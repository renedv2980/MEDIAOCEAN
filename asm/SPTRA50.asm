*          DATA SET SPTRA50    AT LEVEL 155 AS OF 11/06/20                      
*PHASE T21650B                                                                  
*INCLUDE PQPROF                                                                 
*INCLUDE BINSRCH2                                                               
*INCLUDE ENDOFMOD                                                               
*   NET SEED REQUEST FOR ALL NET NEEDS ERR MSG IF NO ALL=                       
* ? NEED TO CREATE NEW REV REC, ADD REV #, NOT CK PRD PROPERLY                  
***********************************************************************         
*****************  PRODUCTION VERSION OF THE PROGRAM ******************         
**************  CONVERTED REVISION RECORDS ****************************         
***********************************************************************         
***********************************************************************         
*                                                                               
* THIS VERSION MERGES CABLE/GEN WITH PATTERN/GEN                                
*                                                                     *         
*  TITLE: T21650 - TRAFFIC NETWORK PATTERN INSTRUCTION GENERATION     *         
*  COMMENTS: THIS PROGRAM GENERATES NETWORK PATTERN INSTRUCTIONS      *         
*  OUTPUTS: UPDATED REVISION RECS, PRINTED INSTR.                     *         
*  LOCALS: REGISTER USAGE                                             *         
*          R2 - POINTER TO SCREEN FLDH, ERREX WILL POSITION CUSOR     *         
*          R3 -                                                       *         
*          R4 - WORK REG & KEY DSECT POINTER                          *         
*          R5 - WORK REG & POINTER TO PROGRAM/UNIT TABLES             *         
*          R6 - USED FOR GETEL ELEMENT DSECT POINTER                  *         
*          R7 - SECOND BASE                                           *         
*          R8 - POINTER TO SPOOLD                                     *         
*          R9 - POINTER TO SYSD                                       *         
*          RA - POINTER TO ATWA                                       *         
*          RB - FIRST BASE                                            *         
*          RC - POINTER TO GEND                                       *         
*                                                                     *         
* AIO USAGE - AIO1 - VALI RTNS IN CONTROLLER (SPTRA00-T21600)         *         
*                  - BLIN RTN PATTERNS                                *         
*             AIO2 - CKEST READ ESTHDRS (1ST 1000) TABLE (LAST 1000)  *         
*                  - CKEST STORED EST CKS FOR COPY CODE N (BYPASS)    *         
*                  - BLIN RTN CMMLS                                   *         
*                  - SPEC TEXT, CLT, PRD, PRG COPIES TO LISTS         *         
*                  - RDPAT RTN TO GET PATTERN DATES                   *         
*             AIO3 - SVPRDLST (1ST 480)                               *         
*                  -                                                  *         
*                                                                     *         
* FOR EASYLINK, AGENCY COPY PRODUCED 1ST, THEN EASYLINK CLASS G ENTRY *         
*                                                                     *         
* TSPFUSER AREA  0 -  7 ID                                            *         
*                8 -135 DCB                                           *         
*              136 -139 CT TO FORCE CHANGE IN REMOTKEY                *         
*              140      EASY PRINT SW Y = ANY CLASS G EASY ENTRY      *         
*                                                                     *         
* TSAR USES ELEM AS AN I/O AREA                                       *         
*      0 - 1  LENGTH OF RECORD                                        *         
*      2 - 3  KEY - BINARY NUMBER 1 TO N                              *         
*      4      FORCEHED OR, IF BINARY, SPACE BEFORE                    *         
*      5      SPACING                                                 *         
*      6 - N  PRINT LINE (OR HEADING OR MIDLINE)                      *         
*                                                                     *         
***********************************************************************         
*                                                                     *         
*   NEED TO CHANGE 63 TO GET DAYPART FROM UNIT, NOT PROGRAM REC       *         
*                                                                     *         
*  LEV   2 FEB23/00 CHANGE MEDIA EROR MSG                             *         
*  LEV  70 SMUR SEP24/08 FIX END OF THE YEAR BUG                      *         
*  LEV  71 SMUR OCT16/08 EXPAND PGROUP TO 500 PRODS                   *         
*  LEV  72 MNAS      /08 ADD ARCHIVING CODE FOR NOW AND FAX           *         
*  LEV  72 MNAS      /08 NEW HEADLINE LAYOUT                          *         
*  LEV  76 MNAS MAY11/09 NEW BODY LAYOUT                              *         
*  LEV  76 MNAS MAY15/09 FIX BUG IN GTSPL                             *         
*  LEV  76 MNAS JUN17/09 NEW BODY LAYOUT INTO PRODUCTION              *         
*  LEV  77 MNAS JUN25/09 BUG FIX READING PROGRAM RECORDS              *         
*  LEV  78 SMUR JUN18/09 ALL ADID SUPPORT                             *         
*  LEV  97 MHER          PATTERN/GEN CABLE/GEN WITH PATTERN TIMES     *         
*  LEV  97 MNAS MAY17/10 FILTER OUT PTRNS IF PROD NOT IN UNIT TABLE   *         
*  LEV  97 MNAS MAY17/10 REINSTATE PSORT                              *         
*  LEV 106 MNAS DEC17/10 ADD SCHEDULE SUMMARY                         *         
*  LEV 107 MNAS JAN19/11 ADD TIME TO REVISION RECORDS                 *         
*  LEV 108 MNAS JAN27/11 INCREASE PNAMTAB TO HOLD 256 PGRMS (FROM 128)*         
*  LEV 111 MNAS MAR23/11 FIX PSORT:SORT DATES WITHIN PRODUCTS         *         
*          FIX DUMPING WHEN SWITCHING FROM WEEKLY TO CALENDAR IN FREV *         
*  LEV 112 MNAS APR07/11 BUG WHEN RUNNING NET=ALL AND PAT TIMES BEING *         
*          USED - PROGRAM TABLE NOT BEING CLEARED                     *         
*  LEV 112 MNAS APR08/11 BUG WHEN ERROR TABLE MAX EXCEEDED - DUMPING  *         
*  LEV 116 MNAS JUL15/11 FIX CODE TO CHECK IF PROGRAM TABLE IS FULL   *         
*  LEV 117 MNAS AUG24/11 STOP DUMP AND CONTINUE WHEN CONTACT INFO NOT *         
*          FOUND ON CONTACT RECORD                                    *         
*  LEV 118 MNAS SEP15/11 BUG IN CODE TO CHECK IF PROGRAM TABLE IS FULL*         
*          SEE LEV 116 - ALSO NEED TO EXTEND TABLE                    *         
*  LEV 119 MNAS NOV15/11 CHANGES TO ACCOMODATE NEW VENDOR RECORD      *         
*          (REPLACING DAYPART) - BUG FIX FOR FEEDS ALSO INCLUDED      *         
*  LEV 139 MNAS MAR21/12 WHEN NO FAX # SEND EMAIL INSTEAD OF ERROR    *         
*          MSG AND CONTINUE PROCESSING                                *         
*  LEV 140 MNAS MAY02/12 FIX BROADCAST DAY BUG WITH TIMES             *         
*  LEV 140 MNAS MAY03/12 FIX BUG WHEN RUNNING MULTIPLE OV FAX REQUESTS*         
*  LEV 141 MNAS MAR12/13 NEW EMAIL ADDRESS FOR NO FAX FOUND           *         
*  LEV 142 MNAS MAR19/13 PROFILE LOGIC FOR SUBMEDIA V                 *         
*  LEV 143 SMUR MAR19/14 NEW RECAP RECORDS FOR OPTICA                 *         
*  LEV 144 SMUR OCT06/14 FIX READ REV REC IN UPDR (WAS COMMENTED OUT) *         
*  LEV 144 SMUR JAN06/15 YNG FOR OPTICA                               *         
*  LEV 145 SMUR JUL06/15 SPG FOR OPTICA                               *         
*          SMUR AUG20/15 FIX OLD BUG TO STOP MSYRT DUMPS              *         
*  LEV 146 SMUR JUL13/16 MAKE ADDITIONAL COMML INFO TABLE BIGGER      *         
*  LEV 147 SMUR AUG15/16 FIX RECAP RECS FOR 8 CHAR ISCII W/ADID ELEM  *         
*  LEV 147 SMUR AUG15/16 FIX RECAP RECS FOR 8 CHAR ISCII W/ADID ELEM  *         
*               FEB15/17 ALLOW COMMENTS AT THE TIME OF REQUEST        *         
*                        ER FOR OPTICA                                *         
*  LEV 148 SMUR JUN28/17 DO NOT ADD PASSIVE POINTER FOR NET RECAP REC *         
*  LEV 149 SMUR AUG09/17 RE-INIT CML SHIP TABLE FOR ALL NET REQUEST   *         
*  LEV 150 SMUR AUG14/17 MERGE CML AIR DATES ON RECAP RECS SPEC-15086 *         
*  LEV 152 SMUR DEC10/17 PRINT STATION NAME ON REPORT SPEC-16082(18.1)*         
*  SPEC-31600  SMUR JAN15/19 MAKE SKIP NETWORK TABLE BIGGER           *         
*  SPEC-35152  SMUR APR25/19 FIX T/A REQUEST FOR PGROUP,PSORT         *         
*  SPEC-42504  SMUR 20.3 SUPPORT CONVERTED DATES ON REVISION RECS     *         
*  SPEC-46117  SMUR 20.3 FIX NETWORK REVISION ON THE INSTRUCTIONS     *         
*                                                                     *         
***********************************************************************         
         TITLE 'T21650 - NET TRAFFIC PATTERN INSTRUCTION GENERATION'            
T21650   CSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 0,T21650**,R7,RR=R3                                              
         L     RC,0(R1)                                                         
         USING GEND,RC                                                          
         L     R8,ASPOOLD          GENERAL PRINT AREAS                          
         USING SPOOLD,R8                                                        
         L     RA,ATWA                                                          
         USING CONHEADH-64,RA      BASE SCREEN FOR SYSTEM + THIS PROG           
         L     R9,ASYSD                                                         
         USING SYSD,R9                                                          
         ST    R3,SPTR50RR                                                      
                                                                                
         LH    R0,=AL2(ENDSYSD-SYSD)   SEE IF PAST END OF SYSD                  
         C     R0,LSYSD                                                         
         BNH   *+6                                                              
         DC    H'0'                                                             
                                                                                
         LH    RE,=AL2(NETBLK-SYSD)                                             
         AR    RE,R9                                                            
         ST    RE,ANETBLK                                                       
                                                                                
         BRAS  RE,INIT             GO INITIALIZE STUFF                          
         EJECT                                                                  
                                                                                
*                                                                               
         MVC   TRACEIT+6(1),MODE                                                
         GOTO1 DATAMGR,DMCB,=C'DMTRACE',=C'DATA',TRACEIT                        
*                                                                               
         TM    WHEN,X'10'                                                       
         BO    MAIN10                                                           
         L     RE,ASECBLK                                                       
         USING SECD,RE                                                          
         MVC   SVSECPID,SECPID                                                  
         MVC   TRAPID,SECPID                                                    
         OI    TRAPIDH+6,X'80'                                                  
         DROP  RE                                                               
                                                                                
MAIN10   DS    0H                                                               
         CLI   MODE,VALKEY         VALIDATE RECORD KEY                          
         BE    VK                                                               
         CLI   MODE,PRINTREP       OFFLINE INSTRUCTIONS                         
         BE    LRR                                                              
         CLI   MODE,RUNFRST                                                     
         BE    GENAUTO                                                          
         CLI   MODE,RUNLAST                                                     
         BE    GENFIN                                                           
         B     EXIT                                                             
                                                                                
EQXIT    CR    RB,RB                                                            
         J     EXIT                                                             
*                                                                               
NEQXIT   LTR   RB,RB                                                            
*                                                                               
EXIT     XIT1                                                                   
*                                                                               
TRACEIT  DC    X'07',C'MODE=X'                                                  
*                                                                               
* SET UP FOR OFFLINE REQUIREMENTS *                                             
                                                                                
GENAUTO  CLI   OFFLINE,C'Y'                                                     
         BNE   EXIT                                                             
         TM    WHEN,X'C0'          TEST IMMED/NOW                               
         BZ    *+6                                                              
         DC    H'0'                                                             
         MVC   SEQNUM,=H'1'                                                     
         MVI   29(RA),X'02'        SET RUNLAST HOOK REQUIRED                    
                                                                                
         L     RE,TWAMASTC                                                      
         L     RF,MCSSB-MCBLOCK(RE)                                             
                                                                                
* RECOVER OFFLINE COPIES TO RECOVERY FILE                                       
         OI    SSBSTAT2-SSBD(RF),SSBSROLC                                       
         B     EXIT                                                             
                                                                                
* CK IF ANY EASYLINK STUFF THAT MIGHT GET LOST *                                
                                                                                
GENFIN   CLI   OFFLINE,C'Y'                                                     
         BNE   EXIT                                                             
         TM    WHEN,X'C0'          TEST IMMED/NOW                               
         BZ    *+6                                                              
         DC    H'0'                                                             
         ICM   RE,15,TWAMASTC                                                   
         BZ    EXIT                                                             
         OC    MCREMOTE-MASTD(,RE),MCREMOTE-MASTD(RE)                           
         BNZ   EXIT                                                             
         L     RE,TWADCONS                                                      
         L     RE,TSPFUSER-TWADCOND(RE)                                         
         CLI   140(RE),C'Y'        SEE IF ANY EASYLINK STUFF PRINTED            
         BNE   EXIT                 NO                                          
                                                                                
* OPEN DIRECT ENTRY (WHICH WILL BE LOST)  TO PRESERVE REAL QUE ENTRY *          
                                                                                
         L     RE,TWAMASTC                                                      
         L     R4,MCVREMOT-MASTD(,RE)                                           
         USING REMOTED,R4                                                       
                                                                                
         MVC   REMOTSYS,MCS2OSYS-MASTD(RE)                                      
         MVC   REMOTJID,=C'STP'                                                 
         MVC   REMOTDST,TWAORIG                                                 
         MVI   REMOTCLS,C'A'                                                    
         MVI   REMOTCPY,1                                                       
                                                                                
         GOTO1 OPENPQ                                                           
         MVC   P(5),=C'DUMMY'                                                   
         GOTO1 SPOOL,DMCB,(R8)    TRY THIS BEFORE XC REMOTKEY                   
         MVI   SPMODE,X'FE'                                                     
         GOTO1 SPOOL,DMCB,(R8)    FORCE CLOSE OF SPOOL                          
         MVI   PQSW,1                                                           
         XC    REMOTKEY,REMOTKEY                                                
         B     EXIT                                                             
         DROP  R4                                                               
         EJECT                                                                  
                                                                                
*        VALIDATE KEY ROUTINE                                                   
                                                                                
VK       MVI   PQSW,1              SUPPRESS AUTO PRTQUE OPEN                    
         MVI   SVFAXARC,0          CLEAR FAX ARCHIVE BYTE                       
         MVI   SVQLTYP1,0          CLEAR FAX ARCHIVE BYTE                       
         XC    ELEM,ELEM                                                        
         XC    PROFKEY,PROFKEY                                                  
         MVI   PROFKEY,C'S'                                                     
         MVC   PROFKEY+1(2),=C'TP'                                              
         MVC   PROFKEY+3(2),TWAORIG                                             
         GOTO1 =V(PQPROF),DMCB,(X'80',PROFKEY),(0,ELEM),ACOMFACS,RR=SPTX        
               R50RR                                                            
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
         LA    R4,ELEM                                                          
         USING REMOTED,R4                                                       
         MVC   SVQLTYP1,REMOTTY1                                                
                                                                                
         CLI   REMOTSUB,C'#'                                                    
         BNE   VK03                                                             
         CLI   REMOTSUB+1,C'N'                                                  
         BE    VK05                                                             
         CLI   REMOTSUB+1,C'A'                                                  
         BNE   VK03                                                             
         OI    SVFAXARC,REMOTARQ                                                
         B     VK05                                                             
VK03     OI    SVFAXARC,REMOTAEQ                                                
VK05     DS    0H                                                               
         DROP  R4                                                               
                                                                                
* CLEAR WORKING STORAGE *                                                       
                                                                                
*NOP     CLI   1(RA),C'*'          THIS A DDS TERMINAL                          
*****    BE    *+12                 YES                                         
         TM    WHEN,X'40'          THIS NOW                                     
         BO    NOTDDSER                                                         
                                                                                
         LA    RE,ASVFTNT                                                       
         LA    RF,EQVPTBL-ASVFTNT                                               
         XCEF                                                                   
                                                                                
         ICM   RE,15,TWAMASTC                                                   
         BZ    VK014                                                            
         OC    MCREMOTE-MASTD(,RE),MCREMOTE-MASTD(RE)                           
         BZ    *+8                                                              
         MVI   DIRPRTSW,C'Y'                                                    
                                                                                
* VALIDATE KEY FIELDS                                                           
                                                                                
VK014    DS   0H                                                                
         LA    R2,ELEM             FAKE VALIMED                                 
         MVC   ELEM,=X'0A01000184010001'                                        
         MVI   ELEM+8,C'N'                                                      
         GOTO1 VALIMED                                                          
                                                                                
         LA    R2,TRACLTH          CLIENT                                       
                                                                                
         GOTO1 VALICLT                                                          
         OI    4(R2),X'20'         SET ON VALIDATED                             
                                                                                
* READ & CHECK OUT TW PROFILE 6 VALUES                                          
                                                                                
         XC    WORK,WORK                                                        
         MVC   WORK(4),=C'S0TW'                                                 
         MVC   WORK+4(2),AGENCY                                                 
         MVI   WORK+6,C'N'                                                      
         MVC   WORK+7(3),QCLT                                                   
         MVI   WORK+10,C'*'                                                     
         MVC   WORK+11(1),SVCLTOFF CLIENT OFFICE                                
                                                                                
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY                         
         BZ    VK15                                                             
                                                                                
         TM    SECFLAG,NEPRDOFF    PRDS OFFICES NOT EQ                          
         BO    VK15                                                             
                                                                                
         MVC   WORK+11(1),SVPRDOFF USE PROD OFFICE                              
                                                                                
VK15     GOTO1 GETPROF,DMCB,WORK,SVTWPROF,DATAMGR                               
                                                                                
         CLI   SVTWPR06,C'Y'       SEND AS EASYLINK                             
         BE    VK020                                                            
         CLI   SVTWPR06,C'2'       SEND AS EASYLINK + AGENCY COPY               
         BE    VK020                                                            
         MVI   SVTWPR06,C'N'       DEFAULT IS N                                 
                                                                                
* READ TN PROFILE                                                               
                                                                                
VK020    MVI   WORK+3,C'N'                                                      
         GOTO1 (RF),(R1),,SVPROF                                                
         MVC   MYTN2PR6,SVPROF+1                                                
                                                                                
* READ TN1 PROFILE *                                                            
                                                                                
         MVI   WORK,X'A2'                                                       
         MVC   WORK+1(3),=C'TN1'                                                
         GOTO1 (RF),(R1),,SVT1PROF                                              
                                                                                
         CLI   SVOPTTN1,C' '                                                    
         BNH   *+10                                                             
         MVC   SVTN1PR3,SVOPTTN1                                                
                                                                                
         MVC   WORK+1(3),=C'TN3'                                                
         GOTO1 (RF),(R1),,SVT3PROF                                              
                                                                                
* VALIDATE NETWORK                                                              
                                                                                
         LA    R2,TRANETH                                                       
                                                                                
         CLI   5(R2),0             ANY ENTRY                                    
         BE    MISSERR                                                          
                                                                                
         NI    ANYFLAG,X'FF'-NETFOUND   INIT NETWORK FOUND                      
         NI    ANYFLAG,X'FF'-COPYSSW+PIGGBSW                                    
         MVI   UPDSW,0                                                          
                                                                                
         CLI   5(R2),3                                                          
         BNE   VK030                                                            
         CLC   =C'ALL',8(R2)                                                    
         BNE   VK030                                                            
                                                                                
         CLI   TWAOFFC,C'*'        THIS A DDS TERM                              
         BE    VK024                                                            
                                                                                
         TM    WHEN,X'38'          TEST SOON/OVERNIGHT/DDS                      
         BZ    OFFLNERR             NO, ERROR                                   
                                                                                
* NEED TO READ UNITS AND FIND FIRST NETWORK HERE *                              
                                                                                
VK024    DS    0H                                                               
                                                                                
         XC    MYSVNET,MYSVNET                                                  
         BRAS  RE,INITNET                                                       
                                                                                
         LA    R4,KEY                                                           
         USING NUKEY,R4                                                         
         XC    KEY,KEY                                                          
                                                                                
         MVI   NUKPTYPE,X'84'      UNIT PASSIVE KEY                             
         MVC   NUKPAM,BAGYMD       AGENCY                                       
         MVC   NUKPCLT,BCLT        CLIENT                                       
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
                                                                                
         CLC   KEY(4),KEYSAVE      SAME AGY/CLT                                 
         BNE   NOUNTERR            NO UNITS!                                    
                                                                                
         MVC   SAVNET,NUKPNET                                                   
         MVC   SVNETFX2,SAVNET                                                  
                                                                                
         B     VK024F              MUST ENTER MEDIA FOR ALL NET REQ             
                                                                                
         CLC   =C'YN',AGENCY       AGENCY IS YNR                                
         BE    *+14                                                             
         CLC   =C'MSYRT ',AGYORIG  SIGN ON MSYRT                                
         BNE   VK025                                                            
                                                                                
VK024F   MVI   BYTE,1              LOOK FOR MEDIA IN OPT                        
         BRAS  RE,VOPT                                                          
         MVI   BYTE,0              RESET                                        
                                                                                
         MVC   SVMEDIA,SVOPTMED                                                 
                                                                                
VK025    BRAS  RE,INITSPT                                                       
         XC    WORK,WORK                                                        
         MVI   WORK,X'A2'                                                       
         MVC   WORK+1(3),=C'TN2'   READ TN2                                     
         MVC   WORK+4(2),AGENCY                                                 
         MVC   WORK+6(1),SVMEDIA   USE MEDIA FROM NETWORK REC                   
         MVC   WORK+7(3),QCLT                                                   
         MVI   WORK+10,C'*'                                                     
         MVC   WORK+11(1),SVCLTOFF CLIENT OFFICE                                
                                                                                
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY                         
         BZ    VK026                                                            
         TM    SECFLAG,NEPRDOFF    PRDS OFFICES NOT EQ                          
         BO    VK026                                                            
         MVC   WORK+11(1),SVPRDOFF USE PROD OFFICE                              
                                                                                
VK026    GOTO1 GETPROF,DMCB,WORK,SVTN2PRO,DATAMGR                               
         CLI   SVTN2PRO+5,C'0'     IF TN2 IS NOT SET                            
         BE    VK026F              USE TN PROF                                  
         CLI   SVTN2PRO+5,0                                                     
         BE    VK026F                                                           
         MVC   MYTN2PR6,SVTN2PRO+5 SAVE TN2 PROF                                
*                                                                               
VK026F   MVC   SVTN2PRE,SVTN2PRO+13 PRINT CLT CML#                              
         CLI   SVOPTTN2,C' '                                                    
         BNH   *+10                                                             
         MVC   SVTN2PRO+10(1),SVOPTTN2                                          
         B     VK040                                                            
         DROP  R4                                                               
                                                                                
VK030    GOTO1 ANY                 GET HERE IF SINGLE NETWORK ENTERED           
                                                                                
         MVC   NETWORK,WORK                                                     
         MVC   SAVNET,WORK                                                      
         MVC   SVNETFX2,SAVNET                                                  
                                                                                
         XC    SVSFAX,SVSFAX                                                    
         BRAS  RE,GNET                                                          
         BE    VK040                                                            
         DC    H'0'                                                             
                                                                                
VK040    DS    0H                                                               
*MNV                                                                            
         CLI   SVTN2PRO+14,C'Y'                                                 
         BNE   VK042                                                            
         TM    SVOPTSW2,OPTDIGI                                                 
         BO    VK042                                                            
         CLI   SVMEDIA,C'V'                                                     
         BNE   VK042                                                            
         LA    R2,TRANETH                                                       
         MVC   GERROR,=Y(BDNETMED)                                              
         GOTO1 VTRAERR                                                          
VK042    DS    0H                                                               
*MNV                                                                            
         MVI   WORK+3,C'N'                                                      
         OI    4(R2),X'20'         SET ON VALIDATED                             
                                                                                
* VALIDATE FAX AND OPTIONS FIELDS (MUST BE DONE AFTER GNET)                     
* FAX FIELD IS VALIDATED WITH OPTIONS *                                         
                                                                                
         LA    R2,TRAOPTH          PRODUCT                                      
                                                                                
         MVI   BYTE,0                                                           
         BRAS  RE,VOPT                                                          
                                                                                
         CLI   CONREC,C'C'         TEST CABLE/GEN                               
         BNE   VK045                                                            
         TM    WHEN,X'20'                                                       
         BZ    VK045                                                            
         CLC   =C'ALL',TRANET      IF ALL NETWORKS CANNOT RUN                   
         BNE   VK045               A SOON RUN WITHOUT OPTION=TEST               
         TM    SVOPTSW,OPTTEST     THIS A TEST RUN                              
         BZ    OFFLERCG                                                         
*                                                                               
* READ ANY REVISION RECORD TO SEE IF THE FILE HAS BEEN CONVERTED.               
VK045    NI    SVFLAG,X'FF'-CONVSW INIT CONVERTED RECORDS                       
         BRAS  RE,INITXSP          SET TO XSPOT                                 
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A1D'                                                  
         GOTO1 HIGH                                                             
         CLC   =X'0A1D',KEY                                                     
         BE    VK46                                                             
*                                                                               
         XC    ELEM,ELEM                                                        
         LA    R1,ELEM                                                          
         MVC   0(L'NOTEMSG,R1),NOTEMSG                                          
         LA    R1,L'NOTEMSG(,R1)                                                
         MVC   0(2,R1),AGENCY                                                   
         MVC   3(3,R1),QCLT                                                     
         MVC   7(4,R1),TRANET                                                   
         MVC   12(8,R1),TRAPER                                                  
                                                                                
         OC    ELEM,SPACES                                                      
         GOTO1 DATAMGR,DMCB,=C'OPMSG',(L'NOTEMSG+72,ELEM)                       
         B     VK47                NO REC FOUND, TREATE AS CONVERTED            
*                                                                               
VK46     TM    KEY+32,X'03'        CONVERTED RECORDS?                           
         BZ    *+8                                                              
VK47     OI    SVFLAG,CONVSW                                                    
*                                                                               
         BRAS  RE,INITSPT         CHANGE TO SPOT                                
                                                                                
         LA    R2,TRAPERH          PERIOD                                       
                                                                                
         BRAS  RE,VPER                                                          
                                                                                
         LA    R2,TRASEEDH                                                      
         CLI   5(R2),0                                                          
         BE    VK050                                                            
         CLI   CONREC,C'C'         TEST CABLE/GEN                               
         BE    VK050                                                            
*                                                                               
         CLI   8(R2),C'N'                                                       
         BE    VK052                                                            
         CLI   8(R2),C'Y'                                                       
         BNE   SEEDERR                                                          
*                                                                               
         LA    R2,TRASEEDH                                                      
         CLI   TRAFAX,C'C'                                                      
         BE    SEEDERR1                                                         
         TM    SVOPTSW,OPTTEST                                                  
         BO    SEEDERR2                                                         
         B     VK052                                                            
                                                                                
VK050    DS    0H                                                               
         MVI   TRASEEDH+5,1                                                     
         OI    TRASEEDH+6,X'80'    FORCE TRANSMIT                               
         MVI   TRASEED,C'Y'                                                     
*                                                                               
         CLI   TRAFAX,C'C'                                                      
         BNE   *+8                                                              
         MVI   TRASEED,C'N'                                                     
         TM    SVOPTSW,OPTTEST                                                  
         BZ    *+8                                                              
         MVI   TRASEED,C'N'                                                     
*                                                                               
         CLI   CONREC,C'C'         TEST CABLE/GEN                               
         BNE   *+8                                                              
         MVI   TRASEED,C' '                                                     
*                                                                               
VK052    DS    0H                                                               
                                                                                
* GET CORERES ADDR OF QSORT AND XSORT                                           
                                                                                
         XC    DMCB,DMCB                                                        
         LA    R1,DMCB                                                          
         L     RF,CALLOV                                                        
         MVC   DMCB+4(4),=X'D9000A50'                                           
         GOTO1 (RF),(R1),0                                                      
         MVC   QSORT,DMCB                                                       
*                                                                               
         MVC   DMCB+4(4),=X'D9000A12'                                           
         GOTO1 (RF),(R1),0                                                      
         MVC   XSORT,DMCB                                                       
*                                                                               
         MVC   DMCB+4(4),=X'D9000AFE'    GET ADDRESS OF TRPACK                  
         GOTO1 CALLOV,DMCB                                                      
         MVC   VTRPACK,0(R1)                                                    
                                                                                
         BRAS  RE,SETSTOR          ALLOCATE TABLES!                             
                                                                                
         BRAS  RE,RPHSE            CML PROD HOUSE RECORD FOR OPTICA             
                                                                                
         CLC   =C'ALL',TRANET                                                   
         BE    VK052G                                                           
         OI    UPDSW,UPDSWFU       ONLY FIND 1 USABLE UNIT                      
         BRAS  RE,BLUNT            SEE IF ANY UNITS                             
         NI    UPDSW,X'FF'-UPDSWFU                                              
         OC    UNTABCT,UNTABCT     FIND ANY UNITS                               
         BNZ   VK052G                                                           
                                                                                
         CLI   CONREC,C'C'                                                      
         BNE   VK052F                                                           
                                                                                
         USING PRGTABLD,R4                                                      
         L     R4,APRGTAB          GET PROGRAM COUNT TABLE                      
         OC    PRGPROG,PRGPROG                                                  
         BZ    VK052F                                                           
                                                                                
VK052B   TM    SVOPTSW1,OPTUNSD    UNSEEDED UNITS OK                            
         BO    VK052C                                                           
         TM    SVOPTSW2,OPTSEED    OPER SAYS SEED WILL BE RUN                   
         BO    VK052C                                                           
         OC    PRGUNSD,PRGUNSD     THIS PROGRAM HAVE ALL COMMERCIALS            
         BZ    VK052C               NO                                          
                                                                                
         LA    R2,TRAOPTH                                                       
         MVC   GERROR,=Y(UNTNOCML)                                              
         GOTO1 VTRAERR                                                          
*                                                                               
VK052C   TM    SVOPTSW,OPTUNAL     UNALLOCATED UNITS OK                         
         BO    VK052D                                                           
         CLI   SVTNPR3,C'Y'        TN PROF ALLOW UNALLOCATED UNITS              
         BE    VK052D                                                           
         OC    PRGUNAL,PRGUNAL     THIS PROGRAM HAVE ALL PROD ALLOC             
         BZ    VK052D               YES                                         
         LA    R2,TRAOPTH                                                       
         MVC   GERROR,=Y(UNALPRD)   NO                                          
         GOTO1 VTRAERR                                                          
*                                                                               
VK052D   LA    R4,PRGNEXT                                                       
         OC    PRGPROG,PRGPROG                                                  
         BNZ   VK052B                                                           
         B     VK052G                                                           
         DROP  R4                                                               
                                                                                
VK052F   LA    R2,TRAPERH                                                       
         MVC   GERROR,=Y(NOUNTPER)    NO UNITS FOR PERIOD                       
         GOTO1 VTRAERR                                                          
                                                                                
VK052G   CLI   OFFLINE,C'Y'                                                     
         BE    VK070                                                            
                                                                                
* IF ONLINE FOR OFFLINE OR SOON REQUEST, SEE IF ANY UNITS                       
*                                                                               
*        CLI   CONREC,C'C'         TEST CABLE/GEN                               
*        BNE   VK060               NO                                           
         OI    UPDSW,UPDSWFU       ONLY FIND 1 USABLE UNIT                      
         BRAS  RE,BLUNT            READ UNITS                                   
         NI    UPDSW,X'FF'-UPDSWFU                                              
                                                                                
* SEE IF ANY PROGRAMS WITHOUT COMMERCIALS OR UNALLOCATED *                      
                                                                                
         L     R4,APRGTAB          GET PROGRAM COUNT TABLE                      
         USING PRGTABLD,R4                                                      
*                                                                               
VK053    DS    0H                                                               
         CLI   CONREC,C'C'         TEST CABLE/GEN                               
         BNE   VK054               NO                                           
                                                                                
         TM    SVOPTSW1,OPTUNSD    UNSEEDED UNITS OK                            
         BO    VK054                                                            
         TM    SVOPTSW2,OPTSEED    OPER SAYS SEED WILL BE RUN                   
         BO    VK054                                                            
         OC    PRGUNSD,PRGUNSD     THIS PROGRAM HAVE ALL COMMERCIALS            
         BZ    VK054                NO                                          
                                                                                
         LA    R2,TRAOPTH                                                       
         MVC   GERROR,=Y(UNTNOCML)                                              
         GOTO1 VTRAERR                                                          
*                                                                               
VK054    TM    SVOPTSW,OPTUNAL     UNALLOCATED UNITS OK                         
         BO    VK056                                                            
         CLI   SVTNPR3,C'Y'        TN PROF ALLOW UNALLOCATED UNITS              
         BE    VK056                                                            
         OC    PRGUNAL,PRGUNAL     THIS PROGRAM HAVE ALL PROD ALLOC             
         BZ    VK056                YES                                         
         LA    R2,TRAOPTH                                                       
         MVC   GERROR,=Y(UNALPRD)   NO                                          
         GOTO1 VTRAERR                                                          
*                                                                               
VK056    DS    0H                                                               
         LA    R4,PRGNEXT                                                       
         OC    PRGPROG,PRGPROG                                                  
         BNZ   VK053                                                            
                                                                                
         CLC   =C'ALL',TRANET      IF ALL NETWORKS CANNOT RUN                   
         BE    VK059                                                            
         CLI   OFFLINE,C'Y'                                                     
         BE    VK059                                                            
         CLI   TRAFAX,C'N'                                                      
         BE    VK059                                                            
         CLI   TRAFAX,C'C'                                                      
         BE    VK059                                                            
         CLI   SVTWPR11,C'N'       TRAFFIC RECS FOR FAX #                       
         BE    VK058                                                            
         BRAS  RE,FNDFAX                                                        
         BE    VK059                                                            
                                                                                
VK058    OC    SVSFAX,SVSFAX       ANY FAX ?                                    
         BZ    FAX2ERR             NO, ERROR                                    
                                                                                
VK059    DS    0H                                                               
                                                                                
         B     VK084                                                            
         DROP  R4                                                               
                                                                                
* PATTERN/GEN                                                                   
                                                                                
VK060    OI    UPDSW,UPDSWFU       ONLY FIND 1 USABLE UNIT                      
         BRAS  RE,BLUNT            SEE IF ANY UNITS                             
*                                                                               
         NI    UPDSW,X'FF'-UPDSWFU                                              
         OC    UNTABCT,UNTABCT     FIND ANY UNITS                               
         BNZ   VK080                YES                                         
         J     EXIT                                                             
                                                                                
VK070    DS    0H                                                               
         L     RE,AERRTAB                                                       
         L     RF,AERRTABX                                                      
         SR    RF,RE                                                            
         XCEFL                                                                  
*                                                                               
         BRAS  RE,INITSROF         INIT TSAROFF                                 
                                                                                
         OC    SAVNET,SAVNET                                                    
         BZ    VK080                                                            
         OC    MYSVNET,MYSVNET                                                  
         BZ    VK080                                                            
         CLC   SAVNET,MYSVNET                                                   
         BE    VK080                                                            
         BRAS  RE,IACML                                                         
                                                                                
VK080    DS    0H                                                               
         MVC   MYSVNET,SAVNET                                                   
         CLI   SVTWPR06,C'N'       NO FAX                                       
         BE    VK084                                                            
                                                                                
         CLI   SVTWPR11,C'Y'       TRAFFIC RECS FOR FAX #                       
         BE    VK084                                                            
                                                                                
         CLC   =C'ALL',TRANET      IF ALL CHECK LATER                           
         BE    VK084                                                            
                                                                                
         OC    SVSFAX,SVSFAX       ANY FAX ?                                    
         BZ    FAXERR              NO, ERROR                                    
                                                                                
VK084    DS    0H                                                               
         TM    WHEN,X'20'          THIS SOON PROCESSING                         
         BZ    EXIT                 NO                                          
                                                                                
         CLI   SVTWPR06,C'N'       NO FAX                                       
         BE    VK100                                                            
         MVI   SVFAXARC,0          CLEAR FAX ARCHIVE BYTE                       
         MVI   SVQLTYP1,0          CLEAR FAX ARCHIVE BYTE                       
         XC    ELEM,ELEM                                                        
         XC    PROFKEY,PROFKEY                                                  
         MVI   PROFKEY,C'S'                                                     
         MVC   PROFKEY+1(2),=C'TP'                                              
         MVC   PROFKEY+3(2),TWAORIG                                             
         GOTO1 =V(PQPROF),DMCB,(X'80',PROFKEY),(0,ELEM),ACOMFACS,      X        
               RR=SPTR50RR                                                      
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
         LA    R4,ELEM                                                          
         USING REMOTED,R4                                                       
         MVC   SVQLTYP1,REMOTTY1                                                
                                                                                
         CLI   REMOTSUB,C'#'                                                    
         BNE   TEMP03                                                           
         CLI   REMOTSUB+1,C'N'                                                  
         BE    TEMP05                                                           
         CLI   REMOTSUB+1,C'A'                                                  
         BNE   TEMP03                                                           
         OI    SVFAXARC,REMOTARQ                                                
         B     TEMP05                                                           
TEMP03   OI    SVFAXARC,REMOTAEQ                                                
TEMP05   DS    0H                                                               
         DROP  R4                                                               
                                                                                
         MVC   REMUSER,=C'PWX'                                                  
         CLI   CONREC,C'C'         TEST CABLE/GEN                               
         BNE   *+10                                                             
         MVC   REMUSER,=C'CWX'                                                  
         MVC   SPOOLKEY+QLTYP1-PQPLD,SVFAXARC                                   
         MVI   SPOOLKEY+PLCLASS-PQPLD,C'G'                                      
                                                                                
         ICM   RE,15,TWAMASTC                                                   
         BZ    VK100                                                            
         MVI   MCREQREP-MASTD(RE),C'N' SUPPRESS REQUEST PAGE                    
                                                                                
VK100    TM    SVOPTSW,OPTTEST     THIS A TEST RUN                              
         BO    EXIT                 NO UPDATE, NO NEED TO LOCK                  
                                                                                
         TM    SVOPTSW1,OPTHDCPY   IF AGENCY COPY RUN                           
         BO    EXIT                 NO UPDATE, NO NEED TO LOCK                  
                                                                                
* SEE IF WE ARE LOCKED OUT BY UNIT ALLOCATION                                   
                                                                                
         MVC   DUB(4),=C'TNET'                                                  
         XC    DUB+4(4),DUB+4      CLEAR REST                                   
         GOTO1 VALILOC,0                                                        
                                                                                
         CLI   CONREC,C'C'         TEST CABLEGEN                                
         BNE   *+12                                                             
         BRAS  RE,TLOCK            TEST IF LOCKED ELSE LOCK                     
         B     VK122                                                            
                                                                                
* SEE IF WE ARE LOCKED OUT BY US                                                
                                                                                
         MVC   DUB(4),=C'TNET'                                                  
         MVI   DUB+4,X'21'                                                      
         XC    DUB+5(3),DUB+5                                                   
                                                                                
         CLC   =C'ALL',TRANET      IF ALL CHECK ALL                             
         BE    VK110                                                            
                                                                                
         MVI   DUB+5,X'FF'         MARKER FOR BY NET                            
         MVC   FULL,NETWORK        LOCK BY NET                                  
                                                                                
VK110    DS    0H                                                               
         GOTO1 VALILOC,0                                                        
                                                                                
         XC    FULL,FULL                                                        
                                                                                
* LOCK OUT FOR SOON UPDATES                                                     
                                                                                
         MVC   DUB(4),=C'LNET'                                                  
         MVI   DUB+4,X'21'                                                      
         XC    DUB+5(3),DUB+5      CLEAR REST                                   
         CLC   =C'ALL',TRANET      IF ALL CHECK ALL                             
         BE    VK120                                                            
                                                                                
         MVI   DUB+5,X'FF'         MARKER FOR BY NET                            
         MVC   FULL,NETWORK        LOCK BY NET                                  
                                                                                
VK120    GOTO1 VALILOC,0                                                        
                                                                                
VK122    MVI   TWAWHEN,5          SET AS UPDATIVE SOON FOR FRED                 
*                                 ALSO SETS SINGLE THREAD                       
         B     EXIT                                                             
*                                                                               
NOTEMSG  DC    C'AUTONOTE*SMUR:NO 0A1D REC FOUND '                              
*                                                                               
         EJECT                                                                  
* PRODUCE REPORT - READ UNITS FOR NETWORK, READ PATTERNS, PRT REPORT *          
* IF ALL NETS, REPEAT FOR EACH NETWORK, ALL REQUIRES OPT ALL=N/C/S/O *          
                                                                                
LRR      DS   0H                                                                
         BRAS  RE,SETSTOR                                                       
         BAS   RE,NETI                                                          
                                                                                
LRR010   L     RE,AUNTABLE         CLEAR UNIT TBL                               
         L     RF,MAXUNTBL                                                      
         SR    RF,RE                                                            
         XCEFL                                                                  
                                                                                
         L     RE,APATABLE         CLEAR PAT TBL                                
         L     RF,MAXPATBL                                                      
         SR    RF,RE                                                            
         XCEFL                                                                  
                                                                                
         LA    RE,PNAMTAB                                                       
         LHI   RF,PNAMTABX-PNAMTAB                                              
                                                                                
         LR    R1,RE                                                            
         AHI   R1,-8                                                            
         MVC   0(8,R1),=C'PNAMTAB*'                                             
         ST    RE,APNAMTAB         ALL PROGRAM NAME TABLE                       
         AR    RF,RE                                                            
         ST    RF,MXPNAMTB                                                      
         SR    RF,RE                                                            
         XCEFL                                                                  
*                                                                               
         L     RE,AERRTAB                                                       
         L     RF,AERRTABX                                                      
         SR    RF,RE                                                            
         XCEFL                                                                  
*                                                                               
LRR011   L     RE,AIO2             CLEAR FOR EST HDRS, EST TABLE                
         L     RF,SIZEIO                                                        
         XCEF                                                                   
*                                                                               
         MVI   SVFAXARC,0          CLEAR FAX ARCHIVE BYTE                       
         XC    ELEM,ELEM                                                        
         XC    PROFKEY,PROFKEY                                                  
         MVI   PROFKEY,C'S'                                                     
         MVC   PROFKEY+1(2),=C'TP'                                              
         MVC   PROFKEY+3(2),TWAORIG                                             
         GOTO1 =V(PQPROF),DMCB,(X'80',PROFKEY),(0,ELEM),ACOMFACS,RR=SPTX        
               R50RR                                                            
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
         LA    R4,ELEM                                                          
         USING REMOTED,R4                                                       
                                                                                
         CLI   REMOTSUB,C'#'                                                    
         BNE   LRR012                                                           
         CLI   REMOTSUB+1,C'N'                                                  
         BE    LRR015                                                           
         CLI   REMOTSUB+1,C'A'                                                  
         BNE   LRR012                                                           
         OI    SVFAXARC,REMOTARQ                                                
         B     LRR015                                                           
LRR012   OI    SVFAXARC,REMOTAEQ                                                
LRR015   DS    0H                                                               
         DROP  R4                                                               
                                                                                
         XC    SVPROG,SVPROG                                                    
         XC    SVPROGDT,SVPROGDT                                                
         XC    SVPROGNM,SVPROGNM                                                
                                                                                
         BRAS  RE,GNET             VALIDATE NETWORK                             
         BNE   LRR100                                                           
                                                                                
         BRAS  RE,BLUNT            GET UNITS FOR PRODS/DATES & MORE..           
                                                                                
LRR024   OC    UNTABCT,UNTABCT     FIND ANY UNITS                               
         BNZ   LRR030               YES                                         
                                                                                
         OC    NETWORK,NETWORK                                                  
         BZ    LRR064                                                           
                                                                                
         CLI   NETWORK,X'FF'       AT END OF NETWORKS                           
         BE    LRR064                                                           
         CLI   CONREC,C'C'         TEST CABLEGEN                                
         BNE   NOUNTERR                                                         
         CLI   OFFLINE,C'Y'                                                     
         BE    LRR064              ERROR WILL PRINT FROM TABLE                  
         B     NOUNTERR                                                         
                                                                                
LRR030   DS   0H                                                                
                                                                                
* BUILD PATTERN TABLE                                                           
                                                                                
         BRAS  RE,BLPAT                                                         
                                                                                
         TM    ANYFLAG,SKIPNET     SKIP THIS NETWORK                            
         BZ    LRR032                                                           
*                                                                               
         NI    ANYFLAG,X'FF'-SKIPNET RESET                                      
         BAS   RE,SVBNET           SAVE BYPASSED NETWORK                        
         B     LRR064                                                           
                                                                                
LRR032   OC    GERROR,GERROR       ANY ERROR                                    
         BNZ   TRAPERR2                                                         
                                                                                
         CLI   OFFLINE,C'Y'                                                     
         BNE   LRR040                                                           
                                                                                
         TM    WHEN,X'10'                                                       
         BO    LRR040                                                           
         TM    SVOPTSW1,OPTHDCPY                                                
         BO    LRR040                                                           
         CLI   SVTWPR06,C'N'                                                    
         BNE   LRR040                                                           
                                                                                
*=========================================================                      
* GET NETWORK AND PROGRAM REVISION NUMBERS                                      
*=========================================================                      
                                                                                
LRR040   MVI   SVNETREV,0          RESET NETWORK REVISION NUMBER                
         CLI   CONREC,C'C'         TEST CABLE/GEN                               
         BE    LRR042                                                           
         BRAS  RE,FREV             THIS CODE FOR PATTERN/GEN                    
         B     LRR050                                                           
                                                                                
* THIS CODE FOR CABLE/GEN                                                       
                                                                                
LRR042   L     R3,APRGTAB                                                       
         USING PRGTABLD,R3                                                      
*                                                                               
LRR044   DS    0H                                                               
         C     R3,MXPRGTAB                                                      
         BNL   LRR046                                                           
         CLI   0(R3),0                                                          
         BE    LRR046                                                           
         BRAS  RE,FREV                                                          
         OI    PRGFLAG,PRGF_INSRUN  SET INSTR RUN FOR THIS PROGRAM              
         LA    R3,PRGNEXT-PRGENT(R3)                                            
         B     LRR044                                                           
*                                                                               
* FIND HIGHEST NET REV NUMBER                                                   
LRR046   L     R3,APRGTAB                                                       
LRR046A  C     R3,MXPRGTAB                                                      
         BNL   LRR050                                                           
         CLC   SVNETREV,PRGNREVN                                                
         BNL   *+10                                                             
         MVC   SVNETREV,PRGNREVN   SAVE HIGHEST NETWORK REV #                   
         LA    R3,PRGNEXT                                                       
         CLI   0(R3),0             END OF THE TABLE                             
         BNE   LRR046A              NO                                          
         DROP  R3                                                               
*                                                                               
LRR050   DS    0H                                                               
         BRAS  RE,BLPRGT                                                        
*                                                                               
         L     R5,APATABLE         SEE IF ANYTHING TO PRINT                     
         USING PATABLED,R5                                                      
*                                                                               
LRR056   TM    PATFLG2,PATXXXX     TEST DO NOT USE PATTERN                      
         BO    LRR058                                                           
         CLI   SVTN2PRO+10,C'Y'    TEST TO PRINT ALL PATTERNS                   
         BE    LRR060                                                           
         TM    PATFLG2,PATUSED                                                  
         BO    LRR060                                                           
*                                                                               
LRR058   LA    R5,PATNEXT                                                       
         CLI   0(R5),0                                                          
         BNE   LRR056                                                           
         B     LRR064                                                           
*                                                                               
LRR060   BRAS  RE,PRT              PRINT THESE INSTRUCTIONS                     
                                                                                
         MVI   REPORTOK,C'Y'       SET REPORT RUN FOR POSSIBLE SEED REQ         
                                                                                
LRR062   DS    0H                                                               
         XC    HEADHOOK,HEADHOOK                                                
         XC    FOOTHOOK,FOOTHOOK                                                
         XC    SPECS,SPECS                                                      
                                                                                
LRR064   DS    0H                                                               
         OC    NETWORK,NETWORK     ONE NETWORK REQUEST                          
         BNZ   LRR200               DONE                                        
                                                                                
         CLI   NXTNET,X'FF'        ALL DONE ALL NETWORKS                        
         BE    LRR200               DONE                                        
                                                                                
         CLI   OFFLINE,C'Y'                                                     
         BNE   LRR080                                                           
                                                                                
         TM    WHEN,X'10'                                                       
         BO    LRR070                                                           
         TM    SVOPTSW1,OPTHDCPY                                                
         BO    LRR070                                                           
         CLI   SVTWPR06,C'N'                                                    
         BNE   LRR080                                                           
                                                                                
LRR070   BRAS  RE,PER                                                           
                                                                                
LRR080   MVC   SAVNET,NXTNET                                                    
                                                                                
         MVI   SVNETREV,0          INIT NETWORK REVISION NUMBER                 
         MVI   NETCREVN,0                                                       
*                                                                               
         ST    R2,SVR2             SAVE R2                                      
* RE-INIT CML SHIP TABLE FOR OPTICA                                             
         SR    R0,R0               ADDRESS OF REC TO BE ADDED                   
         L     R1,ACMLTBL          ADDRESS OF BINTABLE                          
         SR    R2,R2               NUMBER OF RECS IN TABLE                      
         LA    R3,CMLTBLLN         LENGTH OF BIN RECORD                         
         LA    R4,L'CMLKEYL        LENGTH OF BIN KEY                            
         LA    R5,NCOMMLT          MAX RECORDS IN BINTBL (200)                  
         STM   R0,R5,BINPAR7                                                    
         L     R2,SVR2             RESTORE R2                                   
*                                                                               
         L     R0,ACMLTBL          CLEAR CML TABLE                              
         L     R1,ACMLTBLX                                                      
         SR    R1,R0                                                            
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         B     LRR010                                                           
                                                                                
* NOW GET NEXT NETWORK                                                          
                                                                                
LRR100   DS   0H                                                                
         BRAS  RE,INITNET                                                       
                                                                                
         LA    R4,KEY                                                           
         USING NUKEY,R4                                                         
         XC    KEY,KEY                                                          
                                                                                
         MVI   NUKPTYPE,X'84'      UNIT PASSIVE KEY                             
         MVC   NUKPAM,BAGYMD       AGENCY                                       
         MVC   NUKPCLT,BCLT        CLIENT                                       
         MVC   NUKPNET,SAVNET      LAST NETWORK FOR ALL NET REQUEST             
         MVI   NUKPPROG,X'FF'      FORCE NEXT NETWORK                           
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
                                                                                
         BRAS  RE,INITSPT                                                       
         CLC   KEY(4),KEYSAVE      SAME AGY/CLT                                 
         BNE   LRR200                                                           
         MVC   SAVNET,NUKPNET                                                   
                                                                                
         MVI   SVNETREV,0          INIT NETWORK REVISION NUMBER                 
         MVI   NETCREVN,0                                                       
         B     LRR010                                                           
                                                                                
LRR200   DS   0H                                                                
         CLI   OFFLINE,C'Y'                                                     
         BNE   LRR210                                                           
                                                                                
         TM    WHEN,X'10'                                                       
         BO    LRR205                                                           
         TM    SVOPTSW1,OPTHDCPY                                                
         BO    LRR205                                                           
         CLI   SVTWPR06,C'N'                                                    
         BNE   LRR210                                                           
                                                                                
LRR205   BRAS  RE,PER                                                           
                                                                                
LRR210   L     RE,ANETABLE                                                      
         OC    0(4,RE),0(RE)       ANY NETWORKS                                 
         BZ    *+8                                                              
         BRAS  RE,PBYNET           PRINT BYPASSED NETWORKS                      
                                                                                
         TM    SVOPTSW,OPTTEST     TEST                                         
         BNZ   EXIT                                                             
                                                                                
         TM    SVOPTSW1,OPTHDCPY   IF AGENCY COPY RUN                           
         BNZ   EXIT                                                             
                                                                                
         CLI   TRASEED,C'Y'        NEED SEED REQUEST                            
         BNE   LRR220                                                           
                                                                                
         CLI   REPORTOK,C'Y'       WAS REPORT RUN OKAY?                         
         BNE   LRR220               NO, NO SEED NEEDED                          
                                                                                
         BRAS  RE,REQSEED                                                       
                                                                                
* UNLOCK FOR SOON UPDATES                                                       
                                                                                
LRR220   DS    0H                                                               
         TM    WHEN,X'10'          IS THIS OV                                   
         BZ    LRR221                                                           
         CLI   SVTWPR06,C'2'                                                    
         BNE   LRR221                                                           
         MVI   SVTWPR06,C'Y'                                                    
         MVC   SAVNET,SVNETFX2                                                  
         B     LRR015                                                           
                                                                                
LRR221   DS    0H                                                               
         TM    WHEN,X'20'          IS THIS SOON                                 
         BZ    EXIT                                                             
         CLI   OFFLINE,C'Y'                                                     
         BNE   EXIT                                                             
                                                                                
LRR224   DS    0H                                                               
         TM    SVOPTSW,OPTTEST     THIS A TEST RUN                              
         BO    EXIT                                                             
                                                                                
         CLI   TRAFAX,C'2'         IS THIS FAX & COPY                           
         BNE   LRR230                                                           
                                                                                
         CLI   REPORTOK,C'Y'       WAS REPORT RUN OKAY?                         
         BNE   LRR230              NO, NO OVERNIGHT COPY NEEDED                 
                                                                                
         LAY   RF,REQPGEN          REQUEST OVERNIGHT PATTERN GEN                
         BASR  RE,RF                                                            
                                                                                
LRR230   DS    0H                                                               
         BRAS  RE,UNLK                                                          
         B     EXIT                                                             
         EJECT                                                                  
*==================================================================             
*        SET UP FOR NETVALUE CALLS TO GET UNIT COST                             
*==================================================================             
NETI     NTR1                                                                   
         USING NETBLOCK,R6                                                      
         L     RE,ANETBLK          CLEAR NETBLOCK                               
         LA    RF,NBBLKEND-NETBLOCK                                             
         XCEFL                                                                  
                                                                                
         L     R6,ANETBLK          CLEAR NETBLOCK                               
         MVC   NBACTAM,BAGYMD                                                   
         MVC   NBSELAGY,AGENCY                                                  
         MVC   NBEFFAGY,AGENCY                                                  
         MVC   NBSELMED,QMED                                                    
         MVC   NBSELAM,BAGYMD                                                   
         MVC   NBSELCLI,QCLT                                                    
         MVC   NBSELCL2,BCLT                                                    
*        MVC   NBACLI,ACLTREC                                                   
         MVC   NBSELPRD,=C'ALL'                                                 
         MVC   NBSELOFF,SVCLTOFF                                                
         MVC   NBSELNET,NETWORK                                                 
         MVC   NBSELSTR(12),STDATE                                              
*        MVC   NBSELPRG,PROGRAM                                                 
                                                                                
         MVI   NBNOWRIT,C'N'       STOP LOCKING RECORDS                         
         MVI   NBSELPST,0                                                       
         MVI   NBSELUOP,C'A'                                                    
*        MVI   NBSELUOP,C'B'       NEGATIVE UNITS                               
         MVI   NBDATA,C'U'                                                      
         MVI   NBSEQ,C'Q'          PRESET READ '84' PASSIVE KEY                 
*        CLC   NETWORK,SPACES      WAS NETWORK ENTERED                          
*        BH    *+8                 YES                                          
*        MVI   NBSEQ,C'D'          ELSE READ'04' KEY                            
         MVI   NBMODE,NBPROCUN                                                  
*        MVC   NBSELTRF,UNITOPT                                                 
*        CLI   NBSELTRF,C'N'       IF NETWORK ONLY                              
*        BNE   *+8                                                              
         MVI   NBSELTRF,0          SET                                          
         MVC   NBAIO,AIO1                                                       
         L     R1,SYSPARMS                                                      
         L     RF,16(,R1)           COMFACS ADDRESS                             
         ST    RF,NBACOM                                                        
         GOTO1 CALLOV,DMCB,0,(C'R',X'00000A27')                                 
         L     RF,0(,R1)                                                        
         LTR   RF,RF                                                            
         BNZ   *+6                                                              
         DC    H'0'                                                             
         ST    RF,ANETIO                                                        
NETIXIT  XIT1                                                                   
         DROP  R6                                                               
         EJECT                                                                  
*==================================================================             
* SAVE BYPASSED NETWORK IN TABLE                                                
*==================================================================             
                                                                                
SVBNET   NTR1                                                                   
         L     RE,ANETABLE         NETWORKS TABLE                               
                                                                                
BNET10   OC    0(4,RE),0(RE)                                                    
         BZ    BNET20                                                           
                                                                                
         LA    RE,4(RE)                                                         
         C     RE,MAXNETBL         TEST ROOM IN LIST                            
         BL    BNET10                                                           
         DC    H'0'                MAKE NETWORK TABLE BIGGER                    
                                                                                
BNET20   MVC   0(4,RE),SAVNET      SAVE NETWORK IN TABLE                        
                                                                                
         XIT1                                                                   
         EJECT                                                                  
*=====================================================================          
* READ UNIT FILE FOR REQUESTED NETWORK, OR FIND FIRST NETWORK                   
*=====================================================================          
                                                                                
BLUNT    NTR1                                                                   
         XC    UNTABCT,UNTABCT     ZERO TABLE COUNT - USED FOR SORT             
         XC    UNTWORK,UNTWORK                                                  
*                                                                               
         L     RE,AUNTABLE                                                      
         L     RF,MAXUNTBL                                                      
         SR    RF,RE                                                            
         XCEFL                                                                  
*                                                                               
         L     RE,APRGTAB          PROGRAM/UNIT COUNT TABLE                     
         L     RF,MXPRGTAB                                                      
         SR    RF,RE                                                            
         XCEFL                                                                  
*                                                                               
         BRAS  RE,INITNET          SET TO UNIT FILE                             
                                                                                
         LA    R4,KEY                                                           
         USING NUKEY,R4                                                         
         XC    KEY,KEY                                                          
                                                                                
         MVI   NUKPTYPE,X'84'      UNIT PASSIVE KEY                             
         MVC   NUKPAM,BAGYMD       AGENCY                                       
         MVC   NUKPCLT,BCLT        CLIENT                                       
         MVC   NUKPNET,SAVNET      NEXT NETWORK FOR ALL NET REQUEST             
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
                                                                                
BLUNT10 DS    0H                                                                
         CLC   KEY(4),KEYSAVE      SAME AGY/CLT                                 
         BNE   BLUNT400             NO, DONE                                    
                                                                                
         OC    NETWORK,NETWORK     NETWORK OR NULLS FOR ALL                     
         BZ    BLUNT20                                                          
                                                                                
         CLC   NUKPNET,NETWORK     PAST REQUESTED NETWORK?                      
         BNE   BLUNT500                                                         
         B     BLUNT30                                                          
                                                                                
BLUNT20 DS    0H                                                                
         CLC   NUKPNET,SAVNET      AT END OF THIS NETWORK                       
         BE    BLUNT30                                                          
         OC    SAVNET,SAVNET       FIRST TIME THRU?                             
         BZ    BLUNT24                                                          
         MVC   NXTNET,NUKPNET      SAVE NEW NETWORK                             
         B     BLUNT500                                                         
                                                                                
BLUNT24 DS    0H                                                                
         MVC   SAVNET,NUKPNET      SAVE NEW NETWORK                             
         MVC   SVKEY,KEY                                                        
                                                                                
         BRAS  RE,GNET                                                          
         BE    BLUNT26                                                          
                                                                                
         MVC   KEY,SVKEY                                                        
         MVI   NUKPPROG,X'FF'      FORCE NEXT NETWORK                           
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
                                                                                
         CLC   KEY(4),KEYSAVE      SAME AGY/CLT                                 
         BNE   BLUNT400             NO, DONE                                    
                                                                                
         B     BLUNT24                                                          
                                                                                
BLUNT26 DS    0H                                                                
         MVC   KEY,SVKEY                                                        
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
                                                                                
         CLC   KEY(20),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
BLUNT30  DS   0H                                                                
         CLI   SVTNPR9,C'B'        BOTH MEDIA AND SKED                          
         BE    BLUNT50                                                          
                                                                                
         CLI   SVTNPR9,C'S'        SKED ONLY                                    
         BNE   BLUNT40              NO MEDIA ONLY                               
                                                                                
         CLI   NUKPSUB,C'A'        SKED ONLY                                    
         BL    BLUNT300             BYPASS                                      
         B     BLUNT50                                                          
                                                                                
BLUNT40  DS   0H                                                                
         CLI   NUKPSUB,C'A'        IF NOT MEDIA (LESS THAN A)                   
         BNL   BLUNT300             BYPASS                                      
                                                                                
BLUNT50  DS   0H                                                                
         CLC   NUKPDATE,STDATEP    IF LOW, BUMP DATE AND READ NEXT              
         BL    BLUNT60                                                          
                                                                                
         CLC   NUKPDATE,ENDATEP    PAST END DATE?                               
         BNH   BLUNT80              NO                                          
                                                                                
*        MVC   KEY,KEYSAVE                                                      
         LLC   R1,NUKPPROG+5                                                    
         LA    R1,1(,R1)                                                        
         STC   R1,NUKPPROG+5                                                    
                                                                                
BLUNT60  DS   0H                                                                
         MVC   NUKPDATE,STDATEP    FORCE TO START DATE                          
         XC    NUKPEST(4),NUKPEST  ZERO REST OF KEY                             
                                                                                
         CLI   OFFLINE,C'Y'                                                     
         BNE   BLUNT70                                                          
                                                                                
BLUNT70  DS   0H                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         B     BLUNT10                                                          
         DROP  R4                                                               
                                                                                
BLUNT80  DS   0H                                                                
         CLI   PROGRAM,C' '                                                     
         BNH   BLUNT82                                                          
         BRAS  RE,CHKPGM           MATCH PROGRAM IF INPUT                       
         BNE   BLUNT300                                                         
*                                                                               
BLUNT82  L     R6,AIO1                                                          
         ST    R6,AIO                                                           
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         OI    DMINBTS,X'08'       GET DELETES                                  
                                                                                
* DO GETREC TO TABLE UNIT IF NEEDED                                             
                                                                                
         GOTO1 GETREC                                                           
         NI    DMINBTS,X'FF'-X'08'                                              
                                                                                
         USING NURECD,R6                                                        
         TM    NUUNITST,X'42'      PREEMPTED OR MISSED                          
         BNZ   BLUNT300             TREAT AS DELETED                            
                                                                                
         TM    NUPACKST,X'20'      SKIP UNITS FROM A LOCKED PACKAGE             
         BNZ   BLUNT300             TREAT AS DELETED                            
                                                                                
         TM    22(R6),X'80'        MEDIA DELETE?                                
         BNZ   BLUNT300             BYPASS                                      
                                                                                
BLUNT82X MVI   ELCODE,X'21'                                                     
         BAS   RE,GETEL                                                         
         BE    BLUNT84                                                          
                                                                                
*IF 21 DOES NOT EXIST ADD IT TO UNIT AIOAREA                                    
                                                                                
         LA    R1,ELEM                                                          
         XC    ELEM,ELEM                                                        
         MVI   ELEM,X'21'                                                       
         MVI   ELEM+1,80                                                        
         GOTO1 ADDELEM                                                          
         MVI   ELCODE,X'21'                                                     
         L     R6,AIO1                                                          
         BAS   RE,GETEL                                                         
         BE    BLUNT84                                                          
         DC    H'0'                 UNIT JUST ADDED MUST BE THERE               
                                                                                
BLUNT84 DS    0H                                                                
                                                                                
         CLI   SVTNPR5,C'Y'       TRAFFIC DELETES ALLOWED                       
         BE    BLUNT90            YES                                           
         USING NUCMLEL,R6                                                       
         TM    NUCMLFLG,X'08'      TRAFFIC DELETE                               
         BO    BLUNT300                                                         
         DROP  R6                                                               
                                                                                
BLUNT90 DS    0H                                                                
         NI    NETFLAG,X'FF'-NETCSPRD   SET OFF COPY SPLIT PROD FLAG            
         MVI   UNSEEDED,C'N'                                                    
         MVI   UNALLOC,C'N'                                                     
                                                                                
         LA    R5,UNTWORK                                                       
         USING UNTABLED,R5                                                      
         XC    UNTWORK,UNTWORK                                                  
         MVC   UNTHIDTE,KEY+NUKPDATE-NUKPKEY                                    
         MVC   UNTLODTE,UNTHIDTE                                                
*                                                                               
         CLI   NUCMLBSL-NUCMLEL(R6),0                                           
         BE    *+8                                                              
         OI    UNTFLG2,UNTBLBD                                                  
                                                                                
         OC    NUCMLR3F-NUCMLEL(L'NUCMLR3F,R6),NUCMLR3F-NUCMLEL(R6)             
         BNZ   *+18                                                             
         OC    NUCML1-NUCMLEL(L'NUCML1,R6),NUCML1-NUCMLEL(R6)                   
         BZ    *+8                                                              
         OI    UNTFLG2,UNTNETAS                                                 
*                                                                               
         LA    RE,NUCMLR3F-NUCMLEL(R6)                                          
         MVC   UNTSEQNO,0(RE)                                                   
         OC    UNTSEQNO,UNTSEQNO   TEST UNIT SEEDED                             
         BNZ   BLUNT100                                                         
         MVI   UNSEEDED,C'Y'                                                    
         OI    UNTFLG2,UNTFUNSD    AND FLAG IT AS UNSEEDED                      
                                                                                
* GET POSSIBLE ROTATION DATES                                                   
                                                                                
BLUNT100 DS   0H                                                                
         L     R6,AIO1                                                          
         USING NURECD,R6                                                        
         MVC   UNTSLN,NULEN                                                     
         MVC   UNTPROG,NUKPROG                                                  
         MVC   UNTDP,NUKDP                                                      
         MVC   UNTTIME,NUTIME      MOVE START/END TIMES                         
                                                                                
         MVC   BYTE,NUDAY                                                       
         MVC   UNTDAY,NUDAY                                                     
                                                                                
BLUNT104 L     R6,AIO1                                                          
         MVI   ELCODE,X'02'                                                     
         BAS   RE,GETEL                                                         
         BNE   BLUNT120                                                         
                                                                                
         USING NUSDRD,R6                                                        
                                                                                
         CLI   NUSDROT,0           ROTATION OVERRRIDE                           
         BE    *+10                 NO, BYPASS USE DAY                          
         MVC   BYTE,NUSDROT                                                     
         MVC   UNTROT,NUSDROT                                                   
                                                                                
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,UNTHIDTE),(0,WORK)                                
         GOTO1 GETDAY,DMCB,WORK,WORK+6                                          
         LLC   RF,0(R1)            GET DAY OF WEEK                              
                                                                                
         XC    WORK,WORK                                                        
         LLC   R0,NUSDROT                                                       
         SLL   R0,25                                                            
         SR    R1,R1               CLEAR COUNTER                                
                                                                                
         LTR   RF,RF                                                            
         BZ    BLUNT110                                                         
         SLL   R0,1                ONLY COUNT DAYS AFTER NUKPDATE               
         BCT   RF,*-4                                                           
                                                                                
BLUNT110 LTR   R0,R0               COUNT UNTIL NO DAYS LEFT                     
         BZ    BLUNT114                                                         
         SLL   R0,1                                                             
         BCT   R1,BLUNT110                                                      
                                                                                
BLUNT114 LPR   R0,R1               GET # OF DAYS IN ROT AFTER NUKPDATE          
                                                                                
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,UNTHIDTE),(0,WORK)                                
         GOTO1 ADDAY,(R1),WORK,WORK+6,(R0)                                      
         FIXDT02                                                                
         GOTO1 DATCON,(R1),(0,WORK+6),(2,UNTHIDTE)                              
                                                                                
         CLC   UNTHIDTE,ENDATEP    CAN NOT RUN OVER ENDATE                      
         BNH   BLUNT120                                                         
         MVC   UNTHIDTE,ENDATEP    FORCE TO ENDATE                              
                                                                                
                                                                                
* SEE IF COPY SPLIT                                                             
                                                                                
         USING NUSDRD,R6                                                        
BLUNT120 TM    NUSDST3,X'40'       UNIT A COPY SPLIT                            
         BZ    BLUNT122             NO                                          
         OI    NETFLAG,NETCSPRD    SET ON COPY SPLIT PROD FLAG                  
         OI    ANYFLAG,COPYSSW                                                  
         XC    DUB,DUB                                                          
                                                                                
BLUNT122 DS   0H                                                                
         L     R6,AIO1                                                          
         USING NURECD,R6                                                        
         LLC   R0,NULEN            GET TOTAL LEN                                
         STC   R0,UNTSLN                                                        
         SR    R1,R1                                                            
         ICM   R1,1,NULEN1         PRD 1 LEN                                    
         BZ    BLUNT124                                                         
         STC   R1,UNTSLN                                                        
         SR    R0,R1                                                            
         STC   R0,UNTSLN2                                                       
*                                                                               
BLUNT124 XC    NUCPRDS,NUCPRDS                                                  
         L     R6,AIO1                                                          
         MVI   ELCODE,X'19'                                                     
         BRAS  RE,GETEL            SEE IF NEW 3 CHAR PROD CODE ELEM             
         BE    BLUNT128                                                         
         L     R6,AIO1                                                          
         CLI   NUPRD,0                                                          
         BNE   BLUNT126                                                         
* UNIT IS UNALLOCATED                                                           
         MVI   UNALLOC,C'Y'       SET UNALLOCATED FLAG                          
         B     BLUNT153                                                         
BLUNT126 DS    0H                                                               
         LA    R0,NCLSTSIZ                                                      
         L     R1,ASVNCLST                                                      
BLUN126A CLC   NUPRD,3(R1)                                                      
         BE    BLUN126B                                                         
         LA    R1,4(R1)                                                         
         CLI   0(R1),C' '                                                       
         BNH   *+8                                                              
         BCT   R0,BLUN126A                                                      
         DC    H'0'                                                             
BLUN126B MVC   UNTPROD,0(R1)                                                    
         B     BLUNT136                                                         
*                                                                               
         USING NUPDED,R6                                                        
BLUNT128 TM    NUPDEIND,X'40'      THIS A COPY SPLIT?                           
         BZ    BLUNT130             NO                                          
         OI    NETFLAG,NETCSPRD    THIS IS A COPY SPLIT                         
         OI    ANYFLAG,COPYSSW                                                  
         B     BLUNT136                                                         
                                                                                
BLUNT130 LLC   R0,NUPDELEN                                                      
         SHI   R0,3                                                             
         LA    R1,NUPDEPR                                                       
         LR    RE,R0                                                            
         LR    RF,R1                                                            
         OC    OPTPROD,OPTPROD     FILTERING ON PROD                            
         BZ    BLUNT132                                                         
BLUNT131 DS    0H                                                               
         CLC   0(3,R1),OPTPROD                                                  
         BNE   BLUNT300                                                         
                                                                                
* NOW SAVE PRODS FROM 19 ELEM                                                   
                                                                                
BLUNT132 DS   0H                                                                
         LA    R0,6                MAX PRDS IN ELEM                             
         XC    NUCPRDS,NUCPRDS                                                  
         LA    R1,NUCPRD1                                                       
                                                                                
BLUNT134 DS    0H                                                               
         MVC   0(3,R1),0(RF)                                                    
         AHI   R1,3                                                             
         AHI   RF,7                                                             
         SHI   RE,7                                                             
         BCT   R0,*+6                                                           
         DC    H'0'                                                             
         LTR   RE,RE                                                            
         BNZ   BLUNT134                                                         
                                                                                
         TM    NETFLAG,NETCSPRD    IF A COPY SPLIT                              
         BO    BLUNT136                                                         
                                                                                
         MVC   UNTPROD(3),NUCPRD1                                               
         MVC   UNTPROD2(3),NUCPRD2                                              
                                                                                
         OC    NUCPRD2,NUCPRD2     P/B PROD?                                    
         BZ    BLUNT136                                                         
         OI    ANYFLAG,PIGGBSW     SET P/B FLAG                                 
         CLI   UNTSLN2,0           IF NO LEN FOR PROD 2 NEED                    
         BNE   BLUNT136            TO DIVIDE LEN 1 BY 2 FOR                     
         LLC   R0,UNTSLN           GET TOTAL LEN                                
         SRL   R0,1                DIVIDE BY 2 (PER LINE)                       
         STC   R0,UNTSLN                                                        
         STC   R0,UNTSLN2                                                       
                                                                                
BLUNT136 DS    0H                                                               
*        SEE IF THIS UNIT HAS 5 SECONDS TAG                                     
         L     R6,AIO1                                                          
         MVI   ELCODE,X'60'                                                     
         LA    R6,27(R6)                                                        
BLUNT138 BAS   RE,NEXTEL                                                        
         BNE   BLUNT140                                                         
                                                                                
         CLI   2(R6),C'Q'          IS THIS A TAG ELEMENT                        
         BNE   BLUNT138                                                         
         CLI   3(R6),C'T'          T=TAG                                        
         BNE   BLUNT138                                                         
                                                                                
         OI    UNTFLG,UNTTAG                                                    
                                                                                
         PACK  DUB,4(1,R6)                                                      
         CVB   R0,DUB              TAGS IN BINARY                               
         MHI   R0,5                TIMES 5 (5 SECONDS PER TAG)                  
         ZIC   R1,UNTSLN           TOTAL UNIT LEN                               
         SR    R1,R0               MINUS TAG LEN                                
         STC   R1,UNTSLN           = ACTUAL UNIT LENGTH                         
                                                                                
BLUNT140 DS   0H                                                                
         L     R6,AIO1                                                          
         USING NURECD,R6                                                        
                                                                                
         OC    OPTPROD,OPTPROD                                                  
         BZ    BLUNT141                                                         
         CLC   OPTPROD,UNTPROD                                                  
         BNE   BLUNT300                                                         
BLUNT141 DS    0H                                                               
         OC    OPTPRGR,OPTPRGR     ANY PRODUCT GROUP                            
         BZ    BLUNT145             NO                                          
         TM    NETFLAG,NETCSPRD    IF A COPY SPLIT TEST IT LATER                
         BO    BLUNT145            WE DO NOT HAVE PRODS YET                     
                                                                                
         BAS   RE,FPG              FILTER ON PRODUCT GROUP                      
         BNE   BLUNT300                                                         
                                                                                
BLUNT145 DS   0H                                                                
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY CLIENT                  
         BZ    BLUNT150                                                         
                                                                                
         BRAS  RE,BLSEC            BRAND LEVEL SECURITY CHECK                   
         BNE   BLUNT300                                                         
                                                                                
BLUNT150 DS   0H                                                                
         L     R6,AIO1                                                          
                                                                                
         MVI   ELCODE,X'21'                                                     
         BAS   RE,GETEL                                                         
         BE    BLUNT151                                                         
                                                                                
*IF 21 DOES NOT EXIST ADD IT TO UNIT AIOAREA                                    
                                                                                
         LA    R1,ELEM                                                          
         XC    ELEM,ELEM                                                        
         MVI   ELEM,X'21'                                                       
         MVI   ELEM+1,80                                                        
         GOTO1 ADDELEM                                                          
         MVI   ELCODE,X'21'                                                     
         L     R6,AIO1                                                          
         BAS   RE,GETEL                                                         
         BE    BLUNT151                                                         
         DC    H'0'                 UNIT JUST ADDED MUST BE THERE               
                                                                                
BLUNT151 DS   0H                                                                
         USING NUCMLEL,R6                                                       
                                                                                
         OC    NUCML2,NUCML2                                                    
         BZ    *+8                                                              
         OI    ANYFLAG,PIGGBSW                                                  
                                                                                
         TM    NETFLAG,NETCSPRD    IS THIS COPY SPLIT                           
         BZ    BLUNT152             NO WE HAVE PROD                             
                                                                                
         OC    NUCMPROD,NUCMPROD   PRODUCT ALLOCATED                            
         BZ    BLUNT300             NO, BYPASS                                  
                                                                                
         MVC   UNTPROD,NUCMPROD    AND TABLE IT                                 
                                                                                
         OC    OPTPRGR,OPTPRGR     ANY PRODUCT GROUP                            
         BZ    *+12                 NO                                          
         BAS   RE,FPG              FILTER ON PRODUCT GROUP                      
         BNE   BLUNT300                                                         
                                                                                
         OC    OPTPROD,OPTPROD     PROD FILTER?                                 
         BZ    BLUNT152             NO                                          
                                                                                
         CLC   OPTPROD,UNTPROD                                                  
         BNE   BLUNT300                                                         
                                                                                
BLUNT152 DS   0H                                                                
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY CLIENT                  
         BZ    BLUNT153                                                         
                                                                                
         BRAS  RE,BLSEC            BRAND LEVEL SECURITY CHECK                   
         BNE   BLUNT300                                                         
                                                                                
BLUNT153 CLI   KEY+NUKPSUB-NUKPKEY,C'A'  SKED UNIT                              
         BNL   BLUNT154                                                         
                                                                                
* SEE IF ESTIMATE IS CODED N TO BYPASS UNITS *                                  
                                                                                
         OC    UNTPROD,UNTPROD     TEST UNALLOCATED                             
         BZ    BLUNT154                                                         
*                                                                               
         BRAS  RE,CKEST                                                         
         BE    BLUNT300             YES                                         
                                                                                
BLUNT154 DS   0H                                                                
         TM    NUCMLFL2,NUCMLFFD   IS THIS NO NATIONAL UNIT, JUST FEEDS         
         BO    BLUNT166             YES                                         
                                                                                
* CODE HERE FOR BUILDING UNTABLE ENTRIES FOR NATIONAL & FEEDS                   
                                                                                
         L     R6,AIO1                                                          
         MVI   ELCODE,X'22'                                                     
         BAS   RE,GETEL                                                         
         BNE   BLUNT160                                                         
         MVC   UNTFEED,2(R6)       SAVE FEED CD FOR UNIT BOUGHT AS FEED         
                                                                                
BLUNT160 DS   0H                                                                
         CLI   MODE,VALKEY         VALIDATE RECORD KEY                          
         BE    BLUNT161                                                         
         CLI   SVTN1PR3,C'S'                                                    
         BE    BLUNT161                                                         
         USING NETBLOCK,R6                                                      
         L     R6,ANETBLK          CLEAR NETBLOCK                               
         MVC   NBKEY,KEY                                                        
         MVC   NBAIO,AIO1                                                       
         MVI   NBFUNCT,NBFVAL                                                   
         GOTO1 ANETIO,DMCB,(R6)                                                 
         MVC   UNTACCST,NBACTUAL                                                
         MVC   UNTKEYCS,NBACTUAL                                                
         DROP  R6                                                               
                                                                                
BLUNT161 DS   0H                                                                
         BAS   RE,SAVUNT           GO SAVE ENTRY IN UNTABLE                     
                                                                                
*=================================================================              
* POST UNIT TO PROGRAM/UNIT COUNT TABLE                                         
*=================================================================              
                                                                                
         L     RE,APRGTAB                                                       
         USING PRGTABLD,RE                                                      
*                                                                               
BLUNT162 DS    0H                                                               
         CLI   0(RE),0                                                          
         BE    BLUNT164                                                         
*                                                                               
         C     RE,MXPRGTAB                                                      
         BL    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   PRGPROG,KEY+NUKPPROG-NUKEY                                       
         BE    BLUNT164                                                         
         LA    RE,PRGNEXT                                                       
         B     BLUNT162                                                         
*                                                                               
BLUNT164 MVC   PRGPROG,KEY+NUKPPROG-NUKEY  POINT TO PROGRAM CODE                
         LH    RF,PRGUNITS                                                      
         LA    RF,1(RF)                                                         
         STH   RF,PRGUNITS                                                      
*                                                                               
         TM    UNTFLG2,UNTBLBD                                                  
         BZ    *+8                                                              
         OI    PRGFLAG,PRGF_BB                                                  
                                                                                
         TM    UNTFLG2,UNTNETAS                                                 
         BZ    *+8                                                              
         OI    PRGFLAG,PRGF_NAS                                                 
*                                                                               
         LH    RF,PRGUNSD                                                       
         CLI   UNSEEDED,C'Y'                                                    
         BNE   *+8                                                              
         LA    RF,1(RF)                                                         
         STH   RF,PRGUNSD                                                       
*                                                                               
         LH    RF,PRGUNAL                                                       
         CLI   UNALLOC,C'Y'                                                     
         BNE   *+8                                                              
         LA    RF,1(RF)                                                         
         STH   RF,PRGUNAL                                                       
*                                                                               
         OC    UNTABCT,UNTABCT     FIND ANY UNITS                               
         BZ    BLUNT170                                                         
         TM    UPDSW,UPDSWFU       ONLY LOOKING FOR 1 UNIT                      
         JO    EXIT                                                             
         B     BLUNT170                                                         
         DROP  RE                                                               
                                                                                
BLUNT166 DS    0H                                                               
         OI    UNTFLG,UNTFLNON     SET ON NO NATIONAL UNIT FLAG                 
                                                                                
BLUNT170 DS   0H                                                                
         L     R6,AIO1                                                          
         MVI   ELCODE,X'23'                                                     
         BAS   RE,GETEL                                                         
         BNE   BLUNT300                                                         
                                                                                
         USING NUFDCEL,R6                                                       
                                                                                
BLUNT180 DS   0H                                                                
         ST    R6,SVR6             SAVE R6                                      
         TM    NETFLAG,NETCSPRD    IS THIS COPY SPLIT                           
         BZ    BLUNT190             NO HAVE PROD AND CHECKED IF BEFORE          
                                                                                
         OC    NUFDPROD,NUFDPROD    GET PRD HERE                                
         BZ    BLUNT300                                                         
         MVC   UNTPROD,NUFDPROD                                                 
         MVC   UNTSEQNO,NUFDCR3F                                                
*        B     BLUNT190                                                         
                                                                                
BLUNT182 DS   0H                                                                
         OC    OPTPROD,OPTPROD                                                  
         BZ    BLUNT190                                                         
                                                                                
         CLC   OPTPROD,UNTPROD                                                  
         BNE   BLUNT200                                                         
                                                                                
BLUNT190 DS   0H                                                                
         OC    OPTPRGR,OPTPRGR     ANY PRODUCT GROUP                            
         BZ    BLUNT200             NO                                          
         BAS   RE,FPG              FILTER ON PRODUCT GROUP                      
         BNE   BLUNT210                                                         
                                                                                
BLUNT200 DS   0H                                                                
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY CLIENT                  
         BZ    BLUNT205                                                         
                                                                                
         BRAS  RE,BLSEC            BRAND LEVEL SECURITY CHECK                   
         BNE   BLUNT300                                                         
                                                                                
BLUNT205 MVC   UNTFEED,NUFDCFED    SAVE FEED CD FOR UNIT FEED                   
         CLI   MODE,VALKEY         VALIDATE RECORD KEY                          
         BE    BLUNT208                                                         
         CLI   SVTN1PR3,C'S'                                                    
         BE    BLUNT208                                                         
         USING NETBLOCK,R6                                                      
         L     R6,ANETBLK          CLEAR NETBLOCK                               
         MVC   NBKEY,KEY                                                        
         MVC   NBAIO,AIO1                                                       
         MVI   NBFUNCT,NBFVAL                                                   
         GOTO1 ANETIO,DMCB,(R6)                                                 
         MVC   UNTACCST,NBACTUAL                                                
         MVC   UNTKEYCS,NBACTUAL                                                
         DROP  R6                                                               
                                                                                
BLUNT208 DS   0H                                                                
         BAS   RE,SAVUNT           GO SAVE ENTRY IN UNTABLE                     
                                                                                
         TM    UPDSW,UPDSWFU       ONLY LOOKING FOR 1 UNIT                      
         JO    EXIT                                                             
                                                                                
BLUNT210 DS   0H                                                                
         L     R6,SVR6             RESTORE R6                                   
         BAS   RE,NEXTEL                                                        
         BE    BLUNT180                                                         
                                                                                
BLUNT300 DS   0H                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
         B     BLUNT10                                                          
                                                                                
BLUNT400 DS   0H                                                                
         MVI   NXTNET,X'FF'        SET ALL DONE AFTER THIS NET IS PRTED         
                                                                                
BLUNT500 DS   0H                                                                
         L     R5,AUNTABLE                                                      
         USING UNTABLED,R5                                                      
         OI    UPDSW,UPDSWNP       SET ON NO PATTERNS FOUND                     
*                                                                               
BLUNT510 DS   0H                                                                
         CLI   UNTPROD2,0          CK P/B PROD                                  
         BE    BLUNT520                                                         
         CLC   UNTPROD,UNTPROD2                                                 
         BL    BLUNT520                                                         
         XC    UNTPROD(4),UNTPROD2                                              
         XC    UNTPROD2(4),UNTPROD                                              
         XC    UNTPROD(4),UNTPROD2                                              
         OI    UNTFLG,UNTFLGSW     SET ON PRODS SWAPPED                         
                                                                                
BLUNT520 LA    R5,UNTNEXT                                                       
         OC    UNTENT,UNTENT       END OF UNITS                                 
         BNZ   BLUNT510                                                         
                                                                                
BLUNT630 DS   0H                                                                
         L     R4,APRGTAB          GET PROGRAM COUNT TABLE                      
         USING PRGTABLD,R4                                                      
         CLI   PRGPROG,0           TEST NO DATA                                 
         BE    BLUNT650                                                         
*                                                                               
BLUNT632 DS    0H                                                               
         TM    PRGFLAG,PRGF_BB                                                  
         BZ    BLUNT633                                                         
         LA    R1,XTYPE8                                                        
         B     BLUNTERR                                                         
*                                                                               
BLUNT633 DS    0H                                                               
         LA    R1,XTYPE2                                                        
         CLC   PRGUNAL,PRGUNITS    TEST ALL UNALLOCATED                         
         BE    BLUNTERR                                                         
         LA    R1,XTYPE5                                                        
         OC    PRGUNAL,PRGUNAL     TEST ANY UNALLOCATED UNITS                   
         BZ    BLUNT635            NO                                           
         CLI   SVTNPR3,C'Y'        TN PROF ALLOW UNALLOCATED UNITS              
         BE    BLUNT635            YES                                          
         TM    SVOPTSW,OPTUNAL     TEST ALLOW UNALL                             
         BZ    BLUNTERR                                                         
*                                                                               
BLUNT635 DS    0H                                                               
         CLI   CONREC,C'C'         TEST DOING CABLEGEN                          
         BNE   BLUNT640                                                         
*                                                                               
         OC    PRGUNSD,PRGUNSD     TEST ANY UNSEEDED UNITS FOUND                
         BZ    BLUNT636            NO                                           
         TM    SVOPTSW1,OPTUNSD    TEST UNSEEDED UNITS OK                       
         BO    BLUNT636                                                         
         LA    R1,XTYPE6                                                        
         B     BLUNTERR                                                         
*                                                                               
BLUNT636 DS    0H                                                               
         TM    PRGFLAG,PRGF_NAS                                                 
         BZ    BLUNT637                                                         
         LA    R1,XTYPE9                                                        
         B     BLUNTERR                                                         
*                                                                               
BLUNT637 DS    0H                                                               
         CLC   PRGUNSD,PRGUNITS    TEST ALL UNITS UNSEEDED                      
         BNE   BLUNT640                                                         
         LA    R1,XTYPE4                                                        
         B     BLUNTERR                                                         
*                                                                               
BLUNTERR DS    0H                                                               
         CLI   MODE,VALKEY         VALIDATE RECORD KEY                          
         BE    *+8                                                              
*                                                                               
         BRAS  RE,XPUT                                                          
         OI    PRGFLAG,PRGF_SKIP                                                
*                                                                               
BLUNT640 LA    R4,PRGNEXT                                                       
         CLI   PRGPROG,0                                                        
         BE    BLUNT650                                                         
         C     R4,MXPRGTAB                                                      
         BL    BLUNT632                                                         
                                                                                
*==================================================================             
* FOR ALL PROGRAMS SET TO SKIP - FLAG AND REMOVE UNIT TABLE ENTRIES             
*==================================================================             
                                                                                
BLUNT650 DS    0H                                                               
         CLI   CONREC,C'C'         TEST DOING CABLEGEN                          
         BNE   BLUNT660                                                         
*                                                                               
         L     R4,APRGTAB                                                       
*                                                                               
BLUNT652 TM    PRGFLAG,PRGF_SKIP                                                
         BZ    BLUNT656                                                         
         L     R5,AUNTABLE                                                      
*                                                                               
BLUNT654 CLC   UNTPROG,PRGPROG     MATCH PROG                                   
         BNE   *+10                                                             
         MVC   UNTPROD,=X'FFFFFF'  SET TO SORT LAST                             
*                                                                               
         LA    R5,UNTNEXT                                                       
         OC    UNTENT,UNTENT                                                    
         BNZ   BLUNT654                                                         
*                                                                               
BLUNT656 LA    R4,PRGNEXT                                                       
         CLI   PRGPROG,0                                                        
         BE    BLUNT660                                                         
         C     R4,MXPRGTAB                                                      
         BL    BLUNT652                                                         
         DROP  R4                                                               
                                                                                
*============================================================                   
* FOR PATTERN/GEN, REMOVE ALL UNALLOCATED UNIT ENTRIES                          
*============================================================                   
                                                                                
BLUNT660 CLI   CONREC,C'P'         TEST PATTERN/GEN                             
         BNE   BLUNT670                                                         
*                                                                               
         L     R5,AUNTABLE                                                      
         LH    R2,UNTABCT                                                       
*                                                                               
BLUNT662 OC    UNTPROD,UNTPROD                                                  
         BNZ   *+10                                                             
         MVC   UNTPROD,=X'FFFFFF'                                               
*                                                                               
         LA    R5,UNTNEXT                                                       
         OC    UNTENT,UNTENT                                                    
         BNZ   BLUNT662                                                         
*                                                                               
BLUNT670 L     R5,AUNTABLE                                                      
         LH    R2,UNTABCT                                                       
                                                                                
* SORT TABLE BY PRD/PRD2/LEN/DAYP/FEED/PRG/LOWDATE/HIDATE/PSEQ                  
                                                                                
         GOTO1 QSORT,DMCB,(R5),(R2),L'UNTENT,L'UNTSRT,0                         
                                                                                
* AND NOW COUNT THE ENTRIES ONE MO' TIME                                        
                                                                                
         L     R5,AUNTABLE                                                      
         SR    R0,R0                                                            
*                                                                               
BLUNT672 OC    UNTENT,UNTENT                                                    
         BZ    BLUNT674                                                         
         CLI   UNTPROD,X'FF'       PRD=FF IS EOT FLAG                           
         BE    BLUNT674                                                         
         LA    R5,UNTNEXT                                                       
         BCT   R0,BLUNT672                                                      
*                                                                               
BLUNT674 LPR   R0,R0               MAKE COUNTER POSITIVE                        
         STH   R0,UNTABCT          AND SAVE IT                                  
                                                                                
* CLEAR REMAINING FF ENTRIES                                                    
                                                                                
BLUNT676 XC    UNTENT,UNTENT       CLEAR THIS ENTRY!                            
         LA    R5,UNTNEXT                                                       
         OC    UNTENT,UNTENT                                                    
         BNZ   BLUNT676                                                         
*                                                                               
BLUNTX   J     EXIT                                                             
         EJECT                                                                  
*================================================================               
* FILTER ON PROGRAM CODE                                                        
*================================================================               
                                                                                
CHKPGM   NTR1                                                                   
         LA    RE,NUKPPROG-NUKPKEY+KEY   POINT TO PROGRAM CODE                  
         CLC   PROGRAM,0(RE)                                                    
         JE    EQXIT                                                            
*                                                                               
         LA    R0,30               MAX ENTRIES                                  
         LA    R1,EQVPTBL                                                       
         USING EQVPTBLD,R1                                                      
*                                                                               
CHKPGM2  CLC   0(6,RE),0(R1)       MATCH EQV PROG                               
         JE    EQXIT                                                            
         LA    R1,EQVNEXT                                                       
         CLI   0(R1),C' '                                                       
         JNH   NEQXIT                                                           
         BCT   R0,CHKPGM2                                                       
         J     NEQXIT                                                           
         DROP  R1                                                               
         EJECT                                                                  
* FILTER ON PRODUCT GROUP *                                                     
                                                                                
FPG      DS   0H                                                                
         LA    R0,L'OPTPGRL/3                                                   
         LHI   R1,OPTPGRL-SYSD                                                  
         AR    R1,R9                                                            
FPG10    CLC   UNTPROD,0(R1)                                                    
         BE    FPGEQ                                                            
         AHI   R1,3                                                             
         CLI   0(R1),0             END OF LIST                                  
         BE    *+8                  YES                                         
         BCT   R0,FPG10                                                         
                                                                                
         LTR   RB,RB                                                            
         BR    RE                                                               
FPGEQ    CR    RB,RB                                                            
         BR    RE                                                               
         EJECT                                                                  
*=====================================================================          
* MERGE OR ADD NEW UNIT TABLE ENTRY                                             
*=====================================================================          
                                                                                
NEW      USING UNTABLED,UNTWORK                                                 
                                                                                
SAVUNT   NTR1                                                                   
         L     R5,AUNTABLE                                                      
         USING UNTABLED,R5                                                      
*                                                                               
         CLI   CONREC,C'C'         TEST CABLEGEN                                
         BNE   SAVUNT10                                                         
         CLI   UNALLOC,C'Y'        TEST UNIT UNALLOCATED                        
         BE    SAVUNTX                                                          
*                                                                               
SAVUNT10 OC    UNTENT,UNTENT                                                    
         BZ    SAVUNT20                                                         
         CLC   UNTCOMP,UNTWORK                                                  
         BE    SAVUNT30                                                         
                                                                                
SAVUNT15 LA    R5,UNTNEXT                                                       
         C     R5,MAXUNTBL                                                      
         BNL   SVUNTERR                                                         
         B     SAVUNT10                                                         
*                                                                               
SAVUNT20 LH    R1,UNTABCT                                                       
         LA    R1,1(,R1)                                                        
         STH   R1,UNTABCT                                                       
         MVC   UNTENT,UNTWORK                                                   
         MVI   UNTCT+1,1                                                        
         B     SAVUNTX                                                          
                                                                                
SAVUNT30 DS   0H                                                                
         CLC   UNTHIDTE,NEW.UNTHIDTE                                            
         BE    SAVUNT50                                                         
         CLC   UNTLODTE,NEW.UNTLODTE                                            
         BE    SAVUNT50                                                         
         B     SAVUNT15                                                         
                                                                                
SAVUNT50 DS    0H                                                               
         CLC   UNTKEYCS,NEW.UNTKEYCS                                            
         BNE   SAVUNT15                                                         
                                                                                
         SR    RF,RF                                                            
         ICM   RF,3,UNTCT                                                       
         LA    RF,1(,RF)                                                        
         STCM  RF,3,UNTCT                                                       
                                                                                
SAVUNT60 DS    0H                                                               
         SR    RF,RF                                                            
         ICM   RF,15,UNTACCST                                                   
         SR    R0,R0                                                            
         ICM   R0,15,NEW.UNTACCST                                               
         AR    RF,R0                                                            
         STCM  RF,15,UNTACCST                                                   
                                                                                
SAVUNTX  B     EXIT                                                             
         DROP  NEW                                                              
                                                                                
SVUNTERR XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(L'UNTSIZMS),UNTSIZMS                                     
         LA    R2,TRANETH                                                       
         MVC   CONHEAD+27(4),SAVNET                                             
         GOTO1 ERREX2                                                           
*                                                                               
UNTSIZMS DC    C'* ERROR * TOO MANY UNITS - XXXX *'                             
         EJECT                                                                  
*===================================================                            
*        NO FAX FOUND                                                           
*===================================================                            
                                                                                
FAXERR   LA    R2,TRANETH                                                       
         MVC   GERROR,=Y(NOFAX)                                                 
         XC    ELEM,ELEM                                                        
         LA    R1,ELEM                                                          
         STCM  R1,7,GASUBST        A(SUBST TEXT)                                
         MVI   ELEM,8              L'SUBST TEXT+1                               
         MVC   ELEM+1(7),=C'NETWORK'                                            
         CLI   SVTWPR11,C'Y'       TRAFFIC RECS FOR FAX #                       
         BNE   *+10                                                             
         MVC   ELEM+1(7),=C'TRAFFIC'                                            
         NI    TRANETH+4,X'FF'-X'20' SET OFF VALIDATED                          
         GOTO1 VTRAERR                                                          
         EJECT                                                                  
* INITIALIZE TSAROFF                                                            
                                                                                
INITSROF NTR1                                                                   
         XC    PRTCT,PRTCT                                                      
         XC    TSAROFF,TSAROFF                                                  
         XC    TSARBYTE,TSARBYTE                                                
                                                                                
         L     R0,=A(L'ELEM*5000)                                               
         ST    R0,TSARBUFL                                                      
         GETMAIN RC,LV=(0),LOC=(ANY,ANY)                                        
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,TSARBUFF                                                      
                                                                                
         LHI   RE,TSARBLK-SYSD                                                  
         AR    RE,R9                                                            
         LR    R2,RE                                                            
         LA    RF,TSARDL2                                                       
         XCEF                                                                   
         USING TSARD,R2                                                         
                                                                                
         MVC   TSACOM,ACOMFACS                                                  
         MVI   TSKEYL,2                                                         
         MVI   TSRECL+1,138                                                     
         OI    TSRECI,TSRVAR                                                    
         MVC   TSABUF,TSARBUFF                                                  
         MVC   TSAREC,TSARBUFL                                                  
                                                                                
* TSAR CALLOV HERE                                                              
                                                                                
         GOTO1 CALLOV,DMCB,0,(C'R',X'00000A7D')                                 
         ICM   RF,15,0(R1)                                                      
         BNZ   *+6                                                              
         DC    H'0'                                                             
         ST    RF,TSAROFF                                                       
                                                                                
         MVI   TSOFFACT,TSAINI      SET 1ST TSAROFF FOR INIT                    
         GOTO1 TSAROFF,(R2)                                                     
         CLI   TSERRS,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         XIT1                                                                   
         EJECT                                                                  
         PRINT GEN                                                              
         GETEL R6,DATADISP,ELCODE                                               
         PRINT NOGEN                                                            
         EJECT                                                                  
*        ERROR ROUTINES                                                         
                                                                                
NOUNTERR DS    0H                                                               
         TM    WHEN,X'20'          IS THIS SOON                                 
         BZ    NOUERR10                                                         
                                                                                
         CLI   OFFLINE,C'Y'                                                     
         BNE   NOUERR10                                                         
                                                                                
         TM    SVOPTSW,OPTTEST     TEST OPTION TEST                             
         BO    NOUERR10                                                         
                                                                                
* UNLOCK FOR SOON UPDATES                                                       
                                                                                
         CLC   =C'ALL',TRANET      IF ALL CHECK ALL                             
         BNE   NOUERR10            FOR SINGLE NETWORK SKIP UNLOCK               
                                                                                
         CLI   CONREC,C'C'         TEST CABLEGEN                                
         BNE   *+12                                                             
         BRAS  RE,CUNLK                                                         
         B     NOUERR10                                                         
                                                                                
         MVC   DUB(4),=C'UNET'                                                  
         MVI   DUB+4,X'21'                                                      
         XC    DUB+5(3),DUB+5                                                   
         CLC   =C'ALL',TRANET      IF ALL CHECK ALL                             
         BE    UNTER05                                                          
         B     NOUERR10            FOR SINGLE NETWORK SKIP UNLOCK               
                                                                                
         MVI   DUB+5,X'FF'         MARKER FOR BY NET                            
         MVC   FULL,NETWORK        LOCK BY NET                                  
UNTER05  GOTO1 VALILOC,0                                                        
                                                                                
NOUERR10 LA    R2,TRANETH                                                       
         MVC   GERROR,=Y(NOUNTPER)    NO UNITS FOR PERIOD                       
         GOTO1 VTRAERR                                                          
                                                                                
OFFLNERR XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(L'OFFLINMS),OFFLINMS                                     
         GOTO1 ERREX2                                                           
                                                                                
OFFLERCG XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(L'OFFLMSCG),OFFLMSCG                                     
         GOTO1 ERREX2                                                           
                                                                                
SEEDERR  XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(L'SEEDMS),SEEDMS                                         
         GOTO1 ERREX2                                                           
                                                                                
SEEDERR1 XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(L'SEEDMS1),SEEDMS1                                       
         GOTO1 ERREX2                                                           
                                                                                
SEEDERR2 XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(L'SEEDMS2),SEEDMS2                                       
         GOTO1 ERREX2                                                           
                                                                                
FAX2ERR  XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(L'FAX2MSG),FAX2MSG                                       
         GOTO1 ERREX2                                                           
                                                                                
TRAPERR2 DS    0H                                                               
         TM    WHEN,X'20'          IS THIS SOON                                 
         BZ    PATER10                                                          
                                                                                
         CLI   OFFLINE,C'Y'                                                     
         BNE   PATER10                                                          
                                                                                
         TM    SVOPTSW,OPTTEST     TEST OPTION TEST                             
         BO    PATER10                                                          
                                                                                
         XC    FLD,FLD                                                          
         MVC   FLD,ELEM            SAVE OFF ERROR MESSAGE                       
                                                                                
* UNLOCK FOR SOON UPDATES                                                       
                                                                                
         BRAS  RE,UNLK                                                          
         B     PATER06                                                          
                                                                                
PATER06  MVC   ELEM(L'FLD),FLD     PUT BACK ERROR MESSAGE TO ELEM               
                                                                                
PATER10  DS    0H                                                               
         GOTO1 VTRAERR                                                          
                                                                                
MISSERR  MVI   ERROR,MISSING                                                    
         B     TRAPERR                                                          
                                                                                
NOTDDSER MVI   ERROR,POPTNTOK      CAN'T DO NOW UNLESS DDS                      
         LA    R2,CONWHENH                                                      
         B     TRAPERR                                                          
                                                                                
NUMERR   MVI   ERROR,NOTNUM                                                     
                                                                                
TRAPERR  DS   0H                                                                
         TM    WHEN,X'20'          THIS SOON PROCESSING                         
         BZ    TRAPERRX             NO                                          
                                                                                
         TM    SVOPTSW,OPTTEST     THIS A TEST RUN                              
         BO    TRAPERRX             NO UPDATE, NO NEED TO LOCK                  
                                                                                
         TM    SVOPTSW1,OPTHDCPY   IF AGENCY COPY RUN                           
         BO    TRAPERRX             NO UPDATE, NO NEED TO LOCK                  
                                                                                
         CLI   OFFLINE,C'Y'        THIS AN OFFLINE REQUEST                      
         BNE   TRAPERRX             NO UPDATE, NO NEED TO LOCK                  
                                                                                
         BRAS  RE,UNLK                                                          
TRAPERRX GOTO1 ERREX                                                            
                                                                                
         LTORG                                                                  
OFFLINMS DC    C'*ERROR* ALL NETWORKS RUN OV OR SOON *'                         
OFFLMSCG DC    C'*ERROR* RUN OV, OR RUN SOON OPTION TEST *'                     
SEEDMS   DC    C'*ERROR* SEED MUST BE Y OR N, DEFAULT IS Y *'                   
SEEDMS1  DC    C'*ERROR* SEED MUST BE N WITH AGENCY COPY *'                     
SEEDMS2  DC    C'*ERROR* SEED MUST BE N WITH OPTION TEST *'                     
FAX2MSG  DC    C'*ERROR* NO FAX NUMBER FOUND FOR NETWORK *'                     
         EJECT                                                                  
         USING GEND,RC                                                          
INITSPT  DS   0H                                                                
         MVI   DATADISP+1,24       SET FROM NET TO SPOT                         
         MVI   LKEY+1,13                                                        
         MVI   LSTATUS+1,1                                                      
         MVI   SYSDIR,C'S'                                                      
         MVI   SYSDIR+1,C'P'                                                    
         MVI   SYSDIR+2,C'T'                                                    
         MVC   SYSFIL(3),SYSDIR                                                 
         BR    RE                                                               
INITNET  DS   0H                                                                
         MVI   DATADISP+1,27       SET FROM SPOT TO NET                         
         MVI   LKEY+1,20                                                        
         MVI   LSTATUS+1,1                                                      
         MVI   SYSDIR,C'U'                                                      
         MVI   SYSDIR+1,C'N'                                                    
         MVI   SYSDIR+2,C'T'                                                    
         MVC   SYSFIL(3),SYSDIR                                                 
         BR    RE                                                               
INITXSP  DS   0H                                                                
         MVI   DATADISP+1,42       SET FROM SPOT TO NET                         
         MVI   LKEY+1,32                                                        
         MVI   LSTATUS+1,4                                                      
         MVI   SYSDIR,C'X'                                                      
         MVI   SYSDIR+1,C'S'                                                    
         MVI   SYSDIR+2,C'P'                                                    
         MVC   SYSFIL(3),SYSDIR                                                 
         BR    RE                                                               
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*=============================================================                  
* READ PRODUCTION HOUSE RECORD FOR OPTICA                                       
*=============================================================                  
*                                                                               
RPHSE    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVI   OPTICASW,0          INIT OPTICA SWITCH                           
         BRAS  RE,INITSPT                                                       
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A21'                                                  
         MVC   KEY+2(3),BAGYMD     A-M/CLT                                      
         MVC   KEY+5(8),=C'99999999'                                            
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   RPHSEX                                                           
*                                                                               
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         LA    R6,24(R6)                                                        
         CLI   0(R6),X'10'                                                      
         BE    *+6                 NO X'10' ELEM                                
         DC    H'0'                                                             
*                                                                               
         USING CMLDTAEL,R6                                                      
*                                                                               
* BUILD PRODUCTION HOUSE KEY *                                                  
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A29'                                                  
         MVC   KEY+2(1),BAGYMD                                                  
         MVC   KEY+3(6),CMLTITLE   PROD HOUSE ID IS IN TITLE                    
         OC    KEY+3(6),SPACES                                                  
         DROP  R6                                                               
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         L     R6,AIO1                                                          
         MVI   ELCODE,X'25'        OPTICA ELEMENT                               
         BRAS  RE,GETEL                                                         
         BNE   RPHSEX                                                           
*                                                                               
         USING PRHOPCEL,R6                                                      
*&&DO                                                                           
         CLC   =C'SPG',PRHOPC      OPTICA COMPANY                               
         BE    RPHSE20                                                          
*                                                                               
         CLC   =C'YNG',PRHOPC      OPTICA COMPANY                               
         BE    RPHSE20                                                          
*                                                                               
         CLC   =C'CAD',PRHOPC      OPTICA COMPANY                               
         BNE   RPHSEX                                                           
*&&                                                                             
         CLC   =C'ER ',PRHOPC      OPTICA COMPANY                               
         BNE   RPHSEX                                                           
*                                                                               
RPHSE20  MVI   OPTICASW,C'Y'                                                    
*                                                                               
         DROP  R6                                                               
*                                                                               
RPHSEX   BRAS  RE,INITNET          SET FOR UNTDIR/UNTFIL                        
         XIT1                                                                   
*                                                                               
*============================================================                   
*  FIND FAX NUMBER                                                              
*============================================================                   
                                                                                
FNDFAX   NTR1  BASE=*,LABEL=*                                                   
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
                                                                                
* USE NETWORK/CLIENT/DPT FAX NUMBER FROM DAYPART RECORD (IF ANY)                
         XC    KEY,KEY                                                          
         USING FAXKEY,R4                                                        
         LA    R4,KEY                                                           
         MVI   FAXKID,X'26'        RECORD ID                                    
         MVC   FAXKAM,BAGYMD       AGY/MED                                      
         MVC   FAXKNET,SAVNET      NETWORK                                      
         MVC   FAXKCLT,BCLT        CLIENT                                       
         MVC   FAXKDPC,SVDPC       DAYPART                                      
         MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
         CLC   KEY(20),KEYSAVE      ID/AM/NETWORK/CLT                           
         BE    FNFX10                                                           
                                                                                
* OR USE NETWORK/OFFICE/DPT FAX NUMBER FROM DAYPART RECORD (IF ANY)             
         MVC   KEY,KEYSAVE                                                      
         XC    FAXKCLT,FAXKCLT     CLEAR CLIENT                                 
         MVC   FAXKOFC,SVCLTOFF                                                 
         MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
         CLC   KEY(20),KEYSAVE      ID/AM/NETWORK....                           
         BE    FNFX10                                                           
                                                                                
* OR USE NETWORK/CLIENT FAX NUMBER FROM DAYPART RECORD (IF ANY)                 
         MVC   KEY,KEYSAVE                                                      
         XC    FAXKOFC,FAXKOFC                                                  
         MVC   FAXKCLT,BCLT        CLEAR CLIENT                                 
         MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
         CLC   KEY(20),KEYSAVE      ID/AM/NETWORK....                           
         BE    FNFX10                                                           
                                                                                
* OR USE NETWORK/OFFICE FAX NUMBER FROM DAYPART RECORD (IF ANY)                 
         MVC   KEY,KEYSAVE                                                      
         XC    FAXKCLT,FAXKCLT     CLEAR CLIENT                                 
         MVC   FAXKOFC,SVCLTOFF                                                 
         MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
         CLC   KEY(20),KEYSAVE      ID/AM/NETWORK....                           
         BE    FNFX10                                                           
                                                                                
* OR USE NETWORK/DAYPART FAX NUMBER FROM DAYPART RECORD (IF ANY)                
         MVC   KEY,KEYSAVE                                                      
         XC    FAXKOFC,SVCLTOFF                                                 
         MVC   FAXKDPC,SVDPC                                                    
         MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
         CLC   KEY(20),KEYSAVE      ID/AM/NETWORK....                           
         BE    FNFX10                                                           
                                                                                
* OR USE NETWORK FAX NUMBER FROM DAYPART RECORD (IF ANY)                        
         MVC   KEY,KEYSAVE                                                      
         XC    FAXKOFC,FAXKOFC                                                  
         MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
         CLC   KEY(20),KEYSAVE      ID/AM/NETWORK....                           
         BNE   FNFXNO                                                           
         DROP  R4                                                               
                                                                                
FNFX10   L     R6,AIO3                                                          
         GOTO1 (RF),(R1),=C'GETREC',=C'UNTFIL',KEY+21,(R6),DMWORK               
         CLC   KEY(7),0(R6)                                                     
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R6,AIO3             THIS FIRST LOOP WILL LOOK FOR AT             
         LA    R6,27(R6)           LEAST ONE FAX NUMBER ON DAYPART REC          
         MVI   ELCODE,X'80'        ONLY THEN WILL IT CLEAR THE MASTER           
         BRAS  RE,FIRSTEL          FAX FROM THE TABLE AND CONTINUE              
         BNE   FNFX30                                                           
                                                                                
         USING FAXVEMEL,R6                                                      
FNFX20   OC    FAXVFAX,FAXVFAX                                                  
         BNZ   FNFXYES                                                          
         BRAS  RE,NEXTEL                                                        
         BE    FNFX20              SEE IF I HAVE THE FIRST FAX                  
         B     FNFXNO              NO FAX                                       
                                                                                
FNFX30   L     R6,AIO3                                                          
         LA    R6,27(R6)           DISP TO THE ELEM                             
         MVI   ELCODE,X'30'        FAX NUMBER                                   
         BRAS  RE,FIRSTEL                                                       
         BNE   FNFXNO                                                           
                                                                                
FNFXYES  XR    RC,RC                                                            
FNFXNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R6                                                               
         LTORG                                                                  
         EJECT                                                                  
*============================================================                   
* WHEN PRINTING ALL PATTERNS, SEE IF THIS PRD-LEN HAD ANY                       
* PATTERN USED. IF YES, EXIT WITH CC EQUAL!                                     
* ON ENTRY R2 POINTS TO CURRENT PATTERN TABLE ENTRY                             
*============================================================                   
                                                                                
CHKSLN   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R5,APATABLE         SEE IF ANYTHING TO PRINT                     
         USING PATABLED,R5                                                      
*                                                                               
CHKSLN2  CR    R2,R5               TEST SAME ENTRY                              
         BE    CHKSLN4                                                          
         TM    PATFLG2,PATXXXX     TEST DO NOT USE PATTERN                      
         BO    CHKSLN4                                                          
         TM    PATFLG2,PATUSED     TEST USED                                    
         BZ    CHKSLN4             NO                                           
         CLC   PATPRD(4),PATPRD-PATABLED(R2)   MATCH PRD/SLN                    
         JE    EQXIT                                                            
         CLC   PATPRD2(4),PATPRD-PATABLED(R2)   MATCH PRD2/SLN2                 
         JE    EQXIT                                                            
*                                                                               
CHKSLN4  LA    R5,PATNEXT                                                       
         CLI   0(R5),0                                                          
         BNE   CHKSLN2                                                          
         J     NEQXIT                                                           
         DROP  R5                                                               
         LTORG                                                                  
         EJECT                                                                  
*----------------------------------------------                                 
* CABLE GEN UNLOCK FOR SOON UPDATES                                             
*----------------------------------------------                                 
*                                                                               
CUNLK    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
* IF RUNNING FOR ALL PRODUCTS, UNLOCK ALL PRODS                                 
*                                                                               
         CLI   SVTN2PRO+00,C'0'                                                 
         BE    *+12                                                             
         CLI   SVTN2PRO+00,0                                                    
         BNE   CUNLK30             NOT AN ALL PRODUCT RUN                       
*                                                                               
         MVI   BYTE,0                                                           
         B     CUNLK100                                                         
*                                                                               
* IF RUNNING BY PRODUCT, UNLOCK THIS PRD                                        
*                                                                               
CUNLK30  CLI   SVTN2PRO+00,C'*'                                                 
         BNE   CUNLK50                                                          
*                                                                               
         MVC   BYTE,SVTN2PRO+00                                                 
         B     CUNLK100                                                         
*                                                                               
* IF RUNNING BY PGROUP, UNLOCK THIS PGROUP                                      
*                                                                               
CUNLK50  OC    OPTPRGR,OPTPRGR     PRGOUP                                       
         BNZ   *+6                                                              
         DC    H'0'                BUG CATCHER                                  
         MVC   BYTE,SVTN2PRO+00                                                 
*                                                                               
CUNLK100 MVC   DUB,SVLOCK          LOCK INFO                                    
         MVC   SVCPROD,SVSVPROD    PROD LOCK INFO                               
         MVI   DUB,C'U'                                                         
*                                                                               
         CLC   =C'GZ',AGENCY       GMMNY                                        
         BE    CUNLKX                                                           
*                                                                               
         GOTO1 VALILOC,SVCPROD                                                  
CUNLKX   XIT1                                                                   
*                                                                               
         EJECT                                                                  
*----------------------------------                                             
* TEST AND LOCK RECORDS                                                         
*----------------------------------                                             
                                                                                
TLOCK    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    SVLOCK,SVLOCK       INIT LOCK KEY                                
         XC    SVCPROD,SVCPROD     INIT PROD                                    
         MVI   BYTE,0                                                           
*                                                                               
* IF RUNNING FOR ALL PRODUCTS, SEE THAT NONE OF THE PRODS ARE LOCKED            
         CLI   SVTN2PRO+00,C'0'                                                 
         BE    *+12                                                             
         CLI   SVTN2PRO+00,0                                                    
         BNE   TLOCK30             NOT AN ALL PRODUCT RUN                       
*                                                                               
         BRAS  RE,INITSPT                                                       
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0DF1'      PROD REC                                    
         MVC   KEY+2(3),BAGYMD    & BCLT                                        
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
TLOCK10  CLC   KEY(5),KEYSAVE                                                   
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLI   KEY+5,X'FF'         LAST REC FOR THIS CLT                        
         BNE   *+14                                                             
         XC    SVCPROD,SVCPROD     CLEAR PROD                                   
         B     TLOCK20              YES, DONE                                   
*                                                                               
         MVC   SVCPROD,KEY+6       SAVE 3 CHAR PROD                             
*                                                                               
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
         GOTO1 VALILOC,SVCPROD                                                  
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVI   DUB+2,X'FF'         NETWORK=ALL                                  
         MVC   DUB+3(1),SVMEDIA    MEDIA                                        
         MVC   DUB+6(1),3(R4)      THIS PRD LOCKED?                             
         GOTO1 VALILOC,SVCPROD                                                  
*                                                                               
         GOTO1 SEQ                 GET NEXT PROD REC                            
         B     TLOCK10                                                          
*                                                                               
* LOCK OUT FOR SOON UPDATES (FOR ALL PRODUCTS)                                  
TLOCK20  XC    DUB,DUB                                                          
         MVI   DUB,C'L'            LOCK                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
         CLI   TRANETH+5,3                                                      
         BNE   TLOCK25                                                          
         CLC   =C'ALL',TRANETH+8   IF NET=ALL                                   
         BNE   TLOCK25                                                          
         MVI   DUB+2,X'FF'                                                      
         MVC   DUB+3(1),SVMEDIA    THEN LOCK BY MEDIA                           
         XC    DUB+4(2),DUB+4                                                   
TLOCK25  MVI   DUB+6,X'FF'         ALL PRODS                                    
*                                                                               
         CLC   =C'GZ',AGENCY       GMMNY                                        
         BE    TLOCKX                                                           
*                                                                               
         GOTO1 VALILOC,SVCPROD                                                  
         B     TLOCKX                                                           
*                                                                               
* IF RUNNING BY PRODUCT, SEE THAT THIS PRD IS NOT LOCKED                        
*                                                                               
TLOCK30  CLI   SVTN2PRO+00,C'*'                                                 
         BNE   TLOCK50                                                          
         XC    DUB,DUB                                                          
         MVC   BYTE,SVTN2PRO+00                                                 
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
         MVC   SVCPROD,OPTPROD     THIS PRD LOCKED?                             
         GOTO1 VALILOC,SVCPROD                                                  
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVI   DUB+2,X'FF'         NETWORK=ALL                                  
         MVC   DUB+3(1),SVMEDIA    MEDIA                                        
         GOTO1 VALILOC,SVCPROD                                                  
*                                                                               
         XC    DUB,DUB                                                          
         MVI   DUB,C'L'            LOCK                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
         CLI   TRANETH+5,3                                                      
         BNE   TLOCK35                                                          
         CLC   =C'ALL',TRANETH+8   IF NET=ALL                                   
         BNE   TLOCK35                                                          
         MVI   DUB+2,X'FF'                                                      
         MVC   DUB+3(1),SVMEDIA    THEN LOCK BY MEDIA                           
         XC    DUB+4(2),DUB+4                                                   
*                                                                               
TLOCK35  CLC   =C'GZ',AGENCY       GMMNY                                        
         BE    TLOCKX                                                           
*                                                                               
         GOTO1 VALILOC,SVCPROD                                                  
         B     TLOCKX                                                           
*                                                                               
* IF RUNNING BY PGROUP, SEE THAT THIS PGROUP IS NOT LOCKED                      
*                                                                               
TLOCK50  OC    OPTPRGR,OPTPRGR     PROD GROUP                                   
         BNZ   *+6                                                              
         DC    H'0'                BUG CATCHER                                  
*                                                                               
         XC    DUB,DUB                                                          
         MVC   BYTE,SVTN2PRO+00                                                 
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
         MVC   DUB+6(2),OPTPRGR    THIS PGROUP LOCKED?                          
         GOTO1 VALILOC,0                                                        
         XC    DUB,DUB                                                          
         MVI   DUB,C'T'            TEST                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVI   DUB+2,X'FF'         NETWORK=ALL                                  
         MVC   DUB+3(1),SVMEDIA    MEDIA                                        
         MVC   DUB+6(2),OPTPRGR    THIS PGROUP LOCKED?                          
         GOTO1 VALILOC,0                                                        
*                                                                               
         XC    DUB,DUB                                                          
         MVI   DUB,C'L'            LOCK                                         
         MVI   DUB+1,X'FF'         NET (TRAFFIC)                                
         MVC   DUB+2(4),TRANET     NETWORK                                      
         CLI   TRANETH+5,3                                                      
         BNE   TLOCK55                                                          
         CLC   =C'ALL',TRANETH+8   IF NET=ALL                                   
         BNE   TLOCK55                                                          
         MVI   DUB+2,X'FF'                                                      
         MVC   DUB+3(1),SVMEDIA    THEN LOCK BY MEDIA                           
         XC    DUB+4(2),DUB+4                                                   
TLOCK55  MVC   DUB+6(2),OPTPRGR    PGROUP                                       
*                                                                               
         CLC   =C'GZ',AGENCY       GMMNY                                        
         BE    TLOCKX                                                           
*                                                                               
         GOTO1 VALILOC,0                                                        
*                                                                               
TLOCKX   MVC   SVLOCK,DUB          SAVE LOCK INFO FOR UNLOCK                    
         MVC   SVSVPROD,SVCPROD    SAVE PROD LOCK INFO FOR UNLOCK               
*                                                                               
         XIT1                                                                   
*--------------------------------------------------------------*                
* PRINT SCHEDULE SUMMARY - PROFILE BASED                                        
*--------------------------------------------------------------*                
SCHDSUMM NTR1  BASE=*,LABEL=*                                                   
         USING PATABLED,R5                                                      
*                                                                               
         MVC   P1+2(L'SSUMHD1),SSUMHD1                                          
         MVI   P2,0                                                             
         MVC   P3+2(L'SSUMHD2),SSUMHD2                                          
         CLI   SVTN1PR3,C'S'                                                    
         BNE   *+10                                                             
         MVC   P3+2(L'SSUMHD2S),SSUMHD2S                                        
         MVI   P4,0                                                             
*        BRAS  RE,GOSPL            DON'T PRINT UNTIL I HAVE A HIT               
                                                                                
         L     R2,AUNTABLE                                                      
         USING UNTABLED,R2                                                      
SSUM020  OC    UNTENT,UNTENT                                                    
         BZ    SSUM099                                                          
                                                                                
         CLC   UNTSEQ,PATSEQ                                                    
         BNE   SSUM085                                                          
                                                                                
         CLC   P1+2(L'SSUMHD1),SSUMHD1                                          
         BNE   *+8                                                              
         BRAS  RE,GOSPL            DON'T PRINT UNTIL I HAVE A HIT               
                                                                                
         MVC   P1+21(L'UNTPROG),UNTPROG                                         
         MVI   P1+2,C'"'                                                        
         MVI   P1+19,C'"'                                                       
         MVC   P1+3(L'NPGNAME),=C'*NAME NOT FOUND*'                             
                                                                                
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING NPGKEY,R4                                                        
         MVC   NPGKTYP,=X'0D20'                                                 
         MVC   NPGKAM,BAGYMD                                                    
         MVC   NPGKNET,NETMKT                                                   
         MVC   NPGKPROG,UNTPROG                                                 
         MVC   NPGKEND,PATPEND                                                  
         BRAS  RE,INITSPT          SET TO SPOT                                  
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(11),KEYSAVE                                                  
         BNE   SSUM070                                                          
         L     R6,AIO2                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         XC    FILENAME,FILENAME                                                
         MVI   ELCODE,X'92'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING NPGEL92,R6                                                       
         MVC   P1+3(L'NPGNAME),NPGNAME                                          
         DROP  R4,R6                                                            
                                                                                
SSUM070  DS    0H                                                               
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,PATPSTR),(4,P+28)                                 
                                                                                
         MVC   BYTE,UNTDAY                                                      
         CLI   UNTROT,0                                                         
         BE    *+10                                                             
         MVC   BYTE,UNTROT                                                      
         GOTO1 UNDAY,DMCB,BYTE,P+35                                             
                                                                                
         XC    KEY,KEY                                                          
         MVC   KEY+1(1),BAGYMD                                                  
         MVC   KEY+2(2),BCLT                                                    
         MVC   KEY+4(3),UNTPROD                                                 
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R0,AIO                                                           
         L     R6,AIO3                                                          
         LA    R6,4000(R6)         READ TO IO3+4000                             
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         ST    R0,AIO              RESTORE CALLER'S AIO VALUE!                  
         USING PRDHDRD,R6                                                       
         MVC   P1+46(20),PNAME       AND PRODUCT NAME                           
                                                                                
         MVC   P1+41(L'UNTPROD),UNTPROD                                         
         MVI   P1+44,C'-'                                                       
         ZIC   R3,UNTSLN                                                        
         EDIT  (R3),(3,P1+67)                                                   
         CLI   SVTN1PR3,C'S'                                                    
         BE    SSUM075                                                          
*        MVC   FULL,UNTACCST                                                    
         MVC   FULL,UNTKEYCS                                                    
         EDIT  FULL,(14,P1+74),2,MINUS=YES,COMMAS=YES                           
                                                                                
SSUM075  MVC   HALF,UNTCT                                                       
         CLI   SVTN1PR3,C'S'                                                    
         BE    SSUM077                                                          
         EDIT  HALF,(3,P1+97)                                                   
         B     SSUM079                                                          
SSUM077  EDIT  HALF,(3,P1+85)                                                   
                                                                                
SSUM079  OC    UNTPROD2,UNTPROD2                                                
         BZ    SSUM080                                                          
         XC    KEY,KEY                                                          
         MVC   KEY+1(1),BAGYMD                                                  
         MVC   KEY+2(2),BCLT                                                    
         MVC   KEY+4(3),UNTPROD2                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R0,AIO                                                           
         L     R6,AIO3                                                          
         LA    R6,4000(R6)         READ TO IO3+4000                             
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         ST    R0,AIO              RESTORE CALLER'S AIO VALUE!                  
         USING PRDHDRD,R6                                                       
         MVC   P2+46(20),PNAME       AND PRODUCT NAME                           
         MVI   P2+41,C'-'                                                       
         MVC   P2+42(L'UNTPROD2),UNTPROD2                                       
         ZIC   R3,UNTSLN2                                                       
         EDIT  (R3),(3,P2+67)                                                   
                                                                                
SSUM080  DS    0H                                                               
         BRAS  RE,GOSPL                                                         
SSUM085  LA    R2,UNTNEXT                                                       
         B     SSUM020                                                          
                                                                                
SSUM099  DS    0H                                                               
         MVC   P1,SPACES                                                        
         MVC   P2,SPACES                                                        
         MVC   P3,SPACES                                                        
         MVC   P4,SPACES                                                        
         XIT1                                                                   
                                                                                
SSUMHD1  DC    CL24'*** SCHEDULE SUMMARY ***'                                   
SSUMHD2  DC    C'PROGRAM-------------------DATE---ROT---PRODUCT--------*        
                 ---------LEN-------COST--------NUMBER OF UNITS'                
                                                                                
SSUMHD2S DC    C'PROGRAM-------------------DATE---ROT---PRODUCT--------*        
                 ---------LEN-------NUMBER OF UNITS------------'                
                                                                                
         EJECT                                                                  
         DROP  R2,R5                                                            
*============================================================                   
* ALLOCATE STORAGE                                                              
*============================================================                   
                                                                                
SETSTOR  NTR1  BASE=*,LABEL=*                                                   
         CLI   OFFLINE,C'Y'                                                     
         BNE   SETST02                                                          
         L     RE,VADUMMY                                                       
         MVC   0(8,RE),=C'*UNTABLE'                                             
         LA    RE,8(RE)                                                         
         ST    RE,AUNTABLE                                                      
         A     RE,=F'40000'                                                     
         ST    RE,MAXUNTBL                                                      
*                                                                               
         MVC   0(8,RE),=C'*PATABLE'                                             
         LA    RE,8(RE)                                                         
         ST    RE,APATABLE                                                      
         A     RE,=F'10000'                                                     
         ST    RE,MAXPATBL                                                      
*                                                                               
         MVC   0(8,RE),=C'*PRGTAB*'                                             
         LA    RE,8(RE)                                                         
         ST    RE,APRGTAB                                                       
         AHI   RE,800*24        800 ENTRIES @ 24 BYTES = 12,000                 
         ST    RE,MXPRGTAB                                                      
*                                                                               
         MVC   0(8,RE),=C'*CMLTBL*'                                             
         LA    RE,8(RE)                                                         
         ST    RE,ACMLTBL                                                       
         AHI   RE,NCOMMLT*CMLTBLLN                                              
         ST    RE,ACMLTBLX                                                      
*                                                                               
         B     SETST04                                                          
                                                                                
*==============================================================                 
* ONLINE - ALLOCATE ADDITIONAL STORAGE IN T2168C                                
*==============================================================                 
                                                                                
SETST02  DS   0H                                                                
         XC    DMCB(24),DMCB                                                    
         L     RE,=V(ENDOFMOD)                                                  
         A     RE,SPTR50RR                                                      
         ST    RE,DMCB                                                          
         MVC   DMCB+4(4),=X'D902168C'    BLANK OVERLAY FOR STORAGE              
         GOTO1 CALLOV,DMCB                                                      
         CLI   4(R1),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     RE,0(R1)            GET PHASE ADDRESS                            
*                                                                               
         ICM   R5,15,8(RE)         MAX STORAGE LENGTH FROM 8C  FROM 8C          
         AR    R5,RE               A(EOT)                                       
*                                                                               
         LA    RE,16(RE)           CAN USE FROM +16                             
         MVC   0(8,RE),=C'*UNTABLE'                                             
         LA    RE,8(RE)                                                         
         ST    RE,AUNTABLE                                                      
         A     RE,=F'19000'                                                     
         ST    RE,MAXUNTBL                                                      
                                                                                
         MVC   0(8,RE),=C'*PATABLE'                                             
         ST    RE,APATABLE                                                      
         AHI   RE,6000                                                          
         ST    RE,MAXPATBL                                                      
*                                                                               
         MVC   0(8,RE),=C'*PRGTAB*'                                             
         LA    RE,8(RE)                                                         
         ST    RE,APRGTAB                                                       
         LA    RE,2048(RE)                                                      
         ST    RE,MXPRGTAB                                                      
*                                                                               
         LHI   RE,NETABLE-SYSD     NOW USE WORKING STORAGE                      
         AR    RE,R9                                                            
*                                                                               
SETST04  MVC   0(8,RE),=C'*ERRTAB*'                                             
         LA    RE,8(RE)                                                         
         ST    RE,AERRTAB                                                       
         AHI   RE,2200               40 ENTRIES AT 55 BYTES AN ENTRY            
         ST    RE,AERRTABX                                                      
*                                                                               
         MVC   0(8,RE),=C'NETABLE*'  BYPASSED NETWORKS TABLE                    
         LA    RE,8(RE)                                                         
         ST    RE,ANETABLE                                                      
         CLI   OFFLINE,C'Y'                                                     
         BE    *+12                                                             
         LA    RE,256(RE)                                                       
         B     *+8                                                              
         AHI   RE,800                200 NETWORKS                               
         ST    RE,MAXNETBL                                                      
                                                                                
         L     RE,ANETABLE         CLEAR BYPASSED NETWORKS TABLE                
         L     RF,MAXNETBL                                                      
         SR    RF,RE                                                            
         XCEFL                                                                  
*                                                                               
         L     RE,MAXNETBL                                                      
         MVC   0(8,RE),=C'*CMLTAB*'                                             
         LA    RE,8(RE)                                                         
         ST    RE,ACMLTAB                                                       
         LHI   RF,NCMLTAB*CMLNXT       ROOM FOR 200 CMMLS                       
         AR    RF,RE                                                            
         ST    RF,MXCMLTAB                                                      
*                                                                               
         BRAS  RE,IACML            INIT FOR BINSRCH AND CLEAR TABLE             
         J     EXIT                                                             
         LTORG                                                                  
         EJECT                                                                  
*==================================================================             
* COMMON ERROR REPORT FORMAT AND PUT                                            
* ON ENTRY R4 POINTS TO PROGRAM COUNT TABLE ENTRY                               
*==================================================================             
                                                                                
         USING UNTABLED,R5                                                      
         USING PRGTABLD,R4                                                      
XPUT     NTR1  BASE=*,LABEL=*                                                   
         CLI   OFFLINE,C'Y'                                                     
         JNE   EXIT                                                             
                                                                                
         XC    ELEM,ELEM                                                        
         LA    R2,ELEM                                                          
         USING XRECD,R2                                                         
*                                                                               
         STC   R1,XTYPE            SET ERROR NUMBER                             
         MVC   XBAGYMD,BAGYMD                                                   
         MVC   XCLT,QCLT                                                        
         MVC   XNET,SAVNET                                                      
         MVC   XNETMKT,NETMKT                                                   
*                                                                               
         LTR   R4,R4               TEST FOR PROGRAM COUNT DATA                  
         BZ    XPUT002                                                          
         MVC   XPROG,PRGPROG                                                    
         MVC   XTUNT,PRGUNITS                                                   
*                                                                               
XPUT002  MVC   XPERST,STDATE                                                    
         MVC   XPERND,ENDATE                                                    
                                                                                
         L     R1,AERRTAB                                                       
XP042    CLI   0(R1),0                                                          
         BE    XP044                                                            
         LA    R1,XRECLEN(R1)                                                   
         C     R1,AERRTABX                                                      
         BL    XP042                                                            
         B     XP099               IGNORE IF TOO MANY ERRORS                    
*                                                                               
XP044    MVC   0(XRECLEN,R1),ELEM                                               
*                                                                               
XP099    J     EXIT                                                             
         DROP  R2,R5                                                            
         EJECT                                                                  
*=========================================================                      
* SORT UNIT TABLE BY PROGRAM CODE                                               
* THEN LOOK FOR PROGRAMS THAT HAVE NO PATTERNS AT ALL                           
*=========================================================                      
                                                                                
BLPRGT   NTR1  BASE=*,LABEL=*                                                   
         LH    R2,UNTABCT                                                       
         L     R3,AUNTABLE                                                      
         GOTO1 QSORT,DMCB,(R3),(R2),L'UNTENT,L'UNTPROG,UNTPROG-UNTENT           
                                                                                
         USING PATABLED,R2                                                      
         L     R2,APATABLE                                                      
         SR    R0,R0                                                            
BLPR003  CLI   0(R2),0             COUNT PATTERN TABLE ENTRIES                  
         BE    *+12                                                             
         LA    R2,PATNEXT                                                       
         BCT   R0,BLPR003                                                       
         LPR   R0,R0                                                            
         CH    R0,=H'1'                                                         
         BE    BLPR005                                                          
         L     R2,APATABLE                                                      
         GOTO1 QSORT,DMCB,(R2),(R0),L'PATENT,L'PATSEQ,PATSEQ-PATENT             
         DROP  R2                                                               
                                                                                
BLPR005  DS    0H                                                               
         XC    DUB,DUB                                                          
         XC    BYTE,BYTE                                                        
         XC    HALF,HALF                                                        
         XC    FULL,FULL                                                        
         USING UNTABLED,R3                                                      
         L     R3,AUNTABLE                                                      
         OC    UNTENT,UNTENT                                                    
         BZ    BLPR090                                                          
         B     BLPR045                                                          
                                                                                
BLPR010  DS    0H                                                               
         OC    UNTENT,UNTENT                                                    
         BZ    BLPR015                                                          
         CLC   DUB(L'UNTPROG),UNTPROG                                           
         BE    BLPR050                                                          
                                                                                
BLPR015  CLI   BYTE,0                                                           
         BNE   BLPR045                                                          
                                                                                
BLPR020  XC    ELEM,ELEM                                                        
         LA    R2,ELEM                                                          
         USING XRECD,R2                                                         
         MVC   XBAGYMD,BAGYMD                                                   
         MVC   XCLT,QCLT                                                        
         MVC   XNET,SAVNET                                                      
         MVC   XNETMKT,NETMKT                                                   
         MVC   XPROG,DUB                                                        
         MVC   XTUNT,HALF                                                       
         MVC   XPERST,STDATE                                                    
         MVC   XPERND,ENDATE                                                    
         MVI   XTYPE,3            (XTYPE3)                                      
*                                                                               
         L     R1,AERRTAB                                                       
*                                                                               
BLPR021  CLI   0(R1),0                                                          
         BE    BLPR022                                                          
         LA    R1,XRECLEN(R1)                                                   
         C     R1,AERRTABX                                                      
         BL    BLPR021                                                          
         B     BLPR090             IGNORE IF TOO MANY ERRORS                    
*                                                                               
BLPR022  DS    0H                                                               
         MVC   0(XRECLEN,R1),ELEM                                               
*                                                                               
         L     R2,FULL            START ADDRESS OF UNITS TO MARK                
*                                                                               
BLPR025  CLC   UNTPROG-UNTENT(L'UNTPROG,R2),DUB                                 
         BNE   BLPR030                                                          
         OI    UNTFLG-UNTENT(R2),UNTFLGPT                                       
         OI    UNTFLG-UNTENT(R2),UNTXCLUD                                       
         LLC   RE,UNTSEQ-UNTENT(R2)  GET PATTERN SEQNUM                         
         BCTR  RE,0                                                             
         MHI   RE,L'PATENT           POINT TO PATTERN ENTRY                     
         A     RE,APATABLE                                                      
         OI    PATFLG2-PATENT(RE),PATXXXX  SET DO NOT PRINT                     
         LA    R2,L'UNTENT(R2)                                                  
         B     BLPR025                                                          
*                                                                               
BLPR030  OC    UNTENT,UNTENT                                                    
         BZ    BLPR090                                                          
                                                                                
BLPR045  XC    DUB,DUB                                                          
         MVC   DUB(L'UNTPROG),UNTPROG                                           
         XC    HALF,HALF                                                        
         MVI   BYTE,0                                                           
         MVI   PBYTE,0             TEMP STORAGE FOR UNTFLG2                     
         ST    R3,FULL                                                          
         OC    UNTENT,UNTENT                                                    
         BZ    BLPR090                                                          
                                                                                
BLPR050  SR    R2,R2                                                            
         SR    R4,R4                                                            
         ICM   R2,3,UNTCT                                                       
         ICM   R4,3,HALF                                                        
         AR    R2,R4                                                            
         STCM  R2,3,HALF                                                        
*                                                                               
         LLC   RE,UNTSEQ           GET PATTERN SEQNUM                           
         BCTR  RE,0                                                             
         MHI   RE,L'PATENT         POINT TO PATTERN ENTRY                       
         LA    RE,PATSEQNO-PATENT(RE)                                           
         A     RE,APATABLE                                                      
         OC    0(3,RE),0(RE)       TEST TBA ENTRY                               
         BZ    *+10                YES                                          
         MVC   BYTE,UNTSEQ                                                      
                                                                                
         TM    UNTFLG2,UNTBLBD                                                  
         BZ    *+8                                                              
         OI    PBYTE,UNTBLBD                                                    
                                                                                
         LA    R3,UNTNEXT                                                       
         B     BLPR010                                                          
                                                                                
BLPR090  DS    0H                                                               
         DROP  R2,R3                   MARKED AS DO NOT PRINT BUT               
         LH    R2,UNTABCT              COVER OTHER PROGRAMS THAT                
         L     R3,AUNTABLE             WILL NOT BE ON THE ERROR                 
         GOTO1 QSORT,DMCB,(R3),(R2),L'UNTENT,L'UNTSEQ,UNTSEQ-UNTENT             
*                                      REPORT AND NEED TO BE REPORTED           
         USING UNTABLED,R3             AS TBA'S - FIND THEM AND                 
         USING PATABLED,R2             UNMARK THE PATTERN IF NECESSARY          
         L     R2,APATABLE                                                      
                                                                                
BLPR120  OC    PATENT,PATENT                                                    
         BZ    BLPR200                                                          
         TM    PATFLG2,PATXXXX         IS PATTER SET NOT TO PRINT               
         BZ    BLPR190                 IF NO GET NEXT PATTERN                   
         L     R3,AUNTABLE                                                      
BLPR130  CLC   PATSEQ,UNTSEQ                                                    
         BNE   BLPR180                                                          
         TM    UNTFLG,UNTXCLUD                                                  
         BO    BLPR180                                                          
         NI    PATFLG2,X'FF'-PATXXXX                                            
         B     BLPR190                                                          
                                                                                
BLPR180  LA    R3,UNTNEXT                                                       
         OC    UNTENT,UNTENT                                                    
         BZ    BLPR190                                                          
         B     BLPR130                                                          
                                                                                
BLPR190  LA    R2,PATNEXT                                                       
         B     BLPR120                                                          
                                                                                
* SORT TABLE BY PRD/PRD2/LEN/DAYP/FEED/PRG/LOWDATE/HIDATE/PSEQ                  
BLPR200  LH    R2,UNTABCT                                                       
         L     R3,AUNTABLE                                                      
         GOTO1 QSORT,DMCB,(R3),(R2),L'UNTENT,L'UNTSRT,0                         
                                                                                
BLPRGXIT DS    0H                                                               
         USING PATABLED,R2                                                      
         L     R2,APATABLE                                                      
         SR    R0,R0                                                            
BLPRXX3  CLI   0(R2),0             COUNT PATTERN TABLE ENTRIES                  
         BE    *+12                                                             
         LA    R2,PATNEXT                                                       
         BCT   R0,BLPRXX3                                                       
         LPR   R0,R0                                                            
         CH    R0,=H'1'                                                         
         BE    BLPRXIT                                                          
                                                                                
         L     R2,APATABLE                                                      
         TM    SVOPTSW,OPTPSORT    ARE WE SORTING BY PRODUCT CODE?              
         BZ    BLPRXX5                                                          
         GOTO1 XSORT,DMCB,(R2),(R0),L'PATENT,8,12                               
         B     BLPRXIT                                                          
                                                                                
BLPRXX5  DS    0H                                                               
* SORT ON PRDS                                                                  
         LA    R5,PATPRD-PATENT                                                 
         GOTO1 XSORT,DMCB,(R2),(R0),L'PATENT,L'PATPRD,(R5)                      
* SORT ON START TIME                                                            
         GOTO1 XSORT,DMCB,(R2),(R0),L'PATENT,L'PATSTIM,PATSTIM-PATENT           
* SORT ON START/END DATES                                                       
         LA    R5,PATSTR-PATENT                                                 
         CLI   SVTN2PRO+10,C'Y'                                                 
         BNE   *+8                                                              
         LA    R5,PATPSTR-PATENT                                                
         GOTO1 XSORT,DMCB,(R2),(R0),L'PATENT,4,(R5)                             
BLPRXIT  DS    0H                                                               
         XIT1                                                                   
         DROP  R2,R3                                                            
         EJECT                                                                  
*===========================================================                    
* INITIALIZE ADDITIONAL COMMERCIAL INFORMATION TABLE                            
*===========================================================                    
                                                                                
IACML    NTR1  BASE=*,LABEL=*                                                   
         L     RE,ACMLTAB         CLEAR ADDRESS OF BINTABLE                     
         L     RF,MXCMLTAB        END OF TABLE                                  
         SR    RF,RE                                                            
         XCEFL                                                                  
                                                                                
         SR    R0,R0               ADDRESS OF REC TO BE ADDED                   
         L     R1,ACMLTAB          ADDRESS OF BINTABLE                          
         SR    R2,R2               NUMBER OF RECS IN TABLE                      
         LA    R3,CMLNXT           LENGTH OF BIN RECORD                         
         LA    R4,L'CMLCML         LENGTH OF BIN KEY                            
         LA    R5,NCMLTAB         MAXIMUM RECORDS IN BINTBL                     
         STM   R0,R5,BINDMCB                                                    
*                                                                               
         SR    R0,R0               ADDRESS OF REC TO BE ADDED                   
         L     R1,ACMLTBL          ADDRESS OF BINTABLE                          
         SR    R2,R2               NUMBER OF RECS IN TABLE                      
         LA    R3,CMLTBLLN         LENGTH OF BIN RECORD                         
         LA    R4,L'CMLKEYL        LENGTH OF BIN KEY                            
         LA    R5,NCOMMLT          MAX RECORDS IN BINTBL (200)                  
         STM   R0,R5,BINPAR7                                                    
*                                                                               
         L     R0,ACMLTBL          CLEAR CML TABLE                              
         L     R1,ACMLTBLX                                                      
         SR    R1,R0                                                            
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         XIT1                                                                   
                                                                                
* PUT OUT OVERNIGHT COPY REQUEST *                                              
                                                                                
REQPGEN  NTR1  BASE=*,LABEL=*                                                   
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
*                                                                               
         L     RE,AIO3                                                          
         L     RF,SIZEIO                                                        
         SR    R0,R0                                                            
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         L     R6,AIO3                                                          
         USING REQHDRD,R6                                                       
*                                                                               
         XC    REQHDR,REQHDR                                                    
         MVI   REQHDR+15,X'11'     NUMBER OF REQUESTS                           
         MVC   REQUEST,SPACES                                                   
         MVC   REQUEST2,SPACES                                                  
         MVC   REQUEST(2),=C'TP'                                                
*                                                                               
         CLI   CONREC,C'C'         TEST CABLE GEN                               
         BNE   *+10                                                             
         MVC   REQUEST(2),=C'TB'                                                
*                                                                               
         MVC   REQUEST+2(2),AGENCY                                              
                                                                                
         L     R1,ACOMFACS                                                      
         L     RF,CGETFACT-COMFACSD(R1)                                         
         GOTO1 (RF),DMCB,0                                                      
         L     RE,DMCB             FAFACTS                                      
         LA    R2,FASIN-FACTSD(,RE)                                             
         LA    R4,REQUEST+5                                                     
                                                                                
         EDIT  (B4,0(R2)),(6,(R4)),FILL=0                                       
         MVC   REQUEST+12(26),=CL27'0203PAT 0303GEN 0506OV,T/A'                 
*                                                                               
         CLI   CONREC,C'C'         TEST CABLE GEN                               
         BNE   REQP05                                                           
         MVC   REQUEST+12(26),=CL27'0203CAB 0303GEN 0506OV,   '                 
         MVC   REQUEST+35(3),CONWHEN+5                                          
                                                                                
REQP05   DS   0H                                                                
         MVC   REQUEST+39(4),=CL4'0903'                                         
         MVC   REQUEST+43(3),QCLT                                               
         MVC   REQUEST+47(4),=CL4'1004'                                         
         MVC   REQUEST+51(4),TRANET                                             
                                                                                
         LA    R2,REQUEST+56   1234                                             
                                                                                
         CLI   REQUEST+54,C' '                                                  
         BH    REQP10                                                           
         MVI   REQUEST+54,C' '                                                  
         MVI   REQUEST+50,C'3'                                                  
         BCTR  R2,0                                                             
                                                                                
REQP10   DS   0H                                                                
         MVC   0(4,R2),=CL12'1103'                                              
         MVC   4(8,R2),TRAPER                                                   
                                                                                
         LA    R0,8                                                             
         LA    R1,11(,R2)                                                       
REQP20   CLI   0(R1),C' '                                                       
         BH    REQP30                                                           
                                                                                
         MVI   0(R1),C' '                                                       
                                                                                
         BCTR  R1,0                                                             
         BCT   R0,REQP20                                                        
                                                                                
REQP30   DS   0H                                                                
         STC   R0,3(R2)            SAVE NEW LENGTH                              
         OI    3(R2),X'F0'                                                      
                                                                                
         MVC   REQUEST2(12),REQUEST                                             
                                                                                
         LA    R2,REQUEST2+12                                                   
                                                                                
         MVC   0(11,R2),=C'1201C 1301N'                                         
*                                                                               
         CLI   CONREC,C'C'         TEST CABLE GEN                               
         BNE   REQP35                                                           
         MVC   0(11,R2),=C'1201C      '                                         
         LA    R2,6(,R2)                                                        
         B     *+8           *** MAKE SURE YOU SKIP THE NEXT LA INSTR           
REQP35   DS    0H                                                               
*                                                                               
         LA    R2,12(,R2)                                                       
         LR    R3,R2               SAVE START ADDRESS                           
                                                                                
         CLI   SVOPTMED,0          THIS BY ALL = MEDIA                          
         BE    REQP40               NO                                          
                                                                                
         MVC   0(12,R2),=C'1407ALL=X,#*'                                        
*                                                                               
         CLI   CONREC,C'C'         TEST CABLE GEN                               
         BNE   *+8                                                              
         MVI   1(R2),C'3'          MAKE IT FIELD 13 INSTEAD OF 14               
*                                                                               
         MVC   8(1,R2),SVOPTMED                                                 
         LA    R2,11(,R2)                                                       
         LA    R0,7                FIELD LEN SO FAR                             
         B     REQP50                                                           
                                                                                
REQP40   DS   0H                                                                
         MVC   0(6,R2),=C'1401#*'                                               
*                                                                               
         CLI   CONREC,C'C'         TEST CABLE GEN                               
         BNE   *+8                                                              
         MVI   1(R2),C'3'          MAKE FIELD 13 INSTEAD OF 14                  
*                                                                               
         LA    R2,5(,R2)                                                        
         LA    R0,1                FIELD LEN SO FAR                             
                                                                                
REQP50   DS   0H                                                                
         TM    SVOPTSW1,OPTPER     PERIOD ENTERED IN OPTION FIELD               
         BZ    REQP55                                                           
                                                                                
         AHI   R0,4                PRESET ENTRY LENGTH                          
         CVD   R0,DUB                                                           
         UNPK  2(2,R3),DUB                                                      
         OI    3(R3),X'F0'                                                      
                                                                                
         MVC   0(4,R2),=C',BRO'    PRESET TO BROADCAST                          
         CLI   MYTN2PR6,C'B'       BROADCAST - MONTHLY PERIOD                   
         BE    REQP54                                                           
                                                                                
         MVC   0(4,R2),=C',CAL'    PRESET TO CALENDAR                           
         CLI   MYTN2PR6,C'C'       CALENDAR PERIOD                              
         BE    REQP54                                                           
                                                                                
         MVC   0(4,R2),=C',WEE'    PRESET TO WEEKLY                             
         CLI   MYTN2PR6,C'W'       WEEKLY PERIOD                                
         BE    REQP54                                                           
         DC    H'0'                BUG CATCHER                                  
                                                                                
REQP54   LA    R2,4(R2)                                                         
         MVI   0(R2),C'*'                                                       
                                                                                
REQP55   DS   0H                                                                
         CLI   OPTPROD,0                                                        
         BE    REQP60               NO                                          
         MVC   0(6,R2),=C',PROD='                                               
         MVC   6(3,R2),OPTPROD                                                  
         LA    R2,8(,R2)                                                        
         AHI   R0,8                                                             
         CLI   0(R2),C' '                                                       
         BNH   *+12                                                             
         LA    R2,1(,R2)                                                        
         AHI   R0,1                                                             
                                                                                
         CVD   R0,DUB                                                           
         UNPK  2(2,R3),DUB                                                      
         OI    3(R3),X'F0'                                                      
         MVI   0(R2),C'*'                                                       
         B     REQP70                                                           
                                                                                
REQP60   DS   0H                                                                
         OC    OPTPRGR,OPTPRGR     ANY PRODUCT GROUP                            
         BZ    REQP70               NO                                          
         MVC   0(5,R2),=C',PGR='                                                
         MVC   5(3,R2),QPGR+1                                                   
         LA    R2,8(R2)                                                         
         CLI   0(R2),C' '                                                       
         BH    *+8                                                              
         BCT   R2,*-8                                                           
         MVI   1(R2),C'*'                                                       
         LA    R2,1(R2)                                                         
         LR    R0,R3               GET FIELD START ADDRESS                      
         SR    R0,R2                                                            
         LPR   R0,R0               GIVES LENGTH OF FIELD                        
         AHI   R0,-4               ARITHMETIC FOR FIELD LEN!                    
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  2(2,R3),DUB                                                      
                                                                                
REQP70   DS   0H                                                                
         TM    SVOPTSW,OPTPSORT     TEST SORTED BY PROD                         
         BZ    REQP80                                                           
         MVC   0(6,R2),=C',PSORT'                                               
         MVI   6(R2),C'*'                                                       
         AHI   R0,6                                                             
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  2(2,R3),DUB                                                      
*                                                                               
REQP80   CLI   CONREC,C'C'         TEST CABLE/GEN                               
         BE    REQP100                                                          
*                                                                               
         LA    R1,TRACMT1H         CHECK FOR COMMENTS                           
         LA    R3,REQUEST3         1ST COMMENT                                  
         LA    R2,REQUEST3+12                                                   
         MVC   FULL,=C'1560'       FIELD 15 MAX LEN 60                          
                                                                                
REQP82   CLI   5(R1),0             ANY ENTRY                                    
         BE    REQP85                                                           
*                                                                               
         LLC   RF,REQHDR+15        NUMBER OF REQUESTS                           
         AHI   RF,X'10'            ADD ONE TO NUMBER OF REQUESTS                
         STC   RF,REQHDR+15                                                     
*                                                                               
         MVC   0(L'REQUEST3,R3),SPACES                                          
         MVC   0(12,R3),REQUEST                                                 
         MVC   0(4,R2),FULL        FIELD NUMBER AND MAX LEN                     
         LLC   R5,5(R1)            INPUT LEN                                    
         CVD   R5,DUB                                                           
         UNPK  2(2,R2),DUB         FIELD LENGTH                                 
         OI    3(R2),X'F0'                                                      
         BCTR  R5,0                                                             
         EX    R5,*+8                                                           
         B     *+10                                                             
         MVC   4(0,R2),8(R1)       MOVE COMMENT TO REQUEST FIELD                
         AR    R5,R2                                                            
         AHI   R5,5                PT TO END OF ENTRY                           
         LA    R3,L'REQUEST3(R3)   BUMP TO NEXT REQUEST FIELD                   
         LA    R2,L'REQUEST3(R2)                                                
         MVC   HALF,FULL                                                        
         PACK  DUB,HALF                                                         
         CVB   R0,DUB              FIELD NUMBER IN BINARY                       
         AHI   R0,1                                                             
         EDIT  (R0),(2,FULL)                                                    
*                                                                               
REQP85   LLC   R0,0(R1)            NEXT FIELD                                   
         AR    R1,R0                                                            
         LA    RF,TRACMT4H                                                      
         CR    R1,RF               TEST PAST LAST COMMENT LINE?                 
         JH    REQP90                                                           
         LLC   R0,0(R1)            NEXT FIELD                                   
         AR    R1,R0                                                            
         B     REQP82                                                           
                                                                                
REQP90   LA    R1,REQUEST3         SEE IF ANY COMMENTS                          
         CR    R3,R1                                                            
         BE    REQP100             DONE                                         
         MVI   0(R5),C'*'          MARK END OF REQUEST                          
         BAS   RE,CEND             FIND AND CLEAR * IN REQUEST2                 
*                                                                               
REQP100  DS   0H                                                                
         XC    REQSPOOK,REQSPOOK                                                
         GOTO1 REQTWA,DMCB,(5,ATWA),REQHDR,DATAMGR,RCCOMFAC,REQSPOOK            
         CLI   DMCB+8,0                                                         
         BE    REQPX                                                            
         DC    H'0'                                                             
REQPX    XIT1                                                                   
                                                                                
*                                                                               
* CLEAR END OF REQUEST2 MARKER                                                  
*                                                                               
CEND     NTR1                                                                   
         LA    R1,REQUEST2                                                      
         LA    R2,L'REQUEST2-1(R1)                                              
CEND05   CLI   0(R2),C'*'                                                       
         BE    CEND08                                                           
         BCTR  R2,0                BACK UP ONE                                  
         CR    R2,R1               AT THE START OF REQUEST?                     
         BH    CEND05                                                           
         DC    H'0'                BUG CATCHER                                  
*                                                                               
CEND08   MVI   0(R2),X'40'         BLANK OUT THE *                              
         B     REQPX                                                            
         DROP  R6                                                               
                                                                                
                                                                                
*INITIALIZE STUFF                                                               
                                                                                
INIT     NMOD1 0,**INIT**                                                       
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
                                                                                
INIT20   XC    DMCB(7),DMCB                                                     
         MVC   DMCB+4(4),=X'D9000A1D'  GETBROAD                                 
         GOTO1 CALLOV,DMCB                                                      
         CLI   4(R1),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'0'                                                             
         MVC   VGTBROAD,0(R1)                                                   
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*========================================================                       
*        PUT OUT OVERNIGHT SEED REQUEST *                                       
*========================================================                       
                                                                                
REQSEED  NTR1  BASE=*,LABEL=*                                                   
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
                                                                                
         L     RE,AIO3                                                          
         L     RF,SIZEIO                                                        
         SR    R0,R0                                                            
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
                                                                                
         L     R6,AIO3                                                          
         USING REQHDRD,R6                                                       
                                                                                
         XC    REQHDR,REQHDR                                                    
         MVI   REQHDR+15,X'11'     NUMBER OF REQUESTS                           
         MVC   REQUEST,SPACES                                                   
         MVC   REQUEST2,SPACES                                                  
         MVC   REQUEST(2),=C'TS'                                                
         MVC   REQUEST+2(2),AGENCY                                              
                                                                                
         CLI   OFFLINE,C'Y'                                                     
         BE    REQS04              IF OFFLINE USE INPUT REQ #                   
                                                                                
         L     R1,ACOMFACS                                                      
         L     RF,CGETFACT-COMFACSD(R1)                                         
         GOTO1 (RF),DMCB,0                                                      
         L     RE,DMCB             FAFACTS                                      
         LA    R2,FASIN-FACTSD(,RE)                                             
         LA    R4,REQUEST+5                                                     
                                                                                
         EDIT  (B4,0(R2)),(6,(R4)),FILL=0                                       
         B     REQS06                                                           
                                                                                
REQS04   DS   0H                                                                
         ICM   RE,15,TWAMASTC                                                   
         BNZ   *+6                                                              
         DC    H'0'                                                             
         MVC   REQUEST+5(6),MCREQREC+5-MASTD(RE)                                
                                                                                
REQS06   DS   0H                                                                
         MVC   REQUEST+12(26),=CL27'0203NET 0303SEE 0506OV,T/A'                 
         MVC   REQUEST+39(4),=CL4'0903'                                         
         MVC   REQUEST+43(3),QCLT                                               
         MVC   REQUEST+47(4),=CL4'1004'                                         
         MVC   REQUEST+51(4),TRANET                                             
                                                                                
         LA    R2,REQUEST+56   1234                                             
                                                                                
         CLI   REQUEST+54,C' '                                                  
         BH    REQS10                                                           
         MVI   REQUEST+54,C' '                                                  
         MVI   REQUEST+50,C'3'                                                  
         BCTR  R2,0                                                             
                                                                                
REQS10   DS   0H                                                                
         MVC   0(12,R2),=CL12'1103ALL 1208'                                     
         MVC   12(8,R2),TRAPER                                                  
                                                                                
         LA    R0,8                                                             
         LA    R1,19(,R2)                                                       
REQS20   CLI   0(R1),C' '                                                       
         BH    REQS30                                                           
                                                                                
         MVI   0(R1),C' '                                                       
                                                                                
         BCTR  R1,0                                                             
         BCT   R0,REQS20                                                        
                                                                                
REQS30   DS   0H                                                                
         STC   R0,11(R2)                                                        
         OI    11(R2),X'F0'                                                     
                                                                                
         MVC   REQUEST2(12),REQUEST                                             
                                                                                
         LA    R1,REQUEST2+12                                                   
                                                                                
         CLI   SVOPTMED,0          THIS BY ALL = MEDIA                          
         BE    REQS40               NO                                          
                                                                                
         MVC   0(12,R1),=C'1307ALL=X,#*'                                        
         MVC   8(1,R1),SVOPTMED                                                 
         LA    R1,11(,R1)                                                       
         LA    R0,7                FIELD LEN SO FAR                             
         B     REQS50                                                           
                                                                                
REQS40   DS   0H                                                                
         MVC   0(6,R1),=C'1301#*'                                               
         LA    R1,5(,R1)                                                        
         LA    R0,1                FIELD LEN SO FAR                             
                                                                                
REQS50   DS   0H                                                                
         TM    SVOPTSW1,OPTPER     PERIOD ENTERED IN OPTION FIELD               
         BZ    REQS55                                                           
                                                                                
         AHI   R0,4                PRESET ENTRY LENGTH                          
         CVD   R0,DUB                                                           
         UNPK  REQUEST2+14(2),DUB                                               
         OI    REQUEST2+15,X'F0'                                                
                                                                                
         MVC   0(4,R1),=C',BRO'    PRESET TO BROADCAST                          
         CLI   MYTN2PR6,C'B'       BROADCAST - MONTHLY PERIOD                   
         BE    REQS54                                                           
                                                                                
         MVC   0(4,R1),=C',CAL'    PRESET TO CALENDAR                           
         CLI   MYTN2PR6,C'C'       CALENDAR PERIOD                              
         BE    REQS54                                                           
                                                                                
         MVC   0(4,R1),=C',WEE'    PRESET TO WEEKLY                             
         CLI   MYTN2PR6,C'W'       WEEKLY PERIOD                                
         BE    REQS54                                                           
         DC    H'0'                BUG CATCHER                                  
                                                                                
REQS54   LA    R1,4(R1)                                                         
         MVI   0(R1),C'*'                                                       
                                                                                
REQS55   DS   0H                                                                
         CLI   OPTPROD,0                                                        
         BE    REQS60               NO                                          
         MVC   0(6,R1),=C',PROD='                                               
         MVC   6(3,R1),OPTPROD                                                  
         LA    R1,8(,R1)                                                        
         AHI   R0,8                                                             
         CLI   0(R1),C' '                                                       
         BNH   *+12                                                             
         LA    R1,1(,R1)                                                        
         AHI   R0,1                                                             
         CVD   R0,DUB                                                           
         UNPK  REQUEST2+14(2),DUB                                               
         OI    REQUEST2+15,X'F0'                                                
         MVI   0(R1),C'*'                                                       
         B     REQS60               NO                                          
                                                                                
REQS60   DS    0H                                                               
         OC    OPTPRGR,OPTPRGR         ANY PRODUCT GROUP                        
         BZ    REQS70                  NO                                       
         MVC   0(5,R1),=C',PGR='                                                
         MVC   5(3,R1),QPGR+1                                                   
         LA    R1,7(R1)                POINT TO LAST CHAR                       
         AHI   R0,8                    SET FOR MAX LENGTH                       
                                                                                
REQS62   CLI   0(R1),C' '                                                       
         BH    REQS64                                                           
         BCTR  R1,0                                                             
         BCT   R0,REQS62                                                        
                                                                                
REQS64   MVI   1(R1),C'*'              SET END OF REQUEST DATA                  
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  REQUEST2+14(2),DUB      SET DATA LENGTH                          
                                                                                
REQS70   DS    0H                                                               
         XC    REQSPOOK,REQSPOOK                                                
         GOTO1 REQTWA,DMCB,(5,ATWA),REQHDR,DATAMGR,RCCOMFAC,REQSPOOK            
         CLI   DMCB+8,0                                                         
         BE    REQSX                                                            
         DC    H'0'                                                             
REQSX    XIT1                                                                   
         DROP  R6                                                               
         LTORG                                                                  
         EJECT                                                                  
*========================================================                       
*        BRAND LEVEL SECURITY CHECK                                             
*========================================================                       
         USING UNTABLED,R5                                                      
BLSEC    NMOD1 0,**BLSE**                                                       
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
                                                                                
         LA    R2,ELEM             FAKE                                         
                                                                                
         MVI   ERROR,0                                                          
                                                                                
         XC    ELEM,ELEM                                                        
         MVC   ELEM(8),=X'0A01000184030001'                                     
         MVC   ELEM+8(3),UNTPROD                                                
         MVI   ERROPT,C'Y'         RETURN ON ERROR                              
                                                                                
         GOTO1 VALIPRD                                                          
                                                                                
         MVI   ERROPT,0                                                         
                                                                                
*        IF COND CODE NE, WILL BYPASS UNIT                                      
         CLI   ERROR,0             ANY ERROR?                                   
         XIT1                                                                   
         DROP  R5                                                               
                                                                                
         LTORG                                                                  
         EJECT                                                                  
                                                                                
*========================================================                       
* PRINT NETWORKS THAT WERE BYPASSED IN THIS REPORT                              
*========================================================                       
PBYNET   NMOD1 0,*PBYNET*                                                       
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
                                                                                
         TM    SVOPTSW,OPTTEST     TEST                                         
         BO    PBYN10              YES, GO PRINT                                
                                                                                
         CLI   TRAFAX,C'Y'         FAX                                          
         BE    PBYNETX             YES, DONE                                    
                                                                                
         CLI   TRAFAX,C'2'         IS THIS FAX & COPY                           
         BNE   PBYN10                                                           
                                                                                
         TM    SVOPTSW1,OPTHDCPY   AGENCY COPY RUN                              
         BZ    PBYNETX                                                          
                                                                                
PBYN10   DS    0H                                                               
         CLI   REPORTOK,C'Y'       WAS THERE ANYTHING TO REPORT                 
         BE    PBYN20                                                           
                                                                                
         CLI   PQSW,1              PRINT QUE EVER OPENED                        
         BNE   PBYN15               YES                                         
                                                                                
         GOTO1 OPENPQ                                                           
                                                                                
*        NEED HEADINGS                                                          
                                                                                
PBYN15   LM    RF,R1,=A(HEADING,HDHK,FTHK)  SSPECS, HEADHOOK, FOOTHOOK          
         L     RE,SPTR50RR                                                      
         AR    RF,RE                                                            
         ST    RF,SPECS            STORE SPECS FOR CONTROLLER                   
         AR    R0,RE                                                            
         ST    R0,HEADHOOK         STORE HEADHOOK FOR CONTROLLER                
         AR    R1,RE                                                            
         ST    R1,FOOTHOOK         STORE FOOTHOOK FOR CONTROLLER                
                                                                                
         MVI   MAXLINES,60         SET PAGE SIZE                                
         MVI   FOOTLNS,2           ALLOW 2 LINES OF FOOTLINES                   
         MVI   FOOTSW,0            RESET SWITCH                                 
         MVI   CLEARHED,C'N'       DO NOT CLEAR HEADLINES                       
         MVI   CONTINUE,C'Y'                                                    
                                                                                
PBYN20   MVI   FORCEHED,C'Y'                                                    
         MVI   SPACING,2                                                        
         MVI   P1,0                FORCE SPACING                                
         MVI   P2,0                                                             
         MVC   P3+2(19),=C'BYPASSED NETWORK(S)'                                 
         MVC   P4+2(19),=C'-------------------'                                 
         GOTO1 SPOOL,DMCB,(R8)                                                  
                                                                                
         L     R3,ANETABLE         NETWORKS TABLE                               
                                                                                
         LA    R2,P1+2             PRINT LINE                                   
         LA    R0,4                PRINT IN 4 COLUMNS                           
         B     PBYN30                                                           
                                                                                
PBYN25   LA    R3,4(R3)                                                         
         C     R3,MAXNETBL         TEST END OF TABLE                            
         BNL   PBYN60              YES                                          
                                                                                
PBYN30   OC    0(4,R3),0(R3)       ANY MORE NETS                                
         BZ    PBYN60               NO, DONE                                    
                                                                                
         MVC   0(4,R2),0(R3)       PRINT NETWORK                                
         LA    R2,10(R2)                                                        
         BCT   R0,PBYN25                                                        
                                                                                
         GOTO1 SPOOL,DMCB,(R8)                                                  
                                                                                
         LA    R2,P1+2             PRINT LINE                                   
         LA    R0,4                PRINT IN 4 COLUMNS                           
         B     PBYN25                                                           
                                                                                
PBYN60   GOTO1 SPOOL,DMCB,(R8)                                                  
                                                                                
PBYNETX  XIT1                                                                   
                                                                                
         LTORG                                                                  
         EJECT                                                                  
*================================================================               
* PRINT INSTRUCTIONS FOR 1 NETWORK                                              
*================================================================               
                                                                                
PRT      NMOD1 0,**+PRT**,R7                                                    
*                                                                               
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
                                                                                
         MVC   NEXTADDR,AIO2       ALL QUEUES BUILT IN AIO2                     
                                                                                
         TM    SVOPTSW,OPTNEW      TEST NEW INST ONLY                           
         BZ    PRT04                                                            
         CLI   NETCREVN,0         TEST REV=0 (NEW INSTR)                        
         BE    PRT04                                                            
                                                                                
         MVI   INSPRTSW,C'N'      DO NOT PRINT INSTRUCTIONS                     
         B     PRTXIT                                                           
                                                                                
PRT04    DS   0H                                                                
         CLI   SVTWPR06,C'N'       THIS AN EASYLINK TRANS                       
         BNE   *+12                 YES                                         
                                                                                
         CLI   PQSW,1              TEST PRTQUE OPENED                           
         BNE   PRT14                YES                                         
                                                                                
         CLI   OFFLINE,C'Y'        THIS AN OFFLINE REQUEST                      
         BNE   PRT04C               NO                                          
                                                                                
         TM    WHEN,X'20'          THIS SOON                                    
         BO    PRT04C               YES, SEND FAX NOW                           
                                                                                
         CLI   SVTWPR06,C'2'       THIS AN EASYLINK AGENCY COPY REQUEST         
         BE    PRT05                YES, DO AGENCY COPY FIRST                   
                                                                                
PRT04C   CLI   PQSW,1              TEST PRTQUE OPENED                           
         BE    PRT05                NO                                          
                                                                                
         TM    WHEN,X'20'          THIS SOON                                    
         BO    PRT14                YES, NO CLOSE/OPEN                          
                                                                                
         MVI   SPMODE,X'FF'                                                     
         GOTO1 SPOOL,DMCB,(R8)    FORCE CLOSE OF SPOOL                          
         MVI   PQSW,1                                                           
                                                                                
PRT05    LA    R1,ELEM                                                          
         ST    R1,SPOOLQLK                                                      
         XC    ELEM(128),ELEM                                                   
         USING PQPLD,R1                                                         
         MVI   QLEXTRA,X'FF'       NEW PARM LIST                                
         OI    SPOOLIND,X'40'      USER VALUES PRESENT                          
                                                                                
*        OI    SPOOLKEY+QLTYPE-PQPLD,PQTYUPDT                                   
         OI    SPOOLKEY+QLTYPE-PQPLD,X'80'                                      
                                                                                
         CLI   SVTWPR06,C'N'       THIS AN EASYLINK TRANS                       
         BE    PRT10                NO, JUST OPEN                               
         TM    SVOPTSW1,OPTHDCPY   IF AGENCY COPY RUN                           
         BO    PRT10                YES, JUST OPEN                              
                                                                                
         TM    WHEN,X'20'          SOON REQUEST                                 
         BO    PRT05C                                                           
                                                                                
         CLI   OFFLINE,C'Y'        THIS AN OFFLINE REQUEST                      
         BE    PRT06                YES, NO MORE QL STUFF                       
                                                                                
PRT05C   MVC   QLDESC(3),QCLT                                                   
         MVC   QLDESC+3(4),SAVNET                                               
         MVC   QLDESC+7(4),PSTDATE YEAR AND MONTH                               
         MVI   QLCLASS,C'G'        EASYLINK                                     
         MVC   REMUSER,=C'PWX'                                                  
         CLI   CONREC,C'C'         TEST CABLE/GEN                               
         BNE   *+10                                                             
         MVC   REMUSER,=C'CWX'                                                  
         MVC   QLTYP1,SVFAXARC                                                  
                                                                                
         TM    WHEN,X'20'          SOON REQUEST                                 
         BZ    PRT10                NO                                          
         B     PRT08                                                            
         DROP  R1                                                               
                                                                                
PRT06    CLI   SVTWPR06,C'2'       THIS AN EASYLINK AGENCY COPY REQUEST         
         BE    PRT10                YES, DO AGENCY COPY FIRST                   
                                                                                
PRT08    ICM   RE,15,TWAMASTC                                                   
         BNZ   *+6                                                              
         DC    H'0'                                                             
         L     RF,MCVREMOT-MASTD(,RE)                                           
         USING REMOTED,RF                                                       
                                                                                
         MVC   REMOTSYS,MCS2OSYS-MASTD(RE)                                      
                                                                                
         CLI   OFFLINE,C'Y'                                                     
         BNE   PRT09                                                            
                                                                                
         L     RE,TWADCONS                                                      
         L     RE,TSPFUSER-TWADCOND(,RE)                                        
                                                                                
         MVI   140(RE),C'Y'        SET EASYLINK STUFF PRINTED SW                
                                                                                
         L     R1,136(,RE)         PAST SAVED DCB                               
         LA    R1,1(,R1)                                                        
         ST    R1,136(,RE)         FORCE NEW PRINT QUEUE ENTRY                  
         CVD   R1,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  REMOTSUB,DUB        FORCE NEW PRINT QUEUE ENTRY                  
                                                                                
PRT09    MVC   REMOTJID,=C'PWX'                                                 
         CLI   CONREC,C'C'         TEST CABLE/GEN                               
         BNE   *+10                                                             
         MVC   REMOTJID,=C'CWX'                                                 
         MVC   REMOTTY1,SVFAXARC                                                
                                                                                
         CLI   CONREC,C'C'         TEST CABLE/GEN                               
         BNE   PRT09C                                                           
         CLI   SVTWPR06,C'Y'       RESTORE REF CODE ON FAX COPY                 
         BNE   PRT09C                                                           
         MVC   REMOTSYS(3),=C'NCG'                                              
                                                                                
PRT09C   DS    0H                                                               
         MVC   REMOTDST,TWAORIG                                                 
         OC    TWADEST,TWADEST                                                  
         BZ    *+10                                                             
         MVC   REMOTDST,TWADEST                                                 
         MVI   REMOTCLS,C'G'                                                    
         MVI   REMOTCPY,1                                                       
                                                                                
PRT10    GOTO1 OPENPQ                                                           
                                                                                
PRT14    CLI   SVTWPR06,C'N'       THIS AN EASYLINK TRANS                       
         BE    PRT16                NO, BYPASS                                  
         TM    SVOPTSW1,OPTHDCPY   IF AGENCY COPY RUN                           
         BO    PRT16                YES                                         
*                                                                               
* USE NETWORK/CLIENT/DPT FAX NUMBER FROM DAYPART RECORD (IF ANY)                
         XC    KEY,KEY                                                          
         USING FAXKEY,R4                                                        
         LA    R4,KEY                                                           
         MVI   FAXKID,X'26'        RECORD ID                                    
         MVC   FAXKAM,BAGYMD       AGY/MED                                      
         MVC   FAXKNET,SAVNET      NETWORK                                      
         MVC   FAXKCLT,BCLT        CLIENT                                       
         MVC   FAXKDPC,SVDPC       DAYPART                                      
         MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
         CLC   KEY(20),KEYSAVE      ID/AM/NETWORK/CLT                           
         BE    PRT14A                                                           
                                                                                
* OR USE NETWORK/OFFICE/DPT FAX NUMBER FROM DAYPART RECORD (IF ANY)             
         MVC   KEY,KEYSAVE                                                      
         XC    FAXKCLT,FAXKCLT     CLEAR CLIENT                                 
         MVC   FAXKOFC,SVCLTOFF                                                 
         MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
         CLC   KEY(20),KEYSAVE      ID/AM/NETWORK....                           
         BE    PRT14A                                                           
                                                                                
* OR USE NETWORK/CLIENT FAX NUMBER FROM DAYPART RECORD (IF ANY)                 
         MVC   KEY,KEYSAVE                                                      
         XC    FAXKOFC,FAXKOFC                                                  
         MVC   FAXKCLT,BCLT        CLEAR CLIENT                                 
         MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
         CLC   KEY(20),KEYSAVE      ID/AM/NETWORK....                           
         BE    PRT14A                                                           
                                                                                
* OR USE NETWORK/OFFICE FAX NUMBER FROM DAYPART RECORD (IF ANY)                 
         MVC   KEY,KEYSAVE                                                      
         XC    FAXKCLT,FAXKCLT     CLEAR CLIENT                                 
         MVC   FAXKOFC,SVCLTOFF                                                 
         MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
         CLC   KEY(20),KEYSAVE      ID/AM/NETWORK....                           
         BE    PRT14A                                                           
                                                                                
* OR USE NETWORK/DAYPART FAX NUMBER FROM DAYPART RECORD (IF ANY)                
         MVC   KEY,KEYSAVE                                                      
         XC    FAXKOFC,SVCLTOFF                                                 
         MVC   FAXKDPC,SVDPC                                                    
         MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
         CLC   KEY(20),KEYSAVE      ID/AM/NETWORK....                           
         BE    PRT14A                                                           
                                                                                
* OR USE NETWORK FAX NUMBER FROM DAYPART RECORD (IF ANY)                        
         MVC   KEY,KEYSAVE                                                      
         XC    FAXKOFC,FAXKOFC                                                  
         MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
         CLC   KEY(20),KEYSAVE      ID/AM/NETWORK....                           
         BNE   PRT14F                                                           
         DROP  R4                                                               
                                                                                
PRT14A   L     R6,AIO3                                                          
         GOTO1 (RF),(R1),=C'GETREC',=C'UNTFIL',KEY+21,(R6),DMWORK               
         CLC   KEY(7),0(R6)                                                     
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         NI    UPDSW,X'FF'-MULTIFAX CLEAR MULTI-FAX SWITCH                      
                                                                                
         L     R6,AIO3             THIS FIRST LOOP WILL LOOK FOR AT             
         LA    R6,27(R6)           LEAST ONE FAX NUMBER ON DAYPART REC          
         MVI   ELCODE,X'80'        ONLY THEN WILL IT CLEAR THE MASTER           
         BRAS  RE,FIRSTEL          FAX FROM THE TABLE AND CONTINUE              
         BNE   PRT14C              LOOKING FOR MULTI FAX                        
                                                                                
         USING FAXVEMEL,R6                                                      
PRT14A2  OC    FAXVFAX,FAXVFAX                                                  
         BNZ   PRT14A4                                                          
         BRAS  RE,NEXTEL                                                        
         BE    PRT14A2             SEE IF I HAVE THE FIRST FAX                  
         B     PRT14F              NO FAX                                       
                                                                                
PRT14A4  DS    0H                                                               
         XC    SVSFAX,SVSFAX       RE-INITIALIZE FAX TABLE                      
         LA    R1,SVSFAX           SAVE FAX IN TABLE                            
         MVC   0(L'FAXVFAX,R1),FAXVFAX                                          
         LA    R1,L'SVSFAX(R1)                                                  
                                                                                
PRT14A6  BRAS  RE,NEXTEL                                                        
         BNE   PRT14F                                                           
         OC    FAXVFAX,FAXVFAX     IS THERE A SUBSEQUENT FAX                    
         BZ    PRT14A6                                                          
         MVC   0(L'FAXVFAX,R1),FAXVFAX                                          
                                                                                
         CLI   OFFLINE,C'Y'        IF YES SET MULTI-FAX SWITCH                  
         BNE   *+16                                                             
         TM    UPDSW,MULTIFAX                                                   
         BO    *+8                                                              
         OI    UPDSW,MULTIFAX      TURN ON MULTI-FAX SWITCH                     
                                                                                
         LA    R1,L'SVSFAX(R1)                                                  
         B     PRT14A6                                                          
         DROP  R6                                                               
*                                                                               
PRT14C   DS    0H                                                               
         L     R6,AIO3                                                          
         LA    R6,27(R6)           DISP TO THE ELEM                             
         MVI   ELCODE,X'30'        FAX NUMBER                                   
         BRAS  RE,FIRSTEL                                                       
         BNE   PRT14F                                                           
                                                                                
         XC    SVSFAX,SVSFAX                                                    
                                                                                
         LA    R1,SVSFAX           SAVE FAX IN TABLE                            
                                                                                
PRT14D   MVC   0(3,R1),2(R6)       AREA CODE                                    
         MVC   3(3,R1),6(R6)       EXCHANGE                                     
         MVC   6(4,R1),10(R6)      NUMBER                                       
                                                                                
         BRAS  RE,NEXTEL           IF I FIND A SECOND ELEMENT THERE             
         BNE   PRT14F              IS THEN MORE THAN ONE FAX #                  
                                                                                
         CLI   OFFLINE,C'Y'                                                     
         BNE   *+16                                                             
         TM    UPDSW,MULTIFAX                                                   
         BO    *+8                                                              
         OI    UPDSW,MULTIFAX      TURN ON MULTI-FAX SWITCH                     
                                                                                
         LA    R1,L'SVSFAX(R1)                                                  
         B     PRT14D                                                           
                                                                                
PRT14F   DS   0H                                                                
         LA    R1,SVSFAX           POINT TO THE FIRST FAX NUMBER                
         ST    R1,SVFAXNXT         SAVE ADDRESS OF THIS FAX                     
                                                                                
PRT14X   CLI   OFFLINE,C'Y'                                                     
         BNE   PRT15                                                            
         TM    WHEN,X'20'          SOON REQUEST                                 
         BO    PRT15                YES                                         
         CLI   SVTWPR06,C'2'       THIS AN EASYLINK AGY COPY & FAX REQ          
         BE    PRT16                YES                                         
                                                                                
PRT15    OC    SVTS,SVTS                                                        
* FIX TEMP                                                                      
*        BZ    *+10                                                             
*        MVC   SVPRGPRG,UNTPROG                                                 
         BRAS  RE,EASILN                                                        
         TM    FAXSTAT,FAXMISS                                                  
         BZ    PRT16                                                            
         NI    FAXSTAT,X'FF'-FAXMISS                                            
         B     PRTXIT                                                           
                                                                                
* SET UP PRINTING ADDRESSABILITY (AFTER PRTQUE OPEN) *                          
                                                                                
PRT16    LM    RF,R1,=A(HEADING,HDHK,FTHK)  SSPECS, HEADHOOK, FOOTHOOK          
         L     RE,SPTR50RR                                                      
         AR    RF,RE                                                            
         ST    RF,SPECS            STORE SPECS FOR CONTROLLER                   
         AR    R0,RE                                                            
         ST    R0,HEADHOOK         STORE HEADHOOK FOR CONTROLLER                
         AR    R1,RE                                                            
         ST    R1,FOOTHOOK         STORE FOOTHOOK FOR CONTROLLER                
                                                                                
         MVI   MAXLINES,60         SET PAGE SIZE                                
         MVI   FOOTLNS,2           ALLOW 2 LINES OF FOOTLINES                   
         MVI   FOOTSW,0            RESET SWITCH                                 
         MVI   CLEARHED,C'N'       DO NOT CLEAR HEADLINES                       
         MVI   CONTINUE,C'Y'                                                    
                                                                                
         CLI   SVTWPR06,C'N'       THIS AN EASYLINK TRANS                       
         BE    PRT18                NO, BYPASS                                  
                                                                                
         TM    SVOPTSW1,OPTHDCPY   IF AGENCY COPY RUN                           
         BO    PRT18                NO, JUST EASYLINK                           
                                                                                
         MVI   MAXLINES,52         SET PAGE SIZE                                
*                                  CAN ONLY DO 52 ON FIRST PAGE                 
*                                  WILL THERAFTER BE SET TO 58                  
*                                  IN HEADHOOK (HDHK)                           
*                                                                               
*        BLANK THE HEADLINES NOW                                                
                                                                                
PRT18    LA    R0,14                                                            
         LA    R1,H1                                                            
         MVC   0(132,R1),SPACES                                                 
         LA    R1,132(R1)                                                       
         BCT   R0,*-10                                                          
                                                                                
         MVI   LINE,99             FORCE NEW PAGE WITHOUT FORCEHED              
         MVC   PAGE,=H'1'          WHICH CAUSES FOOTLINES TO REPRINT            
                                                                                
*        READ HEADLINE TEXT RECORD                                              
                                                                                
         L     RE,NEXTADDR                                                      
         MVC   AIO,AIO1                                                         
         XC    0(24,RE),0(RE)      PRECLEAR                                     
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A23'                                                  
         MVC   KEY+2(3),BAGYMD AND BCLT                                         
         MVI   KEY+8,C'H'                                                       
                                                                                
         BRAS  RE,INITSPT          SET TO SPOT                                  
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         L     RE,NEXTADDR                                                      
         LHI   RF,2000                                                          
         XCEFL                                                                  
         CLC   KEY(13),KEYSAVE     TEST TEXT FOUND                              
         BNE   PRT20                                                            
                                                                                
* PRINT COMMENTS (08 = DO GETREC THERE, CK FOR BOXES)                           
                                                                                
         OI    UPDSW,UPDSWGR       SET ON GETREC THERE SW                       
                                                                                
         L     RE,NEXTADDR                                                      
         LHI   RF,2000                                                          
         XCEFL                                                                  
*                                                                               
         LA    R1,DMCB                                                          
         MVC   0(4,R1),NEXTADDR                                                 
         MVI   0(R1),60                                                         
         BRAS  RE,PCMT                                                          
*                                                                               
         EJECT                                                                  
* FIND CLIENT COPY LIST REC, CONTACT NAME AND TEL # *                           
PRT20    DS    0H                                                               
         XC    SVISNMTE,SVISNMTE                                                
         XC    SVFAXTL,SVFAXTL                                                  
         XC    KEY,KEY                                                          
         XC    SVCONLST,SVCONLST                                                
                                                                                
         CLI   OPTPROD,0                                                        
         BE    PRT20F                                                           
         USING PRDLRECD,R5                                                      
         LA    R5,KEY                                                           
         MVC   PRDKID,=X'0A42'                                                  
         MVC   PRDKAM,BAGYMD                                                    
         MVC   PRDKCLT,BCLT                                                     
         MVC   PRDKPRD,OPTPROD                                                  
         MVC   PRDKNET,SAVNET                                                   
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     TEST CLIENT LIST FOUND                       
         BE    PRT20C                                                           
         MVC   KEY,KEYSAVE                                                      
         XC    PRDKNET,PRDKNET     LOOK FOR NON-NETWORK SPECIFIC                
         MVI   PRDKNET+2,X'FF'                                                  
         MVC   PRDKNET+1(1),SVOPTMED                                            
         CLI   SVOPTMED,0                                                       
         BNE   *+10                                                             
         MVC   PRDKNET+1(1),SVMEDIA                                             
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     TEST CLIENT LIST FOUND                       
         BE    PRT20C                                                           
         MVC   KEY,KEYSAVE                                                      
         XC    PRDKNET,PRDKNET     LOOK FOR NON-NETWORK SPECIFIC                
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     TEST CLIENT LIST FOUND                       
         BNE   PRT20P                                                           
         DROP  R5                                                               
                                                                                
PRT20C   DS    0H                                                               
         MVC   SVCONLST,KEY                                                     
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BNE   PRT20D                                                           
         USING PRDCONEL,R6                                                      
         MVC   SVISNMTE,PRDCONNM  SAVE CONTACT NAME AND TEL                     
         MVC   SVFAXTL,PRDFAXTL  SAVE CONTACT NAME AND TEL                      
         DROP  R6                                                               
                                                                                
PRT20D   MVC   SVEMLADR,SPACES                                                  
         L     R6,AIO                                                           
         MVI   ELCODE,X'30'                                                     
         BRAS  RE,GETEL                                                         
         BNE   PRT20E                                                           
         USING PRDEMLEL,R6                                                      
         SR    R5,R5                                                            
         IC    R5,1(R6)                                                         
         BCTR  R5,0                                                             
         EX    R5,*+8                                                           
         B     *+10                                                             
         MVC   SVEMLADR(0),PRDEMLAD                                             
         DROP  R6                                                               
                                                                                
PRT20E   DS    0H                                                               
         B     PRT26                                                            
                                                                                
PRT20F   OC    OPTPRGR,OPTPRGR     ANY PRODUCT GROUP                            
         BZ    PRT20P                                                           
         USING PGRNRECD,R5                                                      
         XC    KEY,KEY                                                          
         LA    R5,KEY                                                           
         MVC   PGRKID,=X'0A45'                                                  
         MVC   PGRKAM,BAGYMD                                                    
         MVC   PGRKCLT,BCLT                                                     
         MVC   PGRKGRP,PGROUP                                                   
         MVC   PGRKNET,SAVNET                                                   
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     TEST CLIENT LIST FOUND                       
         BE    PRT20J                                                           
         MVC   KEY,KEYSAVE                                                      
         XC    PGRKNET,PGRKNET     LOOK FOR NON-NETWORK SPECIFIC                
         MVI   PGRKNET+2,X'FF'                                                  
         MVC   PGRKNET+1(1),SVOPTMED                                            
         CLI   SVOPTMED,0                                                       
         BNE   *+10                                                             
         MVC   PGRKNET+1(1),SVMEDIA                                             
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     TEST CLIENT LIST FOUND                       
         BE    PRT20J                                                           
         MVC   KEY,KEYSAVE                                                      
         XC    PGRKNET,PGRKNET     LOOK FOR NON-NETWORK SPECIFIC                
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     TEST CLIENT LIST FOUND                       
         BNE   PRT20P                                                           
         DROP  R5                                                               
                                                                                
PRT20J   DS    0H                                                               
         MVC   SVCONLST,KEY                                                     
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BNE   PRT20L                                                           
         USING PGRCONEL,R6                                                      
         MVC   SVISNMTE,PGRCONNM  SAVE CONTACT NAME AND TEL                     
         MVC   SVFAXTL,PGRFAXTL  SAVE CONTACT NAME AND TEL                      
         DROP  R6                                                               
                                                                                
PRT20L   MVC   SVEMLADR,SPACES                                                  
         L     R6,AIO                                                           
         MVI   ELCODE,X'30'                                                     
         BRAS  RE,GETEL                                                         
         BNE   PRT20M                                                           
         USING PGREMLEL,R6                                                      
         SR    R5,R5                                                            
         IC    R5,1(R6)                                                         
         BCTR  R5,0                                                             
         EX    R5,*+8                                                           
         B     *+10                                                             
         MVC   SVEMLADR(0),PGREMLAD                                             
         DROP  R6                                                               
                                                                                
PRT20M   DS    0H                                                               
         B     PRT26                                                            
                                                                                
PRT20P   DS    0H                                                               
         USING CLTNRECD,R5                                                      
         XC    KEY,KEY                                                          
         LA    R5,KEY                                                           
         MVC   CLTKID,=X'0A41'                                                  
         MVC   CLTKAM,BAGYMD                                                    
         MVC   CLTKCLT,QCLT                                                     
         MVC   CLTKNET,SAVNET                                                   
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     TEST CLIENT LIST FOUND                       
         BE    PRT24                                                            
         MVC   KEY,KEYSAVE                                                      
         XC    KEY+6(4),KEY+6      LOOK FOR NON-NETWORK SPECIFIC                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     TEST CLIENT LIST FOUND                       
         BNE   PRT26                                                            
         DROP  R5                                                               
                                                                                
PRT24    DS   0H                                                                
         MVC   SVCONLST,KEY                                                     
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BNE   PRT24C                                                           
         USING CLTCONEL,R6                                                      
         MVC   SVISNMTE,CLTCONNM  SAVE CONTACT NAME AND TEL                     
         DROP  R6                                                               
                                                                                
PRT24C   L     R6,AIO                                                           
         MVI   ELCODE,X'30'                                                     
         BRAS  RE,GETEL                                                         
         BNE   PRT25                                                            
         USING CLTEMLEL,R6                                                      
         SR    R5,R5                                                            
         IC    R5,1(R6)                                                         
         BCTR  R5,0                                                             
         EX    R5,*+8                                                           
         B     *+10                                                             
         MVC   SVEMLADR(0),CLTEMLAD                                             
         DROP  R6                                                               
                                                                                
PRT25    DS    0H                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'14'                                                     
         BRAS  RE,GETEL                                                         
         BNE   PRT26                                                            
         USING CLTFAXEL,R6                                                      
         MVC   SVFAXTL,CLTFAXTL  SAVE CONTACT FAX TEL                           
         DROP  R6                                                               
                                                                                
PRT26    DS    0H                                                               
                                                                                
* GET OPTIONAL NETWORK ADDRESS FROM PROGRAM COPY LIST REC                       
                                                                                
         XC    SVNETADR,SVNETADR                                                
                                                                                
         CLI   SVTNPR10,C'Y'       BLK NET ADDRESS FROM PROGLIST                
         BE    PRT33                                                            
                                                                                
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A43'    PROGRAM LIST REC                              
         MVC   KEY+2(1),BAGYMD                                                  
         MVC   KEY+3(4),SAVNET                                                  
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     TEST CLIENT LIST FOUND                       
         BE    PRT32                                                            
         MVC   KEY(7),KEYSAVE                                                   
         XC    KEY+7(6),KEY+7                                                   
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   PRT33                                                            
PRT32    DS   0H                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BNE   PRT33                                                            
         USING PRGADREL,R6                                                      
         MVC   SVNETADR,PRGADRAD                                                
         DROP  R6                                                               
                                                                                
* READ PROGRAM RECORD FOR POSSIBLE DAYPART *                                    
                                                                                
PRT33    DS   0H                                                                
                                                                                
* PRINT THE HEADLINES *                                                         
                                                                                
PRT34    MVI   SPACING,1                                                        
         MVC   TSRKEYF,PRTCT       SAVE 1ST TSAR KEY NUMBER-1                   
         BRAS  RE,GOSPL                                                         
                                                                                
         CLI   CONREC,C'C'         TEST CABLE GEN                               
         BE    *+12                                                             
         MVI   SPACING,2                                                        
         BRAS  RE,GOSPL                                                         
                                                                                
         CLI   SVTWPR06,C'N'       THIS AN EASYLINK TRANS                       
         BE    PRT36                NO, BYPASS                                  
                                                                                
         TM    SVOPTSW1,OPTHDCPY   IF AGENCY COPY RUN                           
         BO    PRT36                NO, JUST EASYLINK                           
                                                                                
         MVI   MAXLINES,52         SET PAGE SIZE                                
*                                  CAN ONLY DO 52 ON FIRST PAGE                 
*                                  WILL THERAFTER BE SET TO 58                  
*                                  IN HEADHOOK (HDHK)                           
PRT36    DS   0H                                                                
         MVI   FRSTPGSW,C'N'          SET 1ST PAGE SW OFF                       
                                                                                
         CLC   SVNETREV,NETCREVN   COMPARE NET REV TO PROG REV                  
         BNL   *+10                                                             
         MVC   SVNETREV,NETCREVN   MOVE IN PROG REV NUMBER                      
                                                                                
         TM    NETFLAG,NETINSRN    WERE INSTR RUN FOR THIS REV?                 
         BZ    PRT36F               NO                                          
                                                                                
         CLC   CONWHEN(6),=C'OV,T/A' IS THIS A TURNAROUND REQ                   
         BE    PRT36F                                                           
                                                                                
         TM    SVOPTSW1,OPTHDCPY   TEST OPTION AGENCY COPY                      
         BO    PRT36F               YES                                         
                                                                                
         LLC   RF,SVNETREV                                                      
         LA    RF,1(,RF)                                                        
         STC   RF,SVNETREV                                                      
                                                                                
PRT36F   CLI   SVNETREV,0         TEST REV=0 (ORIGINAL/OLD REV REC)             
         BE    PRT37                                                            
                                                                                
         MVC   P1+92(11),=C'NETWORK REV'                                        
         EDIT  (B1,SVNETREV),(3,P1+104)                                         
         B     *+10                                                             
PRT37    DS    0H                                                               
         MVC   P1+92(9),=C'ORIGINAL '                                           
                                                                                
         CLI   CONREC,C'C'         TEST CABLE GEN                               
         BNE   PRT38                                                            
         MVC   P1+60(11),=C'DATE ISSUED'                                        
         GOTO1 DATCON,DMCB,(5,0),(5,P1+79)                                      
         MVC   P2+60(16),=C'AGENCY OF RECORD'                                   
         CLI   SVTNPR7,C'Y'       BLANK AGENCY OF RECORD N & A                  
         BE    PRT40                                                            
         TM    SVOPTSW,OPTNOAOR   BLANK AGENCY OF RECORD N & A                  
         BO    PRT40                                                            
         CLC   USERNAME,SPACES                                                  
         BH    *+10                                                             
         MVC   USERNAME(L'USERNAME+L'USERADDR),SVUSER                           
         MVC   P2+79(33),USERNAME                                               
         B     PRT40                                                            
                                                                                
PRT38    DS    0H                                                               
         MVC   P1+48(11),=C'DATE ISSUED'                                        
         GOTO1 DATCON,DMCB,(5,0),(5,P1+67)                                      
         MVC   P2+48(16),=C'AGENCY OF RECORD'                                   
         CLI   SVTNPR7,C'Y'       BLANK AGENCY OF RECORD N & A                  
         BE    PRT40                                                            
         TM    SVOPTSW,OPTNOAOR   BLANK AGENCY OF RECORD N & A                  
         BO    PRT40                                                            
         CLC   USERNAME,SPACES                                                  
         BH    *+10                                                             
         MVC   USERNAME(L'USERNAME+L'USERADDR),SVUSER                           
         MVC   P2+67(33),USERNAME                                               
PRT40    DS   0H                                                                
         CLI   CONREC,C'C'         TEST CABLE GEN                               
         BNE   PRT40M                                                           
         MVC   P1+3(6),=C'CLIENT'                                               
         MVC   P1+14(3),QCLT                                                    
         MVC   P1+19(20),CLTNM                                                  
         MVC   P2+3(7),=C'PRODUCT'                                              
         CLI   OPTPROD,0                                                        
         BE    PRT40C                                                           
         MVC   P2+14(3),OPTPROD                                                 
         MVC   P2+19(L'SVPRDNAM),SVPRDNAM                                       
         B     PRT40F                                                           
                                                                                
PRT40C   OC    OPTPRGR,OPTPRGR     RUNNING BY PGROUP                            
         BZ    PRT40D               NO                                          
         MVC   P2+14(4),=C'PGR='                                                
         MVC   P2+19(4),QPGR                                                    
         MVC   P2+24(L'SVPRGNAM),SVPRGNAM                                       
         B     *+10                                                             
PRT40D   MVC   P2+14(7),=C'VARIOUS'                                             
                                                                                
PRT40F   MVC   P3+3(7),=C'NETWORK'                                              
         MVC   P3+14(L'NETWORK),SAVNET                                          
         MVC   P3+19(30),SVNETADR                                               
         MVC   P4+14(L'SVMKTNM),SVMKTNM                                         
         B     PRT43A                                                           
                                                                                
PRT40M   DS    0H                                                               
         MVC   P1+2(6),=C'CLIENT'                                               
         MVC   P1+12(3),QCLT                                                    
         MVC   P1+17(20),CLTNM                                                  
                                                                                
         MVC   P2+2(7),=C'PRODUCT'                                              
         CLI   OPTPROD,0                                                        
         BE    PRT41                                                            
         MVC   P2+12(3),OPTPROD                                                 
         MVC   P2+17(L'SVPRDNAM),SVPRDNAM                                       
         B     PRT43                                                            
                                                                                
PRT41    OC    OPTPRGR,OPTPRGR     RUNNING BY PGROUP                            
         BZ    PRT42                NO                                          
         MVC   P2+12(4),=C'PGR='                                                
         MVC   P2+16(4),QPGR                                                    
         MVC   P2+22(L'SVPRGNAM),SVPRGNAM                                       
         B     PRT43                                                            
                                                                                
PRT42    MVC   P2+17(7),=C'VARIOUS'                                             
                                                                                
PRT43    DS    0H                                                               
         MVC   P3+2(7),=C'NETWORK'                                              
         MVC   P3+12(L'NETWORK),SAVNET                                          
         MVC   P3+17(30),SVNETADR                                               
         MVC   P4+12(L'SVMKTNM),SVMKTNM                                         
                                                                                
PRT43A   DS    0H                                                               
         CLI   CONREC,C'C'         TEST CABLE GEN                               
         BNE   PRT43C                                                           
         MVC   P3+60(9),=C'ISSUED BY'                                           
         MVC   P3+79(30),SVISNAME                                               
         MVC   P4+79(L'SVEMLADR),SVEMLADR                                       
         B     PRT44                                                            
                                                                                
PRT43C   DS    0H                                                               
         MVC   P3+48(9),=C'ISSUED BY'                                           
         MVC   P3+67(30),SVISNAME                                               
         MVC   P4+67(L'SVEMLADR),SVEMLADR                                       
                                                                                
PRT44    LA    R1,P1                                                            
         OC    SVISTEL,SVISTEL     ANY TELEPHONE NUMBER                         
         BNZ   PRT44C               YES                                         
         OC    SVFAXTL,SVFAXTL     ANY CONTACT FAX NUMBER                       
         BZ    PRT46                NO                                          
         BRAS  RE,GOSPL                                                         
         B     PRT44G               NO                                          
                                                                                
PRT44C   BRAS  RE,GOSPL                                                         
                                                                                
         CLI   CONREC,C'C'                                                      
         BNE   PRT44D                                                           
         MVC   P1+60(9),=C'TELEPHONE'                                           
         MVC   P1+79(24),SVISTEL                                                
         B     PRT44E                                                           
                                                                                
PRT44D   MVC   P1+48(9),=C'TELEPHONE'                                           
         MVC   P1+67(24),SVISTEL                                                
                                                                                
PRT44E   LA    R1,132(R1)                                                       
         OC    SVFAXTL,SVFAXTL     ANY CONTACT FAX NUMBER                       
         BZ    PRT46                NO                                          
                                                                                
PRT44G   DS    0H                                                               
         CLI   CONREC,C'C'                                                      
         BNE   PRT44H                                                           
         MVC   60(11,R1),=C'CONTACT FAX'                                        
         MVC   79(24,R1),SVFAXTL                                                
         B     PRT44J                                                           
                                                                                
PRT44H   MVC   48(11,R1),=C'CONTACT FAX'                                        
         MVC   67(24,R1),SVFAXTL                                                
                                                                                
PRT44J   LA    R1,132(R1)                                                       
                                                                                
PRT46    OC    SVTS,SVTS                                                        
         BZ    PRT50                                                            
         BRAS  RE,GOSPL                                                         
                                                                                
         CLI   CONREC,C'C'                                                      
         BNE   PRT46C                                                           
         MVC   60(16,R1),=C'TRAFFIC SUPPLIER'                                   
         MVC   79(5,R1),SVTS       PRINT TRAFFIC SUPPLIER                       
         LA    R1,132(R1)                                                       
         OC    SVCNAME,SVCNAME     CONTACT NAME                                 
         BZ    PRT50                                                            
         MVC   60(7,R1),=C'CONTACT'                                             
         MVC   79(L'SVCNAME,R1),SVCNAME                                         
         B     PRT50                                                            
                                                                                
PRT46C   MVC   48(16,R1),=C'TRAFFIC SUPPLIER'                                   
         MVC   67(5,R1),SVTS       PRINT TRAFFIC SUPPLIER                       
         LA    R1,132(R1)                                                       
         OC    SVCNAME,SVCNAME     CONTACT NAME                                 
         BZ    PRT50                                                            
         MVC   48(7,R1),=C'CONTACT'                                             
         MVC   67(L'SVCNAME,R1),SVCNAME                                         
                                                                                
PRT50    MVI   SPACING,2                                                        
         BRAS  RE,GOSPL                                                         
                                                                                
         TM    ANYFLAG,PIGGBSW+COPYSSW                                          
         BZ    PRT50E                                                           
         BM    *+14                                                             
         MVC   P1+67(41),=C'*** PIGGYBACKS AND COPYSPLITS PRESENT ***'          
         B     PRT50C                                                           
         MVC   P1+67(26),=C'*** PIGGYBACKS PRESENT ***'                         
         TM    ANYFLAG,PIGGBSW     ANY PIGGYBACKS                               
         BO    PRT50C                                                           
         MVC   P1+67(26),=C'*** COPYSPLITS PRESENT ***'                         
         TM    ANYFLAG,COPYSSW     ANY COPYSPLITS                               
         BO    PRT50C                                                           
         DS    H'0'                BUG CATCHER                                  
PRT50C   MVI   P1,0                                                             
         BRAS  RE,GOSPL                                                         
                                                                                
PRT50E   DS    0H                                                               
         L     R4,NEXTADDR         FORMATTED COMMENTS ARE HERE                  
         OC    0(60,R4),0(R4)      THERE ARE NO COMMENT                         
         BZ    PRT57                                                            
PRT51    LA    R0,4                                                             
         LA    R1,P1                                                            
PRT53    DS    0H                                                               
         OC    0(60,R4),0(R4)      TEST REACHED END OF COMMENTS                 
         BZ    PRT54                                                            
         MVC   3(60,R1),0(R4)                                                   
         LA    R1,132(R1)                                                       
         LA    R4,60(R4)                                                        
         BCT   R0,PRT53                                                         
PRT54    BRAS  RE,GOSPL                                                         
         OC    0(60,R4),0(R4)      TEST REACHED END OF COMMENTS                 
         BNZ   PRT51               NO                                           
                                                                                
PRT57    DS    0H                                                               
         CLI   CONREC,C'C'         TEST CABLE/GEN                               
         BE    *+8                                                              
         BRAS  RE,PCOMMENT         PRINT REQUEST COMMENTS FROM SCREEN           
                                                                                
* PRINT MIDLINES HERE FOR PAGE 1 ONLY AS PRINT LINES *                          
                                                                                
         MVI   P,0                                                              
*                                                                               
         CLI   SVT3PROF+2,C'Y'                                                  
         BE    PRT60                                                            
         LARL  RE,MIDLINE2                                                      
         MVC   P2+2(L'MIDLINE2),0(RE)                                           
         B     PRT65                                                            
                                                                                
PRT60    LARL  RE,MIDLINE                                                       
         MVC   P2+2(L'MIDLINE),0(RE)                                            
                                                                                
PRT65    MVI   P4,0                FORCE                                        
                                                                                
         BRAS  RE,GOSPL                                                         
                                                                                
* PRINT ALL PATTERNS ON INSTRUCTIONS *                                          
                                                                                
         BRAS  RE,BLIN              GO BUILD PRINT LINE(S)                      
         CLI   PRINTED,C'Y'        TEST PRINTED ANY PATTERNS                    
         BNE   PRTXIT              NO - EXIT                                    
                                                                                
         BRAS  RE,PCOM              GO PRINT COMMENTS                           
         EJECT                                                                  
* PRINT CLIENT, PRODUCT, AND PROGRAM LISTS *                                    
                                                                                
PRT110   CLI   SVTNPR11,C'Y'       DO NOT PRINT DISTRIBUTION LIST               
         BE    PRT121M                                                          
                                                                                
         L     R2,NEXTADDR         LIST BUILD AREA                              
         MVC   0(8,R2),=CL8'*CPYLST*'                                           
         LA    R2,8(,R2)                                                        
         ST    R2,ASVCPYLS                                                      
         LR    R1,R2                                                            
         L     RE,AIO3                                                          
         AHI   RE,-8                                                            
         SR    RE,R1                                                            
         CHI   RE,250                                                           
         BNL   *+6                                                              
         DC    H'0'                                                             
PRT112   XC    0(250,R1),0(R1)     CLEAR                                        
         LA    R1,250(,R1)                                                      
         AHI   RE,-250                                                          
         BZ    PRT114                                                           
         CHI   RE,250                                                           
         BNL   PRT112                                                           
         EX    RE,*+8                                                           
         B     *+10                                                             
         XC    0(0,R1),0(R1)                                                    
                                                                                
* IF CONTACT ELEMENT IS FOUND IN PRODUCT LIST RECORD                            
* THEN DO NOT PRINT THE DISTRIBUTION LIST FROM CLTLIST RECORD                   
                                                                                
PRT114   DS    0H                                                               
         OC    SVCONLST,SVCONLST                                                
         BZ    PRT121M                                                          
         XC    KEY,KEY                                                          
         MVC   KEY(L'SVCONLST),SVCONLST                                         
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     PRODUCT LIST RECORD?                         
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         MVI   ELCODE,X'20'        CONTACT ELEMENT                              
         BRAS  RE,GETEL                                                         
         BNE   PRT120                                                           
         SR    R4,R4                                                            
         B     *+8                                                              
PRT116   DS    0H                                                               
         BRAS  RE,NEXTEL                                                        
         BNE   PRT120                                                           
         XC    0(30,R2),0(R2)                                                   
         CLI   1(R6),4             EMPTY DISTRIB NAME ELEM                      
         BE    PRT118                                                           
         MVC   0(30,R2),3(R6)                                                   
PRT118   DS    0H                                                               
         LA    R2,30(,R2)                                                       
         LA    R4,1(,R4)                                                        
         B     PRT116                                                           
                                                                                
* FORCE EVEN ALIGNMENT OF LISTS *                                               
                                                                                
PRT120   DS    0H                                                               
         STC   R4,WORK             FORCE EVEN LIST                              
         TM    WORK,1              IF ODD, FORCE EXTRA ENTRY                    
         BZ    *+14                                                             
         XC    0(30,R2),0(R2)      BLANK ENTRY                                  
         LA    R2,30(,R2)                                                       
                                                                                
         XC    0(60,R2),0(R2)      FORCE BLANK LINE BETWEEN LISTS               
         LA    R2,60(,R2)                                                       
                                                                                
* PRODUCT LISTS - FOR ALL PRODUCTS IN INSTRUCTIONS *                            
                                                                                
PRT121   DS    0H                                                               
         ST    R2,DUB             SAVE TO SEE IF ANY LIST FOUND                 
                                                                                
PRT121M  DS    0H                                                               
         L     R4,AIO3                                                          
         LR    R5,R4                                                            
         SR    R6,R6                                                            
         LA    R0,SVPRDLEN                                                      
PRT122   DS    0H                                                               
         CLI   0(R4),0                                                          
         BE    PRT124                                                           
         LA    R4,SVPRDENT(,R4)                                                 
         LA    R6,1(,R6)                                                        
         BCT   R0,PRT122                                                        
                                                                                
PRT124   DS    0H                                                               
         LTR   R6,R6                                                            
         BNZ   PRT125                                                           
         DC    H'0'                                                             
                                                                                
PRT125   DS    0H                                                               
         GOTO1 XSORT,DMCB,AIO3,(R6),SVPRDENT,3,0                                
                                                                                
         CLI   SVTNPR11,C'Y'       DO NOT PRINT DISTRIBUTION LIST               
         BE    PRT150                                                           
                                                                                
         BAS   RE,PTX                                                           
                                                                                
         SR    R4,R4                                                            
                                                                                
* PROGRAM LIST *                                                                
                                                                                
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A43'                                                  
         MVC   KEY+2(1),BAGYMD                                                  
         MVC   KEY+3(4),SAVNET                                                  
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     ANY PROGRAM LIST                             
         BE    PRT136                                                           
         MVC   KEY(7),KEYSAVE                                                   
         XC    KEY+7(6),KEY+7                                                   
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   PRT140                                                           
                                                                                
PRT136   DS    0H                                                               
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         MVI   ELCODE,X'20'                                                     
         BRAS  RE,GETEL                                                         
PRT137   DS    0H                                                               
         B     *+8                                                              
PRT138   DS    0H                                                               
         BRAS  RE,NEXTEL                                                        
         BNE   PRT140                                                           
         XC    0(30,R2),0(R2)                                                   
         CLI   1(R6),4             EMPTY DISTRIB NAME ELEM                      
         BE    *+10                                                             
         MVC   0(30,R2),3(R6)                                                   
         LA    R2,30(,R2)                                                       
         LA    R4,1(,R4)                                                        
         B     PRT138                                                           
         EJECT                                                                  
* CHECK IF ANY LIST TO PRINT *                                                  
                                                                                
PRT140   DS    0H                                                               
         STC   R4,WORK             FORCE EVEN LIST                              
         TM    WORK,1              IF ODD, FORCE EXTRA ENTRY                    
         BZ    *+18                                                             
         XC    0(30,R2),0(R2)      BLANK ENTRY                                  
         LA    R2,30(,R2)                                                       
         LA    R4,1(,R4)                                                        
         CLI   KEY,X'26'           SEE IF DOING DAYPART REC                     
         BE    *+8                  YES                                         
         B     PRT149              GO DO DAYPART                                
                                                                                
PRT143   DS    0H                                                               
         C     R2,ASVCPYLS         ANY LIST  TO PRINT                           
         BE    PRT150               NO                                          
         L     RE,ASVCPYLS         DBL CK IF LIST EMPTY                         
         OC    0(30,RE),0(RE)                                                   
         BNZ   PRT145                                                           
         LA    RE,30(,RE)                                                       
         CR    RE,R2                                                            
         BL    *-16                                                             
         B     PRT150                                                           
*                                                                               
PRT145   MVI   P,0                 SKIP A LINE                                  
         BRAS  RE,GOSPL                                                         
*                                                                               
         MVC   P+2(10),=CL10'COPIES TO:'                                        
         L     R4,ASVCPYLS                                                      
                                                                                
* COUNT LINES REQUIRED FOR COPY LIST *                                          
                                                                                
         LR    R1,R4                                                            
         SR    R0,R0                                                            
         CR    R1,R2               AT END?                                      
         BNL   *+12                                                             
         LA    R1,30(,R1)                                                       
         BCT   R0,*-10                                                          
         BCTR  R0,0                ADD ONE FOR ODD LINE                         
         LPR   R0,R0                                                            
         SRL   R0,1                DIVIDE BY 2 (PER LINE)                       
         STC   R0,ALLOWLIN                                                      
                                                                                
         LA    R6,P+50                                                          
         LA    R5,P+14                                                          
PRT146   CLC   0(30,R4),=CL30'@ '                                               
         BE    *+10                                                             
         MVC   0(30,R5),0(R4)                                                   
         LA    R5,35(,R5)                                                       
         CR    R5,R6                                                            
         BL    PRT148                                                           
         LA    R5,P+14                                                          
         BRAS  RE,GOSPL                                                         
*                                                                               
PRT148   LA    R4,30(,R4)                                                       
         CR    R4,R2                                                            
         BL    PRT146                                                           
         CLC   P,SPACES                                                         
         BE    PRT150                                                           
         BRAS  RE,GOSPL                                                         
         B     PRT150                                                           
                                                                                
*                                                                               
* GET NAME LIST FROM DAYPART RECORD *                                           
* USE NETWORK/CLIENT/DPT FAX NUMBER FROM DAYPART RECORD (IF ANY)                
PRT149   DS   0H                                                                
         XC    KEY,KEY                                                          
         USING FAXKEY,R4                                                        
         LA    R4,KEY                                                           
         MVI   FAXKID,X'26'        RECORD ID                                    
         MVC   FAXKAM,BAGYMD       AGY/MED                                      
         MVC   FAXKNET,SAVNET      NETWORK                                      
         MVC   FAXKCLT,BCLT        CLIENT                                       
         MVC   FAXKDPC,SVDPC                                                    
         MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
         CLC   KEY(20),KEYSAVE      ID/AM/NETWORK/CLT                           
         BE    PRT149A                                                          
                                                                                
* OR USE NETWORK/OFFICE/DPT FAX NUMBER FROM DAYPART RECORD (IF ANY)             
         MVC   KEY,KEYSAVE                                                      
         XC    FAXKCLT,FAXKCLT     CLEAR CLIENT                                 
         MVC   FAXKOFC,SVCLTOFF                                                 
         MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
         CLC   KEY(20),KEYSAVE      ID/AM/NETWORK....                           
         BE    PRT149A                                                          
                                                                                
* OR USE NETWORK/CLIENT FAX NUMBER FROM DAYPART RECORD (IF ANY)                 
         MVC   KEY,KEYSAVE                                                      
         XC    FAXKOFC,FAXKOFC                                                  
         MVC   FAXKCLT,BCLT        CLEAR CLIENT                                 
         MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
         CLC   KEY(20),KEYSAVE      ID/AM/NETWORK....                           
         BE    PRT149A                                                          
                                                                                
* OR USE NETWORK/OFFICE FAX NUMBER FROM DAYPART RECORD (IF ANY)                 
         MVC   KEY,KEYSAVE                                                      
         XC    FAXKCLT,FAXKCLT     CLEAR CLIENT                                 
         MVC   FAXKOFC,SVCLTOFF                                                 
         MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
         CLC   KEY(20),KEYSAVE      ID/AM/NETWORK....                           
         BE    PRT149A                                                          
                                                                                
* OR USE NETWORK/DAYPART FAX NUMBER FROM DAYPART RECORD (IF ANY)                
         MVC   KEY,KEYSAVE                                                      
         XC    FAXKOFC,SVCLTOFF                                                 
         MVC   FAXKDPC,SVDPC                                                    
         MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
         CLC   KEY(20),KEYSAVE      ID/AM/NETWORK....                           
         BE    PRT149A                                                          
                                                                                
* OR USE NETWORK FAX NUMBER FROM DAYPART RECORD (IF ANY)                        
         MVC   KEY,KEYSAVE                                                      
         XC    FAXKOFC,FAXKOFC                                                  
         MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'UNTDIR',KEYSAVE,KEY                   
         CLC   KEY(20),KEYSAVE      ID/AM/NETWORK....                           
         BNE   PRT143                                                           
         DROP  R4                                                               
                                                                                
* NAME LIST *                                                                   
                                                                                
PRT149A  XC    0(60,R2),0(R2)                                                   
         LA    R2,60(R2)           FORCE BLANK LINE                             
         L     R6,AIO3                                                          
         GOTO1 (RF),(R1),=C'GETREC',=C'UNTFIL',KEY+21,(R6),DMWORK               
         CLC   KEY(7),0(R6)                                                     
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         LA    R6,27(R6)           DISP TO THE ELEM                             
         MVI   ELCODE,X'20'        NAME LIST                                    
         BRAS  RE,FIRSTEL                                                       
         B     PRT137              GET ELEMENT                                  
                                                                                
* PRINT PROGRAMS COVERED BY THIS LETTER *                                       
                                                                                
PRT150   DS    0H                                                               
         L     R5,AUNTABLE                                                      
         BRAS  RE,INITSPT          SET TO SPOT                                  
         L     R3,APNAMTAB         ALL PROGRAM NAME TABLE                       
         LR    RE,R3               CLEAR PROGRAM NAME TABLE                     
         L     RF,MXPNAMTB                                                      
         SR    RF,RE                                                            
         XCEFL                                                                  
                                                                                
         L     R5,AUNTABLE                                                      
         USING UNTABLED,R5                                                      
*                                                                               
PRT151   OC    UNTPROG,UNTPROG     THIS NOT PROG                                
         BZ    PRT154                                                           
                                                                                
         L     R3,APNAMTAB         ALL PROGRAM NAME TABLE                       
*                                                                               
PRT152   DS    0H                                                               
         OC    0(6,R3),0(R3)       EMPTY ENTRY                                  
         BZ    PRT153                                                           
         CLC   0(6,R3),UNTPROG     FOUND IN TABLE                               
         BE    PRT154                                                           
         LA    R3,8(R3)            ADDING A FIELD TO APNAMTAB                   
         C     R3,MXPNAMTB                                                      
         BL    PRT152                                                           
         DC    H'0'                RAN OUT OF PROGRAM NAME TABLE                
                                                                                
PRT153   MVC   0(6,R3),UNTPROG     SAVE PROGRAM FROM TABLE                      
         CLI   0(R3),0                                                          
         BNE   *+6                                                              
         DC    H'0'                                                             
         L     R0,MXPNAMTB                                                      
         A     R0,APNAMTAB                                                      
         CR    R3,R0               SEE IF PAST END                              
         BNL   PRT155                                                           
                                                                                
PRT154   DS    0H                                                               
         LA    R5,UNTNEXT          NEXT IN TABLE                                
         OC    UNTENT,UNTENT       AT END OF TABLE                              
         BNZ   PRT151               NO                                          
                                                                                
PRT155   DS   0H                                                                
         MVC   P,SPACES                                                         
         L     R3,APNAMTAB         ALL PROGRAM NAME TABLE                       
         LA    R5,UNTWORK                                                       
                                                                                
         OC    0(6,R3),0(R3)       EMPTY ENTRY                                  
         BZ    PRT160                                                           
                                                                                
PRT156   DS   0H                                                                
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING NPGKEY,R4                                                        
         MVC   NPGKTYP,=X'0D20'                                                 
         MVC   NPGKAM,BAGYMD                                                    
         MVC   NPGKNET,NETMKT                                                   
         MVC   NPGKPROG,0(R3)                                                   
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(11),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         MVI   ELCODE,X'92'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING NPGEL92,R6                                                       
                                                                                
PRT158   DS    0H                                                               
         LA    R3,8(R3)            ADDING A FIELD TO APNAMTAB                   
         OC    0(6,R3),0(R3)       EOL                                          
         BNZ   PRT156              NO                                           
         DROP  R4,R5,R6                                                         
                                                                                
PRT160   DS    0H                                                               
         TM    SVFLAG,SVTAG                                                     
         BZ    PRT161                                                           
         NI    SVFLAG,X'FF'-SVTAG                                               
         MVI   P,0                                                              
         MVC   P2+2(41),=C'*** THERE ARE TAGS(S) ON INSTRUCTIONS ***'           
         BRAS  RE,GOSPL                                                         
PRT161   DS    0H                                                               
                                                                                
         BRAS  RE,INITNET          SET TO UNIT FILE                             
                                                                                
* IF EVER NEED TO PRINT FOOTLINES AT END OF REPORT *                            
                                                                                
         OC    BINDMCB+8(4),BINDMCB+8                                           
         BZ    PRT162                                                           
         L     R4,ACMLTAB                                                       
         BRAS  RE,PACML                                                         
                                                                                
PRT162   DS    0H                                                               
         BRAS  RE,PSTEXT           GO PRINT SPECIAL TEXT                        
                                                                                
         MVC   TSRKEYL,PRTCT       SAVE LAST TSAR KEY NUMBER                    
                                                                                
         TM    SVOPTSW1,OPTHDCPY   TEST OPTION AGENCY COPY                      
         BO    PRTXIT                                                           
                                                                                
* UPDATE REVISION RECORD(S) FOR THIS NETWORK *                                  
                                                                                
PRT166   BRAS  RE,UPDR                                                          
                                                                                
PRT167   CLI   SVTWPR06,C'N'       EASYLINK TRANSMISSION                        
         BE    PRTXIT               NO                                          
                                                                                
         CLI   OFFLINE,C'Y'        ONLINE ?                                     
         BNE   PRTXIT               YES, DONE (MULTI-FAX NOT SUPPORTED)         
                                                                                
         CLI   SVTWPR06,C'Y'       EASYLINK TRANSMISSION                        
         BE    PRT168               YES                                         
                                                                                
         TM    WHEN,X'20'          THIS A SOON RUN                              
         BZ    PRTXIT               NO                                          
                                                                                
PRT168   MVC   P1(26),=C'*** END OF DDS MESSAGE ***'                            
         MVI   LINE,2                                                           
         GOTO1 SPOOL,DMCB,(R8)                                                  
                                                                                
* BLANK THE HEADLINES NOW *                                                     
                                                                                
         LA    R0,14                                                            
         LA    R1,H1                                                            
         MVC   0(132,R1),SPACES                                                 
         LA    R1,132(R1)                                                       
         BCT   R0,*-10                                                          
         MVC   MID1,SPACES                                                      
         MVC   MID2,SPACES                                                      
                                                                                
PRT170   TM    UPDSW,MULTIFAX                                                   
         BZ    PRTXIT                                                           
                                                                                
         BRAS  RE,GTSPL                                                         
         B     PRT170                                                           
                                                                                
PRTXIT   XIT1                                                                   
         EJECT                                                                  
*=========================================================                      
* PRINT ANY TEXT BY PRODUCT                                                     
*=========================================================                      
                                                                                
PTX      NTR1                                                                   
                                                                                
         LR    R4,R6               COUNT OF PRODUCTS                            
         L     R5,AIO3                                                          
                                                                                
* READ PRODUCT TEXT RECORD *                                                    
                                                                                
PTX10    XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A23'                                                  
         MVC   KEY+2(3),BAGYMD AND BCLT                                         
         MVC   KEY+5(3),0(R5)  AND PRODUCT                                      
         MVI   KEY+8,C'H'                                                       
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     TEST TEXT FOUND                              
         BNE   PTX40                                                            
                                                                                
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
                                                                                
         MVI   BYTE,0                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         MVI   ELCODE,X'40'                                                     
         BNE   PTX14                                                            
         MVC   BYTE,2(R6)                                                       
         SR    R2,R2                                                            
         SR    R3,R3                                                            
         BRAS  RE,NEXTEL                                                        
         BE    PTX12                                                            
         DC    H'0'                                                             
PTX12    LLC   RE,1(R6)                                                         
         CR    R2,RE                                                            
         BNL   *+6                                                              
         LR    R2,RE                                                            
         BCTR  R3,0                                                             
         BRAS  RE,NEXTEL                                                        
         BE    PTX12                                                            
         LCR   R3,R3                                                            
         STC   R3,ALLOWLIN                                                      
         TM    BYTE,X'80'         PUT IN BOXES                                  
         BZ    PTX14                                                            
         LA    R3,2(,R3)          2 MORE FOR 2 LINES OF ASTERISKS               
         STC   R3,ALLOWLIN                                                      
         MVI   P+PPROG-PRTLINE,C'*'                                             
         BCTR  R2,0                                                             
         EX    R2,*+8                                                           
         B     *+10                                                             
         MVC   P+PPROG-PRTLINE+1(0),P+PPROG-PRTLINE                             
         BRAS  RE,GOSPL                                                         
                                                                                
PTX14    L     R6,AIO1                                                          
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
PTX20    LLC   RE,1(R6)                                                         
         AHI   RE,-4                                                            
         TM    BYTE,X'80'          PUT IN BOXES                                 
         BO    PTX24                                                            
         EX    RE,*+8                                                           
         B     PTX28                                                            
         MVC   P+PPROG-PRTLINE(0),3(R6) *EXECUTED*                              
PTX24    MVI   P+PPROG-PRTLINE,C'*'                                             
         EX    RE,PTX26                                                         
         LA    R1,P+PPROG-PRTLINE+1(R2)                                         
         MVI   0(R1),C'*'                                                       
         B     PTX28                                                            
PTX26    MVC   P+PPROG-PRTLINE+2(0),3(R6)                                       
                                                                                
PTX28    BRAS  RE,GOSPL                                                         
         BRAS  RE,NEXTEL                                                        
         BE    PTX20                                                            
                                                                                
         TM    BYTE,X'80'          PUT IN BOXES                                 
         BZ    PTX30                                                            
         MVI   P+PPROG-PRTLINE,C'*'                                             
         EX    R2,*+8                                                           
         B     *+10                                                             
         MVC   P+PPROG-PRTLINE+1(0),P+PPROG-PRTLINE                             
         BRAS  RE,GOSPL                                                         
                                                                                
PTX30    DS    0H                                                               
         MVI   SPACING,2                                                        
         BRAS  RE,GOSPL                                                         
                                                                                
PTX40    LA    R5,SVPRDENT(,R5)           NEXT PRODUCT                          
         BCT   R4,PTX10                                                         
         B     PRTXIT                                                           
         EJECT                                                                  
                                                                                
         LTORG                                                                  
         EJECT                                                                  
                                                                                
HEADING  SSPEC H1,3,AGYNAME                                                     
         SSPEC H2,3,AGYADD                                                      
                                                                                
         SSPEC H1,39,C'NETWORK COMMERCIAL SCHEDULE'                             
         SSPEC H2,39,C'---------------------------'                             
         SSPEC H3,40,C'PERIOD'                                                  
                                                                                
         SSPEC H1,85,REPORT                                                     
         SSPEC H2,85,RUN                                                        
         SSPEC H3,85,PAGE                                                       
         SSPEC H3,93,REQUESTOR                                                  
         DC    X'00'               END MARKER FOR SSPECS                        
         EJECT                                                                  
* MODEL DCB FOR AUTO REQUEST FILE-MOVED TO CORE RESIDENT AREA FOR USE           
         DS    0D                                                               
ERRFILE  DCB   BLKSIZE=5500,                                           X        
               DDNAME=ERRFILE,                                         X        
               DSORG=PS,                                               X        
               LRECL=55,                                               X        
               MACRF=PM,                                               X        
               RECFM=FB                                                         
                                                                                
* DCB FOR OFF-LINE PRINT FILE, PRINT ONCE TO EASYLINK, ONCE TO                  
* NORMAL SPOOL FROM PRTFILE                                                     
                                                                                
         DROP  R7                                                               
         EJECT                                                                  
*===================================================================            
* SUBROUTINE TO READ ALL PATTERN RECORDS FOR REQUEST PERIOD                     
* READ AND BUILD PATTERN TABLE(S)                                               
* THIS TABLE WILL BE BASIS TO PRINT INSTRUCTIONS                                
*===================================================================            
                                                                                
BLPAT    NTR1  BASE=*,LABEL=*                                                   
         MVI   ERROR,0                                                          
                                                                                
         L     R2,APATABLE                                                      
         ST    R2,NEXTADDR                                                      
                                                                                
         L     RE,APATABLE                                                      
         AHI   RE,-8                                                            
         MVC   0(8,RE),=C'PATABLE*'                                             
         L     R0,APATABLE                                                      
         L     R1,MAXPATBL                                                      
         SR    R1,R0                                                            
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         BRAS  RE,INITXSP          SET TO XSPOT                                 
         XC    NXPATSEQ,NXPATSEQ                                                
                                                                                
* FIRST READ ANY ALL NETWORK PATTERN RECORDS *                                  
                                                                                
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING NPTXKEY,R4                                                       
         MVC   NPTXKID,=X'0A61'                                                 
         MVC   NPTXAM(3),BAGYMD     A-M/CLT                                     
         XC    KEYSAVE,KEYSAVE                                                  
                                                                                
BLP04    DS   0H                                                                
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         B     BLP20                                                            
                                                                                
BLP10    MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
                                                                                
BLP20    DS   0H                                                                
         CLC   KEY(9),KEYSAVE      SAME A-M/CLT/NETWORK                         
         BE    BLP24                                                            
                                                                                
         CLC   KEY(5),KEYSAVE      SAME A-M/CLT                                 
         BNE   BLP30                                                            
                                                                                
         OC    NPTXNET(NPTXR3F+3-NPTXNET),NPTXNET THIS A SEQ REC?               
         BZ    BLP10                               YES, BYPASS                  
         CLI   NPTXNET,C'$'        TEST A LIST RECORD                           
         BE    BLP10                                                            
                                                                                
         CLI   NPTXNET,X'00'       MEDIA SPECIFIC?                              
         BNE   BLP21                                                            
         CLI   NPTXNET+2,X'FF'     MEDIA SPECIFIC                               
         BNE   BLP21                                                            
         CLC   NPTXNET+1(1),SVMEDIA    THIS MEDIA?                              
         BE    BLP24                                                            
                                                                                
         MVI   NPTXNET+3,X'FF'     BUMP TO NEXT MEDIA                           
         GOTO1 HIGH                                                             
         B     BLP20                                                            
                                                                                
BLP21    CLC   NPTXNET,SAVNET                                                   
         BH    BLP30                                                            
         BE    BLP22                                                            
                                                                                
* NOW READ NETWORK SPECIFIC PATTERN RECORDS *                                   
                                                                                
         XC    KEY,KEY                                                          
         MVC   NPTXKID,=X'0A61'                                                 
         MVC   NPTXAM(3),BAGYMD     A-M/CLT                                     
         MVC   NPTXNET(4),SAVNET    NETWORK                                     
         B     BLP04                                                            
                                                                                
BLP22    MVC   KEYSAVE,KEY                                                      
                                                                                
BLP24    DS    0H                                                               
         CLI   NPTXR3F,X'A0'       THIS SAVED OLD PATTERN                       
         BL    BLP10               YES, BYPASS                                  
*                                                                               
         L     R6,AIO1             SET I/O AREA ADDRESS                         
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
                                                                                
BLP26    DS    0H                                                               
         CLI   NPTXNET-NPTXKEY(R6),C'$' TEST NETWORK LIST REC                   
         BNE   *+12                                                             
         BRAS  RE,CKPATLST         SEE IF NETWORK DELETED                       
         BNE   BLP28                                                            
*                                                                               
         BAS   RE,BLENT            BUILD PATTERN TABLE ENTRY                    
BLP28    B     BLP10                                                            
*                                                                               
BLP30    DS    0H                                                               
         BAS   RE,BLSORT                                                        
*                                                                               
         BRAS  RE,INITSPT          SET TO SPOT                                  
         XIT1                                                                   
         LTORG                                                                  
         DROP  R4                                                               
         EJECT                                                                  
*================================================================               
* SUBROUTINE TO BUILD A PATTERN LIST ENTRY FROM PATTERN RECORD                  
*================================================================               
                                                                                
BLENT    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R2,NEXTADDR                                                      
         LR    R4,R6                                                            
                                                                                
         USING NPTXKEY,R4                                                       
         L     R5,AUNTABLE             LOOK FOR PATTERN PROD IN UNIT            
         USING UNTABLED,R5             TABLE                                    
BLE10    CLC   UNTPROD,NPTXPRD         LOOK FOR THIS PATTERN PROD               
         BE    BLE12                   IN UNIT TABLE                            
         OC    NPTXPRD2,NPTXPRD2       SECOND PROD ON PATTERN?                  
         BZ    *+14                                                             
         CLC   UNTPROD2,NPTXPRD2       LOOK FOR THIS PATTERN PROD               
         BE    BLE12                   IN UNIT TABLE                            
         LA    R5,UNTNEXT              IF PAT/PRD NOT FOUND IN UNIT             
         OC    UNTENT,UNTENT           TABLE DO NOT REPORT IT                   
         BNZ   BLE10                                                            
         B     BLEX                                                             
         DROP  R5                                                               
                                                                                
         USING NPTXKEY,R4                                                       
BLE12    CLI   NPTXPROG,X'FF'      THIS A FEED OR DAYPART                       
         BE    BLE18                YES                                         
         OC    NPTXPROG,NPTXPROG   PATTERN PROGRAM SPECIFIC                     
         BZ    BLE18                NO                                          
         OC    PROGRAM,PROGRAM     IS REQUEST PROGRAM SPECIFIC                  
         BZ    BLE15                NO                                          
         CLC   PROGRAM,NPTXPROG    THIS PROGRAM                                 
         BE    BLE18                YES                                         
         B     BLEX                                                             
*                                                                               
* ONLY TABLE PROG SPECIFIC PATTERN IF PROG IS IN UNIT TABLE *                   
*                                                                               
BLE15    L     R5,AUNTABLE                                                      
         USING UNTABLED,R5                                                      
*                                                                               
BLE16    CLC   UNTPROG,NPTXPROG    THIS PROGRAM                                 
         BE    BLE18                YES                                         
         LA    R5,UNTNEXT                                                       
         OC    UNTENT,UNTENT                                                    
         BNZ   BLE16                                                            
         B     BLEX                                                             
         DROP  R5                                                               
*                                                                               
BLE18    L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING NPTDTAEL,R6                                                      
*                                                                               
         CLC   ENDATEB,NPTSTART    PERIOD END BEFORE PATTERN START              
         BL    BLEX                                                             
         CLC   STDATEB,NPTEND      PERIOD START AFTER PATTERN END               
         BH    BLEX                                                             
         MVI   ELEM+6,0                                                         
         TM    NPTSTAT,X'80'       TEST STATUS = DELETED                        
         BZ    BLE19                NO                                          
         B     BLEX                                                             
*                                                                               
BLE19    CLI   OPTPROD,0           TEST ONE PRD ONLY                            
         BZ    BLE19A                                                           
         CLC   OPTPROD,NPTXPRD     RIGHT PRODUCT                                
         BNE   BLEX                                                             
*                                                                               
BLE19A   L     R2,NEXTADDR                                                      
         LA    R2,0(R2)             CLEAR HOB                                   
         USING PATABLED,R2                                                      
*                                                                               
* ADD ENTRY TO PATTERN LIST *                                                   
*                                                                               
         C     R2,MAXPATBL         TEST ROOM IN LIST                            
         BH    NOPTNRM                                                          
*                                                                               
         LH    RE,NXPATSEQ         BUMP SEQUENCE NUMBER                         
         LA    RE,1(RE)                                                         
         STH   RE,NXPATSEQ         AND SAVE                                     
*                                                                               
         OC    NPTXNET,NPTXNET     THIS ALL NETWORKS PATTERN                    
         BNZ   BLE20                NO                                          
         MVI   ELCODE,PATQALL      SET ALL NETS IND                             
         B     BLE50                                                            
*                                                                               
BLE20    CLI   NPTXNET,0           IS THIS MEDIA SPECIFIC PATTERN               
         BNE   BLE22               NO                                           
         CLI   NPTXNET+2,X'FF'                                                  
         BNE   BLE22                                                            
         MVI   ELCODE,PATQMED      SET BY MEDIA                                 
         CLI   NPTXPROG,X'FF'      NOW CHECK IF ALSO DAYPART                    
         BNE   BLE50                                                            
         MVI   ELCODE,PATQDPMD     SET BY MEDIA & DAYPART                       
         MVC   PATDP,NPTXPROG+1                                                 
         B     BLE50                                                            
*                                                                               
BLE22    OC    NPTXPROG,NPTXPROG   THIS ALL PROGRAMS PATTERN                    
         BNZ   BLE24                NO                                          
         MVI   ELCODE,PATQNET      SET ALL PGMS IND                             
         B     BLE50                                                            
*                                                                               
BLE24    CLI   NPTXPROG,X'FF'      THIS FEED AND/OR DAYPART CD                  
         BE    BLE30                YES                                         
         MVI   ELCODE,PATQPROG     SET AS PROGRAM PATTERN                       
         MVC   PATPROG,NPTXPROG                                                 
         B     BLE50                                                            
*                                                                               
BLE30    OC    NPTXPROG+2(4),NPTXPROG+2 THIS A FEED PATTERN                     
         BNZ   BLE40                     YES                                    
         MVI   ELCODE,PATQDPT      SET AS DAYPART PATTERN                       
         B     BLE46                                                            
*                                                                               
BLE40    MVC   PATFEED,NPTXPROG+2                                               
         CLI   NPTXPROG+1,0        THIS A FEED DAYPART PATTERN                  
         BNE   BLE44                     YES                                    
         MVI   ELCODE,PATQFEED     SET AS FEED ONLY                             
         B     BLE50                                                            
*                                                                               
BLE44    MVI   ELCODE,PATQDPFD     SET AS FEED AND DAYPART                      
*                                                                               
BLE46    MVC   PATDP,NPTXPROG+1                                                 
*                                                                               
BLE50    MVC   PATSEQ,NXPATSEQ+1       MOVE RELATIVE PATTERN SEQNUM             
         MVC   PATPRD,NPTXPRD                                                   
         MVC   PATSLN,NPTXSLN                                                   
         MVC   PATPRD2,NPTXPRD2                                                 
         MVC   PATSLN2,NPTXSLN2                                                 
         MVC   PATREF,NPTXR3F                                                   
         MVC   PATYPE,ELCODE           SET ENTRY TYPE                           
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(3,NPTSTART),(2,PATPSTR)                             
         MVC   PATDATES(2),PATPSTR     SAVE PATTERN START DATE                  
*                                                                               
         CLC   PATPSTR,STDATEP         PATTERN START BEFORE REQ PERIOD          
         BH    *+10                                                             
         MVC   PATPSTR,STDATEP                                                  
*                                                                               
         CLC   NPTEND,=X'FFFFFF'                                                
         BNE   BLE56                                                            
         MVC   PATPEND,ENDATEP         MOVE END PERIOD DATE                     
         OI    PATFLG,PATFLUFN         SET FLAG                                 
         B     BLE60                                                            
*                                                                               
         FIXDT02                                                                
BLE56    GOTO1 (RF),(R1),(3,NPTEND),(2,PATPEND)                                 
         MVC   PATDATES+2(2),PATPEND SAVE PATTERN END DATE                      
*                                                                               
BLE60    CLC   PATPEND,ENDATEP         PATTERN END AFTER REQ PERIOD             
         BL    *+10                                                             
         MVC   PATPEND,ENDATEP                                                  
*                                                                               
         MVC   PATSTR,PATPSTR          SET AS UNIT DATES IN PTTN                
         MVC   PATEND,PATPEND                                                   
*                                                                               
         TM    NPTSTAT,NPTS_TIME       ELEM BIG ENOUGH TO HAVE TIME             
         BZ    *+10                    NO                                       
         MVC   PATSTIM(4),NPTSTIM      MOVE START/END TIMES                     
*                                                                               
         MVC   PATSEQNO,NPTS3QNO       SEQNUM FROM PATTERN RECORD               
*                                                                               
         BRAS  RE,BLHIAT               DEAL WITH HIATUSES                       
*                                                                               
         SR    R2,R2                                                            
         ICM   R2,7,NEXTADDR+1     BLHIAT UPDATES NEXTADDR                      
*                                                                               
BLEX     XIT1                                                                   
*                                                                               
NOPTNRM  DC    H'0'                                                             
         LTORG                                                                  
         EJECT                                                                  
*===============================================================                
* BUILD HIATUS DATE LIST IN IOA3 -                                              
* THEN INSERT HIATUS DATES FOR PATTERN ENTRY AT 0(R2)                           
*===============================================================                
                                                                                
BLHIAT   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R4,AIO3                                                          
         LA    R5,12                                                            
         XC    0(256,R4),0(R4)                                                  
         LA    R4,256(R4)                                                       
         BCT   R5,*-10                                                          
*                                                                               
* FILL IN THE DATES AND SEQNUMS IN THE TABLE                                    
*                                                                               
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,PATPSTR),WORK                                     
         FIXDT02                                                                
         GOTO1 (RF),(R1),(2,PATPEND),WORK+6                                     
         MVC   PARAS(12),WORK         SAVE PATTERN START/END                    
*                                                                               
         L     R4,AIO3                                                          
         L     RF,ADDAY                                                         
         LA    R1,DMCB                                                          
*                                                                               
BLH2     MVC   0(6,R4),WORK                                                     
         MVC   6(2,R4),=X'0101'          SET A FLAG                             
         LA    R4,8(R4)                                                         
         GOTO1 (RF),(R1),WORK,WORK+12,1  GET NEXT DATE                          
         MVC   WORK(6),WORK+12                                                  
         CLC   WORK(6),WORK+6            PASSED END DATE YET?                   
         BNH   BLH2                                                             
*                                                                               
         L     R6,AIO              FIND HIATUS ELEMENT                          
         MVI   ELCODE,X'5C'                                                     
         BRAS  RE,GETEL                                                         
         JNE   BLHX                                                             
*                                                                               
         USING NPTHIAEL,R6                                                      
BLH4     CLI   NPTHIADT+1,0        TEST MONTH PRESENT                           
         BNE   BLH20               YES- THEN IT'S A DATE                        
* GET THE ACTIVE DAY NUMBERS IN DUB                                             
         LLC   R0,NPTHIADT+2                                                    
         SLL   R0,25               GET MON BIT ALL THE WAY LEFT                 
         XC    DUB,DUB                                                          
         LA    R1,DUB                                                           
         LA    R5,1                                                             
*                                                                               
BLH6     LTR   R0,R0               R0 NEG IF DAY BIT IS ON                      
         BZ    BLH8                                                             
         BP    *+12                                                             
         STC   R5,0(R1)            SAVE DAY NUMBER                              
         LA    R1,1(R1)            NEXT LIST ENTRY                              
*                                                                               
         LA    R5,1(R5)            NEXT DAY NUMBER                              
         SLL   R0,1                                                             
         B     BLH6                                                             
*                                                                               
BLH8     LA    R7,DUB              POINT TO FIRST DAY ENTRY                     
*                                                                               
BLH10    GOTO1 GETDAY,DMCB,PARAS,WORK+12    GET PAT START DAY NUM               
*                                                                               
         LLC   R5,0(R7)            GET FIRST HIATUS DAY NUM                     
         LLC   R0,DMCB             GET PATTERN START DAY NUM                    
         SR    R5,R0               DAYS TO ADVANCE                              
         BP    *+8                                                              
         LA    R5,7(R5)                                                         
         GOTO1 ADDAY,DMCB,PARAS,WORK+6,(R5)                                     
*                                                                               
BLH12    CLC   WORK+6(6),PARAS+6   TEST PASSED PAT END                          
         BH    BLH18                                                            
*                                                                               
         L     R4,AIO3                                                          
BLH14    CLC   WORK+6(6),0(R4)     MATCH DATE                                   
         BE    BLH16                                                            
         BH    *+6                                                              
         DC    H'0'                                                             
         LA    R4,8(R4)                                                         
         B     BLH14                                                            
*                                                                               
BLH16    MVC   6(2,R4),=C'HH'      SET HIATUS FLAG                              
*                                                                               
         MVC   WORK(6),WORK+6      MOVE DATE JUST PROCESSED                     
         GOTO1 ADDAY,DMCB,WORK,WORK+6,7                                         
         B     BLH12                                                            
*                                                                               
BLH18    LA    R7,1(R7)            NEXT DAY                                     
         CLI   0(R7),0                                                          
         BNE   BLH10                                                            
         B     BLH40                                                            
         DROP  R6                                                               
         EJECT                                                                  
*================================================================               
* PROCESS LIST OF HIATUS DATES                                                  
*================================================================               
                                                                                
         USING NPTHIAEL,R6                                                      
         FIXDT02                                                                
BLH20    GOTO1 DATCON,DMCB,(3,NPTHIADT),(2,WORK)  GET 2-BYTE DT                 
         GOTO1 DATCON,DMCB,,WORK+6                AND 6-BYTE                    
*                                                                               
         CLC   WORK(2),PATPSTR     TEST DATE IN PAT PERIOD                      
         BL    BLH26                                                            
         CLC   WORK(2),PATPEND                                                  
         BH    BLH26                                                            
*                                                                               
         L     R4,AIO3                                                          
BLH22    CLC   WORK+6(6),0(R4)     MATCH DATE                                   
         BE    BLH24                                                            
         BH    *+6                                                              
         DC    H'0'                                                             
         LA    R4,8(R4)                                                         
         B     BLH22                                                            
*                                                                               
BLH24    MVC   6(2,R4),=C'HH'      SET HIATUS FLAG                              
*                                                                               
BLH26    BRAS  RE,NEXTEL                                                        
         BE    BLH20                                                            
*                                                                               
         DROP  R6                                                               
         EJECT                                                                  
*================================================================               
* NOW BUILD THE PATTERN ENTRIES FROM THE DATE TABLE                             
*================================================================               
                                                                                
BLH40    MVC   WORK(L'PATENT),0(R2)   SAVE PATTERN ENTRY                        
*                                                                               
         L     R4,AIO3                                                          
         LR    R0,R4               SAVE START DATE                              
*                                                                               
BLH42    CLC   6(2,R4),14(R4)      SAME PATTERN NEXT DATE?                      
         BNE   BLH44                                                            
         LA    R4,8(R4)                                                         
         B     BLH42                                                            
*                                                                               
         FIXDT02                                                                
BLH44    GOTO1 DATCON,DMCB,(R0),(2,PATPSTR)                                     
         FIXDT02                                                                
         GOTO1 (RF),(R1),(R4),(2,PATPEND)                                       
         MVC   PATSTR(4),PATPSTR   SET AS UNIT DATES TOO                        
*                                                                               
         CLC   6(2,R4),=C'HH'      TEST HIATUS                                  
         BNE   *+10                                                             
         MVC   PATSEQNO,=C'HIA'    HIGH SEQNUM WILL NEVER BE VALID              
*                                                                               
         LA    R4,8(R4)            NEXT DATE                                    
         CLI   0(R4),0             TEST REACHED END                             
         BE    BLHX                                                             
         LA    R2,L'PATENT(R2)     NEXT PATTERN TABLE ENTRY                     
         MVC   0(L'PATENT,R2),WORK  MOVE PATTERN                                
         LH    RE,NXPATSEQ                                                      
         LA    RE,1(RE)                                                         
         STH   RE,NXPATSEQ                                                      
         STC   RE,PATSEQ           UPDATE RELATIVE PATTERN SEQNUM               
         LR    R0,R4               SAVE NEW START DATE                          
         B     BLH42                                                            
*                                                                               
BLHX     LA    R2,L'PATENT(R2)         NEXT PATTERN LIST ENTRY                  
         STCM  R2,7,NEXTADDR+1         STORE FOR CALLER                         
         J     EXIT                                                             
         DROP  R2                                                               
         EJECT                                                                  
*================================================================               
* SEE IF NETWORK IN KEY+6 IS DELETED IN A 5B PATTERN LIST ELEM                  
*================================================================               
                                                                                
CKPATLST NTR1  BASE=*,LABEL=*                                                   
         L     R6,AIO                                                           
         MVI   ELCODE,X'5B'                                                     
         BRAS  RE,GETEL                                                         
         B     *+8                                                              
*                                                                               
CKPAT2   BRAS  RE,NEXTEL                                                        
         JNE   NEQXIT                                                           
*                                                                               
         CLC   NPTXNET-NPTXKEY+KEY(4),2(R6)   RIGHT NETWORK ELEM                
         BNE   CKPAT2                                                           
*                                                                               
         TM    6(R6),X'80'         TEST NETWORK DELETED                         
         JO    NEQXIT                                                           
         J     EQXIT                                                            
         LTORG                                                                  
         EJECT                                                                  
*================================================================               
* FIND BEST PATTERN ENTRY FOR EACH ENTRY IN UNIT TABLE                          
* AND SORT PATTERN TABLE TO DATE SEQUENCE                                       
*================================================================               
                                                                                
BLSORT   NTR1  BASE=*,LABEL=*                                                   
         NI    ANYFLAG,X'FF'-SKIPNET    INIT SKIP THIS NETWORK                  
*                                                                               
         L     R2,APATABLE                                                      
         USING PATABLED,R2                                                      
         SR    R0,R0                                                            
                                                                                
BLS10    CLI   0(R2),0             COUNT PATTERN TABLE ENTRIES                  
         BE    *+12                                                             
         LA    R2,PATNEXT                                                       
         BCT   R0,BLS10                                                         
*                                                                               
         LPR   R0,R0                                                            
         BNZ   BLS16                                                            
                                                                                
         TM    SVOPTSW,OPTNOPAT    NO PATTERN OPTION ENTERED                    
         BZ    PATERR              NO, NO PATTERN ERROR                         
                                                                                
         CLI   OFFLINE,C'Y'                                                     
         BE    *+12                                                             
         OI    ANYFLAG,SKIPNET     SKIP THIS NETWORK                            
         B     BLS50               AND EXIT                                     
                                                                                
         TM    WHEN,X'10'                                                       
         BO    BLS13                                                            
         TM    SVOPTSW1,OPTHDCPY                                                
         BO    BLS13                                                            
         CLI   SVTWPR06,C'N'                                                    
         BNE   BLS16                                                            
                                                                                
BLS13    L     R4,APRGTAB                                                       
*                                                                               
BLS14    LA    R1,XTYPE3                                                        
         BRAS  RE,XPUT                                                          
*                                                                               
         LA    R4,PRGNEXT-PRGENT(R4)                                            
         CLI   0(R4),0                                                          
         BE    BLS15                                                            
         C     R4,MXPRGTAB                                                      
         BL    BLS14                                                            
*                                                                               
BLS15    OI    ANYFLAG,SKIPNET     SKIP THIS NETWORK                            
         B     BLSX                                                             
         EJECT                                                                  
*==============================================================                 
* SORT PATTERN TABLE                                                            
*==============================================================                 
                                                                                
BLS16    L     R2,APATABLE                                                      
* SORT ON START TIME                                                            
         GOTO1 QSORT,DMCB,(R2),(R0),L'PATENT,L'PATSTIM,PATSTIM-PATENT           
* SORT ON TYPE/PRDS ...                                                         
         GOTO1 XSORT,DMCB,(R2),(R0),L'PATENT,L'PATSORT,0                        
*                                                                               
         BRAS  RE,FIXTIMES         SORT 1-DAY PTTNS AND SET FLAGS               
*                                                                               
         L     R5,AUNTABLE                                                      
         USING UNTABLED,R5                                                      
*                                                                               
BLS20    L     R2,APATABLE         START OF PATTERN TABLE                       
         SR    R6,R6               CLEAR PATTERN POINTER                        
*                                                                               
         CLI   CONREC,C'C'         TEST CABLE GEN                               
         BNE   BLS22                                                            
         TM    UNTFLG2,UNTFUNSD    TEST UNSEEDED                                
         BZ    BLS20B              NO                                           
         SR    R2,R2               SET NO PATTERN FOUND                         
         B     BLS42               AND GO ADD TBA PATTERN                       
*                                                                               
BLS20B   OC    UNTSEQNO,UNTSEQNO   HAVE PATTERN SEQNUM                          
         BZ    BLS22               NO - FIND A PATTERN                          
                                                                                
* FIND THE PATTERN ENTRY                                                        
                                                                                
BLS21C   CLC   PATSEQNO,UNTSEQNO                                                
         BE    BLS21G                                                           
         LA    R2,PATNEXT                                                       
         CLI   0(R2),0                                                          
         BNE   BLS21C                                                           
                                                                                
         OI    UNTFLG2,UNTFUNSD    SET UNSEEDED FLAG                            
         CLI   SVTN2PRO+10,C'Y'                                                 
         BE    BLS21E                                                           
         SR    R2,R2                                                            
         B     BLS42               AND TREAT AS UNSEEDED                        
BLS21E   L     R2,APATABLE         START OF PATTERN TABLE                       
         B     BLS22               AND TREAT AS UNSEEDED                        
*                                                                               
BLS21G   LR    R6,R2               POINT R6 TO ENTRY                            
         B     BLS41                                                            
*                                                                               
BLS22    DS    0H                                                               
         TM    PATFLG2,PATXXXX     TEST DO NOT USE                              
         BO    BLS40                                                            
*                                                                               
         OC    UNTFEED,UNTFEED     THIS A FEED UNIT                             
         BZ    BLS24                NO                                          
         CLC   =X'00FFE3',UNTFEED  CHK FOR TAG                                  
         BE    BLS24               ITS A TAG NOT A FEED                         
*                                                                               
         CLI   PATYPE,PATQFEED     THIS A FEED OR FEED/DP PATTN                 
         BH    BLS40                                                            
         CLC   PATFEED,UNTFEED                                                  
         BNE   BLS40                                                            
*                                                                               
         CLI   PATDP,0             DAYPART CODE ALSO                            
         BE    BLS30                NO                                          
         CLC   PATDP,UNTDP                                                      
         BE    BLS30                                                            
         B     BLS40                                                            
*                                                                               
BLS24    OC    PATFEED,PATFEED     THIS A FEED PATTERN                          
         BNZ   BLS40                YES                                         
         CLI   PATDP,0                                                          
         BE    BLS30                                                            
         CLC   PATDP,UNTDP                                                      
         BNE   BLS40                                                            
                                                                                
*=============================================================                  
* FIND LEAST USED PATTERN ENTRY FOR THIS UNIT                                   
*=============================================================                  
                                                                                
BLS30    CLC   UNTPROD(8),PATPRD     PATTERN FOR RIGHT PRDS                     
         BNE   BLS40                 NO - NEXT PATTERN                          
         CLI   PATPROG,C' '          TEST PROGRAM SPECIFIC PATTERN              
         BNH   *+14                                                             
         CLC   PATPROG,UNTPROG     ELSE MATCH PROGRAM                           
         BNE   BLS40                                                            
*                                                                               
         CLC   UNTLODTE,PATPEND    UNIT START DATE AFTER PATTERN END            
         BH    BLS40                                                            
         CLC   UNTHIDTE,PATPSTR    UNIT END BEFORE PATTERN START                
         BL    BLS40                                                            
*                                                                               
         OC    PATSTIM,PATSTIM      TEST PATTERN HAS TIME                       
         BZ    BLS36                NO - USE IT                                 
*                                                                               
         CLC   UNTLODTE,UNTHIDTE     TEST ONE DAY UNIT                          
         BNE   BLS36                 NO - USE IT                                
*                                                                               
* IT'S A ONE DAY UNIT                                                           
*                                                                               
         MVC   MYPSTIM(4),PATSTIM  MOVE PATTERN TIMES                           
         CLC   MYPSTIM,=H'2400'                                                 
         BNE   *+10                                                             
         XC    MYPSTIM,MYPSTIM                                                  
*                                                                               
         CLC   MYPSTIM,=H'600'     TEST PAT STARTS AFTER 6A                     
         BL    BLS31A                                                           
         LH    RE,MYPETIM                                                       
         CLC   MYPETIM,=H'600'     AND PAT ENDS BEFORE 6A                       
         BH    *+8                                                              
         LA    RE,2400(RE)                                                      
         STH   RE,MYPETIM                                                       
*                                                                               
BLS31A   MVC   MYUSTIM(4),UNTTIME  MOVE UNIT TIMES                              
         CLC   MYPSTIM,=H'600'     TEST PAT STARTS AFTER 6A                     
         BL    BLS31B                                                           
*                                                                               
         LH    RE,MYUSTIM                                                       
         CLC   MYUSTIM,=H'600'     TEST UNIT STARTS AFTER 6A                    
*MN      BH    *+8                                                              
         BNL   *+8                                                              
         LA    RE,2400(RE)                                                      
         STH   RE,MYUSTIM                                                       
*                                                                               
         LH    RE,MYUETIM                                                       
         CLC   MYUETIM,=H'600'                                                  
         BH    *+8                                                              
         LA    RE,2400(RE)                                                      
         STH   RE,MYUETIM                                                       
*                                                                               
BLS31B   CLC   UNTLODTE,PATPSTR      UNIT DATE MATCH PATT START                 
         BNE   BLS32                                                            
         CLC   PATDATES(2),PATDATES+2    TEST ONE DAY PATTERN                   
         BNE   BLS36                     NO - USE IT                            
* ONE DAY UNIT AND ONE DAY PATTERN                                              
         CLC   MYUSTIM,MYPETIM       UNIT START TIME AFTER PATT END             
         BH    BLS40                 YES - SKIP                                 
         CLC   MYUETIM,MYPSTIM       UNIT END TIME BEFORE PATT START            
         BL    BLS40                                                            
         B     BLS36                 USE THIS PATTERN                           
*                                                                               
* ONE DAY UNIT NOT ON PATTERN START DATE                                        
*                                                                               
BLS32    CLC   UNTLODTE,PATPEND      UNIT DATE MATCH PATTERN END                
         BL    BLS36                 BEFORE END DATE - USE IT                   
         CLC   PATPSTR,PATPEND       TEST ONE DAY PATTERN                       
         BNE   BLS36                 NO - USE IT                                
         CLC   MYUSTIM,MYPETIM       UNIT START TIME AFTER PATT END             
         BH    BLS40                 YES - SKIP                                 
         CLC   MYUETIM,MYPSTIM       UNIT END TIME BEFORE PATT START            
         BL    BLS40                                                            
*                                                                               
BLS36    MVC   FULL(2),UNTLODTE    MOVE UNIT START/END                          
         MVC   FULL+2(2),UNTHIDTE                                               
*                                                                               
         CLC   FULL(2),PATPSTR     UNIT START BEFORE PATTERN START              
         BNL   *+10                NO                                           
         MVC   FULL(2),PATPSTR     YES - SAVE PATTERN START                     
*                                                                               
         CLC   FULL+2(2),PATPEND   UNIT END BEFORE PATTERN END                  
         BL    *+10                NO                                           
         MVC   FULL+2(2),PATPEND   YES - SAVE PATTERN END                       
*                                                                               
         LR    R6,R2               SAVE ENTRY WITH LOWEST COUNT                 
         B     BLS41                                                            
*                                                                               
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,FULL),WORK                                        
         FIXDT02                                                                
         GOTO1 (RF),(R1),(2,FULL+2),WORK+6                                      
         GOTO1 PERVERT,DMCB,WORK,WORK+6                                         
         LH    R0,DMCB+8                                                        
         STC   R0,PATCOVER         AND SAVE IT                                  
*                                                                               
         LTR   R6,R6               TEST FOUND AN ENTRY YET                      
         BNZ   *+6                 YES                                          
         LR    R6,R2               SAVE PATTERN TABLE ENTRY ADDRESS             
*                                                                               
         CLC   PATYPE,PATYPE-PATENT(R6) TEST SAME LEVEL PATTERNS                
         BNE   BLS37                    NO                                      
*                                                                               
         LLC   RE,PATCNT                GET NEW USE COUNT                       
         LA    RF,1000                                                          
         MR    RE,RE                    SCALE UP                                
         LLC   R0,PATCOVER              GET NEW DAY COUNT                       
         DR    RE,R0                    CALCULATE COUNT/DAYS                    
         ST    RF,DUB                   AND SAVE IT                             
*                                                                               
         LLC   RE,PATCNT-PATENT(R6)     GET OLD USE COUNT                       
         LA    RF,1000                  SCALE UP                                
         MR    RE,RE                                                            
         LLC   R0,PATCOVER-PATENT(R6)   GET OLD DAY COUNT                       
         DR    RE,R0                                                            
*                                                                               
         C     RF,DUB                   COMPARE RATIOS                          
         BH    BLS38                    OLD HIGHER - USE NEW                    
         BL    BLS40                    OLD LOWER - SKIP IT                     
         LH    R0,DMCB+8                EQUAL - RESTORE R0 AND GO ON            
*                                                                               
BLS37    LTR   R6,R6                 TEST FOUND AN ENTRY YET                    
         BNZ   *+6                   YES                                        
         LR    R6,R2                 SAVE PATTERN TABLE ENTRY ADDRESS           
*                                                                               
         CLC   PATYPE,PATYPE-PATENT(R6)   COMPARE PATTERN TYPES                 
         BH    BLS40                      HI IS LESS SPECIFIC - SKIP            
         BL    BLS38                      LO IS MORE SPECIFIC - USE IT          
*                                                                               
         CLC   PATCOVER,PATCOVER-PATENT(R6)  NEW PATT COVER MORE DAYS?          
         BL    BLS40                    NO SKIP IT                              
         BH    BLS38                    IF HIGH - USE IT                        
*                                                                               
         CLC   PATCNT,PATCNT-PATENT(R6)   COMPARE COUNTERS                      
         BH    BLS40                                                            
         BL    BLS38                                                            
* IF EQUAL USAGE, USE EARLIER START DATE                                        
         CLC   PATPSTR,PATPSTR-PATENT(R6) IS NEW STDATE BEFORE OLD?             
         BH    BLS40                      NO - KEEP OLD                         
         BL    BLS38                                                            
* IF SAME START DATE, USE EARLIER START TIME                                    
         CLC   PATSTIM,PATSTIM-PATENT(R6) IS NEW STTIME BEFORE OLD?             
         BH    BLS40                                                            
*                                                                               
BLS38    LR    R6,R2               SAVE ENTRY WITH LOWEST COUNT                 
*                                                                               
BLS40    LA    R2,PATNEXT                                                       
         CLI   0(R2),0                                                          
         BNE   BLS22                                                            
*                                                                               
BLS41    LTR   R2,R6               TEST FOUND ANY ENTRY                         
         BZ    BLS42               NO                                           
         LLC   RE,PATCNT                                                        
         LA    RE,1(RE)                                                         
         STC   RE,PATCNT                                                        
         MVC   UNTSEQ,PATSEQ       MOVE PATTERN SEQNUM (POSN IN LIST)           
*                                                                               
         TM    PATFLG2,PATUSED                                                  
         BO    BLS41E                                                           
         MVC   PATSTR,UNTLODTE     SET UNIT START DATE                          
         MVC   PATEND,UNTHIDTE     AND UNIT END DATE                            
*                                                                               
BLS41E   CLC   PATSTR,UNTLODTE     USE LOWEST DATE                              
         BL    *+10                                                             
         MVC   PATSTR,UNTLODTE                                                  
*                                                                               
         CLC   PATEND,UNTHIDTE                                                  
         BH    *+10                                                             
         MVC   PATEND,UNTHIDTE                                                  
*                                                                               
         OC    PATSEQNO,PATSEQNO   TEST TBA                                     
         BNZ   *+16                                                             
         MVC   PATPSTR,PATSTR                                                   
         MVC   PATPEND,PATEND                                                   
         OI    PATFLG2,PATUSED     MARK PATTERN USED                            
*                                                                               
         TM    UNTFLG,UNTTAG                                                    
         BZ    *+8                                                              
         OI    PATFLG,PATTAG                                                    
         MVC   PATUNTCT,UNTCT                                                   
*                                                                               
BLS42    BAS   RE,ADDTBA           ADD UNITTAB TBA ENTRIES IF NEEDED            
         LTR   R2,R2               IF R2 IS ZERO THERE IS NO PATTERN            
         BZ    *+8                 TO CHECK OVERLAPPING AGAINST                 
         BAS   RE,CHKOV            CHECK OVERLAPPING                            
*                                                                               
BLS42X   TM    UNTFLG,UNTFLGSW     WERE PRDS SWAPPED                            
         BZ    BLS44                                                            
         XC    UNTPROD(4),UNTPROD2                                              
         XC    UNTPROD2(4),UNTPROD                                              
         XC    UNTPROD(4),UNTPROD2                                              
*                                                                               
BLS44    LA    R5,UNTNEXT                                                       
         CLI   UNTLODTE,0          END OF UNITS                                 
         BNE   BLS20                                                            
                                                                                
*===============================================================                
* NEED TO MAKE SURE THAT THERE ARE NO PATTERNS WITHOUT UNITS                    
* IF WE'RE DOING THE OPTION TO PRINT ALL PATTERNS                               
*===============================================================                
                                                                                
BLS50    CLI   SVTN2PRO+10,C'Y'    TEST TO PRINT ALL PATTERNS                   
         BNE   BLS60                                                            
*                                                                               
         L     R2,APATABLE                                                      
         USING PATABLED,R2                                                      
*                                                                               
BLS52    TM    PATFLG2,PATUSED     TEST USED                                    
         BO    BLS54                                                            
         TM    PATFLG2,PATXXXX     TEST DO NOT USE                              
         BO    BLS54                                                            
*                                                                               
         BRAS  RE,CHKOV                                                         
*                                                                               
         TM    PATFLG2,PATXXXX     IF IT GOT MARKED DO NOT USE                  
         BO    BLS54               NO NEED TO DO MORE                           
*                                                                               
         BRAS  RE,CHKSLN           TEST IF ANY PATS FOR THIS PRD/SLN            
         BE    BLS54                                                            
         OI    PATFLG2,PATXXXX     ELSE SET DO NOT USE                          
*                                                                               
BLS54    LA    R2,PATNEXT                                                       
         CLI   0(R2),0                                                          
         BNE   BLS52                                                            
*                                                                               
BLS60    L     R2,APATABLE                                                      
         SR    R0,R0                                                            
                                                                                
BLS62    CLI   0(R2),0             COUNT PATTERN TABLE ENTRIES                  
         BE    *+12                                                             
         LA    R2,PATNEXT                                                       
         BCT   R0,BLS62                                                         
*                                                                               
         LPR   R0,R0                                                            
         L     R2,APATABLE                                                      
* SORT ON PRDS                                                                  
         LA    R5,PATPRD-PATENT                                                 
         GOTO1 XSORT,DMCB,(R2),(R0),L'PATENT,L'PATPRD,(R5)                      
* SORT ON START/END DATES                                                       
         LA    R5,PATSTR-PATENT                                                 
         CLI   SVTN2PRO+10,C'Y'                                                 
         BNE   *+8                                                              
         LA    R5,PATPSTR-PATENT                                                
         GOTO1 (RF),(R1),(R2),(R0),L'PATENT,4,(R5)                              
BLSX     XIT1                                                                   
         DROP  R2                                                               
         EJECT                                                                  
PATERR   DS    0H                                                               
         TM    WHEN,X'20'          IS THIS SOON                                 
         BZ    PATERRX                                                          
         CLI   OFFLINE,C'Y'                                                     
         BNE   PATERRX                                                          
         TM    SVOPTSW,OPTTEST     TEST OPTION TEST                             
         BO    PATERRX                                                          
                                                                                
* UNLOCK FOR SOON UPDATES                                                       
                                                                                
         BRAS  RE,UNLK                                                          
                                                                                
PATERRX  MVC   GERROR,=Y(NPATFNET)                                              
         XC    ELEM,ELEM                                                        
         LA    R1,ELEM                                                          
         STCM  R1,7,GASUBST        A(SUBST TEXT)                                
         MVI   ELEM,5              L'SUBST TEXT + 1                             
         MVC   ELEM+1(4),SAVNET                                                 
*                                                                               
         LA    R2,TRANETH                                                       
         GOTO1 VTRAERR                                                          
         LTORG                                                                  
         EJECT                                                                  
*======================================================================         
* SO OK, THE ROUTINE IS CALLED ADDTBA. BUT THE NAME IS SLIGHTLY WRONG.          
* IT REALLY DOES THREE THINGS --                                                
*                                                                               
* 1. WHEN A PATTERN ENTRY COVERS PARTIAL UNIT DATES, IT ADDS                    
*    A NEW ENTRY TO THE UNIT TABLE FOR THE UNCOVERED DATES                      
*    THIS TABLE ENTRY THEN HAS A CHANCE TO FIND A DIFFERENT PATTERN             
*                                                                               
* 2. IF THERE IS NO PATTERN ENTRY FOUND, ADDS A TBA ENTRY TO THE                
*    PATTERN TABLE.                                                             
*======================================================================         
                                                                                
         USING UNTENT,R5                                                        
         USING PATABLED,R2                                                      
*                                                                               
ADDTBA   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LTR   R2,R2               TEST NO PATTERN FOUND                        
         BZ    ADDTBA20                                                         
                                                                                
*=================================================================              
* TEST PARTIAL DATES COVERED                                                    
*=================================================================              
*                                                                               
ADDTBA2  CLC   PATPSTR,PATSTR      PATTERN START TO UNIT START                  
         BNH   ADDTBA10            IF PRIOR-JUST USE UNIT START                 
                                                                                
* PATTERN START AFTER UNIT START                                                
* FIND LAST ENTRY IN UNIT TABLE                                                 
                                                                                
N        USING UNTABLED,R6                                                      
                                                                                
         LR    R6,R5                                                            
         LA    R6,N.UNTNEXT                                                     
         OC    N.UNTENT,N.UNTENT                                                
         BNZ   *-10                                                             
         C     R6,MAXUNTBL         AT END OF TABLE                              
         BL    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LH    RE,UNTABCT          BUMP UNIT COUNT                              
         LA    RE,1(RE)                                                         
         STH   RE,UNTABCT                                                       
*                                                                               
         MVC   N.UNTENT(19),UNTENT COPY PRD/SLN/PR2/SLN2/DP/FD/PRG              
         MVC   N.UNTTIME,UNTTIME   COPY TIME                                    
         MVC   N.UNTCT,UNTCT       COPY UNIT COUNT                              
         MVC   N.UNTACCST,UNTACCST   COPY UNIT COST                             
         MVC   N.UNTKEYCS,UNTKEYCS   COPY UNIT COST                             
         MVC   N.UNTDAY,UNTDAY       COPY DAY                                   
         MVC   N.UNTROT,UNTROT       COPY ROTATION                              
         TM    UNTFLG,UNTFLGSW     TEST PRDS SWAPPED                            
         BZ    ADDTBA4                                                          
         OI    N.UNTFLG,UNTFLGSW                                                
                                                                                
* NEW UNIT TABLE ENTRY GOES FROM UNIT START TO PATTERN START -1                 
                                                                                
ADDTBA4  MVC   N.UNTLODTE,UNTLODTE                                              
*                                                                               
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,PATPSTR),WORK                                     
         GOTO1 ADDAY,DMCB,WORK,WORK+6,F'-1'                                     
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,WORK+6,(2,N.UNTHIDTE)                                
* AND NOW UPDATE PATTERN TABLE SO UNIT STARTS ON PATTERN START DATE             
         MVC   PATSTR,PATPSTR                                                   
*                                                                               
ADDTBA10 CLC   PATPEND,PATEND      PATTERN END TO UNIT END                      
         BNL   ADDTBAX             IF AFTER, USE UNIT END                       
                                                                                
* CREATE A UNIT TABLE ENTRY FROM PATTERN END+1 TO UNIT END                      
* FIND LAST ENTRY IN UNIT TABLE                                                 
                                                                                
         LR    R6,R5                                                            
         LA    R6,N.UNTNEXT                                                     
         OC    N.UNTENT,N.UNTENT                                                
         BNZ   *-10                                                             
         C     R6,MAXUNTBL         AT END OF TABLE                              
         BL    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LH    RE,UNTABCT          BUMP UNIT COUNT                              
         LA    RE,1(RE)                                                         
         STH   RE,UNTABCT                                                       
*                                                                               
         MVC   N.UNTENT(19),UNTENT COPY PRD/SLN/PR2/SLN2/DP/FD/PRG              
         MVC   N.UNTTIME,UNTTIME   COPY TIME                                    
         MVC   N.UNTCT,UNTCT       COPY UNIT COUNT                              
         TM    UNTFLG,UNTFLGSW     TEST PRDS SWAPPED                            
         BZ    *+8                                                              
         OI    N.UNTFLG,UNTFLGSW                                                
         MVC   N.UNTACCST,UNTACCST   COPY UNIT COST                             
         MVC   N.UNTKEYCS,UNTKEYCS   COPY UNIT COST                             
         MVC   N.UNTDAY,UNTDAY       COPY DAY                                   
         MVC   N.UNTROT,UNTROT       COPY ROTATION                              
                                                                                
* NEW UNIT TABLE ENTRY GOES FROM PATTERN END+1 TO UNIT END                      
                                                                                
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,PATPEND),WORK                                     
         GOTO1 ADDAY,DMCB,WORK,WORK+6,F'1'                                      
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,WORK+6,(2,N.UNTLODTE)                                
         MVC   N.UNTHIDTE,PATEND                                                
* AND UPDATE PATTERN TABLE UNIT END DATE                                        
         MVC   PATEND,PATPEND                                                   
         B     ADDTBAX                                                          
         EJECT                                                                  
* CREATE A NEW PATTERN ENTRY FROM UNIT                                          
                                                                                
N        USING PATABLED,WORK                                                    
                                                                                
ADDTBA20 XC    WORK,WORK                                                        
*                                                                               
         MVI   N.PATYPE,PATQALL      SET TYPE                                   
         MVC   N.PATPRD(8),UNTPROD MOVE PRDS/LENS                               
         MVC   N.PATSTR,UNTLODTE                                                
         MVC   N.PATEND,UNTHIDTE                                                
*                                                                               
         MVC   N.PATPSTR,N.PATSTR                                               
         MVC   N.PATPEND,N.PATEND                                               
         OI    N.PATFLG2,PATUSED                                                
*                                                                               
         MVC   N.PATFEED,UNTFEED                                                
         OI    N.PATFLG2,PATTBA                                                 
         TM    UNTFLG,UNTTAG                                                    
         BZ    *+8                                                              
         OI    N.PATFLG,PATTAG                                                  
         MVC   N.PATUNTCT,UNTCT                                                 
         L     R2,APATABLE                                                      
*                                                                               
ADDTBA22 OC    PATENT,PATENT       TEST EOT                                     
         BZ    ADDTBA30                                                         
*                                                                               
         OC    PATSEQNO,PATSEQNO   TEST TBA ENTRY                               
         BNZ   ADDTBA26            NO                                           
*                                                                               
         CLC   PATENT(20),N.PATENT     MATCH PRDS/LENS                          
         BNE   ADDTBA26                                                         
                                                                                
* ONLY MERGE ENTRIES IF DATES ARE CONTIGUOUS                                    
* FIRST TRY UNIT END+1 TO PATTERN START                                         
                                                                                
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,UNTHIDTE),UNTWORK                                 
         LA    R0,1                                                             
         GOTO1 ADDAY,DMCB,UNTWORK,UNTWORK+6,(R0)                                
         GOTO1 DATCON,DMCB,UNTWORK+6,(3,UNTWORK+12)                             
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,PATSTR),(3,UNTWORK+15)                            
         CLC   UNTWORK+12(3),UNTWORK+15   UNIT END+1=PATTERN START              
         BE    ADDTBA24                                                         
                                                                                
* NOW TRY UNIT START-1 TO PATTERN END                                           
                                                                                
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,UNTLODTE),UNTWORK                                 
         LA    R0,1                                                             
         LNR   R0,R0                                                            
         GOTO1 ADDAY,DMCB,UNTWORK,UNTWORK+6,(R0)                                
         GOTO1 DATCON,DMCB,UNTWORK+6,(3,UNTWORK+12)                             
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,PATEND),(3,UNTWORK+15)                            
         CLC   UNTWORK+12(3),UNTWORK+15   UNIT START-1=PATTERN END              
         BNE   ADDTBA26                                                         
                                                                                
* ENTRIES MATCH WELL ENOUGH - UPDATE THIS ENTRY                                 
                                                                                
ADDTBA24 CLC   PATSTR,N.PATSTR                                                  
         BL    *+10                                                             
         MVC   PATSTR,N.PATSTR                                                  
*                                                                               
         CLC   PATEND,N.PATEND                                                  
         BH    *+10                                                             
         MVC   PATEND,N.PATEND                                                  
*                                                                               
         MVC   PATPSTR,PATSTR                                                   
         MVC   PATPEND,PATEND                                                   
         MVC   UNTSEQ,PATSEQ                                                    
         B     ADDTBAX                                                          
*                                                                               
ADDTBA26 LA    R2,PATNEXT                                                       
         B     ADDTBA22                                                         
*                                                                               
ADDTBA30 LH    RE,NXPATSEQ              ADD NEW ENTRY TO TABLE                  
         LA    RE,1(RE)                                                         
         STH   RE,NXPATSEQ                                                      
         STC   RE,N.PATSEQ                                                      
         STC   RE,UNTSEQ                SET IN UNIT TOO!                        
         MVC   0(L'PATENT,R2),N.PATENT  AND MOVE TO TABLE STUPIDO!              
*                                                                               
ADDTBAX  XIT1                                                                   
         DROP  N                                                                
         LTORG                                                                  
         EJECT                                                                  
*===================================================================            
* SEE IF THIS PATTERN OVERLAPS ANY MORE GENERAL ONE                             
* ON ENTRY R2 POINTS TO PATTERN ENTRY                                           
* NOTE THAT DAYPART, FEED, AND PROG SPECIFIC PATTERNS ARE IGNORED               
*===================================================================            
                                                                                
CHKOV    NTR1  BASE=*,LABEL=*                                                   
         CLI   PATYPE,PATQALL      TEST ALL NETWORK PATTERN                     
         BE    CHKOV1              YES                                          
         CLI   PATYPE,PATQNET      TEST NETWORK SPECIFIC PATTERN                
         BE    CHKOV1              YES                                          
         CLI   PATYPE,PATQMED      OR MEDIA                                     
         BNE   CHKOVX              YES - NO OVERLAP TESTS!                      
*                                                                               
CHKOV1   L     R4,APATABLE                                                      
         ST    R4,FULL             SAVE LAST ENTRY ADDRESS                      
*                                                                               
N        USING PATABLED,R4                                                      
*                                                                               
CHKOV2   CR    R2,R4               IS IT ME                                     
         BE    CHKOV16                                                          
         CLC   PATPRD(8),N.PATPRD  SAME PRODUCTS/LENGTHS                        
         BNE   CHKOV16                                                          
*                                                                               
CHKOV4   CLI   N.PATYPE,PATQALL    TEST ALL NETWORK                             
         BE    CHKOV4A                                                          
         CLI   N.PATYPE,PATQNET    TEST NETWORK SPECIFIC PATTERN                
         BE    CHKOV4A             YES                                          
         CLI   N.PATYPE,PATQMED    TEST MEDIA PATTERN                           
         BNE   CHKOV16             NO - NO OVERLAP TESTS!                       
*                                                                               
*      TEST PATTERN DATES OVERLAP                                               
CHKOV4A  DS    0H                                                               
         CLC   N.PATPSTR(4),PATPSTR                                             
         BNE   CHKOV6                                                           
                                                                                
CHKOV4D  DS    0H                                                               
         TM    N.PATFLG2,PATXXXX   IF ONE OVERLAPPING PATTERN HAS               
         BO    CHKOV16             ALREADY BEEN MARKED AS EXCLUDED              
         TM    PATFLG2,PATXXXX     DON'T MARK THE OTHER                         
         BO    CHKOV16                                                          
                                                                                
         CLC   PATDATES(2),PATDATES+2   TEST ONE-DAY PATTERN                    
         BNE   CHKOV4G                                                          
         CLC   N.PATDATES(2),N.PATDATES+2                                       
         BNE   CHKOV4G                                                          
         B     CHKOV6                                                           
                                                                                
CHKOV4G  DS    0H                                                               
         LA    RE,N.PATYPE                                                      
         CLC   N.PATYPE,PATYPE                                                  
         BH    *+8                                                              
         LA    RE,PATYPE                                                        
         OI    N.PATFLG2-N.PATENT(RE),PATXXXX SET DO NOT USE THIS PAT           
         B     CHKOV16                                                          
*                                                                               
CHKOV6   DS    0H                                                               
         CLC   N.PATPSTR,PATPEND   TEST NEW START TO CURRENT END                
         BH    CHKOV16                                                          
         BL    CHKOV8                                                           
* IF EQUAL CHECK FOR TIMES - IF BOTH PATTERNS HAVE TIMES, COMPARE               
         OC    N.PATSTIM,N.PATSTIM                                              
         BZ    CHKOV8                                                           
         OC    PATSTIM,PATSTIM                                                  
         BZ    CHKOV8                                                           
         CLC   N.PATSTIM,PATETIM   NEW ST TIME AFTER OLD END TIME               
         BH    CHKOV16             YES - NO OVERLAP                             
*                                                                               
CHKOV8   CLC   N.PATPEND,PATPSTR   TEST NEW END TO CURRENT START                
         BL    CHKOV16                                                          
         BH    CHKOV10                                                          
* IF EQUAL CHECK FOR TIMES - IF BOTH PATTERNS HAVE TIMES, COMPARE               
         OC    N.PATETIM,N.PATETIM                                              
         BZ    CHKOV10                                                          
         OC    PATETIM,PATETIM                                                  
         BZ    CHKOV10                                                          
         CLC   N.PATETIM,PATSTIM   NEW END TIME BEFORE OLD ST TIME              
         BL    CHKOV16             YES - NO OVERLAP                             
                                                                                
* PATTERNS DO OVERLAP                                                           
                                                                                
CHKOV10  DS    0H                                                               
         CLC   N.PATYPE,PATYPE          DETERMINE IF I HAVE SCENARIO            
         BL    CHKOV10C                 WHERE A MORE SPECIFIC PATTERN           
         BE    CHKOV10C                                                         
         CLC   N.PATPEND,PATPSTR        COMPLETELY COVERS A MORE                
         BL    CHKOV10C                 GENERAL PATTERN - IN THAT CASE          
         CLC   N.PATPSTR,PATPEND        NEED TO MARK ONE AS DO NOT USE          
         BH    CHKOV10C                 INSTEAD OF SPLITTING THEM               
         CLC   N.PATPSTR,PATPSTR                                                
         BL    CHKOV10C                                                         
         CLC   N.PATPEND,PATPEND                                                
         BH    CHKOV10C                                                         
         OI    N.PATFLG2,PATXXXX        SET DO NOT USE THIS PAT                 
         B     CHKOV16                                                          
*                                                                               
CHKOV10C CLC   N.PATYPE,PATYPE     WHEN SPLITTING THE PATTERNS MAKE             
         BH    CHKOV11             SURE I ALTER DATES ON A PATTERN              
         XC    DUB,DUB             THAT IS MORE GENERAL.                        
         STCM  R2,15,DUB           STORE THE POINTERS                           
         STCM  R4,15,DUB+4                                                      
         ICM   R2,15,DUB+4         SWAP THE POINTERS                            
         ICM   R4,15,DUB                                                        
                                                                                
CHKOV11  DS    0H                                                               
         MVC   HALF,N.PATPEND      SAVE PATTERN END DATE FROM NEW               
         CLC   N.PATPSTR,PATPSTR   TEST NEW START TO CURRENT START              
         BNL   CHKOV12                                                          
                                                                                
* CHANGE NEW END DATE                                                           
                                                                                
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,PATPSTR),WORK                                     
         GOTO1 ADDAY,(R1),WORK,WORK+6,F'-1'                                     
         FIXDT02                                                                
         GOTO1 DATCON,(R1),WORK+6,(2,N.PATPEND) END AT CUR START-1              
*                                                                               
         CLC   N.PATEND,N.PATPEND  UNIT END DT TO PATTERN END DATE              
         BL    *+10                                                             
         MVC   N.PATEND,N.PATPEND                                               
*                                                                               
CHKOV12  CLC   HALF,PATPEND        NEW UNIT END TO CURRENT PAT END              
         BNH   CHKOV15                                                          
         CLC   HALF,N.PATPEND      TEST WE CHAGNED END DATE ABOVE               
         BE    CHKOV14             NO                                           
                                                                                
* CREATE A NEW PATTERN TABLE ENTRY                                              
                                                                                
         LR    RE,R4                                                            
         LA    R4,N.PATNEXT                                                     
         CLI   0(R4),0                                                          
         BNE   *-8                                                              
         MVC   0(L'PATENT,R4),0(RE)                                             
         MVC   N.PATPEND,HALF      AND RESTORE THE END DATE                     
                                                                                
         CLC   UNTLODTE,N.PATEND                                                
         BH    CHKOV13                                                          
         CLC   UNTHIDTE,N.PATSTR                                                
         BL    CHKOV13                                                          
         B     CHKOV14                                                          
                                                                                
CHKOV13  DS    0H                                                               
         XC    N.PATUNTCT,N.PATUNTCT                                            
         XC    N.PATSEQ,N.PATSEQ                                                
                                                                                
* CHANGE NEW START DATE                                                         
                                                                                
         FIXDT02                                                                
CHKOV14  GOTO1 DATCON,DMCB,(2,PATPEND),WORK                                     
         GOTO1 ADDAY,(R1),WORK,WORK+6,F'1'                                      
         FIXDT02                                                                
         GOTO1 DATCON,(R1),WORK+6,(2,N.PATPSTR) START AT CUR END+1              
*                                                                               
         CLC   N.PATSTR,N.PATPSTR   UNIT START TO PATTERN START                 
         BH    *+10                                                             
         MVC   N.PATSTR,N.PATPSTR                                               
                                                                                
CHKOV15  DS    0H                                                               
         ICM   R2,15,DUB            RESTORE THE POINTER SWAP                    
         ICM   R4,15,DUB+4                                                      
                                                                                
CHKOV16  L     R4,FULL                                                          
         LA    R4,PATNEXT-PATENT(R4)                                            
         ST    R4,FULL                                                          
         CLI   0(R4),0                                                          
         BNE   CHKOV2                                                           
*                                                                               
CHKOVX   XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
*  EASYLINK GETS A PRINT LINE WITH SOME FIXED INFO, AND FAX NUMBER *            
                                                                                
EASILN   NMOD1 0,**EASIL*                                                       
                                                                                
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
                                                                                
         MVI   FORCEHED,C'N'       PREVENT HEADLINES                            
         MVI   LINE,2                                                           
         MVC   EDIORIG,AGYORIG                                                  
         MVC   EDIHDR,=CL5'*HDR*'                                               
                                                                                
         MVC   EDIDESID(4),=C'FAXW'                                             
                                                                                
EASI10   L     R1,SVFAXNXT         GET NEXT FAX NUMBER                          
         MVC   EDIDESID+5(L'SVSFAX),0(R1)  PRODUCTION HOUSE FAX NUMBER          
         MVC   EDIFDEST(L'SVSFAX),0(R1)                                         
                                                                                
         LA    R1,L'SVSFAX(R1)     BUMP TO NEXT FAX IN TABLE                    
         ST    R1,SVFAXNXT         SAVE NEXT FAX ADDRESS                        
                                                                                
EASI12   MVC   EDIBILL(1),QMED    MEDIA                                         
         MVC   EDIBILL+1(3),QCLT    CLIENT                                      
         MVC   EDIBILL+4(4),SAVNET                                              
                                                                                
         CLI   OPTPROD,0           TN2: BY PRODUCT?                             
         BE    EASI13               NO - CK BY PDT GP                           
         MVC   EDIBILL+4(3),OPTPROD                                             
         MVI   EDIBILL+7,C' '                                                   
         B     EASI15                                                           
                                                                                
EASI13   DS   0H                                                                
         OC    OPTPRGR,OPTPRGR     ANY PRODUCT GROUP                            
         BZ    EASI15               NO - BILL BY NET                            
         MVC   EDIBILL+4(4),QPGR                                                
                                                                                
EASI15   DS   0H                                                                
         OC    EDIDESID+5(L'SVSFAX),EDIDESID+5                                  
         BZ    NOFAXERR                                                         
                                                                                
         GOTO1 SPOOL,DMCB,(R8)    SEND SPECIAL PRINT LINE                       
                                                                                
         MVC   EDIDDSID(14),=C'++DDS NECRATRN'                                  
         MVC   EDINTCMD,QMED        MEDIA                                       
         MVC   EDINTCCL,QCLT        CLIENT                                      
         MVC   EDINTCNT,SAVNET                                                  
         MVC   EDINTCDT,PERDTS                                                  
                                                                                
         GOTO1 SPOOL,DMCB,(R8)    SEND SPECIAL PRINT LINE                       
                                                                                
EASIXIT  XIT1                                                                   
                                                                                
NOFAXERR DS    0H                                                               
         TM    WHEN,X'20'          IS THIS SOON                                 
         BZ    NOFAX10                                                          
                                                                                
         CLI   OFFLINE,C'Y'                                                     
         BNE   NOFAX10                                                          
                                                                                
         TM    SVOPTSW,OPTTEST     TEST OPTION TEST                             
         BO    NOFAX10                                                          
                                                                                
* UNLOCK FOR SOON UPDATES                                                       
                                                                                
         BRAS  RE,UNLK                                                          
                                                                                
NOFAX10  DS    0H                                                               
         TM    WHEN,X'10'          10 = OVERNIGHT RUN                           
         BO    NOFAX15                                                          
         CLI   SVOPTMED,0          THIS BY ALL = MEDIA                          
         BE    NOFAX20                                                          
                                                                                
NOFAX15  DS    0H                                                               
         MVC   MSGTEXT+44(8),AGYORIG                                            
         MVC   MSGTEXT+21(3),CONREC    PAT OR CAB                               
         MVC   MSGTEXT+58(8),TRAPID                                             
         MVC   MSGTEXT+72(3),TRACLT                                             
         MVC   MSGTEXT+81(4),SAVNET                                             
         MVC   MSGTEXT+91(8),TRAPER                                             
         OC    MSGTEXT,SPACES                                                   
                                                                                
         GOTO1 DATAMGR,DMCB,=C'OPMSG',(L'MSGTEXT,MSGTEXT)                       
                                                                                
         OI    FAXSTAT,FAXMISS                                                  
         B     EASIXIT                                                          
                                                                                
NOFAX20  DS    0H                                                               
         LA    R2,TRANETH                                                       
         MVC   GERROR,=Y(NOFAX)                                                 
         XC    ELEM,ELEM                                                        
         LA    R1,ELEM                                                          
         STCM  R1,7,GASUBST        A(SUBST TEXT)                                
         MVI   ELEM,13             L'SUBST TEXT+1                               
         MVC   ELEM+1(7),=C'NETWORK'                                            
         CLI   SVTWPR11,C'Y'       TRAFFIC RECS FOR FAX #                       
         BNE   *+10                                                             
         MVC   ELEM+1(7),=C'TRAFFIC'                                            
*                                                                               
         MVC   ELEM+9(4),SAVNET                                                 
         NI    TRANETH+4,X'FF'-X'20' SET OFF VALIDATED                          
         GOTO1 VTRAERR                                                          
                                                                                
                                                                                
MSGTEXT  DC    C'AUTONOTE*INT_NET: ***XXX/GEN FAX ERROR** ID=XXXXXXXX, X        
               PID=XXXXXXXX, CLI=XXX, NET=XXXX, PER=XXXXX/XX'                   
*SGTEXT  DC    C'AUTONOTE*MNAS: ******XXX/GEN FAX ERROR** ID=XXXXXXXX,          
*              PID=XXXXXXXX, CLI=XXX, NET=XXXX, PER=XXXXX/XX'                   
         EJECT                                                                  
                                                                                
* PRINT AGY COPY TO TSAROFF OFFLINE, TSAR ONLINE. FAX IS PRODUCED 1ST           
                                                                                
GOSPL    NMOD1 0,**GOSPL*                                                       
                                                                                
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
                                                                                
         TM    UPDSW,MULTIFAX      MULTI FAX                                    
         BO    *+12                                                             
         TM    WHEN,X'20'          IS THIS SOON                                 
         BO    GOSPL60              YES                                         
                                                                                
         CLI   OFFLINE,C'Y'                                                     
         BNE   GOSPL60                                                          
                                                                                
         TM    SVOPTSW1,OPTHDCPY   IF AGENCY COPY RUN                           
         BO    GOSPL60                                                          
         CLI   SVTWPR06,C'2'       AGY HARD COPY                                
         BE    *+20                                                             
         CLI   SVTWPR06,C'Y'       FAX                                          
         BNE   GOSPL60                                                          
         TM    UPDSW,MULTIFAX      MULTI FAX                                    
         BZ    GOSPL60                                                          
                                                                                
         LA    RE,P                                                             
         LA    RF,528                                                           
         LR    R1,RF                                                            
         L     R0,AIO1                                                          
         AHI   R0,1472                                                          
         LR    R3,R0                                                            
         MVCL  R0,RE                                                            
         LLC   R0,SPACING                                                       
                                                                                
* TSAROFF - WRITE TO HIGH STORAGE HERE                                          
                                                                                
         LHI   R2,TSARBLK-SYSD                                                  
         AR    R2,R9                                                            
         USING TSARD,R2                                                         
         LA    R4,4                                                             
         SR    R5,R5                                                            
                                                                                
* FIND ADDRESS OF LAST LINE TO PRINT                                            
                                                                                
         LR    R1,R4                                                            
         LA    R6,396(,R3)                                                      
GOSPL24  OC    0(132,R6),0(R6)                                                  
         BZ    GOSPL26                                                          
         CLC   0(132,R6),SPACES                                                 
         BNE   GOSPL30                                                          
GOSPL26  AHI   R6,-132                                                          
         BCT   R1,GOSPL24                                                       
                                                                                
GOSPL30  XC    ELEM(256),ELEM                                                   
                                                                                
         LA    RE,132              MAX PRINT POSITIONS                          
         LA    RF,131(,R3)         POINT TO END OF PRINT LINE                   
GOSPL34  CLI   0(RF),C' '                                                       
         BH    GOSPL40                                                          
         CLI   0(RF),0             FORCE LINE                                   
         BE    GOSPL40              YES                                         
         BCTR  RF,0                                                             
         BCT   RE,GOSPL34                                                       
                                                                                
         LA    R5,1(,R5)           ADD TO SKIPPED LINE CT                       
                                                                                
         OC    ELEM+4(2),ELEM+4    IS FORCE HEAD OR SPACING ON                  
         BNZ   GOSPL44              YES                                         
         B     GOSPL50             BYPASS EMPTY LINE                            
                                                                                
GOSPL40  LTR   RE,RE                                                            
         BZ    *+6                                                              
         BCTR  RE,0                                                             
         EX    RE,GOSPLMVC                                                      
                                                                                
         STC   R5,ELEM+4           SAVE ANY SKIPPED LINE CT                     
         SR    R5,R5               SET TO ZERO                                  
                                                                                
GOSPL44  LA    RE,7(,RE)                                                        
         STCM  RE,3,ELEM           REC LENGTH                                   
                                                                                
         A     RE,TSARBYTE                                                      
         ST    RE,TSARBYTE                                                      
                                                                                
         LH    R1,PRTCT                                                         
         LA    R1,1(,R1)                                                        
         STH   R1,PRTCT                                                         
         STCM  R1,3,ELEM+2         KEY                                          
         LA    R1,ELEM                                                          
         ST    R1,TSAREC                                                        
                                                                                
         CR    R3,R6               THIS LAST LINE TO PRINT                      
         BL    GOSPL46              NO                                          
         STC   R0,ELEM+5           SAVE SPACING                                 
                                                                                
GOSPL46  DS   0H                                                                
         MVI   TSOFFACT,TSAADD      SET TSAROFF ADD                             
         GOTO1 TSAROFF,(R2)                                                     
                                                                                
         CLI   TSERRS,0                                                         
         BE    GOSPL50                                                          
         DC    H'0'                                                             
                                                                                
GOSPL50  LA    R3,132(,R3)                                                      
         BCT   R4,GOSPL30                                                       
         DROP  R2                                                               
                                                                                
GOSPL60  DS   0H                                                                
         GOTO1 SPOOL,DMCB,(R8)                                                  
                                                                                
GOSPLX   XIT1                                                                   
GOSPLMVC MVC   ELEM+6(0),0(R3)                                                  
         LTORG                                                                  
         EJECT                                                                  
* PRINT MULTI-FAX RECORD FROM TSAROFF                                           
                                                                                
GTSPL    NMOD1 0,**GTSPL*                                                       
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
                                                                                
         SR    R0,R0                                                            
         ST    R0,SPECS            NO HEADING SPECS                             
         ST    R0,HEADHOOK            HDHK                                      
         ST    R0,FOOTHOOK            FTHK                                      
                                                                                
GTSPL02  BRAS  RE,EASILN                                                        
                                                                                
         OC    SVTS,SVTS           FAX TO TRAFFIC SUPPLIER                      
         BNZ   GTSPL04                                                          
                                                                                
         L     R5,SVFAXNXT                                                      
         OC    0(L'SVSFAX,R5),0(R5)                                             
         BNZ   *+12                                                             
         NI    UPDSW,X'FF'-MULTIFAX                                             
         B     GTSPL04                                                          
                                                                                
         LA    R1,SVSFAX                                                        
         LA    R1,4*L'SVSFAX(R1)   BUMP TO THE LAST ENTRY                       
         CR    R5,R1               ARE WE AT THE END                            
         BL    *+8                                                              
         NI    UPDSW,X'FF'-MULTIFAX                                             
                                                                                
GTSPL04  LHI   R2,TSARBLK-SYSD                                                  
         AR    R2,R9                                                            
         USING TSARD,R2                                                         
                                                                                
         XC    ELEM(256),ELEM                                                   
         LA    R0,ELEM                                                          
         ST    R0,TSAREC           SET ADDRESS OF THE RECORD                    
                                                                                
         LH    R1,TSRKEYF                                                       
         LA    R1,1(R1)                                                         
         STCM  R1,3,ELEM+2         KEY                                          
         SR    R5,R5               PAGE #                                       
                                                                                
         MVI   TSOFFACT,TSARDH      SET GET BY KEY                              
                                                                                
GTSPL10  GOTO1 TSAROFF,(R2)                                                     
                                                                                
GTSPL15  TM    TSERRS,X'90'        END OF FILE                                  
         BNZ   GTSPL40                                                          
         CLI   TSERRS,0                                                         
         BE    GTSPL20                                                          
         DC    H'0'                                                             
GTSPL20  DS   0H                                                                
         CLI   ELEM+4,C'Y'         IS THERE ANY FORCEHED                        
         BE    GTSPL28              YES                                         
         CLI   ELEM+4,0            IS THERE ANY SPACING BEFORE                  
         BE    GTSPL30              NO                                          
         MVC   SPACING,ELEM+4                                                   
         MVI   ELEM+4,0            SET OFF FOR LATER                            
         MVI   P1,0                                                             
                                                                                
         MVI   LINE,1                                                           
         GOTO1 SPOOL,DMCB,(R8)                                                  
         B     GTSPL30                                                          
                                                                                
GTSPL28  LA    R5,1(R5)            INCREMENT PAGE #                             
         CH    R5,=H'1'            FORCE /PAGE ON ALL PAGES BUT PAGE 1.         
         BNH   GTSPL30                                                          
         MVC   P1(5),=C'/PAGE'                                                  
         MVI   FORCEHED,C'Y'                                                    
         MVI   ELEM+4,0             RESET FOR LATER                             
         MVI   LINE,1               I MUST RESET LINE                           
         GOTO1 SPOOL,DMCB,(R8)                                                  
                                                                                
GTSPL30  SR    R1,R1                                                            
         ICM   R1,3,ELEM           RECORD LENGTH                                
         SH    R1,=H'7'                                                         
         EX    R1,GTSPMVC                                                       
         CLI   ELEM+4,0            IS THERE ANY FORCEHED                        
         BE    *+10                                                             
         MVC   FORCEHED,ELEM+4                                                  
                                                                                
         CLI   ELEM+5,0            IS THERE ANY SPACING                         
         BE    *+10                                                             
         MVC   SPACING,ELEM+5                                                   
                                                                                
* KILL IMFAMOUS AND SPURIOUS FAKE STUFF *                                       
                                                                                
         CLC   P1+7(17),=C'** AGENCY COPY **'                                   
         BNE   *+10                                                             
         MVC   P1+7(17),SPACES                                                  
                                                                                
         MVI   LINE,1                                                           
         GOTO1 SPOOL,DMCB,(R8)                                                  
                                                                                
         SR    R1,R1                                                            
         ICM   R1,3,ELEM+2                                                      
         CH    R1,TSRKEYL          CHECK FOR LAST PRT LINE                      
         BE    GTSPL40                                                          
                                                                                
GTSPL35  MVI   TSOFFACT,TSANXT            SET GET NEXT RECORD                   
         B     GTSPL10                                                          
                                                                                
GTSPL40  DS   0H                                                                
         MVI   P1,0                                                             
         MVC   P2(26),=C'*** END OF DDS MESSAGE ***'                            
         MVI   LINE,1                                                           
         GOTO1 SPOOL,DMCB,(R8)                                                  
                                                                                
         XIT1                                                                   
GTSPMVC  MVC   P1(0),ELEM+6                                                     
         DROP  R2                                                               
         EJECT                                                                  
***************************************************************                 
* SUBROUTINE VALIDATES PERIOD AND CALCULATES START/END DATES  *                 
***************************************************************                 
                                                                                
VPER     NMOD1 0,**VPER**                                                       
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
                                                                                
         LA    R2,TRAPERH          PERIOD                                       
         NI    ANYFLAG,X'FF'-TABLESW  RESET TABLE BUILT                         
         CLI   5(R2),0             ANY ENTRY                                    
         BE    MISSERRA            NO, ERROR                                    
                                                                                
         OC    NBUSERL,NBUSERL     CK IF NBUSERL ALREADY FILLED                 
         BNZ   VPER02                                                           
                                                                                
         XC    KEY,KEY             GET USER PROFILE INTO NBUSERL                
         MVC   KEY(4),=C'S0N0'                                                  
         MVC   KEY+4(2),AGENCY                                                  
         MVI   KEY+6,C'N'                                                       
         MVC   KEY+7(3),QCLT                                                    
         MVI   WORK+10,C'*'                                                     
         MVC   WORK+11(1),SVCLTOFF CLIENT OFFICE                                
                                                                                
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY                         
         BZ    VPER01                                                           
                                                                                
         TM    SECFLAG,NEPRDOFF    PRDS OFFICES NOT EQ                          
         BO    VPER01                                                           
                                                                                
         MVC   WORK+11(1),SVPRDOFF USE PROD OFFICE                              
                                                                                
VPER01   GOTO1 GETPROF,DMCB,KEY,NBUSERL,DATAMGR PUT PROFILE IN NBUSERL          
                                                                                
VPER02   LA    R4,TRAPER                                                        
         CLI   0(R4),C'?'          QUESTION MARK HELP                           
         BNE   VPER04                                                           
         LA    R4,1(,R4)                                                        
                                                                                
VPER04   GOTO1 DATVAL,DMCB,(0,0(R4)),STDATE                                     
         OC    DMCB(4),DMCB                                                     
         BZ    VPER06                                                           
         CLI   MYTN2PR6,C'W'       INSTR PERIOD = WEEKLY                        
         BNE   PERDATER                                                         
                                                                                
         GOTO1 GETDAY,(R1),(0,STDATE),WORK                                      
         CLI   0(R1),1             MUST BE MONDAY                               
         BNE   DAYDATER                                                         
         GOTO1 ADDAY,(R1),STDATE,ENDATE,F'6'                                    
         GOTO1 DATCON,(R1),(0,STDATE),(3,PERIOD)                                
                                                                                
         TM    SVFLAG,CONVSW       CONVERTED RECORDS?                           
         BZ    VPER30               NO                                          
         MVC   WORK(6),STDATE                                                   
         BRAS  RE,CONVPER                                                       
         MVC   PERIOD,WORK+6                                                    
         B     VPER30                                                           
                                                                                
VPER06   GOTO1 DATVAL,DMCB,(2,(R4)),STDATE                                      
         OC    DMCB(4),DMCB                                                     
         BZ    PERDATER                                                         
                                                                                
         CLI   MYTN2PR6,C'W'       INSTR PERIOD = WEEKLY                        
         BE    WKDATER                                                          
                                                                                
         GOTO1 DATCON,(R1),(0,STDATE),(3,PERIOD)                                
         CLI   MYTN2PR6,C'B'       TRAFFIC BROADCAST MONTH                      
         BE    VPER20                                                           
         CLI   MYTN2PR6,C'C'       TRAFFIC CALENDAR MONTH                       
         BE    VPER10                                                           
         CLI   NBUSERL+3,C'B'      BROADCAST MONTH                              
         BE    VPER20                                                           
         MVI   MYTN2PR6,C'C'       CALENDAR MONTH                               
                                                                                
* GET START AND END OF CALENDAR MONTH *                                         
                                                                                
VPER10   MVC   STDATE+4(2),=C'01'                                               
         GOTO1 ADDAY,(R1),STDATE,ENDATE,F'31'                                   
                                                                                
VPER14   GOTO1 (RF),(R1),ENDATE,ENDATE,F'-1'                                    
         CLC   STDATE(4),ENDATE                                                 
         BNE   VPER14                                                           
         B     VPER30                                                           
         EJECT                                                                  
* GET BROADCAST MONTH *                                                         
                                                                                
VPER20   DS    0H                                                               
         MVI   MYTN2PR6,C'B'       BROADCAST MONTH                              
         MVC   STDATE+4(2),=C'15'                                               
         MVC   WORK(6),STDATE                                                   
         GOTO1 VGTBROAD,DMCB,(1,WORK),STDATE,GETDAY,ADDAY                       
         FIXDT02                                                                
VPER30   GOTO1 DATCON,(R1),(0,STDATE),(2,STDATEP)                               
         MVC   WKDATEP,STDATEP                                                  
         FIXDT02                                                                
         GOTO1 (RF),(R1),(0,ENDATE),(2,ENDATEP)                                 
                                                                                
         CLI   TRAPER,C'?'         QUESTION MARK HELP                           
         BNE   VPERX                                                            
                                                                                
         XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(31),=CL31'PERIOD IS CALENDAR  MONTH FROM'                
         CLI   MYTN2PR6,C'W'       TRAFFIC WEEKLY PERIOD                        
         BE    VPER44                                                           
         CLI   MYTN2PR6,C'B'       TRAFFIC BROADCAST MONTH                      
         BE    VPER42                                                           
         CLI   MYTN2PR6,C'C'       TRAFFIC CALENDAR MONTH                       
         BE    VPER46                                                           
         CLI   NBUSERL+3,C'B'      BROADCAST MONTH                              
         BNE   VPER46                                                           
VPER42   MVC   CONHEAD+10(9),=CL9'BROADCAST'                                    
         B     VPER46                                                           
VPER44   MVC   CONHEAD+20(5),=CL5'WEEK'                                         
         FIXDT02                                                                
VPER46   GOTO1 DATCON,DMCB,(2,STDATEP),(5,CONHEAD+32)                           
         MVC   CONHEAD+41(2),=C'TO'                                             
         FIXDT02                                                                
         GOTO1 (RF),(R1),(2,ENDATEP),(5,CONHEAD+44)                             
         B     VPERERX                                                          
VPERX    OC    OPTDATE,OPTDATE     DOING PARTIAL PERIOD                         
         BZ    VPERX10                                                          
                                                                                
         CLC   OPTDATE,STDATEP                                                  
         BL    BADPARER                                                         
         CLC   OPTDATE,ENDATEP                                                  
         BH    BADPARER                                                         
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,OPTDATE),(0,STDATE)                               
         MVC   STDATEP,OPTDATE                                                  
                                                                                
VPERX10  GOTO1 DATCON,DMCB,(0,STDATE),(X'20',PSTDATE) PRINTABLE DATES           
         GOTO1 (RF),(R1),(0,ENDATE),(X'20',PENDATE)                             
         GOTO1 (RF),(R1),(0,STDATE),(3,STDATEB)                                 
         GOTO1 (RF),(R1),(0,ENDATE),(3,ENDATEB)                                 
         XIT1                                                                   
                                                                                
MISSERRA MVI   ERROR,MISSING                                                    
         GOTO1 ERREX                                                            
PERDATER MVC   GERROR,=Y(ONLYMMYY)                                              
         CLI   MYTN2PR6,C'W'       INSTR PERIOD = WEEKLY                        
         BE    WKDATER                                                          
         B     VPERERX                                                          
DAYDATER MVC   GERROR,=Y(MONSTDT)                                               
         XC    ELEM,ELEM                                                        
         LA    R1,ELEM                                                          
         STCM  R1,7,GASUBST        A(SUBST TEXT)                                
         MVI   ELEM,4              L'SUBST TEXT + 1                             
         MVC   ELEM+1(3),WORK                                                   
         B     VPERERX                                                          
BADPARER MVC   GERROR,=Y(BDPARPER)                                              
         B     VPERERX                                                          
WKDATER  MVC   GERROR,=Y(WKDTER)                                                
         B     VPERERX                                                          
VPERERX  GOTO1 VTRAERR                                                          
         LTORG                                                                  
         EJECT                                                                  
* VALIDATE OPTIONS                                                              
                                                                                
* VALID OPTIONS = 'TEST'      OPTTEST  (X80)                                    
*                                      (X40) ALLOW INSTR EVEN WITH ERR          
*                                      (X20)                                    
*                 'NEW'       OPTNEW   (X10) (ONLY STA WITH NO INST)            
*                                      (X08) UNASSIGNED UNITS = TBA             
*                                      (X04) UNALLOCATED UNITS = TBA            
*                                            FOR PROG WITH REVISION             
*                 'NOAGY'     OPTNAGY  (X02) BLANK AGENCY NAME/ADDR             
*                 'NOAOR'     OPTNOAOR (X01) BLANK AGY OF RECORD N&A            
                                                                                
VOPT     NMOD1 0,**VOPT**                                                       
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
                                                                                
         XC    OPTIONS,OPTIONS     ZERO OPTIONS NOW                             
*                                                                               
         LHI   RE,OPTPGRL-SYSD                                                  
         AR    RE,R9                                                            
         LA    RF,ENDPGTBL-OPTPGRL                                              
         XCEF                                                                   
*                                                                               
         MVI   SVOPTMED,0                                                       
                                                                                
         CLI   BYTE,1                                                           
         BE    VOPT00                                                           
                                                                                
         LA    R2,TRAFAXH                                                       
         CLI   5(R2),0             ANY ENTRY                                    
         BE    VFAX30                                                           
         CLI   8(R2),C'Y'                                                       
         BE    VFAX10                                                           
         CLI   8(R2),C'2'                                                       
         BNE   VFAX20                                                           
VFAX10   CLI   SVTWPR06,C'Y'       ALREADY SET TO Y                             
         BE    VFAX14                                                           
         CLI   SVTWPR06,C'2'       ALREADY SET TO 2                             
         BE    VFAX14                                                           
         CLI   SVTWPR06,C'N'       IF NO, NONE ALLOWED                          
         BNE   *+14                                                             
         MVC   GERROR,=Y(NOTWAUTH)                                              
         B     VOPTTRAP                                                         
*                                                                               
         CLI   SVTWPR06,0          IF NO PROFILE SET UP, NONE ALLOWED           
         BE    *-14                                                             
VFAX14   MVC   SVTWPR06(1),8(R2)                                                
         B     VFAX40                                                           
                                                                                
VFAX20   CLI   8(R2),C'C'                                                       
         BE    VFAX24                                                           
         CLI   8(R2),C'N'                                                       
         BE    VFAX26                                                           
         MVC   GERROR,=Y(BADFAX)                                                
         B     VOPTTRAP                                                         
*                                                                               
VFAX24   OI    SVOPTSW1,OPTHDCPY                                                
                                                                                
VFAX26   MVI   SVTWPR06,C'N'                                                    
         B     VFAX40                                                           
                                                                                
VFAX30   MVC   BYTE,SVTWPR06                                                    
         CLI   SVTWPR06,C'N'                                                    
         BE    VFAX34                                                           
         CLI   SVTWPR06,C'Y'                                                    
         BE    VFAX34                                                           
         CLI   SVTWPR06,C'2'                                                    
         BE    VFAX34                                                           
         MVI   BYTE,C'N'                                                        
VFAX34   CLC   8(1,R2),BYTE                                                     
         BE    VFAX40                                                           
         MVC   8(1,R2),BYTE                                                     
VFAX38   OI    6(R2),X'80'         FORCE TRANSMIT                               
         MVI   5(R2),1                                                          
                                                                                
VFAX40   OI    TRAFAXH+4,X'20'                                                  
         CLI   SVTWPR06,C'N'                                                    
         B     VOPT00              TEMP?                                        
         BE    VOPT00                                                           
         OI    GENSTAT1,MLTPQOK                                                 
                                                                                
VOPT00   DS   0H                                                                
         LA    R2,TRAOPTH                                                       
                                                                                
         CLI   5(R2),0             ANY ENTRY                                    
         BNE   VOPT05                                                           
                                                                                
         CLI   BYTE,1              ONLY GET MEDIA                               
         BNE   VOPT92               NO                                          
                                                                                
         OC    NETWORK,NETWORK     WAS REQUEST NETWORK SPECIFIC                 
         BZ    NOALLER             NO, MUST TELL US WHAT MEDIA                  
                                                                                
VOPT05   CLI   8(R2),C'?'          HELP                                         
         BE    VOPTHLP             YES                                          
                                                                                
         LA    R4,BLOCK+240        ADDRESS OF FIRST BLOCK                       
         GOTO1 SCANNER,DMCB,TRAOPTH,(7,(R4))                                    
         LLC   R3,DMCB+4           GET NUMBER OF BLOCKS                         
         LTR   R3,R3               SEE IF SCANNER FOUND ANYTHING                
         BZ    MISSERRB            NO                                           
VOPT10   LLC   R1,0(R4)            GET LENGTH                                   
         BCTR  R1,0                                                             
                                                                                
*                                                                               
* GET ADDRESS OF OPTION VALIDATION RTN                                          
         LA    RF,OPTTABLE                                                      
         EX    R1,VOPTCLC                                                       
         BE    VOPTGO                                                           
         LA    RF,L'OPTTABLE(RF)                                                
         CLI   0(RF),X'FF'                                                      
         BNE   *-16                                                             
         B     VOPTHLP                                                          
*                                                                               
VOPTCLC  CLC   12(0,R4),0(RF)                                                   
VOPTGO   L     RE,10(RF)                                                        
         A     RE,SPTR50RR                                                      
         BR    RE                                                               
         EJECT                                                                  
VOPTDTE  GOTO1 DATVAL,DMCB,(0,22(R4)),WORK  DO PARTIAL PERIOD                   
         OC    DMCB,DMCB                                                        
         BZ    INVDATER                                                         
                                                                                
         FIXDT02                                                                
         GOTO1 DATCON,(R1),(0,WORK),(2,OPTDATE)                                 
         B     VOPT90                                                           
                                                                                
* TEST RUN - DO NOT MARK FILES                                                  
                                                                                
VOPTTEST DS   0H                                                                
         L     R1,ATWA                                                          
         CLI   1(R1),C'*'          THIS A DDS TERMINAL                          
         BE    VOPTEST2             YES                                         
         LA    R2,TRAFAXH                                                       
         CLI   8(R2),C'N'                                                       
         BNE   TSTFAXER                                                         
         LA    R2,TRAOPTH                                                       
VOPTEST2 OI    SVOPTSW,OPTTEST     TEST                                         
         B     VOPT90                                                           
*                                                                               
VOPTTN2  MVC   SVOPTTN2,22(R4)     OVERRIDE TN2 PROF+10                         
         CLI   SVOPTTN2,C' '                                                    
         BNH   *+10                                                             
         MVC   SVTN2PRO+10(1),SVOPTTN2                                          
         B     VOPT90                                                           
                                                                                
VOPTTN1  MVC   SVOPTTN1,22(R4)     OVERRIDE TN2 PROF+10                         
         CLI   SVOPTTN1,C' '                                                    
         BNH   *+10                                                             
         MVC   SVTN1PR3,SVOPTTN1                                                
         B     VOPT90                                                           
                                                                                
*MNV                                                                            
VOPTDIGI DS    0H                                                               
         OI    SVOPTSW2,OPTDIGI    OVERRIDE SUPPRESS DIGITAL                    
         B     VOPT90                                                           
*MNV                                                                            
VOPTNEW  DS    0H                                                               
         OI    SVOPTSW,OPTNEW                                                   
         B     VOPT90                                                           
                                                                                
VOPTUNSD OI    SVOPTSW1,OPTUNSD                                                 
         B     VOPT90                                                           
                                                                                
* LIMIT TO 1 PRODUCT                                                            
                                                                                
VOPTPRD  DS   0H                                                                
         CLI   BYTE,1              JUST NEED MEDIA                              
         BE    VOPT90              YES, WILL VALIDATE PRD LATER                 
*                                                                               
         CLI   1(R4),4             TEST FOR PRD=UNAL                            
         BE    VOPTPRDU                                                         
*                                                                               
         CLI   SVTN2PRO+00,C'*'    TRAFFIC BY PRODUCT                           
         BNE   VOPTHLP                                                          
         CLC   =C'POL',22(R4)      IS PRD=POL                                   
         BE    INVPRER              YES, ERROR                                  
         CLC   =C'ALL',22(R4)      IS PRD=ALL                                   
         BE    INVPRER              YES, ERROR                                  
         CLI   1(R4),2             MIN 2 CHAR                                   
         BL    PRLENERR                                                         
         CLI   1(R4),3             MAX 3 CHAR                                   
         BH    PRLENERR                                                         
*                                                                               
         XC    FLDH,FLDH                                                        
         XC    FLD,FLD                                                          
         MVI   FLDH+5,3            DATA LEN                                     
         MVC   FLD(3),22(R4)       PROD                                         
         LA    R2,FLDH                                                          
         MVI   ERROPT,C'Y'         RETURN ON ERROR                              
         GOTO1 VALIPRD                                                          
         MVI   ERROPT,0                                                         
                                                                                
         CLI   ERROR,0             ANY ERRORS                                   
         BNE   INVPRER                                                          
                                                                                
         MVC   OPTPROD,WORK        PROD                                         
         MVC   SVPRDNAM,WORK+5                                                  
         B     VOPT90                                                           
         EJECT                                                                  
VOPTPTTN DS   0H                                                                
         CLI   OFFLINE,C'Y'                                                     
         BE    *+12                                                             
         CLI   TWAOFFC,C'*'        THIS A DDS TERM                              
         BNE   VOPTHLP                                                          
                                                                                
         OI    SVOPTSW,OPTPTTN     PRINT PATTERNS USED ON REPORT                
         B     VOPT90                                                           
*                                                                               
VOPTPRDU CLC   22(4,R4),=CL4'UNAL'                                              
         BNE   VOPTHLP                                                          
         OI    SVOPTSW,OPTUNAL                                                  
         B     VOPT90                                                           
         EJECT                                                                  
VOPTPGM  DS    0H                                                               
         CLI   CONREC,C'C'         TEST CABLE/GEN                               
         BNE   VOPTHLP                                                          
*                                                                               
         CLI   PROGRAM,C' '        TEST ALREADY ENTERED                         
         BH    VOPTHLP                                                          
*                                                                               
         CLI   TRANETH+5,3                                                      
         BNE   *+14                                                             
         CLC   =C'ALL',TRANET      CAN'T DO ONE PROG/ALL NETS                   
         BE    VOPTPGER                                                         
*                                                                               
         CLI   1(R4),1                                                          
         BL    VOPTHLP                                                          
         CLI   1(R4),6                                                          
         BH    VOPTHLP                                                          
*                                                                               
         MVC   PROGRAM,22(R4)      MOVE PROGRAM TO WORK                         
         CLC   =C'ALL ',PROGRAM                                                 
         BNE   *+10                                                             
         MVC   PROGRAM,SPACES                                                   
*                                                                               
         BRAS  RE,GETEQV           GO GET ANY EQUIVALENT PROGRAMS               
*                                                                               
         CLI   EQVPTBL,C' '        FIND ANY EQUIV PROGRAMS                      
         BNH   VOPT90              NO                                           
*                                                                               
         MVC   BASEPRG,PROGRAM                                                  
         MVC   BASEDTS,STDATEP                                                  
         MVI   BASECT,0                                                         
         B     VOPT90                                                           
*                                                                               
VOPTPGER MVC   GERROR,=Y(NOPGMALL)                                              
         B     VOPTTRAP                                                         
*                                                                               
                                                                                
* BYPASS NETWORKS THAT DO NOT HAVE PATTERNS                                     
                                                                                
VOPTNOPT DS   0H                                                                
         OI    SVOPTSW,OPTNOPAT                                                 
         B     VOPT90                                                           
                                                                                
VOPTPSRT DS   0H                                                                
         OI    SVOPTSW,OPTPSORT                                                 
         B     VOPT90                                                           
                                                                                
VOPTPGRP DS    0H                                                               
         CLI   BYTE,1              JUST NEED MEDIA                              
         BE    VOPT90              YES, WILL VALIDATE PGRP LATER                
                                                                                
         CLI   SVTN2PRO+00,C'A'    TRAFFIC BY PRODUCT GROUP                     
         BL    VOPTHLP                                                          
         CLI   SVTN2PRO+00,C'Z'    TRAFFIC BY PRODUCT GROUP                     
         BH    VOPTHLP                                                          
                                                                                
* VALIDATE PRODUCT GROUP *                                                      
                                                                                
         BAS   RE,VPGR                                                          
         B     VOPT90                                                           
                                                                                
VOPTNAGY OI    SVOPTSW,OPTNAGY     NOAGY - DON'T PRINT AGENCY N/A               
         B     VOPT90                                                           
                                                                                
VOPTEASY CLI   OFFLINE,C'Y'        AGY COPY BACKUP/ONLY VALID OFFLINE           
         BNE   VOPTHLP                                                          
         OI    SVOPTSW1,OPTHDCPY                                                
         B     VOPT90                                                           
                                                                                
VOPTNAOR OI    SVOPTSW,OPTNOAOR    NOAOR-DON'T PRT AGENCY OF REC N/A            
         B     VOPT90                                                           
                                                                                
VOPTSKED MVI   SVTNPR9,C'S'        SKED-ONLY USE TRAFFIC SKEDED UNITS           
         B     VOPT90                                                           
                                                                                
VOPTSEED OI    SVOPTSW2,OPTSEED                                                 
         B     VOPT90                                                           
                                                                                
VOPTMED  MVI   SVTNPR9,C'M'        MEDIA-ONLY USE MEDIA UNITS                   
         CLI   1(R4),0             SHOULD NOT BE A SECOND ENTRY                 
         BNE   MEDIAERR                                                         
         B     VOPT90                                                           
                                                                                
VOPTBOTH MVI   SVTNPR9,C'B'        BOTH-USE MEDIA & SKED UNITS                  
         CLI   1(R4),0             SHOULD NOT BE A SECOND ENTRY                 
         BNE   MEDIAERR                                                         
         B     VOPT90                                                           
                                                                                
VOPTALL  MVC   SVOPTMED,22(R4)     ALL = MEDIA C/N/O/S/D/H                      
                                                                                
         OC    NETWORK,NETWORK     WAS REQUEST NETWORK SPECIFIC                 
         BNZ   NETALLER                                                         
                                                                                
         MVI   SVOPTMD,1                                                        
         CLI   SVOPTMED,C'C'       CABLE                                        
         BE    VOPT90                                                           
                                                                                
         MVI   SVOPTMD,0                                                        
         CLI   SVOPTMED,C'N'       NETWORK                                      
         BE    VOPT90                                                           
                                                                                
         MVI   SVOPTMD,3                                                        
         CLI   SVOPTMED,C'O'       OTHER                                        
         BE    VOPT90                                                           
                                                                                
         MVI   SVOPTMD,3                                                        
         CLI   SVOPTMED,C'H'       HISPANIC                                     
         BE    VOPT90                                                           
                                                                                
         MVI   SVOPTMD,3                                                        
         CLI   SVOPTMED,C'D'       NETWORK RADIO                                
         BE    VOPT90                                                           
                                                                                
         MVI   SVOPTMD,2                                                        
         CLI   SVOPTMED,C'S'       SYNDICATION                                  
         BE    VOPT90                                                           
                                                                                
*MNV                                                                            
         MVI   SVOPTMD,3                                                        
         CLI   SVOPTMED,C'V'       DIGITAL IS CONSIDERED OTHER                  
         BE    VOPT90                                                           
*MNV                                                                            
         XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(L'MEDERRMS),MEDERRMS                                     
         B     VOPTERX2                                                         
                                                                                
NETALLER XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(L'NETALLMS),NETALLMS                                     
         B     VOPTERX2                                                         
                                                                                
VOPTCAL  MVI   MYTN2PR6,C'C'       CALENDAR - MONTHLY PERIOD                    
         OI    SVOPTSW1,OPTPER     PERIOD ENTERED IN OPTION FIELD               
         B     VOPT90                                                           
                                                                                
VOPTBRD  MVI   MYTN2PR6,C'B'       BROADCAST - MONTHLY PERIOD                   
         OI    SVOPTSW1,OPTPER     PERIOD ENTERED IN OPTION FIELD               
         B     VOPT90                                                           
                                                                                
VOPTWEEK MVI   MYTN2PR6,C'W'       INSTR PERIOD = WEEKLY                        
         OI    SVOPTSW1,OPTPER     PERIOD ENTERED IN OPTION FIELD               
         B     VOPT90                                                           
                                                                                
VOPTISCI DS    0H                                                               
         CLI   TWAOFFC,C'*'        ONLY DDS TERMINALS                           
         BNE   VOPTHLP                                                          
         MVI   SVTN2PRE,C'N'       PRINT CML ISCII NOT CLT CML #                
         B     VOPT90                                                           
                                                                                
VOPT90   LA    R4,32(,R4)          POINT TO NEXT BLOCK                          
         BCT   R3,VOPT10           FOR NUMBER OF BLOCKS FOUND                   
                                                                                
VOPT92   DS    0H                                                               
         CLI   OFFLINE,C'Y'        BYPASS FOR OFFLINE                           
         BE    VOPT93                                                           
                                                                                
         TM    SOXSW,SOXOKFLG      IF DDS, AND FACTEST, OKAY TO GO              
         BO    VOPT93                                                           
                                                                                
         TM    SOXSW,SOXERFLG      IF RD ONLY/RD ONLY MODE/WRONG ADV            
         BZ    VOPT93                                                           
                                                                                
         TM    SVOPTSW,OPTTEST     TEST                                         
         BO    VOPT93                                                           
                                                                                
         GOTO1 VSOXERR             FORCE OPTION TEST                            
                                                                                
VOPT93   DS   0H                                                                
         CLI   BYTE,1              LOOKING FOR MEDIA ONLY                       
         BE    VOPT96                                                           
         CLI   SVTN2PRO+00,0       ANY PROD OR PROD GROUP EXPECTED              
         BE    VOPT96               NO                                          
         CLI   SVTN2PRO+00,C'0'    ANY PROD OR PROD GROUP EXPECTED              
         BE    VOPT96               NO                                          
         CLI   SVTN2PRO+00,C'*'    EXPECTING PRODUCT                            
         BNE   VOPT94                                                           
         CLI   OPTPROD,0           ANY PROD ENTERED                             
         BNE   VOPT96                                                           
         MVC   GERROR,=Y(PRDREQD)                                               
         B     VOPTTRAP                                                         
*                                                                               
VOPT94   DS   0H                                                                
         OC    OPTPRGR,OPTPRGR     ANY PRODUCT GROUP                            
         BNZ   VOPT96                                                           
         MVC   GERROR,=Y(PGRPREQD)                                              
         B     VOPTTRAP                                                         
                                                                                
VOPT96   DS   0H                                                                
         CLI   BYTE,1              JUST NEEDED MEDIA                            
         BNE   VOPT97                                                           
                                                                                
         OC    NETWORK,NETWORK     WAS REQUEST NETWORK SPECIFIC                 
         BNZ   VOPTXX               YES, DONE                                   
                                                                                
         CLI   SVOPTMED,0          ANY MEDIA                                    
         BZ    NOALLER             NO, MUST TELL US WHAT MEDIA                  
         B     VOPTXX                                                           
                                                                                
VOPT97   TM    SVOPTSW,OPTTEST     IS THIS A TEST RUN?                          
         BZ    VOPT98                                                           
         CLI   SVTWPR06,C'N'       IF NO, NONE ALLOWED                          
         BE    VOPT98               NO FAX IF TEST                              
                                                                                
         NI    TRAOPTH+4,X'FF'-X'20'                                            
         LA    R2,TRAFAXH                                                       
         XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(32),=CL32'* USE FAX=NO WITH TEST REQUEST *'              
         B     VOPTERX2                                                         
                                                                                
VOPT98   DS   0H                                                                
         OC    NETWORK,NETWORK     WAS REQUEST NETWORK SPECIFIC                 
         BNZ   VOPT99                                                           
                                                                                
         CLI   OFFLINE,C'Y'        IF ALREADY OFFLINE, LET IT GO                
         BE    VOPT99                                                           
         CLI   TWAOFFC,C'*'        THIS A DDS TERM                              
         BE    VOPT99               ALSO OKAY                                   
                                                                                
         CLI   SVOPTMED,0          WAS AN ALL=X ENTERED                         
         BE    NOALLER                                                          
                                                                                
VOPT99   DS   0H                                                                
         OI    4(R2),X'20'         SET VALIDATED                                
                                                                                
VOPTX    DS    0H                                                               
         CLI   SVTN2PRO+00,0       ANY PROD OR PROD GROUP EXPECTED              
         BE    VOPTX20              NO                                          
         CLI   SVTN2PRO+00,C'0'    ANY PROD OR PROD GROUP EXPECTED              
         BE    VOPTX20              NO                                          
         CLI   SVTN2PRO+00,C'*'    EXPECTING PRODUCT                            
         BNE   VOPTX10                                                          
         CLI   OPTPROD,0           ANY PROD ENTERED                             
         BNZ   VOPTX20                                                          
         MVC   GERROR,=Y(PRDREQD)                                               
         B     VOPTTRAP                                                         
*                                                                               
VOPTX10  OC    OPTPRGR,OPTPRGR     RUNNING BY PROD GROUP?                       
         BNZ   VOPTX20                                                          
         MVC   GERROR,=Y(PGRPREQD)                                              
         B     VOPTTRAP                                                         
VOPTX20  DS    0H                                                               
                                                                                
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY                         
         BZ    VOPTXX                                                           
         CLI   OPTPROD,0           WAS PRODUCT OPTION ENTERED                   
         BZ    VOPTXX                                                           
         B     VOPTXX                                                           
* BYPASS CODE BELOW (VALIPRD TOOK CARE OF THIS)                                 
                                                                                
         LA    R0,NCLSTSIZ         FIND PROD                                    
         L     R1,ASVNCLST                                                      
                                                                                
VOPTX40  CLC   OPTPROD,0(R1)                                                    
         BE    VOPTXX                                                           
         LA    R1,4(R1)                                                         
         CLI   0(R1),C' '                                                       
         BNH   *+8                                                              
         BCT   R0,VOPTX40                                                       
                                                                                
         LA    R2,TRAOPTH                                                       
         MVI   ERROR,SECLOCK       SECURITY LOCK-OUT                            
         B     VOPTERX                                                          
                                                                                
VOPTXX   XIT1                                                                   
                                                                                
TSTFAXER XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(32),=CL32'* USE FAX=NO WITH TEST REQUEST *'              
         B     VOPTERX2                                                         
                                                                                
MEDIAERR XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(L'MEDIAMSG),MEDIAMSG                                     
*        MVC   CONHEAD+16(1),22(R4)                                             
*        MVC   CONHEAD+35(1),22(R4)                                             
         B     VOPTERX2                                                         
                                                                                
NOALLER  XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(L'NETMSG),NETMSG                                         
         B     VOPTERX2                                                         
*EDIAMS  DC    C'* ERROR * INVALID OPTION, USE ALL= TO SPECIFY MEDIA TY         
*              PE *'                                                            
MEDIAMSG DC    C'* ERROR * MEDIA= INVALID, USE ALL= FOR MEDIA TYPE *'           
         EJECT                                                                  
* VALIDATE PRODUCT GROUP *                                                      
                                                                                
VPGR     NTR1                                                                   
         GOTO1 VALIPGR                                                          
         MVC   OPTPRGR,SVPGRP                                                   
                                                                                
         MVC   QPGR,SPACES                                                      
         MVC   QPGR(1),SVTN2PRO+00                                              
         LLC   RF,PGRLEN                                                        
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   QPGR+1(0),22(R4)                                                 
                                                                                
         MVC   PGROUP(1),QPGR                                                   
         MVC   PGROUP+1(2),SVPGRP                                               
*                                                                               
                                                                                
* GET PRODUCT GROUP NAME *                                                      
                                                                                
VPGR20   MVC   SVKEY,KEY                 ON RETURN KEY HAS 0D81 KEY             
         NI    KEY+1,X'7F'                                                      
         XC    KEY+8(5),KEY+8                                                   
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   SVPRGNAM,2(R6)                                                   
                                                                                
         MVC   KEY,SVKEY                                                        
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         LA    R0,L'OPTPGRL/3                                                   
         LHI   R5,OPTPGRL-SYSD                                                  
         AR    R5,R9                                                            
                                                                                
VPGR30   DS    0H                                                               
         MVC   SVKEY,KEY           SAVE                                         
                                                                                
         XC    FLDH,FLDH                                                        
         XC    FLD,FLD                                                          
         MVI   FLDH+5,3                                                         
         MVC   FLD(3),KEY+8                                                     
                                                                                
         LA    R2,FLDH                                                          
         MVI   ERROPT,C'Y'                                                      
         MVI   ERROR,0                                                          
         GOTO1 VALIPRD                                                          
         MVI   ERROPT,0                                                         
                                                                                
         CLI   ERROR,0             ANY ERROR?                                   
         BNE   VPGR50               YES                                         
                                                                                
         MVC   0(3,R5),SVKEY+8                                                  
         LA    R5,3(R5)                                                         
                                                                                
VPGR50   MVC   KEY,SVKEY                                                        
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
         CLC   KEY(8),KEYSAVE                                                   
         BNE   VPGR70                                                           
         BCT   R0,VPGR30                                                        
         B     MAXPGER                                                          
                                                                                
VPGR70   BRAS  RE,INITNET          SET TO UNIT                                  
         B     VOPTX                                                            
                                                                                
MAXPGER  DS    0H                                                               
         LA    R2,TRAOPTH                                                       
         MVC   GERROR,=Y(MAXPGRP)                                               
         B     VOPTTRAP                                                         
PRLENERR MVC   GERROR,=Y(PRDLENER)                                              
         B     VOPTTRAP                                                         
                                                                                
VOPTTRAP GOTO1 VTRAERR                                                          
                                                                                
VOPTHLP  XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(L'OPTHLPMS),OPTHLPMS                                     
         CLI   SVTN2PRO+00,0       ANY PRD OR PRDGRP EXPECTED                   
         BE    VOPTERX2             NO                                          
         CLI   SVTN2PRO+00,C'0'    ANY PRD OR PRDGRP EXPECTED                   
         BE    VOPTERX2             NO                                          
         MVC   CONHEAD+L'OPTHLPMS-2(7),=CL7'/PRD= *'                            
         CLI   SVTN2PRO+00,C'*'    EXPECTING PRODUCT                            
         BE    VOPTERX2                                                         
         MVC   CONHEAD+L'OPTHLPMS-2+2(3),=C'GRP'                                
*                                                                               
                                                                                
VOPTERX2 GOTO1 ERREX2                                                           
                                                                                
INVPRER  MVI   ERROR,INVPROD                                                    
         B     VOPTERX                                                          
INVDATER MVI   ERROR,INVDATE                                                    
         B     VOPTERX                                                          
BDKYWDER MVI   ERROR,BADKEYWD      KEY WORDS USED IN BAD COMBINATION            
         B     VOPTERX                                                          
MISSERRB MVI   ERROR,MISSING                                                    
                                                                                
VOPTERX  GOTO1 ERREX                                                            
                                                                                
MEDERRMS DC    C'* ERROR * MEDIA=TYPE (C/N/O/S) *'                              
NETALLMS DC    C'* ERROR * NO ALL= FOR SPECIFIC NETWORK REQUEST *'              
NETMSG   DC    C'* ERROR * MISSING MEDIA EG. ALL=CABLE *'                       
OPTTABLE DS   0CL14                                                             
         DC    CL10'HELP      ',AL4(VOPTHLP)                                    
         DC    CL10'ALL       ',AL4(VOPTALL)   ALL=C/S/N/O                      
         DC    CL10'BOTH      ',AL4(VOPTBOTH)  BOTH MEDIA & SKED                
         DC    CL10'BROADCAST ',AL4(VOPTBRD)                                    
         DC    CL10'CALENDAR  ',AL4(VOPTCAL)                                    
         DC    CL10'DATE      ',AL4(VOPTDTE)                                    
         DC    CL10'ISCII     ',AL4(VOPTISCI)  PRINT ISCII - DDS ONLY           
         DC    CL10'MEDIA     ',AL4(VOPTMED)   USE ONLY MEDIA UNITS             
         DC    CL10'NEW       ',AL4(VOPTNEW)                                    
         DC    CL10'NOAGY     ',AL4(VOPTNAGY)                                   
         DC    CL10'NOAOR     ',AL4(VOPTNAOR)                                   
         DC    CL10'PATTERN   ',AL4(VOPTPTTN)                                   
         DC    CL10'NOPATTERN ',AL4(VOPTNOPT)  BYPASS NETWORKS W/O PAT          
         DC    CL10'PGRP      ',AL4(VOPTPGRP)                                   
         DC    CL10'PRD       ',AL4(VOPTPRD)                                    
         DC    CL10'PROD      ',AL4(VOPTPRD)                                    
         DC    CL10'PRG       ',AL4(VOPTPGM)                                    
         DC    CL10'PGM       ',AL4(VOPTPGM)                                    
         DC    CL10'PSORT     ',AL4(VOPTPSRT)  PRODUCT SORT                     
         DC    CL10'SEED      ',AL4(VOPTSEED)                                   
         DC    CL10'SKED      ',AL4(VOPTSKED)                                   
         DC    CL10'TEST      ',AL4(VOPTTEST)                                   
         DC    CL10'UNSEEDED  ',AL4(VOPTUNSD)                                   
         DC    CL10'UNALLOC   ',AL4(VOPTUNSD)                                   
         DC    CL10'UNASSIGNED',AL4(VOPTUNSD)                                   
         DC    CL10'WEEKLY    ',AL4(VOPTWEEK)                                   
         DC    CL10'#         ',AL4(VOPTEASY)   COPY FOR FAX                    
         DC    CL10'TN2       ',AL4(VOPTTN2)    TN2+10=                         
         DC    CL10'TN1       ',AL4(VOPTTN1)    TN1(3)                          
*MNV                                                                            
         DC    CL10'DIGITAL   ',AL4(VOPTDIGI)   OVERRIDE SUPRESS DIGI           
*MNV                                                                            
         DC    X'FF'                                                            
                                                                                
OPTHLPMS DC    C'OPT=DATE/REV/NOAGY/TEST/NEW/TS/-TS/PGM/UNS/WEEK'               
TSMSG    DC    C'* ERROR * INVALID TRAFFIC SUPPLIER ENTERED *'                  
         LTORG                                                                  
         EJECT                                                                  
* BUILD PRINT LINE(S) FOR ALL PATTERNS  *                                       
                                                                                
BLIN     NMOD1 0,**BLIN**,R7                                                    
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
         OI    UPDSW,UPDSWPU       SET 'PRINTING UNITS'                         
                                                                                
         L     R1,AIO3             CLEAR SVPRDLST                               
         XC    0(240,R1),0(R1)                                                  
         XC    240(240,R1),240(R1)                                              
         MVI   PRINTED,C'N'        RESET PRINTED FLAG                           
                                                                                
         TM    SVOPTSW,OPTPSORT    ARE WE SORTING BY PRODUCT CODE?              
         BZ    BLIN03                                                           
         SR    R2,R2                                                            
         USING PATABLED,R5         RESORT PATTERN TABLE BY PROD                 
         L     R5,APATABLE                                                      
BLIN01   CLI   0(R5),0                                                          
         BE    BLIN02                                                           
         LA    R5,PATNEXT                                                       
         LA    R2,1(R2)                                                         
         B     BLIN01                                                           
BLIN02   DS    0H                                                               
         L     R5,APATABLE                                                      
*                                                                               
         LA    R0,PATSTR-PATENT                                                 
         CLI   SVTN2PRO+10,C'Y'                                                 
         BNE   *+8                                                              
         LA    R0,PATPSTR-PATENT                                                
         GOTO1 QSORT,DMCB,(R5),(R2),L'PATENT,4,(R0)                             
*                                                                               
         GOTO1 XSORT,DMCB,(R5),(R2),L'PATENT,8,12                               
*                                                                               
BLIN03   DS    0H                                                               
         L     R5,APATABLE                                                      
         USING PATABLED,R5                                                      
                                                                                
BLIN04   DS    0H                                                               
         TM    PATFLG2,PATXXXX     TEST DO NOT USE PATTERN                      
         BO    BLIN192                                                          
         CLI   SVTN2PRO+10,C'Y'                                                 
         BE    BLIN05                                                           
         TM    PATFLG2,PATUSED                                                  
         BZ    BLIN192                                                          
*                                                                               
BLIN05   MVI   PRINTED,C'Y'        SET PRINTED FLAG                             
         LA    R1,2                MINIMUM LINES TO PRINT                       
         LA    R2,P                                                             
         USING PRTLINE,R2                                                       
                                                                                
         OC    PATPRD2,PATPRD2     P/B PRD?                                     
         BZ    *+8                                                              
         LA    R1,2(R1)                                                         
         STC   R1,ALLOWLIN                                                      
*                                                                               
*        THESE INSTRUCTIONS CAUSE A PROBLEM WHEN RUNNING ALL NETWORKS           
*        AND THE FIRST PATTERN IN A NEW NETWORK HAS THIS FLAG ON                
*        PROGRAM TABLE FROM PRIOR NETWORK THEN REMAINS                          
*        TM    PATFLG2,PATSMDAY    TEST SAME DAY CONTINUATION                   
*        BO    *+8                 YES - KEEP OLD PROGRAM LIST                  
         BRAS  RE,CNTPRG           GO COUNT THE PROGRAMS COVERED                
*                                                                               
         LH    R6,NAMTABCT                                                      
         CHI   R6,1                                                             
         BL    BLIN07X             NONE                                         
         BH    BLIN07X             MORE THAN 1                                  
*                                                                               
         OI    ANYFLAG,ONEPROG     JUST ONE PROGRAM                             
         BRAS  RE,FPN              SVPROG HAS PROGRAM CODE - GET NAME           
         MVC   PPROG,SVPROGNM                                                   
                                                                                
BLIN07X  DS   0H                                                                
         OC    PATFEED,PATFEED     THIS HAVE A FEED                             
         BZ    BLIN09                                                           
         MVC   SVFEED,PATFEED                                                   
         B     BLIN10                                                           
                                                                                
BLIN09   CLI   PATDP,0             ANY DAYPART                                  
         BE    BLIN10                                                           
                                                                                
         XC    GERROR,GERROR                                                    
         MVI   ERROPT,C'Y'         RETURN ON ERROR                              
                                                                                
         GOTO1 VALIDPT,DMCB,(X'01',PATDP)  GET 2 CHAR DAYPART                   
*                                                                               
         MVC   PFEED(2),=C'??'     BAD DAYPART CODE PRINT '??'                  
         MVI   ERROPT,0                                                         
         OC    GERROR,GERROR                                                    
         BNZ   BLIN09B                                                          
         MVC   PFEED(2),QDPT2                                                   
                                                                                
BLIN09A  CLI   PATDP,0             ANY DAYPART                                  
         BE    BLIN10                                                           
                                                                                
         XC    GERROR,GERROR                                                    
         MVI   ERROPT,C'Y'         RETURN ON ERROR                              
                                                                                
         GOTO1 VALIDPT,DMCB,(X'01',PATDP)  GET 2 CHAR DAYPART                   
                                                                                
         MVC   PFEED(2),=C'??'     BAD DAYPART CODE PRINT '??'                  
         MVI   ERROPT,0                                                         
         OC    GERROR,GERROR                                                    
         BNZ   *+10                                                             
         MVC   PFEED(2),QDPT2                                                   
                                                                                
BLIN09B  CLI   PFEED+1,C' '                                                     
         BNH   *+14                                                             
         MVC   PFEED+2(8),=C'=DAYPART'                                          
         B     *+10                                                             
         MVC   PFEED+1(8),=C'=DAYPART'                                          
                                                                                
BLIN10   DS   0H                                                                
         TM    PATFLG,PATTAG                                                    
         BZ    *+8                                                              
         OI    SVFLAG,SVTAG                                                     
*                                                                               
         CLC   PATSEQNO,=C'HIA'                                                 
         BE    BLIN10B                                                          
*                                                                               
BLIN10A  OC    PATSEQNO,PATSEQNO   ANY PATTERN ASSIGNED                         
         BE    *+8                 NO                                           
         BAS   RE,GETPAT           READ THE PATTERN RECORD                      
*                                                                               
BLIN10B  MVC   P,SPACES                                                         
         MVI   P,0                                                              
         MVI   SPACING,1                                                        
         BRAS  RE,GOSPL                                                         
*                                                                               
         BAS   RE,PROTMSG          PRINT ROTATE FROM-TO MESSAGE                 
*                                                                               
         MVI   SPACING,1                                                        
                                                                                
         LA    R1,PATPRD                                                        
         BRAS  RE,FPRDN                                                         
         MVC   PPROD(4),=C'PRD='                                                
         MVC   PPROD+5(L'PATPRD),PATPRD                                         
         MVC   PPRDNM,PRDNM                                                     
*OPTICA                                                                         
         MVC   SVPROD,PATPRD                                                    
         XC    SVPROD2,SVPROD2                                                  
*                                                                               
         OC    PATPRD2,PATPRD2     P/B PROD?                                    
         BZ    BLIN11                                                           
         LA    R1,PATPRD2                                                       
         BRAS  RE,FPRDN                                                         
         MVC   PPROD+132(4),=C'P/B='                                            
         MVC   PPROD+5+132(L'PATPRD2),PATPRD2                                   
         MVC   PPRDNM+132,PRDNM                                                 
*OPTICA                                                                         
         MVC   SVPROD2,PATPRD2                                                  
*                                                                               
BLIN11   CLI   OPTPROD,0                                                        
         BNH   BLIN11X                                                          
         OC    PATPRD2,PATPRD2                                                  
         BNZ   BLIN11X                                                          
         MVC   P2,SPACES                                                        
*                                                                               
BLIN11X  BRAS  RE,GOSPL                                                         
                                                                                
BLIN12   DS    0H                                                               
         CLC   PATSEQNO,=C'HIA'                                                 
         BNE   BLIN13                                                           
         LA    R2,P                                                             
         MVC   PCML+2(6),=C'HIATUS'                                             
         B     BLIN14                                                           
*                                                                               
BLIN13   OC    PATSEQNO,PATSEQNO    TEST TBA                                    
         BNZ   BLIN20               NO                                          
         LA    R2,P                                                             
         MVC   PCML+2(15),=CL15'TO BE ANNOUNCED'                                
*                                                                               
BLIN14   LLC   R0,PATSLN                                                        
         EDIT  (R0),(3,PSLN+5),ALIGN=LEFT                                       
         MVC   PSLN(4),=C'LEN='                                                 
                                                                                
         CLI   PATSLN2,0                                                        
         BE    BLIN15                                                           
         MVI   PSLN+8,C'/'                                                      
         LLC   R0,PATSLN2                                                       
         EDIT  (R0),(3,PSLN+9),ALIGN=LEFT                                       
                                                                                
BLIN15   DS    0H                                                               
         BRAS  RE,GOSPL                                                         
*                                                                               
         CLC   =C'HIA',PATSEQNO                                                 
         BE    BLIN192                                                          
*                                                                               
         TM    PATFLG,PATTAG                                                    
         BZ    *+14                                                             
         MVC   PPROG(6),=C'TAG(S)'                                              
         BRAS  RE,GOSPL                                                         
*                                                                               
         CLI   SVTN1PR3,C'N'       SUPPRESS PROGRAMS COVERED BY                 
         BNE   BLIN130              YES                                         
         MVI   P,0                                                              
         BRAS  RE,GOSPL                                                         
*                                                                               
         TM    ANYFLAG,ONEPROG     JUST ONE PROGRAM                             
         BO    *+8                                                              
         OI    CMTFLAG,NOBLNK                                                   
         B     BLIN130                                                          
                                                                                
BLIN20   DS    0H                                                               
         L     R6,AIO1                                                          
         MVI   ELCODE,X'30'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         ST    R3,SVR3                                                          
                                                                                
         USING NPTCMLEL,R6                                                      
         LLC   R3,NPTCMLLN                                                      
         SRL   R3,4                DIVIDE BY 16                                 
         STC   R3,NXTALPHA                                                      
                                                                                
         CLI   NXTALPHA,1                                                       
         BH    *+12                                                             
         MVI   NXTALPHA,0                                                       
         B     *+8                                                              
         MVI   NXTALPHA,1                                                       
                                                                                
         MVC   BLOCK(192),NPTCML   SAVE OFF COMML LIST                          
         LA    R4,BLOCK                                                         
                                                                                
         CLI   SVTN2PRO+6,C'Y'     PRINT PERCENTAGES IF AVAILABLE               
         BNE   BLIN24                                                           
                                                                                
* GET ACTUAL NUMBER OF COMMERCIAL ROTATION (DELETES DONT COUNT)                 
                                                                                
         LR    R1,R3               NUMBER OF CML ENTRIES                        
BLIN22   CLC   =X'5C00',0(R4)      DEL CML                                      
         BNE   *+6                                                              
         BCTR  R3,0                DECREMENT CNTR FOR PATRN CML DELS            
         LA    R4,16(R4)                                                        
         BCT   R1,BLIN22           R3 NOW HAS COUNT OF NON-DELETES              
                                                                                
         LA    R4,BLOCK                                                         
                                                                                
         MVI   PBYTE,1                                                          
         MVI   ELCODE,X'36'        GET ABSURD PERCENT ELEM IF ANY               
         L     R6,AIO1                                                          
         BRAS  RE,INITXSP                                                       
         BRAS  RE,GETEL                                                         
         BE    BLIN25                                                           
                                                                                
         MVI   ELCODE,X'34'        GET PATTERN PECENT ELEMENT                   
         L     R6,AIO1                                                          
         BRAS  RE,GETEL                                                         
         BE    BLIN25                                                           
                                                                                
BLIN24   MVI   ELCODE,X'32'        GET PATTERN ELEMENT                          
         MVI   PBYTE,0                                                          
         L     R6,AIO1                                                          
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         XC    BLOCK+200(100),BLOCK+200                                         
         LLC   R1,1(R6)                                                         
         AHI   R1,-3                                                            
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   BLOCK+200(0),2(R6)  SAVE ROTATION LIST                           
         STC   R1,BLOCK+199                                                     
                                                                                
         LA    RE,BLOCK+200+1(R1)  POINT PAST END OF LIST                       
         MVI   0(RE),X'FF'         PRINT 'ONLY'                                 
         LTR   R1,R1               WAS LENGTH 1 (NOW ZERO)                      
         BZ    *+8                                                              
         MVI   0(RE),X'EE'         PRINT 'REPEAT'                               
         LA    R6,BLOCK+200                                                     
         B     BLIN30                                                           
                                                                                
BLIN25   LLC   R0,1(R6)                                                         
         BCTR  R0,0                                                             
         BCTR  R0,0                                                             
         LA    R6,2(,R6)                                                        
                                                                                
         XC    WORK,WORK                                                        
         CLI   PBYTE,0             DOING PERCENTS                               
         BE    BLIN30               NO                                          
                                                                                
         CLI   2(R6),100           ROTATION OF 1 LETTER  (100%)                 
         BNE   *+14                 NO                                          
         MVC   WORK(7),=C'100 PCT'                                              
         B     BLIN28                                                           
                                                                                
         LR    R1,R0                                                            
         SR    R0,R0                                                            
         D     R0,=F'3'                                                         
         LTR   R0,R0                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         LR    R0,R1                                                            
                                                                                
BLIN26   CLI   PBYTE,0             DOING PERCENTS                               
         BE    BLIN30               NO                                          
                                                                                
         XC    WORK,WORK                                                        
         CLI   4(R6),100           ROTATION OF 1 LETTER (100%)                  
         BNE   *+14                 NO                                          
         MVC   WORK(7),=C'100 PCT'                                              
         B     BLIN28                                                           
                                                                                
         SR    RE,RE                                                            
         ICM   RE,3,1(R6)                                                       
         CVD   RE,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         MVI   WORK,C' '                                                        
         UNPK  WORK+1(2),DUB+6(2)                                               
         MVI   WORK+3,C' '                                                      
         MVC   WORK+4(4),=C'PCT '                                               
         MVI   WORK+8,C' '                                                      
                                                                                
BLIN28   LLC   RE,0(R6)            GET COMMERCIAL LETTER                        
         AHI   RE,-193             CONVERT A (=193) TO 0                        
         CHI   RE,10                                                            
         BL    *+8                                                              
         AHI   RE,-7               CONVERT J (=209) TO 9                        
                                                                                
* INDEX INTO SAVED ELEMENT TO FIND COMMERCIAL CODE *                            
                                                                                
         SLL   RE,4                X 16                                         
         LA    R4,BLOCK(RE)                                                     
BLIN30   CLC   =X'5C00',0(R4)                                                   
         BE    BLIN110                                                          
         MVC   SVCMLCOD,0(R4)                                                   
         NI    ANYFLAG,X'FF'-CLTCMLNO    TURN OFF GET CLT CML #                 
         MVC   SVPRD,PATPRD                                                     
         BRAS  RE,FCML                                                          
                                                                                
         LA    R2,P                                                             
         CLI   PBYTE,1                                                          
         BE    BLIN52                                                           
         CLI   NXTALPHA,0          ONLY ONE COMMERCIAL                          
         BH    BLIN50                                                           
         MVC   PPCT,=C'100 PCT'                                                 
         B     BLIN54               YES                                         
                                                                                
BLIN50   DS    0H                                                               
         LLC   RF,NXTALPHA         GET DISPLACEMENT INTO ALPHA TABLE            
         LLC   RE,ALPHATAB-1(RF)                                                
         MVC   PLROT,=C'( )'                                                    
         STC   RE,PLROT+1          PRINT ALPHA (A)                              
         LLC   RE,NXTALPHA                                                      
         LA    RE,1(RE)                                                         
         STC   RE,NXTALPHA                                                      
         B     BLIN54                                                           
                                                                                
BLIN52   DS    0H                                                               
         MVC   PPCT(8),WORK                                                     
                                                                                
BLIN54   CLC   SVCMLCOD,=CL8'NO COMML'                                          
         BNE   BLIN56                                                           
         MVC   0(8,R4),=CL8'NO COMML'                                           
         MVC   PROTCML,SPACES                                                   
                                                                                
BLIN56   DS    0H                                                               
         CLC   PATSLN,SVCMLLEN     IF UNIT LEN NOT = CML LEN                    
         BE    BLIN58                                                           
         CLI   PATPRD2,0           AND THERE IS A P/B PRD                       
         BE    BLIN58                                                           
         CLI   PATSLN2,0           AND UNIT LEN 2 ZERO                          
         BNE   BLIN58                                                           
         LLC   RE,PATSLN           ADJUST LENGTHS                               
         LLC   RF,SVCMLLEN                                                      
         SR    RE,RF                                                            
         STC   RF,PATSLN                                                        
         STC   RE,PATSLN2                                                       
                                                                                
BLIN58   SR    R1,R1                                                            
         CLI   PATPRD2,0           CK P/B PROD                                  
         BE    BLIN76               NO                                          
                                                                                
         OC    8(8,R4),8(R4)       ANY SECOND COMML                             
         BZ    BLIN74                                                           
                                                                                
         CLC   0(8,R4),8(R4)       BOTH COMMLS EQUAL                            
         BE    BLIN74                                                           
                                                                                
         MVC   PSLN(4),=C'LEN='                                                 
         MVI   PSLN+5,C'('                                                      
         LA    R1,PSLN+6                                                        
         OC    SVCMLOVR,SVCMLOVR   ANY PRINT OVERRIDE?                          
         BZ    BLIN70                                                           
         LA    RF,SVCMLOVR                                                      
                                                                                
         EDIT  (B1,SVCMLLEN),(3,0(R1)),ALIGN=LEFT                               
         AR    R1,R0                                                            
         MVI   0(R1),C'-'                                                       
         MVI   PCMLTL+9,C'('                                                    
         LA    R1,PCMLTL+10                                                     
                                                                                
         EDIT  (1,(RF)),(3,0(R1)),ALIGN=LEFT,ZERO=NOBLANK                       
         AR    R1,R0                                                            
         MVI   0(R1),C'/'                                                       
         EDIT  (1,1(RF)),(3,1(R1)),ALIGN=LEFT,ZERO=NOBLANK                      
                                                                                
         CLI   0(R1),C' '                                                       
         BNH   *+12                                                             
         LA    R1,1(,R1)                                                        
         B     *-12                                                             
         MVI   0(R1),C')'                                                       
         MVC   PCMLTL(9),=C'LEN OVRD='                                          
         B     BLIN72                                                           
*                                                                               
BLIN70   DS    0H                                                               
         EDIT  (B1,PATSLN),(3,0(R1)),ALIGN=LEFT                                 
         AR    R1,R0                                                            
         MVI   0(R1),C'-'                                                       
                                                                                
BLIN72   DS    0H                                                               
         B     BLIN80                                                           
                                                                                
BLIN74   LLC   R1,PATSLN2                                                       
                                                                                
BLIN76   LLC   R0,PATSLN                                                        
         AR    R0,R1                                                            
*                                                                               
         OC    SVCMLOVR,SVCMLOVR   ANY PRINT OVERRIDE?                          
         BZ    BLIN78                                                           
         LA    RF,SVCMLOVR                                                      
                                                                                
         MVC   PSLN(4),=C'LEN='                                                 
         LA    R1,PSLN+5                                                        
         EDIT  (B1,SVCMLLEN),(3,0(R1)),ALIGN=LEFT                               
         MVI   PCMLTL+9,C'('                                                    
         LA    R1,PCMLTL+10                                                     
                                                                                
         EDIT  (1,(RF)),(3,0(R1)),ALIGN=LEFT,ZERO=NOBLANK                       
         AR    R1,R0                                                            
         MVI   0(R1),C'/'                                                       
         EDIT  (1,1(RF)),(3,1(R1)),ALIGN=LEFT,ZERO=NOBLANK                      
                                                                                
         CLI   0(R1),C' '                                                       
         BNH   *+12                                                             
         LA    R1,1(,R1)                                                        
         B     *-12                                                             
         MVI   0(R1),C')'                                                       
         MVC   PCMLTL(9),=C'LEN OVRD='                                          
         B     BLIN80                                                           
                                                                                
BLIN78   DS    0H                                                               
         LA    R2,P                                                             
         MVC   PSLN(4),=C'LEN='                                                 
         EDIT  (R0),(3,PSLN+5),ALIGN=LEFT                                       
                                                                                
BLIN80   DS    0H                                                               
         TM    PATFLG,PATTAG                                                    
         BZ    *+10                                                             
         MVC   PPROG+132(6),=C'TAG(S)'                                          
*                                                                               
         CLC   PATPRD2,SPACES                                                   
         BNH   BLIN82                                                           
         OC    8(8,R4),8(R4)       ANY SECOND COMML                             
         BNZ   BLIN82                                                           
         MVC   SVPBMSG(5),=C'P/B ('                                             
         LA    R1,SVPBMSG+5                                                     
         EDIT  (B1,PATSLN),(3,0(R1)),ALIGN=LEFT                                 
         CLI   PATSLN2,0                                                        
         BE    BLIN82                                                           
         AR    R1,R0                                                            
         MVI   0(R1),C'/'                                                       
         LA    R1,1(R1)                                                         
         EDIT  (B1,PATSLN2),(3,0(R1)),ALIGN=LEFT                                
         AR    R1,R0                                                            
         MVI   0(R1),C')'                                                       
                                                                                
BLIN82   DS    0H                                                               
         CLC   SVCMLCOD,=CL8'NO COMML'                                          
         BNE   BLIN83                                                           
         LA    R2,P1                                                            
         MVC   PCML(26),=C'*** DELETED COMMERCIAL ***'                          
         B     BLIN86                                                           
                                                                                
BLIN83   DS    0H                                                               
         LA    R2,P1                                                            
         MVC   PCML(L'SVCMLCOD),SVCMLCOD                                        
         OC    SVCMLADI,SVCMLADI                                                
         BZ    *+10                                                             
         MVC   PCML(12),SVCMLADI                                                
*                                                                               
         LA    R2,P1                                                            
         CLC   PCMLTL,SPACES                                                    
         BNH   *+8                                                              
         LA    R2,P2                                                            
*                                                                               
         MVC   PCMLTL,SVCMLDS                                                   
         LA    R2,132(R2)                                                       
         OC    SVCMLDS2,SVCMLDS2                                                
         BZ    BLIN84                                                           
         MVC   PCMLTL,SVCMLDS2                                                  
         LA    R2,132(R2)                                                       
         OC    SVCMLDS3,SVCMLDS3                                                
         BZ    BLIN84                                                           
         MVC   PCMLTL,SVCMLDS3                                                  
*                                                                               
BLIN84   OC    8(8,R4),8(R4)                                                    
         BZ    BLIN86                                                           
         LA    R2,P1                                                            
         OC    PCML,SPACES                                                      
         MVI   PCML-1,C'('                                                      
         LA    RF,PCML+8                                                        
         CLI   0(RF),X'40'         SPACE                                        
         BE    *+12                                                             
         LA    RF,1(RF)                                                         
         B     *-12                                                             
         MVI   0(RF),C'-'                                                       
                                                                                
BLIN86   DS    0H                                                               
         LA    R2,P1                                                            
         BAS   RE,POTHR                                                         
         MVI   ALLOWLIN,3                                                       
         MVI   SPACING,1                                                        
         BRAS  RE,GOSPL                                                         
                                                                                
         OC    SVPBMSG,SVPBMSG                                                  
         BZ    *+14                                                             
         MVC   PCMLTL(L'SVPBMSG),SVPBMSG                                        
         BRAS  RE,GOSPL                                                         
         MVI   P,0                                                              
         BRAS  RE,GOSPL                                                         
         XC    SVPBMSG,SVPBMSG                                                  
                                                                                
BLIN88   DS    0H                                                               
         CLI   PATSLN2,0           LEN 2 ZERO                                   
         BE    BLIN110                                                          
                                                                                
         OC    8(8,R4),8(R4)       ANY SECOND COMML                             
         BZ    BLIN110                                                          
         CLC   0(8,R4),8(R4)       BOTH COMMLS EQUAL                            
         BE    BLIN110                                                          
                                                                                
         MVC   SVCMLCOD,8(R4)                                                   
         BRAS  RE,FCML                                                          
                                                                                
         LA    R1,PSLN+6                                                        
         OC    SVCMLOVR,SVCMLOVR   ANY PRINT OVERRIDE?                          
         BZ    BLIN90                                                           
         LA    RF,SVCMLOVR                                                      
                                                                                
         LA    R1,PSLN+5                                                        
         EDIT  (B1,SVCMLLEN),(3,0(R1)),ALIGN=LEFT                               
         MVI   PCMLTL+9,C'('                                                    
         LA    R1,PCMLTL+10                                                     
                                                                                
         EDIT  (1,(RF)),(3,0(R1)),ALIGN=LEFT,ZERO=NOBLANK                       
         AR    R1,R0                                                            
         MVI   0(R1),C'/'                                                       
         EDIT  (1,1(RF)),(3,1(R1)),ALIGN=LEFT,ZERO=NOBLANK                      
                                                                                
         CLI   0(R1),C' '                                                       
         BNH   *+12                                                             
         LA    R1,1(,R1)                                                        
         B     *-12                                                             
         MVI   0(R1),C')'                                                       
         MVC   PCMLTL(9),=C'LEN OVRD='                                          
                                                                                
         LA    R2,P2                                                            
         MVC   PCMLTL,SVCMLDS                                                   
         LA    R2,P3                                                            
         OC    SVCMLDS2,SVCMLDS2                                                
         BZ    BLIN92                                                           
         MVC   PCMLTL,SVCMLDS2                                                  
         LA    R2,P4                                                            
         OC    SVCMLDS3,SVCMLDS3                                                
         BZ    BLIN92                                                           
         MVC   PCMLTL,SVCMLDS3                                                  
         LA    R2,P1                                                            
         B     BLIN92                                                           
         SPACE                                                                  
BLIN90   DS    0H                                                               
         LA    R1,PSLN+5                                                        
         EDIT  (B1,PATSLN2),(3,0(R1)),ALIGN=LEFT                                
         SPACE                                                                  
BLIN92   DS    0H                                                               
         LA    R1,PSLN+5                                                        
         CLI   0(R1),C' '                                                       
         BNH   *+12                                                             
         LA    R1,1(,R1)                                                        
         B     *-12                                                             
         MVI   0(R1),C')'                                                       
         MVC   PSLN(4),=C'LEN='                                                 
                                                                                
         MVC   SVCMLCOD,8(R4)                                                   
         OC    PATPRD2,PATPRD2                                                  
         BZ    *+10                                                             
         MVC   SVPRD,PATPRD2                                                    
         NI    ANYFLAG,X'FF'-CLTCMLNO    TURN OFF GET CLT CML #                 
         BRAS  RE,FCML                                                          
         CLC   SVCMLCOD,=CL8'NO COMML'                                          
         BE    BLIN94                                                           
*                                                                               
         MVC   PCML(L'SVCMLCOD),SVCMLCOD                                        
         OC    PCML,SPACES                                                      
         OC    SVCMLADI,SVCMLADI                                                
         BZ    *+10                                                             
         MVC   PCML(12),SVCMLADI                                                
                                                                                
         LA    RE,PCML+8                                                        
         CLI   0(RE),X'40'         SPACE                                        
         BNH   *+12                                                             
         LA    RE,1(RE)                                                         
         B     *-12                                                             
         MVI   0(RE),C')'                                                       
                                                                                
         CLC   PCMLTL,SPACES                                                    
         BNH   *+8                                                              
         LA    R2,P2                                                            
                                                                                
         MVC   PCMLTL,SVCMLDS                                                   
                                                                                
         OC    SVCMLDS2,SVCMLDS2                                                
         BZ    *+10                                                             
         MVC   PCMLTL+132,SVCMLDS2                                              
         OC    SVCMLDS3,SVCMLDS3                                                
         BZ    *+10                                                             
         MVC   PCMLTL+132+132,SVCMLDS3                                          
                                                                                
         LA    R2,P1                                                            
         BAS   RE,POTHR                                                         
         BRAS  RE,GOSPL                                                         
         MVI   P,0                                                              
         BRAS  RE,GOSPL                                                         
         B     BLIN110                                                          
                                                                                
BLIN94   DS    0H                                                               
         MVC   8(8,R4),=CL8'NO COMML'                                           
                                                                                
         MVC   PCML(26),=C'*** DELETED COMMERCIAL ***'                          
         MVI   P1,0                                                             
         MVI   P2,0                                                             
         BRAS  RE,GOSPL            GET NEXT PRINT LINE                          
         B     BLIN110                                                          
                                                                                
BLIN96   DS    0H                                                               
         MVC   SVCMLCOD,8(R4)                                                   
         OC    SVCMLCOD,SVCMLCOD                                                
         BZ    BLIN110                                                          
         NI    ANYFLAG,X'FF'-CLTCMLNO    TURN OFF GET CLT CML #                 
         MVC   SVPRD,PATPRD                                                     
         BRAS  RE,FCML                                                          
         CLC   SVCMLCOD,=CL8'NO COMML'                                          
         BNE   *+16                                                             
         MVC   8(8,R4),=CL8'NO COMML'                                           
         MVC   PROTCML,SPACES                                                   
                                                                                
         OC    SVCMLDS2,SVCMLDS2                                                
         BZ    BLIN106                                                          
                                                                                
         OC    SVCMLADI,SVCMLADI   IS THERE AN AD-ID                            
         BNZ   BLIN98                                                           
                                                                                
         CLI   SVTN2PRE,C'Y'       PRINT CLT CML#                               
         BNE   BLIN100                                                          
         OC    SVCMCLTN,SVCMCLTN   ANY CLT CML #                                
         BZ    BLIN100                                                          
                                                                                
BLIN98   DS    0H                                                               
         CLC   PCMLTL,SPACES       ANY DESCRIPTION?                             
         BNH   BLIN100              NO                                          
         MVC   PCMLTL+132(L'SVCMLDS2),SVCMLDS2                                  
         B     *+10                                                             
BLIN100  DS    0H                                                               
         MVC   PCMLTL,SVCMLDS2                                                  
                                                                                
         OC    SVCMLDS3,SVCMLDS3                                                
         BZ    BLIN106                                                          
                                                                                
         OC    SVCMLADI,SVCMLADI   IS THERE AN AD-ID                            
         BNZ   BLIN102                                                          
                                                                                
         CLI   SVTN2PRE,C'Y'       PRINT CLT CML#                               
         BNE   BLIN104                                                          
         OC    SVCMCLTN,SVCMCLTN   ANY CLT CML #                                
         BZ    BLIN104                                                          
BLIN102  DS    0H                                                               
         CLC   PCMLTL,SPACES       ANY DESCRIPTION?                             
         BNH   BLIN104              NO                                          
         MVC   PCMLTL+132(L'SVCMLDS3),SVCMLDS3                                  
         B     *+10                                                             
BLIN104  MVC   PCMLTL,SVCMLDS3                                                  
                                                                                
BLIN106  OC    SVCMCLTN,SVCMCLTN                                                
         BZ    BLIN110                                                          
         CLI   SVTN2PRE,C'Y'       PRINT CLT CML#                               
         BE    BLIN110             YES, ALREADY PRINTED                         
                                                                                
         CLC   PCMLTL,SPACES       IS THIS USED                                 
         BE    BLIN108                                                          
                                                                                
         MVC   PCMLTL+132(L'SVCMCLTN),SVCMCLTN                                  
         B     BLIN110                                                          
                                                                                
BLIN108  DS    0H                                                               
         MVC   PCMLTL(L'SVCMCLTN),SVCMCLTN                                      
                                                                                
BLIN110  DS    0H                                                               
         CLI   PBYTE,1             DOING PERCENTAGES                            
         BE    BLIN112              YES                                         
                                                                                
         CLI   PBYTE,0             DOING PERCENTS                               
         BE    BLIN114              NO                                          
                                                                                
BLIN112  DS    0H                                                               
         LA    R6,3(,R6)           GET NEXT CODE                                
         BCT   R3,BLIN26                                                        
         L     R3,SVR3                                                          
         B     BLIN115                                                          
                                                                                
BLIN114  DS    0H                                                               
         LA    R4,16(,R4)                                                       
         BCT   R3,BLIN30                                                        
                                                                                
         L     R3,SVR3                                                          
                                                                                
* IF ANY PATTERN TEXT, PRINT IT HERE *                                          
                                                                                
BLIN115  DS   0H                                                                
         CLI   PBYTE,1                                                          
         BE    BLIN124                                                          
                                                                                
         CLI   BLOCK+199,0                                                      
         BE    BLIN124                                                          
                                                                                
         MVC   2(L'ROTCMSG,R2),ROTCMSG                                          
         LA    R1,L'ROTCMSG+3(R2)                                               
         LA    RF,BLOCK+200        ROTATION LIST                                
         LLC   R0,BLOCK+199        GET LENGTH                                   
         LA    RE,2                ONE SPACE BETWEEN LETTERS                    
         CHI   R0,36               IF MORE THAN 36 ENTRIES                      
         BNH   BLIN118                                                          
         LR    RE,R0                                                            
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),0(RF)       THEN PRINT ROTATION W/O SPACES               
         LA    RE,2                                                             
         B     BLIN122                                                          
                                                                                
BLIN118  AHI   R0,1                ADJUST TO REAL LENGTH                        
                                                                                
BLIN120  MVC   0(1,R1),0(RF)                                                    
         AR    R1,RE                                                            
         LA    RF,1(RF)                                                         
         BCT   R0,BLIN120                                                       
                                                                                
BLIN122  DS    0H                                                               
         MVI   SPACING,1                                                        
         BAS   RE,NXL              GET NEXT PRINT LINE                          
                                                                                
BLIN124  DS    0H                                                               
         CLC   P,SPACES                                                         
         BNH   *+12                                                             
         MVI   P,0                                                              
         BRAS  RE,GOSPL            GET NEXT PRINT LINE                          
                                                                                
         TM    SVFLAG,SEEMORFL     PRINT SEE ADDITIONAL CML MSG                 
         BZ    BLIN126                                                          
         NI    SVFLAG,X'FF'-SEEMORFL                                            
         MVC   0(SEEMOREX-SEEMORE,R2),SEEMORE                                   
         BRAS  RE,GOSPL                                                         
         MVI   ALLOWLIN,0                                                       
         LA    R2,P2                                                            
                                                                                
BLIN126  DS    0H                                                               
         L     R6,AIO1                                                          
         MVI   ELCODE,X'40'                                                     
         BRAS  RE,INITXSP                                                       
         BRAS  RE,GETEL                                                         
         BNE   BLIN128                                                          
         BAS   RE,PTXT                                                          
         BRAS  RE,GOSPL                                                         
         BRAS  RE,INITSPT                                                       
                                                                                
BLIN128  DS   0H                                                                
         TM    SVOPTSW,OPTPTTN     PRINT PATTERN INFO                           
         BZ    BLIN130                                                          
                                                                                
         BAS   RE,NXL                                                           
         BRAS  RE,PTN                   PRINT PATTERN INFO                      
         BAS   RE,NXL                                                           
*****                                                                           
* PRINT PATTERN KEY FOR TESTING SO I KNOW WHAT PATTERN IS BEING USED            
*****                                                                           
*         L     R6,AIO1                                                         
*         GOTO1 HEXOUT,DMCB,(R6),PFEED,27,=C'TOG'                               
*         BAS   RE,NXL                                                          
*****                                                                           
                                                                                
BLIN130  DS   0H                                                                
         MVI   DATADISP+1,24                                                    
                                                                                
BLIN136  DS   0H                                                                
         CLI   SVTN1PR3,C'N'       SUPPRESS PROGRAMS COVERED BY                 
         BNE   BLIN185              YES                                         
         CLI   PATPROG,C' '        TEST PROGRAM SPECIFIC PATTERN                
         BH    BLIN185                                                          
                                                                                
BLIN168  DS    0H                                                               
         L     R4,APNAMTAB         PROGRAM NAME TABLE                           
         OC    0(6,R4),0(R4)       EMPTY TABLE                                  
         BZ    BLIN185             YES - SKIP                                   
                                                                                
         MVI   P1,0                                                             
         LA    R2,P2                                                            
         MVC   PPROG(17),=C'PROGRAMS COVERED:'                                  
         BAS   RE,NXL              GO TO NEXT PRINT LINE OR PRINT               
                                                                                
BLIN170  DS    0H                                                               
         LH    R0,6(R4)                                                         
         LTR   R0,R0                                                            
         BNZ   BLIN174                                                          
                                                                                
         LA    R4,8(R4)                                                         
         OC    0(6,R4),0(R4)       EMPTY ENTRY                                  
         BZ    BLIN184             NO                                           
         B     BLIN170                                                          
                                                                                
BLIN174  MVC   PCPROG1,0(R4)  PRNT ENTRY FROM TABLE                             
*                                                                               
         EDIT  (R0),(5,PCUNT1),ZERO=NOBLANK                                     
         MVI   PCUNT1,C'('                                                      
         MVC   PCUNT1+6(6),=C'UNITS)'                                           
                                                                                
         CLC   6(2,R4),=H'1'                                                    
         BNE   *+8                                                              
         MVI   PCUNT1+10,C' '                                                   
                                                                                
BLIN178  MVC   SVPROG,0(R4)        PROG CODE                                    
         MVC   SVPROGDT,PATEND                                                  
         BRAS  RE,FPN              GO FIND PROGRAM NAME                         
         MVI   PCPROGN1,C'"'                                                    
         MVC   PCPROGN1+1(L'SVPROGNM),SVPROGNM                                  
         OC    PCPROGN1+1(L'SVPROGNM),SPACES                                    
         MVI   PCPROGN1+L'PCPROGN1-1,C'"'                                       
         LA    R4,8(R4)                                                         
         GOTO1 SQUASHER,DMCB,1(R2),131                                          
                                                                                
         OC    0(6,R4),0(R4)       EMPTY ENTRY                                  
         BZ    BLIN185             NO                                           
                                                                                
         LH    R0,6(R4)                                                         
         LTR   R0,R0                                                            
         BZ    BLIN182                                                          
         MVC   PCPROG2,0(R4)  PRNT ENTRY FROM TABLE                             
         EDIT  (R0),(5,PCUNT2),ZERO=NOBLANK                                     
         MVI   PCUNT2,C'('                                                      
         MVC   PCUNT2+6(6),=C'UNITS)'                                           
                                                                                
         CLC   6(2,R4),=H'1'                                                    
         BNE   *+8                                                              
         MVI   PCUNT2+10,C' '                                                   
                                                                                
BLIN180  MVC   SVPROG,0(R4)        PROG CODE                                    
         MVC   SVPROGDT,PATEND                                                  
*                                                                               
         BRAS  RE,FPN              GO FIND PROGRAM NAME                         
*                                                                               
         MVI   PCPROGN2,C'"'                                                    
         MVC   PCPROGN2+1(L'SVPROGNM),SVPROGNM                                  
         OC    PCPROGN2+1(L'SVPROGNM),SPACES                                    
         MVI   PCPROGN2+L'PCPROGN2-1,C'"'                                       
*                                                                               
BLIN182  LA    R4,8(R4)                                                         
         GOTO1 SQUASHER,DMCB,PCPROGN2,46                                        
                                                                                
BLIN184  BAS   RE,NXL              GO TO NEXT PRINT LINE OR PRINT               
                                                                                
         OC    0(6,R4),0(R4)       EMPTY ENTRY                                  
         BNZ   BLIN170             NO                                           
                                                                                
BLIN185  DS    0H                                                               
         BRAS  RE,GOSPL                                                         
                                                                                
         CLI   SVTN1PR3,C'N'                                                    
         BE    BLIN192                                                          
         CLI   SVTN1PR3,C'Y'                                                    
         BE    BLIN192                                                          
         BRAS  RE,SCHDSUMM                                                      
         B     BLIN192                                                          
                                                                                
BLIN190  DS   0H                                                                
         MVI   P,0                                                              
         MVI   SPACING,2                                                        
         BRAS  RE,GOSPL                                                         
*                                                                               
BLIN192  LA    R5,PATNEXT                                                       
         CLI   0(R5),0                                                          
         BNE   BLIN04                                                           
*                                                                               
BLINX    XIT1                                                                   
         DROP  R5                                                               
                                                                                
ALPHATAB DC    C'ABCDEFGHIJKL'                                                  
         EJECT                                                                  
*============================================================                   
* READ PATTERN RECORD *                                                         
*============================================================                   
                                                                                
         USING PATABLED,R5                                                      
GETPAT   NTR1                                                                   
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING NPTPXID,R4                                                       
         MVC   NPTPXID,=X'0AE1'                                                 
         MVC   NPTPXAM(3),BAGYMD   A-M/CLT                                      
         MVC   NPTPXS3Q,PATSEQNO   SEQNUM                                       
*                                                                               
         BRAS  RE,INITXSP          SET TO XSPOT                                 
         MVI   RDUPDATE,C'N'                                                    
*                                                                               
         GOTO1 HIGH                                                             
         CLC   KEY(32),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         DROP  R4                                                               
*                                                                               
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         XIT1                                                                   
         DROP  R5                                                               
         EJECT                                                                  
*------------------------------------------                                     
* PRINT "ROTATE THE FOLLOWING" MESSAGE                                          
*------------------------------------------                                     
         USING PATABLED,R5                                                      
PROTMSG  NTR1                                                                   
         MVC   P,SPACES                                                         
         MVC   2(L'ROTMSG,R2),ROTMSG  PRINT ROTATION MESSAGE                    
         LA    R1,2+L'ROTMSG(R2)                                                
         ST    R1,ASVPRINT            SAVE PRINT LOCATION                       
                                                                                
         CLI   SVPROG,X'FF'           THIS FEED/DAYPART                         
         BE    PROT020                YES                                       
         MVC   0(L'ALLPMSG,R1),ALLPMSG  FOR ALL PROGS MSG                       
         LA    R1,L'ALLPMSG(R1)                                                 
         ST    R1,ASVPRINT            SAVE PRINT LOCATION                       
                                                                                
         OC    SVPROG,SVPROG          IF NO PROGRAM SPECIFIC PATTERN            
         BNZ   PROT010                TO COVER THESE UNITS PRINT                
         CLI   SVTN1PR3,C'N'          "ALL PROGRAMS" MSG                        
         BNE   PROT015                                                          
         TM    ANYFLAG,ONEPROG                                                  
         BZ    PROT015                                                          
         OC    SVPROG,SVPROG                                                    
         BZ    PROT015                                                          
                                                                                
PROT010  DS    0H                                                               
         CLC   SVPROG,PATPROG                                                   
         BNE   PROT015                                                          
                                                                                
PROT013  DS    0H                                                               
         BRAS  RE,FPN                                                           
                                                                                
         L     R1,ASVPRINT         GET ADDRES OF PRINT LOCATION                 
         SHI   R1,L'ALLPMSG        BACK UP TO REPLACE ALL PROGS MESSAGE         
         MVC   0(L'ALLPMSG,R1),SPACES   CLEAR MSG                               
         MVC   0(9,R1),=C'PROGRAM "'  WITH PROGRAM SPECIFIC MESSAGE             
         MVC   9(16,R1),SVPROGNM   PRINT PROGRAM NAME                           
         MVI   25(R1),C'"'                                                      
         MVC   27(6,R1),SVPROG     AND PROGRAM CODE                             
         LA    R1,34(R1)                                                        
         ST    R1,ASVPRINT                                                      
                                                                                
PROT015  DS    0H                                                               
         CLI   PATDP,0             ANY DAYPART                                  
         BE    PROT020                                                          
         XC    GERROR,GERROR                                                    
         MVI   ERROPT,C'Y'         RETURN ON ERROR                              
         GOTO1 VALIDPT,DMCB,(X'01',PATDP)  GET 2 CHAR DAYPART                   
         L     R1,ASVPRINT         GET ADDRES OF PRINT LOCATION                 
         MVC   0(11,R1),=C'IN DAYPART '                                         
         MVI   ERROPT,0                                                         
         OC    GERROR,GERROR                                                    
         BZ    PROT018                                                          
         MVC   11(2,R1),=C'??'     BAD DAYPART CODE PRINT '??'                  
         B     *+10                                                             
PROT018  MVC   11(2,R1),QDPT2                                                   
         LA    R1,13(R1)                                                        
         ST    R1,ASVPRINT                                                      
                                                                                
PROT020  BAS   RE,PFROMTO                                                       
*                                                                               
         OC    P,SPACES                                                         
         GOTO1 SQUASHER,DMCB,P+1,131                                            
         LA    R2,132(R2)          BUMP TO NEXT PRINT LINE                      
         OC    PATFEED,PATFEED     THIS HAVE A FEED                             
         BZ    PROT030                                                          
         MVC   PFEED(6),=C'FEED= '                                              
         MVC   PFEED+6(4),SVFEED                                                
         BRAS  RE,RFEED                                                         
                                                                                
* FOR PRODUCT SPECIFIC REQUEST IF THERE IS P/B                                  
* THEN PRINT PRD/PRD2 IN THE BODY OF THE REPORT                                 
* OTHERWISE THERE IS NO NEED TO PRINT PRODUCT                                   
                                                                                
PROT030  XIT1  REGS=(R2)                                                        
         EJECT                                                                  
ROTMSG   DC    C'=====> ROTATE THE FOLLOWING FOR '                              
ALLPMSG  DC    C'ALL PROGRAMS '                                                 
ROTCMSG  DC    C'***** ROTATE COMMERCIALS AS FOLLOWS:'                          
*                                                                               
SEEMORE  DC    C'+++++'                                                         
         DC    C' SEE ADDITIONAL COMMERCIAL INFORMATION BELOW '                 
         DC    C'+++++'                                                         
SEEMOREX EQU   *                                                                
         EJECT                                                                  
*=================================================================              
* FORMAT START END DATES AND TIMES                                              
*=================================================================              
                                                                                
         USING PATABLED,R5                                                      
PFROMTO  NTR1                                                                   
         LR    R4,R1               SAVE PRINT POSITION                          
*                                                                               
         XC    WORK(4),WORK                                                     
*                                                                               
         LA    RE,PATSTR           POINT TO UNIT DATES                          
         CLI   SVTN2PRO+10,C'Y'                                                 
         BNE   *+8                                                              
         LA    RE,PATPSTR          PATTERN DATES                                
         LR    R0,RE               SAVE DATE POINTER IN R0!                     
*                                                                               
         CLC   PATDATES(2),0(RE)   TEST ABOUT TO PRINT REAL PTN START           
         BE    *+10                                                             
         XC    PATSTIM,PATSTIM     IF NOT, DON'T PRINT START TIME               
*                                                                               
         CLC   PATDATES+2(2),2(RE)  TEST ABOUT TO PRINT REAL PTN END            
         BE    *+10                                                             
         XC    PATETIM,PATETIM                                                  
                                                                                
* IF START DATE=END DATE, HAVE TO PRINT TWO TIMES                               
* SO IF ONE TIME IS MISSING MAKE IT START AT 12.01A OR END AT 11.59P            
                                                                                
         CLC   0(2,RE),2(RE)       TEST START DATE=END DATE                     
         BNE   PFROM6                                                           
*                                                                               
         CLC   PATDATES(2),PATDATES+2                                           
         BE    PFROM6                                                           
*                                                                               
         OC    PATSTIM(4),PATSTIM  TEST HAVE ANY TIMES                          
         BZ    PFROM6              NO                                           
*                                                                               
         MVC   0(4,R4),=C' ON '                                                 
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,(R0)),(5,5(R4))                                   
*                                                                               
         OC    PATSTIM,PATSTIM                                                  
         BNZ   PFROM2                                                           
         MVC   14(7,R4),=C' UNTIL '                                             
         XC    DUB,DUB                                                          
         MVC   DUB(2),PATETIM                                                   
         GOTO1 UNTIME,DMCB,DUB,21(R4)                                           
         LA    R1,26(R4)                                                        
         ST    R1,ASVPRINT                                                      
         B     PFROMX                                                           
*                                                                               
PFROM2   MVC   14(13,R4),=C' STARTING AT '                                      
         XC    DUB,DUB                                                          
         MVC   DUB(2),PATSTIM                                                   
         GOTO1 UNTIME,DMCB,DUB,27(R4)                                           
         LA    R1,32(R4)                                                        
         ST    R1,ASVPRINT                                                      
         B     PFROMX                                                           
*                                                                               
                                                                                
*                                                                               
PFROM6   MVC   0(6,R4),=C' FROM '                                               
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,(R0)),(5,7(R4))                                   
         MVI   15(R4),C'-'                                                      
         LA    R0,PATEND                                                        
         CLI   SVTN2PRO+10,C'Y'                                                 
         BNE   *+8                                                              
         LA    R0,PATPEND                                                       
         FIXDT02                                                                
         GOTO1 (RF),(R1),(2,(R0)),(5,16(R4))                                    
*                                                                               
         LA    R1,23(R4)                                                        
         ST    R1,ASVPRINT                                                      
         OC    PATSTIM,PATSTIM     TEST PATTERN HAS START TIME                  
         BNZ   *+14                                                             
         OC    PATETIM,PATETIM     OR END TIME                                  
         BZ    PFROMX                                                           
*                                                                               
         MVC   WORK(8),16(R4)      SAVE THE PRINTABLE END DATE                  
         MVC   15(9,R4),SPACES                                                  
*                                                                               
         OC    PATSTIM,PATSTIM                                                  
         BZ    PFROM10                                                          
*                                                                               
         MVC   15(4,R4),=C' AT '                                                
         XC    DUB,DUB                                                          
         MVC   DUB(2),PATSTIM                                                   
         GOTO1 UNTIME,DMCB,DUB,19(R4)                                           
*                                                                               
PFROM10  LA    R4,25(R4)                                                        
         CLI   0(R4),C' '                                                       
         BH    *+8                                                              
         BCT   R4,*-8                                                           
         MVC   1(7,R4),=C' UNTIL '                                              
         MVC   8(8,R4),WORK        MOVE SAVED END DATE                          
         LA    R4,17(R4)                                                        
         ST    R4,ASVPRINT                                                      
*                                                                               
PFROM12  OC    PATETIM,PATETIM                                                  
         BZ    PFROMX                                                           
         MVC   0(4,R4),=C' AT '                                                 
         MVC   DUB(2),PATETIM                                                   
         GOTO1 UNTIME,DMCB,DUB,5(R4)                                            
         LA    R1,10(R4)                                                        
         ST    R1,ASVPRINT                                                      
*                                                                               
PFROMX   XIT1                                                                   
*=========================================                                      
* PRINT OTHER INFORMATION                                                       
*=========================================                                      
                                                                                
POTHR    NTR1                                                                   
         LA    R3,PHIDEF                                                        
         OC    SVHIDEF,SVHIDEF     ANY HIDEF                                    
         BZ    POTH10                                                           
         MVC   0(9,R3),=C'HIDEF  = '                                            
         MVC   9(L'SVHIDEF,R3),SVHIDEF                                          
         XC    SVHIDEF,SVHIDEF                                                  
         LA    R3,132(R3)                                                       
*                                                                               
POTH10   DS    0H                                                               
         OC    SVCNTRC,SVCNTRC     ANY CENTRCUT                                 
         BZ    POTH20                                                           
         MVC   0(9,R3),=C'CTRCUT = '                                            
         MVC   9(L'SVCNTRC,R3),SVCNTRC                                          
         XC    SVCNTRC,SVCNTRC     ANY CENTRCUT                                 
         LA    R3,132(R3)                                                       
*                                                                               
POTH20   DS    0H                                                               
         OC    SVCMCLTN,SVCMCLTN   ANY CLIENT CML NUMBER                        
         BZ    POTHX                                                            
         MVC   0(9,R3),=C'ALT#   = '  CHGD LABEL FROM CLT->ALT !!               
         MVC   9(L'SVCMCLTN,R3),SVCMCLTN                                        
         XC    SVCMCLTN,SVCMCLTN                                                
POTHX    XIT1  REGS=(R2)                                                        
         EJECT                                                                  
*********************************************                                   
* SUBROUTINE TO PRINT PATTERN TEXT IN BOXES *                                   
*********************************************                                   
                                                                                
PTXT     NTR1                                                                   
                                                                                
* FIRST - FIND LENGTH OF LONGEST COMMENT *                                      
                                                                                
         SR    R5,R5                                                            
         LR    R4,R6                                                            
                                                                                
PTXT10   LLC   RE,1(R6)                                                         
         CR    R5,RE                                                            
         BH    *+6                                                              
         LR    R5,RE                                                            
         BRAS  RE,NEXTEL                                                        
         BE    PTXT10                                                           
                                                                                
* LENGTH IN R5 INCLUDES 3 FOR ELCODE/LEN/SEQ - NOW ADJUST FOR                   
* '*/SP' AND 'SP/*' AT EITHER END                                               
                                                                                
         LA    R5,1(R5)                                                         
                                                                                
* CREATE ROW OF *'S THIS LENGTH                                                 
                                                                                
         MVI   PFEED,C'*'                                                       
         BCTR  R5,0                ADJUST FOR FIRST *                           
         BCTR  R5,0                SET FOR EX                                   
         EX    R5,PTXTAST                                                       
         LA    R5,2(R5)            RESTORE LENGTH                               
                                                                                
         BAS   RE,NXL              GO TO NEXT PRINT LINE OR PRINT               
                                                                                
         LR    R6,R4                                                            
         EJECT                                                                  
PTXT20   LLC   RE,1(R6)                                                         
                                                                                
         MVI   PFEED,C'*'                                                       
         AHI   RE,-4               SET FOR EX                                   
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   PFEED+2(0),3(R6) *EXECUTED*                                      
*                                                                               
         LA    RE,PFEED-1(R5)      POINT TO END OF LINE                         
         MVI   0(RE),C'*'                                                       
         BAS   RE,NXL              GO TO NEXT PRINT LINE OR PRINT               
         BRAS  RE,NEXTEL                                                        
         BE    PTXT20                                                           
*                                                                               
         MVI   PFEED,C'*'                                                       
         BCTR  R5,0                ADJUST FOR FIRST *                           
         BCTR  R5,0                SET FOR EX                                   
         EX    R5,PTXTAST                                                       
         BAS   RE,NXL              GO TO NEXT PRINT LINE OR PRINT               
PTXTX    XIT1  REGS=(R2)                                                        
*                                                                               
PTXTAST  MVC   PFEED+1(0),PFEED  *EXECUTED*                                     
         EJECT                                                                  
* INCREMENT TO NEXT LINE AND PRINT IF ALL USED *                                
                                                                                
NXL      NTR1                                                                   
*THIS MVI STOPS GTSPL FROM DYING - DO NOT REMOVE                                
         MVI   131(R2),0                                                        
         LA    R2,132(,R2)                                                      
         LA    R0,P3                                                            
         CR    R2,R0                                                            
         BNH   NXLX                                                             
         BRAS  RE,GOSPL                                                         
         MVI   ALLOWLIN,0                                                       
         LA    R2,P                                                             
NXLX     XIT1  REGS=(R2)                                                        
         EJECT                                                                  
         LTORG                                                                  
         DROP  R6                                                               
         EJECT                                                                  
*------------------------------------------------------------------*            
* PRINT PATTERN KEY AND REF : DDS ONLY OPTION                      *            
*------------------------------------------------------------------*            
         USING PATABLED,R5                                                      
PTN      NMOD1 0,**PTN**                                                        
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
                                                                                
         USING PRTLINE,R2                                                       
         MVC   PPROD(11),=C'PATTERN KEY'                                        
                                                                                
         CLI   PATYPE,PATQDPMD     MEDIA DAYPART SPECIFIC                       
         BE    PTN04                                                            
                                                                                
         CLI   PATYPE,PATQMED      MEDIA SPECIFIC                               
         BNE   PTN06                                                            
PTN04    MVC   PPROD+12(6),=C'MEDIA='                                           
         MVC   PPROD+18(1),SVMEDIA                                              
         LA    R2,PPROD+20                                                      
                                                                                
         CLI   PATYPE,PATQDPMD     MEDIA DAYPART SPECIFIC                       
         BE    PTN24                                                            
                                                                                
         B     PTN50                                                            
                                                                                
PTN06    MVC   PPROD+12(4),=C'NET='                                             
                                                                                
         CLI   PATYPE,PATQALL      ALL NET                                      
         BNE   PTN10                                                            
         MVC   PPROD+16(5),=C'(ALL)'                                            
         LA    R2,PPROD+22                                                      
         B     PTN50                                                            
                                                                                
PTN10    MVC   PPROD+16(4),NETWORK                                              
         LA    R2,PPROD+22                                                      
         CLI   PATYPE,PATQNET      BY NET                                       
         BE    PTN50                                                            
         CLI   PATYPE,PATQPROG     BY PROG                                      
         BNE   PTN20                                                            
                                                                                
         MVC   0(5,R2),=C'PROG='                                                
         MVC   5(6,R2),PATPROG                                                  
         LA    R2,13(,R2)                                                       
         B     PTN50                                                            
PTN20    CLI   PATYPE,PATQDPT      BY DAYPART                                   
         BNE   PTN30                                                            
                                                                                
PTN24    OC    PATFEED,PATFEED                                                  
         BZ    *+6                                                              
         DC    H'0'                                                             
         MVC   0(4,R2),=C'D/P='                                                 
         MVC   4(1,R2),PATDP                                                    
         LA    R2,7(,R2)                                                        
         B     PTN50                                                            
                                                                                
PTN30    CLI   PATYPE,PATQFEED     BY FEED                                      
         BNE   PTN40                                                            
         CLI   PATDP,0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   0(5,R2),=C'FEED='                                                
         MVC   5(4,R2),PATFEED                                                  
         LA    R2,10(,R2)                                                       
         B     PTN50                                                            
*                                                                               
PTN40    CLI   PATYPE,PATQDPFD     BY FEED AND DAYPART                          
         BE    *+6                                                              
         DC    H'0'                                                             
         CLI   PATDP,0                                                          
         BNE   *+6                                                              
         DC    H'0'                                                             
         OC    PATFEED,PATFEED                                                  
         BNZ   *+6                                                              
         DC    H'0'                                                             
         MVC   0(5,R2),=C'FEED='                                                
         MVC   5(4,R2),PATFEED                                                  
         MVC   10(4,R2),=C'D/P='                                                
                                                                                
         XC    GERROR,GERROR                                                    
         MVI   ERROPT,C'Y'         RETURN ON ERROR                              
                                                                                
         GOTO1 VALIDPT,DMCB,(X'01',PATDP)  GET 2 CHAR DAYPART                   
*                                                                               
         MVC   14(2,R2),QDPT2                                                   
         MVI   ERROPT,0                                                         
         OC    GERROR,GERROR                                                    
         BZ    *+10                                                             
         MVC   14(2,R2),=C'??'     BAD DAYPART CODE PRINT '??'                  
*                                                                               
         LA    R2,18(,R2)                                                       
         CLI   0(R2),C' '                                                       
         BH    PTN50                                                            
         LA    R2,1(R1)                                                         
                                                                                
PTN50    MVC   0(4,R2),=C'REF='                                                 
         SR    R4,R4                                                            
         ICM   R4,7,PATREF                                                      
         X     R4,=X'00FFFFFF'                                                  
         EDIT  (R4),(5,4(R2)),ALIGN=LEFT                                        
                                                                                
         XIT1                                                                   
         LTORG                                                                  
         DROP  R2,R5                                                            
         EJECT                                                                  
* GET PROGRAM NAME *                                                            
                                                                                
FPN      NMOD1 0,**FPN**                                                        
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
                                                                                
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING NPGKEY,R4                                                        
         MVC   NPGKTYP,=X'0D20'                                                 
         MVC   NPGKAM,BAGYMD                                                    
         MVC   NPGKNET,NETMKT                                                   
         MVC   NPGKPROG,SVPROG                                                  
         MVC   NPGKEND,SVPROGDT                                                 
                                                                                
         BRAS  RE,INITSPT          SET TO SPOT                                  
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(11),KEYSAVE                                                  
         BNE   FPNERR                                                           
                                                                                
         L     R6,AIO2                                                          
         ST    R6,AIO                                                           
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
                                                                                
         XC    FILENAME,FILENAME                                                
                                                                                
         MVI   ELCODE,X'92'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING NPGEL92,R6                                                       
         MVC   SVPROGNM,NPGNAME                                                 
         XIT1                                                                   
                                                                                
FPNERR   DS    0H                                                               
         TM    WHEN,X'20'          IS THIS SOON                                 
         BZ    FPNERR10                                                         
                                                                                
         CLI   OFFLINE,C'Y'                                                     
         BNE   FPNERR10                                                         
                                                                                
         TM    SVOPTSW,OPTTEST     TEST OPTION TEST                             
         BO    FPNERR10                                                         
                                                                                
* UNLOCK FOR SOON UPDATES                                                       
                                                                                
         BRAS  RE,UNLK                                                          
                                                                                
FPNERR10 XC    CONHEAD,CONHEAD                                                  
         LA    R2,TRANETH                                                       
         MVC   CONHEAD(43),NOPRGDT                                              
         MVC   CONHEAD+18(6),SVPROG                                             
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,SVPROGDT),(5,CONHEAD+44)                          
         GOTO1 ERREX2                                                           
NOPRGDT  DC    C'* ERROR * PROGRAM XXXXXX DOES NOT EXIST FOR'                   
         DS   0H                                                                
         EJECT                                                                  
         DROP  R4                                                               
         LTORG                                                                  
         EJECT                                                                  
*============================================================                   
* IF ONE DAY HAS MULTIPLE PATTERNS, MAKE SURE IN TIME SEQ                       
*============================================================                   
                                                                                
FIXTIMES NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R5,APATABLE                                                      
         USING PATABLED,R5                                                      
*                                                                               
FIXTIM2  OC    PATSTIM,PATSTIM        TEST PATTERN HAS START TIME               
         BZ    FIXTIM20               NO - NEXT PATTERN                         
         CLC   PATDATES(2),PATDATES+2 TEST STARTS/ENDS SAME DAY                 
         BNE   FIXTIM20               NO - NEXT PATTERN                         
                                                                                
         ST    R5,DMCB             SAVE AS START OF SORT                        
         LA    R0,1                COUNT NUMBER OF PATTERNS                     
*                                                                               
         CLC   PATSTIM,=H'2400'    TEST MIDNIGHT START                          
         BNE   *+10                                                             
         XC    PATSTIM,PATSTIM     SET TO ZERO FOR SORT                         
*                                                                               
FIXTIM4  CLI   PATNEXT,0           TEST MORE ENTRIES                            
         BE    FIXTIM10                                                         
*                                                                               
         LA    RE,PATDATES         POINT TO CURRENT START DATE                  
         LA    R5,PATNEXT          POINT TO NEXT PATTERN                        
*                                                                               
         CLC   PATDATES(2),0(RE)       TEST NEXT PATTERN SAME DAY               
         BNE   FIXTIM10                                                         
*                                                                               
         CLC   PATDATES(2),PATDATES+2  TEST STARTS/ENDS SAME DAY                
         BNE   FIXTIM10                IF NOT, IT'S GONNA BE FINE               
         OC    PATSTIM,PATSTIM         TEST HAS START TIME                      
         BZ    FIXTIM10                NO - SHOULDN'T HAPPEN, BUT ...           
*                                                                               
         AHI   R0,1                THIS ONE GETS SORTED                         
*                                                                               
         SR    RE,RE               ADJUST TO 0600-3000 CLOCK                    
         ICM   RE,3,PATSTIM                                                     
         CHI   RE,2400             FOR CALENDAR DAYS                            
         BNE   *+8                                                              
         AHI   RE,-2400            MIDNIGHT BECOMES ZERO                        
         STCM  RE,3,PATSTIM                                                     
         B     FIXTIM4                                                          
*                                                                               
FIXTIM10 CHI   R0,1                                                             
         BNH   FIXTIM12                                                         
*                                                                               
         GOTO1 XSORT,DMCB,,(R0),L'PATENT,2,PATSTIM-PATENT                       
*                                                                               
FIXTIM12 L     RE,DMCB                    POINT TO FIRST SORTED ENTRY           
         LA    RF,PATSTIM-PATENT(RE)      POINT TO START TIME                   
         OC    0(2,RF),0(RF)              TEST IT IS ZERO (MIDNIGHT)            
         BNZ   *+10                                                             
         MVC   0(2,RF),=H'2400'           SET IT BACK TO MIDNIGHT               
*                                                                               
         CHI   R0,1                       TEST ONLY ONE ENTRY                   
         BE    FIXTIM20                                                         
*                                                                               
         LA    RE,PATNEXT-PATENT(RE)        POINT TO NEXT ENTRY                 
         OI    PATFLG2-PATENT(RE),PATSMDAY  SET CONT OF DAY FLAG                
         BCT   R0,*-8                                                           
*                                                                               
FIXTIM20 LA    R5,PATNEXT                                                       
*                                                                               
         CLI   0(R5),0                                                          
         BNE   FIXTIM2                                                          
         J     EXIT                                                             
         LTORG                                                                  
         EJECT                                                                  
* FIND FEED DESCRIPTION *                                                       
                                                                                
         USING PRTLINE,R2                                                       
         USING UNTABLED,R3                                                      
RFEED    NTR1  BASE=*,LABEL=*                                                   
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
         BRAS  RE,INITSPT                                                       
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0A2B'                                                  
         MVC   KEY+2(1),BAGYMD                                                  
         MVC   KEY+3(4),SAVNET                                                  
         MVC   KEY+7(2),BCLT                                                    
         MVC   KEY+9(4),SVFEED                                                  
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    RFEED10                                                          
         MVC   KEY(13),KEYSAVE                                                  
         XC    KEY+7(2),KEYSAVE+7  CLEAR CLIENT                                 
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   RFEEDX                                                           
                                                                                
RFEED10  L     R6,AIO2                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
                                                                                
         CLI   24(R6),X'20'        FEED DESCR ELEM                              
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   PFEED+10(60),27(R6)                                              
         CLI   25(R6),63                                                        
         BE    *+10                                                             
         MVC   PFEED+10(60),26(R6)                                              
                                                                                
         L     R3,AUNTABLE                                                      
RFEED11  OC    UNTENT,UNTENT                                                    
         BZ    RFEED16                                                          
         CLC   PATSEQ,UNTSEQ                                                    
         BE    RFEED12                                                          
RFEED11A LA    R3,UNTNEXT                                                       
         B     RFEED11                                                          
                                                                                
RFEED12  TM    UNTFLG,UNTFLNON        FEED NO NATIONAL                          
         BZ    RFEED11A               NO                                        
                                                                                
* LOOK FOR THE END OF THE FEED DESCRIPTION                                      
                                                                                
         LA    RE,PFEED                                                         
         LA    R1,PFEED+60                                                      
RFEED13  CR    R1,RE               REACHED START OF FEED DESC FIELD?            
         BNH   RFEED14              YES                                         
         CLC   0(1,R1),SPACES                                                   
         BH    RFEED14                                                          
         BCT   R1,RFEED13                                                       
                                                                                
RFEED14  MVC   5(19,R1),=C'*** NO NATIONAL ***'                                 
                                                                                
RFEED16  DS    0H                                                               
         BAS   RE,NXL1             GO TO NEXT PRINT LINE OR PRINT               
                                                                                
         LLC   R1,25(R6)                                                        
         LA    R6,24(R1,R6)                                                     
                                                                                
RFEED18  DS   0H                                                                
         CLI   0(R6),X'20'         FEED DESCR ELEM LINE 2                       
         BNE   RFEEDX                                                           
         MVC   PFEED+10(60),3(R6)                                               
         CLI   1(R6),63                                                         
         BE    *+10                                                             
         MVC   PFEED+10(60),2(R6)                                               
         BAS   RE,NXL1             GO TO NEXT PRINT LINE OR PRINT               
                                                                                
         LLC   R1,1(R6)                                                         
         AR    R6,R1                                                            
         B     RFEED18                                                          
                                                                                
RFEEDX   DS   0H                                                                
         L     R6,AIO1             RESTORE AIO ADDRESS                          
         ST    R6,AIO                                                           
         XIT1  REGS=(R2)                                                        
         DROP  R3                                                               
                                                                                
* INCREMENT TO NEXT LINE AND PRINT IF ALL USED *                                
                                                                                
NXL1     NTR1                                                                   
         MVI   131(R2),0                                                        
         LA    R2,132(,R2)                                                      
         LA    R0,P4                                                            
         CLI   SVTN2PRE,C'Y'       PRINT CLT CML#                               
         BNE   *+8                                                              
         LA    R0,P3                                                            
         CR    R2,R0                                                            
         BNH   NXLX1                                                            
         BRAS  RE,GOSPL                                                         
         MVI   ALLOWLIN,0                                                       
         LA    R2,P                                                             
NXLX1    XIT1  REGS=(R2)                                                        
                                                                                
         LTORG                                                                  
         DROP  R2                                                               
         EJECT                                                                  
* FIND PRODUCT NAME *                                                           
                                                                                
FPRDN    NTR1  BASE=*,LABEL=*                                                   
                                                                                
         BRAS  RE,INITSPT                                                       
                                                                                
         XC    KEY,KEY                                                          
         MVC   KEY+1(1),BAGYMD                                                  
         MVC   KEY+2(2),BCLT                                                    
         MVC   KEY+4(3),0(R1)                                                   
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R0,AIO                                                           
         L     R6,AIO3                                                          
         LA    R6,4000(R6)         READ TO IO3+4000                             
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         ST    R0,AIO              RESTORE CALLER'S AIO VALUE!                  
*                                                                               
         USING PRDHDRD,R6                                                       
*                                                                               
         MVC   PRDNM(20),PNAME       AND PRODUCT NAME                           
         LA    RE,SVPRDLEN                                                      
         L     RF,AIO3            SVPRDLST                                      
FPRDN10  CLC   0(3,R1),0(RF)                                                    
         BE    FPRDNX                                                           
         OC    0(4,RF),0(RF)                                                    
         BZ    FPRDN14                                                          
         LA    RF,SVPRDENT(,RF)                                                 
         BCT   RE,FPRDN10                                                       
         DC    H'0'                                                             
FPRDN14  DS   0H                                                                
         MVC   0(3,RF),0(R1)                                                    
                                                                                
FPRDNX   DS   0H                                                                
         BRAS  RE,INITXSP          BACK TO UNIT FILE                            
         XIT1                                                                   
         LTORG                                                                  
         DROP  R6                                                               
         EJECT                                                                  
*===================================================================            
* COUNT PROGRAMS COVERED, AND IF ONLY 1, PRINT PROGRAM NAME                     
* ON ENTRY R5 POINTS TO PATTERN TABLE ENTRY                                     
*===================================================================            
                                                                                
         USING PATABLED,R5                                                      
         USING UNTABLED,R3                                                      
*                                                                               
CNTPRG   NTR1  BASE=*,LABEL=*                                                   
         L     R0,APNAMTAB                                                      
         L     R1,MXPNAMTB                                                      
         SR    R1,R0                                                            
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         L     R3,AUNTABLE                                                      
         XC    SVPROG,SVPROG                                                    
         SR    R6,R6                                                            
*                                                                               
CNTP02   DS    0H                                                               
         CLC   UNTSEQ,PATSEQ       SAME PATTERN SEQNUM                          
         BNE   CNTP10                                                           
                                                                                
         TM    UNTFLG,UNTXCLUD                                                  
         BO    CNTP10                                                           
                                                                                
         OC    SVPROG,SVPROG                                                    
         BNZ   *+10                                                             
         MVC   SVPROG,UNTPROG      SAVE FIRST PROGRAM NAME                      
*                                                                               
         L     RE,APNAMTAB         ADD CODE TO TABLE                            
*                                                                               
CNTP04   OC    0(6,RE),0(RE)       TEST EOT                                     
         BZ    CNTP06                                                           
         CLC   UNTPROG,0(RE)       TEST MATCH                                   
         BE    CNTP08                                                           
         LA    RE,8(RE)            NEXT ENTRY                                   
         B     CNTP04                                                           
*                                                                               
CNTP06   MVC   0(6,RE),UNTPROG     SAVE PROGRAM CODE                            
         CLI   0(RE),0                                                          
         BNE   *+6                                                              
         DC    H'0'                                                             
         LA    R6,1(R6)            BUMP PROGRAM TABLE COUNTER                   
                                                                                
         LA    R0,8(RE)            ADD TO APNAMTAB                              
         C     R0,MXPNAMTB                                                      
         BL    *+6                                                              
         DC    H'0'                RAN OUT OF PROGRAM NAME TABLE                
*                                                                               
CNTP08   LH    RF,6(RE)            GET UNIT COUNT                               
         SR    R0,R0                                                            
         ICM   R0,3,UNTCT                                                       
         AR    R0,RF                                                            
         STCM  R0,3,6(RE)          BUMP UNIT COUNT                              
*                                                                               
CNTP10   LA    R3,UNTNEXT                                                       
         OC    UNTENT,UNTENT       TEST MORE UNITS                              
         BNZ   CNTP02                                                           
                                                                                
         STH   R6,NAMTABCT         SAVE UNIT COUNT                              
         XIT1                                                                   
         DROP  R3,R5                                                            
         LTORG                                                                  
         EJECT                                                                  
* FIND COMMERCIAL TITLE *                                                       
                                                                                
         USING PRTLINE,R2                                                       
FCML     NTR1  BASE=*,LABEL=*                                                   
                                                                                
         XC    SVHIDEF,SVHIDEF                                                  
         XC    SVCNTRC,SVCNTRC                                                  
         XC    SVCMCLTN,SVCMCLTN                                                
         XC    SVCMLDS2,SVCMLDS2                                                
         XC    SVCMLDS3,SVCMLDS3                                                
         XC    SVCMLOVR,SVCMLOVR                                                
         XC    SVADISCI,SVADISCI                                                
*                                                                               
         XC    SVCMLOPT,SVCMLOPT                                                
         MVI   ADIDFLAG,0          INIT CML IS AN ADID FLAG                     
         MVC   SVCMLOPT,SVCMLCOD   PRESET OPTICA COMML                          
*                                                                               
         BRAS  RE,INITSPT          SET TO SPOT                                  
                                                                                
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING CMLKEY,R4                                                        
         MVC   CMLKID,=X'0A21'                                                  
         MVC   CMLKAM(3),BAGYMD AND BCLT                                        
         MVC   CMLKCML,SVCMLCOD                                                 
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    FCML04                                                           
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE KEY                                  
         MVI   KEY+1,X'C1'         READ 0AC1 KEY                                
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         DROP  R4                                                               
*                                                                               
*                                                                               
* IF 8 CHAR ISCI THEN UNPACK AND USE IT                                         
*                                                                               
         GOTO1 VTRPACK,DMCB,(C'U',SVCMLCOD),SVADISCI                            
         CLI   SVADISCI+8,C' '                                                  
         BH    FCML04                                                           
         MVC   SVCMLCOD,SVADISCI   USE 8 CHAR ISCII                             
         MVC   SVCMLOPT,SVCMLCOD                                                
*                                                                               
FCML04   L     R6,AIO2                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
                                                                                
         TM    ANYFLAG,CLTCMLNO    JUST GET CLT CML #                           
         BO    *+10                                                             
         XC    SVCMLADI,SVCMLADI                                                
                                                                                
         XC    SVCMLADR,SVCMLADR                                                
                                                                                
         USING CMLADIEL,R6                                                      
         MVI   ELCODE,X'A0'        ADID ELEMENT                                 
         BRAS  RE,GETEL                                                         
         BNE   FCML06                                                           
                                                                                
         TM    ANYFLAG,CLTCMLNO    JUST GET CLT CML #                           
         BZ    *+14                                                             
         MVC   SVCMLADR,2(R6)                                                   
         B     FCML06                                                           
                                                                                
         MVC   SVCMLADI,2(R6)      SAVE PRINTABLE ADID                          
         MVC   SVCMLOPT,CMLADIDP   SAVE PACKED ADID FROM ELEM                   
         OI    ADIDFLAG,ADIDSW                                                  
                                                                                
FCML06   DS    0H                                                               
         XC    FLD,FLD                                                          
         LA    R1,FLD                                                           
         USING CMLCMLD,R1                                                       
                                                                                
         L     R6,AIO                                                           
         MVI   ELCODE,X'24'                                                     
         BRAS  RE,GETEL                                                         
         BNE   FCML06F                                                          
         USING CMLXDTEL,R6                                                      
         CLC   CMLXHDEF,SPACES                                                  
         BNH   *+10                                                             
         MVC   SVHIDEF,CMLXHDEF    SAVE HIDEF                                   
         CLC   CMLXCNTR,SPACES                                                  
         BNH   *+10                                                             
         MVC   SVCNTRC,CMLXCNTR    SAVE CENTRCUT                                
                                                                                
         CLI   CMLXSWAP,C'Y'       SWAP HIDEF AND CNTRCUT                       
         BNE   FCML06C                                                          
         XC    SVCNTRC,SVHIDEF                                                  
         XC    SVHIDEF,SVCNTRC                                                  
         XC    SVCNTRC,SVHIDEF                                                  
                                                                                
FCML06C  DS    0H                                                               
         MVC   CMLDDT,CMLXDSDT     SAVE CML DESTROY TIME                        
         MVC   CMLDTM,CMLXDSTM     AND DATE                                     
         DROP  R6                                                               
*                                                                               
FCML06F  DS    0H                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         USING CMLDTAEL,R6                                                      
         TM    CMLSTAT,X'40'    ANY COMTEXT                                     
         BZ    *+8                                                              
         MVI   CMLTXT,C'Y'         COMTEXT PRESENT                              
                                                                                
         XC    CMLTYP,CMLTYP                                                    
         CLI   SVTN1PR6,C'S'       SUPPRESS TYPE                                
         BE    FCML06J                                                          
                                                                                
         CLI   SVTN1PR6,C'Y'       SUPPRESS TYPE                                
         BE    FCML06J                                                          
         MVC   CMLTYP,CMLTYPE      SAVE CML TYPE                                
         DROP  R1                                                               
                                                                                
FCML06J  DS    0H                                                               
         TM    ANYFLAG,CLTCMLNO    JUST GET CLT CML #                           
         BZ    *+14                                                             
         MVC   SVCTCMLR,CMLCLTNO   CLT CML # FOR ROTATION                       
         B     FCML60                                                           
                                                                                
         MVC   SVCMCLTN,CMLCLTNO                                                
         MVC   SVCMLLEN,CMLSLN                                                  
         MVC   SVCMLOVR,CMLOVRD1   SAVE CMLOVRD1 & CMLOVRD2                     
         TM    CMLSTAT,X'80'       TEST DELETED COMMERCIAL                      
         BO    FCML30                                                           
                                                                                
         USING PATABLED,R5                                                      
                                                                                
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,PATSTR),(3,DUB)                                   
         FIXDT02                                                                
         GOTO1 (RF),(R1),(2,PATEND),(3,DUB+3)                                   
*SM                                                                             
         MVC   SVCMLSTR,CMLRLSE                                                 
         MVC   SVCMLEND,CMLRCL                                                  
*SM                                                                             
         CLC   CMLRLSE,DUB+3       SEE IF CML COVERS PATTERN                    
         BH    FCML30                                                           
         CLC   CMLRCL,DUB                                                       
         BL    FCML30                                                           
                                                                                
         MVC   SVCMLDS(15),CMLTITLE                                             
                                                                                
FCML20   MVI   ELCODE,X'30'                                                     
         BRAS  RE,NEXTEL                                                        
         BNE   FCML60                                                           
                                                                                
         MVC   SVCMLDS,3(R6)       DESCRIPTION 1                                
                                                                                
         BRAS  RE,NEXTEL                                                        
         BNE   FCML60                                                           
         MVC   SVCMLDS2,3(R6)                                                   
         BRAS  RE,NEXTEL                                                        
         BNE   FCML60                                                           
         MVC   SVCMLDS3,3(R6)                                                   
         B     FCML60                                                           
                                                                                
FCML30   MVC   SVCMLCOD,=CL8'NO COMML'                                          
         XC    SVHIDEF,SVHIDEF                                                  
         XC    SVCNTRC,SVCNTRC                                                  
         XC    SVCMCLTN,SVCMCLTN                                                
         B     FCMLXIT                                                          
*                                                                               
* ADD CML TO TABLE FOR OPTICA.                                                  
*                                                                               
FCML60   XC    WORK+10(CMLTBLLN),WORK+10                                        
         LA    R4,WORK+10                                                       
         USING CMLTBLD,R4                                                       
*                                                                               
         MVC   CMLSHCML,SVCMLOPT                                                
         MVC   CMLFLAG,ADIDFLAG    ADID FLAG IF ANY                             
*                                                                               
         LA    RE,PATSTR           POINT TO UNIT DATES                          
         CLI   SVTN2PRO+10,C'Y'                                                 
         BNE   *+8                                                              
         LA    RE,PATPSTR          PATTERN DATES                                
         LR    R0,RE               SAVE DATE POINTER IN R0!                     
*                                                                               
         MVC   SVTDTE,0(RE)        SAVE FTD/LTD                                 
*                                                                               
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,SVFTD),(3,CMLFTD)                                 
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,SVLTD),(3,CMLLTD)                                 
*                                                                               
         MVC   CMLPRO1,SVPROD                                                   
         MVC   CMLPRO2,SVPROD2                                                  
*                                                                               
FCML61   GOTO1 =V(BINSRCH),BINPAR7,(1,WORK+10),RR=SPTR50RR                      
         L     R3,0(R1)                                                         
         LTR   R3,R3                                                            
         BNZ   *+6                                                              
         DC    H'0'            *TABLE FULL                                      
*                                                                               
         CLI   0(R1),1             WAS RECORD ADDED TO BINTABLE                 
         BE    FCMLX               YES                                          
*                                                                               
         L     R3,0(R1)            A(RECORD IN BIN TABLE)                       
B        USING CMLTBLD,R3                                                       
*                                                                               
         MVC   B.CMLLTD,CMLLTD     EXPAND LTD IF NEEDED                         
         BNL   *+10                                                             
         MVC   B.CMLLTD,CMLLTD                                                  
*                                                                               
         DROP  B,R4                                                             
*                                                                               
FCMLX    DS    0H                                                               
         OC    FLD,FLD             ANY CML ADDITIONAL INFO                      
         BZ    FCMLX1                                                           
         OI    SVFLAG,SEEMORFL     PRINT SEE ADDITIONAL CML MSG                 
                                                                                
         LA    R3,FLD                                                           
         USING CMLCMLD,R3                                                       
         MVC   CMLCML8,SVCMLCOD    SAVE 8 CHAR ISCII                            
         MVC   CMLCML,SVCMLADI     PRESET TO ADID                               
         OC    SVCMLADI,SVCMLADI   ANY ADID                                     
         BNZ   *+10                                                             
         MVC   CMLCML,SVCMLCOD     ELSE SAVE 8 CHAR ISCII                       
         MVC   CMLPRD,SVPRD                                                     
         GOTO1 =V(BINSRCH),BINDMCB,(1,(R3)),RR=SPTR50RR                         
         L     R3,0(R1)                                                         
         LTR   R3,R3                                                            
         BNZ   *+6                                                              
         DC    H'0'            *TABLE FULL                                      
         DROP  R3                                                               
                                                                                
FCMLX1   DS    0H                                                               
         MVC   FLD,SPACES          CLEAR SAVE AREA                              
                                                                                
         L     R6,AIO                                                           
         MVI   ELCODE,X'B0'        COMMERCIAL RUN TIMES                         
         BRAS  RE,GETEL                                                         
         BNE   FCMLXIT                                                          
                                                                                
         USING CMLMATEL,R6                                                      
         CLC   =X'0000FFFF',CMLMSTIM  IF NO START OR END TIME                   
         BE    FCMLXIT             THEN DONE                                    
                                                                                
         CLC   =X'0000',CMLMSTIM   START TIME ?                                 
         BE    FCMLXIT              NO, DONE                                    
                                                                                
         TM    CMLMFLAG,X'80'      CHECK TIMES DAILY ?                          
         BZ    FCMLX2               NO                                          
                                                                                
         CLI   SVT3PROF+2,C'Y'      IF PROFILE IS N DO NOT PRINT                
         BNE   FCMLX2               COMMERCIAL TIMES                            
                                                                                
         XC    DUB,DUB                                                          
                                                                                
         CLC   CMLMETIM,=X'FFFF'   NO END TIME ?                                
         BNE   *+14                 END TIME IS SET                             
         MVC   DUB(2),CMLMSTIM                                                  
         B     *+10                                                             
         MVC   DUB(4),CMLMSTIM                                                  
                                                                                
         LA    R3,DUB                                                           
         ST    R3,DMCB                                                          
         LA    R2,P                                                             
         GOTO1 UNTIME,DMCB,,PCMLRUN                                             
                                                                                
         LA    R3,PCMLRUN                                                       
         CLI   0(R3),X'40'                                                      
         BNH   *+12                                                             
         LA    R3,1(R3)                                                         
         B     *-12                                                             
                                                                                
         MVC   1(5,R3),=C'DAILY'                                                
         B     FCMLXIT                                                          
                                                                                
FCMLX2   DS    0H                                                               
         LA    R2,P                                                             
         CLI   SVT3PROF+2,C'Y'                                                  
         BNE   FCMLXIT                                                          
*SM                                                                             
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(3,SVCMLSTR),(2,WORK+60)  RELEASE DTE                
         FIXDT02                                                                
         GOTO1 (RF),(R1),(3,SVCMLEND),(2,WORK+62)    RECALL DTE                 
*                                                                               
         CLC   WORK+60(2),PATSTR  IF CML ST DTE IS BEFORE PAT STR               
         BL    FCMLX3             DO NOT PRINT ST TIME                          
*SM                                                                             
         LA    R3,PCMLRUN                                                       
         MVC   0(8,R3),=C'RUN FROM'                                             
         LA    R3,9(R3)                                                         
                                                                                
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,PATSTR),(4,0(R3))                                 
                                                                                
         LA    R3,5(R3)                                                         
         CLI   0(R3),X'40'                                                      
         BH    *+6                                                              
         BCTR  R3,0                                                             
         MVI   1(R3),C'-'                                                       
                                                                                
         XC    DUB,DUB                                                          
         MVC   DUB(2),CMLMSTIM                                                  
         GOTO1 UNTIME,DMCB,DUB,2(R3)                                            
                                                                                
FCMLX3   CLC   =X'FFFF',CMLMSTIM+2 END TIME ?                                   
         BE    FCMLXIT             NONE                                         
*SM                                                                             
         CLC   WORK+62(2),PATEND  IF CML END DTE IS AFTER PAT END               
         BH    FCMLXIT            DO NOT PRINT ST TIME                          
*SM                                                                             
         LA    R2,P2                                                            
         LA    R3,PCMLRUN+3                                                     
         MVC   0(5,R3),=C'UNTIL'                                                
                                                                                
         LA    R3,6(R3)                                                         
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(2,PATEND),(4,0(R3))                                 
         LA    R3,5(R3)                                                         
         CLI   0(R3),X'40'                                                      
         BH    *+6                                                              
         BCTR  R3,0                                                             
         MVI   1(R3),C'-'                                                       
                                                                                
         XC    DUB,DUB                                                          
         MVC   DUB(2),CMLMSTIM+2                                                
         GOTO1 UNTIME,DMCB,DUB,2(R3)                                            
                                                                                
FCMLXIT  XIT1                                                                   
                                                                                
* CONVERSION OF CML TYPE TO PRINTABLE TYPE *                                    
                                                                                
TYPTABLE DC    CL4'CLR ',CL11'CLR/VTR    '                                      
         DC    CL4'SC  ',CL11'SLIDE COPY '                                      
         DC    CL4'CPY ',CL11'COPY       '                                      
         DC    CL4'ABB ',CL11'AUDIO BB   '                                      
         DC    CL4'SSL ',CL11'SUPER SLIDE'                                      
         DC    CL4'CSL ',CL11'COLOR SLIDE'                                      
         DC    CL4'FBB ',CL11'FILM BB    '                                      
TYPTABCT EQU   (*-TYPTABLE)/20                                                  
         DC    CL4'XXXX',CL16'UNKNOWN TYPE'                                     
                                                                                
         DROP  R2,R5                                                            
         LTORG                                                                  
         EJECT                                                                  
* PRINT COMMENTS FOR THIS PROGRAM *                                             
*                                                                               
* EXPECTS:  AIO3 - SVPRDLST                                                     
*           SVCLIST                                                             
*                                                                               
* USES:     AIO1 - COMMENT REC (DTXRECD)                                        
*                - PRODUCT REC                                                  
*           R4   - KEY, COMMENT REC POINTER                                     
*           R5   - AIO3 (SVPRDLST)                                              
*                                                                               
                                                                                
PCOM     NTR1  BASE=*,LABEL=*                                                   
                                                                                
         NI    SVOPTSW1,X'FF'-(USEDEF+PRNTDCMT)  RSET OPTS USED IN PCOM         
         L     R5,AIO3             SVPRDLST                                     
         MVC   AIO,AIO1                                                         
                                                                                
         BRAS  RE,INITXSP          SET TO XSPOT FILE                            
                                                                                
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING DT2RECD,R4                                                       
PCOM10   MVC   DT2KID,=X'0A2D'                                                  
         MVC   DT2KAM,BAGYMD                                                    
         MVC   DT2KCLT,BCLT                                                     
         MVC   DT2KMED,SVMEDIA                                                  
         MVC   DT2KNET,SAVNET                                                   
*                                                                               
         OC    0(3,R5),0(R5)       ANY MORE PRODUCTS?                           
         BZ    PCOM90               NO                                          
*                                                                               
         MVC   DT2KPRD,0(R5)                                                    
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
                                                                                
         CLC   KEY(13),KEYSAVE     DID WE FIND NET/PRD REC?                     
         BE    PCOM20               YES - USE IT                                
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE KEY                                  
         XC    DT2KNET,DT2KNET                                                  
         GOTO1 HIGH                                                             
                                                                                
         CLC   KEY(13),KEYSAVE     DID WE FIND MEDIA/PRD REC?                   
         BE    PCOM20               YES - USE IT                                
         OI    SVOPTSW1,USEDEF     SET FLAG TO PRINT A DEFAULT COMMENT          
         B     PCOM80                                                           
*                                                                               
PCOM20   DS   0H                                                                
         TM    SVOPTSW1,PRNTDCMT   ALREADY PRINTED COMMENTS?                    
         BNZ   PCOM30               YES                                         
         MVI   P,C'*'                                                           
         MVC   P+1(79),P           PRE-FILL PRINT LINE WITH *'S                 
         MVC   P+4(19),=C' START OF COMMENTS '                                  
         OI    SVOPTSW1,PRNTDCMT                                                
         BRAS  RE,GOSPL                                                         
*                                                                               
PCOM30   DS   0H                                                                
         LA    R1,P+3                                                           
         MVC   0(13,R1),=C'*COMMENT FOR '                                       
         LA    R1,13(R1)                                                        
         OC    DT2KNET,DT2KNET     WAS THIS MEDIA OR NET SPECIFIC?              
         BZ    PCOM40               MEDIA OR CLIENT                             
         MVC   0(4,R1),DT2KNET                                                  
         CLI   3(R1),C' '                                                       
         BNE   *+12                                                             
         LA    R1,3(R1)                                                         
         B     *+8                                                              
         LA    R1,4(R1)                                                         
         MVC   0(2,R1),=C', '                                                   
         LA    R1,2(R1)                                                         
         B     PCOM60                                                           
*                                                                               
PCOM40   DS   0H                                                                
         CLI   DT2KMED,0           WAS THIS MEDIA SPEC OR CLIENT?               
         BZ    PCOM50                                                           
                                                                                
         CLI   DT2KMED,C'C'                                                     
         BNE   *+18                                                             
         MVC   0(7,R1),=C'CABLE, '                                              
         LA    R1,7(R1)                                                         
         B     PCOM60                                                           
                                                                                
         CLI   DT2KMED,C'S'                                                     
         BNE   *+18                                                             
         MVC   0(13,R1),=C'SYNDICATION, '                                       
         LA    R1,13(R1)                                                        
         B     PCOM60                                                           
                                                                                
         CLI   DT2KMED,C'N'                                                     
         BNE   *+18                                                             
         MVC   0(9,R1),=C'NETWORK, '                                            
         LA    R1,9(R1)                                                         
         B     PCOM60                                                           
                                                                                
*MNV                                                                            
         CLI   DT2KMED,C'V'                                                     
         BNE   *+18                                                             
         MVC   0(7,R1),=C'OTHER, '                                              
         LA    R1,7(R1)                                                         
         B     PCOM60                                                           
*MNV                                                                            
                                                                                
         CLI   DT2KMED,C'O'                                                     
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   0(7,R1),=C'OTHER, '                                              
         LA    R1,7(R1)                                                         
         B     PCOM60                                                           
*                                                                               
PCOM50   DS   0H                                                                
         MVC   0(07,R1),=C'CLIENT '                                             
         MVC   7(03,R1),QCLT                                                    
         LA    R1,11(R1)                                                        
         B     PCOM70              CAN'T BE PRD FOR CLT LEVEL COMMENT           
*                                                                               
PCOM60   DS   0H                                                                
         CLI   DT2KPRD,0           PRD SPECIFIC?                                
         BNE   *+16                 YES                                         
         BCTR  R1,0                                                             
         BCTR  R1,0                                                             
         MVI   0(R1),C' '          CLEAR ','                                    
         B     PCOM70                                                           
*                                                                               
         BAS   RE,PCFPRD           GET PRD NAME                                 
         MVC   0(8,R1),=C'PRODUCT '                                             
         LA    R1,8(R1)                                                         
         L     RF,AIO1                                                          
         MVC   0(L'PNAME,R1),PNAME-PRDHDRD(RF)                                  
         OC    0(L'PNAME,R1),SPACES                                             
         LA    R1,L'PNAME(R1)                                                   
         CLI   0(R1),C' '          FIND LAST PRINTED CHAR                       
         BNE   *+10                                                             
         BCTR  R1,0                                                             
         B     *-10                                                             
         MVC   1(2,R1),=C' ('                                                   
         MVC   3(3,R1),0(R5)       PRD CODE                                     
         CLI   5(R1),C' '                                                       
         BNE   *+12                                                             
         MVI   5(R1),C')'                                                       
         B     *+8                                                              
         MVI   6(R1),C')'                                                       
                                                                                
PCOM70   BRAS  RE,GOSPL                                                         
                                                                                
         BRAS  RE,INITXSP          SET TO XSPOT                                 
         GOTO1 GETREC                                                           
                                                                                
         MVI   BYTE,C'C'           COMMENT RECORD                               
         BRAS  RE,PRNCMT           NOW GO PRINT COMMENTS                        
                                                                                
         CLI   DT2KPRD,0           DID WE JUST PRINT A DEFAULT COMMENT?         
         BE    PCOMX                YES - WE'RE DONE                            
                                                                                
PCOM80   LA    R5,SVPRDENT(R5)     NEXT ENTRY IN PRD LST                        
         B     PCOM10                                                           
                                                                                
PCOM90   DS   0H                                                                
         CLI   SVTN1PR7,C'Y'       PRINT DEFAULT COMMENTS AS WELL               
         BE    PCOM94                                                           
                                                                                
         TM    SVOPTSW1,USEDEF     DEFAULT COMMENT REQUIRED?                    
         BZ    PCOMX                NO                                          
                                                                                
PCOM94   DS   0H                                                                
         XC    KEY,KEY                                                          
         MVC   DT2KID,=X'0A2D'                                                  
         MVC   DT2KAM,BAGYMD                                                    
         MVC   DT2KCLT,BCLT                                                     
         MVC   DT2KMED,SVMEDIA                                                  
         MVC   DT2KNET,SAVNET                                                   
         XC    DT2KPRD,DT2KPRD                                                  
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
                                                                                
         CLC   KEY(13),KEYSAVE     DO WE HAVE A NET SPEC?                       
         BE    PCOM20               YES                                         
         MVC   KEY,KEYSAVE                                                      
         XC    DT2KNET,DT2KNET                                                  
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
                                                                                
         CLC   KEY(11),KEYSAVE     DO WE HAVE A MEDIA SPEC?                     
         BE    PCOM20               YES                                         
         MVC   KEY,KEYSAVE                                                      
         MVI   DT2KMED,0                                                        
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
                                                                                
         CLC   KEY(13),KEYSAVE     DO WE HAVE A CLIENT SPEC?                    
         BE    PCOM20                                                           
*                                                                               
PCOMX    DS   0H                                                                
         TM    SVOPTSW1,PRNTDCMT   ANY CMTS PRINTED?                            
         BZ    PCOMXIT              NO                                          
         MVI   P,C'*'                                                           
         MVC   P+1(79),P           PRE-FILL PRINT LINE WITH *'S                 
         MVC   P+4(17),=C' END OF COMMENTS '                                    
         BRAS  RE,GOSPL                                                         
                                                                                
PCOMXIT  DS    0H                                                               
         BRAS  RE,INITSPT                                                       
         XIT1                                                                   
         EJECT                                                                  
* FIND PRODUCT NAME *                                                           
*                                                                               
* EXPECTS R5 - A(PRD CODE)                                                      
* RETURNS PRD REC IN AIO (S.B. AIO1 IF CALLED FROM PCOM)                        
* NOTE: KEY IS RESTORED FOR SEQ                                                 
*                                                                               
                                                                                
PCFPRD   NTR1                                                                   
         BRAS  RE,INITSPT                                                       
                                                                                
         MVC   SAVEKEY(32),KEY     SAVE OFF KEY                                 
         XC    KEY,KEY                                                          
         MVC   KEY+1(1),BAGYMD                                                  
         MVC   KEY+2(2),BCLT                                                    
         MVC   KEY+4(3),0(R5)                                                   
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
                                                                                
         BRAS  RE,INITXSP          SET TO XSPOT                                 
         MVC   KEY(32),SAVEKEY     RESTORE KEY                                  
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                RESTORE SEQ                                  
                                                                                
         B     PCOMXIT                                                          
         EJECT                                                                  
* PRINT COMMENT REC & ANY PAGES                                                 
                                                                                
         DS   0H                                                                
                                                                                
PRNCMT   NTR1  BASE=*,LABEL=*                                                   
                                                                                
         MVC   SAVEKEY(32),KEY     SAVE KEY                                     
                                                                                
PRNCMT10 L     R6,AIO                                                           
         MVI   ELCODE,X'40'                                                     
         BRAS  RE,GETEL                                                         
         USING DTXTXTEL,R6                                                      
         BE    *+6                                                              
         DC    H'0'                                                             
PRNCMT20 LA    R0,4                                                             
         LA    R1,P+7                                                           
PRNCMT30 LLC   RF,DTXTXTLN                                                      
         SH    RF,=H'4'            GET TEXT LEN-1                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),DTXTXT                                                   
         CLC   0(132,R1),SPACES    IF STILL BLANK LINE                          
         BNE   *+8                                                              
         MVI   0(R1),0             FORCE LINE TO PRINT                          
PRNCMT35 BRAS  RE,NEXTEL                                                        
         BNE   PRNCMT40                                                         
         LA    R1,132(R1)                                                       
         BCT   R0,PRNCMT30                                                      
         BRAS  RE,GOSPL                                                         
         B     PRNCMT20                                                         
PRNCMT40 BRAS  RE,GOSPL                                                         
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
                                                                                
         CLI   BYTE,C'C'           COMMENT RECORD                               
         BNE   PRNCMT50             NO, STEXT RECORD                            
                                                                                
         CLC   KEY(31),KEYSAVE                                                  
         BNE   PCX                                                              
         B     *+14                                                             
PRNCMT50 CLC   KEY(11),KEYSAVE                                                  
         BNE   PCX                                                              
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         B     PRNCMT10                                                         
                                                                                
PCX      MVC   KEY(32),SAVEKEY     RESTORE KEY                                  
         XIT1                                                                   
         DROP  R4,R6                                                            
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
* PRINT SPECIAL COMMENT AT THE END OF THE REPORT                                
                                                                                
PSTEXT   NTR1  BASE=*,LABEL=*                                                   
         BRAS  RE,INITSPT                                                       
                                                                                
         MVC   AIO,AIO1                                                         
                                                                                
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING DTXRECD,R4                                                       
         MVC   DTXKID,=X'0A2D'                                                  
         MVC   DTXKAM,BAGYMD                                                    
         MVI   DTXKCLT,C'*'        CLT=OFFICE                                   
         MVC   DTXKCLT+1(1),SVCLTOFF                                            
         MVI   DTXKTYP,C'L'        LIVE TEXT (BODY)                             
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
                                                                                
         CLC   KEY(13),KEYSAVE     ANY STEXT FOR THIS OFFICE                    
         BNE   PSTEXTX              NO, DONE                                    
                                                                                
         MVI   P,0                                                              
         BRAS  RE,GOSPL                                                         
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
                                                                                
         MVI   BYTE,C'S'           STEXT                                        
         BRAS  RE,PRNCMT              NOW GO PRINT COMMENTS                     
                                                                                
PSTEXTX  XIT1                                                                   
                                                                                
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
* PRINT COMMENTS ENTERED ON SCREEN AT THE TIME OF REQUEST                       
*                                                                               
PCOMMENT NTR1  BASE=*,LABEL=*                                                   
         MVI   P,0                                                              
         BRAS  RE,GOSPL                                                         
         LA    R1,P+7                                                           
*                                                                               
         LA    R2,TRACMT1H                                                      
PSCMT10  CLI   5(R2),0             ANY ENTRY                                    
         BE    PSCMT20                                                          
*                                                                               
         LLC   R5,5(R2)                                                         
         BCTR  R5,0                                                             
         EX    R5,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),8(R2)       MOVE COMMENT TO PRINT                        
         LA    R1,132(R1)          BUMP TO NEXT PRINT LINE                      
*                                                                               
PSCMT20  LLC   R0,0(R2)            NEXT FIELD                                   
         AR    R2,R0                                                            
         LA    RF,TRACMT4H                                                      
         CR    R2,RF               TEST PAST LAST COMMENT LINE?                 
         JH    PSCMT30                                                          
         LLC   R0,0(R2)            NEXT FIELD                                   
         AR    R2,R0                                                            
         B     PSCMT10                                                          
*                                                                               
PSCMT30  LA    R2,P2                                                            
         CR    R1,R2               ANYTHING TO PRINT?                           
         JL    EXIT                                                             
         BRAS  RE,GOSPL                                                         
         J     EXIT                                                             
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*====================================================                           
* PRINT ADDITIONAL COMMERCIAL INFORMATION                                       
*====================================================                           
                                                                                
PACML    NTR1  BASE=*,LABEL=*                                                   
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
                                                                                
         MVI   P,0                                                              
         BRAS  RE,GOSPL                                                         
                                                                                
         MVI   ALLOWLIN,3                                                       
         MVC   P+2(33),=C'ADDITIONAL COMMERCIAL INFORMATION'                    
         MVC   P2+2(33),=C'---------------------------------'                   
         BRAS  RE,GOSPL                                                         
                                                                                
         L     R4,ACMLTAB                                                       
         MVC   FULL,BINDMCB+8                                                   
         L     R1,FULL                                                          
                                                                                
PACML05  DS    0H                                                               
         ST    R1,FULL                                                          
         LA    R2,P                                                             
         USING PRTLINE,R2                                                       
*                                                                               
         USING CMLCMLD,R4                                                       
         MVC   PACMML,CMLCML       PRINT COMMERCIAL                             
                                                                                
         LA    R5,PTATYPE                                                       
         OC    CMLTYP,CMLTYP                                                    
         BZ    PACML08                                                          
                                                                                
         MVC   0(6,R5),=C'TYPE= '                                               
         MVC   6(L'CMLTYP,R5),CMLTYP                                            
         LA    R5,PADDTE                                                        
                                                                                
PACML08  OC    CMLDDT,CMLDDT                                                    
         BZ    PACML10                                                          
         MVC   0(18,R5),=C'DESTROY DATE/TIME='                                  
                                                                                
         GOTO1 DATCON,DMCB,(3,CMLDDT),(5,23(R5))                                
         XC    WORK,WORK                                                        
         MVC   WORK(2),CMLDTM                                                   
         GOTO1 UNTIME,DMCB,WORK,36(R5)                                          
                                                                                
PACML10  DS    0H                                                               
         OC    CMLTYP,CMLTYP                                                    
         BNZ   PACML15                                                          
         OC    CMLDDT,CMLDDT                                                    
         BZ    PACML20                                                          
PACML15  DS    0H                                                               
         BRAS  RE,GOSPL                                                         
                                                                                
PACML20  DS    0H                                                               
         CLI   CMLTXT,C'Y'         ANY TEXT FOR THIS CML                        
         BNE   PACML50             NO, GET NEXT CML IF ANY                      
                                                                                
         LA    R5,KEY                                                           
         USING CMXKEY,R5                                                        
         XC    KEY,KEY                                                          
         MVC   CMXKID,=X'0A35'                                                  
         MVC   CMXKAM(3),BAGYMD    MEDIA/CLIENT                                 
         MVC   CMXKPROD,CMLPRD     PROD                                         
         MVC   CMXKNET,NETWORK     NETWORK                                      
         MVC   CMXKCML,CMLCML8     8 CHAR ISCII                                 
         MVC   KEYSAVE,KEY                                                      
         BAS   RE,RDHI                                                          
         BE    CMLL23                                                           
                                                                                
         MVC   KEY,KEYSAVE                                                      
         XC    CMXKNET,CMXKNET     CLEAR NETWORK                                
         MVC   KEYSAVE,KEY         MED/CLT/PROD/CML                             
         BAS   RE,RDHI                                                          
         BE    CMLL23                                                           
                                                                                
         MVC   KEY,KEYSAVE                                                      
         XC    CMXKPROD,CMXKPROD   CLEAR PROD                                   
         MVC   CMXKNET,NETWORK     RESTORE NETWORK                              
         MVC   KEYSAVE,KEY         MED/CLT/CML                                  
         BAS   RE,RDHI                                                          
         BE    CMLL23                                                           
                                                                                
         MVC   KEY,KEYSAVE                                                      
         XC    CMXKPROD,CMXKPROD   CLEAR PROD                                   
         XC    CMXKNET,CMXKNET     CLEAR NETWORK                                
         MVC   KEYSAVE,KEY         MED/CLT/CML                                  
         BAS   RE,RDHI                                                          
         BE    CMLL23                                                           
         B     PACML50                                                          
                                                                                
CMLL23   GOTO1 DATAMGR,DMCB,=C'GETREC',=C'XSPFILE ',KEY+36,AIO1,DMWORK          
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R6,AIO1                                                          
         LA    R6,42(R6)                                                        
CMLL23B  CLI   0(R6),X'40'                                                      
         BE    CMLL23D                                                          
         BH    PACML50                                                          
CMLL23C  LLC   R1,1(R6)                                                         
         LTR   R1,R1                                                            
         BZ    PACML50                                                          
         AR    R6,R1                                                            
         B     CMLL23B                                                          
CMLL23D  LLC   R1,1(R6)            GET LENGTH OF TEXT                           
         SHI   R1,4                ID/LEN/LINE#/MVC                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   PACMTXT(0),3(R6)    PRINT TEXT                                   
         BRAS  RE,GOSPL                                                         
         B     CMLL23C             MORE TEXT LINES ?                            
                                                                                
PACML50  LA    R4,CMLNXT(R4)                                                    
         L     R1,FULL                                                          
         BCT   R1,PACML05                                                       
                                                                                
PACMLX   XIT1                                                                   
                                                                                
RDHI     NTR1                                                                   
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'XSPDIR  ',KEY,KEY,0                   
         CLC   KEY(32),KEYSAVE                                                  
         J     EXIT                                                             
         DROP  R4                                                               
                                                                                
         LTORG                                                                  
         EJECT                                                                  
*===========================================================                    
* GET DETAILS ON NETWORK - OR INDICATE NOT OKAY                                 
*===========================================================                    
                                                                                
GNET     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVI   KEY,C'0'                                                         
         MVC   KEY+1(16),KEY       PRE-FILL THE KEY WITH ZEROES                 
         LA    R4,KEY                                                           
         USING STARECD,R4                                                       
         MVI   STAKTYPE,C'S'                                                    
         MVI   STAKMED,C'N'                                                     
         MVC   STAKCALL(4),SAVNET                                               
         MVI   STAKCALL+4,C'N'                                                  
         MVC   STAKAGY,AGENCY                                                   
         MVC   STAKCLT,BCLT                                                     
         GOTO1 DATAMGR,DMCB,=C'DMREAD',=C'STATION',KEY,AIO                      
         CLI   8(R1),0                                                          
         BNE   NETERR                                                           
                                                                                
         L     R4,AIO                                                           
         CLC   KEY(9),0(R4)                                                     
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         MVC   SVSMKT,SMKT         SAVE MARKET CODE                             
         PACK  DUB,SMKT                                                         
         CVB   R0,DUB                                                           
         STH   R0,NETMKT                                                        
                                                                                
         MVC   SVSFAX,SFAX         SAVE FAX NUMBER FROM MASTER                  
         MVC   SVMEDIA,STRTYPE     SAVE TRAFFIC TYPE FROM MASTER                
                                                                                
         CLI   SVOPTMED,0          WAS SPECIFIC MEDIA ENTERED?                  
         BE    GNET42               NO                                          
                                                                                
         CLC   SVMEDIA,SVOPTMED    SAME MEDIA?                                  
         BNE   GNETX                                                            
                                                                                
* MUST READ TN2 PROFILE AFTER GNET USING MEDIA FROM NETWORK!                    
                                                                                
GNET42   OI    4(R2),X'20'         SET ON VALIDATED                             
         XC    WORK,WORK                                                        
         MVI   WORK,X'A2'                                                       
         MVC   WORK+1(3),=C'TN2'   READ TN2                                     
         MVC   WORK+4(2),AGENCY                                                 
         MVC   WORK+6(1),SVMEDIA   USE MEDIA FROM NETWORK REC                   
         MVC   WORK+7(3),QCLT                                                   
         MVI   WORK+10,C'*'                                                     
         MVC   WORK+11(1),SVCLTOFF CLIENT OFFICE                                
                                                                                
         TM    SECFLAG,BLSSW       BRAND LEVEL SECURITY                         
         BZ    GNET43                                                           
                                                                                
         TM    SECFLAG,NEPRDOFF    PRDS OFFICES NOT EQ                          
         BO    GNET43                                                           
                                                                                
         MVC   WORK+11(1),SVPRDOFF USE PROD OFFICE                              
                                                                                
GNET43   GOTO1 GETPROF,DMCB,WORK,SVTN2PRO,DATAMGR                               
                                                                                
         MVC   SVTN2PRE,SVTN2PRO+13 PRINT CLT CML#                              
                                                                                
         CLI   SVOPTTN2,C' '                                                    
         BNH   *+10                                                             
         MVC   SVTN2PRO+10(1),SVOPTTN2                                          
*                                                                               
         CLI   SVTN2PRO+5,0                                                     
         BE    GNET45                                                           
         CLI   SVTN2PRO+5,C'0'                                                  
         BE    GNET45                                                           
         TM    SVOPTSW1,OPTPER     WAS PERIOD ENTERED IN OPTION FIELD           
         BNZ   GNET45               YES, DO NOT OVERRIDE IT                     
         MVC   MYTN2PR6,SVTN2PRO+5                                              
                                                                                
         DROP  R4                                                               
                                                                                
* GET MARKET NAME                                                               
                                                                                
GNET45   MVI   KEY,C'0'                                                         
         MVC   KEY+1(MKTKEYLN),KEY   PRE-FILL THE KEY WITH ZEROES               
         MVI   KEY,C'M'                                                         
         MVC   KEY+1(1),QMED                                                    
         MVC   KEY+2(4),SVSMKT                                                  
         MVC   KEY+6(2),AGENCY                                                  
                                                                                
         L     R6,AIO                                                           
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'STATION',KEY,(R6)                     
         CLC   KEY(MKTKEYLN),0(R6)                                              
*        BNE   GNET50              RECORD NOT FOUND                             
         BE    *+6                                                              
         DC    H'0'                                                             
         USING MKTRECD,R6                                                       
         MVC   SVMKTNM,MKTNAME                                                  
         B     GNET60                                                           
                                                                                
GNET50   MVC   SVMKTNM(19),=CL19'**MKT NOT ON FILE**'                           
                                                                                
GNET60   DS   0H                                                                
         CR    R0,R0               SET EQ CC                                    
                                                                                
GNETX    XIT1                                                                   
                                                                                
NETERR   DS    0H                                                               
         TM    WHEN,X'20'          IS THIS SOON                                 
         BZ    NETERR10                                                         
                                                                                
         CLI   OFFLINE,C'Y'                                                     
         BNE   NETERR10                                                         
                                                                                
         TM    SVOPTSW,OPTTEST     TEST OPTION TEST                             
         BO    NETERR10                                                         
                                                                                
* UNLOCK FOR SOON UPDATES                                                       
                                                                                
         BRAS  RE,UNLK                                                          
                                                                                
NETERR10 MVC   GERROR,=Y(NONET)                                                 
         LA    R2,TRANETH                                                       
         GOTO1 VTRAERR                                                          
         B     GNETX               (SHOULD NOT COME BACK FROM VTRAERR)          
                                                                                
         LTORG                                                                  
         EJECT                                                                  
*===============================================================                
* GET EQUIVALENT PROGRAM RECORDS FOR CLIENT                                     
*===============================================================                
                                                                                
GETEQV   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         BRAS  RE,INITNET                                                       
         LA    RE,EQVPTBL                                                       
         LA    RF,L'EQVPTBL                                                     
         XCEFL                                                                  
*                                                                               
         LA    R2,EQVPTBL                                                       
         LA    R3,L'EQVPTBL/(EQVNEXT-EQVENT)                                    
         LA    R5,1                INITIALIZE COUNTER                           
         USING EQVPTBLD,R2                                                      
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING PGEKEY,R4                                                        
         MVI   PGEKID,X'24'                                                     
         MVC   PGEKAM(3),BAGYMD    & BCLT                                       
         MVC   PGEKNET,NETWORK                                                  
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
*                                                                               
GETEQV10 CLC   KEY(8),KEYSAVE                                                   
         BNE   GETEQVX                                                          
*                                                                               
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    GETEQV24                                                         
         DC    H'0'                                                             
         USING PGEDTAEL,R6                                                      
*                                                                               
GETEQV20 BRAS  RE,NEXTEL                                                        
         BNE   GETEQV60                                                         
*                                                                               
         FIXDT02                                                                
GETEQV24 GOTO1 DATCON,DMCB,(3,PGESTR),(2,WORK)                                  
         FIXDT02                                                                
         GOTO1 (RF),(R1),(3,PGEEND),(2,WORK+2)                                  
         CLC   WORK(2),ENDATEP     SEE IF WITHIN DATES                          
         BH    GETEQV20                                                         
         CLC   WORK+2(2),STDATEP                                                
         BL    GETEQV20                                                         
*                                                                               
         OC    PROGRAM,PROGRAM                                                  
         BZ    GETEQV26                                                         
         CLI   1(RA),C'*'          THIS A DDS TERMINAL                          
         BNE   *+12                                                             
         TM    SVOPTSW,OPTTEST     AND IN TEST MODE                             
         BO    GETEQV26                                                         
*                                                                               
         CLC   PROGRAM,PGEKPRG     THIS AN EQV PROG                             
         BNE   GETEQV26                                                         
         MVC   GERROR,=Y(NOEQUIV)                                               
         LA    R2,TRAOPTH                                                       
         B     VPROGERX                                                         
*                                                                               
GETEQV26 OC    PROGRAM,PROGRAM                                                  
         BZ    GETEQV28                                                         
         CLC   PROGRAM,PGEPROG     SAME BASE PROG                               
         BNE   GETEQV20                                                         
*                                                                               
GETEQV28 CLC   WORK(2),STDATEP                                                  
         BNL   *+10                                                             
         MVC   WORK(2),STDATEP     FORCE DATES TO BE WITHIN PERIOD              
*                                                                               
         CLC   WORK+2(2),ENDATEP                                                
         BNH   *+10                                                             
         MVC   WORK+2(2),ENDATEP                                                
*                                                                               
         MVC   EQVSDT(4),WORK                                                   
*                                                                               
         MVC   EQVEPRG,PGEKPRG                                                  
         MVC   EQVBPRG,PGEPROG                                                  
         STC   R5,EQVCT                                                         
         LA    R5,1(,R5)           ADD 1 TO ENTRY COUNT                         
*                                                                               
         GOTO1 (RF),(R1),(3,PGESTR),(0,WORK)                                    
         CLI   MYTN2PR6,C'B'       TRAFFIC OVERRIDE BROADCAST MONTH             
         BE    GETEQV34                                                         
         CLI   MYTN2PR6,C'C'       TRAFFIC OVERRIDE CALENDAR MONTH              
         BE    GETEQV30                                                         
         CLI   NBUSERL+3,C'B'      BROADCAST MONTH                              
         BE    GETEQV34                                                         
*                                                                               
GETEQV30 MVC   WORK+4(2),=C'01'                                                 
         B     GETEQV36                                                         
*                                                                               
GETEQV34 GOTO1 VGTBROAD,(R1),(1,WORK),WORK+6,GETDAY,ADDAY                       
         MVC   WORK(6),WORK+6                                                   
         FIXDT02                                                                
GETEQV36 GOTO1 DATCON,(R1),(0,WORK),(2,EQVSMODT)                                
*                                                                               
GETEQV40 MVC   EQVEDT,=F'-1'       ONLY USES 1ST 2                              
         MVC   EQVEMODT,=F'-1'     SAME                                         
         CLC   PGEEND,=F'-1'                                                    
         BE    GETEQV50                                                         
         FIXDT02                                                                
         GOTO1 (RF),(R1),(3,PGEEND),(2,EQVEDT)                                  
         GOTO1 (RF),(R1),,(0,WORK)                                              
         CLI   MYTN2PR6,C'B'       TRAFFIC OVERRIDE BROADCAST MONTH             
         BE    GETEQV46                                                         
         CLI   MYTN2PR6,C'C'       TRAFFIC OVERRIDE CALENDAR MONTH              
         BE    GETEQV42                                                         
         CLI   NBUSERL+3,C'B'      BROADCAST MONTH                              
         BE    GETEQV46                                                         
*                                                                               
GETEQV42 MVC   WORK+6(4),WORK                                                   
         GOTO1 ADDAY,(R1),WORK,WORK,F'31'                                       
*                                                                               
GETEQV44 GOTO1 (RF),(R1),,,F'-1'                                                
         CLC   WORK(4),WORK+6                                                   
         BNE   GETEQV44                                                         
         B     GETEQV48                                                         
*                                                                               
GETEQV46 GOTO1 VGTBROAD,(R1),(1,WORK),WORK+6,GETDAY,ADDAY                       
         MVC   WORK(6),WORK+12                                                  
*                                                                               
         FIXDT02                                                                
GETEQV48 GOTO1 DATCON,(R1),(0,WORK),(2,EQVEMODT)                                
*                                                                               
GETEQV50 LA    R2,EQVNEXT                                                       
         BCT   R3,GETEQV20                                                      
         DC    H'0'                                                             
*                                                                               
GETEQV60 DS    0H                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
         B     GETEQV10                                                         
*                                                                               
GETEQVX  DS    0H                                                               
         CLI   KEYSAVE+2,0         DID WE LOOK ACROSS ALL CLIENT                
         BE    GETEQVX2             YES WE ARE DONE                             
         XC    KEY,KEY                                                          
         MVC   KEY(2),KEYSAVE       ID/A/M                                      
         MVC   KEY+4(4),NETWORK     NETWORK                                     
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         B     GETEQV10                                                         
*                                                                               
GETEQVX2 BRAS RE,INITSPT                                                        
         J     EXIT                                                             
*                                                                               
         DROP  R2,R4,R6                                                         
VPROGERX GOTO1 VTRAERR                                                          
         LTORG                                                                  
         EJECT                                                                  
* FIND IF THIS PROD DISTRIBUTION LIST EQUAL TO ANY PREV *                       
*                                                                               
*FEQ     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
*        BRAS  RE,GETEL                                                         
*        LLC   R4,1(R6)                                                         
*                                                                               
*EQ10    BRAS  RE,NEXTEL                                                        
*        BNE   FEQ20                                                            
*        LLC   R0,1(R6)                                                         
*        AR    R4,R0                                                            
*        B     FEQ10                                                            
*                                                                               
*EQ20    STC   R4,4(R5)            SAVE TOTAL DIST LIST LEN                     
*        L     R6,AIO3            SVPRDLST                                      
*                                                                               
*EQ30    CR    R5,R6               END OF LIST                                  
*        BE    FEQNE                                                            
*        OC    0(SVPRDENT,R6),0(R6) ANY ENTRY                                   
*        BZ    FEQ36                                                            
*        CLM   R4,1,4(R6)          WAS THIS THE SAME LEN                        
*        BNE   FEQ36               NOT SAME LIST THEN                           
*        L     R1,AIO1                                                          
*        LA    R1,1000(,R1)                                                     
*        ST    R1,AIO                                                           
*        MVC   KEY+14(4),0(R6)                                                  
*        GOTO1 GETREC                                                           
*        MVC   AIO,AIO1                                                         
*        LA    R0,24(,R1)                                                       
*        LR    R1,R4                                                            
*        LR    RF,R1                                                            
*        L     RE,AIO1                                                          
*        LA    RE,24(,RE)                                                       
*        CLCL  R0,RE                                                            
*        BE    FEQEQ                                                            
*EQ36    LA    R6,SVPRDENT(,R6)                                                 
*        B     FEQ30                                                            
*EQEQ    CR    RB,RB                                                            
*        B     FEQX                                                             
*EQNE    LTR   RB,RB                                                            
*EQX     XIT1                                                                   
         EJECT                                                                  
*==============================================================                 
* CHECK ESTIMATES, BYPASS THOSE WITH COPY CODE N                                
* ESTIMATE TABLE ENTRY = 5 BYTES,                                               
*                        1 EST, 3 PROD, 1 COPY CD                               
* BINARY PRODUCT IS PASSED IN HALF                                              
*==============================================================                 
                                                                                
         USING NUKEY,R4                                                         
         USING UNTABLED,R5                                                      
CKEST    NTR1  BASE=*,LABEL=*                                                   
                                                                                
         LA    R0,999                                                           
         L     R1,AIO2                                                          
         LA    R1,1000(,R1)        200 ENTRIES                                  
CKEST10  CLI   0(R1),0             EMPTY ENTRY                                  
         BE    CKEST30                                                          
         CLC   NUKPEST,0(R1)       SAME EST                                     
         BNE   CKEST14                                                          
         CLC   UNTPROD,1(R1)      SAME PRODUCT                                  
         BE    CKEST20                                                          
                                                                                
CKEST14  DS   0H                                                                
         AHI   R1,5                                                             
         BCT   R0,CKEST10                                                       
         DC    H'0'                                                             
CKEST20  CLI   4(R1),C'N'          BYPASS EST                                   
         XIT1                                                                   
                                                                                
CKEST30  DS   0H                                                                
         MVC   SVKEY,KEY                                                        
         XC    KEY,KEY                                                          
         MVC   KEY+1(3),BAGYMD                                                  
                                                                                
         MVC   KEY+4(3),UNTPROD                                                 
                                                                                
         MVC   KEY+7(1),NUKPEST-NUKPKEY+SVKEY     PUT IN ESTIMATE #             
                                                                                
         BRAS  RE,INITSPT          SET VALUES TO SPOT FILE                      
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    CKEST40                                                          
         DC    H'0'                                                             
CKEST40  L     R6,AIO2                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
                                                                                
         USING ESTHDRD,R6                                                       
         MVC   0(1,R1),NUKPEST-NUKPKEY+SVKEY                                    
         MVC   1(3,R1),UNTPROD                                                  
         MVC   4(1,R1),ECOPY                                                    
                                                                                
         MVC   AIO,AIO1                                                         
                                                                                
         BRAS  RE,INITNET          SET VALUES BACK TO UNIT FILE                 
         MVC   KEY,SVKEY                                                        
         GOTO1 HIGH                                                             
         CLC   KEY(20),KEYSAVE                                                  
         BE    CKEST20                                                          
         DC    H'0'                                                             
                                                                                
         DROP  R4,R5                                                            
         EJECT                                                                  
*==============================================================                 
* GET REVISION INFO *                                                           
* FOR CABLE/GEN R3 POINTS TO PROGRAM TABLE ENTRY                                
*==============================================================                 
                                                                                
         USING PRGTABLD,R3                                                      
         USING UNTABLED,R5                                                      
FREV     NTR1  BASE=*,LABEL=*                                                   
                                                                                
         MVI   OREVNUM,0           REVISION FOR THE OTHER PERIOD                
         MVI   OREVNN,0                                                         
         NI    NETFLAG,X'FF'-NETINSRN  SET OFF INSTR RUN THIS REV               
                                                                                
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING REVXKEY,R4                                                       
*                                                                               
         MVC   REVXKID,=X'0A1D'                                                 
         MVC   REVXKAM(3),BAGYMD AND BCLT                                       
         MVC   REVXKNET,SAVNET                                                  
         CLI   CONREC,C'C'         TEST CABLE/GEN                               
         BNE   *+10                                                             
         MVC   REVXKPRG,0(R3)                                                   
                                                                                
         MVC   REVXKPER,PERIOD                                                  
         CLI   MYTN2PR6,C'W'       USING WEEKLY PERIOD                          
         BNE   *+18                                                             
         TM    SVFLAG,CONVSW       CONVERTED RECORDS?                           
         BNZ   *+10                YES, ALREADY SET                             
         MVC   REVXKPER,WKDATEP                                                 
                                                                                
         CLI   OPTPROD,0            RUNNING BY PRODUCT                          
         BE    *+10                                                             
         MVC   REVXKPRD,OPTPROD                                                 
                                                                                
         OC    OPTPRGR,OPTPRGR     ANY PRODUCT GROUP                            
         BZ    *+10                 NO                                          
         MVC   REVXKPGR,OPTPRGR                                                 
                                                                                
         MVC   KEYSAVE,KEY                                                      
                                                                                
         BRAS  RE,INITXSP                                                       
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'XSPDIR',KEYSAVE,KEY                   
*                                                                               
         CLC   KEY(L'REVXKEY),KEYSAVE                                           
         BE    FREV10                                                           
*                                                                               
FREV02   CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BNE   FREV30                                                           
*                                                                               
         CLI   OPTPROD,0           RUNNING BY PRODUCT                           
         BZ    FREV04                                                           
         CLC   REVXKPRD,OPTPROD                                                 
         BNE   FREV08                                                           
         BE    FREV10                                                           
                                                                                
FREV04   OC    OPTPRGR,OPTPRGR     BY PRODUCT GROUP                             
         BZ    FREV06                                                           
         CLC   REVXKPGR,OPTPRGR                                                 
         BNE   FREV08                                                           
         BE    FREV10                                                           
*                                                                               
FREV06   OC    REVXKPRD(L'REVXKPRD+L'REVXKPGR),REVXKPRD PRD&PG                  
         BZ    FREV10                                                           
*                                                                               
FREV08   MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRSEQ',=C'XSPDIR',KEYSAVE,KEY                   
         B     FREV02                                                           
*                                                                               
FREV10   L     R6,AIO3                                                          
         GOTO1 (RF),(R1),=C'GETREC',=C'XSPFIL',KEY+36,(R6),DMWORK               
         CLC   KEY(32),0(R6)                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   NETCREVN,REVXKNUM-REVXKEY(R6)  PROGRAM REV NUM                   
*                                                                               
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING REVREVEL,R6                                                      
*                                                                               
         CLI   CONREC,C'C'         TEST CABLE GEN                               
         BE    FREV12                                                           
         MVC   SVNETREV,REVNNUM               NETWORK REV NUM                   
                                                                                
* THIS CODE FOR PATTERN GEN                                                     
                                                                                
         MVC   NETIDTE,REVIDATE                                                 
         TM    REVFLAG,X'80'      INSTR RUN FOR THIS REV                        
         BZ    *+8                                                              
         OI    NETFLAG,NETINSRN   SET ON INSTR RUN THIS REV                     
         B     FREV20                                                           
                                                                                
* THIS CODE FOR CABLE GEN                                                       
                                                                                
FREV12   MVC   PRGCREVN,NETCREVN   SAVE PROGRAM REV NUM                         
         MVC   PRGNREVN,REVNNUM    NETWORK REVISION NUMBER                      
*                                                                               
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(3,REVADATE),(2,PRGCREVD)                            
*                                                                               
         NI    PRGFLAG,X'FF'-PRGF_INSRUN  RESET INSTRUCTIONS RUN                
         MVC   PRGIDTE,REVIDATE                                                 
*                                                                               
         TM    REVFLAG,X'80'        TEST INSTR RUN FOR THIS REV                 
         BZ    *+8                                                              
         OI    PRGFLAG,PRGF_INSRUN  SET ON INSTR RUN THIS REV                   
                                                                                
* SEE IF SWITCHED BETWEEN PRODUCT AND PGROUP                                    
                                                                                
FREV20   DS    0H                                                               
         GOTO1 DATAMGR,DMCB,=C'DMRSEQ',=C'XSPDIR',KEYSAVE,KEY                   
                                                                                
         CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BNE   FREVX                                                            
                                                                                
         CLI   OPTPROD,0           RUNNING BY PRODUCT                           
         BE    FREV22                                                           
         CLC   REVXKPRD,OPTPROD                                                 
         BNE   FREV20                                                           
         B     FREV10                                                           
                                                                                
FREV22   OC    OPTPRGR,OPTPRGR     ANY PRODUCT GROUP                            
         BZ    FREV10                                                           
         CLC   REVXKPGR,OPTPRGR                                                 
         BNE   FREV20                                                           
         B     FREV10                                                           
                                                                                
FREVX    DS    0H                                                               
         CLC   OREVNUM,NETCREVN                                                 
         BNH   *+10                                                             
         MVC   NETCREVN,OREVNUM                                                 
*                                                                               
         CLI   CONREC,C'C'         TEST CABLE/GEN                               
         BE    FREVXX                                                           
         CLC   SVNETREV,OREVNN                                                  
         BNL   *+10                                                             
         MVC   SVNETREV,OREVNN                                                  
         J     EXIT                                                             
                                                                                
FREVXX   CLC   OREVNUM,PRGCREVN    COMPARE OTHER  REVISION #                    
         BNH   *+10                TO THIS REVISION                             
         MVC   PRGCREVN,OREVNUM    USE THE HIGHER NUMBER OF THE TWO             
*                                                                               
         CLC   OREVNN,PRGNREVN     AND NETWORK REVISION #                       
         BNH   *+10                                                             
         MVC   PRGNREVN,OREVNN                                                  
         J     EXIT                                                             
         EJECT                                                                  
*===============================================================                
* NO REV REC FOUND, CK IF OTHER FORMAT EXISTS                                   
* IF OPTION WEEKLY, CK FOR MONTHLY REC                                          
*    OPTION MONTHLY, CK FOR WEEKLY REC                                          
*===============================================================                
                                                                                
FREV30   MVC   KEY,KEYSAVE                                                      
         MVI   REVXKNUM,0          SET REVISION TO ZERO                         
*                                                                               
         CLI   OPTPROD,0           RUNNING BY PRODUCT                           
         BE    *+10                                                             
         MVC   REVXKPRD,OPTPROD                                                 
                                                                                
         OC    OPTPRGR,OPTPRGR     RUNNING BY PRODUCT GROUP                     
         BZ    *+10                 NO                                          
         MVC   REVXKPGR,OPTPRGR                                                 
                                                                                
         CLI   MYTN2PR6,C'W'                                                    
         BE    FREV40                                                           
         MVC   WORK(6),STDATE                                                   
         GOTO1 GETDAY,DMCB,(0,STDATE),WORK+6                                    
         CLC   WORK+6(3),SPACES                                                 
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLI   0(R1),1             MUST BE MONDAY                               
         BE    FREV34                                                           
         LLC   R6,DMCB                                                          
         BCTR  R6,0                                                             
         LNR   R6,R6                                                            
         GOTO1 ADDAY,(R1),STDATE,WORK,(R6)                                      
                                                                                
         FIXDT02                                                                
FREV34   GOTO1 DATCON,(R1),(0,WORK),(2,WORK+6)                                  
                                                                                
*                                                                               
         TM    SVFLAG,CONVSW       CONVERTED RECORDS?                           
         BZ    *+8                                                              
         BRAS  RE,CONVPER                                                       
*                                                                               
         MVC   REVXKPER,WORK+6                                                  
         XC    SVLGKEY,SVLGKEY     INIT LAST GOOD KEY                           
         MVC   KEYSAVE,KEY                                                      
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'XSPDIR',KEYSAVE,KEY                   
                                                                                
FREV34B  CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BNE   FREV38              LOOK FOR NEXT WEEK'S REVISION                
*                                                                               
         CLI   OPTPROD,0           RUNNING BY PRODUCT                           
         BE    FREV34C                                                          
         CLC   REVXKPRD,OPTPROD                                                 
         BNE   FREV34G                                                          
         BE    FREV35                                                           
                                                                                
FREV34C  OC    OPTPRGR,OPTPRGR     BY PRODUCT GROUP                             
         BZ    FREV34F                                                          
         CLC   REVXKPGR,OPTPRGR                                                 
         BNE   FREV34G                                                          
         BE    FREV35                                                           
*                                                                               
FREV34F  OC    REVXKPRD(L'REVXKPRD+L'REVXKPGR),REVXKPRD PRD&GRP                 
         BZ    FREV35                                                           
*                                                                               
FREV34G  MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRSEQ',=C'XSPDIR',KEYSAVE,KEY                   
         B     FREV34B                                                          
                                                                                
*==============================================================                 
* READ ALL REVISION RECORDS FOR THIS PERIOD                                     
* AND GET HIGHEST REVISION NUMBER USED                                          
*==============================================================                 
                                                                                
FREV35   CLC   OREVNUM,REVXKNUM    COMPARE OTHER REV # TO THIS                  
         BNL   *+10                                                             
         MVC   OREVNUM,REVXKNUM    SAVE THIS REV#                               
*                                                                               
         MVC   SVLGKEY,KEY         SAVE LAST GOOD KEY                           
*                                                                               
FREV35F  MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRSEQ',=C'XSPDIR',KEYSAVE,KEY                   
*                                                                               
         CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BNE   FREV37               LOOK UP NEXT WEEK                           
*                                                                               
FREV36   CLI   OPTPROD,0           RUNNING BY PRODUCT                           
         BE    FREV36B                                                          
         CLC   REVXKPRD,OPTPROD                                                 
         BE    FREV35                                                           
         BNE   FREV35F             GET NEXT RECORD                              
*                                                                               
FREV36B  OC    OPTPRGR,OPTPRGR     RUNNING BY PRODUCT GROUP                     
         BZ    FREV36C                                                          
         CLC   REVXKPGR(2),OPTPRGR                                              
         BNE   FREV35F             GET NEXT RECORD                              
         BE    FREV35                                                           
*                                                                               
FREV36C  OC    REVXKPRD(L'REVXKPRD+L'REVXKPGR),REVXKPRD PRD&PGR                 
         BZ    FREV35                                                           
         B     FREV35F             GET NEXT RECORD                              
*                                                                               
* RE-READ LAST GOOD RECORD FOR THIS PERIOD                                      
*                                                                               
FREV37   OC    SVLGKEY,SVLGKEY                                                  
         BZ    FREV38                                                           
         MVC   KEY,SVLGKEY                                                      
         MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'XSPDIR',KEYSAVE,KEY                   
         CLC   KEY(L'REVXKEY),KEYSAVE                                           
         BE    *+6                                                              
         DC    H'0'                 MUST BE THERE                               
                                                                                
         L     R6,AIO3                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING REVREVEL,R6                                                      
                                                                                
         BAS   RE,CPRODSW          CHECK PROD/PGROUP SWITCH                     
                                                                                
         CLC   OREVNUM,REVXKNUM    IS OTHER REV# HIGHER                         
         BH    FREV38               YES, DONE WITH THIS WEEK                    
         BE    *+6                                                              
         DC    H'0'                OTHER REV# IS LOWER ?  BUG???                
                                                                                
         CLI   REVDTALN,12         OLD REV REC                                  
         BE    *+20                                                             
         CLC   OREVNN,REVNNUM      IS OTHER NET REV HIGHER                      
         BNL   *+10                                                             
         MVC   OREVNN,REVNNUM      YES, SAVE IT                                 
                                                                                
         TM    REVFLAG,X'80'       HAVE INSTRUCTIONS BEEN RUN                   
         BZ    FREV38              NO,LOOK UP NEXT WEEK                         
                                                                                
         LLC   RF,OREVNUM          YES, UP REVISION NUMBER                      
         LA    RF,1(,RF)                                                        
         STC   RF,OREVNUM                                                       
*                                                                               
         LLC   RF,OREVNN                                                        
         LA    RF,1(,RF)                                                        
         STC   RF,OREVNN                                                        
*                                                                               
* LOOK UP NEXT WEEK IF NOT DONE WITH THIS MONTH                                 
*                                                                               
FREV38   MVC   KEY,KEYSAVE                                                      
         MVI   REVXKNUM,0          SET REVISION TO ZERO                         
         CLI   OPTPROD,0           RUNNING BY PRODUCT                           
         BE    *+10                                                             
         MVC   REVXKPRD,OPTPROD                                                 
                                                                                
         OC    OPTPRGR,OPTPRGR     RUNNING BY PRODUCT GROUP                     
         BZ    *+10                                                             
         MVC   REVXKPGR(2),OPTPRGR                                              
                                                                                
         GOTO1 ADDAY,DMCB,WORK,WORK,F'7' GET MONDAY OF NEXT WEEK                
         CLC   STDATE+2(2),WORK+2  SAME MONTH?                                  
         BE    FREV34                                                           
*                                                                               
         CLI   MYTN2PR6,C'B'       IS THIS BROADCAST PERIOD                     
         BNE   FREVX                NO                                          
*                                                                               
         CLC   ENDATE+2(2),=C'12'   FIX END OF YEAR ISSUE                       
         BNE   *+14                                                             
         CLC   WORK+2(2),=C'01'                                                 
         BE    FREVX                                                            
*                                                                               
         CLC   ENDATE+2(2),WORK+2  SAME MONTH?                                  
         BNL   FREV34                                                           
         B     FREVX                                                            
*                                                                               
* CK FOR MONTHLY REV REC *                                                      
*                                                                               
FREV40   DS    0H                                                               
         MVC   REVXKPER,PERIOD                                                  
         MVC   KEYSAVE,KEY                                                      
         XC    SVLGKEY,SVLGKEY     INIT LAST GOOD KEY                           
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'XSPDIR',KEYSAVE,KEY                   
*                                                                               
         CLC   KEY(L'REVXKEY),KEYSAVE                                           
         BE    FREV42                                                           
*                                                                               
FREV40B  CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BNE   FREV60                                                           
*                                                                               
         CLI   OPTPROD,0           RUNNING BY PRODUCT                           
         BZ    FREV40C                                                          
         CLC   REVXKPRD,OPTPROD                                                 
         BNE   FREV40G                                                          
         BE    FREV42                                                           
                                                                                
FREV40C  OC    OPTPRGR,OPTPRGR     BY PRODUCT GROUP                             
         BZ    FREV40F                                                          
         CLC   REVXKPGR,OPTPRGR                                                 
         BNE   FREV40G                                                          
         BE    FREV42                                                           
*                                                                               
FREV40F  OC    REVXKPRD(L'REVXKPRD+L'REVXKPGR),REVXKPRD PRD&PG                  
         BZ    FREV42                                                           
*                                                                               
FREV40G  MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRSEQ',=C'XSPDIR',KEYSAVE,KEY                   
         B     FREV40B                                                          
*==============================================================                 
* READ ALL REVISION RECORDS FOR THIS PERIOD                                     
* AND GET HIGHEST REVISION NUMBER USED                                          
*==============================================================                 
                                                                                
FREV42   CLC   OREVNUM,REVXKNUM    COMPARE OTHER REV # TO THIS                  
         BNL   *+10                                                             
         MVC   OREVNUM,REVXKNUM    SAVE THIS REV#                               
*                                                                               
         MVC   SVLGKEY,KEY         SAVE LAST GOOD KEY                           
*                                                                               
FREV42F  MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRSEQ',=C'XSPDIR',KEYSAVE,KEY                   
*                                                                               
         CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BNE   FREV45                                                           
*                                                                               
FREV43   CLI   OPTPROD,0           RUNNING BY PRODUCT                           
         BE    FREV43B                                                          
         CLC   REVXKPRD,OPTPROD                                                 
         BE    FREV42                                                           
         BNE   FREV42F             GET NEXT RECORD                              
FREV43B  OC    OPTPRGR,OPTPRGR     RUNNING BY PRODUCT GROUP                     
         BZ    FREV43C                                                          
         CLC   REVXKPGR(2),OPTPRGR                                              
         BNE   FREV42F             GET NEXT RECORD                              
         BE    FREV42                                                           
FREV43C  OC    REVXKPRD(L'REVXKPRD+L'REVXKPGR),REVXKPRD PRD&PGR                 
         BZ    FREV42                                                           
         B     FREV42F             GET NEXT RECORD                              
                                                                                
*==============================================================                 
* RE-READ LAST GOOD RECORD                                                      
*==============================================================                 
                                                                                
FREV45   OC    SVLGKEY,SVLGKEY     ANY GOOD RECORD                              
         BZ    FREV60                                                           
         MVC   KEY,SVLGKEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'XSPDIR',KEYSAVE,KEY                   
         CLC   KEY(L'REVXKEY),KEYSAVE                                           
         BE    *+6                                                              
         DC    H'0'                 MUST BE THERE                               
*                                                                               
         L     R6,AIO3                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING REVREVEL,R6                                                      
                                                                                
         BAS   RE,CPRODSW       CHECK IF SWITCHED PROD/PGROUP/PRD=ALL           
                                                                                
         TM    REVFLAG,X'80'       HAVE INSTRUCTIONS BEEN RUN                   
         BZ    FREV60                                                           
                                                                                
         LLC   RF,OREVNUM          YES, UP REVISION NUMBER                      
         LA    RF,1(RF)                                                         
         STC   RF,OREVNUM                                                       
                                                                                
         LLC   RF,OREVNN           YES, UP REVISION NUMBER                      
         LA    RF,1(RF)                                                         
         STC   RF,OREVNN                                                        
                                                                                
FREV60   DS    0H                                                               
         MVC   KEY,KEYSAVE                                                      
         MVI   REVXKNUM,0          SET REVISION TO ZERO                         
         CLI   OPTPROD,0           RUNNING BY PRODUCT                           
         BE    *+10                                                             
         MVC   REVXKPRD,OPTPROD                                                 
                                                                                
         OC    OPTPRGR,OPTPRGR     RUNNING BY PRODUCT GROUP                     
         BZ    *+10                                                             
         MVC   REVXKPGR(2),OPTPRGR                                              
                                                                                
         MVC   WORK(6),STDATE                                                   
         GOTO1 VGTBROAD,DMCB,(1,WORK),WORK+6,GETDAY,ADDAY                       
         CLC   WORK+8(2),WORK+14   START AND END MONTH SAME                     
         BE    FREV60C                                                          
                                                                                
* ONLY INCREMENT MONTH IF DAY IS OVER 21 *                                      
                                                                                
         CLC   =C'20',WORK+2                                                    
         BL    FREV60C                                                          
         GOTO1 ADDAY,(R1),WORK+6,WORK+6,F'15'                                   
FREV60C  GOTO1 DATCON,(R1),(0,WORK+6),(3,WORK)                                  
                                                                                
         CLC   REVXKPER,WORK                                                    
         BE    FREVX               DONE THIS PERIOD BEFORE                      
                                                                                
         MVC   REVXKPER,WORK                                                    
                                                                                
         XC    SVLGKEY,SVLGKEY                                                  
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         BRAS  RE,INITXSP          SET TO XSPOT                                 
                                                                                
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BNE   FREVX                                                            
*                                                                               
FREV61   CLI   OPTPROD,0           RUNNING BY PRODUCT                           
         BE    FREV61B                                                          
         CLC   REVXKPRD,OPTPROD                                                 
         BE    FREV64                                                           
         BNE   FREV61F                                                          
                                                                                
FREV61B  OC    OPTPRGR,OPTPRGR     RUNNING BY PRODUCT GROUP                     
         BZ    FREV61C                                                          
         CLC   REVXKPGR(2),OPTPRGR                                              
         BNE   FREV61F                                                          
         BE    FREV64                                                           
FREV61C  OC    REVXKPRD(L'REVXKPRD+L'REVXKPGR),REVXKPRD PRD&PGR                 
         BZ    FREV64                                                           
*                                                                               
FREV61F  MVC   KEYSAVE,KEY                                                      
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
*                                                                               
         CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BNE   FREV65                                                           
         B     FREV61                                                           
*                                                                               
FREV64   CLC   OREVNUM,REVXKNUM    COMPARE OTHER REV # TO THIS                  
         BNL   *+10                                                             
         MVC   OREVNUM,REVXKNUM    SAVE THIS REV#                               
*                                                                               
         MVC   SVLGKEY,KEY         SAVE LAST GOOD KEY                           
*                                                                               
         MVC   KEYSAVE,KEY                                                      
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
*                                                                               
         CLC   KEY(REVXKNUM-REVXKEY),KEYSAVE                                    
         BE    FREV61                                                           
                                                                                
*===============================================================                
* RE-READ LAST GOOD RECORD                                                      
*===============================================================                
                                                                                
FREV65   OC    SVLGKEY,SVLGKEY     ANY GOOD RECORDS                             
         BZ    FREVX                                                            
         MVC   KEY,SVLGKEY                                                      
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(L'REVXKEY),KEYSAVE                                           
         BE    *+6                                                              
         DC    H'0'                 MUST BE THERE                               
                                                                                
         CLC   OREVNUM,REVXKNUM    COMPARE OTHER REV # TO THIS                  
         BH    FREVX                                                            
         BE    *+6                                                              
         DC    H'0'                OTHER REV IS LOWER ? BUG??                   
                                                                                
         L     R6,AIO3                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING REVREVEL,R6                                                      
                                                                                
         TM    REVFLAG,X'80'       HAVE INSTRUCTIONS BEEN RUN                   
         BZ    FREVX                                                            
                                                                                
         LLC   RF,OREVNUM          UP REVISION NUMBER                           
         LA    RF,1(,RF)                                                        
         STC   RF,OREVNUM                                                       
*                                                                               
         LLC   RF,OREVNN           UP REVISION NUMBER                           
         LA    RF,1(,RF)                                                        
         STC   RF,OREVNN                                                        
         B     FREVX                                                            
         DROP  R3                                                               
*                                                                               
PRGRPERR DS   0H                   ERROR, NO SWITCHING TO PRODUCT               
         BRAS  RE,UNLK             UNLOCK BEFORE ERROR EXIT                     
         XC    ELEM,ELEM                                                        
         MVI   ELEM,10             L'SUBST TEXT + 1                             
         MVI   ELEM+10,8           2ND L'SUBST TEXT + 1                         
         MVC   ELEM+1(9),=C'BY PGROUP'                                          
         MVC   ELEM+11(7),=C'BY PROD'                                           
         B     PRDGRPER                                                         
                                                                                
PGRALLER DS   0H                   ERROR, NO SWITCHING TO ALL                   
         BRAS  RE,UNLK             UNLOCK BEFORE ERROR EXIT                     
         XC    ELEM,ELEM                                                        
         MVI   ELEM,10             L'SUBST TEXT + 1                             
         MVI   ELEM+10,8           2ND L'SUBST TEXT + 1                         
         MVC   ELEM+1(9),=C'BY PGROUP'                                          
         MVC   ELEM+11(7),=C'FOR ALL'                                           
         B     PRDGRPER                                                         
                                                                                
PRDALLER DS   0H                   ERROR, NO SWITCHING TO ALL                   
         BRAS  RE,UNLK             UNLOCK BEFORE ERROR EXIT                     
         XC    ELEM,ELEM                                                        
         MVI   ELEM,8              L'SUBST TEXT + 1                             
         MVI   ELEM+8,8            2ND L'SUBST TEXT + 1                         
         MVC   ELEM+1(7),=C'BY PROD'                                            
         MVC   ELEM+9(7),=C'FOR ALL'                                            
         B     PRDGRPER                                                         
                                                                                
PRODERR  DS   0H                                                                
         BRAS  RE,UNLK             UNLOCK BEFORE ERROR EXIT                     
         XC    ELEM,ELEM                                                        
         MVI   ELEM,8              L'SUBST TEXT + 1                             
         MVI   ELEM+8,10           2ND L'SUBST TEXT + 1                         
         MVC   ELEM+1(7),=C'BY PROD'                                            
         MVC   ELEM+9(9),=C'BY PGROUP'                                          
         B     PRDGRPER                                                         
                                                                                
PRDPRGER DS   0H                                                                
         BRAS  RE,UNLK             UNLOCK BEFORE ERROR EXIT                     
         XC    ELEM,ELEM                                                        
         MVI   ELEM,8              L'SUBST TEXT + 1                             
         MVI   ELEM+8,18           2ND L'SUBST TEXT + 1                         
         MVC   ELEM+1(7),=C'FOR ALL'                                            
         MVC   ELEM+9(17),=C'BY PROD OR PGROUP'                                 
                                                                                
PRDGRPER DS    0H                                                               
         LA    R2,TRAOPTH                                                       
         LA    R1,ELEM                                                          
         STCM  R1,7,GASUBST        A(SUBST TEXT)                                
         MVC   GERROR,=Y(PRDGRPSW)                                              
         GOTO1 VTRAERR                                                          
         EJECT                                                                  
*---------------------------------------------------------                      
* CHECK SWITCHING BETWEEN PROD, PGROUP AND FOR ALL PRODS                        
*---------------------------------------------------------                      
* -->>>>  THIS HAS NOT WORKED IN THE PAST AND FIXING IT                         
* -->>>>  NOW WOULD LOCK OUT CLIENTS THAT HAVE DIFFERENT                        
* -->>>>  FLAVORS OF REVISION RECORDS                                           
*  -->>>  PER RAMUNE "LET'S NOT MUDDY THE WATERS"                               
*---------------------------------------------------------                      
*                                                                               
CPRODSW  NTR1                                                                   
         B     CPSWX                                                            
                                                                                
         OC    REVXKPRD(L'REVXKPRD+L'REVXKPGR),REVXKPRD PRD&GRP                 
         BZ    CPSW40               NO, RUNNING FOR ALL PRODS                   
                                                                                
******************************************************************              
* ADD CODE HERE IF RUN BY PROD/PGROUP SEE THAT THAT DID NOT CHANGE              
* (THIS HAS NOT WORKED IN THE PAST AND FIXING IT NOW WOULD LOCK OUT             
* CLIENTS THAT HAVE DIFFERENT FLAVORS OF REVISION RECORD)                       
******************************************************************              
                                                                                
* RUNNING FOR ALL PRODS                                                         
                                                                                
CPSW40   OC    REVXKPGR-REVXKEY+KEYSAVE,REVXKPGR-REVXKEY+KEYSAVE                
         BNZ   CPSW45                                                           
         TM    REVFLAG,REVPRGRP    RAN BY PGROUP?                               
         BO    PGRALLER            YES, NO SWITCHING TO ALL                     
         B     PRDALLER                                                         
                                                                                
CPSW45   TM    REVFLAG,REVPRGRP    RAN BY PGROUP ?                              
         BO    CPSW50                                                           
         OC    OPTPRGR,OPTPRGR     RAN BY PRD, NOW  BY PGROUP?                  
         BNZ   PRODERR             ERROR, NO SWITCHING TO PGROUP                
         B     CPSWX                                                            
                                                                                
CPSW50   CLI   OPTPROD,0           RUNNING BY PRODUCT NOW ?                     
         BNE   PRGRPERR            ERROR, NO SWITCHING TO PROD                  
CPSWX    XIT1                                                                   
         EJECT                                                                  
*                                                                               
*                                                                               
****************************************************************                
* ON ENTRY WORK CONTAINS PERIOD (YYMMDD)                                        
* CONVERT PERIOD INTO WORK+6:                                                   
* 1ST BYTE = YEAR                                                               
* 2ND BYTE = HOB MONTH AND LOB WEEK NUMBER FOR THAT MONTH                       
* EG. 1/27/20 CONVERT X'7814' YEAR= X'78' MONTH=1 WEEK=4                        
****************************************************************                
CONVPER  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         GOTO1 DATCON,(R1),(0,WORK),(3,WORK+6) YYMMDD TO YMD                    
*                                                                               
* CALC WEEK NUMBER FOR THIS MONTH                                               
         SR    R5,R5               INIT WEEK NUMBER                             
         MVC   DUB(6),WORK         YYMMDD                                       
CONV02   AHI   R5,1                INCR WEEK NUMBER                             
         GOTO1 ADDAY,(R1),DUB,DUB,F'-7'                                         
         CLC   WORK+2(2),DUB+2     SAME MONTH?                                  
         BE    CONV02                                                           
*                                                                               
         SLL   R5,28               WEEK NUMBER IN HOB                           
         LLC   R4,WORK+7                                                        
         SLDL  R4,28               HOB MONTH/LOB WEEK NUMBER                    
         STCM  R4,8,WORK+7         MONTH/WEEK NO (X'C4'= DEC/WEEK 4)            
         XIT1                                                                   
*                                                                               
*                                                                               
*----------------------------------------                                       
* UNLOCK BEFORE ERROR EXIT                                                      
*----------------------------------------                                       
*                                                                               
UNLK     NTR1  BASE=*,LABEL=*                                                   
                                                                                
         TM    WHEN,X'20'          IS THIS SOON                                 
         BZ    UNLKX                                                            
                                                                                
         CLI   OFFLINE,C'Y'                                                     
         BNE   UNLKX                                                            
                                                                                
         TM    SVOPTSW,OPTTEST     TEST OPTION TEST                             
         BO    UNLKX                                                            
                                                                                
* UNLOCK FOR SOON UPDATES                                                       
                                                                                
         CLI   CONREC,C'C'         TEST CABLEGEN                                
         BNE   *+12                                                             
         BRAS  RE,CUNLK                                                         
         B     UNLKX                                                            
                                                                                
         MVC   DUB(4),=C'UNET'                                                  
         MVI   DUB+4,X'21'                                                      
         XC    DUB+5(3),DUB+5                                                   
                                                                                
         CLC   =C'ALL',TRANET      IF ALL CHECK ALL                             
         BE    UNLK05                                                           
                                                                                
         MVI   DUB+5,X'FF'         MARKER FOR BY NET                            
         MVC   FULL,NETWORK        LOCK BY NET                                  
                                                                                
UNLK05   GOTO1 VALILOC,0                                                        
                                                                                
UNLKX    XIT1                                                                   
                                                                                
         LTORG                                                                  
         DROP  R4                                                               
         EJECT                                                                  
*==================================================================             
* ON ENTRY R3 POINTS TO PROGRAM COUNT TABLE ENTRY FOR CABLE/GEN                 
*==================================================================             
                                                                                
UPDR     NTR1  BASE=*,LABEL=*                                                   
                                                                                
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
                                                                                
         BRAS  RE,INITXSP          SET TO XSPOT                                 
*                                                                               
* UPDATE OR ADD NEW NET RECAP RECORD FOR CAD ONLY                               
*                                                                               
         CLI   OPTICASW,C'Y'       CAD OPTICA CLIENT                            
         BNE   *+8                                                              
         BAS   RE,BRECAP           BUILD RECAP RECORD                           
*                                                                               
         CLI   CONREC,C'C'         TEST CABLE GEN                               
         BE    UPDRC                                                            
                                                                                
* THIS CODE FOR PATTERN GEN ONLY!                                               
                                                                                
         XC    KEYSAVE,KEYSAVE                                                  
         LA    R4,KEYSAVE                                                       
         USING REVXKEY,R4                                                       
         MVC   REVXKID,=X'0A1D'                                                 
         MVC   REVXKAM(3),BAGYMD AND BCLT                                       
         MVC   REVXKNET,SAVNET                                                  
         MVC   REVXKPER,PERIOD                                                  
                                                                                
         CLI   MYTN2PR6,C'W'       USING WEEKLY PERIOD                          
         BNE   *+18                                                             
         TM    SVFLAG,CONVSW       CONVERTED RECORDS?                           
         BNZ   *+10                YES, ALREADY SET                             
         MVC   REVXKPER,WKDATEP                                                 
                                                                                
         MVC   REVXKNUM,NETCREVN                                                
*                                                                               
         TM    NETFLAG,NETINSRN    WERE INSTR RUN FOR THIS REV?                 
         BZ    UPDR10               NO                                          
                                                                                
         LLC   RF,REVXKNUM                                                      
         LA    RF,1(,RF)                                                        
         STC   RF,REVXKNUM                                                      
                                                                                
         CLC   REVXKNUM,SVNETREV   COMPARE PROG REV NUM TO NET REV              
         BNH   UPDR10                                                           
         MVC   SVNETREV,REVXKNUM   NET REV NUM S/B >= PROG REV NUM              
                                                                                
UPDR10   DS    0H                                                               
         CLI   OPTPROD,0           RUNNING BY PRODUCT                           
         BE    *+10                                                             
         MVC   REVXKPRD,OPTPROD                                                 
                                                                                
         OC    OPTPRGR,OPTPRGR     ANY PRODUCT GROUP                            
         BZ    *+10                                                             
         MVC   REVXKPGR,OPTPRGR                                                 
                                                                                
         DROP  R4                                                               
                                                                                
         GOTO1 DATAMGR,DMCB,(X'80',=C'DMRDHI'),=C'XSPDIR',KEYSAVE,KEY           
         CLC   KEY(32),KEYSAVE                                                  
         BE    UPDR40                                                           
                                                                                
* BUILD NEW REVISION RECORD *                                                   
                                                                                
         L     R6,AIO1                                                          
         XC    0(256,R6),0(R6)                                                  
         MVC   0(32,R6),KEYSAVE                                                 
         MVC   KEY(32),KEYSAVE                                                  
                                                                                
         MVI   33(R6),42                                                        
                                                                                
* BUILD NEW REVISION ELEMENT *                                                  
                                                                                
         XC    ELEM,ELEM                                                        
         LA    R6,ELEM                                                          
         USING REVREVEL,R6                                                      
         MVI   REVREVEL,X'10'                                                   
         MVI   REVDTALN,(REVREVEQ-REVREVEL)                                     
         MVC   REVNNUM,SVNETREV    NETWORK REVISION NUMBER                      
                                                                                
         OI    REVFLAG,REVINS+REVPAT                                            
                                                                                
         CLI   MYTN2PR6,C'B'                                                    
         BNE   UPDR20                                                           
         OI    REVFLAG,REVBRD      TURN ON PERIOD IS BROAD MONTH                
         B     UPDR30                                                           
                                                                                
UPDR20   DS    0H                                                               
         CLI   MYTN2PR6,C'C'                                                    
         BNE   UPDR30                                                           
         OI    REVFLAG,REVCAL      TURN ON PERIOD IS CALENDAR MONTH             
                                                                                
UPDR30   DS    0H                                                               
         GOTO1 DATCON,DMCB,(5,0),(3,REVIDATE)                                   
                                                                                
         OC    OPTPRGR,OPTPRGR     ANY PRODUCT GROUP                            
         BZ    *+8                                                              
         OI    REVFLAG,REVPRGRP                                                 
                                                                                
         CLI   SVTWPR06,C'N'       NO FAX                                       
         BE    *+8                                                              
         OI    REVFLAG,REVFAX                                                   
         DROP  R6                                                               
                                                                                
         BRAS  RE,INITXSP          SET TO NET                                   
         GOTO1 ADDELEM                                                          
                                                                                
         CLI   CONREC,C'C'         TEST CABLE/GEN                               
         BE    *+8                                                              
         BRAS  RE,BSCMT            BUILD OPTIONAL PAT GEN COMMENTS              
                                                                                
         BRAS  RE,BTIME                                                         
                                                                                
         TM    SVOPTSW,OPTTEST     THIS A TEST RUN                              
         BO    UPDRX               NO UPDATE                                    
                                                                                
         CLI   OFFLINE,C'Y'        IF OFFLINE                                   
         BNE   *+12                 CK UPDATE                                   
         CLI   TWAWRITE,C'Y'                                                    
         BNE   UPDRX                                                            
                                                                                
         GOTO1 DATAMGR,(R1),=C'ADDREC',=C'XSPFIL',KEY+36,AIO,DMWORK             
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
         B     UPDRX                                                            
                                                                                
UPDR40   DS    0H                                                               
         GOTO1 DATAMGR,DMCB,(X'80',=C'GETREC'),=C'XSPFIL',KEY+36,(R6), C        
               DMWORK                                                           
                                                                                
         CLC   KEY(32),0(R6)                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R6,42(,R6)                                                       
         CLI   0(R6),X'10'                                                      
         BE    *+6                                                              
         DC    H'0'                                                             
         USING REVREVEL,R6                                                      
                                                                                
         GOTO1 DATCON,(R1),(5,0),(3,REVIDATE)                                   
                                                                                
         OI    REVFLAG,REVPAT+REVINS        SET PAG/GEN RUN                     
         MVC   REVNNUM,SVNETREV    NETWORK REVISION NUMBER                      
                                                                                
         OC    OPTPRGR,OPTPRGR     ANY PRODUCT GROUP                            
         BZ    *+8                                                              
         OI    REVFLAG,REVPRGRP                                                 
                                                                                
         CLI   SVTWPR06,C'N'       NO FAX                                       
         BE    *+8                                                              
         OI    REVFLAG,REVFAX                                                   
         DROP  R6                                                               
                                                                                
UPDR60   DS   0H                                                                
         TM    SVOPTSW,OPTTEST     THIS A TEST RUN                              
         BO    UPDRX               NO UPDATE                                    
                                                                                
         CLI   OFFLINE,C'Y'        IF ONLINE                                    
         BNE   UPDR66               ALWAYS UPDATE                               
         CLI   TWAWRITE,C'Y'                                                    
         BNE   UPDRX                                                            
                                                                                
UPDR66   DS   0H                                                                
         BRAS  RE,BTIME                                                         
                                                                                
         GOTO1 DATAMGR,(R1),=C'PUTREC',=C'XSPFIL',KEY+36,AIO,DMWORK             
                                                                                
UPDRX    BRAS  RE,INITSPT          SET TO SPOT                                  
                                                                                
         J     EXIT                                                             
         EJECT                                                                  
*==============================================================                 
* THIS CODE FOR CABLE/GEN                                                       
*==============================================================                 
*                                                                               
UPDRC    L     R5,APRGTAB                                                       
         USING PRGTABLD,R5                                                      
*                                                                               
UPDRC10  TM    PRGFLAG,PRGF_INSRUN  WERE INSTR RUN FOR THIS PROGRAM             
         BZ    UPDRC20                                                          
         TM    PRGFLAG,PRGF_SKIP    SKIP THIS PROGRAM                           
         BO    UPDRC20                                                          
*                                                                               
         L     R6,AIO1                                                          
         ST    R6,AIO                                                           
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING REVXKEY,R4                                                       
         MVC   REVXKID,=X'0A1D'                                                 
         MVC   REVXKAM(3),BAGYMD AND BCLT                                       
         MVC   REVXKNET,SAVNET                                                  
         MVC   REVXKPRG,PRGPROG                                                 
         MVC   REVXKPER,PERIOD                                                  
*                                                                               
         CLI   MYTN2PR6,C'W'       USING WEEKLY PERIOD                          
         BNE   *+18                                                             
         TM    SVFLAG,CONVSW       CONVERTED RECORDS?                           
         BNZ   *+10                YES, ALREADY SET                             
         MVC   REVXKPER,WKDATEP                                                 
*                                                                               
         MVC   REVXKNUM,PRGCREVN                                                
*                                                                               
         CLC   OPTPROD,SPACES      RUNNING BY PRODUCT                           
         BNH   *+14                                                             
         MVC   REVXKPRD,OPTPROD                                                 
         B     UPDRC12                                                          
*                                                                               
         OC    OPTPRGR,OPTPRGR     RUNNING BY PGROUP                            
         BZ    *+10                 NO                                          
         MVC   REVXKPGR,OPTPRGR                                                 
*                                                                               
UPDRC12  MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,(X'80',=C'DMRDHI'),=C'XSPDIR',KEYSAVE,KEY           
         CLC   REVXKEY,KEYSAVE                                                  
         BE    UPDRC14                                                          
                                                                                
* LOOK FOR NETWORK REVISION RECORD CREATED BY PATTERN GEN                       
                                                                                
         MVC   KEY,KEYSAVE         RESTORE KEY                                  
         XC    REVXKPRG,REVXKPRG   CLEAR PROGRAM                                
         MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,(X'80',=C'DMRDHI'),=C'XSPDIR',KEYSAVE,KEY           
         CLC   REVXKEY,KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
UPDRC14  GOTO1 (RF),(R1),(X'80',=C'GETREC'),=C'XSPFIL',KEY+36,(R6),    C        
               DMWORK                                                           
         CLC   REVXKEY,0(R6)                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         DROP  R4                                                               
*                                                                               
         LA    R6,42(R6)                                                        
         CLI   0(R6),X'10'                                                      
         BE    *+6                                                              
         DC    H'0'                                                             
         USING REVREV,R6                                                        
*                                                                               
         GOTO1 DATCON,DMCB,(5,0),(3,REVIDATE)                                   
*                                                                               
         OI    REVFLAG,REVINS+REVCAB SET ON CABLE INSTRUCTIONS RUN              
*                                                                               
         OC    OPTPRGR,OPTPRGR     RUNNING BY PGROUP                            
         BZ    *+8                                                              
         OI    REVFLAG,REVPRGRP                                                 
*                                                                               
         CLI   SVTWPR06,C'N'       NO FAX                                       
         BE    *+8                                                              
         OI    REVFLAG,REVFAX                                                   
         DROP  R6                                                               
*                                                                               
         TM    SVOPTSW,OPTTEST     THIS A TEST RUN                              
         BO    UPDRC20             NO UPDATE                                    
*                                                                               
UPDRC18  DS    0H                                                               
         CLI   OFFLINE,C'Y'        IF ONLINE                                    
         BNE   *+12                 ALWAYS UPDATE                               
         CLI   TWAWRITE,C'Y'                                                    
         BNE   UPDRC20                                                          
*                                                                               
         BRAS  RE,BTIME                                                         
*                                                                               
         GOTO1 DATAMGR,(R1),=C'PUTREC',=C'XSPFIL',KEY+36,AIO,DMWORK             
*                                                                               
UPDRC20  LA    R5,PRGNEXT          NEXT PROGRAM TABLE ENTRY                     
         CLI   0(R5),0             EOL                                          
         BE    UPDRCX              NO                                           
         C     R5,MXPRGTAB                                                      
         BL    UPDRC10             NO                                           
*                                                                               
UPDRCX   B     UPDRX                                                            
         DROP  R5                                                               
         LTORG                                                                  
*                                                                               
* BUILD RECAP RECORD                                                            
* UPDATE OR ADD NEW NET RECAP RECORD                                            
*                                                                               
BRECAP   NTR1                                                                   
         L     R5,ACMLTBL                                                       
         USING CMLTBLD,R5                                                       
*                                                                               
         OC    CMLSHCML,CMLSHCML    ANY ENTRIES                                 
         BZ    BRCX                 NO DONE                                     
*                                                                               
* SEE IF NET RECAP RECORD FOR THIS NETWORK IS ALREADY THERE                     
BRC00    XC    KEY,KEY                                                          
*                                                                               
         LA    R4,KEY                                                           
         USING NRCPKEY,R4                                                       
         MVC   NRCPKID,=X'0A20'    NET RECAP RECORD                             
         MVC   NRCPKAM(3),BAGYMD AND BCLT                                       
         MVC   NRCPCML,CMLSHCML    CML                                          
         MVC   NRCPNET,SAVNET      NETWORK                                      
         MVC   NRCPSMED,SVMEDIA    SUB-MEDIA                                    
         MVC   NRCPPROD,CMLPRO1    PRODUCT                                      
         MVC   NRCPPRO2,CMLPRO2    PRODUCT 2                                    
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(32),KEYSAVE     HAVE THE RECORD?                             
         BNE   BRC50                                                            
*                                                                               
         XC    ELEM,ELEM                                                        
         MVI   BYTE,0              INIT PUTREC/ADDREC FLAG                      
*                                                                               
         GOTO1 GETREC                                                           
*                                                                               
BRC01    L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING NRCPDTEL,R6                                                      
*                                                                               
* ARE DATES IN TABLE COMPLETE OUT OF DATE RANGE IN ELEM                         
BRC02    CLC   NRCPFTD,CMLLTD      FTD IN ELEM > LTD IN TABLE?                  
         BH    BRC20                                                            
         CLC   NRCPLTD,CMLFTD      LTD IN ELEM < FTD IN TABLE?                  
         BL    BRC10                                                            
*                                                                               
* DATE OVERLAP?                                                                 
BRC05    CLC   NRCPFTD,CMLFTD      FTD IN ELEM < FTD IN TABLE?                  
         BNH   *+14                                                             
         MVC   NRCPFTD,CMLFTD                                                   
         MVI   BYTE,C'C'           ELEMENT CHANGED, DO PUTREC                   
         CLC   NRCPLTD,CMLLTD                                                   
         BNL   BRC40               NEXT DATE RANGE FROM TABLE                   
         MVC   NRCPLTD,CMLLTD                                                   
         MVI   BYTE,C'C'           ELEMENT CHANGED, DO PUTREC                   
         B     BRC40               NEXT DATE RANGE FROM TABLE                   
                                                                                
* DATE RANGE IS ONE DAY APART?                                                  
BRC10    GOTO1 DATCON,DMCB,(3,CMLFTD),(0,WORK)                                  
         GOTO1 ADDAY,(R1),WORK,WORK+6,F'-1' MINUS 1 FROM TO FTD                 
         GOTO1 DATCON,(R1),(0,WORK+6),(3,WORK+12)                               
         CLC   NRCPLTD,WORK+12     LTD IN ELEM = FTD IN TABLE -1                
         BNE   BRC20                                                            
         MVC   NRCPLTD,CMLLTD      SAVE LATER LTD                               
         MVI   BYTE,C'C'           ELEMENT CHANGED, DO PUTREC                   
         B     BRC40               DONE, DATES ARE MERGED                       
*                                                                               
BRC20    GOTO1 DATCON,DMCB,(3,CMLLTD),(0,WORK)                                  
         GOTO1 ADDAY,(R1),WORK,WORK+6,F'1' ADD 1 TO TO LTD                      
         GOTO1 DATCON,(R1),(0,WORK+6),(3,WORK+12)                               
         CLC   NRCPFTD,WORK+12     FTD IN ELEM = LTD IN TABLE +1                
         BNE   BRC30                                                            
         MVC   NRCPFTD,CMLFTD      SAVE EARLIER FTD                             
         MVI   BYTE,C'C'           ELEMENT CHANGED, DO PUTREC                   
         B     BRC40               NEXT DATE RANGE FROM TABLE                   
*                                                                               
BRC30    BRAS  RE,NEXTEL                                                        
         BE    BRC02                                                            
*                                                                               
* ADD NEW ELEMENT                                                               
         XC    ELEM,ELEM                                                        
         LA    R6,ELEM                                                          
         USING NRCPDTEL,R6                                                      
         MVI   NRCPDTEL,X'10'                                                   
         MVI   NRCPDTLN,(NRCPDTX-NRCPDTEL)                                      
         MVC   NRCPFTD,CMLFTD      FTD                                          
         MVC   NRCPLTD,CMLLTD      LTD                                          
         MVC   NRCPIDTE,BTODAY     CML INSTR DATE                               
*                                                                               
         GOTO1 ADDELEM                                                          
*                                                                               
         MVI   BYTE,C'P'           NEED PUTREC                                  
         B     BRC70                                                            
*                                                                               
BRC40    LA    R5,CMLTBLLN(R5)     BUMP TO NEXT ENTRY IN TABLE                  
         CLI   0(R5),0                                                          
         BE    BRC75               DONE                                         
*                                                                               
         CLC   NRCPCML,CMLSHCML    SAME COMMERCIAL?                             
         BNE   BRC45                                                            
         CLC   NRCPPROD(6),CMLPRO1 SAME PRODS?                                  
         BE    BRC01                                                            
*                                                                               
BRC45    CLI   BYTE,C'P'                                                        
         BE    BRC75                                                            
         CLI   BYTE,C'C'                                                        
         BE    BRC75                                                            
         B     BRC00                                                            
*                                                                               
* BUILD NEW RECAP RECORD                                                        
*                                                                               
BRC50    MVC   KEY,KEYSAVE                                                      
         L     R6,AIO1                                                          
         XC    0(256,R6),0(R6)                                                  
         MVC   0(32,R6),KEYSAVE                                                 
         MVI   33(R6),42                                                        
         TM    CMLFLAG,ADIDSW      IS CML PACKED ADID                           
         BZ    BRC60                                                            
         OI    KEY+32,X'01'        SET STATUS CML PACKED ADID                   
         OI    34(R6),X'01'                                                     
*                                                                               
* ADD NEW ELEMENT                                                               
BRC60    XC    ELEM,ELEM                                                        
         LA    R6,ELEM                                                          
         USING NRCPDTEL,R6                                                      
         MVI   NRCPDTEL,X'10'                                                   
         MVI   NRCPDTLN,(NRCPDTX-NRCPDTEL)                                      
         MVC   NRCPFTD,CMLFTD      FTD                                          
         MVC   NRCPLTD,CMLLTD      LTD                                          
         MVC   NRCPIDTE,BTODAY     CML INSTR DATE                               
*                                                                               
         GOTO1 ADDELEM                                                          
*                                                                               
         MVI   BYTE,C'A'           NEED ADDREC                                  
*                                                                               
BRC70    LA    R5,CMLTBLLN(R5)     BUMP TO NEXT ENTRY IN TABLE                  
         CLI   0(R5),0                                                          
         BE    BRC75               DONE                                         
*                                                                               
         CLC   NRCPCML,CMLSHCML    SAME COMMERCIAL?                             
         BNE   BRC75                                                            
         CLC   NRCPPROD(6),CMLPRO1 SAME PRODS?                                  
         BNE   BRC75                                                            
*                                                                               
         CLI   BYTE,C'A'                                                        
         BE    BRC60                                                            
         B     BRC01                                                            
*                                                                               
*GO THRU ALL ELEMS ONE MORE TIME                                                
BRC75    BAS   RE,CELEMS           COMBINE ELEMENTS IF DATES MERGE              
*                                                                               
         TM    SVOPTSW,OPTTEST     THIS A TEST RUN                              
         BO    BRC90               NO UPDATE                                    
*                                                                               
         TM    SVOPTSW1,OPTHDCPY   IF AGENCY COPY RUN                           
         BO    BRC90               NO UPDATE                                    
*                                                                               
         CLI   OFFLINE,C'Y'        IF OFFLINE                                   
         BNE   *+12                 CK UPDATE                                   
         CLI   TWAWRITE,C'Y'                                                    
         BNE   BRC90                                                            
*                                                                               
         CLI   BYTE,C'A'           ADD REC ?                                    
         BNE   BRC80                                                            
*                                                                               
         MVC   SAVEKEY,KEY                                                      
         GOTO1 ADDREC                                                           
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVI   BYTE,0                                                           
         B     BRC90                                                            
*                                                                               
BRC80    CLI   BYTE,C'C'                                                        
         BE    BRCPUT                                                           
*                                                                               
         OC    ELEM,ELEM           DID WE ADD ANY ELEMENTS                      
         BZ    BRC90                                                            
*                                                                               
         CLI   BYTE,C'P'                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
BRCPUT   GOTO1 PUTREC                                                           
         MVI   BYTE,0                                                           
*                                                                               
BRC90    CLI   0(R5),0                                                          
         BNE   BRC00               PROCESS NEXT CML                             
*                                                                               
BRCX     XIT1                                                                   
*                                                                               
*                                                                               
* GO THRU ELEMENTS ONE MORE TIME                                                
* AND COMBINE ELEMS WITH DATES THAT CAN MERGE                                   
*                                                                               
CELEMS   NTR1                                                                   
         L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         LR    R2,R6               SAVE ELEM ADDRESS                            
R        USING NRCPDTEL,R2                                                      
         BRAS  RE,NEXTEL                                                        
         BNE   CELX                                                             
*                                                                               
CEL02    MVI   OPTION2,0           INIT RECUP FLAG                              
         CLI   0(R6),X'10'         POINTING TO 10 ELEM                          
         BNE   CELX                NO, DONE                                     
*                                                                               
         CLC   R.NRCPFTD,NRCPLTD   FTD > LTD?                                   
         BH    CEL20                                                            
         CLC   R.NRCPLTD,NRCPFTD   LTD < FTD?                                   
         BL    CEL10                                                            
*                                                                               
* DATE OVERLAP?                                                                 
CEL05    CLC   R.NRCPFTD,NRCPFTD     FTD IN ELEM < FTD IN TABLE?                
         BNH   CEL08                                                            
         MVC   R.NRCPFTD,NRCPFTD                                                
         GOTO1 VRECUP,DMCB,(C'T',AIO),(R6)  DELETE THIS ELEMENT                 
         MVI   OPTION2,1                                                        
         CLI   BYTE,0                                                           
         BNE   *+8                                                              
         MVI   BYTE,C'C'             NEED PUTREC                                
*                                                                               
CEL08    CLC   R.NRCPLTD,NRCPLTD                                                
         BH    CEL30               GET NEXT ELEM                                
         MVC   R.NRCPLTD,NRCPLTD                                                
         GOTO1 VRECUP,DMCB,(C'T',AIO),(R6)  DELETE THIS ELEMENT                 
         MVI   OPTION2,1                                                        
         CLI   BYTE,0                                                           
         BNE   *+8                                                              
         MVI   BYTE,C'C'             NEED PUTREC                                
         B     CEL30                                                            
                                                                                
* DATE RANGE IS ONE DAY APART?                                                  
CEL10    GOTO1 DATCON,DMCB,(3,NRCPFTD),(0,WORK)                                 
         GOTO1 ADDAY,(R1),WORK,WORK+6,F'-1' MINUS 1 FROM TO FTD                 
         GOTO1 DATCON,(R1),(0,WORK+6),(3,WORK+12)                               
         CLC   R.NRCPLTD,WORK+12   LTD IN ELEM = FTD IN TABLE -1                
         BNE   CEL20                                                            
         MVC   R.NRCPLTD,NRCPLTD   SAVE LATER LTD                               
         GOTO1 VRECUP,DMCB,(C'T',AIO),(R6)  DELETE THIS ELEMENT                 
         MVI   OPTION2,1                                                        
         CLI   BYTE,0                                                           
         BNE   *+8                                                              
         MVI   BYTE,C'C'             NEED PUTREC                                
         B     CEL30               DONE, DATES ARE MERGED                       
*                                                                               
CEL20    GOTO1 DATCON,DMCB,(3,NRCPLTD),(0,WORK)                                 
         GOTO1 ADDAY,(R1),WORK,WORK+6,F'1' ADD 1 TO TO LTD                      
         GOTO1 DATCON,(R1),(0,WORK+6),(3,WORK+12)                               
         CLC   R.NRCPFTD,WORK+12   FTD IN ELEM = LTD IN TABLE +1                
         BNE   CEL30                                                            
         MVC   R.NRCPFTD,NRCPFTD   SAVE EARLIER FTD                             
         GOTO1 VRECUP,DMCB,(C'T',AIO),(R6)  DELETE THIS ELEMENT                 
         MVI   OPTION2,1                                                        
         CLI   BYTE,0                                                           
         BNE   *+8                                                              
         MVI   BYTE,C'C'             NEED PUTREC                                
                                                                                
CEL30    CLI   OPTION2,1           ELEM DELETED?                                
         BE    CEL02               YES, R6 POINTS TO NEXT ELEM                  
         LR    R2,R6               PT TO NEXT ELEM                              
         BRAS  RE,NEXTEL                                                        
         BE    CEL02                                                            
*                                                                               
CELX     XIT1                                                                   
         DROP  R,R6                                                             
*                                                                               
*                                                                               
* BUILD PAT GEN REVISION COMMENTS ELEMENTS *                                    
*                                                                               
BSCMT    NTR1  BASE=*,LABEL=*                                                   
         XC    ELEM,ELEM                                                        
         LA    R6,ELEM                                                          
         MVI   ELCODE,X'60'                                                     
         GOTO1 REMELEM                                                          
         USING REVCMTEL,R6                                                      
         SR    R5,R5                                                            
         LA    R2,TRACMT1H                                                      
*                                                                               
BSCMT10  CLI   5(R2),0             TEST FOR A COMMENT IN THIS FIELD             
         BE    BSCMT20                                                          
*                                                                               
         XC    ELEM,ELEM                                                        
         LA    R5,1(,R5)                                                        
         MVI   REVCMTEL,X'65'      PAT GEN COMMENT ELEM                         
         MVI   REVCMTLN,63         ELEMENT LENGTH                               
         STC   R5,REVNUMB          ELEMENT SEQUENCE NUMBER                      
*                                                                               
         GOTO1 ANY                 MOVES DATA LEFT JUSTIFIED INTO WORK          
         MVC   REVCMT,WORK                                                      
         GOTO1 ADDELEM                                                          
*                                                                               
BSCMT20  LLC   R0,0(R2)            NEXT FIELD                                   
         AR    R2,R0                                                            
         LA    RF,TRACMT4H                                                      
         CR    R2,RF               TEST PAST LAST COMMENT LINE?                 
         JH    EXIT                                                             
         LLC   R0,0(R2)            NEXT FIELD                                   
         AR    R2,R0                                                            
         B     BSCMT10                                                          
*                                                                               
*                                                                               
* ADD F1 ACTIVITY ELEMENT                                                       
* BUILD/UPDATE TIME ELEMENT                                                     
*                                                                               
BTIME    NTR1  BASE=*,LABEL=*                                                   
         L     R4,0(R1)            OUTPUT AREA ADDR                             
         LLC   R7,0(R1)            LENGTH OF OUTPUT AREA                        
                                                                                
         BRAS  RE,INITXSP          SET TO XSPOT                                 
         L     R6,AIO                                                           
         MVI   ELCODE,X'70'                                                     
         BRAS  RE,GETEL                                                         
         BE    BTIM20                                                           
                                                                                
         USING REVTMEL,R6                                                       
         XC    ELEM,ELEM                                                        
         LA    R6,ELEM                                                          
         USING REVTMEL,R6                                                       
         MVI   REVTMEL,X'70'                                                    
         MVI   REVTMLN,REVTMEQ                                                  
         EDIT  (TIME,NOW),(8,WORK)                                              
         MVC   REVTIME(2),WORK                                                  
         MVC   REVTIME+2(2),WORK+3                                              
         MVC   REVTIME+4(2),WORK+6                                              
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(5,0),(2,REVDATE)                                    
         MVI   REVTPG,REVPATG                                                   
         CLI   CONREC,C'C'                                                      
         BNE   *+8                                                              
         MVI   REVTPG,REVCABG                                                   
         OC    OPTDATE,OPTDATE                                                  
         BZ    BTIM10                                                           
         MVC   REVDTOV,OPTDATE                                                  
         MVC   REVDTOVR,REVDATE                                                 
                                                                                
BTIM10   GOTO1 ADDELEM                                                          
         B     BTIMXIT                                                          
                                                                                
BTIM20   DS    0H                                                               
         MVC   REVTIME2,REVTIME1                                                
         MVC   REVDATE2,REVDATE1                                                
         MVC   REVTPG2,REVTPG1                                                  
         MVC   REVTIME1,REVTIME                                                 
         MVC   REVDATE1,REVDATE                                                 
         MVC   REVTPG1,REVTPG                                                   
         EDIT  (TIME,NOW),(8,WORK)                                              
         MVC   REVTIME(2),WORK                                                  
         MVC   REVTIME+2(2),WORK+3                                              
         MVC   REVTIME+4(2),WORK+6                                              
         FIXDT02                                                                
         GOTO1 DATCON,DMCB,(5,0),(2,REVDATE)                                    
         MVI   REVTPG,REVPATG                                                   
         CLI   CONREC,C'C'                                                      
         BNE   *+8                                                              
         MVI   REVTPG,REVCABG                                                   
         OC    OPTDATE,OPTDATE                                                  
         BZ    BTIMXIT                                                          
         MVC   REVDTOV,OPTDATE                                                  
         MVC   REVDTOVR,REVDATE                                                 
BTIMXIT  J     EXIT                                                             
*=================================================================              
* PRINT COMMENTS, BOXED OR NOT                                                  
*=================================================================              
                                                                                
PCMT     NTR1  BASE=*,LABEL=*                                                   
         L     R4,0(R1)            OUTPUT AREA ADDR                             
         LLC   R7,0(R1)            LENGTH OF OUTPUT AREA                        
         SR    R2,R2               ZERO LINE CT                                 
         L     R6,AIO                                                           
         TM    UPDSW,UPDSWGR       DO GETREC/CK FOR BOX?                        
         BZ    PCMT04               NO, DONE                                    
         GOTO1 GETREC                                                           
*                                                                               
PCMT04   MVI   HALF,0                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BNE   *+10                                                             
         MVC   HALF,2(R6)          SAVE IND BYTE                                
*                                                                               
PCMT06   L     R6,AIO                                                           
         MVI   ELCODE,X'40'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         CLC   =C'NONE ',3(R6)     TEST SUPPRESS COMMENT                        
         BE    PCMT40                                                           
         CLC   =C'ID=',3(R6)                                                    
         BNE   PCMT08                                                           
         BRAS  RE,NEXTEL                                                        
PCMT08   TM    HALF,X'80'          TEST TO BOX COMMENT                          
         BZ    PCMT10              NO                                           
         GOTO1 BOXER,DMCB,((R7),(R4))                                           
         B     PCMT40                                                           
                                                                                
* FORMAT UNBOXED COMMENT *                                                      
                                                                                
PCMT10   L     R6,AIO                                                           
         BRAS  RE,GETEL                                                         
PCMT12   BAS   RE,CEP              GO CK FOR END OF PAGE                        
         MVC   0(132,R4),SPACES                                                 
         MVI   60(R4),0            FORCE BLANK COMMENTS TO PRINT                
         LLC   RE,1(R6)                                                         
         SH    RE,=H'4'                                                         
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R4),3(R6) *EXECUTED*                                         
PCMT34   LA    R4,0(R4,R7)                                                      
         LA    R2,1(,R2)                                                        
         BRAS  RE,NEXTEL                                                        
         BE    PCMT12                                                           
         MVI   0(R4),0             SET EOL FLAG                                 
PCMT40   NI    UPDSW,X'FF'-UPDSWGR SET OFF GET REC SW                           
         XC    FILENAME,FILENAME                                                
         B     EXIT2                                                            
                                                                                
CEP      NTR1                                                                   
         CH    R7,=H'132'          PRINTING                                     
         BNE   CEP10                                                            
         CH    R2,=H'4'                                                         
         BL    CEP10                                                            
         BRAS  RE,GOSPL                                                         
         MVI   ALLOWLIN,0          RESET                                        
         SR    R2,R2                                                            
         LR    R1,R7                                                            
         SLL   R1,2                                                             
         SR    R4,R1                                                            
CEP10    XIT1  REGS=(R2,R4)                                                     
         EJECT                                                                  
*==========================================================                     
* SUBROUTINE TO PRINT BOXES AROUND TEXT                                         
* AIO MUST HAVE RECORD ADDRESS                                                  
* ELCODE MUST CONTAIN COMMENT ELEM CODE                                         
* P1  (1) = MAXIMUM LEN OF EXPANDED COMMENT                                     
* P1+1(3) = EXPANDED COMMENT OUTPUT AREA                                        
*==========================================================                     
                                                                                
BOXER    NTR1                                                                   
                                                                                
* FIRST - FIND LENGTH OF LONGEST COMMENT *                                      
                                                                                
         L     R3,0(R1)            GET OUTPUT AREA ADDRESS                      
         LLC   R4,0(R1)            GET OUTPUT RECORD SIZE                       
*                                                                               
         L     R6,AIO                                                           
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         SR    R5,R5                                                            
*                                                                               
BOX2     LLC   RE,1(R6)                                                         
         CLC   =C'BOX=',3(R6)                                                   
         BNE   *+8                                                              
         SH    RE,=H'4'                                                         
         CR    R5,RE                                                            
         BH    *+6                                                              
         LR    R5,RE                                                            
         BRAS  RE,NEXTEL                                                        
         BE    BOX2                                                             
                                                                                
* LENGTH IN R5 INCLUDES 3 FOR ELCODE/LEN/SEQ - NOW ADJUST FOR                   
* '*/SP' AND 'SP/*' AT EITHER END                                               
                                                                                
         LA    R5,1(R5)                                                         
                                                                                
* CREATE ROW OF *'S THIS LENGTH                                                 
                                                                                
         EX    R4,BOXSPC                                                        
         MVI   0(R3),C'*'                                                       
         BCTR  R5,0                ADJUST FOR FIRST *                           
         BCTR  R5,0                SET FOR EX                                   
         EX    R5,BOXR7                                                         
         AR    R3,R4               POINT TO NEXT OUTPUT LINE                    
         LA    R5,2(R5)            RESTORE LENGTH                               
*                                                                               
         L     R6,AIO                                                           
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         EJECT                                                                  
BOX4     EX    R4,BOXSPC                                                        
*                                                                               
         LLC   RE,1(R6)                                                         
         LA    RF,3(R6)                                                         
*                                                                               
         CLC   =C'BOX=',0(RF)                                                   
         BNE   *+12                                                             
         SH    RE,=H'4'                                                         
         LA    RF,4(RF)                                                         
*                                                                               
         MVI   0(R3),C'*'                                                       
         SH    RE,=H'4'            SET FOR EX                                   
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   2(0,R3),0(RF) *EXECUTED*                                         
*                                                                               
         LA    RE,0(R3,R5)         POINT TO END OF LINE                         
         BCTR  RE,0                BACK UP                                      
         MVI   0(RE),C'*'                                                       
         AR    R3,R4               POINT TO NEXT LINE                           
         BRAS  RE,NEXTEL                                                        
         BE    BOX4                                                             
*                                                                               
         EX    R4,BOXSPC                                                        
         MVI   0(R3),C'*'                                                       
         BCTR  R5,0                ADJUST FOR FIRST *                           
         BCTR  R5,0                SET FOR EX                                   
         EX    R5,BOXR7                                                         
         AR    R3,R4                                                            
         MVI   0(R3),0             SET END OF BUFFER FLAG                       
EXIT2    XIT1                                                                   
*                                                                               
BOXR7    MVC   1(0,R3),0(R3)  *EXECUTED*                                        
BOXSPC   MVC   0(0,R3),SPACES *EXECUTED*                                        
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
* HEAD HOOK ROUTINE                                                             
                                                                                
HDHK     NMOD1 0,**HDHK**                                                       
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
                                                                                
         MVC   MID1,SPACES                                                      
         MVC   MID2,SPACES                                                      
                                                                                
                                                                                
         CLC   USERNAME,SPACES                                                  
         BH    *+10                                                             
         MVC   USERNAME(L'USERNAME+L'USERADDR),SVUSER                           
         MVC   H1+2(L'USERNAME),USERNAME                                        
         MVC   H2+2(L'USERADDR),USERADDR                                        
                                                                                
         CLI   SVTWPR06,C'N'       SEE IF FAXING                                
         BE    HDHK06               NO                                          
         TM    SVOPTSW1,OPTHDCPY   IF AGENCY COPY RUN                           
         BO    HDHK06                                                           
         CLI   FRSTPGSW,C'Y'       THIS 1ST PAGE                                
         BE    HDHK06                YES - DO NOT SEND /PAGE                    
                                                                                
         CLI   OFFLINE,C'Y'                                                     
         BNE   HDHK04                                                           
                                                                                
         TM    WHEN,X'20'          THIS RUNNING SOON                            
         BO    HDHK04               YES, DO FAX                                 
                                                                                
         CLI   SVTWPR06,C'2'         SEE IF FAXING, BUT AGENCY COPY RUN         
         BE    HDHK06                                                           
*                                    (SPECIAL FAX LINE FOR NEW PAGE)            
HDHK04   LA    RE,P                                                             
         LA    RF,528                                                           
         LR    R1,RF                                                            
         L     R0,AIO1                                                          
         AH    R0,=H'1472'         PUT IN LAST OF I/O1                          
         MVCL  R0,RE                                                            
         MVC   P1,SPACES                                                        
         MVC   P2,SPACES                                                        
         MVC   P3,SPACES                                                        
         MVC   P4,SPACES                                                        
         LLC   R2,SPACING            SAVE SPACING                               
         MVI   SPACING,1                                                        
         MVC   P1(5),=C'/PAGE'                                                  
         MVI   FORCEHED,C'N'                                                    
         IC    R6,FORCEMID                                                      
         MVI   FORCEMID,C'N'                                                    
         MVI   MAXLINES,99                                                      
         MVI   LINE,1               I MUST RESET LINE                           
         GOTO1 SPOOL,DMCB,(R8)                                                  
         LA    RE,P                                                             
         LA    RF,528                                                           
         LR    R1,RF                                                            
         L     R0,AIO1                                                          
         AH    R0,=H'1472'         GET FROM LAST OF I/O1                        
         MVCL  RE,R0                                                            
         STC   R2,SPACING             RESTORE SPACING                           
         STC   R6,FORCEMID                                                      
         MVI   MAXLINES,58                                                      
                                                                                
HDHK06   CLI   OFFLINE,C'Y'                                                     
         BNE   HDHK10                                                           
         LH    RE,SEQNUM          PRINT SEQUENCE NUMBER                         
         CVD   RE,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  H1+104(4),DUB                                                    
         LA    RE,1(RE)                                                         
         STH   RE,SEQNUM                                                        
*                                                                               
HDHK10   CLI   SVTNPR6,C'Y'       BLANK AGENCY NAME & ADDRESS                   
         BE    HDHK12                                                           
         TM    SVOPTSW,OPTNAGY    BLANK AGENCY NAME & ADDRESS                   
         BZ    HDHK14                                                           
HDHK12   MVC   H1+2(33),SPACES                                                  
         MVC   H2+2(33),SPACES                                                  
                                                                                
         FIXDT02                                                                
HDHK14   GOTO1 DATCON,DMCB,(2,STDATEP),(5,H3+47)                                
         MVI   H3+55,C'-'                                                       
         FIXDT02                                                                
         GOTO1 (RF),(R1),(2,ENDATEP),(5,H3+56)                                  
                                                                                
HDHK14K  TM    SVOPTSW,OPTTEST     TEST OPTION TEST                             
         BZ    *+10                                                             
         MVC   H3+8(16),=C'*** TEST RUN ***'                                    
                                                                                
         TM    SVOPTSW1,OPTHDCPY   AGENCY COPY RUN                              
         BO    HDHK14S              YES                                         
                                                                                
         TM    WHEN,X'20'          IF SOON                                      
         BO    HDHK14X             THEN SKIP AGY COPY (REQUESTED OV)            
         CLI   OFFLINE,C'Y'        IF OFFLINE                                   
         BNE   HDHK14X                                                          
         CLI   SVTWPR06,C'2'       AND AGY COPY REQUEST                         
         BNE   HDHK14X                                                          
HDHK14S  MVC   H4+7(17),=C'** AGENCY COPY **'                                   
                                                                                
HDHK14X  DS   0H                                                                
                                                                                
HDHK16   DS   0H                                                                
                                                                                
HDHK18   CLC   PAGE,=H'1'                                                       
         BNE   HDHK40                                                           
                                                                                
* BLANK OUT ANY PREVIOUS STUFF *                                                
                                                                                
         LA    R0,9                                                             
         LA    R1,H5                                                            
*                                                                               
HDHK20   MVC   0(132,R1),SPACES                                                 
         LA    R1,132(R1)                                                       
         BCT   R0,HDHK20                                                        
                                                                                
* FORMAT STANDARD TEXT TO PRINT LINES ONLY ON PAGE 1 *                          
         BAS   RE,CKFIL            GO CK IF DISK HARD COPY REQUIRED             
                                                                                
         B     HDHKX               DO NOT PRINT MIDLINES FOR PAGE 1             
                                                                                
* BLANK HEADLINES AFTER PAGE 1 *                                                
                                                                                
HDHK40   LA    R0,9                                                             
         LA    R1,H5                                                            
                                                                                
HDHK42   MVC   3(60,R1),SPACES                                                  
         LA    R1,132(R1)                                                       
         BCT   R0,HDHK42                                                        
                                                                                
         MVC   H4+85(21),=C'***** CONTINUED *****'                              
                                                                                
         CLI   CONREC,C'C'         TEST CABLE GEN                               
         BNE   HDHK42M                                                          
         MVC   H6+60(11),=C'DATE ISSUED'                                        
         GOTO1 DATCON,DMCB,(5,0),(5,H6+79)                                      
         MVC   H8+3(7),=C'NETWORK'                                              
         MVC   H8+14(4),SAVNET                                                  
         MVC   H8+19(30),SVNETADR                                               
         MVC   H9+14(L'SVMKTNM),SVMKTNM                                         
         MVC   H6+3(6),=C'CLIENT'                                               
         MVC   H6+14(3),QCLT                                                    
         MVC   H6+19(20),CLTNM                                                  
                                                                                
         MVC   H7+3(7),=C'PRODUCT'                                              
         CLI   OPTPROD,0                                                        
         BE    HDHK42C                                                          
         MVC   H7+14(3),OPTPROD                                                 
         MVC   H7+19(L'SVPRDNAM),SVPRDNAM                                       
         B     HDHK45                                                           
HDHK42C  OC    OPTPRGR,OPTPRGR     RUNNING BY PGROUP                            
         BZ    HDHK42G              NO                                          
         MVC   H7+14(4),=C'PGR='                                                
         MVC   H7+19(4),QPGR                                                    
         MVC   H7+24(L'SVPRGNAM),SVPRGNAM                                       
         B     HDHK45                                                           
HDHK42G  MVC   H7+14(7),=C'VARIOUS'                                             
         B     HDHK45                                                           
                                                                                
HDHK42M  DS    0H                                                               
         MVC   H5+48(11),=C'DATE ISSUED'                                        
         GOTO1 DATCON,DMCB,(5,0),(5,H5+67)                                      
                                                                                
         MVC   H7+2(7),=C'NETWORK'                                              
         MVC   H7+12(4),SAVNET                                                  
         MVC   H7+17(30),SVNETADR                                               
         MVC   H8+12(L'SVMKTNM),SVMKTNM                                         
         MVC   H5+2(6),=C'CLIENT'                                               
         MVC   H5+12(3),QCLT                                                    
         MVC   H5+17(20),CLTNM                                                  
                                                                                
         MVC   H6+2(7),=C'PRODUCT'                                              
         CLI   OPTPROD,0                                                        
         BE    HDHK43                                                           
         MVC   H6+12(3),OPTPROD                                                 
         MVC   H6+17(L'SVPRDNAM),SVPRDNAM                                       
         B     HDHK45                                                           
                                                                                
HDHK43   OC    OPTPRGR,OPTPRGR     RUNNING BY PGROUP                            
         BZ    HDHK44               NO                                          
         MVC   H6+12(4),=C'PGR='                                                
         MVC   H6+17(4),QPGR                                                    
         MVC   H6+22(L'SVPRGNAM),SVPRGNAM                                       
         B     HDHK45                                                           
                                                                                
HDHK44   MVC   H6+17(7),=C'VARIOUS'                                             
                                                                                
HDHK45   DS    0H                                                               
         CLI   CONREC,C'C'                                                      
         BNE   HDHK47                                                           
         MVC   H7+60(16),=C'AGENCY OF RECORD'                                   
         CLI   SVTNPR7,C'Y'       BLANK AGENCY OF RECORD N & A                  
         BE    HDHK45C                                                          
         TM    SVOPTSW,OPTNOAOR   BLANK AGENCY OF RECORD N & A                  
         BO    HDHK45C                                                          
         CLC   USERNAME,SPACES                                                  
         BH    *+10                                                             
         MVC   USERNAME(L'USERNAME+L'USERADDR),SVUSER                           
         MVC   H7+79(33),USERNAME                                               
HDHK45C  DS    0H                                                               
         MVC   H8+60(9),=C'ISSUED BY'                                           
         MVC   H8+79(30),SVISNAME                                               
         MVC   H9+79(L'SVEMLADR),SVEMLADR                                       
         OC    SVISTEL,SVISTEL                                                  
         BZ    HDHK45E                                                          
         MVC   H10+60(9),=C'TELEPHONE'                                          
         MVC   H10+79(24),SVISTEL                                               
HDHK45E  LA    R1,H11                                                           
         OC    SVFAXTL,SVFAXTL     ANY CONTACT FAX TEL                          
         BZ    *+20                 NO                                          
         MVC   60(11,R1),=C'CONTACT FAX'                                        
         MVC   79(24,R1),SVFAXTL                                                
         LA    R1,132(R1)                                                       
                                                                                
         OC    SVTS,SVTS                                                        
         BZ    HDHK55                                                           
         MVC   60(16,R1),=C'TRAFFIC SUPPLIER'                                   
         MVC   79(5,R1),SVTS       PRINT TRAFFIC SUPPLIER                       
         LA    R1,132(R1)                                                       
                                                                                
         OC    SVCNAME,SVCNAME     CONTACT NAME                                 
         BZ    HDHK55                                                           
         MVC   60(7,R1),=C'CONTACT'                                             
         MVC   79(L'SVCNAME,R1),SVCNAME                                         
         LA    R1,132(R1)                                                       
         B     HDHK55                                                           
                                                                                
HDHK47   DS    0H                                                               
         MVC   H6+48(16),=C'AGENCY OF RECORD'                                   
         CLI   SVTNPR7,C'Y'       BLANK AGENCY OF RECORD N & A                  
         BE    HDHK48                                                           
         TM    SVOPTSW,OPTNOAOR   BLANK AGENCY OF RECORD N & A                  
         BO    HDHK48                                                           
                                                                                
         CLC   USERNAME,SPACES                                                  
         BH    *+10                                                             
         MVC   USERNAME(L'USERNAME+L'USERADDR),SVUSER                           
                                                                                
         MVC   H6+67(33),USERNAME                                               
HDHK48   DS   0H                                                                
         MVC   H7+48(9),=C'ISSUED BY'                                           
         MVC   H7+67(30),SVISNAME                                               
                                                                                
         MVC   H8+67(L'SVEMLADR),SVEMLADR                                       
                                                                                
         OC    SVISTEL,SVISTEL                                                  
         BZ    HDHK49                                                           
         MVC   H9+48(9),=C'TELEPHONE'                                           
         MVC   H9+67(24),SVISTEL                                                
HDHK49   LA    R1,H10                                                           
         OC    SVFAXTL,SVFAXTL     ANY CONTACT FAX TEL                          
         BZ    *+20                 NO                                          
         MVC   48(11,R1),=C'CONTACT FAX'                                        
         MVC   67(24,R1),SVFAXTL                                                
         LA    R1,132(R1)                                                       
                                                                                
         OC    SVTS,SVTS                                                        
         BZ    HDHK55                                                           
         MVC   48(16,R1),=C'TRAFFIC SUPPLIER'                                   
         MVC   67(5,R1),SVTS       PRINT TRAFFIC SUPPLIER                       
         LA    R1,132(R1)                                                       
                                                                                
         OC    SVCNAME,SVCNAME     CONTACT NAME                                 
         BZ    HDHK55                                                           
         MVC   48(7,R1),=C'CONTACT'                                             
         MVC   67(L'SVCNAME,R1),SVCNAME                                         
         LA    R1,132(R1)                                                       
                                                                                
HDHK55   TM    ANYFLAG,PIGGBSW+COPYSSW                                          
         BZ    HDHK58                                                           
         BM    *+14                                                             
         MVC   67(41,R1),=C'*** PIGGYBACKS AND COPYSPLITS PRESENT ***'          
         B     HDHK58                                                           
         MVC   67(26,R1),=C'*** PIGGYBACKS PRESENT ***'                         
         TM    ANYFLAG,PIGGBSW     ANY PIGGYBACKS                               
         BO    HDHK58                                                           
         MVC   67(26,R1),=C'*** COPYSPLITS PRESENT ***'                         
         TM    ANYFLAG,COPYSSW     ANY COPYSPLITS                               
         BO    HDHK58                                                           
         DS    H'0'                BUG CATCHER                                  
HDHK58   LA    R1,132(R1)                                                       
         MVI   0(R1),0                                                          
                                                                                
HDHK60   BAS   RE,CKFIL            GO CK IF DISK HARD COPY REQUIRED             
                                                                                
* PRINT TITLES *                                                                
                                                                                
         TM    UPDSW,UPDSWPU       PRINTING UNITS                               
         BZ    HDHKX                NO, NO MIDLINES                             
                                                                                
         CLI   SVT3PROF+2,C'Y'                                                  
         BE    *+14                                                             
         MVC   MID1+2(L'MIDLINE2),MIDLINE2                                      
         B     *+10                                                             
                                                                                
         MVC   MID1+2(L'MIDLINE),MIDLINE                                        
                                                                                
         CLI   OFFLINE,C'Y'        ONLY OFFLINE                                 
         BNE   HDHKX                                                            
         CLI   SVTWPR06,C'2'       IF NOT FAXING                                
         BE    HDHK64                                                           
         CLI   SVTWPR06,C'N'       IF NOT FAXING                                
         BE    HDHKX                                                            
                                                                                
         TM    UPDSW,MULTIFAX                                                   
         BZ    HDHKX                                                            
                                                                                
         TM    SVOPTSW1,OPTHDCPY   IF AGENCY COPY RUN                           
         BO    HDHKX                                                            
                                                                                
HDHK64   BAS   RE,CKMID                                                         
                                                                                
HDHKX    XIT1                                                                   
                                                                                
CKFIL    TM    UPDSW,MULTIFAX      MULTI FAX                                    
         BO    CKF                                                              
                                                                                
         CLI   OFFLINE,C'Y'        ONLY OFFLINE                                 
         BNER  RE                                                               
         CLI   SVTWPR06,C'2'       IS AGENCY COPY REQUIRED                      
         BNER  RE                                                               
         TM    SVOPTSW1,OPTHDCPY   IF AGENCY COPY RUN                           
         BOR   RE                                                               
                                                                                
         TM    WHEN,X'20'          IS THIS SOON                                 
         BOR   RE                                                               
                                                                                
CKF      NTR1                                                                   
                                                                                
         LH    R2,=AL2(TSARBLK-SYSD)                                            
         AR    R2,R9                                                            
         USING TSARD,R2                                                         
                                                                                
         ICM   R5,15,H1+104        GET SEQNUM                                   
         MVC   H1+104(4),SPACES    BLK SEQ                                      
*TEMP    MVC   H4+7(17),SPACES     BLK AGENCY COPY                              
         LA    R6,14                                                            
         LA    R1,H14                                                           
CKFIL24  CLC   SPACES,0(R1)                                                     
         BNE   CKFIL26                                                          
         SH    R1,=H'132'                                                       
         BCT   R6,CKFIL24                                                       
         DC    H'0'                                                             
                                                                                
CKFIL26  XC    ELEM(256),ELEM                                                   
         MVI   ELEM+4,C'Y'         SET FORCEHED                                 
                                                                                
         LA    R3,H1                                                            
         LH    R2,=AL2(TSARBLK-SYSD)                                            
         AR    R2,R9                                                            
         USING TSARD,R2                                                         
         SR    R5,R5                                                            
         B     CKFIL32                                                          
                                                                                
CKFIL30  XC    ELEM(256),ELEM                                                   
                                                                                
CKFIL32  LA    RE,132                                                           
         LA    RF,131(,R3)                                                      
CKFIL34  CLI   0(RF),C' '                                                       
         BH    CKFIL36                                                          
         BCTR  RF,0                                                             
         BCT   RE,CKFIL34                                                       
                                                                                
         LA    R5,1(,R5)           ADD TO SKIPPED LINE                          
         B     CKFIL38                                                          
                                                                                
CKFIL36  BCTR  RE,0                                                             
         EX    RE,CKFILMVC                                                      
         LA    RE,7(,RE)                                                        
         STCM  RE,3,ELEM                                                        
                                                                                
         A     RE,TSARBYTE                                                      
         ST    RE,TSARBYTE                                                      
                                                                                
         LH    R1,PRTCT                                                         
         LA    R1,1(,R1)                                                        
         STH   R1,PRTCT                                                         
         STCM  R1,3,ELEM+2                                                      
                                                                                
         CLI   ELEM+4,C'Y'         WAS THIS A FORCE HEAD                        
         BE    CKFIL37                                                          
                                                                                
         LTR   R5,R5                                                            
         BZ    CKFIL37                                                          
         LA    R5,1(,R5)           ADD 1 TO SPACING                             
         STC   R5,ELEM+4                                                        
         SR    R5,R5               RESET                                        
                                                                                
CKFIL37  LA    R1,ELEM                                                          
         ST    R1,TSAREC                                                        
         MVI   TSOFFACT,TSAADD      SET TSAROFF ADD                             
         GOTO1 TSAROFF,TSARD                                                    
                                                                                
         CLI   TSERRS,0                                                         
         BE    CKFIL38                                                          
         DC    H'0'                                                             
CKFIL38  LA    R3,132(,R3)                                                      
         BCT   R6,CKFIL30                                                       
                                                                                
         CLC   PAGE,=H'1'                                                       
         BE    CKFIL40                                                          
                                                                                
* FORCE SPACE AFTER LAST LINE OF HEADING *                                      
                                                                                
         XC    ELEM(256),ELEM                                                   
         MVI   ELEM+1,7                                                         
         LH    R1,PRTCT                                                         
         LA    R1,1(,R1)                                                        
         STH   R1,PRTCT                                                         
         STCM  R1,3,ELEM+2         KEY                                          
                                                                                
         MVI   ELEM+5,2            FORCE 2 LINES OF SPACING                     
         MVI   TSOFFACT,TSAADD      SET TSAROFF ADD                             
         GOTO1 TSAROFF,TSARD                                                    
                                                                                
         CLI   TSERRS,0                                                         
         BE    CKFIL40                                                          
         DC    H'0'                                                             
                                                                                
CKFIL40  DS   0H                                                                
         MVI   H1+131,C' '                                                      
         STCM  R5,15,H1+104        RESTORE SEQNUM                               
         CLI   SVTWPR06,C'2'       REQUIRE AGENCY COPY                          
         BNE   HDHKX                                                            
                                                                                
         TM    WHEN,X'20'                                                       
         BO    HDHKX                                                            
                                                                                
         MVC   H4+7(17),=C'** AGENCY COPY **'                                   
                                                                                
         B     HDHKX                                                            
                                                                                
CKMID    NTR1                                                                   
                                                                                
         LA    R3,MID1                                                          
         XC    ELEM(256),ELEM                                                   
                                                                                
CKFIL54  LH    R2,=AL2(TSARBLK-SYSD)                                            
         AR    R2,R9                                                            
         USING TSARD,R2                                                         
         SR    R5,R5                                                            
         B     CKFIL62                                                          
                                                                                
CKFIL60  XC    ELEM(256),ELEM                                                   
                                                                                
CKFIL62  LA    RE,132                                                           
         LA    RF,131(,R3)                                                      
CKFIL64  CLI   0(RF),C' '                                                       
         BH    CKFIL66                                                          
         BCTR  RF,0                                                             
         BCT   RE,CKFIL64                                                       
                                                                                
         LA    R5,1(,R5)           ADD TO SKIPPED LINE COUNT                    
         B     CKFIL68                                                          
                                                                                
CKFIL66  BCTR  RE,0                                                             
         EX    RE,CKFILMVC                                                      
         LA    RE,7(,RE)                                                        
         STCM  RE,3,ELEM                                                        
                                                                                
         A     RE,TSARBYTE                                                      
         ST    RE,TSARBYTE                                                      
                                                                                
         LH    R1,PRTCT                                                         
         LA    R1,1(,R1)                                                        
         STH   R1,PRTCT                                                         
         STCM  R1,3,ELEM+2                                                      
                                                                                
         CLI   ELEM+4,C'Y'         WAS THIS A FORCE HEAD                        
         BE    CKFIL67                                                          
                                                                                
         LTR   R5,R5                                                            
         BZ    CKFIL67                                                          
         LA    R5,1(,R5)           ADD 1 TO SPACING                             
         STC   R5,ELEM+4                                                        
         SR    R5,R5               RESET                                        
                                                                                
CKFIL67  LA    R1,ELEM                                                          
         ST    R1,TSAREC                                                        
                                                                                
         MVI   TSOFFACT,TSAADD      SET TSAROFF ADD                             
         GOTO1 TSAROFF,TSARD                                                    
                                                                                
         CLI   TSERRS,0                                                         
         BE    CKFIL68                                                          
         DC    H'0'                                                             
CKFIL68  LA    R3,132(,R3)                                                      
                                                                                
* FORCE SPACE AFTER LAST LINE OF HEADING *                                      
                                                                                
         XC    ELEM(256),ELEM                                                   
         MVI   ELEM+1,7            REC LENGTH                                   
                                                                                
         LA    RE,7                                                             
         A     RE,TSARBYTE                                                      
         ST    RE,TSARBYTE                                                      
                                                                                
         LH    R1,PRTCT                                                         
         LA    R1,1(,R1)                                                        
         STH   R1,PRTCT                                                         
         STCM  R1,3,ELEM+2         KEY                                          
                                                                                
         MVI   ELEM+5,2            FORCE 2 LINES OF SPACING                     
                                                                                
         MVI   TSOFFACT,TSAADD      SET TSAROFF ADD                             
         GOTO1 TSAROFF,TSARD                                                    
                                                                                
         CLI   TSERRS,0                                                         
         BE    HDHKX                                                            
         DC    H'0'                                                             
CKFILMVC MVC   ELEM+6(0),0(R3)                                                  
         DROP  R2                                                               
                                                                                
         DS    0H                                                               
MIDLINE  DC    CL106'---------- ROTATION COMMERCIAL ---- COMMERCIAL TITC        
               LE --- --------- OTHER ------------------ CMML RUN TIMESC        
               '                                                                
                                                                                
         DS    0H                                                               
MIDLINE2 DC    CL106'---------- ROTATION COMMERCIAL ---- COMMERCIAL TITC        
               LE --- --------- OTHER ------------------'                       
                                                                                
         EJECT                                                                  
* FOOT HOOK ROUTINE                                                             
                                                                                
FTHK     NMOD1 0,**FTHK**                                                       
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
         CLI   FOOTSW,5            TEST DONE 5 LINES YET                        
         BE    FTHK20              YES - DONE                                   
         LLC   RE,FOOTSW                                                        
         LA    RE,1(RE)                                                         
         STC   RE,FOOTSW                                                        
*                                                                               
         MVC   P,SPACES            FTHK DOES NOT CLEAR P                        
         MVI   P,0                 FORCE RETURN                                 
*                                                                               
         CLI   FOOTSW,1            TEST FIRST LINE                              
         BNE   FTHK10                                                           
                                                                                
         CLI   CONTINUE,C'N'       TEST FINISHED                                
         BE    FTHK10              YES                                          
                                                                                
         MVC   P+2(40),=C'** INSTRUCTIONS CONTINUE ON NEXT PAGE **'             
                                                                                
         CLI   OFFLINE,C'Y'        WE OFFLINE                                   
         BNE   FTHKX                                                            
                                                                                
         CLI   SVTWPR06,C'N'       NOT A FAX                                    
         BE    FTHKX                                                            
                                                                                
         TM    SVOPTSW1,OPTHDCPY   IF AGENCY COPY RUN                           
         BO    FTHKX                YES                                         
                                                                                
         TM    UPDSW,MULTIFAX      MULTI FAX                                    
         BZ    FTHKX                                                            
                                                                                
* FOR MULTI FAX TRANSMISSION SAVE FOOT HOOK IN TSAROFF                          
                                                                                
FTHK02   LH    R2,=AL2(TSARBLK-SYSD)                                            
         AR    R2,R9                                                            
         USING TSARD,R2                                                         
                                                                                
         XC    ELEM(256),ELEM                                                   
         LA    RE,132                                                           
         LA    RF,P+131                                                         
FTHK04   CLI   0(RF),C' '                                                       
         BH    FTHK06                                                           
         BCTR  RF,0                                                             
         BCT   RE,FTHK04                                                        
         DC    H'0'                                                             
                                                                                
FTHK06   BCTR  RE,0                                                             
         EX    RE,FTHKMVC                                                       
         LA    RE,7(,RE)                                                        
         STCM  RE,3,ELEM                                                        
                                                                                
         A     RE,TSARBYTE                                                      
         ST    RE,TSARBYTE                                                      
         LH    R1,PRTCT                                                         
         LA    R1,1(,R1)                                                        
         STH   R1,PRTCT                                                         
         STCM  R1,3,ELEM+2                                                      
                                                                                
         LA    R1,ELEM                                                          
         ST    R1,TSAREC                                                        
         MVI   TSOFFACT,TSAADD      SET TSAROFF ADD                             
         GOTO1 TSAROFF,TSARD                                                    
         CLI   TSERRS,0                                                         
         BE    FTHKX                                                            
         DC    H'0'                                                             
FTHKMVC  MVC   ELEM+6(0),P                                                      
                                                                                
         DROP  R2                                                               
FTHK10   CLI   FOOTSW,3            REACHED LINE 3 YET                           
         BL    FTHKX                                                            
                                                                                
* CHECK FOR FOOTNOTE LINE *                                                     
                                                                                
         CLI   CONTINUE,C'N'       TEST FINISHED                                
         BNE   FTHK20              YES                                          
         L     R2,ASVFTNT                                                       
         LLC   R0,FOOTSW                                                        
         SH    R0,=H'2'                                                         
         B     FTHK14                                                           
FTHK12   CLI   0(R2),0             TEST MORE DATA                               
         BE    FTHK20                                                           
         LA    R2,60(R2)                                                        
FTHK14   BCT   R0,FTHK12                                                        
         CLI   0(R2),0                                                          
         BE    FTHK20                                                           
         MVC   P+2(60),0(R2)                                                    
         B     FTHKX                                                            
*                                                                               
FTHK20   MVI   FOOTSW,0                                                         
         MVC   P,SPACES                                                         
*                                                                               
FTHKX    XIT1                                                                   
                                                                                
         LTORG                                                                  
         EJECT                                                                  
* PRINT ERROR REPORT *                                                          
                                                                                
PER      NMOD1 0,**+PER**                                                       
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
         NI    UPDSW,X'FF'-UPDSWPU      RESET 'PRINTING UNITS'                  
                                                                                
         MVC   TEMPNET,SAVNET                                                   
                                                                                
         SR    R7,R7               FLAG FOR ERROR REPORT ONLY                   
         CLI   PQSW,1              PRINT QUE EVER OPENED                        
         BE    PER04                NO, SOME FUNNY ERROR ONLY                   
         BCTR  R7,0                FORCE NEGATIVE                               
         CLI   SVTWPR06,C'N'       IF N, NO SWITCH                              
         BE    PER06                YES                                         
         TM    WHEN,X'20'          IF SOON, CAN'T SWITCH                        
         BO    PER100                                                           
         CLI   SVTWPR06,C'2'       IF 2, NO SWITCH                              
         BE    PER06                YES                                         
         TM    SVOPTSW1,OPTHDCPY   AGENCY COPY                                  
         BO    PER06                YES, NO SW                                  
                                                                                
         TM    WHEN,X'10'          TEST IF OV                                   
         BZ    PER0A                                                            
         CLI   TRAFAX,C'2'                                                      
         BNE   PER0A                                                            
         CLI   SVTWPR06,C'Y'                                                    
         BNE   PER0A                                                            
         L     RE,AERRTAB                                                       
         L     RF,AERRTABX                                                      
         SR    RF,RE                                                            
         XCEFL                                                                  
                                                                                
PER0A    DS    0H                                                               
                                                                                
* IF WE JUST DID FAX ONLY, HAVE TO SWITCH BACK TO  *                            
* ORIGINAL SETTINGS FOR ANY ERROR REPORT AND LOGOS *                            
                                                                                
         MVI   SPMODE,X'FF'                                                     
         GOTO1 SPOOL,DMCB,(R8)    FORCE CLOSE OF SPOOL                          
         MVI   PQSW,1                                                           
                                                                                
PER00    LA    R1,ELEM                                                          
         ST    R1,SPOOLQLK                                                      
         XC    ELEM(128),ELEM                                                   
         USING PQPLD,R1                                                         
         MVI   QLEXTRA,X'FF'       NEW PARM LIST                                
         OI    SPOOLIND,X'40'      USER VALUES PRESENT                          
                                                                                
         ICM   RE,15,TWAMASTC                                                   
         BNZ   *+6                                                              
         DC    H'0'                                                             
         L     RF,MCVREMOT-MASTD(,RE)                                           
         USING REMOTED,RF                                                       
                                                                                
* SEE IF ORIGINALLY PRINTING DDS SHOP                                           
                                                                                
         OC    MCREMOTE-MASTD(,RE),MCREMOTE-MASTD(RE)                           
         BZ    PER02               YES                                          
         CLI   DIRPRTSW,C'Y'                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*        MVC   REMOTKEY,MCREMOTE-MASTD(RE) RESTORE ORIGINAL DIRECT              
         LA    R1,MCREMOTE-MASTD(,RE)                                           
         MVC   REMOTSYS,MCS2OSYS-MASTD(RE)                                      
         MVC   REMOTPRG,REMOTPRG-REMOTED(R1)                                    
         MVC   REMOTFRM,REMOTFRM-REMOTED(R1)                                    
         MVC   REMOTJID,REMOTJID-REMOTED(R1)                                    
         MVC   REMOTDST,REMOTDST-REMOTED(R1)                                    
         MVC   REMOTCLS,REMOTCLS-REMOTED(R1)                                    
         MVC   REMOTCPY,REMOTCPY-REMOTED(R1)                                    
                                                                                
         TM    WHEN,X'10'                                                       
         BZ    PER01                                                            
         MVI   REMOTFLG,X'FA'                                                   
                                                                                
         MVC   REMOTSYS(3),=C'NTP'                                              
         CLI   CONREC,C'C'         TEST CABLE/GEN                               
         BNE   *+10                                                             
         MVC   REMOTSYS(3),=C'NTB'                                              
                                                                                
         MVC   REMOTSUB,SPACES                                                  
         MVI   REMOTCPY,1                                                       
         MVC   REMOTTY1,SVQLTYP1                                                
         L     RE,TWAMASTC                                                      
         XC    MCARC-MASTD(L'MCARC,RE),MCARC-MASTD(RE)                          
         MVC   REMOTTY1,SVQLTYP1                                                
                                                                                
PER01    DS    0H                                                               
         L     RE,TWADCONS         MAKE SURE OUTPUT DCB ADDRESS SET             
         L     RE,TSPFUSER-TWADCOND(RE)                                         
         L     R1,136(,RE)         PAST SAVED DCB                               
         LA    R1,1(,R1)                                                        
         ST    R1,136(,RE)         FORCE NEW PRINT QUEUE ENTRY                  
         CVD   R1,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  REMOTSUB,DUB        FORCE NE PRINT QUEUE ENTRY                   
         B     PER04                                                            
                                                                                
PER02    XC    REMOTKEY,REMOTKEY                                                
         DROP  RF                                                               
         MVC   QLDESC,SPACES                                                    
         MVC   QLDESC(4),RCPROG                                                 
         MVC   QLCLASS,PLCLASS                                                  
         MVC   REMUSER,=C'STP'                                                  
         MVC   QLTYP1,SVQLTYP1                                                  
         MVI   MCOUTPUT-MASTD(RE),C'P'                                          
         DROP  R1                                                               
                                                                                
PER04    GOTO1 OPENPQ                                                           
                                                                                
PER06    DS    0H                                                               
                                                                                
* CLEAR HEAD AND MIDLINES FROM INST *                                           
                                                                                
         LA    R0,14                                                            
         LA    R1,H1                                                            
         MVC   0(132,R1),SPACES                                                 
         LA    R1,132(R1)                                                       
         BCT   R0,*-10                                                          
*                                                                               
         MVC   MID1,SPACES                                                      
         MVC   MID2,SPACES                                                      
*                                                                               
         LA    RE,PHDG                                                          
         ST    RE,SPECS                                                         
         LA    RE,PHDHK                                                         
         ST    RE,HEADHOOK                                                      
         XC    FOOTHOOK,FOOTHOOK                                                
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         EJECT                                                                  
         USING XRECD,R3                                                         
         L     R3,AERRTAB                                                       
         B     *+8                                                              
*                                                                               
PER10    LA    R3,XRECLEN(R3)           NEXT ERROR                              
*                                                                               
         C     R3,AERRTABX                                                      
         BNL   PEREOF                                                           
         CLI   0(R3),0                                                          
         BE    PEREOF                                                           
                                                                                
         MVC   SAVNET,XNET                                                      
         MVC   P,SPACES                                                         
         MVC   XPPROG,XPROG                                                     
                                                                                
* READ PROGRAM RECORD FOR STANDARD PROGRAM INFORMATION *                        
                                                                                
         BRAS  RE,INITSPT          SET TO SPOT                                  
*                                                                               
         CLI   XPROG,0             TEST NO PROGRAM                              
         BE    PER26                                                            
                                                                                
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING NPGKEY,R4                                                        
         MVC   NPGKTYP,=X'0D20'                                                 
         MVC   NPGKAM,XBAGYMD                                                   
         MVC   NPGKNET,XNETMKT                                                  
         MVC   NPGKPROG,XPROG                                                   
         MVC   NPGKEND,XPERND                                                   
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(11),KEYSAVE                                                  
         BE    PER12                                                            
         MVC   KEY,KEYSAVE                                                      
         MVC   NPGKEND,XPERST                                                   
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(11),KEYSAVE                                                  
         BE    PER12                                                            
         MVC   KEY,KEYSAVE                                                      
         XC    NPGKEND,NPGKEND                                                  
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(11),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         DROP  R4                                                               
*                                                                               
PER12    L     R6,AIO2                                                          
         ST    R6,AIO                                                           
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         AH    R6,DATADISP                                                      
         LR    R5,R6                                                            
*                                                                               
PER14    CLI   0(R6),0                                                          
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLI   0(R6),X'92'                                                      
         BE    PER16                                                            
         SR    RF,RF                                                            
         ICM   RF,1,1(R6)                                                       
         BNZ   *+6                                                              
         DC    H'0'                                                             
         AR    R6,RF                                                            
         B     PER14                                                            
         USING NPGEL92,R6                                                       
PER16    MVC   XPPROGNM,NPGNAME                                                 
         EJECT                                                                  
* GET PROGRAM DAY, 1ST FROM NPGDAY, NPGROT OVERRIDES IF PRESENT,                
* THEN NPGTDAY (OPTIONAL TRAFFIC ELEM) OVERRIDES THAT.                          
                                                                                
         MVC   BYTE,NPGDAY                                                      
         CLI   NPGROT,0            IF NPGROT PRESENT, USE IT                    
         BE    *+10                                                             
         MVC   BYTE,NPGROT                                                      
                                                                                
PER20    CLI   0(R5),0                                                          
         BE    PER25                                                            
         CLI   0(R5),X'E3'                                                      
         BE    PER24                                                            
         SR    RF,RF                                                            
         ICM   RF,1,1(R5)                                                       
         BZ    PER25                                                            
         AR    R5,RF                                                            
         B     PER20                                                            
         USING NPGELE3,R5                                                       
PER24    MVC   BYTE,NPGTDAY                                                     
         DROP  R5                                                               
                                                                                
PER25    GOTO1 UNDAY,DMCB,BYTE,XPPROGDA                                         
                                                                                
         GOTO1 UNTIME,DMCB,NPGTIME,XPPROGTM                                     
         DROP  R6                                                               
         EDIT  XTUNT,(4,XPUNITS)                                                
         GOTO1 DATCON,(R1),(0,XPERST),(5,XPPERIOD)                              
         MVI   XPPERIOD+8,C'-'                                                  
         GOTO1 (RF),(R1),(0,XPERND),(5,XPPERIOD+9)                              
*                                                                               
PER26    CLI   CONREC,C'C'                                                      
         BE    PER27                                                            
         CLI   XTYPE,XTYPE5        SOME UNALLOCATED UNITS                       
         BE    PER30                                                            
         CLI   XTYPE,XTYPE6        SOME UNASSIGNED UNITS                        
         BE    PER30                                                            
                                                                                
PER27    CLI   XTYPE,1                                                          
         BL    PER28                                                            
         CLI   XTYPE,11                                                         
         BNH   *+8                                                              
PER28    MVI   XTYPE,12                                                         
         LLC   R1,XTYPE                                                         
         BCTR  R1,0                                                             
         MHI   R1,L'PERTBLE                                                     
         LA    R1,PERTBLE(R1)                                                   
         MVC   XPEXPLAN(L'PERTBLE),0(R1)                                        
         LA    R7,132(R7)                                                       
         B     PER50                                                            
                                                                                
PER30    LA    R2,XPEXPLAN         ANY UNALLOCATED                              
         DROP  R3                                                               
                                                                                
PER50    GOTO1 SPOOL,DMCB,(R8)                                                  
         B     PER10                                                            
                                                                                
PEREOF   DS    0H                                                               
         L     RE,AERRTAB                                                       
         L     RF,AERRTABX                                                      
         SR    RF,RE                                                            
         XCEFL                                                                  
                                                                                
PER60    TM    WHEN,X'20'          THIS A SOON RUN                              
         BO    PER100                                                           
                                                                                
         CLI   SVTWPR06,C'2'       WAS HARD COPY REQUESTED                      
         BNE   PERX                 NO                                          
         TM    UPDSW,X'01'         ANY PROG SELECTED FOR INSTR                  
         BZ    PERX                 NO                                          
         TM    SVOPTSW1,OPTHDCPY   THIS AGENCY COPY ONLY                        
         BO    PERX                 YES                                         
                                                                                
         MVI   SPMODE,X'FF'                                                     
         GOTO1 SPOOL,DMCB,(R8)    FORCE CLOSE OF SPOOL                          
         MVI   PQSW,1                                                           
                                                                                
* RE-OPEN OR OPEN DIRECT TO AGENCY PRINT QUE ENTRY *                            
                                                                                
         LA    R1,ELEM                                                          
         XC    ELEM,ELEM                                                        
         ST    R1,SPOOLQLK                                                      
         USING PQPLD,R1                                                         
         MVI   QLEXTRA,X'FF'       NEW PARM LIST                                
         OI    SPOOLIND,X'40'      USER VALUES PRESENT                          
         DROP  R1                                                               
                                                                                
         ICM   RE,15,TWAMASTC                                                   
         BNZ   *+6                                                              
         DC    H'0'                                                             
         L     RF,MCVREMOT-MASTD(,RE)                                           
         USING REMOTED,RF                                                       
                                                                                
         MVC   REMOTSYS,MCS2OSYS-MASTD(RE)                                      
                                                                                
         CLI   OFFLINE,C'Y'                                                     
         BNE   PEREOF10                                                         
         L     RE,TWADCONS         MAKE SURE OUTPUT DCB ADDRESS SET             
         L     RE,TSPFUSER-TWADCOND(RE)                                         
                                                                                
         MVI   140(RE),C'Y'        SET EASYLINK STUFF PRINTED                   
                                                                                
         LA    R1,136(,RE)        PAST SAVED DCB                                
         L     RE,0(,R1)                                                        
         LA    RE,1(,RE)                                                        
         CVD   RE,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  REMOTSUB,DUB        FORCE NEW PRINT QUEUE ENTRY                  
         ST    RE,0(,R1)                                                        
                                                                                
PEREOF10 MVC   REMOTJID,=C'PWX'                                                 
         CLI   CONREC,C'C'         TEST CABLE/GEN                               
         BNE   *+10                                                             
         MVC   REMOTJID,=C'CWX'                                                 
         MVC   REMOTTY1,SVFAXARC                                                
         MVI   REMOTFLG,X'FA'                                                   
         MVC   REMOTSYS(3),=C' PG'                                              
         MVC   REMOTSUB,SPACES                                                  
         MVI   REMOTCPY,1                                                       
*        DROP  RF                                                               
         MVC   REMOTTY1,SVFAXARC                                                
         MVC   REMOTDST,TWAORIG                                                 
         OC    TWADEST,TWADEST                                                  
         BZ    *+10                                                             
         MVC   REMOTDST,TWADEST                                                 
         MVI   REMOTCPY,1                                                       
         MVI   REMOTCLS,C'G'                                                    
                                                                                
         GOTO1 OPENPQ                                                           
         TM    WHEN,X'10'                                                       
         BZ    PRTEZ05                                                          
         L     RE,TWAMASTC                                                      
         XC    MCARC-MASTD(L'MCARC,RE),MCARC-MASTD(RE)                          
PRTEZ05  DS    0H                                                               
         SR    R1,R1                                                            
         ST    R1,HEADHOOK         NO HEADHOOK                                  
         ST    R1,FOOTHOOK         OR FOOTHOOK                                  
         ST    R1,SPECS            OR SPECS                                     
                                                                                
         MVI   LINE,99             FORCE NEW PAGE WITHOUT FORCEHED              
         MVC   PAGE,=H'1'          WHICH CAUSES FOOTLINES TO REPRINT            
                                                                                
         CLI   SVTWPR06,C'2'       AGENCY COPY?                                 
         BE    *+12                 YES                                         
PRTEZ10  TM    UPDSW,MULTIFAX      MULTI FAX                                    
         BZ    PRTEZ20              NO                                          
                                                                                
* PRINT EASY COPY OF PATTERN INTSTRUCTION                                       
                                                                                
         BRAS  RE,GTSPL                                                         
         B     PRTEZ10                                                          
                                                                                
PRTEZ20  MVI   SPMODE,X'FF'                                                     
         GOTO1 SPOOL,DMCB,(R8)    FORCE CLOSE OF SPOOL                          
         MVI   PQSW,1                                                           
                                                                                
         LA    R1,ELEM                                                          
         ST    R1,SPOOLQLK                                                      
         XC    ELEM(128),ELEM                                                   
         USING PQPLD,R1                                                         
         MVI   QLEXTRA,X'FF'       NEW PARM LIST                                
         DROP  R1                                                               
         OI    SPOOLIND,X'40'      USER VALUES PRESENT                          
                                                                                
         ICM   RE,15,TWAMASTC                                                   
         BNZ   *+6                                                              
         DC    H'0'                                                             
         L     RF,MCVREMOT-MASTD(,RE)                                           
         USING REMOTED,RF                                                       
                                                                                
         OC    MCREMOTE-MASTD(,RE),MCREMOTE-MASTD(RE)                           
         BZ    ENDPRT10                                                         
         CLI   DIRPRTSW,C'Y'                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*        MVC   REMOTKEY,MCREMOTE-MASTD(RE)                                      
         LA    R1,MCREMOTE-MASTD(,RE)                                           
         MVC   REMOTSYS,MCS2OSYS-MASTD(RE)                                      
         MVC   REMOTJID,REMOTJID-REMOTED(R1)                                    
         MVC   REMOTDST,REMOTDST-REMOTED(R1)                                    
         MVC   REMOTCLS,REMOTCLS-REMOTED(R1)                                    
         MVC   REMOTCPY,REMOTCPY-REMOTED(R1)                                    
         L     RE,TWAMASTC                                                      
         XC    MCARC-MASTD(L'MCARC,RE),MCARC-MASTD(RE)                          
         OC    REMOTKEY,REMOTKEY                                                
         BZ    ENDEZP30                                                         
         MVC   REMOTSYS(3),=C'NTP'                                              
                                                                                
         CLI   CONREC,C'C'         TEST CABLE/GEN                               
         BNE   *+10                                                             
         MVC   REMOTSYS(3),=C'NTB'                                              
                                                                                
         MVC   REMOTTY1,SVQLTYP1                                                
ENDEZP30 DS    0H                                                               
         B     ENDPRT20                                                         
                                                                                
* GO BACK TO LOCAL PRINT *                                                      
                                                                                
ENDPRT10 XC    REMOTKEY,REMOTKEY FORCE BACK TO LOCAL PRINT                      
         DROP  RF                                                               
                                                                                
ENDPRT20 GOTO1 OPENPQ                                                           
         B     PERX                                                             
                                                                                
PER100   CLI   SVTWPR06,C'2'       WAS HARD COPY REQUESTED                      
         BNE   PER200               NO                                          
                                                                                
         LTR   R7,R7               ONLY ERRORS - NO REAL REPORT                 
         BZ    PER200               YES, DON'T PUT OUT REQUEST                  
                                                                                
*NOP     BAS   RE,AREQ             ADD REQUEST FOR AGENCY COPY                  
                                                                                
PER200   TM    SVOPTSW,OPTTEST     TEST OPTION TEST                             
         BO    PERX                                                             
                                                                                
         TM    SVOPTSW1,OPTHDCPY                                                
         BO    PERX                                                             
                                                                                
* UNLOCK FOR SOON UPDATES                                                       
                                                                                
         BRAS  RE,UNLK                                                          
                                                                                
PERX     DS    0H                                                               
         MVC   SAVNET,TEMPNET                                                   
         XIT1                                                                   
         EJECT                                                                  
*&&DO                                                                           
* GENERATE OFFLINE OV REQUEST FOR HARD COPY *                                   
* PUT OUT FOR SOON REQUESTS WITH COPY ONLY  *                                   
                                                                                
AREQ     NTR1                                                                   
                                                                                
         MVC   CONWHEN(2),=C'OV'                                                
         MVC   CONWHEN+2(L'CONWHEN-4),CONWHEN+4                                 
         MVI   CONWHEN+L'CONWHEN-1,C' '                                         
                                                                                
         LLC   R2,TRAOPTH+5                                                     
         LA    R3,TRAOPT(R2)                                                    
         LR    R6,R3                                                            
         SR    R4,R4                                                            
                                                                                
         LTR   R2,R2                                                            
         BZ    AREQ10                                                           
         MVI   0(R6),C','                                                       
         LA    R6,1(,R6)                                                        
         LA    R4,1                                                             
                                                                                
AREQ10   MVI   0(R6),C'#'                                                       
         LA    R4,1(,R4)                                                        
         LA    RF,0(R2,R4)                                                      
         STC   RF,TRAOPTH+5                                                     
                                                                                
         XC    REQHDR,REQHDR                                                    
         MVC   REQUEST,SPACES                                                   
         MVI   REQHDR+15,X'01'     GENERATE LINKED REQUESTS                     
         MVC   REQUEST(2),=C'TB'                                                
         MVC   REQUEST+2(2),AGENCY                                              
                                                                                
         ICM   RE,15,TWAMASTC                                                   
         BNZ   *+6                                                              
         DC    H'0'                                                             
         MVC   REQUEST+5(6),MCREQREC+5-MASTD(RE)                                
                                                                                
         XC    ELEM,ELEM                                                        
         GOTO1 REQTWA,DMCB,(0,ATWA),REQHDR,DATAMGR,RCCOMFAC,ELEM                
                                                                                
         MVC   WORK(L'CONWHEN-4),CONWHEN+2                                      
         MVC   CONWHEN+4(L'CONWHEN-4),WORK                                      
         MVC   CONWHEN(4),=C'SOON'                                              
         XC    CONHEAD,CONHEAD                                                  
                                                                                
         EX    R4,NREQCLR                                                       
         STC   R2,TRAOPTH+5                                                     
         B     PERX                                                             
                                                                                
NREQCLR  MVC   0(0,R3),SPACES                                                   
*&&                                                                             
         EJECT                                                                  
* HEAD HOOK ROUTINE                                                             
                                                                                
PERTBLE  DC    CL36'NET SEED NEVER RUN'                   1                     
         DC    CL36'NO PRODUCTS ALLOCATED TO UNITS      ' 2                     
         DC    CL36'NO PATTERNS TO APPLY TO THESE UNITS ' 3                     
         DC    CL36'NO COMMERCIALS ASSIGNED TO ANY UNITS' 4                     
         DC    CL36'SOME UNITS UNALLOCATED FOR PROGRAM  ' 5                     
         DC    CL36'SOME UNITS UNASSIGNED FOR PROGRAM   ' 6                     
         DC    CL36'POSITIONS ASSIGNED TO THIS PROGRAM'   7                     
         DC    CL36'BILLBOARDS THIS PROGRAM'              8                     
         DC    CL36'NET ASSIGN RUN FOR THIS PROGRAM'      9                     
         DC    CL36'EQUIV PROG-NO BASE COVERS THIS UNIT'  A                     
         DC    CL36'UNKNOWN ERROR                      '  C                     
XTYPE1   EQU   1                   NET SEED NEVER RUN                           
XTYPE2   EQU   2                   ALL UNITS UNALLOCATED                        
XTYPE3   EQU   3                   ALL UNITS UNASSIGNED                         
XTYPE4   EQU   4                   ALL UNITS UNASSIGNED/UNALLOCATED             
XTYPE5   EQU   5                   SOME UNITS UNALLOCATED                       
XTYPE6   EQU   6                   SOME UNITS UNASSIGNED                        
XTYPE7   EQU   7                   POSITIONS ASSIGNED TO THIS PROGRAM           
XTYPE8   EQU   8                   BILLBOARDS FOR THIS PROGRAM                  
XTYPE9   EQU   9                   NET ASSIGN RUN FOR THIS PROGRAM              
XTYPEA   EQU   10                  EQUIV PROG-THIS UNIT NOT COVERED             
XTYPEC   EQU   12                  UNKNOWN ERROR                                
         EJECT                                                                  
                                                                                
* HEAD HOOK ROUTINE                                                             
                                                                                
PHDHK    NMOD1 0,**HDHK**                                                       
         L     RC,SVADGEND                                                      
         USING GEND,RC                                                          
                                                                                
         LH    RE,SEQNUM          PRINT SEQUENCE NUMBER                         
         CVD   RE,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  H1+104(4),DUB                                                    
         LA    RE,1(RE)                                                         
         STH   RE,SEQNUM                                                        
                                                                                
         TM    SVOPTSW,OPTTEST     TEST OPTION TEST                             
         BZ    *+10                                                             
         MVC   H4+85(16),=C'*** TEST RUN ***'                                   
                                                                                
         MVC   H3+10(3),QCLT                                                    
         MVC   H3+15(20),CLTNM                                                  
                                                                                
         MVC   H4+10(4),SAVNET                                                  
                                                                                
         OC    SVTS,SVTS                                                        
         BZ    PHDHKX                                                           
         MVC   H5+2(16),=C'TRAFFIC SUPPLIER'                                    
         MVC   H5+20(L'SVTS),SVTS                                               
                                                                                
         OC    SVCNAME,SVCNAME     CONTACT NAME                                 
         BZ    PHDHKX                                                           
         MVC   H6+2(7),=C'CONTACT'                                              
         MVC   H6+20(L'SVCNAME),SVCNAME                                         
                                                                                
PHDHKX   XIT1                                                                   
         EJECT                                                                  
PHDG     SSPEC H1,3,AGYNAME                                                     
         SSPEC H2,3,AGYADD                                                      
         SSPEC H3,3,C'CLIENT'                                                   
         SSPEC H4,3,C'NETWORK'                                                  
         SSPEC H1,49,C'INSTRUCTIONS ERROR LISTING'                              
         SSPEC H2,49,C'--------------------------'                              
         SSPEC H1,85,REPORT                                                     
         SSPEC H2,85,RUN                                                        
         SSPEC H3,85,PAGE                                                       
         SSPEC H6,03,C'PROGRAM-NAME'                                            
         SSPEC H7,03,C'-------------'                                           
         SSPEC H6,32,C'DAY      TIME'                                           
         SSPEC H7,32,C'----     -----'                                          
         SSPEC H6,52,C'UNITS  FEEDS'                                            
         SSPEC H7,52,C'-----  -----'                                            
         SSPEC H6,66,C'PERIOD              REASON'                              
         SSPEC H7,66,C'-----------------   ------------------'                  
         DC    X'00'                                                            
         LTORG                                                                  
         TITLE 'T21650 - NETWORK PATTERN TRAFFIC INST - RECORD DSECTS'          
         PRINT OFF                                                              
       ++INCLUDE NEGENUNIT                                                      
       ++INCLUDE NETBLOCKN                                                      
                                                                                
       ++INCLUDE SPTRNREV                                                       
       ++INCLUDE SPTRNPAT                                                       
       ++INCLUDE SPTRCMLTXT                                                     
       ++INCLUDE SPTRNFAX                                                       
       ++INCLUDE SPTRPRH                                                        
       ++INCLUDE SPTRNRCP                                                       
                                                                                
CLTHDRD  DSECT                                                                  
       ++INCLUDE SPGENCLT                                                       
                                                                                
ESTHDRD  DSECT                                                                  
       ++INCLUDE SPGENEST                                                       
       ++INCLUDE SPTRNCLT                                                       
       ++INCLUDE SPTRNPRD                                                       
       ++INCLUDE SPTRNPRG                                                       
       ++INCLUDE SPTRNPGRP                                                      
                                                                                
STARECD  DSECT                                                                  
       ++INCLUDE SPGENSTA                                                       
                                                                                
MKTRECD  DSECT                                                                  
       ++INCLUDE SPGENMKT                                                       
                                                                                
PRDHDRD  DSECT                                                                  
       ++INCLUDE SPGENPRD                                                       
       ++INCLUDE SPGENPROG                                                      
       ++INCLUDE SPTRCMML                                                       
       ++INCLUDE SPTRDTXT                                                       
       ++INCLUDE SPTRNCMT                                                       
       ++INCLUDE SPTRNEQPRG                                                     
       ++INCLUDE DDSPOOLD                                                       
       ++INCLUDE DMPRTQL                                                        
       ++INCLUDE DDREPMASTD                                                     
       ++INCLUDE DDREMOTED                                                      
       ++INCLUDE DDCOMFACS                                                      
       ++INCLUDE FAFACTS                                                        
       ++INCLUDE DDTSARD                                                        
       ++INCLUDE FASSB                                                          
       ++INCLUDE DDSPLWORKD                                                     
                                                                                
TWADCOND DSECT                                                                  
       ++INCLUDE DDTWADCONS                                                     
       ++INCLUDE SPTRAFFD                                                       
         ORG   CONTAGH                                                          
       ++INCLUDE SPTRA85D                                                       
                                                                                
       ++INCLUDE DDGENTWA                                                       
       ++INCLUDE SPTRAWORKD                                                     
         PRINT ON                                                               
         EJECT                                                                  
* SVPRDLST ENTRY IS 3 BYTE PRD CODE, THEN WHEN LIST PROCESSED,                  
* 4 BYTE DISK ADDR, 1 BYTE LEN OF COPY NAMES IN EACH REC                        
                                                                                
SVPRDLEN EQU   480/5                                                            
SVPRDENT EQU   5                                                                
                                                                                
SYSD     DSECT                                                                  
         ORG   SVSPAREX                                                         
SPTR50RR DS    A                                                                
QSORT    DS    A                                                                
VTRPACK  DS    A                                                                
SVR6     DS   0A                                                                
SVR2     DS   0A                                                                
SVR3     DS    A                                                                
ASVSTOR  DS    A                                                                
VGTBROAD DS    A                                                                
AUNTABLE DS    A                   UNIT TABLE                                   
MAXUNTBL DS    A                                                                
AUNTABL2 DS    A                   UNIT TABLE                                   
MAXUNTB2 DS    A                                                                
APATABLE DS    A                   PATTERN TABLE                                
MAXPATBL DS    A                                                                
ANETABLE DS    A                   BYPASSED NETWORKS TABLE                      
MAXNETBL DS    A                                                                
APNAMTAB DS    A                   PROGRAM NAME TABLE                           
MXPNAMTB DS    A                                                                
AERRTAB  DS    A                                                                
AERRTABX DS    A                                                                
*                                                                               
APRGTAB  DS    A                   PROGRAM UNIT COUNTER                         
MXPRGTAB DS    A                                                                
*                                                                               
ASVFTNT  DS    A                                                                
NEXTADDR DS    A                                                                
ASVPRINT DS    A                                                                
ASVCPYLS DS    A                                                                
ASVNEXT  DS    A                   1ST TABLE ENTRY ON NEXT SCREEN               
TSAROFF  DS    A                   TSAROFF CORE RESIDENT T00A7D                 
ACMLTAB  DS    A                   ADDR OF COMML TABLE FOR BINSRCH              
MXCMLTAB DS    A                   END OF TABLE                                 
NCMLTAB  EQU   200                 NUMBER OF RECORDS IN TABLE                   
*                                                                               
*                                                                               
* CML TABLE FOR  OPTICA                                                         
ACMLTBL  DS    A                   ADDL CMMLM DATA TABLE                        
ACMLTBLX DS    A                   END OF SAVE AREA                             
NCOMMLT  EQU   200                 NUMBER OF RECORDS IN TABLE                   
*                                                                               
*                                                                               
SVPTNADR DS    F                   CURRENT ADDRESS IN PATTERN TABLE             
SVUNTADR DS    F                   CURRENT ADDRESS IN UNIT TABLE                
TSARBUFL DS    A(L'ELEM*5000)     BUFFER LENGTH FOR 600 RECORDS                 
TSARBUFF DS    A                   ADDRESS OF GETMAIN BUFFER                    
TSARBYTE DS    F                   CT OF TSAR BYTE SENT                         
TSARLAST DS    H                   LAST TSAR RECORD NUMBER                      
TSRKEYF  DS    H                   SAVE FIRST TSAR KEY NUMBER                   
TSRKEYL  DS    H                     AND LAST                                   
PRTCT    DS    H                   CT OF PRINT LINES SAVED                      
UNTABCT  DS    H                   CT OF UNTABLE ENTRIES                        
NAMTABCT DS    H                   CT OF NAMTABLE ENTRIES                       
PBYTE    DS    CL1                 DOING PERCENTAGES                            
NXTALPHA DS    CL1                 DISP INTO ALPHA TABLE                        
                                                                                
* SAVED STORAGE (TWA 2) STARTS HERE *                                           
                                                                                
ANETIO   DS    A                                                                
ANETBLK  DS    A                                                                
PTTNCTR  DS    F                                                                
SVTHIS   DS    F                                                                
SAVEKEY  DS    CL(L'KEY)                                                        
NBUSERL  DS    CL16                NETPAK N0 PROFILE                            
SVTWPROF DS    CL16                                                             
SVTWPR06 EQU   SVTWPROF+5                                                       
SVTWPR11 EQU   SVTWPROF+10                                                      
                                                                                
SEQNUM   DS    H                                                                
CVRDAYS  DS    H                                                                
SVMEDIA  DS    C                   SAVE MEDIA                                   
SAVNET   DS    CL4                 SAVE THIS NETWORK (FOR NET=ALL)              
SVNETFX2 DS    CL4                 SAVE FIRST NETWORK FOR OV FAX=2              
SVCMCLTN DS    CL20                SAVE CLIENT CMML NO.                         
MYTN2PR6 DS    CL1                 SAVE CAL/BROAD/WEEKLY                        
SVTN2PRE DS    CL1                 PRINT CLT CML#                               
TEMPNET  DS    CL(L'SAVNET)                                                     
PGROUP   DS    XL3                 STORE PRODUCT GROUP CODE                     
SVCONLST DS    XL13                SAVE KEY OF CONTACT LIST RECORD              
SVFEED   DS    CL4                                                              
SVPROG   DS    CL6                                                              
SVPROGNM DS    CL16                                                             
SVPROGDT DS    XL2                                                              
SVCMLCOD DS    CL8                                                              
SVCMLADI DS    CL12                AD-ID CODE                                   
SVCMLADR DS    CL12                SAVED AD-ID CODE IN PROT RTN                 
SVHIDEF  DS    CL12                SAVE HIDEF CODE                              
SVCNTRC  DS    CL12                SAVE CENTER CUT CODE                         
SVADISCI DS    CL12                UNPACKED 8-12 CHAR ADID-ISCII                
SVCMLOPT DS    CL8                 8 CHAR ISCII OR PACKED ADID                  
MYSVNET  DS    CL4                                                              
CMTFLAG  DS    XL3                                                              
SKIPBLNK EQU   X'80'               SKIP BLANKS IN COMMENT RECORD                
NOBLNK   EQU   X'40'               SKIP BLANKS IN BODY                          
SVPBMSG  DS    CL12                SAVE PB MSG FOR LATER PRINTING               
SVCMLLEN DS    XL1                                                              
SVCMLOVR DS    XL2                 SAVE CMLOVRD1                                
SVCMLOV2 DS    XL2                 SAVE CMLOVRD2                                
SVCMLCD2 DS    CL8                 P/B CML                                      
SVCTCMLR DS    CL20                SAVE CLIENT CMML NO. ROTATION                
SVPRD    DS    CL3                 SAVE PRODUCT CODE                            
                                                                                
SVCMLDS  DS    CL24                COMMERCIAL EXT DESC 1                        
SVCMLDS2 DS    CL24                COMMERCIAL EXT DESC 2                        
SVCMLDS3 DS    CL24                COMMERCIAL EXT DESC 3                        
SVFAXTL  DS    CL24                CONTACT FAX FORM CLIENT LIST REC             
SVISNMTE DS   0CL54                                                             
SVISNAME DS    CL30                                                             
SVISTEL  DS    CL24                                                             
SVNETREV DS    CL1                 SAVE HIGHEST NETWORK REV #                   
                                                                                
NXTNET   DS    CL4                 NEXT NETWORK TO DO (FOR NET=ALL)             
*                                  X'FF' IS END OF CLIENT                       
*                                                                               
SVLOCK   DS    CL8                 SAVE LOCK INFO FOR UNLOCK                    
SVSVPROD DS    CL3                 SAVE PROD LOCK INFO FOR UNLOCK               
SVCPROD  DS    CL3                 3 CHAR PROD FOR LOCKING                      
*                                                                               
FLDH     DS    CL8                                                              
FLD      DS    CL40                                                             
SVEMLADR DS    CL40                SAVE EMAIL ADDRESS FOR HEADLINES             
                                                                                
SVSFAX   DS   4CL12                NETWORK FAX - FROM STATION RECORD            
*                                          OR DAYPART RECORD (MAX 4)            
SVFAXNXT DS    F                   SAVE ADDRESS OF THIS FAX                     
SVQLTYP1 DS    CL1                 STORE SOON ARCHIVE SETTING                   
SVFAXARC DS    CL1                 ARCHIVE FOR FAX COPIES                       
PROFKEY  DS    CL5                 READ PROGRAM PROFILE RECORD                  
*                                                                               
SVSMKT   DS    CL4                 MARKET CODE                                  
SVMKTNM  DS    CL24                MARKET NAME FROM MARKET RECORD               
SVPRGPRG DS    CL6                                                              
SVDPC    DS    CL1                                                              
SVNETADR DS    CL30                                                             
SVUNTDTS DS   0XL4                                                              
SVUNTSTR DS    XL2                                                              
SVUNTEND DS    XL2                                                              
*SM                                                                             
SVCMLSTR DS    XL3                                                              
SVCMLEND DS    XL3                                                              
*SM                                                                             
NUCPRDS  DS   0CL6                                                              
NUCPRD1  DS    CL3                                                              
NUCPRD2  DS    CL3                                                              
NUCPRD3  DS    CL3                                                              
NUCPRD4  DS    CL3                                                              
NUCPRD5  DS    CL3                                                              
NUCPRD6  DS    CL3                                                              
                                                                                
         DS    0D                                                               
MYPSTIM  DS    H                                                                
MYPETIM  DS    H                                                                
MYUSTIM  DS    H                                                                
MYUETIM  DS    H                                                                
SVPRGNAM DS    CL24                SAVED PRODUCT GROUP NAME                     
SVPRDNAM DS    CL20                SAVED PRODUCT NAME                           
                                                                                
BASEPRG  DS    CL6                                                              
BASEDTS  DS   0XL4                                                              
BASESTR  DS    XL2                                                              
BASEEND  DS    XL2                                                              
BASECT   DS    XL1                                                              
                                                                                
SVCOFFIC DS    XL1                 SAVED OFFICE FROM CLIENT HEADER              
                                                                                
FOOTSW   DS    C                                                                
FRSTPGSW DS    C                                                                
CONTINUE DS    C                                                                
HEADSW   DS    C                                                                
REQSW    DS    C                                                                
DIRPRTSW DS    C                   Y IF PRINTING DIRECT                         
PRINTED  DS    C                                                                
                                                                                
* FROM VPER RTN - PERIOD FIELD IN HEADING ON SCREEN                             
                                                                                
WKDATEP  DS    XL2                 SAVED START DATE FOR WEEKLY INSTR            
STDATEP  DS    XL2                                                              
ENDATEP  DS    XL2                                                              
STDATEB  DS    XL3                                                              
ENDATEB  DS    XL3                                                              
PERIOD   DS    XL3                                                              
STDATE   DS    CL6                                                              
ENDATE   DS    CL6                                                              
PERDTS   DS    0CL12                                                            
PSTDATE  DS    CL6                 PRINTABLE START DATE (YR2000)                
PENDATE  DS    CL6                           END DATE                           
                                                                                
NXPATSEQ DS    H                                                                
NETMKT   DS    H                                                                
*                                                                               
UNSEEDED DS    CL1                                                              
UNALLOC  DS    CL1                                                              
*                                                                               
NETWORK  DS    CL4                 KEEP NETWORK/PROGRAM TOGETHER                
PROGRAM  DS    CL6                     AND IN ORDER                             
                                                                                
NETCREVN DS    XL1                 CURRENT REVISION #                           
OREVNUM  DS    XL1                 OTHER REVISION NUMBER                        
OREVNN   DS    XL1                 OTHER NETWORK REV #                          
                                                                                
NETFLAG  DS    XL1                                                              
NETCSPRD EQU   X'80'               COPY SPLIT UNIT                              
NETINSRN EQU   X'20'               INSTRUCTIONS RUN THIS REVISION               
*                                  (NEED NEW REV NUMBER)                        
NETIDTE  DS    XL3                 LAST INSTRUCTION DATE                        
INSPRTSW DS    CL1                                                              
REPORTOK DS    CL1                 REPORT RAN OKAY - USED FOR SEED REQ          
*                                                                               
SVSECPID DS    CL8                 CHAR VALUE OF PID                            
FAXSTAT  DS    XL1                                                              
FAXMISS  EQU   X'80'               FAX NUMBER MISSING                           
ANYFLAG  DS    XL1                                                              
TABLESW  EQU   X'80'               TABLE IS BUILT                               
NETFOUND EQU   X'40'               AN LEAST ONE NETWORK FOUND                   
ONEPROG  EQU   X'20'               ONE PROGRAM ENTRY (AFTER CTP)                
CLTCMLNO EQU   X'08'               JUST GET CLT CML #                           
SKIPNET  EQU   X'04'               SKIP THIS NETWORK                            
COPYSSW  EQU   X'10'               COPY SPLIT PRESENT                           
PIGGBSW  EQU   X'01'               PIGGY BACKS PRESENT                          
*                                                                               
UPDSW    DS    CL1                                                              
UPDSWNP  EQU   X'80'               NO PATTERNS FOUND                            
UPDSWFU  EQU   X'40'               FIND ONLY 1 UNIT IN BLUNT RTN                
UPDSWPU  EQU   X'20'                PRINTING UNITS, PRT MIDLNS IN HDHK          
*                                   INSTR PRINTED FOR PROGRAM SEND DIP          
UPDSWGR  EQU   X'08'             08 DO GETREC IN PCMT RTN                       
MULTIFAX EQU   X'04'             04 MULTI-FAX PROGRAM SWITCH                    
*                                01 AT LEAST ONE PROGRAM SELECTED FOR           
*                                   INSTRUCTIONS                                
*                    X'FF' NO UNTS FOUND BYPASS THIS NET (FOR NET=ALL)          
         DS   0D                                                                
QUESTOR  DS    CL16                                                             
QPGR     DS    CL4                 PRODUCT GROUP CODE                           
                                                                                
OPTIONS DS     0CL(OPTIONX-SVOPTSW)                                             
*                                                                               
SVOPTSW  DS    XL1                                                              
*                                                                               
OPTTEST  EQU   X'80'               NO UPDATES TO DISK FILES                     
OPTNOPAT EQU   X'40'               BYPASS NETWORKS W/NO PATTERN                 
OPTPSORT EQU   X'20'               SORT BY PRODUCT                              
OPTNEW   EQU   X'10'               RUN ONLY ORIGINALS                           
OPTPTTN  EQU   X'08'               PRINT OUT PATTERNS USED                      
OPTUNAL  EQU   X'04'               ALLOW UNALLOCED UNITS                        
OPTNAGY  EQU   X'02'               DON'T PRINT AGENCY NAME & ADDRESS            
OPTNOAOR EQU   X'01'               DON'T PRINT AGENCY OF RECORD N & A           
*                                                                               
SVOPTSW1 DS    XL1                                                              
*                                                                               
OPTUNSD  EQU   X'80'               ALLOW UNSEEDED UNITS FOR CBL/GEN             
OPTHDCPY EQU   X'40'               IF AGENCY COPY ONLY RUN                      
USEDEF   EQU   X'20'               PRINT A DEFAULT COMMENT                      
PRNTDCMT EQU   X'10'               COMMENTS HAVE BEEN PRINTED                   
OPTTS    EQU   X'08'               TRAFFIC SUPPLIER                             
OPTNTS   EQU   X'04'               NON-TRAFFIC SUPPLIER                         
OPTNETS  EQU   X'02'               ALL NETWORKS REQUEST                         
OPTPER   EQU   X'01'               OVERRRIDE PERIOD (TN2PR6)                    
*                                                                               
SVOPTSW2 DS    XL1                                                              
OPTSEED  EQU   X'80'               ALLOW CABLE/GEN EVEN IF ERRS                 
*MNV                                                                            
OPTDIGI  EQU   X'40'               OVERRIDE SUPPRESS DIGITAL                    
*MNV                                                                            
                                                                                
OPTDATE  DS    XL2                                                              
OPTPROD  DS    CL3                                                              
OPTPRD   DS    XL1                                                              
OPTPRGR  DS    XL2                                                              
SVOPTTN2 DS    XL1                                                              
SVOPTTN1 DS    XL1                                                              
OPTIONX  EQU   *                                                                
                                                                                
*                                                                               
SVLGKEY  DS    CL(L'KEYSAVE)       SAVE LAST GOOD KEY                           
                                                                                
SVCNAME  DS    CL30                SAVE TRAFFIC SUPPLIER CONTACT NAME           
SVTS     DS    CL5                 SAVE TRAFFIC SUPPLIER                        
SVOTSLEN DS    CL1                 AND ITS LENGTH                               
                                                                                
* C=CABLE, N=NETWORK, O=OTHER, S=SYNDICATION                                    
                                                                                
SVOPTMED DS    CL1                 MEDIA (FOR ALL NETWORKS REQUEST)             
                                                                                
* 1=CABLE, 0=NETWORK, 3=OTHER, 2=SYNDICATION                                    
                                                                                
SVOPTMD  DS    XL1                 MEDIA (FOR ALL NETWORKS REQUEST)             
*                                                                               
SVFLAG   DS    XL1                                                              
*                                                                               
*        EQU   X'80'               OUTSIDE TRAFFIC SUPPLIER FOUND               
*        EQU   X'40'               NON-TRAFFIC SUPPLIER FOUND                   
CONVSW   EQU   X'20'               CONVERTED RECORDS                            
SVPRGERR EQU   X'10'               AT LEAST ONE ERROR FOUND                     
SVFLGFDD EQU   X'08'               FEED NO NATIONAL                             
ENTDEL   EQU   X'04'               ENTRY DELETED                                
SVTAG    EQU   X'02'               TAGS ON INSTRUCTIONS                         
SEEMORFL EQU   X'01'               SEE ADDTNL INFO MSGS                         
                                                                                
BINDMCB  DS    6F                                                               
*OPTICA                                                                         
BINPAR7  DS    6F                                                               
*                                                                               
SVPROD   DS    CL3                                                              
SVPROD2  DS    CL3                                                              
SVTDTE   DS   0XL4                                                              
SVFTD    DS    XL2                 FTD                                          
SVLTD    DS    XL2                 LTD                                          
OPTICASW DS    C                                                                
*                                                                               
*OPTICA                                                                         
*                                                                               
         DS    D                                                                
EQVPTBL  DS    XL(30*L'EQVENT)     EQUIVALENT PROGRAM TABLE                     
*                                                                               
                                                                                
* IF AN ENTRY IN THE UNTABLE IS PARTIALLY COVERED, THEN                         
* A NEW ENTRY IS CREATED                                                        
                                                                                
         DS    D                                                                
UNTWORK  DS    CL(UNTNEXT-UNTPROD)                                              
*                                                                               
         DS    D                                                                
PNAMTAB  DS    6400X           PROGRAM TABLE                                    
PNAMTABX EQU   *                                                                
         DS    D                                                                
NETBLK   DS    1024X                                                            
NETBLKX  EQU   *                                                                
* BYPASSED NETWORKS TABLE                                                       
                                                                                
         DS    D                                                                
NETABLE  DS    XL((50*4)+8)    ROOM FOR 50 ENTRIES (DDS ONLY ONLINE)            
ENDNETBL EQU   *                                                                
*                                                                               
OPTPGRL  DS    XL1500              HOLDS 500 PRODUCTS (3 CHAR EACH)             
OPTPGRLX EQU   *                                                                
*                                                                               
ENDPGTBL EQU   *                                                                
                                                                                
         DS    0D                                                               
TSARBLK  DS    CL(TSARDL2)                                                      
ENDSYSD  EQU   *       IF THIS ADDRESS MORE THAN 2F08, PAST END OF SYSD         
                                                                                
         EJECT                                                                  
* DSECT FOR UNIT ACTIVITY LIST ENTRIES *                                        
                                                                                
UNTABLED DSECT                                                                  
UNTENT   DS   0CL(UNTNEXT-UNTPROD)                                              
UNTSRT   DS   0CL(UNTFLG-UNTPROD)                                               
UNTCOMP  DS   0CL(UNTLODTE-UNTPROD)                                             
*                                                                               
UNTPROD  DS    CL3      0          PRODUCT                                      
UNTSLN   DS    XL1      3                                                       
UNTPROD2 DS    CL3      4          PRODUCT                                      
UNTSLN2  DS    XL1      7          UNIT LENGTH                                  
UNTDP    DS    CL1      8          DAY PART CODE                                
UNTFEED  DS    CL4      9          FEED                                         
UNTPROG  DS    CL6     13          PROGRAM CODE                                 
*                   END OF UNTCOMP                                              
UNTLODTE DS    XL2     19          LOWEST DATE FOR PROGRAM                      
UNTHIDTE DS    XL2     21          HIGHEST DATE FOR PROGRAM                     
UNTSEQ   DS    XL1     23          POINTER TO PATTERN FOR THIS UNIT             
*                   END OF UNTSRT                                               
UNTTIME  DS    XL4     25          UNIT START/END TIME                          
UNTSEQNO DS    XL3     29          PATTERN SEQUENCE NUMBER                      
*                                                                               
UNTFLG   DS    XL1     32                                                       
UNTFLGPT EQU   X'80'               UNIT HAS BEEN PRINTED                        
UNTXCLUD EQU   X'40'               EXCLUDED UNIT - TRAFFIC SUPPLIER             
UNTFLNON EQU   X'20'               NO NATIONAL UNIT                             
UNTCNTD  EQU   X'10'               MARK UNITS ALREADY COUNTED                   
UNTFLGSW EQU   X'08'               PRDS SWAPPED                                 
UNTFLGCS EQU   X'04'               COPY SPLIT                                   
UNTTAG   EQU   X'02'               5 SECOND TAG                                 
UNTSUMM  EQU   X'01'               UNITS HAVE BEEN PRINTED ON SUMMARY           
*                                                                               
UNTFLG2  DS    XL1     33                                                       
UNTFUNSD EQU   X'80'               UNIT IS NOT SEEDED                           
UNTBLBD  EQU   X'40'               UNIT IS BILLBOARD                            
UNTNETAS EQU   X'20'               UNIT ASSIGNED VIA NET ASSIGN                 
UNTCT    DS    XL2     34                                                       
UNTCVRD  EQU   X'80'                                                            
UNTACCST DS    XL4                 ACTUAL COST                                  
UNTKEYCS DS    XL4                 KEY COST                                     
UNTDAY   DS    XL1                 DAY                                          
UNTROT   DS    XL1                 ROTATION                                     
UNTNEXT  EQU   *                                                                
                                                                                
* DSECT FOR EQUIVALENT PROGRAM CODE ENTRIES                                     
                                                                                
EQVPTBLD DSECT                                                                  
EQVENT   DS   0CL(EQVNEXT-EQVEPRG)                                              
EQVEPRG  DS    CL6                EQUIVALENT                                    
EQVBPRG  DS    CL6                BASE PROGRAM CODE                             
EQVSDT   DS    XL2                START DATE                                    
EQVEDT   DS    XL2                END                                           
EQVSMODT DS    XL2                START PERIOD DATE                             
EQVEMODT DS    XL2                END                                           
EQVUSED  DS    XL1                                                              
EQVCT    DS    XL1                ENTRY COUNTER                                 
EQVNEXT  EQU   *                                                                
         EJECT                                                                  
* DSECT FOR UNIT ACTIVITY LIST ENTRIES *                                        
                                                                                
PATABLED DSECT                                                                  
PATENT   DS    0CL(PATNEXT-PATYPE)                                              
PATCOM   DS    0CL(PATPRD-PATYPE)                                               
PATSORT  DS    0CL(PATREF-PATYPE)                                               
PATYPE   DS    XL1       0                                                      
*                                                                               
PATQALL  EQU   64                  ALL NETWORKS                                 
PATQMED  EQU   32                  MEDIA                                        
PATQFDMD EQU   28                  MEDIA & FEED                                 
PATQDPMD EQU   24                  MEDIA & DAYPART                              
PATQNET  EQU   16                  NETWORK                                      
PATQDPT  EQU   08                  DAYPART                                      
PATQPROG EQU   04                  PROGRAM                                      
PATQFEED EQU   02                  FEED                                         
PATQDPFD EQU   01                  DAYPART & FEED                               
*                                                                               
PATPROG  DS    CL6       1         PROGRAM (BLANK IF ALL)                       
PATDP    DS    CL1       7         DAYPART                                      
PATFEED  DS    CL4       8         FEED                                         
PATPRD   DS    CL3      12         PRODUCT                                      
PATSLN   DS    XL1      15         UNIT LENGTH                                  
PATPRD2  DS    CL3      16         PARTNER PRODUCT                              
PATSLN2  DS    XL1      19         UNIT LENGTH                                  
PATSTR   DS    XL2      20         START/END FROM UNITS (WITH ROTATION)         
PATEND   DS    XL2      22                                                      
PATREF   DS    XL3      24                                                      
                                                                                
PATPSTR  DS    XL2      27         PAT START/END DATES W/IN REQ PERIOD          
PATPEND  DS    XL2      29                                                      
PATSTIM  DS    XL2      31                                                      
PATETIM  DS    XL2      33                                                      
PATKEY   DS    XL1      35                                                      
*        EQU   X'80'               80 = PROG SPEC                               
*        EQU   X'40'               40 = FEED SPEC                               
*        EQU   X'20'               20 = D/P SPEC                                
*        EQU   X'10'               10 = ALL NETWORKS PATTERN                    
*        EQU   X'08'               08 = MEDIA SPEC                              
*                                                                               
PATFLG   DS    XL1      36                                                      
PATRPTD  EQU   X'80'              80 - PTN USED IN SVTN2PRO+10                  
PATFLUFN EQU   X'40'              40 - PAT DATE UFN-UNTIL FURTHER NOTE          
PATPRT   EQU   X'20'              20 - PATTERN PRINTED                          
PATTAG   EQU   X'10'              10 - UNIT IS TAG                              
*        EQU   X'08'              08 - FEED TO NATIONAL UNIT                    
PATFLFDD EQU   X'04'              04 - FEED NO NATIONAL                         
*        EQU   X'02'              02 - MISSED                                   
*        EQU   X'01'              01 - MEDIA ORIGINATED FEED                    
PATFLG2  DS    XL1      37                                                      
PATUSED  EQU   X'80'               PATTERN USED                                 
PATXXXX  EQU   X'40'               DON'T PRINT THIS PATTERN                     
PATSMDAY EQU   X'20'               ONE DAY PAT SAME DATE AS PREVIOUS            
PATTBA   EQU   X'10'               PATTERN ENTRY IS TBA - DO NOT APPLY          
*                                                                               
PATSEQ   DS    XL1      38         RELATIVE PATTERN NUMBER IN LIST              
PATSEQNO DS    XL3      39         SEQNUM FROM PATTERN RECORD                   
PATUNTCT DS    XL2      42                                                      
PATCTFLG DS    XL1      44                                                      
PATPROC  EQU   X'80'                                                            
PATSUMM  EQU   X'40'                                                            
PATCNT   DS    XL1      45                                                      
PATCOVER DS    XL1      46                                                      
PATDATES DS    XL4      47         PATTERN DATES FROM PATTERN RECORD            
         DS    XL1      51                                                      
PATNEXT  EQU   *                                                                
         EJECT                                                                  
PRGTABLD DSECT                                                                  
PRGENT   DS    0CL24                                                            
PRGPROG  DS    CL6                                                              
PRGUNITS DS    XL2                TOTAL UNITS                                   
PRGFEEDS DS    XL2                TOTAL FEEDS                                   
PRGUNSD  DS    XL2                TOTAL UNITS UNASSIGNED (NO CMLS)              
PRGUNAL  DS    XL2                TOTAL UNITS UNALLOCATED (NO PRD)              
PRGIDTE  DS    XL3                LAST INSTR DATE                               
PRGCREVN DS    XL1                CURRENT REVISION NUMBER                       
PRGCREVD DS    XL2                CURRENT REVISION DATE                         
PRGHIDTE DS    XL2                HIGHEST DATE FOR PROGRAM                      
PRGFLAG  DS    XL1                80 - NO PROGRAM FOR THIS PERIOD               
PRGF_SKIP   EQU  X'80'               SKIP THIS PROGRAM                          
PRGF_INSRUN EQU  X'20'            20 - INST PRINTED FOR THIS REVNUM             
*                                 08 - NET ASSIGN RUN FOR THIS PROG             
*                                      SINCE NET SEED                           
*                                 04 - POSITIONS ASSIGNED THIS PROG             
PRGF_BB  EQU   X'02'              02 - BILLBOARDS ASSIGNED THIS PROG            
PRGF_NAS EQU   X'01'              01 - NET ASSIGN LAST RUN                      
PRGNREVN DS    XL1                NETWORK REVISION NUMBER                       
PRGNEXT  EQU   *                                                                
                                                                                
         EJECT                                                                  
* ADDITIONAL COMMERCIAL INFORMATION DSECT                                       
                                                                                
CMLCMLD  DSECT                                                                  
CMLCML   DS    CL12                COMMERCIAL                                   
CMLTYP   DS    CL4                 TYPE                                         
CMLDDT   DS    XL3                 DESTROY DATE                                 
CMLDTM   DS    XL2                 DESTROY TIME                                 
CMLPRD   DS    CL3                 PRODUCT                                      
CMLTXT   DS    XL1                 COMTEXT FLAG                                 
CMLCML8  DS    CL8                 COMMERCIAL 8 CHAR ISCII                      
CMLNXT   EQU   *-CMLCML                                                         
*                                                                               
*                                                                               
* COMMERCIAL TABLE FOR SHIPPING THROUGH OPTICA                                  
*                                                                               
CMLTBLD  DSECT                     *COMMERCIAL TABLE DSECT*                     
CMLKEYL  DS   0CL(CMLLTD-CMLSHCML) BINSRCH KEY LEN                              
CMLSHCML DS    CL8                 COMMERCIAL (ISCII OR PACKED ADID)            
CMLFTD   DS    CL3                 FTD                                          
CMLPRO1  DS    CL3                 PROD                                         
CMLPRO2  DS    CL3                 PROD 2                                       
CMLLTD   DS    XL3                 LTD                                          
CMLFLAG  DS    XL1                                                              
ADIDSW   EQU   X'01'               PACKED ADID                                  
CMLTBLLN EQU   *-CMLTBLD                                                        
*                                                                               
         EJECT                                                                  
* DSECT FOR NETWORK COMMERCIAL INSTRUCTIONS ERROR LIST *                        
                                                                                
XRECD    DSECT                                                                  
XREC     DS    0XL(XRECEND-XBAGYMD)                                             
*                                                                               
XBAGYMD  DS    XL1                                                              
XCLT     DS    CL2                 CLIENT                                       
XNET     DS    CL4                 NETWORK                                      
XNETMKT  DS    XL2                 NETWORK MARKET                               
XPROG    DS    CL6                 PROGRAM                                      
XTUNT    DS    XL2                 TOTAL UNITS                                  
XCML     DS    CL8                 COMMERCIAL CODE                              
XPERST   DS    CL6                                                              
XPERND   DS    CL6                                                              
XREVN    DS    XL2                                                              
XTYPE    DS    CL1                 1=NET SEED/ASSIGN NEVER RUN                  
*                                  2=ALL UNALLOCATED UNITS                      
*                                  3=NO COMMERCIALS ASSIGNED                    
*                                  4=ALL UNITS UNASSIGNED/UNALLOCATED           
*                                  5=SOME UNALLOCATED UNITS                     
*                                  6=SOME UNASSIGNED UNITS                      
*                                  7=EQUIVALENT PROG CODE NOT COVERED           
XSUBTYPE DS    CL1                                                              
XPROD1   DS    CL3                                                              
XPROD2   DS    CL3                                                              
XREF     DS    XL2                                                              
XDATEST  DS    XL3                                                              
XDATEND  DS    XL3                                                              
XRECEND  EQU   *                                                                
XRECLEN  EQU   *-XREC                                                           
                                                                                
                                                                                
         EJECT                                                                  
REQHDRD  DSECT                                                                  
REQHDR   DS    CL26                                                             
REQUEST  DS    CL80                                                             
REQUEST2 DS    CL80                                                             
REQUEST3 DS    CL80                                                             
REQUEST4 DS    CL80                                                             
REQUEST5 DS    CL80                                                             
REQUEST6 DS    CL80                                                             
REQSPOOK DS    CL64                                                             
*                                                                               
*                                                                               
* DSECT FOR PRINT LINE DATA *                                                   
PRTLINE  DSECT                                                                  
         DS    CL2    1 -  2      *NEW LAYOUT                                   
PPROG    DS   0CL16                                                             
PFEED    DS    CL10   3 - 12      FEED= AAAA                                    
         DS    CL1                                                              
PFEEDNM  DS    CL60               FEED NAME                                     
         ORG   PRTLINE                                                          
         DS    CL2                                                              
PPROD    DS    CL8                PRD= AAA                                      
         DS    CL1                                                              
PPRDNM   DS    CL20               PROD NAME                                     
         ORG   PRTLINE                                                          
         DS    CL2                                                              
PSLN     DS    CL11               LEN= 15/15                                    
         DS    CL3                                                              
PPCT     DS    CL7                '100 PCT'                                     
         ORG   PPCT+4                                                           
PLROT    DS    CL3                                                              
         DS    CL2                                                              
PCML     DS    CL12                                                             
PROTADI  DS    0CL12                **TEMP** REPLACE W/PCML                     
         DS    CL3                                                              
PCMLTL   DS    CL24                                                             
         DS    CL1                                                              
PCLTCML  DS   0CL29                                                             
PHIDEF   DS   0CL21                                                             
PCNTRC   DS   0CL21                                                             
POTHER   DS    CL29                                                             
         DS    CL1                                                              
PCMLRUN  DS    CL13                                                             
                                                                                
         DS    CL9               **** START DEL HERE ****                       
         DS    CL3              *****                                           
*                                                                               
PRTLINE  DSECT                                                                  
         DS    CL2    1 -  2                                                    
ZPPROG   DS    CL16   3 - 18                                                    
         DS    CL1   19                                                         
ZPFEED   DS    CL4   20 - 23                                                    
         DS    CL1   24                                                         
PDATES   DS    CL9   25 - 33                                                    
         DS    CL3   34 - 36                                                    
ZPPROD   DS    CL3   37 - 39                                                    
         DS    CL1   40                                                         
ZPPRDNM  DS    CL20  41 - 59                                                    
         DS    CL1   60                                                         
ZPCML    DS    CL8   61 - 68                                                    
         DS    CL1   69                                                         
ZPCMLTL  DS    CL24  70 - 93                                                    
         DS    CL1   94                                                         
PUNTLEN  DS    CL7   95 - 101                                                   
         DS    CL2  102 - 103                                                   
ZPROTADI DS    0CL12                                                            
ZPCLTCML DS   0CL20 104 - 123                                                   
PROTCML  DS    CL17 104 - 120                                                   
         DS    CL3                                                              
                                                                                
* PRINT ADDITIONAL CML INFO                                                     
         ORG   PRTLINE                                                          
         DS    CL2    1 -  2                                                    
PACMML   DS    CL12   3 -                                                       
         DS    CL5   19                                                         
PACMTXT  DS   0CL61  20                                                         
PTATYPE  DS    CL9   20 - 23                                                    
         DS    CL5   24                                                         
PADDTE   DS    CL41  25 - 33     DESTROY DATE AND TIME                          
*        DS    CL3   34 - 36                                                    
*PROD    DS    CL3   37 - 39                                                    
                                                                                
* PRINT PROGRAMS COVERED IN 2 COLUMNS                                           
         ORG   PRTLINE                                                          
         DS    CL2    1 -  2                                                    
PCPROGN1 DS    CL18   3 - 20       PROGRAM NAME                                 
         DS    CL2   21 - 22                                                    
PCPROG1  DS    CL6   23 - 28       PROPGRAM CODE                                
         DS    CL1   29                                                         
PCUNT1   DS    CL13  30 - 42       UNIT COUNT INFO                              
PCMARKER DS    CL6   43 - 48                                                    
PCPROGN2 DS    CL18  49 - 66       SAME AS ABOVE BUT COLUMN 2                   
         DS    CL2   67 - 68                                                    
PCPROG2  DS    CL6   69 - 74                                                    
         DS    CL1   75                                                         
PCUNT2   DS    CL13  76 - 88                                                    
         EJECT                                                                  
                                                                                
* DSECT FOR EDI                                                                 
                                                                                
SPOOLD   DSECT                                                                  
* LABELS FOR NETWORK COMMERCIAL INSTRUCTIONS ERROR LIST *                       
         ORG   P                                                                
         DS    CL2                                                              
XPPROG   DS    CL6                 PROGRAM                                      
         DS    CL2                                                              
XPPROGNM DS    CL16                PROGRAM NAME                                 
         DS    CL5                                                              
XPPROGDA DS    CL8                 PROGRAM DAY                                  
         DS    CL1                                                              
XPPROGTM DS    CL11                PROGRAM TIME                                 
         DS    CL1                                                              
XPUNITS  DS    CL5                 PROGRAM UNITS                                
         DS    CL1                                                              
XPFEEDS  DS    CL5                 PROGRAM FEEDS                                
         DS    CL2                                                              
XPPERIOD DS    CL17                PRINT PERIOD                                 
         DS    CL3                                                              
XPEXPLAN DS    CL1                 PRINT REASON                                 
                                                                                
*                                                                               
         ORG   P                                                                
*                                                                               
       ++INCLUDE EDIDESTD                                                       
*                                                                               
         ORG   P                                                                
*                                                                               
       ++INCLUDE EDIDDSHD                                                       
       ++INCLUDE EDILINKD                                                       
       ++INCLUDE FASECRETD                                                      
       ++INCLUDE SEACSFILE                                                      
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'155SPTRA50   11/06/20'                                      
         END                                                                    
