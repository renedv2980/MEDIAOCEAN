*          DATA SET ACBRA2D    AT LEVEL 027 AS OF 10/14/20                      
*PHASE T6242DA                                                                  
                                                                                
ACBRA2D  TITLE '- BrandOcean New Style General download Server'                 
                                                                                
* Level change comments                                                         
* ---------------------                                                         
* UK Levels                                                                     
* ---------                                                                     
* ASHA 001         NEW STYLE CODE FOR AUDIT APPROVER AND USER FIELDS            
*                  DOWNLOADS                                                    
*                                                                               
* JSAY 001         NEW STYLE CODE FOR JOBLIST AND SEARCH CRITERION              
*                                                                               
* CPAT 001         New style server set up for ACBRA11 FOR A#ARTL,              
*                  A#WCOL, A#TEAP DOWNLOAD REQUESTS                             
* MPEN 002 28AUG17 <DSRD-16708> FIX FOR OPEN/CLOSE OPEN DATE                    
*                                                                               
* CPAT 003 26SEP17 <DSRD-17073> FIX job audit request FOR Legacy data           
* NSHE     27Oct17 <DSRD-16866> Send amber and red estimate % for jobs          
* JSAY     02Nov17 <DSRD-16335> Fix for awaiting approval jobs                  
* JSAY     03Nov17 <DSRD-16378> Fix for override limit list                     
* ASHA     08Nov17 <DSRD-17404> Job Approval email issue                        
* NSHE 004 14Dec17 <DSRD-17746> Work code list bug with getopt                  
* NSHE     31Jan18 <DSRD-18020> fix joblist issue                               
* NSHE 005 12Feb18 <DSRD-18215> Fix runner issue with user fields               
* NSHE 006 01Mar18 <DSRD-18375> Issue with client POs                           
* MPEN 007 23Mar18 <DSRD-18370> Apply limlist to saved searches                 
* NSHE     10Apr18 <DSRD-18588> Suppress job net paid based on open dte         
* NRAK 008 11May18 <SPEC-24034> Typo causing duff 'locked' errors.              
* MPEN 009 15May18 <DSRD-19110> Fix for limlist filtering                       
* ABID 010 21MAY18 <DSRD-18387> NEW STYLE CODE FOR APPROVER LIST                
* NSHE     22May18 <DSRD-19020> Ensure net paid shows zero                      
* NSHE     25May18 <DSRD-19218> Filter job list for office                      
* NSHE 011 25Jun18 SPEC-25296 Fix to approver list added at lvl 10              
* NSHE 012 08Nov18 DSRD-20729 Fix to job audit time output                      
* MPEN 013 17Jan19 <DSRD-21323> Fix for job audit client PO                     
* MPEN 014 25Mar19 <DSRD-22079> Return default workcode for time                
* MPEN     05Apr19 <DSRD-22124> Fix for checking for locked jobs                
* MPEN 015 22May19 <DSRD-22638> Read higher level workcode setting              
* NSHE 016 20Jul19 <DSRD-23101> fix job search when pid and account             
* MPEN     02Aug19 <DSRD-23101> Fix for job owner search                        
* YNGX 017 27Aug19 <DSRD-23680> Clear ALOCEL in PERDTL                          
* JSHA 018 30Aug19 <DSRD-23669> Aura Jobs-Wrong Client Name Displayed           
* MPEN 019 16Aug19 <DSRD-23527> Fix for job search multiple words               
* ABID 020 05DEC19 <DSRD-23587> AMEND APPROVER RECORD FOR ORDERS AND            
*                               INVOICES TO ACCEPT OFFICE AND OLIST             
* NSHE 020 05DEC19 <DSRD-24187> Check we have location element                  
* ABID 021 10DEC19 <DSRD-24764> INCREASE Maximum number of OLIST                
*                               associated with OFFICE TO 100                   
*NRAK 022 05JAN20 SPEC-42929 BAD SJ FILT SH'D ERROR, NOT DIE IN GETOPT          
*ASAX 024 06MAY20 <DSRD-26268> Fixed bug which was not clearing                 
*                               previos office code for Locked records          
*MPEN     17APR20 <DSRD-25986>  Report on estimate/actual hours                 
*MPEN 025 24JUL20 <DSRD-27067>  Fix for in progress report on hours             
*MPEN 026 15JUL20 <DSRD-26623>  Ignore zero % in colour coding                  
*MPEN     07AUG20 <DSRD-27078>  Fix for jobs dashboard hrs filtering            
*MPEN     07AUG20 <DSRD-27196>  Additional fix for including rejected           
*MPEN 027 18AUG20 <DSRD=26699>  New line manager approver list call             
*NSHE     23SEP20 <DSRD-27625>  Filter out cancelled and deleted orders         
*NSHE     reversing changes made at level 26 for FLTORD                         
                                                                                
         PRINT NOGEN                                                            
SVRDEF   CSECT                                                                  
         LKSVR TYPE=D,                                                 +        
               SERVERTYPE=TSTACBO,WORKERKEY=ACBO,                      +        
               SEGMENT=Y,APPEND=Y,IDF=Y,                               +        
               REQUEST=*,CODE=CODE,FILES=FILES,                        +        
               SYSPHASE=X'0624',SYSTEM=ACCSYSQ,                        +        
               BLOCKS=(B#WORKD,WORKD,                                  +        
               B#SAVED,SAVED,                                          +        
               B#LP_D,LP_D,                                            +        
               B#TWAD,TWAD,                                            +        
               B#SVRDEF,SVRDEF,                                        +        
               B#AUD,AUDRECD,B#DESC,DESCTAB,                           +        
               B#DPAPAS,DPAPASD,                                       +        
               B#UFDL,UFSRECD,                                         +        
               B#ACTREC,ACTRECD,                                       +        
               B#ARTREC,ARTRECD,                                       +        
               B#WCREC,WCORECD,                                        +        
               B#APPTAB,APPTABD,                                       +        
               B#CEITAB,CEITABD,                                       +        
               B#SPITAB,SPITABD,                                       +        
               B#GOBLK,GOBLOCKD,                                       +        
               B#GOXBLK,GOXBLKD,                                       +        
               B#GOBBLK,GOBBLKD,                                       +        
               B#LLSREC,LLSRECD,                                       +        
               B#COBLCK,COBLOCKD)                                               
         EJECT                                                                  
                                                                                
CODE     NMOD1 0,**BO2D**,RR=RE                                                 
         LARL  RA,GLOBALS                                                       
         USING GLOBALS,RA              RA=A(GLOBAL LITERALS)                    
         LR    R5,R1                                                            
         USING LP_D,R5                 R5=A(DDLINK PARAMETER BLOCK)             
         L     R7,LP_ARUNP                                                      
         USING RUNPARMD,R7             R7=A(RUNPARMS)                           
         XR    R6,R6                                                            
         ICM   R6,7,RUNPARUN                                                    
         USING RUNFACSD,R6             R6=A(RUNFACS)                            
                                                                                
         USING WORKD,R9                R9=A(GLOBAL W/S)                         
         USING SAVED,R8                R8=A(SAVE W/S)                           
                                                                                
         TM    LP_FLAG,LP_FOFFL        TEST OFFLINE                             
         BNZ   INIT02                                                           
         ICM   R9,15,LP_ABLK1          ROOT SETS A(WORKD)                       
         BNZ   *+6                                                              
         DC    H'0'                                                             
         ICM   R8,15,RSVRSAVE          R8=A(7K SAVE AREA)                       
         ST    R8,LP_BLKS+((B#SAVED-1)*L'LP_BLKS)                               
         LA    R1,WORKD                                                         
         ST    R1,LP_BLKS+((B#WORKD-1)*L'LP_BLKS)                               
         J     INIT04                                                           
                                                                                
INIT02   L     R9,RSVRSAVE                                                      
         ST    R9,LP_BLKS+((B#WORKD-1)*L'LP_BLKS)                               
         XR    R8,R8                                                            
         ICM   R8,3,WORKLEN                                                     
         LA    R8,WORKD(R8)                                                     
         ST    R8,LP_BLKS+((B#SAVED-1)*L'LP_BLKS)                               
                                                                                
         USING CPXELD,SCPXEL                                                    
         USING CPYELD,SCPYEL                                                    
INIT04   MVC   ATWA,LP_ATWA                                                     
         MVC   RUNMODE,RUNPMODE    EXTRACT DDLINK/RUNNER CALLING MODE           
         MVC   ACOMFACS,RCOMFACS                                                
         MVC   AMASTC,RMASTC                                                    
         MVC   ABUFFRIN,RBUFFRIN                                                
         DROP  R6,R7                                                            
                                                                                
         USING ELES_DS,ELEMENT                                                  
                                                                                
         USING TWAD,R7                                                          
         L     R7,ATWA                 RA=A(ON/OFFLINE TWA)                     
                                                                                
         MVI   TWAMODE,0                                                        
                                                                                
         ST    R5,ALP                  SAVE A(LP_D)                             
         ST    RE,SRVRRELO             SAVE PROGRAM RELOCATION FACTOR           
         STM   R2,RB,LP_R2RB           SAVE REGISTERS FOR SUB-ROUTINES          
                                                                                
         EJECT                                                                  
***********************************************************************         
* Initialize for running                                              *         
***********************************************************************         
                                                                                
RUNSTR   CLI   RUNMODE,RRUNSTRQ    TEST FIRST FOR RUN                           
         BNE   PRCWRK                                                           
         TM    LP_FLAG,LP_FOFFL        TEST OFFLINE                             
         BZ    RUNSTR02                NO                                       
                                                                                
         L     RF,ACOMFACS             YES - LOAD FACILITIES OVERLAYS           
         L     RF,CCALLOV-COMFACSD(RF)                                          
         GOTOR (RF),DMCB,(1,0),0,0                                              
         MVC   AROUT1,0(R1)                                                     
         GOTOR (RF),DMCB,(2,0),0,0                                              
         MVC   AROUT2,0(R1)                                                     
         L     RF,AMASTC                                                        
         MVC   VACCEMU,MCVACEMU-MASTD(RF)                                       
         MVC   AROUT1,LP_AUIR1         SET LOCAL INDEX ROUTINE ADDRESSE         
         MVC   AROUT2,LP_AUIR2         WHICH WERE LOADED BY MSTR SERVER         
         GOTOR (#WRKINI,AWRKINI)       INITIALISE WORKING STORAGE               
         J     RUNSTR08                                                         
                                                                                
RUNSTR02 L     RF,AACCFACS                                                      
         MVC   VACCEMU,X_AACCEMU-X_ACCFACSD(RF)                                 
                                                                                
         GOTOR (#WRKINI,AWRKINI)      INITIALIZE SERVER WORKING STORAGE         
                                                                                
RUNSTR08 MVC   LP_BLKS+((B#ACTREC-1)*L'LP_BLKS)(L'LP_BLKS),AIO2                 
         MVC   LP_BLKS+((B#APPTAB-1)*L'LP_BLKS)(L'LP_BLKS),AIO4                 
         MVC   LP_BLKS+((B#SPITAB-1)*L'LP_BLKS)(L'LP_BLKS),AIO6                 
         MVC   LP_BLKS+((B#GOBLK-1)*L'LP_BLKS)(L'LP_BLKS),AGOBLOCB              
         MVC   LP_BLKS+((B#GOBBLK-1)*L'LP_BLKS)(L'LP_BLKS),AGOBBLCK             
         MVC   LP_BLKS+((B#GOXBLK-1)*L'LP_BLKS)(L'LP_BLKS),AGOXBLCK             
         MVC   LP_BLKS+((B#COBLCK-1)*L'LP_BLKS)(L'LP_BLKS),ACOBLOCK             
         MVC   LP_BLKS+((B#TWAD-1)*L'LP_BLKS)(L'LP_BLKS),LP_ATWA                
         MVC   LP_BLKS+((B#SVRDEF-1)*L'LP_BLKS)(L'LP_BLKS),LP_ASVR              
         MVC   LP_BLKS+((B#LP_D-1)*L'LP_BLKS)(L'LP_BLKS),ALP                    
                                                                                
         MVC   WVALUES(WVALUEL),LVALUE                                          
                                                                                
         OI    LP_AIND1,LP_AICOM                                                
                                                                                
         LA    R1,ADCONS               RELOCATE ADDRESS CONSTANTS               
         LHI   R0,ADCONSN                                                       
         BASR  RE,0                                                             
         L     R2,0(R1)                                                         
         A     R2,SRVRRELO                                                      
         ST    R2,0(R1)                                                         
         AHI   R1,L'ADCONS                                                      
         BCTR  R0,RE                                                            
                                                                                
         EJECT                                                                  
***********************************************************************         
* First for new work                                                  *         
***********************************************************************         
                                                                                
PRCWRK   CLI   RUNMODE,RPRCWRKQ        TEST 'PROCESS WORK' MODE                 
         BNE   RUNREQ                                                           
         LA    R0,SAVEVAR                                                       
         LHI   R1,SAVEVARL                                                      
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         TM    LP_FLAG,LP_FOFFL        TEST OFFLINE                             
         BZ    PRCWRK02                                                         
                                                                                
         LA    R0,WORKD                CLEAR I/O AREAS                          
         AHI   R0,IOAREA1-WORKD                                                 
         LHI   R1,IOAREASL                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
PRCWRK02 J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Run a download request                                              *         
***********************************************************************         
RUNREQ   CLI   RUNMODE,RRUNREQQ        TEST 'RUN REQUEST' MODE                  
         JNE   EXITY                                                            
                                                                                
         MVI   GIND2,GI2EBUY                                                    
*                                                                               
         GOTOR (#CPYINI,ACPYINI)       (RE)INITIALISE COMPANY VALUES            
         MVC   QAGENCY,CUXCPY                                                   
         MVC   QPRODUL,PRODUL                                                   
         MVC   QCCTPID,CCTPID                                                   
*                                                                               
         USING CPXELD,SCPXEL                                                    
         USING CPYELD,SCPYEL                                                    
*                                                                               
         L     RE,LP_AWMP              BUILD DEFAULT RNG WMP ELEMENTS           
         USING LW_D,RE                                                          
         MVI   LW_TYPE,LW_TALLQ        ALL VALUES                               
         STCM  RE,7,AALL                                                        
         AHI   RE,LW_LN1Q                                                       
         MVI   LW_TYPE,LW_TNZRQ        NON-ZERO VALUES                          
         STCM  RE,7,ANZR                                                        
         AHI   RE,LW_LN1Q                                                       
         ST    RE,LP_AWMP                                                       
         DROP  RE                                                               
                                                                                
         L     R0,AGOBLOCB                                                      
         AHI   R0,GOADM-GOBLOCK                                                 
         LHI   R1,GOBLOCKX-GOBLOCKD                                             
         SHI   R0,GOADM-GOBLOCK                                                 
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         TM    LP_FLAG,LP_FOFFL        TEST OFFLINE                             
         JZ    RUNREQ04                                                         
                                                                                
         L     RF,AMASTC               SET TRACE OPTION                         
         MVC   IOTRACE,MCTRACE-MASTD(RF)                                        
                                                                                
         GOTOR VDATAMGR,DMCB,DMKEY,ACCDIR,(4,0),0                               
         GOTOR VDATAMGR,DMCB,DMKEY,ACCMST,(4,0),0                               
         GOTOR VDATAMGR,DMCB,DMKEY,ACCARC,(4,0),0                               
                                                                                
RUNREQ04 GOTOR VDATCON,DMCB,(5,0),(1,XL#TODP)                                   
RUNREQ06 GOTOR (RF),(R1),,(2,XL#TODC)                                           
*                                                                               
RUNREQX  GOTOR LP_APUTO,LP_D           CALL DDLINK OUTPUT PROCESSOR             
         J     EXITY                   EXIT BACK TO DDLINK                      
         DROP  RB                                                               
         EJECT                                                                  
         LTORG                                                                  
***********************************************************************         
* Approver List Download                                              *         
***********************************************************************         
*                                                                               
REQAPPL  LKREQ H,A#APPL,OUTAPPL,NEXTREQ=REQWCOL                                 
*                                                                               
Oval     LKREQ F,01,(D,B#SAVED,RQ_APOVL),CHAR,OLEN=L'RQ_APOVL,         +        
               MAXLEN=L'RQ_APOVL,TEXT=AC#ORDT,COL=*                             
*                                                                               
Otyp     LKREQ F,02,(D,B#SAVED,RQ_APOTY),CHAR,OLEN=L'RQ_APOTY,         +        
               MAXLEN=L'RQ_APOTY,TEXT=AC#ORDTY,COL=*                            
*                                                                               
Etyp     LKREQ F,03,(D,B#SAVED,RQ_APETY),CHAR,OLEN=L'RQ_APETY,         +        
               MAXLEN=L'RQ_APETY,TEXT=AC#ETYPE,COL=*                            
*                                                                               
Clic     LKREQ F,04,(D,B#SAVED,RQ_APCLI),CHAR,OLEN=L'RQ_APCLI,         +        
               MAXLEN=L'RQ_APCLI,TEXT=AC#CLINT,COL=*                            
*                                                                               
Dept     LKREQ F,05,(D,B#SAVED,RQ_APDPT),CHAR,OLEN=L'RQ_APDPT,         +        
               MAXLEN=L'RQ_APDPT,TEXT=AC#DPT,COL=*                              
*                                                                               
Owner    LKREQ F,06,(D,B#SAVED,RQ_APOWN),CHAR,OLEN=L'RQ_APOWN,         +        
               MAXLEN=L'RQ_APOWN,TEXT=AC#VWOW,COL=*                             
*                                                                               
Prodt    LKREQ F,07,(D,B#SAVED,RQ_APPRO),CHAR,OLEN=L'RQ_APPRO,         +        
               MAXLEN=L'RQ_APPRO,TEXT=AC#PRO,COL=*                              
*                                                                               
JobCde   LKREQ F,08,(D,B#SAVED,RQ_APJOB),CHAR,OLEN=L'RQ_APJOB,         +        
               MAXLEN=L'RQ_APJOB,TEXT=AC#JOBC,COL=*                             
*                                                                               
Suppr    LKREQ F,09,(D,B#SAVED,RQ_APSUP),CHAR,OLEN=L'RQ_APSUP,         +        
               MAXLEN=L'RQ_APSUP,TEXT=AC#SUPC,COL=*                             
*                                                                               
Inv      LKREQ F,10,(D,B#SAVED,RQ_APLTC),LBIN,OLEN=L'RQ_APLTC,         +        
               MAXLEN=L'RQ_APLTC,TEXT=AC#INV,COL=*                              
*                                                                               
Self     LKREQ F,11,(D,B#SAVED,RQ_APSEL),CHAR,OLEN=L'RQ_APSEL,         +        
               MAXLEN=L'RQ_APSEL,TEXT=AC#SFAP,COL=*                             
*                                                                               
2Pacc    LKREQ F,12,(D,B#SAVED,RQ_AP2PA),CHAR,OLEN=L'RQ_AP2PA,         +        
               MAXLEN=L'RQ_AP2PA,TEXT=AC#2P,COL=*                               
*                                                                               
Editr    LKREQ F,13,(D,B#SAVED,RQ_APEDT),CHAR,OLEN=L'RQ_APEDT,         +        
               MAXLEN=L'RQ_APEDT,TEXT=AC#SFAP,COL=*                             
*                                                                               
Ordnm    LKREQ F,14,(D,B#SAVED,RQ_APORN),CHAR,OLEN=L'RQ_APORN,         +        
               MAXLEN=L'RQ_APORN,TEXT=AC#SFAP,COL=*                             
*                                                                               
AllCl    LKREQ F,15,(D,B#SAVED,RQ_APALL),CHAR,OLEN=L'RQ_APALL,         +        
               MAXLEN=L'RQ_APALL,TEXT=AC#ALLCS,COL=*                            
*                                                                               
MixCl    LKREQ F,16,(D,B#SAVED,RQ_APMIX),CHAR,OLEN=L'RQ_APMIX,         +        
               MAXLEN=L'RQ_APMIX,TEXT=AC#APMIX,COL=*                            
*                                                                               
CPerc    LKREQ F,17,(D,B#SAVED,RQ_APCPX),CHAR,OLEN=L'RQ_APCPX,         +        
               MAXLEN=L'RQ_APCPX,TEXT=AC#APCPX,COL=*                            
*                                                                               
CDate    LKREQ F,18,(D,B#SAVED,RQ_APCCD),PDAT,OLEN=L'RQ_APCCD,         +        
               MAXLEN=L'RQ_APCCD,TEXT=AC#APCCD,COL=*                            
*                                                                               
         LKREQ E                                                                
*                                                                               
OUTAPPL  LKOUT H                                                                
*                                                                               
APPLI    LKOUT R,A#APPL                Approver List Record                     
PROUT    LKOUT P,,GETAPLV                                                       
Array    LKOUT C,A#APPL,(A,ARYAPLVL)                                            
PROUT    LKOUT P,,GETAPRS                                                       
Array    LKOUT C,A#APPL,(A,ARYAPRS)                                             
         LKOUT E                                                                
*                                                                               
         LKOUT X                                                                
*                                                                               
ARYAPLVL LKOUT A,(R,NXTAPLVL),MULTIROW=Y                                        
APLIM    LKOUT C,01,(D,B#SAVED,AP_HLMT),CPAK,ND=Y                               
APNAT    LKOUT C,02,(D,B#SAVED,AP_HNAT),HEXD,ND=Y                               
APNAP    LKOUT C,03,(D,B#SAVED,AP_HNAP),HEXD,ND=Y                               
APAPL    LKOUT C,07,(D,B#SAVED,AP_DAPL),CPAK                                    
APORC    LKOUT C,23,(D,B#SAVED,AP_ORCK),CHAR,ND=Y                               
         LKOUT E                                                                
*                                                                               
ARYAPRS  LKOUT A,(R,NXTAPRS),MULTIROW=Y                                         
APLIM    LKOUT C,01,(D,B#SAVED,AP_HLMT),CPAK,ND=Y                               
APNAT    LKOUT C,02,(D,B#SAVED,AP_HNAT),HEXD,ND=Y                               
APNAP    LKOUT C,03,(D,B#SAVED,AP_HNAP),HEXD,ND=Y                               
APCOD    LKOUT C,04,(D,B#SAVED,AP_DPID),CHAR,ND=Y                               
APFNM    LKOUT C,05,(D,B#SAVED,AP_DPFN),CHAR,ND=Y                               
APLNM    LKOUT C,06,(D,B#SAVED,AP_DPLN),CHAR,ND=Y                               
APAPL    LKOUT C,07,(D,B#SAVED,AP_DAPL),CPAK                                    
APAPT    LKOUT C,08,(D,B#SAVED,AP_DAPT),CHAR,ND=Y                               
APDEF    LKOUT C,09,(D,B#SAVED,AP_DDEF),CHAR,ND=Y                               
APDEM    LKOUT C,10,(D,B#SAVED,AP_DEMA),CHAR,ND=Y                               
APLVL    LKOUT C,11,(D,B#SAVED,AP_DLVL),CHAR,ND=Y                               
APMNM    LKOUT C,12,(D,B#SAVED,AP_DPMN),CHAR,ND=Y                               
APMOT    LKOUT C,13,(D,B#SAVED,AP_MORT),CHAR,ND=Y                               
APMOF    LKOUT C,14,(D,B#SAVED,AP_MOFF),CHAR,ND=Y                               
APMDP    LKOUT C,15,(D,B#SAVED,AP_MDPT),CHAR,ND=Y                               
APMET    LKOUT C,16,(D,B#SAVED,AP_METY),CHAR,ND=Y                               
APMSU    LKOUT C,17,(D,B#SAVED,AP_MSUP),CHAR,ND=Y                               
APM2P    LKOUT C,18,(D,B#SAVED,AP_M2PA),CHAR,ND=Y                               
APMJB    LKOUT C,19,(D,B#SAVED,AP_MJOB),CHAR,ND=Y                               
APMPR    LKOUT C,20,(D,B#SAVED,AP_MPRO),CHAR,ND=Y                               
APMCL    LKOUT C,21,(D,B#SAVED,AP_MCLI),CHAR,ND=Y                               
APMME    LKOUT C,22,(D,B#SAVED,AP_MMED),CHAR,ND=Y                               
APORC    LKOUT C,23,(D,B#SAVED,AP_ORCK),CHAR,ND=Y                               
         LKOUT E                                                                
*                                                                               
***********************************************************************         
* GET APPROVAL LIMITS AND APPROVERS                                   *         
***********************************************************************         
GETAPLV  NTR1  LABEL=*                                                          
         ST    R8,LP_ADATA                                                      
         XC    AP_VALS(AP_LNQ),AP_VALS  CLEAR OUTREQ WORK AREA                  
         XC    APLIND1,APLIND1     INIT APPROVAL LOOK UP INDICATOR              
         ZAP   AP_HLMT,PZERO       INIT APPROVAL LIMIT                          
         ZAP   AP_DAPL,PZERO       INIT APPROVAL LIMIT                          
*                                                                               
         GOTOR (#ORDPRF,AORDPRF),DMCB,XL#ORPF                                   
*                                                                               
         MVC   TEMP2(16),SPACES    CLEAR WORK AREA                              
         MVC   TEMP2(L'RQ_APOVL),RQ_APOVL  SAVE INPUT ORDER NUMBER              
*                                                                               
         GOTOR (#CONAMT,ACONAMT)    CONVERT ACCOUNT NUMBER INTO PACKED          
*                                                                               
         ZAP   DUB2,TEMP2+16(8)     ORDER VALUE PACKED                          
         ZAP   DUB,DUB2             SAVE THE VALUE IN DUB                       
*                                                                               
GETAPL00 SRP   DUB,64-2,9          / 100, always round up                       
*                                                                               
X        USING ORDPRFD,XL#ORPF     MAP WITH ORDER PROFILE BLOCK                 
         MVC   HALF1,SPACES        INIT COMPANY LEVEL APP                       
         TM    CPYSTAT1,CPYSOROE   IS OFFICE REQUIRED ON EXPENSES ?             
         JZ    GETAPL04            NO, CONTINUE                                 
*                                                                               
         OC    RQ_APDPT,RQ_APDPT   ANY OFFICE CODE INPUT ?                      
         JZ    GETAPL04            NO, CONTINUE                                 
*                                  YES                                          
*&&US                                                                           
*                                                                               
* Temporary fix to see if U/L 2D is being passed down incorrectly as            
*           as part of the account based on CPYSTAT5 setting.                   
*           If it is, remove it from RQ_APDPT                                   
*                                                                               
         TM    CPYSTAT5,CPYSOFPL   COMPANY USES OFFICES FOR P&L ONLY?           
         JZ    GETAPL02            NO, CONTINUE                                 
         CLC   =C'2D',RQ_APDPT     YES, DEPARTMENT INPUT MATCHES ?              
         JNE   GETAPL02            NO, CONTINUE                                 
*                                  YES,                                         
         MVC   TEMP(L'RQ_APDPT),SPACES  INIT WORK AREA                          
         MVC   TEMP(L'RQ_APDPT-2),RQ_APDPT+2  SAVE DEPARTMENT DETAILS           
         MVC   RQ_APDPT,TEMP       ADD SPACES AT END                            
GETAPL02 DS    0H                                                               
*&&                                                                             
         SR    RF,RF               CLEAR REGISTER FOR LENGTH                    
         TM    CPYSTAT4,CPYSOFF2   NEW OFFICE SYSTEM IN USE ?                   
         JZ    *+8                 NO, PROCESS AS 1 BYTE OFFICE CODE            
         AHI   RF,1                YES, MARK 2 BYTES MOVEMENT                   
*                                                                               
         BASR  RE,0                PROCESS VERIABLE LENGTH OFFICE CODE          
         MVC   HALF1(0),RQ_APDPT   SAVE INPUT OFFICE CODE                       
         EX    RF,0(RE)                                                         
*                                                                               
GETAPL04 MVC   ANYACCNT,SPACES     INIT WORK AREA TO SAVE ACCOUNT CODE          
         MVC   HALF2,SPACES        INIT WORK AREA TO SAVE OFFICE CODE           
         OC    RQ_APCLI,RQ_APCLI   DO WE HAVE A CLIENT CODE INPUT ?             
         JZ    GETAPL06            NO, CONTINUE                                 
*                                  YES, POPULATE ACCOUNT  DETAILS               
         GOTOR BLDJOB,DMCB,ANYACCNT,RQ_APCLI,RQ_APPRO,RQ_APJOB                  
*                                                                               
**********************************************************************          
* GET ACCOUNT NAME  - VALIDATE ACCOUNT DETAILS                       *          
* - ACCOUNT PASSSED IN TEMP2(14)                                     *          
* - NAME RETURNED IN TEMP2(36)                                       *          
* - CURRENCY RETURNED IN TEMP2+50                                    *          
**********************************************************************          
*                                                                               
         MVC   TEMP2,SPACES        INIT WORK AREA                               
         MVC   TEMP2(L'ANYACCNT),ANYACCNT   SAVE ACCOUNT DETAILS                
         GOTOR (#GETACN,AGETACN)   USES AIO3 - GET ACCOUNT NAME DETAILS         
*                                                                               
         CLC   TEMP2(36),SPACES    ACCOUNT DETAILS PRESENT ?                    
         JH    *+14                YES, CONTINUE                                
         MVC   ROUERRV,=AL2(AE$ACTNF) NO, PROCESS ERROR MESSAGE                 
         J     EXITN                                                            
*                                                                               
         MVC   TEMP2,SPACES        CLEAR WORK AREA                              
         MVC   TEMP2(L'ANYACCNT),ANYACCNT  SAVE ACCOUNT DETAILS                 
*                                                                               
         GOTOR SSJOFF              GET OFFICE CODE                              
*                                                                               
         TM    CPYSTAT1,CPYSOROE   OFFICE REQUIRED ON EXPENSES ?                
         JZ    GETAPL06            NO, CONTINUE                                 
*                                  YES                                          
         MVC   HALF2,XL#COFF       SAVE OFFICE CODE FROM SJ RECORD              
         CLI   RQ_APOTY,ALIKEXP    ORDER TYPE EXPENCES ?                        
         JE    GETAPL06            YES,ENSURE OFFICE MATCHES CLIENT PRD         
         MVC   HALF1,HALF2         SAVE OFFICE CODE                             
*                                                                               
GETAPL06 DS    0H                                                               
         MVI   BYTE4,SE#INVS       SET INVOICE APPLICATION                      
         CLI   RQ_APLTC,RQ_AINV    ARE WE LOOKING FOR INVOICE APPROVER?         
         JE    *+8                 YES, CONTINUE                                
*                                  NO,                                          
         CLI   RQ_APLTC,RQ_AINVN   INVOICE NO PURCHASE ORDER ?                  
         JE    GETAPL07            YES, CONTINUE                                
*                                                                               
         MVC   ROUERRV,=AL2(AE$RQDIN) NO, PROCESS ERROR MESSAGE                 
         MVC   LP_ERROR,ROUERRV    SET ERROR MESSAGE DETAILS                    
         J     XERROR              PROCESS ERROR                                
*                                                                               
GETAPL07 DS    0H                                                               
*                                                                               
***********************************************************************         
* CHECK SETTING AS TO WHETHER TO SEND EMAILS                          *         
* P1=OFFICE CODE                                                      *         
* P2=APPLICATION                                                      *         
***********************************************************************         
         GOTOR (#SEMAIL,ASEMAIL),DMCB,HALF1,BYTE4 CHECK WHETHER TO SEND         
*                                  EMAIL                                        
         JNE   *+8                 NO, CONTINUE                                 
         OI    APLIND1,APLIEML     YES, SET EMAILS CAN JE SENT                  
*                                                                               
         CLC   RQ_APCPX,SPACES     ANY CLAIMANT PERSON CODE INPUT ?             
         JNH   GETAPL08            NO , CONTINUE                                
*                                  YES,                                         
         MVC   TEMP2,SPACES        CLEAR WORK AREA                              
         MVC   TEMP2,RQ_APCPX      SAVE DETAILS                                 
         OC    RQ_APCCD,RQ_APCCD   CLAIMANT PERSON DATE INPUT ?                 
         JZ    *+10                NO, CONTINUE                                 
         MVC   XL#TODP,RQ_APCCD    SAVE DATE DETAILS                            
*                                                                               
         GOTOR PERDTL              GET PERSON DETAILS                           
         JE    *+14                FOUND, CONTINUE                              
         MVC   ROUERRV,FULL2       SAVE ERROR DETAILS                           
         J     EXITN               PROCESS ERROR                                
*                                                                               
         L     R2,ALOCEL           ADDRESS LOCAL ELEMENT DETAILS                
         LA    R3,X#1RACC          ADDRESS 1R ACCOUNT CODE WORK AREA            
         LLC   RF,ONERL1L          LENGTH OF THE FILED                          
         SHI   RF,1                -1  LENGTH FOR MACHINE INSTR.                
         BASR  R1,0                SAVE VERIABLE LENGTH OFFICE                  
         MVC   0(0,R3),LOCOFF-LOCELD(R2) -  SAVE OFFICE CODE FROM LOCEL         
         EX    RF,0(R1)                                                         
         MVC   HALF1,LOCOFF-LOCELD(R2) SAVE OFFICE CODE DETAILS                 
         AHI   RF,1                POINT END OF THE OFFICE CODE                 
         AR    R3,RF               POINT 1R ACCOUNT AFTER OFFICE CODE           
         LLC   RF,ONERL2L          TOTAL LGTH OF THE DEPT CODE FRM STRT         
         LLC   R0,ONERL1L          LENGTH OF THE OFFICE CODE                    
         SR    RF,R0               ACTUAL LENGTH OF THE DEPT CODE               
         SHI   RF,1                -1 FOR MACHINE INSTR.                        
         BASR  R1,0                                                             
         MVC   0(0,R3),LOCDEPT-LOCELD(R2)  SAVE DEPT DETAILS                    
         EX    RF,0(R1)                                                         
         AHI   RF,1               ADD 1 TO DEPT LENGTH                          
         AR    R3,RF              POINT TO THE END OF DEPT VALUE                
         LLC   RF,ONERL3L         TOTAL LGTH OF THE SUB-DEPT FRM STRT           
         LLC   R0,ONERL2L         LENGTH OF THE DEPT CODE                       
         SR    RF,R0              ACTUAL LENGTH OF THE SUB-DEPT CODE            
         SHI   RF,1               -1 FOR MACHINE INSTR.                         
         BASR  R1,0                                                             
         MVC   0(0,R3),LOCSUB-LOCELD(R2)  SAVE SUB-DEPARTMENT DETAILS           
         EX    RF,0(R1)                                                         
         AHI   RF,1               SUB-DEPT CODE LENGTH                          
         AR    R3,RF              POINT TO THE END OF SUB-DEPT CODE             
         MVC   0(L'RQ_APCPX,R3),RQ_APCPX  SAVE CLAIMANT PERSON CODE             
*                                                                               
GETAPL08 MVI   AP_ORCK,NOQ         SET ORDER ESTIMATE CHECK PERM TO NO          
         MVC   BYTE2,RQ_APLTC      SAVE INVOICE APPROVER TYPE FROM INP          
*                                                                               
         USING ALIRECD,R2                                                       
GETAPL10 LA    R2,IOKEY            ADDRESS WORK AREA                            
         XC    ALIKEY,ALIKEY       CLEAR KEY AREA                               
         MVI   ALIKTYP,ALIKTYPQ    READ APPROVER RECORD FOR TYPE - 37           
         MVI   ALIKSUB,ALIKSUBQ                         SUB TYPE - 02           
         MVC   ALIKCPY,CUXCPY      SAVE COMPANY CODE                            
         MVC   ALIKCAT,BYTE2       READ FOR REQUESTED CATEGORY                  
         MVC   CSVKEY1(L'ALIKEY),ALIKEY  SAVE KEY                               
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'  *READHIGH ACCDIR             
*                                                                               
         CLC   ALIKEY(ALIKSCAT-ALIRECD),CSVKEY1  KEY MATCHES ?                  
         JE    GETAPL12            YES,                                         
*                                                                               
         CLI   BYTE2,RQ_AINVN      TEST 'INVOICE NO PO' NOT FOUND?              
         JNE   *+12                NO, CONTINUE    OR                           
         MVI   BYTE2,RQ_AINV       SET -TRY REGULAR INVOICES                    
         J     GETAPL10            PROCESS AGAIN                                
*                                                                               
         MVI   BYTE2,RQ_AORD       OTHERWISE DEFAULT TO ORDERS                  
*                                                                               
         USING ALIRECD,R2          ** APPROVER LIMIT RECORD  **                 
GETAPL12 LAY   R3,APLTAB           ADDRESS ORDER TYPE TABLE                     
         USING APLTABD,R3                                                       
GETAPL14 LA    R2,IOKEY            LOOK UP APLIMIT RECORD                       
         XC    ALIKEY,ALIKEY       CLEAR KEY AREA                               
         MVI   ALIKTYP,ALIKTYPQ    READ RECORD FOR TYPE - X'37'                 
         MVI   ALIKSUB,ALIKSUBQ                SUB TYPE - X'02'                 
         MVC   ALIKCPY,CUXCPY      SAVE COMPANY NAME                            
         MVC   ALIKCAT,BYTE2       USE REQUESTED CATEGORY/DEFAULT               
         TM    APLTSTAT,APLTORT1   ORDER TYPE - EXPS PROD INTER ARTS?           
         JZ    GETAPL20            NO, SKIP                                     
*&&UK                                                                           
         CLI   BYTE2,ALIKINV       INVOICES ORDER ?                             
         JE    GETAPL16            YES, CONTINUE                                
*                                  NO,                                          
         CLI   BYTE2,ALIKINVN      INVOICE NO PURCHASE ORDER ?                  
         JE    GETAPL16            YES, CONTINUE                                
*                                  NO,                                          
         CLI   BYTE2,ALIKEXPS      EXPENSES  ORDER ?                            
         JNE   GETAPL18            (NO NEED FOR APRTORT1 ?|)                    
*                                  YES                                          
GETAPL16 CLI   RQ_APOTY,ALIKDFT    ORDER TYPE INPUT ?                           
         JH    GETAPL18            YES, CONTINUE                                
         MVI   RQ_APOTY,ALIKMIX    NO, SET MIXED (BILL/NONE BILL) 4 INV         
*                                                                               
GETAPL18 DS    0H                                                               
*&&                                                                             
         MVC   ALIKSCAT,RQ_APOTY   REQUESTED ORDER TYPE                         
         J     GETAPL26                                                         
*                                                                               
GETAPL20 TM    APLTSTAT,APLTORT2   ORDER TYPE - CLIENT OR NON CLIENT ?          
         JZ    GETAPL24            NO, SKIP                                     
*                                  YES                                          
         CLI   RQ_APMIX,YESQ       HAVE WE A MIX OF CLIENT AND NONE ?           
         JE    GETAPL34            YES - SKIP THIS TABLE ENTRY                  
*                                  NO                                           
         CLI   RQ_APALL,YESQ       HAVE WE ALL CLIENTS BUT DIFFERENT ?          
         JE    GETAPL22            YES - SET ORDER TYPE AS CLIENT               
*                                                                               
         MVI   ALIKSCAT,ALIKNCLI   TRY NON-CLIENT OR CLIENT TYPE                
         CLC   RQ_APCLI,SPACES     CLIENT  INPUT ?                              
         JNH   GETAPL26            NO, SKIP                                     
*                                  YES                                          
GETAPL22 MVI   ALIKSCAT,ALIKCLI    SET CLIENT ORDERS                            
         J     GETAPL26            CONTINUE                                     
*                                                                               
GETAPL24 MVI   ALIKSCAT,ALIKDFT    ELSE SET DEFULT ORDER                        
*                                                                               
GETAPL26 TM    APLTSTAT,APLTCLI    CLIENT ORDER REQUESTED ?                     
         JZ    GETAPL28            NO, CONTINUE                                 
*                                  YES                                          
         CLC   RQ_APCLI,SPACES     CLIENT SPECIFIED  ?                          
         JNH   GETAPL34            NO, SKIP                                     
*                                  YES                                          
         MVC   ALIKCLIC(L'RQ_APCLI),RQ_APCLI  SAVE CLIENT DETAILS               
         OC    ALIKCLIC,SPACES     MAKE VALUE IN CAPS                           
*                                                                               
GETAPL28 TM    APLTSTAT,APLTETYP   EXPENDITURE TYPE   ?                         
         JZ    GETAPL30            NO, SKIP                                     
*                                  YES                                          
         CLC   RQ_APETY,SPACES     CLIENT SPECIFIED                             
         JNH   GETAPL34            NO, SKIP                                     
*                                                                               
         MVC   ALIKETYP(L'RQ_APETY),RQ_APETY  SAVE EXPENDITURE TYPE             
         OC    ALIKETYP,SPACES     MAKE DETAILS IN CAPS                         
*                                                                               
GETAPL30 TM    APLTSTAT,APLTOFFC   ORDER TYPE OFFICE                            
         JZ    GETAPL32            NO, SKIP PROCESS                             
*                                  YES                                          
         CLC   HALF1,SPACES        OFFICE SPECIFIED  ?                          
         JE    GETAPL34            NO, SKIP PROCESS                             
*                                  YES,                                         
         MVC   ALIKOFFC,HALF1      SAVE OFFICE CODE DETAILS                     
*                                                                               
GETAPL32 MVC   CSVKEY1(L'ALIKEY),ALIKEY  SAVE KEY DETAILS                       
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    GETAPL36            RECORD FOUND                                 
*                                  NO,                                          
GETAPL34 AHI   R3,APLTABL          POINT TO THE NEXT TABLE ENTRY                
         CLI   APLTSTAT,X'FF'      END OF THE TABLE ?                           
         JE    APPLERR2            NO APPLICABLE APLIMIT RECS FOUND             
         J     GETAPL14            PROCESS THE RECORD                           
*                                  * GET ACCMST RECORD FOR THE KEY              
GETAPL36 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                 RECORD FOUND, CONTINUE                       
         DC    H'0'                NO, ABEND                                    
*                                                                               
         L     R2,AIO3             ADDRESS RECORD                               
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO2  CLEAR IO AREA WITH X'00'              
         L     R4,AIO2             TO USE IT FOR APPROVER TABLE                 
                                                                                
         XC    X#NPLVL,X#NPLVL     CLEAR COUNT OF LEVELS                        
         LA    R3,ALIRFST          APPROVER LIMIT RECORD 1ST ELEM ADRS          
*                                                                               
         USING APLELD,R3           ** APPROVER LIMIT ELEMENT **                 
GETAPL38 CLI   APLEL,0             MORE ELEMENT FOR THE PROCESS ?               
         JE    GETAPL54            YES, EXIT                                    
*                                  NO,                                          
GETAPL40 CLI   APLEL,APLELQ        APPROVAL LIMIT ELEMENT(S) ?                  
         JE    GETAPL44            YES, PROCESS IT                              
*                                  NO,                                          
GETAPL42 LLC   R0,APLLN            POINT TO THE NEXT ELEMENT UNTIL              
         AR    R3,R0               - END OF THE RECORD OR ELEMENT               
         J     GETAPL38            - FOUND                                      
*                                                                               
         USING APLVLTD,R4                                                       
GETAPL44 ZAP   APLVLVAL,APLVAL     SAVE APPROVAL VALUE                          
         MVC   APLVLNUM,APLNUM     N'APPROVERS, THIS LEVEL                      
         MVC   APLVLPRV,APLPREV    N'PREVIOUS LEVELS                            
         CLI   APLLN,APLLN3Q       NEW STYLE RECORD                             
         JL    GETAPL46            NO, PROCESS AS A OLD RECORD                  
*                                  SAVE FINAL APPROVER STATUS                   
         MVC   APLVLFAP(L'APLVLFAP+L'APLVLHLV),APLFAPP                          
         J     GETAPL48            CONTINUE                                     
*                                                                               
GETAPL46 TM    ALIRSTAT,ALISFAPP   FINAL APPROVER REQUIRED  ?                   
         JZ    GETAPL48            NO,                                          
         MVI   APLVLFAP,YESQ       YES,SET FINAL APPROVAL REQUIRED              
*                                                                               
GETAPL48 CP    APLVAL,DUB          IS APPROVAL LIMIT GREAT OR EQUAL ?           
         JL    GETAPL50            NO                                           
*                                  YES                                          
         TM    APLIND1,APLIGREA    HAVE WE SAVED 1ST > THAN ORDER LEVEL         
         JNZ   GETAPL50            YES                                          
*                                  NO                                           
         ST    R4,ADRAPLVL         SAVE ADDRESS OF CURRENT ENTRY                
         OI    APLIND1,APLIGREA    SET WE SAVED THE ADDRESS                     
*                                                                               
GETAPL50 TM    APLIND1,APLIGREA    LEVEL > THAN ORDER FOUND  ?                  
         JNZ   GETAPL52            YES,                                         
*                                                                               
         LLC   RF,X#NPLVL          SAVE NO. OF PREVIOUS LEVELS ADDED            
         AHI   RF,1                TO TABLE                                     
         STC   RF,X#NPLVL          SAVE FOR FURTHER PROCESS                     
*                                                                               
GETAPL52 AHI   R4,APLVLTBL         BUMP TO NEXT FREE ENTRY                      
         J     GETAPL42            GET NEXT ELEMENT                             
         DROP  R3                                                               
*                                                                               
GETAPL54 TM    APLIND1,APLIGREA    DID WE FIND APPROPRIATE LEVEL                
         JZ    APPLERR2            NO - ORDER IS > ANY APPROVAL LIMIT           
         L     R4,ADRAPLVL         R4=A(HIGHEST LEVEL APPROVAL)                 
*                                                                               
GETAPL56 ZAP   DUB,APLVLVAL        SAVE APPROVAL VALUE                          
         LHI   R3,1                INIT TO ONE LEVEL                            
         SR    RF,RF               CLEAR FOR APPROVER LEVEL                     
         ICM   RF,1,APLVLPRV       N'PREVIOUS APPROVER LEVELS                   
         JZ    GETAPL58            NONE                                         
*                                                                               
         CLM   RF,1,X#NPLVL        DO WE HAVE ENOUGH PREVIOUS LEVELS            
         JH    APPLERR5            NO - ERROR                                   
*                                                                               
         AR    R3,RF               N'PREVIOUS LEVELS PLUS CURRENT ONE           
         SHI   R4,APLVLTBL         R4=A(PREVIOUS SLOT)                          
         JCT   RF,*-4              N TIMES, TO GET TO 1ST LVL REQUIRED          
*                                                                               
GETAPL58 ST    R4,ADRFSLVL         SAVE A(1ST LEVEL)                            
         ST    R3,SAVER3           SAVE COUNT                                   
         J     EXITY                                                            
**********************************************************************          
*NXTAPLVL - DISPLAY APPROVER LIMITS **********************************          
**********************************************************************          
*                                  PROCESS ALL THE RECORD AND DISPLAY           
         USING APLVLTD,R4                                                       
NXTAPLVL NTR1                                                                   
         ST    R8,LP_ADATA                                                      
         OC    ROUERRV,ROUERRV     ARE WE PROCESSING ERROR MESSAGE?             
         JZ    NXTAPLV1            NO, CONTINUE                                 
*                                                                               
         MVC   LP_ERROR,ROUERRV    SET ERROR MESSAGE DETAILS                    
         J     XERROR              PROCESS ERROR                                
*                                                                               
NXTAPLV1 L     R4,ADRCULVL                                                      
         L     R3,SAVER3           SAVE COUNT                                   
         CLI   LP_RMODE,LP_RFRST   FIRST TIME HERE ?                            
         JNE   NXTAPLV2            NO, CONTINUE                                 
*                                                                               
         L     R4,ADRFSLVL         ADDRESS (1ST LEVEL)                          
         J     NXTAPLV3            PROCESS DETAILS                              
*                                                                               
NXTAPLV2 XC    AP_VALS(AP_LNQ),AP_VALS CLEAR WORK AREA FOR OUTPUT               
         ZAP   AP_HLMT,PZERO       REINITIALISE PACKED DATA                     
         ZAP   AP_DAPL,PZERO       -                                            
*                                                                               
NXTAPLV3 LTR   R3,R3               MORE DETAILS TO PROCESS ?                    
         JZ    NOMORE              NO, EXIT                                     
*                                                                               
         ZAP   AP_HLMT,APLVLVAL    SAVED VALUES: APPROVAL VALUE                 
         MVC   AP_HNAT,APLVLNUM    N'APPROVERS, FOR THIS LEVEL                  
         MVC   AP_HNAP,APLVLPRV    N'PREVIOUS LEVELS                            
         AHI   R4,APLVLTBL         BUMP TO NEXT ENTRY                           
         BCTR  R3,0                                                             
         ST    R4,ADRCULVL         ADDRESS OF CURRENT LEVEL                     
         ST    R3,SAVER3           SAVE COUNT                                   
         MVI   LP_RMODE,LP_RNEXT   SET READ NEXT MODE                           
         J     EXITY                                                            
                                                                                
**********************************************************************          
**GETAPRS  - GET APPROVER DETAILS ************************************          
**********************************************************************          
         PUSH  USING                                                            
GETAPRS  NTR1                                                                   
         ST    R8,LP_ADATA                                                      
         OC    ROUERRV,ROUERRV     ARE WE PROCESSING ERROR MESSAGE?             
         JNZ   EXITN               NO, CONTINUE                                 
*                                                                               
         MVI   OL_INDS,0           INITALIZE OLIST PROCESS INDICATOR            
         CLC   HALF1,SPACES        OFFICE SPECIFIED ?                           
         JNH   GETAPR00            NO, CONTINUE                                 
*                                                                               
         GOTOR GETOLST             YES, GET OLIST DETAILS FOR OFFICE            
         USING OLISTD,R5           MAP WITH ORDER LIST                          
         LA    R5,SAVOLIST         ADDRESS OLIST                                
*                                                                               
*                                                                               
GETAPR00 GOTOR INIBUFA             INIT TSAR BUFFER                             
*&&US*&& MVI   BYTE1,C'N'          INIT WITH APPROVER NOT SENT                  
GETAPR01 L     R4,ADRFSLVL         R4=A(1ST LEVEL)                              
*                                                                               
GETAPR02 ST    R4,ADRCULVL         SAVE CURRENT APPROVAL LEVEL ENTRY            
         MVC   APLVLLVL,=X'0001'   SET APPROVER LEVEL                           
         LAY   R3,APR1TAB          ADDRESS APPROVAL TABLE                       
         USING APR1TABD,R3                                                      
         XC    APLAREA,APLAREA     CLEAR WORK AREA                              
*                                                                               
P        USING APETABD,APLAREA                                                  
GETAPR04 CLI   0(R3),X'FF'         END OF THE TABLE ?                           
         JE    GETAPR92            YES, EXIT                                    
         NI    APLIND1,X'FF'-APLIFOND SET DEFULT TO APPROVER NOT FOUND          
         LA    R2,IOKEY            READ APPROVER RECS VIA PASSIVES              
         USING APPPASD,R2           ** APPROVER PASSIVE RECORD  **              
         XC    APPPAS,APPPAS       CLEAR KEY WORK AREA                          
         MVI   APPPTYP,APPPTYPQ    READ RECORD FOR TYPE = X'37'                 
         MVI   APPPSUB,APPPSUBQ                SUB TYPE - X'0E'                 
         MVC   APPPCPY,CUXCPY      SAVE COMPANY CODE                            
         MVI   APPPCAT,APPPORD     READ FOR ORDERS VALUE APPROVER               
         CLI   RQ_APLTC,RQ_AINV    INVOICE ORDER TYPE ?                         
         JE    *+8                 YES, CONTINUE                                
*                                                                               
         CLI   RQ_APLTC,RQ_AINVN   INVOICE NO PURCHASE ORDER ?                  
         JNE   *+8                 NO, CONTINUE                                 
         MVI   APPPCAT,APPPINV     YES, SET INVOICE NO PURCHASE ORDER           
*                                                                               
         TM    APRTSTAT,APRTORT1   ORDER TYPE - EXPENSE PROD INTR ARTS?         
         JZ    GETAPR06            NO, CONTINUE                                 
*                                  YES                                          
         MVC   APPPSCAT,RQ_APOTY   SAVE ORDER TYPE                              
         J     GETAPR12                                                         
*                                                                               
GETAPR06 TM    APRTSTAT,APRTORT2   ORDER TYPE - CLIENT OR NON CLIENT ?          
         JZ    GETAPR10            NO, CONTINUE                                 
*                                  YES,                                         
         CLI   RQ_APMIX,YESQ       HAVE WE A MIX OF CLIENT AND NONE             
         JE    GETAPR46            YES - SKIP THIS TABLE ENTRY                  
*                                  NO                                           
         CLI   RQ_APALL,YESQ       HAVE WE ALL CLIENTS BUT DIFFERENT            
         JE    GETAPR08            YES - SET ORDER TYPE AS ALL CLI              
*                                  NO                                           
         MVI   APPPSCAT,ALIKNCLI   TRY NON-CLIENT OR CLIENT TYPE                
         CLC   RQ_APCLI,SPACES     CLIENT DETAILS INPUT ?                       
         JNH   GETAPR12            NO, CONTIUNE                                 
*                                  YES,                                         
GETAPR08 MVI   APPPSCAT,ALIKCLI    SET CLIENT ORDERS                            
         J     GETAPR12                                                         
*                                                                               
GETAPR10 MVI   APPPSCAT,ALIKDFT    SET DEFULT ORDER                             
*                                                                               
GETAPR12 CP    APLVLVAL,PZERO      VALUE OF APPROVAL LEVEL ?                    
         JNE   *+8                 NO, CONTINUE                                 
         MVI   APPPCAT,APPPORDF    YES, SET ORDERS FINANCE APPROVER             
*                                                                               
         ZAP   APPPVAL,APLVLVAL    APPROVAL VALUE FROM TABLE                    
         MVC   APPPACLA,SPACES     INIT CREDITOR LEDGER/ACCOUNT                 
         MVC   APPPOFFC,SPACES     INIT OFFICE CODE                             
         MVC   APPPMED,SPACES      INIT MEDIA CODE                              
         MVC   APPPDEPT,SPACES     INIT DEPARTMENT CODE                         
         MVC   APPPETYP,SPACES     INIT ETYPE CODE                              
         TM    CPYSTAT1,CPYSOROE   IS OFFICE REQUIRED ON EXPENSES?              
         JZ    GETAPR14            NO, CONTINUE                                 
*                                  YES                                          
         TM    APRTSTAT,APRTOFFC   OFFICE ORDER TYPE ?                          
         JZ    GETAPR14            NO, CHECK FOR MEDIA                          
*                                                                               
         TM    OL_INDS,OL_PROLT    PROCESS DETAILS FROM OLIST ?                 
         JZ    GETAPR13            NO, CONTINUE                                 
*                                  YES                                          
         MVC   APPPOFFC,OLISTCDE   SAVE OLIST FOR PROCESS                       
         J     GETAPR14            CONTINUE                                     
*                                                                               
GETAPR13 CLC   HALF1,SPACES        IS OFFICE CODE PRESENT ?                     
         JNH   GETAPR46            NO,                                          
         MVC   APPPOFFC,HALF1      OFFICE CODE OR FF'S                          
*                                                                               
GETAPR14 TM    APRTSTA2,APRTMED    MEDIA ?                                      
         JZ    GETAPR16            NO, CONTINUE                                 
*                                  YES,                                         
         CLI   RQ_APJOB,C' '       JOB DETAILS INPUT ?                          
         JNH   GETAPR46            NO                                           
         MVC   APPPMED,RQ_APJOB    YES, SAVE THE DETAILS                        
*                                                                               
GETAPR16 TM    APRTSTAT,APRTDEPT   DEPARTMENT ?                                 
         JZ    GETAPR18            NO                                           
*                                                                               
         LHI   RF,1                SET 1 BYTE OFFICE CODE AS DEFULT             
         TM    CPYSTAT4,CPYSOFF2   NEW STYLE OFFICE SYSTEM IN USE?              
         JZ    *+8                 NO, PROCESS AS A 1 BYTE OFFICE CODE          
         LHI   RF,2                SET 2 BYTE OFFICE CODE FOR NEW STYLE         
*                                                                               
         LA    R1,RQ_APDPT         POINT START OF THE INPUT DEPT CODE           
         AR    RF,R1               POINT END OF THE OFFICE CODE                 
         CLI   0(RF),C' '          ANY DETAILS PRESENT ?                        
         JNH   GETAPR46            NO                                           
*                                  YES,                                         
         MVC   APPPDEPT,0(RF)      SAVE DEPT CODE DETAILS                       
*                                                                               
GETAPR18 TM    APRTSTAT,APRTETYP   EXPENDITURE TYPE ?                           
         JZ    GETAPR20            NO , SKIP CHECK                              
*                                                                               
         CLI   RQ_APETY,C' '       EXPENDITURE TYPE INPUT ?                     
         JNH   GETAPR46            NO                                           
         MVC   APPPETYP,RQ_APETY   YES, SAVE EXPENDITURE TYPE DETAILS           
*                                                                               
GETAPR20 TM    APRTSTA2,APRTSUP    SUPPLIER CODE ?                              
         JZ    GETAPR22            NO,                                          
*                                  YES                                          
         CLI   RQ_APSUP,C' '       SUPPLIER CODE INPUT ?                        
         JNH   GETAPR46            NO, SKIP                                     
*                                                                               
         MVC   APPPACLA,RQ_APSUP+L'ACTKUNT  SAVE SUPPLIER CODE DETAILS          
         J     GETAPR38            CONTINUE                                     
*                                                                               
GETAPR22 TM    APRTSTAT,APRTJOB    JOB ?                                        
         JZ    GETAPR24            NO, SKIP                                     
*                                                                               
         CLI   RQ_APJOB,C' '       JOB DETAILS INPUT ?                          
         JNH   GETAPR46            NO,                                          
*                                                                               
         MVC   APPPACLA,ANYACCNT+L'ACTKUNT   YES, SAVE JOB DETAILS              
         J     GETAPR38                                                         
*                                                                               
GETAPR24 TM    APRTSTAT,APRTPRO    PRODUCT ?                                    
         JZ    GETAPR26            NO                                           
*                                                                               
         CLI   RQ_APPRO,C' '       PRODUCT DETAILS PRESENT ?                    
         JNH   GETAPR46            NO, SKIP                                     
*                                                                               
         LLC   RF,PPROLEN          LENGTH OF THE PRODUCT                        
         BASR  RE,0                REDUCE 1 FOR MACHINE INSTR                   
         MVC   APPPACLA(0),ANYACCNT+L'ACTKUNT SAVE PRODUCT CODE                 
         EX    RF,0(RE)                                                         
         J     GETAPR38            CONTINUE                                     
*                                                                               
GETAPR26 TM    APRTSTAT,APRTCLI    CLIENT ?                                     
         JZ    GETAPR28            NO,                                          
*                                  YES,                                         
         CLI   RQ_APCLI,C' '       CLIENT DETAILS INPUT ?                       
         JNH   GETAPR46            NO                                           
*                                  YES,                                         
         LLC   RF,PCLILEN          LENGTH OF THE CLIENT CODE                    
         BASR  RE,0                MINUS 1 FOR MACHINE INSTR.                   
         MVC   APPPACLA(0),ANYACCNT+L'ACTKUNT SAVE CLIENT CODE                  
         EX    RF,0(RE)                                                         
         J     GETAPR38            CONTINUE                                     
*                                                                               
GETAPR28 TM    APRTSTA2,APRT2PA    2P ACCOUNT ?                                 
         JZ    GETAPR30            NO, CONTINUE                                 
*                                  YES                                          
         CLI   RQ_AP2PA,C' '       2P ACCOUNT CODE INPUT ?                      
         JNH   GETAPR46            NO                                           
*                                                                               
         MVI   APPPACLG,C'P'                                                    
         MVC   APPPACCD,RQ_AP2PA   SAVE 2P ACCOUNT CODE                         
         J     GETAPR38                                                         
*                                                                               
GETAPR30 TM    APRTSTA2,APRT2PE    1R PERSON LEVEL ?                            
         JZ    GETAPR32            NO,                                          
*                                  YES                                          
         CLC   X#1RACC,SPACES      1R ACCOUNT DETAILS PRESENT ?                 
         JNH   GETAPR46            NO, SKIP                                     
*                                  YES                                          
         MVI   APPPACLG,C'R'                                                    
         LA    RF,L'ACTKACT        LENGTH OF THE ACCOUNT CODE                   
         BCTR  RF,0                -1 FOR MACHINE INSTR.                        
         BASR  RE,0                SAVE THE 1R ACCOUNT DETAILS                  
         MVC   APPPACCD(0),X#1RACC                                              
         EX    RF,0(RE)                                                         
         J     GETAPR38                                                         
*                                                                               
GETAPR32 TM    APRTSTA2,APRT2SD    1R SUBDEP LEVEL ?                            
         JZ    GETAPR34            NO,                                          
*                                                                               
         CLC   X#1RACC,SPACES      1R PERSON LEVEL ?                            
         JNH   GETAPR46            NO,                                          
*                                  YES                                          
         MVI   APPPACLG,C'R'                                                    
         LLC   RF,ONERL3L          LENGTH OF THE IR                             
         BCTR  RF,0                -1 FOR MACHINE INSTR.                        
         BASR  RE,0                                                             
         MVC   APPPACCD(0),X#1RACC SAVE THE 1R ACCOUNT DETAILS                  
         EX    RF,0(RE)                                                         
         J     GETAPR38                                                         
*                                                                               
GETAPR34 TM    APRTSTA2,APRT2DE    1R DEPARTMENT LEVEL  ?                       
         JZ    GETAPR36            NO,                                          
*                                  YES                                          
         CLC   X#1RACC,SPACES      1R ACCOUNT DETAILS PRESENT ?                 
         JNH   GETAPR46            NO, SKIP                                     
*                                                                               
         MVI   APPPACLG,C'R'                                                    
         LLC   RF,ONERL2L          LENGTH                                       
         BCTR  RF,0                -1 FOR MACHINE INSTR.                        
         BASR  RE,0                                                             
         MVC   APPPACCD(0),X#1RACC SAVE ACCOUNT DETAIL                          
         EX    RF,0(RE)                                                         
         J     GETAPR38                                                         
*                                                                               
GETAPR36 TM    APRTSTA2,APRT2OF    1R OFFICE LEVEL  ?                           
         JZ    GETAPR38            NO                                           
*                                                                               
         CLC   X#1RACC,SPACES      1R ACCOUNT DETAILS PRESENT ?                 
         JNH   GETAPR46            NO, SKIP                                     
*                                                                               
         MVI   APPPACLG,C'R'                                                    
         LLC   RF,ONERL1L          LENGTH                                       
         BCTR  RF,0                -1 FOR MACHINE INSTR.                        
         BASR  RE,0                                                             
         MVC   APPPACCD(0),X#1RACC SAVE ACCOUNT DETAILS                         
         EX    RF,0(RE)                                                         
         J     GETAPR38                                                         
*                                                                               
GETAPR38 MVC   CSVKEY1(L'APPPAS),APPPAS  READ RECORD FOR THE KEY                
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         J     GETAPR44                                                         
                                                                                
GETAPR40 LA    R2,IOKEY                                                         
         MVC   IOKEY,SAVEKEY       RESTORE READ SEQUENCE                        
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
GETAPR42 NI    APLIND1,X'FF'-APLISLF  REMOVE SELF APPROVED                      
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
*                                                                               
GETAPR44 CLC   CSVKEY1(APPPPIDB-APPPAS),APPPAS  SAME KEY ?                      
         JE    GETAPR50            YES                                          
*                                  NO,                                          
GETAPR46 TM    APLIND1,APLIFOND    APPROVER FOUND AT THIS LEVEL ?               
         JZ    GETAPR48            NO                                           
*                                                                               
         LH    RF,APLVLLVL         LEVEL OF APPROVER SO FAR                     
         AHI   RF,1                ADD 1 TO IT                                  
         STH   RF,APLVLLVL         SAVE UPDATED LEVEL OF APPROVER               
*                                                                               
GETAPR48 AHI   R3,APR1TABL         PROCESS NEXT ENTRY                           
         J     GETAPR04            LOOP FOR IT                                  
*                                                                               
GETAPR50 CLI   RQ_APLTC,RQ_AINV    TEST INVOICES ?                              
         JE    GETAPR58            SKIP SELF-APPROVAL                           
*                                                                               
         CLI   RQ_APLTC,RQ_AINVN   INVOICE NO PURCHASE ORDER ?                  
         JE    GETAPR58            YES,                                         
*                                  NO,                                          
         CLI   RQ_APEDT,NOQ        IS EDITOR NOT THE SUBMITTER - IGNORE         
         JE    GETAPR58            SELF APPROVAL RULES                          
*                                                                               
         LA    RE,RNSASEQ          SELF APPROVAL BY ORDER TYPE                  
         CLI   RQ_APOTY,ALIKEXP    EXPENSES  ORDER TYPE ?                       
         JE    GETAPR52            YES                                          
*                                  NO                                           
         LA    RE,RNSASPQ          SET PRODUCTION ORDER DEFULT                  
         CLI   RQ_APOTY,ALIKPROD   PRODUCTION ORDER ?                           
         JE    GETAPR52            YES, CONTINUE                                
*                                  NO                                           
         LA    RE,RNSASAQ          SET AS A ARTIST ORDERS                       
         CLI   RQ_APOTY,ALIKART    ARTIST ORDERS ?                              
         JE    GETAPR52            YES, CONTINUE                                
*                                  NO                                           
         LA    RE,RNSASIQ          SET AS INTERNAL ORDERS                       
         CLI   RQ_APOTY,ALIKINT    INTERNAL ORDERS  ?                           
         JE    GETAPR52            YES, CONTINUE                                
         DC    H'0'                NO, ABEND INVALID ORDER TYPE                 
*                                                                               
GETAPR52 BASR  R1,0                                                             
         TM    X.RNSAIND,0         SET REQ. NO./SELF APPR. INDICATOR            
         EX    RE,0(R1)                                                         
         JNZ   GETAPR54            SELF APPROVAL OK                             
*                                                                               
         CLI   RQ_APOWN,NOQ        CAN APPROVER SELF APPROVE?                   
         JE    GETAPR54            YES                                          
*                                                                               
         CLC   APPPPIDB,CCTPID     NO - CHECK NOT APPROVER NOT SELF             
         JE    GETAPR42            IT IS IGNORE ENTRY                           
*                                                                               
GETAPR54 LA    RE,CCTPID           CONNECTED ACC PID                            
*        CLI   RQ_APLTC,RQ_AEXPS   IN EXPENSE CONNECTED USER ?                  
*        JNE   GETAPR56            DIFFERENT TO CLAIMANT                        
*                                                                               
         LA    RE,X#PPIN           ADDRESS PID DETAILS                          
*                                                                               
GETAPR56 CLC   APPPPIDB,0(RE)      IS THE PID THE SAME ?                        
         JNE   GETAPR58            NO                                           
*                                  YES                                          
         OI    APLIND1,APLISLF     SET SELF APPROVER                            
         CLI   RQ_APSEL,YESQ       SELF APPROVAL ALLOWED FOR ETYPE              
         JNE   GETAPR42            NO                                           
*                                                                               
         CP    APPPSEL,APPPVAL     YES - CHECK WE HAVEN'T EXCEEDED IT           
         JNL   GETAPR60            NO, CONTINUE                                 
         J     GETAPR42            YES                                          
*                                                                               
GETAPR58 CP    APPPSEL,APPPVAL     DON'T SHOW SELF APPROVER LIMITS              
         JH    GETAPR42            TO OTHER USERS                               
*                                                                               
GETAPR60 MVC   SAVEKEY,IOKEY       SAVE KEY DETAILS                             
*                                                                               
GETAPR62 CURED (B2,APLVLLVL),(L'APERLVL,P.APERLVL),0,ZERO=YES,         +        
               ALIGN=LEFT                                                       
*                                                                               
         ZAP   P.APERAPL,APPPVAL     SET APPROVAL LIMIT                         
         ZAP   P.APERAPL2,APPPVAL                                               
         MVC   TEMP2(L'APPPPIDB),APPPPIDB                                       
*                                                                               
         GOTOR (#GETPID,AGETPID)   GET 8 CHARACTER PID                          
         MVC   P.APERPID,TEMP2     SAVE  PERSON ID                              
*                                                                               
         GOTOR (#GETPIN,AGETPIN)   GET PERSON NAMES                             
*                                                                               
         L     R2,AIO1             ADDRESS RECORD                               
         LA    RF,SAPEDATA-SAPEREC(R2) POINT TO THE START OF ELEM DATA          
*                                                                               
         USING SAPERD,RF           MAP WITH PERSONNEL DETAILS ELEMENT           
         XR    R0,R0                                                            
GETAPR64 CLI   SAPEREL,0           CHECK IF USER TERMINATED                     
         JNE   *+6                 NO, CONTINUE                                 
         DC    H'0'                YES, ABEND                                   
*                                                                               
         CLI   SAPEREL,SAPERELQ    PERSONNEL DETAILS ELEMENT FOUND ?            
         JE    GETAPR66            YES, CONTINUE                                
*                                  NO                                           
         IC    R0,SAPERLN          L'ELEMENT                                    
         AR    RF,R0               POINT TO THE NEXT ELEMENT                    
         J     GETAPR64            LOOP IT                                      
*                                                                               
GETAPR66 OC    SAPERDTE,SAPERDTE   ARE THEY TERMINATED?                         
         JZ    GETAPR68            NO                                           
*                                  YES                                          
         CLC   SAPERDTE,XL#TODC    TERMINATED IN THE FUTURE ?                   
         JNH   GETAPR40            NO, SKIP                                     
         DROP  RF                                                               
*                                  YES                                          
GETAPR68 MVC   P.APERPFN,TEMP2     SAVE APPROVER FIRST NAME                     
         MVC   P.APERPLN,WORK2     SAVE APPROVER LAST NAME                      
         MVC   P.APERPMN,TEMP2+32  SAVE APPROVER MIDDLE NAME                    
         TM    APLIND1,APLIEML     CAN EMAILS JE SENT ?                         
         JZ    *+10                NO, CONTINUE                                 
         MVC   P.APEREMA,APPEMAIL  SAVE EMAIL ADDRESS                           
*                                                                               
         MVC   IOKEY,SAVEKEY       RESTORE READ SEQUENCE                        
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         LA    R2,IOKEY            SET/RESET R2 TO IOKEY                        
*                                                                               
         TM    APRTSTAT,APRTORT1+APRTORT2 ORDER TYPE - EXP/CLI/NONCLI?          
         JZ    *+8                 NO, CONTINUE                                 
         MVI   P.APEMORT,YESQ      SET MATCHED AT ORDER TYPE                    
*                                                                               
         TM    APRTSTAT,APRTOFFC   OFFICE ORDER ?                               
         JZ    *+8                 NO, CONTINUE                                 
         MVI   P.APEMOFF,YESQ      YES, SET MATCHED AT OFFICE                   
*                                                                               
         TM    APRTSTAT,APRTDEPT   DEPT ORDER ?                                 
         JZ    *+8                 NO, CONTINUE                                 
         MVI   P.APEMDPT,YESQ      YES, SET MATCHED AT DEPARTMENT               
*                                                                               
         TM    APRTSTAT,APRTETYP   EXPENDITURE TYPE ORDER ?                     
         JZ    *+8                 NO, CONTINUE                                 
         MVI   P.APEMETY,YESQ      YES, SET MATCHED AT EXPENDITURE TYPE         
*                                                                               
         TM    APRTSTAT,APRTJOB    JOB ORDER ?                                  
         JZ    GETAPR70            NO, CONTINUE                                 
         MVI   P.APEMJOB,YESQ      YES, SET MATCHED AT JOB                      
         J     GETAPR74            CONTINUE                                     
*                                                                               
GETAPR70 TM    APRTSTAT,APRTPRO    PRTODUCT TYPE ORDER ?                        
         JZ    GETAPR72            NO, SKIP                                     
         MVI   P.APEMPRO,YESQ      YES, SET MATCHED AT PRODUCT                  
         J     GETAPR74            CONTINUE                                     
*                                                                               
GETAPR72 TM    APRTSTAT,APRTCLI    CLIENT TYPE ORDER ?                          
         JZ    GETAPR74            NO, SKIP                                     
         MVI   P.APEMCLI,YESQ      YES, SET MATCHED AT CLIENT                   
*                                                                               
GETAPR74 TM    APRTSTA2,APRTMED    MEDIA ?                                      
         JZ    *+8                 NO, CONTINUE                                 
         MVI   P.APEMMED,YESQ      YES, SET MATCHED AT MEDIA                    
*                                                                               
         TM    APRTSTA2,APRT2PA    2P ACCOUNT ?                                 
         JZ    *+8                 NO, CONTINUE                                 
         MVI   P.APEM2PA,YESQ      YES, SET MATCHED AT 2P ACCOUNT               
*                                                                               
         TM    APRTSTA2,APRTSUP    SUPPLIER ORDER ?                             
         JZ    *+8                 NO, CONTINUE                                 
         MVI   P.APEMSUP,YESQ      YES, SET MATCHED AT SUPPLIER                 
*                                                                               
         MVI   P.APERAPT,AGENCYQ   SET AGENCY LEVEL APPROVER                    
         MVI   P.APERDEF,NOQ       SET NO TO DEFAULT APPROVER                   
         CLI   APPPCAT,APPPORDF    IS IT A PURCHASING APPROVER ?                
         JNE   GETAPR76            NO                                           
         MVI   P.APERAPT,PURCHSQ   YES, SET AGENCY OR PURCHS. APPROVER          
*                                                                               
GETAPR76 TM    APPPSTAT,APPPDFLT   IS IT A DEFAULT APPROVER                     
         JZ    GETAPR78            NO,CONTINUE                                  
         MVI   P.APERDEF,YESQ      SET AS DEFAULT                               
*                                                                               
GETAPR78 TM    APLIND1,APLIHLV     ARE WE READING HIGH LEVELS FOR LOW           
         JNZ   GETAPR82            LEVELS ONLY                                  
*                                  TSAR  RECORD PROCESSING                      
T        USING TSARD,TSARABUF                                                   
GETAPR80 L     R0,AIO1             COPY BUFFER TO IO1                           
         LA    R1,APETABL          APPROVER TABLE LENGTH                        
         LA    RE,APLAREA          AREA TO READ APPROVERS FROM BUFFER           
         LR    RF,R1               SAVE THE LENGTH                              
         MVCL  R0,RE               SAVE DETAILS                                 
*                                                                               
         MVI   T.TSACTN,TSARDH     SET ACTION TO 'READ HIGH'                    
         XC    P.APERAPL2(APESRTL),P.APERAPL2                                   
         LA    R0,APLAREA                                                       
         ST    R0,T.TSAREC         READ INTO ACQUIRED STORAGE                   
*                                                                               
         GOTOR VTSAR,T.TSARD                                                    
*                                                                               
         L     R1,AIO1                                                          
         TM    T.TSERRS,TSEEOF                                                  
         JNZ   *+14                                                             
*                                                                               
         CLC   APLAREA(APEDUPL),0(R1)                                           
         JE    GETAPR42                                                         
*                                                                               
         GOTOR ADDBUFA                                                          
*                                                                               
         LA    R0,APLAREA          COPY BUFFER TO IO1                           
         LA    R1,APETABL                                                       
         L     RE,AIO1                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
*                                                                               
*&&US*&& MVI   BYTE1,C'Y'          SHOW THAT APPROVER WAS SENT                  
GETAPR82 TM    APLIND1,APLIPUR     ARE WE DEALING WITH PURCHASING               
         JNZ   GETAPR91            YES - DON'T LOOK AT LOWER LEVELS             
         L     R6,ADRFSLVL         NO, LOAD FIRST LEVEL                         
*                                                                               
PREV     USING APLVLTD,R6                                                       
GETAPR84 CLM   R6,15,ADRCULVL      ENSURE IT'S BEFORE CURRENT LEVEL             
         JNL   GETAPR91                                                         
         CLM   R6,15,ADRAPLVL      DON'T ADD ITEMS FOR LEVEL ABOVE              
         JH    GETAPR91                                                         
*                                                                               
         TM    APLIND1,APLISLF     IS IT SELF APPROVED                          
         JNZ   GETAPR86            NO                                           
*                                                                               
         TM    APLIND1,APLIHSL     ARE WE ONLY INTERESTED IN SELF APPR          
         JNZ   GETAPR91                                                         
*                                                                               
         CLI   PREV.APLVLHLV,YESQ  DOES THIS LEVEL ACCEPT HIGHER LEVEL          
         JNE   GETAPR90            -                      APPROVERS             
*                                                                               
GETAPR86 ZAP   P.APERAPL,PREV.APLVLVAL  SET APPROVAL LIMIT                      
         ZAP   P.APERAPL2,PREV.APLVLVAL                                         
         TM    APLIND1,APLIFOND                                                 
         JNZ   GETAPR88                                                         
*                                                                               
         LH    RF,PREV.APLVLLVL                                                 
         AHI   RF,1                                                             
         STH   RF,PREV.APLVLLVL                                                 
*                                                                               
GETAPR88 CURED (B2,PREV.APLVLLVL),(L'APERLVL,P.APERLVL),0,ZERO=YES,    +        
               ALIGN=LEFT                                                       
*                                                                               
         XR    RF,RF                                                            
         ICM   RF,1,PREV.APLVLNUM  DECREMENT APPROVERS REQUIRED                 
         JZ    GETAPR89            DON'T LET IT GO LESS THAN ZERO               
         SHI   RF,1                                                             
         STC   RF,PREV.APLVLNUM                                                 
*                                                                               
GETAPR89 L     R0,AIO1             COPY BUFFER TO IO1                           
         LA    R1,APETABL                                                       
         LA    RE,APLAREA                                                       
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
*                                                                               
         MVI   T.TSACTN,TSARDH     SET ACTION TO 'READ HIGH'                    
         XC    P.APERAPL2(APESRTL),P.APERAPL2  CLEAR KEY                        
         LA    R0,APLAREA          ADDRESS TABLE AREA                           
         ST    R0,T.TSAREC         READ INTO ACQUIRED STORAGE                   
*                                                                               
         GOTOR VTSAR,T.TSARD                                                    
*                                                                               
         L     R1,AIO1                                                          
         TM    T.TSERRS,TSEEOF                                                  
         JNZ   *+14                                                             
         CLC   APLAREA(APEDUPL),0(R1)                                           
         JE    GETAPR42                                                         
*                                                                               
         GOTOR ADDBUFA                                                          
*                                                                               
         LA    R0,APLAREA          COPY BUFFER TO IO1                           
         LA    R1,APETABL                                                       
         L     RE,AIO1                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
*&&US*&& MVI   BYTE1,C'Y'          Show that approver was sent                  
*                                                                               
GETAPR90 AHI   R6,APLVLTBL                                                      
         J     GETAPR84                                                         
*                                                                               
GETAPR91 OI    APLIND1,APLIFOND    SET APPROVER FOUND AT THIS LEVEL             
         XR    RF,RF                                                            
         ICM   RF,1,APLVLNUM       DECREMENT APPROVERS REQUIRED                 
         JZ    GETAPR42            DON'T LET IT GO LESS THAN ZERO               
*                                                                               
         SHI   RF,1                REDUCE NUMBER BY 1                           
         STC   RF,APLVLNUM         SET FINAL NUMBER                             
         J     GETAPR42                                                         
*                                                                               
GETAPR92 L     R6,ADRAPLVL         LOAD LEVEL GREATER THAN ORDER                
         CLM   R4,15,ADRAPLVL      DON'T ADD ITEMS FOR LEVEL ABOVE              
         JL    GETAPR93                                                         
*                                                                               
         OI    APLIND1,APLIHLV     SET FLAG GET HIGHER LEVELS                   
         CLI   PREV.APLVLHLV,YESQ  ARE WE GETTING HIGHER LEVELS                 
         JE    GETAPR93                                                         
         OI    APLIND1,APLIHSL     SET FLAG ONLY FOR SELF APPROVERS             
*                                                                               
GETAPR93 LH    RF,APLVLLVL         REMOVE 1 FROM THE CURRENT LEVEL              
         SHI   RF,1                AS WILL ADD 1 WHEN WE ADD HIGHER             
         STH   RF,APLVLLVL         LEVELS                                       
         AHI   R4,APLVLTBL         BUMP TO NEXT APPROVAL VALUE                  
         OC    APLVLVAL,APLVLVAL   ANY MORE APPROVAL LIMITS                     
         JNZ   GETAPR02                                                         
*                                                                               
GETAPR94 CLI   PREV.APLVLFAP,YESQ  ARE WE GETTING PURCHASING APPROVER           
         JNE   GETAPR95            NO,                                          
*                                                                               
         TM    APLIND1,APLIPUR     HAVE WE ALREADY PROCESSED                    
         JNZ   GETAPR95            YES                                          
*                                                                               
         ZAP   APLVLVAL,PZERO      BUILD ENTRY FOR PURCHASING APPROVER          
         MVI   APLVLNUM,X'01'                                                   
         XC    APLVLPRV,APLVLPRV                                                
         XC    APLVLHLV,APLVLHLV                                                
         OI    APLIND1,APLIPUR                                                  
         NI    APLIND1,X'FF'-(APLIHLV+APLIHSL)                                  
         J     GETAPR02                                                         
*                                                                               
GETAPR95 TM    OL_INDS,OL_PRSNT    OLIST DETAILS PRESENT ?                      
         JZ    GETAPR96            NO, CONTINUE                                 
*                                  YES                                          
         TM    OL_INDS,OL_PROLT    1ST TIME HERE ?                              
         JZ    GETAPR9A            YES, CONTINUE                                
         AHI   R5,OLSTDLNQ         NO, POINT TO THE NEXT OLIST ENTRY            
*                                                                               
GETAPR9A OI    OL_INDS,OL_PROLT    SET - PROCESS OLIST DETAILS                  
         CLC   OLISTCDE,SPACES     OLIST/OFFICE CODE PRESENT ?                  
         JNH   GETAPR96            YES, CONTINUE                                
*                                  NO, PROCESS FOR OLIST                        
         NI    APLIND1,X'FF'-(APLIHLV+APLIHSL)                                  
         J     GETAPR01                                                         
*                                                                               
GETAPR96 L     R4,ADRFSLVL         CHECK WE HAVE ENOUGH APPROVERS               
         NI    APLIND1,X'FF'-APLIPUR  FOR EACH LEVEL                            
*                                                                               
GETAPR97 TM    APLIND1,APLIPUR                                                  
         JNZ   GETAPR98                                                         
         CLM   R4,15,ADRAPLVL      DON'T CHECK LEVELS ABOVE LEVEL FOR           
         JH    GETAPR99                                     THIS ORDER          
*                                                                               
GETAPR98 XR    RF,RF                                                            
         ICM   RF,1,APLVLNUM       DECREMENT APPROVERS REQUIRED                 
         JZ    GETAPR99            DON'T LET IT GO LESS THAN ZERO               
*                                                                               
         CP    APLVLVAL,PZERO                                                   
         JNE   APPLERR3            VALUE APPROVER MISSING                       
         J     APPLERR4            PURCHASING APPROVER MISSING                  
*                                                                               
GETAPR99 AHI   R4,APLVLTBL         BUMP TO NEXT APPROVAL VALUE                  
         OC    APLVLVAL,APLVLVAL   ANY MORE APPROVAL LIMITS                     
         JZ    EXITY                                                            
*                                                                               
         CP    APLVLVAL,PZERO      IS IT PURCHASING LEVEL ?                     
         JNE   GETAPR97            NO                                           
*                                  YES,                                         
         OI    APLIND1,APLIPUR     SET PURCHASING LEVEL                         
         J     GETAPR97                                                         
         DROP  R5                                                               
         POP   USING                                                            
**********************************************************************          
**NXTAPRS  - PROCESS NEXT APPROVER DETAILS ***************************          
**********************************************************************          
*                                                                               
T        USING TSARD,TSARABUF                                                   
P        USING APETABD,APLAREA                                                  
NXTAPRS  NTR1                                                                   
         ST    R8,LP_ADATA                                                      
         OC    ROUERRV,ROUERRV     ARE WE PROCESSING ERROR MESSAGE?             
         JZ    NXTAPRS2            NO, CONTINUE                                 
*                                                                               
         MVC   LP_ERROR,ROUERRV    SET ERROR MESSAGE DETAILS                    
         J     XERROR              PROCESS ERROR                                
*                                                                               
NXTAPRS2 DS    0H                                                               
         CLI   LP_RMODE,LP_RFRST   FIRST TIME HERE ?                            
         JNE   NXTAPRS3            NO, CONTINUE                                 
*                                                                               
         MVI   T.TSACTN,TSASRT     SET ACTION TO 'READ HIGH'                    
         MVC   T.TSRTPARM,=AL1(0,APERAPL2-APERAPL,APESRTL)                      
*                                                                               
         GOTOR VTSAR,T.TSARD                                                    
*                                                                               
         MVI   T.TSACTN,TSARDH     SET ACTION TO 'READ HIGH'                    
         XC    APLAREA,APLAREA                                                  
         LA    R0,APLAREA                                                       
         ST    R0,T.TSAREC         READ INTO ACQUIRED STORAGE                   
         GOTOR VTSAR,T.TSARD                                                    
         J     NXTAPRS4            PROCESS RECORD                               
*                                                                               
NXTAPRS3 DS    0H                                                               
         MVI   T.TSACTN,TSANXT     READ NEXT RECORD                             
         LA    R0,APLAREA          ADDRESS WORK AREA                            
         ST    R0,T.TSAREC         READ RECORD IN APLAREA WORK AREA             
*                                                                               
         GOTOR VTSAR,T.TSARD       READ NEXT RECORD FROM TSAR                   
*                                                                               
         TM    T.TSERRS,TSEEOF     PROCESSED ALL THE RECORD ?                   
         JNZ   APPL250             YES, EXIT                                    
*                                                                               
NXTAPRS4 DS    0H                                                               
         XC    AP_VALS(AP_LNQ),AP_VALS   CLEAR RECORD                           
         ZAP   AP_HLMT,PZERO       RE-INIT PACKED OUTPUT FIELDS                 
         ZAP   AP_DAPL,P.APERAPL                                                
         MVC   AP_DPFN,P.APERPFN                                                
         MVC   AP_DPID,P.APERPID                                                
         MVC   AP_DPLN,P.APERPLN                                                
         MVC   AP_DPMN,P.APERPMN                                                
         MVC   AP_DEMA,P.APEREMA                                                
         MVC   AP_DLVL,P.APERLVL                                                
         MVC   AP_DAPT,P.APERAPT                                                
         MVC   AP_DDEF,P.APERDEF                                                
         MVC   AP_MORT,P.APEMORT                                                
         MVC   AP_MOFF,P.APEMOFF                                                
         MVC   AP_MDPT,P.APEMDPT                                                
         MVC   AP_METY,P.APEMETY                                                
         MVC   AP_MSUP,P.APEMSUP                                                
         MVC   AP_M2PA,P.APEM2PA                                                
         MVC   AP_MJOB,P.APEMJOB                                                
         MVC   AP_MPRO,P.APEMPRO                                                
         MVC   AP_MCLI,P.APEMCLI                                                
         MVC   AP_MMED,P.APEMMED                                                
         MVI   LP_RMODE,LP_RNEXT   SET READ NEXT MODE                           
         J     EXITY                                                            
APPL250  DS    0H                                                               
*&&US*&& CLI   BYTE1,C'Y'          WAS AN APPROVER FOUND?                       
*&&US*&& JNE   APPLERR3                                                         
         J     NOMORE                                                           
*                                                                               
APPLERR1 MVC   ROUERRV,=AL2(AE$ENDOF)   FILE ERROR                              
         J     EXITN                     EXIT                                   
*                                                                               
APPLERR2 DS    0H                  ORDER VALUE > ANY APPROVAL LIMIT             
         CLI   RQ_APLTC,RQ_AINV    INVOICES                                     
         JE    APPLERRI                                                         
*                                                                               
         CLI   RQ_APLTC,RQ_AINVN                                                
         JE    APPLERRI                                                         
*                                                                               
APPLERRO MVC   ROUERRV,=AL2(AE$OVGAP)                                           
         J     EXITN                                                            
*                                                                               
APPLERRE MVC   ROUERRV,=AL2(AE$EVGAP)                                           
         J     EXITN                                                            
*                                                                               
APPLERRS MVC   ROUERRV,=AL2(AE$SVGAP)                                           
         J     EXITN                                                            
*                                                                               
APPLERRI MVC   ROUERRV,=AL2(AE$IVGAP)                                           
         J     EXITN                                                            
*                                                                               
APPLERR3 DS    0H                      NOT ENOUGH APPROVERS FOUND               
         MVC   ROUERRV,=AL2(AE$NEAPF)                                           
         J     EXITN                                                            
*                                                                               
APPLERR4 DS    0H                      FINAL APPROVER NOT FOUND                 
         MVC   ROUERRV,=AL2(AE$FARNF)                                           
         J     EXITN                                                            
*                                                                               
APPLERR5 DS    0H                      APLIMIT PREVIOUS LEVELS INVALID          
         MVC   ROUERRV,=AL2(AE$ALRIN)                                           
         J     EXITN                                                            
*                                                                               
APPLERR6 MVC   ROUERRV,=AL2(AE$ALIXP)   EXPENSE APLIMIT RECORD MISSING          
         J     EXITN                                                            
*                                                                               
APPLERR7 MVC   ROUERRV,=AL2(AE$ESTNF)   ESTIMATE NOT FOUND                      
         J     EXITN                                                            
*                                                                               
APPLERR8 MVC   ROUERRV,=AL2(AE$ALIES)   ESTIMATE APLIMIT REC MISSING            
         J     EXITN                                                            
*                                                                               
APPLERR9 MVC   ROUERRV,=AL2(AE$ALIOU)   ORDER UN APLIMIT REC MISSING            
         J     EXITN                                                            
*                                                                               
APPLERRA MVC   ROUERRV,=AL2(AE$ALIOA)   ORDER AP APLIMIT REC MISSING            
         J     EXITN                                                            
*                                                                               
APPLERRB MVC   ROUERRV,=AL2(AE$ORVES)   ORDER AMOUNT OVER ESTIMATE              
         J     EXITN                                                            
*                                                                               
APPLERRC MVC   ROUERRV,=AL2(AE$ARESI)   ESTIMATES INTERNAL MISSING              
         J     EXITN                                                            
         DROP  R2,T                                                             
*                                                                               
* APPROVER TYPES                                                                
*                                                                               
CLIENTQ  EQU   C'C'                CLIENT LEVEL APPROVER                        
DEPTQ    EQU   C'D'                DEPARTMENT LEVEL APPROVER                    
EXPTYPQ  EQU   C'E'                EXPENDITURE TYPE APPROVER                    
AGENCYQ  EQU   C'P'                AGENCY LEVEL APPROVER                        
PURCHSQ  EQU   C'F'                PURCHASING APPROVER                          
FINANCQ  EQU   C'I'                FINANCE APPROVER                             
SUPPLRQ  EQU   C'S'                SUPPLIER APPROVER                            
* L'TEMP APLIMIT TABLE ENTRY                                                    
APTABNTQ EQU   L'APLSTAT+L'APLVAL+L'APLNUM+L'APLPREV                            
***********************************************************************         
* Initialise approver buffer (uses WSSVR buffer)                      *         
***********************************************************************         
*                                                                               
INIBUFA  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*INIBUF*'                                                      
                                                                                
         XC    TSARABUF(TSPNEWL),TSARABUF  CLEAR BUFFER AREA                    
T        USING TSARD,TSARABUF                                                   
         MVI   T.TSACTN,TSAINI     SET ACTION TO 'INITIALISE'                   
         MVI   T.TSRECI,TSRXTN+TSRWSSVR                                         
         MVI   T.TSKEYL,APEKEYL                                                 
         LHI   R0,2*ONEK                                                        
         OC    T.TSBUFFL,T.TSBUFFL NUMBER OF KBYTES TO ACQUIRE ?                
         JNZ   *+8                 NOT ZERO , CONTINUE                          
         STCM  R0,3,T.TSBUFFL      STORE THE VALUE                              
*                                                                               
         LHI   R0,APETABL          APPROVER TABLE LENGTH                        
         STCM  R0,3,T.TSRECL       SAVE THE LENGTH                              
         MVC   T.TSACOM,ACOMFACS   SAVE COMMON FACILITY ADDRESS                 
         GOTOR VTSAR,T.TSARD                                                    
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  T                                                                
         EJECT                                                                  
***********************************************************************         
* ADD A RECORD TO APPROVER BUFFER/LOCAL SUPPLIER BUFFER               *         
*                                                                     *         
* NTRY:- R1 POINTS TO CALLER'S APETABD/SUPPLIER RECORD                *         
***********************************************************************         
                                                                                
ADDBUFA  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDBUF*'                                                      
                                                                                
T        USING TSARD,TSARABUF                                                   
         MVI   T.TSACTN,TSAADD     SET ACTION TO 'ADD'                          
         ST    R1,T.TSAREC         SAVE RECORD ADDRESS                          
         GOTOR VTSAR,T.TSARD       ADD RECORD TO TSAR                           
         JE    ADDBUFX             SUCCESSFUL, CONTINUE                         
*                                                                               
         TM    T.TSERRS,TSEDUP     DUSPLICATE ENTRY                             
         JNZ   ADDBUFX             CONTINUE                                     
         DC    H'0'                OTHER ERROR , ABEND                          
ADDBUFX  J     EXIT                                                             
         DROP  T                                                                
         EJECT                                                                  
*                                                                               
***********************************************************************         
* CALL GETOLST TO GET THE LIST OF OLIST FOR GIVEN OFFICE CODE         *         
***********************************************************************         
*                                                                               
GETOLST  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GTOLST*'                                                      
*                                                                               
         USING OFLPASD,R2          MAP WITH OLIST PASSIVE RECORD                
         USING OLISTD,R3           MAP OLIST SAVE AREA DSECT                    
*                                                                               
         XC    SAVOLIST,SAVOLIST   CLEAR WORK AREA                              
         LA    R3,SAVOLIST         ADDRESS WORK AREA                            
*                                                                               
         LHI   R4,MAXOLSTQ-1       MAXIMUM OLIST ENTRIES ALLOWED 20             
         LA    R2,IOKEY            ADDRESS KEY WORK AREA                        
         XC    OFLPAS,OFLPAS       INIT KEY TO X'00'                            
         MVI   OFLPTYP,OFLPTYPQ    READ OFFICE LIST PASSIVE                     
         MVI   OFLPSUB,OFLPSUBQ    OFFICE LIST PASSIVE SUB TYPE                 
         MVC   OFLPCPY,CUXCPY      SAVE COMPANY CODE                            
         MVC   OFLPOFF,HALF1       GET OLIST FOR OFFICE CODE                    
         MVC   CSVKEY1(L'OFLPAS),OFLPAS   SAVE KEY DETAILS                      
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         JE    GETOLST4                                                         
         J     GETOLSTX                                                         
*                                                                               
GETOLST2 DS    0H                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO1'                               
         JNE   GETOLSTX                                                         
*                                                                               
GETOLST4 CLC   OFLPAS(OFLPOFL-OFLPASD),CSVKEY1                                  
         JNE   GETOLSTX                                                         
*                                                                               
         MVC   OLISTCDE,OFLPOFL    SAVE OFFICE LIST CODE                        
         OI    OL_INDS,OL_PRSNT    SET OLIST IS PRESENT FOR OFFICE              
         AHI   R3,OLSTDLNQ         POINT TO THE NEXT ENTRY                      
         JCT   R4,GETOLST2         PROCESS NEXT RECORD                          
         DC    H'00'               MORE OLIST ENTRIES,ABEND                     
*                                                                               
GETOLSTX J     EXITY                                                            
         DROP  R2,R3                                                            
*                                                                               
*                                                                               
***********************************************************************         
* SET SJ OFFICE CODE                                                  *         
***********************************************************************         
*                                                                               
SSJOFF   NTR1  LABEL=*                                                          
         J     *+12                                                             
         DC    C'*SSJOFF*'                                                      
*                                                                               
         MVC   XL#COFF,SPACES        CLEAR LIST OF OFFICE CDE WORK AREA         
         CLC   PRODUL,TEMP2          IS UNIT LEDGER SAME ?                      
         JNE   SSJOFFX               NO, EXIT                                   
*                                                                               
         USING ACTRECD,R2            MAP WITH ACCOUNT RECORD KEY                
         LA    R2,IOKEY              ADDRESS WORK AREA                          
         MVC   ACTKEY,SPACES         INIT KEY AREA TO SPACES                    
         MVC   ACTKCPY,CUXCPY        SAVE COMPANY CODE                          
         MVC   ACTKUNT(L'PRODUL),PRODUL  SAVE UNIT - LEDGER DETAILS             
*                                                                               
         LLC   RE,PCLILEN            LENGTH OF THE CLIENT                       
         SHI   RE,1                  -1 FOR MACHINE INSTR.                      
         BASR  RF,0                                                             
         MVC   ACTKACT(0),TEMP2+2    SAVE CLIENT CODE FROM INP                  
         EX    RE,0(RF)                                                         
*                                    READ ACCOUNT DIR FOR ULCLI                 
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JNE   SSJOFFX               EXIT IF NO RECORD FOUND                    
*                                    GET  MASTER RECORD FOR THE SAME            
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JNE   SSJOFFX                                                          
*                                                                               
         L     R2,AIO1               RECORD IS IN IO1                           
         LA    R3,ACTRFST-ACTRECD(R2) ADDRESS START OF THE ELEMENT ADDR         
         USING PPRELD,R3             ** PRODUCTION PROFILE ELEMENT **           
*                                                                               
SSJOFF1  CLI   PPREL,0               MORE ELEMENT FOR PROCESS ?                 
         JE    SSJOFF3               YES, EXIT                                  
*                                    NO,                                        
         CLI   PPREL,PPRELQ          PRODUCTION PROFILE ELEMENT ?               
         JE    SSJOFF2               YES                                        
*                                                                               
         LLC   R0,PPRLN              LENGTH OF THE ELEMENT                      
         AR    R3,R0                 POINT THE NEXT ELEMENT                     
         J     SSJOFF1               LOOP FOR THE NEXT ELEMENT                  
*                                                                               
SSJOFF2  MVC   XL#COFF,PPRGAOFF      SAVE OFFICE CODE                           
         OC    XL#COFF,SPACES        MAKE OFFICE CODE CAPS                      
*                                                                               
SSJOFF3  LA    R2,IOKEY              ADDRESS WORK AREA                          
         LLC   RE,PPROLEN            LENGTH OF THE PROCDUCT CODE                
         SHI   RE,1                  -1 FOR MACHINE INSTR.                      
         BASR  RF,0                                                             
         MVC   ACTKACT(0),TEMP2+2    SAVE CLI+PROD DETAILS INPUT                
         EX    RE,0(RF)                                                         
*                                    READ ACCOUNT DIR FOR THE KEY               
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JNE   SSJOFFX               EXIT IF NOT FOUND                          
*                                    GET MASTER RECORD                          
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JNE   SSJOFFX               EXIT IF NOT FOUND                          
*                                                                               
         L     R2,AIO1               ADDRESS RECORD                             
         LA    R3,ACTRFST-ACTRECD(R2) POINT TO THE ELEMENT AREA                 
*                                                                               
SSJOFF4  CLI   PPREL,0               MORE ELEMENT FOR PROCESS ?                 
         JE    SSJOFF6               NO , EXIT                                  
*                                    YES,                                       
         CLI   PPREL,PPRELQ          PRODUCTION PROFILE ELEMENT ?               
         JE    SSJOFF5               YES                                        
*                                                                               
         LLC   R0,PPRLN              LENGTH OF THE ELEMENT                      
         AR    R3,R0                 POINT THE NEXT ELEMENT                     
         J     SSJOFF4               LOOP FOR THE NEXT ELEMENT                  
*                                                                               
SSJOFF5  CLC   PPRGAOFF,SPACES       OFFICE CODE PRESENT ?                      
         JNH   SSJOFF6               NO, CONTINUE                               
*                                    YES                                        
         MVC   XL#COFF,PPRGAOFF      SAVE OFFICE CODE                           
         OC    XL#COFF,SPACES        MAKE IT CAPITAL                            
*                                                                               
SSJOFF6  LA    R2,IOKEY              ADDRESS KEY                                
         MVC   ACTKACT,TEMP2+2       SAVE KEY AS UL/CLI/PROD/JOB                
*                                    READ ACCOUNT DIR FOR KEY                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JNE   SSJOFFX               NOT FOUND , EXIT                           
*                                    GET MASTER RECORD                          
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JNE   SSJOFFX               NOT FOUND EXIT                             
*                                                                               
         L     R2,AIO1               ADDRESS RECORD                             
         LA    R3,ACTRFST-ACTRECD(R2) POINT TO THE ELEMENT AREA                 
*                                                                               
SSJOFF7  CLI   PPREL,0               MORE ELEMENT FOR PROCESS ?                 
         JE    SSJOFFX               NO , EXIT                                  
*                                    YES,                                       
         CLI   PPREL,PPRELQ          PRODUCTION PROFILE ELEMENT ?               
         JE    SSJOFF8               YES                                        
*                                                                               
         LLC   R0,PPRLN              LENGTH OF THE ELEMENT                      
         AR    R3,R0                 POINT THE NEXT ELEMENT                     
         J     SSJOFF7               LOOP FOR THE NEXT ELEMENT                  
*                                                                               
SSJOFF8  CLC   PPRGAOFF,SPACES       OFFICE CODE PRESENT ?                      
         JNH   SSJOFFX               NO, CONTINUE                               
*                                    MAKE IT CAPITAL                            
         MVC   XL#COFF,PPRGAOFF      YES                                        
         OC    XL#COFF,SPACES        SAVE OFFICE CODE                           
*                                    MAKE IT CAPITAL                            
SSJOFFX  J     EXIT                                                             
         DROP  R2,R3                                                            
*                                                                               
***********************************************************************         
* Build job key from client, product and job codes                    *         
*                                                                     *         
* NTRY:- P1=A(AREA TO BUILD KEY INTO)  -   R2                         *         
*        P2=A(CLIENT CODE)             -   R3                         *         
*        P3=A(PRODUCT CODE)            -   R4                         *         
*        P4=A(JOB CODE)                -   R5                         *         
***********************************************************************         
*                                                                               
BLDJOB   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*BLDJOB*'                                                      
*                                                                               
         LM    R2,R5,0(R1)         SAVE PARM ADDRESS                            
         USING ACTKULA,R2          MAP WITH ACCOUNT CODE STRUCTURE              
         MVC   ACTKULA(L'PRODUL),PRODUL   SAVE UNIT LEDGER DETAILS              
         LLC   RF,PCLILEN          CLIENT LENGTH                                
         SHI   RF,1                -1 FOR MACHINE INSTR.                        
         BASR  RE,0                SAVE THE INPUT CLIENT CODE DETAILS           
         MVC   ACTKACT(0),0(R3)    - AT ACCOUNT CODE WRK AREA                   
         EX    RF,0(RE)            MOVE CLIENT CODE TO KEY                      
*                                                                               
         LA    R1,ACTKACT+1(RF)    POINT TO THE END OF THE CLI                  
         LLC   RE,PCLILEN          LENGTH OF THE CLIENT                         
         LLC   RF,PPROLEN          LENGTH OF THE PRODUCT CODE                   
         OC    0(L'RQ_APPRO,R4),0(R4) PRODUCT CODE INPUT ?                      
         JZ    BLDJOB02            NO, SKIP                                     
*                                  YES                                          
         SR    RF,RE               ACTUAL PRODUCT LENGTH                        
         SHI   RF,1                -1 FOR MACHINE INSTR.                        
         BASR  RE,0                                                             
         MVC   0(0,R1),0(R4)       MOVE PRODUCT CODE TO KEY                     
         EX    RF,0(RE)            - FROM THE INPUT                             
*                                                                               
         LA    R1,1(RF,R1)         POINT TO THE END OF PRODUCT                  
         LLC   RE,PPROLEN          LENGTH OF THE PRODUCT                        
         IC    RF,PJOBLEN          LENGTH OF THE JOB                            
         OC    0(L'RQ_APJOB,R5),0(R5)  JOB DETAILS INPUT ?                      
         JZ    BLDJOB02            NO, SKIP                                     
*                                  YES,                                         
         SR    RF,RE               ACTUAL LENGTH OF THE JOB                     
         CHI   RF,L'GOSELJOB       JOB CAN'T JE LONGER THAN GOSELJOB            
         JNH   *+8                 NO, CONTINUE                                 
         LHI   RF,L'GOSELJOB       YES, SET DEFULT VALUE                        
*                                                                               
         SHI   RF,1                -1 FOR THE MACHINE INSTR.                    
         BASR  RE,0                                                             
         MVC   0(0,R1),0(R5)       MOVE JOB CODE TO KEY                         
         EX    RF,0(RE)                                                         
*                                                                               
BLDJOB02 OC    ACTKACT,SPACES      (ENSURE SPACE FILLED KEY)                    
         J     EXITY                                                            
         DROP  R2                                                               
         EJECT                                                                  
*                                                                               
***********************************************************************         
* GET PERSON DETAILS (USE TS#PBLK)                                    *         
***********************************************************************         
*                                                                               
PERDTL   NTR1  LABEL=*                                                          
         J     *+12                                                             
         DC    CL8'*PERDTL*'                                                    
         XC    ALOCEL,ALOCEL       CLEAR                                        
*                                  READ FOR PERSON RECORD                       
         USING PERRECD,R2          MAP WITH ** PERSON RECORD  **                
         LA    R2,IOKEY            ADDRESS KEY WORK AREA                        
         MVC   PERKEY,SPACES       INIT KEY WITH SPACES                         
         MVI   PERKTYP,PERKTYPQ    READ FOR THE KEY X'0F'                       
         MVC   PERKCPY,CUXCPY      SAVE COMPANY CODE                            
         MVC   PERKCODE,TEMP2      SAVE PERSON CODE                             
*                                  READ ACDIR FOR THE KEY                       
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    PERDTL10            FOUND, CONTINUE                              
*                                  NOT FOUND                                    
         MVC   FULL2(2),=AL2(AE$IVPER)  ERROR : INVALID PERSON CODE             
         J     EXITN               EXIT                                         
*                                  GET MASTER RECORD                            
PERDTL10 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    *+6                 FOUND , CONTINUE                             
         DC    H'0'                FATAL ERROR, ABEND                           
*                                                                               
         L     R2,AIO1             ADDRESS RECORD                               
         LA    R3,PERRFST          LOCATE ELEMENTS AREA                         
         USING EMPELD,R3           MAP ELEMENT STRUCTURE                        
*                                                                               
PERDTL20 CLI   EMPEL,0             MORE ELEMENT FOR PROCESS ?                   
         JE    PERDTL80            NO, EXIT                                     
*                                                                               
         CLI   EMPEL,LOCELQ        STAFF LOCATION ELEMENT ?                     
         JE    PERDTL60            YES, PROCESS IT                              
*                                  NO                                           
         CLI   EMPEL,PIDELQ        PERSON ID ELEMENT ?                          
         JE    PERDTL70            YES, PROCESS IT                              
*                                  NO                                           
         CLI   EMPEL,EMPELQ        EMPLOYEE HISTORY ELEMENT ?                   
         JE    PERDTL72            YES, PROCESS IT                              
*                                  NO                                           
PERDTL30 LLC   R0,EMPLN            LENGTH OF THE ELEMENT                        
         AR    R3,R0               POINT NEXT ELEMENT                           
         J     PERDTL20            VALIDATE NEXT ELEMENT                        
*                                                                               
         USING LOCELD,R3                                                        
         USING OFFALD,R1           DSECT TO COVER OFF.ACS LIMIT BLOCK           
PERDTL60 CLI   CUACCS,0            LIMIT ACCESS?                                
         JE    PERDTL62            YES, EXIT                                    
*                                  NO                                           
         L     R1,AOFFAREA         ADDRESS OFFICE ACCESS LIMIT BLOCK            
         MVC   OFFAOFFC,LOCOFF     SAVE CURRENT PERSON OFFICE CODE              
         MVI   OFFAACT,OFFAVAL     SET VALIDATE INPUT OFFICE                    
*                                                                               
         GOTO1 VOFFAL                                                           
         JNE   PERDTL30            NOT VALID, PROCESS NEXT ELEMENT              
         DROP  R1                                                               
*                                                                               
PERDTL62 ST    R3,ACLOCL          STR  MOST RECENT LOCTN ELEMENT ADRS           
         CLC   XL#TODP,LOCSTART   FIND LOCATION FOR CURRENT DATE                
         JL    PERDTL30                                                         
*                                                                               
         OC    LOCEND,LOCEND                                                    
         JZ    PERDTL65                                                         
*                                                                               
         CLC   XL#TODP,LOCEND                                                   
         JH    PERDTL30                                                         
*                                                                               
PERDTL65 ST    R3,ALOCEL                                                        
         J     PERDTL30                                                         
*                                                                               
         USING PIDELD,R3                                                        
PERDTL70 MVC   X#PPIN,PIDNO       EXTRACT PID                                   
         J     PERDTL30                                                         
*                                                                               
         USING EMPELD,R3                                                        
PERDTL72 CLI   XL#APPL,RQ_ADEST    FOR ESTIMATES CHECK ACTIVE PERSON            
         JNE   PERDTL30                                                         
*                                                                               
         CLI   EMPCSTAT,0          ACTIVE PERSON                                
         JE    PERDTL30            YES - ALWAYS ALLOW                           
*                                                                               
         CLI   EMPCSTAT,EMPCTRM                                                 
         JNE   PERDTL74                                                         
*                                                                               
         MVC   FULL2(2),=AL2(AE$PRSNT)                                          
         J     EXITN                                                            
*                                                                               
PERDTL74 CLI   EMPCSTAT,EMPCLOA                                                 
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   FULL2(2),=AL2(AE$PRSLA)                                          
         J     EXITN                                                            
         DROP  R3                                                               
*                                                                               
PERDTL80 OC    ALOCEL,ALOCEL      ENSURE THIS IS SET                            
         JNZ   PERDTL85                                                         
*                                                                               
         OC    ACLOCL,ACLOCL      IF CAN'T FIND LOCATION FOR CURRENT            
         JZ    PERDTL82           DATE USE MOST RECENT LOCATION                 
*                                                                               
         MVC   ALOCEL,ACLOCL                                                    
         J     PERDTL85                                                         
*                                                                               
PERDTL82 MVC   FULL2(2),=AL2(AE$IVLDT)                                          
         J     EXITN                                                            
*                                                                               
PERDTL85 OC    X#PPIN,X#PPIN                                                    
         JNZ   PERDTL90                                                         
*                                                                               
         MVC   FULL2(2),=AL2(AE$NCPID)                                          
         J     EXITN                                                            
*                                                                               
PERDTL90 J     EXITY                                                            
*                                                                               
         DROP  R2                                                               
         EJECT                                                                  
*                                                                               
***********************************************************************         
* Work Code list/display download                                     *         
***********************************************************************         
*                                                                               
REQWCOL  LKREQ H,A#WCOL,OUTWCOL,NEXTREQ=REQTEAP                                 
*                                                                               
Start    LKREQ F,01,(D,B#SAVED,QWCSTRT),CHAR,OLEN=L'QWCSTRT,           +        
               MAXLEN=L'QWCSTRT,TEXT=AC#START,COL=*                             
                                                                                
End      LKREQ F,02,(D,B#SAVED,QWCEND),CHAR,OLEN=L'QWCEND,             +        
               MAXLEN=L'QWCEND,TEXT=AC#END,COL=*                                
                                                                                
Group    LKREQ F,03,(D,B#SAVED,QWCGRP),CHAR,OLEN=L'QWCGRP,             +        
               MAXLEN=L'QWCGRP,TEXT=(*,WCGRPLIT),COL=*                          
                                                                                
Stat     LKREQ F,04,(D,B#SAVED,QWCSTAT),CHAR,OLEN=L'QWCSTAT,           +        
               MAXLEN=L'QWCSTAT,TEXT=AC#STT,COL=*                               
                                                                                
Type     LKREQ F,05,(D,B#SAVED,QWCTYPE),CHAR,OLEN=L'QWCTYPE,           +        
               MAXLEN=L'QWCTYPE,TEXT=(*,APPLLIT),COL=*                          
                                                                                
OffCd    LKREQ F,06,(D,B#SAVED,QWCOFFC),CHAR,OLEN=L'QWCOFFC,           +        
               MAXLEN=L'QWCOFFC,TEXT=AC#OFFC,COL=*                              
                                                                                
FrnReq   LKREQ F,07,(D,B#SAVED,QWCFDE),CHAR,OLEN=L'QWCFDE,             +        
               MAXLEN=L'QWCFDE,TEXT=(*,FRNRQLIT),COL=*                          
                                                                                
LimLst   LKREQ F,08,(D,B#SAVED,QWCLIML),CHAR,OLEN=L'QWCLIML,           +        
               MAXLEN=L'QWCLIML,TEXT=AC#LIMLS,COL=*                             
                                                                                
NoVal    LKREQ F,09,(D,B#SAVED,QWCLNOV),CHAR,OLEN=L'QWCLNOV,           +        
               MAXLEN=L'QWCLNOV,TEXT=(*,SKPVLIT),COL=*                          
                                                                                
SJAcc    LKREQ F,10,(D,B#SAVED,QWCLSJA),CHAR,OLEN=L'QWCLSJA,           +        
               MAXLEN=L'QWCLSJA,TEXT=(*,SJACLIT),COL=*                          
                                                                                
Media    LKREQ F,11,(D,B#SAVED,QWCLMED),CHAR,OLEN=L'QWCLMED,           +        
               MAXLEN=L'QWCLMED,TEXT=AC#MEDC,COL=*                              
                                                                                
OrdTy    LKREQ F,12,(D,B#SAVED,QWCLOTY),CHAR,OLEN=L'QWCLOTY,           +        
               MAXLEN=L'QWCLOTY,TEXT=AC#ORDTY,COL=*                             
                                                                                
         LKREQ E                                                                
                                                                                
OUTWCOL  LKOUT H                                                                
                                                                                
WRKCOD   LKOUT R,A#WCOL                WorkCode record                          
PRout    LKOUT P,,WCOLST                                                        
Array    LKOUT C,A#WCOL,(A,ARYWCOL)                                             
         LKOUT E                                                                
                                                                                
         LKOUT X                                                                
                                                                                
ARYWCOL  LKOUT A,(R,WCONXT),MULTIROW=Y,ROWNAME=WCORECD                          
WCode    LKOUT C,01,WCOKWRK,CHAR                                                
Array    LKOUT C,255,(A,ARYWCE)                                                 
Array    LKOUT C,255,(A,ARYEST),FILTROUT=TSTEST                                 
*&&UK                                                                           
Array    LKOUT C,255,(A,ARYFDE),FILTROUT=TSTWCFDS                               
*&&                                                                             
Array    LKOUT C,255,(A,ARYOET),FILTROUT=TSTOET                                 
Array    LKOUT C,27,(A,ARYWXNM)                                                 
Dftwc    LKOUT C,28,WCOKWRK,(R,EDTDFT),CHAR,ND=Y                                
         LKOUT E                                                                
                                                                                
ARYWCE   LKOUT A,(D,B#WCREC,WCORFST),EOT=EOR,ROWID=(WCOELD,WCOELQ),    +        
               ROWWIDTH=(V,WCOLN)                                               
WCDsc    LKOUT C,02,WCODESC,CHAR                                                
WCGrp    LKOUT C,03,WCOGRP,CHAR,ND=Y                                            
WCStA    LKOUT C,04,WCOSTAT,(R,EDTINEX)                                         
WCArt    LKOUT C,05,WCOSTAT2,(R,EDTART)                                         
*&&UK                                                                           
WCEXP    LKOUT C,22,WCOSTAT,(R,EDTEXST),ND=Y                                    
WCTHR    LKOUT C,23,WCOSTAT3,(R,EDTTHRU),ND=Y                                   
EstChk   LKOUT C,24,WCOSTAT3,(R,EDTESTC),ND=Y                                   
*&&                                                                             
         LKOUT E                                                                
                                                                                
ARYEST   LKOUT A,(R,COMVAT),ROWNAME=SAVED                                       
WCCom    LKOUT C,06,XL#COMM,SPAK,ND=Y,LEN=L'XL#COMM,PZERO=S                     
*&&UK                                                                           
WCVRa    LKOUT C,07,XL#VATR,CHAR,ND=Y,LEN=L'XL#VATR                             
WCVCo    LKOUT C,08,XL#VATC,CHAR,ND=Y,LEN=L'XL#VATC                             
WCVNa    LKOUT C,09,XL#VATN,CHAR,ND=Y,LEN=L'XL#VATN                             
*&&                                                                             
                                                                                
         LKOUT E                                                                
                                                                                
ARYFDE   LKOUT A,(D,B#WCREC,WCORFST),EOT=EOR,                          +        
               ROWID=(XNMEL,XNMELQ),ROWWIDTH=(V,XNMLN)                          
WCFdes   LKOUT C,10,XNMSUBN,CHAR,LEN=V,ND=Y                                     
                                                                                
         LKOUT E                                                                
                                                                                
ARYOET   LKOUT A,(D,B#GOBLK,GOBLOCKD),NROWS=1,ROWWIDTH=0                        
PRout    LKOUT P,,GETWCT                                                        
                                                                                
WCFPt    LKOUT C,11,(D,B#GOXBLK,GOFPT),CHAR,ND=Y                                
WCFJt    LKOUT C,12,(D,B#GOXBLK,GOFJT),CHAR,ND=Y                                
*&&UK                                                                           
WCFPt    LKOUT C,13,GOTTALLW,(R,EDTBILA),CHAR                                   
WCFJt    LKOUT C,14,GOTTALLW,(R,EDTCHRA),CHAR                                   
WCFJt    LKOUT C,15,GOTTALLW,(R,EDTNBIL),CHAR                                   
*&&                                                                             
*&&US                                                                           
WCFPt    LKOUT C,13,(D,B#GOXBLK,GOTTALLW),(R,EDTBILA),CHAR                      
WCFJt    LKOUT C,14,(D,B#GOXBLK,GOTTALLW),(R,EDTCHRA),CHAR                      
WCFJt    LKOUT C,15,(D,B#GOXBLK,GOTTALLW),(R,EDTNBIL),CHAR                      
*&&                                                                             
WCDFt    LKOUT C,16,(D,B#GOXBLK,GOTOT),CHAR,ND=Y                                
*&&UK                                                                           
WCFNb    LKOUT C,17,GOTFNARR,(R,EDTBILA),CHAR,ND=Y                              
WCFNr    LKOUT C,18,GOTFNARR,(R,EDTCHRA),CHAR,ND=Y                              
WCFNn    LKOUT C,19,GOTFNARR,(R,EDTNBIL),CHAR,ND=Y                              
*&&                                                                             
*&&US                                                                           
WCFNb    LKOUT C,17,(D,B#GOXBLK,GOTFNARR),(R,EDTBILA),CHAR,ND=Y                 
WCFNr    LKOUT C,18,(D,B#GOXBLK,GOTFNARR),(R,EDTCHRA),CHAR,ND=Y                 
WCFNn    LKOUT C,19,(D,B#GOXBLK,GOTFNARR),(R,EDTNBIL),CHAR,ND=Y                 
*&&                                                                             
*&&US                                                                           
WCJob    LKOUT C,20,(D,B#GOXBLK,GOTNOJOB),CHAR,ND=Y                             
*&&                                                                             
WCInc    LKOUT C,21,(D,B#GOBBLK,GOINCAC+1),(R,EDTOINV),CHAR,ND=Y                
WCCcw    LKOUT C,25,(D,B#GOXBLK,GOCCW),CHAR,ND=Y                                
WCWcf    LKOUT C,26,(D,B#GOXBLK,GOWCF),CHAR,ND=Y                                
                                                                                
         LKOUT E                                                                
                                                                                
ARYWXNM  LKOUT A,(D,B#WCREC,WCORFST),EOT=EOR,                          +        
               ROWID=(NAMEL,NAMELQ),ROWWIDTH=(V,NAMLN)                          
WCXnm    LKOUT C,27,NAMEREC,CHAR,LEN=V                                          
                                                                                
         LKOUT E                                                                
*                                                                               
***********************************************************************         
* W/C LIST DOWNLOAD                                                   *         
***********************************************************************         
*                                                                               
WCOLST   NTR1  LABEL=*                                                          
*                                                                               
         ST    R8,LP_ADATA                                                      
         XC    ROUERRV,ROUERRV         Clear previous errors                    
         MVC   XL#APPL,QWCTYPE         SET APPLICATION                          
         MVI   XL#GOTWC,NOQ                                                     
         MVI   XL#GLIND,0                                                       
*                                                                               
         USING LW_D,R2                                                          
         XR    R2,R2                   Clear status WMP                         
         ICM   R2,B'0111',AWMPOST                                               
         JZ    WCOL02                                                           
         XC    LW_NUMN,LW_NUMN                                                  
         LA    R0,LW_DATA2                                                      
         LHI   R1,WMPOSTMQ*L'WCOKWRK                                            
         SR    RF,RF                                                            
         SR    RE,RE                                                            
         MVCL  R0,RE                                                            
         DROP  R2                                                               
*                                                                               
WCOL02   DS    0H                                                               
*&&UK                                                                           
         CLI   QWCTYPE,QWCEST             IS IT ESTIMATE TYPE?                  
         JNE   WCOL10                                                           
         MVC   XL#COFF,QWCOFFC                                                  
         OC    XL#COFF,SPACES                                                   
         XC    XL#VATC(XL#VATQ),XL#VATC                                         
*                                                                               
         XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,SGQ                                                       
         GOTOR (#SETLDG,ASETLDG)                                                
         JE    WCOL10                                                           
                                                                                
         MVC   ROUERRV,=AL2(AE$OPTNV)                                           
         J     EXITN                                                            
*                                                                               
WCOL10   MVC   XL#SGOP,LDGAOP                                                   
*&&                                                                             
*                                                                               
WCOL20   CLC   QWCEND,QWCSTRT                                                   
         JNE   WCOL25                                                           
         GOTOR VALDATWC                                                         
         JE    WCOL25                                                           
         MVC   ROUERRV,=AL2(AE$INWRK)  INVALID WORK CODE                        
         J     EXITN                                                            
*                                                                               
WCOL25   DS    0H                                                               
         GOTOR VALSJACT                                                         
         JE    WCOL30                                                           
         MVC   ROUERRV,=AL2(AE$ACTNF)  sj ACCT NOT FOUND.                       
         J     EXITN                                                            
*                                                                               
WCOL30   DS    0H                                                               
         GOTOR ACCRUL                                                           
         XR    R4,R4                                                            
         OC    CCTPID,CCTPID                                                    
         JZ    EXITY                                                            
         CLI   QWCTYPE,QWCWID          Timeline widget module                   
         JE    *+12                                                             
         CLI   QWCTYPE,QWCTIM          Limit list for Time module only          
         JNE   EXITY                                                            
*                                      Read cost person record to get           
         USING PIDRECD,R2              1R account                               
         LA    R2,IOKEY                                                         
         XC    IOKEY,IOKEY                                                      
         MVI   PIDKTYP,PIDKTYPQ                                                 
         MVI   PIDKSUB,PIDKSUBQ                                                 
         MVC   PIDKCPY,CUXCPY                                                   
         MVC   PIDKPID,CCTPID                                                   
         MVI   PIDKSTYP,PIDKPERQ                                                
         MVC   CSVKEY1,PIDKEY                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         CLC   IOKEY(PIDKPER-PIDRECD),CSVKEY1                                   
         JNE   WCOL35                  Cost person rec not found                
         MVC   TEMP2,PIDKPER                                                    
         GOTOR PERDTL                                                           
         JNE   WCOL35                                                           
*                                                                               
         L     R2,ALOCEL           ADDRESS LOCAL ELEMENT DETAILS                
         CLI   0(R2),LOCELQ        CHECK WE DO HAVE LOCATION ELEMENT            
         JNE   WCOL35               OTHERWISE SKIP                              
         LA    R3,X#1RACC          ADDRESS 1R ACCOUNT CODE WORK AREA            
         LLC   RF,ONERL1L          LENGTH OF THE FILED                          
         SHI   RF,1                -1  LENGTH FOR MACHINE INSTR.                
         BASR  R1,0                SAVE VERIABLE LENGTH OFFICE                  
         MVC   0(0,R3),LOCOFF-LOCELD(R2) -  SAVE OFFICE CODE FROM LOCEL         
         EX    RF,0(R1)                                                         
         AHI   RF,1                POINT END OF THE OFFICE CODE                 
         AR    R3,RF               POINT 1R ACCOUNT AFTER OFFICE CODE           
         LLC   RF,ONERL2L          TOTAL LGTH OF THE DEPT CODE FRM STRT         
         LLC   R0,ONERL1L          LENGTH OF THE OFFICE CODE                    
         SR    RF,R0               ACTUAL LENGTH OF THE DEPT CODE               
         SHI   RF,1                -1 FOR MACHINE INSTR.                        
         BASR  R1,0                                                             
         MVC   0(0,R3),LOCDEPT-LOCELD(R2)  SAVE DEPT DETAILS                    
         EX    RF,0(R1)                                                         
         AHI   RF,1               ADD 1 TO DEPT LENGTH                          
         AR    R3,RF              POINT TO THE END OF DEPT VALUE                
         LLC   RF,ONERL3L         TOTAL LGTH OF THE SUB-DEPT FRM STRT           
         LLC   R0,ONERL2L         LENGTH OF THE DEPT CODE                       
         SR    RF,R0              ACTUAL LENGTH OF THE SUB-DEPT CODE            
         SHI   RF,1               -1 FOR MACHINE INSTR.                         
         BASR  R1,0                                                             
         MVC   0(0,R3),LOCSUB-LOCELD(R2)  SAVE SUB-DEPARTMENT DETAILS           
         EX    RF,0(R1)                                                         
         AHI   RF,1               SUB-DEPT CODE LENGTH                          
         AR    R3,RF              POINT TO THE END OF SUB-DEPT CODE             
         MVC   0(L'PIDKPER,R3),TEMP2  SAVE CLAIMANT PERSON CODE                 
         OC    X#1RACC,SPACES                                                   
         GOTOR GETWCD                                                           
*                                                                               
WCOL35   CLI   QWCLIML,YESQ            override limit list                      
         JE    EXITY                   YES                                      
*                                                                               
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO7                                        
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO8                                        
         GOTOR GETLMT,'LIDTWCL'        Get work code limit list                 
         JE    WCOL40                                                           
*                                                                               
         CLI   X#LLTWC,X#LLNONQ                                                 
         JE    EXITY                                                            
*                                                                               
WCOL40   L     R4,AIO7                 List of work codes                       
         OC    0(L'WCOKWRK,R4),0(R4)                                            
         JZ    EXITY                                                            
*                                                                               
                                                                                
WCOL50   CLC   0(L'QWCSTRT,R4),QWCSTRT                                          
         JL    WCOL60                                                           
         CLC   0(L'QWCEND,R4),QWCEND                                            
         JH    WCOL60                                                           
         GOTOR LP_AAWMP,DMCB,(L'WCOKWRK,0(R4)),IWMPOST,WMPOSTMQ,LP_D            
         MVI   XL#GOTWC,YESQ                                                    
*                                                                               
WCOL60   LA    R4,L'WCOKWRK(,R4)                                                
         OC    0(L'WCOKWRK,R4),0(R4)                                            
         JNZ   WCOL50                  Get next record OTHERWISE GT ALL         
*                                                                               
         CLI   XL#GOTWC,YESQ           DOES WMP WORKCODE LIST EMPTY?            
         JE    EXITY                   NO -NO WC MATCHES PASSED WC LIST         
         MVC   ROUERRV,=AL2(AE$WCLIM)  WORKCODE NOT IN LIMIT LIST               
         J     EXITN                                                            
         EJECT                                                                  
         DROP  R2                                                               
*                                                                               
WCONXT   NTR1  LABEL=*                                                          
*                                                                               
         ST    R8,LP_ADATA                                                      
         OC    ROUERRV,ROUERRV                                                  
         JZ    WCONXT10                                                         
         MVC   LP_ERROR,ROUERRV                                                 
         J     XERROR                                                           
WCONXT10 OC    CCTPID,CCTPID                                                    
         JZ    WCONXT20                                                         
         CLI   QWCTYPE,QWCWID          Timeline widget module                   
         JE    *+12                                                             
         CLI   QWCTYPE,QWCTIM          Limit list for Time module only          
         JNE   WCONXT20                                                         
         CLI   QWCLIML,YESQ            override limit list                      
         JE    WCONXT20                Yes - get full list                      
         CLI   XL#GOTWC,YESQ           Do we have a limit list of wcs           
         JE    WCONXT30                Yes - then use WMP in nxtrec             
         CLI   X#LLTWC,X#LLNONQ        No - but do we have access to            
         JE    NOMORE                          any wc in this scenario          
                                                                                
WCONXT20 GOTOR (#NXTREC,ANXTREC),DMCB,WCOKEYT,('B#WCREC',0),           +        
               (0,SAVED),0,AWCOLRF                                              
         J     EXITY                                                            
*                                                                               
WCONXT30 GOTOR (#NXTREC,ANXTREC),DMCB,WCOKEYT2,('B#WCREC',0),          +        
               (0,SAVED),0,AWCOLRF                                              
         J     EXITY                                                            
         EJECT                                                                  
*                                                                               
TSTWCFDS DS    0H                                                               
         CLI   QWCFDE,YESQ             foreign description required?            
         BR    RE                                                               
*                                                                               
TSTEST   NTR1  LABEL=*                                                          
         CLI   QWCTYPE,QWCEST          APPLICATION TYPE = ESTIMATE ?            
         JNE   EXITN                                                            
         CLC   QWCSTRT,QWCEND          SINGLE WORK CODE?                        
         JNE   EXITN                                                            
         J     EXITY                                                            
*                                                                               
TSTOET   DS    0H                      TEST ORDER, ESTIMATE & TIMESHEET         
         CLI   QWCTYPE,QWCORD          APPLICATION TYPE = ODERED ?              
         BER   RE                                                               
         CLI   QWCTYPE,QWCEST          ESTIMATE ?                               
         BER   RE                                                               
         CLI   QWCTYPE,QWCWID          Timeline widget module                   
         BER   RE                                                               
         CLI   QWCTYPE,QWCTIM          TIMESHEET ?                              
         BR    RE                                                               
         EJECT                                                                  
*                                                                               
*** Record filter routine for work code record ***                              
*                                                                               
WCOLRF   NTR1  LABEL=*                                                          
         USING WCORECD,R1                                                       
         L     R1,AIO2                                                          
         USING WCOELD,R2                                                        
         LA    R2,WCORFST                                                       
         OC    WCOKWRK,WCOKWRK         IF NO WORKCODE SKIP                      
         JZ    EXITN                                                            
         CLC   WCOKWRK,QWCSTRT         is WC part of range?                     
         JL    EXITN                   no - exit                                
         CLC   WCOKWRK,QWCEND                                                   
         JH    EXITN                   no - exit                                
         CLI   CUCTRY,CTRYGER          Germany and Orders?                      
         JNE   WCOLRF20                                                         
         CLI   QWCTYPE,QWCORD          ORDER TYPE?                              
         JNE   WCOLRF20                                                         
         CLI   QWCLOTY,QWCEMPTY        is order type > spaces?                  
         JNH   WCOLRF20                yes - do validation                      
         CLI   QWCLOTY,QWCNTRNL        else check for internal orders           
         JNE   WCOLRF10                                                         
         CLI   WCOKWRK,QWCSKIP        skip xternals for internal orders         
         JNL   EXITN                                                            
         J     WCOLRF20                                                         
*                                                                               
WCOLRF10 CLI   WCOKWRK,QWCSKIP         skip internals for other orders          
         JL    EXITN                                                            
*                                                                               
WCOLRF20 DS    0H                                                               
         CLI   QWCLNOV,YESQ            Skip validation                          
         JE    EXITY                                                            
         LA    RE,WCOSLORD             Orders?                                  
         CLI   QWCTYPE,QWCORD                                                   
         JE    WCOLRF30                                                         
         LA    RE,WCOSLEST             Estimates?                               
         CLI   QWCTYPE,QWCEST                                                   
         JE    WCOLRF30                                                         
         LA    RE,WCOSLPST             Time?                                    
         CLI   QWCTYPE,QWCTIM                                                   
         JE    WCOLRF30                                                         
         LA    RE,WCOSLPST             Invoices?                                
         CLI   QWCTYPE,QWCINV                                                   
         JE    WCOLRF30                                                         
         LA    RE,WCOSLPST             Expenses?                                
         CLI   QWCTYPE,QWCEXP                                                   
         JE    WCOLRF30                                                         
         CLI   QWCTYPE,QWCWID          Timeline widget module                   
         JE    WCOLRF30                                                         
         DC    H'0'                    abend                                    
*                                                                               
WCOLRF30 BASR  RF,0                                                             
         TM    WCOSTAT2,0              Locked from ...?                         
         EX    RE,0(RF)                                                         
         JNZ   EXITN                                                            
*                                                                               
         CLI   QWCGRP,EMPTY            filters passed from application?         
         JNH   WCOLRF40                                                         
         CLC   QWCGRP,WCOGRP           is it matching with request?             
         JNE   EXITN                                                            
WCOLRF40 CLI   QWCSTAT,QWCSTALL        status = both (time/cost)?               
         JNH   EXITY                                                            
         CLI   QWCSTAT,QWCSTTIM        status = time?                           
         JNE   WCOLRF50                                                         
*&&UK*&& TM    WCOSTAT,WCOSHCOE        HOURS CARRIED IN ORIG. EST.              
*&&UK*&& JZ    EXITN                                                            
         J     EXITY                                                            
WCOLRF50 CLI   QWCSTAT,QWCSTCOS        status = cost?                           
         JNE   EXITY                                                            
*&&UK*&& TM    WCOSTAT,WCOSHCOE        HOURS CARRIED IN ORIG. EST.              
*&&UK*&& JNZ   EXITN                                                            
         J     EXITY                                                            
         DROP  R1,R2                                                            
         EJECT                                                                  
*                                                                               
***********************************************************************         
* VALIDATE WORKCODE                                                   *         
***********************************************************************         
*                                                                               
VALDATWC NTR1  LABEL=*                 VALIDATE WORKCODE                        
*                                                                               
         LA    R1,IOKEY                Yes - check it exits                     
         USING WCORECD,R1                                                       
         MVC   WCOKEY,SPACES                                                    
         MVI   WCOKTYP,WCOKTYPQ                                                 
         MVC   WCOKCPY,CUXCPY                                                   
         MVC   WCOKUNT(2),CPYPROD                                               
         MVC   WCOKWRK,QWCSTRT                                                  
         MVC   CSVKEY1(WCOKWRK-WCORECD),WCOKEY                                  
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         J     EXIT                                                             
         DROP  R1                                                               
         EJECT                                                                  
*                                                                               
***********************************************************************         
* VALIDATE provided sj acct.                                          *         
***********************************************************************         
*                                                                               
VALSJACT NTR1  LABEL=*                 VALIDATE WORKCODE                        
*                                                                               
         CLC   QWCLSJA,SPACES          SJ account passed?                       
         JNH   EXITY                                                            
         LA    R1,IOKEY                Yes - check it exits                     
         USING ACTRECD,R1                                                       
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(L'PRODUL),PRODUL                                         
         MVC   ACTKACT,QWCLSJA                                                  
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         J     EXIT                                                             
         DROP  R1                                                               
         EJECT                                                                  
*                                                                               
***********************************************************************         
* GET AND PROCESS WORK CODE TABLE ENTRY                               *         
***********************************************************************         
*                                                                               
GETWCT   NTR1  LABEL=*                                                          
*                                                                               
         USING WCORECD,R2                                                       
         L     R2,AIO2                                                          
         ST    R8,LP_ADATA                                                      
*                                                                               
         USING GOBLOCKD,R3                                                      
         L     R3,AGOBLOCB                                                      
         MVC   SJACLIC,SPACES                                                   
         MVC   SJAPROC,SPACES                                                   
         MVC   SJAJOBC,SPACES                                                   
         CLC   QWCLSJA,SPACES          SJ account passed?                       
         JNH   GETWCT05                                                         
*                                                                               
         LLC   RE,PCLILEN                                                       
         BCTR  RE,0                                                             
         BASR  R1,0                                                             
         MVC   SJACLIC(0),QWCLSJA                                               
         EX    RE,0(R1)                                                         
         LA    RE,QWCLSJA+1(RE)                                                 
         LLC   R1,PCLILEN                                                       
         LLC   RF,PPROLEN                                                       
         SR    RF,R1                                                            
         BCTR  RF,0                                                             
         BASR  R1,0                                                             
         MVC   SJAPROC(0),0(RE)                                                 
         EX    RF,0(R1)                                                         
         AR    RE,RF                                                            
         AHI   RE,1                                                             
         LLC   RF,PPROLEN                                                       
         LLC   R1,PJOBLEN                                                       
         SR    R1,RF                                                            
         BCTR  R1,0                                                             
         BASR  RF,0                                                             
         MVC   SJAJOBC(0),0(RE)                                                 
         EX    R1,0(RF)                                                         
*                                                                               
GETWCT05 XC    GOADM(GOABUFF-GOADM),GOADM                                       
         XC    GOADETS(GOACOVL-GOADETS),GOADETS                                 
                                                                                
         MVC   GOADM,VDATAMGR                                                   
         MVC   GOAEXT,AGOXBLCK         US USES 1ST EXTENSION BLOCK              
         MVC   GOABEXT,AGOBBLCK        UK USES 2ND EXTENSION BLOCK              
         MVC   GOSELCUL(L'CUXCPY),CUXCPY                                        
         MVC   GOSELCUL+1(L'PRODUL),PRODUL                                      
         CLC   SJACLIC,SPACES                                                   
         JNH   GETWCT10                                                         
         MVC   GOSELCLI(L'SJACLIC),SJACLIC                                      
         OC    GOSELCLI,SPACES                                                  
GETWCT10 CLC   SJAPROC,SPACES                                                   
         JNH   GETWCT20                                                         
         MVC   GOSELPRO(L'SJAPROC),SJAPROC                                      
         OC    GOSELPRO,SPACES                                                  
GETWCT20 CLC   SJAJOBC,SPACES                                                   
         JNH   GETWCT30                                                         
         MVC   GOSELJOB,SJAJOBC                                                 
         OC    GOSELJOB,SPACES                                                  
*                                                                               
GETWCT30 MVC   GOSELWC,WCOKWRK                                                  
         MVI   GOANYWC,YESQ                                                     
         MVC   GOCTRY,CUCTRY                                                    
         L     RF,ACOMFACS                                                      
                                                                                
         XC    GOACOVL,GOACOVL                                                  
         TM    LP_FLAG,LP_FOFFL        TEST OFFLINE                             
         JZ    *+10                                                             
         MVC   GOACOVL,VCOVAIL                                                  
         MVC   GOABINSR,CBINSRCH-COMFACSD(RF)                                   
                                                                                
         GOTO1 VGETOPT,DMCB,GOBLOCKD                                            
*                                                                               
         J     EXITY                                                            
         DROP  R2,R3                                                            
         EJECT                                                                  
                                                                                
* get commission and VAT for workcode                                           
COMVAT   NTR1  LABEL=*                                                          
         ST    R8,LP_ADATA                                                      
         MVC   CSVKEY4,IOKEY           save to reestablsih sequence             
*                                                                               
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO3                                        
*                                                                               
         MVC   SJACLIC,SPACES                                                   
         MVC   SJAPROC,SPACES                                                   
         MVC   SJAJOBC,SPACES                                                   
         CLC   QWCLSJA,SPACES          SJ account passed?                       
         JNH   COMVAT10                                                         
         LLC   RE,PCLILEN                                                       
         BCTR  RE,0                                                             
         BASR  R1,0                                                             
         MVC   SJACLIC(0),QWCLSJA                                               
         EX    RE,0(R1)                                                         
         LA    RE,QWCLSJA+1(RE)                                                 
         LLC   R1,PCLILEN                                                       
         LLC   RF,PPROLEN                                                       
         SR    RF,R1                                                            
         BCTR  RF,0                                                             
         BASR  R1,0                                                             
         MVC   SJAPROC(0),0(RE)                                                 
         EX    RF,0(R1)                                                         
         AR    RE,RF                                                            
         AHI   RE,1                                                             
         LLC   RF,PPROLEN                                                       
         LLC   R1,PJOBLEN                                                       
         SR    R1,RF                                                            
         BCTR  R1,0                                                             
         BASR  RF,0                                                             
         MVC   SJAJOBC(0),0(RE)                                                 
         EX    R1,0(RF)                                                         
*                                                                               
         USING WCORECD,R1                                                       
         USING GOBLOCKD,R2                                                      
COMVAT10 L     R2,AIO3                                                          
         L     R1,AIO2                                                          
                                                                                
         XC    GOADM(GOABUFF-GOADM),GOADM                                       
         XC    GOADETS(GOACOVL-GOADETS),GOADETS                                 
                                                                                
         MVC   GOADM,VDATAMGR                                                   
         MVC   GOAEXT,AGOXBLCK         US USES 1ST EXTENSION BLOCK              
         MVC   GOABEXT,AGOBBLCK                                                 
         MVC   GOSELCUL(L'CUXCPY),CUXCPY                                        
         MVC   GOSELCUL+1(L'PRODUL),PRODUL                                      
         MVC   GOSELCLI,SPACES                                                  
         MVC   GOSELCLI(L'SJACLIC),SJACLIC                                      
         MVC   GOSELPRO,SPACES                                                  
         MVC   GOSELPRO(L'SJAPROC),SJAPROC                                      
         MVC   GOSELJOB,SJAJOBC                                                 
         CLI   QWCLMED,QWCALLMD                                                 
         JNH   COMVAT20                                                         
         CLC   SJAJOBC,SPACES                                                   
         JH    COMVAT20                                                         
         MVC   GOSELMED,QWCLMED                                                 
*                                                                               
COMVAT20 MVC   GOSELWC,WCOKWRK                                                  
         MVI   GOANYWC,YESQ                                                     
         MVC   GOCTRY,CUCTRY                                                    
                                                                                
         GOTO1 VGETOPT,DMCB,GOBLOCKD                                            
         XC    TEMP2,TEMP2                                                      
*&&US                                                                           
         ZAP   DUB2,GOAGYCOM                                                    
         ZAP   XL#COMM,DUB2                                                     
         J     COMVAT40                                                         
*&&                                                                             
*&&UK                                                                           
         ZAP   XL#COMM,GOAGYCOM                                                 
*                                                                               
         CLI   CUCTRY,CTRYGER      internal we/c and Germany?                   
         JNE   COMVAT30                                                         
         CLI   GOSELWC,OWCSUPRS    C'Z' ?                                       
         JH    COMVAT30                                                         
         OC    GOPROVPC,GOPROVPC   if internal comm rate override               
         JZ    COMVAT30            regular comm rate with it                    
         ZAP   XL#COMM,GOPROVPC                                                 
*                                                                               
COMVAT30 MVC   TEMP2+4(L'GOTAXCOD),GOTAXCOD                                     
*                                                                               
         CLC   XL#VATC,TEMP2+4         same as previous?                        
         JE    COMVAT40                                                         
*                                                                               
         USING VTCD,R2                                                          
         L     R2,AIO3                 build VATICAN call block                 
         XC    VTCD(VTCLNQ),VTCD                                                
         MVI   VTCACTN,VTCALOOK                                                 
         MVC   VTCCPY,CUXCPY                                                    
         MVC   VTCOFFC,XL#COFF                                                  
         MVC   VTCCOMF,ACOMFACS                                                 
         MVC   VTCINVD,XL#TODP                                                  
         MVC   VTCTYPE,TEMP2+4                                                  
         MVC   VTCCPYS1,CPYSTAT1                                                
         MVC   VTCSGOPO,XL#SGOP                                                 
         GOTO1 VATICAN,VTCD                                                     
         JNE   COMVAT40                                                         
         MVC   TEMP2+5(L'XL#VATN),SPACES                                        
         MVC   TEMP2+5(L'VTCTTYPE),VTCTTYPE                                     
         CURED (B2,VTCRATE),(L'XL#VATR,TEMP2),0,ZERO=YES,ALIGN=LEFT             
         MVC   XL#VATC,TEMP2+4                                                  
         MVC   XL#VATR,TEMP2                                                    
         MVC   XL#VATN,TEMP2+5                                                  
*&&                                                                             
*                                                                               
COMVAT40 MVC   IOKEY,CSVKEY4           reestablish sequence                     
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
*                                                                               
         J     EXIT                                                             
         DROP  R2                                                               
         EJECT                                                                  
                                                                                
***********************************************************************         
                                                                                
ACCRUL   NTR1  LABEL=*                                                          
*                                                                               
         MVI   X#LLTABS,X#LLALLQ       Default to unlimited access              
         MVC   X#LLTABS+1(X#LLTLQ-1),X#LLTABS                                   
                                                                                
         XR    R3,R3                   INITIALIZING R3 AS LOOP COUNTER          
         LA    RF,SCPXEL                                                        
         GOTOR SETLAV                  Set Lmt to company access values         
         GOTOR CHKLAV                                                           
         JE    ACCRULX                 All values now set                       
                                                                                
         CLI   CUACCS,DOLLAR           List access single character             
         JE    ACCRUL70                Yes - don't read for offices             
         USING OFLPASD,R2                                                       
         LA    R2,IOKEY                                                         
         XC    OFLPAS,OFLPAS                                                    
         MVI   OFLPTYP,OFLPTYPQ                                                 
         MVI   OFLPSUB,OFLPSUBQ                                                 
         MVC   OFLPREM,CUXCPY                                                   
         MVC   OFLPOFF,CUACCS+1                                                 
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    *+10                                                             
         MVC   OFLPOFF,CUACCS+2                                                 
         MVC   CSVKEY1,OFLPAS                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         JE    ACCRUL20                                                         
         J     ACCRUL70                                                         
                                                                                
ACCRUL10 DS    0H                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
         JNE   ACCRUL70                                                         
*                                                                               
ACCRUL20 CLC   OFLPAS(OFLPOFL-OFLPASD),CSVKEY1                                  
         JNE   ACCRUL70                                                         
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         GOTOR GETACRUL                                                         
         J     ACCRUL10                                                         
*                                                                               
ACCRUL70 GOTOR CHKLAV                                                           
         JE    ACCRULX                 OK - ALL VALUES NOW SET                  
                                                                                
         LHI   R3,1                                                             
         LA    R2,IOKEY                ELSE TRY OFFICE FOR SETTINGS             
         USING OFFRECD,R2                                                       
         MVC   OFFKEY,SPACES                                                    
         MVI   OFFKTYP,OFFKTYPQ                                                 
         MVC   OFFKCPY,CUXCPY                                                   
         MVC   OFFKOFF,CUACCS+1        *** THIS PROBABLY WON'T DO...            
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    *+10                                                             
         MVC   OFFKOFF,CUACCS+2                                                 
         MVC   CSVKEY1,OFFKEY                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JNE   ACCRULX                 NO OFFICE RECORD                         
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR GETACRUL                                                         
*                                                                               
         DROP  R2                                                               
                                                                                
ACCRULX  J     EXIT                                                             
                                                                                
         EJECT                                                                  
                                                                                
GETACRUL NTR1  LABEL=*                                                          
         SR    R0,R0                                                            
         L     RF,AIO3                                                          
         LA    RF,OFFRFST-OFFRECD(RF)                                           
N        USING CPXELD,RF                                                        
GTACCR00 CLI   N.CPXEL,0                                                        
         JE    GTACCRX                                                          
         CLI   N.CPXEL,CPXELQ                                                   
         JE    GTACCR10                                                         
         IC    R0,N.CPXLN                                                       
         AR    RF,R0                                                            
         J     GTACCR00                                                         
         DROP  N                                                                
*                                                                               
GTACCR10 GOTOR SETLAV                SET LIMIT ACCESS VALUES AT OFL LVL         
*                                                                               
GTACCRX  J     EXIT                                                             
                                                                                
         EJECT                                                                  
*                                                                               
************************************************************************        
                                                                                
N        USING CPXELD,RF                                                        
SETLAV   CLI   X#LLTMED,X#LLALLQ       TEST 'ALL' (= DEFAULT)                   
         JNE   SETJOBS                                                          
         TM    N.CPXSTAT3,CPXAMED                                               
         JZ    *+8                                                              
         MVI   X#LLTMED,X#LLNONQ                                                
                                                                                
SETJOBS  CLI   X#LLTCPJ,X#LLALLQ                                                
         JNE   SETWC                                                            
         TM    N.CPXSTAT3,CPXAJOBS                                              
         JZ    *+8                                                              
         MVI   X#LLTCPJ,X#LLNONQ                                                
                                                                                
SETWC    CLI   X#LLTWC,X#LLALLQ                                                 
         JNE   SETETYP                                                          
         TM    N.CPXSTAT3,CPXAWC                                                
         JZ    *+8                                                              
         MVI   X#LLTWC,X#LLNONQ                                                 
                                                                                
SETETYP  CLI   X#LLTETY,X#LLALLQ                                                
         JNE   SETSUPP                                                          
         TM    N.CPXSTAT3,CPXAETYP                                              
         JZ    *+8                                                              
         MVI   X#LLTETY,X#LLNONQ                                                
                                                                                
SETSUPP  CLI   X#LLTSUP,X#LLALLQ                                                
         JNE   SETSTAF                                                          
         TM    N.CPXSTAT4,CPXASUPP                                              
         JZ    *+8                                                              
         MVI   X#LLTSUP,X#LLNONQ                                                
                                                                                
SETSTAF  CLI   X#LLT1R,X#LLALLQ                                                 
         JNE   SET1NAC                                                          
         TM    N.CPXSTAT3,CPXASTAF                                              
         JZ    *+8                                                              
         MVI   X#LLT1R,X#LLNONQ                                                 
                                                                                
SET1NAC  CLI   X#LLTNC,X#LLALLQ                                                 
         JNE   SETLAVX                                                          
         TM    N.CPXSTAT3,CPXA1NAC                                              
         JZ    *+8                                                              
         MVI   X#LLTNC,X#LLNONQ                                                 
SETLAVX  BR    RE                                                               
         DROP  N                                                                
                                                                                
* TEST ALL LIMIT ACCESS VALUES ARE SET                                          
                                                                                
CHKLAV   LA    RF,X#LLTABS                                                      
         LHI   R0,X#LLTLQ                                                       
CHKLAVL  CLI   0(RF),X#LLALLQ          'ALL' = DEFAULT                          
         JE    CHKLAVN                 SO TRY ANOTHER LEVEL                     
         LA    RF,1(RF)                                                         
         JCT   R0,CHKLAVL                                                       
CHKLAVY  CR    RB,RB                                                            
         BR    RE                                                               
CHKLAVN  LTR   RB,RB                                                            
         BR    RE                                                               
         EJECT                                                                  
                                                                                
***********************************************************************         
* Get limit list data                                                 *         
* Etry: R1 - list type for MCS record                                 *         
* Exit: ELEMENT (LIDTMED,LIDTEXPD,LIDTWKCD) or LIACBLK contains limlist         
* This routine uses BYTE3 and BYTE4                                   *         
***********************************************************************         
         SPACE 1                                                                
GETLMT   NTR1  LABEL=*                                                          
         CLI   XL#APPL,QWMAINT                                                  
         JE    EXITN                                                            
         STC   R1,BYTE3            Save MCS list type                           
*                                                                               
         L     R0,AIO8                                                          
         ST    R0,XL#ADR2                                                       
         L     R0,AIO7                                                          
         MVI   BYTE4,YESQ          Store limit list in AIO7                     
         CLI   BYTE3,LIDTMEDL      Media code record                            
         JE    GETLMT02                                                         
         CLI   BYTE3,LIDTWCL       Work code record                             
         JE    GETLMT02                                                         
*                                                                               
         MVI   BYTE4,0                                                          
         LAY   R0,LIACBLK                                                       
GETLMT02 ST    R0,XL#ADR1                                                       
*                                                                               
         OC    CCTPID,CCTPID                                                    
         JZ    EXITN                                                            
*                                                                               
         USING LLSRECD,R2          Read list PID record for this person         
         LA    R2,IOKEY                                                         
         XC    LLSKEY,LLSKEY                                                    
         MVI   LLSKTYP,LLSKTYPQ                                                 
         MVI   LLSKSUB,LLSKSUBQ                                                 
         MVC   LLSKCPY,CUXCPY                                                   
         MVC   LLSKPIDB,CCTPID                                                  
         MVC   CSVKEY3,LLSKEY                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         CLC   IOKEY(LLSKGRP-LLSRECD),CSVKEY3                                   
         JNE   EXITN                                                            
         NI    XL#GLIND,FF-XL#GLIFQ                                             
         TM    XL#GLIND,XL#GLIPQ   Processed before?                            
         JNZ   GETLMT06                                                         
         OI    XL#GLIND,XL#GLIPQ+XL#GLIFQ                                       
         MVI   X#LLTABS,X#LLALLQ   Default to unlimited access if               
         MVC   X#LLTABS+1(X#LLTLQ-1),X#LLTABS we have limit list rec            
         OI    X#LLIND,X#LLINI                                                  
         J     GETLMT06                                                         
GETLMT04 LA    R2,IOKEY                                                         
         MVC   IOKEY,CSVKEY3       Reread sequential GrpList record             
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO1'                               
         LHI   RF,(LLSKGRP-LLSKEY)-1                                            
         CLI   LLSKSUB,LLSKSUBQ      Test Limit list record                     
         JE    *+8                                                              
         LHI   RF,(GLSKSEQ-GLSKEY)-1 No - use  Group list length                
         BASR  R1,0                                                             
         CLC   LLSKEY(0),CSVKEY3                                                
         EX    RF,0(R1)                                                         
         JNE   GETLMT48                                                         
GETLMT06 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    *+6                                                              
         DC    H'0'                Bad master record                            
         DROP  R2                                                               
*                                                                               
         L     R1,AIO1                                                          
         MVC   CSVKEY3,0(R1)                                                    
         LA    R1,LLSRFST-LLSRECD(R1)                                           
         USING LIDELD,R1                                                        
*                                                                               
GETLMT10 CLI   LIDEL,0                                                          
         JE    GETLMT04                                                         
         CLI   LIDEL,RSTELQ                                                     
         JE    GETLMT34                                                         
         CLI   LIDEL,LIDELQ                                                     
         JNE   GETLMT12                                                         
         CLC   LIDTYPE,BYTE3                                                    
         JE    GETLMT14                                                         
*                                                                               
GETLMT12 XR    RE,RE                                                            
         IC    RE,LIDLN                                                         
         AR    R1,RE                                                            
         J     GETLMT10            Get next                                     
*                                                                               
GETLMT14 XR    RE,RE                                                            
         IC    RE,LIDLN                                                         
         SHI   RE,(LIDDATA-LIDELD)+1                                            
         JM    GETLMT12            No client code                               
*&&UK                                                                           
         CLI   LIDTYPE,LIDTMEDL    media list                                   
         JNE   *+8                                                              
         MVI   X#LLTMED,X#LLLSTQ                                                
         CLI   LIDTYPE,LIDTSUPP    supplier list                                
         JNE   *+8                                                              
         MVI   X#LLTSUP,X#LLLSTQ                                                
         CLI   LIDTYPE,LIDT1RAC    1R account                                   
         JNE   *+8                                                              
         MVI   X#LLT1R,X#LLLSTQ                                                 
         CLI   LIDTYPE,LIDTCPJL    cli/pro/job list                             
         JNE   *+8                                                              
         MVI   X#LLTCPJ,X#LLLSTQ                                                
         CLI   LIDTYPE,LIDTEXPL    expenditure type list                        
         JNE   *+8                                                              
         MVI   X#LLTETY,X#LLLSTQ                                                
         CLI   LIDTYPE,LIDTWCL     workcode list                                
         JNE   *+8                                                              
         MVI   X#LLTWC,X#LLLSTQ                                                 
         CLI   LIDTYPE,LIDTNCLL    non client code list                         
         JNE   *+8                                                              
         MVI   X#LLTNC,X#LLLSTQ                                                 
*&&                                                                             
         XR    R3,R3                                                            
         IC    R3,LIDLN                                                         
         AR    R3,R1                                                            
         LA    R2,LIDDATA                                                       
M        USING LIDDATA,R2                                                       
                                                                                
GETLMT24 CR    R2,R3                                                            
         JNL   GETLMT12            (missing in media limlist = bad)             
         LA    RE,APPLTAB                                                       
GETLMT26 CLI   0(RE),FF                                                         
         JNE   *+6                                                              
         DC    H'0'                                                             
         CLC   XL#APPL,0(RE)                                                    
         JE    GETLMT28                                                         
         LA    RE,APPLTABL(RE)                                                  
         J     GETLMT26                                                         
                                                                                
GETLMT28 LLC   RF,1(RE)                                                         
         BASR  R4,0                                                             
         TM    M.LIDLAPPL,0                                                     
         EX    RF,0(R4)                                                         
         JZ    GETLMT32                                                         
*&&US                                                                           
         CLI   LIDTYPE,LIDTMEDL    media list                                   
         JNE   *+8                                                              
         MVI   X#LLTMED,X#LLLSTQ                                                
         CLI   LIDTYPE,LIDTSUPP    supplier list                                
         JNE   *+8                                                              
         MVI   X#LLTSUP,X#LLLSTQ                                                
         CLI   LIDTYPE,LIDT1RAC    1R account                                   
         JNE   *+8                                                              
         MVI   X#LLT1R,X#LLLSTQ                                                 
         CLI   LIDTYPE,LIDTCPJL    cli/pro/job list                             
         JNE   *+8                                                              
         MVI   X#LLTCPJ,X#LLLSTQ                                                
         CLI   LIDTYPE,LIDTEXPL    expenditure type list                        
         JNE   *+8                                                              
         MVI   X#LLTETY,X#LLLSTQ                                                
         CLI   LIDTYPE,LIDTWCL     workcode list                                
         JNE   *+8                                                              
         MVI   X#LLTWC,X#LLLSTQ                                                 
         CLI   LIDTYPE,LIDTNCLL    non client code list                         
         JNE   *+8                                                              
         MVI   X#LLTNC,X#LLLSTQ                                                 
*&&                                                                             
         CLI   LIDTYPE,LIDTSUPP                                                 
         JNE   GETLMT2A                                                         
         CLI   M.LIDLSULA,EMPTY    suppliers start w/ optional office           
         JE    GETLMT32                                                         
         L     RF,XL#ADR1          List area                                    
         LLC   RE,LIDITLN                                                       
         SHI   RE,1+L'LIDLAPPL+L'LIDLAPP2+L'LIDLOFFC                            
         BASR  R4,0                                                             
         MVC   0(0,RF),M.LIDLSULA  Save account codes                           
         EX    RE,0(R4)                                                         
         AHI   RE,1                                                             
         AR    RF,RE                                                            
         ST    RF,XL#ADR1                                                       
         J     GETLMT32                                                         
*                                                                               
GETLMT2A CLI   M.LIDLACT,EMPTY     Any account?                                 
         JE    GETLMT30                                                         
         L     RF,XL#ADR1          List area                                    
         LLC   RE,LIDITLN                                                       
         SHI   RE,1+L'LIDLAPPL+L'LIDLAPP2                                       
         BASR  R4,0                                                             
         MVC   0(0,RF),M.LIDLACT  Save client codes                             
         EX    RE,0(R4)                                                         
         AHI   RE,1                                                             
         AR    RF,RE                                                            
         ST    RF,XL#ADR1                                                       
         J     GETLMT32                                                         
                                                                                
GETLMT30 L     RF,XL#ADR2          List area                                    
         MVC   0(L'LIDLOFF,RF),M.LIDLOFF  Save client codes                     
         LA    RF,L'LIDLOFF(RF)                                                 
         ST    RF,XL#ADR2                                                       
                                                                                
GETLMT32 LLC   RE,LIDITLN                                                       
         AR    R2,RE                                                            
         J     GETLMT24                                                         
         DROP  M                                                                
*                                                                               
         USING RSTELD,R1                                                        
GETLMT34 TM    XL#GLIND,XL#GLIFQ                                                
         JZ    GETLMT12                                                         
         CLI   RSTLN,RSTLN3Q                                                    
         JL    GETLMT12                                                         
         TM    RSTACST1,RSTAJOBS                                                
         JZ    GETLMT36                                                         
         CLI   X#LLTCPJ,X#LLALLQ                                                
         JNE   GETLMT36                                                         
         MVI   X#LLTCPJ,X#LLNONQ                                                
GETLMT36 TM    RSTACST1,RSTAMED    Media code limit list                        
         JZ    GETLMT38                                                         
         CLI   X#LLTMED,X#LLALLQ                                                
         JNE   GETLMT38                                                         
         MVI   X#LLTMED,X#LLNONQ                                                
GETLMT38 TM    RSTACST1,RSTAETYP   Expenditure type limit list                  
         JZ    GETLMT40                                                         
         CLI   X#LLTETY,X#LLALLQ                                                
         JNE   GETLMT40                                                         
         MVI   X#LLTETY,X#LLNONQ                                                
GETLMT40 TM    RSTACST1,RSTA1NAC   Non-client limit list                        
         JZ    GETLMT42                                                         
         CLI   X#LLTNC,X#LLALLQ                                                 
         JNE   GETLMT42                                                         
         MVI   X#LLTNC,X#LLNONQ                                                 
GETLMT42 TM    RSTACST1,RSTASTAF   1R costing account list                      
         JZ    GETLMT44                                                         
         CLI   X#LLT1R,X#LLALLQ                                                 
         JNE   GETLMT44                                                         
         MVI   X#LLT1R,X#LLNONQ                                                 
GETLMT44 TM    RSTACST1,RSTAWC     Workcode list                                
         JZ    GETLMT46                                                         
         CLI   X#LLTWC,X#LLALLQ                                                 
         JNE   GETLMT46                                                         
         MVI   X#LLTWC,X#LLNONQ                                                 
GETLMT46 TM    RSTACST2,RSTASUPP   Supplier list                                
         JZ    GETLMT12                                                         
         CLI   X#LLTSUP,X#LLALLQ                                                
         JNE   GETLMT12                                                         
         MVI   X#LLTSUP,X#LLNONQ                                                
         J     GETLMT12                                                         
*                                                                               
GETLMT48 CLI   BYTE4,YESQ                                                       
         JNE   GETLMT50                                                         
         L     R1,AIO7                                                          
         OC    0(L'ELEMENT,R1),0(R1)                                            
         JZ    EXITN                                                            
         J     EXITY                                                            
*                                                                               
GETLMT50 LAY   R4,LIACBLK                                                       
         OC    0(L'ACTKACT,R4),0(R4)        Any limit list                      
         JZ    EXITN                        No                                  
         J     EXITY                                                            
         DROP  R1                                                               
         EJECT                                                                  
                                                                                
***********************************************************************         
* time & exp. appr. list download                                     *         
***********************************************************************         
*                                                                               
REQTEAP  LKREQ H,A#TEAP,OUTTEAP,NEXTREQ=REQJLSD                                 
*                                                                               
Type     LKREQ F,01,(D,B#SAVED,QTETY),CHAR,OLEN=L'QTETY,               +        
               MAXLEN=L'QTETY,TEXT=AC#TYPE,COL=*                                
*                                                                               
EMail    LKREQ F,02,(D,B#SAVED,QTEML),CHAR,OLEN=L'QTEML,               +        
               MAXLEN=L'QTEML,TEXT=AC#EMIL,COL=*                                
*                                                                               
TestOnly LKREQ F,03,(D,B#SAVED,QTETSTO),CHAR,OLEN=L'QTETSTO,           +        
               MAXLEN=L'QTETSTO,TEXT=(*,TSTOLIT),COL=*                          
                                                                                
         LKREQ E                                                                
*                                                                               
OUTTEAP  LKOUT H                                                                
                                                                                
TEAPPL   LKOUT R,A#TEAP                E-MAIL NOTIFICATION RECORD               
Array    LKOUT C,A#TEAP,(A,ARYTEAP)                                             
         LKOUT E                                                                
                                                                                
         LKOUT X                                                                
                                                                                
ARYTEAP  LKOUT A,(R,XTEAVLD)                                                    
Array    LKOUT C,A#TEAP,(A,ARYTEAP1),FILTROUT=TSTTYP1                           
Array    LKOUT C,A#TEAP,(A,ARYTEAP2),FILTROUT=TSTTYP2                           
Array    LKOUT C,A#TEAP,(A,ARYTEAP3),FILTROUT=TSTTYP3                           
         LKOUT E                                                                
                                                                                
ARYTEAP1 LKOUT A,(R,XTEAOUT),MULTIROW=Y,ROWNAME=APPTABD                         
                                                                                
PRout    LKOUT P,APPRPID,GETPID                                                 
TEAPP    LKOUT C,01,(D,B#WORKD,TEMP2),CHAR,LEN=ACCLEN,                 +        
               FILTROUT=TSTEMTY,SKIPCOLS=TEASKIPS                               
                                                                                
TEASKIP  EQU   *                                                                
                                                                                
PRout    LKOUT P,,GETPIN                                                        
TEAFN    LKOUT C,02,(D,B#WORKD,TEMP2),CHAR,ND=Y,LEN=NMLEN                       
TEALN    LKOUT C,03,(D,B#WORKD,WORK2),CHAR,ND=Y,LEN=LNMLEN                      
TEAEA    LKOUT C,04,(D,B#WORKD,APPEMAIL),CHAR,ND=Y,FILTROUT=TSTEML              
TEATY    LKOUT C,05,APPRTYP,HEXD                                                
TEANF    LKOUT C,06,APPRNTFY,CHAR,ND=Y                                          
TEA2N    LKOUT C,09,APPRPRNM,CHAR,ND=Y,FILTROUT=TSTPLNQ                         
TEAAC    LKOUT C,07,APPRULA,CHAR,ND=Y,FILTROUT=TSTKLNQ,                +        
               SKIPCOLS=TPKSKIPS                                                
                                                                                
TPKSKIP  EQU   *                                                                
                                                                                
TEA1N    LKOUT C,08,APPRCLNM,CHAR,ND=Y                                          
TEA3N    LKOUT C,10,APPRJBNM,CHAR,ND=Y                                          
TEAOF    LKOUT C,11,APPROFFC,CHAR,ND=Y                                          
                                                                                
TPKSKIPS EQU   (*-TPKSKIP)/LX_COLSL                                             
                                                                                
TEAON    LKOUT C,12,APPROFNM,CHAR,ND=Y,FILTROUT=TSTJLNQ,               +        
               SKIPCOLS=TPJSKIPS                                                
                                                                                
TPJSKIP  EQU   *                                                                
                                                                                
TEAMED   LKOUT C,13,APPRMED,CHAR,ND=Y                                           
TEAME    LKOUT C,14,APPRMDNM,CHAR,ND=Y                                          
                                                                                
TPJSKIPS EQU   (*-TPJSKIP)/LX_COLSL                                             
                                                                                
TEAMN    LKOUT C,15,(D,B#WORKD,TEMP2+32),CHAR,ND=Y,LEN=NMLEN                    
TEATK    LKOUT C,16,APPRTOKN,CHAR,ND=Y                                          
TEAST    LKOUT C,17,APPRAST,(R,EDTEAST),CHAR,ND=Y                               
                                                                                
TEASKIPS EQU   (*-TEASKIP)/LX_COLSL                                             
                                                                                
         LKOUT E                                                                
*                                                                               
ARYTEAP2 LKOUT A,(R,XTE2OUT),MULTIROW=Y,ROWNAME=CEITABD                         
                                                                                
PRout    LKOUT P,CEIPID,GETPID                                                  
TEAPP    LKOUT C,01,(D,B#WORKD,TEMP2),CHAR,LEN=ACCLEN,                 +        
               FILTROUT=TSTEMTY,SKIPCOLS=TE2SKIPS                               
                                                                                
TE2SKIP  EQU   *                                                                
                                                                                
PRout    LKOUT P,,GETPIN                                                        
TEAFN    LKOUT C,02,(D,B#WORKD,TEMP2),CHAR,ND=Y,LEN=NMLEN                       
TEALN    LKOUT C,03,(D,B#WORKD,WORK2),CHAR,ND=Y,LEN=LNMLEN                      
TEAEA    LKOUT C,04,(D,B#WORKD,APPEMAIL),CHAR,ND=Y,FILTROUT=TSTEML              
TEATY    LKOUT C,05,CEIPTY,HEXD,ND=Y                                            
TEANF    LKOUT C,06,(D,B#SAVED,QTETY),(R,EDTENTF),CHAR,ND=Y,           +        
               FILTROUT=TSTTYP4                                                 
                                                                                
TE2SKIPS EQU   (*-TE2SKIP)/LX_COLSL                                             
                                                                                
         LKOUT E                                                                
*                                                                               
ARYTEAP3 LKOUT A,(R,XTE3OUT),MULTIROW=Y,ROWNAME=SPITABD                         
                                                                                
PRout    LKOUT P,SPIPID,GETPID                                                  
TEAPP    LKOUT C,01,(D,B#WORKD,TEMP2),CHAR,LEN=ACCLEN,                 +        
               FILTROUT=TSTEMTY,SKIPCOLS=TE3SKIPS                               
                                                                                
TE3SKIP  EQU   *                                                                
                                                                                
PRout    LKOUT P,,GETPIN                                                        
TEAFN    LKOUT C,02,(D,B#WORKD,TEMP2),CHAR,ND=Y,LEN=NMLEN                       
TEALN    LKOUT C,03,(D,B#WORKD,WORK2),CHAR,ND=Y,LEN=LNMLEN                      
TEAEA    LKOUT C,04,(D,B#WORKD,APPEMAIL),CHAR,ND=Y,FILTROUT=TSTEML              
TEAAC    LKOUT C,07,SPIAPAC,CHAR,ND=Y                                           
TEAMN    LKOUT C,15,(D,B#WORKD,TEMP2+32),CHAR,ND=Y,LEN=NMLEN                    
                                                                                
TE3SKIPS EQU   (*-TE3SKIP)/LX_COLSL                                             
                                                                                
         LKOUT E                                                                
*                                                                               
***********************************************************************         
* Time & Expenses - Approver List download                            *         
***********************************************************************         
         SPACE 1                                                                
                                                                                
XTEAVLD  NTR1  LABEL=*                                                          
*                                                                               
         ST    R8,LP_ADATA                                                      
         CLI   QTETY,QTET1Q        type 1 = expenses/embedded                   
         JE    EXITY                                                            
         CLI   QTETY,QTET2Q        type 2 = time/embedded                       
         JE    EXITY                                                            
         CLI   QTETY,QTET3Q        type 3 = estimates/embedded                  
         JE    EXITY                                                            
         CLI   QTETY,QTET5Q        type 5 = invoices(2)/embedded                
         JE    EXITY                                                            
         CLI   QTETY,QTET6Q        type 6 = orders/embedded                     
         JE    EXITY                                                            
         CLI   QTETY,QTET7Q        type 7 = Jobs dashboard/embedded             
         JE    EXITY                                                            
                                                                                
*&&UK*&& MVC   LP_ERROR,=AL2(AE$SPNMC)                                          
*&&US*&& MVC   LP_ERROR,=AL2(AE$INVCD)                                          
         J     XERROR                                                           
***********************************************************************         
* Time & Expenses - Approver List download                            *         
***********************************************************************         
         SPACE 1                                                                
                                                                                
         USING CEITABD,R2                                                       
XTE2OUT  NTR1  LABEL=*                                                          
*                                                                               
         XR    R0,R0                                                            
         L     R2,SAVER2               RESTORING R2                             
*                                                                               
         CLI   LP_RMODE,LP_RFRST       IS IT FIRST TIME ?                       
         JNE   XTE2O10                                                          
*                                                                               
         XC    SAVER2,SAVER2           INITIALIZE SAVE AREA                     
         L     R2,AIO6                                                          
         ST    R2,SAVER2                                                        
*                                                                               
         CLI   QTETSTO,YESQ            IS IT TEST ONLY ?                        
         JNE   XTE2O10                                                          
*                                                                               
* TEST DATA ONLY FOR TESTING PURPOSE                                            
*                                                                               
         MVI   CEIPTY,X'01'                                                     
         MVC   CEIPID,=X'FFEA'                                                  
         MVC   CEILNQ(1,R2),=X'0000'   END OF TEST DATA                         
*                                                                               
XTE2O10  DS    0H                                                               
         ST    R2,LP_ADATA                                                      
         AHI   R0,CEILNQ               STORING THE RECORD LENGTH                
         OC    CEIPID,CEIPID           end of table?                            
         JZ    NOMORE                                                           
         J     XTEACOM                 READ NEXT                                
                                                                                
         EJECT                                                                  
*                                                                               
***********************************************************************         
         SPACE 1                                                                
                                                                                
         USING SPITABD,R2                                                       
XTE3OUT  NTR1  LABEL=*                                                          
*                                                                               
         XR    R0,R0                                                            
         L     R2,SAVER2               RESTORING R2                             
*                                                                               
         CLI   LP_RMODE,LP_RFRST       IS IT FIRST TIME ?                       
         JNE   XTE3O10                                                          
*                                                                               
         XC    SAVER2,SAVER2           INITIALIZE SAVE AREA                     
         L     R2,AIO6                                                          
         ST    R2,SAVER2                                                        
*                                                                               
         CLI   QTETSTO,YESQ            IS IT TEST ONLY ?                        
         JNE   XTE3O10                                                          
*                                                                               
* TEST DATA ONLY FOR TESTING PURPOSE                                            
*                                                                               
         MVC   SPIPID,=X'FFEA'                                                  
         MVC   SPIAPAC,=C'1234567'                                              
         MVC   SPILNQ(1,R2),=X'0000'   END OF TEST DATA                         
*                                                                               
XTE3O10  DS    0H                                                               
         ST    R2,LP_ADATA                                                      
         AHI   R0,SPILNQ               STORING THE RECORD LENGTH                
         OC    SPIPID,SPIPID           end of table?                            
         JZ    NOMORE                                                           
         J     XTEACOM                 READ NEXT                                
         EJECT                                                                  
*                                                                               
**********************************************************************          
         SPACE 1                                                                
                                                                                
         USING APPTABD,R2                                                       
XTEAOUT  NTR1  LABEL=*                                                          
*                                                                               
         XR    R0,R0                                                            
         L     R2,SAVER2               RESTORING R2                             
*                                                                               
         CLI   LP_RMODE,LP_RFRST       IS IT FIRST TIME ?                       
         JNE   XTEAO10                                                          
*                                                                               
         XC    SAVER2,SAVER2           INITIALIZE SAVE AREA                     
         L     R2,AIO4                                                          
         ST    R2,SAVER2                                                        
*                                                                               
         CLI   QTETSTO,YESQ            IS IT TEST ONLY ?                        
         JNE   XTEAO10                                                          
*                                                                               
* TEST DATA ONLY FOR TESTING PURPOSE                                            
*                                                                               
         MVI   APPRLN,APPJLNQ          RECORD LENGTH                            
         MVC   APPRPID,=X'FFEA'                                                 
         MVI   APPRTYP,X'01'                                                    
         MVI   APPRNTFY,C'Y'                                                    
         MVI   APPRAST,X'80'                                                    
         MVC   APPRTOKN,=C'ABCDEFGH'                                            
         MVC   APPROFFC,SJQ                                                     
*                                                                               
         MVI   APPRUNT,OUNIT                                                    
         MVI   APPRLDG,OLEDGER                                                  
         MVC   APPRACT,=C'123456789000'                                         
         MVI   APPRMED,C'Y'                                                     
         MVC   APPROFNM,=C'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'                
         MVC   APPRCLNM,APPROFNM                                                
         MVC   APPRMDNM,APPROFNM                                                
         MVC   APPRPRNM,APPROFNM                                                
         MVC   APPRJBNM,APPROFNM                                                
         MVC   APPJLNQ(0,R2),=X'00'    END OF TEST DATA                         
*                                                                               
XTEAO10  DS    0H                                                               
         ST    R2,LP_ADATA                                                      
         MVC   XL#APLNQ,APPRLN         STORING FOR FILTER ROUTUNE               
         LLC   R0,APPRLN               STORING THE RECORD LENGTH                
         CLI   APPRLN,0                END OF TABLE?                            
         JE    NOMORE                                                           
*                                                                               
XTEACOM  DS    0H                                                               
         AR    R2,R0                   INCREMENTING WITH THE REC LENGTH         
         ST    R2,SAVER2                                                        
         J     NXTREC                  READ NEXT                                
                                                                                
         EJECT                                                                  
*                                                                               
***********************************************************************         
* FILTER ROUTINES                                                               
***********************************************************************         
                                                                                
TSTTYP1  CLI   QTETY,QTET2Q            type 2 = time/embedded?                  
         BER   RE                                                               
         CLI   QTETY,QTET1Q            type 1 = expenses/embedded?              
         BR    RE                                                               
                                                                                
TSTTYP2  CLI   QTETY,QTET3Q            type 3 = estimates/embedded?             
         BER   RE                                                               
         CLI   QTETY,QTET6Q            type 6 = orders/embedded?                
         BER   RE                                                               
         CLI   QTETY,QTET7Q            type 7 =Jobs dashboard/embedded?         
         BR    RE                                                               
                                                                                
TSTTYP3  CLI   QTETY,QTET5Q            type 5 = invoices(2)/embedded?           
         BR    RE                                                               
                                                                                
TSTTYP4  CLI   QTETY,QTET7Q            type 7 =Jobs dashboard/embedded?         
         BR    RE                                                               
                                                                                
TSTEMTY  DS    0H                                                               
         CLI   TEMP2,QCHAR             SKIP RECORD IF "?"                       
         J     SETCCC                                                           
                                                                                
TSTEML   CLI   QTEML,NOQ               EMAIL NEEDED?                            
         J     SETCCC                                                           
                                                                                
TSTKLNQ  CLI   XL#APLNQ,APPKLNQ        IS LENGTH EQUAL?                         
         J     SETCCC                                                           
                                                                                
TSTPLNQ  CLI   XL#APLNQ,APPPLNQ        IS LENGTH LOW?                           
         BNLR  RE                                                               
         J     SETCCC                                                           
                                                                                
TSTJLNQ  CLI   XL#APLNQ,APPJLNQ        IS LENGTH LOW?                           
         BNLR  RE                                                               
         J     SETCCC                                                           
                                                                                
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* GET Email Notification : - APPROVER CODE, FIRST, MIDDLE &? LAST NAME          
***********************************************************************         
         SPACE 1                                                                
GETPID   NTR1  LABEL=*                                                          
*                                                                               
         L     R1,LP_AINP                                                       
         MVC   TEMP2(PIDLEN),0(R1)                                              
         GOTOR (#GETPID,AGETPID)       GET THE ACCOUNT CODE FOR PID             
         JE    GETPIDX                                                          
*                                                                               
         XC    TEMP2,TEMP2             IF NOT FOUND MOVE "?"                    
         MVI   TEMP2,QCHAR                                                      
*                                                                               
GETPIDX  J     EXITY                                                            
                                                                                
         EJECT                                                                  
***********************************************************************         
         SPACE 1                                                                
GETPIN   NTR1  LABEL=*                                                          
*                                                                               
         CLI   TEMP2,QCHAR             IF "?" DON'T POPULATE REST               
         JE    GETPINX                                                          
*                                                                               
         GOTOR (#GETPIN,AGETPIN)                                                
*                                                                               
GETPINX  J     EXITY                                                            
                                                                                
         EJECT                                                                  
*                                                                               
***********************************************************************         
* Job list call 2C                                                    *         
***********************************************************************         
                                                                                
REQJLSD  LKREQ H,A#JLSD,OUTJLSD,NEXTREQ=REQJAUD                                 
                                                                                
Clic     LKREQ F,01,(D,B#SAVED,RQ_JDCLC),CHAR,OLEN=L'RQ_JDCLC,         +        
               MAXLEN=L'RQ_JDCLC,TEXT=AC#CLIC,COL=*                             
                                                                                
LockedJ  LKREQ F,02,(D,B#SAVED,RQ_JDLST),CHAR,OLEN=L'RQ_JDLST,         +        
               MAXLEN=L'RQ_JDLST,TEXT=AC#LCKED,COL=*                            
                                                                                
ClosedJ  LKREQ F,03,(D,B#SAVED,RQ_JDCST),CHAR,OLEN=L'RQ_JDCST,         +        
               MAXLEN=L'RQ_JDCST,TEXT=AC#CLSD,COL=*                             
                                                                                
Accflt1  LKREQ F,04,(D,B#SAVED,RQ_JDF1V),CHAR,OLEN=L'RQ_JDF1V,         +        
               MAXLEN=L'RQ_JDF1V,TEXT=AC#FLT1,COL=*                             
                                                                                
Accflt2  LKREQ F,05,(D,B#SAVED,RQ_JDF2V),CHAR,OLEN=L'RQ_JDF2V,         +        
               MAXLEN=L'RQ_JDF2V,TEXT=AC#FLT2,COL=*                             
                                                                                
Accflt3  LKREQ F,06,(D,B#SAVED,RQ_JDF3V),CHAR,OLEN=L'RQ_JDF3V,         +        
               MAXLEN=L'RQ_JDF3V,TEXT=AC#FLT3,COL=*                             
                                                                                
Accflt4  LKREQ F,07,(D,B#SAVED,RQ_JDF4V),CHAR,OLEN=L'RQ_JDF4V,         +        
               MAXLEN=L'RQ_JDF4V,TEXT=AC#FLT4,COL=*                             
                                                                                
Accflt5  LKREQ F,08,(D,B#SAVED,RQ_JDF5V),CHAR,OLEN=L'RQ_JDF5V,         +        
               MAXLEN=L'RQ_JDF5V,TEXT=AC#FLT5,COL=*                             
                                                                                
Mediac   LKREQ F,09,(I,B#SAVED,RQ_JDMIN),CHAR,OLEN=L'PMDKMED,          +        
               LIST=(F,NOSORT),TEXT=AC#MEDC,COL=*                               
                                                                                
Prodc    LKREQ F,10,(D,B#SAVED,RQ_JDPRO),CHAR,OLEN=L'RQ_JDPRO,         +        
               MAXLEN=L'RQ_JDPRO,TEXT=AC#PROC,COL=*                             
                                                                                
OpnDtS   LKREQ F,11,(D,B#SAVED,RQ_JDOPN),CHAR,OLEN=L'RQ_JDOPN,         +        
               MAXLEN=L'RQ_JDOPN,TEXT=AC#OPNDT,COL=*                            
                                                                                
OpnDtE   LKREQ F,12,(D,B#SAVED,RQ_JDOPX),CHAR,OLEN=L'RQ_JDOPX,         +        
               MAXLEN=L'RQ_JDOPX,TEXT=AC#OPNDT,COL=*                            
                                                                                
ClsDtS   LKREQ F,13,(D,B#SAVED,RQ_JDCLO),CHAR,OLEN=L'RQ_JDCLO,         +        
               MAXLEN=L'RQ_JDCLO,TEXT=AC#CLSDT,COL=*                            
                                                                                
ClsDtE   LKREQ F,14,(D,B#SAVED,RQ_JDCLX),CHAR,OLEN=L'RQ_JDCLX,         +        
               MAXLEN=L'RQ_JDCLX,TEXT=AC#CLSDT,COL=*                            
                                                                                
Jobnm    LKREQ F,15,(I,B#SAVED,RQ_JDNIN),CHAR,OLEN=L'SRCKWRD1,         +        
               LIST=F,LOWERCASE=Y,TEXT=AC#NAME,COL=*                            
                                                                                
Usrfld1  LKREQ F,16,(D,B#SAVED,RQ_JDUF1),CHAR,OLEN=L'RQ_JDUF1,         +        
               MAXLEN=L'RQ_JDUF1,TEXT=AC#RSUSF,COL=*                            
                                                                                
Usrfld2  LKREQ F,17,(D,B#SAVED,RQ_JDUF2),CHAR,OLEN=L'RQ_JDUF2,         +        
               MAXLEN=L'RQ_JDUF2,TEXT=AC#RSUSF,COL=*                            
                                                                                
Usrfld3  LKREQ F,18,(D,B#SAVED,RQ_JDUF3),CHAR,OLEN=L'RQ_JDUF3,         +        
               MAXLEN=L'RQ_JDUF3,TEXT=AC#RSUSF,COL=*                            
                                                                                
Usrfld4  LKREQ F,19,(D,B#SAVED,RQ_JDUF4),CHAR,OLEN=L'RQ_JDUF4,         +        
               MAXLEN=L'RQ_JDUF4,TEXT=AC#RSUSF,COL=*                            
                                                                                
Usrfld5  LKREQ F,20,(D,B#SAVED,RQ_JDUF5),CHAR,OLEN=L'RQ_JDUF5,         +        
               MAXLEN=L'RQ_JDUF5,TEXT=AC#RSUSF,COL=*                            
                                                                                
Usrfld6  LKREQ F,21,(D,B#SAVED,RQ_JDUF6),CHAR,OLEN=L'RQ_JDUF6,         +        
               MAXLEN=L'RQ_JDUF6,TEXT=AC#RSUSF,COL=*                            
                                                                                
Usrfld7  LKREQ F,22,(D,B#SAVED,RQ_JDUF7),CHAR,OLEN=L'RQ_JDUF7,         +        
               MAXLEN=L'RQ_JDUF7,TEXT=AC#RSUSF,COL=*                            
                                                                                
Usrfld8  LKREQ F,23,(D,B#SAVED,RQ_JDUF8),CHAR,OLEN=L'RQ_JDUF8,         +        
               MAXLEN=L'RQ_JDUF8,TEXT=AC#RSUSF,COL=*                            
                                                                                
Usrfld9  LKREQ F,24,(D,B#SAVED,RQ_JDUF9),CHAR,OLEN=L'RQ_JDUF9,         +        
               MAXLEN=L'RQ_JDUF9,TEXT=AC#RSUSF,COL=*                            
                                                                                
Usrfld0  LKREQ F,25,(D,B#SAVED,RQ_JDUF0),CHAR,OLEN=L'RQ_JDUF0,         +        
               MAXLEN=L'RQ_JDUF0,TEXT=AC#RSUSF,COL=*                            
                                                                                
*&&UK                                                                           
Drafts   LKREQ F,26,(D,B#SAVED,RQ_JDDRA),CHAR,OLEN=L'RQ_JDDRA,         +        
               MAXLEN=L'RQ_JDDRA,TEXT=AC#UNAPP,COL=*                            
*&&                                                                             
*&&US                                                                           
Drafts   LKREQ F,26,(D,B#SAVED,RQ_JDDRA),CHAR,OLEN=L'RQ_JDDRA,         +        
               MAXLEN=L'RQ_JDDRA,TEXT=AC#UAPR,COL=*                             
*&&                                                                             
EstmtPC  LKREQ F,27,(D,B#SAVED,RQ_JDEPC),CHAR,OLEN=L'RQ_JDEPC,         +        
               MAXLEN=L'RQ_JDEPC,TEXT=AC#JOBES,COL=*                            
                                                                                
StatVT   LKREQ F,40,(D,B#SAVED,RQ_JDTYP),CHAR,OLEN=L'RQ_JDTYP,         +        
               MAXLEN=L'RQ_JDTYP,TEXT=AC#TYPE,COL=*                             
                                                                                
Gaov     LKREQ F,41,(D,B#SAVED,RQ_JDGAO),CHAR,OLEN=L'RQ_JDGAO,         +        
               MAXLEN=L'RQ_JDGAO,TEXT=AC#GAOV,COL=*                             
                                                                                
Status   LKREQ F,42,(I,B#SAVED,RQ_JDSIN),CHAR,OLEN=L'X#JDSTAT,         +        
               LIST=(F,NOSORT),TEXT=AC#STT,COL=*                                
                                                                                
*&&UK                                                                           
Submtr   LKREQ F,43,(D,B#SAVED,RQ_JDSPC),CHAR,OLEN=L'RQ_JDSPC,         +        
               MAXLEN=L'RQ_JDSPC,TEXT=AC#ESSUB,COL=*                            
*&&                                                                             
                                                                                
*&&US                                                                           
Submtr   LKREQ F,43,(D,B#SAVED,RQ_JDSPC),CHAR,OLEN=L'RQ_JDSPC,         +        
               MAXLEN=L'RQ_JDSPC,TEXT=AC#SUBMT,COL=*                            
*&&                                                                             
                                                                                
Apprvr   LKREQ F,44,(D,B#SAVED,RQ_JDAPC),CHAR,OLEN=L'RQ_JDAPC,         +        
               MAXLEN=L'RQ_JDAPC,TEXT=AC#APRVR,COL=*                            
                                                                                
*&&UK                                                                           
Rejctr   LKREQ F,45,(D,B#SAVED,RQ_JDRPC),CHAR,OLEN=L'RQ_JDRPC,         +        
               MAXLEN=L'RQ_JDRPC,TEXT=AC#ESREJ,COL=*                            
*&&                                                                             
                                                                                
*&&US                                                                           
Rejctr   LKREQ F,45,(D,B#SAVED,RQ_JDRPC),CHAR,OLEN=L'RQ_JDRPC,         +        
               MAXLEN=L'RQ_JDRPC,TEXT=AC#REJEC,COL=*                            
*&&                                                                             
                                                                                
OpnfEst  LKREQ F,46,(D,B#SAVED,RQ_OPENS),CHAR,OLEN=L'RQ_OPENS,         +        
               MAXLEN=L'RQ_OPENS,TEXT=(*,OPESTLIT),COL=*                        
                                                                                
OpnfOrd  LKREQ F,47,(D,B#SAVED,RQ_OPENO),CHAR,OLEN=L'RQ_OPENO,         +        
               MAXLEN=L'RQ_OPENO,TEXT=(*,OPORDLIT),COL=*                        
                                                                                
OpnfExt  LKREQ F,48,(D,B#SAVED,RQ_OPENX),CHAR,OLEN=L'RQ_OPENX,         +        
               MAXLEN=L'RQ_OPENX,TEXT=(*,OPEXTLIT),COL=*                        
                                                                                
OpnfBil  LKREQ F,49,(D,B#SAVED,RQ_OPENB),CHAR,OLEN=L'RQ_OPENB,         +        
               MAXLEN=L'RQ_OPENB,TEXT=(*,OPBILLIT),COL=*                        
                                                                                
OpnfAdj  LKREQ F,50,(D,B#SAVED,RQ_OPENA),CHAR,OLEN=L'RQ_OPENA,         +        
               MAXLEN=L'RQ_OPENA,TEXT=(*,OPADJLIT),COL=*                        
                                                                                
OpnfTim  LKREQ F,51,(D,B#SAVED,RQ_OPENT),CHAR,OLEN=L'RQ_OPENT,         +        
               MAXLEN=L'RQ_OPENT,TEXT=(*,OPTIMLIT),COL=*                        
                                                                                
Overlim  LKREQ F,52,(D,B#SAVED,RQ_JDOVR),CHAR,OLEN=L'RQ_JDOVR,         +        
               MAXLEN=L'RQ_JDOVR,TEXT=AC#TYPE,COL=*                             
                                                                                
OfficeC  LKREQ F,53,(D,B#SAVED,RQ_JDOFF),CHAR,OLEN=L'RQ_JDOFF,         +        
               MAXLEN=L'RQ_JDOFF,TEXT=AC#OFFC,COL=*                             
                                                                                
UsrfldH  LKREQ F,54,(I,B#SAVED,RQ_JDUIN),CHAR,LIST=NOSORT,             X        
               TEXT=AC#HEADR,LOWERCASE=Y,OLEN=L'UFSDESC,ARRAY=S                 
                                                                                
UsrfldD  LKREQ F,55,(I,B#SAVED,RQ_JDUIN),CHAR,LIST=NOSORT,             X        
               TEXT=AC#RSUSF,LOWERCASE=Y,OLEN=UFSDATMX                          
                                                                                
UsrfldT  LKREQ F,57,(D,B#SAVED,RQ_JDUIN),CHAR,LIST=NOSORT,             X        
               TEXT=AC#TYPE,LOWERCASE=Y,OLEN=UFSTYPEL,ARRAY=E                   
                                                                                
JobCd    LKREQ F,56,(D,B#SAVED,RQ_JDJOB),CHAR,OLEN=L'RQ_JDJOB,         +        
               MAXLEN=L'RQ_JDJOB,TEXT=AC#JOBC,COL=*                             
                                                                                
ShowPay  LKREQ F,58,(D,B#SAVED,RQ_JDPAY),CHAR,OLEN=L'RQ_JDPAY,         +        
               MAXLEN=L'RQ_JDPAY,TEXT=(*,JBPAYLIT),COL=*                        
                                                                                
         LKREQ E                                                                
                                                                                
                                                                                
OUTJLSD  LKOUT H                                                                
                                                                                
OUTJLSDS LKOUT R,R#JLSD                                                         
Prout    LKOUT P,,JLSDINIT                                                      
Array    LKOUT C,R#JLSD,(A,ARYJLSD)                                             
Prout    LKOUT P,,JLSDLAP2                                                      
Array    LKOUT C,R#JLSD,(A,ARYJLSD),FILTROUT=TSTLAPS                            
         LKOUT E                                                                
         LKOUT X                                                                
                                                                                
ARYJLSD  LKOUT A,(R,NXTJLSD),MULTIROW=Y,ROWNAME=ACTRECD                         
Prout    LKOUT P,ACTKACT,GETACNT                                                
ClientC  LKOUT C,28,(D,B#SAVED,JD_CLI),CHAR,ND=Y                                
ProdC    LKOUT C,01,(D,B#SAVED,JD_PRO),CHAR,ND=Y                                
JobC     LKOUT C,05,(D,B#SAVED,JD_JOB),CHAR,ND=Y                                
MedC     LKOUT C,03,(D,B#SAVED,JD_MED),CHAR,ND=Y                                
*                                                                               
ClientN  LKOUT C,29,(D,B#SAVED,JD_CLN),CHAR,ND=Y                                
ProdN    LKOUT C,02,(D,B#SAVED,JD_PRN),CHAR,ND=Y                                
*                                                                               
Prout    LKOUT P,,GETMEDNM                                                      
MedNm    LKOUT C,04,(D,B#SAVED,JD_MEN),CHAR,ND=Y                                
*                                                                               
Array    LKOUT C,06,(A,ARYJOBN)                                                 
Array    LKOUT C,07,(A,ARYJOBF)                                                 
*                                                                               
JobLock  LKOUT C,08,ACTKSTAT,(R,EDTJOBL),CHAR,ND=Y,FILTROUT=TSTRWNCL            
*                                                                               
Prout    LKOUT P,,GETOFFD                                                       
OfficeN  LKOUT C,10,(D,B#WORKD,TEMP2),CHAR,ND=Y                                 
OfficeC  LKOUT C,09,(D,B#SAVED,JD_OFF),CHAR,ND=Y                                
*                                                                               
Array    LKOUT C,11,(A,ARYJDT)                                                  
*                                                                               
Prout    LKOUT P,,GETOPTD                                                       
Currency LKOUT C,13,(D,B#SAVED,JD_CUR),CHAR,ND=Y                                
DraftJob LKOUT C,63,(D,B#SAVED,JD_DRFT),CHAR,ND=Y                               
AutoNum  LKOUT C,62,(D,B#SAVED,JD_AUTO),CHAR,ND=Y                               
DrfJEst  LKOUT C,64,(D,B#SAVED,JD_ESDR),CHAR,ND=Y                               
*                                                                               
Prout    LKOUT P,ACTRECD,GETJSTA                                                
Status   LKOUT C,14,(D,B#SAVED,JD_STA),CHAR,ND=Y                                
*                                                                               
Filters  LKOUT C,15,ACTRSAF1,CHAR,LEN=FLTLN,ND=Y                                
*                                                                               
Array    LKOUT C,16,(A,ARYUSF),FILTROUT=TSTUFS                                  
*                                                                               
Prout    LKOUT P,,GETLAD                                                        
LstActDt LKOUT C,26,(D,B#SAVED,JD_LAD),PDAT,ND=Y                                
LstActPC LKOUT C,27,(D,B#SAVED,JD_LAC),CHAR,ND=Y                                
LstActFN LKOUT C,39,(D,B#SAVED,JD_LAF),CHAR,LEN=NMLEN,ND=Y                      
LstActLN LKOUT C,40,(D,B#SAVED,JD_LAL),CHAR,LEN=LNMLEN,ND=Y                     
LstActMN LKOUT C,58,(D,B#SAVED,JD_LAM),CHAR,LEN=NMLEN,ND=Y                      
*                                                                               
Array    LKOUT C,31,(A,ARYCPC)                                                  
*                                                                               
Array    LKOUT C,37,(A,ARYJCAM)                                                 
*                                                                               
Prout    LKOUT P,,ESTPCC                                                        
EstPC    LKOUT C,41,(D,B#SAVED,JD_EPC),SPAK,ND=Y,PZERO=S                        
ColourC  LKOUT C,42,(D,B#SAVED,JD_COL),CHAR,ND=Y                                
NetBill  LKOUT C,74,(D,B#SAVED,JD_NETBL),SPAK,ND=Y,PZERO=S                      
Actuals  LKOUT C,75,(D,B#SAVED,JD_ACTLS),SPAK,ND=Y,PZERO=S                      
Orders   LKOUT C,76,(D,B#SAVED,JD_ORDRS),SPAK,ND=Y,PZERO=S                      
Estimate LKOUT C,77,(D,B#SAVED,JD_ESTMD),SPAK,ND=Y,PZERO=S                      
Amber    LKOUT C,79,(D,B#SAVED,JD_AMBR),SPAK,PZERO=S                            
Red      LKOUT C,80,(D,B#SAVED,JD_RED),SPAK,PZERO=S                             
Eshrs    LKOUT C,82,(D,B#SAVED,JD_ESHRS),SPAK                                   
Achrs    LKOUT C,83,(D,B#SAVED,JD_ACHRS),SPAK                                   
*                                                                               
Prout    LKOUT P,,CHKACT                                                        
JobCls   LKOUT C,43,(D,B#SAVED,JD_CCLSE),CHAR,ND=Y                              
JObDel   LKOUT C,61,(D,B#SAVED,JD_CDELT),CHAR,ND=Y                              
*                                                                               
Array    LKOUT C,44,(A,ARYJLOC)                                                 
*                                                                               
Array    LKOUT C,50,(A,ARYJSCI)                                                 
*                                                                               
Array    LKOUT C,52,(A,ARYMACC)                                                 
*                                                                               
Prout    LKOUT P,,GETHDRDT                                                      
AuraUFH1 LKOUT C,66,(D,B#SAVED,JD_AUFH1),CHAR,ND=Y                              
AuraUFD1 LKOUT C,67,(D,B#SAVED,JD_AUFD1),CHAR,ND=Y                              
AuraUFH2 LKOUT C,68,(D,B#SAVED,JD_AUFH2),CHAR,ND=Y                              
AuraUFD2 LKOUT C,69,(D,B#SAVED,JD_AUFD2),CHAR,ND=Y                              
AuraUFH3 LKOUT C,70,(D,B#SAVED,JD_AUFH3),CHAR,ND=Y                              
AuraUFD3 LKOUT C,71,(D,B#SAVED,JD_AUFD3),CHAR,ND=Y                              
*                                                                               
Array    LKOUT C,72,(A,ARYJIFU)                                                 
*                                                                               
PayTotal LKOUT C,78,(D,B#SAVED,JD_PAYMT),SPAK,FILTROUT=TSTSCPAT                 
         LKOUT E                                                                
                                                                                
*                                                                               
ARYJOBN  LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,                         +        
               ROWID=(NAMEL,NAMELQ),ROWWIDTH=(V,NAMLN)                          
Jobname  LKOUT C,6,NAMEREC,CHAR,LEN=V,ND=Y                                      
         LKOUT E                                                                
*                                                                               
ARYJOBF  LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,                         +        
               ROWID=(XNMELD,XNMELQ),ROWWIDTH=(V,XNMLN)                         
Jobfnam  LKOUT C,7,XNMSUBN,CHAR,LEN=V,ND=Y                                      
         LKOUT E                                                                
*                                                                               
ARYJDT   LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,                         +        
               ROWID=(JOBEL,JOBELQ),ROWWIDTH=(V,JOBLN)                          
OpenDt   LKOUT C,11,JOBADATE,PDAT,ND=Y,FILTROUT=TSTJOBL2                        
OpenDt   LKOUT C,11,JOBODATE,PDAT,ND=Y,FILTROUT=TSTJOBL3                        
ClosDt   LKOUT C,12,JOBCDATE,PDAT,ND=Y                                          
IdNum    LKOUT C,30,JOBREVNO,(R,EDTJIDN),CHAR,ND=Y,FILTROUT=TSTJOBL             
JobMast  LKOUT C,51,JOBSTA2,(R,EDTJMST),CHAR,ND=Y,FILTROUT=TSTJOBL1             
*&&US                                                                           
ExpJob   LKOUT C,65,JOBSTA1,(R,EDTEXJB),CHAR,ND=Y,FILTROUT=TSTJOBL1             
*&&                                                                             
Prout    LKOUT P,JOBELD,SETREJC                                                 
         LKOUT E                                                                
*                                                                               
ARYCPC   LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,                         +        
               ROWID=(RACEL,RACELQ),ROWWIDTH=(V,RACLN)                          
CreatorC LKOUT C,31,RACPERS,(U,#EDTPID,$EDTPID),FILTROUT=TSTRADD,      +        
               SKIPCOLS=JCPCSKPS,ND=Y                                           
JCPCSKIP EQU   *                                                                
Prout    LKOUT P,RACPERS,SETPIDN                                                
CreatFnm LKOUT C,32,(D,B#WORKD,TEMP2),CHAR,LEN=NMLEN,ND=Y                       
CreatLnm LKOUT C,33,(D,B#WORKD,WORK2),CHAR,LEN=LNMLEN,ND=Y                      
CreatMnm LKOUT C,60,(D,B#WORKD,TEMP2+32),CHAR,LEN=NMLEN,ND=Y                    
JCPCSKPS EQU   (*-JCPCSKIP)/LX_COLSL                                            
                                                                                
ApprvrCd LKOUT C,34,RACPERS,(U,#EDTPID,$EDTPID),FILTROUT=TSTRAPP,      +        
               SKIPCOLS=APCSKIPS                                                
APCSKIP  EQU   *                                                                
Prout    LKOUT P,RACPERS,SETPIDN                                                
ApprvrFn LKOUT C,35,(D,B#WORKD,TEMP2),CHAR,LEN=NMLEN,ND=Y                       
ApprvrLn LKOUT C,36,(D,B#WORKD,WORK2),CHAR,LEN=LNMLEN,ND=Y                      
ApprvrMn LKOUT C,59,(D,B#WORKD,TEMP2+32),CHAR,LEN=NMLEN,ND=Y                    
APCSKIPS EQU   (*-APCSKIP)/LX_COLSL                                             
                                                                                
         LKOUT E                                                                
*                                                                               
ARYJCAM  LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,                         +        
               ROWID=(FFTEL,FFTELQ),ROWWIDTH=(V,FFTLN)                          
CampCd   LKOUT C,37,FFTDATA,LBIN,ND=Y,FILTROUT=TSTRFFTP                         
CampNM   LKOUT C,38,FFTDATA,(R,EDTCAMN),CHAR,ND=Y,FILTROUT=TSTRFFTP             
         LKOUT E                                                                
*                                                                               
ARYJIFU  LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,                         +        
               ROWID=(ASTEL,ASTELQ),ROWWIDTH=(V,ASTLN)                          
IsForUsr LKOUT C,72,ASTSTAT1,(R,EDTIFU)                                         
         LKOUT E                                                                
*                                                                               
ARYJLOC  LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,                         +        
               ROWID=(RSTEL,RSTELQ),ROWWIDTH=(V,RSTLN)                          
JobLfEst LKOUT C,44,RSTLSTAT,(R,EDTJLOS),CHAR,ND=Y,FILTROUT=TSTRLN3Q            
JobLford LKOUT C,45,RSTLSTAT,(R,EDTJLOR),CHAR,ND=Y,FILTROUT=TSTRLN3Q            
JobLfExt LKOUT C,46,RSTLSTAT,(R,EDTJLOE),CHAR,ND=Y,FILTROUT=TSTRLN3Q            
JobLfBil LKOUT C,47,RSTLSTAT,(R,EDTJLOB),CHAR,ND=Y,FILTROUT=TSTRLN3Q            
JobLfAdj LKOUT C,48,RSTLSTAT,(R,EDTJLOA),CHAR,ND=Y,FILTROUT=TSTRLN3Q            
JobLfTim LKOUT C,49,RSTELD,(R,EDTJLOT),CHAR,ND=Y,FILTROUT=TSTRLN3Q              
BraEstEx LKOUT C,73,RSTSTAT6,(R,EDTBEST),CHAR,ND=Y,FILTROUT=TSTRLN3Q            
         LKOUT E                                                                
*                                                                               
ARYJSCI  LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,                         +        
               ROWID=(SCIEL,SCIELQ),ROWWIDTH=(V,SCILN)                          
Fee      LKOUT C,50,SCIAMNT,SPAK,ND=Y,FILTROUT=TSTSCFEE                         
Prout    LKOUT P,SCIELD,SETPAY                                                  
Comm     LKOUT C,81,SCIAMNT,SPAK,ND=Y,FILTROUT=TSTSCCOM                         
         LKOUT E                                                                
*                                                                               
ARYMACC  LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,                         +        
               ROWID=(SPAEL,SPAELQ),ROWWIDTH=(V,SPALN)                          
MastCli  LKOUT C,52,SPAAULA,(U,#EDTCLI,$EDTCLI),SPAK,FILTROUT=TSTSMACC,+        
               SKIPCOLS=JMCSKIPS,ND=Y                                           
JMCSKIP  EQU   *                                                                
MastCliN LKOUT C,53,SPAAULA,(U,#EDTCLN,$EDTCLN),SPAK,ND=Y                       
MastProd LKOUT C,54,SPAAULA,(U,#EDTPRD,$EDTPRD),SPAK,ND=Y                       
MastPrdN LKOUT C,55,SPAAULA,(U,#EDTPRN,$EDTPRN),SPAK,ND=Y                       
MastJob  LKOUT C,56,SPAAULA,(U,#EDTJOB,$EDTJOB),SPAK,ND=Y                       
MastJobN LKOUT C,57,SPAAULA,(U,#EDTJBN,$EDTJBN),SPAK,ND=Y                       
JMCSKIPS EQU   (*-JMCSKIP)/LX_COLSL                                             
         LKOUT E                                                                
*                                                                               
ARYUSF   LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,                         +        
               ROWID=(UFSEL,UFSELQ),ROWWIDTH=(V,UFSLN)                          
Usrflds  LKOUT C,15,UFSDATA,CHAR,MAPMOD=*,LEN=V,ND=Y                            
         LKOUT E                                                                
*                                                                               
FLTLN    EQU   5                                                                
NMLEN    EQU   16                                                               
LNMLEN   EQU   58                                                               
*                                                                               
SVRDEF   CSECT ,                                                                
                                                                                
***********************************************************************         
* Job List and Search download Routine                                *         
***********************************************************************         
NXTJLSD  NTR1                                                                   
                                                                                
         LA    R0,JD_VALS                                                       
         LHI   R1,JD_LNQ                                                        
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
         ZAP   JD_PAYMT,PZERO                                                   
                                                                                
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO2                                        
                                                                                
         MVI   X#LAPSW1,NOQ                                                     
         MVI   X#LAPSW2,NOQ                                                     
                                                                                
         OC    ROUERRV,ROUERRV                                                  
         JZ    NXTJLS02                                                         
         MVC   LP_ERROR,ROUERRV                                                 
         XC    ROUERRV,ROUERRV                                                  
         J     XERROR                                                           
*                                                                               
NXTJLS02 CLI   RQ_JDTYP,RQ_JDTNQ   New Call?                                    
         JH    NXTJLS18                                                         
                                                                                
         USING REQTABD,R3                                                       
NXTJLS04 XC    DMCB,DMCB                                                        
         XC    IOKEY,IOKEY                                                      
         LA    R2,DMCB                                                          
         LA    R3,REQTAB                                                        
         XR    R4,R4                                                            
         LHI   R4,REQTABN                                                       
                                                                                
NXTJLS06 CLC   REQTYP,X#PTYP       Check for Request type                       
         JE    NXTJLS08                                                         
                                                                                
         LA    R3,REQTABLQ(R3)                                                  
         JCT   R4,NXTJLS06                                                      
         J     *+2                                                              
                                                                                
NXTJLS08 ICM   R6,15,REQKEYD       Get Key Driver                               
         A     R6,SRVRRELO                                                      
         CLI   X#PTYP,REQTACTQ                                                  
         JNE   NXTJLS10                                                         
         CLC   RQ_JDCLC,SPACES                                                  
         JNH   NXTJLS10                                                         
                                                                                
         LLC   R7,RQ_JDCLC                                                      
         AHI   R7,1                                                             
         STC   R7,RQ_JDCEN                                                      
         LA    R6,ACTKEYC                                                       
                                                                                
NXTJLS10 STCM  R6,15,0(R2)                                                      
*                                                                               
         ICM   R6,15,REQKEYF       Get Key Filter Routine                       
         A     R6,SRVRRELO                                                      
         STCM  R6,15,12(R2)                                                     
*                                                                               
         ICM   R6,15,REQRECF       Get record filter routine                    
         A     R6,SRVRRELO                                                      
         STCM  R6,15,16(R2)                                                     
*                                                                               
         DROP  R3                                                               
*                                                                               
NXTJLS12 MVC   IOKEY,SAVEKEY1                                                   
         GOTOR (#NXTREC,ANXTREC),DMCB,,('B#ACTREC',0),(0,SAVED)                 
         JE    EXITY                                                            
                                                                                
         CLI   X#PTYP,REQTACTQ                                                  
         JNE   NXTJLS14                                                         
         MVI   LP_RMODE,LP_RLAST                                                
                                                                                
NXTJLS14 TM    SAVEIND,SAVEXDR                                                  
         JZ    NXTJLS16                                                         
         NI    SAVEIND,FF-SAVEXDR                                               
         OI    SAVEIND,SAVEXDL                                                  
         MVI   X#PTYP,REQTDRAQ                                                  
         MVI   X#LAPSW1,YESQ                                                    
         J     NOMORE                                                           
                                                                                
NXTJLS16 TM    SAVEIND,SAVEMST     multiple status'?                            
         JZ    EXITY                                                            
         TM    SAVEIND,SAVERL2     lap 2 required                               
         JZ    EXITY                                                            
                                                                                
         MVI   X#JDSTAT,X#JDSTAP   set to approved for lap 2                    
         OI    SAVEIND,SAVEML2                                                  
         NI    SAVEIND,FF-(SAVEMST+SAVERL2)                                     
         MVI   X#LAPSW2,YESQ                                                    
         J     NOMORE                                                           
                                                                                
NXTJLS18 MVC   X#PAST,SPACES                                                    
                                                                                
         USING REQTABD,R3                                                       
NXTJLS20 XC    DMCB,DMCB                                                        
         LA    R2,DMCB                                                          
         LA    R3,NWCTAB                                                        
         XR    R4,R4                                                            
         LHI   R4,NWCTABN                                                       
                                                                                
NXTJLS22 CLC   REQTYP,RQ_JDTYP                                                  
         JE    NXTJLS24                                                         
                                                                                
         LA    R3,NWCTABLQ(R3)                                                  
         JCT   R4,NXTJLS22                                                      
                                                                                
         MVC   LP_ERROR,=AL2(AE$IVTYP) Invalid Request                          
         J     XERROR                                                           
                                                                                
NXTJLS24 ICM   R6,15,REQKEYD       Get Key Driver                               
         A     R6,SRVRRELO                                                      
         STCM  R6,15,0(R2)                                                      
*                                                                               
         ICM   R6,15,REQKEYF       Get Key filter routine                       
         A     R6,SRVRRELO                                                      
         STCM  R6,15,12(R2)                                                     
*                                                                               
         ICM   R6,15,REQRECF       Get Record filter routine                    
         A     R6,SRVRRELO                                                      
         STCM  R6,15,16(R2)                                                     
*                                                                               
         MVC   X#PAST,REQJOBS                                                   
*                                                                               
         DROP  R3                                                               
*                                                                               
NXTJLS26 MVC   IOKEY,SAVEKEY1                                                   
         GOTOR (#NXTREC,ANXTREC),DMCB,,('B#ACTREC',0),(0,SAVED)                 
         JNE   EXITN                                                            
         J     EXITY                                                            
         EJECT                                                                  
**********************************************************************          
* Job list and Search Download request initialization                *          
**********************************************************************          
JLSDINIT NTR1                                                                   
         XR    RF,RF                                                            
         NI    SAVEIND,FF-(SAVEXDL+SAVEML2+SAVEAUR)                             
         ICM   RF,B'0011',CUXPNUM                                               
         CHI   RF,XPRODIKQ                                                      
         JNE   JLSD002                                                          
         OI    SAVEIND,SAVEAUR                                                  
                                                                                
JLSD002  XC    X#13MDAT,X#13MDAT   All, if Aura 13 months only for some         
         TM    SAVEIND,SAVEAUR     requests (PIDKJOBQ)                          
         JZ    JLSD004                                                          
                                                                                
         GOTOR VDATCON,DMCB,(5,0),(0,DUB1)                                      
         GOTOR VADDAY,DMCB,(C'M',DUB1),DUB2,-13                                 
         GOTOR VDATCON,DMCB,(0,DUB2),(2,X#13MDAT)                               
                                                                                
JLSD004  MVI   X#SRCL,FF                                                        
         XC    X#OPND,X#OPND                                                    
         XC    X#CLOD,X#CLOD                                                    
         MVC   X#OPNX,XFFS                                                      
         MVC   X#CLOX,XFFS                                                      
         MVI   X#JDTPAS,0                                                       
         MVI   X#CLPL,0                                                         
         MVC   XL#SCPJ,SPACES                                                   
*                                  Initialize GAP TSAR                          
         JAS   RE,PROCARRY         process arrays                               
         JNE   EXITN                                                            
                                                                                
JLSD008  OC    CCTPID,CCTPID                                                    
         JNZ   JLSD010                                                          
                                                                                
         MVC   ROUERRV,=AL2(AE$INPID)                                           
         J     EXITN                                                            
                                                                                
JLSD010  MVI   TSARTYPE,TSARTJSQ                                                
         GOTOR GOTSAR,DMCB,('TSAINI',0)  to buffer cli/pro/off details          
                                                                                
         OC    RQ_JDSPC,SPACES                                                  
         XC    X#PIDSU,X#PIDSU                                                  
         CLC   RQ_JDSPC,SPACES                                                  
         JE    JLSD014                                                          
         MVC   TEMP2(L'RQ_JDSPC),RQ_JDSPC                                       
         GOTOR (#GETPIN,AGETPIN)                                                
         JE    JLSD012                                                          
         MVC   ROUERRV,=AL2(AE$INPID)                                           
         J     EXITN                                                            
                                                                                
JLSD012  MVC   X#PIDSU,TEMP2+50                                                 
                                                                                
JLSD014  OC    RQ_JDAPC,SPACES                                                  
         XC    X#PIDAP,X#PIDAP                                                  
         CLC   RQ_JDAPC,SPACES                                                  
         JNH   JLSD018                                                          
         MVC   TEMP2(L'RQ_JDAPC),RQ_JDAPC                                       
         GOTOR (#GETPIN,AGETPIN)                                                
         JE    JLSD016                                                          
         MVC   ROUERRV,=AL2(AE$INPID)                                           
         J     EXITN                                                            
                                                                                
JLSD016  MVC   X#PIDAP,TEMP2+50                                                 
                                                                                
JLSD018  XC    X#PIDRJ,X#PIDRJ                                                  
         CLC   RQ_JDRPC,SPACES                                                  
         JNH   JLSD022                                                          
         MVC   TEMP2(L'RQ_JDRPC),RQ_JDRPC                                       
         GOTOR (#GETPIN,AGETPIN)                                                
         JE    JLSD020                                                          
         MVC   ROUERRV,=AL2(AE$INPID)                                           
         J     EXITN                                                            
                                                                                
JLSD020  MVC   X#PIDRJ,TEMP2+50                                                 
                                                                                
         USING ACTRECD,R2                                                       
JLSD022  MVI   X#PTYP,REQTACTQ                                                  
                                                                                
         CLC   RQ_JDCLC,SPACES                                                  
         JNH   JLSD030                                                          
                                                                                
         XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY            read for client account record               
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(L'PRODUL),PRODUL                                         
         MVC   ACTKACT(L'RQ_JDCLC),RQ_JDCLC                                     
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    JLSD028                                                          
                                                                                
*&&UK*&& MVC   ROUERRV,=AL2(AE$CLINF)                                           
*&&US*&& MVC   ROUERRV,=AL2(AE$INCLI)                                           
         J     EXITN                                                            
*                                                                               
JLSD028  MVC   XL#SCPJ,ACTKACT                                                  
         LLC   RE,PCLILEN          Client length                                
         BCTR  RE,0                                                             
         STC   RE,X#CLPL                                                        
         CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    JLSD032                                                          
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    JLSD032                                                          
         CLI   RQ_JDLST,YESQ       include locked jobs?                         
         JE    JLSD032                                                          
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    JLSD032                                                          
                                                                                
         TM    ACTKSTAT,ACTSLOCK   client locked?                               
         JZ    JLSD032                                                          
                                                                                
         MVC   ROUERRV,=AL2(AE$CLILK)                                           
         J     EXITN                                                            
                                                                                
JLSD030  CLC   RQ_JDPRO,SPACES                                                  
         JH    *+2                                                              
                                                                                
JLSD032  CLC   RQ_JDPRO,SPACES                                                  
         JNH   JLSD036                                                          
                                                                                
         LA    R2,IOKEY                                                         
         LLC   R1,PPROLEN                                                       
         LLC   RE,PCLILEN                                                       
         SR    R1,RE                                                            
         LA    RE,ACTKACT(RE)                                                   
         BCTR  R1,0                                                             
         ST    R5,SAVER5                                                        
         BASR  R5,0                                                             
         MVC   0(0,RE),RQ_JDPRO                                                 
         EX    R1,0(R5)                                                         
         L     R5,SAVER5                                                        
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    JLSD034                                                          
                                                                                
*&&UK*&& MVC   ROUERRV,=AL2(AE$PRONF)                                           
*&&US*&& MVC   ROUERRV,=AL2(AE$INPRO)                                           
         J     EXITN                                                            
                                                                                
*                                                                               
JLSD034  MVC   XL#SCPJ,ACTKACT                                                  
         LLC   RE,PPROLEN          prod length                                  
         BCTR  RE,0                                                             
         STC   RE,X#CLPL                                                        
         CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    JLSD036                                                          
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    JLSD036                                                          
         CLI   RQ_JDLST,YESQ       include locked jobs?                         
         JE    JLSD036                                                          
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    JLSD036                                                          
                                                                                
         TM    ACTKSTAT,ACTSLOCK   product locked?                              
         JZ    JLSD036                                                          
                                                                                
         MVC   ROUERRV,=AL2(AE$LOCKD)                                           
         J     EXITN                                                            
                                                                                
JLSD036  CLC   RQ_JDJOB,SPACES                                                  
         JNH   JLSD038                                                          
                                                                                
         LA    R2,IOKEY                                                         
         LLC   R1,PJOBLEN                                                       
         LLC   RE,PPROLEN                                                       
         SR    R1,RE                                                            
         LA    RE,ACTKACT(RE)                                                   
         BCTR  R1,0                                                             
         ST    R5,SAVER5                                                        
         BASR  R5,0                                                             
         MVC   0(0,RE),RQ_JDJOB                                                 
         EX    R1,0(R5)                                                         
         L     R5,SAVER5                                                        
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    JLSD037                                                          
                                                                                
*&&UK*&& MVC   ROUERRV,=AL2(AE$JOBNF)                                           
*&&US*&& MVC   ROUERRV,=AL2(AE$INJOB)                                           
         J     EXITN                                                            
*                                                                               
JLSD037  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO2                                                          
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('PPRELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JNE   JLSD064                                                          
         L     R3,12(R1)           Save product office                          
         MVC   XL#COFF,PPRGAOFF-PPRELD(R3)                                      
         J     JLSD064                                                          
         DROP  R2                                                               
                                                                                
JLSD038  CLC   RQ_JDOPN,SPACES                                                  
         JNH   JLSD040                                                          
         GOTOR VDATCON,DMCB,(0,RQ_JDOPN+2),(1,X#OPND)                           
         OI    X#JDTPAS,X#JDTPOQ                                                
                                                                                
JLSD040  CLC   RQ_JDOPX,SPACES                                                  
         JNH   JLSD042                                                          
         GOTOR VDATCON,DMCB,(0,RQ_JDOPX+2),(1,X#OPNX)                           
         OI    X#JDTPAS,X#JDTPOQ                                                
                                                                                
JLSD042  CLC   RQ_JDCLO,SPACES                                                  
         JNH   JLSD044                                                          
         GOTOR VDATCON,DMCB,(0,RQ_JDCLO+2),(1,X#CLOD)                           
         OI    X#JDTPAS,X#JDTPCQ                                                
                                                                                
JLSD044  CLC   RQ_JDCLX,SPACES                                                  
         JNH   JLSD046                                                          
         GOTOR VDATCON,DMCB,(0,RQ_JDCLX+2),(1,X#CLOX)                           
         OI    X#JDTPAS,X#JDTPCQ                                                
                                                                                
JLSD046  CLI   RQ_JDTYP,RQ_JDTNQ                                                
         JH    JLSD065                                                          
         MVI   X#PAST,0                                                         
         OC    RQ_JDNAD,RQ_JDNAD                                                
         JNZ   JLSD050                                                          
         TM    X#JDSTAT,X#JDSTRE+X#JDSTSU+X#JDSTMA                              
         JZ    JLSD052             skip no filter or approved filter            
         MVI   X#PAST,YESQ         else use DRAPASD                             
                                                                                
         TM    SAVEIND,SAVEMST                                                  
         JZ    JLSD048                                                          
                                                                                
         TM    X#JDSTAT,X#JDSTAP   also approved?                               
         JZ    JLSD048                                                          
                                                                                
         OI    SAVEIND,SAVERL2     set to required lap 2                        
         NI    X#JDSTAT,FF-X#JDSTAP                                             
                                                                                
JLSD048  MVI   X#PTYP,REQTDRAQ                                                  
         J     JLSD064                                                          
                                                                                
JLSD050  MVI   X#PAST,0                                                         
                                                                                
         STC   RF,RCTYPE                                                        
         MVI   X#HIGH,YESQ                                                      
         LLC   R1,X#CLVL                                                        
         SHI   R1,ACTKACT-ACTKCPY                                               
         STC   R1,X#CLVL                                                        
                                                                                
         L     R2,AIO7             buffer table to skip dupes                   
         LHI   R0,(L'IOAREA7+L'IOAREA8)/L'ACTKACT                               
         STH   R0,0(R2)                                                         
         MVI   2(R2),0                                                          
                                                                                
         MVI   X#TSAYN,YESQ                                                     
         MVI   X#PTYP,REQTSRCQ                                                  
                                                                                
         J     JLSD064                                                          
                                                                                
JLSD052  NI    SAVEIND,FF-SAVEXDR  extra DRAPAS lap not required                
         LA    RE,PIDKJSAQ                                                      
         OC    X#PIDAP,X#PIDAP     approver or submitter?                       
         JNZ   JLSD056                                                          
         LA    RE,PIDKJSSQ                                                      
         OC    X#PIDSU,X#PIDSU                                                  
         JZ    JLSD060                                                          
         CLI   X#JDSTAT,0          no status or none approved status            
         JE    JLSD054             set then need DRAPASD lap, too               
         TM    X#JDSTAT,X#JDSTRE+X#JDSTSU+X#JDSTMA                              
         JZ    JLSD056                                                          
                                                                                
JLSD054  OI    SAVEIND,SAVEXDR                                                  
                                                                                
JLSD056  STC   RE,X#PAST                                                        
         MVC   X#PID,X#PIDAP                                                    
         CLI   X#PAST,PIDKJSAQ                                                  
         JE    JLSD058                                                          
         MVC   X#PID,X#PIDSU                                                    
                                                                                
JLSD058  MVI   X#PTYP,REQTPIDQ                                                  
         J     JLSD064                                                          
                                                                                
JLSD060  TM    X#JDTPAS,X#JDTPCQ+X#JDTPOQ                                       
         JZ    JLSD064             open/close date passives                     
                                                                                
         LLC   R0,X#JDTPAS         (save)                                       
         MVI   X#JDTPAS,0                                                       
         CLC   RQ_JDCLC,SPACES     unless single client specified               
         JH    JLSD064                                                          
         STC   R0,X#JDTPAS         (restore)                                    
                                                                                
         GOTO1 VDATCON,DMCB,(1,X#CLOD),(2,X#PASSTA)                             
         GOTO1 VDATCON,DMCB,(1,X#CLOX),(2,X#PASEND)                             
                                                                                
         MVI   TMPJDTP,JDTPDTCQ                                                 
         TM    X#JDTPAS,X#JDTPCQ                                                
         JNZ   JLSD062                                                          
         MVI   TMPJDTP,JDTPDTOQ                                                 
                                                                                
         GOTO1 VDATCON,DMCB,(1,X#OPND),(2,X#PASSTA)                             
         GOTO1 VDATCON,DMCB,(1,X#OPNX),(2,X#PASEND)                             
                                                                                
JLSD062  MVI   X#TSAYN,YESQ                                                     
         MVI   X#PTYP,REQTJDTQ                                                  
*                                  Check limlist security                       
JLSD064  MVC   XL#SCPJ,IOKEY+ACTKACT-ACTRECD                                    
*                                                                               
JLSD065  XC    GAPLPARM,GAPLPARM                                                
         GOTOR (#GOATSR,AGOATSR),DMCB,('TSAINI',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
         CLI   RQ_JDTYP,RQ_JDTNQ   New status call?                             
         JNH   *+12                No                                           
         CLI   RQ_JDTYP,RQ_JDT7Q   Yes but only want to get Limlist for         
         JNE   JLSD092               for assigned list call                     
         CLI   RQ_JDOVR,YESQ       Do we have override on                       
         JE    JLSD092             Yes - let all through                        
*                                                                               
         MVI   X#LLIN2,0                                                        
*                                                                               
         GOTOR (#GAPLST,AGAPLST),DMCB,('GAPTT2Q',TSARABUF),            +        
               ('GAPLLIML',SPACES),('GAPLTACC',GAPLPARM),('QJOB',0)             
         JE    JLSD066                                                          
         GOTOR (#GAPLST,AGAPLST),DMCB,('GAPTT2Q',TSARABUF),            +        
               ('GAPLAPPR',SPACES),('GAPLTACC',GAPLPARM),('QJOB',0)             
         JE    JLSD066                                                          
         GOTOR (#GAPLST,AGAPLST),DMCB,('GAPTT2Q',TSARABUF),            +        
               ('GAPLBKAP',SPACES),('GAPLTACC',GAPLPARM),('QJOB',0)             
         JNE   JLSECLK             No CPJ access                                
*                                                                               
JLSD066  MVI    GAPLPARM,GAPLPADD+GAPLACLS                                      
         GOTOR (#GAPLST,AGAPLST),DMCB,('GAPTT5Q',TSARABUF),            +        
               ('GAPLLIML',SPACES),('GAPLTACC',GAPLPARM),('QJOB',0)             
         JE    JLSD068                                                          
         GOTOR (#GAPLST,AGAPLST),DMCB,('GAPTT5Q',TSARABUF),            +        
               ('GAPLAPPR',SPACES),('GAPLTACC',GAPLPARM),('QJOB',0)             
         JE    JLSD068                                                          
         GOTOR (#GAPLST,AGAPLST),DMCB,('GAPTT5Q',TSARABUF),            +        
               ('GAPLBKAP',SPACES),('GAPLTACC',GAPLPARM),('QJOB',0)             
         JE    JLSD068                                                          
         J     JLSECLK            No media access                               
*                                                                               
JLSD068  CLC   RQ_JDCLC,SPACES    If no client code or media no                 
         JH    JLSD070            filtering to do                               
         OC    X#MEDLS,X#MEDLS                                                  
         JZ    JLSD092                                                          
*                                                                               
GAP      USING GAPTABD,GAPAREA                                                  
JLSD070  LA    R2,X#MEDLL         Media limlist block                           
         XC    GAPAREA,GAPAREA                                                  
         XC    ATSRERRS,ATSRERRS                                                
         GOTOR (#GOATSR,AGOATSR),DMCB,('TSARDH',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
         J     JLSD074                                                          
*                                                                               
JLSD072  GOTOR (#GOATSR,AGOATSR),DMCB,('TSANXT',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
*                                                                               
JLSD074  TM    ATSRERRS,TSEEOF      Hit the end?                                
         JZ    JLSD082                                                          
         TM    X#LLIN2,X#LCPJQ+X#LMEDQ Passed CPJ and media filtering?          
         JNO   JLSECLK                                                          
*                                                                               
*  Check passed media list against media limlist                                
*                                                                               
         LA    RF,X#MEDLS           Passed media list                           
         LA    RE,X#MEDLS+L'X#MEDLS                                             
*                                                                               
JLSD076  OC    0(L'PMDKMED,RF),0(RF) No media filter?                           
         JZ    JLSD092                                                          
         CR    RF,RE                                                            
         JNL   JLSD092                                                          
*                                                                               
         LA    R2,X#MEDLL           Media limlist                               
         LA    R1,X#MEDLL+L'X#MEDLL                                             
*                                                                               
JLSD078  OC    0(L'PMDKMED,R2),0(R2) No media filter?                           
         JZ    JLSECLK                                                          
         CR    R2,R1                                                            
         JNL   JLSECLK                                                          
         CLC   0(L'PMDKMED,RF),0(R2) match on media                             
         JE    JLSD080                                                          
         AHI   R2,L'PMDKMED                                                     
         J     JLSD078                                                          
*                                                                               
JLSD080  AHI   RF,L'PMDKMED                                                     
         J     JLSD076                                                          
*                                                                               
JLSD082  CLI   GAP.GAPTDAT1,GAPTT2Q SJ entry                                    
         JNE   JLSD088                                                          
         CLC   GAP.GAPTCODE,SPACES All access entry then ok                     
         JH    *+14                                                             
         CLC   GAP.GAPTCOFF,SPACES Any office?                                  
         JNH   JLSD086                                                          
*                                                                               
         LA    R4,GAP.GAPTACC                                                   
         LLC   R1,PCLILEN          Determine limlist entry level                
         LR    RF,R1                                                            
         AR    RF,R4                                                            
         CLI   0(RF),C' '                                                       
         JNH   JLSD084                                                          
         LLC   R1,PPROLEN                                                       
         LR    RF,R1                                                            
         AR    RF,R4                                                            
         CLI   0(RF),C' '                                                       
         JNH   JLSD084                                                          
         LLC   R1,PJOBLEN                                                       
*                                                                               
JLSD084  BCTR  R1,0                                                             
         LLC   RF,X#CLPL                                                        
         CR    R1,RF                                                            
         JNH   *+6                                                              
         LR    R1,RF                                                            
         BASR  RF,0                                                             
         CLC   GAP.GAPTACC(0),XL#SCPJ  Match on SJ account code                 
         EX    R1,0(RF)                                                         
         JNE   JLSD072                                                          
*                                                                               
JLSD086  CLC   GAP.GAPTCOFF,SPACES Check office code                            
         JNH   JLSD087                                                          
         CLC   RQ_JDOFF,SPACES                                                  
         JNH   JLSD087                                                          
         CLC   GAP.GAPTCOFF,RQ_JDOFF                                            
         JNE   JLSD072                                                          
JLSD087  OI    X#LLIN2,X#LCPJQ     Set CPJ limlist found                        
         J     JLSD072                                                          
*                                 Concatenate media list                        
JLSD088  CLI   GAP.GAPTDAT1,GAPTT5Q media entry                                 
         JNE   JLSD072                                                          
         CLC   GAP.GAPTCODE,SPACES All access entry then ok                     
         JNH   JLSD090                                                          
         MVC   0(L'GAPTMEDI,R2),GAP.GAPTMEDI                                    
         AHI   R2,L'GAPTMEDI        Populate media limlist block                
         CLC   RQ_JDJOB,SPACES      Any job code?                               
         JNH   JLSD090                                                          
         CLC   GAP.GAPTMEDI,RQ_JDJOB                                            
         JNE   JLSD072                                                          
JLSD090  OI    X#LLIN2,X#LMEDQ                                                  
         J     JLSD072                                                          
*                                                                               
JLSD092  DS    0H                                                               
         J     EXITY                                                            
*                                                                               
JLSECLK  MVC   ROUERRV,=AL2(AE$SECLK)                                           
         J     EXITN                                                            
         DROP  GAP                                                              
**********************************************************************          
* Job list and Search Download LAP 2 Routine                         *          
**********************************************************************          
         USING ACTRECD,R2                                                       
JLSDLAP2 NTR1                                                                   
                                                                                
         CLI   X#LAPSW1,YESQ                                                    
         JE    EXITY                                                            
                                                                                
         MVI   X#PTYP,REQTACTQ                                                  
                                                                                
         CLC   RQ_JDCLC,SPACES                                                  
         JNH   JLSDLP04                                                         
                                                                                
         XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY            read for client account record               
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(L'PRODUL),PRODUL                                         
         MVC   ACTKACT(L'RQ_JDCLC),RQ_JDCLC                                     
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    JLSDLP02                                                         
                                                                                
*&&UK*&& MVC   ROUERRV,=AL2(AE$CLINF)                                           
*&&US*&& MVC   ROUERRV,=AL2(AE$INCLI)                                           
         J     EXITN                                                            
                                                                                
JLSDLP02 MVC   XL#SCPJ,ACTKACT                                                  
         LLC   RE,PCLILEN          Client length                                
         BCTR  RE,0                                                             
         STC   RE,X#CLPL                                                        
         CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    JLSDLP06                                                         
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    JLSDLP06                                                         
         CLI   RQ_JDLST,YESQ       include locked jobs?                         
         JE    JLSDLP06                                                         
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    JLSDLP06                                                         
                                                                                
         TM    ACTKSTAT,ACTSLOCK   client locked?                               
         JZ    JLSDLP06                                                         
                                                                                
         MVC   ROUERRV,=AL2(AE$CLILK)                                           
         J     EXITN                                                            
                                                                                
JLSDLP04 CLC   RQ_JDPRO,SPACES                                                  
         JH    *+2                                                              
                                                                                
JLSDLP06 CLC   RQ_JDPRO,SPACES                                                  
         JNH   JLSDLP10                                                         
                                                                                
         LA    R2,IOKEY                                                         
         LLC   R1,PPROLEN                                                       
         LLC   RE,PCLILEN                                                       
         SR    R1,RE                                                            
         LA    RE,ACTKACT(RE)                                                   
         BCTR  R1,0                                                             
         ST    R5,SAVER5                                                        
         BASR  R5,0                                                             
         MVC   0(0,RE),RQ_JDPRO                                                 
         EX    R1,0(R5)                                                         
         L     R5,SAVER5                                                        
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    JLSDLP08                                                         
                                                                                
*&&UK*&& MVC   ROUERRV,=AL2(AE$PRONF)                                           
*&&US*&& MVC   ROUERRV,=AL2(AE$INPRO)                                           
         J     EXITN                                                            
                                                                                
JLSDLP08 MVC   XL#SCPJ,ACTKACT                                                  
         LLC   RE,PPROLEN          prod length                                  
         BCTR  RE,0                                                             
         STC   RE,X#CLPL                                                        
         CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    JLSDLP10                                                         
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    JLSDLP10                                                         
         CLI   RQ_JDLST,YESQ       include locked jobs?                         
         JE    JLSDLP10                                                         
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    JLSDLP10                                                         
                                                                                
         TM    ACTKSTAT,ACTSLOCK   product locked?                              
         JZ    JLSDLP10                                                         
                                                                                
         MVC   ROUERRV,=AL2(AE$LOCKD)                                           
         J     EXITN                                                            
                                                                                
JLSDLP10 CLC   RQ_JDJOB,SPACES                                                  
         JNH   JLSDLP12                                                         
                                                                                
         LA    R2,IOKEY                                                         
         LLC   R1,PJOBLEN                                                       
         LLC   RE,PPROLEN                                                       
         SR    R1,RE                                                            
         LA    RE,ACTKACT(RE)                                                   
         BCTR  R1,0                                                             
         ST    R5,SAVER5                                                        
         BASR  R5,0                                                             
         MVC   0(0,RE),RQ_JDJOB                                                 
         EX    R1,0(R5)                                                         
         L     R5,SAVER5                                                        
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    JLSDLP12                                                         
                                                                                
*&&UK*&& MVC   ROUERRV,=AL2(AE$JOBNF)                                           
*&&US*&& MVC   ROUERRV,=AL2(AE$INJOB)                                           
         J     EXITN                                                            
         DROP  R2                                                               
                                                                                
JLSDLP12 MVC   TMPACNT,IOKEY+ACTKACT-ACTRECD                                    
         MVI   X#SRCL,FF   save SJ(/client/product) key                         
         XC    X#OPND,X#OPND                                                    
         XC    X#CLOD,X#CLOD                                                    
         MVC   X#OPNX,XFFS                                                      
         MVC   X#CLOX,XFFS                                                      
         MVI   X#JDTPAS,0                                                       
                                                                                
         CLC   RQ_JDOPN,SPACES                                                  
         JNH   JLSDLP14                                                         
         GOTOR VDATCON,DMCB,(0,RQ_JDOPN+2),(1,X#OPND)                           
         OI    X#JDTPAS,X#JDTPOQ                                                
                                                                                
JLSDLP14 CLC   RQ_JDOPX,SPACES                                                  
         JNH   JLSDLP16                                                         
         GOTOR VDATCON,DMCB,(0,RQ_JDOPX+2),(1,X#OPNX)                           
         OI    X#JDTPAS,X#JDTPOQ                                                
                                                                                
JLSDLP16 CLC   RQ_JDCLO,SPACES                                                  
         JNH   JLSDLP18                                                         
         GOTOR VDATCON,DMCB,(0,RQ_JDCLO+2),(1,X#CLOD)                           
         OI    X#JDTPAS,X#JDTPCQ                                                
                                                                                
JLSDLP18 CLC   RQ_JDCLX,SPACES                                                  
         JNH   JLSDLP20                                                         
         GOTOR VDATCON,DMCB,(0,RQ_JDCLX+2),(1,X#CLOX)                           
         OI    X#JDTPAS,X#JDTPCQ                                                
                                                                                
JLSDLP20 CLI   RQ_JDTYP,RQ_JDTNQ                                                
         JH    NXTJLS18                                                         
         MVI   X#PAST,0                                                         
         OC    RQ_JDNAD,RQ_JDNAD                                                
         JNZ   JLSDLP24                                                         
         TM    X#JDSTAT,X#JDSTRE+X#JDSTSU+X#JDSTMA                              
         JZ    JLSDLP26            skip no filter or approved filter            
         MVI   X#PAST,YESQ         else use DRAPASD                             
                                                                                
         TM    SAVEIND,SAVEMST                                                  
         JZ    JLSDLP22                                                         
                                                                                
         TM    X#JDSTAT,X#JDSTAP   also approved?                               
         JZ    JLSDLP22                                                         
                                                                                
         OI    SAVEIND,SAVERL2     set to required lap 2                        
         NI    X#JDSTAT,FF-X#JDSTAP                                             
                                                                                
JLSDLP22 MVI   X#PTYP,REQTDRAQ                                                  
         J     EXITY                                                            
                                                                                
JLSDLP24 MVI   X#PAST,0                                                         
                                                                                
         STC   RF,RCTYPE                                                        
         MVI   X#HIGH,YESQ                                                      
         LLC   R1,X#CLVL                                                        
         SHI   R1,ACTKACT-ACTKCPY                                               
         STC   R1,X#CLVL                                                        
                                                                                
         L     R2,AIO7             buffer table to skip dupes                   
         LHI   R0,(L'IOAREA7+L'IOAREA8)/L'ACTKACT                               
         STH   R0,0(R2)                                                         
         MVI   2(R2),0                                                          
                                                                                
         MVI   X#TSAYN,YESQ                                                     
         MVI   X#PTYP,REQTSRCQ                                                  
                                                                                
         J     EXITY                                                            
                                                                                
JLSDLP26 NI    SAVEIND,FF-SAVEXDR  extra DRAPAS lap not required                
         LA    RE,PIDKJSAQ                                                      
         OC    X#PIDAP,X#PIDAP     approver or submitter?                       
         JNZ   JLSDLP30                                                         
         LA    RE,PIDKJSSQ                                                      
         OC    X#PIDSU,X#PIDSU                                                  
         JZ    JLSDLP34                                                         
         CLI   X#JDSTAT,0          no status or none approved status            
         JE    JLSDLP28            set then need DRAPASD lap, too               
         TM    X#JDSTAT,X#JDSTRE+X#JDSTSU+X#JDSTMA                              
         JZ    JLSDLP30                                                         
                                                                                
JLSDLP28 OI    SAVEIND,SAVEXDR                                                  
                                                                                
JLSDLP30 STC   RE,X#PAST                                                        
         XC    X#PID,X#PID                                                      
         MVC   X#PID,X#PIDAP                                                    
         CLI   X#PAST,PIDKJSAQ                                                  
         JE    JLSDLP32                                                         
         XC    X#PID,X#PID                                                      
         MVC   X#PID,X#PIDSU                                                    
                                                                                
JLSDLP32 MVI   X#PTYP,REQTPIDQ                                                  
         J     EXITY                                                            
                                                                                
JLSDLP34 TM    X#JDTPAS,X#JDTPCQ+X#JDTPOQ                                       
         JZ    EXITY               open/close date passives                     
                                                                                
         LLC   R0,X#JDTPAS         (save)                                       
         MVI   X#JDTPAS,0                                                       
         CLC   RQ_JDCLC,SPACES     unless single client specified               
         JH    EXITY                                                            
         STC   R0,X#JDTPAS         (restore)                                    
                                                                                
         GOTO1 VDATCON,DMCB,(1,X#CLOD),(2,X#PASSTA)                             
         GOTO1 VDATCON,DMCB,(1,X#CLOX),(2,X#PASEND)                             
                                                                                
         MVI   TMPJDTP,JDTPDTCQ                                                 
         TM    X#JDTPAS,X#JDTPCQ                                                
         JNZ   JLSDLP36                                                         
         MVI   TMPJDTP,JDTPDTOQ                                                 
                                                                                
         GOTO1 VDATCON,DMCB,(1,X#OPND),(2,X#PASSTA)                             
         GOTO1 VDATCON,DMCB,(1,X#OPNX),(2,X#PASEND)                             
                                                                                
JLSDLP36 MVI   X#TSAYN,YESQ                                                     
         MVI   X#PTYP,REQTJDTQ                                                  
         J     EXITY                                                            
                                                                                
**********************************************************************          
* Edit Brandocean estimate on job                                    *          
**********************************************************************          
         SPACE 1                                                                
EDTBEST  NTR1                                                                   
         LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),NOQ                                                        
         TM    0(R2),RSTSMCSE                                                   
         JZ    EDTBEST2                                                         
         MVI   0(R4),YESQ                                                       
EDTBEST2 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
**********************************************************************          
* Edit Job Lock from Estimates                                       *          
**********************************************************************          
         SPACE 1                                                                
EDTJLOS  NTR1                                                                   
         LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),NOQ                                                        
         TM    0(R2),RSTLSESQ          LOCKED FROM ESTIMATES                    
         JZ    EDTJLOS2                                                         
         MVI   0(R4),YESQ                                                       
EDTJLOS2 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
**********************************************************************          
* Edit Job lock from billing                                         *          
**********************************************************************          
         SPACE 1                                                                
EDTJLOB  NTR1                                                                   
         LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),NOQ                                                        
         TM    0(R2),RSTLSBIQ          LOCKED FROM BILLING                      
         JZ    EDTJLOB2                                                         
         MVI   0(R4),YESQ                                                       
EDTJLOB2 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
**********************************************************************          
* Edit job lock from Expenses                                        *          
**********************************************************************          
         SPACE 1                                                                
EDTJLOE  NTR1                                                                   
         LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),NOQ                                                        
         TM    0(R2),RSTLSEXQ          LOCKED FROM EXPENSES                     
         JZ    EDTJLOE2                                                         
         MVI   0(R4),YESQ                                                       
EDTJLOE2 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
**********************************************************************          
* Edit Job lock from orders                                          *          
**********************************************************************          
         SPACE 1                                                                
EDTJLOR  NTR1                                                                   
         LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),NOQ                                                        
         TM    0(R2),RSTLSESQ          LOCKED FROM ORDERS                       
         JZ    EDTJLOR2                                                         
         MVI   0(R4),YESQ                                                       
EDTJLOR2 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
**********************************************************************          
* Edit Job lock from adjustments                                     *          
**********************************************************************          
         SPACE 1                                                                
EDTJLOA  NTR1                                                                   
         LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),NOQ                                                        
         TM    0(R2),RSTLSADQ          LOCKED FROM ADJUSTMENTS                  
         JZ    EDTJLOA2                                                         
         MVI   0(R4),YESQ                                                       
EDTJLOA2 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
**********************************************************************          
* Edit Aura timesheet lock status                                    *          
**********************************************************************          
         SPACE 1                                                                
         USING RSTELD,R2                                                        
EDTJLOT  NTR1                                                                   
         LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),NOQ                                                        
         TM    SAVEIND,SAVEAUR         Aura - merge t/s lock status             
         JZ    EDTJLOT2                                                         
         TM    RSTSTAT5,RSTSNOTS                                                
         JZ    EDTJLOT2                                                         
         MVI   0(R4),YESQ                                                       
                                                                                
EDTJLOT2 TM    RSTLSTAT,RSTLSTIQ       LOCKED FROM TIMESHEETS                   
         JZ    *+8                                                              
         MVI   0(R4),YESQ                                                       
                                                                                
EDTJLOT4 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         DROP  R2                                                               
         EJECT                                                                  
**********************************************************************          
* Edit Job Revision Number                                           *          
**********************************************************************          
         SPACE 1                                                                
EDTJIDN  NTR1                                                                   
         LM    R2,R4,LP_AINP                                                    
         GOTO1 VHEXOUT,DMCB,0(R2),0(R4),L'JOBREVNO                              
         LHI   RE,L'JOBREVNO*2                                                  
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
*&&US                                                                           
**********************************************************************          
* Edit Expense Job indicator                                         *          
**********************************************************************          
         SPACE 1                                                                
EDTEXJB  NTR1                                                                   
         LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),NOQ                                                        
         TM    0(R2),JOBSXJOB                                                   
         JZ    EDTEXJB2                                                         
         MVI   0(R4),YESQ                                                       
EDTEXJB2 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
*&&                                                                             
**********************************************************************          
* Edit Master Job Indicator                                          *          
**********************************************************************          
         SPACE 1                                                                
EDTJMST  NTR1                                                                   
         LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),NOQ                                                        
         TM    0(R2),JOBSMST                                                    
         JZ    EDTJMST2                                                         
         MVI   0(R4),YESQ                                                       
EDTJMST2 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
**********************************************************************          
* Edit Job Lock indicator                                            *          
**********************************************************************          
         SPACE 1                                                                
EDTJOBL  NTR1                                                                   
         LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),NOQ                                                        
         TM    0(R2),ACTSLOCK                                                   
         JZ    EDTJOBL2                                                         
         MVI   0(R4),YESQ                                                       
EDTJOBL2 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
**********************************************************************          
* Get Account details                                                *          
**********************************************************************          
         SPACE 1                                                                
GETACNT  NTR1                                                                   
         L     R1,LP_AINP                                                       
         LR    R2,R1                                                            
                                                                                
         LLC   RF,PCLILEN                                                       
         BCTR  RF,0                                                             
         ST    R5,SAVER5                                                        
         BASR  R5,0                                                             
         MVC   JD_CLI(0),0(R2)                                                  
         EX    RF,0(R5)                                                         
         L     R5,SAVER5                                                        
                                                                                
         LLC   R1,PPROLEN                                                       
         LR    RF,R1                                                            
         LLC   R1,PCLILEN                                                       
         SR    RF,R1                                                            
         BCTR  RF,0                                                             
         LA    R1,0(R1,R2)                                                      
         ST    R5,SAVER5                                                        
         BASR  R5,0                                                             
         MVC   JD_PRO(0),0(R1)                                                  
         EX    RF,0(R5)                                                         
         L     R5,SAVER5                                                        
                                                                                
         LLC   R1,PPROLEN                                                       
         LA    RF,L'ACTKACT                                                     
         SR    RF,R1                                                            
         BCTR  RF,0                                                             
         LA    R1,0(R1,R2)                                                      
         ST    R5,SAVER5                                                        
         BASR  R5,0                                                             
         MVC   JD_JOB(0),0(R1)                                                  
         EX    RF,0(R5)                                                         
         MVC   JD_MED,0(R1)                                                     
         L     R5,SAVER5                                                        
                                                                                
         J     EXITY                                                            
         EJECT                                                                  
**********************************************************************          
* Get Last Activity Details                                          *          
**********************************************************************          
         SPACE 1                                                                
         USING ACTRECD,R2                                                       
GETLAD   NTR1                                                                   
         L     R2,AIO2                                                          
                                                                                
         USING PACELD,R3                                                        
         LA    R3,ACTRFST                                                       
         XR    R0,R0                                                            
         XC    JD_LAD,JD_LAD                                                    
         XC    JD_LAC,JD_LAC                                                    
         MVC   JD_LAF,SPACES                                                    
         MVC   JD_LAM,SPACES                                                    
         MVC   JD_LAL,SPACES                                                    
                                                                                
GETLAD02 CLI   PACEL,0                                                          
         JE    GETLAD10                                                         
         CLI   PACEL,RACELQ                                                     
         JE    GETLAD06                                                         
         CLI   PACEL,PACELQ                                                     
         JNE   GETLAD08                                                         
                                                                                
GETLAD04 OC    JD_LAX,JD_LAX                                                    
         JNZ   GETLAD08                                                         
         CLC   PACDATE,JD_LAD                                                   
         JNH   GETLAD08                                                         
         MVC   JD_LAD,PACDATE                                                   
         MVC   JD_LAC,PACPERS                                                   
         J     GETLAD08                                                         
                                                                                
         USING RACELD,R3                                                        
GETLAD06 LA    RE,JD_LAX                                                        
         CLI   RACTYPE,RACTCHA                                                  
         JNE   GETLAD08                                                         
         CLC   RACDATE,JD_LAD                                                   
         JNH   GETLAD08                                                         
         MVC   JD_LAD,RACDATE                                                   
         MVC   0(2,RE),RACPERS                                                  
                                                                                
         J     GETLAD08                                                         
                                                                                
GETLAD08 LLC   R0,RACLN                                                         
         AR    R3,R0                                                            
         J     GETLAD02                                                         
                                                                                
GETLAD10 MVC   SAVEKEY3,IOKEY                                                   
         MVC   TEMP2,SPACES                                                     
         OC    JD_LAX,JD_LAX                                                    
         JNZ   GETLAD12                                                         
                                                                                
         CLC   JD_LAC,SPACES                                                    
         JNH   GETLAD16                                                         
                                                                                
         MVC   TEMP2(L'JD_LAC),JD_LAC                                           
         J     GETLAD14                                                         
                                                                                
GETLAD12 MVC   TEMP2(L'RACPERS),JD_LAX                                          
         GOTOR (#GETPID,AGETPID)                                                
         JNE   GETLAD16                                                         
GETLAD14 GOTOR (#GETPIN,AGETPIN)                                                
                                                                                
         MVC   JD_LAF,TEMP2                                                     
         MVC   JD_LAL,WORK2                                                     
         MVC   JD_LAM,TEMP2+32                                                  
                                                                                
GETLAD16 MVC   IOKEY,SAVEKEY3                                                   
         J     EXITY                                                            
         DROP  R2,R3                                                            
*&&DO                                                                           
**********************************************************************          
* Edit Job Code                                                      *          
**********************************************************************          
         SPACE 1                                                                
EDTJOBC  NTR1                                                                   
         LM    R2,R4,LP_AINP                                                    
         LLC   R1,PPROLEN                                                       
         LA    RF,L'ACTKACT                                                     
         SR    RF,R1                                                            
         BCTR  RF,0                                                             
         LA    R1,0(R1,R2)                                                      
         ST    R5,SAVER5                                                        
         BASR  R5,0                                                             
         MVC   0(0,R4),0(R1)                                                    
         EX    RF,0(R5)                                                         
         L     R5,SAVER5                                                        
         AHI   RF,1                                                             
         LR    RE,RF                                                            
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
*&&                                                                             
***********************************************************************         
* Edit Campeign Name                                                  *         
***********************************************************************         
         SPACE                                                                  
         USING CPNPASD,R6                                                       
EDTCAMN  NTR1                                                                   
         LM    R2,R4,LP_AINP                                                    
                                                                                
         LA    R6,IOKEY                                                         
         XC    CPNPAS,CPNPAS                                                    
         MVI   CPNPTYP,CPNPTYPQ                                                 
         MVI   CPNPSUB,CPNPSUBQ                                                 
         MVC   CPNPCPY,CUXCPY                                                   
         MVC   CPNPCODE,0(R2)                                                   
         XC    CPNPCODE,=X'FFFFFFFF'                                            
         DROP  R6                                                               
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         JNE   *+2                                                              
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JNE   *+2                                                              
                                                                                
         USING NAMELD,R6                                                        
         L     R6,AIO1                                                          
         LA    R6,RWKRFST-RWKRECD(R6)                                           
         XR    R0,R0                                                            
         XR    R1,R1                                                            
                                                                                
EDTCAM02 CLI   NAMEL,NAMELQ                                                     
         JE    EDTCAM04                                                         
         CLI   NAMEL,0                                                          
         JE    EDTCAM06                                                         
         IC    R0,NAMLN                                                         
         AR    R6,R0                                                            
         J     EDTCAM02                                                         
                                                                                
EDTCAM04 LLC   R1,NAMLN                                                         
         SHI   R1,NAMLN1Q+1                                                     
         BASR  RE,0                                                             
         MVC   0(0,R4),NAMEREC                                                  
         EX    R1,0(RE)                                                         
                                                                                
EDTCAM06 STCM  R1,15,LP_OLEN                                                    
         J     EXITY                                                            
         DROP  R6                                                               
         EJECT                                                                  
***********************************************************************         
* Edit IFU Details                                                    *         
***********************************************************************         
         SPACE                                                                  
EDTIFU   NTR1                                                                   
         LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),NOQ                                                        
         TM    0(R2),ASTISFOR                                                   
         JZ    EDTIFU02                                                         
         MVI   0(R4),YESQ                                                       
EDTIFU02 LHI   RE,1                                                             
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
***********************************************************************         
* Get Office Name                                                     *         
***********************************************************************         
         SPACE 1                                                                
GETOFFD  NTR1                                                                   
         MVC   JD_OFF,X#POFF                                                    
         MVC   TEMP2,SPACES                                                     
         MVC   TEMP2(L'JD_OFF),X#POFF                                           
         GOTOR (#GETOFN,AGETOFN)                                                
         J     EXITY                                                            
         EJECT                                                                  
**********************************************************************          
* Get Media Name                                                     *          
**********************************************************************          
         SPACE 1                                                                
         USING PMDRECD,RE                                                       
GETMEDNM NTR1                                                                   
         LA    RE,IOKEY            read media code record                       
                                                                                
         CLC   JD_MED,PREVMEDC                                                  
         JNE   GETMDN02                                                         
         MVC   JD_MEN,PREVMENM                                                  
         MVC   X#MEDGRP,PREVMGRP                                                
         J     GETMDN08                                                         
                                                                                
GETMDN02 MVC   JD_MEN,SPACES                                                    
         MVC   PMDKEY,SPACES                                                    
         MVI   PMDKTYP,PMDKTYPQ                                                 
         MVC   PMDKCPY,CUXCPY                                                   
         MVC   PMDKMED,JD_MED                                                   
         MVI   X#MEDGRP,0                                                       
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JNE   GETMDN08                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JNE   *+2                                                              
                                                                                
         L     RE,AIO3                                                          
         LA    RE,PMDRFST                                                       
         USING PMDELD,RE                                                        
                                                                                
GETMDN04 CLI   PMDEL,PMDELQ                                                     
         JE    GETMDN06                                                         
         CLI   PMDEL,0                                                          
         JE    GETMDN08                                                         
         LLC   R0,PMDLN                                                         
         AR    RE,R0                                                            
         J     GETMDN04                                                         
                                                                                
GETMDN06 MVC   JD_MEN,PMDDESC                                                   
         MVC   X#MEDGRP,PMDGRP                                                  
         MVC   PREVMENM,PMDDESC                                                 
         MVC   PREVMGRP,PMDGRP                                                  
         MVC   PREVMEDC,JD_MED                                                  
                                                                                
GETMDN08 J     EXITY                                                            
         DROP  RE                                                               
         EJECT                                                                  
***********************************************************************         
* Get UFH Header and details                                          *         
***********************************************************************         
         SPACE 1                                                                
GETHDRDT NTR1                                                                   
         TM    SAVEIND,SAVEAUR                                                  
         JZ    EXITY                                                            
         CLI   X#UFLDH1,0          any Aura user field filters?                 
         JE    EXITY                                                            
         LA    R2,X#UFLDH1                                                      
         LA    R3,X#UFRET1                                                      
         LA    R4,JD_AUFH1                                                      
         LHI   R0,RQ_JDUMX                                                      
                                                                                
GETHDR02 CLI   0(R2),0             active/required entry?                       
         JE    GETHDR04                                                         
                                                                                
         LLC   R1,0(R3)            in which BLOCK slot is the data?             
         MHI   R1,L'UFSDESC                                                     
         L     RE,ABLOCK                                                        
         AR    R1,RE               pass down data                               
         MVC   0(L'JD_AUFH1,R4),0(R1)                                           
                                                                                
         LLC   R1,0(R3)            in which X#UFLS is the data?                 
         MHI   R1,L'X#UFLS                                                      
         LA    R1,X#UFLS(R1)       pass down data                               
         MVC   L'JD_AUFH1(L'JD_AUFD1,R4),0(R1)                                  
                                                                                
GETHDR04 AHI   R2,X#UFLDH2-X#UFLDH1                                             
         AHI   R3,X#UFRET2-X#UFRET1                                             
         AHI   R4,JD_AUFH2-JD_AUFH1                                             
         JCT   R0,GETHDR02                                                      
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Get Data from Option Record                                         *         
***********************************************************************         
         SPACE                                                                  
         USING OGRRECD,RE                                                       
GETOPTD  NTR1                                                                   
         LA    RE,IOKEY                                                         
         MVI   X#OFFGRP,0                                                       
         XC    OGRKEY,OGRKEY                                                    
         MVI   OGRKTYP,OGRKTYPQ                                                 
         MVI   OGRKSUB,OGRKOFFQ                                                 
         MVC   OGRKCPY,CUXCPY                                                   
         MVC   OGRKUNT(L'OGRKUNT+L'OGRKLDG),PRODUL                              
         MVC   OGRKOFC,X#POFF                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JNE   GETOPT06                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JNE   *+2                                                              
                                                                                
         L     RE,AIO3                                                          
         LA    RE,OGRRFST                                                       
         USING PGRELD,RE                                                        
         XR    R0,R0                                                            
GETOPT02 CLI   PGREL,0                                                          
         JE    GETOPT06                                                         
         CLI   PGREL,PGRELQ                                                     
         JE    GETOPT04                                                         
         IC    R0,PGRLN                                                         
         AR    RE,R0                                                            
         J     GETOPT02                                                         
                                                                                
GETOPT04 MVC   X#OFFGRP,PGRCODE                                                 
         DROP  RE                                                               
                                                                                
         USING GOBLOCKD,R3                                                      
GETOPT06 L     R3,AGOBLOCB                                                      
                                                                                
         XC    GOADM(GOABUFF-GOADM),GOADM                                       
         XC    GOADETS(GOACOVL-GOADETS),GOADETS                                 
                                                                                
         MVC   GOADM,VDATAMGR                                                   
         MVC   GOAEXT,AGOXBLCK                                                  
         MVC   GOABEXT,AGOBBLCK                                                 
         L     RE,ATWA                                                          
         LA    RE,2304+FALINKDL(RE)                                             
         ST    RE,GOABUFF                                                       
         L     RE,=AL4(TWAMAXRL-(FALINKDL+2304))                                
         ST    RE,GOLBUFF                                                       
         TM    LP_FLAG,LP_FOFFL                                                 
         JNZ   GETOPT08                                                         
*                                                                               
         MVC   GOABUFF,ATIA                                                     
         MVC   GOLBUFF,=AL4(TWAMAXRL)                                           
*                                                                               
GETOPT08 DS    0H                                                               
         L     RF,AIO2                                                          
         MVC   GOSELCUL,ACTKEY-ACTRECD(RF)                                      
         MVI   GOSELLEV,0                                                       
         MVC   GOSELCLI,SPACES                                                  
         LLC   RE,PCLILEN                                                       
         BCTR  RE,0                                                             
         BASR  R1,0                                                             
         MVC   GOSELCLI(0),JD_CLI                                               
         EX    RE,0(R1)                                                         
         MVC   GOSELPRO,SPACES                                                  
         CLC   JD_PRO,SPACES                                                    
         JNH   GETOPT10                                                         
         LLC   RF,PPROLEN                                                       
         LLC   RE,PCLILEN                                                       
         SR    RF,RE                                                            
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   GOSELPRO(0),JD_PRO                                               
         EX    RF,0(RE)                                                         
         CLC   JD_JOB,SPACES                                                    
         JNH   GETOPT10                                                         
         MVC   GOSELJOB,SPACES                                                  
         LLC   RF,PJOBLEN                                                       
         LLC   RE,PPROLEN                                                       
         SR    RF,RE                                                            
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   GOSELJOB(0),JD_JOB                                               
         EX    RF,0(RE)                                                         
         MVC   GOSELMED,JD_JOB                                                  
                                                                                
GETOPT10 DS    0H                                                               
*&&UK*&& LA    R1,TEMP             none emulated IOs + skip w/c level +         
*&&UK*&& ST    R1,GOADETS          TEMP+TEMP2 for extra details block           
                                                                                
         GOTOR SETXDB,DMCB,TEMP,0                                               
                                                                                
         OI    GOSPEC3,GOSPNERQ+GOSPSWLQ                                        
*&&UK*&& OI    GOSPEC3,GOSPXDPQ                                                 
*&&UK*&& MVC   GOSELOFC,JD_OFF                                                  
*&&UK*&& MVC   GOSELOG,X#OFFGRP                                                 
         CLC   JD_MED,SPACES                                                    
         JNH   *+10                                                             
         MVC   GOSELMED,JD_MED                                                  
         CLC   X#MEDGRP,SPACES                                                  
         JNH   *+10                                                             
         MVC   GOSELMG,X#MEDGRP                                                 
                                                                                
         LA    R1,SAVEKEY1                                                      
         ST    R1,GOAKEY                                                        
                                                                                
         MVC   GOCTRY,CUCTRY                                                    
         L     R1,ACOMFACS                                                      
                                                                                
         XC    GOACOVL,GOACOVL                                                  
         TM    LP_FLAG,LP_FOFFL    TEST OFFLINE                                 
         JZ    GETOPT12                                                         
         MVC   GOACOVL,VCOVAIL                                                  
                                                                                
GETOPT12 MVC   GOABINSR,CBINSRCH-COMFACSD(R1)                                   
                                                                                
         GOTO1 VGETOPT,DMCB,GOBLOCKD                                            
                                                                                
*&&UK                                                                           
         ZAP   JD_AMBR,GOCEAMBR                                                 
         ZAP   JD_RED,GOCERED                                                   
*&&                                                                             
         USING GOBBLKD,RF                                                       
         L     RF,AGOBBLCK         A(NEW BILLING EXTENSION)                     
*&&UK                                                                           
         CLC   GOBILCUR,AGYCURR                                                 
         JE    GETOPT14                                                         
         MVC   JD_CUR,GOBILCUR                                                  
*&&                                                                             
         USING GOXBLKD,RF                                                       
GETOPT14 L     RF,AGOXBLCK                                                      
         MVC   JD_DRFT,GODRFT                                                   
         MVC   JD_ESDR,GOAEDT                                                   
         MVC   JD_AUTO,GOAUTNUM                                                 
*&&US                                                                           
         ZAP   JD_AMBR,GOCEAMBR                                                 
         ZAP   JD_RED,GOCERED                                                   
*&&                                                                             
         DROP  RF,R3                                                            
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Get Job Status details                                              *         
***********************************************************************         
         SPACE                                                                  
         USING ACTRECD,R2                                                       
GETJSTA  NTR1                                                                   
         L     R1,LP_AINP                                                       
         LR    R2,R1                                                            
         MVC   JD_STA,=C'**A  N'   job status                                   
         TM    ACTRSTA,ACTSCLOS                                                 
         JZ    *+8                                                              
         MVI   JD_STA+0,C'C'                                                    
         TM    ACTRSTA,ACTSLOCK                                                 
         JZ    *+8                                                              
         MVI   JD_STA+1,C'L'                                                    
         TM    ACTRSTA,ACTSDRFT                                                 
         JZ    *+8                                                              
         MVI   JD_STA+2,C'D'       (draft)                                      
         CLI   X#JREJ,YESQ                                                      
         JNE   *+8                                                              
         MVI   JD_STA+2,C'R'       (or rejected)                                
         GOTO1 VHEXOUT,DMCB,X#JSRC,JD_STA+3,L'X#JSRC                            
                                                                                
GETSTA02 TM    ACTRSTA,ACTSDRFT                                                 
         JZ    EXITY                                                            
         TM    X#GAPIND,X#GAPIDQ   done already?                                
         JZ    GETSTA04                                                         
         TM    X#GAPIND,X#GAPIYQ   good return?                                 
         JZ    EXITY                                                            
         MVI   JD_STA+5,YESQ                                                    
         J     EXITY                                                            
                                                                                
GETSTA04 GOTOR GETAPP,DMCB,(2,ACTKACT),JD_OFF                                   
         JNE   EXITY                                                            
         MVI   JD_STA+5,YESQ                                                    
         J     EXITY                                                            
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* Set Record Status element length                                    *         
***********************************************************************         
         SPACE                                                                  
         USING JOBELD,R1                                                        
SETREJC  NTR1                                                                   
         L     R1,LP_AINP                                                       
         CLI   JOBLN,JOBLN3Q                                                    
         JL    SETREJC2                                                         
         MVC   X#JSRC,JOBSRCES                                                  
         TM    JOBSTA2,JOBSREJ                                                  
         JZ    SETREJC4                                                         
         MVI   X#JREJ,YESQ                                                      
         J     SETREJC6                                                         
SETREJC2 MVI   X#JSRC,0                                                         
         MVI   X#JREJ,NOQ                                                       
         J     SETREJC6                                                         
SETREJC4 MVI   X#JREJ,NOQ                                                       
SETREJC6 J     EXITY                                                            
         DROP  R1                                                               
         EJECT                                                                  
***********************************************************************         
* Set payment amount                                                  *         
***********************************************************************         
         SPACE                                                                  
         USING SCIELD,R1                                                        
SETPAY   NTR1                                                                   
         L     R1,LP_AINP                                                       
         CLI   SCITYPE,SCITCPAT                                                 
         JNE   EXITN                                                            
         ZAP   JD_PAYMT,SCIAMNT                                                 
         J     EXITY                                                            
         DROP  R1                                                               
         EJECT                                                                  
*                                                                               
***********************************************************************         
* Get Person Id details                                               *         
***********************************************************************         
         SPACE                                                                  
SETPIDN  NTR1                                                                   
         L     R1,LP_AINP                                                       
         MVC   TEMP2,SPACES                                                     
         MVC   TEMP2(L'RACPERS),0(R1)                                           
         GOTOR (#GETPID,AGETPID)                                                
         JNE   EXITN                                                            
SETPIDN2 GOTOR (#GETPIN,AGETPIN)                                                
         J     EXITY                                                            
                                                                                
***********************************************************************         
* Filter routines                                                     *         
***********************************************************************         
TSTRADD  NTR1                                                                   
         L     R4,LP_AINP                                                       
         CLI   RACTYPE-RACEL(R4),RACTADD                                        
         JNE   EXITN                                                            
         J     EXITY                                                            
                                                                                
TSTRAPP  NTR1                                                                   
         L     R4,LP_AINP                                                       
         CLI   RACTYPE-RACEL(R4),RACTAPP                                        
         JNE   EXITN                                                            
         J     EXITY                                                            
                                                                                
TSTRWNCL NTR1                                                                   
         CLI   RQ_JDTYP,RQ_JDTNQ                                                
         JH    EXITN                                                            
         J     EXITY                                                            
                                                                                
TSTSCFEE NTR1                                                                   
         L     R4,LP_AINP                                                       
         CLI   SCITYPE-SCIEL(R4),SCITFEEB                                       
         JNE   EXITN                                                            
         J     EXITY                                                            
                                                                                
TSTSCPAT NTR1                                                                   
         CLI   RQ_JDPAY,YESQ                                                    
         JNE   EXITN                                                            
         OC    CPXJBOSP,CPXJBOSP   Do we have job open date control             
         JZ    EXITY                                                            
         GOTOR VDATCON,DMCB,(1,X#JBOPDP),(2,X#JBOPDC)                           
         CLC   X#JBOPDC,CPXJBOSP                                                
         JL    EXITN                                                            
         J     EXITY                                                            
                                                                                
TSTSCCOM NTR1                                                                   
         L     R4,LP_AINP                                                       
         CLI   SCITYPE-SCIEL(R4),SCITCOMM                                       
         JNE   EXITN                                                            
         J     EXITY                                                            
                                                                                
TSTSMACC L     R4,LP_AINP                                                       
         CLI   SPATYPE-SPAEL(R4),SPATMJOB                                       
         BR    RE                                                               
                                                                                
TSTUFS   TM    SAVEIND,SAVEAUR                                                  
         BR    RE                                                               
                                                                                
TSTJOBL  NTR1                                                                   
         L     R4,LP_AINP                                                       
         CLI   JOBLN-JOBEL(R4),JOBLN2Q                                          
         JL    EXITN                                                            
         J     EXITY                                                            
                                                                                
TSTJOBL1 NTR1                                                                   
         L     R4,LP_AINP                                                       
         CLI   JOBLN-JOBEL(R4),JOBLN3Q                                          
         JL    EXITN                                                            
         J     EXITY                                                            
                                                                                
TSTJOBL2 NTR1                                                                   
         L     R4,LP_AINP                                                       
         CLI   JOBLN-JOBEL(R4),JOBLN1Q                                          
         JNH   EXITY                                                            
         MVC   X#JBOPDP,JOBADATE-JOBEL(R4)                                      
         CLC   JOBODATE-JOBEL(L'JOBODATE,R4),SPACES                             
         JNH   EXITY                                                            
         J     EXITN                                                            
                                                                                
TSTJOBL3 NTR1                                                                   
         L     R4,LP_AINP                                                       
         CLI   JOBLN-JOBEL(R4),JOBLN1Q                                          
         JNH   EXITN                                                            
         CLC   JOBODATE-JOBEL(L'JOBODATE,R4),SPACES                             
         JNH   EXITN                                                            
         MVC   X#JBOPDP,JOBODATE-JOBEL(R4)                                      
         J     EXITY                                                            
                                                                                
TSTRLN3Q NTR1                                                                   
         L     R4,LP_AINP                                                       
         CLI   RSTLN-RSTEL(R4),RSTLN3Q                                          
         JL    EXITN                                                            
         J     EXITY                                                            
                                                                                
TSTRFFTP NTR1                                                                   
         L     R4,LP_AINP                                                       
         CLI   FFTTYPE-FFTEL(R4),FFTTCAMP                                       
         JNE   EXITN                                                            
         J     EXITY                                                            
                                                                                
TSTLAP2  NTR1                                                                   
         CLI   X#LAPSW2,YESQ                                                    
         JE    EXITY                                                            
         J     EXITN                                                            
                                                                                
TSTLAPS  NTR1                                                                   
         CLI   X#LAPSW1,YESQ                                                    
         JE    EXITY                                                            
         CLI   X#LAPSW2,YESQ                                                    
         JE    EXITY                                                            
         J     EXITN                                                            
***********************************************************************         
* Edit work code rec - Status                                         *         
***********************************************************************         
         SPACE 1                                                                
EDTINEX  NTR1  LABEL=*                                                          
         LM    R2,R4,LP_AINP                                                    
                                                                                
         MVI   0(R4),QWCSTCOS                                                   
         TM    0(R2),WCOSHCOE          Cost or time workcode                    
         JZ    EDTINEXX                                                         
         MVI   0(R4),QWCSTTIM                                                   
                                                                                
EDTINEXX LHI   RE,LENONE                                                        
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Edit work code rec - artist flag                                    *         
***********************************************************************         
         SPACE 1                                                                
EDTART   NTR1  LABEL=*                                                          
         LM    R2,R4,LP_AINP                                                    
                                                                                
         MVI   0(R4),NOQ                                                        
         TM    0(R2),WCOSART           Artist                                   
         JZ    EDTARTX                                                          
         MVI   0(R4),YESQ                                                       
                                                                                
EDTARTX  LHI   RE,LENONE                                                        
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Edit work code rec - Billable                                                 
***********************************************************************         
         SPACE 1                                                                
*                                                                               
EDTBILA  NTR1  LABEL=*                                                          
         LM    R2,R4,LP_AINP                                                    
*                                                                               
         LA    R0,3                                                             
         MVI   0(R4),NOQ                                                        
EDTBIL10 DS    0H                                                               
         CLI   0(R2),OWCBLABL                                                   
         JNE   EDTBIL20                                                         
         MVI   0(R4),YESQ              BILLABLE                                 
         J     EDTBILX                                                          
EDTBIL20 LA    R2,1(R2)                                                         
         JCT   R0,EDTBIL10                                                      
                                                                                
EDTBILX  LHI   RE,LENONE                                                        
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
*                                                                               
         EJECT                                                                  
***********************************************************************         
* Edit work code rec - CHARGEABLE                                     *         
***********************************************************************         
         SPACE 1                                                                
*                                                                               
EDTCHRA  NTR1  LABEL=*                                                          
         LM    R2,R4,LP_AINP                                                    
*                                                                               
         LA    R0,3                                                             
         MVI   0(R4),NOQ                                                        
EDTCHR10 DS    0H                                                               
         CLI   0(R2),OWCCHARG                                                   
         JNE   EDTCHR20                                                         
         MVI   0(R4),YESQ              CHARGEABLE                               
         J     EDTCHRX                                                          
EDTCHR20 LA    R2,1(R2)                                                         
         JCT   R0,EDTCHR10                                                      
                                                                                
EDTCHRX  LHI   RE,LENONE                                                        
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
*                                                                               
         EJECT                                                                  
***********************************************************************         
* Edit work code rec - Non-billable                                   *         
***********************************************************************         
         SPACE 1                                                                
*                                                                               
EDTNBIL  NTR1  LABEL=*                                                          
         LM    R2,R4,LP_AINP                                                    
*                                                                               
         LA    R0,3                                                             
         MVI   0(R4),NOQ                                                        
EDTNBL10 DS    0H                                                               
         CLI   0(R2),OWCNBIL                                                    
         JNE   EDTNBL20                                                         
         MVI   0(R4),YESQ              NON-BILLABLE                             
         J     EDTNBLX                                                          
EDTNBL20 LA    R2,1(R2)                                                         
         JCT   R0,EDTNBL10                                                      
                                                                                
EDTNBLX  LHI   RE,LENONE                                                        
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
*                                                                               
         EJECT                                                                  
***********************************************************************         
* Edit work code Rec - Orders - IAC income/suspense account           *         
***********************************************************************         
         SPACE 1                                                                
                                                                                
EDTOINV  NTR1  LABEL=*                                                          
         LM    R2,R4,LP_AINP                                                    
         MVC   0(L'GOINCAC-1,R4),0(R2)                                          
*&&UK                                                                           
         USING GOXBLKD,R3                                                       
         L     R3,AGOXBLCK                                                      
                                                                                
         CLI   GOICRA,GOIWCSK                                                   
         JNE   EDTOINVX                                                         
         MVC   0(L'GOINCAC-1,R4),SPACES                                         
         MVC   0(L'SKQ,R4),SKQ                                                  
*&&                                                                             
EDTOINVX LHI   RE,L'GOINCAC-1                                                   
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
                                                                                
         EJECT                                                                  
***********************************************************************         
* Edit work code rec - Expense account required ?                     *         
***********************************************************************         
         SPACE 1                                                                
*&&UK                                                                           
*                                                                               
EDTEXST  NTR1  LABEL=*                                                          
         LM    R2,R4,LP_AINP                                                    
                                                                                
         TM    0(R2),WCOSEAUJ+WCOSEABJ                                          
         JZ    EDTEXSTX                                                         
         JNO   EDTXST10                                                         
         MVI   0(R4),OWCEXAL                                                    
         J     EDTEXSTX                                                         
EDTXST10 TM    0(R2),WCOSEAUJ          Estimate check                           
         JZ    EDTXST20                                                         
         MVI   0(R4),OWCEXUL                                                    
         J     EDTEXSTX                                                         
EDTXST20 TM    0(R2),WCOSEABJ          Estimate check                           
         JZ    EDTEXSTX                                                         
         MVI   0(R4),OWCEXBL                                                    
                                                                                
EDTEXSTX LHI   RE,LENONE                                                        
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
*&&                                                                             
         EJECT                                                                  
***********************************************************************         
* Edit work code Rec - available FOR third party use ?                *         
***********************************************************************         
         SPACE 1                                                                
                                                                                
EDTTHRU  NTR1  LABEL=*                                                          
         LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),NOQ                                                        
*&&US*&& TM    0(R2),WCOSTHRD   - W/C available for third party use             
*&&UK*&& TM    0(R2),WCOKTHRD   - W/C available for third party use             
         JZ    EDTTHRUX                                                         
         MVI   0(R4),YESQ                                                       
                                                                                
EDTTHRUX LHI   RE,LENONE                                                        
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
                                                                                
         EJECT                                                                  
***********************************************************************         
* Edit work code rec - Estimate check required?                       *         
***********************************************************************         
         SPACE 1                                                                
EDTESTC  NTR1  LABEL=*                                                          
         LM    R2,R4,LP_AINP                                                    
                                                                                
         MVI   0(R4),YESQ                                                       
*&&UK                                                                           
         TM    0(R2),WCOSESCK          Estimate check                           
         JZ    EDTESTCX                                                         
         MVI   0(R4),NOQ                                                        
*&&                                                                             
                                                                                
EDTESTCX LHI   RE,LENONE                                                        
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
                                                                                
***********************************************************************         
* Edit Email Notification :- ALWAYS TRUE                              *         
***********************************************************************         
         SPACE 1                                                                
EDTENTF  NTR1  LABEL=*                                                          
         L     R4,LP_AOUT                                                       
*                                                                               
         MVI   0(R4),YESQ                                                       
*                                                                               
EDTENTFX LHI   RE,LENONE                                                        
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
                                                                                
***********************************************************************         
* Edit Email Notification status                                      *         
***********************************************************************         
         SPACE 1                                                                
EDTEAST  NTR1  LABEL=*                                                          
         LM    R2,R4,LP_AINP                                                    
         MVI   0(R4),EMPTY                                                      
*                                                                               
         CLI   QTETY,QTET1Q            O/P approval status for expenses         
         JNE   EDTEST10                                                         
         MVI   0(R4),OTPNOAP                                                    
         TM    0(R2),CIDAAPP           Approved?                                
         JZ    EDTEST00                                                         
         MVI   0(R4),OTPAPPRV                                                   
         J     EDTEASTX                                                         
EDTEST00 TM    0(R2),CIDAREJ           Rejected?                                
         JZ    EDTEST10                                                         
         MVI   0(R4),OTPREJ                                                     
         J     EDTEASTX                                                         
*                                                                               
EDTEST10 CLI   QTETY,QTET2Q            Output approval status for time          
         JNE   EDTEASTX                                                         
         MVI   0(R4),OTPNOAP                                                    
         TM    0(R2),TIMASAPR          Approved?                                
         JZ    EDTEST20                                                         
         MVI   0(R4),OTPAPPRV                                                   
         J     EDTEASTX                                                         
EDTEST20 TM    0(R2),TIMASREJ          Rejected?                                
         JZ    EDTEASTX                                                         
         MVI   0(R4),OTPREJ                                                     
*                                                                               
EDTEASTX LHI   RE,LENONE                                                        
         STCM  RE,15,LP_OLEN                                                    
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Edit out default workcode                                           *         
***********************************************************************         
         SPACE 1                                                                
EDTDFT   LM    R2,R4,LP_AINP                                                    
         LHI   RE,LENONE                                                        
         STCM  RE,15,LP_OLEN                                                    
         MVI   0(R4),NOQ                                                        
         CLC   X#DFWC,0(R2)                                                     
         JNE   EXITY                                                            
         MVI   0(R4),YESQ                                                       
         J     EXITY                                                            
         EJECT                                                                  
SVRDEF   CSECT ,                                                                
***********************************************************************         
* Get job audit values and download                                   *         
***********************************************************************         
                                                                                
REQJAUD  LKREQ H,A#JAUD,OUTJAUD,NEXTREQ=REQJAPP                                 
                                                                                
JOBC     LKREQ F,01,(D,B#SAVED,RQ_JAACT),CHAR,OLEN=L'RQ_JAACT,         +        
               MAXLEN=L'RQ_JAACT,TEXT=AC#JOBC,COL=*                             
                                                                                
UL       LKREQ F,02,(D,B#SAVED,RQ_JAUL),CHAR,OLEN=L'RQ_JAUL,           +        
               MAXLEN=L'RQ_JAUL,TEXT=AC#UNTLD,COL=*                             
                                                                                
OFFC     LKREQ F,03,(D,B#SAVED,RQ_JAOFF),CHAR,OLEN=L'RQ_JAOFF,         +        
               MAXLEN=L'RQ_JAOFF,TEXT=AC#OFFC,COL=*                             
                                                                                
         LKREQ E                                                                
                                                                                
OUTJAUD  LKOUT H                                                                
                                                                                
AUDREC   LKOUT R,R#JAUD            AUDIT RECORD                                 
Array    LKOUT C,R#JAUD,(A,ARYAUD)                                              
Array    LKOUT C,R#JAUD,(A,ARYRAUD),FILTROUT=TSTRAUD                            
         LKOUT E                                                                
                                                                                
         LKOUT X                                                                
                                                                                
ARYAUD   LKOUT A,(R,NXTAUD),ROWNAME=AUDRECD                                     
                                                                                
Array    LKOUT C,R#JAUD,(A,ARYSTC),FILTROUT=TSTAUD                              
                                                                                
         LKOUT E                                                                
                                                                                
ARYSTC   LKOUT A,(D,B#AUD,AUDRFST),EOT=EOR,ROWID=(STCELD,STCELQ),      +        
               ROWWIDTH=(V,STCLN),NEWEL=B                                       
                                                                                
DATE     LKOUT C,03,STCDATE,PDAT,ND=Y                                           
TIME     LKOUT C,04,STCELD,(R,EDTTIME),CHAR,ND=Y                                
USID     LKOUT C,05,STCUSER,(U,#EDTUSR,$EDTUSR),ND=Y                            
PCOD     LKOUT C,06,STCPERS,(U,#EDTPID,$EDTPID),ND=Y                            
PRout    LKOUT P,,SETNAME                                                       
PFNA     LKOUT C,07,(D,B#WORKD,TEMP2),CHAR,LEN=PFNL,ND=Y                        
PLNA     LKOUT C,08,(D,B#WORKD,WORK2),CHAR,LEN=PLNL                             
COMM     LKOUT C,09,STCELD,(R,EDTCOMM),CHAR,ND=Y,                      +        
               FILTROUT=TSTROUT                                                 
PMNA     LKOUT C,10,(D,B#WORKD,TEMP2+32),CHAR,LEN=PFNL,ND=Y                     
PRout    LKOUT P,STCELD,SETSTCST                                                
TYPE     LKOUT C,11,(D,B#WORKD,TEMP2+32),LBIN,LEN=STAL,ND=Y                     
STAT     LKOUT C,12,STCASTA,CHAR,ND=Y,LEN=STAL,FILTROUT=TSTROUT                 
ACTN     LKOUT C,13,(D,B#WORKD,TEMP2),LBIN,LEN=STAL,ND=Y                        
PRout    LKOUT P,STCELD,SETDATA                                                 
DATA     LKOUT C,14,STCELD,(R,EDTAACT),CHAR,ND=Y,FILTROUT=TSTAACT               
DATA     LKOUT C,14,STCELD,(R,EDTDATA1),CHAR,ND=Y,FILTROUT=TSTDATA1             
DATA     LKOUT C,14,STCELD,(R,EDTCLIT),CHAR,ND=Y,FILTROUT=TSTCLIT               
DATA     LKOUT C,14,STCELD,(R,EDTLKJB),CHAR,ND=Y,FILTROUT=TSTLKJB               
DATA     LKOUT C,14,STCELD,(R,EDTCLPO),CHAR,ND=Y,FILTROUT=TSTCLPO               
DATA     LKOUT C,14,STCASECY,CHAR,ND=Y,FILTROUT=TSTSECY                         
DATA     LKOUT C,14,STCADWC,CHAR,ND=Y,FILTROUT=TSTDFWC                          
DATA     LKOUT C,14,STCAOFF,CHAR,ND=Y,FILTROUT=TSTAOFF                          
DATA     LKOUT C,14,STCAPRB,CHAR,ND=Y,FILTROUT=TSTPRTB                          
DATA     LKOUT C,14,STCAMED,CHAR,ND=Y,FILTROUT=TSTMEDC                          
DATA     LKOUT C,14,STCAPRO,CHAR,ND=Y,FILTROUT=TSTPROC                          
*&&US                                                                           
DATA     LKOUT C,14,STCASTUC,CHAR,ND=Y,FILTROUT=TSTSTUC                         
DATA     LKOUT C,14,STCASTUL,CHAR,ND=Y,FILTROUT=TSTSTUL                         
*&&                                                                             
ARRAY    LKOUT C,14,(A,ARYDESC),FILTROUT=TSTDATA2,EOT=EOR                       
DATA     LKOUT C,14,STCELD,(R,EDTDATE),FILTROUT=TSTDATE                         
DATA     LKOUT C,14,STCASTA,CHAR,ND=Y,FILTROUT=TSTSTA2                          
DATA     LKOUT C,14,STCAAMNT,(R,EDTAMT),FILTROUT=TSTAMT                         
PRout    LKOUT P,STCELD,SETAPPL                                                 
APPL     LKOUT C,15,(D,B#WORKD,TEMP2),HEXD,LEN=STAL,ND=Y                        
                                                                                
         LKOUT E                                                                
                                                                                
ARYDESC  LKOUT A,(R,NXTDESC),ROWNAME=DESCTAB,NEWEL=N,                  +        
               ROWWIDTH=(V,DESCLEN),ROWID=(DESCIDN,DESCIDNA)                    
DATA     LKOUT C,14,DESCDATA,CHAR,LEN=V,ND=Y                                    
                                                                                
         LKOUT E                                                                
***********************************************************************         
* OLD AUDIT RECORDS                                                   *         
***********************************************************************         
ARYRAUD  LKOUT A,(R,NXTRAUD),ROWNAME=ACTRECD                                    
                                                                                
Array    LKOUT C,R#JAUD,(A,ARYRAC)                                              
Array    LKOUT C,R#JAUD,(A,ARYSTC2)                                             
                                                                                
         LKOUT E                                                                
                                                                                
ARYRAC   LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,ROWID=(RACELD,RACELQ),   +        
               ROWWIDTH=(V,RACLN),NEWEL=B                                       
                                                                                
Prout    LKOUT P,RACTYPE,SETTYPE                                                
DATE     LKOUT C,03,RACDATE,PDAT,ND=Y,FILTROUT=TSTRAC1,SKIPCOLS=RACSKPS         
                                                                                
RACSKIP  EQU   *                                                                
                                                                                
TIME     LKOUT C,04,RACTIME,SPAK,ND=Y                                           
USID     LKOUT C,05,RACUSER,(U,#EDTUSR,$EDTUSR),ND=Y                            
PCOD     LKOUT C,06,RACPERS,(U,#EDTPID,$EDTPID),ND=Y                            
PRout    LKOUT P,,SETNAME                                                       
PFNA     LKOUT C,07,(D,B#WORKD,TEMP2),CHAR,LEN=PFNL,ND=Y                        
PLNA     LKOUT C,08,(D,B#WORKD,WORK2),CHAR,LEN=PLNL                             
PMNA     LKOUT C,10,(D,B#WORKD,TEMP2+32),CHAR,LEN=PFNL,ND=Y                     
PRout    LKOUT P,RACELD,SETACTN                                                 
ACTN     LKOUT C,13,(D,B#WORKD,TEMP2),LBIN,LEN=STAL,ND=Y                        
APPL     LKOUT C,15,(D,B#WORKD,WORK2),HEXD,LEN=STAL,ND=Y                        
                                                                                
RACSKPS  EQU   (*-RACSKIP)/LX_COLSL                                             
                                                                                
Array    LKOUT C,R#JAUD,(A,ARYSTC2),FILTROUT=TSTSTC2                            
                                                                                
         LKOUT E                                                                
                                                                                
ARYSTC2  LKOUT A,(D,B#ACTREC,ACTRFST),EOT=EOR,ROWID=(STCELD,STCELQ),   +        
               ROWWIDTH=(V,STCLN),NEWEL=B                                       
DATE     LKOUT C,03,STCDATE,PDAT,ND=Y                                           
TIME     LKOUT C,04,STCELD,(R,EDTTIME),CHAR,ND=Y                                
USID     LKOUT C,05,STCUSER,(U,#EDTUSR,$EDTUSR),ND=Y                            
PCOD     LKOUT C,06,STCPERS,(U,#EDTPID,$EDTPID),ND=Y                            
PRout    LKOUT P,,SETNAME                                                       
PFNA     LKOUT C,07,(D,B#WORKD,TEMP2),CHAR,LEN=PFNL,ND=Y                        
PLNA     LKOUT C,08,(D,B#WORKD,WORK2),CHAR,LEN=PLNL                             
COMM     LKOUT C,09,STCELD,(R,EDTCOMM),CHAR,ND=Y,                      +        
               FILTROUT=TSTROUT                                                 
PMNA     LKOUT C,10,(D,B#WORKD,TEMP2+32),CHAR,LEN=PFNL,ND=Y                     
                                                                                
         LKOUT E                                                                
                                                                                
***********************************************************************         
* AUDIT RECORD ROUTINES                                               *         
***********************************************************************         
                                                                                
         USING AUDRECD,R2                                                       
NXTAUD   ST    R8,LP_ADATA                                                      
         MVI   XAUDTYP,YESQ                                                     
         CLI   LP_RMODE,LP_RFRST                                                
         JNE   XJAUD10                                                          
         MVI   CHKBYTE1,0                                                       
         OC    RQ_JAACT,SPACES                                                  
         CLC   RQ_JAACT,SPACES                                                  
         JH    XJAUD10                                                          
         MVC   LP_ERROR,=AL2(AE$MSJOB)                                          
         J     QERROR                                                           
*                                                                               
XJAUD10  MVC   LP_ADATA,AIO2                                                    
         MVI   CHKDATA1,NOQ                                                     
         GOTOR (#NXTREC,ANXTREC),DMCB,AUDKEYT,('B#AUD',0),             +        
               ('$NXTRXAD',SAVED),0,0                                           
         JE    EXITY                                                            
*                                                                               
         CLI   CHKBYTE1,1          Is all audit info here                       
         JE    EXITN               Yes - exit                                   
*                                                                               
         MVI   XAUDTYP,NOQ         No - look on account record                  
         J     EXITN                                                            
                                                                                
***********************************************************************         
* AUDIT RECORD ROUTINES - determine history first                     *         
***********************************************************************         
                                                                                
NXTRAUD  MVC   LP_ADATA,AIO2                                                    
         GOTOR (#NXTREC,ANXTREC),DMCB,ACTKEYT2,('B#ACTREC',0),         +        
               ('$NXTRXAD',SAVED),0,0                                           
         JE    EXITY                                                            
*                                                                               
         MVC   LP_ERROR,=AL2(AE$INJOB)   Invalid Job Id                         
         J     QERROR                                                           
                                                                                
         EJECT                                                                  
***********************************************************************         
         USING RACELD,R2                                                        
SETACTN  NTR1  ,                                                                
         L     R2,LP_AINP                                                       
         XC    TEMP2,TEMP2                                                      
         XC    WORK2,WORK2                                                      
         CLI   RACTYPE,RACTCHA    change?                                       
         JE    SETACT10                                                         
*                                                                               
         MVI   TEMP2,STCACADD                                                   
         NI    TEMP2,X'0F'                                                      
*                                                                               
SETACT10 MVI   WORK2,STCAAURA      Set to DS Spectra                            
         CLI   RACAPPL,RACAURAQ    Completed in Aura                            
         JE    SETACTNX                                                         
         MVI   WORK2,STCABRON                                                   
         CLI   RACAPPL,RACBRONQ    Completed in BrandOcean                      
         JE    SETACTNX                                                         
         MVI   WORK2,STCADSSP      Set to DS Spectra                            
*                                                                               
SETACTNX J     EXITY                                                            
*                                                                               
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
         USING AUDRECD,R2                                                       
SETSTCST L     R3,LP_AINP                                                       
         USING STCELD,R3                                                        
         XC    WORK2,WORK2                                                      
         MVC   TEMP2+32(L'STCASTA),SPACES                                       
         CLI   STCIND,STCIACT     Check accounting STCELs                       
         JNE   EXIT                                                             
         MVC   TEMP2+32(L'STCATYP),STCATYP                                      
         CLI   STCATYP,STCACLIT   Temporary code to convert                     
         JE    *+12               client and product teams to job level         
         CLI   STCATYP,STCAPROT                                                 
         JNE   *+8                                                              
         MVI   TEMP2+32,STCAJOBT                                                
         MVC   TEMP2(L'STCASTAT),STCASTAT                                       
         NI    TEMP2,X'0F'                                                      
SETSTCX  J     EXITY                                                            
         DROP  R3                                                               
                                                                                
***********************************************************************         
TSTRAC1  NTR1  ,                                                                
         CLI   RCTYPE,RACTADD                                                   
         JE    EXITY                                                            
         CLI   RCTYPE,RACTCHA                                                   
         JE    EXITY                                                            
         J     EXITN                                                            
                                                                                
***********************************************************************         
TSTSTC2  NTR1  ,                                                                
         CLI   RCTYPE,RACTAPP      wrong, base it on other things               
         J     EXIT                                                             
                                                                                
***********************************************************************         
TSTAUD   NTR1  ,                                                                
         CLI   XAUDTYP,AUDRECQ                                                  
         J     EXIT                                                             
                                                                                
***********************************************************************         
TSTRAUD  NTR1  ,                                                                
         CLI   XAUDTYP,ACTRECQ                                                  
         J     EXIT                                                             
                                                                                
***********************************************************************         
TSTROUT  L     R3,LP_AINP                                                       
         USING STCELD,R3                                                        
         CLI   STCATYP,STCAAPST                                                 
         J     EXIT                                                             
         DROP  R3                                                               
***********************************************************************         
TSTAACT  LAY   R1,VALAACT                                                       
         L     R3,LP_AINP                                                       
         USING STCELD,R3                                                        
TSTAACA  CLC   STCATYP,0(R1)                                                    
         JE    EXITY                                                            
         LA    R1,1(R1)                                                         
         CLI   0(R1),X'FF'                                                      
         JNE   TSTAACA                                                          
         J     EXITN                                                            
         DROP  R3                                                               
***********************************************************************         
TSTDATA1 CLI   CHKDATA,YESQ                                                     
         BR    RE                                                               
***********************************************************************         
TSTDATA2 CLI   CHKDATA1,YESQ                                                    
         JE    EXITY                                                            
         J     EXITN                                                            
***********************************************************************         
* Check that audit element contains an amount                         *         
***********************************************************************         
TSTAMT   L     R3,LP_AINP                                                       
         LAY   R1,VALAMT                                                        
         USING STCELD,R3                                                        
TSTAMT2  CLC   STCATYP,0(R1)                                                    
         BER   RE                                                               
         AHI   R1,1                                                             
         CLI   0(R1),X'FF'                                                      
         JNE   TSTAMT2                                                          
         J     EXITN                                                            
***********************************************************************         
TSTSTA2  LAY   R1,VALSTA2                                                       
         L     R3,LP_AINP                                                       
         USING STCELD,R3                                                        
TSTSTA1  CLC   STCATYP,0(R1)                                                    
         JE    EXITY                                                            
         LA    R1,1(R1)                                                         
         CLI   0(R1),X'FF'                                                      
         JNE   TSTSTA1                                                          
         J     EXITN                                                            
         DROP  R3                                                               
***********************************************************************         
TSTDATE  L     R3,LP_AINP                                                       
         USING STCELD,R3                                                        
         CLI   STCATYP,STCAOPDT                                                 
         JE    EXITY                                                            
         CLI   STCATYP,STCACLDT                                                 
         JE    EXITY                                                            
         J     EXITN                                                            
         DROP  R3                                                               
***********************************************************************         
TSTCLIT  L     R3,LP_AINP                                                       
         USING STCELD,R3                                                        
         CLI   STCATYP,STCAJOBT                                                 
         JE    EXITY                                                            
         CLI   STCATYP,STCACLIT                                                 
         JE    EXITY                                                            
         CLI   STCATYP,STCAPROT                                                 
         JE    EXITY                                                            
         J     EXITN                                                            
         DROP  R3                                                               
***********************************************************************         
TSTCLPO  L     R3,LP_AINP                                                       
         USING STCELD,R3                                                        
         CLI   STCATYP,STCACLPO                                                 
         JE    EXITY                                                            
         J     EXITN                                                            
         DROP  R3                                                               
***********************************************************************         
TSTLKJB  L     R3,LP_AINP                                                       
         USING STCELD,R3                                                        
         CLI   STCATYP,STCALKJB                                                 
         JE    EXITY                                                            
         J     EXITN                                                            
         DROP  R3                                                               
***********************************************************************         
TSTSECY  L     R3,LP_AINP                                                       
         USING STCELD,R3                                                        
         CLI   STCATYP,STCASEC                                                  
         JE    EXITY                                                            
         J     EXITN                                                            
         DROP  R3                                                               
***********************************************************************         
TSTDFWC  L     R3,LP_AINP                                                       
         USING STCELD,R3                                                        
         CLI   STCATYP,STCADFWC                                                 
         JE    EXITY                                                            
         J     EXITN                                                            
         DROP  R3                                                               
***********************************************************************         
TSTAOFF  L     R3,LP_AINP                                                       
         USING STCELD,R3                                                        
         CLI   STCATYP,STCAGLOF                                                 
         JE    EXITY                                                            
         J     EXITN                                                            
         DROP  R3                                                               
***********************************************************************         
TSTPRTB  L     R3,LP_AINP                                                       
         USING STCELD,R3                                                        
         CLI   STCATYP,STCAPRTB                                                 
         JE    EXITY                                                            
         J     EXITN                                                            
         DROP  R3                                                               
***********************************************************************         
TSTMEDC  L     R3,LP_AINP                                                       
         USING STCELD,R3                                                        
         CLI   STCATYP,STCAMEDC                                                 
         JE    EXITY                                                            
         J     EXITN                                                            
         DROP  R3                                                               
***********************************************************************         
TSTPROC  L     R3,LP_AINP                                                       
         USING STCELD,R3                                                        
         CLI   STCATYP,STCAPROC                                                 
         JE    EXITY                                                            
         CLI   STCATYP,STCAJOBC                                                 
         JE    EXITY                                                            
         J     EXITN                                                            
         DROP  R3                                                               
***********************************************************************         
*&&US                                                                           
TSTSTUC  L     R3,LP_AINP                                                       
         USING STCELD,R3                                                        
         CLI   STCATYP,STCASTUT                                                 
         JE    EXITY                                                            
         J     EXITN                                                            
         DROP  R3                                                               
***********************************************************************         
TSTSTUL  L     R3,LP_AINP                                                       
         USING STCELD,R3                                                        
         CLI   STCATYP,STCASTUK                                                 
         JE    EXITY                                                            
         J     EXITN                                                            
         DROP  R3                                                               
*&&                                                                             
***********************************************************************         
         USING STCELD,R3                                                        
SETAPPL  L     R3,LP_AINP                                                       
         MVC   TEMP2(L'STCASTAT),STCASTAT                                       
         NI    TEMP2,X'F0'                                                      
         J     EXIT                                                             
         DROP  R3                                                               
***********************************************************************         
EDTAACT  ST    RE,SAVERE                                                        
         LM    R2,R4,LP_AINP                                                    
         USING STCELD,R2                                                        
         CLI   STCLN,STCLN7Q                                                    
         JNH   EDTACT4                                                          
         MVC   0(L'STCAACT,R4),STCAACT                                          
         LHI   RE,L'STCAACT                                                     
         STCM  RE,15,LP_OLEN                                                    
         CLI   STCATYP,STCACADD                                                 
         JE    EDTACT4                                                          
         MVC   TEMP2(L'STCAULA),STCAULA                                         
         GOTOR (#GETACN,AGETACN)                                                
         AHI   R4,L'STCAACT+1                                                   
         MVC   0(L'NAMEREC,R4),TEMP2                                            
         LHI   RE,L'STCAACT+1+L'NAMEREC                                         
         STCM  RE,15,LP_OLEN                                                    
EDTACT4  L     RE,SAVERE                                                        
         BR    RE                                                               
         DROP  R2                                                               
                                                                                
EDTCOMM  ST    RE,SAVERE                                                        
         LM    R2,R4,LP_AINP                                                    
         USING STCELD,R2                                                        
         CLI   STCLN,STCLN8Q                                                    
         JNH   EDTCOM10                                                         
         LLC   RF,STCADATL                                                      
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   0(0,R4),STCADATA                                                 
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         STCM  RF,15,LP_OLEN                                                    
EDTCOM10 L     RE,SAVERE                                                        
         BR    RE                                                               
         DROP  R2                                                               
                                                                                
EDTTIME  LM    R2,R4,LP_AINP                                                    
         USING STCELD,R2                                                        
         UNPK  DUB2,STCTIME                                                     
         OI    DUB2+7,C'0'                                                      
         MVC   0(L'DUB2-2,R4),DUB2+2                                            
         LA    RF,6                                                             
         STCM  RF,15,LP_OLEN                                                    
         J     EXITY                                                            
         DROP  R2                                                               
                                                                                
EDTDATE  LM    R2,R4,LP_AINP                                                    
         ST    RE,SAVERE                                                        
         USING STCELD,R2                                                        
         GOTOR VDATCON,DMCB,(1,STCADTE),(21,0(R4))                              
         LHI   RE,10                                                            
         CLI   CUCTRY,CTRYGBR           ONLY 9 BYTES FOR THE UK                 
         JNE   *+8                                                              
         LHI   RE,9                                                             
         STCM  RE,15,LP_OLEN                                                    
         L     RE,SAVERE                                                        
         BR    RE                                                               
         DROP  R2                                                               
                                                                                
EDTAMT   LM    R2,R4,LP_AINP                                                    
         ST    RE,SAVERE                                                        
         CURED (P6,0(R2)),(10,0(R4)),2,ZERO=YES,ALIGN=LEFT                      
         L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
SETDATA  MVI   CHKDATA,NOQ                                                      
         MVI   CHKBYTE1,1          Account add means all on new audit           
         L     R3,LP_AINP                                                       
         LAY   R1,VALDATA                                                       
         USING STCELD,R3                                                        
TSTDATA  CLC   STCATYP,0(R1)                                                    
         JE    SETDATA1                                                         
         LA    R1,1(R1)                                                         
         CLI   0(R1),X'FF'                                                      
         JNE   TSTDATA                                                          
         J     EXITN                                                            
SETDATA1 CLI   STCATYP,STCADESC                                                 
         JNE   SETDATA4                                                         
         MVC   X#TIME,STCTIME                                                   
         MVC   X#DATE,STCDATE                                                   
         L     R2,AIO1                                                          
         USING DESCTAB,R2                                                       
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO1                                        
SETDATA2 CLI   STCEL,STCELQ                                                     
         JNE   SETDATA6                                                         
         CLI   STCATYP,STCADESC                                                 
         JNE   SETDATA6                                                         
         CLC   STCTIME,X#TIME                                                   
         JNE   SETDATA6                                                         
         CLC   STCDATE,X#DATE                                                   
         JNE   SETDATA6                                                         
         MVI   DESCIDN,DESCIDNA                                                 
         AHI   R2,1                                                             
         LLC   RF,STCADATL                                                      
         BASR  RE,0                                                             
         MVC   0(0,R2),STCADATL                                                 
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         LR    RE,RF                                                            
         AHI   RE,DESCDSP                                                       
         STC   RE,0(R2)                                                         
         AR    R2,RF                                                            
         MVI   STCEL,X'FF'                                                      
         LLC   RF,STCLN                                                         
         AR    R3,RF                                                            
         J     SETDATA2                                                         
SETDATA4 MVI   CHKDATA,YESQ                                                     
         J     SETDATAX                                                         
SETDATA6 MVI   CHKDATA1,YESQ                                                    
SETDATAX J     EXITY                                                            
         DROP  R3                                                               
**********************************************************************          
EDTDATA1 LM    R2,R4,LP_AINP                                                    
         USING STCELD,R2                                                        
         CLI   STCLN,STCLN7Q                                                    
         JNH   EDTDAT1X                                                         
         LLC   RF,STCADATL                                                      
         BASR  RE,0                                                             
         MVC   0(0,R4),STCADATA                                                 
         EX    RF,0(RE)                                                         
         STCM  RF,15,LP_OLEN                                                    
EDTDAT1X J     EXITY                                                            
**********************************************************************          
EDTLKJB  NTR1                                                                   
         LM    R2,R4,LP_AINP                                                    
         USING STCELD,R2                                                        
         LLC   RF,STCANUM                                                       
         MHI   RF,L'ACTKACT                                                     
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   0(0,R4),STCAJOB                                                  
         EX    RF,0(RE)                                                         
         STCM  RF,15,LP_OLEN                                                    
         J     EXITY                                                            
**********************************************************************          
EDTCLPO  NTR1                                                                   
         LM    R2,R4,LP_AINP                                                    
         USING STCELD,R2                                                        
         LLC   R3,STCANUM                                                       
         LA    R6,STCACPO                                                       
         MVI   BYTE2,200                                                        
         XR    RF,RF                      RF=length of output                   
*                                                                               
ORD      USING STCACPO,R6                                                       
EDTCPO2  MVI   0(R4),C'('                                                       
         MVC   1(L'STCACPO,R4),ORD.STCACPO                                      
         AHI   RF,1+L'STCACPO                                                   
EDTCPO4  CLI   L'STCACPO(R4),C' '                                               
         JH    EDTCPO6                                                          
         SHI   R4,1                                                             
         JCT   RF,EDTCPO4                                                       
                                                                                
EDTCPO6  OC    ORD.STCACPOA,ORD.STCACPOA  Do we have a order amount             
         JZ    EDTCPO7              No                                          
         MVI   L'STCACPO+1(R4),C':'                                             
         AHI   RF,1                                                             
         STC   RF,BYTE3                                                         
         CURED (P6,ORD.STCACPOA),(12,L'STCACPO+2(R4)),2,ZERO=YES,      +        
               ALIGN=LEFT                                                       
         LLC   RF,BYTE3                                                         
EDTCPO7  LA    R6,L'STCACPO+L'STCACPOA(R6)                                      
         AHI   RF,12                                                            
EDTCPO8  CLI   L'STCACPO+13(R4),C' '                                            
         JH    EDTCPO10                                                         
         SHI   R4,1                                                             
         JCT   RF,EDTCPO8                                                       
                                                                                
EDTCPO10 MVI   L'STCACPO+14(R4),C')'                                            
         AHI   RF,1                                                             
         LA    R4,L'STCACPO+15(R4)              Bump to next entry              
         LLC   RE,BYTE2                                                         
         SR    RE,RF                                                            
         STC   RE,BYTE2                                                         
         CHI   RE,34                                                            
         JNH   EDTCPOX             send data for this status change             
         JCT   R3,EDTCPO2                                                       
*                                                                               
EDTCPOX  STCM  RF,15,LP_OLEN                                                    
         J     EXITY                                                            
         DROP  ORD                                                              
**********************************************************************          
EDTCLIT  NTR1                                                                   
         LM    R2,R4,LP_AINP                                                    
         USING STCELD,R2                                                        
         LLC   R6,STCANUM                                                       
         LA    R5,STCAROL                                                       
         MVI   BYTE2,200                                                        
         MVC   TEMP2,SPACES                                                     
         XC    BYTE3,BYTE3                                                      
TEA      USING STCAROL,R5                                                       
EDTCLT2  MVI   0(R4),C'('                                                       
         GOTOR (#GETROL,AGETROL),DMCB,TEA.STCAROL,RQ_JAOFF                      
         MVC   1(L'NAMEREC,R4),TEMP2                                            
         LHI   RF,1+L'NAMEREC                                                   
EDTCLT4  CLI   1+L'NAMEREC(R4),C' '                                             
         JH    EDTCLT6                                                          
         SHI   R4,1                                                             
         JCT   RF,EDTCLT4                                                       
EDTCLT6  LA    R4,L'NAMEREC+2(R4)                                               
         MVI   0(R4),C':'                                                       
         AHI   R4,1                                                             
         AHI   RF,1                                                             
         STC   RF,BYTE3                                                         
         MVC   TEMP2(2),TEA.STCARPID                                            
         GOTOR (#GETPID,AGETPID)                                                
         JNE   EDTCLT20                                                         
         GOTOR (#GETPIN,AGETPIN)                                                
         JNE   EDTCLT20                                                         
         LA    R5,L'STCAROL+L'STCARPID(R5)                                      
         LLC   RF,BYTE3                                                         
         MVC   0(16,R4),TEMP2                                                   
         AHI   RF,16                                                            
EDTCLT8  CLI   15(R4),C' '                                                      
         JH    EDTCLT10                                                         
         SHI   R4,1                                                             
         JCT   RF,EDTCLT8                                                       
                                                                                
EDTCLT10 LA    R4,17(R4)                                                        
         MVC   0(16,R4),TEMP2+32                                                
         AHI   RF,16                                                            
EDTCLT12 CLI   15(R4),C' '                                                      
         JH    EDTCLT14                                                         
         SHI   R4,1                                                             
         JCT   RF,EDTCLT12                                                      
                                                                                
EDTCLT14 LA    R4,17(R4)                                                        
         MVC   0(16,R4),TEMP2+16                                                
         AHI   RF,16                                                            
EDTCLT16 CLI   15(R4),C' '                                                      
         JH    EDTCLT18                                                         
         SHI   R4,1                                                             
         JCT   RF,EDTCLT16                                                      
                                                                                
EDTCLT18 LA    R4,16(R4)                                                        
EDTCLT20 MVI   0(R4),C')'                                                       
         LA    R4,1(R4)                                                         
         LLC   RE,BYTE2                                                         
         SR    RE,RF                                                            
         STC   RE,BYTE2                                                         
         CHI   RE,88                                                            
         JH    EDTCLT22                                                         
         STCM  RF,15,LP_OLEN                                                    
         J     EXITY               send data for this status change             
EDTCLT22 JCT   R6,EDTCLT2                                                       
         J     EXITY                                                            
         DROP  TEA                                                              
**********************************************************************          
         USING DESCTAB,R2                                                       
NXTDESC  NTR1  LABEL=*                                                          
         CLI   LP_RMODE,LP_RFRST                                                
         JNE   NXTDESC2                                                         
         MVC   STORE,LP_ADATA                                                   
         L     R2,AIO1                                                          
         ST    R2,ANXTDSC                                                       
         ST    R2,LP_ADATA                                                      
         J     EXITY                                                            
NXTDESC2 L     R2,ANXTDSC                                                       
         LLC   RF,DESCLEN                                                       
         AR    R2,RF                                                            
         BCTR  R2,0                                                             
         ST    R2,ANXTDSC                                                       
         ST    R2,LP_ADATA                                                      
         CLI   0(R2),EOR                                                        
         JNE   EXITY                                                            
         MVC   LP_ADATA,STORE                                                   
         J     NOMORE                                                           
***********************************************************************         
SETNAME  GOTOR (#GETPIN,AGETPIN)                                                
         J     EXITY                                                            
***********************************************************************         
* LIST OF AACT TYPES                                                  *         
***********************************************************************         
VALAACT  DS    0D                                                               
         DC    AL1(STCACADD)                                                    
         DC    AL1(STCAMSTR)                                                    
         DC    AL1(STCACSTG)                                                    
         DC    AL1(STCARECV)                                                    
         DC    AL1(STCABCHG)                                                    
         DC    AL1(STCAEXDF)                                                    
         DC    AL1(STCAANA)                                                     
         DC    AL1(STCADISC)                                                    
         DC    AL1(STCAFACC)                                                    
         DC    AL1(STCA2PAC)                                                    
         DC    AL1(STCA2DAC)                                                    
         DC    AL1(STCAEXAC)                                                    
         DC    AL1(STCAOINC)                                                    
         DC    AL1(STCAOWRT)                                                    
         DC    X'FF'                                                            
         EJECT                                                                  
***********************************************************************         
* LIST OF DATA TYPES                                                  *         
***********************************************************************         
VALDATA  DS    0D                                                               
         DC    AL1(STCADESC)                                                    
         DC    AL1(STCACOMT)                                                    
         DC    AL1(STCAUFS)                                                     
         DC    AL1(STCAPTEL)                                                    
         DC    AL1(STCAPFAX)                                                    
         DC    AL1(STCAPCON)                                                    
         DC    AL1(STCAPEML)                                                    
         DC    AL1(STCAOMEM)                                                    
         DC    AL1(STCAMSHN)                                                    
         DC    AL1(STCAALNM)                                                    
         DC    AL1(STCAFRNM)                                                    
         DC    AL1(STCANAME)                                                    
         DC    AL1(STCALNNM)                                                    
         DC    AL1(STCAADR)                                                     
         DC    AL1(STCAGLAC)                                                    
         DC    AL1(STCAVATN)                                                    
         DC    AL1(STCANIC)                                                     
         DC    AL1(STCACURR)                                                    
         DC    AL1(STCAKSV)                                                     
         DC    AL1(STCA13VT)                                                    
         DC    AL1(STCAVATC)                                                    
         DC    AL1(STCATAX)                                                     
         DC    AL1(STCAREFN)                                                    
         DC    AL1(STCAAUTH)                                                    
         DC    AL1(STCAENTY)                                                    
         DC    AL1(STCABSRL)                                                    
         DC    AL1(STCACRCD)                                                    
         DC    AL1(STCADSRT)                                                    
         DC    AL1(STCAVTRT)                                                    
         DC    AL1(STCADUED)                                                    
         DC    AL1(STCAEXCM)                                                    
         DC    AL1(STCAOTHR)                                                    
         DC    AL1(STCAOFFC)                                                    
         DC    AL1(STCABLGP)                                                    
         DC    AL1(STCAPID)                                                     
         DC    AL1(STCABSRT)                                                    
         DC    AL1(STCABACT)                                                    
         DC    AL1(STCABANM)                                                    
         DC    AL1(STCABNAM)                                                    
         DC    AL1(STCAPMTH)                                                    
         DC    X'FF'                                                            
         EJECT                                                                  
***********************************************************************         
* LIST OF STA2 TYPES                                                  *         
***********************************************************************         
VALSTA2  DS    0D                                                               
         DC    AL1(STCALOCK)                                                    
         DC    AL1(STCAFLT1)                                                    
         DC    AL1(STCAFLT2)                                                    
         DC    AL1(STCAFLT3)                                                    
         DC    AL1(STCAFLT4)                                                    
         DC    AL1(STCAFLT5)                                                    
         DC    AL1(STCADEPT)                                                    
         DC    AL1(STCAMILE)                                                    
         DC    AL1(STCASTAF)                                                    
         DC    AL1(STCACLIA)                                                    
         DC    AL1(STCAPERX)                                                    
         DC    AL1(STCABAL)                                                     
         DC    AL1(STCAPNL)                                                     
         DC    AL1(STCAJOBA)                                                    
         DC    AL1(STCAPROV)                                                    
         DC    AL1(STCAMRGI)                                                    
         DC    AL1(STCAPAYL)                                                    
         DC    AL1(STCAPCRS)                                                    
         DC    AL1(STCAPDRS)                                                    
         DC    AL1(STCACLIC)                                                    
         DC    AL1(STCAJLES)                                                    
         DC    AL1(STCAJLOR)                                                    
         DC    AL1(STCAJLBL)                                                    
         DC    AL1(STCAJLTM)                                                    
         DC    AL1(STCAJLAD)                                                    
         DC    AL1(STCAJLEX)                                                    
         DC    AL1(STCAEXCL)                                                    
         DC    AL1(STCADSKP)                                                    
         DC    AL1(STCAINVT)                                                    
         DC    AL1(STCASUND)                                                    
         DC    AL1(STCAINVR)                                                    
         DC    AL1(STCAFPRO)                                                    
         DC    AL1(STCAFJOB)                                                    
         DC    AL1(STCABOES)                                                    
         DC    AL1(STCAMAST)                                                    
         DC    AL1(STCATHRP)                                                    
         DC    AL1(STCAFUSR)                                                    
         DC    AL1(STCALOCL)                                                    
         DC    AL1(STCACLOS)                                                    
         DC    AL1(STCAPRJC)                                                    
         DC    AL1(STCACLIN)                                                    
         DC    AL1(STCACLIH)                                                    
         DC    AL1(STCAXJOB)                                                    
         DC    X'FF'                                                            
***********************************************************************         
* LIST OF AMOUNT AUDIT DATA TYPES                                     *         
***********************************************************************         
         SPACE 1                                                                
VALAMT   DS    0D                                                               
         DC    AL1(STCAICRL)                                                    
         DC    AL1(STCACRLM)                                                    
         DC    AL1(STCAJFEE)                                                    
         DC    X'FF'                                                            
         EJECT                                                                  
*** JOB APPROVER DOWNLOAD *********************************************         
REQJAPP  LKREQ H,A#JAPP,OUTJAPP,NEXTREQ=REQUFDL                                 
                                                                                
JOBC     LKREQ F,01,(D,B#SAVED,RQ_JAACT),CHAR,OLEN=L'RQ_JAACT,         X        
               MAXLEN=L'RQ_JAACT,TEXT=AC#JOBC,COL=*                             
OFFC     LKREQ F,02,(D,B#SAVED,RQ_JAOFF),CHAR,OLEN=L'RQ_JAOFF,         X        
               MAXLEN=L'RQ_JAOFF,TEXT=AC#OFFC,COL=*                             
                                                                                
         LKREQ E                                                                
                                                                                
OUTJAPP  LKOUT H                                                                
                                                                                
APPRCD   LKOUT R,A#JAPP                                                         
PRout    LKOUT P,,APRINIT                                                       
ARRAY    LKOUT C,A#JAPP,(A,ARYAPPR)                                             
         LKOUT E                                                                
         LKOUT X                                                                
ARYAPPR  LKOUT A,(R,NXTAPPR),MULTIROW=Y                                         
CRPC     LKOUT C,01,(D,B#SAVED,JP_CPC),CHAR,ND=Y                                
CRPF     LKOUT C,02,(D,B#SAVED,JP_CPF),CHAR,ND=Y                                
CRPL     LKOUT C,03,(D,B#SAVED,JP_CPL),CHAR,ND=Y                                
CREM     LKOUT C,04,(D,B#SAVED,JP_CEM),CHAR,ND=Y                                
Prout    LKOUT P,,SETPID                                                        
APPC     LKOUT C,05,(D,B#WORKD,TEMP2),CHAR,LEN=CPCL,ND=Y                        
Prout    LKOUT P,,SETNAME                                                       
APPF     LKOUT C,06,(D,B#WORKD,TEMP2),CHAR,LEN=PFNL,ND=Y                        
APPL     LKOUT C,07,(D,B#WORKD,WORK2),CHAR,LEN=PFNL,ND=Y                        
Prout    LKOUT P,,SETMAIL                                                       
APEM     LKOUT C,08,(D,B#WORKD,APPEMAIL),CHAR,ND=Y,FILTROUT=TSTMAIL             
ALVL     LKOUT C,09,(D,B#SAVED,JP_LVL),CHAR,ND=Y                                
APPM     LKOUT C,10,(D,B#WORKD,TEMP2+32),CHAR,LEN=PFNL,ND=Y                     
                                                                                
         LKOUT E                                                                
                                                                                
***********************************************************************         
* Job approver download                                               *         
***********************************************************************         
                                                                                
APRINIT  NTR1  BASE=*,LABEL=*                                                   
                                                                                
         MVI   CHKDATA,C'N'                                                     
         XC    STORE,STORE                                                      
         OC    RQ_JAACT,SPACES     validate job input                           
         CLC   RQ_JAACT,SPACES                                                  
         JH    APRIN02                                                          
                                                                                
         MVC   ROUERRV,=AL2(AE$MSJOB)                                           
         J     XERROR                                                           
                                                                                
         USING GOBLOCKD,R3                                                      
APRIN02  L     R3,AGOBLOCB                                                      
                                                                                
         XC    GOADM(GOABUFF-GOADM),GOADM                                       
         XC    GOADETS(GOACOVL-GOADETS),GOADETS                                 
                                                                                
         MVC   GOADM,VDATAMGR                                                   
         MVC   GOABEXT,AGOBBLCK                                                 
         MVC   GOAEXT,AGOXBLCK                                                  
         MVC   GOSELCUL(1),CUXCPY                                               
         MVC   GOSELCUL+1(L'PRODUL),PRODUL                                      
                                                                                
         MVC   GOSELCLI,SPACES                                                  
         LLC   RE,PCLILEN                                                       
         BCTR  RE,0                                                             
         MVC   GOSELCLI(0),RQ_JAACT                                             
         EX    RE,*-6                                                           
         MVC   GOSELPRO,SPACES                                                  
         LLC   R1,PCLILEN                                                       
         LLC   RF,PPROLEN                                                       
         SR    RF,R1                                                            
         BCTR  RF,0                                                             
         LA    RE,RQ_JAACT(R1)                                                  
         MVC   GOSELPRO(0),0(RE)                                                
         EX    RF,*-6                                                           
         MVC   GOSELJOB,SPACES                                                  
         LLC   R1,PPROLEN                                                       
         LLC   RF,PJOBLEN                                                       
         SR    RF,R1                                                            
         CHI   RF,L'GOSELJOB                                                    
         JNH   *+8                                                              
         LA    RF,L'GOSELJOB                                                    
         BCTR  RF,0                                                             
         LA    RE,RQ_JAACT(R1)                                                  
         MVC   GOSELJOB(0),0(RE)                                                
         EX    RF,*-6                                                           
         MVC   GOCTRY,CUCTRY                                                    
         OI    GOSPEC3,GOSPNERQ    USE NONE EMULATED IOS                        
                                                                                
         GOTO1 VGETOPT,DMCB,GOBLOCKD                                            
                                                                                
         USING GOXBLKD,R3                                                       
         L     R3,AGOXBLCK                                                      
         CLI   GODRFT,NOQ                                                       
         JNE   APRIN50                                                          
         DROP  R3                                                               
                                                                                
APRIN04  XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,PRODUL                                                    
         GOTOR (#SETLDG,ASETLDG)                                                
         JE    APRIN06                                                          
         MVC   ROUERRV,=AL2(AE$INLDG)                                           
         J     EXITN                                                            
*                                                                               
APRIN06  L     R1,AIO1                                                          
         LA    R1,LDGRFST-LDGRECD(R1)                                           
         USING LDGELD,R1                                                        
APRIN08  CLI   LDGEL,0                                                          
         JE    NOMORE                                                           
         CLI   LDGEL,LDGELQ                                                     
         JE    APRIN10                                                          
         LLC   RE,LDGLN                                                         
         AR    R1,RE                                                            
         J     APRIN08                                                          
                                                                                
APRIN10  TM    LDGSTAT2,LDGSDRFT                                                
         JZ    NOMORE                                                           
         DROP  R1                                                               
                                                                                
APRIN50  OC    RQ_JAOFF,SPACES                                                  
         CLC   RQ_JAOFF,SPACES     if office missng get from cli/pro            
         JH    APRIN66                                                          
         CLI   OFFIND,NONEQ        skip for non office agencies                 
         JE    APRIN66                                                          
                                                                                
         USING ACTRECD,R2                                                       
         LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(L'PRODUL),PRODUL                                         
         LLC   RE,PCLILEN                                                       
         BCTR  RE,0                                                             
         BASR  RF,0                                                             
         MVC   ACTKACT(0),RQ_JAACT                                              
         EX    RE,0(RF)                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    APRIN52                                                          
         DC    H'0'                                                             
                                                                                
APRIN52  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                Bad master record                            
                                                                                
         L     R2,AIO2                                                          
         LA    R2,ACTRFST                                                       
         USING PPRELD,R2                                                        
         XR    R0,R0                                                            
                                                                                
APRIN54  CLI   PPREL,0                                                          
         JE    APRIN58                                                          
         CLI   PPREL,PPRELQ                                                     
         JE    APRIN56                                                          
         IC    R0,PPRLN                                                         
         AR    R2,R0                                                            
         J     APRIN54                                                          
                                                                                
APRIN56  MVC   RQ_JAOFF,PPRGAOFF                                                
         OC    RQ_JAOFF,SPACES                                                  
                                                                                
         USING ACTRECD,R2                                                       
APRIN58  LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(L'PRODUL),PRODUL                                         
         LLC   RE,PPROLEN                                                       
         BCTR  RE,0                                                             
         MVC   ACTKACT(0),RQ_JAACT                                              
         EX    RE,*-6                                                           
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    APRIN60                                                          
         DC    H'0'                should exist                                 
                                                                                
APRIN60  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                Bad master record                            
                                                                                
         L     R2,AIO2                                                          
         LA    R2,ACTRFST                                                       
         USING PPRELD,R2                                                        
         XR    R0,R0                                                            
                                                                                
APRIN62  CLI   PPREL,0                                                          
         JE    APRIN66                                                          
         CLI   PPREL,PPRELQ                                                     
         JE    APRIN64                                                          
         IC    R0,PPRLN                                                         
         AR    R2,R0                                                            
         J     APRIN62                                                          
                                                                                
APRIN64  CLC   PPRGAOFF,SPACES                                                  
         BNH   APRIN66                                                          
         MVC   RQ_JAOFF,PPRGAOFF                                                
         OC    RQ_JAOFF,SPACES                                                  
                                                                                
         USING ACTRECD,R2                                                       
APRIN66  LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(L'PRODUL),PRODUL                                         
         MVC   ACTKACT,RQ_JAACT                                                 
         LLC   RE,PPROLEN                                                       
         LA    RE,RQ_JAACT(RE)                                                  
         MVC   X#MEDC,0(RE)                                                     
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    APRIN68                                                          
                                                                                
         MVC   ROUERRV,=AL2(AE$INJOB)                                           
         J     EXITN                                                            
                                                                                
APRIN68  XC    X#JAMD,X#JAMD       clear creator and approver                   
         XC    X#JAPP,X#JAPP                                                    
                                                                                
         MVI   X#BYTE3,YESQ        set draft yes/no                             
         TM    ACTKSTAT,ACTSDRFT                                                
         JZ    APRIN70                                                          
         MVI   X#BYTE3,NOQ                                                      
                                                                                
APRIN70  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    EXITY                                                            
         DC    H'0'                                                             
                                                                                
APRINETY CR    RB,RB                                                            
         J     *+6                                                              
APRINETN LTR   RB,RB                                                            
         J     EXITY                                                            
                                                                                
***********************************************************************         
* CHECK IF ITS APPROVED OR ADDED RECORDS                              *         
***********************************************************************         
NXTAPPR  NTR1                                                                   
         ST    R8,LP_ADATA                                                      
         OC    ROUERRV,ROUERRV                                                  
         JZ    NXTAP00                                                          
         MVC   LP_ERROR,ROUERRV                                                 
         J     QERROR                                                           
NXTAP00  CLI   CHKDATA,C'N'                                                     
         JE    NXTAP01                                                          
         L     R3,STORE                                                         
         CLI   X#BYTE3,YESQ        If job is approved put out only who          
         JNE   *+12                approved                                     
         MVI   LP_RMODE,LP_RLAST                                                
         J     EXITY                                                            
         LA    R3,L'JOBPPIDB+L'JP_LVL(R3)                                       
         OC    0(L'JOBPPIDB,R3),0(R3)                                           
         JNZ   NXTAP20                                                          
         MVI   LP_RMODE,LP_RLAST                                                
         J     EXITY                                                            
         USING RACELD,R3                                                        
NXTAP01  MVI   LP_RMODE,LP_RNEXT   look for creator and approver                
         L     R2,AIO2             look for creator and approver                
         LA    R3,ACTRFST                                                       
         XR    R0,R0                                                            
         XC    X#JCRE,X#JCRE                                                    
         XC    TEMP2,TEMP2                                                      
                                                                                
NXTAP02  CLI   RACEL,0                                                          
         JE    NXTAP08                                                          
         CLI   RACEL,RACELQ                                                     
         JNE   NXTAP06                                                          
         LA    RE,X#JAPP                                                        
         CLI   RACTYPE,RACTAPP                                                  
         JE    NXTAP04                                                          
         LA    RE,X#JAMD                                                        
         CLI   RACTYPE,RACTADD                                                  
         JNE   NXTAP06                                                          
         MVC   X#JCRE,RACPERS                                                   
                                                                                
NXTAP04  MVC   0(2,RE),RACPERS                                                  
                                                                                
NXTAP06  IC    R0,RACLN                                                         
         AR    R3,R0                                                            
         J     NXTAP02                                                          
         DROP  R2,R3                                                            
                                                                                
NXTAP08  XC    JP_VALS(JP_LNQ),JP_VALS                                          
         LA    R0,ACCBLK                                                        
         LHI   R1,ONEK                                                          
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
         OC    X#JAPP,X#JAPP       Have we got approver                         
         JNZ   NXTAP10                                                          
         GOTOR GETAPP,DMCB,(1,RQ_JAACT),RQ_JAOFF                                
         JE    NXTAP10                                                          
         CLI   X#BYTE3,YESQ        If job is approved put out else              
         JE    NXTAP10             look for approver                            
         MVC   ROUERRV,=AL2(AE$NEAPF)                                           
         J     EXITN               Error                                        
NXTAP10  OC    X#JCRE,X#JCRE                                                    
         JZ    NXTAP12                                                          
         MVC   TEMP2(2),X#JCRE                                                  
         GOTOR (#GETPID,AGETPID)                                                
         JNE   NXTAP12                                                          
         MVC   JP_CPC,TEMP2                                                     
         GOTOR (#GETPIN,AGETPIN)                                                
         JNE   NXTAP12                                                          
         MVC   JP_CPF,TEMP2                                                     
         MVC   JP_CPL,TEMP2+16                                                  
         MVI   BYTE4,SE#JOBS                                                    
         GOTOR (#SEMAIL,ASEMAIL),DMCB,RQ_JAOFF,BYTE4                            
         JNE   *+10                CHECK WHETHER TO SEND EMAILS                 
         MVC   JP_CEM,APPEMAIL                                                  
NXTAP12  OC    X#JAPP,X#JAPP                                                    
         JZ    NXTAPX                                                           
         CLI   X#BYTE3,YESQ        If job is not approved put out all           
         JNE   NXTAP16             approvers                                    
         LA    R3,ACCBLK                                                        
NXTAP14  OC    0(L'JOBPPIDB,R3),0(R3)                                           
         JZ    NXTAP18                                                          
         CLC   X#JAPP,0(R3)                                                     
         JE    NXTAP20                                                          
         LA    R3,L'JOBPPIDB+L'JP_LVL(R3)                                       
         J     NXTAP14                                                          
                                                                                
NXTAP16  LA    R3,ACCBLK                                                        
         OC    0(L'JOBPPIDB,R3),0(R3)                                           
         JNZ   NXTAP20                                                          
                                                                                
NXTAP18  MVC   TEMP2(2),X#JAPP                                                  
         MVC   HALF1,X#JAPP                                                     
         J     NXTAPX                                                           
                                                                                
NXTAP20  MVC   TEMP2(2),0(R3)                                                   
         MVC   HALF1,0(R3)                                                      
         MVC   JP_LVL,L'JOBPPIDB(R3)                                            
         MVI   LP_RMODE,LP_RNEXT                                                
NXTAPX   ST    R3,STORE                                                         
         MVI   CHKDATA,C'Y'                                                     
         J     EXITY                                                            
***********************************************************************         
* Get Person Id details                                               *         
***********************************************************************         
SETPID   GOTOR (#GETPID,AGETPID)                                                
SETPIDX  J     EXITY                                                            
                                                                                
***********************************************************************         
* Get RECORD TYPE                                                     *         
***********************************************************************         
SETTYPE  L     R1,LP_AINP                                                       
         MVC   RCTYPE,0(R1)                                                     
         J     EXITY                                                            
                                                                                
***********************************************************************         
* Get EMAIL DETAILS                                                   *         
***********************************************************************         
SETMAIL  L     R1,LP_AINP                                                       
         MVI   BYTE4,SE#JOBS                                                    
         GOTOR (#SEMAIL,ASEMAIL),DMCB,RQ_JAOFF,BYTE4                            
SETMAILX J     EXITY                                                            
                                                                                
***********************************************************************         
* FILTER ROUTINES                                                     *         
***********************************************************************         
TSTMAIL  CLC   HALF1,X#JAPP                                                     
         JE    EXITY                                                            
         J     EXITN                                                            
*** USER FIELDS DOWNLOAD **********************************************         
REQUFDL  LKREQ H,A#UFDL,OUTUFDL,NEXTREQ=REQLMDL                                 
                                                                                
CLIC     LKREQ F,01,(D,B#SAVED,RQ_UFCLI),CHAR,OLEN=L'RQ_UFCLI,         +        
               MAXLEN=L'RQ_UFCLI,TEXT=AC#CLIC,COL=*                             
PROC     LKREQ F,02,(D,B#SAVED,RQ_UFPRO),CHAR,OLEN=L'RQ_UFPRO,         +        
               MAXLEN=L'RQ_UFPRO,TEXT=AC#PROC,COL=*                             
JOBC     LKREQ F,03,(D,B#SAVED,RQ_UFJOB),CHAR,OLEN=L'RQ_UFJOB,         +        
               MAXLEN=L'RQ_UFJOB,TEXT=AC#JOBC,COL=*                             
OFFC     LKREQ F,04,(D,B#SAVED,RQ_UFOFF),CHAR,OLEN=L'RQ_UFOFF,         +        
               MAXLEN=L'RQ_UFOFF,TEXT=AC#OFFC,COL=*                             
OPND     LKREQ F,05,(D,B#SAVED,RQ_UFODT),CHAR,OLEN=L'RQ_UFODT,         +        
               MAXLEN=L'RQ_UFODT,TEXT=AC#OPND,COL=*                             
                                                                                
         LKREQ E                                                                
                                                                                
OUTUFDL  LKOUT H                                                                
OUTUFDLS LKOUT R,A#UFDL                                                         
Prout    LKOUT P,,UFDLDATA                                                      
Array    LKOUT C,A#UFDL,(A,ARYUFD)                                              
         LKOUT E                                                                
         LKOUT X                                                                
                                                                                
ARYUFD   LKOUT A,(R,NXTUFD),MULTIROW=Y,ROWNAME=ELMTABD                          
                                                                                
TYPE     LKOUT C,01,ELMEDIT,CHAR,ND=Y                                           
CODE     LKOUT C,02,ELMCODE,CHAR,ND=Y                                           
HEAD     LKOUT C,03,ELMDESC,CHAR,ND=Y                                           
MAXC     LKOUT C,04,ELMMAXL,(R,EDTMAXC),CHAR,ND=Y                               
COMP     LKOUT C,05,ELMSTAT,(R,EDTCOMP),CHAR,ND=Y                               
OFFI     LKOUT C,06,(D,B#SAVED,RQ_UFOFF),CHAR,ND=Y                              
         LKOUT E                                                                
                                                                                
***********************************************************************         
*UFDLDATA - ROUTINE TO PULL DATA FOR USER FIELD REQUEST               *         
***********************************************************************         
UFDLDATA NTR1                                                                   
         MVI   CHKDATA,C'N'        INITIALIZE FLAG TO CHECK ELMDATA             
         MVI   CHKDATA1,C'N'       INITIALIZE FLAG TO CHECK CLIENT VAL          
         XC    STORE,STORE                                                      
         XC    STORE1,STORE1                                                    
         L     R4,AGENAREA                                                      
         ST    R4,STORE1                                                        
         LA    R3,MAXUFS                                                        
         ST    R3,STORE                                                         
         OC    RQ_UFCLI,SPACES                                                  
         OC    RQ_UFPRO,SPACES                                                  
         OC    RQ_UFJOB,SPACES                                                  
         OC    RQ_UFOFF,SPACES                                                  
         MVC   X#POFF,SPACES                                                    
         L     R4,AGENAREA         clear table                                  
         LR    RE,R4                                                            
         LHI   RF,L'GENAREA                                                     
         XR    R1,R1                                                            
         XR    R0,R0                                                            
         MVCL  RE,R0                                                            
*                                  List or display request?                     
         CLC   RQ_UFCLI(RQ_UFOFF-RQ_UFOFF),SPACES                               
         JNH   UFDLD35                                                          
         CLC   RQ_UFOFF,SPACES     if office missng get from cli/pro            
         JH    UFDLD16                                                          
         CLI   OFFIND,NONEQ        skip for non office agencies                 
         JE    UFDLD16                                                          
                                                                                
         USING ACTRECD,R2                                                       
         LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(2),PRODUL                                                
         MVC   ACTKACT(5),RQ_UFCLI                                              
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    UFDLD02                                                          
                                                                                
         MVC   ROUERRV,=AL2(AE$INCLI)                                           
         J     UFDLDN                                                           
                                                                                
UFDLD02  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                Bad master record                            
                                                                                
         L     R2,AIO2                                                          
         LA    R2,ACTRFST                                                       
         USING PPRELD,R2                                                        
         XR    R0,R0                                                            
                                                                                
UFDLD04  CLI   PPREL,0                                                          
         JE    UFDLD08                                                          
         CLI   PPREL,PPRELQ                                                     
         JE    UFDLD06                                                          
         IC    R0,PPRLN                                                         
         AR    R2,R0                                                            
         J     UFDLD04                                                          
                                                                                
UFDLD06  MVC   X#POFF,PPRGAOFF                                                  
         OC    X#POFF,X#POFF                                                    
                                                                                
         USING ACTRECD,R2                                                       
UFDLD08  LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(2),PRODUL                                                
         MVC   ACTKACT(5),RQ_UFCLI                                              
         LLC   RE,PCLILEN                                                       
         LA    RE,ACTKACT(RE)                                                   
*&&UK*&& MVC   0(2,RE),RQ_UFPRO                                                 
*&&US*&& MVC   0(L'RQ_UFPRO,RE),RQ_UFPRO                                        
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    UFDLD10                                                          
                                                                                
         MVC   ROUERRV,=AL2(AE$INPRO)                                           
         J     UFDLDN                                                           
                                                                                
UFDLD10  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                Bad master record                            
                                                                                
         L     R2,AIO2                                                          
         LA    R2,ACTRFST                                                       
         USING PPRELD,R2                                                        
         XR    R0,R0                                                            
                                                                                
UFDLD12  CLI   PPREL,0                                                          
         JE    UFDLD16                                                          
         CLI   PPREL,PPRELQ                                                     
         JE    UFDLD14                                                          
         IC    R0,PPRLN                                                         
         AR    R2,R0                                                            
         J     UFDLD12                                                          
                                                                                
UFDLD14  CLC   PPRGAOFF,SPACES                                                  
         JNH   UFDLD16                                                          
         MVC   X#POFF,PPRGAOFF                                                  
         OC    X#POFF,X#POFF                                                    
                                                                                
UFDLD16  CLC   RQ_UFOFF,SPACES                                                  
         JH    UFDLD18                                                          
                                                                                
         MVC   RQ_UFOFF,X#POFF     set from retrieved office                    
                                                                                
UFDLD18  GOTOR VDATCON,DMCB,(0,RQ_UFODT+2),(1,X#CLOX)                           
                                                                                
         MVC   X#MEDC,RQ_UFJOB     get media code/group and off group           
                                                                                
         USING PMDRECD,R2                                                       
         LA    R2,IOKEY                                                         
         MVC   PMDKEY,SPACES                                                    
         MVI   PMDKTYP,PMDKTYPQ                                                 
         MVC   PMDKCPY,CUXCPY                                                   
         MVC   PMDKMED,X#MEDC                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    UFDLD20                                                          
                                                                                
         MVC   ROUERRV,=AL2(AE$MCINV)                                           
         J     UFDLDN                                                           
                                                                                
UFDLD20  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                Bad master record                            
                                                                                
         L     R2,AIO2                                                          
         LA    R3,PMDRFST                                                       
         USING PMDELD,R3                                                        
         XR    R0,R0                                                            
                                                                                
UFDLD22  CLI   PMDEL,PMDELQ                                                     
         JE    UFDLD24                                                          
         CLI   PMDEL,0                                                          
         JNE   *+6                                                              
         DC    H'0'                                                             
                                                                                
         IC    R0,PMDLN                                                         
         AR    R3,R0                                                            
         J     UFDLD22                                                          
                                                                                
UFDLD24  MVC   X#MEDG,PMDGRP                                                    
                                                                                
         CLI   OFFIND,NONEQ        skip for non office agencies                 
         JE    UFDLD35                                                          
                                                                                
         USING OGRRECD,R2                                                       
         LA    R2,IOKEY                                                         
         XC    OGRKEY,OGRKEY                                                    
         MVI   OGRKTYP,OGRKTYPQ                                                 
         MVI   OGRKSUB,OGRKOFFQ                                                 
         MVC   OGRKCPY,CUXCPY                                                   
         MVC   OGRKUNT(2),PRODUL                                                
         MVC   OGRKOFC,RQ_UFOFF                                                 
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    UFDLD26                                                          
                                                                                
         MVC   ROUERRV,=AL2(AE$IVOFF)                                           
         J     UFDLDN                                                           
                                                                                
UFDLD26  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                Bad master record                            
                                                                                
         L     R2,AIO2                                                          
         LA    R3,OGRRFST                                                       
         USING PGRELD,R3                                                        
         XR    R0,R0                                                            
                                                                                
UFDLD28  CLI   PGREL,PGRELQ                                                     
         JE    UFDLD30                                                          
         CLI   PGREL,0                                                          
         JE    UFDLD35                                                          
                                                                                
         IC    R0,PGRLN                                                         
         AR    R3,R0                                                            
         J     UFDLD28                                                          
                                                                                
UFDLD30  MVC   X#OFFG,PGRCODE                                                   
                                                                                
UFDLD35  L     R4,AGENAREA         clear table                                  
         LR    RE,R4                                                            
         LHI   RF,L'GENAREA                                                     
         XR    R1,R1                                                            
         XR    R0,R0                                                            
         MVCL  RE,R0                                                            
                                                                                
*                                                                               
UFDLD36  CLC   RQ_UFCLI(RQ_UFOFF-RQ_UFOFF),SPACES                               
         JH    UFDLD38             Any c/p/j passed?                            
         CLC   RQ_UFCLI(RQ_UFOFF-RQ_UFOFF),SPACES                               
         JH    *+2                 Invalid request all passed or none           
         OC    RQ_UFODT,RQ_UFODT                                                
         JZ    UFDLD37                                                          
         GOTOR VDATCON,DMCB,(0,RQ_UFODT+2),(1,X#CLOX)                           
UFDLD37  GOTOR XUALL                                                            
         LHI   R3,MAXLUF                                                        
         ST    R3,STORE                                                         
         J     EXITY                                                            
*                                                                               
UFDLD38  LA    R2,X#URKEY          Company level                                
         XC    X#URKEY,X#URKEY                                                  
         JAS   RE,XUREAD                                                        
         CLC   SAVEKEY1(UFSKOFG-UFSKEY),IOKEY                                   
         JNE   UFDLDY              exit if no records at all                    
         CLC   SAVEKEY1(L'UFSKEY),IOKEY                                         
         JNE   UFDLD40                                                          
         JAS   RE,XUTBL                                                         
                                                                                
UFDLD40  CLI   X#MEDG,C' '         Company/Media group level                    
         JNH   UFDLD45                                                          
         XC    X#URKEY,X#URKEY                                                  
         MVC   X#URKEY+UFSKMGR-UFSRECD(L'UFSKMGR),X#MEDG                        
         JAS   RE,XUREAD                                                        
         JNE   UFDLD45                                                          
         JAS   RE,XUTBL                                                         
                                                                                
UFDLD45  CLI   X#MEDC,C' '         Company/Media level                          
         JNH   UFDLD50                                                          
         XC    X#URKEY,X#URKEY                                                  
         MVC   X#URKEY+UFSKMED-UFSRECD(L'UFSKMED),X#MEDC                        
         JAS   RE,XUREAD                                                        
         JNE   UFDLD50                                                          
         JAS   RE,XUTBL                                                         
                                                                                
UFDLD50  CLI   X#OFFG,C' '         Company/office group level                   
         JNH   UFDLD65                                                          
         XC    X#URKEY,X#URKEY                                                  
         MVC   X#URKEY+UFSKOFG-UFSRECD(L'UFSKOFG),X#OFFG                        
         JAS   RE,XUREAD                                                        
         CLC   SAVEKEY1(UFSKOFC-UFSKEY),IOKEY      skip if no records           
         JNE   UFDLD65                                                          
         CLC   SAVEKEY1(L'UFSKEY),IOKEY                                         
         JNE   UFDLD55                                                          
         JAS   RE,XUTBL                                                         
                                                                                
UFDLD55  CLI   X#MEDG,C' '         Company/off group/media group level          
         JNH   UFDLD60                                                          
         MVC   X#URKEY+UFSKMGR-UFSRECD(L'UFSKMGR),X#MEDG                        
         JAS   RE,XUREAD                                                        
         JNE   UFDLD60                                                          
         JAS   RE,XUTBL                                                         
                                                                                
UFDLD60  CLI   X#MEDC,C' '         Company/off group /media level               
         JNH   UFDLD65                                                          
     XC    X#URKEY+UFSKMGR-UFSRECD(L'UFSKMGR),X#URKEY+UFSKMGR-UFSRECD           
         MVC   X#URKEY+UFSKMED-UFSRECD(L'UFSKMED),X#MEDC                        
         JAS   RE,XUREAD                                                        
         JNE   UFDLD65                                                          
         JAS   RE,XUTBL                                                         
                                                                                
UFDLD65  CLC   RQ_UFOFF,SPACES     Company/Office level                         
         JNH   UFDLD80                                                          
         XC    X#URKEY,X#URKEY                                                  
         MVC   X#URKEY+UFSKOFC-UFSRECD(L'UFSKOFC),RQ_UFOFF                      
         JAS   RE,XUREAD                                                        
         CLC   SAVEKEY1(UFSKCLI-UFSKEY),IOKEY                                   
         JNE   UFDLD80             skip if no office records                    
         CLC   SAVEKEY1(L'UFSKEY),IOKEY                                         
         JNE   UFDLD70                                                          
         JAS   RE,XUTBL                                                         
                                                                                
UFDLD70  CLI   X#MEDG,C' '         Company/Office/Media group level             
         JNH   UFDLD75                                                          
         MVC   X#URKEY+UFSKMGR-UFSRECD(L'UFSKMGR),X#MEDG                        
         JAS   RE,XUREAD                                                        
         JNE   *+8                                                              
         JAS   RE,XUTBL                                                         
   XC    X#URKEY+UFSKMGR-UFSRECD(L'UFSKMGR),X#URKEY+UFSKMGR-UFSRECD             
                                                                                
UFDLD75  CLI   X#MEDC,C' '         Company/Office/Media level                   
         JNH   UFDLD80                                                          
         MVC   X#URKEY+UFSKMED-UFSRECD(L'UFSKMED),X#MEDC                        
         JAS   RE,XUREAD                                                        
         CLC   SAVEKEY1(L'UFSKEY),IOKEY                                         
         JNE   UFDLD80                                                          
         JAS   RE,XUTBL                                                         
                                                                                
UFDLD80  XC    X#URKEY,X#URKEY     Company/Client level                         
         MVC   X#URKEY+UFSKCLI-UFSRECD(L'UFSKCLI),SPACES                        
         MVC   X#URKEY+UFSKCLI-UFSRECD(L'RQ_UFCLI),RQ_UFCLI                     
         JAS   RE,XUREAD                                                        
         CLC   SAVEKEY1(UFSKPRO-UFSKEY),IOKEY                                   
         JNE   UFDLD120            skip if no client records                    
         CLC   SAVEKEY1(L'UFSKEY),IOKEY                                         
         JNE   UFDLD85                                                          
         JAS   RE,XUTBL                                                         
                                                                                
UFDLD85  CLI   X#MEDG,C' '         Company/Client/Media group level             
         JNH   UFDLD90                                                          
         MVC   X#URKEY+UFSKMGR-UFSRECD(L'UFSKMGR),X#MEDG                        
         JAS   RE,XUREAD                                                        
         JNE   *+8                                                              
         JAS   RE,XUTBL                                                         
    XC    X#URKEY+UFSKMGR-UFSRECD(L'UFSKMGR),X#URKEY+UFSKMGR-UFSRECD            
                                                                                
UFDLD90  CLI   X#MEDC,C' '         Company/Client/Media level                   
         JNH   UFDLD95                                                          
         MVC   X#URKEY+UFSKMED-UFSRECD(L'UFSKMED),X#MEDC                        
         JAS   RE,XUREAD                                                        
         JNE   *+8                                                              
         JAS   RE,XUTBL                                                         
      XC    X#URKEY+UFSKMED-UFSRECD(L'UFSKMED),X#URKEY+UFSKMED-UFSRECD          
                                                                                
UFDLD95  DS    0H                  Company/Client/Product level                 
         MVC   X#URKEY+UFSKPRO-UFSRECD(L'UFSKPRO),SPACES                        
         MVC   X#URKEY+UFSKPRO-UFSRECD(L'RQ_UFPRO),RQ_UFPRO                     
         JAS   RE,XUREAD                                                        
         JNE   *+8                                                              
         JAS   RE,XUTBL                                                         
         CLI   X#MEDG,C' '         Company/Client/Prod/Media gr level           
         JNH   UFDLD100                                                         
         MVC   X#URKEY+UFSKMGR-UFSRECD(L'UFSKMGR),X#MEDG                        
         JAS   RE,XUREAD                                                        
         JNE   *+8                                                              
         JAS   RE,XUTBL                                                         
    XC    X#URKEY+UFSKMGR-UFSRECD(L'UFSKMGR),X#URKEY+UFSKMGR-UFSRECD            
                                                                                
UFDLD100 CLI   X#MEDC,C' '         Company/Client/Product/Media level           
         JNH   UFDLD105                                                         
         MVC   X#URKEY+UFSKMED-UFSRECD(L'UFSKMED),X#MEDC                        
         JAS   RE,XUREAD                                                        
         JNE   *+8                                                              
         JAS   RE,XUTBL                                                         
    XC    X#URKEY+UFSKMED-UFSRECD(L'UFSKMED),X#URKEY+UFSKMED-UFSRECD            
                                                                                
UFDLD105 DS    0H                  Company/Client/product/Job level             
         MVC   X#URKEY+UFSKJOB-UFSRECD(L'UFSKJOB),RQ_UFJOB                      
         JAS   RE,XUREAD                                                        
         JNE   *+8                                                              
         JAS   RE,XUTBL                                                         
                                                                                
UFDLD120 MVI   CHKDATA1,C'Y'                                                    
         J     EXITY                                                            
                                                                                
UFDLDY   CR    RB,RB                                                            
         J     *+6                                                              
UFDLDN   LTR   RB,RB                                                            
         XIT1                                                                   
                                                                                
         USING UFSRECD,R2                                                       
XUREAD   NTR1                                                                   
         LA    R2,IOKEY                                                         
         MVC   UFSKEY,X#URKEY                                                   
         MVI   UFSKTYP,UFSKTYPQ                                                 
         MVI   UFSKSUB,UFSKSUBQ                                                 
         MVC   UFSKCPY,CUXCPY                                                   
         MVC   UFSKUNT(2),PRODUL                                                
         MVC   SAVEKEY1,UFSKEY                                                  
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
                                                                                
         CLC   UFSKEY,SAVEKEY1     set cc and exit                              
         XIT1                                                                   
                                                                                
         USING ELMTABD,R3                                                       
         USING UFSELD,R2                                                        
XUTBL    NTR1                                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                Bad master record                            
                                                                                
         L     R2,AIO2                                                          
         AHI   R2,ACTRFST-ACTKEY                                                
                                                                                
XUTBL05  CLI   UFSEL,0                                                          
         JE    XUTBLY                                                           
         CLI   UFSEL,UFSELQ                                                     
         JE    XUTBL15                                                          
                                                                                
XUTBL10  LLC   R0,UFSLN                                                         
         AR    R2,R0                                                            
         J     XUTBL05                                                          
                                                                                
XUTBL15  DS    0H                                                               
*&&US                                                                           
         TM    UFSSTAT,UFSSAUTH    Show on Authorization REC Only?              
         JO    XUTBL10             YES - Skip                                   
*&&                                                                             
         CLC   UFSDESC,SPACES                                                   
         JE    XUTBL10                                                          
                                                                                
         L     R3,AGENAREA                                                      
         LA    R0,MAXUFS                                                        
                                                                                
XUTBL20  OC    ELMDATA,ELMDATA     free spot?                                   
         JZ    XUTBL30             no - go for next                             
         CLC   UFSCODE,ELMCODE     yes- code match?                             
         JNE   XUTBL30             no                                           
         MVC   ELMDESC(ELMSTAT-ELMDESC+1),UFSDESC                               
         OC    UFSCUT,UFSCUT       cut off date?                                
         JZ    XUTBL25             no - replace element                         
         CLC   UFSCUT,X#CLOX       yes - take it?                               
         JH    XUTBL25             yes                                          
                                                                                
         BCTR  R0,0                                                             
         MVC   ELMDATA,ELMLNG(R3)                                               
         LA    R3,ELMLNG(R3)                                                    
         JCT   R0,*-10                                                          
         XC    ELMDATA,ELMDATA     clear last spot                              
         J     XUTBL10             get next element                             
                                                                                
XUTBL25  MVC   ELMDATA,UFSEL       repalve element                              
         J     XUTBL10             get next one                                 
                                                                                
XUTBL30  AHI   R3,ELMLNG           get next                                     
         JCT   R0,XUTBL20                                                       
                                                                                
         L     R3,AGENAREA         no match - look for free spot                
         LA    R0,MAXUFS                                                        
                                                                                
XUTBL50  OC    ELMDATA,ELMDATA     free spot?                                   
         JNZ   XUTBL60             no - keep looping                            
         OC    UFSCUT,UFSCUT       yes - cutoff date                            
         JZ    XUTBL55             no - add element                             
         CLC   UFSCUT,X#CLOX       yes - take it?                               
         JNH   XUTBL10             no                                           
                                                                                
XUTBL55  MVC   ELMDATA,UFSEL       add element                                  
         J     XUTBL10             get next element                             
                                                                                
XUTBL60  LA    R3,ELMLNG(R3)       GET NEXT                                     
         JCT   R0,XUTBL50                                                       
                                                                                
XUTBLY   CR    RB,RB                                                            
         J     *+6                                                              
XUTBLN   LTR   RB,RB                                                            
         XIT1                                                                   
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* Read all user field entries                                         *         
***********************************************************************         
         SPACE 1                                                                
         USING UFSRECD,R2                                                       
XUALL    NTR1                                                                   
         LA    R2,IOKEY                                                         
         XC    IOKEY,IOKEY                                                      
         MVI   UFSKTYP,UFSKTYPQ                                                 
         MVI   UFSKSUB,UFSKSUBQ                                                 
         MVC   UFSKCPY,CUXCPY                                                   
         MVC   UFSKUNT(2),PRODUL                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JE    XUALL04                                                          
         DC    H'0'                                                             
                                                                                
XUALL02  LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         JE    XUALL04                                                          
         DC    H'0'                                                             
                                                                                
XUALL04  CLI   UFSKTYP,UFSKTYPQ    Still reading user fields?                   
         JNE   XUALLY                                                           
         CLI   UFSKSUB,UFSKSUBQ                                                 
         JNE   XUALLY                                                           
         CLC   UFSKCPY,CUXCPY                                                   
         JNE   XUALLY                                                           
         CLC   UFSKUNT(2),PRODUL                                                
         JNE   XUALLY                                                           
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                 Bad master record                            
                                                                                
         L     R2,AIO2                                                          
         AHI   R2,ACTRFST-ACTKEY                                                
                                                                                
         USING UFSELD,R2                                                        
XUALL05  CLI   UFSEL,0                                                          
         JE    XUALL02                                                          
         CLI   UFSEL,UFSELQ                                                     
         JE    XUALL15                                                          
                                                                                
XUALL10  LLC   R0,UFSLN                                                         
         AR    R2,R0                                                            
         J     XUALL05                                                          
                                                                                
XUALL15  DS    0H                                                               
*&&US                                                                           
         TM    UFSSTAT,UFSSAUTH    Show on Authorization REC Only?              
         JO    XUALL10             YES - Skip                                   
*&&                                                                             
         CLC   UFSDESC,SPACES                                                   
         JNH   XUALL10                                                          
                                                                                
         L     R3,AGENAREA                                                      
         LA    R0,MAXLUF                                                        
*                              **  Excl entries with the same name **           
XUALL20  OC    ELMDATA,ELMDATA     free spot?                                   
         JZ    XUALL40             no - go for next                             
         CLC   UFSDESC,ELMDESC     Don't include codes with same name           
         JE    XUALL10                                                          
         AHI   R3,ELMLNG           get next                                     
         JCT   R0,XUALL20                                                       
                                                                                
XUALL40  L     R3,AGENAREA         no match - look for free spot                
         LA    R0,MAXLUF                                                        
                                                                                
XUALL50  OC    ELMDATA,ELMDATA     free spot?                                   
         JNZ   XUALL60             no - keep looping                            
         OC    UFSCUT,UFSCUT       yes - cutoff date                            
         JZ    XUALL55             no - add element                             
         OC    X#CLOX,X#CLOX                                                    
         JZ    XUALL55                                                          
         CLC   UFSCUT,X#CLOX       yes - take it?                               
         JNH   XUALL10             no                                           
                                                                                
XUALL55  MVC   ELMDATA,UFSEL       add element                                  
         J     XUALL10             get next element                             
                                                                                
XUALL60  LA    R3,ELMLNG(R3)       GET NEXT                                     
         JCT   R0,XUALL50                                                       
         DC    H'0'                ACCBLK FULL                                  
                                                                                
XUALLY   CR    RB,RB                                                            
         J     *+6                                                              
XUALLN   LTR   RB,RB                                                            
         XIT1                                                                   
         DROP  R2,R3                                                            
         EJECT                                                                  
***********************************************************************         
* NXTUFD - Production User Field Download Request                     *         
***********************************************************************         
NXTUFD   NTR1                                                                   
         OC    ROUERRV,ROUERRV     CHECK IF THERE IS ANY ERROR                  
         JZ    NXTUFD02                                                         
         MVC   LP_ERROR,ROUERRV                                                 
         J     QERROR                                                           
NXTUFD02 CLI   CHKDATA1,C'Y'       CHECK IF USER HAS ENTERED CLIENT             
         JNE   NXTUFD2A                                                         
         LA    R3,SPACES           DISPLAY ONLY OFFICE, SKIP OTHERS             
         ST    R3,LP_ADATA                                                      
         J     EXITY                                                            
NXTUFD2A L     R3,STORE                                                         
         USING ELMTABD,R4                                                       
         L     R4,STORE1                                                        
         ST    R4,LP_ADATA                                                      
         CLI   CHKDATA,C'Y'        CHECK IF REQD TO POINT TO NXT REC            
         JNE   NXTUFD03                                                         
         MVI   CHKDATA,C'N'        RESET THE FLAG                               
         AHI   R4,ELMLNG           POINT TO NEXT RECORD                         
         ST    R4,STORE1                                                        
         BCTR  R3,0                                                             
         CHI   R3,0                                                             
         JH    *+8                                                              
         J     NXTUFDX                                                          
         ST    R3,STORE                                                         
                                                                                
NXTUFD03 OC    ELMDATA,ELMDATA                                                  
         JZ    NXTUFD04                                                         
         ST    R3,STORE                                                         
         MVI   CHKDATA,C'Y'        SET THE FLAG TO POINT TO NXTREC              
         MVC   RQ_UFOFF,SPACES                                                  
         ST    R4,LP_ADATA                                                      
         J     EXITY                                                            
                                                                                
NXTUFD04 AHI   R4,ELMLNG                                                        
         ST    R4,STORE1                                                        
         ST    R4,LP_ADATA                                                      
         BCTR  R3,0                                                             
         CHI   R3,0                                                             
         JH    NXTUFD03                                                         
NXTUFDX  MVI   LP_RMODE,LP_RLAST                                                
         J     EXITY                                                            
                                                                                
***********************************************************************         
* ROUTINE TO PULL VALUES OF MAXC                                                
***********************************************************************         
EDTMAXC  NTR1  BASE=*,LABEL=*                                                   
         ST    R3,SAVERE                                                        
         LM    R2,R4,LP_AINP                                                    
         CLI   CHKDATA1,C'Y'                                                    
         JE    EDTMAX2                                                          
         EDIT  (B1,0(R2)),(2,0(R4)),ALIGN=LEFT                                  
         LA    RF,MAXL                                                          
         STCM  RF,15,LP_OLEN                                                    
EDTMAX2  L     R3,SAVERE                                                        
         J     EXITY                                                            
***********************************************************************         
* ROUTINE TO PULL VALUES OF COMP                                                
***********************************************************************         
EDTCOMP  ST    R3,SAVERE                                                        
         LM    R2,R4,LP_AINP                                                    
         CLI   CHKDATA1,C'Y'                                                    
         JE    EDTCOMP2                                                         
         MVI   0(R4),YESQ                                                       
         TM    0(R2),UFSSREQD    required?                                      
         JNZ   *+8                                                              
         MVI   0(R4),NOQ                                                        
         LA    RF,1                                                             
         STCM  RF,15,LP_OLEN                                                    
EDTCOMP2 L     R3,SAVERE                                                        
         MVI   CHKDATA1,C'N'                                                    
         J     EXITY                                                            
***********************************************************************         
* LINE MANAGER APPROVER LIST DOWNLOAD                                 *         
***********************************************************************         
                                                                                
REQLMDL  LKREQ H,A#LINM,OUTLMDL,NEXTREQ=REQUESTX                                
Office   LKREQ F,01,(D,B#SAVED,RQ_LMOFF),CHAR,OLEN=L'RQ_LMOFF,         +        
               MAXLEN=L'RQ_LMOFF,TEXT=AC#OFF,COL=*                              
Dept     LKREQ F,02,(D,B#SAVED,RQ_LMDEP),CHAR,OLEN=L'RQ_LMDEP,         +        
               MAXLEN=L'RQ_LMDEP,TEXT=AC#DPT,COL=*                              
Subdp    LKREQ F,03,(D,B#SAVED,RQ_LMSDP),CHAR,OLEN=L'RQ_LMSDP,         +        
               MAXLEN=L'RQ_LMSDP,TEXT=AC#SUBDP,COL=*                            
Person   LKREQ F,04,(D,B#SAVED,RQ_LMPER),CHAR,OLEN=L'RQ_LMPER,         +        
               MAXLEN=L'RQ_LMPER,TEXT=AC#PRSN,COL=*                             
         LKREQ E                                                                
                                                                                
OUTLMDL  LKOUT H                                                                
*                                                                               
OUTLMDLS LKOUT R,A#LINM                                                         
Array    LKOUT C,A#LINM,(A,ARYLNM)                                              
         LKOUT E                                                                
         LKOUT X                                                                
                                                                                
ARYLNM   LKOUT A,(R,NXTLMN),MULTIROW=Y                                          
Pid      LKOUT C,1,(D,B#SAVED,LM_PID),CHAR,ND=Y                                 
FirstNam LKOUT C,2,(D,B#SAVED,LM_FSTNM),CHAR,ND=Y                               
MidNam   LKOUT C,3,(D,B#SAVED,LM_MIDNM),CHAR,ND=Y                               
LastNam  LKOUT C,4,(D,B#SAVED,LM_LSTNM),CHAR,ND=Y                               
         LKOUT E                                                                
                                                                                
**********************************************************************          
* Read line manager approver records                                 *          
**********************************************************************          
         SPACE 1                                                                
         USING DPAPASD,R2                                                       
NXTLMN   NTR1  LABEL=NO,WORK=(RC,LMWORKL)                                       
         J     *+12                                                             
         DC    C'*NXTLMN*'                                                      
         ST    R8,LP_ADATA                                                      
*                                                                               
         USING LMWORKD,RC                                                       
         GOTOR CLRWRK,LMWORKL      Clear work area                              
         USING OB_D,LMAREA                                                      
         LA    R2,IOKEY                                                         
*                                                                               
         CLI   LP_RMODE,LP_RFRST   Test first time                              
         JNE   NXTLMN14            No                                           
*                                                                               
         XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,LED1R       Read 1r ledger lengths                        
         GOTOR (#SETLDG,ASETLDG)                                                
         JNE   *+2                                                              
*                                                                               
         GOTOR INILMB                                                           
*                                                                               
         XC    DPAPAS,DPAPAS                                                    
         MVI   DPAPTYP,DPAPTYPQ                                                 
         MVI   DPAPSUB,DPAPSUBQ                                                 
         MVI   DPAPAPPL,DPAPATIM                                                
         MVC   DPAPCPY,CUXCPY                                                   
         ZAP   DPAPXVAL,PZERO                                                   
*                                                                               
         CLC   RQ_LMOFF,SPACES     If no office use key driver                  
         JNH   NXTLMN02                                                         
         LA    R1,DPAP1RAC        Populate 1R account in key if present         
         LLC   RF,LDGAL1                                                        
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   0(0,R1),RQ_LMOFF                                                 
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         AR    R1,RF                                                            
*                                                                               
         CLC   RQ_LMDEP,SPACES                                                  
         JNH   NXTLMN02                                                         
*                                                                               
         LLC   RF,LDGAL2                                                        
         LLC   RE,LDGAL1                                                        
         SR    RF,RE                                                            
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   0(0,R1),RQ_LMDEP                                                 
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         AR    R1,RF                                                            
                                                                                
         CLC   RQ_LMSDP,SPACES                                                  
         JNH   NXTLMN02                                                         
*                                                                               
         LLC   RF,LDGAL3                                                        
         LLC   RE,LDGAL2                                                        
         SR    RF,RE                                                            
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   0(0,R1),RQ_LMSDP                                                 
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         AR    R1,RF                                                            
*                                                                               
         CLC   RQ_LMPER,SPACES                                                  
         JNH   NXTLMN02                                                         
*                                                                               
         LLC   RF,LDGAL4                                                        
         LLC   RE,LDGAL3                                                        
         SR    RF,RE                                                            
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   0(0,R1),RQ_LMPER                                                 
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         AR    R1,RF                                                            
*                                                                               
NXTLMN02 MVC   X#1RACC,DPAP1RAC                                                 
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         JE    NXTLMN06                                                         
         DC    H'0'                                                             
*                                                                               
NXTLMN04 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO1'                               
         JNE   *+2                                                              
*                                                                               
NXTLMN06 CLI   DPAPTYP,DPAPTYPQ                                                 
         JNE   NXTLMN12           Check still reading DPAPASD                   
         CLI   DPAPSUB,DPAPSUBQ                                                 
         JNE   NXTLMN12                                                         
         CLC   DPAPCPY,CUXCPY                                                   
         JNE   NXTLMN12                                                         
         CLI   DPAPAPPL,DPAPATIM                                                
         JNE   NXTLMN12                                                         
*                                                                               
         MVC   SAVEKEY,IOKEY                                                    
*                                                                               
         CLC   RQ_LMOFF,SPACES   No office passed then accept key               
         JNH   NXTLMN10                                                         
         LLC   RF,LDGAL1                                                        
         CLC   RQ_LMDEP,SPACES                                                  
         JNH   NXTLMN08                                                         
         LLC   RF,LDGAL2                                                        
         CLC   RQ_LMSDP,SPACES                                                  
         JNH   NXTLMN08                                                         
         LLC   RF,LDGAL3                                                        
         CLC   RQ_LMPER,SPACES                                                  
         JNH   NXTLMN08                                                         
         LLC   RF,LDGAL4                                                        
*                                                                               
NXTLMN08 BCTR  RF,0               Check 1R account still matches                
         BASR  RE,0                                                             
         CLC   X#1RACC(0),DPAP1RAC                                              
         EX    RF,0(RE)                                                         
         JNE   NXTLMN12                                                         
*                                                                               
NXTLMN10 MVC   TEMP2(L'DPAPPIDB),DPAPPIDB                                       
         GOTOR (#GETPID,AGETPID)                                                
         XC    OB_D(OB_LNQ),OB_D                                                
         MVC   OB_KEY,TEMP2       Check pid has already been returned           
         GOTOR GETBUF,OB_D                                                      
         JH    EXITN                                                            
         JE    NXTLMN04           If found read next DPAPASD                    
*                                                                               
         GOTOR (#GETPIN,AGETPIN)                                                
         MVC   OB_FSTNM,TEMP2                                                   
         MVC   OB_MIDNM,TEMP2+32                                                
         MVC   OB_LSTNM,WORK2                                                   
         GOTOR ADDBUF,OB_D         Add option buffer record                     
         J     NXTLMN04                                                         
*                                                                               
T        USING TSARD,TSAROBUF                                                   
NXTLMN12 XC    OB_D(OB_LNQ),OB_D   Clear TSAR area and read back                
         MVI   T.TSACTN,TSARDH                                                  
         J     NXTLMN16                                                         
*                                                                               
NXTLMN14 MVI   T.TSACTN,TSANXT                                                  
*                                                                               
NXTLMN16 LA    R0,OB_D                                                          
         ST    R0,T.TSAREC         Read into acquired storage                   
         GOTOR VTSAR,T.TSARD                                                    
         TM    T.TSERRS,TSEEOF                                                  
         JNZ   NXTLMNX                                                          
*                                                                               
         MVI   LP_RMODE,LP_RNEXT                                                
         MVC   LM_PID,OB_KEY       Extract PID                                  
         MVC   LM_FSTNM,OB_FSTNM   Extract first name                           
         MVC   LM_MIDNM,OB_MIDNM   Extract middle name                          
         MVC   LM_LSTNM,OB_LSTNM   Extract last name                            
         J     EXITY                                                            
*                                                                               
                                                                                
NXTLMNX  MVI   LP_RMODE,LP_RLAST                                                
         J     EXITY                                                            
         DROP  R2,RC                                                            
*                                                                               
LMWORKD  DSECT                     ** NXTLMN local w/s **                       
LMAREA   DS    XL(OB_LNQ)          approver pid optimization buffer             
LMWORKL  EQU   *-LMWORKD                                                        
*                                                                               
SVRDEF   CSECT ,                                                                
         EJECT                                                                  
***********************************************************************         
* Clear work area (RC=A(Work area), R1=L'Work area)                   *         
***********************************************************************         
                                                                                
CLRWRK   STM   RE,R1,12(RD)                                                     
         LR    R0,RC                                                            
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         LM    RE,R1,12(RD)                                                     
         BR    RE                                                               
***********************************************************************         
* GLOBAL EXITS                                                        *         
***********************************************************************         
                                                                                
SETCCC   JE    *+8                 SET CONVERSE CONDITION CODE                  
         CR    RE,RE               NOT EQUAL TO EQUAL/NOT ZERO TO ZERO          
         BR    RE                                                               
         LTR   RE,RE               EQUAL TO NOT EQUAL/ZERO TO NOT ZERO          
         BR    RE                                                               
                                                                                
NXTREC   MVI   LP_RMODE,LP_RNEXT   SET NORE TO COME                             
         J     EXITY                                                            
                                                                                
MORE     MVI   LP_RMODE,LP_RMORE   SET NORE TO COME                             
         J     EXITY                                                            
                                                                                
NOMORE   MVI   LP_RMODE,LP_RLAST   SET NO MORE RECORDS & EXIT                   
         J     EXITY                                                            
                                                                                
QERROR   MVI   LP_RMODE,LP_RERRR   SET REQUEST ERROR & EXIT                     
         J     EXITY                                                            
                                                                                
QNXROW   MVI   LP_RMODE,LP_RQUIT   SKIP CURRENT ROW                             
         J     EXIT                                                             
                                                                                
XERROR   MVI   LP_RMODE,LP_RERRR   SET REQUEST ERROR & EXIT                     
         MVI   LP_EMSYS,6                                                       
         MVI   CHKDATA1,C'Y'                                                    
         J     EXITY                                                            
                                                                                
EXITH    LHI   RE,2                                                             
         J     EXITCC                                                           
EXITL    DS    0H                                                               
EXITN    LHI   RE,0                SET CONDITION CODE TO NOT EQUAL              
         J     EXITCC                                                           
EXITY    LHI   RE,1                SET CONDITION CODE TO EQUAL                  
EXITCC   CHI   RE,1                                                             
                                                                                
EXIT     XIT1  ,                   GENERAL EXIT POINT                           
         EJECT                                                                  
***********************************************************************         
* End of requests                                                     *         
***********************************************************************         
REQUESTX LKREQ X                                                                
         LKARY T                                                                
         EJECT                                                                  
***********************************************************************         
* LOCAL ROUTINES                                                      *         
***********************************************************************         
***********************************************************************         
* Process JLSD arrays                                                 *         
***********************************************************************         
PROCARRY NTR1  BASE=*,LABEL=*                                                   
                                                                                
         LARL  R1,UINGER                                                        
         LARL  RE,TRTSPEC                                                       
         CLI   CUCTRY,CTRYGER                                                   
         JE    PARRY00                                                          
         LARL  R1,UINUKUS                                                       
         LARL  RE,TRTSGER                                                       
                                                                                
PARRY00  ST    R1,AUINTAB                                                       
         ST    RE,ASRCTAB                                                       
                                                                                
         MVI   X#JDSTAT,0          job status array                             
         NI    SAVEIND,FF-SAVEMST                                               
         OC    RQ_JDSAD,RQ_JDSAD                                                
         JZ    PARRY14                                                          
                                                                                
         USING LW_D,R1                                                          
         XR    R1,R1               point to list in WMP                         
         ICM   R1,7,RQ_JDSAD                                                    
         XR    R0,R0                                                            
         ICM   R0,3,LW_NUMN        number of entries                            
         CHI   R0,1                                                             
         JNH   PARRY02                                                          
         OI    SAVEIND,SAVEMST     indicate multiple status                     
         TM    SAVEIND,SAVEAUR     (only valid for Aura)                        
         JNZ   PARRY02                                                          
         MVC   ROUERRV,=AL2(AE$TMINF)                                           
         J     EXITN                                                            
                                                                                
PARRY02  LA    RF,LW_DATA2         start of list                                
                                                                                
PARRY04  CLI   0(RF),SUBMITED                                                   
         JNE   PARRY06                                                          
         OI    X#JDSTAT,X#JDSTSU                                                
         J     PARRY12                                                          
                                                                                
PARRY06  CLI   0(RF),REJECTED                                                   
         JNE   PARRY08                                                          
         OI    X#JDSTAT,X#JDSTRE                                                
         J     PARRY12                                                          
                                                                                
PARRY08  CLI   0(RF),APPROVED                                                   
         JNE   PARRY10                                                          
         OI    X#JDSTAT,X#JDSTAP                                                
         J     PARRY12                                                          
                                                                                
PARRY10  CLI   0(RF),MWAITING                                                   
         JNE   PARRY12                                                          
         OI    X#JDSTAT,X#JDSTMA                                                
                                                                                
PARRY12  AHI   RF,L'X#JDSTAT                                                    
         JCT   R0,PARRY04                                                       
         DROP  R1                                                               
                                                                                
PARRY14  XC    X#MEDNO,X#MEDNO     check media list                             
         XC    X#MEDLS,X#MEDLS                                                  
         XC    ELEMENT,ELEMENT                                                  
         OC    RQ_JDMAD,RQ_JDMAD                                                
         JZ    PARRY18                                                          
                                                                                
         USING LW_D,R1                                                          
         XR    R1,R1               point to list in WMP                         
         ICM   R1,7,RQ_JDMAD                                                    
         XR    R0,R0                                                            
         ICM   R0,3,LW_NUMN        number of entries                            
         STC   R0,X#MEDNO                                                       
         LA    RF,LW_DATA2         start of list                                
         LA    RE,X#MEDLS                                                       
                                                                                
PARRY16  MVC   0(L'PMDKMED,RE),0(RF)                                            
         AHI   RF,L'PMDKMED                                                     
         AHI   RE,L'PMDKMED                                                     
         JCT   R0,PARRY16                                                       
                                                                                
         CLI   X#MEDNO,1                                                        
         JE    PARRY18                                                          
         LHI   R0,L'PMDKMED                                                     
         XR    RF,RF                                                            
         ICM   RF,3,LW_NUMN                                                     
         DROP  R1                                                               
         GOTO1 VXSORT,DMCB,X#MEDLS,(RF),(R0),(R0),0                             
                                                                                
*                                  check name search list                       
PARRY18  OC    RQ_JDNAD,RQ_JDNAD                                                
         JZ    PARRY26                                                          
                                                                                
         USING LW_D,R1                                                          
         XR    R1,R1               point to list in WMP                         
         ICM   R1,7,RQ_JDNAD                                                    
         XR    R0,R0                                                            
         ICM   R0,3,LW_NUMN        number of entries                            
         LA    R5,LW_DATA2         start of list                                
         DROP  R1                                                               
                                                                                
PARRY20  L     R1,AUINTAB          translate to upper case                      
         TR    0(L'SRCKWRD1,R5),0(R1)                                           
                                                                                
         LA    R1,L'SRCKWRD1-1(R5)                                              
         LHI   R2,L'SRCKWRD1       save name and its length                     
PARRY22  CLI   0(R1),C' '                                                       
         JH    PARRY24                                                          
         BCTR  R1,0                                                             
         JCT   R2,PARRY22                                                       
         DC    H'0'                                                             
PARRY24  GOTOR TRANS4S             translate for search                         
         CHI   R2,0                                                             
         JH    *+14                                                             
         MVC   ROUERRV,=AL2(AE$RQNPC)                                           
         J     EXITN                                                            
         AHI   R5,L'SRCKWRD1                                                    
         JCT   R0,PARRY20                                                       
                                                                                
                                                                                
PARRY26  TM    SAVEIND,SAVEAUR     User fields - Aura vs. BrandOcean            
         JNZ   PARRY30                                                          
         OC    RQ_JDUAD,RQ_JDUAD                                                
         JZ    PARRY50                                                          
                                                                                
PARRY28  MVC   ROUERRV,=AL2(AE$IVUFD)                                           
         J     EXITN                                                            
                                                                                
PARRY30  CLC   RQ_JDUF1,SPACES                                                  
         JH    PARRY28                                                          
         CLC   RQ_JDUF2,SPACES                                                  
         JH    PARRY28                                                          
         CLC   RQ_JDUF3,SPACES                                                  
         JH    PARRY28                                                          
         CLC   RQ_JDUF4,SPACES                                                  
         JH    PARRY28                                                          
         CLC   RQ_JDUF5,SPACES                                                  
         JH    PARRY28                                                          
         CLC   RQ_JDUF6,SPACES                                                  
         JH    PARRY28                                                          
         CLC   RQ_JDUF7,SPACES                                                  
         JH    PARRY28                                                          
         CLC   RQ_JDUF8,SPACES                                                  
         JH    PARRY28                                                          
         CLC   RQ_JDUF9,SPACES                                                  
         JH    PARRY28                                                          
         CLC   RQ_JDUF0,SPACES                                                  
         JH    PARRY28                                                          
                                                                                
         XC    X#UFLD,X#UFLD                                                    
                                                                                
         OC    RQ_JDUAD,RQ_JDUAD   any user field array?                        
         JZ    PARRY50                                                          
                                                                                
         USING LW_D,R3                                                          
         XR    R3,R3               point to list in WMP                         
         XR    R4,R4                                                            
         ICM   R3,7,RQ_JDUAD                                                    
         XR    R0,R0                                                            
         ICM   R0,3,LW_NUMN        number of entries                            
         CHI   R0,RQ_JDUMX         current maximum                              
         JNH   PARRY32                                                          
         MVC   ROUERRV,=AL2(AE$TMINF)                                           
         J     EXITN                                                            
                                                                                
PARRY32  AHI   R3,LW_LN2Q          R3=A(first array line data)                  
         LA    R2,X#UFLDH1                                                      
                                                                                
PARRY34  CLC   0(L'UFSDESC,R3),SPACES                                           
         JNH   PARRY44                                                          
                                                                                
         L     RF,AUINTAB          translate to upper case                      
         TR    0(L'UFSDESC,R3),0(RF)                                            
                                                                                
         LA    R1,L'UFSDESC-1(R3)                                               
         LHI   RF,L'UFSDESC                                                     
PARRY36  CLI   0(R1),C' '                                                       
         JH    PARRY38                                                          
         BCTR  R1,0                                                             
         JCT   RF,PARRY36                                                       
         DC    H'0'                                                             
                                                                                
PARRY38  STC   RF,0(R2)                                                         
                                                                                
         CLC   L'UFSDESC(UFSDATMX,R3),SPACES                                    
         JNH   PARRY44                                                          
                                                                                
         L     RF,AUINTAB          translate to upper case                      
         TR    L'UFSDESC(UFSDATMX,R3),0(RF)                                     
                                                                                
         LA    R1,UFSDATMX-1+L'UFSDESC(R3)                                      
         LHI   RF,UFSDATMX                                                      
PARRY40  CLI   0(R1),C' '                                                       
         JH    PARRY42                                                          
         BCTR  R1,0                                                             
         JCT   RF,PARRY40                                                       
         DC    H'0'                                                             
                                                                                
PARRY42  STC   RF,1(R2)                                                         
                                                                                
PARRY44  AHI   R3,L'UFSDESC                                                     
         XR    RF,RF               For Aura check data type and convert         
         ICM   RF,B'0011',CUXPNUM                                               
         CHI   RF,XPRODIKQ                                                      
         JNE   PARRY48                                                          
         LA    RF,UFSDATMX(R3)                                                  
         CLI   0(RF),RQ_USFDA      Date field convert                           
         JNE   PARRY48                                                          
         MVC   X#DATD,0(R3)                                                     
         MVC   0(UFSDATMX,R3),SPACES                                            
         GOTO1 VDATCON,DMCB,(9,X#DATD),(8,0(R3))                                
*&&UK*&& OI    0(R3),X'F0'                                                      
         LR    RE,R4               any data filter?                             
         MHI   RE,X#UFLDD2-X#UFLDD1                                             
         LA    RE,X#UFLDD1(RE)                                                  
         LHI   R1,8                                                             
         CLI   CUCTRY,CTRYGBR                                                   
         JNE   *+8                                                              
         LHI   R1,7                                                             
         STC   R1,0(RE)            update length of data filter                 
         J     PARRY48                                                          
*                                                                               
PARRY48  AHI   R4,1                                                             
         AHI   R3,UFSDATMX+UFSTYPEL                                             
         AHI   R2,X#UFLDH2-X#UFLDH1                                             
         JCT   R0,PARRY34                                                       
         DROP  R3                                                               
                                                                                
PARRY50  TM    SAVEIND,SAVEAUR     for Aura see PROCARRY                        
         JNZ   EXITY                                                            
                                                                                
         XC    X#UFLD,X#UFLD       set user field filter lengths                
         LA    RE,X#UFLD                                                        
         LA    RF,RQ_JDUF1                                                      
         LA    R1,10                                                            
PARRY52  SR    R3,R3                                                            
         CLC   0(L'RQ_JDUF1,RF),SPACES                                          
         JNH   PARRY56                                                          
         LA    R2,(L'RQ_JDUF1-1)(RF)                                            
         LA    R3,L'RQ_JDUF1                                                    
PARRY54  CLI   0(R2),C' '                                                       
         JH    PARRY56                                                          
         BCTR  R2,0                                                             
         JCT   R3,PARRY54                                                       
         DC    H'0'                                                             
                                                                                
PARRY56  STC   R3,0(RE)                                                         
         AHI   RE,1                                                             
         AHI   RF,L'RQ_JDUF1                                                    
         JCT   R1,PARRY52                                                       
         J     EXITY                                                            
                                                                                
***********************************************************************         
* Apply GESRCHPARS.TRTSPEC and .TRTSGER character handling            *         
* On NTRY R4 = A(job name)                                                      
***********************************************************************         
TRANS4S  NTR1                                                                   
                                                                                
         MVC   ELEMENT(L'SRCKWRD1),0(R5)                                        
         L     R3,ASRCTAB                                                       
         TR    ELEMENT(L'SRCKWRD1),0(R3)                                        
                                                                                
         LHI   R0,L'SRCKWRD1        now squash out any unknowns (X'00')         
         LA    RE,ELEMENT                                                       
         LR    R1,R5                                                            
         MVC   0(L'SRCKWRD1,R5),SPACES                                          
                                                                                
TRANS402 CLI   0(RE),X'40'                                                      
         JE    TRANS406            exit on first space                          
         JL    TRANS404            skip zeroes                                  
         MVC   0(1,R1),0(RE)                                                    
         AHI   R1,1                                                             
                                                                                
TRANS404 AHI   RE,1                                                             
         JCT   R0,TRANS402                                                      
                                                                                
TRANS406 LA    R1,L'SRCKWRD1-1(R5)                                              
         LHI   R0,L'SRCKWRD1                                                    
                                                                                
TRANS408 CLI   0(R1),X'40'                                                      
         JH    TRANS410                                                         
         BCTR  R1,0                                                             
         JCT   R0,TRANS408                                                      
                                                                                
TRANS410 J     EXIT                                                             
                                                                                
*                                                                               
SVRDEF   CSECT ,                                                                
***********************************************************************         
* Key filter routine - ACTRECD                                        *         
***********************************************************************         
         USING ACTRECD,R2                                                       
ACTKF    NTR1                                                                   
                                                                                
         LA    R2,IOKEY                                                         
                                                                                
         CLC   IOKEY+L'ACTKCULA(L'ACTKEY-L'ACTKCULA),SPACES                     
         JH    EXITN               Are we still at job level?                   
                                                                                
         MVC   SAVEKEY1,IOKEY                                                   
                                                                                
         CLC   RQ_JDCLC,SPACES                                                  
         JNH   ACTKF02                                                          
                                                                                
         LLC   R3,PCLILEN                                                       
         BCTR  R3,0                                                             
         ST    R5,SAVER5                                                        
         BASR  R5,0                                                             
         CLC   RQ_JDCLC(0),ACTKACT                                              
         EX    R3,0(R5)                                                         
         L     R5,SAVER5                                                        
         JNE   NOMORE                                                           
                                                                                
         LLC   R3,PCLILEN                                                       
         LA    R3,ACTKACT(R3)                                                   
         CLC   0(L'RQ_JDPRO,R3),SPACES                                          
         JNH   ACTKF02                                                          
                                                                                
         CLC   RQ_JDPRO,SPACES                                                  
         JNH   ACTKF02                                                          
                                                                                
         CLC   RQ_JDPRO,0(R3)                                                   
         JNE   EXITN                                                            
                                                                                
         LLC   R3,PPROLEN                                                       
         LA    R3,ACTKACT(R3)                                                   
         CLC   0(L'RQ_JDJOB,R3),SPACES                                          
         JNH   ACTKF02                                                          
                                                                                
         CLC   RQ_JDJOB,SPACES                                                  
         JNH   ACTKF02                                                          
                                                                                
         CLC   RQ_JDJOB,0(R3)                                                   
         JNE   EXITN                                                            
                                                                                
ACTKF02  TM    ACTKSTAT,ACTSABLP                                                
         JNZ   ACTKF08                                                          
                                                                                
         CLI   RQ_JDCST,YESQ                                                    
         JE    ACTKF04                                                          
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    ACTKF04                                                          
         CLI   RQ_JDLST,YESQ                                                    
         JE    ACTKF04                                                          
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    ACTKF04                                                          
                                                                                
         TM    ACTKSTAT,ACTSLOCK                                                
         JZ    ACTKF04                                                          
         LLC   RE,PPROLEN             Save product length                       
         LR    RF,RE                                                            
         LLC   RE,PCLILEN             Save client length                        
         SR    RF,RE                  only product length                       
         BCTR  RF,0                                                             
         LA    RE,ACTKACT(RE)         Point to product                          
         BASR  R3,0                                                             
         CLC   SPACES(0),0(RE)        client record                             
         EX    RF,0(R3)                                                         
         JNE   ACTKF03                no,check for product record               
         MVC   X#CLIOFF,SPACES        clear previous client                     
         MVC   X#POFF,SPACES                                                    
         J     EXITN                                                            
ACTKF03  LLC   RE,PJOBLEN             Save job length                           
         LR    RF,RE                                                            
         LLC   RE,PPROLEN             Save product length                       
         SR    RF,RE                  only job length                           
         BCTR  RF,0                                                             
         LA    RE,ACTKACT(RE)         Point to job                              
         BASR  R3,0                                                             
         CLC   SPACES(0),0(RE)        product Record                            
         EX    RF,0(R3)                                                         
         JE    EXITN                  no,exit                                   
         MVC   X#PROOFF,SPACES        clear previous product                    
         MVC   X#POFF,SPACES                                                    
         J     EXITN                                                            
                                                                                
ACTKF04  CLI   RQ_JDDRA,C'O'                                                    
         JNE   ACTKF06                                                          
         TM    ACTKSTAT,ACTSDRFT                                                
         JZ    EXITN                                                            
         J     EXITY                                                            
                                                                                
ACTKF06  CLI   RQ_JDDRA,NOQ                                                     
         JNE   EXITY                                                            
         TM    ACTKSTAT,ACTSDRFT                                                
         JZ    EXITY                                                            
                                                                                
ACTKF08  MVC   SAVEKEY3,IOKEY                                                   
                                                                                
         GOTOR XJOBDIR                                                          
         JNE   EXITN                                                            
                                                                                
         GOTOR XMULSTA,ACTKEY                                                   
         JNE   EXITN                                                            
                                                                                
         MVC   SAVEKEY1,IOKEY                                                   
                                                                                
         J     EXITY                                                            
         DROP  R2                                                               
                                                                                
***********************************************************************         
* Rec filter routine - ACTRECD                                        *         
***********************************************************************         
         USING ACTRECD,R2                                                       
ACTRF    NTR1                                                                   
                                                                                
         MVI   X#CLISW,NOQ                                                      
                                                                                
         L     R2,AIO2                                                          
                                                                                
         LLC   R3,PPROLEN                                                       
         LR    RF,R3                                                            
         LLC   R3,PCLILEN                                                       
         SR    RF,R3                                                            
         BCTR  RF,0                                                             
         LA    R3,ACTKACT(R3)                                                   
         BASR  R5,0                                                             
         CLC   SPACES(0),0(R3)                                                  
         EX    RF,0(R5)                                                         
         JNE   *+8                                                              
         MVI   X#CLISW,YESQ                                                     
                                                                                
         TM    ACTRSTAT,ACTSABLP                                                
         JNZ   ACTRF20                                                          
                                                                                
         GOTOR XJOBGOF                                                          
                                                                                
         CLI   X#CLISW,YESQ                                                     
         JNE   ACTRF00                                                          
                                                                                
         L     RE,AIO2               COPY CLIENT                                
         L     R0,AIO4                                                          
         LA    R1,IOLENQ                                                        
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
         MVC   X#CLIOFF,SPACES                                                  
         MVC   X#CLIOFF,X#AOFF                                                  
*        J     ACTRF02             <<<DSRD-23669 fix                            
                                                                                
ACTRF00  MVC   X#PROOFF,X#AOFF                                                  
                                                                                
ACTRF02  CLC   X#PROOFF,SPACES                                                  
         JNH   ACTRF04                                                          
         MVC   X#POFF,X#PROOFF                                                  
         J     ACTRF06                                                          
                                                                                
ACTRF04  CLC   X#CLIOFF,SPACES                                                  
         JNH   ACTRF06                                                          
         MVC   X#POFF,X#CLIOFF                                                  
                                                                                
         USING OFFALD,R1                                                        
ACTRF06  L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,X#POFF     validate current office                      
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL                                                           
         JNE   EXITN                                                            
         DROP  R1                                                               
*                                                                               
ACTRF08  CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    ACTRF10                                                          
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    ACTRF10                                                          
         CLI   RQ_JDLST,YESQ       include locked jobs?                         
         JE    ACTRF10                                                          
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    ACTRF10                                                          
                                                                                
         TM    ACTKSTAT,ACTSLOCK                                                
         JNZ   EXITN                                                            
                                                                                
         USING NAMELD,R3                                                        
ACTRF10  LA    R3,ACTRFST                                                       
ACTRF12  CLI   NAMEL,NAMELQ                                                     
         JE    ACTRF14                                                          
         CLI   NAMEL,0                                                          
         JE    *+2                                                              
         LLC   R0,NAMLN                                                         
         AR    R3,R0                                                            
         J     ACTRF12                                                          
ACTRF14  LLC   RE,NAMLN                                                         
         SHI   RE,NAMLN1Q+1                                                     
         CLI   X#CLISW,YESQ                                                     
         JNE   ACTRF16                                                          
         MVC   JD_CLN,SPACES                                                    
         BASR  R4,0                                                             
         MVC   JD_CLN(0),NAMEREC                                                
         EX    RE,0(R4)                                                         
         J     ACTRF18                                                          
                                                                                
ACTRF16  MVC   JD_PRN,SPACES                                                    
         BASR  R4,0                                                             
         MVC   JD_PRN(0),NAMEREC                                                
         EX    RE,0(R4)                                                         
                                                                                
ACTRF18  CLI   X#CLISW,YESQ                                                     
         JE    EXITN                                                            
         L     RE,AIO2             COPY PRODUCT                                 
         L     R0,AIO5                                                          
         LA    R1,IOLENQ                                                        
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         J     EXITN                                                            
                                                                                
         DROP  R3                                                               
                                                                                
ACTRF20  MVI   X#GAPIND,0                                                       
                                                                                
         L     RE,AIO2             Copy Job                                     
         L     R0,AIO6                                                          
         LA    R1,IOLENQ                                                        
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
         CLC   RQ_JDOFF,SPACES     apply office filter if passed                
         JNH   ACTRF22                                                          
         CLC   RQ_JDOFF,X#POFF                                                  
         JNE   EXITN                                                            
                                                                                
ACTRF22  GOTOR XNAMFLT             extra name filtering                         
         JNE   EXITN                                                            
         GOTOR XJOBFLT             filter job record                            
         JNE   EXITN                                                            
                                                                                
         J     EXITY                                                            
         DROP  R2                                                               
                                                                                
***********************************************************************         
* Key filter routine - DRAPASD                                        *         
***********************************************************************         
         SPACE 1                                                                
         USING DRAPASD,R2                                                       
DRAKF    NTR1  LABEL=*                                                          
                                                                                
         MVC   SAVEKEY1,IOKEY                                                   
                                                                                
         LA    R2,IOKEY                                                         
                                                                                
         GOTOR CASCLI,DRAPACT                                                   
         JNE   EXITN                                                            
                                                                                
         GOTOR CASPRO,DRAPACT                                                   
         JNE   EXITN                                                            
                                                                                
         GOTOR XJOBDRA                                                          
         JH    QNXROW                                                           
         JNE   EXITN                                                            
                                                                                
         GOTOR XMULSTA,DRAPAS                                                   
         JNE   EXITN                                                            
                                                                                
         J     EXITY                                                            
                                                                                
         DROP  R2                                                               
                                                                                
         EJECT                                                                  
***********************************************************************         
* Rec filter routine - DRAPASD                                        *         
***********************************************************************         
DRARF    NTR1  LABEL=*                                                          
         MVI   X#GAPIND,0                                                       
                                                                                
         L     RE,AIO2               COPY Job                                   
         L     R0,AIO6                                                          
         LA    R1,IOLENQ                                                        
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
         GOTOR XNAMFLT                                                          
         JNE   EXITN                                                            
                                                                                
         GOTOR XJOBFLT                                                          
         JNE   EXITN                                                            
                                                                                
         J     EXITY                                                            
                                                                                
***********************************************************************         
* Key filter routine - SRCRECD                                        *         
***********************************************************************         
         USING SRCRECD,R2                                                       
SRCKF    NTR1                                                                   
         LA    R2,IOKEY                                                         
                                                                                
         MVC   SAVEKEY1,IOKEY                                                   
                                                                                
         TM    SRCKSTAT,ACTSABLP                                                
         JZ    EXITN                                                            
                                                                                
         GOTOR CASCLI,SRCKACT                                                   
         JNE   EXITN                                                            
                                                                                
         GOTOR CASPRO,SRCKACT                                                   
         JNE   EXITN                                                            
                                                                                
         CLC   RQ_JDOFF,SPACES                                                  
         JNH   SRCKF02                                                          
                                                                                
         CLC   RQ_JDOFF,SRCKSOFF                                                
         JNE   EXITN                                                            
                                                                                
         USING OFFALD,R1                                                        
SRCKF02  L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,SRCKSOFF                                                
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL                                                           
         JNE   EXITN                                                            
         MVC   X#POFF,SRCKSOFF                                                  
         DROP  R1                                                               
                                                                                
         GOTOR XJOBPAS                                                          
         JNE   EXITN                                                            
                                                                                
         GOTOR XMULSTA,SRCKEY                                                   
         JNE   EXITN                                                            
                                                                                
         GOTOR CHKDUP,SRCKACT                                                   
         JE    EXITN                                                            
                                                                                
         CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    SRCKF03A                                                         
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    SRCKF03B                                                         
         TM    SRCKSTAT,ACTSCLOS   job closed?                                  
         JNZ   EXITN                                                            
         J     SRCKF03B                                                         
                                                                                
SRCKF03A TM    SRCKSTAT,ACTSCLOS   job closed?                                  
         JZ    EXITN                                                            
                                                                                
SRCKF03B CLI   RQ_JDLST,YESQ       include locked?                              
         JE    SRCKF06                                                          
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    SRCKF04                                                          
                                                                                
         TM    SRCKSTAT,ACTSLOCK   job locked?                                  
         JNZ   EXITN                                                            
         J     SRCKF06                                                          
                                                                                
SRCKF04  TM    SRCKSTAT,ACTSLOCK   job locked?                                  
         JZ    EXITN                                                            
                                                                                
SRCKF06  CLI   RQ_JDDRA,C'O'       drafts only?                                 
         JNE   SRCKF08                                                          
         TM    SRCKSTAT,ACTSDRFT                                                
         JZ    EXITN                                                            
         J     SRCKF10                                                          
                                                                                
SRCKF08  CLI   RQ_JDDRA,NOQ        drafts not?                                  
         JNE   SRCKF10                                                          
         TM    SRCKSTAT,ACTSDRFT                                                
         JNZ   EXITN                                                            
                                                                                
SRCKF10  CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    SRCKF16                                                          
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    SRCKF18                                                          
                                                                                
         TM    SRCKSTAT,ACTSCLOS   job closed no                                
         JNZ   EXITN                                                            
         J     SRCKF18                                                          
                                                                                
SRCKF16  TM    SRCKSTAT,ACTSCLOS   job closed yes (only)                        
         JZ    EXITN                                                            
         J     SRCKF18                                                          
                                                                                
SRCKF18  DS    0H                  more filtering here                          
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Rec filter routine - SRCRECD                                        *         
***********************************************************************         
         SPACE 1                                                                
         USING ACTRECD,R2                                                       
SRCRF    NTR1                                                                   
         MVI   X#GAPIND,0                                                       
                                                                                
         L     RE,AIO2             Copy Job                                     
         L     R0,AIO6                                                          
         LA    R1,IOLENQ                                                        
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
         GOTOR XNAMFLT                                                          
         JNE   EXITN                                                            
         GOTOR XJOBFLT                                                          
         JNE   EXITN                                                            
                                                                                
         L     R2,AIO2                                                          
         GOTOR ADDDUP,ACTKACT                                                   
                                                                                
         J     EXITY                                                            
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* Key filter routine - PIDRECD                                        *         
***********************************************************************         
         USING PIDRECD,R2                                                       
PIDKF    NTR1                                                                   
         LA    R2,IOKEY                                                         
                                                                                
         MVC   SAVEKEY1,IOKEY                                                   
                                                                                
         GOTOR CASCLI,PIDKACC                                                   
         JNE   EXITN                                                            
                                                                                
         GOTOR CASPRO,PIDKACC                                                   
         JNE   EXITN                                                            
                                                                                
         GOTOR XJOBPID                                                          
*        JH    EXITY                                                            
         JNE   EXITN                                                            
                                                                                
         GOTOR XMULSTA,PIDKEY                                                   
         JNE   EXITN                                                            
                                                                                
         J     EXITY                                                            
                                                                                
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* Rec filter routine - PIDRECD                                        *         
***********************************************************************         
PIDRF    NTR1                                                                   
         MVI   X#GAPIND,0                                                       
                                                                                
         L     RE,AIO2             Copy Job                                     
         L     R0,AIO6                                                          
         LA    R1,IOLENQ                                                        
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
         GOTOR XNAMFLT                                                          
         JNE   EXITN                                                            
                                                                                
         GOTOR XJOBFLT                                                          
         JNE   EXITN                                                            
                                                                                
         J     EXITY                                                            
                                                                                
***********************************************************************         
* Key filter routine - JDTRECD                                        *         
***********************************************************************         
JDTKF    NTR1                                                                   
         MVC   SAVEKEY1,IOKEY                                                   
                                                                                
         GOTOR XCHKJDT                                                          
         JNE   EXITN                                                            
         J     EXITY                                                            
                                                                                
***********************************************************************         
* Rec filter routine - JDTRECD                                        *         
***********************************************************************         
JDTRF    NTR1                                                                   
         MVI   X#GAPIND,0                                                       
                                                                                
         L     RE,AIO2             Copy Job                                     
         L     R0,AIO6                                                          
         LA    R1,IOLENQ                                                        
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
         GOTOR XNAMFLT                                                          
         JNE   EXITN                                                            
                                                                                
         GOTOR XJOBFLT                                                          
         JNE   EXITN                                                            
                                                                                
         J     EXITY                                                            
                                                                                
***********************************************************************         
* Key filter routine - New Call (1,6,7) - User Approved/Added/Assigned*         
***********************************************************************         
         USING PIDRECD,R2                                                       
APDKF    NTR1                                                                   
         LA    R2,IOKEY                                                         
                                                                                
         MVC   SAVEKEY1,IOKEY                                                   
                                                                                
         GOTOR CASCLI,PIDKACC                                                   
         JNE   EXITN                                                            
                                                                                
         GOTOR CASPRO,PIDKACC                                                   
         JNE   EXITN                                                            
                                                                                
         CLI   RQ_JDTYP,RQ_JDT7Q                                                
         JE    *+14                                                             
                                                                                
         CLC   PIDKADAT,X#13MDAT                                                
         JL    EXITN                                                            
                                                                                
         CLI   RQ_JDTYP,RQ_JDT7Q   User assigned list call                      
         JNE   APDKF02                                                          
                                                                                
         GOTOR XJOBPID                                                          
         JNE   EXITN                                                            
         J     APDKF06                                                          
                                                                                
APDKF02  TM    PIDKSTAT,ACTSCLOS+ACTSLOCK                                       
         JNZ   EXITN                                                            
                                                                                
APDKF06  CLC   RQ_JDOFF,SPACES                                                  
         JNH   APDKF08                                                          
                                                                                
*&&UK*&& CLC   RQ_JDOFF,PIDKEY+ACTKSUFA-ACTRECD                                 
*&&US*&& CLC   RQ_JDOFF,PIDKEY+ACTKSOFF-ACTRECD                                 
         JNE   EXITN                                                            
                                                                                
         USING OFFALD,R1                                                        
APDKF08  L     R1,AOFFAREA                                                      
*&&UK*&& MVC   OFFAOFFC,PIDKEY+ACTKSUFA-ACTRECD                                 
*&&US*&& MVC   OFFAOFFC,PIDKEY+ACTKSOFF-ACTRECD                                 
         MVC   X#POFF,OFFAOFFC                                                  
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL                                                           
         JNE   EXITN                                                            
         J     EXITY                                                            
         DROP  R1                                                               
                                                                                
***********************************************************************         
* Rec filter routine - New Call (1,6,7) - User Approved/Added/Assigned*         
***********************************************************************         
         USING ACTRECD,R2                                                       
APDRF    NTR1                                                                   
         L     R2,AIO2                                                          
                                                                                
         L     RE,AIO2             Copy Job                                     
         L     R0,AIO6                                                          
         LA    R1,IOLENQ                                                        
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
         MVI   X#GAPIND,0                                                       
                                                                                
         TM    ACTRSTAT,ACTSDELT   skip deleted jobs                            
         JNZ   EXITN                                                            
                                                                                
         GOTOR XNAMFLT                                                          
         JNE   EXITN                                                            
                                                                                
         GOTOR XJOBFLT                                                          
         JNE   EXITN                                                            
                                                                                
         CLI   RQ_JDTYP,RQ_JDTNQ   New status call?                             
         JNH   *+12                No                                           
         CLI   RQ_JDTYP,RQ_JDT7Q                                                
         JNE   EXITY                                                            
                                                                                
         GOTOR FLTLIM,ACTKACT                                                   
         JNE   EXITN                                                            
                                                                                
         J     EXITY                                                            
         DROP  R2                                                               
***********************************************************************         
* Key filter routine - New Call (4 & 5) - User Added/Draft/Rejected   *         
***********************************************************************         
         USING DRAPASD,R2                                                       
UDDKF    NTR1                                                                   
         LA    R2,IOKEY                                                         
         MVC   SAVEKEY1,IOKEY                                                   
                                                                                
         CLC   DRAPPID,QCCTPID                                                  
         JNE   EXITN                                                            
                                                                                
         GOTOR CASCLI,DRAPACT                                                   
         JNE   EXITN                                                            
                                                                                
         GOTOR CASPRO,DRAPACT                                                   
         JNE   EXITN                                                            
                                                                                
         CLC   RQ_JDOFF,SPACES                                                  
         JNH   UDDKF02                                                          
                                                                                
         CLC   RQ_JDOFF,DRAPSOFF                                                
         JNE   EXITN                                                            
                                                                                
         USING OFFALD,R1                                                        
UDDKF02  L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,DRAPSOFF                                                
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL              validate office                              
         JNE   EXITN                                                            
         MVC   X#POFF,DRAPSOFF                                                  
         DROP  R1                                                               
                                                                                
         J     EXITY                                                            
***********************************************************************         
* Rec filter routine - New Call (4 & 5) - User Added/Draft/Rejected   *         
***********************************************************************         
         USING ACTRECD,R2                                                       
UDDRF    NTR1                                                                   
         L     R2,AIO2                                                          
                                                                                
         L     RE,AIO2             Copy Job                                     
         L     R0,AIO6                                                          
         LA    R1,IOLENQ                                                        
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
         MVI   X#GAPIND,0                                                       
                                                                                
         TM    ACTRSTAT,ACTSDELT   skip deleted jobs                            
         JNZ   EXITN                                                            
                                                                                
         TM    ACTRSTAT,ACTSCLOS   skip closed jobs                             
         JNZ   EXITN                                                            
                                                                                
         USING JOBELD,R3                                                        
         LA    R3,ACTRFST                                                       
         MVI   TMPBYTE1,NOQ                                                     
UDDRF02  CLI   JOBEL,JOBELQ                                                     
         JE    UDDRF06                                                          
         CLI   JOBEL,0                                                          
         JE    UDDRF08                                                          
                                                                                
UDDRF04  LLC   R0,JOBLN                                                         
         AR    R3,R0                                                            
         J     UDDRF02                                                          
                                                                                
UDDRF06  CLI   JOBLN,JOBLN3Q                                                    
         JL    UDDRF04                                                          
         MVI   TMPBYTE1,YESQ                                                    
         MVI   BYTE2,RQ_JDT4Q                                                   
         TM    JOBSTA2,JOBSREJ                                                  
         JZ    *+8                                                              
         MVI   BYTE2,RQ_JDT5Q                                                   
         CLC   BYTE2,RQ_JDTYP      if wrong draft/reject status skip            
         JNE   EXITN                                                            
         J     UDDRF04                                                          
UDDRF08  CLI   TMPBYTE1,YESQ          skip if no job element found              
         JNE   EXITN                                                            
         J     EXITY                                                            
         DROP  R2,R3                                                            
                                                                                
***********************************************************************         
* Key filter routine - New Call (2) - User Rejected                   *         
***********************************************************************         
         USING DRAPASD,R2                                                       
RELKF    NTR1                                                                   
         LA    R2,IOKEY                                                         
         MVC   SAVEKEY1,IOKEY                                                   
                                                                                
         GOTOR CASCLI,DRAPACT                                                   
         JNE   EXITN                                                            
                                                                                
         GOTOR CASPRO,DRAPACT                                                   
         JNE   EXITN                                                            
                                                                                
         CLC   RQ_JDOFF,SPACES                                                  
         JNH   RELKF02                                                          
         CLC   RQ_JDOFF,DRAPSOFF                                                
         JNE   EXITN                                                            
                                                                                
         USING OFFALD,R1                                                        
RELKF02  L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,DRAPSOFF                                                
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL              validate office                              
         JNE   EXITN                                                            
         MVC   X#POFF,DRAPSOFF                                                  
         J     EXITY                                                            
         DROP  R1                                                               
***********************************************************************         
* Rec filter routine - New Call (2) - User Rejected                   *         
***********************************************************************         
         USING ACTRECD,R2                                                       
RELRF    NTR1                                                                   
         L     R2,AIO2                                                          
                                                                                
         L     RE,AIO2             Copy Job                                     
         L     R0,AIO6                                                          
         LA    R1,IOLENQ                                                        
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
         MVI   X#GAPIND,0                                                       
                                                                                
         TM    ACTRSTAT,ACTSDELT   skip deleted jobs                            
         JNZ   EXITN                                                            
         TM    ACTRSTAT,ACTSCLOS                                                
         JNZ   EXITN                                                            
                                                                                
         USING STCELD,R3                                                        
         LA    R3,ACTRFST                                                       
         XR    R0,R0                                                            
         MVI   X#BYTE1,NOQ                                                      
         MVI   X#BYTE2,NOQ                                                      
                                                                                
RELRF02  CLI   STCEL,0                                                          
         JE    RELRF08                                                          
         CLI   STCEL,JOBELQ                                                     
         JE    RELRF06                                                          
         CLI   STCEL,STCELQ        STCELs held in AUDRECD, too                  
         JNE   RELRF04             - see REJECTER (note: REJECT08               
         CLI   STCIND,STCIJOB        STCIND,STCIACT not applied here)           
         JNE   RELRF04                                                          
         CLI   STCDTO,C'R'         rejection?                                   
         JNE   RELRF04                                                          
         CLC   STCPERS,QCCTPID                                                  
         JNE   RELRF04                                                          
         MVI   X#BYTE2,YESQ                                                     
                                                                                
RELRF04  IC    R0,STCLN                                                         
         AR    R3,R0                                                            
         J     RELRF02                                                          
                                                                                
         USING JOBELD,R3                                                        
RELRF06  CLI   JOBLN,JOBLN3Q                                                    
         JL    RELRF04                                                          
         TM    JOBSTA2,JOBSREJ                                                  
         JZ    RELRF04                                                          
         MVI   X#BYTE1,YESQ                                                     
         J     RELRF04                                                          
                                                                                
RELRF08  CLI   X#BYTE1,YESQ        skip if no rejection found                   
         JNE   EXITN                                                            
                                                                                
         CLI   X#BYTE2,YESQ        if user did reject then no need for          
         JE    EXITY               REJECTER                                     
                                                                                
         GOTOR REJECTER,ACTKULA                                                 
         MVC   IOKEY,SAVEKEY1                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         CLI   X#CONREJ,YESQ                                                    
         JNE   EXITN                                                            
                                                                                
         J     EXITY                                                            
         DROP  R2,R3                                                            
                                                                                
***********************************************************************         
* Key filter routine - New Call (3) - User needs to approve           *         
***********************************************************************         
         USING DRAPASD,R2                                                       
NADKF    NTR1                                                                   
         LA    R2,IOKEY                                                         
                                                                                
         MVC   SAVEKEY1,IOKEY                                                   
                                                                                
         TM    DRAPSTAT,ACTSDELT   Ignore deleted accounts                      
         JNZ   EXITN                                                            
                                                                                
         CLC   DRAPPID,QCCTPID     cannot approve your own jobs                 
         JE    EXITN                                                            
                                                                                
         GOTOR CASCLI,DRAPACT                                                   
         JNE   EXITN                                                            
                                                                                
         GOTOR CASPRO,DRAPACT                                                   
         JNE   EXITN                                                            
                                                                                
         CLC   RQ_JDOFF,SPACES     apply office filter if passed                
         JNH   NADKF02                                                          
         CLC   RQ_JDOFF,DRAPSOFF                                                
         JNE   EXITN                                                            
                                                                                
         USING OFFALD,R1                                                        
NADKF02  L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,DRAPSOFF                                                
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL                                                           
         JNE   EXITN                                                            
         MVC   X#POFF,DRAPSOFF                                                  
         DROP  R1                                                               
                                                                                
         MVI   X#GAPIND,0                                                       
                                                                                
         GOTOR CHKJAL                                                           
         JNE   EXITN                                                            
                                                                                
         J     EXITY                                                            
         DROP  R2                                                               
                                                                                
***********************************************************************         
* Rec filter routine - New Call (3) - User needs to approve           *         
***********************************************************************         
         USING ACTRECD,R2                                                       
NADRF    NTR1                                                                   
         L     R2,AIO2                                                          
                                                                                
         L     RE,AIO2             Copy Job                                     
         L     R0,AIO6                                                          
         LA    R1,IOLENQ                                                        
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
         TM    ACTRSTAT,ACTSDRFT   Is account really draft                      
         JZ    EXITN               No - get next record                         
         TM    ACTRSTAT,ACTSDELT   Ignore deleted accounts                      
         JNZ   EXITN                                                            
                                                                                
         USING JOBELD,R3                                                        
         LA    R3,ACTRFST                                                       
         XR    R0,R0                                                            
         MVI   X#BYTE1,NOQ                                                      
         MVI   X#BYTE2,0                                                        
                                                                                
NADRF02  CLI   JOBEL,JOBELQ                                                     
         JE    NADRF06                                                          
         CLI   JOBEL,STCELQ                                                     
         JE    NADRF08                                                          
         CLI   JOBEL,0                                                          
         JE    NADRF10                                                          
                                                                                
NADRF04  IC    R0,JOBLN                                                         
         AR    R3,R0                                                            
         J     NADRF02                                                          
                                                                                
NADRF06  CLI   JOBLN,JOBLN3Q                                                    
         JL    NADRF04                                                          
         MVI   X#BYTE1,YESQ                                                     
         TM    JOBSTA2,JOBSREJ     take all non rejected ones                   
         JNZ   EXITN                                                            
         OI    X#BYTE2,X'08'                                                    
         J     NADRF04                                                          
                                                                                
         USING STCELD,R3                                                        
NADRF08  CLI   STCIND,STCIJOB      STCELs held in AUDRECD, too                  
         JNE   NADRF04             - see REJECTER (note: REJECT08               
         CLI   STCDTO,C'R'           STCIND,STCIACT not applied her             
         JNE   NADRF04                                                          
         OI    X#BYTE2,X'80'                                                    
         CLC   STCPERS,CCTPID      own rejection?                               
         JNE   NADRF04                                                          
         OI    X#BYTE2,X'01'                                                    
         J     NADRF04                                                          
                                                                                
NADRF10  CLI   X#BYTE1,YESQ        skip if no job element found                 
         JNE   EXITN                                                            
         TM    X#BYTE2,X'08'       take non rejected ones                       
         JNZ   EXITY               ### decide whether taking other              
         J     EXITN               or own rejections? ###                       
                                                                                
         DROP  R2,R3                                                            
***********************************************************************         
* filter job on directory record                                      *         
***********************************************************************         
         USING ACTRECD,R2                                                       
XJOBDIR  NTR1  BASE=*,LABEL=*                                                   
                                                                                
         LA    R2,IOKEY                                                         
                                                                                
XJOBD02  LLC   RE,PPROLEN          filter on media code                         
         LR    RF,RE                                                            
         LA    RE,ACTKACT(RE)                                                   
         CLI   X#MEDNO,1                                                        
         JL    XJOBD10                                                          
         JE    XJOBD06                                                          
                                                                                
         LA    RF,X#MEDLS          loop through list                            
         LLC   R0,X#MEDNO                                                       
XJOBD04  CLC   0(L'PMDKMED,RF),0(RE)                                            
         JE    XJOBD10                                                          
         AHI   RF,L'PMDKMED                                                     
         JCT   R0,XJOBD04                                                       
         LLC   RF,PPROLEN                                                       
         LA    RF,ACTKACT(RF)                                                   
         LLC   R1,0(RF)                                                         
         AHI   R1,1                                                             
         STC   R1,0(RF)                                                         
         MVI   1(RF),C' '                                                       
         J     EXITN                                                            
                                                                                
XJOBD06  CLC   X#MEDLS(L'PMDKMED),0(RE)                                         
         JE    XJOBD10                                                          
         JH    XJOBD08                                                          
                                                                                
         LA    R1,L'ACTKACT        if past then set to next product             
         LLC   RF,PPROLEN                                                       
         SR    R1,RF                                                            
         BCTR  R1,0                                                             
         MVC   0(0,RE),SPACES                                                   
         EX    R1,*-6                                                           
         MVI   0(RE),FF                                                         
         J     EXITN                                                            
                                                                                
XJOBD08  LA    R1,L'ACTKACT        set to media code filter                     
         LLC   RF,PPROLEN                                                       
         SR    R1,RF                                                            
         BCTR  R1,0                                                             
         MVC   0(0,RE),SPACES                                                   
         EX    R1,*-6                                                           
         MVC   0(1,RE),X#MEDLS                                                  
         J     EXITN                                                            
                                                                                
XJOBD10  GOTOR FLTLIM,ACTKACT      filter on limit lists                        
         JNE   EXITN                                                            
                                                                                
***      close status see XJOBD22                                               
         CLI   RQ_JDLST,YESQ       include locked?                              
         JE    XJOBD14                                                          
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    XJOBD12                                                          
                                                                                
         TM    ACTKSTAT,ACTSLOCK   job locked?                                  
         JNZ   EXITN                                                            
         J     XJOBD14                                                          
                                                                                
XJOBD12  TM    ACTKSTAT,ACTSLOCK   job locked?                                  
         JZ    EXITN                                                            
                                                                                
XJOBD14  CLI   RQ_JDDRA,C'O'       drafts only?                                 
         JNE   XJOBD16                                                          
         TM    ACTKSTAT,ACTSDRFT                                                
         JZ    EXITN                                                            
         J     XJOBD18                                                          
                                                                                
XJOBD16  CLI   RQ_JDDRA,NOQ        drafts not?                                  
         JNE   XJOBD18                                                          
         TM    ACTKSTAT,ACTSDRFT                                                
         JNZ   EXITN                                                            
                                                                                
XJOBD18  LA    RE,RQ_JDF1V         filter on filters                            
         LA    RF,ACTKSAF1                                                      
         LHI   R1,5                                                             
                                                                                
XJOBD20  CLI   0(RE),C' '                                                       
         JNH   XJOBD22                                                          
                                                                                
         CLC   0(1,RF),0(RE)                                                    
         JNE   EXITN                                                            
                                                                                
XJOBD22  AHI   RE,1                                                             
         AHI   RF,1                                                             
         JCT   R1,XJOBD20                                                       
                                                                                
         CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    XJOBD24                                                          
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    XJOBD26                                                          
                                                                                
         TM    ACTKSTAT,ACTSCLOS   job closed no                                
         JNZ   EXITN                                                            
         J     XJOBD26                                                          
                                                                                
XJOBD24  TM    ACTKSTAT,ACTSCLOS   job closed yes (only)                        
         JZ    EXITN                                                            
         J     XJOBD26                                                          
                                                                                
XJOBD26  J     EXITY               both                                         
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* Filter on media and product/job limit lists                         *         
***********************************************************************         
GAP      USING GAPTABD,GAPAREA                                                  
FLTLIM   NTR1  BASE=*,LABEL=*                                                   
         MVI   X#LLIN2,0                                                        
*                                                                               
         LR    R2,R1               point to SJ account code                     
         LLC   R3,PPROLEN                                                       
         AR    R3,R2               point to media code                          
         CLI   RQ_JDOVR,YESQ       Do we have override on                       
         JE    EXITY               Yes - let it all through                     
*                                  Read back from TSAR check security           
         XC    GAPAREA,GAPAREA                                                  
         XC    ATSRERRS,ATSRERRS                                                
         GOTOR (#GOATSR,AGOATSR),DMCB,('TSARDH',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
         J     FLTLIM04                                                         
*                                                                               
FLTLIM02 GOTOR (#GOATSR,AGOATSR),DMCB,('TSANXT',ATSRERRS),0,GAPAREA,   +        
               TSARABUF                                                         
*                                                                               
FLTLIM04 TM    ATSRERRS,TSEEOF      Hit the end?                                
         JZ    FLTLIM06                                                         
         TM    X#LLIN2,X#LCPJQ+X#LMEDQ Passed CPJ and media filtering?          
         JO    EXITY                                                            
         J     EXITN                                                            
*                                                                               
FLTLIM06 CLI   GAP.GAPTDAT1,GAPTT2Q SJ entry                                    
         JNE   FLTLIM12                                                         
         CLC   GAP.GAPTCODE,SPACES All access entry then ok                     
         JH    *+14                                                             
         CLC   GAP.GAPTCOFF,SPACES Any office?                                  
         JNH   FLTLIM10                                                         
*                                                                               
         LA    R4,GAP.GAPTACC                                                   
         LLC   R1,PCLILEN          Determine limlist entry level                
         LR    RF,R1                                                            
         AR    RF,R4                                                            
         CLI   0(RF),C' '                                                       
         JNH   FLTLIM08                                                         
         LLC   R1,PPROLEN                                                       
         LR    RF,R1                                                            
         AR    RF,R4                                                            
         CLI   0(RF),C' '                                                       
         JNH   FLTLIM08                                                         
         LLC   R1,PJOBLEN                                                       
*                                                                               
FLTLIM08 BCTR  R1,0                                                             
         BASR  RF,0                                                             
         CLC   GAP.GAPTACC(0),0(R2)   Match on SJ account code                  
         EX    R1,0(RF)                                                         
         JNE   FLTLIM02                                                         
*                                                                               
FLTLIM10 CLC   GAP.GAPTCOFF,SPACES Check office code                            
         JNH   *+14                                                             
         CLC   GAP.GAPTCOFF,X#POFF                                              
         JNE   FLTLIM02                                                         
         OI    X#LLIN2,X#LCPJQ     Set CPJ limlist found                        
         J     FLTLIM02                                                         
*                                                                               
FLTLIM12 CLI   GAP.GAPTDAT1,GAPTT5Q media entry                                 
         JNE   FLTLIM02                                                         
         CLC   GAP.GAPTCODE,SPACES All access entry then ok                     
         JNH   *+14                                                             
         CLC   GAP.GAPTMEDI,0(R3)                                               
         JNE   FLTLIM02                                                         
         OI    X#LLIN2,X#LMEDQ                                                  
         J     FLTLIM02                                                         
         EJECT                                                                  
         DROP  GAP                                                              
***********************************************************************         
* Directory filter for multiple status scenario                       *         
***********************************************************************         
XMULSTA  NTR1  BASE=*,LABEL=*                                                   
                                                                                
         NI    SAVEIND,FF-SAVEPMA                                               
         LR    R2,R1               point to key                                 
                                                                                
         USING ACTRECD,R2                                                       
         TM    SAVEIND,SAVEMST                                                  
         JZ    XMULST06                                                         
         CLI   X#PTYP,REQTSRCQ                                                  
         JE    XMULST10                                                         
XMULST02 TM    X#JDSTAT,X#JDSTRE+X#JDSTMA+X#JDSTSU                              
         JZ    XMULST04                                                         
         CLI   X#PTYP,REQTDRAQ                                                  
         JE    XMULST04                                                         
         TM    ACTKSTAT,ACTSDRFT                                                
         JZ    EXITN                                                            
                                                                                
XMULST04 TM    X#JDSTAT,X#JDSTAP                                                
         JZ    XMULST06                                                         
         CLI   X#PTYP,REQTDRAQ                                                  
         JE    EXITN                                                            
         TM    ACTKSTAT,ACTSDRFT                                                
         JNZ   EXITN                                                            
         DROP  R2                                                               
                                                                                
XMULST06 TM    X#JDSTAT,X#JDSTMA                                                
         JZ    XMULST08                                                         
         CLI   X#PTYP,REQTDRAQ                                                  
         JNE   XMULST08                                                         
                                                                                
         USING DRAPASD,R2                                                       
         CLC   DRAPPID,CCTPID      cannot approve your own jobs                 
         JNE   XMULST08                                                         
         TM    X#JDSTAT,X#JDSTSU+X#JDSTRE                                       
         JZ    EXITN                                                            
         OI    SAVEIND,SAVEPMA                                                  
         DROP  R2                                                               
                                                                                
         USING ACTRECD,R2                                                       
XMULST08 CLI   X#JDSTAT,X#JDSTAP                                                
         JNE   EXITY                                                            
         TM    ACTKSTAT,ACTSDRFT                                                
         JNZ   EXITN                                                            
         J     EXITY                                                            
         DROP  R2                                                               
                                                                                
XMULST10 CLI   X#JDSTAT,0          any status?                                  
         JE    EXITY                                                            
         TM    X#JDSTAT,X#JDSTRE+X#JDSTMA+X#JDSTSU                              
         JZ    XMULST04            must be approved                             
         TM    X#JDSTAT,X#JDSTAP   mixture?                                     
         JZ    XMULST02            no                                           
         J     EXITY               then let through                             
                                                                                
***********************************************************************         
* get produtcion office from AIO2 record                              *         
***********************************************************************         
         USING ACTRECD,R2                                                       
         USING PPRELD,R3                                                        
XJOBGOF  NTR1  BASE=*,LABEL=*                                                   
                                                                                
         L     R2,AIO2                                                          
         LA    R3,ACTRFST                                                       
         MVC   X#AOFF,SPACES                                                    
                                                                                
XJOBG02  CLI   PPREL,PPRELQ                                                     
         JE    XJOBG04                                                          
         CLI   PPREL,0                                                          
         JE    EXIT                                                             
                                                                                
         LLC   R1,PPRLN                                                         
         AR    R3,R1                                                            
         J     XJOBG02                                                          
                                                                                
XJOBG04  MVC   X#AOFF,PPRGAOFF                                                  
         OC    X#AOFF,SPACES                                                    
         J     EXIT                                                             
         DROP  R2,R3                                                            
         EJECT                                                                  
***********************************************************************         
* Set extra details block for GETOPT                                  *         
***********************************************************************         
                                                                                
SETXDB   NTR1  BASE=*,LABEL=*                                                   
                                                                                
         L     R2,0(R1)                                                         
         L     R3,4(R1)                                                         
         LTR   R3,R3               single record passed - else full set         
         JZ    SETXDB00                                                         
         XC    0(GOXDBCLQ,R2),0(R2)                                             
         LHI   R0,4                                                             
         J     SETXDB04                                                         
                                                                                
         USING GOXDBD,R2                                                        
SETXDB00 XC    0(GOXDBLNQ,R2),0(R2)                                             
                                                                                
         MVC   GOXDBAS1,SCPYEL+CPYSTAT1-CPYELD                                  
         MVC   GOXDBAS4,SCPYEL+CPYSTAT4-CPYELD                                  
         MVC   GOXDBL1L,PCLILEN                                                 
         MVC   GOXDBL2L,PPROLEN                                                 
         MVC   GOXDBL3L,PJOBLEN                                                 
         MVC   GOXDBCBT(GOXDBCLQ),ELESDCXD                                      
         MVC   GOXDBPBT(GOXDBCLQ),ELESDPXD                                      
         LA    R2,GOXDBJBT                                                      
         LHI   R0,3                                                             
         J     SETXDB02                                                         
                                                                                
         LA    R2,GOXDBCBT                                                      
         DROP  R2                                                               
         LHI   R0,1                                                             
                                                                                
         USING GOXDBCBT,R2                                                      
SETXDB02 L     R3,AIO4             Client                                       
         CHI   R0,1                                                             
         JE    SETXDB04                                                         
         L     R3,AIO5             Product                                      
         CHI   R0,2                                                             
         JE    SETXDB04                                                         
         L     R3,AIO6             Job                                          
         CHI   R0,3                                                             
         JNE   *+2                                                              
                                                                                
         USING ACTRECD,R3                                                       
         USING PPRELD,R4                                                        
SETXDB04 LA    R4,ACTRFST                                                       
                                                                                
SETXDB06 CLI   PPREL,PPRELQ                                                     
         JE    SETXDB10                                                         
         CLI   PPREL,XPRELQ                                                     
         JE    SETXDB12                                                         
         CLI   PPREL,PRUELQ                                                     
         JE    SETXDB14                                                         
         CLI   PPREL,XXPELQ                                                     
         JE    SETXDB16                                                         
         CLI   PPREL,SCMELQ                                                     
         JE    SETXDB18                                                         
         CLI   PPREL,0                                                          
         JE    SETXDB20                                                         
                                                                                
SETXDB08 LLC   R1,PPRLN                                                         
         AR    R4,R1                                                            
         J     SETXDB06                                                         
                                                                                
SETXDB10 MVC   GOXDBCBT,PPRBTYPE                                                
         MVC   GOXDBCSA,PPRBLAMT                                                
         MVC   GOXDBCUW,PPRUWRK                                                 
         J     SETXDB08                                                         
                                                                                
         USING XPRELD,R4                                                        
SETXDB12 MVC   GOXDBCDU,XPRDUE                                                  
         MVC   GOXDBCPO,XPROVER                                                 
         MVC   GOXDBCPL,XPRLOW                                                  
         MVC   GOXDBCSU,XPRSUM                                                  
         MVC   GOXDBCNT,XPRNET                                                  
         MVC   GOXDBCDT,XPRDET                                                  
         MVC   GOXDBCDE,XPREDET                                                 
         MVC   GOXDBCCD,XPRCD                                                   
         CLI   XPRLN,XPRLN2Q                                                    
         JL    SETXDB08                                                         
         MVC   GOXDBCES,XPREST                                                  
         MVC   GOXDBCS1,XPRSTAT1                                                
         MVC   GOXDBCS2,XPRSTAT2                                                
         MVC   GOXDBCRE,XPRREP                                                  
         MVC   GOXDBCNB,XPRBILL                                                 
         MVC   GOXDBCIW,XPRINTC                                                 
         J     SETXDB08                                                         
                                                                                
         USING PRUELD,R4                                                        
SETXDB14 MVC   GOXDBCMD,PRUMED                                                  
         MVC   GOXDBCWR,PRUWORK                                                 
         MVC   GOXDBCCR,PRUCOMM                                                 
         MVC   GOXDBCST,PRUSTAT                                                 
         MVC   GOXDBCTX,PRUTAX                                                  
         J     SETXDB08                                                         
                                                                                
         USING XXPELD,R4                                                        
SETXDB16 MVC   GOXDBCDS,XXPDSCHM                                                
         J     SETXDB08                                                         
                                                                                
         USING SCMELD,R4                                                        
SETXDB18 TM    SCMTYPE,SCMTPRBI                                                 
         JZ    SETXDB08                                                         
         MVC   GOXDBCSC,SPACES                                                  
         LLC   RE,SCMLN                                                         
         SHI   RE,SCMLN1Q+1                                                     
         JM    *+2                                                              
         MVC   GOXDBCSC(0),SCMCODE                                              
         EX    RE,*-6                                                           
         J     SETXDB08                                                         
                                                                                
SETXDB20 AHI   R0,1                next record into next block                  
         AHI   R2,GOXDBCLQ                                                      
         CHI   R0,3                                                             
         JNH   SETXDB02                                                         
         DROP  R2,R3,R4                                                         
         J     EXIT                                                             
                                                                                
***********************************************************************         
* Interface to TSAR                                                   *         
***********************************************************************         
                                                                                
GOTSAR   NTR1  BASE=*,LABEL=*                                                   
                                                                                
         LR    R2,R1               R2=A(Caller's parameter list)                
TB       USING TSARD,TSARRECS      R3=A(TSAR block)                             
         LA    R1,ES_BUFF                                                       
         ST    R1,TB.TSAREC        Address of record buffer area                
         CLI   TSARTYPE,TSARTESQ                                                
         JE    GOTSAR00                                                         
         LA    R1,CSVKEY3          (CSVKEY3/CSVKEY4)                            
         ST    R1,TB.TSAREC                                                     
         CLI   TSARTYPE,TSARTJSQ                                                
         JE    GOTSAR00                                                         
         DC    H'0'                                                             
GOTSAR00 CLI   0(R2),TSAINI        Test initialisation call                     
         JNE   GOTSAR04                                                         
         XC    TB.TSARD(TSPNEWL),TB.TSARD                                       
         MVC   TB.TSACTN,0(R2)                                                  
         MVC   TB.TSACOM,ACOMFACS                                               
         LHI   R0,1024                                                          
         OC    TB.TSBUFFL,TB.TSBUFFL                                            
         JNZ   *+8                                                              
         STCM  R0,3,TB.TSBUFFL      Set require 1MB off-line                    
         MVI   TB.TSRECI,TSRXTN+TSRMINB1+TSRVAR                                 
         MVI   TB.TSKEYL,ESTTKYL    Set key length - estimates                  
         LHI   R0,500                                                           
         CLI   TSARTYPE,TSARTESQ                                                
         JE    GOTSAR02                                                         
         MVI   TB.TSKEYL,JSBDKYL                   - job search                 
         LHI   R0,JSBDLNQ                                                       
         CLI   TSARTYPE,TSARTJSQ                                                
         JE    GOTSAR02                                                         
         DC    H'0'                                - unknown                    
GOTSAR02 MVI   TB.TSINDS,TSINODSK   Set no disk writes (save/restore)           
         MVI   TB.TSIND2,TSI2MANY                                               
         STCM  R0,3,TB.TSRECL       Set maximum record length                   
         GOTOR VTSAR,TB.TSARD                                                   
         TM    TB.TSINDS,TSIINIOK                                               
         JNZ   EXITY                                                            
         DC    H'0'                 Initialisation failure                      
                                                                                
GOTSAR04 TM    TB.TSINDS,TSIINIOK   Test initialised                            
         JZ    GOTSAR08                                                         
                                                                                
         MVC   TB.TSACTN,0(R2)      Set action                                  
                                                                                
         CLI   TB.TSACTN,TSASRT     Test sorting                                
         JNE   GOTSAR06                                                         
         L     R1,4(R2)                                                         
         MVC   TB.TSRTPARM,0(R1)    Yes - set sort parameters                   
                                                                                
GOTSAR06 GOTOR VTSAR,TB.TSARD       Call TSAR                                   
         MVC   TSARERRS,TB.TSERRS   Return TSARERRS                             
         J     GOTSARX                                                          
                                                                                
GOTSAR08 MVI   TSARERRS,TSEEOF                                                  
                                                                                
GOTSARX  CLI   TSARERRS,0          Set condition code for caller                
         JNE   EXITN                                                            
         J     EXITY                                                            
                                                                                
         DROP  TB                                                               
         EJECT                                                                  
                                                                                
***********************************************************************         
* filter job record for extra names                                   *         
***********************************************************************         
         USING NAMELD,R2                                                        
XNAMFLT  NTR1  BASE=*,LABEL=*                                                   
                                                                                
         MVI   CHKDATA,C'N'                                                     
         OC    RQ_JDNAD,RQ_JDNAD   skip if no name                              
         JZ    EXITY                                                            
                                                                                
         L     R2,AIO2             point to SJ job record                       
         AHI   R2,ACTRFST-ACTRECD                                               
                                                                                
XNAMF02  CLI   NAMEL,NAMELQ                                                     
         JE    XNAMF04                                                          
         CLI   NAMEL,0                                                          
         JE    EXITY               - or die?                                    
         LLC   R0,NAMLN                                                         
         AR    R2,R0                                                            
         J     XNAMF02                                                          
                                                                                
XNAMF04  OC    RQ_JDNAD,RQ_JDNAD   point to names                               
         JZ    EXITY                                                            
*                                                                               
         LLC   RF,NAMLN                                                         
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   ELEMENT(0),NAMEL                                                 
         EX    RF,0(RE)                                                         
                                                                                
T        USING NAMELD,ELEMENT                                                   
         USING LW_D,RF                                                          
         XR    RF,RF               point to list in WMP                         
         ICM   RF,7,RQ_JDNAD                                                    
         XR    R4,R4                                                            
         ICM   R4,3,LW_NUMN        number of entries                            
         LLC   RE,T.NAMLN                                                       
         SHI   RE,NAMLN1Q                                                       
         L     R1,AUINTAB                                                       
         LA    R3,LW_DATA2         start of list                                
         DROP  RF                                                               
*                                                                               
XNAMF06  TR    T.NAMEREC(0),0(R1)                                               
         EX    RE,XNAMF06                                                       
                                                                                
XNAMF08  LLC   R0,T.NAMLN          disregard L'NAMEREC as 99,99% OK             
         SHI   R0,NAMLN1Q                                                       
         LA    RE,T.NAMEREC                                                     
         LA    RF,L'SRCKWRD1-1(R3)                                              
XNAMF09  CR    RF,R3               Determine length of search word              
         JNH   XNAMF9A                                                          
         CLI   0(RF),C' '                                                       
         JH    XNAMF9A                                                          
         JCT   RF,XNAMF09                                                       
XNAMF9A  SR    RF,R3                                                            
*                                                                               
XNAMF10  EX    RF,XNAMFC                                                        
         JE    EXITY                                                            
         AHI   RE,1                                                             
         JCT   R0,XNAMF10                                                       
         J     XNAMF15                                                          
                                                                                
XNAMF12  AHI   R3,L'SRCKWRD1  extra name (filter) matches                       
         JCT   R4,XNAMF08                                                       
         CLI   CHKDATA,C'Y'                                                     
         JE    EXITN                                                            
         J     EXITY               all OK                                       
                                                                                
         USING ACTRECD,R5                                                       
XNAMF15  LLC   RE,PPROLEN                                                       
         LLC   R6,PJOBLEN                                                       
         SR    R6,RE                                                            
         L     R5,AIO2                                                          
         LA    RE,ACTKACT(RE)                                                   
         BASR  R7,0                                                             
         CLC   0(0,RE),0(R3)                                                    
         EX    R6,0(R7)                                                         
         JE    EXITY                                                            
         MVI   CHKDATA,C'Y'                                                     
         J     XNAMF12                                                          
                                                                                
         DROP  R5                                                               
                                                                                
                                                                                
XNAMFC   CLC   0(0,RE),0(R3)                                                    
                                                                                
         DROP  R2,T                                                             
                                                                                
***********************************************************************         
* filter job record (record in AIO2)                                  *         
***********************************************************************         
         USING ACTRECD,R2                                                       
XJOBFLT  NTR1  BASE=*,LABEL=*                                                   
                                                                                
         L     R2,AIO2             point to SJ job record                       
         XC    X#ACTAP,X#ACTAP                                                  
         XC    X#ACTRJ,X#ACTRJ                                                  
         XC    X#ACTSU,X#ACTSU                                                  
                                                                                
         CLI   X#JDSTAT,0          no filter                                    
         JE    XJOBF004                                                         
         TM    X#JDSTAT,X#JDSTSU+X#JDSTRE+X#JDSTMA  approved jobs only?         
         JNZ   XJOBF002                                                         
         TM    ACTRSTAT,ACTSDRFT   skip draft jobs                              
         JNZ   EXITN                                                            
         J     XJOBF004                                                         
                                                                                
XJOBF002 TM    X#JDSTAT,X#JDSTAP   approved jobs, too?                          
         JNZ   XJOBF004                                                         
         TM    ACTRSTAT,ACTSDRFT   else skip live jobs                          
         JZ    EXITN                                                            
                                                                                
XJOBF004 OC    X#PIDAP,X#PIDAP     approver search?                             
         JZ    XJOBF005                                                         
         TM    ACTRSTAT,ACTSDRFT   skip draft jobs, too                         
         JNZ   EXITN                                                            
                                                                                
XJOBF005 CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    XJOBF05A                                                         
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    XJOBF05B                                                         
         TM    ACTRSTAT,ACTSCLOS                                                
         JNZ   EXITN                                                            
         J     XJOBF05B                                                         
*                                                                               
XJOBF05A TM    ACTRSTAT,ACTSCLOS                                                
         JZ    EXITN                                                            
*                                                                               
XJOBF05B CLI   RQ_JDLST,YESQ       include locked jobs?                         
         JE    XJOBF006                                                         
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    XJOBF05C                                                         
         TM    ACTRSTAT,ACTSLOCK   job locked?                                  
         JNZ   EXITN                                                            
         J     XJOBF006                                                         
*                                                                               
XJOBF05C TM    ACTRSTAT,ACTSLOCK   job locked?                                  
         JZ    EXITN                                                            
*                                                                               
XJOBF006 LA    R3,ACTRFST                                                       
         USING UFSELD,R3                                                        
                                                                                
         CLI   X#SRCL,FF           if name search skip                          
         JNE   XJOBF008                                                         
                                                                                
         DS    0H                  X#POFF passed with high lvl office           
         MVC   X#COFF,SPACES       set office and filter                        
                                                                                
XJOBF008 MVI   X#BYTE3,0                                                        
         MVI   X#JBIR,NOQ                                                       
         XC    X#RUFI,X#RUFI                                                    
         LA    R0,X#UFLS           clear user field value area                  
         LA    R1,X#UFLQ                                                        
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
         L     RE,ABLOCK                                                        
         LHI   RF,L'BLOCK                                                       
         XCEF                                                                   
         MVI   BYTE2,0                                                          
                                                                                
XJOBF010 CLI   UFSEL,0                                                          
         JE    XJOBF062                                                         
         CLI   UFSEL,UFSELQ                                                     
         JE    XJOBF014                                                         
         CLI   UFSEL,JOBELQ                                                     
         JE    XJOBF022                                                         
         CLI   UFSEL,RACELQ                                                     
         JE    XJOBF028                                                         
         CLI   UFSEL,PPRELQ                                                     
         JE    XJOBF032                                                         
         CLI   UFSEL,RSTELQ                                                     
         JE    XJOBF034                                                         
                                                                                
XJOBF012 LLC   R0,UFSLN                                                         
         AR    R3,R0                                                            
         J     XJOBF010                                                         
                                                                                
XJOBF014 LLC   R1,X#BYTE3          process user field element                   
         CHI   R1,X#UFCMQ                                                       
         JNL   XJOBF012                                                         
         LLC   RE,BYTE2            save off header/description                  
         LR    RF,RE                                                            
         MHI   RE,L'UFSDESC                                                     
         L     R0,ABLOCK                                                        
         AR    RE,R0                                                            
         AHI   RF,1                                                             
         STC   RF,BYTE2                                                         
         MVC   0(L'UFSDESC,RE),UFSDESC                                          
         L     RF,AUINTAB          translate to upper case                      
         TR    0(L'UFSDESC,RE),0(RF)                                            
         LR    RF,R1               (save off user field data)                   
         MHI   RF,L'X#UFLS                                                      
         LA    RF,X#UFLS(RF)                                                    
         LLC   RE,UFSLN                                                         
         SHI   RE,UFSLN1Q+1                                                     
         LTR   RE,RE                                                            
         JNM   XJOBF016                                                         
         TM    SAVEIND,SAVEAUR                                                  
         JZ    XJOBF012                                                         
         MVC   0(UFSDATMX,RF),SPACES                                            
         AHI   R1,1                                                             
         STC   R1,X#BYTE3                                                       
         J     XJOBF012                                                         
XJOBF016 CHI   RE,UFSDATMX-1                                                    
         JL    XJOBF018                                                         
         LA    RE,UFSDATMX-1                                                    
XJOBF018 MVC   0(0,RF),UFSDATA                                                  
         EX    RE,*-6                                                           
         AHI   R1,1                                                             
         STC   R1,X#BYTE3                                                       
         L     RE,AUINTAB          translate to upper case                      
         TR    0(UFSDATMX,RF),0(RE)                                             
         LR    RF,R1                                                            
         LA    R1,X#RUFI-1(R1)     point to indicator                           
         MVI   0(R1),FF            set to found                                 
         TM    SAVEIND,SAVEAUR     Aura has different filtering                 
         JNZ   XJOBF012                                                         
         LA    R1,X#UFLD-1(RF)     point to filters                             
         CLI   0(R1),0             apply filter?                                
         JE    XJOBF012                                                         
         LLC   RE,0(R1)                                                         
         BCTR  RE,0                                                             
         BCTR  RF,0                                                             
         MHI   RF,L'RQ_JDUF1                                                    
         LA    RF,RQ_JDUF1(RF)                                                  
         EX    RE,XJOBF020                                                      
         JNE   EXITN                                                            
         J     XJOBF012                                                         
                                                                                
XJOBF020 CLC   0(0,RF),UFSDATA                                                  
                                                                                
         USING JOBELD,R3                                                        
XJOBF022 CLC   JOBCDATE,X#CLOD                                                  
         JL    EXITN                                                            
                                                                                
         CLC   JOBCDATE,X#CLOX                                                  
         JH    EXITN                                                            
                                                                                
         MVC   X#SVDT,JOBADATE                                                  
         CLI   JOBLN,JOBLN2Q                                                    
         JL    XJOBF024                                                         
                                                                                
         OC    JOBODATE,JOBODATE                                                
         JZ    XJOBF024                                                         
                                                                                
         MVC   X#SVDT,JOBODATE                                                  
                                                                                
XJOBF024 CLC   X#SVDT,X#OPND                                                    
         JL    EXITN                                                            
                                                                                
         CLC   X#SVDT,X#OPNX                                                    
         JH    EXITN                                                            
                                                                                
         CLI   JOBLN,JOBLN3Q                                                    
         JL    XJOBF012                                                         
         TM    JOBSTA2,JOBSREJ                                                  
         JZ    XJOBF012                                                         
         TM    SAVEIND,SAVEAUR     Skipped for Aura as per DSRD-10476           
         JNZ   XJOBF026                                                         
         CLI   X#JDSTAT,0          If no status filter, skip rejected           
         JE    EXITN                                                            
XJOBF026 MVI   X#JBIR,YESQ                                                      
         J     XJOBF012                                                         
                                                                                
         USING RACELD,R3                                                        
XJOBF028 CLI   RACTYPE,RACTADD     added=submitted?                             
         JNE   XJOBF030                                                         
         MVC   X#ACTSU,RACPERS                                                  
         J     XJOBF012                                                         
                                                                                
XJOBF030 CLI   RACTYPE,RACTAPP     approved?                                    
         JNE   XJOBF012                                                         
         CLI   RACVRVN,RACTAPP     approved in BrandOcean?                      
         JNE   XJOBF012                                                         
         MVC   X#ACTAP,RACPERS                                                  
         J     XJOBF012                                                         
                                                                                
         USING PPRELD,R3                                                        
XJOBF032 CLI   X#SRCL,FF           if name search skip                          
         JNE   XJOBF012                                                         
         MVC   X#COFF,PPRGAOFF                                                  
         OC    X#COFF,SPACES                                                    
         J     XJOBF012                                                         
                                                                                
         USING RSTELD,R3                                                        
XJOBF034 CLI   RQ_OPENS,C' '       OPEN FOR ESTIMATES                           
         JNH   XJOBF038                                                         
         CLI   RQ_OPENS,ALLSTATS   ANY STATUS ALLOWED                           
         JE    XJOBF038                                                         
         CLI   RQ_OPENS,YESQ       OPEN FOR ESTIMATES                           
         JNE   XJOBF036                                                         
         TM    RSTLSTAT,RSTLSESQ   LOCKED?                                      
         JNZ   EXITN               THEN REJECT                                  
         J     XJOBF038                                                         
*                                                                               
XJOBF036 TM    RSTLSTAT,RSTLSESQ   CLOSED TO ESTIMATES THEN FILTER              
         JZ    EXITN               ANYTHING NOT LOCKED                          
         J     XJOBF038                                                         
*                                                                               
XJOBF038 CLI   RQ_OPENO,C' '       LOCKED FROM ORDERS                           
         JNH   XJOBF042                                                         
         CLI   RQ_OPENO,ALLSTATS   ANY STATUS ALLOWED                           
         JE    XJOBF042                                                         
         CLI   RQ_OPENO,YESQ       OPEN FOR ORDERS                              
         JNE   XJOBF040                                                         
         TM    RSTLSTAT,RSTLSORQ   LOCKED?                                      
         JNZ   EXITN               THEN REJECT                                  
         J     XJOBF042                                                         
*                                                                               
XJOBF040 TM    RSTLSTAT,RSTLSORQ   CLOSED TO ORDERS THEN FILTER                 
         JZ    EXITN               ANYTHING NOT LOCKED                          
         J     XJOBF042                                                         
*                                                                               
XJOBF042 CLI   RQ_OPENX,C' '       LOCKED FROM EXTERNAL POSTINGS                
         JNH   XJOBF046                                                         
         CLI   RQ_OPENX,ALLSTATS   ANY STATUS ALLOWED                           
         JE    XJOBF046                                                         
         CLI   RQ_OPENX,YESQ       OPEN FOR EXTERNAL POSTINGS                   
         JNE   XJOBF044                                                         
         TM    RSTLSTAT,RSTLSEXQ   LOCKED?                                      
         JNZ   EXITN               THEN REJECT                                  
         J     XJOBF046                                                         
*                                                                               
XJOBF044 TM    RSTLSTAT,RSTLSEXQ   CLOSED TO EXTERNAL POSTINGS THEN L           
         JZ    EXITN               FILTER ANYTHING NOT LOCKED                   
         J     XJOBF046                                                         
*                                                                               
XJOBF046 CLI   RQ_OPENB,C' '       LOCKED FROM BILLING                          
         JNH   XJOBF050                                                         
         CLI   RQ_OPENB,ALLSTATS   ANY STATUS ALLOWED                           
         JE    XJOBF050                                                         
         CLI   RQ_OPENB,YESQ       OPEN FOR BILLING                             
         JNE   XJOBF048                                                         
         TM    RSTLSTAT,RSTLSBIQ   LOCKED?                                      
         JNZ   EXITN               THEN REJECT                                  
         J     XJOBF050                                                         
*                                                                               
XJOBF048 TM    RSTLSTAT,RSTLSBIQ   CLOSED TO BILLING                            
         JZ    EXITN               FILTER ANYTHING NOT LOCKED                   
         J     XJOBF050                                                         
*                                                                               
XJOBF050 CLI   RQ_OPENA,C' '       LOCKED FROM ADJUSTMENTS                      
         JNH   XJOBF054                                                         
         CLI   RQ_OPENA,ALLSTATS   ANY STATUS ALLOWED                           
         JE    XJOBF054                                                         
         CLI   RQ_OPENA,YESQ       OPEN FOR ADJUSTMENTS                         
         JNE   XJOBF052                                                         
         TM    RSTLSTAT,RSTLSADQ   LOCKED?                                      
         JNZ   EXITN               THEN REJECT                                  
         J     XJOBF054                                                         
*                                                                               
XJOBF052 TM    RSTLSTAT,RSTLSADQ   CLOSED TO ADJUSTMENTS                        
         JZ    EXITN               FILTER ANYTHING NOT LOCKED                   
         J     XJOBF054                                                         
*                                                                               
XJOBF054 CLI   RQ_OPENT,C' '       LOCKED FROM TIMESHEETS                       
         JNH   XJOBF012                                                         
         CLI   RQ_OPENT,ALLSTATS   ANY STATUS ALLOWED                           
         JE    XJOBF012                                                         
         CLI   RQ_OPENT,YESQ                                                    
         JNE   XJOBF058                                                         
         TM    SAVEIND,SAVEAUR     Aura - merge t/s lock status                 
         JZ    XJOBF056                                                         
         TM    RSTSTAT5,RSTSNOTS                                                
         JNZ   EXITN                                                            
                                                                                
XJOBF056 TM    RSTLSTAT,RSTLSTIQ   LOCKED?                                      
         JNZ   EXITN               THEN REJECT                                  
         J     XJOBF012                                                         
                                                                                
XJOBF058 TM    SAVEIND,SAVEAUR     Aura - merge t/s lock status                 
         JZ    XJOBF060                                                         
         TM    RSTSTAT5,RSTSNOTS                                                
         JZ    EXITN                                                            
                                                                                
XJOBF060 TM    RSTLSTAT,RSTLSTIQ   CLOSED TO TIMESHEETS                         
         JZ    EXITN               FILTER ANYTHING NOT LOCKED                   
         J     XJOBF012                                                         
                                                                                
XJOBF062 OC    X#PIDRJ,X#PIDRJ     see XJOBF090 - required at all?              
         JZ    XJOBF064                                                         
         GOTOR REJECTER,ACTKULA                                                 
         MVC   X#ACTRJ,X#JOBREJ    no need to reestablsih IO sequence           
                                                                                
XJOBF064 TM    SAVEIND,SAVEAUR     Aura has different filtering                 
         JNZ   XJOBF070                                                         
                                                                                
         OC    X#UFLD,X#UFLD       final check on user fields                   
         JZ    XJOBF082                                                         
                                                                                
         LA    R1,X#UFLD                                                        
         LA    RE,X#UFCMQ                                                       
         LA    RF,X#RUFI                                                        
                                                                                
XJOBF066 CLI   0(R1),0             user field filter required?                  
         JE    XJOBF068                                                         
                                                                                
         CLI   0(RF),FF            processed                                    
         JNE   EXITN                                                            
                                                                                
XJOBF068 AHI   RF,1                                                             
         AHI   R1,1                                                             
         JCT   RE,XJOBF066                                                      
         J     XJOBF082                                                         
                                                                                
XJOBF070 CLI   X#UFLDH1,0          Aura user fields filtering                   
         JE    XJOBF082            (any filter passed?                          
                                                                                
         XR    R3,R3               main loop count                              
                                                                                
XJOBF072 LHI   R0,X#UFCMQ                                                       
         L     R4,ABLOCK           saved headers                                
                                                                                
         USING LW_D,RF                                                          
         XR    RF,RF               point to list in WMP                         
         ICM   RF,7,RQ_JDUAD                                                    
         AHI   RF,LW_LN2Q          RF=A(first array line data)                  
         LR    RE,R3                                                            
         MHI   RE,L'UFSDESC+UFSDATMX+UFSTYPEL                                   
         AR    RF,RE               get header filter entry                      
         DROP  RF                                                               
                                                                                
XJOBF074 LR    RE,R3                                                            
         MHI   RE,X#UFLDH2-X#UFLDH1                                             
         LA    RE,X#UFLDH1(RE)                                                  
         LLC   R1,0(RE)            length of header filter                      
         LTR   R1,R1                                                            
         JZ    XJOBF078                                                         
         BCTR  R1,0                                                             
         EX    R1,XJOBF080         match on header?                             
         JE    XJOBF076                                                         
         AHI   R4,L'UFSDESC                                                     
         JCT   R0,XJOBF074                                                      
         J     EXITN               reject job                                   
                                                                                
XJOBF076 LHI   R1,X#UFCMQ          save position                                
         SR    R1,R0                                                            
         LR    RE,R3                                                            
         MHI   RE,X#UFRET2-X#UFRET1                                             
         LA    RE,X#UFRET1(RE)                                                  
         STC   R1,0(RE)                                                         
         LR    R4,R1                                                            
         MHI   R4,L'X#UFLS                                                      
         LA    R4,X#UFLS(R4)       entry in saved data values                   
                                                                                
         LR    RE,R3               any data filter?                             
         MHI   RE,X#UFLDD2-X#UFLDD1                                             
         LA    RE,X#UFLDD1(RE)                                                  
         LLC   R1,0(RE)            length of data filter (skip if none)         
         LTR   R1,R1                                                            
         JZ    XJOBF078                                                         
         BCTR  R1,0                                                             
                                                                                
         USING LW_D,RF                                                          
         XR    RF,RF               point to list in WMP                         
         ICM   RF,7,RQ_JDUAD                                                    
         AHI   RF,LW_LN2Q          RF=A(first array line data)                  
         AHI   RF,L'UFSDESC        point to data in array entry                 
         LR    RE,R3                                                            
         MHI   RE,L'UFSDESC+UFSDATMX+UFSTYPEL                                   
         AR    RF,RE                                                            
         DROP  RF                                                               
         EX    R1,XJOBF080         match on header?                             
         JE    XJOBF078                                                         
         J     EXITN                                                            
                                                                                
XJOBF078 AHI   R3,1                                                             
         CHI   R3,RQ_JDUMX                                                      
         JL    XJOBF072                                                         
         J     XJOBF082                                                         
                                                                                
XJOBF080 CLC   0(0,RF),0(R4)                                                    
                                                                                
XJOBF082 CLI   X#JDSTAT,0          status filter?                               
         JE    XJOBF088                                                         
         TM    SAVEIND,SAVEMST     Aura multipe status?                         
         JNZ   XJOBF086                                                         
         TM    X#JDSTAT,X#JDSTAP   approved? (done upfront)                     
         JNZ   XJOBF088                                                         
         TM    X#JDSTAT,X#JDSTRE   rejected?                                    
         JZ    XJOBF084                                                         
         CLI   X#JBIR,YESQ                                                      
         JNE   EXITN                                                            
         J     XJOBF088                                                         
                                                                                
XJOBF084 CLI   X#JBIR,YESQ         submitted                                    
         JE    EXITN                                                            
         J     XJOBF088                                                         
                                                                                
XJOBF086 CLI   X#JBIR,YESQ         Job rejected?                                
         JNE   XJOBF088                                                         
         TM    X#JDSTAT,X#JDSTRE   then must have asked for rejected            
         JZ    EXITN                                                            
                                                                                
XJOBF088 OC    X#PIDAP,X#PIDAP     check for subm/rej/appr PIDs                 
         JZ    XJOBF090                                                         
         CLC   X#ACTAP,X#PIDAP                                                  
         JNE   EXITN                                                            
                                                                                
XJOBF090 OC    X#PIDRJ,X#PIDRJ                                                  
         JZ    XJOBF092                                                         
         CLC   X#ACTRJ,X#PIDRJ                                                  
         JNE   EXITN                                                            
                                                                                
XJOBF092 OC    X#PIDSU,X#PIDSU                                                  
         JZ    XJOBF094                                                         
         CLC   X#ACTSU,X#PIDSU                                                  
         JNE   EXITN                                                            
                                                                                
XJOBF094 CLI   X#SRCL,FF                                                        
         JNE   XJOBF098                                                         
                                                                                
         CLC   X#COFF,SPACES       set office                                   
         JH    XJOBF096                                                         
                                                                                
         MVC   X#COFF,X#POFF                                                    
                                                                                
XJOBF096 CLC   RQ_JDOFF,SPACES     apply office filter if passed                
         JNH   XJOBF097                                                         
         CLC   RQ_JDOFF,X#COFF                                                  
         JNE   EXITN                                                            
                                                                                
         USING OFFALD,R1                                                        
XJOBF097 L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,X#COFF     validate current office                      
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL                                                           
         JNE   EXITN                                                            
         DROP  R1                                                               
                                                                                
XJOBF098 LA    RE,RQ_JDF1V         filter on filters                            
         LA    RF,ACTRSAF1                                                      
         LHI   R1,5                                                             
                                                                                
XJOBF100 CLI   0(RE),C' '                                                       
         JNH   XJOBF102                                                         
                                                                                
         CLC   0(1,RF),0(RE)                                                    
         JNE   EXITN                                                            
                                                                                
XJOBF102 AHI   RE,1                                                             
         AHI   RF,1                                                             
         JCT   R1,XJOBF100                                                      
                                                                                
XJOBF104 TM    X#JDSTAT,X#JDSTMA   only for 'await my appr' or                  
         JNZ   XJOBF106            multiple status                              
         TM    SAVEIND,SAVEMST                                                  
         JZ    EXITY                                                            
         J     XJOBF108                                                         
                                                                                
XJOBF106 TM    X#JDSTAT,X#JDSTRE   also rejected?                               
         JZ    XJOBF108                                                         
         CLI   X#JBIR,YESQ         rejected job?                                
         JE    XJOBF108                                                         
         TM    X#JDSTAT,X#JDSTSU   also submitted?                              
         JNZ   XJOBF108                                                         
         TM    SAVEIND,SAVEPMA     if not exclude if 'my job'                   
         JNZ   EXITN                                                            
                                                                                
XJOBF108 TM    ACTRSTAT,ACTSDELT   global checks first                          
         JNZ   EXITN                                                            
                                                                                
         DS    0H                  go through each X#JDSTAT and once            
         DS    0H                  OK set flag and take job                     
         TM    X#JDSTAT,X#JDSTMA   > awaiting my approvals                      
         JZ    XJOBF110                                                         
         CLI   X#JBIR,YESQ         skip rejected jobs (see JLNADL50             
         JE    XJOBF110            for 'own' - not implemented)                 
         CLC   X#ACTSU,CCTPID      cannot approve your own jobs                 
         JE    XJOBF110                                                         
         XC    X#JAPP,X#JAPP       (see code at CHKJAL)                         
         LA    RF,ACTKACT                                                       
         LLC   R0,PPROLEN                                                       
         AR    RF,R0                                                            
         MVC   X#MEDC,0(RF)                                                     
         OI    X#GAPIND,X#GAPIDQ+X#GAPIYQ                                       
         GOTOR GETAPP,DMCB,(2,ACTKACT),X#POFF                                   
         JE    EXITY                                                            
         NI    X#GAPIND,FF-X#GAPIYQ                                             
                                                                                
XJOBF110 TM    X#JDSTAT,X#JDSTRE   > rejected                                   
         JZ    XJOBF112                                                         
         TM    ACTRSTAT,ACTSDRFT                                                
         JZ    XJOBF112                                                         
         CLI   X#JBIR,YESQ                                                      
         JE    EXITY                                                            
                                                                                
XJOBF112 TM    X#JDSTAT,X#JDSTSU   > submitted                                  
         JZ    XJOBF114                                                         
         TM    ACTRSTAT,ACTSDRFT                                                
         JZ    XJOBF114                                                         
         CLI   X#JBIR,YESQ                                                      
         JNE   EXITY                                                            
                                                                                
XJOBF114 TM    X#JDSTAT,X#JDSTAP   > approved                                   
         JZ    EXITN                                                            
         TM    ACTRSTAT,ACTSDRFT                                                
         JZ    EXITY                                                            
         JNZ   EXITN                                                            
                                                                                
         DROP  R2,R3                                                            
                                                                                
***********************************************************************         
* Get job audit 'rejection' values                                    *         
***********************************************************************         
                                                                                
REJECTER NTR1  BASE=*,LABEL=*                                                   
                                                                                
         MVC   SAVEKEY3,IOKEY                                                   
                                                                                
         LR    R4,R1                                                            
         XC    X#JOBREJ,X#JOBREJ   rejecter PID                                 
         MVI   X#CONREJ,NOQ        connetced PID rejected Y/N                   
                                                                                
         USING AUDRECD,R2                                                       
         LA    R2,IOKEY                                                         
         XC    AUDKEY,AUDKEY                                                    
         MVI   AUDKTYP,AUDKTYPQ                                                 
         MVI   AUDKSUB,AUDKSUBQ                                                 
         MVC   AUDKCPY,CUXCPY                                                   
         MVI   AUDKAUDT,AUDKACC                                                 
         MVC   AUDKULA,0(R4)                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JNE   REJECTX                                                          
         J     REJECT04                                                         
                                                                                
REJECT02 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO1'                               
         CLC   AUDKEY(AUDKSEQ-AUDRECD),IOKEYSAV                                 
         JNE   REJECTX                                                          
                                                                                
REJECT04 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JNE   *+2                                                              
                                                                                
         USING STCELD,R3                                                        
         L     R3,AIO1             look for STC elements                        
         AHI   R3,AUDRFST-AUDRECD                                               
                                                                                
REJECT06 CLI   STCEL,0                                                          
         JE    REJECT02                                                         
         CLI   STCEL,STCELQ                                                     
         JNE   REJECT08                                                         
         CLI   STCIND,STCIJOB                                                   
         JNE   REJECT08                                                         
         CLI   STCDTO,C'R'                                                      
         JNE   REJECT10                                                         
         MVC   X#JOBREJ,STCPERS    rejecter                                     
         CLC   STCPERS,CCTPID                                                   
         JNE   REJECT10                                                         
         MVI   X#CONREJ,YESQ                                                    
         J     REJECT10                                                         
                                                                                
REJECT08 CLI   STCIND,STCIACT                                                   
         JNE   REJECT10                                                         
         CLI   STCATYP,STCAAPST                                                 
         JNE   REJECT10                                                         
         CLI   STCASTA,AB29REJQ                                                 
         JNE   REJECT10                                                         
         MVC   X#JOBREJ,STCPERS                                                 
         CLC   STCPERS,CCTPID                                                   
         JNE   REJECT10                                                         
         MVI   X#CONREJ,YESQ                                                    
         J     REJECT10                                                         
                                                                                
REJECT10 LLC   R0,STCLN                                                         
         AR    R3,R0                                                            
         J     REJECT06                                                         
                                                                                
REJECTX  MVC   IOKEY,SAVEKEY3                                                   
         J     EXITY                                                            
                                                                                
AB29REJQ EQU   C'2'                ACBRA29.QA_AREJT 'reject'                    
         DROP  R2,R3                                                            
                                                                                
***********************************************************************         
* Add to 'check for dupes' table                                      *         
***********************************************************************         
ADDDUP   NTR1  BASE=*,LABEL=*                                                   
                                                                                
         LR    R2,R1                                                            
         L     R3,AIO7                                                          
         LH    R0,0(R3)                                                         
         LTR   R0,R0                                                            
         JP    ADDDUP02                                                         
         LHI   R0,(L'IOAREA7+L'IOAREA8)/L'ACTKACT                               
         STH   R0,0(R3)                                                         
         AHI   R3,2                                                             
         J     ADDDUP06            tabel full - restart                         
                                                                                
ADDDUP02 AHI   R3,2                                                             
                                                                                
ADDDUP04 CLI   0(R3),0                                                          
         JE    ADDDUP06                                                         
         AHI   R3,L'ACTKACT                                                     
         J     ADDDUP04                                                         
                                                                                
ADDDUP06 MVC   0(L'ACTKACT,R3),0(R2)                                            
         AHI   R3,L'ACTKACT                                                     
         MVI   0(R3),0                                                          
         L     R3,AIO7                                                          
         LH    R0,0(R3)                                                         
         BCTR  R0,0                                                             
         STH   R0,0(R3)                                                         
                                                                                
         J     EXIT                                                             
                                                                                
***********************************************************************         
* Check dupe  jobs due to duplicate search passives                   *         
***********************************************************************         
                                                                                
CHKDUP   NTR1  BASE=*,LABEL=*                                                   
                                                                                
         LR    R2,R1                                                            
         L     R3,AIO7                                                          
         AHI   R3,2                                                             
                                                                                
CHKDUP02 CLI   0(R3),0                                                          
         JE    EXITN                                                            
         CLC   0(L'ACTKACT,R3),0(R2)                                            
         JE    EXITY                                                            
         AHI   R3,L'ACTKACT                                                     
         J     CHKDUP02                                                         
                                                                                
***********************************************************************         
* Check you can close job                                             *         
***********************************************************************         
         SPACE 1                                                                
CHKACT   NTR1  BASE=*,LABEL=*                                                   
                                                                                
         L     R4,AIO2                                                          
         USING ACTRECD,R4                                                       
         CLC   PRODUL,ACTKULA                                                   
         JNE   CHKACTX                                                          
         MVI   JD_CCLSE,YESQ                                                    
         MVI   JD_CDELT,YESQ                                                    
***                                                                             
         TM    SAVEIND,SAVEAUR     Temporarily taken out for efficiency         
         JNZ   CHKACTX             (see level comments) under AURA              
***                                                                             
         LA    R2,IOKEY            Read for time passives                       
         USING TSJPASD,R2                                                       
         XC    TSJPAS,TSJPAS                                                    
         MVC   TSJPCPY,CUXCPY                                                   
         MVI   TSJPTYP,TSJPTYPQ                                                 
         MVI   TSJPSUB,TSJPSUBQ                                                 
         MVI   TSJPVIEW,TSJPSJAQ                                                
         MVC   TSJPCOFF,X#POFF                                                  
         MVC   TSJPACT,ACTKACT                                                  
         LLC   RE,PPROLEN                                                       
         LA    R1,ACTKACT                                                       
         AR    R1,RE                                                            
         MVC   TSJPMED,0(R1)                                                    
         MVC   CSVKEY1,IOKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         J     CHKACT04                                                         
*                                                                               
CHKACT02 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
*                                                                               
CHKACT04 CLC   TSJPAS(TSJPPEDT-TSJPAS),CSVKEY1                                  
         JNE   CHKACT06                                                         
         TM    TSJPSTAT,TIMSDELT   Is time deleted                              
         JNZ   CHKACT02            Yes - ignore this                            
         MVI   JD_CDELT,NOQ                                                     
         TM    TSJPSTAT,TIMSFAPP   Is time fully approved                       
         JNZ   CHKACT02            Yes - ignore this                            
         MVI   JD_CCLSE,NOQ                                                     
         J     CHKACTX                                                          
*                                                                               
         USING OSJPASD,R2                                                       
CHKACT06 LA    R2,IOKEY            Read for unapproved orders                   
         XC    IOKEY,IOKEY                                                      
         MVC   OSJPCPY,CUXCPY                                                   
         MVI   OSJPTYP,OSJPTYPQ                                                 
         MVI   OSJPSUB,OSJPSUBQ                                                 
         MVC   OSJPACT,ACTKACT                                                  
         MVC   CSVKEY1,IOKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         J     CHKACT10                                                         
*                                                                               
CHKACT08 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
*                                                                               
CHKACT10 CLC   OSJPAS(OSJPMEM-OSJPAS),CSVKEY1                                   
         JNE   CHKACT12                                                         
         TM    OSJPSTAT,ORDSDEL+ORDSFMCH+ORDSLDEL+ORDCLOSE+ORDGDRCV             
*&&US*&& TM    OSJPSTAT,ORDSDEL+ORDSFMCH+ORDSLDEL+ORDCLOSE                      
         JNZ   CHKACT08            Get next record                              
         MVI   JD_CDELT,NOQ                                                     
         TM    OSJPSTA2,ORDSAPPR   Is it fully approved                         
         JNZ   CHKACT08            Ignore this                                  
         MVI   JD_CCLSE,NOQ                                                     
         J     CHKACTX                                                          
                                                                                
         USING EXJPASD,R2                                                       
CHKACT12 LA    R2,IOKEY            Read for unapproved expense claims           
         XC    IOKEY,IOKEY                                                      
         MVC   EXJPCPY,CUXCPY                                                   
         MVI   EXJPTYP,EXJPTYPQ                                                 
         MVI   EXJPSUB,EXJPSUBQ                                                 
         MVI   EXJPVIEW,EXJPCLI1                                                
         TM    CPXSTAT6,CPX2LAEI   WPP workflow                                 
         JZ    *+8                 No                                           
         MVI   EXJPVIEW,EXJPCBL1                                                
         MVC   EXJPCOFF,JD_OFF                                                  
         MVC   EXJPCPJ,ACTKACT                                                  
         MVC   CSVKEY1,IOKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         J     CHKACT16                                                         
*                                                                               
CHKACT14 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
*                                                                               
CHKACT16 CLC   EXJPAS(EXJPMED-EXJPAS),CSVKEY1                                   
         JNE   CHKACT18                                                         
         TM    EXJPSTAT,EXCSDELT+EXCSLOGD Is expense claim deleted              
         JNZ   CHKACT14            Yes - Get next record                        
         MVI   JD_CDELT,NOQ                                                     
         TM    EXJPSTAT,EXCSCOMP                                                
         JNZ   CHKACT14                                                         
         MVI   JD_CCLSE,NOQ                                                     
         J     CHKACTX                                                          
                                                                                
CHKACT18 TM    CPXSTAT6,CPX2LAEI   WPP workflow                                 
         JZ    CHKACT24            No                                           
         MVC   IOKEY,CSVKEY1                                                    
         MVI   EXJPVIEW,EXJPCNB1                                                
         MVC   CSVKEY1,IOKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         J     CHKACT22                                                         
*                                                                               
CHKACT20 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
*                                                                               
CHKACT22 CLC   EXJPAS(EXJPMED-EXJPAS),CSVKEY1                                   
         JNE   CHKACT24                                                         
         TM    EXJPSTAT,EXCSDELT+EXCSLOGD Is expense claim deleted              
         JNZ   CHKACT20            Yes - Get next record                        
         MVI   JD_CDELT,NOQ                                                     
         TM    EXJPSTAT,EXCSCOMP                                                
         JNZ   CHKACT20                                                         
         MVI   JD_CCLSE,NOQ                                                     
         J     CHKACTX                                                          
                                                                                
CHKACT24 GOTO1 VHELLO,DMCB,(C'G',ACCMST),('ABLELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,12(R1)                                                        
         USING ABLELD,R2                                                        
         CP    ABLCR,ABLDR         Does account balance                         
         JE    CHKACT26            Yes                                          
         MVI   JD_CCLSE,NOQ                                                     
         MVI   JD_CDELT,NOQ                                                     
         J     CHKACTX                                                          
*                                                                               
CHKACT26 GOTO1 VHELLO,DMCB,(C'G',ACCMST),('ASTELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JNE   CHKACT30                                                         
         L     R2,12(R1)                                                        
         USING ASTELD,R2                                                        
         OC    ASTDRAFT,ASTDRAFT                                                
         JZ    CHKACT30                                                         
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('JCBELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JNE   CHKACT28                                                         
         L     R3,12(R1)                                                        
         USING JCBELD,R3                                                        
         SR    RF,RF                                                            
         ICM   RF,7,ASTDRAFT       SET RF=#DRAFT TRANSACTIONS                   
         SR    R1,R1               SET R6=#ADVANCE BILLS                        
         ICM   R1,3,JCBADV                                                      
         CR    RF,R1                                                            
         JNH   CHKACT30            ALL DRAFTS ARE ADVANCES                      
CHKACT28 MVI   JD_CCLSE,NOQ                                                     
         J     CHKACTX                                                          
*                                                                               
         USING TRNRECD,R2                                                       
CHKACT30 LA    R2,IOKEY                                                         
         MVC   TRNKEY,ACTKEY                                                    
         MVC   CSVKEY1,IOKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         J     CHKACT34                                                         
*                                                                               
CHKACT32 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
         LA    R2,IOKEY                                                         
*                                                                               
CHKACT34 CLC   TRNKEY(TRNKWORK-TRNKEY),CSVKEY1                                  
         JNE   CHKACTX             End of transactions                          
         CLC   TRNKCULC,SPACES                                                  
         JNH   CHKACT32                                                         
         CLC   TRNKDATE,SPACES                                                  
         JNH   CHKACT32                                                         
         CLC   TRNKREF,SPACES                                                   
         JNH   CHKACT32                                                         
         MVI   JD_CDELT,NOQ                                                     
*&&UK                                                                           
         CLC   TRNKWORK,=C'99'                                                  
         JE    CHKACT32                                                         
*&&                                                                             
         LHI   R1,IOGET+IOMST+IO3                                               
         TM    TRNKSTAT,TRNSARCH                                                
         JZ    *+8                                                              
         LHI   R1,IOGET+IOARC+IO3                                               
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO3                                                          
         L     R3,AIO1                                                          
         USING PRORATAD,R3                                                      
         XC    PG$GEN(PA$VALS-PG$GEN),PG$GEN                                    
         GOTO1 VPRORATA,DMCB,(X'00',TRNRECD),0,ACOMFACS,0,PRORATAD,0            
         CLC   TRNKWORK,=C'**'                                                  
         JNE   CHKACT42                                                         
         TM    SCPYEL+CPYSTAT7-CPYELD,CPYSNCOB                                  
         JNZ   CHKACT38                                                         
                                                                                
* Check the status first because a zero amount could be fully billed            
                                                                                
         TM    PG$STAT,PG$FULLB    Test order is fully billed                   
         JNZ   CHKACT32                                                         
         CP    PA$NET,=P'0'        Zero amount can't be fully billed            
         JE    CHKACT38                                                         
         DROP  R3                                                               
*                                                                               
         LA    RE,TRNRFST                                                       
         USING PTAELD,RE           Test if order is billed - that's ok          
CHKACT36 LLC   R0,1(RE)                                                         
         AR    RE,R0                                                            
         CLI   0(RE),0                                                          
         JE    CHKACT38            No billing on this order                     
         CLI   0(RE),PTAELQ                                                     
         JNE   CHKACT36                                                         
         CLI   PTATYPE,PTATRAL                                                  
         JNE   CHKACT36                                                         
         TM    PTASTAT1,PTASPEND                                                
         JNZ   CHKACT32                                                         
*                                                                               
CHKACT38 MVC   CSVKEY2,TRNKEY                                                   
*                                                                               
NEW      USING ORDRECD,R3                                                       
         LA    R3,IOKEY                                                         
         XC    NEW.ORDKEY,NEW.ORDKEY                                            
         MVI   NEW.ORDKTYP,ORDKTYPQ                                             
         MVC   NEW.ORDKCPY,CUXCPY                                               
         MVC   NEW.ORDKORD,TRNKREF                                              
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    CHKACT40                                                         
         MVC   IOKEY,CSVKEY2                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         J     CHKACT32                                                         
         DROP  NEW                                                              
*                                                                               
CHKACT40 MVI   JD_CCLSE,NOQ                                                     
         J     CHKACTX                                                          
*                                                                               
CHKACT42 L     R3,AGOBLOCB                                                      
         USING GOBLOCKD,R3                                                      
         CLI   GOBILTYP,C'C'         Is this client billing?                    
         JE    CHKACT46              Yes, use different logic                   
                                                                                
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('TRNELQ',TRNRECD),0                   
         CLI   12(R1),0                                                         
         JNE   CHKACT32                                                         
         L     R3,12(R1)                                                        
         USING TRNELD,R3                                                        
         TM    TRNSTAT,TRNSHOLD                                                 
         JNO   *+12                                                             
         MVI   JD_CCLSE,NOQ                                                     
         J     CHKACTX                                                          
                                                                                
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('TRSELQ',TRNRECD),0                   
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R3,12(R1)                                                        
         USING TRSELD,R3                                                        
         OC    TRSUDAT,TRSUDAT       No, is it billed ?                         
         JNZ   CHKACT32              Yes                                        
*                                                                               
         TM    TRNRSTAT,X'20'        Is it a reversal ?                         
         JO    CHKACT32              Yes - skip transactions                    
*                                                                               
         CLC   TRNKULC(2),=C'SK'     Is the contra SK                           
         JNE   CHKACT44              No                                         
         MVI   JD_CCLSE,NOQ                                                     
         J     CHKACTX                                                          
CHKACT44 GOTO1 VHELLO,DMCB,(C'G',ACCMST),('SPDELQ',TRNRECD),0                   
         CLI   12(R1),0                                                         
         JNE   CHKACT32                                                         
         L     R3,12(R1)                                                        
         USING SPDELD,R3                                                        
         CLC   SPDACCS(2),=C'SK'                                                
         JNE   CHKACT32                                                         
         MVI   JD_CCLSE,NOQ                                                     
         J     CHKACTX                                                          
*                                                                               
CHKACT46 LA    R3,TRNRFST                                                       
         USING BNDELD,R3                                                        
         ZAP   AC_AMT,=P'0'                                                     
         LR    R4,R3                                                            
CHKACT48 LLC   R0,BNDLN                                                         
         AR    R3,R0                                                            
         CLI   0(R3),0                                                          
         JE    CHKACT52            No billing on this order                     
         CLI   0(R3),TRNELQ                                                     
         JNE   CHKACT50                                                         
         LR    R4,R3                                                            
CHKACT50 CLI   0(R3),BNDELQ                                                     
         JNE   CHKACT48                                                         
*                                                                               
         CLC   BNDBNO,SPACES       Is this billed ?                             
         JNH   CHKACT48            No, get next                                 
         ICM   RF,15,BNDAMNT                                                    
         CVD   RF,DUB                                                           
         AP    AC_AMT,DUB                                                       
         J     CHKACT48                                                         
*                                                                               
         USING TRNELD,R4                                                        
CHKACT52 CP    AC_AMT,TRNAMNT                                                   
         JNE   CHKACT54                                                         
*                                                                               
         L     R5,AIO1                                                          
         USING PRORATAD,R5                                                      
         TM    PG$STAT3,PG$FULUT   FULLY UTILIZED?                              
         JO    CHKACT32            YES                                          
         TM    TRNSTAT,X'20'         NO, IS IT A REVERSAL ?                     
         JO    CHKACT32              YES, SKIP IT                               
*                                                                               
CHKACT54 MVI   JD_CCLSE,NOQ                                                     
CHKACTX  XIT1                                                                   
                                                                                
         DROP  R2,R3,R4,R5                                                      
                                                                                
***********************************************************************         
* JobList/Search - Estimate % Committed                               *         
***********************************************************************         
ESTPCC   NTR1  BASE=*,LABEL=*                                                   
                                                                                
         ZAP   JD_EPC,PZERO                                                     
         MVI   JD_COL,JD_COLWQ                                                  
         CLI   RQ_JDEPC,YESQ                                                    
         BNE   ESTPCCX                                                          
                                                                                
         ZAP   X#TEST,PZERO                                                     
         ZAP   X#EHRS,PZERO                                                     
         ZAP   X#TUOR,PZERO                                                     
         ZAP   X#TCRE,PZERO                                                     
         ZAP   X#TDEB,PZERO                                                     
         ZAP   X#THRS,PZERO                                                     
                                                                                
         L     R0,AIO6             Copy SJ job to AIO6 and emulate it           
         LA    R1,IOLENQ                                                        
         L     RE,AIO2                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
         LA    R2,DMCB                                                          
         GOTO1 VACCEMU,DMCB,=C'NEWO',,AIO6,AIO6                                 
                                                                                
         USING GOBLOCKD,R3                                                      
         L     R3,AGOBLOCB                                                      
                                                                                
*&&UK                                                                           
ESTPCC02 ZAP   X#CEAMBR,GOCEAMBR   CURRENT ESTIMATE AMBER WARNING               
         ZAP   X#CERED,GOCERED     CURRENT ESTIMATE RED WARNING                 
         DROP  R3                                                               
*&&                                                                             
*&&US                                                                           
         USING GOXBLKD,RE                                                       
ESTPCC02 L     RE,AGOXBLCK                                                      
         ZAP   X#CEAMBR,GOCEAMBR   CURRENT ESTIMATE AMBER WARNING               
         ZAP   X#CERED,GOCERED     CURRENT ESTIMATE RED WARNING                 
         DROP  R3,RE                                                            
*&&                                                                             
                                                                                
*&&UK*&& GOTO1 VJOBCOL,DMCB,(X'FF',JOBFLDS),ACOLIST,ACOMFACS                    
*&&US*&& GOTO1 VJOBCOL,DMCB,LOOKFLDH,ACOLIST,ACOMFACS                           
         CLI   4(R1),0                                                          
*&&UK*&& BE    ESTPCC04                                                         
*&&US*&& BNE   ESTPCC04                                                         
         DC    H'0'                                                             
                                                                                
         USING JBLOCKD,R3                                                       
ESTPCC04 GOTOR GETTUP              read in and validate TUP profile             
         L     R3,AJOBLOCK                                                      
         LR    RE,R3                                                            
         LHI   RF,JBLOCKL                                                       
         XCEF                                                                   
         MVC   JBAJOB,AIO6                                                      
         MVC   JBACOLS,ACOLIST                                                  
         MVC   JBACOM,ACOMFACS                                                  
*&&UK*&& MVC   JBCSHVAL,VCASHVAL                                                
*&&UK*&& MVC   JBTOBACO,VTOBACCO                                                
         MVC   JBAGOBLK,AGOBLOCB                                                
         MVC   JBAIO,AIO3                                                       
         MVC   JBGETOPT,VGETOPT                                                 
         MVC   JBAOPVTB,AELEAREA   Use ELEAREA here                             
         LHI   RE,L'ELEAREA                                                     
         ST    RE,JBLOPVTB                                                      
                                                                                
                                                                                
         MVC   JBACOLTB,AFREEST    Uses FREESTOR+GENAETXN                       
                                                                                
         LHI   RE,L'FREESTOR+L'GENAEXTN                                         
         ST    RE,JBLCOLTB                                                      
         MVI   JBSELFUN,JBGETDE     MCS: GET DETAILS AND SET ORIGINAL           
*&&UK*&& LA    RE,JOBFLDS               COLUMN LIST  ADDRESS (OE/CE)            
*&&US*&& LA    RE,LOOKFLDH              COLUMN LIST  ADDRESS (OE/CE)            
         ST    RE,JBORICLI                                                      
                                                                                
         GOTO1 VJOBBER,DMCB,AJOBLOCK                                            
         CLI   JBERROR,0                                                        
         BE    ESTPCC06                                                         
         DC    H'0'                                                             
                                                                                
ESTPCC06 CLI   JBNEWEST,JBMCSQ     FOR MCS ESTIMATES                            
         BE    ESTPCC12                                                         
                                                                                
         USING JBCOLD,R4                                                        
         L     R4,JBACOLTB         R4=A(COLUMN TABLE)                           
         XR    R2,R2                                                            
         ICM   R2,3,JBNROWS        R2=(LOOP COUNTER)                            
         BZ    ESTPCC14                                                         
                                                                                
ESTPCC08 CLI   JBCOLTYP,JBCOLTWC   TEST FOR WORK CODE ENTRY                     
         BNE   ESTPCC10                                                         
                                                                                
*&&UK*&& AP    X#TEST,JBCOLVAL(L'JBCOLVAL)                                      
*&&US*&& AP    X#TEST,JBCOLVAL+6(L'JBCOLVAL)                                    
*&&UK*&& AP    X#EHRS,JBCOLVAL+24(L'JBCOLVAL)     EST TOTAL HOURS               
*&&US*&& AP    X#EHRS,JBCOLVAL+12(L'JBCOLVAL)     EST TOTAL HOURS               
                                                                                
ESTPCC10 AH    R4,JBLCOL           NEXT TABLE ENTRY                             
         BCT   R2,ESTPCC08                                                      
         B     ESTPCC14                                                         
         DROP  R4                                                               
                                                                                
         USING MJETABD,R4                                                       
ESTPCC12 L     R4,JBACOLTB         1ST ENTRY IS TOTAL (MJETTYP=MJETTTQ)         
*&&UK*&& AP    X#TEST,MJETVAL                                                   
*&&US*&& AP    X#TEST,MJETVAL+6(L'MJETVAL)                                      
*&&UK*&& AP    X#EHRS,MJETVAL+24(L'MJETVAL)    EST TOTAL HOURS                  
*&&US*&& AP    X#EHRS,MJETVAL+12(L'MJETVAL)    EST TOTAL HOURS                  
         DROP  R3,R4                                                            
                                                                                
*                                                                               
TP       USING TSJPASD,IOKEY                                                    
ESTPCC14 XC    TP.TSJPAS,TP.TSJPAS                                              
         MVI   TP.TSJPTYP,TSJPTYPQ                                              
         MVI   TP.TSJPSUB,TSJPSUBQ                                              
         MVI   TP.TSJPVIEW,TSJPSJAQ                                             
         MVC   TP.TSJPCPY,CUXCPY                                                
         L     R1,AIO2                                                          
         MVC   TP.TSJPACT,ACTKACT-ACTKEY(R1)                                    
         MVC   TP.TSJPMED,JD_MED                                                
         MVC   TP.TSJPCOFF,JD_OFF                                               
         MVC   SAVEKEY2,TP.TSJPAS                                               
*                                                                               
ESTPCC20 GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         BE    ESTPCC24                                                         
         DC    H'0'                                                             
*                                                                               
ESTPCC22 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
         BE    ESTPCC24                                                         
         DC    H'0'                                                             
*                                                                               
ESTPCC24 CLC   TP.TSJPAS(TSJPPEDT-TSJPASD),SAVEKEY2    Match on key?            
         BNE   ESTPCC36                                                         
         GOTOR FLTTMK,DMCB,TP.TSJPASD filter time status                        
         BNE   ESTPCC22                                                         
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R3,AIO3                                                          
         AHI   R3,TIMRFST-TIMRECD                                               
*                                                                               
         USING TIMELD,R3                                                        
ESTPCC26 CLI   TIMEL,0                                                          
         BE    ESTPCC22                                                         
         CLI   TIMEL,TIMELQ                                                     
         BE    ESTPCC30                                                         
ESTPCC28 LLC   R0,TIMLN                                                         
         AR    R3,R0                                                            
         B     ESTPCC26                                                         
*                                                                               
ESTPCC30 CLI   TIMETYP,TIMEITMS                                                 
         JE    ESTPCC34                                                         
         CLI   TIMETYP,TIMEINP                                                  
         JNE   ESTPCC28                                                         
         ST    R3,FULL1            Save address of input timel                  
         L     R1,AIO2                                                          
         CLC   TIMACC,ACTKULA-ACTKEY(R1)                                        
         JNE   ESTPCC28            look for this job's items only               
         CLC   TIMTSK,SPACES       Have we got a workcode                       
         JNH   ESTPCC28                                                         
         CLI   TIMTTYP,TIMTNC                                                   
         JE    ESTPCC28                                                         
*                                                                               
         CLI   TIMTTYP,TIMTCN      Client non-billable                          
         JNE   ESTPCC3A                                                         
         GOTOR FLTTMS,DMCB,('TIMTCN',TP.TSJPAS)                                 
         JNE   ESTPCC3B                                                         
         AP    X#THRS,TIMHRS       Total up N cli hours                         
         J     ESTPCC3B                                                         
*                                                                               
ESTPCC3A CLI   TIMTTYP,TIMTCR      R chargeable time?                           
         JNE   ESTPCC31                                                         
         GOTOR FLTTMS,DMCB,('TIMTCR',TP.TSJPAS)                                 
         JNE   ESTPCC3B                                                         
         AP    X#THRS,TIMHRS       Total up R hours                             
         J     ESTPCC3B                                                         
*                                                                               
ESTPCC31 CLI   TIMTTYP,TIMTCB      B billable hours                             
         JNE   ESTPCC3B                                                         
         GOTOR FLTTMS,DMCB,('TIMTCB',TP.TSJPAS)                                 
         JNE   ESTPCC3B                                                         
         AP    X#THRS,TIMHRS       Total up billable hours                      
         J     ESTPCC3B                                                         
*                                                                               
ESTPCC3B GOTOR FLTTMP,DMCB,TIMELD,TP.TSJPAS                                     
         JNE   ESTPCC28                                                         
                                                                                
         ZAP   DUB1,TIMRATE        Amount = Rate * Hours                        
         MP    DUB1,TIMHRS                                                      
         SRP   DUB1,64-2,5         / 100 (hours is 2 dec places)                
*&&US*&& ZAP   DUB2,PZERO                                                       
*&&UK                                                                           
         ZAP   DUB2,TIMCRATE       Amount = Rate * Hours                        
         MP    DUB2,TIMHRS                                                      
         SRP   DUB2,64-2,5         / 100 (hours is 2 dec places)                
*&&                                                                             
         CLI   TIMTTYP,TIMTCR      R chargeable time?                           
         JNE   ESTPCC32                                                         
         CLI   GOINCR-GOXBLOCK(RF),YESQ                                         
         JNE   ESTPCC32                                                         
         LA    R1,DUB1                                                          
*&&UK                                                                           
         CLI   GOCSAT-GOXBLOCK(RF),GOCSCOST Want cost amount?                   
         JNE   *+8                                                              
         LA    R1,DUB2                                                          
*&&                                                                             
         AP    X#TDEB,0(L'DUB2,R1)                                              
                                                                                
ESTPCC32 CLI   TIMTTYP,TIMTCB      B billable hours                             
         JNE   ESTPCC28                                                         
         AP    X#TDEB,TIMAMNT                                                   
         J     ESTPCC28                                                         
                                                                                
ESTPCC34 L     R1,AIO2                                                          
         CLC   TIMIULA,ACTKULA-ACTKEY(R1)                                       
         JNE   ESTPCC28            Look for this job's items only               
         CLC   TIMITSK,SPACES      Have we got a workcode                       
         JNH   ESTPCC28                                                         
         L     R2,FULL1            R2=A(Input timel)                            
         GOTOR FLTTMP,DMCB,(R2),TP.TSJPAS                                       
         JNE   ESTPCC28                                                         
         AP    X#TDEB,TIMITOT                                                   
         J     ESTPCC28                                                         
         DROP  TP                                                               
*                                                                               
         USING EXJPASD,R2                                                       
ESTPCC36 LA    R6,EXPTYTAB                                                      
*                                                                               
ESTPCC38 LA    R2,IOKEY                                                         
         XC    EXJPAS,EXJPAS       EXPENSES                                     
         MVI   EXJPTYP,EXJPTYPQ                                                 
         MVI   EXJPSUB,EXJPSUBQ                                                 
         MVC   EXJPCPY,CUXCPY                                                   
         MVC   EXJPVIEW,0(R6)                                                   
         MVC   EXJPCOFF,JD_OFF                                                  
         L     R1,AIO2                                                          
         MVC   EXJPCPJ,ACTKACT-ACTKEY(R1)                                       
         MVC   SAVEKEY2,EXJPAS                                                  
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         BE    ESTPCC42                                                         
         DC    H'0'                                                             
                                                                                
ESTPCC40 LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
         BE    ESTPCC42                                                         
         DC    H'0'                                                             
                                                                                
ESTPCC42 CLC   EXJPAS(EXJPMED-EXJPASD),SAVEKEY2    Match on key?                
         BNE   ESTPCC50                                                         
         GOTOR FLTEXK,DMCB,EXJPAS                 filter expense claims         
         BNE   ESTPCC40                                                         
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING EXCRECD,R2                                                       
         L     R2,AIO3                                                          
         USING CIDELD,R3                                                        
         LA    R3,EXCRFST                                                       
         B     ESTPCC46                                                         
*                                                                               
ESTPCC44 LLC   R0,CIDLN            find appropriate CIDEL cluster(s)            
         AR    R3,R0                                                            
*                                                                               
ESTPCC46 CLI   CIDEL,0                                                          
         BE    ESTPCC40                                                         
         CLI   CIDEL,CIDELQ                                                     
         BNE   ESTPCC44                                                         
         CLI   CIDTYPE,CIDTYMQ                                                  
         BNE   ESTPCC44                                                         
*                                                                               
CUR      USING CIDELD,RF                                                        
         LA    RF,CIDELD           filter CIDEL and its cluster                 
         CLC   CIDMWCD,SPACES      Have we got a workcode                       
         BNH   ESTPCC44                                                         
         GOTOR FLTEXL,DMCB,0(RF),EXCRECD filter expense claims                  
         BNE   ESTPCC44                                                         
         LA    RF,CIDELD                                                        
                                                                                
ESTPCC48 LLC   R0,CUR.CIDLN                                                     
         AR    RF,R0                                                            
         CLI   CUR.CIDEL,CIDELQ                                                 
         BNE   ESTPCC44                                                         
         CLC   CUR.CIDSEQ,CIDSEQ                                                
         BNE   ESTPCC44                                                         
         CLI   CUR.CIDTYPE,CIDTYCQ                                              
         BNE   ESTPCC48                                                         
                                                                                
         L     R1,AIO2                                                          
         CLC   CUR.CIDCCPJ,ACTKACT-ACTKEY(R1)                                   
         BNE   ESTPCC44                                                         
         AP    X#TDEB,CIDMAMT      total up amount                              
         B     ESTPCC44                                                         
*                                                                               
ESTPCC50 LA    R6,1(R6)                                                         
         CLI   0(R6),X'FF'                                                      
         BNE   ESTPCC38                                                         
*                                                                               
         USING OSJPASD,R2                                                       
ESTPCC52 LA    R2,IOKEY            orders passives                              
         XC    OSJPAS,OSJPAS                                                    
         MVI   OSJPTYP,OSJPTYPQ                                                 
         MVI   OSJPSUB,OSJPSUBQ                                                 
         MVC   OSJPCPY,CUXCPY                                                   
         L     R1,AIO2                                                          
         MVC   OSJPACT,ACTKACT-ACTKEY(R1)                                       
         MVI   OSJPMEM,0                                                        
*                                                                               
         MVC   SAVEKEY2,OSJPAS                                                  
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         BE    ESTPCC56                                                         
         DC    H'0'                                                             
*                                                                               
ESTPCC54 LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
         BE    ESTPCC56                                                         
         DC    H'0'                                                             
*                                                                               
ESTPCC56 CLC   OSJPAS(OSJPMEM-OSJPASD),SAVEKEY2     Match on key?               
         BNE   ESTPCC68                                                         
*                                                                               
ESTPCC58 GOTOR FLTORD,DMCB,OSJPAS  filter orders                                
         BNE   ESTPCC54                                                         
*                                                                               
ESTPCC60 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLI   IOKEY+OSJPMEM-OSJPASD,0   skip looking for workcode              
         JE    ESTPCC64                   for expense orders                    
         USING ORDRECD,R2                                                       
         L     R2,AIO3                                                          
         USING FFTELD,R3                                                        
         LA    R3,ORDRFST                                                       
ESTPCC62 LLC   R0,FFTLN            Look to see whether there                    
         AR    R3,R0                is work code on memo orders                 
         CLI   FFTEL,0                                                          
         BE    ESTPCC54                                                         
         CLI   FFTEL,FFTELQ                                                     
         BNE   ESTPCC62                                                         
         CLI   FFTTYPE,FFTTWRKC                                                 
         JNE   ESTPCC62                                                         
         CLC   FFTWORK,SPACES                                                   
         JNH   ESTPCC62                                                         
                                                                                
         USING ORDRECD,R2                                                       
ESTPCC64 L     R2,AIO3                                                          
         USING OAMELD,R3                                                        
         LA    R3,ORDRFST                                                       
*                                                                               
ESTPCC66 LLC   R0,OAMLN            extract order amounts                        
         AR    R3,R0                                                            
         CLI   OAMEL,0                                                          
         BE    ESTPCC54                                                         
         CLI   OAMEL,OAMELQ                                                     
         BNE   ESTPCC66                                                         
         AP    X#TUOR,OAMAMNT      Order amount                                 
         SP    X#TUOR,OAMIVAL      Amount invoiced to date                      
         B     ESTPCC66                                                         
         DROP  R2,R3                                                            
*                                                                               
         USING ABLELD,R3                                                        
ESTPCC68 L     R3,AIO2             BALANCE ELEMENT                              
         AHI   R3,ACTRFST-ACTRECD                                               
                                                                                
ESTPCC70 CLI   ABLEL,0                                                          
         BE    ESTPCC82                                                         
         CLI   ABLEL,ABLELQ                                                     
         BE    ESTPCC74                                                         
         CLI   ABLEL,SCIELQ                                                     
         BE    ESTPCC76                                                         
ESTPCC72 LLC   R0,ABLLN                                                         
         AR    R3,R0                                                            
         B     ESTPCC70                                                         
                                                                                
ESTPCC74 AP    X#TDEB,ABLDR        ACTUAL CHARGES                               
         AP    X#TCRE,ABLCR        BILLED AMOUNT                                
         B     ESTPCC72                                                         
                                                                                
         USING SCIELD,R3                                                        
ESTPCC76 L     RF,AGOXBLCK                                                      
         CLI   GODITSR-GOXBLOCK(RF),GONONE                                      
         JE    ESTPCC78                                                         
         CLI   GOINCR-GOXBLOCK(RF),YESQ Are we including R-time                 
         JNE   ESTPCC78            No                                           
*&&UK                                                                           
         CLI   GOCSAT-GOXBLOCK(RF),GOCSCOST Want cost amount?                   
         JNE   *+12                No                                           
         CLI   SCITYPE,SCITMCRT    Cost amount                                  
         BE    ESTPCC80                                                         
         CLI   GOCSAT-GOXBLOCK(RF),GOCSSALE Want sales amount?                  
         BNE   *+12                No                                           
*&&                                                                             
         CLI   SCITYPE,SCITMSRT    Sales amount                                 
         BE    ESTPCC80                                                         
*&&UK                                                                           
ESTPCC78 CLI   SCITYPE,SCITMEXP    Memo expenses (EXPENSE INVOICES)             
*&&                                                                             
*&&US                                                                           
ESTPCC78 CLI   SCITYPE,SCITSJXP    Memo expenses (EXPENSE INVOICES)             
*&&                                                                             
         BNE   ESTPCC72                                                         
         CLI   GODEIS-GOXBLOCK(RF),GODAMT Include memo invoices?                
         JNE   ESTPCC72            No                                           
*                                                                               
ESTPCC80 AP    X#TDEB,SCIAMNT                                                   
         B     ESTPCC72                                                         
*                                                                               
ESTPCC82 ZAP   JD_ORDRS,X#TUOR                                                  
         ZAP   JD_NETBL,X#TCRE                                                  
         ZAP   JD_ACTLS,X#TDEB                                                  
         ZAP   JD_ESTMD,X#TEST                                                  
         ZAP   JD_ESHRS,X#EHRS                                                  
         ZAP   JD_ACHRS,X#THRS                                                  
                                                                                
         CP    X#TEST,PZERO        ANY ESTIMATE FIGURE?                         
         BE    ESTPCCX             CALCULATE:                                   
         ZAP   X#PL16,X#TUOR       ACTUALS = ORDERS + DEBITS                    
         AP    X#PL16,X#TDEB                                                    
         MP    X#PL16,=P'100000'   * 100 * 100 * 10                             
                                                                                
         ZAP   X#PL06,X#TEST       CURRENT ESTIMATE                             
                                                                                
         DP    X#PL16,X#PL06       EST % COMM = ACTUALS / CURRENT EST           
         ZAP   DUB,X#PL16(L'X#PL16-L'X#PL06)                                    
         SRP   DUB,63,5                                                         
                                                                                
         ZAP   JD_EPC,DUB                                                       
         MVI   JD_COL,JD_COLWQ     SET COLOUR = WHITE                           
         CP    X#CEAMBR,PZERO                                                   
         BNE   ESTPCC84                                                         
         CP    X#CERED,PZERO                                                    
         BE    ESTPCCX                                                          
                                                                                
ESTPCC84 MVI   JD_COL,JD_COLGQ     SET COLOUR = GREEN                           
         CP    DUB,X#CEAMBR                                                     
         BL    *+8                                                              
         MVI   JD_COL,JD_COLAQ     SET COLOUR = AMBER                           
         CP    X#CERED,PZERO       IGNORE ZERO % RED                            
         BNH   ESTPCCX                                                          
         CP    DUB,X#CERED                                                      
         BL    ESTPCCX                                                          
         MVI   JD_COL,JD_COLRQ     SET COLOUR = RED                             
                                                                                
ESTPCCX  XIT1                                                                   
         DROP  R3                                                               
***********************************************************************         
* Get TUP profile and 'translate' filter out based on GODITSB and     *         
* GODITSN and GODITSR (must be called after getopt call)              *         
***********************************************************************         
         USING COBLOCKD,R2                                                      
         USING GOXBLKD,R4                                                       
GETTUP   NTR1  BASE=*,LABEL=*                                                   
                                                                                
         L     R2,ACOBLOCK         Get cost allocation profiles                 
         L     R4,AGOXBLCK                                                      
         MVC   ORACCNT,SPACES                                                   
         GOTOR (#CSTPRF,ACSTPRF),DMCB,ORACCNT                                   
*                                                                               
         LA    R3,GODITSR                                                       
         LA    R1,X#RTTRX                                                       
         LA    R0,TMSTNUM          Number of settings                           
         USING COGOTABD,R4                                                      
GETTUP2  LA    R4,COGOTAB                                                       
*                                                                               
GETTUP4  CLC   COGOCAP,COTUP       Find match on COTUP                          
         BNE   GETTUP6             Get next entry in table if no match          
         CLC   COGOGOPT,0(R3)      Find match on getopt setting                 
         BE    GETTUP8                                                          
GETTUP6  LA    R4,COGOTABL(R4)                                                  
         B     GETTUP4                                                          
*                                                                               
GETTUP8  MVC   0(TMSTTABL,R1),COGOMPTY Set whether to read passives             
         LA    R3,1(R3)                                                         
         LA    R1,TMSTTABL(R1)     Point R1 to next type of time                
         BCT   R0,GETTUP2                                                       
*                                                                               
GETTUPX  XIT1                                                                   
         DROP  R2,R4                                                            
                                                                                
COGOTAB  DS    0X                                                               
         DC    AL1(COSAVED,GONONE,NOQ,0,0,0)                                    
         DC    AL1(COSAVED,GOAPPR,NOQ,0,0,0)                                    
         DC    AL1(COSAVED,GOINPR,NOQ,0,0,0)                                    
         DC    AL1(COSAVED,GOSUB,NOQ,0,0,0)                                     
         DC    AL1(COSAVED,GOMANPAP,NOQ,0,0,0)                                  
         DC    AL1(COSAVED,GOCLIPAP,NOQ,0,0,0)                                  
         DC    AL1(COSUBMD,GONONE,NOQ,0,0,0)                                    
         DC    AL1(COSUBMD,GOAPPR,NOQ,0,0,0)                                    
         DC    AL1(COSUBMD,GOINPR,YESQ,0,0,0)                                   
         DC    AL1(COSUBMD,GOSUB,NOQ,0,0,0)                                     
         DC    AL1(COSUBMD,GOCLIPAP,NOQ,0,0,0)                                  
         DC    AL1(COSUBMD,GOMANPAP,NOQ,0,0,0)                                  
         DC    AL1(COCLAPR,GONONE,NOQ,0,0,0)                                    
         DC    AL1(COCLAPR,GOAPPR,NOQ,0,0,0)                                    
         DC    AL1(COCLAPR,GOINPR,YESQ,TIMSSUBM+TIMSREJE+TIMSPAPP)              
         DC    AL1(0,TIMSAWAP)                                                  
         DC    AL1(COCLAPR,GOSUB,NOQ,TIMSSUBM+TIMSPAPP,0,TIMSAWAP)              
         DC    AL1(COCLAPR,GOMANPAP,NOQ,TIMSMAAP,0,TIMSAWAP)                    
         DC    AL1(COCLAPR,GOCLIPAP,NOQ,0,0,0)                                  
         DC    AL1(COLMAPR,GONONE,NOQ,0,0,0)                                    
         DC    AL1(COLMAPR,GOAPPR,NOQ,0,0,0)                                    
         DC    AL1(COLMAPR,GOINPR,YESQ,TIMSSUBM+TIMSREJE+TIMSPAPP)              
         DC    AL1(TIMSMAAP,0)                                                  
         DC    AL1(COLMAPR,GOSUB,NOQ,TIMSSUBM+TIMSPAPP,TIMSMAAP,0)              
         DC    AL1(COLMAPR,GOMANPAP,NOQ,0,0,0)                                  
         DC    AL1(COLMAPR,GOCLIPAP,NOQ,TIMSPAPP,0,TIMSAWAP)                    
         DC    AL1(COFUAPR,GONONE,NOQ,0,0,0)                                    
         DC    AL1(COFUAPR,GOAPPR,NOQ,0,0,0)                                    
         DC    AL1(COFUAPR,GOINPR,YESQ,TIMSSUBM+TIMSREJE+TIMSPAPP,0,0)          
         DC    AL1(COFUAPR,GOSUB,NOQ,TIMSSUBM+TIMSPAPP,0,0)                     
         DC    AL1(COFUAPR,GOMANPAP,NOQ,TIMSMAAP,0,0)                           
         DC    AL1(COFUAPR,GOCLIPAP,NOQ,TIMSPAPP,0,TIMSFAPP)                    
         DC    X'FF'                                                            
                                                                                
                                                                                
***********************************************************************         
* Filter time records according to lowest Getopt setting              *         
* ON NTRY P1=TSJPASD                                                  *         
***********************************************************************         
         SPACE 1                                                                
         USING GOXBLOCK,RF                                                      
         USING GOTMKTBD,R2                                                      
         USING TSJPASD,R3                                                       
FLTTMK   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R3,0(R1)            R3=A(Time passive key)                       
         L     RF,AGOXBLCK                                                      
         TM    0(R3),TIMSDELT      Ignore deleted                               
         JNZ   EXITN                                                            
*                                                                               
         CLI   GODITSR,GONONE      NONE TO BE INCLUDED?                         
         JNE   *+12                                                             
         CLI   GODITSB,GONONE                                                   
         JE    EXITN               NOTHING TO BE INCLUDED                       
*                                                                               
         LA    R2,GOTMKTAB                                                      
*                                                                               
FLTTMK02 CLI   0(R2),X'FF'         End of table                                 
         JE    EXITN                                                            
         CLC   GODITSR,GOTMKGOP    Match on opt setting                         
         JNE   FLTTMK06                                                         
         CLI   GOTMKMPT,YESQ       Are we interested in saved timesheet         
         JNE   FLTTMK04            No                                           
         OC    TSJPSTAT,TSJPSTAT   Yes - have we got one                        
         JZ    EXITY               Yes - want this time record                  
*                                                                               
FLTTMK04 OC    GOTMKSTA,GOTMKSTA   Are we interested in other statuses          
         JZ    FLTTMK06            No - get next time type                      
         MVC   X#BYTE3,GOTMKSTA    Yes - do we have a match                     
         NC    X#BYTE3,TSJPSTAT                                                 
         OC    X#BYTE3,X#BYTE3     Any match on the statuses                    
         JZ    FLTTMK06            No                                           
         OC    GOTMKCAS,GOTMKCAS   Are we interested in client approval         
         JZ    EXITY               No - we want time record                     
         MVC   X#BYTE3,GOTMKCAS    Yes - check it matches                       
         NC    X#BYTE3,TSJPKSTA                                                 
         OC    X#BYTE3,X#BYTE3                                                  
         JNZ   EXITY               Match found accept timel                     
*                                                                               
FLTTMK06 LA    R2,TMSTTABL(R2)                                                  
         J     FLTTMK02                                                         
*                                                                               
         DROP  R2,R3,RF                                                         
         EJECT                                                                  
***********************************************************************         
* Filter out based on GETOPT setting and timesheet status             *         
* ON NTRY P1=TSJPASD                                                  *         
***********************************************************************         
         SPACE 1                                                                
         USING GOTMKTBD,R2                                                      
         USING TSJPASD,R3                                                       
FLTTMS   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R3,0(R1)            R3=A(Time passive key)                       
         MVC   X#BYTE3,0(R1)                                                    
         L     RF,AGOXBLCK                                                      
         LA    RF,GODITSN-GOXBLOCK(RF)                                          
         CLI   X#BYTE3,TIMTCN      Client non billable time?                    
         JE    FLTTMS00                                                         
         L     RF,AGOXBLCK                                                      
         LA    RF,GODITSR-GOXBLOCK(RF)                                          
         CLI   X#BYTE3,TIMTCR      Chargeable time?                             
         JE    FLTTMS00                                                         
         L     RF,AGOXBLCK                                                      
         LA    RF,GODITSB-GOXBLOCK(RF)                                          
         CLI   X#BYTE3,TIMTCB      Billable time?                               
         JE    FLTTMS00                                                         
         DC    H'0'                Unrecognised time typeD                      
*                                                                               
FLTTMS00 CLI   0(RF),GONONE      None to be included?                           
         JE    EXITN                                                            
         LA    R2,GOTMKTAB                                                      
*                                                                               
FLTTMS02 CLI   0(R2),X'FF'         End of table                                 
         JE    EXITN                                                            
         CLC   0(L'GODITSN,RF),GOTMKGOP    Match on opt setting                 
         JNE   FLTTMS06                                                         
         CLI   GOTMKMPT,YESQ       Are we interested in saved timesheet         
         JNE   FLTTMS04            No                                           
         OC    TSJPSTAT,TSJPSTAT   Yes - have we got one                        
         JZ    EXITY               Yes - want this time record                  
*                                                                               
FLTTMS04 OC    GOTMKSTA,GOTMKSTA   Are we interested in other statuses          
         JZ    FLTTMS06            No - get next time type                      
         MVC   X#BYTE3,GOTMKSTA    Yes - do we have a match                     
         NC    X#BYTE3,TSJPSTAT                                                 
         OC    X#BYTE3,X#BYTE3     Any match on the statuses                    
         JZ    FLTTMS06            No                                           
         OC    GOTMKCAS,GOTMKCAS   Are we interested in client approval         
         JZ    EXITY               No - we want time record                     
         MVC   X#BYTE3,GOTMKCAS    Yes - check it matches                       
         NC    X#BYTE3,TSJPKSTA                                                 
         OC    X#BYTE3,X#BYTE3                                                  
         JNZ   EXITY               Match found accept timel                     
*                                                                               
FLTTMS06 LA    R2,TMSTTABL(R2)                                                  
         J     FLTTMS02                                                         
*                                                                               
         DROP  R2,R3                                                            
         EJECT                                                                  
***********************************************************************         
* FILTER TIME RECORDS ACCORDING TO COTUP AND GODITSB, GODITSR,GODITSN *         
* ROUTINE #1-FILTER TSJPASD                                           *         
* ON NTRY P1=A(TIMELD)                                                *         
*         P2=A(TSJPASD)                                               *         
***********************************************************************         
                                                                                
FLTTMP   NTR1  BASE=*,LABEL=*                                                   
                                                                                
         LM    R3,R4,0(R1)         R4=A(TIMELD),R5=A(TSJPAS)                    
                                                                                
         USING TSJPASD,R4                                                       
         USING TIMELD,R3                                                        
*                                                                               
         USING TMSTTABD,R1                                                      
         CLI   TIMTTYP,TIMTCB      Billable time?                               
         JNE   FLTTMP02                                                         
         LA    R1,X#BTTRX                                                       
         J     FLTTMP06                                                         
                                                                                
FLTTMP02 CLI   TIMTTYP,TIMTCR      R type time?                                 
         JNE   FLTTMP04                                                         
         LA    R1,X#RTTRX                                                       
         J     FLTTMP06                                                         
                                                                                
FLTTMP04 CLI   TIMTTYP,TIMTCN      non billable time?                           
         JE    *+6                                                              
         DC    H'0'                                                             
         LA    R1,X#NTTRX                                                       
                                                                                
FLTTMP06 OC    TMSTSTAT,TMSTSTAT   Are we interested in any statuses            
         JNZ   FLTTMP08            Yes                                          
         CLI   TMSTMPTY,NOQ        Are we interested in saved TS                
         JE    EXITN                                                            
*                                                                               
FLTTMP08 CLI   TMSTMPTY,YESQ       Are we interested in saved TS                
         JNE   FLTTMP10            No                                           
         OC    TSJPSTAT,TSJPSTAT   Yes - do we have a saved timesheet           
         JZ    EXITY               Yes - accept time line                       
         OC    TMSTSTAT,TMSTSTAT   No - are we interested in any other          
         JZ    EXITN                            statuses                        
FLTTMP10 MVC   X#BYTE3,TMSTSTAT                                                 
         NC    X#BYTE3,TSJPSTAT                                                 
         OC    X#BYTE3,X#BYTE3     Any match on the statuses                    
         JZ    EXITN               No - don't want this timel                   
         OC    TMSTXSTA,TMSTXSTA   Yes - do we have an exception status         
         JZ    FLTTMP12            No                                           
         MVC   X#BYTE3,TMSTXSTA    Yes - check for a match                      
         NC    X#BYTE3,TSJPSTAT                                                 
         OC    X#BYTE3,X#BYTE3                                                  
         JNZ   EXITN               Reject timel if found                        
FLTTMP12 OC    TMSTCLST,TMSTCLST   Are we interested in client approval         
         JZ    EXITY               No                                           
         MVC   X#BYTE3,TMSTCLST    Yes - check it matches                       
         NC    X#BYTE3,TSJPKSTA                                                 
         OC    X#BYTE3,X#BYTE3                                                  
         JNZ   EXITY               Match found accept timel                     
         J     EXITN               Reject timel                                 
                                                                                
         DROP  R1,R3,R4                                                         
         EJECT                                                                  
***********************************************************************         
* Filter expenses according to GODIEN and GODIEB                      *         
* ON NTRY P1=EXJPASD                                                  *         
***********************************************************************         
FLTEXK   NTR1  BASE=*,LABEL=*                                                   
         L     R2,0(R1)                                                         
         L     R3,AGOXBLCK                                                      
         USING EXJPASD,R2                                                       
         USING GOXBLKD,R3                                                       
*                                                                               
         TM    EXJPSTAT,EXCSLOGD   ignore logically deleted                     
         JNZ   EXITN                                                            
                                                                                
         LA    RF,GODIEN                                                        
         LA    RE,GODIEB                                                        
         CLI   0(RF),GOINPR        find lowest level of both settings           
         JE    EXITY                                                            
         CLI   0(RE),GOINPR                                                     
         JE    EXITY                                                            
         OC    EXJPSTAT,EXJPSTAT   ignore in progress                           
         JZ    EXITN                                                            
         TM    EXJPSTAT,EXCSREJE   ignore and rejected                          
         JNZ   EXITN                                                            
         CLI   0(RF),GOSUB         submitted?                                   
         JE    EXITY                                                            
         CLI   0(RE),GOSUB                                                      
         JE    EXITY                                                            
         TM    EXJPSTAT,EXCSSUBM   ignore submitted                             
         JNZ   EXITN                                                            
         CLI   0(RF),GOPAP         part approved                                
         JE    EXITY                                                            
         CLI   0(RE),GOPAP                                                      
         JE    EXITY                                                            
         TM    EXJPSTAT,EXCSPAPP+EXCSFNTA                                       
         JNZ   EXITN                                                            
         TM    EXJPSTAT,EXCSCOMP                                                
         JZ    EXITN                                                            
         CLI   0(RF),GOAPPR        approved                                     
         JE    EXITY                                                            
         CLI   0(RE),GOAPPR                                                     
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  R2,R3                                                            
         EJECT                                                                  
***********************************************************************         
* Filter expenses according to GODIEN and GODIEB                      *         
* Filter CIDELDS                                                      *         
* ON NTRY P1=A(CIDELD)                                                *         
*         P2=A(EXCRECD)                                               *         
***********************************************************************         
FLTEXL   NTR1  BASE=*,LABEL=*                                                   
         LM    R2,R3,0(R1)         R2=A(CIDELD),R3=A(EXCRECD)                   
*                                                                               
         L     R4,AGOXBLCK                                                      
         USING CIDELD,R2                                                        
         USING GOXBLKD,R4                                                       
         USING EXCRECD,R3                                                       
*                                                                               
         CLI   CIDMTYP,CIDMBILQ    billable                                     
         JNE   FLTEXL02                                                         
         LA    RF,GODIEB                                                        
         TM    EXCRSTAT,EXCSCOMP   ignore fully approved - double count         
         JNZ   EXITN                                                            
         J     FLTEXL04                                                         
*                                                                               
FLTEXL02 CLI   CIDMTYP,CIDMNBLQ    non-billable                                 
         JE    *+6                                                              
         DC    H'0'                this cideld is bad                           
         LA    RF,GODIEN                                                        
         LA    RE,GODEIS                                                        
         CLI   0(RE),NOQ           Have we already got memo invoice             
         JE    FLTEXL04            No                                           
         TM    EXCRSTAT,EXCSCOMP   Yes ignore fully approved to avoid           
         JNZ   EXITN                               double counting              
         J     FLTEXL04                                                         
*                                                                               
FLTEXL04 CLI   0(RF),GONONE        none?                                        
         JE    EXITN                                                            
         CLI   0(RF),GOINPR        in progress?                                 
         JE    EXITY                                                            
         OC    EXCRSTAT,EXCRSTAT   ignore in progress                           
         JZ    EXITN                                                            
         TM    EXCRSTAT,EXCSREJE   ignore rejected                              
         JNZ   EXITN                                                            
         CLI   0(RF),GOSUB         submitted?                                   
         JE    EXITY                                                            
         TM    EXCRSTAT,EXCSSUBM   ignore submitted                             
         JNZ   EXITN                                                            
         CLI   0(RF),GOPAP         part approved                                
         JE    EXITY                                                            
         TM    EXCRSTAT,EXCSPAPP+EXCSFNTA  ignore part appr                     
         JNZ   EXITN                                                            
         TM    EXCRSTAT,EXCSCOMP                                                
         JZ    EXITN                                                            
         CLI   0(RF),GOAPPR        approved                                     
         JE    EXITY                                                            
         DC    H'0'                bad getopt setting                           
         DROP  R2,R3,R4                                                         
         EJECT                                                                  
***********************************************************************         
* Filter order passives according to GODIOS and GODIEO                *         
* ON NTRY P1=A(ORDER PASSIVE)                                         *         
***********************************************************************         
FLTORD   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R2,0(R1)                                                         
         USING OSJPASD,R2                                                       
         TM    OSJPSTAT,ORDCLOSE+ORDSLDEL+ORDSFMCH  Ignore cancelled            
         JNZ   EXITN                closed and deleted orders                   
         TM    OSJPSTA2,ORDSOREJ   Ignore rejected orders                       
         JNZ   EXITN                                                            
*                                                                               
* any change to the above needs to be referred to NSHE!                         
*                                                                               
FLTORD02 L     R3,AGOXBLCK                                                      
         USING GOXBLKD,R3                                                       
         LA    RF,GODIOS           order option                                 
         CLI   OSJPMEM,0           is it memo?                                  
         JE    FLTORD06                                                         
         LA    RF,GODIEO           yes-use memo order option                    
*                                                                               
FLTORD06 CLI   0(RF),GONONE        none                                         
         JE    EXITN                                                            
         CLI   0(RF),GOINPR        in progress                                  
         JE    EXITY                                                            
         TM    OSJPSTA2,ORDSDRFT   ignore in progress                           
         JNZ   EXITN                                                            
         CLI   0(RF),GOSUB         submitted                                    
         JE    EXITY                                                            
         TM    OSJPSTA2,ORDSSUBM   ignore submitted                             
         JNZ   EXITN                                                            
         CLI   0(RF),GOPAP         part approved                                
         JE    EXITY                                                            
         TM    OSJPSTA2,ORDSPAPP   ignore part approved                         
         JNZ   EXITN                                                            
         CLI   0(RF),GOAPPR        approved                                     
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  R2,R3                                                            
         EJECT                                                                  
***********************************************************************         
* Get approvers for job                                               *         
***********************************************************************         
GETAPP   NTR1  BASE=*,LABEL=*                                                   
                                                                                
         LM    R3,R4,0(R1)                                                      
         MVC   BYTE3,0(R1)                                                      
         LA    R5,ACCBLK                                                        
GETAPP00 MVI   BYTE2,NOQ                                                        
P        USING ACTKACT,R3                                                       
                                                                                
         LA    R2,APRTAB                                                        
         USING APRTABD,R2                                                       
SA       USING JOBPASD,IOKEY                                                    
GETAPP02 XC    SA.JOBPAS,SA.JOBPAS Look for Cli/Pro job appr passive            
         MVI   SA.JOBPTYP,JOBPTYPQ                                              
         MVI   SA.JOBPSUB,JOBPSUBQ                                              
         MVC   SA.JOBPCPY,CUXCPY                                                
         MVI   SA.JOBPAPPL,JOBPAJOB                                             
         MVI   SA.JOBPVIEW,JOBPVOFF                                             
         MVC   SA.JOBPCPJ,SPACES                                                
         MVC   SA.JOBPCOFF,SPACES                                               
         MVC   SA.JOBPCMED,SPACES                                               
         OC    APRSTAT,APRSTAT                                                  
         JNZ   GETAPP04                                                         
         MVI   SA.JOBPCODE,X'FF'                                                
         MVC   SA.JOBPCODE+1(L'JOBPCODE-1),SA.JOBPCODE                          
         J     GETAPP12                                                         
                                                                                
GETAPP04 TM    APRSTAT,APRPRO                                                   
         JZ    GETAPP06                                                         
         LLC   RF,PCLILEN                                                       
         LA    RF,P.ACTKACT(RF)                                                 
         CLI   0(RF),X'40'         Have we got a product                        
         JNH   GETAPP18            No                                           
         LLC   RF,PPROLEN                                                       
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   SA.JOBPCPJ(0),P.ACTKACT                                          
         EX    RF,0(RE)                                                         
         J     GETAPP08                                                         
GETAPP06 TM    APRSTAT,APRCLI                                                   
         JZ    GETAPP08                                                         
         LLC   RF,PCLILEN                                                       
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   SA.JOBPCPJ(0),P.ACTKACT                                          
         EX    RF,0(RE)                                                         
                                                                                
GETAPP08 TM    APRSTAT,APRMED                                                   
         JZ    GETAPP10                                                         
         CLC   X#MEDC,SPACES                                                    
         JNH   GETAPP18                                                         
         MVC   SA.JOBPCMED,X#MEDC                                               
                                                                                
GETAPP10 TM    APRSTAT,APROFF                                                   
         JZ    GETAPP12                                                         
         CLC   0(L'TRNOFFC,R4),SPACES                                           
         JNH   GETAPP18                                                         
         MVC   SA.JOBPCOFF,0(R4)                                                
                                                                                
GETAPP12 OC    SA.JOBPCODE,SPACES                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         J     GETAPP16                                                         
                                                                                
GETAPP14 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
                                                                                
GETAPP16 CLC   SA.JOBPAS(JOBPPIDB-JOBPASD),IOKEYSAV                             
         JE    GETAPP20                                                         
         CLI   BYTE2,YESQ          Did we find an approver                      
         JNE   GETAPP18            No                                           
         OC    X#JAPP,X#JAPP       Yes - did we find default                    
         JNZ   EXITY               Yes                                          
         J     EXITN               No - error as there should be one            
GETAPP18 LA    R2,APRTABL(R2)                                                   
         CLI   0(R2),X'FF'                                                      
         JNE   GETAPP02                                                         
         J     EXITN                                                            
                                                                                
GETAPP20 MVI   BYTE2,YESQ                                                       
         CLI   BYTE3,1             Are we looking for default only              
         BNE   GETAPP22            No                                           
         MVC   0(L'JOBPPIDB,R5),SA.JOBPPIDB                                     
         MVC   L'JOBPPIDB(L'JP_LVL,R5),APRLVL                                   
         LA    R5,L'JOBPPIDB+L'JP_LVL(R5)                                       
         TM    SA.JOBPSTAT,JOBPDFLT Is it default approver                      
         JZ    GETAPP14                                                         
         OC    X#JAPP,X#JAPP       Did we already find default                  
         JNZ   GETAPP14            Yes                                          
         MVC   X#JAPP,SA.JOBPPIDB                                               
         MVC   JP_LVL,APRLVL       approver level                               
         B     GETAPP14                                                         
                                                                                
GETAPP22 CLC   SA.JOBPPIDB,CCTPID  Is this approver the correct one             
         BNE   GETAPP14                                                         
         JE    EXITY                                                            
                                                                                
         DROP  P,SA,R2                                                          
                                                                                
SVRDEF   CSECT ,                                                                
                                                                                
***********************************************************************         
* set client details and carry on                                     *         
***********************************************************************         
CASCLI   NTR1  BASE=*,LABEL=*                                                   
                                                                                
         LTR   R1,R1               XJOBOUT special call to get client           
         JNZ   CASCLI02                                                         
         MVC   X#ACT,SPACES                                                     
         MVC   X#ACT(L'JD_CLI),JD_CLI                                           
CR       USING ACTRECD,R1                                                       
         L     R1,AIO4             current client in IO area?                   
         CLC   JD_CLI,CR.ACTKACT                                                
         JNE   CASCLI08                                                         
         L     R0,AIO2             copy AIO4 into AIO2                          
         LA    R1,IOLENQ                                                        
         L     RE,AIO4                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         L     R3,AIO2                                                          
         J     CASCLI10                                                         
         DROP  CR                                                               
                                                                                
CASCLI02 MVC   X#ACT,0(R1)                                                      
         LA    R4,X#ACT                                                         
                                                                                
         MVI   X#HIGH,NOQ                                                       
         LLC   RE,PCLILEN                                                       
         BCTR  RE,0                                                             
                                                                                
TSB      USING JSBD_D,CSVKEY3                                                   
         CLI   X#TSAYN,YESQ        TSAR required?                               
         JNE   CASCLI08                                                         
         XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         MVI   TSB.JSBDTYP,JSBDTCQ                                              
         MVC   TSB.JSBDCOD,SPACES                                               
         MVC   TSB.JSBDCOD(0),0(R4)                                             
         EX    RE,*-6                                                           
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         JE    CASCLI04                                                         
         TM    TSARERRS,TSERNF     Test record not found                        
         JNZ   CASCLI08                                                         
         DC    H'0'                Other error                                  
                                                                                
CASCLI04 MVC   X#AOFF,TSB.JSBDOFF  save current client details                  
         MVC   ELESDCLI,TSB.JSBDCOD                                             
         MVC   ELESDCST,TSB.JSBDSTA                                             
         MVC   ELESDCOF,TSB.JSBDOFF                                             
         MVC   ELESDCLN,TSB.JSBDNAM                                             
         MVC   JD_CLN,SPACES                                                    
         MVC   JD_CLN,TSB.JSBDNAM                                               
         MVC   ELESDCXD,TSB.JSBDXDB                                             
         XC    ELESDPRO(ELESPLNQ),ELESDPRO                                      
         MVC   X#HOFF,ELESDCOF                                                  
         MVC   X#POFF,ELESDCOF                                                  
                                                                                
         TM    ELESDCST,ACTSLOCK   client locked?                               
         JZ    EXITY                                                            
         J     EXITN                                                            
                                                                                
CASCLI08 MVC   CSVKEY1,IOKEY                                                    
                                                                                
         USING ACTRECD,R3                                                       
         LA    R3,IOKEY            read for client account record               
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(2),PRODUL                                                
         LLC   R1,PCLILEN                                                       
         BCTR  R1,0                                                             
         MVC   ACTKACT(0),X#ACT                                                 
         EX    R1,*-6                                                           
         MVI   X#HIGH,YESQ                                                      
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JNE   *+2                                                              
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
                                                                                
         L     R0,AIO4             Copy SJ client to AIO4                       
         LA    R1,IOLENQ                                                        
         L     RE,AIO2                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         L     R3,AIO2                                                          
                                                                                
CASCLI10 LLC   RE,PPROLEN                                                       
         AHI   RE,ACTKACT-ACTKCPY-1                                             
         STC   RE,X#CLVL                                                        
                                                                                
         GOTOR XJOBGOF                                                          
                                                                                
         XC    X#HOFF,X#HOFF                                                    
         CLC   X#AOFF,SPACES                                                    
         JNH   CASCLI12                                                         
                                                                                
         MVC   X#HOFF,X#AOFF                                                    
         MVC   X#POFF,X#AOFF                                                    
                                                                                
TSB      USING JSBD_D,CSVKEY3                                                   
CASCLI12 XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         LHI   R1,JSBDLNQ                                                       
         STH   R1,TSB.JSBDLEN                                                   
         MVI   TSB.JSBDTYP,JSBDTCQ                                              
         MVC   TSB.JSBDCOD,ACTKACT                                              
         MVC   TSB.JSBDOFF,X#POFF                                               
         MVC   TSB.JSBDNAM,SPACES                                               
         CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    CASCLI14                                                         
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    CASCLI14                                                         
         CLI   RQ_JDLST,YESQ       include locked jobs?                         
         JE    CASCLI14                                                         
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    CASCLI14                                                         
         MVC   TSB.JSBDSTA,ACTRSTAT                                             
                                                                                
         USING NAMELD,R1                                                        
CASCLI14 LA    R1,ACTRFST                                                       
CASCLI16 CLI   NAMEL,NAMELQ                                                     
         JE    CASCLI18                                                         
         CLI   NAMEL,0                                                          
         JE    *+2                                                              
         LLC   R0,NAMLN                                                         
         AR    R1,R0                                                            
         J     CASCLI16                                                         
CASCLI18 LLC   RE,NAMLN                                                         
         SHI   RE,NAMLN1Q+1                                                     
         MVC   JD_CLN,SPACES                                                    
         MVC   JD_CLN(0),NAMEREC                                                
         EX    RE,*-6                                                           
         MVC   TSB.JSBDNAM(0),NAMEREC                                           
         EX    RE,*-6                                                           
         DROP  R1                                                               
                                                                                
         GOTOR SETXDB,DMCB,TSB.JSBDXDB,ACTRECD                                  
                                                                                
         CLI   X#TSAYN,YESQ        TSAR required?                               
         JNE   CASCLI20                                                         
                                                                                
         GOTOR GOTSAR,DMCB,('TSAADD',0)  add client to buffer                   
         JE    CASCLI20                                                         
         TM    TSARERRS,TSEEOF     buffer full - so it is ...                   
         JNZ   CASCLI20                                                         
         DC    H'0'                duplicate key                                
                                                                                
CASCLI20 MVC   ELESDCLI,TSB.JSBDCOD save current client details                 
         MVC   ELESDCST,TSB.JSBDSTA                                             
         MVC   ELESDCOF,TSB.JSBDOFF                                             
         MVC   ELESDCLN,TSB.JSBDNAM                                             
         MVC   JD_CLN,SPACES                                                    
         MVC   JD_CLN,TSB.JSBDNAM                                               
         MVC   ELESDCXD,TSB.JSBDXDB                                             
         XC    ELESDPRO(ELESPLNQ),ELESDPRO                                      
         MVC   X#HOFF,ELESDCOF                                                  
         MVC   X#POFF,ELESDCOF                                                  
         DROP  TSB                                                              
                                                                                
         TM    ELESDCST,ACTSLOCK   do we want it?                               
         JZ    CASCLI22                                                         
                                                                                
CASCLI22 MVC   IOKEY,CSVKEY1                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JNE   *+2                                                              
                                                                                
         TM    ELESDCST,ACTSLOCK                                                
         JNZ   EXITN                                                            
         J     EXITY                                                            
                                                                                
         DROP  R3                                                               
         EJECT                                                                  
***********************************************************************         
* Check for Product requested, if not check for product change, if so *         
* set product details and carry on                                    *         
***********************************************************************         
CASPRO   NTR1  BASE=*,LABEL=*                                                   
                                                                                
         LTR   R1,R1               XJOBOUT special call to get product          
         JNZ   CASPRO02                                                         
         MVC   X#ACT,SPACES                                                     
         L     RE,AIO2                                                          
         LLC   RF,PPROLEN                                                       
         BCTR  RF,0                                                             
         MVC   X#ACT(0),ACTKACT-ACTRECD(RE)                                     
         EX    RF,*-6                                                           
                                                                                
CR       USING ACTRECD,R1                                                       
         L     R1,AIO5             current product in IO area?                  
         LLC   RF,PPROLEN                                                       
         BCTR  RF,0                                                             
         LA    R4,X#ACT                                                         
         CLC   X#ACT(0),CR.ACTKACT                                              
         EX    RF,*-6                                                           
         JNE   CASPRO08                                                         
         L     R0,AIO2             copy AIO5 into AIO2                          
         LA    R1,IOLENQ                                                        
         L     RE,AIO5                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         L     R3,AIO2                                                          
         J     CASPRO12                                                         
         DROP  CR                                                               
                                                                                
CASPRO02 MVC   X#ACT,0(R1)                                                      
         LA    R4,X#ACT                                                         
                                                                                
         LLC   RE,PCLILEN                                                       
         LA    R1,X#ACT                                                         
         AR    R1,RE               point to product                             
         LLC   RF,PPROLEN                                                       
         SR    RF,RE                                                            
         BCTR  RF,0                length of it                                 
                                                                                
TSB      USING JSBD_D,CSVKEY3                                                   
         CLI   X#TSAYN,YESQ        TSAR required?                               
         JNE   CASPRO08                                                         
         XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         MVI   TSB.JSBDTYP,JSBDTPQ                                              
         MVC   TSB.JSBDCOD,SPACES                                               
         LLC   RE,PPROLEN                                                       
         BCTR  RE,0                                                             
         MVC   TSB.JSBDCOD(0),X#ACT                                             
         EX    RE,*-6                                                           
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         JE    CASPRO04                                                         
         TM    TSARERRS,TSERNF     Test record not found                        
         JNZ   CASPRO08                                                         
         DC    H'0'                Other error                                  
                                                                                
CASPRO04 LLC   RF,PCLILEN                                                       
         LA    RF,TSB.JSBDCOD(RF)                                               
         MVC   ELESDPRO,0(RF)                                                   
         MVC   ELESDPST,TSB.JSBDSTA                                             
         MVC   ELESDPOF,TSB.JSBDOFF                                             
         MVC   ELESDPRN,TSB.JSBDNAM                                             
         MVC   JD_PRN,SPACES                                                    
         MVC   JD_PRN,TSB.JSBDNAM                                               
         MVC   ELESDPXD,TSB.JSBDXDB                                             
         MVC   X#AOFF,ELESDPOF                                                  
         MVC   X#POFF,ELESDPOF                                                  
                                                                                
         TM    ELESDPST,ACTSLOCK                                                
         JZ    EXITY                                                            
         J     EXITN                                                            
                                                                                
CASPRO08 MVC   CSVKEY1,IOKEY                                                    
                                                                                
         USING ACTRECD,R3                                                       
         LA    R3,IOKEY            read for product account record              
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(2),PRODUL                                                
         LLC   R1,PPROLEN                                                       
         BCTR  R1,0                                                             
         MVC   ACTKACT(0),0(R4)                                                 
         EX    R1,*-6                                                           
         MVI   X#HIGH,YESQ                                                      
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JNE   *+2                                                              
                                                                                
*&&UK*&& CLI   ACTKSUFA,C' '                                                    
*&&US*&& CLI   ACTKSOFF,C' '                                                    
         JNH   CASPRO10                                                         
*&&UK*&& CLC   ACTKSUFA,X#HOFF                                                  
*&&US*&& CLC   ACTKSOFF,X#HOFF                                                  
         JNE   *+2                                                              
                                                                                
CASPRO10 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
                                                                                
         L     R0,AIO5             Copy SJ product to AIO5                      
         LA    R1,IOLENQ                                                        
         L     RE,AIO2                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         L     R3,AIO2                                                          
                                                                                
CASPRO12 GOTOR XJOBGOF                                                          
                                                                                
         CLC   X#AOFF,SPACES                                                    
         JNH   CASPRO14                                                         
         MVC   X#POFF,X#AOFF                                                    
                                                                                
TSB      USING JSBD_D,CSVKEY3                                                   
CASPRO14 XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         LHI   R1,JSBDLNQ                                                       
         STH   R1,TSB.JSBDLEN                                                   
         MVI   TSB.JSBDTYP,JSBDTPQ                                              
         LLC   RF,PPROLEN                                                       
         BCTR  RF,0                                                             
         MVC   TSB.JSBDCOD,SPACES                                               
         MVC   TSB.JSBDCOD(0),ACTKACT                                           
         EX    RF,*-6                                                           
         MVC   TSB.JSBDOFF,X#POFF                                               
         MVC   TSB.JSBDNAM,SPACES                                               
         CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    CASPRO16                                                         
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    CASPRO16                                                         
         CLI   RQ_JDLST,YESQ       include locked jobs?                         
         JE    CASPRO16                                                         
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    CASPRO16                                                         
         MVC   TSB.JSBDSTA,ACTRSTAT                                             
                                                                                
         USING NAMELD,R1                                                        
CASPRO16 LA    R1,ACTRFST                                                       
CASPRO18 CLI   NAMEL,NAMELQ                                                     
         JE    CASPRO20                                                         
         CLI   NAMEL,0                                                          
         JE    *+2                                                              
         LLC   R0,NAMLN                                                         
         AR    R1,R0                                                            
         J     CASPRO18                                                         
CASPRO20 LLC   RE,NAMLN                                                         
         SHI   RE,NAMLN1Q+1                                                     
         MVC   JD_PRN,SPACES                                                    
         MVC   JD_PRN(0),NAMEREC                                                
         EX    RE,*-6                                                           
         MVC   TSB.JSBDNAM(0),NAMEREC                                           
         EX    RE,*-6                                                           
         DROP  R1                                                               
                                                                                
         GOTOR SETXDB,DMCB,TSB.JSBDXDB,ACTRECD                                  
                                                                                
         CLI   X#TSAYN,YESQ        TSAR required?                               
         JNE   CASPRO22                                                         
                                                                                
         GOTOR GOTSAR,DMCB,('TSAADD',0)  add client to buffer                   
         JE    CASPRO22                                                         
         TM    TSARERRS,TSEEOF     buffer full - so it is ...                   
         JNZ   CASPRO22                                                         
         TM    TSARERRS,TSEDUP     (this may happen if AIO5 has this            
         JNZ   CASPRO22             product saved)                              
         DC    H'0'                duplicate key                                
                                                                                
CASPRO22 LLC   RF,PCLILEN          save current product details                 
         LA    RF,TSB.JSBDCOD(RF)                                               
         MVC   ELESDPRO,0(RF)                                                   
         MVC   ELESDPST,TSB.JSBDSTA                                             
         MVC   ELESDPOF,TSB.JSBDOFF                                             
         MVC   ELESDPRN,TSB.JSBDNAM                                             
         MVC   JD_PRN,SPACES                                                    
         MVC   JD_PRN,TSB.JSBDNAM                                               
         MVC   ELESDPXD,TSB.JSBDXDB                                             
         MVC   X#POFF,ELESDPOF                                                  
         DROP  TSB                                                              
                                                                                
         MVC   IOKEY,CSVKEY1                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JNE   *+2                                                              
                                                                                
         TM    ELESDPST,ACTSLOCK                                                
         JNZ   EXITN                                                            
         J     EXITY                                                            
                                                                                
         DROP  R3                                                               
         EJECT                                                                  
***********************************************************************         
* filter job on directory DRAPAS passive                              *         
***********************************************************************         
         USING DRAPASD,R2                                                       
XJOBDRA  NTR1  BASE=*,LABEL=*                                                   
                                                                                
         CLC   RQ_JDCLC,SPACES                                                  
         JNH   XJDRA06                                                          
                                                                                
         LLC   RE,PCLILEN                                                       
         CLC   RQ_JDPRO,SPACES                                                  
         JNH   XJDRA02                                                          
         LLC   RE,PPROLEN                                                       
                                                                                
XJDRA02  BCTR  RE,0                                                             
         EX    RE,XJDRA04                                                       
         JH    XJDRAH                                                           
         JL    XJDRAL                                                           
         J     XJDRA06                                                          
                                                                                
XJDRA04  CLC   DRAPACT(0),XL#SCPJ                                               
                                                                                
XJDRA06  OC    X#PIDSU,X#PIDSU                                                  
         JZ    XJDRA08                                                          
         CLC   DRAPPID,X#PIDSU                                                  
         JNE   XJDRAL                                                           
                                                                                
         CLC   X#COFF,SPACES                                                    
         JNH   XJDRA08                                                          
         CLC   DRAPSOFF,X#COFF                                                  
         JNE   XJDRAL                                                           
                                                                                
XJDRA08  LLC   RE,PPROLEN          media code filter                            
         LA    RE,DRAPACT(RE)                                                   
                                                                                
         CLI   X#MEDNO,1                                                        
         JL    XJDRA14                                                          
         JE    XJDRA12                                                          
                                                                                
         LA    RF,X#MEDLS          loop through list                            
         LLC   R0,X#MEDNO                                                       
XJDRA10  CLC   0(L'PMDKMED,RF),0(RE)                                            
         JE    XJDRA14                                                          
         AHI   RF,L'PMDKMED                                                     
         JCT   R0,XJDRA10                                                       
         J     XJDRAL                                                           
                                                                                
XJDRA12  CLC   X#MEDLS(L'PMDKMED),0(RE)                                         
         JNE   XJDRAL                                                           
                                                                                
XJDRA14  GOTOR FLTLIM,DRAPACT      filter on limit lists                        
         JNE   XJDRAL                                                           
                                                                                
         CLI   RQ_JDLST,YESQ       include locked?                              
         JE    XJDRA18                                                          
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    XJDRA16                                                          
                                                                                
         TM    DRAPSTAT,ACTSLOCK   job locked?                                  
         JNZ   XJDRAL                                                           
         J     XJDRA18                                                          
                                                                                
XJDRA16  TM    DRAPSTAT,ACTSLOCK   job locked?                                  
         JZ    XJDRAL                                                           
                                                                                
XJDRA18  CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    XJDRA20                                                          
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    XJDRA22                                                          
                                                                                
         TM    DRAPSTAT,ACTSCLOS   job closed yes                               
         JNZ   XJDRAL                                                           
         J     XJDRA22                                                          
                                                                                
XJDRA20  TM    DRAPSTAT,ACTSCLOS   job closed no                                
         JZ    XJDRAL                                                           
                                                                                
XJDRA22  LA    RE,RQ_JDF1V         filter on filters                            
         LA    RF,DRAPSTAT+ACTKSAF1-ACTKSTAT                                    
         LHI   R1,5                                                             
                                                                                
XJDRA24  CLI   0(RE),C' '                                                       
         JNH   XJDRA26                                                          
                                                                                
         CLC   0(1,RF),0(RE)                                                    
         JNE   XJDRAL                                                           
                                                                                
XJDRA26  AHI   RE,1                                                             
         AHI   RF,1                                                             
         JCT   R1,XJDRA24                                                       
                                                                                
XJDRA28  DS    0H                  no more checking here                        
                                                                                
XJDRAE   LA    RE,1                                                             
         J     XJDRAX                                                           
XJDRAL   LA    RE,0                                                             
         J     XJDRAX                                                           
XJDRAH   LA    RE,2                                                             
         J     XJDRAX                                                           
XJDRAX   DS    0H                                                               
         CHI   RE,1                                                             
         XIT1                                                                   
         DROP  R2                                                               
         EJECT                                                                  
                                                                                
***********************************************************************         
* filter job on directory passive                                     *         
***********************************************************************         
         USING SRCRECD,R2                                                       
XJOBPAS  NTR1  BASE=*,LABEL=*                                                   
                                                                                
         CLC   RQ_JDCLC,SPACES     skip if no client set                        
         JNH   XJOBP06                                                          
                                                                                
         LLC   RE,X#CLPL          then read for next product                    
         EX    RE,XJOBP02                                                       
         J     XJOBP04                                                          
                                                                                
XJOBP02  CLC   XL#SCPJ(0),SRCKACT                                               
                                                                                
XJOBP04  JNE   EXITN                                                            
                                                                                
XJOBP06  LA    R2,IOKEY                                                         
         GOTOR FLTLIM,SRCKACT      filter on limit lists                        
         JNE   EXITN                                                            
                                                                                
         LLC   RE,PPROLEN          filter on media code                         
         LR    RF,RE                                                            
         LA    RE,SRCKACT(RE)                                                   
                                                                                
         CLI   X#MEDNO,1                                                        
         JL    XJOBP12                                                          
         JE    XJOBP10                                                          
                                                                                
         LA    RF,X#MEDLS          loop through list                            
         LLC   R0,X#MEDNO                                                       
XJOBP08  CLC   0(L'PMDKMED,RF),0(RE)                                            
         JE    XJOBP12                                                          
         AHI   RF,L'PMDKMED                                                     
         JCT   R0,XJOBP08                                                       
         J     EXITN                                                            
                                                                                
XJOBP10  CLC   X#MEDLS(L'PMDKMED),0(RE)                                         
         JNE   EXITN                                                            
                                                                                
XJOBP12  DS    0H                                                               
         CLI   RQ_JDLST,YESQ       include locked?                              
         JE    XJOBP16                                                          
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    XJOBP14                                                          
                                                                                
         TM    SRCKSTAT,ACTSLOCK   job locked?                                  
         JNZ   EXITN                                                            
         J     XJOBP16                                                          
                                                                                
XJOBP14  TM    SRCKSTAT,ACTSLOCK   job locked?                                  
         JZ    EXITN                                                            
                                                                                
XJOBP16  CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    XJOBP18                                                          
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    XJOBP20                                                          
                                                                                
         TM    SRCKSTAT,ACTSCLOS   job closed yes                               
         JNZ   EXITN                                                            
         J     XJOBP20                                                          
                                                                                
XJOBP18  TM    SRCKSTAT,ACTSCLOS   job closed no                                
         JZ    EXITN                                                            
                                                                                
XJOBP20  MVC   X#COFF,SRCKSOFF     both                                         
         J     EXITY                                                            
                                                                                
         DROP  R2                                                               
                                                                                
***********************************************************************         
* filter job on directory PID passive                                 *         
***********************************************************************         
         USING PIDRECD,R2                                                       
XJOBPID  NTR1  BASE=*,LABEL=*                                                   
                                                                                
         CLC   RQ_JDCLC,SPACES                                                  
         JNH   XJPID04                                                          
                                                                                
         LLC   RE,PCLILEN                                                       
         CLC   RQ_JDPRO,SPACES                                                  
         JNH   XJPID02                                                          
         LLC   RE,PPROLEN                                                       
         CLC   RQ_JDJOB,SPACES                                                  
         JNH   XJPID02                                                          
         LLC   RE,PJOBLEN                                                       
         LA    RF,RQ_JDJOB+L'RQ_JDJOB-1                                         
         CLI   0(RF),C' '          Find end of job                              
         JH    XJPID02                                                          
         BCTR  RF,0                                                             
         JCT   RE,*-10                                                          
                                                                                
XJPID02  BCTR  RE,0                                                             
         EX    RE,XJPID28                                                       
         JH    XJPIDH                                                           
         JL    XJPIDL                                                           
                                                                                
XJPID04  LLC   RE,PPROLEN                                                       
         LA    RE,PIDKACC(RE)                                                   
                                                                                
         CLI   X#MEDNO,1                                                        
         JL    XJPID10                                                          
         JE    XJPID08                                                          
                                                                                
         LA    RF,X#MEDLS          loop through list                            
         LLC   R0,X#MEDNO                                                       
XJPID06  CLC   0(L'PMDKMED,RF),0(RE)                                            
         JE    XJPID10                                                          
         AHI   RF,L'PMDKMED                                                     
         JCT   R0,XJPID06                                                       
         J     XJPIDL                                                           
                                                                                
XJPID08  CLC   X#MEDLS(L'PMDKMED),0(RE)                                         
         JNE   XJPIDL                                                           
XJPID10  CLI   RQ_JDTYP,RQ_JDT7Q   User assigned list call                      
         JE    XJPID12             filtering done later                         
         GOTOR FLTLIM,PIDKACC      filter on limit lists                        
         JNE   XJPIDL                                                           
                                                                                
* Note: that the close/lock checks here differ from other JLSD places           
XJPID12  CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    XJPID14                                                          
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    XJPID16                                                          
         TM    PIDKSTAT,ACTSCLOS   job closed?                                  
         JNZ   XJPIDL                                                           
         J     XJPID16                                                          
                                                                                
XJPID14  TM    PIDKSTAT,ACTSCLOS   job closed?                                  
         JZ    XJPIDL                                                           
                                                                                
XJPID16  CLI   RQ_JDLST,YESQ       include locked jobs?                         
         JE    XJPID20                                                          
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    XJPID18                                                          
         TM    PIDKSTAT,ACTSLOCK   job locked?                                  
         JNZ   XJPIDL                                                           
         J     XJPID20                                                          
                                                                                
XJPID18  TM    PIDKSTAT,ACTSLOCK   job locked?                                  
         JZ    XJPIDL                                                           
                                                                                
XJPID20  LA    RE,RQ_JDF1V         filter on filters                            
         LA    RF,PIDKSTAT+ACTKSAF1-ACTKSTAT                                    
         LHI   R1,5                                                             
                                                                                
XJPID22  CLI   0(RE),C' '                                                       
         JNH   XJPID24                                                          
                                                                                
         CLC   0(1,RF),0(RE)                                                    
         JNE   XJPIDL                                                           
                                                                                
XJPID24  AHI   RE,1                                                             
         AHI   RF,1                                                             
         JCT   R1,XJPID22                                                       
                                                                                
XJPID26  DS    0H                                                               
         J     XJPIDE              no more checking here                        
                                                                                
XJPID28  CLC   PIDKACC(0),XL#SCPJ                                               
                                                                                
XJPIDE   LA    RE,1                                                             
         J     XJPIDX                                                           
XJPIDL   LA    RE,0                                                             
         J     XJPIDX                                                           
XJPIDH   LA    RE,2                                                             
         J     XJPIDX                                                           
XJPIDX   CHI   RE,1                                                             
         XIT1                                                                   
         DROP  R2                                                               
         EJECT                                                                  
                                                                                
***********************************************************************         
* Filter on current JDT passive                                       *         
***********************************************************************         
         USING JDTPASD,R2                                                       
XCHKJDT  NTR1  BASE=*,LABEL=*                                                   
                                                                                
         LA    R2,IOKEY                                                         
                                                                                
         CLC   JDTPDATE,X#PASSTA                                                
         JNL   XCHKJ04                                                          
         MVC   JDTPDATE,X#PASSTA                                                
         XC    JDTPOFFC,JDTPOFFC                                                
         MVI   X#HIGH,YESQ                                                      
         J     XCHKJDTL            read high for next set                       
                                                                                
XCHKJ04  CLC   JDTPDATE,X#PASEND                                                
         JH    XCHKJDTH            all done                                     
                                                                                
         USING OFFALD,R1                                                        
         L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,JDTPOFFC   validate 'job office'                        
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL                                                           
         JNE   XCHKJ06                                                          
         DROP  R1                                                               
                                                                                
         CLC   RQ_JDOFF,SPACES     apply office filter if passed                
         JNH   XCHKJ08                                                          
         CLC   RQ_JDOFF,JDTPOFFC                                                
         JE    XCHKJ08                                                          
                                                                                
XCHKJ06  MVI   JDTPJACT,FF         next office                                  
         MVI   X#HIGH,YESQ                                                      
         J     XCHKJDTL            read high for next set                       
                                                                                
XCHKJ08  GOTOR CASCLI,JDTPJACT     Check and set client                         
         JNE   EXITN                                                            
*        JE    XCHKJ10                                                          
*        LLC   RE,PCLILEN                                                       
*        LA    RE,JDTPJACT(RE)                                                  
*        MVI   0(RE),FF            skip this client                             
*        MVI   X#HIGH,YESQ                                                      
*        J     XCHKJDTL            read high for next set                       
                                                                                
XCHKJ10  GOTOR CASPRO,JDTPJACT     Check and set product                        
         JNE   EXITN                                                            
*        JE    XCHKJ12                                                          
*        LLC   RE,PPROLEN                                                       
*        LA    RE,JDTPJACT(RE)                                                  
*        MVI   0(RE),FF            skip this product                            
*        MVI   X#HIGH,YESQ                                                      
*        J     XCHKJDTL            read high for next set                       
                                                                                
XCHKJ12  LLC   RE,PPROLEN          filter on media code                         
         LR    RF,RE                                                            
         LA    RE,JDTPJACT(RE)                                                  
                                                                                
         CLI   X#MEDNO,1                                                        
         JL    XCHKJ18                                                          
         JE    XCHKJ16                                                          
                                                                                
         LA    RF,X#MEDLS          loop through list                            
         LLC   R0,X#MEDNO                                                       
XCHKJ14  CLC   0(L'PMDKMED,RF),0(RE)                                            
         JE    XJOBP12                                                          
         AHI   RF,L'PMDKMED                                                     
         JCT   R0,XCHKJ14                                                       
         J     EXITN                                                            
                                                                                
XCHKJ16  CLC   X#MEDLS(L'PMDKMED),0(RE)                                         
         JE    XCHKJ18                                                          
         MVI   0(RE),FF            set to next product                          
         MVI   X#HIGH,YESQ                                                      
         J     XCHKJDTL            read high for next set                       
                                                                                
XCHKJ18  MVC   X#POFF,JDTPOFFC                                                  
         GOTOR FLTLIM,JDTPJACT     filter on limit lists                        
         JE    XCHKJ20                                                          
         MVI   X#HIGH,NOQ                                                       
         J     XCHKJDTL            read for next job                            
                                                                                
XCHKJ20  DS    0H                                                               
         CLI   RQ_JDLST,YESQ       include locked?                              
         JE    XCHKJ24                                                          
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    XCHKJ22                                                          
                                                                                
         TM    JDTPSTA,ACTSLOCK    job locked?                                  
         JNZ   XCHKJ28                                                          
         J     XCHKJ24                                                          
                                                                                
XCHKJ22  TM    JDTPSTA,ACTSLOCK    job locked?                                  
         JZ    XCHKJ28                                                          
                                                                                
XCHKJ24  CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    XCHKJ26                                                          
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    XCHKJ30                                                          
                                                                                
         TM    JDTPSTA,ACTSCLOS    job closed yes                               
         JNZ   XCHKJ28                                                          
         J     XCHKJ30                                                          
                                                                                
XCHKJ26  TM    JDTPSTA,ACTSCLOS    job closed no                                
         JNZ   XCHKJ30                                                          
                                                                                
XCHKJ28  MVI   X#HIGH,NOQ                                                       
         J     XCHKJDTL            read for next job                            
                                                                                
XCHKJ30  MVC   X#COFF,JDTPOFFC     both                                         
                                                                                
XCHKJDTE LHI   R1,1                OK                                           
         J     XCHKJDTX                                                         
XCHKJDTL LHI   R1,0                next                                         
         J     XCHKJDTX                                                         
XCHKJDTH LHI   R1,2                end                                          
XCHKJDTX DS    0H                                                               
         CHI   R1,1                                                             
         XIT1                                                                   
         DROP  R2                                                               
                                                                                
***********************************************************************         
* Check SJ code (at R1) against approval list of user                 *         
* Note: no distinction between SJ defaults or regular approver list   *         
*       entries, also no GAPLST like checking - only matching this    *         
*       list here                                                     *         
***********************************************************************         
CHKJAL   NTR1  BASE=*,LABEL=*                                                   
                                                                                
         XC    X#JAPP,X#JAPP       Init Approver Pid                            
         MVC   CSVKEY2,IOKEY                                                    
         USING DRAPASD,R2                                                       
         LA    R2,CSVKEY2                                                       
         LLC   R1,PPROLEN                                                       
         LA    RF,DRAPACT(R1)                                                   
         MVC   X#MEDC,0(RF)                                                     
         OI    X#GAPIND,X#GAPIDQ                                                
         GOTOR GETAPP,DMCB,(2,DRAPACT),DRAPSOFF                                 
         JNE   CHKJALN                                                          
         OI    X#GAPIND,X#GAPIYQ                                                
                                                                                
         MVC   IOKEY,CSVKEY2                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
                                                                                
CHKJALY  CR    RB,RB                                                            
         XIT1                                                                   
CHKJALN  MVC   IOKEY,CSVKEY2                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         LTR   RB,RB                                                            
         XIT1                                                                   
         DROP  R2                                                               
                                                                                
***********************************************************************         
* Initialise line manager optimisation buffer (uses WSSVR buffer)     *         
***********************************************************************         
INILMB   NTR1  LABEL=*                                                          
                                                                                
         XC    TSAROBUF(TSPNEWL),TSAROBUF                                       
T        USING TSARD,TSAROBUF                                                   
         MVI   T.TSACTN,TSAINI     Set action to 'Initialise'                   
         MVI   T.TSRECI,TSRXTN+TSRMINB1                                         
         MVI   T.TSKEYL,L'OB_KEY                                                
         LHI   R0,ONEK                                                          
         OC    T.TSBUFFL,T.TSBUFFL                                              
         JNZ   *+8                                                              
         STCM  R0,3,T.TSBUFFL                                                   
         LHI   R0,OB_LNQ                                                        
         STCM  R0,3,T.TSRECL                                                    
         MVC   T.TSACOM,ACOMFACS                                                
         GOTOR VTSAR,T.TSARD                                                    
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  T                                                                
         EJECT                                                                  
***********************************************************************         
* Add a record to optimisation buffer                                 *         
*                                                                     *         
* Ntry:- R1 points to caller's OB_D                                   *         
***********************************************************************         
         SPACE 1                                                                
ADDBUF   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDBUF*'                                                      
                                                                                
T        USING TSARD,TSAROBUF                                                   
         MVI   T.TSACTN,TSAADD     Set action to 'Add'                          
         ST    R1,T.TSAREC                                                      
         GOTOR VTSAR,T.TSARD                                                    
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  T                                                                
         EJECT                                                                  
                                                                                
***********************************************************************         
* Get a record from optimisation buffer                               *         
*                                                                     *         
* Ntry:- R1 points to caller's OB_D                                   *         
* Exit:- CC=Low if record not found in buffer                         *         
*        CC=Equal if record found and is not posted with an error     *         
*           - record is returned in caller's OB_D                     *         
*        CC=High if record found and is posted with an error (set in  *         
*           ROUERRV)                                                  *         
***********************************************************************         
GETBUF   NTR1  LABEL=*,WORK=(RC,OB_LNQ)                                         
                                                                                
W        USING OB_D,RC                                                          
         LR    R2,R1                                                            
P        USING OB_D,R2             R2=A(caller's OB_D)                          
         MVC   W.OB_KEY,P.OB_KEY                                                
                                                                                
T        USING TSARD,TSAROBUF                                                   
         MVI   T.TSACTN,TSARDH     Set action to 'Read High'                    
         LA    R0,W.OB_D                                                        
         ST    R0,T.TSAREC         Read into acquired storage                   
         GOTOR VTSAR,T.TSARD                                                    
         JNE   EXITL               Not found/EOF                                
         DROP  T                                                                
                                                                                
         MVC   P.OB_D(OB_LNQ),W.OB_D                                            
                                                                                
         MVC   ROUERRV,P.OB_ERROR  Set/test record in error                     
         OC    ROUERRV,ROUERRV                                                  
         JNZ   EXITH                                                            
         J     EXITY                                                            
         DROP  W,P                                                              
         EJECT                                                                  
***********************************************************************         
* Extract default workcode                                            *         
*                                                                     *         
***********************************************************************         
         SPACE 1                                                                
         USING ACTRECD,R2                                                       
GETWCD   NTR1  LABEL=*                                                          
*                                                                               
         LA    R3,ONERL4L         Read through 1R levels to get                 
         MVC   X#DFWC,SPACES      default workcode                              
*                                                                               
GETWCD02 LA    RF,ONERL1L                                                       
         CR    R3,RF                                                            
         JL    EXITY                                                            
*                                                                               
         LA    R2,IOKEY                                                         
         MVC   IOKEY,SPACES       Read 1r account                               
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(L'ACTKUNT+L'ACTKLDG),LED1R                               
         LLC   RF,0(R3)                                                         
         BCTR  RF,0                                                             
         BASR  R1,0                                                             
         MVC   ACTKACT(0),X#1RACC                                               
         EX    RF,0(R1)                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO2                                                          
         LA    R2,ACTRFST                                                       
*                                                                               
         USING RSTELD,R2                                                        
GETWCD04 CLI   RSTEL,0                                                          
         JE    GETWCD08                                                         
         CLI   RSTEL,RSTELQ                                                     
         JE    GETWCD06                                                         
         LLC   R0,RSTLN                                                         
         AR    R2,R0                                                            
         J     GETWCD04                                                         
*                                                                               
GETWCD06 CLI   RSTLN,RSTLN2Q                                                    
         JNH   *+10                                                             
         MVC   X#DFWC,RSTDFTSK         Extract default workcode                 
*                                                                               
GETWCD08 CLC   X#DFWC,SPACES           Found default workcode?                  
         JH    EXITY                                                            
         JCT   R3,GETWCD02                                                      
         DC    H'0'                                                             
         EJECT                                                                  
***********************************************************************         
* LIST OF ACCOUNT FILES TO OPEN IN ALL SYSTEMS                        *         
***********************************************************************         
                                                                                
FILES    DS    0X                  ** FILE INFO **                              
         DC    C'ACCOUNT'          SYSTEM NAME FOR OPEN                         
                                                                                
         DC    C'nCTFILE '         FILE LIST                                    
         DC    C'UACCDIR '                                                      
         DC    C'UACCMST '                                                      
         DC    C'UACCARC '                                                      
         DC    C'X'                                                             
         EJECT                                                                  
***********************************************************************         
* GLOBAL LITERALS                                                     *         
***********************************************************************         
                                                                                
GLOBALS  DS    0D                  ** GLOBAL LITERALS **                        
                                                                                
***********************************************************************         
* Literal Pool                                                        *         
***********************************************************************         
         LTORG ,                                                                
                                                                                
WORKLEN  DC    AL2(((WORKL+7)/8)*8)                                             
*                                                                               
APPLTAB  DS    0XL1                                                             
         DC    AL1(QWCTIM,LIDLTIME)                                             
APPLTABL EQU   *-APPLTAB                                                        
         DC    AL1(QWCORD,LIDLORDS)                                             
         DC    AL1(QWCEST,LIDLESTM)                                             
         DC    AL1(QWCEJL,LIDLESTM)                                             
         DC    AL1(QWCEXP,LIDLEXPN)                                             
         DC    AL1(QWCJOB,LIDLJOBS)                                             
         DC    AL1(QWCREP,LIDLREPT)                                             
         DC    AL1(QWCINV,LIDLINVC)                                             
         DC    AL1(QWCRES,LIDLRESC)                                             
         DC    AL1(QWCDAS,LIDLJOBS)                                             
         DC    AL1(QWCWID,LIDLTIME)                                             
         DC    X'FF'                                                            
*                                                                               
GOTMKTAB DS    0H                                                               
         DC    AL1(GOINPR,YESQ,X'FF',0)                                         
         DC    AL1(GOSUB,NOQ,X'FF'-TIMSDELT-TIMSREJE,0)                         
         DC    AL1(GOPAP,NOQ,TIMSPAPP,0)                                        
         DC    AL1(GOCLIPAP,NOQ,TIMSPAPP,TIMSAWAP)                              
         DC    AL1(GOMANPAP,NOQ,TIMSMAAP,TIMSAWAP)                              
         DC    AL1(GOAPPR,NOQ,TIMSFAPP,0)                                       
         DC    X'FF'                                                            
*                                                                               
         DS    0H                                                               
APRTAB   DS    0XL1                                                             
         DC    B'11011000'         Office/client/product/media                  
         DC    C'1'                                                             
         DC    B'10011000'         Office/client/media                          
         DC    C'2'                                                             
         DC    B'10010000'         Client/media                                 
         DC    C'4'                                                             
         DC    B'00011000'         Office/media                                 
         DC    C'3'                                                             
         DC    B'00010000'         Media                                        
         DC    C'M'                                                             
         DC    B'11001000'         Office/client/product                        
         DC    C'P'                                                             
         DC    B'10001000'         Office/client                                
         DC    C'C'                                                             
         DC    B'10000000'         Client                                       
         DC    C'C'                                                             
         DC    B'00001000'         Office                                       
         DC    C'O'                                                             
         DC    B'00000000'         Agency                                       
         DC    C'A'                                                             
         DC    X'FF'                                                            
*                                                                               
DMKEY    DC    CL8'DMKEY'                                                       
ACCDIR   DC    CL8'ACCDIR'                                                      
ACCMST   DC    CL8'ACCMST'                                                      
ACCARC   DC    CL8'ACCARC'                                                      
SGQ      DC    CL2'SG'                                                          
SIQ      DC    CL2'SI'                                                          
SKQ      DC    CL2'SK'                                                          
SJQ      DC    CL2'SJ'                                                          
PZERO    DC    P'0'                                                             
                                                                                
SYSLFQA  EQU   X'73'                   SYSTEM 73                                
EMPTY    EQU   C' '                                                             
DOLLAR   EQU   C'$'                                                             
QCHAR    EQU   C'?'                                                             
                                                                                
XFFS     DC    4X'FF'                                                           
*                                                                               
REQTAB   DS    0XL14                                                            
         DC    AL1(REQTACTQ),AL4(ACTKEYT),AL4(ACTKF),AL4(ACTRF),CL1' '          
REQTABLQ EQU   *-REQTAB                                                         
         DC    AL1(REQTDRAQ),AL4(DRAPKEY),AL4(DRAKF),AL4(DRARF),CL1' '          
         DC    AL1(REQTJDTQ),AL4(JDTKEYT),AL4(JDTKF),AL4(JDTRF),CL1' '          
         DC    AL1(REQTPIDQ),AL4(PIDKEYT),AL4(PIDKF),AL4(PIDRF),CL1' '          
         DC    AL1(REQTSRCQ),AL4(SRCRKEY),AL4(SRCKF),AL4(SRCRF),CL1' '          
REQTABN  EQU   (*-REQTAB)/REQTABLQ                                              
*                                                                               
NWCTAB   DS    0XL14                                                            
         DC    AL1(REQT1Q),AL4(PIDKEY1),AL4(APDKF),AL4(APDRF),CL1'A'            
NWCTABLQ EQU   *-NWCTAB                                                         
         DC    AL1(REQT2Q),AL4(DRAPKEY1),AL4(RELKF),AL4(RELRF),CL1' '           
         DC    AL1(REQT3Q),AL4(DRAPKEY1),AL4(NADKF),AL4(NADRF),CL1' '           
         DC    AL1(REQT4Q),AL4(DRAPKEY2),AL4(UDDKF),AL4(UDDRF),CL1' '           
         DC    AL1(REQT5Q),AL4(DRAPKEY2),AL4(UDDKF),AL4(UDDRF),CL1' '           
         DC    AL1(REQT6Q),AL4(PIDKEY1),AL4(APDKF),AL4(APDRF),CL1'S'            
         DC    AL1(REQT7Q),AL4(PIDKEY1),AL4(APDKF),AL4(APDRF),CL1'T'            
NWCTABN  EQU   (*-NWCTAB)/NWCTABLQ                                              
*                                                                               
USRTAB   DS   0D                                                                
         DC    CL3'100'                                                         
         DC    CL3'110'                                                         
         DC    CL3'101'                                                         
         DC    CL3'200'                                                         
         DC    CL3'210'                                                         
         DC    CL3'201'                                                         
         DC    CL3'300'                                                         
         DC    CL3'310'                                                         
         DC    CL3'301'                                                         
         DC    CL3'400'                                                         
         DC    CL3'410'                                                         
         DC    CL3'401'                                                         
         DC    CL3'500'                                                         
         DC    CL3'510'                                                         
         DC    CL3'501'                                                         
         DC    CL3'600'                                                         
         DC    CL3'610'                                                         
         DC    CL3'601'                                                         
*                                                                               
MAXUFS   EQU  10                                                                
MAXLUF   EQU  (L'GENAREA)/ELMLNG                                                
*                                                                               
         DS    0D                                                               
*&&US                                                                           
JOBFLDS  DC    AL2(AC#CE,AC#CEH,0,0,0,0)                                        
*&&                                                                             
*&&UK                                                                           
JOBFLDS  DC    AL2(AC#CE,AC#CEC,AC#CEB,AC#CECB,AC#RSCEH,0)                      
*&&                                                                             
LOOKFLDH DC    AL1(8+L'LOOKFLD),4X'00',AL1(L'LOOKFLD),AL2(0)                    
LOOKFLD  DC    CL9'OE,CE,CEH'                                                   
                                                                                
LVALUE   DS    0F                  ** LITERALS MOVED TO SAVED **                
         DC    A(WCOLRF)                                                        
         DC    A(ACTKF)                                                         
         DC    A(ACTRF)                                                         
         DC    A(DRAKF)                                                         
         DC    A(DRARF)                                                         
         DC    A(SRCKF)                                                         
         DC    A(SRCRF)                                                         
         DC    A(PIDKF)                                                         
         DC    A(PIDRF)                                                         
         DC    A(JDTKF)                                                         
         DC    A(JDTRF)                                                         
         DC    A(APDKF)                                                         
         DC    A(APDRF)                                                         
         DC    A(UDDKF)                                                         
         DC    A(UDDRF)                                                         
         DC    A(NADKF)                                                         
         DC    A(NADRF)                                                         
         DC    A(RELKF)                                                         
         DC    A(RELRF)                                                         
                                                                                
EXPTYTAB DS    0X                                                               
         DC    AL1(EXJPCLI1)                                                    
         DC    AL1(EXJPCBL1)                                                    
         DC    AL1(EXJPCNB1)                                                    
         DC    X'FF'                                                            
                                                                                
LED1N    DC    C'1N'                                                            
LED1R    DC    C'1R'                                                            
LSTNAR   DC    C'999999'                                                        
FFS      DC    32X'FF'                                                          
NONOS    DC    C'NNNNNN'                                                        
YEYES    DC    C'YYYYYY'                                                        
MANYNOS  DC    32C'N'                                                           
         EJECT                                                                  
***********************************************************************         
* KEY DRIVER TABLES                                                   *         
***********************************************************************         
AUDKEYT  LKKEY H,AUDKEY,SAVED      ** AUDIT # ALLOC KEY DRIVER **               
         LKKEY LIT,AUDKTYP,AUDKTYPQ                                             
         LKKEY LIT,AUDKSUB,AUDKSUBQ                                             
         LKKEY SIN,AUDKCPY,QAGENCY                                              
         LKKEY LIT,AUDKAUDT,AUDKACC          *X'04'                             
         LKKEY SIN,AUDKUNT,QPRODUL                                              
         LKKEY SIN,AUDKLDG,QPRODUL+L'AUDKUNT                                    
         LKKEY SIN,AUDKACTC,RQ_JAACT                                            
         LKKEY E                                                                
                                                                                
ACTKEYT2 LKKEY H,ACTKEY,SAVED      ** ACCOUNT ALLOC KEY DRIVER **               
         LKKEY SIN,ACTKCPY,QAGENCY                                              
         LKKEY SIN,ACTKUNT,QPRODUL                                              
         LKKEY SIN,ACTKLDG,QPRODUL+L'AUDKUNT                                    
         LKKEY SIN,ACTKACT,RQ_JAACT                                             
         LKKEY E                                                                
WCOKEYT  LKKEY H,WCOKEY,SAVED        ** WORK CODE DRIVER **                     
         LKKEY LIT,WCOKTYP,WCOKTYPQ                                             
         LKKEY SIN,WCOKCPY,QAGENCY                                              
         LKKEY LIT,WCOKUNT,OUNIT                                                
         LKKEY LIT,WCOKLDG,OLEDGER                                              
         LKKEY RNG,WCOKWRK,QWCSTRT                                              
         LKKEY NZR,WCOKREM                                                      
         LKKEY E                                                                
                                                                                
WCOKEYT2 LKKEY H,WCOKEY,SAVED        ** WORK CODE DRIVER 2**                    
         LKKEY LIT,WCOKTYP,WCOKTYPQ                                             
         LKKEY SIN,WCOKCPY,QAGENCY                                              
         LKKEY LIT,WCOKUNT,OUNIT                                                
         LKKEY LIT,WCOKLDG,OLEDGER                                              
         LKKEY WMP,WCOKWRK,AWMPOST                                              
         LKKEY NZR,WCOKREM                                                      
         LKKEY E                                                                
ACTKEYT  LKKEY H,ACTKEY,SAVED                                                   
         LKKEY SIN,ACTKCPY,QAGENCY                                              
         LKKEY SIN,ACTKUNT,QPRODUL                                              
         LKKEY SIN,ACTKLDG,QPRODUL+1                                            
         LKKEY NZR,ACTKACT                                                      
         LKKEY LIT,ACTREST,X'40'                                                
         LKKEY E                                                                
*                                                                               
ACTKEYC  LKKEY H,ACTKEY,SAVED                                                   
         LKKEY SIN,ACTKCPY,QAGENCY                                              
         LKKEY SIN,ACTKUNT,QPRODUL                                              
         LKKEY SIN,ACTKLDG,QPRODUL+1                                            
         LKKEY RNG,ACTKCLI,RQ_JDCLC                                             
         LKKEY NZR,ACTKREM                                                      
         LKKEY LIT,ACTREST,X'40'                                                
         LKKEY E                                                                
*                                                                               
DRAPKEY  LKKEY H,DRAPAS,SAVED                                                   
         LKKEY LIT,DRAPTYP,DRAPTYPQ                                             
         LKKEY LIT,DRAPSUB,DRAPSUBQ                                             
         LKKEY SIN,DRAPCPY,QAGENCY                                              
         LKKEY LIT,DRAPREM,0                                                    
         LKKEY LIT,DRAPAPS,DRAPDRA                                              
         LKKEY SIN,DRAPUAL,QPRODUL                                              
         LKKEY ALL,DRAPACT                                                      
         LKKEY ALL,DRAPPID                                                      
         LKKEY E                                                                
*                                                                               
DRAPKEY1 LKKEY H,DRAPAS,SAVED                                                   
         LKKEY LIT,DRAPTYP,DRAPTYPQ                                             
         LKKEY LIT,DRAPSUB,DRAPSUBQ                                             
         LKKEY SIN,DRAPCPY,QAGENCY                                              
         LKKEY LIT,DRAPREM,0                                                    
         LKKEY LIT,DRAPAPS,DRAPDRA                                              
         LKKEY SIN,DRAPUAL,QPRODUL                                              
         LKKEY ALL,DRAPACT                                                      
         LKKEY ALL,DRAPPID                                                      
         LKKEY E                                                                
*                                                                               
DRAPKEY2 LKKEY H,DRAPAS,SAVED                                                   
         LKKEY LIT,DRAPTYP,DRAPTYPQ                                             
         LKKEY LIT,DRAPSUB,DRAPSUBQ                                             
         LKKEY SIN,DRAPCPY,QAGENCY                                              
         LKKEY LIT,DRAPREM,0                                                    
         LKKEY LIT,DRAPAPS,DRAPDRA                                              
         LKKEY SIN,DRAPUAL,QPRODUL                                              
         LKKEY ALL,DRAPACT                                                      
         LKKEY SIN,DRAPPID,QCCTPID                                              
         LKKEY E                                                                
*                                                                               
DPAPKEY  LKKEY H,DPAPAS,SAVED                                                   
         LKKEY LIT,DPAPTYP,DPAPTYPQ                                             
         LKKEY LIT,DPAPSUB,DPAPSUBQ                                             
         LKKEY SIN,DPAPCPY,QAGENCY                                              
         LKKEY LIT,DPAPREM,0                                                    
         LKKEY LIT,DPAPAPPL,DPAPATIM                                            
         LKKEY LIT,DPAPXVAL,0                                                   
         LKKEY ALL,DPAP1RAC                                                     
         LKKEY ALL,DPAPPIDB                                                     
         LKKEY ALL,DPAPSEQ                                                      
         LKKEY E                                                                
*                                                                               
SRCRKEY  LKKEY H,SRCKEY,SAVED                                                   
         LKKEY LIT,SRCKTYP,SRCKTYPQ                                             
         LKKEY SIN,SRCKCPY,QAGENCY                                              
         LKKEY SIN,SRCKUL,QPRODUL                                               
         LKKEY LIT,SRCKSUB,SRCKWDSQ                                             
         LKKEY LIT,SRCKREST,0                                                   
         LKKEY WMP,SRCKWRD1,RQ_JDNAD                                            
         LKKEY ALL,SRCKSEQ1                                                     
         LKKEY ALL,SRCKACT                                                      
         LKKEY E                                                                
*                                                                               
PIDKEYT  LKKEY H,PIDKEY,SAVED                                                   
         LKKEY LIT,PIDKTYP,PIDKTYPQ                                             
         LKKEY LIT,PIDKSUB,PIDKSUBQ                                             
         LKKEY SIN,PIDKCPY,QAGENCY                                              
         LKKEY LIT,PIDKREM,0                                                    
         LKKEY SIN,PIDKPID,X#PID                                                
         LKKEY LIT,PIDKSTYP,PIDKJOBQ                                            
         LKKEY SIN,PIDKJST,X#PAST                                               
         LKKEY ALL,PIDKACC                                                      
         LKKEY ALL,PIDKADAT                                                     
         LKKEY E                                                                
*                                                                               
PIDKEY1  LKKEY H,PIDKEY,SAVED                                                   
         LKKEY LIT,PIDKTYP,PIDKTYPQ                                             
         LKKEY LIT,PIDKSUB,PIDKSUBQ                                             
         LKKEY SIN,PIDKCPY,QAGENCY                                              
         LKKEY LIT,PIDKREM,0                                                    
         LKKEY SIN,PIDKPID,QCCTPID                                              
         LKKEY LIT,PIDKSTYP,PIDKJOBQ                                            
         LKKEY SIN,PIDKJST,X#PAST                                               
         LKKEY ALL,PIDKACC                                                      
         LKKEY ALL,PIDKADAT                                                     
         LKKEY E                                                                
*                                                                               
JDTKEYT  LKKEY H,JDTPAS,SAVED                                                   
         LKKEY LIT,JDTPTYP,JDTPTYPQ                                             
         LKKEY LIT,JDTPSUB,JDTPSUBQ                                             
         LKKEY SIN,JDTPCPY,QAGENCY                                              
         LKKEY LIT,JDTPREM,0                                                    
         LKKEY SIN,JDTPDTYP,TMPJDTP                                             
         LKKEY RNG,JDTPDATE,X#PASSTA                                            
         LKKEY NZR,JDTPOFFC                                                     
         LKKEY ALL,JDTPJACT                                                     
         LKKEY E                                                                
         EJECT                                                                  
*                                                                               
         DS    0H                                                               
       ++INCLUDE FACTRYXLAT                                                     
         DS    0H                                                               
TRTSPEC  DC    256AL1(0)           TRANSLATED VALUE IS X'00', EXCEPT            
*                                                                               
         ORG   TRTSPEC+C'A'        UPPER CASE LETTERS                           
         DC    C'ABCDEFGHI'                                                     
         ORG   TRTSPEC+C'J'                                                     
         DC    C'JKLMNOPQR'                                                     
         ORG   TRTSPEC+C'S'                                                     
         DC    C'STUVWXYZ'                                                      
*                                                                               
         ORG   TRTSPEC+C'0'        UPPER CASE NUMBERS                           
         DC    C'0123456789'                                                    
*                                                                               
         ORG   TRTSPEC+C' '        SPACES STAY SAME                             
         DC    X'40'                                                            
*                                                                               
         ORG   TRTSPEC+C'*'        '*' STAYS SAME, IN CASE PARTIAL FLAG         
         DC    C'*'                                                             
*                                                                               
         ORG   TRTSPEC+C'.'        THESE SPECIAL CHARS BECOME SPACES            
         DC    X'40'               AND ARE TREATED AS WORD SEPARATORS           
         ORG   TRTSPEC+C'<'        ALL OTHERS BECOME NULLS AND ARE              
         DC    X'40'               IGNORED AS IF COMPRESSED OUT.                
         ORG   TRTSPEC+C'('                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C'+'                                                     
         DC    C'+'                                                             
         ORG   TRTSPEC+C'&&'                                                    
         DC    X'40'                                                            
         ORG   TRTSPEC+C')'                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C';'                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C'-'                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C'/'                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C','                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C'_'                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C'>'                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C':'                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C'='                                                     
         DC    X'40'                                                            
*                                                                               
         ORG   ,                                                                
*                                                                               
TRTSGER  DC    256AL1(0)           TRANSLATED VALUE IS X'00', EXCEPT            
*                                                                               
         ORG   TRTSGER+C'A'        UPPER CASE LETTERS                           
         DC    C'ABCDEFGHI'                                                     
         ORG   TRTSGER+C'J'                                                     
         DC    C'JKLMNOPQR'                                                     
         ORG   TRTSGER+C'S'                                                     
         DC    C'STUVWXYZ'                                                      
*                                                                               
         ORG   TRTSGER+X'4A'       4A=U/C A UMLAUT                              
         DC    X'4A'                                                            
         ORG   TRTSGER+X'5A'       5A=U/C U UMLAUT (! IN ENGLISH)               
         DC    X'5A'                                                            
         ORG   TRTSGER+X'A1'       A1=SS                                        
         DC    X'A1'                                                            
         ORG   TRTSGER+X'E0'       E0=U/C O UMLAUT                              
         DC    X'E0'                                                            
*                                                                               
         ORG   TRTSGER+C'0'        UPPER CASE NUMBERS                           
         DC    C'0123456789'                                                    
*                                                                               
         ORG   TRTSGER+C' '        SPACES STAY SAME                             
         DC    X'40'                                                            
*                                                                               
         ORG   TRTSGER+C'*'        '*' STAYS SAME, IN CASE PARTIAL FLAG         
         DC    C'*'                                                             
*                                                                               
         ORG   TRTSGER+C'.'        THESE SPECIAL CHARS BECOME SPACES            
         DC    X'40'               AND ARE TREATED AS WORD SEPARATORS           
         ORG   TRTSGER+C'<'        ALL OTHERS BECOME NULLS AND ARE              
         DC    X'40'               IGNORED AS IF COMPRESSED OUT.                
         ORG   TRTSGER+C'('                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C'+'                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C'&&'                                                    
         DC    X'40'                                                            
         ORG   TRTSGER+C')'                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C';'                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C'-'                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C'/'                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C','                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C'_'                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C'>'                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C':'                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C'='                                                     
         DC    X'40'                                                            
*                                                                               
         ORG   ,                                                                
***********************************************************************         
* OTHER LITERALS AND DECLARATIONS                                     *         
***********************************************************************         
APPLLIT  DC    C'Application'                                                   
ESTDTLTT DC    C'Estimate Date'                                                 
WCGRPLIT DC    C'W/C Group'                                                     
FRNRQLIT DC    C'Foreign Required?'                                             
SKPVLIT  DC    C'Skip Validation'                                               
SJACLIT  DC    C'SJ Account'                                                    
TSTOLIT  DC    C'Test Only'                                                     
OTYPLIT  DC    C'Order type filter'                                             
OPESTLIT DC    C'Open for estimates'                                            
OPORDLIT DC    C'Open for orders'                                               
OPEXTLIT DC    C'Open for external postings'                                    
OPBILLIT DC    C'Open for billing'                                              
OPADJLIT DC    C'Open for adjustments'                                          
OPTIMLIT DC    C'Open for timesheets'                                           
JBPAYLIT DC    C'Show Payments totals'                                          
       ++INCLUDE ACURLTAB                                                       
*                                                                               
         EJECT                                                                  
*                                                                               
***********************************************************************         
         SPACE 1                                                                
*                                                                               
B#WCREC  EQU   3                   IO2                                          
B#AUD    EQU   3                   IO2                                          
B#UFDL   EQU   3                   IO2                                          
B#DPAPAS EQU   3                   IO2                                          
B#ACTREC EQU   3                   IO2                                          
B#ARTREC EQU   3                   IO2                                          
B#LLSREC EQU   3                   IO2                                          
B#GOBLK  EQU   4                   IO3                                          
B#APPTAB EQU   5                   IO4                                          
B#GOXBLK EQU   5                   IO4                                          
B#GOBBLK EQU   6                   IO5                                          
B#CEITAB EQU   7                   IO6                                          
B#SPITAB EQU   7                   IO6                                          
B#COBLCK EQU   9                   COBLOCK                                      
B#SVRDEF EQU   10                  ACBRA2D                                      
ASERVER  EQU   LP_BLKS+((B#SVRDEF-1)*L'LP_BLKS)                                 
B#LP_D   EQU   11                  LP_D                                         
                                                                                
PFNL     EQU   16                                                               
MAXL     EQU   02                                                               
PLNL     EQU   58                                                               
STAL     EQU   01                                                               
CPCL     EQU   08                                                               
CEML     EQU   44                                                               
EOR      EQU   0                                                                
EFF      EQU   X'FF'                                                            
                                                                                
         EJECT                                                                  
         EJECT                                                                  
APLTAB   DS    0XL1                                                             
         DC    B'11110000'         Order type/Office/Etype/Client               
         DC    B'10110000'         Order type/Etype/Client                      
         DC    B'11010000'         Order type/Office/Client                     
         DC    B'10010000'         Order type/Client                            
         DC    B'11100000'         Order type/Office/Etype                      
         DC    B'10100000'         Order type/Etype                             
         DC    B'11000000'         Order type/Office                            
         DC    B'10000000'         Order type                                   
         DC    B'01111000'         Client ord type/Office/Etype/Client          
         DC    B'01011000'         Client ord type/Office/Client                
         DC    B'00111000'         Client ord type/Client/Etype                 
         DC    B'00011000'         Client ord type/Client                       
         DC    B'01101000'         Client ord type/Office/Etype                 
         DC    B'00101000'         Client ord type/Etype                        
         DC    B'01001000'         Client ord type/Office                       
         DC    B'00001000'         Client ord type                              
         DC    B'01110000'         Office/Etype/Client                          
         DC    B'01010000'         Office/Client                                
         DC    B'00110000'         Client/Etype                                 
         DC    B'00010000'         Client                                       
         DC    B'01100000'         Office/Etype                                 
         DC    B'00100000'         Etype                                        
         DC    B'01000000'         Office                                       
         DC    B'00000000'         Agency                                       
         DC    X'FF'                                                            
                                                                                
* new version - use equates                                                     
APR1TAB  DS    0XL2                                                             
*  section 1 - with media and/or 2P, but no cli/pro/job                         
*                                                                               
* Exp/Prod order type, off, dep, etype, media, 2P a/c                           
         DC    AL1(APRTORT1+APRTOFFC+APRTDEPT+APRTETYP)                         
         DC    AL1(APRTMED+APRT2PA)                                             
* Client order type, off, dep, etype, med, 2P a/c                               
         DC    AL1(APRTORT2+APRTOFFC+APRTDEPT+APRTETYP)                         
         DC    AL1(APRTMED+APRT2PA)                                             
* No order type, off, dep, etype, med, 2P a/c                                   
         DC    AL1(APRTOFFC+APRTDEPT+APRTETYP)                                  
         DC    AL1(APRTMED+APRT2PA)                                             
* Exp/Prod order type, off, dep, med, 2P a/c                                    
         DC    AL1(APRTORT1+APRTOFFC+APRTDEPT)                                  
         DC    AL1(APRTMED+APRT2PA)                                             
* Client order type, off, dep, med, 2P a/c                                      
         DC    AL1(APRTORT2+APRTOFFC+APRTDEPT)                                  
         DC    AL1(APRTMED+APRT2PA)                                             
* No order type, off, dep, med, 2P a/c                                          
         DC    AL1(APRTOFFC+APRTDEPT)                                           
         DC    AL1(APRTMED+APRT2PA)                                             
* Exp/Prod order type, off, etype, med, 2P a/c                                  
         DC    AL1(APRTORT1+APRTOFFC+APRTETYP)                                  
         DC    AL1(APRTMED+APRT2PA)                                             
* Client order type, off, etype, med, 2P a/c                                    
         DC    AL1(APRTORT2+APRTOFFC+APRTETYP)                                  
         DC    AL1(APRTMED+APRT2PA)                                             
* No order type, off, etype, med, 2P a/c                                        
         DC    AL1(APRTOFFC+APRTETYP)                                           
         DC    AL1(APRTMED+APRT2PA)                                             
* Exp/Prod order type, etype, med, 2P a/c                                       
         DC    AL1(APRTORT1+APRTETYP)                                           
         DC    AL1(APRTMED+APRT2PA)                                             
* Client order type, etype, med, 2P a/c                                         
         DC    AL1(APRTORT2+APRTETYP)                                           
         DC    AL1(APRTMED+APRT2PA)                                             
* No order type, etype, med, 2P a/c                                             
         DC    AL1(APRTETYP)                                                    
         DC    AL1(APRTMED+APRT2PA)                                             
* Exp/Prod order type, off, med, 2P a/c                                         
         DC    AL1(APRTORT1+APRTOFFC)                                           
         DC    AL1(APRTMED+APRT2PA)                                             
* Client order type, off, med, 2P a/c                                           
         DC    AL1(APRTORT2+APRTOFFC)                                           
         DC    AL1(APRTMED+APRT2PA)                                             
* No order type, off, med, 2P a/c                                               
         DC    AL1(APRTOFFC)                                                    
         DC    AL1(APRTMED+APRT2PA)                                             
* Exp/Prod order type, med, 2P a/c                                              
         DC    AL1(APRTORT1)                                                    
         DC    AL1(APRTMED+APRT2PA)                                             
* Client order type, med, 2P a/c                                                
         DC    AL1(APRTORT2)                                                    
         DC    AL1(APRTMED+APRT2PA)                                             
* No order type, med, 2P a/c                                                    
         DC    AL1(0)                                                           
         DC    AL1(APRTMED+APRT2PA)                                             
* Exp/Prod order type, off, dep, etype, 2P a/c                                  
         DC    AL1(APRTORT1+APRTOFFC+APRTDEPT+APRTETYP)                         
         DC    AL1(APRT2PA)                                                     
* Client order type, off, dep, etype, 2P a/c                                    
         DC    AL1(APRTORT2+APRTOFFC+APRTDEPT+APRTETYP)                         
         DC    AL1(APRT2PA)                                                     
* No order type, off, dep, etype, 2P a/c                                        
         DC    AL1(APRTOFFC+APRTDEPT+APRTETYP)                                  
         DC    AL1(APRT2PA)                                                     
* Exp/Prod order type, off, dep, 2P a/c                                         
         DC    AL1(APRTORT1+APRTOFFC+APRTDEPT)                                  
         DC    AL1(APRT2PA)                                                     
* Client order type, off, dep, 2P a/c                                           
         DC    AL1(APRTORT2+APRTOFFC+APRTDEPT)                                  
         DC    AL1(APRT2PA)                                                     
* No order type, off, dep, 2P a/c                                               
         DC    AL1(APRTOFFC+APRTDEPT)                                           
         DC    AL1(APRT2PA)                                                     
* Exp/Prod order type, off, etype, 2P a/c                                       
         DC    AL1(APRTORT1+APRTOFFC+APRTETYP)                                  
         DC    AL1(APRT2PA)                                                     
* Client order type, off, etype, 2P a/c                                         
         DC    AL1(APRTORT2+APRTOFFC+APRTETYP)                                  
         DC    AL1(APRT2PA)                                                     
* No order type, off, etype, 2P a/c                                             
         DC    AL1(APRTOFFC+APRTETYP)                                           
         DC    AL1(APRT2PA)                                                     
* Exp/Prod order type, etype, 2P a/c                                            
         DC    AL1(APRTORT1+APRTETYP)                                           
         DC    AL1(APRT2PA)                                                     
* Client order type, etype, 2P a/c                                              
         DC    AL1(APRTORT2+APRTETYP)                                           
         DC    AL1(APRT2PA)                                                     
* No order type,  etype, 2P a/c                                                 
         DC    AL1(APRTETYP)                                                    
         DC    AL1(APRT2PA)                                                     
* Exp/Prod order type, off, 2P a/c                                              
         DC    AL1(APRTORT1+APRTOFFC)                                           
         DC    AL1(APRT2PA)                                                     
* Client order type, off, 2P a/c                                                
         DC    AL1(APRTORT2+APRTOFFC)                                           
         DC    AL1(APRT2PA)                                                     
* No order type, off, 2P a/c                                                    
         DC    AL1(APRTOFFC)                                                    
         DC    AL1(APRT2PA)                                                     
* Exp/Prod order type, 2P a/c                                                   
         DC    AL1(APRTORT1)                                                    
         DC    AL1(APRT2PA)                                                     
* Client order type, 2P a/c                                                     
         DC    AL1(APRTORT2)                                                    
         DC    AL1(APRT2PA)                                                     
* No order type, 2P a/c                                                         
         DC    AL1(0)                                                           
         DC    AL1(APRT2PA)                                                     
*                                                                               
*  section 2 - with cli/pro/job, no supplier or 2P                              
*                                                                               
* Exp/Prod order type, off, dep, etype, cli, pro, job, med                      
         DC    AL1(APRTORT1+APRTOFFC+APRTDEPT+APRTETYP+APRTCLI+APRTPRO+X        
               APRTJOB)                                                         
         DC    AL1(APRTMED)                                                     
* Client order type, off, dep, etype, cli, pro, job, med                        
         DC    AL1(APRTORT2+APRTOFFC+APRTDEPT+APRTETYP+APRTCLI+APRTPRO+X        
               APRTJOB)                                                         
         DC    AL1(APRTMED)                                                     
* No order type, off, dep, etype, cli, pro, job, med                            
         DC    AL1(APRTOFFC+APRTDEPT+APRTETYP+APRTCLI+APRTPRO+APRTJOB)          
         DC    AL1(APRTMED)                                                     
* Exp/Prod order type, off, dep, cli, pro, job, med                             
         DC    AL1(APRTORT1+APRTOFFC+APRTDEPT+APRTCLI+APRTPRO+APRTJOB)          
         DC    AL1(APRTMED)                                                     
* Client order type, off, dep,  cli, pro, job, med                              
         DC    AL1(APRTORT2+APRTOFFC+APRTDEPT+APRTCLI+APRTPRO+APRTJOB)          
         DC    AL1(APRTMED)                                                     
* No order type, off, dep,  cli, pro, job, med                                  
         DC    AL1(APRTOFFC+APRTDEPT+APRTCLI+APRTPRO+APRTJOB)                   
         DC    AL1(APRTMED)                                                     
* Exp/Prod order type, off, etype, cli, pro, job, med                           
         DC    AL1(APRTORT1+APRTOFFC+APRTETYP+APRTCLI+APRTPRO+APRTJOB)          
         DC    AL1(APRTMED)                                                     
* Client order type, off, etype, cli, pro, job, med                             
         DC    AL1(APRTORT2+APRTOFFC+APRTETYP+APRTCLI+APRTPRO+APRTJOB)          
         DC    AL1(APRTMED)                                                     
* No order type, off, etype, cli, pro, job, med                                 
         DC    AL1(APRTOFFC+APRTETYP+APRTCLI+APRTPRO+APRTJOB)                   
         DC    AL1(APRTMED)                                                     
* Exp/Prod order type, off, cli, pro, job, med                                  
         DC    AL1(APRTORT1+APRTOFFC+APRTCLI+APRTPRO+APRTJOB)                   
         DC    AL1(APRTMED)                                                     
* Client order type, off, cli, pro, job, med                                    
         DC    AL1(APRTORT2+APRTOFFC+APRTCLI+APRTPRO+APRTJOB)                   
         DC    AL1(APRTMED)                                                     
* No order type, off, cli, pro, job, med                                        
         DC    AL1(APRTOFFC+APRTCLI+APRTPRO+APRTJOB)                            
         DC    AL1(APRTMED)                                                     
*                                                                               
*  section 3 - cli/pro                                                          
* Exp/Prod order type, off, dep, etype, cli, pro, med                           
         DC    AL1(APRTORT1+APRTOFFC+APRTDEPT+APRTETYP+APRTCLI+APRTPRO)         
         DC    AL1(APRTMED)                                                     
* Client order type, off, dep, etype, cli, pro, med                             
         DC    AL1(APRTORT2+APRTOFFC+APRTDEPT+APRTETYP+APRTCLI+APRTPRO)         
         DC    AL1(APRTMED)                                                     
* No order type, off, dep, etype, cli, pro, med                                 
         DC    AL1(APRTOFFC+APRTDEPT+APRTETYP+APRTCLI+APRTPRO)                  
         DC    AL1(APRTMED)                                                     
* Exp/Prod order type, off, dep, cli, pro, med                                  
         DC    AL1(APRTORT1+APRTOFFC+APRTDEPT+APRTCLI+APRTPRO)                  
         DC    AL1(APRTMED)                                                     
* Client order type, off, dep,  cli, pro, med                                   
         DC    AL1(APRTORT2+APRTOFFC+APRTDEPT+APRTCLI+APRTPRO)                  
         DC    AL1(APRTMED)                                                     
* No order type, off, dep,  cli, pro, med                                       
         DC    AL1(APRTOFFC+APRTDEPT+APRTCLI+APRTPRO)                           
         DC    AL1(APRTMED)                                                     
* Exp/Prod order type, off, etype, cli, pro, med                                
         DC    AL1(APRTORT1+APRTOFFC+APRTETYP+APRTCLI+APRTPRO)                  
         DC    AL1(APRTMED)                                                     
* Client order type, off, etype, cli, pro, med                                  
         DC    AL1(APRTORT2+APRTOFFC+APRTETYP+APRTCLI+APRTPRO)                  
         DC    AL1(APRTMED)                                                     
* No order type, off, etype, cli, pro, med                                      
         DC    AL1(APRTOFFC+APRTETYP+APRTCLI+APRTPRO)                           
         DC    AL1(APRTMED)                                                     
* Exp/Prod order type, off, cli, pro, med                                       
         DC    AL1(APRTORT1+APRTOFFC+APRTCLI+APRTPRO)                           
         DC    AL1(APRTMED)                                                     
* Client order type, off, cli, pro, med                                         
         DC    AL1(APRTORT2+APRTOFFC+APRTCLI+APRTPRO)                           
         DC    AL1(APRTMED)                                                     
* No order type, off, cli, pro, med                                             
         DC    AL1(APRTOFFC+APRTCLI+APRTPRO)                                    
         DC    AL1(APRTMED)                                                     
*                                                                               
*  section 4 - cli only                                                         
*                                                                               
* Exp/Prod order type, off, dep, etype, cli, med                                
         DC    AL1(APRTORT1+APRTOFFC+APRTDEPT+APRTETYP+APRTCLI)                 
         DC    AL1(APRTMED)                                                     
* Client order type, off, dep, etype, cli, med                                  
         DC    AL1(APRTORT2+APRTOFFC+APRTDEPT+APRTETYP+APRTCLI)                 
         DC    AL1(APRTMED)                                                     
* No order type, off, dep, etype, cli, med                                      
         DC    AL1(APRTOFFC+APRTDEPT+APRTETYP+APRTCLI)                          
         DC    AL1(APRTMED)                                                     
* Exp/Prod order type, off, dep, cli, med                                       
         DC    AL1(APRTORT1+APRTOFFC+APRTDEPT+APRTCLI)                          
         DC    AL1(APRTMED)                                                     
* Client order type, off, dep,  cli, med                                        
         DC    AL1(APRTORT2+APRTOFFC+APRTDEPT+APRTCLI)                          
         DC    AL1(APRTMED)                                                     
* No order type, off, dep,  cli, med                                            
         DC    AL1(APRTOFFC+APRTDEPT+APRTCLI)                                   
         DC    AL1(APRTMED)                                                     
* Exp/Prod order type, off, etype, cli, med                                     
         DC    AL1(APRTORT1+APRTOFFC+APRTETYP+APRTCLI)                          
         DC    AL1(APRTMED)                                                     
* Client order type, off, etype, cli, med                                       
         DC    AL1(APRTORT2+APRTOFFC+APRTETYP+APRTCLI)                          
         DC    AL1(APRTMED)                                                     
* No order type, off, etype, cli, med                                           
         DC    AL1(APRTOFFC+APRTETYP+APRTCLI)                                   
         DC    AL1(APRTMED)                                                     
* Exp/Prod order type, etype, cli, med                                          
         DC    AL1(APRTORT1+APRTETYP+APRTCLI)                                   
         DC    AL1(APRTMED)                                                     
* Client order type, etype, cli, med                                            
         DC    AL1(APRTORT2+APRTETYP+APRTCLI)                                   
         DC    AL1(APRTMED)                                                     
* No order type, etype, cli, med                                                
         DC    AL1(APRTETYP+APRTCLI)                                            
         DC    AL1(APRTMED)                                                     
* Exp/Prod order type, off, cli, med                                            
         DC    AL1(APRTORT1+APRTOFFC+APRTCLI)                                   
         DC    AL1(APRTMED)                                                     
* Client order type, off, cli, med                                              
         DC    AL1(APRTORT2+APRTOFFC+APRTCLI)                                   
         DC    AL1(APRTMED)                                                     
* No order type, off, cli, med                                                  
         DC    AL1(APRTOFFC+APRTCLI)                                            
         DC    AL1(APRTMED)                                                     
* Exp/Prod order type, cli, med                                                 
         DC    AL1(APRTORT1+APRTCLI)                                            
         DC    AL1(APRTMED)                                                     
* Client order type, cli, med                                                   
         DC    AL1(APRTORT2+APRTCLI)                                            
         DC    AL1(APRTMED)                                                     
* No order type, cli, med                                                       
         DC    AL1(APRTCLI)                                                     
         DC    AL1(APRTMED)                                                     
*                                                                               
*  section 5 - media+supplier, no SJ                                            
*                                                                               
* Exp/Prod order type, off, dep, etype, med, supp                               
         DC    AL1(APRTORT1+APRTOFFC+APRTDEPT+APRTETYP)                         
         DC    AL1(APRTMED+APRTSUP)                                             
* Client order type, off, dep, etype, med, supp                                 
         DC    AL1(APRTORT2+APRTOFFC+APRTDEPT+APRTETYP)                         
         DC    AL1(APRTMED+APRTSUP)                                             
* No order type, off, dep, etype, med, supp                                     
         DC    AL1(APRTOFFC+APRTDEPT+APRTETYP)                                  
         DC    AL1(APRTMED+APRTSUP)                                             
* Exp/Prod order type, off, dep, med, supp                                      
         DC    AL1(APRTORT1+APRTOFFC+APRTDEPT)                                  
         DC    AL1(APRTMED+APRTSUP)                                             
* Client order type, off, dep, med, supp                                        
         DC    AL1(APRTORT2+APRTOFFC+APRTDEPT)                                  
         DC    AL1(APRTMED+APRTSUP)                                             
* No order type, off, dep, med, supp                                            
         DC    AL1(APRTOFFC+APRTDEPT)                                           
         DC    AL1(APRTMED+APRTSUP)                                             
* Exp/Prod order type, off, etype, med, supp                                    
         DC    AL1(APRTORT1+APRTOFFC+APRTETYP)                                  
         DC    AL1(APRTMED+APRTSUP)                                             
* Client order type, off, etype, med, supp                                      
         DC    AL1(APRTORT2+APRTOFFC+APRTETYP)                                  
         DC    AL1(APRTMED+APRTSUP)                                             
* No order type, off, etype, med, supp                                          
         DC    AL1(APRTOFFC+APRTETYP)                                           
         DC    AL1(APRTMED+APRTSUP)                                             
* Exp/Prod order type, etype, med, supp                                         
         DC    AL1(APRTORT1+APRTETYP)                                           
         DC    AL1(APRTMED+APRTSUP)                                             
* Client order type, etype, med, supp                                           
         DC    AL1(APRTORT2+APRTETYP)                                           
         DC    AL1(APRTMED+APRTSUP)                                             
* No order type, etype, med, supp                                               
         DC    AL1(APRTETYP)                                                    
         DC    AL1(APRTMED+APRTSUP)                                             
* Exp/Prod order type, off, med, supp                                           
         DC    AL1(APRTORT1+APRTOFFC)                                           
         DC    AL1(APRTMED+APRTSUP)                                             
* Client order type, off, med, supp                                             
         DC    AL1(APRTORT2+APRTOFFC)                                           
         DC    AL1(APRTMED+APRTSUP)                                             
* No order type, off, med, supp                                                 
         DC    AL1(APRTOFFC)                                                    
         DC    AL1(APRTMED+APRTSUP)                                             
* Exp/Prod order type, med, supp                                                
         DC    AL1(APRTORT1)                                                    
         DC    AL1(APRTMED+APRTSUP)                                             
* Client order type, med, supp                                                  
         DC    AL1(APRTORT2)                                                    
         DC    AL1(APRTMED+APRTSUP)                                             
* No order type, med, supp                                                      
         DC    AL1(0)                                                           
         DC    AL1(APRTMED+APRTSUP)                                             
*                                                                               
*  section 6 - No supplier, client, 2P                                          
*                                                                               
* Exp/Prod order type, off, dep, etype, med                                     
         DC    AL1(APRTORT1+APRTOFFC+APRTDEPT+APRTETYP)                         
         DC    AL1(APRTMED)                                                     
* Client order type, off, dep, etype, med                                       
         DC    AL1(APRTORT2+APRTOFFC+APRTDEPT+APRTETYP)                         
         DC    AL1(APRTMED)                                                     
* No order type, off, dep, etype, med                                           
         DC    AL1(APRTOFFC+APRTDEPT+APRTETYP)                                  
         DC    AL1(APRTMED)                                                     
* Exp/Prod order type, off, dep, med                                            
         DC    AL1(APRTORT1+APRTOFFC+APRTDEPT)                                  
         DC    AL1(APRTMED)                                                     
* Client order type, off, dep, med                                              
         DC    AL1(APRTORT2+APRTOFFC+APRTDEPT)                                  
         DC    AL1(APRTMED)                                                     
* No order type, off, dep, med                                                  
         DC    AL1(APRTOFFC+APRTDEPT)                                           
         DC    AL1(APRTMED)                                                     
* Exp/Prod order type, off, etype, med                                          
         DC    AL1(APRTORT1+APRTOFFC+APRTETYP)                                  
         DC    AL1(APRTMED)                                                     
* Client order type, off, etype, med                                            
         DC    AL1(APRTORT2+APRTOFFC+APRTETYP)                                  
         DC    AL1(APRTMED)                                                     
* No order type, off, etype, med                                                
         DC    AL1(APRTOFFC+APRTETYP)                                           
         DC    AL1(APRTMED)                                                     
* Exp/Prod order type, etype, med                                               
         DC    AL1(APRTORT1+APRTETYP)                                           
         DC    AL1(APRTMED)                                                     
* Client order type, etype, med                                                 
         DC    AL1(APRTORT2+APRTETYP)                                           
         DC    AL1(APRTMED)                                                     
* No order type, etype, med                                                     
         DC    AL1(APRTETYP)                                                    
         DC    AL1(APRTMED)                                                     
* Exp/Prod order type, off, med                                                 
         DC    AL1(APRTORT1+APRTOFFC)                                           
         DC    AL1(APRTMED)                                                     
* Client order type, off, med                                                   
         DC    AL1(APRTORT2+APRTOFFC)                                           
         DC    AL1(APRTMED)                                                     
* No order type, off, med                                                       
         DC    AL1(APRTOFFC)                                                    
         DC    AL1(APRTMED)                                                     
* Exp/Prod order type, med                                                      
         DC    AL1(APRTORT1)                                                    
         DC    AL1(APRTMED)                                                     
* Client order type, med                                                        
         DC    AL1(APRTORT2)                                                    
         DC    AL1(APRTMED)                                                     
* No order type, med                                                            
         DC    AL1(0)                                                           
         DC    AL1(APRTMED)                                                     
*                                                                               
*  section 7 - cli/pro,  but no supplier, media, 2P                             
*                                                                               
* Exp/Prod order type, off, dep, etype, cli, pro                                
         DC    AL1(APRTORT1+APRTOFFC+APRTDEPT+APRTETYP+APRTCLI+APRTPRO)         
         DC    AL1(0)                                                           
* Client order type, off, dep, etype, cli, pro                                  
         DC    AL1(APRTORT2+APRTOFFC+APRTDEPT+APRTETYP+APRTCLI+APRTPRO)         
         DC    AL1(0)                                                           
* No order type, off, dep, etype, cli, pro                                      
         DC    AL1(APRTOFFC+APRTDEPT+APRTETYP+APRTCLI+APRTPRO)                  
         DC    AL1(0)                                                           
* Exp/Prod order type, off, dep, cli, pro                                       
         DC    AL1(APRTORT1+APRTOFFC+APRTDEPT+APRTCLI+APRTPRO)                  
         DC    AL1(0)                                                           
* Client order type, off, dep,  cli, pro                                        
         DC    AL1(APRTORT2+APRTOFFC+APRTDEPT+APRTCLI+APRTPRO)                  
         DC    AL1(0)                                                           
* No order type, off, dep,  cli, pro                                            
         DC    AL1(APRTOFFC+APRTDEPT+APRTCLI+APRTPRO)                           
         DC    AL1(0)                                                           
* Exp/Prod order type, off, etype, cli, pro                                     
         DC    AL1(APRTORT1+APRTOFFC+APRTETYP+APRTCLI+APRTPRO)                  
         DC    AL1(0)                                                           
* Client order type, off, etype, cli, pro                                       
         DC    AL1(APRTORT2+APRTOFFC+APRTETYP+APRTCLI+APRTPRO)                  
         DC    AL1(0)                                                           
* No order type, off, etype, cli, pro                                           
         DC    AL1(APRTOFFC+APRTETYP+APRTCLI+APRTPRO)                           
         DC    AL1(0)                                                           
* Exp/Prod order type, off, cli, pro                                            
         DC    AL1(APRTORT1+APRTOFFC+APRTCLI+APRTPRO)                           
         DC    AL1(0)                                                           
* Client order type, off, cli, pro                                              
         DC    AL1(APRTORT2+APRTOFFC+APRTCLI+APRTPRO)                           
         DC    AL1(0)                                                           
* No order type, off, cli, pro                                                  
         DC    AL1(APRTOFFC+APRTCLI+APRTPRO)                                    
         DC    AL1(0)                                                           
*                                                                               
*  section 8 - with client, but no supplier, media, 2P                          
*                                                                               
* Exp/Prod order type, off, dep, etype, cli                                     
         DC    AL1(APRTORT1+APRTOFFC+APRTDEPT+APRTETYP+APRTCLI)                 
         DC    AL1(0)                                                           
* Client order type, off, dep, etype, cli                                       
         DC    AL1(APRTORT2+APRTOFFC+APRTDEPT+APRTETYP+APRTCLI)                 
         DC    AL1(0)                                                           
* No order type, off, dep, etype, cli                                           
         DC    AL1(APRTOFFC+APRTDEPT+APRTETYP+APRTCLI)                          
         DC    AL1(0)                                                           
* Exp/Prod order type, off, dep, cli                                            
         DC    AL1(APRTORT1+APRTOFFC+APRTDEPT+APRTCLI)                          
         DC    AL1(0)                                                           
* Client order type, off, dep,  cli                                             
         DC    AL1(APRTORT2+APRTOFFC+APRTDEPT+APRTCLI)                          
         DC    AL1(0)                                                           
* No order type, off, dep,  cli                                                 
         DC    AL1(APRTOFFC+APRTDEPT+APRTCLI)                                   
         DC    AL1(0)                                                           
* Exp/Prod order type, off, etype, cli                                          
         DC    AL1(APRTORT1+APRTOFFC+APRTETYP+APRTCLI)                          
         DC    AL1(0)                                                           
* Client order type, off, etype, cli                                            
         DC    AL1(APRTORT2+APRTOFFC+APRTETYP+APRTCLI)                          
         DC    AL1(0)                                                           
* No order type, off, etype, cli                                                
         DC    AL1(APRTOFFC+APRTETYP+APRTCLI)                                   
         DC    AL1(0)                                                           
* Exp/Prod order type, off, cli                                                 
         DC    AL1(APRTORT1+APRTOFFC+APRTCLI)                                   
         DC    AL1(0)                                                           
* Client order type, off, cli                                                   
         DC    AL1(APRTORT2+APRTOFFC+APRTCLI)                                   
         DC    AL1(0)                                                           
* No order type, off, cli                                                       
         DC    AL1(APRTOFFC+APRTCLI)                                            
         DC    AL1(0)                                                           
* Exp/Prod order type, cli                                                      
         DC    AL1(APRTORT1+APRTCLI)                                            
         DC    AL1(0)                                                           
* Client order type, cli                                                        
         DC    AL1(APRTORT2+APRTCLI)                                            
         DC    AL1(0)                                                           
* No order type, cli                                                            
         DC    AL1(APRTCLI)                                                     
         DC    AL1(0)                                                           
*                                                                               
*  section 9 - with supplier,but no cli, media or 2P                            
*                                                                               
* Exp/Prod order type, off, dep, etype                                          
         DC    AL1(APRTORT1+APRTOFFC+APRTDEPT+APRTETYP)                         
         DC    AL1(APRTSUP)                                                     
* Client order type, off, dep, etype                                            
         DC    AL1(APRTORT2+APRTOFFC+APRTDEPT+APRTETYP)                         
         DC    AL1(APRTSUP)                                                     
* No order type, off, dep, etype                                                
         DC    AL1(APRTOFFC+APRTDEPT+APRTETYP)                                  
         DC    AL1(APRTSUP)                                                     
* Exp/Prod order type, off, dep                                                 
         DC    AL1(APRTORT1+APRTOFFC+APRTDEPT)                                  
         DC    AL1(APRTSUP)                                                     
* Client order type, off, dep                                                   
         DC    AL1(APRTORT2+APRTOFFC+APRTDEPT)                                  
         DC    AL1(APRTSUP)                                                     
* No order type, off, dep                                                       
         DC    AL1(APRTOFFC+APRTDEPT)                                           
         DC    AL1(APRTSUP)                                                     
* Exp/Prod order type, off, etype                                               
         DC    AL1(APRTORT1+APRTOFFC+APRTETYP)                                  
         DC    AL1(APRTSUP)                                                     
* Client order type, off, etype                                                 
         DC    AL1(APRTORT2+APRTOFFC+APRTETYP)                                  
         DC    AL1(APRTSUP)                                                     
* No order type, off, etype                                                     
         DC    AL1(APRTOFFC+APRTETYP)                                           
         DC    AL1(APRTSUP)                                                     
* Exp/Prod order type, etype                                                    
         DC    AL1(APRTORT1+APRTETYP)                                           
         DC    AL1(APRTSUP)                                                     
* Client order type, etype                                                      
         DC    AL1(APRTORT2+APRTETYP)                                           
         DC    AL1(APRTSUP)                                                     
* No order type, etype                                                          
         DC    AL1(APRTETYP)                                                    
         DC    AL1(APRTSUP)                                                     
* Exp/Prod order type, off                                                      
         DC    AL1(APRTORT1+APRTOFFC)                                           
         DC    AL1(APRTSUP)                                                     
* Client order type, off                                                        
         DC    AL1(APRTORT2+APRTOFFC)                                           
         DC    AL1(APRTSUP)                                                     
* No order type, off                                                            
         DC    AL1(APRTOFFC)                                                    
         DC    AL1(APRTSUP)                                                     
* Exp/Prod order type                                                           
         DC    AL1(APRTORT1)                                                    
         DC    AL1(APRTSUP)                                                     
* Client order type                                                             
         DC    AL1(APRTORT2)                                                    
         DC    AL1(APRTSUP)                                                     
* No order type                                                                 
         DC    AL1(0)                                                           
         DC    AL1(APRTSUP)                                                     
*                                                                               
* Section 10 1R account levels and types                                        
*                                                                               
* Expenses/prod order type full 1R etype                                        
         DC    AL1(APRTETYP+APRTORT1)                                           
         DC    AL1(APRT2PE)                                                     
* Cli/non cli order type full 1R etype                                          
         DC    AL1(APRTETYP+APRTORT2)                                           
         DC    AL1(APRT2PE)                                                     
* No order type full 1R etype                                                   
         DC    AL1(APRTETYP)                                                    
         DC    AL1(APRT2PE)                                                     
*                                                                               
* Expenses/prod order type full 1R                                              
         DC    AL1(APRTORT1)                                                    
         DC    AL1(APRT2PE)                                                     
* Cli/non-cli order type full 1R                                                
         DC    AL1(APRTORT2)                                                    
         DC    AL1(APRT2PE)                                                     
* No order type full 1R                                                         
         DC    AL1(0)                                                           
         DC    AL1(APRT2PE)                                                     
*                                                                               
* Expenses/prod order type subdepartment etype                                  
         DC    AL1(APRTETYP+APRTORT1)                                           
         DC    AL1(APRT2SD)                                                     
* Cli/non cli order type subdepartment etype                                    
         DC    AL1(APRTETYP+APRTORT2)                                           
         DC    AL1(APRT2SD)                                                     
* No order type full subdepartment etype                                        
         DC    AL1(APRTETYP)                                                    
         DC    AL1(APRT2SD)                                                     
*                                                                               
* Expenses/prod order type subdepartment                                        
         DC    AL1(APRTORT1)                                                    
         DC    AL1(APRT2SD)                                                     
* Cli/non-cli order type subdepartment                                          
         DC    AL1(APRTORT2)                                                    
         DC    AL1(APRT2SD)                                                     
* No order type subdepartment                                                   
         DC    AL1(0)                                                           
         DC    AL1(APRT2SD)                                                     
*                                                                               
* Expenses/prod order type department etype                                     
         DC    AL1(APRTETYP+APRTORT1)                                           
         DC    AL1(APRT2DE)                                                     
* Cli/non cli order type department etype                                       
         DC    AL1(APRTETYP+APRTORT2)                                           
         DC    AL1(APRT2DE)                                                     
* No order type full department etype                                           
         DC    AL1(APRTETYP)                                                    
         DC    AL1(APRT2DE)                                                     
                                                                                
* Expenses/prod order type department                                           
         DC    AL1(APRTORT1)                                                    
         DC    AL1(APRT2DE)                                                     
* Cli/non-cli order type department                                             
         DC    AL1(APRTORT2)                                                    
         DC    AL1(APRT2DE)                                                     
* No order type department                                                      
         DC    AL1(0)                                                           
         DC    AL1(APRT2DE)                                                     
*                                                                               
* Expenses/prod order type office etype                                         
         DC    AL1(APRTETYP+APRTORT1)                                           
         DC    AL1(APRT2OF)                                                     
* Cli/non cli order type office etype                                           
         DC    AL1(APRTETYP+APRTORT2)                                           
         DC    AL1(APRT2OF)                                                     
* No order type full office etype                                               
         DC    AL1(APRTETYP)                                                    
         DC    AL1(APRT2OF)                                                     
*                                                                               
* Expenses/prod order type office                                               
         DC    AL1(APRTORT1)                                                    
         DC    AL1(APRT2OF)                                                     
* Cli/non-cli order type office                                                 
         DC    AL1(APRTORT2)                                                    
         DC    AL1(APRT2OF)                                                     
* No order type office                                                          
         DC    AL1(0)                                                           
         DC    AL1(APRT2OF)                                                     
*                                                                               
*  section 11 - only 2D off/dep and types                                       
*                                                                               
* Exp/Prod order type, off, dep, etype                                          
         DC    AL1(APRTORT1+APRTOFFC+APRTDEPT+APRTETYP)                         
         DC    AL1(0)                                                           
* Client order type, off, dep, etype                                            
         DC    AL1(APRTORT2+APRTOFFC+APRTDEPT+APRTETYP)                         
         DC    AL1(0)                                                           
* No order type, off, dep, etype                                                
         DC    AL1(APRTOFFC+APRTDEPT+APRTETYP)                                  
         DC    AL1(0)                                                           
* Exp/Prod order type, off, dep                                                 
         DC    AL1(APRTORT1+APRTOFFC+APRTDEPT)                                  
         DC    AL1(0)                                                           
* Client order type, off, dep                                                   
         DC    AL1(APRTORT2+APRTOFFC+APRTDEPT)                                  
         DC    AL1(0)                                                           
* No order type, off, dep                                                       
         DC    AL1(APRTOFFC+APRTDEPT)                                           
         DC    AL1(0)                                                           
* Exp/Prod order type, off, etype                                               
         DC    AL1(APRTORT1+APRTOFFC+APRTETYP)                                  
         DC    AL1(0)                                                           
* Client order type, off, etype                                                 
         DC    AL1(APRTORT2+APRTOFFC+APRTETYP)                                  
         DC    AL1(0)                                                           
* No order type, off, etype                                                     
         DC    AL1(APRTOFFC+APRTETYP)                                           
         DC    AL1(0)                                                           
* Exp/Prod order type, etype                                                    
         DC    AL1(APRTORT1+APRTETYP)                                           
         DC    AL1(0)                                                           
* Client order type, etype                                                      
         DC    AL1(APRTORT2+APRTETYP)                                           
         DC    AL1(0)                                                           
* No order type, etype                                                          
         DC    AL1(APRTETYP)                                                    
         DC    AL1(0)                                                           
* Exp/Prod order type, off                                                      
         DC    AL1(APRTORT1+APRTOFFC)                                           
         DC    AL1(0)                                                           
* Client order type, off                                                        
         DC    AL1(APRTORT2+APRTOFFC)                                           
         DC    AL1(0)                                                           
* No order type, off                                                            
         DC    AL1(APRTOFFC)                                                    
         DC    AL1(0)                                                           
* No order type, dept                                                           
         DC    AL1(APRTDEPT)                                                    
         DC    AL1(0)                                                           
* Exp/Prod order type                                                           
         DC    AL1(APRTORT1)                                                    
         DC    AL1(0)                                                           
* Client order type                                                             
         DC    AL1(APRTORT2)                                                    
         DC    AL1(0)                                                           
* No order type                                                                 
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    X'FF'                                                            
                                                                                
***********************************************************************         
* DSECT TO COVER SAVED STORAGE                                        *         
***********************************************************************         
                                                                                
SAVED    DSECT ,                                                                
WVALUES  DS    0X                  ** LITERAL VALUES **                         
ADCONS   DS    0A                  ** RELOCATED ADDRESS CONSTANTS **            
AWCOLRF  DS    A                   A(WCOLRF)                                    
AACTKF   DS    A                   A(ACTKF)                                     
AACTRF   DS    A                   A(ACTRF)                                     
ADRAKF   DS    A                   A(DRAKF)                                     
ADRARF   DS    A                   A(DRARF)                                     
ASRCKF   DS    A                   A(SRCKF)                                     
ASRCRF   DS    A                   A(SRCRF)                                     
APIDKF   DS    A                   A(PIDKF)                                     
APIDRF   DS    A                   A(PIDRF)                                     
AJDTKF   DS    A                   A(JDTKF)                                     
AJDTRF   DS    A                   A(JDTRF)                                     
AAPDKF   DS    A                   A(APDKF)                                     
AAPDRF   DS    A                   A(APDRF)                                     
AUDDKF   DS    A                   A(UDDKF)                                     
AUDDRF   DS    A                   A(UDDRF)                                     
ANADKF   DS    A                   A(NADKF)                                     
ANADRF   DS    A                   A(NADRF)                                     
ARELKF   DS    A                   A(RELKF)                                     
ARELRF   DS    A                   A(RELRF)                                     
ADCONSN  EQU   (*-ADCONS)/L'ADCONS                                              
WVALUEL  EQU   *-WVALUES                                                        
                                                                                
VACCEMU  DS    A                   A(ACCEMU)                                    
AGETWCT  DS    A                   A(GETWCT)                                    
AMASTC   DS    A                   A(MASTC)                                     
ABUFFRIN DS    A                   A(BUFFERIN)                                  
ANXTDSC  DS    A                   A(NXTDESC)                                   
*                                                                               
*                                                                               
ACLOCL   DS    F                   saved address of most recent loctn           
ALOCEL   DS    F                   saved location element                       
ADRAPLVL DS    F                   Approval level greater than order            
ADRFSLVL DS    F                   First approval level of interest             
ADRCULVL DS    F                   Current approval level entry                 
TSARABUF DS    XL(TSPXTNL)         TSAR block for approver buffer               
*                                                                               
OL_INDS  DS    XL1                 OLIST - OFFICE CODE INDICATOR                
OL_PRSNT EQU   X'80'               OLIST IS PRESENT FOR OFFICE CODE             
OL_PROLT EQU   X'40'               PROCESS OLIST DETAILS                        
*                                                                               
SAVOLIST DS    CL(OLSTDLNQ*MAXOLSTQ) WORK AREA TO SAVE OLIST                    
MAXOLSTQ EQU   100                 MAXIMUM OLIST ENTRIES ALLOWED - 1            
*                                                                               
X#PPIN   DS    XL2                 Person pin                                   
X#1RACC  DS    CL12                1R account                                   
X#ESTOE  DS    PL6                 Original estimate                            
X#ESTCE  DS    PL6                 Current estimate                             
X#ESTHR  DS    PL6                 Highest revision estimate                    
X#CHRGS  DS    PL6                 Total charges                                
X#NPLVL  DS    XL1                 PREVIOUS LEVELS                              
X#DFWC   DS    CL2                 Default time workcode                        
SAVEKEY  DS    XL(L'IOKEY)         Overlay save key area                        
SAVEDPOS DS    XL1                 SAVED DEP POSITION                           
SAVEDLEN DS    XL1                 SAVED DEP LENGTH                             
SAVEPOS2 DS    XL1                 SAVED OFF POSITION                           
SAVELEN2 DS    XL1                 SAVED OFF LENGTH                             
APLAREA  DS    XL(APETABL)         Area to read approvers from buffer           
APLIND1  DS    XL1                 Approval look up indicator                   
APLIGREA EQU   X'80'               Level > than order found                     
APLIFOND EQU   X'40'               Approver found at this level                 
APLIEML  EQU   X'20'               Emails can JE sent                           
APLISLF  EQU   X'10'               Approver can self approve                    
APLIPUR  EQU   X'08'               Purchasing approver required                 
APLIHLV  EQU   X'04'               Reading high levels for low levels           
APLIHSL  EQU   X'02'               As above but for self approvers only         
*ABID                                                                           
         DS    0H                                                               
GAPAREA  DS    XL(GAPTLNQ)         Area to use for buffer rec                   
GAPLPARM DS    XL1                 GAPLST parm                                  
ATSRERRS DS    XL1                 Error area for buffer                        
*                                                                               
TSARTYPE DS    CL1                                                              
TSARTESQ EQU   C'E'                                                             
TSARTJSQ EQU   C'J'                                                             
TSARRECS DS    XL(TSPXTNL)         TSAR block for record buffer                 
TSAROBUF DS    XL(TSPXTNL)         TSAR block for optimisation buffer           
RUNMODE  DS    XL(L'RUNPMODE)      DDLINK/RUNNER CALLING MODE                   
*                                                                               
SAVEVAR  DS    0F                                                               
*                                  - EXPENSES AND INVOICES                      
QVALUES  DS    0XL256              ** REQUEST VALUES **                         
QDATA    DS    0XL1                - REQUEST DATA                               
*                                   - EXPENSES AND INVOICES                     
RQ_APOVL DS     CL14                - APPROVER: ORDER VALUE                     
RQ_APOTY DS     CL1                 - APPROVER: ORDER TYPE                      
RQ_APETY DS     CL3                 - APPROVER: EXPENDITURE TYPE                
RQ_APCLI DS     CL6                 - APPROVER: CLIENT (OPTIONAL)               
RQ_APDPT DS     CL12                - APPROVER: DEPARTMENT (OPTIONAL)           
RQ_APOWN DS     CL1                 - APPROVER: APPROVER IS OWNER               
RQ_APPRO DS     CL6                 - APPROVER: PRODUCT (OPTIONAL)              
RQ_APJOB DS     CL6                 - APPROVER: JOB (OPTIONAL)                  
RQ_APSUP DS     CL14                - APPROVER: SUPPLIER (OPTIONAL)             
RQ_APLTC DS     CL1                 - APPROVER: INVOICE APPROVER                
RQ_AORD  EQU    ALIKORD             - ORDERS                                    
RQ_AINV  EQU    ALIKINV             - INVOICES                                  
RQ_AINVN EQU    ALIKINVN            - INVOICE NO PURCHASE ORDER                 
RQ_APSEL DS     CL1                 - APPROVER: ETYPE SELF APPROVAL             
RQ_AP2PA DS     CL12                - APPROVER: 2P ACCOUNT CODE                 
RQ_APEDT DS     CL1                 - APPROVER: EDITOR IS SUBMITTER             
RQ_APORN DS     CL6                 - APPROVER: ORDER NUMBER                    
RQ_APALL DS     CL1                 - APPROVER: ALL ITEMS HAVE CLIENT           
RQ_APMIX DS     CL1                 - APPROVER: SOME ITEMS HAVE CLIENT          
RQ_APCPX DS     CL8                 - APPROVER: CLAIMANT PERSON CODE            
RQ_APCCD DS     PL3                 - APPROVER: CLAIMANT PERSON DATE            
QVALUESL EQU   *-QDATA             - LENGTH OF THE APPROVER LIST                
*                                                                               
         ORG   QVALUES                                                          
RQ_ADACC DS    CL14                - ACCOUNT DETAILS ACCOUNT CODE               
RQ_ADVLL DS    CL1                 - ACCOUNT DETAILS VALIDATE LIMLIST           
RQ_ADLED DS    CL1                 - ACCOUNT DETAILS ACCOUNT TYPE               
RQ_ADVAP DS    CL1                 - ACCOUNT DETAILS spare spare                
RQ_ADAPL DS    CL1                 - ACCOUNT DETAIL APPLICATION                 
RQ_ADORD EQU   C'O'                ORDERS                                       
RQ_ADTIM EQU   C'T'                TIMESHEETS                                   
RQ_ADEST EQU   C'E'                ESTIMATES                                    
RQ_ADEJL EQU   C'B'                ESTIMATE FOR JOB LIST                        
RQ_ADEXP EQU   C'X'                EXPENSES                                     
RQ_ADJOB EQU   C'J'                JOBS                                         
RQ_ADREP EQU   C'R'                REPORTING                                    
RQ_ADINV EQU   C'I'                INVOICES                                     
RQ_ADRES EQU   C'S'                RESOURCES                                    
RQ_ADDAS EQU   C'D'                DASHBOARD                                    
RQ_MAINT EQU   C'M'                MAINTENANCE                                  
RQ_ADMED DS    CL1                 - ACCOUNT DETAILS MEDIA CODE                 
RQ_ADIDT DS    CL8                 INVOICE DATE                                 
RQ_ADISJ DS    CL14                SPARE                                        
RQ_ADIOF DS    CL2                 OFFICE                                       
RQ_ADFPT DS    CL1                 ACCOUNT DETAIL FORCE PRODUCT ON TIME         
RQ_ADFJT DS    CL1                 ACCOUNT DETAIL FORCE JOB ON TIME             
RQ_ADBIL DS    CL1                 AC DETAIL BILLABLE ENTRY FOR ORDERS          
RQ_ADFTM DS    CL1                 AC DETAIL FUTURE TIME ONLY                   
RQ_ADEPT DS    CL6                 DEPARTMENT                                   
RQ_ADWC  DS    CL2                 WORK CODE                                    
RQ_ADRLK DS    CL1                 RETRUN LOCKED ACCOUNT (T/S)                  
*                                                                               
         ORG   QVALUES                                                          
QWCSTRT  DS    CL2                 - W/C LIST: START CODE                       
QWCSKIP  EQU   C'0'                - SKIP WORKCODE                              
QWCEND   DS    CL2                 - W/C LIST: END CODE                         
QWCGRP   DS    CL1                 - W/C LIST: W/C GROUP                        
QWCSTAT  DS    CL1                 - W/C LIST: STATUS                           
QWCSTTIM EQU   C'T'                TIME                                         
QWCSTCOS EQU   C'C'                COST                                         
QWCSTALL EQU   C' '                BOTH                                         
QWCTYPE  DS    CL1                 - W/C LIST: TYPE (Order/Estm/etc)            
QWCORD   EQU   C'O'                ORDERS                                       
QWCTIM   EQU   C'T'                TIMESHEETS                                   
QWCEST   EQU   C'E'                ESTIMATES                                    
QWCEJL   EQU   C'B'                ESTIMATE FOR JOB LIST                        
QWCEXP   EQU   C'X'                EXPENSES                                     
QWCJOB   EQU   C'J'                JOBS                                         
QWCREP   EQU   C'R'                REPORTING                                    
QWCINV   EQU   C'I'                INVOICES                                     
QWCRES   EQU   C'S'                RESOURCES                                    
QWCDAS   EQU   C'D'                DASHBOARD                                    
QWMAINT  EQU   C'M'                MAINTENANCE                                  
QWCWID   EQU   C'W'                TIMELINE ENTRY WIDGET                        
QWCOFFC  DS    CL2                 - W/C LIST: Office                           
QWCFDE   DS    CL1                 - W/C LIST: Foreign Description Y/N          
QWCLIML  DS    CL1                 - W/C LIST: LIMIT LIST OVERIDE Y/N           
QWCLNOV  DS    CL1                 - W/C LIST: no validation Y/N                
QWCLSJA  DS    CL12                - W/C LIST: SJ account                       
QWCLMED  DS    CL1                 - W/C LIST: Media (ballparks)                
QWCALLMD EQU   C' '                - W/C LIST: Media (ballparks)                
QWCLOTY  DS    CL1                 - W/C LIST: Order type                       
QWCEMPTY EQU   C' '                - ALL                                        
QWCNTRNL EQU   C'I'                - Internal                                   
QWCXPNSE EQU   C'E'                - Expense                                    
QWCARTST EQU   C'A'                - Artist                                     
QWCPROD  EQU   C'P'                - Production                                 
                                                                                
         ORG   QVALUES                                                          
QTETY    DS    CL1                 - TIME/EXP APPR. LIST TYPE                   
QTET1Q   EQU   C'1'                - expenses embedded                          
QTET2Q   EQU   C'2'                - time embedded                              
QTET3Q   EQU   C'3'                - estimates embedded                         
QTET4Q   EQU   C'4'                - invoices(posting) embedded                 
QTET5Q   EQU   C'5'                - invoices(route) embedded                   
QTET6Q   EQU   C'6'                - orders embedded                            
QTET7Q   EQU   C'7'                - Jobs dashboard embedded                    
QTEML    DS    CL1                 - Is email required?  T TYPE                 
QTETSTO  DS    CL1                 - Is IT TEST ONLY?                           
         ORG   QVALUES                                                          
RQ_LMOFF DS    CL2                 - Office                                     
RQ_LMDEP DS    CL3                 - Department                                 
RQ_LMSDP DS    CL2                 - Subdepartment                              
RQ_LMPER DS    CL8                 - Person                                     
QVALUEL  EQU   *-QVALUES                                                        
                                                                                
OVALUES  DS    0D                  ** OUTPUT VALUES **                          
*                                                                               
OUNIT    EQU   C'S'                                                             
OLEDGER  EQU   C'J'                                                             
*                                                                               
*WORK CODE ESTIMATE BILLING STATUS                                              
*                                                                               
OWCEXAL  EQU   C'A'                - Always                                     
OWCEXBL  EQU   C'B'                - When billing type isn't unbillable         
OWCEXUL  EQU   C'U'                - when billing type is unbillable            
* STATUS                                                                        
OWCBLABL EQU   C'B'                - BILLABLE                                   
OWCCHARG EQU   C'R'                - CHARGEABLE                                 
OWCNBIL  EQU   C'N'                - NON-BILLABLE                               
*                                                                               
OWCSUPRS EQU   C'Z'                - SUPPRESS WORKCODE                          
* TEAP APPROVAL STATUS                                                          
OTPREJ   EQU   C'R'                - REJECTED                                   
OTPAPPRV EQU   C'Y'                - APPROVED                                   
OTPNOAP  EQU   C'N'                - NOT APPROVED                               
                                                                                
         ORG                                                                    
OVALUESL EQU   *-OVALUES                                                        
                                                                                
DVALUES  DS    0F                  ** DERIVED VALUES **                         
*                                                                               
X#LLIND  DS    XL1                                                              
X#LLINI  EQU   X'80'               Limit list record found                      
X#CLIOF  EQU   X'40'               Read for clients filter by office            
X#ALCLI  EQU   X'20'               Read for all clients                         
*                                                                               
X#LLIN2  DS    XL1                                                              
X#LCPJQ  EQU   X'80'               CPJ limlist found                            
X#LMEDQ  EQU   X'40'               media limlist found                          
*                                                                               
XL#TODP  DS    XL3                 Today's date packed                          
XL#TODC  DS    XL2                 Today's date compressed                      
XL#GLIND DS    XL1                                                              
XL#GLIPQ EQU   X'80'                                                            
XL#GLIFQ EQU   X'08'                                                            
XL#COFF  DS    CL2                 Current office                               
XL#SCPJ  DS    CL12                Saved requested c/p/j                        
XL#INFA  DS    XL(X_INFOLNQ)                                                    
XL#RSUM  DS    CL1                                                              
XL#RCOD  DS    CL4                                                              
XL#APPL  DS    CL1                 APPLICATION FOR AL, AD AND SR                
XL#ARTWC DS    CL2                                                              
XL#ARTLC DS    CL4                                                              
XL#ARTOF DS    CL2                                                              
XL#ARTCL DS    CL5                                                              
XL#SVSUC DS    CL14                SUPPLIER CODE                                
XL#ORPF  DS    XL(ORDPRFL)                                                      
X#LLTABS DS    0C                  LIMIT LIST ACCESS:                           
X#LLTCPJ DS    CL1                 CLI/PRO/JOB                                  
X#LLTETY DS    CL1                 EXPENDITURE TYPE                             
X#LLTMED DS    CL1                 MEDIA                                        
X#LLTSUP DS    CL1                 SUPPLIER                                     
X#LLT1R  DS    CL1                 1R ACCOUNTS                                  
X#LLTNC  DS    CL1                 NON CLIENT ACCOUNTS                          
X#LLTWC  DS    CL1                 WORKCODE                                     
X#LLTLQ  EQU   *-X#LLTABS                                                       
X#LLALLQ EQU   C'A'                * UNLIMITED ACCESS                           
X#LLLSTQ EQU   C'L'                * LIMITED BY LIST                            
X#LLNONQ EQU   C'N'                * NO ACCESS                                  
                                                                                
XL#COMM  DS    PL6                 - COMMISSION RATE                            
*&&UK                                                                           
XL#SGOP  DS    XL1                                                              
*                                                                               
XL#VATC  DS    CL1                 - VAT rate                                   
XL#VATR  DS    CL4                 - VAT code                                   
XL#VATN  DS    CL36                - VAT a/c or code anme                       
XL#VATQ  EQU   *-XL#VATC                                                        
*&&                                                                             
XL#WCTYP DS    CL1                 - WORK CODE TYPE                             
XL#GOTWC DS    CL1                 - GOT WC FLAG Y/N                            
*                                                                               
* TEAP Request temp variables USED FOR TESTING ONLY                             
*                                                                               
XL#APLNQ DS    XL1                 - LENGTH OF ENTRY                            
*                                                                               
LENONE   EQU   1                                                                
PIDLEN   EQU   2                                                                
ACCLEN   EQU   8                                                                
*                                                                               
XL#ADR   DS    0A                                                               
XL#ADR1  DS    A                                                                
XL#ADR2  DS    A                                                                
*                                                                               
AALL     DS    AL3                 ALL VALUE WMP ENTRY                          
ANZR     DS    AL3                 NON-ZERO VALUE WMP ENTRY                     
*                                                                               
IWMPOST  DS    XL1                                                              
AWMPOST  DS    AL3                                                              
WMPOSTMQ EQU   400                                                              
*                                                                               
*IWMJNAM  DS    XL1                                                             
*AWMJNAM  DS    AL3                                                             
*WMJNAMMQ EQU   400                                                             
*                                                                               
*                                                                               
LL_LISTQ EQU   C'1'                                                             
LL_ALLQ  EQU   C'2'                                                             
LL_NONEQ EQU   C'3'                                                             
LL_DACS  DS    0CL1                                                             
LL_DCLIA DS    CL1                 Default Client Access                        
LL_DMEDA DS    CL1                 Default Media Access                         
LL_DEXPA DS    CL1                 Default Expenditure Access                   
LL_DNCLA DS    CL1                 Default Non-Client Access                    
LL_DSTFA DS    CL1                 Default Staff Access                         
LL_DWCA  DS    CL1                 Default Work Code Access                     
LL_DREPA DS    CL1                 Default Report Formats Access                
LL_DESTA DS    CL1                 Default Estimate Scheme Access               
LL_DSUPA DS    CL1                 Default Supplier Access                      
LL_DACLQ EQU   *-LL_DACS                                                        
*                                                                               
DVALUESL EQU   *-DVALUES                                                        
*                                                                               
MYTYPE   DS    XL1                                                              
RCTYPE   DS    XL1                                                              
STORE    DS    F                                                                
STORE1   DS    F                                                                
XAUDTYP  DS    CL1                                                              
AUDRECQ  EQU   C'Y'                                                             
ACTRECQ  EQU   C'N'                                                             
CHKMAIL  DS    CL1                                                              
CHKDATA  DS    CL1                                                              
CHKDATA1 DS    CL1                                                              
CHKBYTE1 DS    XL1                                                              
*                                                                               
PREVMEDC DS    CL1                                                              
PREVMENM DS    CL12                                                             
PREVMGRP DS    CL1                                                              
*                                                                               
TMPACNT  DS    CL12                                                             
ZEROS    DS    XL22                                                             
TMPJDTP  DS    XL1                                                              
TMPBYTE1 DS    XL1                                                              
TMPBYTE2 DS    XL1                                                              
*                                                                               
QAGENCY  DS    XL1                                                              
QPRODUL  DS    CL2                                                              
QCCTPID  DS    XL2                                                              
QALPHA   DS    CL(L'SAPEAGY)                                                    
AGYALF   DS    CL(L'SAPEAGY)                                                    
*                                                                               
SAVER5   DS    F                                                                
SAVER6   DS    F                                                                
SAVER4   DS    F                                                                
SAVER3   DS    F                                                                
SAVER2   DS    F                                                                
*                                                                               
AUINTAB  DS    A                   A(upper case translate table)                
ASRCTAB  DS    A                   A(search translate table)                    
*                                                                               
SAVEKEY1 DS    XL(L'IOKEY)                                                      
SAVEKEY2 DS    XL(L'IOKEY)                                                      
SAVEKEY3 DS    XL(L'IOKEY)                                                      
*                                                                     i         
AC_AMT   DS    PL6                 ADD UP BILLED AMOUNT                         
X#13MDAT DS    XL2                 13 months cut off date                       
X#LAPSW1 DS    CL1                 Lap Switch 1                                 
X#LAPSW2 DS    CL1                 Lap Switch 2                                 
X#BYTE1  DS    XL1                 BYTE 1                                       
X#BYTE2  DS    XL1                 BYTE 2                                       
X#BYTE3  DS    XL1                 BYTE 3                                       
X#PTYP   DS    XL1                 JLSD passive type                            
                                                                                
X#UFLD   DS    0XL10               Brandocean or ...                            
X#UFLDAU DS    0XL10               ... Aura                                     
X#UFLDH1 DS    XL1                                                              
X#UFLDD1 DS    XL1                                                              
X#UFLDH2 DS    XL1                                                              
X#UFLDD2 DS    XL1                                                              
X#UFLDH3 DS    XL1                                                              
X#UFLDD3 DS    XL1                                                              
X#UFRET1 DS    XL1                                                              
X#UFRET2 DS    XL1                                                              
X#UFRET3 DS    XL1                                                              
         DS    XL1                                                              
                                                                                
X#DATD   DS    CL10                                                             
X#TIME   DS    XL(L'STCTIME)                                                    
X#DATE   DS    XL(L'STCDATE)                                                    
X#OFFGRP DS    CL1                                                              
X#MEDGRP DS    CL1                                                              
X#JBIR   DS    CL1                                                              
X#JDSTAT DS    XL1                 Job status filter                            
X#JDSTSU EQU   X'80'                                                            
X#JDSTAP EQU   X'40'                                                            
X#JDSTRE EQU   X'20'                                                            
X#JDSTMA EQU   X'10'                                                            
X#JOBREJ DS    XL2                 Job rejecter                                 
X#CONREJ DS    CL1                 Connected person rejected?                   
X#CLISW  DS    CL1                 Client Record                                
*                                                                               
SAVEIND  DS    XL1                 INDICAT THAT IS NOT CLEARED BETWEEN          
*                                  REQUESTS                                     
SAVEAUR  EQU   X'40'               AURA (NOT BRANDOCEAN)                        
SAVEMST  EQU   X'20'               MULTIPLE X#JDSTAT STATUS'                    
SAVEML2  EQU   X'10'               SAVEMST - LAP 2 running                      
SAVERL2  EQU   X'01'               SAVEMST - LAP 2 required                     
SAVEPMA  EQU   X'02'               SAVEMST - PID match: cannot approve          
SAVEXDR  EQU   X'04'               SAVEMST - extra DRAPASD lap required         
SAVEXDL  EQU   X'08'               SAVEMST - extra DRAPASD lap running          
*                                                                               
X#RTTRX  DS    XL(TMSTTABL)        R TIME SETTINGS FROM GETOPT/GETCAP           
X#BTTRX  DS    XL(TMSTTABL)        B TIME SETTINGS FROM GETOPT/GETCAP           
TMSTNU2  EQU   (*-X#RTTRX)/TMSTTABL WHEN DOING ESTIMATE CHECKING                
X#NTTRX  DS    XL(TMSTTABL)        N TIME SETTINGS FROM GETOPT/GETCAP           
TMSTNUM  EQU   (*-X#RTTRX)/TMSTTABL                                             
*                                                                               
X#JAPP   DS    XL2                                                              
X#PAST   DS    CL1                                                              
X#JDTPAS DS    XL1                                                              
X#JDTPOQ EQU   X'80'                                                            
X#JDTPCQ EQU   X'08'                                                            
X#GAPIND DS    XL1                                                              
X#GAPIDQ EQU   X'80'                                                            
X#GAPIYQ EQU   X'40'                                                            
X#CLVL   DS    XL1                                                              
X#CLPL   DS    XL1                                                              
X#HOFF   DS    CL2                                                              
X#AOFF   DS    CL2                                                              
X#CLIOFF DS    CL2                                                              
X#PROOFF DS    CL2                                                              
X#POFF   DS    CL2                                                              
X#JBOPDP DS    XL3                 Job opened date packed                       
X#JBOPDC DS    XL2                 Job opened date compressed                   
X#OPND   DS    XL3                                                              
X#CLOD   DS    XL3                                                              
X#OPNX   DS    XL3                                                              
X#CLOX   DS    XL3                                                              
X#SRCL   DS    XL1                                                              
X#HIGH   DS    CL1                                                              
X#TSAYN  DS    CL1                                                              
X#COFF   DS    CL2                                                              
X#RUFI   DS    XL10                                                             
X#SVDT   DS    XL3                                                              
X#JREJ   DS    CL1                                                              
X#JSRC   DS    XL1                                                              
X#MEDC   DS    CL1                                                              
X#JCRE   DS    XL2                                                              
X#JAMD   DS    XL2                                                              
X#MEDG   DS    CL1                                                              
X#OFFG   DS    CL1                                                              
X#URKEY  DS    0XL42                                                            
X#MEDNO  DS    XL1                                                              
X#MEDLS  DS    CL41                                                             
X#MLLST  DS    XL37                                                             
X#PIDAP  DS    XL2                                                              
X#PIDRJ  DS    XL2                                                              
X#PIDSU  DS    XL2                                                              
X#PID    DS    XL2                                                              
X#ACTAP  DS    XL2                                                              
X#ACTRJ  DS    XL2                                                              
X#ACTSU  DS    XL2                                                              
X#PL16   DS    PL16                                                             
X#PL06   DS    PL6                                                              
X#TEST   DS    PL6                 TOTAL ESTIMATE NET                           
X#EHRS   DS    PL6                 TOTAL ESTIMATE HOURS                         
X#TUOR   DS    PL6                 TOTAL UNCOMMITTED ORDER AMOUNT               
X#TCRE   DS    PL6                 TOTAL CREDITS                                
X#TDEB   DS    PL6                 TOTAL DEBITS                                 
X#THRS   DS    PL6                 TOTAL HOURS                                  
X#CEAMBR DS    PL3                                                              
X#CERED  DS    PL3                                                              
                                                                                
X#CURTA  DS    0PL16                                                            
X#PASSTA DS    XL2                                                              
X#PASEND DS    XL2                                                              
X#ACT    DS    CL12                                                             
                                                                                
X#UFCMQ  EQU   10                                                               
X#UFLS   DS    (X#UFCMQ)CL(UFSDATMX)                                            
X#UFLQ   EQU   *-X#UFLS                                                         
*                                                                               
X#MEDLL  DS    CL50                                                             
***********************************************************************         
* REQUEST IN/OUT DEFINITION IN STORAGE                                *         
***********************************************************************         
                                                                                
RQ_VALS  DS    0X                  ** REQUEST VALUES                            
RQ_TYPE  DS    XL1                 - REQUEST TYPE                               
RQ_DATA  DS    0XL1                - REQUEST DATA                               
         ORG   RQ_DATA                                                          
* JOB AUDIT AND APPROVER VALUES                                                 
RQ_JAACT DS    CL12                                                             
RQ_JAOFF DS    CL2                                                              
RQ_JAUL  DS    CL2                                                              
         ORG   RQ_DATA                                                          
* USER FIELD VALUES                                                             
RQ_UFCLI DS    CL5                 CLIENT                                       
*&&UK                                                                           
RQ_UFPRO DS    CL2                 PRODUCT                                      
*&&                                                                             
*&&US                                                                           
RQ_UFPRO DS    CL3                 PRODUCT                                      
*&&                                                                             
RQ_UFJOB DS    CL7                 JOB                                          
RQ_UFOFF DS    CL2                 OFFICE                                       
RQ_UFODT DS    CL8                 JOB OPEN DATE                                
         ORG   RQ_DATA                                                          
* JOB LIST AND SEARCH VALUES                                                    
RQ_JDCLC DS    CL5                 - JOB LIST/SEARCH: CLIENT CODE               
RQ_JDCEN DS    CL5                 - Client Range end                           
RQ_JDLST DS    CL1                 - JOB LIST/SEARCH: INCL LOCKED Y/N/O         
RQ_ONLYQ EQU   C'O'                                                             
RQ_JDCST DS    CL1                 - JOB LIST/SEARCH: SHOW CLOSED Y/N/B         
RQ_BOTHQ EQU   C'B'                                                             
RQ_JDF1V DS    CL1                 - JOB LIST/SEARCH: FILTER 1 VALUE            
RQ_JDF2V DS    CL1                 - JOB LIST/SEARCH: FILTER 2 VALUE            
RQ_JDF3V DS    CL1                 - JOB LIST/SEARCH: FILTER 3 VALUE            
RQ_JDF4V DS    CL1                 - JOB LIST/SEARCH: FILTER 4 VALUE            
RQ_JDF5V DS    CL1                 - JOB LIST/SEARCH: FILTER 5 VALUE            
RQ_JDMIN DS    X                   - JOB LIST/SEARCH: MEDIA CODE ARRAY          
RQ_JDMAD DS    AL3                                                              
*&&UK                                                                           
RQ_JDPRO DS    CL2                 - JOB LIST/SEARCH: PRODUCT FILTER            
*&&                                                                             
*&&US                                                                           
RQ_JDPRO DS    CL3                 - JOB LIST/SEARCH: PRODUCT FILTER            
*&&                                                                             
RQ_JDOPN DS    CL8                 - JOB LIST/SEARCH: OPEN DATE START           
RQ_JDOPX DS    CL8                 - JOB LIST/SEARCH: OPEN DATE END             
RQ_JDCLO DS    CL8                 - JOB LIST/SEARCH: CLOSE DATE START          
RQ_JDCLX DS    CL8                 - JOB LIST/SEARCH: CLOSE DATE END            
RQ_JDNIN DS    X                   - JOB LIST/SEARCH: NAME ARRAY                
RQ_JDNAD DS    AL3                                                              
RQ_JDUF1 DS    CL30                - JOB LIST/SEARCH: USER FIELD 1              
RQ_JDUF2 DS    CL30                - JOB LIST/SEARCH: USER FIELD 2              
RQ_JDUF3 DS    CL30                - JOB LIST/SEARCH: USER FIELD 3              
RQ_JDUF4 DS    CL30                - JOB LIST/SEARCH: USER FIELD 4              
RQ_JDUF5 DS    CL30                - JOB LIST/SEARCH: USER FIELD 5              
RQ_JDUF6 DS    CL30                - JOB LIST/SEARCH: USER FIELD 6              
RQ_JDUF7 DS    CL30                - JOB LIST/SEARCH: USER FIELD 7              
RQ_JDUF8 DS    CL30                - JOB LIST/SEARCH: USER FIELD 8              
RQ_JDUF9 DS    CL30                - JOB LIST/SEARCH: USER FIELD 9              
RQ_JDUF0 DS    CL30                - JOB LIST/SEARCH: USER FIELD 10             
RQ_JDDRA DS    CL1                 - JOB LIST/SEARCH: DRAFT ACCOUNTS            
RQ_JDUIN DS    X                   - JOB LIST/SEARCH: Aura user fields          
RQ_JDUAD DS    AL3                                    headers and data          
RQ_JDUMX EQU   3                                                                
UFSDATMX EQU   30                                                               
UFSTYPEL EQU   1                                                                
RQ_USFDA EQU   C'D'                  - DATE TYPE                                
RQ_USFAL EQU   C'L'                  - ALPHANUMERIC CHARACTERS                  
RQ_USFNM EQU   C'N'                  - NUMERIC CHARACTERS                       
                                                                                
RQ_JDSIN DS    X                   - JOB LIST/SEARCH: STATUS ARRAY              
RQ_JDSAD DS    AL3                                                              
SUBMITED EQU   C'S'                                                             
APPROVED EQU   C'A'                                                             
REJECTED EQU   C'R'                                                             
MWAITING EQU   C'M'                                                             
                                                                                
RQ_JDSPC DS    CL8                 - JOB LIST/SEARCH: SUBMITTER CODE            
RQ_JDAPC DS    CL8                 - JOB LIST/SEARCH: APPROVER CODE             
RQ_JDRPC DS    CL8                 - JOB LIST/SEARCH: REJECTER CODE             
                                                                                
RQ_JDEPC DS    CL1                 CHARGES/ORDERS/ESTIMATES: Y/N                
                                                                                
RQ_JDTYP DS    CL1                 - JOB LIST/SEARCH: NEW TYPE                  
RQ_JDTNQ EQU   X'40'                 - OLD REQUEST                              
RQ_JDT1Q EQU   C'1'                  - USER APPROVED (BY STATUS)                
RQ_JDT2Q EQU   C'2'                  - USER REJECTED (BY STATUS)                
RQ_JDT3Q EQU   C'3'                  - USER NEEDS TO APPROVE (STATUS)           
RQ_JDT4Q EQU   C'4'                  - USER ADDED/=DRAFT (BY STATUS)            
RQ_JDT5Q EQU   C'5'                  - USER ADDED/=REJECTED (BY STATUS)         
RQ_JDT6Q EQU   C'6'                  - USER ADDED/=APPROVED (BY STATUS)         
RQ_JDT7Q EQU   C'7'                  - USER ASSIGNED TO JOB                     
RQ_JDGAO DS    CL1                 - GAOV CALL Y/N                              
RQ_OPENS DS    CL1                 - JOB LIST/SEARCH: OPEN FOR ESTIMAT          
RQ_OPENO DS    CL1                 - JOB LIST/SEARCH: OPEN FOR ORDERS           
RQ_OPENX DS    CL1                 - JOB LIST/SEARCH: OPEN FOR EXTERN           
RQ_OPENB DS    CL1                 - JOB LIST/SEARCH: OPEN FOR BILLING          
RQ_OPENA DS    CL1                 - JOB LIST/SEARCH: OPEN FOR ADJUST           
RQ_OPENT DS    CL1                 - JOB LIST/SEARCH: OPEN FOR TIMEST           
ALLSTATS EQU   C'A'                                                             
RQ_JDOVR DS    CL1                 - OVERRIDE LIMIT LIST                        
RQ_JDOFF DS    CL2                 - Office filter                              
RQ_JDJOB DS    CL7                 - JOB LIST/SEARCH: JOB CODE                  
RQ_JDPAY DS    CL1                 - Show Payments totals                       
RQMAXQ   EQU   *-RQ_DATA+64        <--- ADJUST FOR BIG RQ ENTRIES               
         ORG   RQ_DATA+RQMAXQ                                                   
         EJECT                                                                  
SAVEVALS DS    0X                                                               
         ORG   SAVEVALS                                                         
LM_VALS  DS    0X                 ** LINE MAN APPROVER RETURN DATA **           
LM_PID   DS    CL(L'SA0KPID)       - PID                                        
LM_FSTNM DS    CL16                - FIRST NAME                                 
LM_MIDNM DS    CL16                - MIDDLE NAME                                
LM_LSTNM DS    CL58                - LAST NAME                                  
         ORG   SAVEVALS                                                         
AL_VALS  DS    0X                  ** APPROVAL LIMITS RETURN DATA               
*L_COD   DS    CL1                 - CODE (ALIKSCAT)                            
AL_AMT   DS    PL6                 - AMOUNT                                     
AL_ATH   DS    CL2                 - N'APPROVERS, THIS LEVEL                    
AL_APV   DS    CL2                 - N'APPROVERS, PREVIOUS LEVEL                
AL_LNQ   EQU   *-AL_VALS                                                        
         ORG   SAVEVALS                                                         
                                                                                
AP_VALS  DS    0X             ABID ** APPROVER LIST RETURN DATA                 
*        'HEADER' LIST DATA: 1-N ENTRIES                                        
AP_HVALS DS    0X                                                               
AP_HLMT  DS    PL6                 - APPROVAL LIMIT                             
AP_HNAT  DS    XL1                 - N'APPROVERS REQUIRED AT THIS LVL           
AP_HNAP  DS    XL1                 - N'APPROVERS REQUIRED AT PREV LVL           
*        'DETAIL' LIST DATA: 1-N ENTRIES                                        
AP_DVALS DS    0X                                                               
AP_DPID  DS    CL8                 - APPROVER PERSON ID                         
AP_DPFN  DS    CL16                - APPROVER FIRST NAME                        
AP_DPLN  DS    CL58                - APPROVER LAST NAME                         
AP_DAPL  DS    PL6                 - APPROVAL LIMIT                             
AP_DAPT  DS    CL1                 - AGENCY/PUCHASE                             
AP_DDEF  DS    CL1                 - APPROVER IS DEFAULT 'Y'/'N'                
AP_DEMA  DS    CL52                - EMAIL ADDRESS OF APPROVER                  
AP_DLVL  DS    CL3                 - APPROVER LEVEL                             
AP_DPMN  DS    CL16                - APPROVER MIDDLE NAME                       
AP_MORT  DS    CL1                 - APPROVER MATCHED AT ORDER TYPE             
AP_MOFF  DS    CL1                 - APPROVER MATCHED AT OFFICE                 
AP_MDPT  DS    CL1                 - APPROVER MATCHED AT DEPT                   
AP_METY  DS    CL1                 - APPROVER MATCHED AT ETYPE                  
AP_MSUP  DS    CL1                 - APPROVER MATCHED AT SUPPLIER               
AP_M2PA  DS    CL1                 - APPROVER MATCHED AT 2P ACCOUNT             
AP_MJOB  DS    CL1                 - APPROVER MATCHED AT JOB                    
AP_MPRO  DS    CL1                 - APPROVER MATCHED AT PRODUCT                
AP_MCLI  DS    CL1                 - APPROVER MATCHED AT CLIENT                 
AP_MMED  DS    CL1                 - APPROVER MATCHED AT MEDIA                  
AP_ORCK  DS    CL1                 - ORDER ESTIMATE CHECK PERFORMED             
AP_LNDQ  EQU   *-AP_DVALS                                                       
AP_LNQ   EQU   *-AP_VALS           ABID                                         
         ORG   SAVEVALS                                                         
JA_VALS  DS    0X                  JOB AUDIT CALL                               
JA_DATA  DS    CL200               DATA                                         
JA_LNQ   EQU   *-JA_VALS                                                        
         ORG   SAVEVALS                                                         
JP_VALS  DS    0X                  JOB APPROVER CALL                            
JP_CPC   DS    CL8                 CREATOR PERSON CODE, FIRST NAME,             
JP_CPF   DS    CL16                LAST NAME AND EMAIL ADDRESS                  
JP_CPL   DS    CL16                                                             
JP_CEM   DS    CL44                                                             
JP_LVL   DS    CL1                 APPROVER LEVEL                               
JP_LNQ   EQU   *-JP_VALS                                                        
         ORG   SAVEVALS                                                         
JD_VALS  DS    0X                  JOB LIST/SEARCH RETURN DATA                  
JD_LVL   DS    CL1                 APPROVER LEVEL                               
JD_CLI   DS    CL5                 client code                                  
*&&UK                                                                           
JD_PRO   DS    CL2                 product code                                 
*&&                                                                             
*&&US                                                                           
JD_PRO   DS    CL3                 product code                                 
*&&                                                                             
JD_JOB   DS    CL7                 job code                                     
JD_MED   DS    CL1                 media code                                   
JD_MEN   DS    CL12                media name                                   
JD_OFF   DS    CL2                 office code                                  
JD_CUR   DS    CL3                 currency                                     
JD_STA   DS    CL6                 status                                       
JD_LAD   DS    XL3                 last activity date                           
JD_LAX   DS    XL2                 last activity binary pid code                
JD_LAC   DS    CL8                 last activity person code                    
JD_LAF   DS    CL16                                                             
JD_LAM   DS    CL16                                                             
JD_LAL   DS    CL58                                                             
JD_EPC   DS    PL6                 estimate % committed (%)                     
JD_COL   DS    CL1                 colour code                                  
JD_COLWQ EQU   C'1'                (1=white, 2=green, 3=amber, 4=red)           
JD_COLGQ EQU   C'2'                                                             
JD_COLAQ EQU   C'3'                                                             
JD_COLRQ EQU   C'4'                                                             
JD_CCLSE DS    CL1                 Job can be closed Y/N?                       
JD_CDELT DS    CL1                 Job can be deleted Y/N?                      
JD_AUTO  DS    CL1                 Auto number is use Y/N?                      
JD_DRFT  DS    CL1                 Draft jobs Y/N/D?                            
JD_ESDR  DS    CL1                 Estimates allowed to use draft jobs?         
JD_AUFH1 DS    CL12                UserField Header (1, Aura)                   
JD_AUFD1 DS    CL30                UserField Data (1, Aura)                     
JD_AUFH2 DS    CL12                UserField Header (2, Aura)                   
JD_AUFD2 DS    CL30                UserField Data (2, Aura)                     
JD_AUFH3 DS    CL12                UserField Header (3, Aura)                   
JD_AUFD3 DS    CL30                UserField Data (3, Aura)                     
JD_NETBL DS    PL6                 Net billed                                   
JD_ACTLS DS    PL6                 Actuals                                      
JD_ORDRS DS    PL6                 Orders                                       
JD_ESTMD DS    PL6                 Estimated net amount                         
JD_ESHRS DS    PL6                 Estimated hours                              
JD_ACHRS DS    PL6                 Actual hours                                 
JD_PAYMT DS    PL6                 Payments                                     
JD_AMBR  DS    PL3                 Estimate % for amber                         
JD_RED   DS    PL3                 Estimate % for red                           
JD_LNQ   EQU   *-JD_VALS                                                        
JD_CLN   DS    CL36                client name                                  
JD_PRN   DS    CL36                product name                                 
JD_LNQ1  EQU   *-JD_VALS                                                        
                                                                                
ES_BUFF  DS    XL500               Buffer area for estimates                    
LIACBLK  DS    XL(3*ONEK)          Block for limit list                         
SAVEVARL EQU   *-SAVEVAR                                                        
         ORG   SAVED+(L'SVSERVER-(*-SAVED))  Online SAVED overflow trap         
         EJECT                                                                  
*                                                                               
         SPACE 1                                                                
***********************************************************************         
* INCLUDED DSECTS                                                     *         
***********************************************************************         
         PRINT OFF                                                              
       ++INCLUDE ACBRAWRKD                                                      
         PRINT ON                                                               
                                                                                
SRCRECD  DSECT                                                                  
         ORG   SRCKSUB+L'SRCKSUB                                                
SRCKREST DS    XL12                                                             
         ORG   SRCKWRD1                                                         
SRCKFNM  DS    CL1                                                              
SRCKRNM  DS    XL9                                                              
                                                                                
ACTRECD  DSECT                                                                  
         ORG   ACTKACT                                                          
ACTKCLI  DS    CL5                                                              
ACTKREM  DS    CL7                                                              
         ORG   ACTKACT+L'ACTKACT                                                
ACTREST  DS    XL(L'ACTKEY-ACTKEND)                                             
***                                                                             
APLTABD  DSECT                                                                  
APLTSTAT DS    CL1                                                              
APLTORT1 EQU   X'80'               Order type - expense prod inter arts         
APLTOFFC EQU   X'40'               Office                                       
APLTETYP EQU   X'20'               Expenditure type                             
APLTCLI  EQU   X'10'               Client                                       
APLTORT2 EQU   X'08'               Order type - client or non client            
APLTABL  EQU   *-APLTABD           length of entry                              
*                                                                               
APLVLTD  DSECT                                                                  
APLVLVAL DS    PL6                 Value of approval level                      
APLVLNUM DS    XL1                 Number of approvers at this level            
APLVLPRV DS    XL1                 Number of previous levels                    
APLVLFAP DS    CL1                 Final approval required                      
APLVLHLV DS    CL1                 High level approvers for lower lvls          
APLVLLVL DS    H                   Level of approver so far                     
APLVLTBL EQU   *-APLVLTD           length of entry                              
*                                                                               
APETABD  DSECT                                                                  
APERAPL  DS    PL6                 Approval limit                               
APERPID  DS    CL8                 Approver PID                                 
APEDUPL  EQU   *-APETABD           Duplicate length check                       
APERAPL2 DS    PL6                 Approval limit - used for sort               
APERLVL  DS    CL3                 Approval level                               
APERPLN  DS    CL58                Approver last name                           
APERPFN  DS    CL16                Approver first name                          
APERPMN  DS    CL16                Approver middle name                         
APEKEYL  EQU   *-APETABD           Key length                                   
APESRTL  EQU   *-APERAPL2          Sort length                                  
APEREMA  DS    CL52                Email of approver                            
APERAPT  DS    CL1                 Agency or purchasing approver                
APERDEF  DS    CL1                 Default approver                             
APEMORT  DS    CL1                 Matched at order type                        
APEMOFF  DS    CL1                 Matched at office                            
APEMDPT  DS    CL1                 Matched at department                        
APEMETY  DS    CL1                 Matched at expenditure type                  
APEMSUP  DS    CL1                 Matched at supplier                          
APEM2PA  DS    CL1                 Matched at 2P account                        
APEMJOB  DS    CL1                 Matched at job                               
APEMPRO  DS    CL1                 Matched at product                           
APEMCLI  DS    CL1                 Matched at client                            
APEMMED  DS    CL1                 Matched at media                             
APETABL  EQU   *-APETABD                                                        
*                                                                               
APR1TABD  DSECT                                                                 
APRTSTAT DS    CL1                 Status byte 1                                
APRTORT1 EQU   X'80'               Order type - expense prod inter arts         
APRTORT2 EQU   X'40'               Order type - client or non client            
APRTOFFC EQU   X'20'               Office                                       
APRTDEPT EQU   X'10'               Department                                   
APRTETYP EQU   X'08'               Expenditure type                             
APRTCLI  EQU   X'04'               Client                                       
APRTPRO  EQU   X'02'               Product                                      
APRTJOB  EQU   X'01'               Job                                          
APRTSTA2 DS    XL1                 Status byte 2                                
APRTMED  EQU   X'80'               Media                                        
APRTSUP  EQU   X'40'               Supplier                                     
APRT2PA  EQU   X'20'               2P account                                   
APRT2PE  EQU   X'10'               1R person level                              
APRT2SD  EQU   X'08'               1R sub department level                      
APRT2DE  EQU   X'04'               1R department level                          
APRT2OF  EQU   X'02'               1R office level                              
APR1TABL  EQU   *-APR1TABD         length of entry                              
         EJECT                                                                  
                                                                                
***********************************************************************         
* Optimisation buffer record layout                                   *         
***********************************************************************         
         SPACE 1                                                                
OB_D     DSECT                                                                  
                                                                                
OB_KEY   DS    CL8                 PID                                          
OB_ERROR DS    XL2                 Error number (Zero=OK)                       
*                                                                               
OB_DATA  DS    0X                                                               
OB_FSTNM DS    CL16                First name                                   
OB_MIDNM DS    CL16                Middle name                                  
OB_LSTNM DS    CL58                Last name                                    
OB_DATAL EQU   *-OB_ERROR                                                       
OB_LNQ   EQU   *-OB_D                                                           
         SPACE 1                                                                
***********************************************************************         
* Extracted 1R Acc + Rate DSECTs for Charge Rate list                 *         
***********************************************************************         
*                                                                               
EST_D    DSECT                                                                  
ESTTLEN  DS    XL2                 WORKCODE FOR ESTIMATE                        
ESTTKEY  DS    0X                                                               
ESTTWCD  DS    CL2                 WORKCODE FOR ESTIMATE                        
ESTTKYL  EQU   *-ESTTKEY                                                        
ESTTGLO  DS    CL6                 GLOBAL ESTIMATE NUMBER                       
ESTTLOC  DS    XL1                 LOCAL ESTIMATE NUMBER                        
ESTTCUR  DS    CL3                 ESTIMATE CURRENCY                            
ESTTXRT  DS    XL7                 ESTIMATE CURRENCY RATE                       
ESTTSTA  DS    XL1                 STATUS                                       
ESTTDES  DS    CL50                ESTIMATE DESCRIPTION                         
ESTTAMT  DS    PL6                 AMOUNT OF ESTIMATE                           
ESTTFCA  DS    PL6                 AMOUNT OF ESTIMATE FOREIGN CURRENCY          
ESTTALA  DS    PL6                 BILLED ALLOCATION                            
ESTTCOM  DS    PL6                 COMMISSION INCLUDED                          
ESTTCOB  DS    PL6                 COMMISSION BILLED                            
ESTTLN1Q EQU   *-EST_D             LENGTH OF ESTIMATE ENTRY MINUS BILLS         
ESTTBLN  DS    CL6                 REPEATING BILL NUMBER ENTRY                  
*                                                                               
APRTABD  DSECT                                                                  
APRSTAT  DS    XL1                 Levels to include                            
APRCLI   EQU   X'80'               Client                                       
APRPRO   EQU   X'40'               Product                                      
APRJOB   EQU   X'20'               Job                                          
APRMED   EQU   X'10'               Media                                        
APROFF   EQU   X'08'               Office                                       
APRLVL   DS    CL1                 Level of approver                            
APRTABL  EQU   *-APRTABD                                                        
*                                                                               
ELMTABD  DSECT                                                                  
ELMDATA  DS    0CL32                                                            
         DS    CL4                                                              
ELMCODE  DS    CL2                                                              
ELMDESC  DS    CL12                                                             
ELMEDIT  DS    CL8                                                              
ELMMAXL  DS    XL1                                                              
ELMSTAT  DS    XL1                                                              
         DS    CL4                                                              
ELMLNG   EQU   *-ELMDATA                                                        
***********************************************************************         
* REQTABD - This DSECT is used to search entries in REQTAB for derived*         
*           request type (X#PTYP) in program and NWCTAB entries for   *         
*           value provided in RQ_JDTYP field of input request.                  
***********************************************************************         
REQTABD  DSECT                                                                  
REQTYP   DS    CL1           - Type X#PTYP/RQ_JDTYP for record read             
REQTACTQ EQU   C'A'                - use ACTRECD                                
REQTSRCQ EQU   C'S'                - use SRCRECD                                
REQTPIDQ EQU   C'P'                - use PIDRECD                                
REQTJDTQ EQU   C'J'                - use JDTRECD                                
REQTDRAQ EQU   C'D'                - use DRAPASD                                
REQT1Q   EQU   RQ_JDT1Q            - 1 USER APPROVED (BY STATUS)                
REQT2Q   EQU   RQ_JDT2Q            - 2 USER REJECTED (BY STATUS)                
REQT3Q   EQU   RQ_JDT3Q            - 3 USER NEEDS TO APPROVE (STATUS)           
REQT4Q   EQU   RQ_JDT4Q            - 4 USER ADDED/=DRAFT (BY STATUS)            
REQT5Q   EQU   RQ_JDT5Q            - 5 USER ADDED/=REJECTED (BY STATUS)         
REQT6Q   EQU   RQ_JDT6Q            - 6 USER ADDED/=APPROVED (BY STATUS)         
REQT7Q   EQU   RQ_JDT7Q            - 7 USER ASSIGNED TO JOB                     
REQKEYD  DS    AL4           - Address of Key Driver                            
REQKEYF  DS    AL4           - Address of Key Filter                            
REQRECF  DS    AL4           - Address of Record Filter                         
REQJOBS  DS    CL1           - Job Status for New Call request                  
REQTABL  EQU   *-REQTABD                                                        
*                                                                               
***********************************************************************         
* USRTABD - This DSECT is used to mark that program has read the record         
*           till here now restart reading from next record            *         
***********************************************************************         
USRTABD  DSECT                                                                  
USRLVL   DS    XL1           - LEVEL(COMPANY,OFFICE GRP, CLIENT ETC..)          
USRMDGF  DS    XL1           - MEDIA GROUP FLAG                                 
USRMDCF  DS    XL1           - MEDIA CODE FLAG                                  
USRTABL  EQU   *-USRTABD                                                        
USRLENG  EQU   2*USRTABL                                                        
*                                                                               
***********************************************************************         
* ELES_DS                                                             *         
***********************************************************************         
ELES_DS  DSECT                                                                  
ELESDCLI DS    CL5                 Saved client code                            
ELESDCST DS    XL1                 and its name/office/saved details            
ELESDCOF DS    CL2                                                              
ELESDCLN DS    CL36                                                             
ELESDCXD DS    XL(GOXDBCLQ)                                                     
*&&UK                                                                           
ELESDPRO DS    CL2                 Saved product code                           
*&&                                                                             
*&&US                                                                           
ELESDPRO DS    CL3                                                              
*&&                                                                             
ELESDPST DS    XL1                                                              
ELESDPOF DS    CL2                 and its name/office/saved details            
ELESDPRN DS    CL36                                                             
ELESDPXD DS    XL(GOXDBCLQ)                                                     
ELESPLNQ EQU   *-ELESDPRO                                                       
***********************************************************************         
* JSBD_D                                                              *         
***********************************************************************         
JSBD_D   DSECT                                                                  
JSBDLEN  DS    XL2                 Job Search Buffered Details                  
JSBDKEY  DS    0X                                                               
JSBDTYP  DS    CL1                 Type                                         
JSBDTCQ  EQU   C'C'                - Client                                     
JSBDTPQ  EQU   C'P'                - Product                                    
JSBDTOQ  EQU   C'O'                - Office                                     
JSBDTMQ  EQU   C'M'                - Media                                      
JSBDTXQ  EQU   C'X'                - Security person hex                        
JSBDTSQ  EQU   C'S'                - Security person char                       
JSBDCOD  DS    CL12                Client/Product/Office/Media/PID              
JSBDKYL  EQU   *-JSBDKEY                                                        
JSBDATA  DS    0X                                                               
JSBDMGR  DS    0CL1                Status - or office resp. media group         
JSBDOGR  DS    0CL1                                                             
JSBDSTA  DS    XL1                                                              
JSBDOFF  DS    CL2                 Office                                       
JSBDNAM  DS    CL36                Name                                         
JSBDXDB  DS    XL(GOXDBCLQ)        GETOPT extra data block                      
JSBDLNQ  EQU   *-JSBD_D                                                         
         ORG   JSBDATA                                                          
JSBDPIX  DS    0XL2                Hex PID                                      
JSBDPID  DS    CL8                 Character PID                                
JSBDPFN  DS    CL16                First name                                   
JSBDPMN  DS    CL16                Middle name                                  
JSBDPLN  DS    CL58                Last name                                    
***********************************************************************         
* INCLUDED DSECTS                                                     *         
***********************************************************************         
OFFRECD  DSECT                                                                  
         ORG   OFFKCPY+L'OFFKCPY                                                
OFFREST  DS    XL38                                                             
*                                                                               
DESCTAB  DSECT                                                                  
DESCREC  DS    0XL202                                                           
DESCIDN  DS    XL1                                                              
DESCIDNA EQU   X'AA'                                                            
DESCLEN  DS    XL1                 DESCRIPTION LENGTH                           
DESCDSP  EQU   *-DESCTAB                                                        
DESCDATA DS    0C                  DATA STARTS FROM HERE                        
                                                                                
*                                                                               
UFSRECD  DSECT                                                                  
         ORG   UFSKOFG                                                          
UFSKREM  DS    CL37                                                             
*                                                                               
CEITABD  DSECT ,                   - CLAIM/ESTIMATES/INVOICES DSECT             
CEIPID   DS    XL2                 - PID                                        
CEIPTY   DS    XL1                 - APPROVER TYPE                              
CEILNQ   EQU   *-CEITABD                                                        
                                                                                
SPITABD  DSECT ,                   - SPLIT INVOICES DSECT                       
SPIPID   DS    XL2                 - PID                                        
SPIAPAC  DS    CL7                 - APPROVER ACCOUNT                           
SPILNQ   EQU   *-SPITABD                                                        
*                                                                               
OLISTD   DSECT                                                                  
OLISTCDE DS    CL(L'OFLPOFL)       OLIST CODE                                   
OLSTDLNQ EQU   *-OLISTD            LENGTH OF ENTRY                              
*                                                                               
GOTMKTBD DSECT                                                                  
GOTMKGOP DS    XL1                 OPT MAINT SETTING                            
GOTMKMPT DS    XL1                 INTERESTED IN EMPTY STATUSES                 
GOTMKSTA DS    XL1                 STATUSES WE ARE INTERESTED IN                
GOTMKCAS DS    XL1                 CLIENT APPROVAL STATUSES WE WANT             
GOTMKTBL EQU   *-GOTMKTBD                                                       
*                                                                               
***********************************************************************         
* Includes                                                            *         
***********************************************************************         
         SPACE 1                                                                
         PRINT   OFF                                                            
*                                                                               
*&&UK                                                                           
       ++INCLUDE GEGENCUR                                                       
*&&                                                                             
*&&US                                                                           
       ++INCLUDE ACCATCALLD                                                     
*&&                                                                             
       ++INCLUDE ACVATICAND                                                     
*                                                                               
       ++INCLUDE GEGENGEN                                                       
       ++INCLUDE GEGENFEE                                                       
       ++INCLUDE GEGENEXC                                                       
       ++INCLUDE GEGENXLI                                                       
       ++INCLUDE DDDDEQUS                                                       
       ++INCLUDE DDLANGEQUS                                                     
       ++INCLUDE DDGETRETD                                                      
       ++INCLUDE ACGOXDBLK                                                      
         PRINT ON                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'027ACBRA2D   10/14/20'                                      
         END                                                                    
