*          DATA SET ACREPRL06  AT LEVEL 212 AS OF 03/02/21                      
*PHASE ACRL06C                                                                  
*INCLUDE BINSR31                                                                
*INCLUDE DATVAL                                                                 
*INCLUDE CONVMOS                                                                
*INCLUDE PUBEDIT                                                                
*INCLUDE GETBROAD                                                               
*                                                                               
* PID  LVl DATE    COMMENTS                                                     
* ---------------------------------                                             
* SMAN 025 10NOV11 PR000122 Estimate Phase 1                                    
* SMAN 026 10NOV11 BR45416L Preserve R4 when dealing with ASJBUF1&2             
* SMAN 027 16DEC11 PR002242 UK/US merge                                         
* YNGX     30NOV11 PR002414 NEW JOB DESCRIPTION KEYWORD                         
* SMAN 028 31JAN11 PR002625 Estimate currency keywords                          
* SMAN             Fixes from DCUR                                              
* JFOS 029 04DEC12 <PR003402> Estimated time keywords (B33)                     
* JFOS 164 15MAY13 Handle new format Order STCEL (B34)                          
* JFOS 165 14AUG13 Fix from US                                                  
* JFOS 166 22AUG13 <DSPCA110> New Cred/Expense keywords, InvSts filter          
* JFOS 167 11FEB14 <DSPCA411> New TSERNO keyword                                
* JFOS     28APR14 <DSPCA359> New Payee BACS keywords                           
* JFOS     30JUN14 <DSPCA1044> Drop '<nl>' from long narrative                  
* JFOS     02JUL14 <DSPCA1040> Lang soft 'Order=' literal in Narrative          
* MPEN 168 17JUL14 <DSPCA1070> Read MXPELD for serial number                    
* MPEN 169 21JUL14 <DSPCA1081> Additional fix for above if mult fftels          
* YNGX 170 30SEP14 <PCA01185> NEW KEYWORD TYMAP()                               
* YNGX 171 30OCT14 <PCA01322> New kywds AGEFAG,REFSER,DRBILF,TFDR,TFDRF         
* YNGX 172 02DEC14 PCA01326 keywords OG & OGN for other report types            
* YNGX 173 05JAN15 PCA01484 MAKE KEYWORD SOURAC AVALIABLE FOR DEBTOR            
* YNGX 174 27JAN15 PCA01501 NEW KEYWORDS BGA,BGM,BGACC,COLINF,CATNAM            
* YNGX 175 13MAY15 PCA01764 CHANGE TYMAP KYW TO RETURN F INSTEAD OF D           
* ***  176/7 ***15 MERGED WITH US *************************************         
* JFOS 178 27MAY15 PCA01445 Handle foreign currency in calculated cols          
* YNGX     21DEC15 PCA02137 NEW ITEM DESCRIPTION KEYWORD                        
* YNGX     02FEB16 PCA02249 NEW KEYWORDS FOR NEW GETPAID'S EXTRACT              
* YNGX 179 11MAR16 PCA02351 FIX BUG ON REFSER                                   
* YNGX 180 21MAR16 PCA02359 MERGE WITH US VERSION                               
* YNGX 181 05APR16 PCA02375 NEW KEYWORD CLIENT ADDED IN LAST MONTH              
* YNGX 182 23MAY16 PCA02433 NEW KEYWORD MEMONR & RCTNUM (GRPMUK)                
* MPEN 183 01FEB17 <ITMF-11633> Initialise TSAR correctly                       
* YNGX 184 16MAY17 PCA02599 GroupM Get Paid project 2017.2                      
* MPEN 185 18JUL17 RD015589 Extend timeline narrative                           
* NRAK 186 30Aug17 <SPEC-15683> handle long narr in PARSE                       
* MPEN 188 08Sep17 <SPEC-15873> Fix NAR keyword issue                           
* GHOA 189 05Oct17 <SPEC-15538> TY12 (PO) MOA reports differently               
* GHOA 190 25Oct17 SPEC-6974 POA Keyword not working as expected                
* GHOA 191 08NOV17 SPEC-17083 SCRIBE/PAY keyword ETYPE/ETYPN                    
* SGAV 192 30NOV17 <SPEC14476> Scribe does not report 0 hour timesheets         
* GHOA 193 29Jan18 SPEC-20151 Not started / created Missing Timesheets          
* GHOA 194 07Mar18 SPEC-16611 SCRIBE/RCV keyword AGYMF                          
*          27Apr18 Fix NARR keyword bug found in regression testing             
* GHOA 195 22Jun18 SPEC-25306 Remove fix NARR keyword, PER abends               
* GHOA 196 28Jun18 SPEC-24461 support AGYMF for SCRIBE/CASH                     
* GHOA 197 28Jun18 SPEC-20151 Missing Timesheets for S,I,R, or P                
* GHOA 199 10Jul18 SPEC-25631 Error due to keyword POA                          
* JSAY 201 23Nov18 SPEC-23449 Print PID of the Submitter on POAUTH              
* VGUP 203 12Mar19 SPEC-33240 Fixed issue with approver PID                     
* JSAY 204 23Jun19 SPEC-33734 Relink to include new ACREPRLWRK                  
* VGUP 205 31MAR20 SPEC-38613 Fix for POAMTO keyword                            
* VGUP 205 03MAR20 SPEC-38613 Fix media name for keywork MCN                    
* ASAX 207 06Jun20 SPEC-38613 Fix Bug of SPEC-38613                             
* GHOA 208 22Jun20 SPEC-28298 New Setup: Cairnes Oniel for CSI                  
* GHOA 209 20Oct20 SPEC-50200 Innocean QST posting is incorrect                 
* GHOA 210 23Jul20 SPEC-46231 PO keyword issues                                 
*          25Aug20 SPEC-46379 JAC-A not populating from Cli2                    
* GHOA 211 04Nov20 SPEC-46231 PO keyword issues (commented out)                 
* GHOA 212 08Feb21 SPEC-53694 AGYMF not working for Media and Income            
*                                                                               
ACRL06   CSECT                                                                  
         TITLE 'SCRIBE ROUTINES'                                                
         PRINT NOGEN                                                            
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
         NMOD1 0,**ROUT**                                                       
         L     RC,RLBASEC                                                       
*                                                                               
         CLI   MODE,RUNFRST                                                     
         BE    *+6                                                              
         DC    H'00'                                                            
*                                                                               
         TM    DDLNKIND,DDLNKINT   DDLINK initialized ?                         
         BO    RUNFXIT                                                          
         LA    R0,ROUTTAB#         NUMBER OF ENTRIES                            
         LA    R2,ROUTTAB                                                       
RUNF10   ICM   RE,15,0(R2)                                                      
         SR    RF,RF                                                            
         ICM   RF,3,4(R2)                                                       
         AR    RF,RA                                                            
         ST    RE,0(,RF)           SAVE ROUTINE ADDRESS                         
         LA    R2,ROUTLNQ(,R2)     NEXT ENTRY                                   
         BCT   R0,RUNF10                                                        
                                                                                
         L     RE,=V(BINSRCH)                                                   
         ST    RE,BIN31                                                         
                                                                                
RUNFXIT  XMOD1                                                                  
         EJECT ,                                                                
ROUTTAB  DC    AL4(TRN2TMS),AL2(ATRN2TMS-ACRLD)                                 
ROUTLNQ  EQU   *-ROUTTAB                                                        
         DC    AL4(SEEDREC),AL2(ASEED-ACRLD)                                    
         DC    AL4(FILTER),AL2(AFILTER-ACRLD)                                   
         DC    AL4(RECORD),AL2(ARECORD-ACRLD)                                   
         DC    AL4(PUTREC),AL2(APUTREC-ACRLD)                                   
         DC    AL4(TSAR),AL2(ATSAR-ACRLD)                                       
         DC    AL4(RANKER),AL2(ARANK-ACRLD)                                     
         DC    AL4(PARSE00),AL2(PARSE-ACRLD)                                    
         DC    AL4(ESTSTATS),AL2(ESTSTAT-ACRLD)                                 
         DC    AL4(SVD2TMS),AL2(ASVD2TMS-ACRLD)                                 
         DC    AL4(POSTLOC),AL2(LOCATION-ACRLD)                                 
         DC    AL4(PROCBUD),AL2(BUDGETS-ACRLD)                                  
         DC    AL4(DEBUGER),AL2(DEBUG-ACRLD)                                    
         DC    AL4(VERTICAL),AL2(VERTPCT-ACRLD)                                 
         DC    AL4(GETPODT),AL2(GETPO-ACRLD)                                    
         DC    AL4(EVALUATE),AL2(EVAL-ACRLD)                                    
         DC    AL4(RANKWRK),AL2(RANKDCB-ACRLD)                                  
         DC    AL4(ARATES),AL2(ARATE-ACRLD)                                     
         DC    AL4(TOTALHRS),AL2(TOTLHRS-ACRLD)                                 
         DC    AL4(POSTTHRS),AL2(POSTTHR-ACRLD)                                 
         DC    AL4(PAYROLLS),AL2(PAYROLL-ACRLD)                                 
         DC    AL4(SETPAYT),AL2(ASETPAY-ACRLD)                                  
         DC    AL4(COLPAYR),AL2(ACOLPAYR-ACRLD)                                 
         DC    AL4(BLDLML),AL2(ABLDLML-ACRLD)                                   
         DC    AL4(RDLML),AL2(ARDLML-ACRLD)                                     
         DC    AL4(GOATSR),AL2(GOATSAR-ACRLD)                                   
         DC    AL4(GETEST),AL2(GEST-ACRLD)                                      
*&&UK*&& DC    AL4(ESXFLT),AL2(AESXFLT-ACRLD)                                   
         DC    AL4(PBKPST),AL2(APBKPST-ACRLD)                                   
ROUTTAB# EQU   (*-ROUTTAB)/ROUTLNQ                                              
         TITLE 'CREATE TMS ELEMENT FROM TRANSACTION'                            
         USING TIMELD,R4                                                        
         USING FMTRECD,R5                                                       
         USING ACRL2D,R7                                                        
TRN2TMS  NMOD1 0,**TTMS**                                                       
         L     RC,RLBASEC                                                       
         L     R7,AACRL2D                                                       
         XC    TIMELM1,TIMELM1     INPUT TYPE ELEMENT                           
         XC    TIMELM2,TIMELM2     TAX ELEMENT                                  
         XC    TIMELM3,TIMELM3     NARRATIVE ELEMENT                            
         LA    R4,TIMELM1                                                       
         ST    R4,AELMTMS1                                                      
*                                                                               
         MVI   TIMEL,TIMELQ        X'8B'                                        
         MVI   TIMLN,TIMILN1Q      LENGTH FOR NON-BILLABLE                      
         MVI   TIMETYP,TIMEINP     INPUT DETIAL                                 
         MVI   TIMTTYP,TIMTCN      CLIENT NON-BILLABLE                          
         MVC   TIMACC,SPACES                                                    
         MVC   TIMTSK,SPACES                                                    
         ZAP   TIMHRS,PKZERO                                                    
*                                                                               
         USING ACMD,R2                                                          
         L     R2,AMONACC                                                       
         MVC   TIMMOA,ACMTTMOS     MOS OF TRANSACTION                           
         DROP  R2                                                               
*                                                                               
         USING TRNRECD,R2                                                       
         L     R2,ADTRANS                                                       
         LR    R3,R2                                                            
         SH    R2,DATADISP                                                      
         MVC   TIMSEQ,TRNKSBR                                                   
         CLC   =C'1N',TRNKCUNT                                                  
         BNE   TRN2T10                                                          
         MVC   TIMACC,TRNKCUNT                                                  
         MVI   TIMTTYP,TIMTNC      NON-CLIENT                                   
*                                                                               
         USING TRNELD,R3                                                        
TRN2T10  MVC   TIMOFF,TRNOFFC                                                   
         CLI   TRNTYPE,34          34'S ARE ADJUSTMENTS                         
         BNE   *+8                                                              
         OI    TIMIND,TIMIADJ      MARK ADJUSTED                                
         ZAP   TIMAMNT,TRNAMNT                                                  
         ZAP   TRNSAMT,TRNAMNT                                                  
*                                                                               
         SR    RF,RF               ADD NARRATIVE ELEMENT                        
         IC    RF,TRNLN                                                         
         SHI   RF,(TRNLN1Q+1)                                                   
         BM    TRN2T15                                                          
         EXCLC RF,TRNNARR,SPACES                                                
         BE    TRN2T15                                                          
         LA    R4,TIMELM3                                                       
         ST    R4,AELMTMS3                                                      
         MVI   TIMEL,TIMELQ        X'8B'                                        
         MVC   TIMSEQ,TRNKSBR                                                   
         MVI   TIMETYP,TIMENAR     NARRATIVE TYPE                               
         USING COLD,R1                                                          
         USING FLTADRD,R6                                                       
         L     R1,FMTCOL                                                        
         L     RE,ASRTWRK                                                       
         AH    RE,COLDSP                                                        
         CLC   COLDD#,=AL2(AC#RSNAR)   Narr keyword?                            
         BNE   TRN2T12                                                          
         CHI   RF,(L'STCTCNAR-1)                                                
         BNH   TRN2T14                                                          
         LA    RF,L'STCTCNAR-1      MAX OUT LENGTH                              
         B     TRN2T14                                                          
         DROP  R1                                                               
*                                                                               
TRN2T12  CHI   RF,(L'TIMNARR-1)                                                 
         BNH   TRN2T14                                                          
         LA    RF,L'TIMNARR-1      MAX OUT LENGTH                               
*                                                                               
TRN2T14  EXMVC RF,TIMNARR,TRNNARR                                               
         LA    RF,TIMHLNQ+1(,RF)                                                
         STC   RF,TIMLN            ELEMENT LENGTH                               
*                                                                               
TRN2T15  LA    R4,TIMELM1          RESET                                        
         LR    R5,R3                                                            
TRN2T18  CLI   0(R5),0             END OF RECORD?                               
         BE    TRN2T80                                                          
         CLI   0(R5),PRTELQ        X'40' RATE ELEMENT                           
         BE    TRN2T20                                                          
         CLI   0(R5),SCIELQ        X'50' HOURS DATA                             
         BE    TRN2T30                                                          
         CLI   0(R5),PCIELQ        X'51' ELEMENT                                
         BE    TRN2T40                                                          
         CLI   0(R5),TRSELQ        X'60' STATUS ELEMENT                         
         BE    TRN2T50                                                          
TRN2T19  SR    R0,R0                                                            
         IC    R0,1(,R5)           NEXT ELEMENT                                 
         AR    R5,R0                                                            
         B     TRN2T18                                                          
*                                                                               
         USING PRTELD,R5                                                        
TRN2T20  CLI   TIMTTYP,TIMTNC      1N TIME                                      
         BE    TRN2T19                                                          
         MVC   TIMREFF,PRTSTRT     EFFECTIVE DATE OF RATE                       
         ZAP   TIMHRS,PRTHOUR                                                   
*&&US*&& TM    PRTSTAT,PRTSADJ                                                  
*&&US*&& BZ    *+8                                                              
*&&US*&& OI    TIMRBSTA,TIMRBADJ                                                
         MVI   TIMTTYP,TIMTCB      BILLABLE TIME                                
         MVI   TIMLN,TIMILN2Q                                                   
         MVC   TIMINC,SPACES                                                    
         ZAP   DUB,TIMHRS          HOURS                                        
         OC    PRTRATE,PRTRATE                                                  
*&&UK*&& BZ    TRN2T19                                                          
*&&US*&& BZ    TRN2T21                                                          
         ZAP   TIMRATE,PRTRATE     HOURLY RATE                                  
         MP    DUB,TIMRATE         X RATE                                       
         SRP   DUB,62,5                                                         
         ZAP   TIMAMNT,DUB                                                      
*&&UK*&& B     TRN2T19                                                          
*&&US                                                                           
TRN2T21  TM    PRTSTAT,PRTSBILQ    CLIENT BILLABLE?                             
         BO    TRN2T19                                                          
         MVI   TIMTTYP,TIMTCR      CLIENT REALIZATION                           
         TM    PRTSTAT,PRTSRTEQ                                                 
         BO    TRN2T19                                                          
         MVI   TIMTTYP,TIMTCN      CLIENT NON-BILLABLE                          
         MVI   TIMLN,TIMILN1Q                                                   
         TM    PRTSTAT,PRTSNOTQ                                                 
         BO    TRN2T19                                                          
         DC    H'00'                                                            
*&&                                                                             
         USING SCIELD,R5                                                        
TRN2T30  CLI   SCITYPE,SCITHOUR    HOURS TYPE?                                  
         BNE   TRN2T19                                                          
         ZAP   TIMHRS,SCIAMNT                                                   
         B     TRN2T19                                                          
*                                                                               
         USING PCIELD,R5                                                        
TRN2T40  CLI   TIMTTYP,TIMTNC      1N TIME                                      
         BE    TRN2T19                                                          
         MVC   TIMACC,PCICLI+1     CLI/PROD/JOB                                 
         CLI   PCILN,PCILN2Q                                                    
         BL    TRN2T19                                                          
         CLC   =C'1J',PCIPRJT+1                                                 
         BNE   TRN2T45                                                          
*                                                                               
         USING CPYELD,R6                                                        
         L     R6,ADCMPEL                                                       
         TM    CPYSTAT3,CPYSPC1C                                                
         BZ    *+8                                                              
         OI    TIMSTAT,TIMSPCC                                                  
         TM    CPYSTAT3,CPYSPCSJ                                                
         BZ    *+8                                                              
         OI    TIMSTAT,TIMSPCJ                                                  
         DROP  R6                                                               
*                                                                               
TRN2T45  MVC   TIMTSK,PCITSK       MOVE IN TASK                                 
         CLC   TIMACC+8(6),SPACES  TEST JOB FROM SJ                             
         BH    TRN2T19                                                          
         CLC   PCIPRJT+3(12),SPACES                                             
         BNH   TRN2T19                                                          
         MVC   TIMACC+2(12),PCIPRJT+3                                           
         B     TRN2T19                                                          
*                                                                               
         USING TRSELD,R5                                                        
TRN2T50  GOTO1 DATCON,DMCB,(2,TRSDATE),(1,TIMADAT)                              
         TM    TRSSTAT2,TRSSTADJ                                                
         BZ    *+8                                                              
         OI    TIMIND,TIMIADJ                                                   
         B     TRN2T19                                                          
*                                                                               
TRN2T80  EQU   *                                                                
         XMOD1                                                                  
         DROP  R4,R7                                                            
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'CREATE A SEED RECORD FOR SORT OR TSAR'                          
         USING ACTRECD,R2                                                       
         USING FMTRECD,R5                                                       
SEEDREC  NMOD1 0,**SEED**                                                       
         L     RC,RLBASEC                                                       
         STC   R1,SEEDMODE                                                      
         CLI   SEEDMODE,SEEDPOA    Additional BrandO PO approvers               
         BE    SEED02                                                           
         MVC   CURBLK1,SPACES      CLEAR FOR EVER TRANSACTION                   
         MVC   CURWKCD,SPACES                                                   
         XC    CURMMOS,CURMMOS                                                  
         XC    CURPED#,CURPED#                                                  
         XC    CURSTAT(3),CURSTAT                                               
         MVC   DFTBLK1,SPACES      CLEAR FOR NEW TRANS. SET                     
         XC    DFTMMOS,DFTMMOS                                                  
         XC    CURFCCDE,CURFCCDE                                                
         XC    AELEM77B(12),AELEM77B                                            
         XC    AELMTMS1(AELMTMSQ),AELMTMS1                                      
         XC    AELEM1A(AELEMQ),AELEM1A                                          
         XC    AELEMPO,AELEMPO                                                  
SEED02   LA    R0,1                DEFAULT TO PUT ONE RECORD ONLY               
         SR    R4,R4                                                            
         L     R2,ADACC                                                         
         MVC   CURACC,ACTKCPY                                                   
         GOTO1 AFILTER,DMCB,AFLTACC,CURACC+1,0                                  
         BNE   SEEDXIT                                                          
*                                                                               
SEED10   NI    BYTE1,TURNOFF-(X'80'+X'40')                                      
         CLI   SEEDMODE,SEEDLVL    LOWER THAN ACCOUNT LEVEL?                    
         BE    SEED12              YES,  SEED LEVELS OF REPORT                  
         CLI   SEEDMODE,SEEDPBIL   Prior billing                                
         BE    SEED15                                                           
         CLI   SEEDMODE,SEEDPEDT   Personal effective date                      
         BE    SEED700             Yes                                          
         CLI   SEEDMODE,SEED1N     Propogate 1N accounts                        
         BE    SEED20                                                           
         CLI   SEEDMODE,SEEDAGE                                                 
         BE    SEED40                                                           
         CLI   SEEDMODE,SEEDBFW                                                 
         BE    SEED50                                                           
         CLI   SEEDMODE,SEEDPOA    Additional BrandO PO approvers               
         BE    SEED60                                                           
         CLI   SEEDMODE,SEEDACC    Account level details ?                      
         BNE   SEEDXIT             No                                           
         CLI   QPROG,MANPOWER      Yes, Person Scribe ?                         
         BE    SEED600             Yes                                          
*                                                                               
SEED12   CLI   QPROG,PRODUCTION    No, Production Scribe ?                      
         BNE   *+10                No                                           
         MVC   CURSJACC,ACTKACT    Set SJ account                               
*                                                                               
         TM    FMTFLAG2,FMTALVL$   Process amounts @ the account level?         
         BO    SEED30                                                           
         B     SEED900             Just put a simple record out                 
*                                                                               
         USING BILLD,R4                                                         
SEED15   DS    0H                                                               
         MVC   CURSJACC,ACTKACT    SET SJ ACCOUNT                               
         LTR   R4,R4                                                            
         BNZ   SEED15A                                                          
         L     R4,BILLTAB          Load start of table                          
         ICM   R0,3,#TOTBILS       Number of total bills                        
         BZ    SEEDXIT                                                          
         SR    R8,R8                                                            
         ICM   R8,3,#BILLS         Number of bills                              
*                                                                               
SEED15A  LTR   R8,R8               Any bills to process ?                       
         BZ    SEEDXIT             Looked at all bills if zero                  
                                                                                
SEED15B  CLC   BILDTE,RTRNSTR                                                   
         BL    SEED15D             Bill out of date range                       
         CLC   BILDTE,RTRNEND                                                   
         BH    SEED15D             Bill out of date range                       
         CLI   BILLTY,TRNBTTOT     Total bill ?                                 
*&&US*&& BE    *+12                                                             
*&&US*&& CLI   BILLTY,TRNBTONE     One-line?                                    
         BNE   SEED15D                                                          
*&&US                                                                           
*        BE    *+12                                                             
*        TM    BILLIND,BILL100     100% of estimate bill?                       
*        BZ    SEED15D                                                          
         TM    BILLIND,BILLREV     If total bill is unbilled or the             
         BO    SEED15D             reversal total bill then skip it             
         OC    BILUDTE,BILUDTE                                                  
         BNZ   SEED15D                                                          
*&&                                                                             
         TM    DATEFLT,DATEBIL     Filtering on bill date                       
         BZ    SEED16              This is ok then                              
         CLC   BILDTE,ALTNSTR      Billing start date                           
         BL    SEED15D             Don't want this bill                         
         CLC   BILDTE,ALTNEND      Billing end date                             
         BNH   SEED16              This bill is in range                        
*                                                                               
SEED15D  AHI   R4,BILLLNQ                                                       
         BCT   R8,SEED15B                                                       
         B     SEEDXIT             Finished                                     
*                                                                               
SEED16   DS    0H                                                               
         ST    R4,ACURBIL          Save current entry BILLD                     
         MVC   CURWKCD,=C'99'      Only get here if credit                      
*        MVC   CURSUBAC,BILLCON                                                 
         GOTO1 ARECORD,DMCB,('POSTNUL',ASRTWRK),('POSTCLR',1)                   
*                                                                               
         USING COLD,R3                                                          
         USING FLTADRD,R6                                                       
         L     R3,FMTCOL                                                        
         SR    R9,R9                                                            
         IC    R9,FMT#COLS                                                      
*&&US                                                                           
SEED16A  ICM   R6,15,COLFLTS       Check if workcode type filter is             
         BZ    SEED16C             being used on any columns.                   
SEED16B  CLI   FLTFLAG,EOT         If so need to fill in workcode type          
         BE    SEED16C             and get amounts from BILLEST for             
         CLI   FLTTYPE,RFLWCTYP    %est bills.                                  
         BE    SEED16F                                                          
         AHI   R6,FLTADRLQ                                                      
         B     SEED16B                                                          
*                                                                               
SEED16C  LA    R3,COLLNQ(,R3)           Next column                             
         BCT   R9,SEED16A                                                       
         B     SEED17                                                           
*                                                                               
SEED16F  BRAS  RE,PCTBILL                                                       
         TM    BYTE1,X'80'         Did you find a %est bill?                    
         BZ    SEED17              No then proceed as usual                     
         B     SEEDXIT             Put out sort rec and get next bill           
*                                                                               
SEED17   L     R3,FMTCOL                                                        
         SR    R9,R9                                                            
         IC    R9,FMT#COLS                                                      
*&&                                                                             
SEED18   TM    COLFLAGS,COLAMT     Check columns to fill                        
         BZ    SEED19                                                           
         TM    COLFLAGS,COLJOBR    Don't process JOBBER columns                 
         BO    SEED19                                                           
         TM    COLFLAGS,COLBUD     Don't process BUDGET columns                 
         BO    SEED19                                                           
         TM    COLFLAGS,COLCALC    Don't process column cals                    
         BO    SEED19                                                           
         ICM   R6,15,COLFLTS                                                    
         BZ    SEED18D             CC=EQUAL (OK)                                
*                                                                               
SEED18A  CLI   FLTFLAG,EOT                                                      
         BE    SEED18D                                                          
         GOTO1 AFILTER,DMCB,FLTADDR,FLTDATA,0                                   
         BNE   SEED19                                                           
         AHI   R6,FLTADRLQ                                                      
         B     SEED18A                                                          
         DROP  R6                                                               
*                                                                               
SEED18D  L     RE,ASRTWRK                                                       
         AH    RE,COLDSP                                                        
         CLC   COLDD#,=AL2(AC#RSBGS)                                            
         BNE   SEED18G                                                          
         ZAP   0(PKLEN,RE),BILLPAMT     Previous billing gross $                
         AP    0(PKLEN,RE),BILLPCOM                                             
         AP    0(PKLEN,RE),BILLPCD                                              
*                                                                               
SEED18G  CLC   COLDD#,=AL2(AC#RSBNT)                                            
         BNE   SEED18H                                                          
         ZAP   0(PKLEN,RE),BILLPAMT     Previous billing net $                  
*        AP    0(PKLEN,RE),BILLPCOM                                             
*                                                                               
SEED18H  CLC   COLDD#,=AL2(AC#RSBCM)                                            
         BNE   *+10                                                             
         ZAP   0(PKLEN,RE),BILLPCOM     Previous billing commission $           
         XI    PKLEN-1(RE),X'01'      Reverse sign                              
*                                                                               
SEED19   LA    R3,COLLNQ(,R3)           Next column                             
         BCT   R9,SEED18                                                        
*                                                                               
         AHI   R4,BILLLNQ          Move to next for loop                        
         BCTR  R8,0                                                             
         B     SEED950                                                          
         DROP  R3,R4                                                            
         EJECT ,                                                                
*=====================================================================*         
* Seed 1N account data                                                          
*=====================================================================*         
         USING NONCLID,R4                                                       
SEED20   LTR   R4,R4                                                            
         BNZ   SEED22                                                           
         L     R4,ANONCLI                                                       
         ICM   R0,3,NONCLI#                                                     
         BZ    SEEDXIT             NOTHING TO SEED                              
*                                                                               
SEED22   MVC   CURSUBAC(1),RCCOMPFL                                             
         MVC   CURSUBAC+1(2),=C'1N'                                             
         MVC   CURSUBAC+3(12),NONCCODE   CURRENT SUBACCOUNT                     
         CLI   NONCFLT2,C'T'             1N ACCOUNT WITH F2="T"                 
         LA    R4,NONCLNQ(,R4)           BUMP UP BEFORE BRANCH                  
         BNE   SEED980                   JUST LOOP FOR NEXT                     
         GOTO1 AFILTER,DMCB,AFLTCTRA,CURSUBAC+1                                 
         BNE   SEED980                   JUST LOOP FOR NEXT                     
         GOTO1 SETCNTR,DMCB,CURSUBAC+1                                          
         B     SEED900             PUT TO SORTWRK AND LOOP FOR NEXT             
         DROP  R4                                                               
*                                                                               
SEED30   GOTO1 ARECORD,DMCB,('POSTNUL',ASRTWRK),('POSTCLR',1)                   
*                                                                               
         USING COLD,R3                                                          
         L     R3,FMTCOL                                                        
         SR    R1,R1                                                            
         IC    R1,FMT#COLS                                                      
SEED34   TM    COLIND3,COLALVL$    Fill in this amount ?                        
         BZ    SEED36                                                           
         L     R4,ASRTWRK                                                       
         AH    R4,COLDSP                                                        
         ZAP   0(PKLEN,R4),COLDUB  ZAP in account level amount                  
         TM    COLOPT2,COLFCPRT    Copy down feature ?                          
         BO    SEED36              Yes                                          
         ZAP   COLDUB,PKZERO       No so wipe out data                          
*                                                                               
SEED36   LA    R3,COLLNQ(,R3)                                                   
         BCT   R1,SEED34                                                        
         B     SEED950                                                          
         EJECT ,                                                                
*=====================================================================*         
*  Seed age information                                               *         
*=====================================================================*         
SEED40   MVC   CURSJACC,ACTKACT    SET SJ ACCOUNT                               
         GOTO1 ARECORD,DMCB,('POSTNUL',ASRTWRK),('POSTCLR',1)                   
*                                                                               
         L     R3,FMTCOL                                                        
         SR    R1,R1                                                            
         IC    R1,FMT#COLS                                                      
SEED44   TM    COLFLAGS,COLAMT     CHECK COLUMNS TO FILL                        
         BZ    SEED46              SKIP, NOT AN AMOUNT TYPE COLUMN              
         SR    RF,RF                                                            
         ICM   RF,1,COLAGE#        DATE PAIR IN TABLE                           
         BZ    SEED46              SKIP, NOT AN PRODUCTION AGE TYPE             
         L     R4,ASRTWRK          POINT INTO SORT RECORD ACCUMULATORS          
         AH    R4,COLDSP                                                        
*                                                                               
         USING JAIDATED,RF                                                      
         BCTR  RF,0                ADJUST FOR ARRAY INDEX NUMBER                
         MHI   RF,JAIDATEQ         DATE  PAIR ENTRY LENGTH                      
         A     RF,JBAGECOL         ADD   BASE OF TABLE                          
         CLI   COLDATES,COLMDTE    MOA   DATE TYPE?                             
         BNE   *+10                                                             
         ZAP   0(PKLEN,R4),JAISMMOA      ZAP AGED $ TO SORT REC                 
         CLI   COLDATES,COLTDTE          TRANSACTION DATE TYPE?                 
         BNE   *+10                                                             
         ZAP   0(PKLEN,R4),JAISMTXD      ZAP AGED $ TO SORT REC                 
         DROP  RF                                                               
*                                                                               
SEED46   LA    R3,COLLNQ(,R3)      CHECK NEXT COLUMN                            
         BCT   R1,SEED44                                                        
         B     SEED950                                                          
         EJECT ,                                                                
*=====================================================================*         
* Seed balance forward data                                                     
*=====================================================================*         
         USING OFARECD,R2                                                       
         USING ACMD,R4                                                          
SEED50   L     R4,AMONACC                                                       
         L     R2,ACMAOFA                                                       
         ST    R2,AOFFACC                                                       
         CLI   NEWOFF,YES                                                       
         BNE   SEED52                                                           
         MVC   CUROFF,OFAKOFF                                                   
         GOTO1 AFILTER,DMCB,AFLTOFF,CUROFF,0                                    
         BNE   SEEDXIT                                                          
         DROP  R4                                                               
*                                                                               
SEED52   GOTO1 PARSE,DMCB,GETPEEL,DUB,0,0                                       
         BNE   SEEDXIT                                                          
         GOTO1 ARECORD,DMCB,('POSTNUL',ASRTWRK),('POSTCLR',1)                   
*                                                                               
         L     R3,FMTCOL                                                        
         SR    R1,R1                                                            
         IC    R1,FMT#COLS                                                      
SEED54   BRAS  RE,GOFILT                                                        
         BNE   SEED56                                                           
         TM    COLFLAGS,COLAMT     Check columns to fill                        
         BZ    SEED56                                                           
         CLC   COLDD#,=AL2(AC#RSPE$)     Peeled dollars                         
         BNE   SEED56                                                           
         L     R4,ASRTWRK                                                       
         AH    R4,COLDSP                                                        
         ZAP   0(PKLEN,R4),DUB                                                  
SEED56   LA    R3,COLLNQ(,R3)                                                   
         BCT   R1,SEED54                                                        
         B     SEED950                                                          
         EJECT ,                                                                
*=====================================================================*         
* Seed BrandOcean purchase order approver                                       
*=====================================================================*         
         USING POD,CURPODET                                                     
SEED60   DS    0H                                                               
         TM    SPLITIND,SPLITREC   Extra sort recs for split data?              
         BZ    SEPO05              No                                           
         SR    RE,RE               Yes so point to current split record         
         LH    RE,FMT#TRNS         using RE and copy that record to             
         BCTR  RE,0                ASRTWRK                                      
         MH    RE,SRTRECLN                                                      
         A     RE,FMTSRTWK                                                      
         L     R2,ASRTWRK                                                       
         SR    RF,RF                                                            
         LH    RF,SRTRECLN                                                      
         LR    R3,RF               length of key                                
         MVCL  R2,RE                                                            
         SR    R1,R1                                                            
         ICM   R1,1,FMT#ACMS       Number of accumulators                       
         BZ    SEPO70                                                           
*****                                                                           
         TM    POSTMODE,POSTTOT    PUT RECORD OUT NO MATER WHAT                 
         BO    SEPOC                                                            
         L     RE,ASRTWRK                                                       
         LR    R3,RE               USE R3 TO POINT TO ACCUMULATORS              
         AH    R3,SRTDATLN         DISPLACEMENT TO ACCUMS                       
*                                                                               
SEPOA    OC    0(PKLEN,R3),0(R3)                                                
         BZ    SEPOB               POSSIBLE EVAL ERROR, SO SKIP                 
         CP    0(PKLEN,R3),PKZERO                                               
         BNE   SEPOC               NOT ZERO-PUT REC, ACTIVITY PRESENT           
*                                                                               
SEPOB    LA    R3,PKLEN(,R3)       BUMP TO NEXT ACCUM                           
         BCT   R1,SEPOA            LOOP THROUGH ACCUMS FOR ONE TRANSACT         
         B     SEEDXIT             No amts don't put                            
***                                                                             
SEPOC    SR    R1,R1                                                            
         ICM   R1,1,FMT#ACMS       Number of accumulators                       
         BZ    SEPO70                                                           
         L     RE,ASRTWRK                                                       
         AH    RE,SRTDATLN         POINT TO ACCUMS                              
         ZAP   0(PKLEN,RE),PKZERO  CLEAR ACCUMS                                 
         LA    RE,PKLEN(,RE)                                                    
         BCT   R1,*-10                                                          
         B     SEPO70                                                           
*                                                                               
         USING TRNRECD,R2                                                       
SEPO05   L     R2,ADTRANS                                                       
         SH    R2,DATADISP                                                      
         MVC   CURSJACC,TRNKACT    SET SJ ACCOUNT                               
         MVC   CURWKCD,TRNKWORK    SET WORKCODE                                 
         DROP  R2                                                               
*        TM    POSTATUS,POAPPD     Was this done already for this PO?           
*        BO    SEEDXIT                                                          
*                                                                               
         LH    R6,FMT#TRNS         Number of transaction so far                 
         LR    RE,R6                                                            
         BCTR  RE,0                                                             
         MH    RE,SRTRECLN                                                      
         A     RE,FMTSRTWK         A(SORTAREA CURRENT RECORD)                   
         SR    RF,RF                                                            
         ICM   RF,1,FMT#ACMS       CHECK TRANSACTIONS FOR ACTIVITY              
         BZ    SEPO30              NO ACTIVITY TO CHECK,SHOW ALL DETAIL         
         TM    POSTMODE,POSTTOT    PUT RECORD OUT NO MATER WHAT                 
         BO    SEPO30                                                           
         LR    R3,RE               USE R3 TO POINT TO ACCUMULATORS              
         AH    R3,SRTDATLN         DISPLACEMENT TO ACCUMS                       
*                                                                               
SEPO10   OC    0(PKLEN,R3),0(R3)                                                
         BZ    SEPO20              POSSIBLE EVAL ERROR, SO SKIP                 
         CP    0(PKLEN,R3),PKZERO                                               
         BNE   SEPO30              NOT ZERO-PUT REC, ACTIVITY PRESENT           
*                                                                               
SEPO20   LA    R3,PKLEN(,R3)       BUMP TO NEXT ACCUM                           
         BCT   RF,SEPO10           LOOP THROUGH ACCUMS FOR ONE TRANSACT         
         B     SEEDXIT             No amts don't put                            
*                                                                               
                                                                                
         USING TRNRECD,R2                                                       
SEPO30   L     R2,ADTRANS                                                       
         SH    R2,DATADISP                                                      
         CLC   CURWKCD,=C'**'      Type 12 PO?                                  
         BNE   SEPO40                                                           
         CLC   TRNKREF,PO#         Match PO number?                             
         BNE   SEEDXIT                                                          
         B     SEPO70                                                           
*                                                                               
         USING FFNELD,R2                                                        
SEPO40   L     R2,ADTRANS                                                       
SEPO50   CLI   0(R2),EOR           End of record                                
         BE    SEEDXIT             Not related to a purchase order              
         CLI   0(R2),FFNELQ        X'25' Free form number element               
         BE    SEPO60                                                           
         SR    R1,R1                                                            
         IC    R1,1(,R2)                                                        
         AR    R2,R1                                                            
         B     SEPO50                                                           
*                                                                               
SEPO60   CLC   FFNONUM,PO#         Matches the current PO?                      
         BNE   SEEDXIT             No                                           
         DROP  R2                                                               
                                                                                
SEPO70   MVI   POBYTE1,4            3 max additional approver info              
         MVI   POBYTE2,C'N'                                                     
         LA    R2,POAUDI           Multiple audit rec info entries              
         USING POAUDI,R2                                                        
         TM    POSTATUS,POBRO      BrandOcean PO?                               
         BZ    SEEDXIT             No                                           
         TM    DATEFLT2,DATETRM    Alt type E-for prod means po due dte         
         BZ    SEPO80                                                           
         CLC   PODUE,SPACES        If no due date skip to next                  
         BNH   SEEDXIT                                                          
         CLC   ALTNEND,PODUE       Alternate end date                           
         BL    SEEDXIT                                                          
         CLC   ALTNSTR,PODUE       Alternate start date                         
         BH    SEEDXIT                                                          
SEPO80   CLI   POBYTE2,C'Y'        Did we already skip the first entry          
         BE    SEPO90              that was processed in the PARSE rtn?         
         MVI   POBYTE2,C'Y'        No so set flag and skip                      
         AHI   R2,POAUDILQ                                                      
         ZIC   R1,POBYTE1                                                       
         SHI   R1,1                                                             
         STC   R1,POBYTE1                                                       
         LTR   R1,R1                                                            
         BNZ   SEPO80                                                           
         B     SEEDXIT                                                          
*                                                                               
         USING COLD,R3                                                          
SEPO90   OI    POSTATUS,POAPPD         Set bit to say this is done              
         OC    0(POAUDILQ,R2),0(R2)    If blank then no more approvers          
         BZ    SEEDXIT                                                          
         TM    SPLITIND,SPLITREC   Extra sort recs for split data?              
         BO    SEPO92              Yes don't go to record                       
         GOTO1 ARECORD,DMCB,('POSTNUL',ASRTWRK),('POSTCLR',1)                   
*                                                                               
SEPO92   DS    0H                                                               
*&&US                                                                           
         L     R3,FMTCOL                                                        
         SR    R1,R1                                                            
         IC    R1,FMT#COLS                                                      
*                                                                               
SEPO100  CLC   COLDD#,=AL2(AC#RSPOA)   POA keyword?                             
         BNE   SEPO130                                                          
         L     R4,ASRTWRK                                                       
         AH    R4,COLDSP                                                        
         MVC   0(L'POBPID,R4),POBPID   Fill in approver in sort rec key         
*                                                                               
         USING ROWD,RE                                                          
         L     RE,FMTROW               And also fill it in in sort rec          
         ZIC   R0,FMT#ROWS             data portion but need to get the         
SEPO110  CLC   ROWDD#,=AL2(AC#RSPOA)   displacement and length from the         
         BNE   SEPO120                 row table                                
         SR    RF,RF                                                            
         ICM   RF,1,ROWDASZ                                                     
         BZ    SEEPONX                                                          
         L     R4,ASRTWRK                                                       
         AH    R4,ROWDADSP                                                      
         SHI   RF,1                                                             
         BM    SEEPONX                                                          
         EXMVC RF,0(R4),POBPID                                                  
         B     SEEPONX                                                          
SEPO120  AHI   RE,ROWLNQ                                                        
         BCT   R0,SEPO110                                                       
         B     SEEPONX                                                          
         DROP  RE                                                               
*                                                                               
SEPO130  CLC   COLDD#,=AL2(AC#RSPAD)   POAD keyword?                            
         BNE   SEPO140                                                          
         L     R4,ASRTWRK                                                       
         AH    R4,COLDSP                                                        
         MVC   0(L'POBDATE,R4),POBDATE  Fill in apprvr date in sort rec         
*                                                                               
SEPO140  CLC   COLDD#,=AL2(AC#RSPP)    POP keyword?                             
         BNE   SEPO150                                                          
         L     R4,ASRTWRK                                                       
         AH    R4,COLDSP                                                        
         MVC   0(L'POPPR,R4),POPPR      Fill in preparer pid in sort            
*                                                                               
SEPO150  CLC   COLDD#,=AL2(AC#RSPD)    POPD keyword?                            
         BNE   SEP0160                                                          
         L     R4,ASRTWRK                                                       
         AH    R4,COLDSP                                                        
         MVC   0(L'POPPRD,R4),POPPRD    Fill in preparer date in sort           
*                                                                               
SEP0160  DS    0H                                                               
*&&DO                                                                           
SEP0160  CLC   COLDD#,=AL2(AC#RSPOS)   POSUB keyword?                           
         BNE   SEEPONX                                                          
         L     R4,ASRTWRK                                                       
         AH    R4,COLDSP                                                        
         MVC   0(L'POSPID,R4),POSPID   Fill in submittr in sort rec key         
*&&                                                                             
SEEPONX  LA    R3,COLLNQ(,R3)                                                   
         BCT   R1,SEPO100                                                       
*&&                                                                             
         USING RECXD,RE                                                         
         L     RE,ASRTWRK                                                       
         AH    RE,SRTKEYXT                                                      
*        NI    RECIND,TURNOFF-RECMRGE   This is on becasue of PROCACC           
         OI    RECIND,RECKEEP           Don't drop this record later            
         GOTO1 APUTREC,DMCB,ASRTWRK,1                                           
         DROP  RE                                                               
*                                                                               
         AHI   R2,POAUDILQ                                                      
         ZIC   R1,POBYTE1                                                       
         SHI   R1,1                                                             
         STC   R1,POBYTE1                                                       
         LTR   R1,R1                                                            
         BNZ   SEPO80                                                           
         B     SEEDXIT                                                          
*                                                                               
POBYTE1  DS    XL1                                                              
POBYTE2  DS    XL1                                                              
*                                                                               
*=====================================================================*         
*  Process 1R account/payroll history data                            *         
*=====================================================================*         
SEED600  LA    R0,1                Set for only one pass                        
         TM    PHISIND,PHISON      Process Payroll history data ?               
         BZ    SEED610             No, other data                               
         SR    RF,RF                                                            
         LA    RE,FMT#PAYR         # of payroll rate                            
         CLC   FMT#PAYR,FMT#PAY$   Which is greater                             
         BH    *+8                                                              
         LA    RE,FMT#PAY$         # of payroll amounts                         
         ICM   RF,1,0(RE)          Yes, so any elements to process ?            
         BZ    SEED610             No, so one pass only                         
         LR    R0,RF                                                            
         XC    MOADTE,MOADTE                                                    
         XC    TRANDTE,TRANDTE                                                  
         GOTOR ASETPAY,1                                                        
*                                  Build Key/Data of sort record                
SEED610  GOTO1 ARECORD,DMCB,('POSTNUL',ASRTWRK),('POSTCLR',1)                   
*                                                                               
         L     R3,FMTCOL           Fill in certain column data                  
         SR    R7,R7                                                            
         ICM   R7,1,FMT#COLS       Number of columns to work on                 
         BZ    SEED950             No accums to work on                         
*                                                                               
SEED620  TM    COLFLAGS,COLAMT     Check columns to fill                        
         BZ    SEED630                                                          
         TM    COLFLAGS,COLCALC    Column calculation ?                         
         BO    SEED630             Yes, so skip                                 
         L     R4,ASRTWRK          Start of sort record                         
         AH    R4,COLDSP           Point to accumnulator position               
         TM    COLFLAGS,COLBUD     Is it a budgeted column ?                    
         BO    SEED630             Budget cols are not processed here           
         TM    COLIND1,COLPAY$     Payroll history keyword                      
         BZ    SEED626             No, so fill in check if MTS ?                
*        XC    MOADTE,MOADTE                                                    
*        TM    PHISIND,PHISMOA     Reporting by MOA ?                           
*        BZ    SEED624                                                          
*        CLC   TEMPMOS,COLEND      TEMPMOS is set in SETPAY                     
*        BH    SEED630                                                          
*        CLC   TEMPMOS,COLSTART                                                 
*        BL    SEED630                                                          
*                                                                               
         USING KYWD,R6                                                          
SEED624  ST    R3,ACURCOL                                                       
         L     R6,COLINDEX                                                      
         ZAP   PACKAMT,PKZERO                                                   
         SR    RE,RE                                                            
         ICM   RE,3,KYWPRSE                                                     
         A     RE,PRSBASE                                                       
         GOTO1 PARSE,DMCB,(RE),PACKAMT,0,(R6)                                   
         ZAP   0(PKLEN,R4),PACKAMT                                              
         B     SEED630                                                          
         DROP  R6                                                               
*                                                                               
SEED626  CLC   COLDD#,=AL2(AC#RSMTS)                                            
         BNE   *+10                                                             
         ZAP   0(PKLEN,R4),COLTOMTS      Put MTS# into column                   
*                                                                               
         TM    COLIND1,COLSHRS+COLEHRS                                          
         BZ    *+10                                                             
         ZAP   0(PKLEN,R4),COLHOURS                                             
*                                                                               
SEED630  LA    R3,COLLNQ(,R3)      Bump up to next column                       
         BRCT  R7,SEED620          Loop for # of columns                        
                                                                                
         GOTO1 APUTREC,DMCB,ASRTWRK,1                                           
                                                                                
         LA    RF,MAXDELEL         Elements to mark deleted                     
         L     RE,FMTDELEL         Delete element pool                          
SEED640  ICM   R4,15,0(RE)         R4 = A(ELEMENT TO MARK)                      
         BZ    SEED650             None left to mark, so process                
         MVI   0(R4),X'FF'         Mark deleted                                 
         XC    0(4,RE),0(RE)       Clear entry                                  
         LA    RE,4(,RE)           Next element address stored                  
         BCT   RF,SEED640          Check next                                   
                                                                                
SEED650  TM    PHISIND,PHISON                                                   
         BZ    SEED652             Allow only one pass                          
         GOTOR ASETPAY,0                                                        
         OI    ACTIVITY,ACTPAYR    Processed payroll data                       
                                                                                
SEED652  BRCT  R0,SEED610          Loop unitl payroll elem processed            
         B     SEEDXIT                                                          
         DROP  R3                                                               
         EJECT ,                                                                
*=====================================================================*         
*  Process at PROCACC special PE dates, personal effective dates      *         
*=====================================================================*         
         USING FFTELD,R3                                                        
SEED700  L     R3,ADACC                                                         
         CLI   FMTNUM,1                                                         
         BNH   SEED710                                                          
         MVI   ELCODE,X'FE'        Get ones we marked from last time            
         BRAS  RE,GETEL                                                         
SEED705  BNE   SEED710                                                          
         MVI   FFTEL,FFTELQ        Restore element                              
         BRAS  RE,NEXTEL                                                        
         B     SEED705                                                          
                                                                                
SEED710  L     R3,ADACC                                                         
         MVI   ELCODE,FFTELQ       X'DB'                                        
         BRAS  RE,GETEL                                                         
SEED720  BNE   SEEDXIT             None to process                              
         CLI   FFTTYPE,FFTTFEER    FEE report inclusion 221                     
         BE    SEED730             Found                                        
         BRAS  RE,NEXTEL                                                        
         B     SEED720                                                          
                                                                                
SEED730  GOTO1 ARECORD,DMCB,('POSTNUL',ASRTWRK),('POSTCLR',1)                   
                                                                                
         USING RECXD,RE                                                         
         L     RE,ASRTWRK                                                       
         AH    RE,SRTKEYXT                                                      
         NI    RECIND,TURNOFF-RECMRGE   This is on becasue of PROCACC           
         OI    RECIND,RECKEEP           Don't drop this record later            
         TM    DDLNKIND,DDLNKGBL                                                
         BZ    *+10                                                             
         MVC   RECOFC,LMTSECOF                                                  
         DROP  RE                                                               
                                                                                
         GOTO1 APUTREC,DMCB,ASRTWRK,1                                           
         MVI   FFTEL,X'FE'         Mark as FE's                                 
         B     SEED710             Process next                                 
         DROP  R3                                                               
         EJECT ,                                                                
*=====================================================================*         
*  Process a generic seeded record                                    *         
*=====================================================================*         
SEED900  GOTO1 ARECORD,DMCB,('POSTNUL',ASRTWRK),('POSTCLR',1)                   
                                                                                
SEED950  DS    0H                                                               
*&&US                                                                           
         TM    BYTE1,X'80'         Special code done for %est bills?            
         BO    SEED980             Yes so already put out sort rec              
*&&                                                                             
         SR    RF,RF                                                            
         ICM   RF,3,FMTFCOL        DISPLACEMENT TO FORCED COLUMN                
         BZ    SEED970                                                          
         A     RF,ASRTWRK                                                       
         ZAP   0(PKLEN,RF),PKONE                                                
                                                                                
SEED970  GOTO1 APUTREC,DMCB,ASRTWRK,1                                           
                                                                                
SEED980  BCT   R0,SEED10                                                        
                                                                                
SEEDXIT  MVI   SEEDMODE,0                                                       
         XMOD1 1                                                                
         DROP  R2,R5                                                            
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'FILTER OUT ACCOUNTS/TRANSACTIONS ETC.'                          
***********************************************************************         
*         FILTER OUT FROM PREBUILT LIST                               *         
*         PARM AL1 = X'80' +/- LIST TYPE                              *         
*                  = X'40' REQUEST CARD                               *         
*                          LENGTH OF LEVEL OF COMPARE IN LOW NILBBLE  *         
*                  = X'20' LIST OF ACCOUNT FROM ELEMENT ON RECORD     *         
*                  = X'10' IF X'20' SKIP THE UNIT/LEDGER PART         *         
*              AL3 = ADDRESS OF LIST                                  *         
*         PARM 2 = ADDRESS OF FIELD TO COMPARE TO IN LIST             *         
***********************************************************************         
         SPACE 1                                                                
FILTER   CLI   0(R1),0             Any filter set up ?                          
         BER   RE                  No, so set as ok                             
*                                                                               
FLTSTART DS    0H                                                               
         NMOD1 0,**FILT**                                                       
         L     RC,RLBASEC                                                       
         L     R6,0(,R1)           A(Table of filters)                          
         L     R3,4(,R1)           A(data to compare to)                        
*                                  ** Denominator filters **                    
         LA    RF,BZ               Process denominators only                    
         CLC   8(4,R1),=C'DENO'    Checking for denmoinator action              
         BE    *+8                 Yes                                          
         LA    RF,BO               Process non-denominators only                
         TM    0(R1),FLTDENO                                                    
         EX    RF,*+8                                                           
         B     *+8                                                              
         BC    0,FLTOK             Exit, always set flag to ok                  
*                                  Continue as usual                            
         TM    0(R1),FLTLIST       X'80' (+,-) TYPE LIST                        
         BZ    FLTLST10                                                         
         TM    0(R1),X'08'         Old stype record ?                           
         BO    *+8                                                              
         MVI   0(R1),C'S'          Mark for search                              
         GOTO1 ACLIST                                                           
         CLI   DMCB,0                                                           
         BNE   *+6                                                              
         DC    H'0'                Who knows why ?                              
*                                                                               
         CLI   DMCB,C'I'           Include                                      
         B     FLTXIT              CC Flag set                                  
*                                                                               
FLTLST10 TM    0(R1),FLTMULT       X'20' List of accounts in table              
         BO    FLTLST20                                                         
         TM    0(R1),FLTCARD                                                    
         BO    FLTEQL                                                           
         DC    H'0'                Unknown type for now                         
*                                                                               
FLTLST20 SR    RF,RF                                                            
         TM    0(R1),FLTNOUL       X'08' No unit/ledger ?                       
         BZ    *+8                 No need to cheack                            
         LA    R3,2(,R3)           Bump past unit/ledger                        
         CLI   4(R1),RFLUF         User field filter                            
         BNE   FLTLST38                                                         
*                                                                               
         USING FUFCOND,R6          Filter user field conditions                 
FLTLST21 CLI   0(R6),EOT                                                        
         BE    FLTNO               Set to not equal                             
         NI    FUF#OF,TURNOFF-FUFON                                             
         SR    R0,R0                                                            
         IC    R0,FUF#OF           Get number of sub pieces                     
         MVC   BYTE,FUFCC          Save off condition code                      
         NI    BYTE,TURNOFF-FUFAND                                              
*                                                                               
         LR    R1,R0               Find next group                              
         LR    RE,R6                                                            
         SR    RF,RF                                                            
         IC    RF,0(,RE)           Length of data                               
         LA    RE,1(RF,RE)         Add data length + 1 for length field         
         BCT   R1,*-8              R1 = Number of sub pieces                    
         ST    RE,ANEXT            Next filter group                            
*                                                                               
         IC    RF,0(,R6)           Length of data                               
         SHI   RF,FUFLNQ-1         Less header                                  
         ST    RF,FULL             RF = Length of data                          
         LA    R8,FUFSUBEL         Point to data                                
*                                                                               
         L     R2,ADACC                                                         
         AH    R2,DATADISP                                                      
FLTLST22 CLI   0(R2),EOR           End of record ?                              
         BNE   FLTLST24              Not yet                                    
         CLI   *,0                 Set to not equal (False)                     
         B     FLTLST34                                                         
*                                                                               
         USING UFSELD,R2                                                        
FLTLST24 CLI   0(R2),UFSELQ        User field ?                                 
         BNE   FLTLST25              No, get next element                       
         CLC   UFSCODE,FUFIELD     Match on code ?                              
         BE    FLTLST27              Yes, so match userfield data               
*                                                                               
FLTLST25 IC    RF,1(,R2)           Get next user field element                  
         AR    R2,RF                                                            
         B     FLTLST22                                                         
*                                                                               
FLTLST27 SR    RE,RE               Figure out length of userfield data          
         IC    RE,UFSLN                                                         
         SHI   RE,UFSLN1Q          Length of data in element                    
         C     RE,FULL                                                          
         BNE   FLTLST32            Not same len, not equal, try next            
         LR    RF,RE                                                            
         LA    R3,UFSDATA          USFELD data                                  
         LR    RE,R8                                                            
         DROP  R2                                                               
*                                                                               
FLTLST28 CLI   0(RE),C'?'          Wild card ?                                  
         BE    *+10                Yes, skip wild cards                         
         CLC   0(1,RE),0(R3)       Match up characters                          
         BNE   FLTLST32            Not equal try next in group                  
         AHI   R3,1                Check next character                         
         AHI   RE,1                Next character                               
         BCT   RF,FLTLST28         RF = length of data                          
*                                                                               
         CLI   *+1,0               Set to equal (True)                          
         B     FLTLST34            Now check branch type                        
*                                                                               
FLTLST32 A     R8,FULL                                                          
         IC    RF,0(,R8)           Length of sub piece                          
         AHI   R8,1                                                             
         ST    RF,FULL             Save off length of data                      
         BCT   R0,FLTLST27         Number of pieces                             
*                                                                               
         CLI   *,0                 Set to not equal (False)                     
*                                                                               
FLTLST34 IC    RF,BYTE                                                          
         EX    RF,*+8                                                           
         B     FLTFALSE            False                                        
         BC    0,FLTTRUE           True                                         
*                                                                               
FLTFALSE TM    FUFCC,FUFAND        AND with next set ?                          
         BO    FLTNO               Set to exit with not equal                   
         B     FLTLST36            Try next                                     
*                                                                               
FLTTRUE  TM    FUFCC,FUFAND                                                     
         BZ    FLTOK               Set to exit with equal                       
*                                                                               
FLTLST36 L     R6,ANEXT            Point to next filter group                   
         B     FLTLST21                                                         
         DROP  R6                                                               
*                                                                               
FLTLST38 CLI   4(R1),RFLTTYPE      Filter transaction type                      
         BNE   FLTLST50                                                         
*                                                                               
FLTLST40 CLI   0(R6),EOT                                                        
         BE    FLTNEQL             No match                                     
         CLI   REALTYP,30          Include all type 30's                        
         BNE   FLTLST45                                                         
         CLI   1(R6),30            Type 30 in fitler list?                      
         BE    FLTEQL                                                           
         CLC   SUBTTYP2,1(R6)      Inter-agency ?                               
         BE    FLTEQL                                                           
*                                                                               
FLTLST45 CLI   REALTYP,6           Include all type 6's                         
         BNE   FLTLST48                                                         
         CLI   1(R6),6             Type 6 in filter list?                       
         BE    FLTEQL                                                           
*                                                                               
FLTLST48 CLC   SUBTTYP,1(R6)       Match type                                   
         BE    FLTEQL                                                           
         LA    R6,2(,R6)                                                        
         B     FLTLST40                                                         
*                                                                               
FLTLST50 TM    0(R1),FLTWILD       X'04' Wild card matching ?                   
         BZ    FLTLST60            No                                           
*                                                                               
FLTLST52 CLI   0(R6),EOT                                                        
         BE    FLTNEQL             No match of any kind                         
         LR    RE,R3               Reset RE each time                           
         IC    RF,0(,R6)           Length of data                               
         LA    R6,1(,R6)           Bump past length                             
FLTLST54 CLI   0(R6),C'?'          Wild card ?                                  
         BE    FLTLST58            Yes so skip compare                          
         CLC   0(1,RE),0(R6)                                                    
         BE    FLTLST58            Continue                                     
         AR    R6,RF                                                            
         B     FLTLST52                                                         
*                                                                               
FLTLST58 LA    RE,1(,RE)           Bump to next character                       
         LA    R6,1(,R6)                                                        
         BCT   RF,FLTLST54                                                      
         B     FLTEQL                                                           
*                                                                               
FLTLST60 CLI   0(R6),EOT           End of list ?                                
         BE    FLTNEQL             Yes, no match found                          
         IC    RF,0(,R6)           Get length to compare for                    
         BCTR  RF,0                                                             
         LA    R6,1(,R6)           Bump to data                                 
         EX    RF,FLTCOMP                                                       
         BE    FLTEQL              Found, so ok                                 
         LA    R6,1(RF,R6)         Bump to next entry                           
         B     FLTLST60                                                         
*                                                                               
FLTNEQL  TM    0(R1),FLTEXCL       X'10' Exclude ?                              
         BZ    FLTNO                                                            
         B     FLTOK                                                            
*                                                                               
FLTEQL   TM    0(R1),FLTEXCL       X'10' Exclude ?                              
         B     FLTXIT                                                           
*                                                                               
FLTOK    SR    RA,RA               Set to ok, no matter what                    
FLTNO    LTR   RA,RA                                                            
FLTXIT   XIT1                                                                   
                                                                                
FLTCOMP  CLC   0(0,R3),0(R6)                                                    
                                                                                
ANEXT    DS    A                                                                
         SPACE 1                                                                
         LTORG                                                                  
         TITLE 'BUILD RECORDS FOR TSAR OR SORTER'                               
         USING FMTRECD,R5                                                       
         USING KYWD,R6                                                          
RECORD   NMOD1 0,**MKRC**,R9                                                    
         L     RC,RLBASEC                                                       
         L     R7,0(,R1)           AREA TO BUILD SORT RECORD                    
         LA    R7,0(,R7)           CLEAR HIGH ORDER                             
         MVC   SAVEMODE,0(R1)                                                   
         MVC   RECIDX#,6(R1)       RECORD INDEX                                 
         MVC   SAVELVL,4(R1)                                                    
         XC    @REPLNME,@REPLNME                                                
         OC    POSTMODE,SAVEMODE                                                
         OC    POSTLVL,SAVELVL                                                  
***********************************************************************         
*  CLEAR SORT AREA AND ZERO OUT ACCUMS                                *         
***********************************************************************         
         SPACE 1                                                                
         CLC   RECIDX#,=AL2(01)                                                 
         BH    RECORD10                                                         
         TM    POSTLVL,POSTCLR     CLEAR?                                       
         BZ    RECORD26                                                         
         LR    RE,R7               CLEAR AREA TO BUILD JOB SORT RECORD          
         LH    RF,SRTRECLN                                                      
         XCEFL                                                                  
         B     RECORD12                                                         
*                                                                               
RECORD10 LH    R6,RECIDX#                                                       
         SHI   R6,1                                                             
         BNM   *+6                                                              
         DC    H'00'                                                            
         MH    R6,SRTRECLN         DISPLACEMENT TO NEW RECORD                   
         AR    R6,R7               ADD BASE TO POINT TO NEW RECORD              
         LR    R0,R6               SET R0 AND RE FOR MVCL                       
         LR    RE,R6               ALSO POINT TO NEW RECORD                     
         LH    RF,SRTRECLN         LENGTH OF RECORD                             
         SR    R0,RF               POINT TO PREVIOUS BUILT RECORD               
         LR    R1,RF               ALSO LENGTH OF RECORD                        
         CLI   PARSEALL,YES        IF YES THEN CLEAR AREA INSTEAD               
         BNE   *+6                                                              
         SR    R1,R1               LENGTH OF SOURCE                             
         MVCL  RE,R0                                                            
         LR    R7,R6               POINT TO NEW RECORD FOR PROCESSING           
*                                                                               
         USING COLD,R3                                                          
RECORD12 SR    R0,R0                                                            
         IC    R0,FMT#COLS                                                      
         L     R3,FMTCOL                                                        
RECORD14 TM    COLIND2,COLRATE                                                  
         BO    *+8                                                              
         TM    COLFLAGS,COLAMT                                                  
         BZ    RECORD16                                                         
         LH    RE,COLDSP           DISPLACEMENT TO ACCUM                        
         AR    RE,R7                                                            
         ZAP   0(PKLEN,RE),PKZERO  CLEAR ACCUMS                                 
RECORD16 LA    R3,COLLNQ(,R3)                                                   
         BCT   R0,RECORD14                                                      
         DROP  R3                                                               
*&&DO                                                                           
RECORD12 SR    R1,R1                                                            
         ICM   R1,1,FMT#ACMS       NUMBER OF ACCUMULATORS                       
         BZ    RECORD26            IF ZERO EXIT                                 
         LR    RE,R7                                                            
         AH    RE,SRTDATLN         POINT TO ACCUMS                              
         ZAP   0(PKLEN,RE),PKZERO  CLEAR ACCUMS                                 
         LA    RE,PKLEN(,RE)                                                    
         BCT   R1,*-10                                                          
*&&                                                                             
***********************************************************************         
*  Build row information in sort record                               *         
***********************************************************************         
         SPACE 1                                                                
         USING ROWD,R3                                                          
RECORD26 MVI   ROWSVLVL,0          NORMAL RECORD?                               
         L     R3,FMTROW           ROW TABLE                                    
         SR    R0,R0                                                            
         IC    R0,FMT#ROWS         NUMBER OF ROWS TO PROCESS                    
         CLI   UNIFLAG,YES                                                      
         BNE   RECORD28            CAN DO THIS IF RECORDS ARE MERGED            
         CLI   QPROG,RECEIVABLE                                                 
         BNE   RECORD28                                                         
         TM    TRNSSTAT,TRNSDR     IS IT A DEBIT ?                              
         BZ    RECORD28                                                         
         OI    0(R7),TRNSDR                                                     
*                                                                               
RECORD28 L     R6,ROWINDEX         R6 = A(KEYWORD)                              
         XC    @REPLNME,@REPLNME   Replacement name                             
         TM    ROWXPIND,ROWNOSRT   None sorted data                             
         BO    RECORD84                                                         
         LH    R4,ROWKYDSP         Key displacement                             
         AR    R4,R7               Add start of sort record                     
         SR    R2,R2                                                            
         ICM   R2,3,ROWKYSZ        Sort size of key                             
         BZ    RECORD84            Skip this part of key                        
         TM    RECAPSW,RECAPON     Are we recapping ?                           
         BZ    RECORD30            No                                           
         TM    FMTRCAP,FMTRSEP     Recaps are seperate ?                        
         BO    RECORD30            Separate so don't bother                     
         LA    RF,0(R2,R4)                                                      
         BCTR  RF,0                                                             
         MVC   0(1,RF),FMTNUM      Set as default of next row                   
         CLI   FMTMRGE#,0                                                       
         BE    *+10                                                             
         MVC   0(1,RF),FMTMRGE#    Over-ride, mergering of reports              
                                                                                
RECORD30 SHI   R2,2                                                             
         BNM   RECORD32            Must have been > 1                           
         LR    RF,R4                                                            
         BCTR  RF,0                                                             
         MVC   0(1,RF),ROWRECAP    Just move in recap #                         
         B     RECORD84                                                         
*                                                                               
RECORD32 TM    POSTMODE,POSTTOT    Post recap total record ?                    
         BZ    RECORD34            No                                           
         CLI   ROWNUM,1            Row 1 ?                                      
         BE    RECORD34            Yes, always set to company code              
         EXMVC R2,0(R4),HEXFF      Else all others set to X'FF's                
         LR    RF,R4                                                            
         BCTR  RF,0                                                             
         MVC   0(1,RF),ROWRECAP                                                 
         B     RECORD84                                                         
*                                                                               
RECORD34 CLI   PARSEALL,YES        Go parse all data regardless                 
         BE    RECORD38            Yes                                          
         TM    ROWXPIND,ROWRATE                                                 
         BO    RECORD38                                                         
         TM    ROWFLAGS,ROWUNQ     Data is unique to each transaction ?         
         BZ    RECORD36            No, so see if we have data already           
         TM    ROWFLAGS,ROW1SIDE   Unique of 1 side, either DR or CR            
         BZ    RECORD38            No, unique for both DR and CR                
         IC    R1,BRNCHSGN                                                      
         TM    TRNSSTAT,TRNSDR     Is it a debit ?                              
         EX    R1,*+8              DR unique branch if DR & visa versa          
         B     *+8                                                              
         BC    0,RECORD38          Yes, so branch accordingly                   
*                                                                               
RECORD36 EXOC  R2,0(R4),0(R4)      IS IT NULLS?                                 
         BZ    RECORD38            PARSE DATA                                   
         TM    ROWKYIND,ROWKYXFF   FILL WITH HEX FF                             
         BZ    RECORD62            ALREADY HAVE DATA                            
         EXCLC R2,0(R4),HEXFF      CHECK FOR X'FF' FILLED                       
         BNE   RECORD62            ALREADY HAVE DATA                            
*                                                                               
RECORD38 SR    RE,RE                                                            
         ICM   RE,3,KYWPRSE                                                     
         BNZ   *+6                                                              
         DC    H'00'                                                            
*                                                                               
         A     RE,PRSBASE                                                       
         MVI   BYTE,0                                                           
         TM    ROWKYIND,ROWKYCDE+ROWKYLVL                                       
         BNO   RECORD40                                                         
         MVI   BYTE,PARDLVL                                                     
         ICM   R4,8,KYWLVLQ        Get length of level                          
*                                                                               
RECORD40 ST    R3,ACURROW                                                       
         OC    ROWCON,ROWCON       Size may not be what it was                  
         BZ    *+8                                                              
         OI    BYTE,PARREPL                                                     
                                                                                
         GOTO1 PARSE,DMCB,(BYTE,(RE)),(R4),ROWFILT,(R6)                         
         BE    RECORD47                                                         
         TM    KYWIND5,KYWNOBUD                                                 
         BO    RECORD42            None essential budget level data             
         TM    KYWIND3,KYWRATE     DON'T CONSIDER RATE AS A LEVEL               
         BO    RECORD42                                                         
         MVC   ROWSVLVL,ROWNUM     SAVE ROW FOR NO KEY DATA FOUND               
                                                                                
RECORD42 LR    RF,R4                                                            
         BCTR  RF,0                                                             
         MVC   0(1,RF),ROWRECAP                                                 
         TM    ROWXPIND,ROWRATE                                                 
         BO    RECORD62                                                         
         CHI   R2,254                                                           
         BNL   RECORD44                                                         
         EXXC  R2,0(R4),0(R4)                                                   
         B     RECORD46                                                         
*                                                                               
RECORD44 LA    RF,1(,R2)                                                        
         LR    RE,R4                                                            
         XCEFL                                                                  
*                                                                               
RECORD46 TM    ROWKYIND,ROWKYXFF   Fill with Hex x'ff's                         
         BZ    RECORD62            No                                           
*&&UK*&& CLI   MODE,PROCACC                                                     
*&&UK*&& BE    RECORD62            Lower levels keep as nulls                   
         EXMVC R2,0(R4),HEXFF                                                   
         B     RECORD62                                                         
*                                                                               
RECORD47 DS    0H                                                               
*&&US                                                                           
         TM    ROWDAIND,ROWXCOL    Hide column and keep data out of             
         BZ    RECORD48            sort record?                                 
         LH    RF,ROWKYDSP                                                      
         AR    RF,R7               Point to right area in sort record           
         ICM   R1,3,ROWKYSZ                                                     
         BZ    RECORD48                                                         
         SHI   R1,1                                                             
         BM    RECORD48                                                         
         EXXC  R1,0(RF),0(RF)      WIPE OUT DATA                                
*&&                                                                             
RECORD48 CLI   KYWREAD,KYWREST     Non-accum BrO estimate keyword?              
         BNE   RECORD52                                                         
         USING RECXD,RE                                                         
         LR    RE,R7                                                            
         AH    RE,SRTKEYXT                                                      
         OI    RECIND,RECKEEP      Keep no matter what                          
         DROP  RE                                                               
*                                                                               
RECORD52 CLI   QPROG,RECEIVABLE                                                 
         BNE   RECORD60                                                         
         CLI   UNIFLAG,YES                                                      
         BNE   RECORD60          CAN DO THIS IF RECORDS ARE MERGED              
         TM    ROWOPT,ROWFILL    FILL IN POSSIBLE MISSING DATA                  
         BZ    RECORD60          OCCURS WHEN DR/CR ARE OUT OF SEQUENCE          
         TM    0(R7),TRNSDR      IS IT A DR ?                                   
         BZ    RECORD60                                                         
         LH    RF,RECIDX#                                                       
         SHI   RF,1                                                             
         BNP   RECORD60                                                         
         LR    RE,R4                                                            
         LR    R1,R7                                                            
*                                                                               
RECORD54 SH    RE,SRTRECLN         LOOK AT PREVIOUS RECORD                      
         SH    R1,SRTRECLN         POINT AT START OF RECORD                     
         TM    0(R1),TRNSDR        IS IT A CREDIT ?                             
         BO    RECORD60            STOP PROCESSING                              
         EX    R2,CMPNULLS                                                      
         BZ    RECORD56            IF SPACES OR LESS THEN FILL                  
         EX    R2,CMPHEXFF                                                      
         BNE   RECORD58                                                         
*                                                                               
RECORD56 EX    R2,FILLDATA                                                      
*                                                                               
RECORD58 BCT   RF,RECORD54                                                      
*                                                                               
RECORD60 TM    ROWFLAGS,ROWUNQ                                                  
         BO    RECORD62                                                         
         CLI   PARSEALL,YES                                                     
         BE    RECORD62                                                         
         LH    RF,RECIDX#                                                       
         SHI   RF,1                                                             
         BNP   RECORD62            DUPLICATE DATA FOR OTHER RECORDS             
         LR    RE,R4                                                            
         SH    RE,SRTRECLN         FILL IN KEY DATA TO OTHER RECORDS            
         EX    R2,FILLDATA                                                      
         BCT   RF,*-8                                                           
*                                                                               
RECORD62 LR    RF,R4                                                            
         BCTR  RF,0                                                             
         MVC   0(1,RF),ROWRECAP                                                 
         CLI   ROWRECAP,0                                                       
         BE    RECORD64                                                         
         CLI   FMTMRGE#,0                                                       
         BE    *+10                                                             
         MVC   0(1,RF),FMTMRGE#    Over-ride, mergering of reports              
                                                                                
RECORD64 SR    R1,R1                                                            
         ICM   R1,3,KYWLINK        IS THEN ALTERNATE DATA                       
         BZ    RECORD84            NO, SO FINISHED                              
         LR    R6,R1                                                            
         A     R6,KYWBASE          POINT TO ALTERNATE KEYWORD                   
         LH    R4,ROWDADSP         DATA DISPACEMENT                             
         AR    R4,R7               POINT TO SORT LOCATION                       
         SR    R2,R2                                                            
         ICM   R2,1,ROWDASZ        SORT SIZE OF DATA                            
         BZ    RECORD84            DON'T PARSE                                  
         BCTR  R2,0                                                             
         ICM   RE,15,@REPLNME                                                   
         BZ    RECORD66                                                         
         SR    RF,RF                                                            
         IC    RF,0(,RE)           Get length of data                           
         BCTR  RF,0                                                             
         CR    RF,R2                                                            
         BL    *+6                                                              
         LR    RF,R2                                                            
         EXMVC RF,0(R4),1(RE)                                                   
         B     RECORD74                                                         
                                                                                
RECORD66 CLI   PARSEALL,YES        GO TO PARSE REGARDLESS                       
         BE    RECORD70                                                         
         TM    ROWFLAGS,ROWUNQ     DATA IS ALWAYS UNIQUE SO PARSE               
         BZ    RECORD68                                                         
         TM    ROWFLAGS,ROW1SIDE   Unique of 1 side, either DR or CR            
         BZ    RECORD70            No, unique for both DR and CR                
         IC    R1,BRNCHSGN                                                      
         TM    TRNSSTAT,TRNSDR     Is it a debit ?                              
         EX    R1,*+8              DR unique branch if DR & visa versa          
         B     *+8                                                              
         BC    0,RECORD70          Yes, so branch accordingly                   
*                                                                               
RECORD68 EXOC  R2,0(R4),0(R4)      IS IT NULLS?                                 
         BZ    RECORD70            PARSE DATA                                   
         TM    ROWDAIND,ROWDAXFF   FILL WITH HEX FF                             
         BZ    RECORD84            ALREADY HAVE DATA                            
         EXCLC R2,0(R4),HEXFF      CHECK FOR X'FF' FILLED                       
         BNE   RECORD84            ARLEADY HAVE DATA                            
*                                                                               
RECORD70 SR    RE,RE                                                            
         SR    RF,RF                                                            
         ICM   RE,3,KYWPRSE                                                     
         A     RE,PRSBASE                                                       
         TM    ROWDAIND,ROWDACDE+ROWDALVL                                       
         BNO   RECORD72                                                         
         LA    RF,PARDLVL                                                       
         ICM   R4,8,KYWLVLQ        GET LENGTH OF LEVEL                          
*                                                                               
RECORD72 ST    R3,ACURROW                                                       
         GOTO1 PARSE,DMCB,((RF),(RE)),(R4),ROWFILT,(R6)                         
         BE    RECORD74                                                         
         EXXC  R2,0(R4),0(R4)                                                   
         TM    ROWDAIND,ROWDAXFF   FILL WITH HEX FF                             
         BZ    RECORD84                                                         
*&&UK*&& CLI   MODE,PROCACC                                                     
*&&UK*&& BE    RECORD84            Lower levels keep as nulls                   
         EXMVC R2,0(R4),HEXFF                                                   
         B     RECORD84                                                         
*                                                                               
RECORD74 CLI   QPROG,RECEIVABLE                                                 
         BNE   RECORD82                                                         
         CLI   UNIFLAG,YES                                                      
         BNE   RECORD82          CAN DO THIS IF RECORDS ARE MERGED              
         TM    ROWOPT,ROWFILL    FILL IN POSSIBLE MISSING DATA                  
         BZ    RECORD82          OCCURS WHEN DR/CR ARE OUT OF SEQUENCE          
         TM    0(R7),TRNSDR      IS IT A DR ?                                   
         BZ    RECORD82                                                         
         LH    RF,RECIDX#                                                       
         SHI   RF,1                                                             
         BNP   RECORD82                                                         
         LR    RE,R4                                                            
         LR    R1,R7                                                            
*                                                                               
RECORD76 SH    RE,SRTRECLN         LOOK AT PREVIOUS RECORD                      
         SH    R1,SRTRECLN         POINT AT START OF RECORD                     
         TM    0(R1),TRNSDR        IS IT A CREDIT ?                             
         BO    RECORD82            STOP PROCESSING                              
         EX    R2,CMPNULLS                                                      
         BZ    RECORD78            IF SPACES OR LESS THEN FILL                  
         EX    R2,CMPHEXFF                                                      
         BNE   RECORD80                                                         
*                                                                               
RECORD78 EX    R2,FILLDATA                                                      
*                                                                               
RECORD80 BCT   RF,RECORD76                                                      
*                                                                               
RECORD82 TM    ROWFLAGS,ROWUNQ                                                  
         BO    RECORD84                                                         
         CLI   PARSEALL,YES                                                     
         BE    RECORD84                                                         
         LH    RF,RECIDX#                                                       
         SHI   RF,1                                                             
         BNP   RECORD84            DUPLICATE DATA FOR OTHER RECORDS             
         LR    RE,R4                                                            
         SH    RE,SRTRECLN         FILL IN KEY DATA TO OTHER RECORDS            
         EX    R2,FILLDATA                                                      
         BCT   RF,*-8                                                           
         B     RECORD84                                                         
*                                                                               
RECORD84 AHI   R3,ROWLNQ                                                        
         BCT   R0,RECORD28         LOOP FOR NEXT ROW                            
*                                                                               
         USING RECXD,R6                                                         
         LR    R6,R7                                                            
         AH    R6,SRTKEYXT                                                      
                                                                                
         TM    POSTMODE,POSTTOT    Make recap total record ?                    
         BO    RECORD90            Yes                                          
         TM    DDLNKIND,DDLNKGBL                                                
         BZ    *+10                                                             
         MVC   RECOFC,LMTSECOF                                                  
         TM    FMTSW,FMTRKRTE      No. Rank on rate ?                           
         BZ    RECORD88            No                                           
         LR    RE,R7               Yes                                          
         AH    RE,FMTRNKCL         Point to rate amount                         
         ZAP   DUB,PKZERO                                                       
         OC    0(PKLEN,RE),0(RE)   Any rate supplied ?                          
         BZ    *+10                No                                           
         ZAP   DUB,0(PKLEN,RE)                                                  
         CLI   FMTRNKTY,C'A'       Ascending or descending ?                    
         BNE   *+10                                                             
         MP    DUB,PKNEG                                                        
         CP    DUB,PKZERO               Positive number ?                       
         BL    RECORD86                 No                                      
         MP    DUB,PKNEG                Yes, make negative                      
         AP    DUB,=P'999999999999999'  Reverse sort order                      
*                                                                               
RECORD86 LR    RE,R7                                                            
         AH    RE,FMTRNKBY         SORTKEY LOCATION TO STORE                    
         ZAP   2(PKLEN,RE),DUB                                                  
         BNL   *+8                                                              
         MVI   1(RE),X'FF'         IF NEG. FLAG A SIGN IN FRONT                 
         MVC   0(1,RE),FMTNUM                                                   
*                                                                               
RECORD88 TM    FCIND,FCISORT                                                    
         BZ    *+10                                                             
         MVC   RECFCUR,CURFCCDE                                                 
*                                                                               
RECORD90 MVI   RECTYPE,RECNORM                                                  
         MVC   RECOTH,DTEIDX#                                                   
         TM    POSTMODE,POSTTOT                                                 
         BZ    *+8                                                              
         OI    RECIND,RECTOTS      Mark as total record (Recap)                 
         TM    POSTMODE,POSTBUD                                                 
         BZ    RECORD92                                                         
         TM    DDLNKIND,DDLNKON                                                 
         BO    RECORD94            If DDLINK don't merge buds w/actuals         
                                                                                
RECORD92 CLI   MODE,PROCACC        Processing an account ?                      
         BNE   *+8                                                              
         OI    RECIND,RECMRGE      Merge account records with detail            
                                                                                
RECORD94 MVC   RECRPT#,FMTNUM                                                   
         CLI   FMTMRGE#,0                                                       
         BE    *+10                                                             
         MVC   RECRPT#,FMTMRGE#    Over-ride, mergering of reports              
*                                                                               
         USING ACMD,R2                                                          
         CLI   OFFSEC,YES          Office security in action ?                  
         BNE   RECORD96                                                         
         L     R2,AMONACC                                                       
         TM    ACMPESEC,ACMPEEMP   Was employee office good ?                   
         BO    RECORD96            Yes so leave well enough alone               
         OI    RECOTH,RECMASK      Indicator on record for later RL04           
         DROP  R2                                                               
*                                                                               
RECORD96 TM    POSTMODE,POSTBUD                                                 
         BZ    RECORD98                                                         
         TM    DDLNKIND,DDLNKON                                                 
         BO    RECORD98            When running DDLINK skip                     
         CLI   ROWSVLVL,0                                                       
         BE    RECORD98                                                         
         MVI   RECTYPE,RECBUDG     Make a special budget record                 
         MVC   RECLVL,ROWSVLVL     Save off row level                           
*                                                                               
RECORD98 TM    POSTMODE,POSTNUL+POSTTOT     Don't bother w/accums               
         BNZ   RCORD236                                                         
         TM    FMTIND,FMTREVSG                                                  
         BZ    RCORD100                                                         
         TM    FCIND,FCIOKREV      Do we want to reverse it ?                   
         BZ    RCORD100            No                                           
         MVI   RECTYPE,RECREV      Reverse columns amts when on                 
         DROP  R6                                                               
         EJECT ,                                                                
***********************************************************************         
*  Process columns amounts now - BUILD ACCUMULATOR DATA               *         
***********************************************************************         
                                                                                
         USING COLD,R3                                                          
RCORD100 SR    R0,R0                                                            
         IC    R0,FMT#COLS                                                      
         L     R3,FMTCOL                                                        
*                                                                               
         TM    POSTMODE,POSTBUD    Post budgets ?                               
         BZ    RCORD122            No                                           
RCORD102 L     R2,ABUDIO           Yes (Budget record in IO)                    
*&&US                                                                           
T        USING BUDRECD,R2                                                       
         MVC   HALF,CUROFF         Force in budget office for filtering         
         MVC   CUROFF,T.BUDKWORK                                                
*&&                                                                             
         AH    R2,DATADISP                                                      
         TM    COLFLAGS,COLBUD                                                  
         BO    RCORD106                                                         
         CLI   ROWSVLVL,0                                                       
         BNE   RCORD120            Creating a special budget record             
         TM    COLFLAGS,COLAMT     Is this an amount column ?                   
         BZ    RCORD120            No                                           
         TM    COLOPT2,COLFCPRT    Yes, is it a constant value ?                
         BZ    RCORD120            No                                           
         BRAS  RE,GOFILT                                                        
         BNE   RCORD120                                                         
*                                                                               
         TM    COLOPT2,COLDSKIP    DON'T CHECK DATES                            
         BO    RCORD104                                                         
         L     RE,COLDATE          A(DATE TO COMPARE TO)                        
         CLC   COLEND,0(RE)                                                     
         BL    RCORD120                                                         
         CLC   COLSTART,0(RE)                                                   
         BH    RCORD120                                                         
*                                                                               
         USING KYWD,R6                                                          
RCORD104 L     R6,COLINDEX         Keyword index                                
         ZAP   PACKAMT,PKZERO                                                   
         SR    RE,RE                                                            
         ICM   RE,3,KYWPRSE                                                     
         BZ    RCORD120                                                         
         A     RE,PRSBASE                                                       
         ST    R3,ACURCOL                                                       
         GOTO1 PARSE,DMCB,(RE),PACKAMT,COLFILT,(R6)                             
         LH    R4,COLDSP           DISPLACEMENT TO ACCUM                        
         AR    R4,R7                                                            
         ZAP   0(PKLEN,R4),PACKAMT                                              
         XC    ACURCOL,ACURCOL                                                  
         B     RCORD120                                                         
         DROP  R6                                                               
*                                                                               
RCORD106 LH    R4,COLDSP           DISPLACEMENT TO ACCUM                        
         AR    R4,R7                                                            
         L     R6,COLINDEX         KEYWORD ASSOCIATED WITH THIS COLUMN          
         CLC   COLBUD#,CURBUD#                                                  
         BNE   RCORD120                                                         
         ZAP   0(PKLEN,R4),PKZERO                                               
         BRAS  RE,GOFILT                                                        
         BNE   RCORD120                                                         
*                                                                               
RCORD108 SR    R1,R1                                                            
         LA    RE,TRANDTE                                                       
         TM    POSTCTL,POSTBYDT    POST BY DATE OF BUDGET BUCKET                
         BZ    RCORD110                                                         
         LA    RF,1                COMPARE YYMM PACKED                          
         TM    POSTCTL,POSTPED                                                  
         BZ    *+8                                                              
         LA    RF,2                COMPARE YYMMDD PACKED                        
         EX    RF,COLENDDT                                                      
         BH    RCORD120                                                         
         EX    RF,COLSTRDT                                                      
         BL    RCORD120                                                         
         ZAP   0(PKLEN,R4),BUDAMT  POST EACH AMOUNT                             
         B     RCORD120                                                         
*                                                                               
COLENDDT CLC   0(0,RE),COLEND                                                   
COLSTRDT CLC   0(0,RE),COLSTART                                                 
*                                                                               
         USING BAMELD,R2                                                        
RCORD110 CLI   0(R2),0             EOR                                          
         BE    RCORD120                                                         
         TM    POSTCTL,POSTPED                                                  
         BO    RCORD114                                                         
         CLI   BAMEL,BAMELQ        X'1D' BUDGET ELEMENT                         
         BNE   RCORD112                                                         
         CLC   BAMMNTH,COLEND      MOA WITHIN RANGE?                            
         BH    RCORD120                                                         
         CLC   BAMMNTH,COLSTART                                                 
         BL    RCORD112                                                         
         AP    0(PKLEN,R4),BAMBUDG POST TOTAL OF BUCKETS                        
RCORD112 IC    R1,1(,R2)                                                        
         AR    R2,R1                                                            
         B     RCORD110                                                         
*                                                                               
         USING CDRD,R2                                                          
         USING CPRCNDRD,RE                                                      
RCORD114 L     R2,ACNDRWRK         CALENDAR DATA                                
         L     RE,ACNDRBLK         CALENDAR INFO                                
         SR    RF,RF                                                            
         IC    RF,CPR#PRD          # OF PERIODS IN CALENDAR                     
         DROP  RE                                                               
*                                                                               
RCORD116 CP    CDRBUD,PKZERO                                                    
         BE    RCORD118                                                         
         CLC   CDRSDATE,COLEND                                                  
         BH    RCORD118                                                         
         CLC   CDREDATE,COLSTART                                                
         BL    RCORD118                                                         
         AP    0(PKLEN,R4),CDRBUD  ADD UP BUDGET BY PERIOD                      
RCORD118 LA    R2,CDRLNQ(,R2)                                                   
         BCT   RF,RCORD116                                                      
         DROP  R2                                                               
*                                                                               
RCORD120 LA    R3,COLLNQ(,R3)                                                   
         BCT   R0,RCORD102                                                      
*&&US                                                                           
         MVC   CUROFF,HALF         Put back current office                      
         DROP  T                                                                
*&&                                                                             
         B     RCORD236                                                         
*                                                                               
RCORD122 TM    POSTMODE,POSTJBR    POST ESTIMATE/JOBBER AMOUNTS                 
         BZ    RCORD190                                                         
*                                                                               
RCORD124 TM    COLFLAGS,COLJOBR    IS IT A JOBBER COLUMN?                       
         BZ    RCORD146                                                         
         BRAS  RE,GOFILT           FILTER COLUMN                                
         BNE   RCORD188                                                         
*                                                                               
         USING KYWD,R6                                                          
RCORD126 L     R6,COLINDEX                                                      
         SR    RF,RF                                                            
         SR    RE,RE                                                            
         ICM   RE,3,KYWPRSE                                                     
         BZ    RCORD188                                                         
         A     RE,PRSBASE                                                       
         LH    R4,COLDSP           Should be OK for MCS/BrandOcean              
         AR    R4,R7                                                            
         IC    RF,COLJOBRC                                                      
         BCTR  RF,0                                                             
         L     R1,AMONACC                                                       
         L     RE,ACMAJOBB-ACMD(R1)                                             
         CLI   JBNEWEST-JBLOCKD(RE),JBMCSQ                                      
         BE    RCORD132                                                         
         MHI   RF,L'JBCOLV1R       Displace to Jobber column value              
         A     RF,JOBRBLK                                                       
         AHI   RF,(JBCOLV1R-JBCOLD)                                             
         TM    COLIND5,COLIETN+COLIETO Est. time filt: test excl/only           
         BZ    RCORD130            Neither, carry on                            
*                                                                               
         CLC   COLKYWD,=CL6'OE'    Original Estimate                            
         BE    RCORD128                                                         
         CLC   COLKYWD,=CL6'OEN'   Original Estimate Net                        
         BE    RCORD128                                                         
         CLC   COLKYWD,=CL6'OEG'   Original Estimate Gross                      
         BE    RCORD128                                                         
         CLC   COLKYWD,=CL6'CE'    Current Estimate                             
         BE    RCORD128                                                         
         CLC   COLKYWD,=CL6'CEN'   Current Estimate Net                         
         BE    RCORD128                                                         
         CLC   COLKYWD,=CL6'CEG'   Current Estimate Gross                       
         BNE   RCORD130                                                         
*                                                                               
RCORD128 LA    RE,BH                                                            
         TM    COLIND5,COLIETN     Test excluding estimated time                
         BNZ   *+8                                                              
         LA    RE,BLE              (BNH)                                        
         L     R1,JOBRBLK                                                       
         CLI   JBCOL1R-JBCOLD(R1),C' '  Test 1R a/c in Jobber tab entry         
         NOP   RCORD188            Skip if set/not set                          
         EX    RE,*-4                                                           
RCORD130 ZAP   0(PKLEN,R4),0(L'JBCOLV1R,RF)                                     
         B     RCORD188                                                         
*                                                                               
RCORD132 MHI   RF,L'MJETVAL        BrandOcean table layout                      
         AHI   RF,MJETLNQ                                                       
**WHY?   LR    R2,RF               Save RF                                      
         A     RF,JOBRBLK                                                       
*                                                                               
         TM    POSTLVL,POSTITM     Posting by ITEM?                             
         BZ    RCORD140            No                                           
         ZAP   0(PKLEN,R4),PKZERO                                               
         L     R2,AITMBLK          Yes, use ITEM BLOCK                          
         CLC   COLKYWD,=CL6'CEH'   Current Estimate Hours                       
         BE    RCORD138                                                         
         LA    R2,6(0,R2)                                                       
         CLC   COLKYWD,=CL6'CE'    Current Estimate                             
         BE    RCORD136                                                         
         CLC   COLKYWD,=CL6'CEN'   or Current Estimate Net                      
         BE    RCORD136                                                         
         LA    R2,6(0,R2)                                                       
         CLC   COLKYWD,=CL6'CEC'   Current Estimate Commission                  
         BE    RCORD138                                                         
         LA    R2,6(0,R2)                                                       
         CLC   COLKYWD,=CL6'CEG'   Current Estimate Gross                       
         BNE   RCORD188                                                         
                                                                                
RCORD136 LA    RE,BH                                                            
         TM    COLIND5,COLIETN     Test excluding estimated time                
         BNZ   *+8                                                              
         LA    RE,BLE              (BNH)                                        
         L     R1,JOBRBLK                                                       
         CLI   MJET1RA-MJETABD(R1),C' '  Test 1R a/c in Jobber tab ntry         
         NOP   RCORD188            Skip if set/not set                          
         EX    RE,*-4                                                           
*                                                                               
RCORD138 ZAP   0(PKLEN,R4),0(L'MJETVAL,R2)                                      
         B     RCORD188                                                         
*                                                                               
RCORD140 TM    COLIND5,COLIETN+COLIETO Est. time filt: test excl/only           
         BZ    RCORD142            Neither, carry on                            
         ZAP   0(PKLEN,R4),PKZERO                                               
         CLC   COLKYWD,=CL6'OE'    Original Estimate                            
         BE    *+10                                                             
         CLC   COLKYWD,=CL6'OEN'   Original Estimate Net                        
         BE    *+10                                                             
         CLC   COLKYWD,=CL6'OEG'   Original Estimate Gross                      
         BE    *+10                                                             
         CLC   COLKYWD,=CL6'CE'    Current  ditto                               
         BE    *+10                                                             
         CLC   COLKYWD,=CL6'CEN'                                                
         BE    *+10                                                             
         CLC   COLKYWD,=CL6'CEG'                                                
         BNE   RCORD142                                                         
         LA    RE,BH                                                            
         TM    COLIND5,COLIETN     Test excluding estimated time                
         BNZ   *+8                                                              
         LA    RE,BLE              (BNH)                                        
         L     R1,JOBRBLK                                                       
         CLI   MJET1RA-MJETABD(R1),C' '  Test 1R a/c in Jobber tab ntry         
         NOP   RCORD188            Skip if set/not set                          
         EX    RE,*-4                                                           
RCORD142 ZAP   0(PKLEN,R4),0(L'MJETVAL,RF)                                      
*                                                                               
         TM    POSTLVL,POSTAITM    Did we have ITEMS for this WC?               
         BZ    RCORD188            No                                           
         CLC   COLKYWD,=CL6'CEH'   Yes, already printed these                   
         BE    RCORD144                                                         
         CLC   COLKYWD,=CL6'CE'                                                 
         BE    RCORD144                                                         
         CLC   COLKYWD,=CL6'CEN'                                                
         BE    RCORD144                                                         
         CLC   COLKYWD,=CL6'CEC'                                                
         BE    RCORD144                                                         
         CLC   COLKYWD,=CL6'CEG'                                                
         BNE   RCORD144                                                         
*                                                                               
RCORD144 ZAP   0(PKLEN,R4),PKZERO                                               
*                                                                               
RCORD146 TM    COLFLAGS,COLNJEST   IS IT A NON-JOBBER ESTIMATE COLUMN?          
         BNZ   RCORD148                                                         
         TM    COLIND5,COLNJESR    OR NON-JOBBER EST HOURS/RATE COLUMN          
         BZ    RCORD188                                                         
RCORD148 OC    NJEWBLK,NJEWBLK     TEST WORKCODE DATA                           
         BZ    RCORD188                                                         
         BRAS  RE,GOFILT           FILTER COLUMN                                
         BNE   RCORD188                                                         
*                                                                               
         USING KYWD,R6                                                          
         L     R6,COLINDEX                                                      
         SR    RF,RF                                                            
         SR    RE,RE                                                            
         ICM   RE,3,KYWPRSE                                                     
         BZ    RCORD188                                                         
         A     RE,PRSBASE                                                       
         LH    R4,COLDSP                                                        
         AR    R4,R7                                                            
         USING ESTWCD,R2                                                        
         L     R2,NJEWBLK                                                       
         CLI   RCCTRY,CTRYGER      TEST GERMANY?                                
         BE    RCORD150                                                         
                                                                                
         CLC   COLKYWD,=CL6'ESNET'   OUGHT TO SOFT CODE (AC#RSEAM)              
         BNE   *+14                                                             
         ZAP   0(PKLEN,R4),ESTWAM                                               
         B     RCORD152                                                         
         CLC   COLKYWD,=CL6'ESGRS'   OUGHT TO SOFT CODE (AC#RSEGR)              
         BNE   RCORD158                                                         
         ZAP   0(PKLEN,R4),ESTWGAM                                              
         B     RCORD152                                                         
RCORD150 CLC   COLKYWD,=CL6'KVNET'   OUGHT TO SOFT CODE (AC#RSEAM)              
         BNE   *+14                                                             
         ZAP   0(PKLEN,R4),ESTWAM                                               
         B     RCORD152                                                         
         CLC   COLKYWD,=CL6'KVABR'   OUGHT TO SOFT CODE (AC#RSEGR)              
         BNE   RCORD158                                                         
         ZAP   0(PKLEN,R4),ESTWGAM                                              
                                                                                
*        Adjust Est Net/Gross if Estimated time filter set:                     
RCORD152 TM    COLIND5,COLIETN     Exclude estimated time                       
         BZ    RCORD156                                                         
         TM    ESTWIND,ESTW1RQ     Test time level entry                        
         BZ    RCORD186                                                         
         ZAP   0(PKLEN,R4),PKZERO  Yes - clear it                               
         B     RCORD186                                                         
RCORD156 TM    COLIND5,COLIETO     Estimated time only                          
         BZ    RCORD186                                                         
         TM    ESTWIND,ESTWWCQ     Test w/c level entry                         
         BZ    RCORD186                                                         
         ZAP   0(PKLEN,R4),PKZERO  Yes - clear it                               
         B     RCORD186                                                         
*                                                                               
RCORD158 DS    0H                                                               
         CLC   COLKYWD(2),=AL2(AC#RSESH)  'ESHRS'                               
         BNE   *+14                                                             
         ZAP   0(PKLEN,R4),ESTTHRS                                              
         B     RCORD186                                                         
         CLC   COLKYWD(2),=AL2(AC#RSERA)  'ESHRAT'                              
         BNE   *+14                                                             
         ZAP   0(PKLEN,R4),ESTWRAT                                              
         B     RCORD186                                                         
*&&US*&& B     RCORD188                                                         
*&&UK                                                                           
         CLC   COLKYWD(2),=AL2(AC#RSERC)  'ESHRAC'  Currency fields             
         BNE   *+14                                                             
         ZAP   0(PKLEN,R4),ESTTRFC                                              
         B     RCORD170                                                         
         CLC   COLKYWD(2),=AL2(AC#RSENC)  'ESNETC'                              
         BNE   *+14                                                             
         ZAP   0(PKLEN,R4),ESTWAMC                                              
         B     RCORD162                                                         
         CLC   COLKYWD(2),=AL2(AC#RSEGC)  'ESGRSC'                              
         BNE   RCORD188                                                         
         ZAP   0(PKLEN,R4),ESTWGAMC                                             
                                                                                
*        Adjust Est currency Net/Gross if Estimated time filter set:            
RCORD162 TM    COLIND5,COLIETN     Exclude estimated time                       
         BZ    RCORD168                                                         
         TM    ESTWIND,ESTW1RQ     Test time level entry                        
         BZ    RCORD170                                                         
         ZAP   0(PKLEN,R4),PKZERO  Yes - clear it                               
         B     RCORD170                                                         
RCORD168 TM    COLIND5,COLIETO     Estimated time only                          
         BZ    RCORD170                                                         
         TM    ESTWIND,ESTWWCQ     Test w/c level entry                         
         BZ    RCORD170                                                         
         ZAP   0(PKLEN,R4),PKZERO  Yes - clear it                               
*                                                                               
RCORD170 LR    RF,R7               Pass currency code in SRTREC xtn             
         AH    RF,SRTKEYXT         so these values get edited correctly         
         MVC   RECFCUR-RECXD(L'RECFCUR,RF),ESTWCUR  (currency edit is           
*                                  switched on by KYWFC$ set in RL05)           
*&&                                                                             
RCORD186 CP    0(PKLEN,R4),PKZERO                                               
         BZ    *+8                                                              
         MVI   BYTE,YES                                                         
         DROP  R2                                                               
RCORD188 LA    R3,COLLNQ(,R3)                                                   
         BCT   R0,RCORD124                                                      
         B     RCORD236                                                         
*                                                                               
RCORD190 TM    POSTMODE,POSTBKT    POST BUCKET TYPE RECORDS                     
         BZ    RCORD202                                                         
*                                                                               
RCORD192 TM    COLFLAGS,COLAMT     Column amount                                
         BZ    RCORD200                                                         
         L     R2,BUKELM                                                        
         TM    COLFLAGS,COLBUD     Don't PROCESS BUDGET COLS                    
         BO    RCORD200                                                         
         CLI   COLBUCK,0           BUCKET TYPE COLUMN                           
         BE    RCORD200            NO                                           
         CLI   QPROG,GENERAL       General Ledger                               
         BE    RCORD198                                                         
         CLI   QPROG,PNL           PROFIT AND LOSS ?                            
         BNE   RCORD194                                                         
         CLC   CURSUBAC+1(2),=C'11'                                             
         BE    RCORD198            NO METHOD OR BUCKET TYPE FOR 11-13           
         CLC   CURSUBAC+1(2),=C'12'                                             
         BE    RCORD198                                                         
         CLC   CURSUBAC+1(2),=C'13'                                             
         BE    RCORD198                                                         
*                                                                               
RCORD194 CLI   COLBUCK,X'FF'       ALL BUCKET TYPES                             
         BE    RCORD196            METHOD ONLY FOR OVERHEAD                     
         CLC   COLBUCK,CURBUCK     MATCH BUCKET TYPE                            
         BNE   RCORD200            NOT   CORRECT                                
                                                                                
RCORD196 CLI   COLMTHD,0           ANY METHOD ?                                 
         BE    *+10                YES                                          
         CLC   COLMTHD,CURMTHD     MATCH METHOD                                 
         BNE   RCORD200            NOT   CORRECT                                
*                                                                               
RCORD198 LH    R4,COLDSP           DISPLACEMENT TO ACCUM                        
         AR    R4,R7                                                            
         L     R6,COLINDEX         KEYWORD ASSOCIATED WITH THIS COLUMN          
         BRAS  RE,GOFILT                                                        
         BNE   RCORD200                                                         
         GOTO1 BUKPST,DMCB,(R2),(R3) Post BUKELQ - Monthly bucket               
         GOTO1 APBKPST,DMCB,(R2),(R3) Post PBKELQ - Prior   bucket              
                                                                                
RCORD200 LA    R3,COLLNQ(,R3)                                                   
         BCT   R0,RCORD192                                                      
         B     RCORD236                                                         
*                                                                               
RCORD202 DS    0H                                                               
*&&UK                                                                           
         TM    POSTMODE,POSTCPO                                                 
         BZ    RCORD210                                                         
*                                                                               
RCORD204 TM    COLFLAGS,COLAMT     Column amount                                
         BZ    RCORD208                                                         
         LH    R4,COLDSP                                                        
         AR    R4,R7                                                            
         TM    POSTMODE,POSTCPO                                                 
         BZ    RCORD208                                                         
         TM    POSTLVL2,POSTCLP    Posting by client PO?                        
         BZ    RCORD206            No                                           
         ZAP   0(PKLEN,R4),PKZERO                                               
         CLC   COLDD#,=AL2(AC#RSCPA)   Client purchase order amount?            
         BNE   RCORD208                                                         
         ZAP   0(PKLEN,R4),CURCPOA                                              
         B     RCORD208                                                         
*                                                                               
RCORD206 TM    POSTLVL2,POSTACLP                                                
         BZ    RCORD208                                                         
         ZAP   0(PKLEN,R4),PKZERO                                               
*                                                                               
RCORD208 LA    R3,COLLNQ(,R3)                                                   
         BCT   R0,RCORD204                                                      
         B     RCORD236                                                         
*&&                                                                             
RCORD210 CLI   FMT#ACMS,0                                                       
         BE    RCORD236                                                         
         XC    ACURCOL,ACURCOL                                                  
         OI    FMTFLAG2,FMTNOCB    SET, ASSUME ALL COLS = 0                     
*                                                                               
RCORD212 TM    COLFLAGS,COLAMT                                                  
         BZ    RCORD228                                                         
         TM    COLFLAGS,COLJOBR    DON'T PROCESS JOBBER COLS                    
         BO    RCORD228                                                         
         TM    COLFLAGS,COLBUD     DON'T PROCESS BUDGET COLS                    
         BO    RCORD228                                                         
         TM    COLFLAGS,COLCALC    DON'T PROCESS CALCULATIONS COLS              
         BZ    RCORD214                                                         
         TM    COLIND2,COLDCALC    PROCESS THESE NOW INSTEAD OF LATER           
         BZ    RCORD228            NO                                           
         DC    H'00'               NOT USED AT THIS TIME, VERIFY                
                                                                                
RCORD214 TM    POSTLVL2,POSTDALY   Posting by Daily time keyword?               
         BZ    RCORD216                                                         
         CLC   COLDD#,=AL2(AC#RSBRT)                                            
         BE    RCORD218                                                         
         CLC   COLDD#,=AL2(AC#RSBVL)                                            
         BE    RCORD218                                                         
         CLC   COLDD#,=AL2(AC#RSCRT)                                            
         BE    RCORD218                                                         
         CLC   COLDD#,=AL2(AC#RSCVL)                                            
         BE    RCORD218                                                         
         CLC   COLDD#,=AL2(AC#RSHRS)                                            
         BE    RCORD218                                                         
         B     RCORD228                                                         
*                                                                               
RCORD216 DS    0H                                                               
*&&UK                                                                           
         TM    POSTLVL2,POSTTMI    Posting by Time/Material keywords?           
         BZ    RCORD218                                                         
         CLC   COLDD#,=AL2(AC#RSIUN)                                            
         BE    RCORD218                                                         
         CLC   COLDD#,=AL2(AC#RSITO)                                            
         BE    RCORD218                                                         
         CLC   COLDD#,=AL2(AC#RSIPC)                                            
         BNE   RCORD228                                                         
*&&                                                                             
RCORD218 TM    COLOPT,COLFCFLT     FILTER BY FOREIGN CURRENCY?                  
         BZ    *+14                                                             
         CLC   COLFCCDE,CURFCCDE   MATCH?                                       
         BNE   RCORD228                                                         
*&&UK                                                                           
         TM    COLIND5,X'0F'       TEST BRANDOCEAN INV STATUS FILTER(S)         
         BZ    RCORD220                                                         
         CLI   CURBOSTS,0          ANY INVOICE STATUS                           
         BNH   RCORD228            NO - SKIP (PER FTEI DSPCA190)                
         MVC   HALF+0(1),CURBOSTS  POSTING STATUS                               
         MVC   HALF+1(1),COLIND5   FILTER(S)                                    
         NI    HALF+1,X'0F'                                                     
         NC    HALF+0(1),HALF+1                                                 
         BZ    RCORD228            NO MATCH - SKIP                              
*&&                                                                             
RCORD220 BRAS  RE,GOFILT                                                        
         BNE   RCORD228                                                         
*                                                                               
         L     R6,COLINDEX         KEYWORD ENTRY FOR COLUMN                     
         LH    R4,COLDSP                                                        
         AR    R4,R7                                                            
         ST    R3,ACURCOL                                                       
         TM    COLOPT2,COLDSKIP    DON'T CHECK DATES                            
         BO    RCORD224                                                         
         TM    POSTCTL,POSTALO$    POST ALLOATED $ BY MONTH ?                   
         BZ    RCORD222                                                         
         CLC   MOADTE,AL$MOA                                                    
         BNE   RCORD228                                                         
*                                                                               
RCORD222 L     RE,COLDATE          A(DATE TO COMPARE TO)                        
         CLC   COLEND,0(RE)                                                     
         BL    RCORD228                                                         
         CLC   COLSTART,0(RE)                                                   
         BH    RCORD228                                                         
*                                                                               
RCORD224 ZAP   PACKAMT,PKZERO                                                   
         SR    RE,RE                                                            
         ICM   RE,3,KYWPRSE                                                     
         BZ    RCORD228                                                         
         A     RE,PRSBASE                                                       
         GOTO1 PARSE,DMCB,(RE),PACKAMT,COLFILT,(R6)                             
         AP    0(PKLEN,R4),PACKAMT                                              
*                                                                               
         TM    COLOPT,COLCZERO                                                  
         BO    RCORD226                                                         
         CP    0(PKLEN,R4),PKZERO        IF ZERO                                
         BE    RCORD226                  LEAVE INDICATOR ON                     
         NI    FMTFLAG2,TURNOFF-FMTNOCB  DATA FOUND, SO OK                      
         DROP  R6                                                               
*                                                                               
RCORD226 TM    COLIND3,COLNATSR                                                 
         BZ    RCORD228                                                         
         ZAP   0(PKLEN,R4),PACKAMT                                              
*                                                                               
RCORD228 LA    R3,COLLNQ(,R3)                                                   
         BCT   R0,RCORD212                                                      
         XC    ACURCOL,ACURCOL                                                  
         EJECT ,                                                                
*=====================================================================*         
* Special processing to eliminate detail so records merger later      *         
*=====================================================================*         
                                                                                
         USING ROWD,R3                                                          
         TM    FMTFLAG2,FMTWIPE+FMTNOCB      WIPE ON DATA INDICATOR             
         BNO   RCORD236                                                         
         L     R3,FMTROW           ROW TABLE                                    
         IC    R0,FMT#ROWS         NUMBER OF ROWS TO PROCESS                    
RCORD230 TM    ROWXPIND,ROWWIPE                                                 
         BZ    RCORD234                                                         
         SR    R2,R2                                                            
         ICM   R2,3,ROWKYSZ                                                     
         BZ    RCORD234                                                         
         LR    R4,R7                                                            
         AH    R4,ROWKYDSP                                                      
         AHI   R2,-1                                                            
         BM    RCORD234                                                         
         CHI   R2,254                                                           
         BNL   RCORD232                                                         
         EXXC  R2,0(R4),0(R4)      WIPE OUT DATA                                
         B     RCORD234                                                         
*                                                                               
RCORD232 LA    RF,1(,R2)           WIPE OUT LONG DATA                           
         LR    RE,R4                                                            
         XCEFL                                                                  
*                                                                               
RCORD234 LA    R3,ROWLNQ(,R3)                                                   
         BCT   R0,RCORD230                                                      
         EJECT ,                                                                
***********************************************************************         
*  BUILD HEADING IN SORT RECORD                                       *         
***********************************************************************         
                                                                                
         USING HEADD,R3                                                         
RCORD236 SR    R0,R0                                                            
         ICM   R0,1,FMT#HEAD                                                    
         BZ    RECORDX                                                          
*                                                                               
         USING KYWD,R6                                                          
         L     R3,FMTHEAD                                                       
RCORD238 L     R6,HEADINDX         POINT TO KEYWORD TABLE ENTRY                 
         OC    KYWPRSE,KYWPRSE     IS THERE DATA TO PARSE ?                     
         BZ    RCORD250                     NO                                  
         TM    HEADFLAG,HEADDEF                                                 
         BO    RCORD240                                                         
         TM    HEADFLAG,HEADROW                                                 
         BZ    RCORD250            Not applicable then                          
         CLC   KYWDD#,=AL2(AC#RSGAP)   GAP keyword                              
         BE    RCORD250                                                         
*                                                                               
RCORD240 LR    R4,R7               R7 = BASE OF RECORD                          
         AH    R4,HEADDISP         R4 = POINT TO DATA                           
         MVI   TMPTRAP,0           Patch to find senerio                        
         SR    R8,R8                                                            
         SR    R2,R2               Is there data at this location ?             
         ICM   R2,3,KYWSRTQ                                                     
         BZ    RCORD250            Skip                                         
         TM    HEADFLAG,HEADADR    Row address ?                                
         BO    RCORD242            Yes so get data                              
                                                                                
         USING ROWD,R8                                                          
         TM    HEADFLAG,HEADROW    Row                                          
         BZ    RCORD242            No                                           
         L     R8,HEADPTR          Yes                                          
         ST    R8,ACURROW          Save location                                
         TM    ROWXPIND,ROWWIPE    Don't undo what was done                     
         BO    RCORD250                                                         
         TM    ROWXPIND,ROWREPTB   Replacement table ?                          
         BO    RCORD250            Don't replace for now                        
         ICM   R2,3,ROWKYSZ                                                     
         BZ    RCORD250                                                         
         BCTR  R2,0                One extra because of recapping               
*                                                                               
RCORD242 SHI   R2,1                                                             
         BM    RCORD250                                                         
         TM    POSTMODE,POSTJBR    Estimates/Jobber                             
         BO    RCORD244            Yes                                          
         EXOC  R2,0(R4),0(R4)      Do we already have data?                     
         BNZ   RCORD250            Yes so skip                                  
         MVI   TMPTRAP,1                                                        
*                                                                               
RCORD244 SR    RE,RE                                                            
         ICM   RE,3,KYWPRSE                                                     
         BZ    RCORD250                                                         
         A     RE,PRSBASE                                                       
         XC    DMCB,DMCB           Build parms manually (free up R9)            
         ST    RE,DMCB+0           *P1                                          
         ST    R4,DMCB+4           *P2                                          
         ST    R6,DMCB+12          *P4                                          
         TM    HEADFLAG,HEADROW    Test Row                                     
         BZ    RCORD246            No                                           
         L     RE,ROWFILT          (was R9)                                     
         ST    RE,DMCB+8           *P3                                          
         TM    ROWKYIND,ROWKYCDE+ROWKYLVL                                       
         BNO   RCORD246                                                         
         MVI   DMCB+0,PARDLVL      *P1 HOB                                      
         MVC   DMCB+4(1),KYWLVLQ   *P2 HOB - length of level                    
         DROP  R8                                                               
*                                +0    +4   +8  +12                             
**ORD246 GOTO1 PARSE,DMCB,((RF),(RE)),(R4),(R9),(R6) **                         
*                                                                               
RCORD246 GOTO1 PARSE,DMCB                                                       
         BNE   RCORD250                     No data                             
         EXOC  R2,0(R4),0(R4)      Do we already have data?                     
         BZ    RCORD250            No data is okay. Fix later                   
         TM    POSTMODE,POSTJBR    ESTIMATES/JOBBER                             
         JO    RCORD248                                                         
         TM    HEADFLAG,HEADROW    Row                                          
         BZ    RCORD248            No                                           
         TM    HEADFLAG,HEADADR    Row address ?                                
         BO    RCORD248            Yes so okay                                  
         CLI   TMPTRAP,1                                                        
         BNE   RCORD248                                                         
         DC    H'00'               See why - can add special case ?             
                                                                                
RCORD248 TM    KYWIND1,KYWUNQ      IS DATA UNIQUE?                              
         BO    RCORD250                                                         
         LH    RF,RECIDX#                                                       
         AHI   RF,-1                                                            
         BNP   RCORD250            DUPLICATE DATA FOR OTHER RECORDS             
         LR    RE,R4                                                            
         SH    RE,SRTRECLN         FILL IN KEY DATA TO OTHER RECORDS            
         EX    R2,FILLDATA                                                      
         BCT   RF,*-8                                                           
*                                                                               
RCORD250 LA    R3,HEADLNQ(,R3)                                                  
         BCT   R0,RCORD238                                                      
         DROP  R6                                                               
*                                                                               
RECORDX  XI    SAVEMODE,X'FF'                                                   
         NC    POSTMODE,SAVEMODE   TURNOFF MODE                                 
         XI    SAVELVL,X'FF'                                                    
         NC    POSTLVL,SAVELVL     TURNOFF LEVEL                                
         XMOD1                                                                  
         DROP  R5                                                               
FILLDATA MVC   0(0,RE),0(R4)                                                    
CMPNULLS OC    0(0,RE),0(RE)                                                    
CMPHEXFF CLC   0(0,RE),HEXFF                                                    
HEXFF    DC    72X'FF'                                                          
ROWSVLVL DS    XL1                                                              
TMPTRAP  DS    XL1                                                              
         EJECT ,                                                                
         SPACE 2                                                                
         LTORG                                                                  
         EJECT ,                                                                
**********************************************************************          
* Process BUKELD element(s)                                                     
**********************************************************************          
         USING COLD,R3                                                          
         USING BUKELD,R2                                                        
BUKPST   NMOD1 0,**BUKPS*                                                       
         L     RC,RLBASEC                                                       
         L     R2,0(,R1)                                                        
         L     R3,4(,R1)                                                        
         SR    R1,R1                                                            
BUKPST10 CLI   0(R2),EOR           End of record                                
         JE    BUKPSTX                                                          
         CLI   BUKEL,PBKELQ        X'55' Prior bucket element                   
         JE    BUKPSTX             Done, since comes after x'45'                
         CLI   BUKEL,BUKELQ        X'45' Bucket element                         
         JNE   BUKPST70            Next element                                 
*&&US                                                                           
         CLI   QPROG,GENERAL       Only for General Ledger                      
         BNE   BUKPST13                                                         
         CLC   BUKMOS,SVGLBMOS     Has to be after GL GB's MOS                  
         BH    BUKPST13                                                         
         ZAP   BUKDR,=P'0'                                                      
         ZAP   BUKCR,=P'0'                                                      
*&&                                                                             
BUKPST13 CLC   BUKMOS,RMOAEND                                                   
         JH    BUKPSTX             Next column                                  
         CLC   BUKMOS,COLEND       MOA within range?                            
         JH    BUKPSTX             Next column                                  
         CLC   BUKMOS,RMOASTR                                                   
         JL    BUKPST70            Next element                                 
         CLC   BUKMOS,COLSTART                                                  
         JL    BUKPST70            Next element                                 
         LA    RE,BUKDR                                                         
         TM    COLIND1,COLBUKDR    Debit or credit bucket                       
         JO    *+8                                                              
         LA    RE,BUKCR                                                         
                                                                                
         SR    RF,RF                                                            
         ICM   RF,3,COLDD#         Set keyword unique #                         
         CLI   QPROG,GENERAL                                                    
         JNE   BUKPST20                                                         
         TM    FCIND,FCNEWGL       New GL                                       
         JZ    BUKPST20                                                         
         CHI   RF,AC#RSBAL         Balance keyword                              
         JNE   BUKPST15            No                                           
         LA    RE,DUB+(L'DUB-L'BUKDR)                                           
         ZAP   DUB,BUKDR                                                        
         SP    DUB,BUKCR                                                        
         J     BUKPST40                                                         
*                                                                               
BUKPST15 DS    0H                                                               
*&&US*&& CHI   RF,AC#PLBAL         Reverse Balance keyword                      
*&&UK*&& C     RF,=AL4(AC#PLBAL)   (UK) Number is > x'7FFF'                     
         JNE   BUKPST40            No                                           
         LA    RE,DUB+(L'DUB-L'BUKDR)                                           
         ZAP   DUB,BUKCR                                                        
         SP    DUB,BUKDR                                                        
         J     BUKPST40                                                         
                                                                                
BUKPST20 CLI   QPROG,PNL           Profit & Loss ?                              
         JNE   BUKPST40            No                                           
         LA    RE,DUB+(L'DUB-L'BUKDR)                                           
         ZAP   DUB,BUKDR           Do debits minus credits                      
         SP    DUB,BUKCR                                                        
         CLI   CURSUBAC+2,C'3'     Biling or revenue ?                          
         JL    BUKPST30            Yes so okay                                  
         ZAP   DUB,BUKCR           Do credits minus debits                      
         SP    DUB,BUKDR                                                        
*                                                                               
BUKPST30 DS    0H                                                               
*&&US                                                                           
         CHI   RF,AC#RSNI$         Net income keyword ?                         
         JNE   BUKPST40            No                                           
         CLI   CURSUBAC+2,C'2'     Revenue contra ?                             
         JE    BUKPST40            Yes                                          
         MP    DUB,PKNEG           Revenue - (Direct + Indirect)                
*&&                                                                             
BUKPST40 AP    0(PKLEN,R4),0(L'BUKDR,RE)       Bucket amount                    
*                                                                               
BUKPST70 TM    POSTCTL,POSTBYDT    Post by date of bucket ?                     
         JO    BUKPSTX             Yes, so done                                 
         IC    R1,1(,R2)                                                        
         AR    R2,R1                                                            
         J     BUKPST10                                                         
                                                                                
BUKPSTX  XIT1                                                                   
         DROP  R2,R3                                                            
         EJECT ,                                                                
**********************************************************************          
* Process PBKELD element(s)                                                     
**********************************************************************          
         USING COLD,R3                                                          
         USING PBKELD,R2                                                        
PBKPST   NMOD1 0,**PBKPS*                                                       
         L     RC,RLBASEC                                                       
         L     R2,0(,R1)                                                        
         L     R3,4(,R1)                                                        
         SR    R1,R1                                                            
PBKPST10 CLI   0(R2),EOR           End of record                                
         JE    PBKPSTX                                                          
         CLI   PBKEL,PBKELQ        X'55' Prior bucket element                   
         JNE   PBKPST70            Next element                                 
*&&US                                                                           
         CLI   QPROG,GENERAL       Only for General Ledger                      
         BNE   PBKPST13                                                         
         TM    TABIND,TABGBMOS     GL RECORDS                                   
         BZ    PBKPST13                                                         
         CLC   PBKHI,SVGLBMOS      Has to be after GL GB's MOS                  
         BH    PBKPST13                                                         
         ZAP   PBKDR,=P'0'                                                      
         ZAP   PBKCR,=P'0'                                                      
*&&                                                                             
PBKPST13 CLC   PBKLOW,RMOAEND                                                   
         JH    PBKPSTX             Next column                                  
         CLC   PBKLOW,COLEND       MOA within range?                            
         JH    PBKPSTX             Next column                                  
         CLC   PBKHI,RMOASTR                                                    
         JL    PBKPST70            Next element                                 
         CLC   PBKHI,COLSTART                                                   
         JL    PBKPST70            Next element                                 
         LA    RE,PBKDR                                                         
         TM    COLIND1,COLBUKDR    Debit or credit bucket                       
         JO    *+8                                                              
         LA    RE,PBKCR                                                         
                                                                                
         SR    RF,RF                                                            
         ICM   RF,3,COLDD#         Set keyword unique #                         
         CLI   QPROG,GENERAL                                                    
         JNE   PBKPST20                                                         
         TM    FCIND,FCNEWGL       New GL                                       
         JZ    PBKPST20                                                         
         CHI   RF,AC#RSBAL         Balance keyword                              
         JNE   PBKPST15            No                                           
         LA    RE,DUB+(L'DUB-L'PBKDR)                                           
         ZAP   DUB,PBKDR                                                        
         SP    DUB,PBKCR                                                        
         J     PBKPST40                                                         
*                                                                               
PBKPST15 DS    0H                                                               
*&&US*&& CHI   RF,AC#PLBAL         Reverse Balance keyword                      
*&&UK*&& C     RF,=AL4(AC#PLBAL)   (UK) Number is > x'7FFF'                     
         JNE   PBKPST40            No                                           
         LA    RE,DUB+(L'DUB-L'BUKDR)                                           
         ZAP   DUB,PBKCR                                                        
         SP    DUB,PBKDR                                                        
         J     BUKPST40                                                         
                                                                                
PBKPST20 CLI   QPROG,PNL           Profit & Loss ?                              
         JNE   PBKPST40            No                                           
         LA    RE,DUB+(L'DUB-L'PBKDR)                                           
         ZAP   DUB,PBKDR           Do debits minus credits                      
         SP    DUB,PBKCR                                                        
         CLI   CURSUBAC+2,C'3'     Biling or revenue ?                          
         JL    PBKPST30            Yes so okay                                  
         ZAP   DUB,PBKCR           Do credits minus debits                      
         SP    DUB,PBKDR                                                        
*                                                                               
PBKPST30 DS    0H                                                               
*&&US                                                                           
         CHI   RF,AC#RSNI$         Net income keyword ?                         
         JNE   PBKPST40            No                                           
         CLI   CURSUBAC+2,C'2'     Revenue contra ?                             
         JE    PBKPST40            Yes                                          
         MP    DUB,PKNEG           Revenue - (Direct + Indirect)                
*&&                                                                             
PBKPST40 AP    0(PKLEN,R4),0(L'PBKDR,RE)       Bucket amount                    
*                                                                               
PBKPST70 TM    POSTCTL,POSTBYDT    Post by date of bucket ?                     
         JO    PBKPSTX             Yes, so done                                 
         IC    R1,1(,R2)                                                        
         AR    R2,R1                                                            
         J     PBKPST10                                                         
                                                                                
PBKPSTX  XIT1                                                                   
         DROP  R2,R3                                                            
         LTORG                                                                  
         TITLE 'PROCESS PAYROLL RECORDS BY PERSON'                              
***********************************************************************         
*  Routine to process payroll records                                 *         
*  Do not use R5, Contains address of current FORMAT FOR ARECORD      *         
***********************************************************************         
         USING PHIRECD,R2                                                       
         USING LDGD,R3                                                          
         USING FMTRECD,R5                                                       
         SPACE 1                                                                
PAYROLLS DS    0D                                                               
         NMOD1 0,**PAY$**                                                       
         L     RC,RLBASEC          R3 = SET TO LEDGER INFO                      
         LA    R2,IOKEY                                                         
         GOTO1 GETLDGR,DMCB,=C'1R'                                              
         L     R3,0(,R1)           GET ENTERY                                   
         XC    PAYBUK#,PAYBUK#     RESET TO ZERO RATE IN TABLE                  
         MVC   PAYRKEY,SPACES                                                   
         MVC   PHIKEY,SPACES                                                    
         MVI   PHIKTYP,PHIKTYPQ    X'3E' PAYROLL RECORD                         
         MVI   PHIKSUB,PHIKSUBQ    X'05'                                        
         MVC   PHIKCPY,CURACC      COMPANY CODE                                 
         SR    R1,R1                                                            
         IC    R1,LDGLVQ1          MOVE IN OFFICE                               
         LA    RE,CURACC+3                                                      
         BCTR  R1,0                                                             
         EXMVC R1,PHIKOFC,0(RE)                                                 
*                                                                               
         LA    RE,1(R1,RE)         POINT TO 2ND LEVEL                           
         IC    R1,LDGLVQ2          MOVE IN DEPARTMENT                           
         BCTR  R1,0                                                             
         EXMVC R1,PHIKDPT,0(RE)                                                 
*                                                                               
         LA    RE,1(R1,RE)         POINT TO 3RD LEVEL                           
         IC    R1,LDGLVQ3          MOVE IN SUB DEPARTMENT                       
         BCTR  R1,0                                                             
         EXMVC R1,PHIKSBD,0(RE)                                                 
*                                                                               
         LA    RE,1(R1,RE)         POINT TO 4TH LEVEL                           
         IC    R1,LDGLVQ4          MOVE IN PERSON CODE                          
         BCTR  R1,0                                                             
         EXMVC R1,PHIKPER,0(RE)                                                 
         XC    PHIKMOA,PHIKMOA                                                  
         MVC   PAYRKEY,PHIKCPY                                                  
         MVI   PHIKSEQ,0                                                        
         L     R1,=AL4(IOBUD+IOHIGH+IOACFIL)                                    
         CLI   RMOAEND,X'FF'       Any MOA end date ?                           
         BE    PAYROL12            No                                           
*        TM    POSTLVL,POSTDET     Yes, transaction level reporting ?           
*        BO    PAYROL12            Yes, so process more rates                   
         SR    RF,RF                                                            
         ICM   RF,3,RMOAEND        READ LASTEST MOA                             
         LNR   RF,RF                                                            
         STCM  RF,3,PHIKMOA                                                     
*                                                                               
PAYROL12 GOTO1 AIO                                                              
         XC    AELEM86,AELEM86                                                  
         L     R2,ABUDIO                                                        
         MVC   PAYIOKEY,PHIKEY                                                  
         SR    RF,RF                                                            
         ICM   RF,3,PHIKMOA        IN 2'S COMPLEMENT                            
         LNR   RF,RF                                                            
         STCM  RF,3,CURRMOA        CURRENT MOA FOR RECORD                       
         MVI   CURRMOA+2,01        SET DD FOR PACKED YYMMDD                     
         MVC   POSTMOA,CURRMOA     SET FIRST MOA TO POST                        
         CLC   PAYRKEY,PHIKCPY     SAME PERSONS KEY?                            
         BNE   PAYROL60            NO RECORDS FOUND, SO FINISHED                
*                                                                               
*        TM    POSTLVL,POSTDET     Transaction type reporting ?                 
*        BO    PAYROL14            Pull in prior MOA's                          
         CLC   POSTMOA(2),RMOASTR  Before request start ?                       
         JL    PAYROL50            Yes, try next MOA                            
PAYROL14 CLC   POSTMOA(2),RMOAEND  After request end ?                          
         JH    PAYROL50            Yes, try next MOA                            
*                                                                               
         USING PDEELD,R2                                                        
PAYROL15 AH    R2,DATADISP                                                      
PAYROL20 CLI   0(R2),0             EOR                                          
         BE    PAYROL50            Next record                                  
         CLI   0(R2),PDEELQ        X'86' Payroll detail                         
         BNE   PAYROL45            Next element                                 
*                                  Filter out certain paycodes                  
         GOTO1 AFILTER,DMCB,AFLTPCDE,PDENUM,0                                   
         BNE   PAYROL45            Next element                                 
         CLC   PDEDTE(2),RTRNSTR   Is payroll date within start date ?          
         BL    PAYROL45            No, next element                             
         CLC   PDEDTE(2),RTRNEND   Is payroll date within end   date ?          
         BH    PAYROL45            No, next element                             
*&&DO                                                                           
         TM    PDESTAT2,PDESHRTE   Hourly rate ?                                
         BO    PAYROL28            Yes so don't filter by MOA                   
         CLC   PDEDTE(2),RMOASTR   Before request start ?                       
         JL    PAYROL45            Yes, try next MOA                            
         CLC   PDEDTE(2),RMOAEND   After request end ?                          
         JH    PAYROL45            Yes, try next MOA                            
*&&                                                                             
         USING MTHDD,R8                                                         
PAYROL28 LA    R7,METHODS          Table of methods we need only                
         LA    R4,L'METHODS                                                     
PAYROL30 CLI   0(R7),0             Method not used if zero                      
         BE    PAYROL40            Skip and try next                            
         LH    R1,CSTMTHDS         Number of methods on file                    
         L     R8,MHDBASE          Start of method info table                   
         CLC   MTHDNUM,0(R7)                                                    
         BE    PAYROL33                                                         
         LA    R8,MTHDLNQ(,R8)                                                  
         BCT   R1,*-14                                                          
         DC    H'00'               Method must exist                            
                                                                                
PAYROL33 LA    R6,(MTHDIDR-MTHDTOT)/32                                          
PAYROL34 LR    R1,R6                                                            
         MHI   R1,L'MTHDTOT                                                     
         LA    R1,MTHDTOT(R1)                                                   
         SR    R0,R0                                                            
         IC    R0,PDENUM           Pay code number                              
         LR    RF,R0                                                            
         SRL   RF,3                DIVIDE BY 8 (8 BITS TO A BYTE)               
         AR    R1,RF               POINT TO BYTE IN LINE                        
         LA    RE,X'07'            RE=POWER OF 2                                
         NR    RE,R0                                                            
         LA    RF,X'80'            RF=MASK BIT                                  
         SRL   RF,0(RE)                                                         
         EX    RF,*+8                                                           
         BO    PAYROL35                                                         
         TM    0(R1),0                                                          
         BCT   R6,PAYROL34                                                      
         B     PAYROL40            NO NEED TO PROCESS THIS METHOD               
*                                                                               
R        USING PHSELD,PAYHIST                                                   
*                                                                               
PAYROL35 XC    PAYHIST,PAYHIST                                                  
         MVC   R.PHSDATE,PDEDTE                                                 
         MVC   R.PHSCODE,PDENUM                                                 
*                                                                               
         MVC   R.PHSMTHD,MTHDNUM                                                
         STC   R6,R.PHSBUCK                                                     
         OI    R.PHSBUCK,X'F0'     Char's C'1'- C'4',<SAL,PEN,BEN,IND>          
         TM    PDESTAT2,PDESHRTE   Hourly rate ?                                
         BZ    *+8                                                              
         OI    R.PHSIND,PHSRTE                                                  
         ZAP   R.PHSAMNT,PDEAMT                                                 
         AP    R.PHSAMNT,PDEADJ                                                 
         LH    R6,PAYBUK#          Total number of entries                      
         SAM31                     31 bit mode                                  
         GOTO1 BIN31,DMCB,PAYHIST,APAYHIST,(R6),(1,PHSLNQ),            X        
               (0,PHSKLNQ),MAXPHISQ                                             
         MVC   PAYBUK#,DMCB+10     Update number of entries                     
         ICM   RE,15,DMCB                                                       
         BNZ   *+6                 Next element                                 
         DC    H'00'               Table full                                   
*                                                                               
         USING PHSELD,RE                                                        
         TM    DMCB,X'80'          Record found ?                               
         BO    *+10                No, record not found, so added               
         AP    PHSAMNT,R.PHSAMNT   Found, add into amount already there         
         SAM24                     Back to 24 bit mode                          
         DROP  R8,RE                                                            
*                                                                               
PAYROL40 LA    R7,1(,R7)           Next method                                  
         BCT   R4,PAYROL30                                                      
*                                                                               
PAYROL45 SR    R1,R1                                                            
         IC    R1,1(,R2)           Bump to next element                         
         AR    R2,R1                                                            
         B     PAYROL20                                                         
*                                                                               
         USING PHIRECD,R2                                                       
PAYROL50 L     R1,=AL4(IOBUD+IOSEQ+IOACFIL)                                     
         LA    R2,IOKEY                                                         
         CLC   PHIKEY,PAYIOKEY     DID WE BREAK SEQUENSE ?                      
         BE    PAYROL12            NO                                           
         L     R1,=AL4(IOBUD+IOHIGH+IOACFIL)                                    
         MVC   PHIKEY,PAYIOKEY                                                  
         SR    RF,RF                                                            
         IC    RF,PHIKSEQ                                                       
         AHI   RF,1                                                             
         STC   RF,PHIKSEQ                                                       
         B     PAYROL12                                                         
         DROP  R2                                                               
*                                                                               
         USING PHSELD,R6                                                        
PAYROL60 SAM31                     31 bit mode                                  
         SR    R0,R0                                                            
         ICM   R0,3,PAYBUK#        Total number of rates for person             
         BZ    PAYROLLX                                                         
         LR    R6,R0                                                            
         MHI   R6,PHSLNQ           Length of each entry                         
         A     R6,APAYHIST         Point to end of table                        
         XC    0(PHSLNQ,R6),0(R6)  Clear one beyond                             
                                                                                
         L     R6,APAYHIST         Rates and add effective dates                
         TM    PHSIND,PHSRTE       Rate type ?                                  
         BO    PAYROL62            Start of rates                               
         AHI   R6,PHSLNQ                                                        
         BRCT  R0,*-12                                                          
         B     PAYROLLX            No rates to set                              
                                                                                
NXT      USING PHSELD,R5                                                        
                                                                                
PAYROL62 LR    R5,R6                                                            
         AHI   R5,PHSLNQ           Look ahead                                   
         MVC   PHSEFSDT,PHSDATE    Effective start date                         
         MVC   PHSEFEDT,=X'FFFF'   Effective end   date (default)               
         CLC   NXT.PHSMTHD(2),PHSMTHD                                           
         BNE   *+10                                                             
         MVC   PHSEFEDT,NXT.PHSDATE                                             
         LR    R6,R5               Process next                                 
         BRCT  R0,PAYROL62                                                      
                                                                                
PAYROLLX SAM24                     Back to 24 bit mode                          
         XMOD1                                                                  
         DROP  NXT                                                              
         DROP  R5,R6                                                            
         SPACE 2                                                                
PAYIOKEY DS    CL(L'PHIKEY)                                                     
PAYRKEY  DS    CL(PHIKMOA-PHIKCPY)                                              
PAYHIST  DS    CL(PHSLNQ)                                                       
CURRMOA  DS    XL3                                                              
POSTMOA  DS    XL3                                                              
LASTMOA  DS    XL3                                                              
PRIORDTE DS    XL3                                                              
CURDTE   DS    XL3                                                              
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'Set payroll total elements'                                     
*=====================================================================*         
* Set payroll total amount per trans, multiple times                            
*=====================================================================*         
         USING COLD,R3                                                          
         USING P$TELD,R4                                                        
         USING FMTRECD,R5                                                       
SETPAYT  STM   RE,R4,SVRE                                                       
         OC    FMTPAY$,FMTPAY$                                                  
         BZR   RE                                                               
         LTR   R1,R1               If zero then process                         
         JZ    SETPAY08                                                         
         SR    RF,RF               If not zero then reset then process          
         ICM   R4,15,FMTPAY$                                                    
         JZ    SETPAY08                                                         
                                                                                
         LR    R2,R4               R2 = location of 1st element                 
SETPAY02 CLI   0(R4),EOR                                                        
         JE    SETPAY08                                                         
         NI    P$TIND,TURNOFF-P$TDONE   Start over                              
         MVI   0(R4),P$TELQ             Reset element                           
                                                                                
         TM    PHISIND,PHISMOA                                                  
         JZ    SETPAY07                                                         
         CLC   P$TMOA,SAVEMOS      Match on transaction MOA                     
         JNE   SETPAY07                                                         
         IC    RF,P$TLN                                                         
         BCTR  RF,0                                                             
         CR    R2,R4                                                            
         JE    SETPAY03                                                         
                                                                                
         BASR  R1,0                                                             
         USING *,R1                                                             
         EX    RF,8(R1)                                                         
         J     *+10                                                             
         XC    0(0,R2),0(R4)      Swap elements                                 
                                                                                
         BASR  R1,0                                                             
         EX    RF,8(R1)                                                         
         J     *+10                                                             
         XC    0(0,R4),0(R2)                                                    
                                                                                
         BASR  R1,0                                                             
         EX    RF,8(R1)                                                         
         J     *+10                                                             
         XC    0(0,R2),0(R4)                                                    
         DROP  R1                                                               
                                                                                
SETPAY03 LA    R2,1(RF,R2)         Point to next element                        
*                                                                               
SETPAY07 IC    RF,P$TLN                                                         
         AR    R4,RF                                                            
         J     SETPAY02                                                         
                                                                                
SETPAY08 MVI   BYTE,NO             At end of record ? No                        
         L     R3,FMTCOL                                                        
         SR    R0,R0                                                            
         IC    R0,FMT#COLS                                                      
         SR    RF,RF                                                            
         ICM   R4,15,FMTPAY$                                                    
         JZ    SETPAY11                                                         
                                                                                
SETPAY10 CLI   0(R4),EOR           No more to process                           
         JNE   SETPAY12                                                         
                                                                                
SETPAY11 MVI   BYTE,YES            At end of record ? Yes                       
         J     SETPAY20                                                         
                                                                                
SETPAY12 LA    R1,P$TAMT                                                        
         TM    P$TIND,P$TDONE      Did we use this one ?                        
         JZ    SETPAY20            No                                           
         IC    RF,P$TLN            Yes, try next                                
         AR    R4,RF                                                            
         J     SETPAY10                                                         
                                                                                
SETPAY20 TM    COLFLAGS,COLAMT                                                  
         JZ    SETPAY30                                                         
         SR    RF,RF                                                            
         TM    COLIND1,COLPADJ$                                                 
         JZ    SETPAY30                                                         
                                                                                
SETPAY22 ZAP   COLPROLL,PKZERO     Clear                                        
         CLI   BYTE,YES                   At end of record ?                    
         JE    SETPAY30                   Then don't set                        
         SR    RF,RF                                                            
         IC    RF,COLPAY#                                                       
         BCTR  RF,0                                                             
         MHI   RF,L'P$TAMT                                                      
         AR    RF,R1                      Start of P$TAMT's                     
         ZAP   COLPROLL,0(L'P$TAMT,RF)    Set payroll total amount              
                                                                                
SETPAY30 AHI   R3,COLLNQ                                                        
         BRCT  R0,SETPAY20                                                      
                                                                                
         CLI   FMT#PAY$,0          Were there any elements ?                    
         JE    *+8                 No                                           
         OI    P$TIND,P$TDONE      Mark done / applied to columns               
SETPAY90 LM    RE,R4,SVRE                                                       
         BR    RE                                                               
         DROP  R3,R4,R5                                                         
         TITLE 'Set payroll tables for person'                                  
***********************************************************************         
*  Build payroll amounts table table for the columns                  *         
*  Build payroll rates   table                                        *         
*  For rates this is called at PROCACC and PROCTIME                   *         
***********************************************************************         
         SPACE 1                                                                
         USING FMTRECD,R5                                                       
         USING PHSELD,R6                                                        
COLPAYR  NMOD1 0,**CPAY**                                                       
         L     RC,RLBASEC                                                       
         L     R5,AFORMATS         Initialize formats values                    
         LH    R2,FORMAT#          # of formats to process                      
                                                                                
COLPAY02 MVI   FMT#PAYR,0          # of RT$ELD created for format               
         XC    FMTRTES,FMTRTES     Rates   A(0)                                 
         CLI   MODE,PROCACC                                                     
         BNE   COLPAY03                                                         
         MVI   FMT#PAY$,0          # pf P$TELD created for format               
         XC    FMTPAY$,FMTPAY$     Amounts A(0)                                 
                                                                                
COLPAY03 AHI   R5,FMTLNQ           Next format                                  
         BRCT  R2,COLPAY02                                                      
                                                                                
         SR    R7,R7                                                            
         ICM   R7,3,PAYBUK#        Total number of payroll elements             
         BZ    COLPXIT             Nothing to do                                
         L     R5,AFORMATS                                                      
         LH    R2,FORMAT#          # of formats to process                      
         CLI   MODE,PROCTIME       Time                                         
         BE    COLPAY60                                                         
         CLI   MODE,PROCTRNS       Transaction converted to TMS                 
         BE    COLPAY60                                                         
         CLI   MODE,ACCLAST        Acc last for ones we missed                  
         BE    COLPAY60                                                         
         MVC   APAY$,APAYTOTS      Initialize payroll area addresses            
         MVC   ARTES,APAYRTE2                                                   
                                                                                
         SAM31                     31 bit mode                                  
COLPAY05 TM    PHISIND,PHISON      Payroll history needed for format ?          
         JZ    COLPAY40            No, process next format                      
                                                                                
         L     R6,APAYHIST         Payroll histories                            
COLPAY10 TM    PHSIND,PHSRTE       Rate                                         
         JO    COLPAY30            No, process rates                            
                                                                                
**********************************************************************          
* Add payroll amounts by format                                                 
**********************************************************************          
COLPAY15 OC    FMTPAY$,FMTPAY$     Did we set the address ?                     
         JNZ   COLPAY18                                                         
         L     RE,APAY$                                                         
         ST    RE,FMTPAY$          Set A(Payroll amounts)                       
         MVI   0(RE),EOR           Initialize to zero                           
                                                                                
COLPAY18 TM    PHSIND,PHSRTE       Are we finished with amounts ?               
         BO    COLPAY20            Yes, no process rates                        
         BRAS  RE,PAYADD                                                        
         AHI   R6,PHSLNQ                                                        
         BRCT  R7,COLPAY15                                                      
                                                                                
COLPAY20 L     RE,APAY$END                                                      
         AHI   RE,1                                                             
         ST    RE,APAY$            Set to new address                           
         ST    RE,APAY$END         Set to new address                           
         LTR   R7,R7                                                            
         BZ    COLPAY40            Next format                                  
                                                                                
**********************************************************************          
* Add payroll rates by format                                                   
**********************************************************************          
COLPAY30 OC    FMTRTES,FMTRTES     Did we set the address ?                     
         JNZ   COLPAY32                                                         
         L     RE,ARTES                                                         
         ST    RE,FMTRTES          Set A(Payroll rates)                         
         MVI   0(RE),EOR           Initialize to zero                           
                                                                                
COLPAY32 BRAS  RE,RTEADD           Add rate to table                            
         AHI   R6,PHSLNQ                                                        
         BRCT  R7,COLPAY30                                                      
                                                                                
         L     RE,ARTESEND                                                      
         AHI   RE,1                                                             
         ST    RE,ARTES            Set to new address                           
         ST    RE,ARTESEND         Set to new address                           
                                                                                
COLPAY40 AHI   R5,FMTLNQ           Next FMTRECD format                          
         ICM   R7,3,PAYBUK#        Total number of payroll elements             
         BRCT  R2,COLPAY05                                                      
         SAM24                     Back to 24 bit mode                          
         J     COLPXIT                                                          
                                                                                
**********************************************************************          
* Build payroll rates based on time sheet date by TMS record                    
**********************************************************************          
COLPAY60 SAM31                     31 bit mode                                  
         L     RE,APAYRTE2                                                      
         MVI   0(RE),EOR           Set end of record                            
         XC    FMTRTES,FMTRTES     A(0) Set to no rates                         
         LR    R6,R7               Find last table entry                        
         BCTR  R6,0                                                             
         MHI   R6,PHSLNQ                                                        
         A     R6,APAYHIST                                                      
         TM    PHSIND,PHSRTE       See if there is at least one                 
         JZ    COLPAY80            None, so skip                                
                                                                                
         L     R6,APAYHIST         Payroll histories                            
         TM    PHSIND,PHSRTE       Find first rate entry                        
         BO    *+14                                                             
         AHI   R6,PHSLNQ                                                        
         BRCT  R7,*-12                                                          
         DC    H'00'               No rates, did something wrong                
                                                                                
         MVC   FMTRTES,APAYRTE2    Reset                                        
         L     RE,FMTRTES                                                       
         MVI   0(RE),EOR           Set end of record                            
                                                                                
COLPAY70 CLI   MODE,ACCLAST        Acc last for ones we missed                  
         BE    COLPAY76            Don't check MOA since                        
         CLC   MOADTE(2),PHSDATE   Match on MOA and payroll MOA                 
         BNE   COLPAY78            No, so try another                           
                                                                                
*OLPAY72 CLC   TRANDTE,PHSEFSDT    Lower then effective start date ?            
*        BL    COLPAY78            Yes, so try another                          
*        CLC   TRANDTE,PHSEFEDT    If equal or higher than skip it              
*        BNL   COLPAY78                                                         
                                                                                
COLPAY76 BRAS  RE,RTEADD           Add rate to table                            
                                                                                
COLPAY78 AHI   R6,PHSLNQ                                                        
         BRCT  R7,COLPAY70                                                      
                                                                                
COLPAY80 MVC   FULL,FMTRTES        A(Rates) or A(0)                             
         MVC   FMTRTES,FULL        Set all formats to same place                
         AHI   R5,FMTLNQ           Next format                                  
         BRCT  R2,*-10                                                          
         SAM24                     Back to 24 bit mode                          
                                                                                
COLPXIT  XIT1                                                                   
         DROP  R6                                                               
         SPACE 3                                                                
PAY$LN   DS    H                                                                
APAY$    DS    A                   A(Current payroll table by format)           
APAY$END DS    A                   A(Current end of table)                      
ARTES    DS    A                   A(Current rates   table by format)           
ARTESEND DS    A                   A(Current end of table)                      
         EJECT ,                                                                
***********************************************************************         
*   Add/Accmulate amounts by format to table                                    
***********************************************************************         
         USING P$TELD,R4                                                        
         USING PHSELD,R6                                                        
PAYADD   NTR1                                                                   
         SR    RF,RF                                                            
         IC    RF,FMT#P$AJ         Payroll adjusted keyword used ?              
         MHI   RF,L'P$TAMT                                                      
         AHI   RF,P$TLNQ                                                        
         STH   RF,PAY$LN           Length of an P$TELD entry                    
                                                                                
         L     R4,FMTPAY$                                                       
PAYADD02 CLI   0(R4),EOR           End of table ?                               
         JE    PAYADD15            Yes                                          
                                                                                
PAYADD04 CLC   P$TMTHD,PHSMTHD     Same method ?                                
         JNE   PAYADD10            No                                           
         TM    PHISIND,PHISMOA     Post by MOA ?                                
         JZ    PAYADD06            No                                           
         CLC   P$TMOA,PHSDATE                                                   
         JNE   PAYADD10            Try next                                     
                                                                                
PAYADD06 TM    PHISIND,PHISTYPE    Post by pay type                             
         JZ    PAYADD07                                                         
         CLC   P$TTYPE,PHSBUCK                                                  
         JNE   PAYADD10            Try next                                     
                                                                                
PAYADD07 TM    PHISIND,PHISCDNM    Post by payroll code or name                 
         JZ    PAYADD08                                                         
         CLC   P$TCODE,PHSCODE                                                  
         JNE   PAYADD10            Try next                                     
                                                                                
PAYADD08 TM    PHISIND,PHISDATE    Post by payroll date                         
         JZ    PAYADD20            Found                                        
         CLC   P$TDATE,PHSDATE                                                  
         JE    PAYADD20            Found                                        
                                                                                
PAYADD10 AH    R4,PAY$LN           Length of each entry                         
         B     PAYADD02                                                         
                                                                                
*********************************************************************           
* Not found so add new entry                                        *           
*********************************************************************           
PAYADD15 MVI   P$TEL,P$TELQ        Add new entry                                
         MVC   P$TLN,PAY$LN+1                                                   
         TM    PHISIND,PHISMOA     Post by MOA ?                                
         JZ    *+10                No                                           
         MVC   P$TMOA,PHSDATE                                                   
                                                                                
         TM    PHISIND,PHISTYPE    Post by pay type                             
         JZ    *+10                                                             
         MVC   P$TTYPE,PHSBUCK                                                  
                                                                                
         TM    PHISIND,PHISCDNM    Post by payroll code or name                 
         JZ    *+10                                                             
         MVC   P$TCODE,PHSCODE                                                  
                                                                                
         TM    PHISIND,PHISDATE    Post by payroll date                         
         JZ    *+10                                                             
         MVC   P$TDATE,PHSDATE                                                  
                                                                                
         MVC   P$TMTHD,PHSMTHD                                                  
                                                                                
         SR    RF,RF               Clear out amounts                            
         IC    RF,FMT#P$AJ         Number of payroll adj columns                
         LA    RE,P$TAMT                                                        
         ZAP   0(L'P$TAMT,RE),PKZERO                                            
         AHI   RE,L'P$TAMT                                                      
         BRCT  RF,*-10                                                          
                                                                                
         IC    RF,FMT#PAY$         Count the number of elements                 
         AHI   RF,1                                                             
         STC   RF,FMT#PAY$                                                      
                                                                                
         LR    RE,R4                                                            
         AH    RE,PAY$LN                                                        
         MVI   0(RE),EOR           Mark end of table                            
         ST    RE,APAY$END         End of table or new start of next            
                                                                                
**********************************************************************          
* Have entry now fill in amounts                                                
**********************************************************************          
         USING COLD,R3                                                          
PAYADD20 SR    R0,R0                                                            
         IC    R0,FMT#COLS         Check columns for P$ATOT etc. types          
         L     R3,FMTCOL                                                        
         LA    RE,P$TAMT                                                        
PAYADD22 TM    COLFLAGS,COLAMT     Amount column ?                              
         JZ    PAYADD40            No                                           
         TM    COLIND1,COLPAY$     Regular payroll keywords                     
         JZ    PAYADD40            No                                           
                                                                                
PAYADD25 CLC   COLMTHD,PHSMTHD     Right method ?                               
         JNE   PAYADD40            No                                           
         CLI   COLBUCK,X'FF'       Any bucket type (total) ?                    
         JE    PAYADD26            Yes                                          
         CLC   COLBUCK,PHSBUCK     No, match on bucket type                     
         JNE   PAYADD40            No                                           
                                                                                
PAYADD26 CLI   COLDATES,COLMDTE    Column is by MOA                             
         JE    PAYADD35            No                                           
         CLC   PHSDATE,COLSTART                                                 
         JL    PAYADD40                                                         
         CLC   PHSDATE,COLEND                                                   
         JH    PAYADD40                                                         
         J     PAYADD38            This one ok so add                           
                                                                                
PAYADD35 CLC   PHSDATE(2),COLSTART      Column is by CMO                        
         JL    PAYADD40                                                         
         CLC   PHSDATE(2),COLEND                                                
         JH    PAYADD40                                                         
                                                                                
PAYADD38 SR    RF,RF                                                            
         IC    RF,COLPAY#          Point to accum associated with col           
         BCTR  RF,0                                                             
         MHI   RF,L'P$TAMT                                                      
         AR    RF,RE               Add start of P$TAMT                          
         AP    0(L'P$TAMT,RF),PHSAMNT                                           
                                                                                
PAYADD40 AHI   R3,COLLNQ                                                        
         BRCT  R0,PAYADD22         Next COLD column                             
                                                                                
PAYADD90 J     COLPXIT                                                          
         DROP  R3,R4,R6                                                         
                                                                                
***********************************************************************         
*   Add rates by format to table                                                
***********************************************************************         
         USING RT$ELD,R4                                                        
         USING PHSELD,R6                                                        
RTEADD   NTR1                                                                   
         L     R4,FMTRTES                                                       
RTEADD02 CLI   0(R4),EOR                                                        
         JE    RTEADD40                                                         
         CLC   RT$MOA,PHSDATE                                                   
         JNE   RTEADD10            Found                                        
                                                                                
         CLC   RT$MTHD,PHSMTHD     Same method ?                                
         JNE   RTEADD10            No                                           
                                                                                
         TM    PHISIND,PHISTYPE    Post by pay type                             
         JZ    RTEADD06                                                         
         CLC   RT$TYPE,PHSBUCK                                                  
         JNE   RTEADD10            Try next                                     
                                                                                
RTEADD06 TM    PHISIND,PHISCDNM    Post by payroll code or name                 
         JZ    RTEADD08                                                         
         CLC   RT$CODE,PHSCODE                                                  
         JNE   RTEADD10            Try next                                     
                                                                                
RTEADD08 DS    0H                                                               
*        TM    PHISIND,PHISDATE    Post by payroll date                         
*        JZ    RTEADD30            Found                                        
         CLC   RT$DATE,PHSDATE                                                  
         JE    RTEADD30            Found                                        
                                                                                
RTEADD10 ZIC   RF,RT$LN                                                         
         AR    R4,RF                                                            
         J     RTEADD02                                                         
                                                                                
RTEADD30 AP    RT$TOT,PHSAMNT      Add rates together at this level             
         CLI   PHSBUCK,C'1'                                                     
         JNE   *+10                                                             
         AP    RT$SAL,PHSAMNT                                                   
         CLI   PHSBUCK,C'2'                                                     
         JNE   *+10                                                             
         AP    RT$BEN,PHSAMNT                                                   
         CLI   PHSBUCK,C'3'                                                     
         JNE   *+10                                                             
         AP    RT$PEN,PHSAMNT                                                   
         J     RTEADD90                                                         
*                                                                               
RTEADD40 XC    RT$EL(RT$LNQ),RT$EL                                              
         MVI   RT$EL,RT$ELQ        Add new entry                                
         MVI   RT$LN,RT$LNQ                                                     
         MVC   RT$MOA,PHSDATE                                                   
         MVC   RT$MTHD,PHSMTHD                                                  
         ZAP   RT$TOT,PKZERO                                                    
         ZAP   RT$SAL,PKZERO                                                    
         ZAP   RT$BEN,PKZERO                                                    
         ZAP   RT$PEN,PKZERO                                                    
                                                                                
         TM    PHISIND,PHISTYPE    Post by pay type                             
         JZ    *+10                                                             
         MVC   RT$TYPE,PHSBUCK                                                  
                                                                                
         TM    PHISIND,PHISCDNM    Post by payroll code or name                 
         JZ    *+10                                                             
         MVC   RT$CODE,PHSCODE                                                  
                                                                                
         TM    PHISIND,PHISDATE    Post by payroll date                         
         JZ    *+10                                                             
         MVC   RT$DATE,PHSDATE                                                  
                                                                                
         ZAP   RT$TOT,PHSAMNT      Add rates together at this level             
         CLI   PHSBUCK,C'1'                                                     
         JNE   *+10                                                             
         ZAP   RT$SAL,PHSAMNT                                                   
         CLI   PHSBUCK,C'2'                                                     
         JNE   *+10                                                             
         ZAP   RT$BEN,PHSAMNT                                                   
         CLI   PHSBUCK,C'3'                                                     
         JNE   *+10                                                             
         ZAP   RT$PEN,PHSAMNT                                                   
                                                                                
         AHI   R4,RT$LNQ                                                        
         MVI   0(R4),EOR           Mark end of table / record                   
         ST    R4,ARTESEND         Set to new address                           
                                                                                
         IC    RF,FMT#PAYR         Count the number of elements                 
         AHI   RF,1                                                             
         STC   RF,FMT#PAYR                                                      
                                                                                
RTEADD90 J     COLPXIT                                                          
         DROP  R4,R5,R6                                                         
         SPACE 2                                                                
         LTORG                                                                  
         EJECT ,                                                                
*                                                                               
***********************************************************************         
* Read Limlist records and build TSAR records                         *         
***********************************************************************         
         DS    0H                                                               
         USING ACRL2D,R7                                                        
BLDLML   NMOD1 0,*BLDLML*                                                       
         L     RC,RLBASEC                                                       
         L     R7,AACRL2D                                                       
         L     R4,0(R1)                                                         
         MVC   TSARABUF,0(R4)                                                   
         XC    GSVLDG,GSVLDG                                                    
         XC    BYTE1,BYTE1                                                      
         XC    BYTE2,BYTE2                                                      
         XC    ATSRERRS,ATSRERRS                                                
         XC    GAPFLTLN,GAPFLTLN                                                
         XC    GAPACTLN,GAPACTLN                                                
         NI    LMLBYTE,TURNOFF-LMLMED-LMLCLT-LML1R                              
         USING GAPTABD,R4                                                       
         LA    R4,GAPAREA                                                       
*                                                                               
         USING LLSRECD,R2                                                       
         LA    R2,IOKEY            Read limit list record                       
         XC    LLSKEY,LLSKEY                                                    
         MVI   LLSKTYP,LLSKTYPQ                                                 
         MVI   LLSKSUB,LLSKSUBQ                                                 
         MVC   LLSKCPY,RCCOMPFL                                                 
         MVC   LLSKPIDB,SECPSWD#                                                
                                                                                
         L     R1,=AL4(IOAREA3+IOHIGH+IOACDIR)                                  
         GOTO1 AIO                                                              
         JE    BLDL008                                                          
         DC    H'0'                                                             
                                                                                
BLDL006  LA    R2,IOKEY                                                         
         L     R1,=AL4(IOAREA3+IOSEQ+IOACDIR)                                   
         GOTO1 AIO                                                              
         JE    BLDL008                                                          
         DC    H'0'                                                             
                                                                                
BLDL008  L     RF,AIO3                                                          
         CLC   LLSKEY(LLSKGRP-LLSRECD),0(RF)                                    
         JNE   BLDL190                                                          
                                                                                
BLDL034  L     R1,=AL4(IOAREA3+IOGETREC+IOACMST)                                
         GOTO1 AIO                                                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         USING LIDELD,R3                                                        
         L     R2,AIO3                                                          
         LA    R3,LLSRFST                                                       
                                                                                
BLDL036  CLI   LIDEL,0                                                          
         JE    BLDL006                                                          
BLDL038  CLI   LIDEL,LIDELQ                                                     
         JE    BLDL042                                                          
                                                                                
BLDL040  XR    R0,R0                                                            
         IC    R0,LIDLN                                                         
         AR    R3,R0                                                            
         J     BLDL036                                                          
                                                                                
BLDL042  CLI   LIDTYPE,LIDTCPJL         Read client limlist for both            
         BE    BLDL046                  Prod and Person                         
         CLI   QPROG,PRODUCTION         For Prod also read media limlst         
         BNE   BLDL044                                                          
         CLI   LIDTYPE,LIDTMEDL                                                 
         BE    BLDL046                                                          
         B     BLDL040                                                          
BLDL044  CLI   LIDTYPE,LIDT1RAC         For Person also read 1r limlist         
         BNE   BLDL040                                                          
                                                                                
BLDL046  MVC   BYTE1,LIDTYPE       Save type of element                         
         XR    RF,RF                                                            
         IC    RF,LIDLN                                                         
         LA    RF,LIDELD(RF)       R5=A(End of element)                         
         ST    RF,GENDELE                                                       
         LA    R6,LIDDATA          R6=A(Start of data on LIDELD)                
*                                                                               
AC       USING LIDDATA,R6                                                       
BLDL048  CLM   R6,15,GENDELE       End of element?                              
         JNL   BLDL040             Yes                                          
*                                                                               
*        TM    LIDLAPPL,LIDLREPT        Must be on for report module            
*        BZ    BLDL114                                                          
         MVI   GAPFLTLN,0                                                       
         MVI   GAPACTLN,0                                                       
BLDL052  CLI   LIDTYPE,LIDTMEDL    If type is media never filter                
         BNE   *+12                                                             
         MVI   GAPACTLN,X'01'      Set media length                             
         B     BLDL052B                                                         
         CLI   QPROG,MANPOWER      If Person Scribe and processing              
         BNE   BLDL052A            SJ client element then don't filter          
         CLI   BYTE1,LIDTCPJL      just move in the client                      
         BNE   BLDL052C                                                         
         MVC   GAPACTLN,SJCLILEN   Set to length of client                      
         B     BLDL052B                                                         
BLDL052A CLI   BYTE1,LIDT1RAC      Must be prod Scribe so it 1r elem            
         BNE   BLDL052C            then don't filter                            
         MVI   GAPACTLN,L'ACTKACT                                               
BLDL052B LA    R5,LIDLACT-LIDDATA(R6)     R5=displ to account field             
         B     BLDL086                                                          
BLDL052C CLC   GSVLDG,QUNIT                                                     
         JE    BLDL054                                                          
         MVC   GSVLDG,QUNIT                                                     
         GOTO1 GETLDGR,DMCB,QUNIT                                               
         USING LDGD,RF                                                          
         L     RF,DMCB             Get ledger entry                             
         XC    GLEVELS,GLEVELS                                                  
         MVC   GLEVELS(1),LDGLEV1                                               
         MVC   GLEVELS+1(1),LDGLEV2                                             
         MVC   GLEVELS+2(1),LDGLEV3                                             
         MVC   GLEVELS+3(1),LDGLEV4                                             
         DROP  RF                                                               
*                                                                               
BLDL054  CLC   QACCOUNT,SPACES     Have we read with a filter                   
         JNH   BLDL070             No                                           
         LA    R5,QACCOUNT         Yes - compare entry against filter           
         CLC   0(L'QACCOUNT,R5),SPACES                                          
         JNH   BLDL070                                                          
         ZIC   R1,GLEVELS          Level 1 of ledger                            
         CHI   R1,L'ACTKACT                                                     
         JE    BLDL058                                                          
         AR    R1,R5                                                            
BLDL056  CLI   0(R1),C' '                                                       
         JH    BLDL060                                                          
BLDL058  MVC   GAPFLTLN,GLEVELS     SET FILTER IS LEVEL 1 LENGTH                
         J     BLDL070                                                          
                                                                                
BLDL060  ZIC   R1,GLEVELS+1                                                     
         CHI   R1,L'ACTKACT                                                     
         JE    BLDL062                                                          
         AR    R1,R5                                                            
         CLI   0(R1),C' '                                                       
         JH    BLDL064                                                          
BLDL062  MVC   GAPFLTLN,GLEVELS+1   Set filter is level 2 length                
         J     BLDL070                                                          
                                                                                
BLDL064  ZIC   R1,GLEVELS+2                                                     
         CHI   R1,L'ACTKACT                                                     
         JE    BLDL066                                                          
         AR    R1,R5                                                            
         CLI   0(R1),C' '                                                       
         JH    BLDL068                                                          
BLDL066  MVC   GAPFLTLN,GLEVELS+2   Set filter is level 3 length                
         J     BLDL070                                                          
                                                                                
BLDL068  MVC   GAPFLTLN,GLEVELS+3   Set filter is level 4 length                
                                                                                
BLDL070  LA    R5,LIDLACT-LIDDATA(R6)     R5=displ to account field             
         CLI   0(R5),C' '          Have we got an account                       
         JE    BLDL084             No - could be global entry                   
         ZIC   R1,GLEVELS                                                       
         CHI   R1,L'ACTKACT        Is this a one level ledger                   
         JE    BLDL072             Yes                                          
         AR    R1,R5                                                            
         CLI   0(R1),C' '          Anything passed level 1                      
         JH    BLDL074             Yes                                          
BLDL072  MVC   GAPACTLN,GLEVELS    Set account is level 1 length                
         J     BLDL084                                                          
                                                                                
BLDL074  ZIC   R1,GLEVELS+1        Try at level 2                               
         CHI   R1,L'ACTKACT                                                     
         JE    BLDL076                                                          
         AR    R1,R5                                                            
         CLI   0(R1),C' '                                                       
         JH    BLDL078                                                          
BLDL076  MVC   GAPACTLN,GLEVELS+1  Set account is level 2 length                
         J     BLDL084                                                          
                                                                                
BLDL078  ZIC   R1,GLEVELS+2                                                     
         CHI   R1,L'ACTKACT                                                     
         JE    BLDL080                                                          
         AR    R1,R5                                                            
         CLI   0(R1),C' '                                                       
         JH    BLDL082                                                          
BLDL080  MVC   GAPACTLN,GLEVELS+2  Set account is level 3 length                
         J     BLDL084                                                          
                                                                                
BLDL082  MVC   GAPACTLN,GLEVELS+3  Set account is level 4 length                
*                                                                               
BLDL084  OC    GAPFLTLN,GAPFLTLN   Did we have a filter                         
         JZ    BLDL086             No                                           
         LLC   RE,GAPFLTLN                                                      
         LLC   R0,GAPACTLN                                                      
         CR    R0,RE                                                            
         JH    *+6                                                              
         LR    RE,R0                                                            
         SHI   RE,1                Compare filter to entry in LIDELD            
         BASR  R1,0                                                             
         CLC   0(0,R5),QACCOUNT                                                 
         EX    RE,0(R1)                                                         
         JNE   BLDL114             Reject if not matching                       
         LLC   RE,GAPFLTLN                                                      
         CR    R0,RE                                                            
         JNL   BLDL086                                                          
         MVC   0(L'QACCOUNT,R5),QACCOUNT                                        
         MVC   GAPACTLN,GAPFLTLN                                                
                                                                                
BLDL086  DS    0H                                                               
BLDL096  XC    GAPTDAT1(GAPTLNQ),GAPTDAT1                                       
         CLI   LIDTYPE,LIDTCPJL                                                 
         BNE   *+12                                                             
         MVI   GAPTDAT1,GAPTT2Q                                                 
         OI    LMLBYTE,LMLCLT                                                   
         CLI   LIDTYPE,LIDTMEDL                                                 
         BNE   *+12                                                             
         MVI   GAPTDAT1,GAPTT3Q                                                 
         OI    LMLBYTE,LMLMED      Set that media LimList found                 
         CLI   LIDTYPE,LIDT1RAC                                                 
         BNE   *+12                                                             
         MVI   GAPTDAT1,GAPTT1Q                                                 
         OI    LMLBYTE,LML1R       Set that 1R LimList found                    
         MVC   GAPTACT,SPACES      Clear account to spaces                      
         ZIC   R1,GAPACTLN                                                      
         BCTR  R1,0                                                             
         EXMVC R1,GAPTACT,0(R5)                                                 
         NI    GAPTSTA,TURNOFF-GAPTICL-GAPTECL                                  
         TM    AC.LIDLAPPL,LIDLREPT     Set to Y on Limlist Q row               
         BZ    *+12                                                             
         OI    GAPTSTA,GAPTICL          Yes so set to include in report         
         B     BLDL110                                                          
         OI    GAPTSTA,GAPTECL          No so set to exclude in report          
*                                                                               
BLDL110  STC   R0,GAPTLEN                                                       
         GOTO1 GOATSAR,DMCB,('TSAADD',ATSRERRS),0,GAPAREA,TSARABUF              
         JE    *+6                                                              
         DC    H'0'                                                             
         MVI   BYTE2,1             Set we added an entry                        
*                                                                               
BLDL114  LLC   RF,LIDITLN                                                       
         AR    R6,RF               Goto next sub element                        
         J     BLDL048                                                          
         DROP  AC                                                               
                                                                                
BLDL190  XC    GAPAREA,GAPAREA                                                  
         GOTO1 GOATSAR,DMCB,('TSARDH',ATSRERRS),0,GAPAREA,TSARABUF              
         TM    ATSRERRS,TSEEOF     Is buffer empty                              
         JZ    BLDL200                                                          
         J     BLDLXNE                                                          
                                                                                
BLDL200  CLI   BYTE2,1             Did we add an entry this time                
         JE    BLDL210             Yes                                          
         J     BLDLXNE                                                          
*                                  Sort table                                   
BLDL210  LA    R4,GAPAREA          Point to start of table                      
                                                                                
BLDLXE   SR    RE,RE                                                            
BLDLXNE  LTR   RE,RE                                                            
         XMOD1                                                                  
         DROP  R3,R4,R7                                                         
*                                                                               
***********************************************************************         
* Read TSAR records for limlist                                       *         
* Byte contains:                                                                
* 01 - GAPTT1Q - read 1R entries (Manpower Scribe)                              
* 02 - GAPTT2Q - read client entries (Manpower Scribe)                          
* 03 - GAPTT2Q/GAPTT3Q - read client and media entries (Prod Scribe)            
* 04 - GAPTT2Q - read client entries only (Prod Scribe)                         
***********************************************************************         
         DS    0H                                                               
         USING ACRL2D,R7                                                        
         USING GAPTABD,R4                                                       
RDLML    NMOD1 0,*RDLML*                                                        
         L     RC,RLBASEC                                                       
         L     R7,AACRL2D                                                       
*                                                                               
         LA    R4,GAPAREA                                                       
         XC    GAPAREA,GAPAREA                                                  
         GOTO1 GOATSAR,DMCB,('TSARDH',ATSRERRS),0,GAPAREA,TSARABUF              
         TM    ATSRERRS,TSEEOF     Is buffer empty                              
         JO    RDLMLOK             Than show all                                
*                                                                               
RDLML02  CLI   BYTE,01             Manpower Scribe filtering 1R                 
         BNE   RDLML10                                                          
         TM    LMLBYTE,LML1R       Limlist setup for 1r filtering?              
         BZ    RDLMLOK             No then show this one                        
         CLI   GAPTDAT1,GAPTT1Q    only interested in 1R entries                
         BNE   RDLMLNX             so ignore any that aren't                    
         CLC   CURACC+3(L'GAPTACT),GAPTACT                                      
         BNE   RDLMLNX                                                          
         TM    GAPTSTA,GAPTICL                                                  
         BZ    RDLMLNO                                                          
         B     RDLMLOK                                                          
*                                                                               
RDLML10  CLI   BYTE,02             Manpower Scribe filtering on client          
         BNE   RDLML20                                                          
         TM    LMLBYTE,LMLCLT      Limlist setup for client filtering?          
         BZ    RDLMLOK             No so show this one                          
         CLI   GAPTDAT1,GAPTT2Q    only interested in client entries            
         BNE   RDLMLNX                                                          
         ZIC   R1,SJCLILEN                                                      
         BCTR  R1,0                                                             
         EXCLC R1,CURSJ+2,GAPTACT                                               
         BNE   RDLMLNX                                                          
         TM    GAPTSTA,GAPTICL                                                  
         BZ    RDLMLNO                                                          
         B     RDLMLOK                                                          
*                                                                               
RDLML20  CLI   BYTE,03             Prod Scribe filtering client                 
         BNE   RDLML30                                                          
         TM    LMLBYTE,LMLCLT      Limlist setup for client filtering?          
         BZ    RDLMLOK             No so show this one                          
         CLI   GAPTDAT1,GAPTT2Q                                                 
         BNE   RDLMLNX                                                          
         ZIC   R1,SJCLILEN                                                      
         BCTR  R1,0                                                             
         EXCLC R1,CURACC+3,GAPTACT                                              
         BNE   RDLMLNX                                                          
         TM    GAPTSTA,GAPTICL                                                  
         BZ    RDLMLNO                                                          
         B     RDLMLOK                                                          
*                                                                               
RDLML30  CLI   BYTE,04             Prod Scribe filtering on media               
         BE    *+6                                                              
         DC    H'0'                                                             
         TM    LMLBYTE,LMLMED      Limlist setup for media filtering?           
         BZ    RDLMLOK             No so show this one                          
         CLI   GAPTDAT1,GAPTT3Q    only interested in media entries             
         BNE   RDLMLNX                                                          
         ZIC   R1,SJCLILEN                                                      
         ZIC   RF,SJPRDLEN                                                      
         AR    R1,RF                                                            
         LA    RF,CURSJACC                                                      
         AR    RF,R1                                                            
         CLC   0(1,RF),GAPTACT                                                  
         BNE   RDLMLNX                                                          
         TM    GAPTSTA,GAPTICL                                                  
         BZ    RDLMLNO                                                          
         B     RDLMLOK                                                          
*                                                                               
RDLMLNX  GOTO1 GOATSAR,DMCB,('TSANXT',ATSRERRS),0,GAPAREA,TSARABUF              
         TM    ATSRERRS,TSEEOF     any more?                                    
         JO    RDLMLNO             then exclude                                 
         B     RDLML02                                                          
*                                                                               
RDLMLOK  SR    RA,RA                                                            
RDLMLNO  LTR   RA,RA                                                            
RDLMLX   XIT1                                                                   
         DROP  R4,R7                                                            
*                                                                               
***********************************************************************         
* Interface to limlist TSAR                                           *         
*                                                                     *         
***********************************************************************         
                                                                                
         USING ACRL2D,R7                                                        
GOATSR   NMOD1 0,*GOATSR*                                                       
         L     RC,RLBASEC                                                       
         L     R7,AACRL2D                                                       
*                                                                               
         LR    R2,R1               R2=A(Caller's parameter list)                
         L     R4,12(R2)           R1=A(TSAR block)                             
         MVC   GOTSABUF,0(R1)                                                   
         L     R3,0(R2)            R3=A(error byte)                             
AB       USING TSARD,R4                                                         
         L     R1,8(R2)                                                         
         ST    R1,AB.TSAREC        Address of record buffer area                
         CLI   0(R2),TSAINI        Test initialisation call                     
         JNE   GOATSR02                                                         
         MVC   AB.TSACTN,0(R2)                                                  
         MVC   AB.TSACOM,ADCOMFAC                                               
         LHI   R0,K                                                             
         OC    AB.TSBUFFL,AB.TSBUFFL                                            
         JNZ   *+8                                                              
         STCM  R0,3,AB.TSBUFFL      Set require 1MB off-line                    
         MVI   AB.TSRECI,TSRXTN+TSRMINB2                                        
         MVI   AB.TSKEYL,GAPTLNQ    Set key length                              
         MVI   AB.TSRECL,GAPTLNQ    Set maximum record length                   
         LHI   R0,GAPTLNQ                                                       
         STCM  R0,3,AB.TSRECL                                                   
         MVI   AB.TSINDS,TSINODSK   Set no disk writes (save/restore)           
         MVI   AB.TSIND2,TSI2MANY                                               
         GOTO1 TSARDINE,AB.TSARD                                                
         TM    AB.TSINDS,TSIINIOK                                               
         JNZ   GOATSRE                                                          
         DC    H'0'                 Initialisation failure                      
                                                                                
GOATSR02 TM    AB.TSINDS,TSIINIOK   Test initialised                            
         JZ    GOATSR06                                                         
                                                                                
         MVC   AB.TSACTN,0(R2)      Set action                                  
                                                                                
         CLI   AB.TSACTN,TSASRT     Test sorting                                
         JNE   GOATSR04                                                         
         L     R1,4(R2)                                                         
         MVC   AB.TSRTPARM,0(R1)    Yes - set sort parameters                   
                                                                                
GOATSR04 GOTO1 TSARDINE,AB.TSARD       Call TSAR                                
         MVC   0(L'TSERRS,R3),AB.TSERRS   Return TSARERRS                       
         CLI   0(R2),TSAADD        Was this an add?                             
         BNE   GOATSRE                                                          
         TM    UPSI,UPSISRTI       SHOULD WE DUMP THE FIRST N RECS.             
         BZ    GOATSRE                                                          
         ZIC   RF,AB.TSKEYL                                                     
         GOTO1 PRNTBL,DMCB,=C'LIMLIST TSAR REC',AB.TSAREC,C'DUMP',     +        
               (RF),=C'1D'                                                      
         J     GOATSRE                                                          
                                                                                
GOATSR06 MVI   0(R3),TSEEOF                                                     
         B     GOATSRNE                                                         
*                                                                               
GOATSRE  SR    RE,RE                                                            
GOATSRNE LTR   RE,RE                                                            
         XMOD1                                                                  
         DROP  AB,R7                                                            
         LTORG                                                                  
         EJECT                                                                  
                                                                                
         TITLE 'Store Estimate details'                                         
***********************************************************************         
*  Store EST details                                                            
*        P1 = A(Workcode)                                                       
***********************************************************************         
         USING ESTWCD,R3                                                        
GETEST   DS    0D                                                               
         NMOD1 0,*GETEST*                                                       
         L     RC,RLBASEC                                                       
         L     RE,0(,R1)                                                        
                                                                                
         LA    R3,WORK                                                          
         XC    WORK,WORK                                                        
         MVC   ESTWL#,CURESTET                                                  
         MVC   ESTWC,0(RE)                                                      
         ZAP   ESTWRAT,PKZERO                                                   
         XR    R5,R5                                                            
         ICM   R5,3,#OFEST         Number of entries in table                   
*                                                                               
BIN      USING ESTWCD,R6                                                        
*                                                                               
         SAM31                     31 bit mode                                  
         GOTO1 BIN31,DMCB,ESTWCD,ESTWCTB,(R5),(1,ESTWLNQ),             X        
               (0,ESTWKLQ),A(MAXEST)                                            
         ICM   R6,15,0(R1)                                                      
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
*                                                                               
         MVC   #OFEST,DMCB+10      Save of number of records                    
         TM    0(R1),X'80'         Record exists?                               
         BZ    GETESXIT            Yes                                          
         MVC   BIN.ESTWL#,CURESTET                                              
         MVC   BIN.ESTWC,ESTWC                                                  
         MVI   BIN.ESTWIND,ESTWWCQ                                              
         ZAP   BIN.ESTWAM,PKZERO                                                
         ZAP   BIN.ESTWGAM,PKZERO                                               
         ZAP   BIN.ESTWTAM,PKZERO                                               
         ZAP   BIN.ESTTHRS,PKZERO                                               
*&&UK                                                                           
         ZAP   BIN.ESTWAMC,PKZERO                                               
         ZAP   BIN.ESTWGAMC,PKZERO                                              
         ZAP   BIN.ESTWTAC,PKZERO                                               
         ZAP   BIN.ESTTRFC,PKZERO                                               
*&&                                                                             
         SAM24                     Return to 24 bit mode                        
         DROP  BIN                                                              
*                                                                               
GETESXIT XMOD1 1                                                                
         SPACE 1                                                                
***********************************************************************         
*  ROUTINE TO SET UP COST RATES IN RATE TABLE BY METHOD               *         
***********************************************************************         
         SPACE 1                                                                
         USING COSTD,R2                                                         
         USING RATED,R6                                                         
         USING MTHDD,R8                                                         
ARATES   NMOD1 0,**ARTE**                                                       
         L     RC,RLBASEC                                                       
         SR    R0,R0                                                            
         ICM   R0,3,CSTMTHDS       TURN OFF ACTIVITY SWITCH                     
         BZ    ARATE40                                                          
         L     R8,MHDBASE                                                       
         NI    MTHDIND,TURNOFF-MTHDRTE-MTHDHRS                                  
         LA    R8,MTHDLNQ(,R8)                                                  
         BCT   R0,*-8                                                           
*                                                                               
         ICM   R0,3,CSTYRS         NUMBER OF YEARS TO PROCESS                   
         BZ    ARATE40             NONE, SO GET OUT                             
         L     R2,CSTBASE          CLEAR TABLE                                  
ARATE10  TM    COSTIND,COSTRTE     RATE PRESENT?                                
         BZ    ARATE15                                                          
         NI    COSTIND,TURNOFF-COSTRTE                                          
         L     R6,COSTRATE         POINT TO RATE TABLE                          
         SR    RF,RF                                                            
         IC    RF,COSTMTHS         NUMBER OF MONTHS TO PROCESS                  
ARATE11  LA    R6,RATEMTHD         POINT  TO SUB ELEMENTS                       
         LH    R1,CSTMTHDS         NUMBER OF METHODS TO PROCESS                 
ARATE12  LA    R6,RATEBUK-RATEMTHD(,R6)   SKIP OVER METHOD                      
         LA    RE,RATEBUK#                NUMBER OF BUCKETS TO CLEAR            
         ZAP   0(L'RATEBUK,R6),PKZERO                                           
         LA    R6,L'RATEBUK(,R6)                                                
         BCT   RE,*-10                                                          
         BCT   R1,ARATE12          CLEAR NEXT METHOD                            
         BCT   RF,ARATE11          CLEAR NEXT MONTHS WORTH                      
*                                                                               
ARATE15  LA    R2,COSTLNQ(,R2)     TRY NEXT CALENDAR                            
         BCT   R0,ARATE10                                                       
*                                                                               
         USING CPRRECD,R3                                                       
         USING PHRELD,R4                                                        
         LA    R3,IOKEY                                                         
         MVC   CPRKEY,SPACES                                                    
         MVI   CPRKTYP,CPRKTYPQ    X'3E'                                        
         MVI   CPRKSUB,CPRKSUBQ    X'07'                                        
         MVC   CPRKCPY(15),CURACC                                               
         L     R1,=AL4(IOHIGH+IOAREA1+IOACFIL)                                  
                                                                                
ARATE18  GOTO1 AIO                                                              
         L     R4,AIO1                                                          
         CLC   2(15,R4),CURACC                                                  
         BNE   ARATEX              Finished                                     
         AH    R4,DATADISP                                                      
                                                                                
ARATE20  CLI   0(R4),0             EOR                                          
         BE    ARATE40             Yes                                          
         CLI   0(R4),PHRELQ        X'80' HOURLY RATE ELEM                       
         BNE   ARATE35                                                          
                                                                                
ARATE25  L     R2,CSTBASE          Find calendar to put rate to                 
         LH    R0,CSTYRS                                                        
ARATE26  CLC   PHRYR(2),COSTSMOA                                                
         BL    ARATE35             Not in this set of calendars                 
         CLC   PHRYR(2),COSTEMOA                                                
         BNH   ARATE27                                                          
         LA    R2,COSTLNQ(,R2)                                                  
         BCT   R0,ARATE26                                                       
         DC    H'00'                                                            
*                                                                               
ARATE27  OI    COSTIND,COSTRTE                                                  
         L     R6,COSTRATE         A(RATE TABLE ENTRY)                          
         SR    R0,R0                                                            
         IC    R0,COSTMTHS         NUMBER OF MONTHS                             
         CLC   RATEMOA,PHRYR       MATCH ON MOA                                 
         BE    *+14                                                             
         AH    R6,RATELEN          BUMP TO NEXT ENTRY                           
         BCT   R0,*-14                                                          
         DC    H'00'                                                            
*                                                                               
         LH    R0,CSTMTHDS         NUMBER OF METHODS                            
         L     R8,MHDBASE                                                       
         CLC   MTHDNUM,PHRMTH      MATCH ON METHOD                              
         BE    *+14                                                             
         LA    R8,MTHDLNQ(,R8)                                                  
         BCT   R0,*-14                                                          
         DC    H'00'                                                            
*                                                                               
         OI    MTHDIND,MTHDRTE     SET METHOD AS ACTIVE                         
         LR    R7,R6                                                            
         AH    R7,MTHDLOC          DISPLACEMENT TO BUCKETS                      
*                                                                               
         IC    R0,PHRNUM           NUMBER OF RATES                              
         LA    R5,PHRNTRY                                                       
*                                                                               
         USING PHRNTRY,R5                                                       
         USING RATEMTHD,R7                                                      
ARATE28  CLI   PHRTYPE,PHRTSAL                                                  
         BNE   *+10                                                             
         ZAP   RATESAL,PHRRATE     SAVE SALARY RATE                             
         CLI   PHRTYPE,PHRTBEN                                                  
         BNE   *+10                                                             
         ZAP   RATEBEN,PHRRATE     SAVE BENEFIT RATE                            
         CLI   PHRTYPE,PHRTPEN                                                  
         BNE   *+10                                                             
         ZAP   RATEPEN,PHRRATE     SAVE PENSION RATE                            
         CLI   PHRTYPE,PHRTTOT                                                  
         BNE   *+10                                                             
         ZAP   RATETOT,PHRRATE     SAVE TOTAL RATE                              
         LA    R5,PHRLN2Q(,R5)     NEXT RATE                                    
         BCT   R0,ARATE28                                                       
                                                                                
ARATE35  SR    RF,RF                                                            
         IC    RF,1(,R4)                                                        
         AR    R4,RF                                                            
         B     ARATE20                                                          
*                                                                               
ARATE40  L     R1,=AL4(IOSEQ+IOAREA1+IOACFIL)                                   
         B     ARATE18             Loop, get next possible rate record          
                                                                                
ARATEX   XMOD1                                                                  
         DROP  R2,R3,R4,R5,R6,R7,R8                                             
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'Put records to SORTER or TSAR'                                  
***********************************************************************         
*  CONTROL RECORDS PUT TO TSAR OR SORT OR RANKING FILE                *         
***********************************************************************         
         SPACE 1                                                                
         USING FMTRECD,R5                                                       
PUTREC   NMOD1 0,**PUTRE*                                                       
         L     RC,RLBASEC                                                       
         MVC   AWRKREC,0(R1)       AREA WHERE RECORDS ARE AT                    
         MVC   WRKREC#,6(R1)       NUMBER OF RECORDS TO PUT                     
*                                                                               
PUTREC10 LH    R6,WRKREC#          NUMBER OF SORT RECORDS TO PUT                
         CLI   UNIFLAG,YES         ONE RECORD PER TRANSACTION?                  
         BNE   PUTREC15                                                         
         SHI   R6,1                DECREASE BY ONE FOR LOOPING                  
         BP    PUTREC15                                                         
         LA    R6,1                DECREASED TOO MUCH, MAKE AT LEAST 1          
*                                                                               
PUTREC15 L     R7,AWRKREC          LOAD SORT RECORD ADDRESS                     
         NI    0(R7),TURNOFF-TRNSDR                                             
*&&US                                                                           
*        OC    0(9,R7),0(R7)       ANY TRANSACTIONS BUILT?                      
*        BZ    PUTREC90            NO, SO EXIT                                  
*&&                                                                             
         OC    0(9,R7),0(R7)       ANY TRANSACTIONS BUILT?                      
         BZ    PUTREC90            NO, SO EXIT                                  
         OI    ACTIVITY,ACTACCT    ACCOUNT HAS SORT ACTIVITY                    
*                                                                               
         USING RECXD,R2                                                         
PUTREC30 TM    FMTPOPT1,RPFIACT    Print inactive accounts ?                    
         BO    PUTREC40            Yes, put all records to SORTER               
         LR    R2,R7                                                            
         AH    R2,SRTKEYXT                                                      
         TM    RECIND,RECKEEP      Keep no matter what ?                        
         BO    PUTREC40            Yes                                          
         SR    RF,RF                                                            
         TM    FMTFLAG,FMTRATES    Were rates used ?                            
         BZ    PUTREC34            No                                           
         DROP  R2                                                               
*                                                                               
         USING COLD,R3                                                          
         L     R3,FMTCOL                                                        
         IC    RF,FMT#COLS         CHECK COLUMNS FOR RATES                      
PUTREC32 TM    COLIND2,COLRATE     IS THIS RATE IN SORT KEY?                    
         BZ    PUTREC33            NO                                           
         TM    POSTMODE,POSTTOT    DON'T CHECK IF TOTAL RECORD                  
         BO    PUTREC33                                                         
         LR    RE,R7                                                            
         AH    RE,COLDSP                                                        
         OC    0(PKLEN,RE),0(RE)   MIGHT NOT HAVE BEEN INITIALIZED              
         BNZ   *+10                SKIP                                         
         ZAP   0(PKLEN,RE),PKZERO  INITAILIZE                                   
         CP    0(PKLEN,RE),PKZERO                                               
         BNE   PUTREC40            NOT ZERO-PUT REC, ACTIVITY PRESENT           
PUTREC33 LA    R3,COLLNQ(,R3)                                                   
         BCT   RF,PUTREC32                                                      
         DROP  R3                                                               
*                                                                               
         CLI   FMT#ACMS,0          REPORTING ONLY RATES ?                       
         BE    PUTREC80            YES, BUT ALL WERE ZERO                       
*                                                                               
PUTREC34 ICM   RF,1,FMT#ACMS       CHECK TRANSACTIONS FOR ACTIVITY              
         BZ    PUTREC40            NO ACTIVITY TO CHECK,SHOW ALL DETAIL         
         TM    POSTMODE,POSTTOT    PUT RECORD OUT NO MATTER WHAT                
         BO    PUTREC40                                                         
         LR    RE,R7               USE R3 TO POINT TO ACCUMULATORS              
         AH    RE,SRTDATLN         DISPLACEMENT TO ACCUMS                       
*                                                                               
PUTREC35 OC    0(PKLEN,RE),0(RE)                                                
         BZ    PUTREC36            POSSIBLE EVAL ERROR, SO SKIP                 
*&&US                              IF TIME ACCOUNT & ZERO HOURS, THEN           
         CLI   QUNIT,C'1'          PRINT IT FOR ZERO HOUR TIMESHEETS            
         BNE   *+16                                                             
         CLI   QLEDGER,C'R'                                                     
         BNE   *+8                                                              
         B     PUTREC40                                                         
*                                                                               
         CP    0(PKLEN,RE),PKZERO                                               
         BNE   PUTREC40            NOT ZERO-PUT REC, ACTIVITY PRESENT           
*&&                                                                             
*                                                                               
PUTREC36 LA    RE,PKLEN(,RE)       BUMP TO NEXT ACCUM                           
         BCT   RF,PUTREC35         LOOP THROUGH ACCUMS FOR ONE TRANSACT         
*&&US*&& TM    FMTROPT6,RPFZPST    Print $0 transactions?                       
*&&US*&& BO    PUTREC40                                                         
         B     PUTREC80            LOOK AT NEXT                                 
*                                                                               
         USING COLD,R3                                                          
PUTREC40 TM    FMTSW,FMT4DEC       SHIFT ACCUMS TO 4 DECIMAL PLACES             
         BZ    PUTREC44                                                         
         L     R3,FMTCOL                                                        
         SR    RF,RF                                                            
         IC    RF,FMT#COLS         CHECK COLUMNS FOR RATES                      
PUTREC42 TM    COLFLAGS,COLAMT     IS IT AN ACCUMULATOR                         
         BZ    PUTREC43            NO                                           
         SR    RE,RE                                                            
         IC    RE,COLDCMLS                                                      
         LA    R1,4                                                             
         CLI   COLDCMLS,4          ARLEADY 4 DECIMALS                           
         BNL   PUTREC43            DON'T BOTHER                                 
         SR    R1,RE               R1 = SHIFT FACTOR TO GET TO 4 DECML          
         LR    RE,R7                                                            
         AH    RE,COLDSP                                                        
         OC    0(PKLEN,RE),0(RE)   MIGHT BE MARKED AS ERROR                     
         BZ    PUTREC43            SKIP                                         
         SRP   0(PKLEN,RE),0(R1),0                                              
*                                                                               
PUTREC43 LA    R3,COLLNQ(,R3)                                                   
         BCT   RF,PUTREC42                                                      
         DROP  R3                                                               
*                                                                               
PUTREC44 TM    TSARSW,TSARON       ARE WE USING TSAR ?                          
         BZ    PUTREC45            NO                                           
         GOTO1 ATSAR,DMCB,=C'PUT',(R7)                                          
         TM    FMTSW,FMTVPCT       VERTICAL % ON FORMAT ?                       
         BZ    PUTREC80            NO                                           
         TM    FMTSW,FMTRANK       ARE WE RANKING ON THIS FORMAT ?              
         BO    PUTREC80            YES, SO HOLD UP ON VERTICAL %                
         GOTO1 VERTPCT,DMCB,=C'PUT',(R7)                                        
         B     PUTREC80            NEXT RECORD                                  
*                                                                               
PUTREC45 TM    FMTSW,FMTRANK       ARE WE RANKING REPORT?                       
         BZ    PUTREC55            NO                                           
         GOTO1 ARANK,DMCB,=C'PUT',(R7)                                          
         B     PUTREC80            NEXT RECORD                                  
*                                                                               
PUTREC55 TM    FMTSW,FMTVPCT       POST A VERTICAL PERCENT?                     
         BZ    PUTREC60            NO                                           
         GOTO1 VERTPCT,DMCB,=C'PUT',(R7)                                        
*                                                                               
PUTREC60 TM    UPSI,UPSISRTI       SHOULD WE DUMP THE FIRST N RECS.             
         BZ    PUTREC62                                                         
         GOTO1 DEBUG,DMCB,=C'PUT RECORD TO SORT',(R7)                           
*                                                                               
PUTREC62 GOTO1 ADSORTER,DMCB,=C'PUT',(R7)                                       
         OI    SORTSW,SORTDATA                                                  
*                                                                               
PUTREC80 DS    0H                                                               
         AH    R7,SRTRECLN         NEXT TRANSACTION TO POST                     
         NI    0(R7),TURNOFF-TRNSDR                                             
         BCT   R6,PUTREC30                                                      
*                                                                               
PUTREC90 XMOD1                                                                  
         DROP  R5                                                               
         SPACE 1                                                                
AWRKREC  DC    A(0)                A(RECORD BLOCK)                              
WRKREC#  DC    Y(0)                NUMBER OF RECORDS IN AREA                    
         LTORG                                                                  
         TITLE 'ADD RECORD TO TSAR, REDUCE SORTER WORK'                         
***********************************************************************         
*   ADD / MERGER A RECORD GOING TO TSAR                               *         
***********************************************************************         
         USING TSARD,R1                                                         
         USING FMTRECD,R5                                                       
TSAR     NMOD1 0,**2ZAR**                                                       
         L     RC,RLBASEC                                                       
         L     R2,0(,R1)           ACTION                                       
         L     R7,4(,R1)           RECORD TO PUT TO TSAR                        
         CLC   =C'PUT',0(R2)                                                    
         BNE   TSAR300                                                          
         TM    UPSI,UPSISRTI       SHOULD WE DUMP THE FIRST N RECS.             
         BZ    TSAR020                                                          
*        CLC   =C'B7000003024',33(R7)                                           
*        BNE   TSAR020                                                          
         GOTO1 DEBUG,DMCB,=C'PUT RECORD TO TSAR',(R7)                           
*                                                                               
TSAR020  LA    R1,TSARBLK                                                       
         L     R2,ATBUFREC         MOVE RECORD INTO TSAR BUFFER                 
         SR    R3,R3                                                            
         LH    R3,SRTRECLN         RECORD LENGTH                                
         LR    RE,R7               A(SOURCE)                                    
         LR    RF,R3                                                            
         MVCL  R2,RE                                                            
         MVC   TSAREC,ATBUFREC     ADDRESS OF RECORD TO BE READ                 
         MVI   TSOFFACT,TSARDH     READ HI                                      
         GOTO1 ATSAROFF                                                         
         TM    TSERRS,TSERNF       RECORD NOT FOUND?                            
         BO    TSAR150             RECORD NOT FOUND SO GO ADD                   
*                                                                               
         SR    R0,R0               ADD UP ACCUMS AND WRITE BACK RECORD          
         ICM   R0,1,FMT#ACMS       NUMBER OF COLUMNS TO ADD TOGETHER            
         BZ    TSARXIT             NO COLUMNS TO ADD SO SKIP                    
         TM    FMTFLAG,FMTBYCOL                                                 
         BZ    TSAR130                                                          
*                                                                               
         USING COLD,R3                                                          
         IC    R0,FMT#COLS         NUMBER OF COLUMNS TO SCAN                    
         L     R3,FMTCOL           A(COLUMN TABLE)                              
TSAR040  TM    COLFLAGS,COLAMT                                                  
         BZ    TSAR120                                                          
         LR    RE,R7                                                            
         L     R2,ATBUFREC                                                      
         AH    R2,COLDSP                                                        
         AH    RE,COLDSP                                                        
         TM    COLIND3,COLNATSR    Constant type value, not cumalative          
         BZ    TSAR080             Ok to add together                           
         TM    FMTPONCE,FMTPON     Option on to post by account ?               
         BZ    TSAR060             No                                           
         TM    COLIND3,COLBYACT    Posted by account ?                          
         BO    TSAR120             Yes                                          
         CP    0(PKLEN,RE),PKZERO  Any amount to post ?                         
         BE    TSAR120             No                                           
         OI    COLIND3,COLBYACT    Must post once per account                   
         B     TSAR080             Add amount to accumulator                    
*                                                                               
TSAR060  CP    0(PKLEN,R2),PKZERO        Was record ever set ?                  
         BNE   TSAR120                   Yes, don't over-write value            
         CP    0(PKLEN,R2),0(PKLEN,RE)   See if other record has value          
         BE    TSAR120                   Skip this column                       
*                                                                               
TSAR080  AP    0(PKLEN,R2),0(PKLEN,RE)                                          
*                                                                               
TSAR120  LA    R3,COLLNQ(,R3)                                                   
         BCT   R0,TSAR040                                                       
         B     TSAR140                                                          
         DROP  R3                                                               
*                                                                               
TSAR130  LR    R3,R7               USE R3 TO POINT TO ACCUMS                    
         AH    R3,SRTDATLN         DISPLACEMENT TO ACCUMULATORS                 
         L     R2,ATBUFREC         MOVE REC TO TBUFREC A(DESTINATION)           
         AH    R2,SRTDATLN                                                      
         AP    0(PKLEN,R2),0(PKLEN,R3)                                          
         LA    R2,PKLEN(,R2)       BUMP TO NEXT ACCUM                           
         LA    R3,PKLEN(,R3)       BUMP TO NEXT ACCUM                           
         BCT   R0,*-14                                                          
*                                                                               
TSAR140  MVI   TSOFFACT,TSAWRT     WRITE BACK NEW RECORD                        
         GOTO1 ATSAROFF                                                         
         BE    TSARXIT             FINSISHED, SO GET NEXT                       
         DC    H'00'               UT OH?                                       
*                                                                               
         USING COLD,R3                                                          
TSAR150  TM    FMTPONCE,FMTPON     Option on to post by account ?               
         BZ    TSAR190             No                                           
         SR    R0,R0               ADD UP ACCUMS AND WRITE BACK RECORD          
         IC    R0,FMT#COLS         NUMBER OF COLUMNS TO SCAN                    
         L     R3,FMTCOL           A(COLUMN TABLE)                              
TSAR160  TM    COLFLAGS,COLAMT                                                  
         BZ    TSAR180                                                          
*        L     R2,ATBUFREC                                                      
         LR    R2,R7               R7 = Record to be added                      
         AH    R2,COLDSP                                                        
         TM    COLIND3,COLNATSR    Constant type value, not cumalative          
         BZ    TSAR180             No, so don't mark COLIND3                    
         CP    0(PKLEN,R2),PKZERO  Any amount to post ?                         
         BE    TSAR180             No, so don't mark COLIND3                    
         OI    COLIND3,COLBYACT    Post by account so set COLIND3               
                                                                                
TSAR180  AHI   R3,COLLNQ           Next column                                  
         BCT   R0,TSAR160                                                       
         DROP  R3                                                               
*                                                                               
TSAR190  ST    R7,TSAREC           A(RECORD TO BE ADDED)                        
         OI    TSARSW,TSARDATA     TSAR RECORD                                  
         MVI   TSOFFACT,TSAADD     ADD  RECORD TO TSAR                          
         GOTO1 ATSAROFF                                                         
         BE    TSARXIT             RECORD ADDED, SO OK                          
         TM    TSERRS,TSEEOF       TSAR BUFFER FULL?                            
         BO    *+6                 YES                                          
         DC    H'00'               NO, SO WHAT HAPPENED?                        
         TM    THRSW,THRLST        NOT ALLOWED TO HAPPEN IF SWITH ON            
         BZ    *+6                                                              
         DC    H'00'               INCREASE TSAR HIGH CORE                      
*                                                                               
         TM    UPSI,UPSISRTI       SHOULD WE DUMP THE FIRST N RECS.             
         BZ    TSAR200                                                          
         TM    FMTSW,FMTRANK       RANKING ?                                    
         BO    TSAR200             DON'T DUMP RECORD HERE WHEN RANKING          
         ZIC   R2,COUNT2                                                        
         CLI   COUNT2,MAXCOUNT                                                  
         BNL   TSAR200                                                          
         LA    R2,1(,R2)                                                        
         STC   R2,COUNT2                                                        
         LH    R0,SRTRECLN                                                      
         GOTO1 PRNTBL,DMCB,=C' CLEAR TSAR TO SORT',                    X        
               (R7),C'DUMP',(R0),=C'1D'                                         
*                                                                               
TSAR200  L     RF,ARANK            A(RANKER)                                    
         TM    RANKSW,RANKGET      HAVE WE RANKED AND NOW PROCESSING ?          
         BO    TSAR220             YES, SO FORCE  PUT TO SORTER                 
         TM    FMTSW,FMTRANK       ARE WE RANKING ON THIS FORMAT ?              
         BO    TSAR250             YES, SO FORCE  PUT TO RANKWRK                
*                                                                               
TSAR220  L     RF,ADSORTER         A(SORTER)                                    
         OI    SORTSW,SORTDATA                                                  
*                                                                               
TSAR250  GOTO1 (RF),DMCB,=C'PUT',(R7)                                           
         OI    TSARSW,TSARFULL                                                  
         B     TSAR520             NO FLUSH OUT RECORDS IN TSAR                 
         EJECT ,                                                                
***********************************************************************         
*  ALL RECORDS RESIDE IN TSAR SO GET RECORDS IN SEQUENCE              *         
***********************************************************************         
         SPACE 1                                                                
TSAR300  CLC   =C'GET',0(R2)                                                    
         BNE   TSAR500                                                          
         LR    R6,R1               SAVE PARAMETER LIST                          
         XC    0(8,R6),0(R6)       CLEAR PARAMETERS                             
         LA    R1,TSARBLK                                                       
         MVI   TSOFFACT,TSANXT     READ NEXT RECORD                             
         TM    TSARSW,TSARGET                                                   
         BO    TSAR350                                                          
         MVI   TSOFFACT,TSARDH     READ HI FOR FIRST RECORD                     
         OI    TSARSW,TSARGET      GET ISSUED                                   
         L     RE,ATBUFREC                                                      
         LA    RF,TBUFLNQ                                                       
         XCEF                                                                   
*                                                                               
TSAR350  L     R7,ATBUFREC                                                      
         ST    R7,TSAREC           SET A(TSAR RECORD)                           
         GOTO1 ATSAROFF                                                         
         OI    TSARSW,TSARFULL                                                  
         TM    TSERRS,TSEEOF           End of file ?                            
         BO    TSAR800                 Yes so initialize TSAR buffer            
         NI    TSARSW,TURNOFF-TSARFULL No  so turn off indication               
         ST    R7,4(,R6)                                                        
         B     TSARXIT             GOT FIRST RECORD                             
*=====================================================================*         
*  Flush out Tsar buffer to Sort or Rankwork/Buffalo records          *         
*=====================================================================*         
         SPACE 1                                                                
TSAR500  CLC   =C'FLUSH',0(R2)                                                  
         BE    *+6                                                              
         DC    H'00'                                                            
*                                                                               
TSAR520  L     RE,ATBUFREC                                                      
         LA    RF,TBUFLNQ                                                       
         XCEF                                                                   
*                                                                               
         LA    R1,TSARBLK                                                       
         MVI   TSOFFACT,TSARDH     READ HI FOR FIRST RECORD                     
TSAR550  L     R7,ATBUFREC                                                      
         ST    R7,TSAREC           SET A(TSAR RECORD)                           
         GOTO1 ATSAROFF                                                         
         TM    TSERRS,TSEEOF       End of file ?                                
         BO    TSAR800             Yes so initialize TSAR buffer                
*                                                                               
         LR    RE,R7                                                            
         AH    RE,SRTREPNO         Point to format # in record                  
         TM    TSARSW,TSARFULL     Force to flush all ?                         
         BO    TSAR600                                                          
         CLI   MODE,REQLAST        Flush out all records                        
         BE    TSAR600                                                          
         CLC   FMTNUM,0(RE)        Match on report #, because of recaps         
         BNE   TSAR790             Flush recaps in multiple passes              
         B     TSAR610                                                          
*                                                                               
TSAR600  SR    R5,R5                                                            
         IC    R5,0(,RE)           Get report number                            
         SHI   R5,1                                                             
         BNM   *+6                                                              
         DC    H'00'                                                            
*                                                                               
         MHI   R5,FMTLNQ                                                        
         A     R5,AFORMATS         BASE OF FORMAT DATA                          
*                                                                               
TSAR610  TM    THRSW,THRLST        Process in ACCLST mode ?                     
         BZ    TSAR700             No                                           
         CLI   MODE,REQLAST                                                     
         BE    TSAR700             Ignore, must be recap totals                 
         CLI   MODE,PROCACC                                                     
         BE    TSAR700             Don't process here if in PROCACC             
         TM    FMTSW,FMTTHRON      Format used total data ?                     
         BZ    TSAR700             No                                           
         TM    FMTSW,FMTP$AON      Payroll adjusted amounts                     
         BZ    TSAR620                                                          
         GOTO1 ASETPAY,1           Set column payroll totals                    
                                                                                
         USING COLD,R3                                                          
TSAR620  SR    R0,R0                                                            
         IC    R0,FMT#COLS                                                      
         L     R3,FMTCOL                                                        
TSAR630  TM    COLFLAGS,COLAMT                                                  
         BZ    TSAR690                                                          
         TM    COLFLAGS,COLCALC                                                 
         BO    TSAR690                                                          
         SR    RF,RF                                                            
         ICM   RF,3,COLDD#                                                      
         CLC   COLDD#,=AL2(AC#RSMTS)    Missing time sheets ?                   
         BE    TSAR690                  Yes                                     
         LH    R4,COLDSP                                                        
         AR    R4,R7                    Point to numerator value                
         ZAP   OP1,0(PKLEN,R4)                                                  
         ZAP   OP2,COLTOTHR                                                     
         CHI   RF,AC#RSTHR              Total hours keyword                     
         BE    TSAR640                    Yes                                   
         ZAP   OP2,COLTOT1C                                                     
         CHI   RF,AC#RSTHC              Total 1C time keyword                   
         BNE   TSAR650                                                          
*                                                                               
TSAR640  MP    OP2,0(PKLEN,R4)          Multiplying by 1 or 0                   
         ZAP   ANSWER,OP2                                                       
         B     TSAR685                  Next column                             
*                                                                               
TSAR650  ZAP   OP2,COLTOT1C             Denominator                             
         CHI   RF,AC#RSPTC              Client time/Total 1R time               
         BE    TSAR660                                                          
         ZAP   OP2,COLTOTHR             Denominator                             
         CHI   RF,AC#RSMWR              Man Week Ratio                          
         BE    TSAR660                    Yes                                   
         CHI   RF,AC#RSPCT              Time/Total time                         
         BE    TSAR660                  next column                             
         TM    COLIND1,COLPADJ$         Payroll adjusted amount                 
         BZ    TSAR690                    No                                    
*                                                                               
TSAR660  ZAP   0(PKLEN,R4),PKZERO                                               
         CP    OP2,PKZERO          Don't divide by zero                         
         BE    TSAR690                                                          
         SRP   OP1,6,0                                                          
         DP    OP1,OP2+12(4)                                                    
         ZAP   ANSWER,OP1(12)                                                   
         CHI   RF,AC#RSMWR         Man Week Ratio                               
         BE    TSAR680                      Yes                                 
         TM    COLIND1,COLPADJ$    Payroll adjusted amount ?                    
         BZ    TSAR685               No                                         
                                                                                
TSAR670  MP    ANSWER,COLPROLL     (hours / total hours) * payroll              
         SRP   ANSWER,58,5                                                      
         B     TSAR685                                                          
                                                                                
TSAR680  OC    COLTPEDS,COLTPEDS   Was this set ?                               
         BZ    TSAR690             No                                           
         CP    COLTPEDS,PKZERO                                                  
         BE    TSAR690             Can't divide by zero                         
         ZAP   OP2,OP1(12)         PCT prior to shift adjust                    
         ZAP   OP1,COLTOACT        Total periods worked                         
         SRP   OP1,6,0             Shift to keep significance                   
         DP    OP1,COLTPEDS        Total periods possible                       
         MP    OP2,OP1+6(PKLEN)    PCT x MWR                                    
         SRP   OP2,56,5                                                         
         ZAP   0(PKLEN,R4),OP2                                                  
         B     TSAR690                                                          
*                                                                               
TSAR685  ZAP   0(PKLEN,R4),ANSWER                                               
*                                                                               
TSAR690  LA    R3,COLLNQ(,R3)                                                   
         BCT   R0,TSAR630                                                       
         DROP  R3                                                               
*                                                                               
TSAR700  TM    UPSI,UPSISRTI       SHOULD WE DUMP THE FIRST N RECS.             
         BZ    TSAR760                                                          
         TM    FMTSW,FMTRANK       RANKING ?                                    
         BO    TSAR760             DON'T DUMP RECORD HERE WHEN RANKING          
         ZIC   R2,COUNT2                                                        
         CLI   COUNT2,MAXCOUNT                                                  
         BNL   TSAR760                                                          
         LA    R2,1(,R2)                                                        
         STC   R2,COUNT2                                                        
         LH    R0,SRTRECLN                                                      
         GOTO1 PRNTBL,DMCB,=C' CLEAR TSAR TO SORT',                    X        
               (R7),C'DUMP',(R0),=C'1D'                                         
*                                                                               
TSAR760  L     RF,ARANK            A(RANKER)                                    
         TM    RANKSW,RANKGET      HAVE WE RANKED AND NOW PROCESSING ?          
         BO    TSAR770             YES, SO FORCE  PUT TO SORTER                 
         TM    FMTSW,FMTRANK       IS THERE RANKING?                            
         BO    TSAR780             YES, SO PUT TO RANKWRK                       
*                                                                               
TSAR770  L     RF,ADSORTER         A(SORTER)                                    
         OI    SORTSW,SORTDATA                                                  
*                                                                               
TSAR780  GOTO1 (RF),DMCB,=C'PUT',(R7)                                           
*                                                                               
TSAR790  LA    R1,TSARBLK                                                       
         MVI   TSOFFACT,TSANXT     READ NEXT RECORD                             
         B     TSAR550                                                          
*                                                                               
TSAR800  LA    R1,TSARBLK                                                       
         TM    TSARSW,TSARFULL     Tsar full ?                                  
         BO    TSAR810             Yes so flush all                             
         CLC   FMTNUM,FORMAT#+1          Only do on last format                 
         BNE   TSARXIT                   Not last format yet, wait              
*                                                                               
TSAR810  MVC   TSAREC,ATBUFLEN           Size of buffer                         
         MVI   TSOFFACT,TSAINI           Re-initialize to clear                 
         GOTO1 ATSAROFF                                                         
         NI    TSARSW,TURNOFF-TSARDATA-TSARFULL                                 
*                                                                               
TSARXIT  XMOD1                                                                  
         DROP  R1,R5                                                            
         SPACE 1                                                                
         LTORG                                                                  
         EJECT ,                                                                
*=====================================================================*         
*  Put higher level totals to Buffalo                                 *         
*=====================================================================*         
                                                                                
         USING FMTRECD,R5                                                       
RANKER   DS    0D                                                               
         NMOD1 0,**RNKR**                                                       
         L     RC,RLBASEC                                                       
         L     R2,0(,R1)           ACTION                                       
         CLC   =C'PUT',0(R2)                                                    
         BNE   RANK50                                                           
         L     R7,4(,R1)           A(RECORD TO PUT)                             
         TM    UPSI,UPSISRTI                                                    
         BZ    RANK10                                                           
         GOTO1 DEBUG,DMCB,=C'PUT RECORD TO RANK FILE',(R7)                      
*                                                                               
RANK10   L     R3,RANKDCB          Put record to RANKWRK file                   
         PUT   (R3),(R7)                                                        
         TM    FMTSW,FMTRANK       Rank on this format ?                        
         BZ    RANK99              No                                           
         L     R2,ABUFWRK          Yes, move key to BUFFWRK                     
         SR    R3,R3                                                            
         LH    R3,FMTRNKON         Length of pertanent key                      
         LR    RE,R7               R7 = A(SOURCE)                               
         LR    RF,R3               Length of key                                
         MVCL  R2,RE                                                            
*                                                                               
         L     R2,ABUFWRK          Append extra data to key                     
         AH    R2,BFLKEYLN                                                      
         SHI   R2,RECXDQ                                                        
         LR    R3,R7                                                            
         AH    R3,SRTKEYXT                                                      
         MVC   0(RECXDQ,R2),0(R3)  Move in extra data to key                    
*                                                                               
         L     R2,ABUFWRK          Append accums to record                      
         SR    RF,RF                                                            
         IC    RF,MAX#ACMS                                                      
         SR    RE,RE                                                            
         IC    RE,MAX#RTES                                                      
         AR    RF,RE                                                            
         AH    R2,BFLKEYLN         Clear all accums                             
         ZAP   0(PKLEN,R2),PKZERO                                               
         LA    R2,PKLEN(,R2)                                                    
         BCT   RF,*-10                                                          
         ZAP   0(PKLEN,R2),PKONE   R2 points to end, forces none zero           
*                                                                               
         L     R2,ABUFWRK          Buffalo rank record                          
         AH    R2,BFLKEYLN         Point to end of key                          
         ZIC   R3,FMT#ACMS         Number of accumulators                       
         MHI   R3,PKLEN            Length of accums                             
         LR    RE,R7               A(SOURCE)                                    
         AH    RE,SRTDATLN         Point to accums                              
         LR    RF,R3               Length of accums                             
         MVCL  R2,RE               Append accumns                               
*                                                                               
         TM    RANKSW,RANKRTE      Rank switch                                  
         BZ    RANK18                                                           
         OC    FMTKRATE,FMTKRATE   Did we initalize rate info ?                 
         BNZ   RANK12              Yes                                          
         LR    RE,R2               RF = Location to move rates to               
         L     RF,ABUFWRK          Start of record                              
         SR    RE,RF               Displacement into                            
         STH   RE,FMTKRATE         Save off where we appended rates             
*                                                                               
         USING COLD,R3                                                          
RANK12   ZIC   RF,FMT#COLS         Append rates                                 
         L     R3,FMTCOL                                                        
*                                                                               
RANK14   TM    COLIND2,COLRATE     Is this a rate column ?                      
         BZ    RANK15              No                                           
         LR    RE,R7                                                            
         AH    RE,COLDSP           Point to rate to append                      
         ZAP   0(PKLEN,R2),PKZERO                                               
         OC    0(PKLEN,RE),0(RE)                                                
         BZ    *+10                                                             
         ZAP   0(PKLEN,R2),0(PKLEN,RE)                                          
         LA    R2,PKLEN(,R2)       BUMP PAST LAST ONE                           
RANK15   LA    R3,COLLNQ(,R3)                                                   
         BCT   RF,RANK14                                                        
         DROP  R3                                                               
*                                                                               
RANK18   L     R2,ABUFWRK          Load begining of record                      
         LR    RE,R2                                                            
         AH    R2,FMTRNKON         A(Part of key to clear)                      
         LH    R3,BFLKEYLN         length of key - part to leave alone          
         SH    R3,FMTRNKON         R3 = Lenght to clear key for                 
         SHI   R3,RECXDQ+1         1 for execute + extra data                   
         BNP   RANK20                                                           
         EXXC  R3,0(R2),0(R2)      Clear key                                    
*                                                                               
         USING RECXD,RE                                                         
RANK20   AH    RE,BFLKEYLN         Point to format # in RANK record             
         SHI   RE,RECXDQ                                                        
         MVC   RECRPT#,FMTNUM      Set format # just in case not there          
         DROP  RE                                                               
*                                                                               
         TM    UPSI,UPSISRTI                                                    
         BZ    RANK30                                                           
         SR    R0,R0                                                            
         IC    R0,FMT#ACMS         NUMBER OF ACCUMULATORS                       
         SR    R1,R1                                                            
         IC    R1,FMT#RTES         NUMBER OF RATES                              
         LA    R1,1(,R1)                                                        
         AR    R0,R1                                                            
         MHI   R0,PKLEN            LENGTH OF ACCUMS                             
         AH    R0,BFLKEYLN                                                      
         GOTO1 PRNTBL,DMCB,=C'BUFFALO RANK',ABUFWRK,C'DUMP',(R0),=C'2D'         
*                                                                               
RANK30   GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,ABUFWRK                               
         B     RANK99                                                           
         EJECT ,                                                                
*=====================================================================*         
*  Get ranking reocrds from RANKWRK file                              *         
*  Get higher level totals from BUFFALO                               *         
*  Fill in ranked amount and put sorter with filled in amount         *         
*=====================================================================*         
                                                                                
RANK50   CLC   =C'FLUSH',0(R2)                                                  
         BE    *+6                                                              
         DC    H'00'                                                            
*                                                                               
         L     R3,RANKDCB                                                       
         CLOSE ((R3))              Close RANK file                              
         NI    RANKSW,TURNOFF-RANKOPN                                           
*                                                                               
         OPEN  ((R3),INPUT)        Re-open to get records from start            
         OI    RANKSW,RANKOPN+RANKGET                                           
*                                                                               
         SR    RF,RF                                                            
         L     RE,ABUFWRK                                                       
         LH    RF,SRTRECLN         Clear prevwrk area                           
         XCEFL                                                                  
*                                                                               
RANK52   L     R6,AIO3             Area of last expanded buffalo record         
         L     R7,ASRTWRK          Begining of Sort record area                 
         L     R3,RANKDCB          Read through RANKWRK sequentially            
         GET   (R3),(R7)                                                        
         LR    RE,R7               Get fromat details, FMTRECD                  
         AH    RE,SRTREPNO         Point to format # in record                  
         SR    R5,R5                                                            
         IC    R5,0(,RE)                                                        
         BCTR  R5,0                                                             
         MHI   R5,FMTLNQ                                                        
         A     R5,AFORMATS         A(Format entry)                              
*                                                                               
         TM    UPSI,UPSISRTI       DUMP RANK FILE RECORD?                       
         BZ    RANK55                                                           
         GOTO1 DEBUG,DMCB,=C'RECORD OUT OF RANK FILE',(R7)                      
         EJECT ,                                                                
*=====================================================================*         
*  Turning off TSAR for 2nd pass, not nessesary but probable          *         
*          more efficent 06/16/98                                     *         
*=====================================================================*         
                                                                                
RANK55   NI    TSARSW,TURNOFF-TSARON                                            
         TM    FMTSW,FMTRANK       Ranking for this fromat ?                    
         BZ    RANK80              No                                           
         SR    R1,R1               Yes                                          
         LH    R1,FMTRNKON         Compare last record to this record           
         BCTR  R1,0                                                             
         EXCLC R1,0(R7),0(R6)                                                   
         BNE   RANK58              Not the same                                 
         LR    RE,R6                                                            
         AH    RE,SRTREPNO         Point to format # in record                  
         CLC   FMTNUM,0(RE)        Same format number ?                         
         BE    RANK76              If equal then use prev. Buffalo rec          
*                                                                               
RANK58   L     R2,ABUFWRK          Build key to get Buffalo record              
         SR    R3,R3                                                            
         LH    R3,FMTRNKON                                                      
         LR    RE,R7               A(SOURCE)                                    
         LR    RF,R3               Length of key                                
         MVCL  R2,RE                                                            
*                                                                               
         USING RECXD,RE                                                         
         L     R2,ABUFWRK          Load begining of record                      
         LR    RE,R7                                                            
         AH    RE,SRTKEYXT                                                      
         AH    R2,BFLKEYLN                                                      
         SHI   R2,RECXDQ                                                        
         MVC   0(RECXDQ,R2),RECXD                                               
                                                                                
*=====================================================================*         
*   SETUP KEY TO READ FROM BUFFALO SAVE KEY TO COMPARE TO LAST READ   *         
*=====================================================================*         
         MVC   RECRPT#,FMTNUM      Restore format #                             
         DROP  RE                                                               
*                                                                               
         GOTO1 BUFFALO,DMCB,=C'GET',ABUFF,ABUFWRK,1                             
         TM    DMCB+8,X'10'                         Did we find one ?           
         BZ    *+6                 Yes, get total $ & seed sort record          
         DC    H'00'               No level total not found, problem            
*                                                                               
         L     R2,ABUFWRK                                                       
         L     R3,AIO3                                                          
         LR    RE,R3               Use io area to re-build record               
         LH    RF,SRTRECLN         Move in key                                  
         LR    R0,R2                                                            
         LH    R1,BFLKEYLN         Key of rank record                           
         SHI   R1,RECXDQ           Less extra data                              
         MVCL  RE,R0                                                            
*                                                                               
         USING RECXD,RE                                                         
         LR    RE,R3               Move in extra data                           
         AH    RE,SRTKEYXT                                                      
         LR    R1,R2                                                            
         AH    R1,BFLKEYLN                                                      
         SHI   R1,RECXDQ                                                        
         MVC   RECXD(RECXDQ),0(R1)                                              
         DROP  RE                                                               
*                                                                               
         LR    RE,R3               Move in accumaltors                          
         AH    RE,SRTKEYLN                                                      
         SR    RF,RF                                                            
         IC    RF,FMT#ACMS         Number of accumulators                       
         MHI   RF,PKLEN                                                         
         LR    R1,RF                                                            
         LR    R0,R2                                                            
         AH    R0,BFLKEYLN                                                      
         MVCL  RE,R0                                                            
*                                  Move rates back into key                     
         USING COLD,R3                                                          
         TM    RANKSW,RANKRTE      Rate                                         
         BZ    RANK68                                                           
         L     R4,ABUFWRK          A(BUFFALO'S accums)                          
         AH    R4,FMTKRATE         A(Rate amounts in Buffalo)                   
         L     R3,FMTCOL           Point to column info                         
         ZIC   R0,FMT#COLS         Number of columns to look at                 
RANK62   TM    COLIND2,COLRATE     Is it a rate ?                               
         BZ    RANK65              No                                           
         L     RE,AIO3             Yes                                          
         AH    RE,COLDSP           Rate in key                                  
         ZAP   0(PKLEN,RE),0(PKLEN,R4)                                          
         LA    R4,PKLEN(,R4)                                                    
RANK65   LA    R3,COLLNQ(,R3)      Bump up to next column                       
         BCT   R0,RANK62                                                        
*                                                                               
RANK68   L     R4,AIO3             Point to re-built record                     
         AH    R4,SRTKEYLN         A(Accumulator line)                          
         L     R3,FMTCOL           Point to column information                  
         ZIC   R0,FMT#COLS         Number of columns to look at                 
*                                                                               
RANK70   TM    COLFLAGS,COLCALC                                                 
         BZ    RANK72                                                           
         GOTO1 EVAL,DMCB,(R3),(R4),AIO3                                         
         BE    *+10                                                             
         ZAP   ANSWER,PKZERO       Ignore error                                 
         LR    R6,R4               R4 = Begining of accum line                  
         AH    R6,COLACM           R6 = Where answer goes                       
         ZAP   0(PKLEN,R6),ANSWER                                               
RANK72   LA    R3,COLLNQ(,R3)      Bump up to next column                       
         BCT   R0,RANK70                                                        
         DROP  R3                                                               
*                                                                               
         TM    UPSI,UPSISRTI       Trace out buffalo record ?                   
         BZ    RANK73              No                                           
         SR    R0,R0               Yes                                          
         IC    R0,MAX#ACMS         Number of accumulators                       
         MHI   R0,PKLEN            Length of accums                             
         AH    R0,SRTKEYLN         Length of key. R0 = total length             
         GOTO1 PRNTBL,DMCB,=C'BUFFALO OUT',AIO3,C'DUMP',(R0),=C'2D'             
*                                                                               
RANK73   L     R4,AIO3             A(Rebuilt Buffalo record)                    
         AH    R4,FMTRNKCL         Point to rank amount                         
         CLI   FMTRNKTY,C'A'       Ascending or Ddscending rank order ?         
         BNE   RANK74                                                           
         MP    0(PKLEN,R4),PKNEG   Reverse sign in ascending order              
*                                                                               
RANK74   CP    0(PKLEN,R4),PKZERO               Positive amount ?               
         BL    RANK76                           No                              
         MP    0(PKLEN,R4),PKNEG                Yes, make negative              
         AP    0(PKLEN,R4),=P'999999999999999'  Reverse sort order              
*                                                                               
RANK76   L     R4,AIO3             A(Expanded Buffalo record)                   
         AH    R4,FMTRNKCL         Point to rank amount                         
         LR    R2,R7               A(Sort record) from RANKWRK                  
         AH    R2,FMTRNKBY         Point to place to put rank amount            
         ZAP   2(PKLEN,R2),0(PKLEN,R4)                                          
         BNL   *+8                                                              
         MVI   1(R2),X'FF'         If negative set a sing in front              
         MVC   0(1,R2),FMTNUM      Set recap nunber                             
*                                                                               
RANK80   TM    FMTSW,FMTVPCT       Post a vertical percent ?                    
         BZ    RANK82                     No                                    
         GOTO1 VERTPCT,DMCB,=C'PUT',(R7)  Yes                                   
         B     RANK85                                                           
*                                                                               
RANK82   TM    TSARSW,TSARON       Are we using TSAR at all ?                   
         BZ    RANK85                     No                                    
         GOTO1 ATSAR,DMCB,=C'PUT',(R7)    Yes                                   
         B     RANK52                                                           
*                                                                               
RANK85   TM    UPSI,UPSISRTI       Should we dump some records ?                
         BZ    RANK88              No                                           
         GOTO1 DEBUG,DMCB,=C'Put Ranked record to sort',(R7)                    
*                                                                               
RANK88   GOTO1 ADSORTER,DMCB,=C'PUT',(R7)                                       
         OI    SORTSW,SORTDATA     Sort activity                                
         B     RANK52                                                           
*                                                                               
RANK90   TM    TSARSW,TSARON       Are we using TSAR at all ?                   
         BZ    RANK92              No, using SORTER only                        
         TM    TSARSW,TSARDATA     Did we ever put data to TSAR ?               
         BZ    RANK92              No, so using TSAR for now                    
         TM    SORTSW,SORTDATA     Yes. Did we put data to SORTER ?             
         BZ    RANK92                   No so use TSAR for now                  
         GOTO1 ATSAR,DMCB,=C'FLUSH',0   Yes, so flush out TSAR                  
*                                                                               
RANK92   L     R3,RANKDCB          Finished                                     
         CLOSE ((R3))                                                           
         NI    RANKSW,TURNOFF-RANKOPN-RANKGET                                   
*                                                                               
RANK99   XMOD1                                                                  
         DROP  R5                                                               
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'PARSE OUT DATA USING PARSE TABLE'                               
***********************************************************************         
*  GET DATA FROM RECORD/KEY/OTHER                                     *         
***********************************************************************         
         USING PARSED,R3                                                        
         USING FMTRECD,R5                                                       
         USING PARWRKD,R7                                                       
PARSE00  DS    0D                                                               
         NMOD1 PARWRKN-PARWRKD,**PARSE*,R9,CLEAR=YES                            
         LR    R7,RC               LOCAL WORK AREA                              
         L     RC,RLBASEC                                                       
         LM    R3,R4,0(R1)         R3=Parse entry, R4=Where to put              
         MVC   PARDMSK,0(R1)       Bit for name/code/level                      
         MVC   PARDLEN,4(R1)       Length of data to parse 'from len'           
         MVC   CONCODE,8(R1)       Special case condition code list             
                                                                                
         TM    PARDMSK,PARDLVL     Want level of an account?                    
         BZ    *+12                No                                           
         CLI   PARDLEN,0           Yes is the length zero?                      
         BE    PARSE99             Yes so no data to parse                      
                                                                                
         TM    UPSI,X'02'                                                       
         BZ    PARSE02                                                          
         L     R6,12(,R1)                                                       
         GOTO1 =A(TRACE),0                                                      
                                                                                
PARSE02  CLI   PARTYPE,EOT         ANY MORE PARSE ENTRIES?                      
         BE    PARSE99             NO MORE, DATA NOT FOUND                      
         CLI   PARDLEN,0                                                        
         BE    *+10                                                             
         MVC   PARNEWLN+1(1),PARDLEN                                            
                                                                                
         TM    PARIND3,PARMODE     PARSE IN THIS MODE ?                         
         BZ    PARSE02A                                                         
         CLC   MODE,PARTTYP2       VALID FOR THIS MODE ?                        
         BNE   PARSE50                                                          
                                                                                
PARSE02A CLI   PARFRTYP,DATETYPE                                                
         BNE   *+12                                                             
         LA    RF,2                                                             
         STH   RF,PARNEWLN         INITILIZE TO 2 FOR > SPACES CLC              
                                                                                
         TM    PARIND1,PARLDG      FOR SPECIFIC LEDGER?                         
         BZ    PARSE03                                                          
         MVC   WORK(4),CURLDGR                                                  
         NC    WORK(4),PARLDGRS                                                 
         BZ    PARSE50             NOT VALID LEDGER FOR PARSE ENTRY             
                                                                                
PARSE03  TM    POSTLVL,POSTSPLT    SPECIAL SPLIT REC MODE?                      
         BZ    PARSE04                                                          
         TM    PARIND3,PARFRCE     Force to get in split mode                   
         BO    PARSE04                                                          
         TM    PARIND1,PARSPLT     If split mode then split entry               
         BZ    PARSE50                                                          
                                                                                
PARSE04  TM    POSTMODE,POSTBUD    IS IT SPECIAL BUDGET MODE?                   
         BZ    PARSE05             NO, SO CONTINUE                              
         TM    PARIND2,PARBUDO                                                  
         BO    PARSE08                                                          
         TM    PARIND1,PARBUD      IS THIS A BUDGET POSTING TYPE                
         BO    PARSE08                                                          
         B     PARSE50             GET NEXT ENTRY                               
                                                                                
PARSE05  TM    PARIND2,PARBUDO     BUDGET PARSE ONLY?                           
         BO    PARSE50             GET NEXT ENTRY                               
         TM    POSTMODE,POSTBKT    POST BUCKET TYPE RECORDS                     
         BO    PARSE07                                                          
         TM    PARIND2,PARDR+PARCR Check DR or CR posting ?                     
         BNM   PARSE05F              No, either both on or off                  
         TM    TRNSSTAT,X'80'      Debit ?                                      
         BZ    PARSE05C              No                                         
         TM    PARIND2,PARDR       DR wanted ?                                  
         BO    PARSE05F              Yes                                        
         B     PARSE50                                                          
                                                                                
PARSE05C TM    PARIND2,PARCR       CR wanted ?                                  
         BZ    PARSE50                                                          
                                                                                
PARSE05F TM    PARIND1,PARTTYP     CHECK TRANSACTION TYPE UP FRONT              
         BZ    PARSE06                                                          
         CLC   PARTTYP1,REALTYP    INCLUDE THIS TYPE?                           
         BE    PARSE07             OR                                           
         CLC   PARTTYP2,REALTYP    INCLUDE THIS TYPE?                           
         BNE   PARSE50             LOOP                                         
                                                                                
PARSE06  TM    PARIND2,PARXTYP     CHECK TRANSACTION TYPE UP FRONT              
         BZ    PARSE07                                                          
         CLC   PARTTYP1,REALTYP    EXCLUDE THIS TYPE?                           
         BE    PARSE50             OR                                           
         CLC   PARTTYP2,REALTYP    EXCLUDE THIS TYPE?                           
         BE    PARSE50             LOOP                                         
                                                                                
PARSE07  TM    PARIND3,PARVCUL     VALIDATE AGAIN CONTRA U/L                    
         BZ    PARSE07A                                                         
         CLC   PARXTRA,CURSUBAC+1                                               
         BNE   PARSE45             NOT FOUND                                    
                                                                                
PARSE07A CLI   PARTYPE,CALTYPE     CALULATION TYPE                              
         BE    PRSECAL                                                          
                                                                                
PARSE07B CLI   PARTYPE,APDTYPE     Append keyword data                          
         BE    PAPPEND                                                          
                                                                                
PARSE08  CLI   PARTYPE,CODE        SHOULD WE CALL ROUTINE                       
         BNE   PARSE10             YES BRANCH TO ROUTINE                        
         SR    R2,R2                                                            
         LH    R2,PARBASE                                                       
         SLL   R2,2                                                             
         CLM   R2,15,=AL4(ROUTLEN)                                              
         BNH   *+2(R2)                                                          
         DC    H'00'                                                            
                                                                                
* "PARC" routines                                                               
ROUTLIST B     GETACCNM         1  GET ACCOUNT NAME                             
         B     GETCACNM         2  GET CONTRA  NAME                             
         B     GETPRNEN         3  GET PRNENTBL ENTRY                           
         B     GETANAME         4  GET NAME IN TABLE                            
         B     GETCSTNM         5  GET COST NAME                                
         B     GETCOST          6  GET COST CODE                                
         B     GETNUM2          7  GET NUM2                                     
         J     BLDSJCLI         8  BUILD SJ CLIENT                              
         J     BLDSJPRD         9  BUILD SJ PRODUCT                             
         J     BLDSJJOB         10 BUILD SJ JOB                                 
         B     BLDSJPGC         11 BUILD SJ PRODUCT GROUP CLIENT                
         B     BLDSJPGP         12 BUILD SJ PRODUCT GROUP PRODUCT               
         B     PRGRCLI          13 GET PRODUCT GROUP CLIENT                     
         B     PRGRPRD          14 GET PRODUCT PRODUCT                          
         B     GETHEAD1         15 GET HEADING 1 - KEYWORD "STATIC"             
*&&US*&& J     PODTA            16 Filter on PO approval status                 
*&&UK*&& J     PARSE45          16 N/D                                          
*&&UK*&& J     GETISCTN         17 Get ISO country name                         
*&&US*&& J     PARSE45          17 N/D                                          
         B     GETFCNME         18 GET FOREIGN CURRENCY NAME                    
         B     GETSTUDO         19 GET STUDIO TYPE NAME                         
         B     GETSTCPN         20 GET STUDIO CLI OR PROD NAME                  
         J     GETSJOBN         21 GET STUDIO JOB NAME                          
         B     VALBALT          22 X'77' BALT / BBHRS KEYWORDS                  
         B     VALALO$          23 ALLOCATED AMOUNTS/RATE                       
         J     GTFRATE          24 Get File Maintenance rate                    
         J     GETCPED          25 Get calendar period and month                
         B     ZONEDT           26 ZONE FOR PAYABLES                            
         B     COLDAMT          27 COLD amount, MTS, STD/EDIT HRS               
         B     SJACEQU          28 SJ account equivalents on SR                 
         B     GETGRUP          29 Get client billing group                     
         J     GETJCOM          30 Get job comment                              
*&&DO*&& B     GETSRAT          31 Get sales rate - UK                          
         J     PARSE45          31 N/D                                          
*&&UK*&& J     GETEQNM          32 Get equivalent name                          
*&&US*&& J     PARSE45          32 Once we have equiv name this will go         
         J     GENACC#          33 Unique account number per run                
         B     GETBILT2         34 Get bill type previous billing               
*&&UK*&& J     GETXJCM          35 Get XJob Desktop comments (UK)               
*&&US*&& J     PARSE45          35 N/D                                          
*&&US*&& J     VPYMTHP          36 EFT/CHECK payment method for PAY             
*&&UK*&& J     PARSE45          36 N/D                                          
*&&US*&& J     VPYMTHC          37 EFT/CHECK payment method for CASH            
*&&UK*&& J     PARSE45          37 N/D                                          
*&&US*&& J     VFRLST           38 Freelancer status (1R)                       
*&&UK*&& J     PARSE45          38 N/D                                          
*&&UK*&& J     GETCTYNM         39 GET COUNTRY NAME (UK)                        
*&&US*&& J     PARSE45          39 N/D                                          
*&&UK*&& J     GETVATNM         40 GET VAT NUMBER FOR LEDGER SJ (UK)            
*&&US*&& J     PARSE45          40 N/D                                          
*&&UK*&& J     GETCTYCD         41 GET COUNTRY CODE FOR LEDGER SJ (UK)          
*&&US*&& J     PARSE45          41 N/D                                          
         J     GETTHRS          42 Get timesheet hours                          
         J     GETETYPN         43 Get Expenditure type name                    
         J     GETDAYNM         44 Get Day name                                 
*&&UK*&& J     GETBYSR          45 Get media buy serial number (UK)             
*&&US*&& J     GETMEDNM         45 GET MEDIA name for SSN/SU                    
*&&UK*&& J     GETJDES          46 Get job description                          
*&&US*&& J     PARSE45          46 N/D                                          
*&&UK*&& J     GETTSNO          47 Get trx serial number                        
*&&US*&& J     PARSE45          47 N/D                                          
*&&UK*&& J     GETBACV          48 Get BACSORT value                            
*&&US*&& J     PARSE45          48 N/D                                          
*&&UK*&& J     GETBACV          49 Get BACCOUNT value                           
*&&US*&& J     PARSE45          49 N/D                                          
*&&UK*&& J     GETBACV          50 Get BACACNAM value                           
*&&US*&& J     PARSE45          50 N/D                                          
*&&UK*&& J     GETBACV          51 Get BACBNAME value                           
*&&US*&& J     PARSE45          51 N/D                                          
*&&UK*&& J     GETEBDV          52 Get EBDIBAN value                            
*&&US*&& J     PARSE45          52 N/D                                          
*&&UK*&& J     GETEBDV          53 Get EBDBIC value                             
*&&US*&& J     PARSE45          53 N/D                                          
*&&UK*&& J     GETRSER          54 Get REF_SER number value (GRPMUK)            
*&&US*&& J     PARSE45          54 N/D                                          
*&&UK*&& J     GETFCAS          55 Get FC AMOUNT WITH SHIFT (GRPMUK)            
*&&US*&& J     PARSE45          55 N/D                                          
*&&UK*&& J     GETOFGC          56 Get office group code                        
*&&US*&& J     PARSE45          56 N/D                                          
*&&UK*&& J     GETBGA           57 Get a/c billing group code (GRPMUK)          
*&&US*&& J     PARSE45          57 N/D                                          
*&&UK*&& J     GETBGAC          58 Get SR billing group code (GRPMUK)           
*&&US*&& J     PARSE45          58 N/D                                          
*&&UK*&& J     GETIDES          59 Get item description                         
*&&US*&& J     PARSE45          59 N/D                                          
*&&UK*&& J     GETTYID          60 Get type indicator (GRPMUK)                  
*&&US*&& J     PARSE45          60 N/D                                          
*&&UK*&& J     GETRCTN          61 Get receipt number (GRPMUK)                  
*&&US*&& J     PARSE45          61 N/D                                          
*&&UK*&& J     GETOPCD          62 Get operation code (GRPMUK                   
*&&US*&& J     PARSE45          62 N/D                                          
                                                                                
ROUTLEN  EQU   *-ROUTLIST                                                       
                                                                                
PARSE10  LA    R1,R2*16            R1 = '00000020' FOR R2 LOAD ADDRESS          
         MVC   LOADADRS+2(2),PARBASE    "S" TYPE (BASE+DISP)                    
         EX    R1,LOADADRS         SET R2                                       
         CLI   PARTYPE,STORAGE     IN STORAGE LOCATION?                         
         BE    PARSE40             DATA IS IN THIS LOCATION, SO GET IT          
                                                                                
         LA    R1,R2*16            R1 = '00000020' FOR R2 LOAD                  
         MVC   LOAD+2(2),PARBASE   "S" TYPE (BASE+DISP)                         
         EX    R1,LOAD                                                          
         LTR   R2,R2               DID I LOAD ANY ADDRESS?                      
         BZ    PARSE50             NO, SO TRY NEXT ENTRY IN PARSE TBL           
         TM    PARIND1,PARADJ      DO WE NEED TO ADJUST BY KEY LENGTH           
         BZ    PARSE12                                                          
         TM    PARIND4,PARAMST     Master type format                           
         BZ    PARSE11                                                          
         SHI   R2,ACTRFST-ACTRECD                                               
         B     PARSE12                                                          
                                                                                
PARSE11  CLI   MODE,PROCSBAC                                                    
         BE    PARSE12                                                          
         CLI   MODE,PROCSBOF                                                    
         BE    PARSE12                                                          
         SH    R2,DATADISP         ADJUST BY KEY LENGTH                         
                                                                                
PARSE12  DS    0H                                                               
*&&DO                              DOESN'T WORK FOR MULTIPLE ELEMENTS           
         TM    PARIND4,PARELNH     CHECK ELEM LENGTH (EQUAL OR HIGHER)          
         BZ    PARSE13                                                          
         CLC   PARTTYP2,1(R2)      DOES LENGTH MATCH                            
         BH    PARSE50             NO, SO GET NEXT                              
         B     PARSE14                                                          
                                                                                
PARSE13  TM    PARIND3,PARELLN     CHECK ELEMENT LENGTH (EQUAL ONLY)            
         BZ    PARSE14                                                          
         CLC   PARTTYP2,1(R2)      DOES LENGTH MATCH                            
         BNE   PARSE50             NO, SO GET NEXT                              
*&&                                                                             
                                                                                
PARSE14  CLI   PARTYPE,ELEMENT     GET DATA FROM ELEMENT                        
         BE    PARSE16                                                          
         CLI   PARTYPE,ELMTYPE     LOAD A(ELEMENT)                              
         BE    PARSE20                                                          
         CLI   PARTYPE,KEYTYPE     Data in a key or area block                  
         BE    PARSE40                                                          
         B     PARSE99             NOT FOUND, EXIT                              
                                                                                
PARSE16  TM    PARIND4,PARAMST     Master type format                           
         BZ    PARSE18                                                          
         AHI   R2,ACTRFST-ACTRECD                                               
         B     PARSE20                                                          
PARSE18  AH    R2,DATADISP                                                      
                                                                                
PARSE20  CLI   0(R2),0             END OF RECORD?                               
         BE    PARSE50             NEXT TYPE IN PARSE TABLE                     
         CLC   PARELEM,0(R2)       PARSE ELEM. CODE TO GET                      
         BNE   PARSE26                                                          
         TM    PARIND4,PARELNH     CHECK ELEM LENGTH (EQUAL OR HIGHER)          
         BZ    PARSE22                                                          
         CLC   PARTTYP2,1(R2)      DOES LENGTH MATCH                            
         BH    PARSE26             NO, SO GET NEXT ELEMENT                      
         B     PARSE28                                                          
                                                                                
PARSE22  TM    PARIND3,PARELLN     CHECK ELEMENT LENGTH (EQUAL ONLY)            
         BZ    PARSE28                                                          
         CLC   PARTTYP2,1(R2)      DOES LENGTH MATCH                            
         BE    PARSE28             YES, WE WANT THIS ONE                        
                                                                                
PARSE26  SR    R1,R1                                                            
         ICM   R1,1,1(R2)                                                       
         BNZ   *+6                 ABEND TO PREVENT LOOPING IN RUNNER           
         DC    H'0'                JOB.IF YOU DIE HERE, CHECK IF PARADJ         
         AR    R2,R1               NEEDED/MISSING IN RL05 PRSETAB ENTRY         
         B     PARSE20                                                          
                                                                                
PARSE28  CLC   1(1,R2),PARDSPEL+1  MAKE SURE WITHIN ELEMENT LENGTH              
         BH    PARSE30             ELEMENT OK                                   
         TM    PARIND1,PARMULT     TOO SHORT SO SEE IF WE KEEP ON               
         BO    PARSE26             GOING                                        
         B     PARSE50                                                          
                                                                                
PARSE30  ST    R2,PARELADR                                                      
         TM    PARIND1,PARSPLT+PARMULT                                          
         BO    PARSE40                                                          
         BRAS  RE,CHK2DEL          Passed so far so mark for del. later         
                                                                                
PARSE40  LR    R8,R2               USE TWO REGS. TO POINT TO ELEMENT            
         AH    R2,PARDSPEL         POINT TO ELEMENT DATA                        
         AH    R8,PARDSPTT         POINT TO ELEMENT TEST CHARACTER              
         TM    PARIND1,PAROTH      USE OTHER SOURCE FOR R8                      
         BZ    PARSE41                                                          
         LA    R1,R8*16            R1 = '00000080' FOR R8 LOAD ADDRESS          
         MVC   LOADADRS+2(2),PARDSPTT                                           
         EX    R1,LOADADRS                                                      
                                                                                
PARSE41  TM    PARIND3,PARULSAV    SAVE UNIT/LEDGER ?                           
*&&US*&& BZ    *+16                NO,  SKIP                                    
*&&UK*&& BZ    *+10                NO,  SKIP                                    
         MVC   PARSAVUL,0(R8)      SAVE UNIT/LEDGER                             
*&&US*&& MVC   MEDSAVLG,2(R8)      SAVE LEDGER FOR MEDIA PAYABLE                
                                                                                
         TM    PARIND3,PARVALUL    VALIDATE AGAINST UNIT/LEDGER                 
         BZ    PARSE42                                                          
         LR    RF,R2               R2 = LOCATION OF DATA                        
         CLI   PARTYPE,ELEMENT     IS DATA FROM ELEMENT ?                       
         BE    *+8                                                              
         CLI   PARTYPE,ELMTYPE     IS DATA FROM ELEMENT ?                       
         BE    *+6                                                              
         DC    H'00'               MUST CODE EACH CASE                          
                                                                                
         SH    RF,PARDSPEL         POINT TO START OF ELEMENT                    
         CLI   0(RF),SORELQ        IS IT A SORELD, X'7B' ?                      
         BE    *+6                                                              
         DC    H'00'               MUST CODE EACH CASE                          
                                                                                
         LA    RF,SORAULA-SORELD(RF)     POINT TO UNIT/LEDGER                   
         CLC   PARXTRA(2),0(RF)                                                 
         BNE   PARSE45             NO GOOD GET NEXT ENTRY                       
                                                                                
PARSE42  TM    PARIND2,PAREXNM     GET EXECUTE LENGTH FOR NAME                  
         BZ    PARSE43                                                          
         L     RF,PARELADR                                                      
         SR    R1,R1                                                            
         IC    R1,1(,RF)           LENGTH OF ELEMENT                            
         SH    R1,PARDSPEL         DISPLACEMENT TO DATA                         
         BNP   PARSE50             NO NAME, GET NEXT ENTRY                      
         STH   R1,PARFRLEN         YES SO USE LENGTH                            
                                                                                
PARSE43  CLI   PARTEST,0           NO SPECIAL TEST                              
         BE    PARSE60             FOUND, MOVE IN DATA                          
         SR    R1,R1                                                            
         IC    R1,PARTEST          USE ROUTINE TO TEST (VALIDATE CODE)          
         ICM   RF,15,PARADDR                                                    
         BZ    PARSE60             NO VALIDATION ROUTINE                        
         SLL   RF,2                                                             
         CLM   RF,15,=AL4(PARVLEN)                                              
         BNH   *+2(RF)                                                          
         DC    H'00'                                                            
                                                                                
PARVLIST B     VALCHAR          1  VALIDATE CHARACTER                           
         B     VALBYTE          2  VALIDATE BIT IN BYTE                         
         B     AGEAMNT          3  AGE AMOUNT                                   
         B     AGEFC$1          4  AGE FOREIGN CURRENCY                         
         B     AGEFC$2          5  AGE PAY FOREIGN CURRENCY                     
         B     NARDAT05         6  GET VOID FROM NARRATIVE                      
         B     NARDATA          7  GET DATA FROM NARRATIVE                      
         B     DATEFIX          8  FIX DATE FOR BAD MOS                         
         B     GETACCC          9  GET ACCOUNT CODE FROM X'C0' ELEMENT          
         B     GETAORC          10 GET BRAND CODE                               
         B     GETAORN          11 GET BRAND NAME                               
         B     MMOSBRD          12 MEDIA MOS FOR BROADCAST                      
         B     MMOSPAY          13 MEDIA MOS FOR PAYABLES                       
         B     GETNARA          14 GET NARRATIVE                                
         B     VALADDR          15 VALIDATE THAT AN ADDRESS AT LEVEL            
         B     CNTRFIX          16 CONTRA FIX                                   
         J     VALUFLD          17 VALIDATE USER FIELD                          
         J     UFMPGC           18 USER FIELD MEDIA PRODUCT GROUP CODE          
         J     UFMPGN           19 USER FIELD MEDIA PRODUCT GROUP NAME          
         B     VALCOMM          20 VALIDATE IF COMMISSIONABLE                   
         B     AGEPAY$          21 FOREIGN CURRENCY AGEING                      
         B     VALNAND          22 NAND CHARACTER WITH BITS                     
         B     VALWROF          23 CONVERT WRITE - OFFS                         
         B     OMEMACC          24 ONLINE MEMO ACCOUNT                          
         B     VALTIMC          25 TIME ELEM TYPE CONVERT                       
         B     VALPCT           26 TIME DIVIDED BY TOTAL HOURS                  
         J     VALREPC          27 VALIDATE REP CODE                            
         B     VALTTYC          28 TYPE TIME CONVERT                            
         B     VALWCNM          29 WORKCODE LONG/SHORT NAME                     
         B     VALCNUM          30 CHECK    NUMBER (NUMBER IN CHAR)             
         B     ADDVAT           31 ADD UP VAT AMOUNT (UK)                       
         B     VALPAY$          32 PAYROLL   AMOUNTS/RATE                       
         J     PAYDET           33 PAYROLL   CODE/NAME                          
         B     GETCONTR         34 Get contractor name                          
         B     VAL2CHAR         35 validate 2 char compare                      
         B     GETBILTY         36 Get bill type for charges (DR)               
*&&US*&& J     AORSIGN          37 Adjust sign for DR or CR on AOR $            
*&&UK*&& J     PARSE45                                                          
*&&US*&& J     TYPETAX          38 QST or HST                                   
*&&UK*&& J     PARSE45                                                          
         J     LBILRF6          39 Fix LBILL ref # for type 6 RCV               
         J     LBILRF9          40 Fix LBILL bill # for type 9 RCV              
         J     LBL2RF9          41 Fix LBLLND bill # for type 9 RCV             
         J     LBL2RF6          42 Fix LBLLND ref # for type 6 RCV              
         J     GETRSTA          43 Get reversed status (Yes/No)                 
*&&UK*&& J     GETCTRY          44 Get country code                             
*&&US*&& J     PARSE45                                                          
*&&UK*&& J     GETSOAC          45 Get Account from X'4F' element               
*&&US*&& J     PARSE45                                                          
*&&UK*&& J     GETXDAT          46 Get Extra data                               
*&&US*&& J     PARSE45                                                          
*&&UK*&& J     GETMVAL          47 Get memo value                               
*&&US*&& J     PARSE45                                                          
*&&US*&& J     B2AMT            48 Adjust B2 amt                                
*&&UK*&& J     PARSE45                                                          
*&&US*&& J     SM2CFX           49 Fix system/media code for Net                
*&&UK*&& J     PARSE45                                                          
*&&US*&& J     NAMEFX           50 Fix client name for Y&R                      
         J     PIDN             51 Get pid name                                 
*&&UK*&& J     GETTIMSH         52 GET Timesheet (BrandOcean)                   
*&&US*&& J     PARSE45                                                          
         J     GETESNUM         53 GET Estimate (local) number                  
         J     GETESTAT         54 GET Estimate status                          
         J     TRNESTAS         55 Translate Estimate status bytes              
*&&UK*&& J     GETEXDAT         56 Get Estimate extra data                      
*&&US*&& J     PARSE45                                                          
         J     XESTFLT          57 Extra Estimate filtering                     
*&&US*&& J     B2WCTYP          58 Store wc type based on B2 elem wc            
*&&UK*&& J     PARSE45                                                          
*&&UK*&& J     GETESNAM         59 GET Estimate name                            
*&&US*&& J     PARSE45                                                          
*&&UK*&& J     GETESCUN         60 GET Est Currency name                        
*&&US*&& J     PARSE45                                                          
*&&UK*&& J     GETCRPMT         61 GET Creditor payment method                  
*&&US*&& J     PARSE45                                                          
*&&UK*&& J     PIDPNAM          62 Get pid person name                          
*&&US*&& J     PARSE45                                                          
*&&UK*&& J     GETINVST         63 Get BrandOcean Invoice status                
*&&US*&& J     PARSE45                                                          
*&&UK*&& J     GETTYMP          64 Get Tx Type mapping to a column              
*&&US*&& J     PARSE45                                                          
*&&UK*&& J     VALTXCUR         65 CURRENCY VALIDATION ON TRANSACTION           
*&&US*&& J     PARSE45                                                          
*&&UK*&& J     VALTRNFR         66 TRANSFER VALIDATION ON TRANSACTION           
*&&US*&& J     PARSE45                                                          
*&&UK*&& J     GETSORA          67 Get source a/c from X'7B'                    
*&&US*&& J     PARSE45                                                          
*&&UK*&& J     GETBGM           68 Get media billing group (GRPMUK)             
*&&US*&& J     PARSE45                                                          
*&&UK*&& J     GETCATN          69 Get category name (GRPMUK)                   
*&&US*&& J     PARSE45                                                          
*&&UK*&& J     GETTRSC          70 Get REF_SER number for cash (GRPMUK)         
*&&US*&& J     PARSE45          70 N/D                                          
*&&UK*&& J     PARSE45          71 N/D                                          
*&&US*&& J     GETREFN          71 Get Reference Number                         
*&&UK*&& J     VALCLAD          72 Test Cli added last month (GRPMUK)           
*&&US*&& J     PARSE45          72 N/D                                          
*&&UK*&& J     VALCURTF         73 CURR/TRANSFER VALIDATION (GRPMUK)            
*&&US*&& J     PARSE45          73 N/D                                          
*&&UK*&& J     PARSE45          74 N/D                                          
*&&US*&& J     GETAGYMF         74 GET AGENCY MEDIA FILE                        
*&&UK*&& J     PARSE45          75 N/D                                          
*&&US*&& J     GETRQDT          75 GET REQUEST DATE TIME                        
*                                                                               
PARVLEN  EQU   *-PARVLIST                                                       
*                                                                               
PARSE45  TM    PARIND1,PARMULT     SEE IF THERE ARE MULT ELEMENTS               
         BZ    PARSE50             NO SO LOOP IN PARSE TABLE                    
         ICM   R2,15,PARELADR      RESTORE TO START OF ELEMENT                  
         BNZ   PARSE26             SEE IF THERE IS ANOTHER ELEMENT              
                                                                                
PARSE50  AHI   R3,PARSEDQ          NOT FOUND, SO GET NEXT PARSE TYPE            
         B     PARSE02                                                          
                                                                                
PARSE60  TM    PARDMSK,PARDLVL                                                  
         BZ    PARSE62                                                          
         SR    R1,R1                                                            
         ICM   R1,3,PARFRLEN       FULL ACCOUNT                                 
         SR    RF,RF                                                            
         IC    RF,PARDLEN          LENGTH OF PART OF ACCOUNT                    
         SR    R1,RF               CALCULATE DISPLACMENT TO PART                
         BM    PARSE62             IF NEG SOMETHING WACKED                      
         AR    R2,R1               ADD DISPLACEMENT IN TO ADJUST                
                                                                                
PARSE62  SR    R1,R1               SEE IF INPUT NULLS OR SPACES                 
         ICM   R1,3,PARFRLEN       LENGTH OF PARSE DATA                         
         OC    PARNEWLN,PARNEWLN   NEW OVERRIDE LENGTH?                         
         BZ    *+8                 NO                                           
         ICM   R1,3,PARNEWLN       NUM OF CHARACTERS TO MOVE RETURN             
                                                                                
PARSE64  CLI   PARFRTYP,BINARY     BINARY TO PACKED                             
         BE    PARSE74                                                          
         CLI   PARFRTYP,SIGNED     BINARY SIGNED TO PACKED                      
         BE    PARSE68                                                          
         SHI   R1,1                                                             
         BM    PARSE45                                                          
         LA    RF,L'SPACES-1                                                    
         CR    R1,RF                                                            
         BNH   *+6                                                              
         LR    R1,RF               Just check first L'SPACES chars              
         CLI   PARFRTYP,PACK       Packed data                                  
         BE    PARSE64A            Yes, so can't be spaces                      
         TM    PARIND3,PARBLKOK    Blank is ok (ADDED TO KYWRD FOR BUD)         
         BO    PARSE64A            DON'T CHECK (ADD BIT AS NEEDED)              
         EXCLC R1,0(R2),SPACES                                                  
         BE    PARSE45             IF IS NO DATA FOUND TRY NEXT PARSE           
*                                                                               
PARSE64A EXOC  R1,0(R2),0(R2)                                                   
         BZ    PARSE45             IF IS NO DATA FOUND TRY NEXT PARSE           
         CLI   PARFRTYP,CHAR       CHARACTER TYPE                               
         BE    PARSE65                                                          
         CLI   PARFRTYP,USGNPACK   UNSIGNED PACKED                              
         BE    PARSE70                                                          
         CLI   PARFRTYP,PACK       PACKED                                       
         BE    PARSE70                                                          
         CLI   PARFRTYP,DATETYPE   DATE TYPE TO DATE TYPE                       
         BE    PARSE78                                                          
         DC    H'00'               TYPE NOT DEFINED                             
                                                                                
         USING ACRL2D,R6                                                        
PARSE65  L     R6,AACRL2D                                                       
         LA    R0,XLCHOP           CLEAR XLCHOP TO ZEROES OR SPACES             
         LA    R1,GESIZEQ                                                       
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         ICM   RF,8,SPACES         SET PADDING CHARACTER                        
         MVCL  R0,RE                                                            
*                                                                               
         ICM   R1,3,PARFRLEN       SIZE OF FIELD TO RETRIEVE FROM               
         OC    PARNEWLN,PARNEWLN   NEW OVERRIDE LENGTH?                         
         BZ    *+8                 NO                                           
         ICM   R1,3,PARNEWLN       NUM OF CHARACTERS TO MOVE RETURN             
         LTR   R1,R1                                                            
         BZ    PARSE45             LENGTH NO GOOD                               
         ST    R1,SVR1                                                          
*                                                                               
         LR    R0,R2               MOVE DATA TO XLCHOP                          
         LA    RE,XLCHOP                                                        
         LR    RF,R1                                                            
         MVCL  RE,R0                                                            
         L     R1,SVR1                                                          
*                                                                               
         OC    PARTOLEN,PARTOLEN   NUM OF CHARACTERS TO MOVE RETURN             
         BZ    PARSE45             LENGTH NO GOOD                               
*                                                                               
         TM    PARIND1,PARPAD40    MAKE NULLS SPACES                            
         BZ    *+10                                                             
         OC    XLCHOP(L'SPACES),SPACES                                          
                                                                                
         USING ROWD,R8                                                          
         TM    PARDMSK,PARREPL     Replace data found ?                         
         BZ    PARSE67                                                          
         L     R8,ACURROW                                                       
         TM    ROWXPIND,ROWREPTB   Replacement table ?                          
         BO    PARSE67                                                          
         GOTO1 =A(REPLACE),DMCB,(R8),XLCHOP (USES XLCHOP & GENAREA2)            
         SR    R1,R1                                                            
         ICM   R1,3,ROWKYSZ                                                     
         BZ    PARSE90                                                          
         DROP  R8                                                               
                                                                                
*ARSE67  DS    0H                                                               
PARSE67  BAS   RE,SPACEIT                                                       
                                                                                
         LR    R0,R4               Move data to R4                              
         LA    RE,XLCHOP                                                        
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         B     PARSE90             DATA FOUND, EXIT                             
                                                                                
PARSE68  LH    R1,0(,R2)           MUST BE HALF WORD TO KEEP SIGN               
         CLI   PARFRLEN+1,2                                                     
         BE    PARSE75A            OR                                           
         L     R1,0(,R2)           FULL WORD                                    
         CLI   PARFRLEN+1,4                                                     
         BE    PARSE75A                                                         
         DC    H'00'                                                            
                                                                                
PARSE70  CLI   PARTOTYP,PACK       PACKED TO PACKED                             
         BNE   PARSE73                                                          
         ICM   R1,3,PARTOLEN       SIZE OF FIELD TO ZAP TO                      
         BCTR  R1,0                ADJUST BY ONE                                
         SLA   R1,4                SHIFT OVER BY ONE HEX DIGIT                  
         LA    R8,PARZAP           SET UP ZAP                                   
         CLI   PARFRTYP,PACK       PACKED TO PACKED                             
         BE    PARSE72                                                          
         LA    R8,PARMVO           SET UP MVO                                   
         EX    R1,*+8                                                           
         B     PARSE72                                                          
         ZAP   0(0,R4),PKZERO      CLEAR OUT                                    
                                                                                
PARSE72  SR    R0,R0                                                            
         ICM   R0,3,PARFRLEN       SIZE OF FIELD ZAPPING FROM                   
         OC    PARNEWLN,PARNEWLN                                                
         BZ    *+8                                                              
         ICM   R0,3,PARNEWLN                                                    
         BCTR  R0,0                ADJUST BY ONE                                
         OR    R1,R0               OR SIZES TOGETHER                            
         EX    R1,0(,R8)           EXECUTE FOR BOTH LENGTHS IN ZAP              
         TM    PARIND2,PARSHFT                                                  
         BZ    PARSE72A                                                         
         N     R1,=X'000000F0'                                                  
         EX    R1,PARSRP                                                        
                                                                                
PARSE72A TM    PARIND2,PARNEG      REVERSE SIGN                                 
         BZ    PARSE90                                                          
         N     R1,=X'000000F0'                                                  
         EX    R1,PARMP                                                         
         B     PARSE90                                                          
                                                                                
PARZAP   ZAP   0(0,R4),0(0,R2)                                                  
PARMVO   MVO   0(0,R4),0(0,R2)                                                  
PARSRP   SRP   0(0,R4),2,5                                                      
PARMP    MP    0(0,R4),PKNEG                                                    
                                                                                
PARSE73  CLI   PARTOTYP,BINARY     PACKED TO BINARY                             
         BE    *+6                                                              
         DC    H'0'                                                             
         ICM   R1,3,PARFRLEN       SIZE OF FIELD ZAPPING FROM                   
         BCTR  R1,0                                                             
         EX    R1,*+8              EXECUTE FOR BOTH LENGTHS IN ZAP              
         B     *+10                                                             
         ZAP   DUB,0(0,R2)                                                      
                                                                                
         CVB   R1,DUB                                                           
         CLI   PARTOLEN+1,4                                                     
         BNH   *+6                                                              
         DC    H'0'                BINARY LENGTH TO LONG, 4 MAX                 
         SR    RF,RF                                                            
         ICM   RF,3,PARTOLEN       LENGTH OF BINARY NUMBER                      
         EX    RF,*+8                                                           
         B     PARSE90                                                          
         STCM  R1,0,0(R4)          PUT BINARY NUMBER IN RECORD                  
                                                                                
PARSE74  CLI   PARTOTYP,BINARY     BINARY TO BINARY                             
         BNE   PARSE75                                                          
         SHI   R1,1                                                             
         BM    PARSE99                                                          
         EXMVC R1,0(R4),0(R2)                                                   
         B     PARSE90                                                          
                                                                                
PARSE75  CLI   PARFRLEN+1,4        MUST BE FOUR OR SHORTER                      
         BNH   *+6                                                              
         DC    H'0'                CAN'T CONVERT A >4 BYTE BINARY               
         LA    RF,1                                                             
         SLL   RF,0(R1)            POWERS OF 2     ( 2 , 4 , 8 , 16)            
         BCTR  RF,0                FOR ICM WE NEED ( 1 , 3 , 7 , 15)            
         SR    R1,R1                                                            
         EX    RF,*+8                                                           
         B     *+8                                                              
         ICM   R1,0,0(R2)                                                       
                                                                                
PARSE75A CVD   R1,DUB                                                           
         CLI   PARTOTYP,PACK       CONVERT TO BINARY TO PACKED                  
         BNE   PARSE76                                                          
         ZAP   0(PKLEN,R4),DUB                                                  
         B     PARSE90                                                          
                                                                                
PARSE76  CLI   PARTOTYP,CHAR       CONVERT TO BINARY TO CHARACTER               
         BE    *+6                                                              
         DC    H'0'                                                             
         SR    R1,R1                                                            
         ICM   R1,3,PARTOLEN                                                    
         BCTR  R1,0                                                             
         SLL   R1,4                                                             
         OI    DUB+7,X'0F'         MAKE SIGN A CHARACTER                        
         EX    R1,*+8                                                           
         B     PARSE90                                                          
         UNPK  0(0,R4),DUB                                                      
***********************************************************************         
*              CONVERT DATE FORM PARFRLEN TO PARTOLEN                 *         
***********************************************************************         
PARSE78  CLC   PARFRLEN,PARTOLEN   SAME TYPE?                                   
         BNE   PARSE79                                                          
         MVC   0(2,R4),0(R2)       MOVE CHARACTER YYMM                          
         CLI   PARFRLEN+1,9        YYMM (PACKED)                                
         BNE   *+12                                                             
         MVI   2(R4),01            DD=01                                        
         B     PARSE90                                                          
         MVC   2(1,R4),2(R2)       MOVE CHARATER DD                             
         B     PARSE90                                                          
                                                                                
PARSE79  MVC   DATEFRM,PARFRLEN+1  CONVERT DATE TYPE FROM                       
         MVC   DATETO,PARTOLEN+1   TO DATE TYPE TO                              
         CLI   PARFRLEN+1,9        YYMM (PACKED)                                
         BL    PARSE80                                                          
         MVI   DATEFRM,1           YYMM PACKED DATE FORM  DATETYPE=9            
         BE    *+8                                                              
         MVI   DATEFRM,3           YYMM BINARY DATE FORM  DATETYPE=10           
         MVC   FIXDATE(2),0(R2)                                                 
         MVC   TEMPDATE(3),FIXDATE                                              
         LA    R2,TEMPDATE                                                      
         B     PARSE86                                                          
                                                                                
PARSE80  CLI   PARFRLEN+1,8        MMMDD/YY                                     
         BNE   PARSE86                                                          
         XC    0(3,R4),0(R4)       CLEAR AREA                                   
         GOTO1 =V(DATVAL),DMCB,(0,(R2)),TEMPDATE                                
         CLI   DMCB+3,0                                                         
         BE    PARSE99              NOT VALID SO LEAVE                          
                                                                                
         MVI   DATEFRM,0           YYMMDD EBCIDC FORM                           
         OC    PARTOLEN,PARTOLEN   SEE IF WE NEED TO CONVERT FURTHER            
         LA    R2,TEMPDATE                                                      
         BNZ   PARSE86                                                          
         MVC   0(L'TEMPDATE,R4),TEMPDATE                                        
         B     PARSE90                                                          
                                                                                
PARSE86  CLI   PARTOLEN+1,9                                                     
         BL    PARSE88                                                          
         MVI   DATETO,1            PACKED YYMM, DATETYPE=9                      
         BE    *+8                                                              
         MVI   DATETO,3            BINARY YYMM, DATETYPE=10                     
                                                                                
PARSE88  GOTO1 DATCON,DMCB,(DATEFRM,(R2)),(DATETO,(R4))                         
         CLI   PARTOLEN+1,9                                                     
         BL    PARSE90                                                          
         MVI   2(R4),01                                                         
                                                                                
PARSE90  BRAS  RE,CHK2DEL          See if we will need to delete later          
                                                                                
         TM    UPSI,UPSISPTR       Dump data to trace                           
         BZ    PARSE98                                                          
         GOTO1 =A(TRACE),1                                                      
                                                                                
PARSE98  SR    RE,RE               DATA FOUND, SET CON CODE FOUND               
                                                                                
PARSE99  LTR   RE,RE               DATA NOT FOUND IF JUMP TO 99                 
         XMOD1                                                                  
LOAD     L     R0,0(,0)            EXCUTED LOAD                                 
LOADADRS LA    R0,0                EXCUTED LOAD ADDRESS                         
*                                                                               
DATEFRM  DC    AL1(0)                                                           
DATETO   DC    AL1(0)                                                           
PSTLVL   DC    AL1(0)                                                           
FIXDATE  DC    XL3'000001'         YYMMDD PACKED OR BINARY                      
         EJECT ,                                                                
SPACEIT  NTR1                                                                   
         ICM   R1,3,PARFRLEN       Clear out 0(r4) first                        
         CLC   PARFRLEN,PARTOLEN   Use the longer length                        
         BNL   *+8                                                              
         ICM   R1,3,PARTOLEN                                                    
         LTR   R1,R1                                                            
         BZ    SPACEITX                                                         
*                                                                               
         LR    R0,R4               FILL 0(R4) WITH SPACES                       
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         ICM   RF,8,SPACES                                                      
         MVCL  R0,RE                                                            
SPACEITX XIT1                                                                   
         EJECT ,                                                                
         USING EQUD,R6                                                          
PRSECAL  CLI   PSTLVL,3            If high die maybe looping                    
         BNH   *+6                                                              
         DC    H'00'                                                            
         CLI   PSTLVL,0            Set BYTE1 to no if zero                      
         BNE   *+8                                                              
         MVI   BYTE1,NO                                                         
         SR    R6,R6                                                            
         ICM   R6,3,PARDSPEL       Load first from equation list                
         A     R6,EQUBASE                                                       
         ZAP   PAROPRND,PKZERO     Clear operand                                
*                                                                               
PRSECAL2 ZAP   PARANSWR,PKZERO     Clear answer                                 
         SR    R8,R8                                                            
         ICM   R8,3,EQUPRSE                                                     
         BZ    PRSECAL9            Finished                                     
         TM    EQUIND,EQUCR        Is it credit only ?                          
         BZ    *+12                No                                           
         TM    TRNSSTAT,X'80'                                                   
         BO    PRSECAL6            It is a DR, so skip                          
         TM    EQUIND,EQUDR        Is it debit only ?                           
         BZ    *+12                No                                           
         TM    TRNSSTAT,X'80'                                                   
         BZ    PRSECAL6            It is a CR, so skip                          
         A     R8,PRSBASE                                                       
         TM    POSTLVL,POSTSPLT                                                 
         BZ    PRSECAL3                                                         
         TM    EQUIND,EQUMULT                                                   
         BZ    PRSECAL6            Skip this parse in split mode                
*                                                                               
PRSECAL3 SR    R2,R2                                                            
         IC    R2,PSTLVL           Get current level                            
         AHI   R2,1                                                             
         STC   R2,PSTLVL                                                        
         GOTO1 PARSE,DMCB,(R8),PARANSWR,0,0                                     
         BNE   *+8                                                              
         MVI   BYTE1,YES           Turn on to say found data                    
         AHI   R2,-1                                                            
         STC   R2,PSTLVL                                                        
         CLI   EQUOPTR,C'+'        Add                                          
         BNE   *+10                                                             
         AP    PAROPRND,PARANSWR                                                
         CLI   EQUOPTR,C'-'        Subtract                                     
         BNE   *+10                                                             
         SP    PAROPRND,PARANSWR                                                
         CLI   EQUOPTR,C'*'        Multiple                                     
         BE    *+8                                                              
         CLI   EQUOPTR,C'X'        Just in case                                 
         BNE   PRSECAL4                                                         
         SR    RF,RF                                                            
         IC    RF,EQUDECM                                                       
         LA    R1,64                                                            
         SR    R1,RF               Number of decimals to shift for              
         MP    PAROPRND,PARANSWR                                                
         SRP   PAROPRND,0(R1),5                                                 
*                                                                               
PRSECAL4 CLI   EQUOPTR,C'/'        Divide                                       
         BNE   PRSECAL6                                                         
         CP    PARANSWR,PKZERO                                                  
         BE    PARSE50             Don't divide by zero                         
         SRP   PAROPRND,6,0                                                     
         DP    PAROPRND,PARANSWR                                                
         SR    RF,RF                                                            
         IC    RF,EQUDECM                                                       
         LA    R1,64                                                            
         AR    R1,RF               Number of decimals to shift for              
         AHI   R1,-6                                                            
         ZAP   PAROPRND,PAROPRND(8)       Get rid of remainder                  
         SRP   PAROPRND,0(R1),5                                                 
PRSECAL6 LA    R6,EQULNQ(,R6)                                                   
         B     PRSECAL2                                                         
*                                                                               
PRSECAL9 LA    R2,PAROPRND+8       Set R2 for return to parse                   
         CLI   BYTE1,YES                                                        
         BNE   PARSE50             No data found                                
         B     PARSE60                                                          
         DROP  R6                                                               
         SPACE 2                                                                
         LTORG                                                                  
         EJECT ,                                                                
***********************************************************************         
*  TEST A CHARACTER OR A BIT                                          *         
***********************************************************************         
         SPACE 1                                                                
VALCHAR  EX    R1,COMPCHAR         Compare single character                     
         B     VALBY10                                                          
*                                                                               
VAL2CHAR CLC   0(2,R8),PARXTRA     Compare two characters                       
         B     VALBY10                                                          
*                                                                               
VALBYTE  EX    R1,TESTMASK         Test under mask                              
*                                                                               
VALBY10  IC    R1,PARCC            MOVE CONDITION CODE INTO BRANCH              
         EX    R1,*+8              BRANCH BASED ON CC IN R1                     
         B     PARSE45                                                          
         BC    0,PARSE60           FOUND, MOVE IN DATA                          
*                                                                               
TESTMASK TM    0(R8),0             TEST UNDER MASK                              
COMPCHAR CLI   0(R8),0             COMPARE CHARACTER                            
*                                                                               
VALNAND  MVC   BYTE,0(R2)          SAVE OFF BYTE                                
         NC    BYTE,PARTEST        LEAVE ON ONLY BITS THAT APPLY                
         LA    R2,BYTE                                                          
         B     PARSE60             FOUND, MOVE IN DATA                          
         EJECT ,                                                                
***********************************************************************         
*        R8 = BRNBASE, pre-read 99's table of billing info            *         
***********************************************************************         
                                                                                
         USING PTAELD,R2                                                        
         USING BILLD,R8                                                         
GETBILT2 DS    0H                                                               
         ICM   R8,15,ACURBIL       Processed in R(SEEDREC)                      
         BZ    PARSE45             No bills to process                          
         CLI   SEEDMODE,SEEDPBIL                                                
         BNE   PARSE45                                                          
         B     GETBT20                                                          
*                                                                               
GETBILTY DS    0H                                                               
         L     R8,BILLTAB                                                       
*        TM    PTASTAT1,PTASPEND                                                
*        BO    PARSE45             Not good                                     
         CLC   PTARBLNO,SPACES                                                  
         BNH   PARSE45                                                          
         SR    R1,R1                                                            
         ICM   R1,3,#BILLS                                                      
         BZ    PARSE45                                                          
*                                                                               
GETBT10  CLC   BILL#,PTARBLNO      Match bill number                            
         BE    GETBT20                                                          
         LA    R8,BILLLNQ(,R8)                                                  
         BCT   R1,GETBT10                                                       
         DC    H'00'               Could not find bill from 99's                
*                                                                               
         USING BTYPED,R1                                                        
GETBT20  L     R1,ABTYPTAB                                                      
*                                                                               
GETBT22  CLI   0(R1),EOT                                                        
         BNE   *+6                                                              
         DC    H'00'               Should have found bill type                  
         CLC   BILLTY,BTYPNUM      Match on bill type tran number               
         BE    GETBT30                                                          
         LA    R1,BTYPLNQ(,R1)                                                  
         B     GETBT22                                                          
*                                                                               
GETBT30  LA    R2,BTYPNUM                                                       
         B     PARSE60             Found good data                              
         DROP  R1,R2                                                            
         EJECT ,                                                                
*=====================================================================*         
*       Get File maintance rate                                       *         
*=====================================================================*         
GTFRATE  GOTO1 =A(GETFRATE)                                                     
         BNE   PARSE50                                                          
         B     PARSE60             R2 Passed back from routine                  
         EJECT ,                                                                
***********************************************************************         
*  GET PLANNING OR REVISION NUMBER TABLE ELEMENT                      *         
***********************************************************************         
         SPACE 1                                                                
         USING ROWD,R2             ROW   ELEMENT                                
         USING PRNEND,R6                                                        
GETPRNEN L     R2,ACURROW          ->    CURRENT   ROW                          
         ZIC   R6,ROWPRNE#         GET   ROW  PRNENTBL  ENTRY     NUM           
         BCTR  R6,0                MINUS ONE                                    
         MHI   R6,PRNENLNQ         TIMES ELEMENT   LENGTH                       
         A     R6,PRNENTBL         ->    PLANNING/REV   NUM  ENT  TABLE         
         LA    R2,PRNDATA                                                       
         AH    R2,PARDSPEL         ->    DATA                                   
         B     PARSE60             GOOD  RETURN                                 
         DROP  R2,R6                                                            
         EJECT ,                                                                
***********************************************************************         
*                                                                               
***********************************************************************         
VALBALT  GOTO1 =A(VBALSJ)                                                       
         BNE   PARSE50                                                          
         B     PARSE60             R2 Passed back from routine                  
         EJECT ,                                                                
***********************************************************************         
* Get timesheet hours                                                           
***********************************************************************         
         SPACE 1                                                                
GETTHRS  GOTO1 =A(GTHRS)                                                        
         BNE   PARSE50                                                          
         B     PARSE60             R2 Passed back from routine                  
         EJECT ,                                                                
***********************************************************************         
* Get expenditure type name                                                     
***********************************************************************         
         SPACE 1                                                                
GETETYPN GOTO1 =A(GTETYN),DMCB,(R3),(R7)                                        
         BNE   PARSE99                                                          
         B     PARSE60             R2 Passed back from routine                  
         EJECT ,                                                                
***********************************************************************         
* Get Day name                                                                  
***********************************************************************         
         SPACE 1                                                                
GETDAYNM OC    CURPDTE,CURPDTE     DAILY DATE KEYWORD?                          
         BZ    PARSE99                                                          
         GOTO1 DATCON,DMCB,(1,CURPDTE),(0,WORK)                                 
         GOTO1 GETDAY,DMCB,WORK,WORK+6                                          
         LA    R2,WORK+6                                                        
         B     PARSE60                                                          
         EJECT ,                                                                
***********************************************************************         
* Get Estimate (local) number                                                   
***********************************************************************         
         SPACE 1                                                                
GETESNUM CLC   PARTEST,0(R8)                                                    
         BNE   PARSE45                                                          
*                                                                               
         GOTO1 =A(GTESTN),DMCB,(0,(R2))                                         
         BNE   PARSE45                                                          
         B     PARSE60             R2 Passed back from routine                  
         EJECT ,                                                                
***********************************************************************         
* Get Estimate status                                                           
***********************************************************************         
         SPACE 1                                                                
GETESTAT CLC   PARTEST,0(R8)                                                    
         BNE   PARSE45                                                          
*                                                                               
         GOTO1 =A(GTESTN),DMCB,(1,(R2))                                         
         BNE   PARSE99                                                          
         B     PARSE60             R2 Passed back from routine                  
         EJECT ,                                                                
***********************************************************************         
* Translate Estimate status bytes                                               
***********************************************************************         
         SPACE 1                                                                
TRNESTAS GOTO1 =A(GTESTN),DMCB,(2,(R2))                                         
         BNE   PARSE99                                                          
         B     PARSE60             R2 Passed back from routine                  
         EJECT ,                                                                
*&&UK                                                                           
***********************************************************************         
* Get Estimate extra data                                                       
***********************************************************************         
         SPACE 1                                                                
GETEXDAT OC    CURLCNO,CURLCNO                                                  
         BZ    PARSE45                                                          
*                                                                               
         GOTO1 =A(GTEXDA),DMCB,(R7)                                             
         BNE   PARSE99                                                          
         B     PARSE60             R2 Passed back from routine                  
         EJECT ,                                                                
*&&                                                                             
***********************************************************************         
* Extra Estimate filtering                                                      
***********************************************************************         
         SPACE 1                                                                
XESTFLT  CLC   PARTEST,0(R8)                                                    
         BNE   PARSE45                                                          
                                                                                
         GOTO1 =A(GTESTN),DMCB,(3,(R2))                                         
         BNE   PARSE99                                                          
         B     PARSE60             R2 Passed back from routine                  
         EJECT ,                                                                
*&&UK                                                                           
***********************************************************************         
* Get Estimate name                                                             
***********************************************************************         
         SPACE 1                                                                
GETESNAM GOTO1 =A(GTENAM),DMCB,(R2),(R7)                                        
         BNE   PARSE99                                                          
         B     PARSE60             R2 Passed back from routine                  
         EJECT ,                                                                
***********************************************************************         
* Get Estimate currency name                                                    
***********************************************************************         
         SPACE 1                                                                
GETESCUN GOTO1 =A(GTESCN),DMCB,(R2),(R7)                                        
         BNE   PARSE99                                                          
         B     PARSE60             R2 Passed back from routine                  
         EJECT ,                                                                
***********************************************************************         
* Get Creditor payment method                                                   
***********************************************************************         
         SPACE 1                                                                
GETCRPMT GOTO1 =A(GTCRPM),DMCB,(R2),(R7)                                        
         BNE   PARSE99                                                          
         B     PARSE60             R2 Passed back from routine                  
         EJECT ,                                                                
***********************************************************************         
* Get BrandOcean Invoice status                                                 
***********************************************************************         
         SPACE 1                                                                
GETINVST GOTO1 =A(GTINVS),DMCB,(R2),(R7)                                        
         BNE   PARSE99                                                          
         B     PARSE60             R2 Passed back from routine                  
         EJECT ,                                                                
                                                                                
***********************************************************************         
* Get Tx type mapping to a column                                               
***********************************************************************         
         SPACE 1                                                                
GETTYMP  GOTO1 =A(GTYMP),DMCB,(R2),(R5),(R7)                                    
         BNE   PARSE99                                                          
         B     PARSE60             R2 Passed back from routine                  
         EJECT ,                                                                
                                                                                
***********************************************************************         
*  CURRENCY VALIDATION ON TRANSACTION                                 *         
***********************************************************************         
         SPACE 1                                                                
VALTXCUR CLC   CURFCCDE,SPACES     ANY CURRENCY CODE                            
         BNH   PARSE45             NO - GET NEXT                                
         CLC   CURFCCDE,RCCURR     TEST AGENCY CURRENCY CODE                    
         BE    PARSE45             Yes - GET NEXT                               
         B     PARSE60             GOOD  RETURN                                 
         EJECT ,                                                                
                                                                                
***********************************************************************         
*  CURRENCY/ VALIDATION ON TRANSACTION                                          
***********************************************************************         
         SPACE 1                                                                
VALCURTF CLC   CURFCCDE,SPACES     ANY CURRENCY CODE                            
         BNH   PARSE45             NO - GET NEXT                                
         CLC   CURFCCDE,RCCURR     TEST AGENCY CURRENCY CODE                    
         BE    PARSE45             Yes - GET NEXT                               
         B     VALTRNFR            GOTO TO TRANSFER VALIDATION                  
                                                                                
***********************************************************************         
*  TRANSFER VALIDATION ON TRANSACTION                                 *         
***********************************************************************         
         SPACE 1                                                                
VALTRNFR CLI   REALTYP,TRNTMABL   MANUAL BILLING (TYPE = 6)                     
         BE    PARSE60            Yes - Passed back from routine                
         CLI   REALTYP,TRNTCLBL   CLIENT BILLING (TYPE = 7)                     
         BE    PARSE60                                                          
         CLI   REALTYP,TRNTMEBL   MEDIA BILLING  (TYPE = 9)                     
         BE    PARSE60                                                          
         CLI   REALTYP,TRNTCALC   CASH ALLOCATION (TYPE = 30)                   
         BNE   PARSE45            NO - GET NEXT                                 
*                                                                               
         USING RALELD,RF                                                        
         ICM   RF,15,AELEMD9      TEST RECEIVABLE ALLOACTION                    
         BZ    PARSE45            NO - GET NEXT                                 
         CLI   RALTYPE,RALTTTO    TEST TRANSFERRED TO                           
         BE    PARSE60            Yes - Passed back from routine                
         CLI   RALTYPE,RALTTFR    TEST TRANSFERRED FROM                         
         BE    PARSE60            Yes - Passed back from routine                
         B     PARSE45            ALL OTHER TYPES - GET NEXT                    
         DROP  RF                                                               
         EJECT ,                                                                
                                                                                
***********************************************************************         
*  GET SOURCE ACCOUNT FROM X'7B' FOR LEDGER SR                        *         
***********************************************************************         
         SPACE 1                                                                
GETSORA  GOTO1 =A(GSORA),DMCB,(R8)                                              
         BNE   PARSE45                                                          
         B     PARSE60             R2 Passed back from routine                  
         EJECT ,                                                                
                                                                                
***********************************************************************         
*  GET MEDIA BILLING GROUP FROM X'7B' FOR LEDGER SR                   *         
***********************************************************************         
         SPACE 1                                                                
GETBGM   DS    0H                                                               
         GOTO1 =A(GBGM),DMCB,(R8)                                               
         BNE   PARSE99                                                          
         B     PARSE60             R2 Passed back from routine                  
         EJECT ,                                                                
*                                                                               
***********************************************************************         
*  GET CATEGROY NAME FOR LEDGER SR (GRPMUK)                           *         
***********************************************************************         
         SPACE 1                                                                
         USING NAMELD,R8                                                        
GETCATN  CLI   NAMLN,NAMLN1Q+12                                                 
         BNE   PARSE60                                                          
         CLC   =C'INTERCOMPANY',NAMEREC                                         
         BNE   PARSE60             OK IF IT'S NOT 'INTERCOMPANY'                
         MVC   WORK,SPACES                                                      
         MVC   WORK(5),=C'INTER'   CHANGE IT TO 'INTER'                         
         MVI   PARNEWLN+1,5                                                     
         LA    R2,WORK                                                          
         B     PARSE60                                                          
         DROP  R8                                                               
         EJECT ,                                                                
                                                                                
***********************************************************************         
*  GET MEDIA BILLING GROUP FROM X'7B' FOR LEDGER SR                   *         
***********************************************************************         
         SPACE 1                                                                
GETTRSC  DS    0H                                                               
         GOTO1 =A(GTRSC),DMCB,(R8)                                              
         B     PARSE60             R2 Passed back from routine                  
         EJECT ,                                                                
*&&                                                                             
*&&US                                                                           
***********************************************************************         
*  GET REFERENCE FROM DB OR 44 ELEMENT                                *         
***********************************************************************         
         SPACE 1                                                                
         USING TRNRECD,RF                                                       
GETREFN  CLI   0(R8),FFTTKREF      KEY REFERENCE NUMBER FOR BANK VOID           
         BNE   PARSE45             NO, USE WHAT WE GOT                          
         L     RF,ADTRANS          YES, ANOTHER CHECK                           
         SHI   RF,ACCORFST         GET TO BEGINING OF KEY                       
         CLI   TRNKREF+3,C'*'      IF > 255 TRANSACTIONS?                       
         BE    PARSE60             YES, USE FFTTKREF                            
         XR    R1,R1               NO, USE REFERENCE FROM KEY                   
         IC    R1,2(R8)            LENGTH OF DATA                               
         AHI   R1,-1                                                            
         EX    R1,GETRFMV                                                       
         B     PARSE60                                                          
                                                                                
GETRFMV  MVC   3(0,R8),TRNKREF                                                  
         DROP  RF                                                               
         EJECT ,                                                                
                                                                                
*&&                                                                             
*&&UK                                                                           
***********************************************************************         
*  Test client code added last month (GRPMUK)                         *         
***********************************************************************         
         SPACE 1                                                                
         USING RSTELD,RF                                                        
VALCLAD  L     RF,ADHEIRA                                                       
         AH    RF,DATADISP         GET TO FIRST ELEMENT                         
         XR    R1,R1                                                            
VCLAD04  CLI   RSTEL,0                                                          
         BE    PARSE99             ELEMENT NO FOUND!!!                          
         CLI   RSTEL,RSTELQ        RECORD STATUS ELEMENT                        
         BE    *+14                                                             
         IC    R1,RSTLN                                                         
         AR    RF,R1                                                            
         B     VCLAD04                                                          
*                                                                               
         CLC   PRVMOA,RSTBDATE                                                  
         BNE   PARSE45                                                          
         B     PARSE60                                                          
         DROP  RF                                                               
         EJECT ,                                                                
*&&                                                                             
***********************************************************************         
         USING ROWD,R2                                                          
         USING MTHDD,R4                                                         
         USING RATED,R6                                                         
VALALO$  CLC   =C'1N',CURSUBAC+1                                                
         BE    PARSE50                                                          
         L     R2,ACURCOL                                                       
         CLI   PARELEM,1           OR ALLOCATED RATE                            
         BNE   VALAL$10                                                         
         L     R2,ACURROW          POINT TO ROW                                 
         L     R2,ROWACOL          THEN TO COLUMN THAT MADE THE ROW             
         DROP  R2                                                               
*                                                                               
         USING COLD,R2                                                          
VALAL$10 ST    R4,SVR4                                                          
         L     R4,MHDBASE                                                       
         LH    R1,CSTMTHDS                                                      
         ZAP   DUB,PKZERO          CLEAR INCASE WE EXIT                         
         ICM   R6,15,RATEPTR       LAST RATE POSTED TO                          
         BZ    VALAL$80                                                         
*                                                                               
         CLC   COLMTHD,MTHDNUM     MATCH ON METHOD FOR COLUMN                   
         BE    *+14                                                             
         LA    R4,MTHDLNQ(,R4)                                                  
         BCT   R1,*-14                                                          
         DC    H'00'                                                            
*                                                                               
         LA    R1,1                MONTHLY ALLOCATION, POSTED ONCE              
         CLI   PARELEM,1           OR ALLOCATED RATE                            
         BE    VALAL$20                                                         
         TM    MTHDIND,MTHDYTD                                                  
         BZ    *+8                                                              
         LH    R1,RATEMTH          # OF MONTHS THIS COVERS                      
*                                                                               
VALAL$20 CLC   RATEMOA,COLSTART                                                 
         BL    VALAL$25                                                         
         CLC   RATEMOA,COLEND                                                   
         BH    VALAL$80                                                         
*                                                                               
         CLC   RATEMOA,RMOASTR     ONLY POST WITH IN REQUESTED MOA              
         BL    VALAL$25                                                         
         CLC   RATEMOA,RMOAEND                                                  
         BH    VALAL$80                                                         
*                                                                               
         TM    POSTCTL,POSTALO$    POST ALLOCATED $ BY MONTH                    
         BZ    VALAL$24                                                         
         CLC   RATEMOA,AL$MOA      POST ONLY UP TO AL$MOA                       
         BL    VALAL$25                                                         
         BH    VALAL$80                                                         
*                                                                               
VALAL$24 LR    RE,R6                                                            
         AH    RE,MTHDLOC          POINT TO RATE METHOD                         
         AH    RE,PARDSPEL         POINT TO ACCUM                               
         AP    DUB,0(L'RATEAMT$,RE)                                             
*                                                                               
VALAL$25 AH    R6,RATELEN          NEXT POSTED MONTH                            
         BCT   R1,VALAL$20                                                      
*                                                                               
VALAL$80 CLI   PARELEM,1           ALLOCATED RATE                               
         BE    VALAL$82            YES                                          
         SRP   DUB,62,5                                                         
*                                                                               
VALAL$82 LA    R2,DUB                                                           
         L     R4,SVR4                                                          
         B     PARSE60                                                          
         DROP  R2,R4,R6                                                         
         EJECT ,                                                                
***********************************************************************         
*  POST PAYROLL AMOUNT TO COLUMN                                      *         
***********************************************************************         
         SPACE 1                                                                
VALPAY$  ZAP   DUB,PKZERO                                                       
         ST    R4,SVR4                                                          
         OC    PAYBUK#,PAYBUK#                                                  
         JZ    VALPAY80                                                         
*                                                                               
VALPAY10 CLI   MODE,PROCACC        Account mode                                 
         JE    VALPAY18            Yes                                          
         CLI   MODE,ACCLAST        Account last mode                            
         JE    VALPAY18            Yes                                          
         CLI   MODE,PROCTRNS       Must be detail mode                          
         JE    *+8                 Yes                                          
         CLI   MODE,PROCTIME       Must be detail mode                          
         JNE   VALPAY80            No                                           
*&&DO                                                                           
         TM    POSTLVL,POSTSPLT    Split mode ?                                 
         JO    VALPAY18            Yes, don't check then                        
         TM    PHISIND,PHISMOA     MOA reporting                                
         JZ    VALPAY18            No, so ok as is                              
         CLC   P$TMOA,SAVEMOS                                                   
         JNE   VALPAY80            Process later                                
*&&                                                                             
         USING COLD,R4                                                          
         USING ROWD,RE                                                          
VALPAY18 L     R4,ACURCOL          Default to processing a column               
         CLI   PARCC,2             Are we processing a rate keyword ?           
         BNE   VALPAY20            No                                           
         L     RE,ACURROW          Rates are retrieved from rows                
         L     R4,ROWACOL          Point to column that created row             
         DROP  RE                                                               
                                                                                
VALPAY20 CLC   COLMTHD,0(R8)       Match on method                              
         BNE   VALPAY80            No                                           
         SR    RF,RF                                                            
         IC    RF,COLPAY#                                                       
         BCTR  RF,0                                                             
         MHI   RF,L'P$TAMT                                                      
         AR    R2,RF                                                            
         ZAP   DUB,0(L'P$TAMT,R2)                                               
         TM    COLOPT2,COLFCPRT    Copy down feature                            
         JO    VALPAY80            Yes                                          
         ZAP   0(L'P$TAMT,R2),PKZERO                                            
         J     VALPAY80                                                         
         DROP  R4                                                               
                                                                                
VALPAY80 LA    R2,DUB                                                           
         L     R4,SVR4                                                          
         B     PARSE60                                                          
         EJECT ,                                                                
***********************************************************************         
*        Get name of contractor                                       *         
***********************************************************************         
         SPACE 1                                                                
GETCONTR MVC   IOKEY2,SPACES                                                    
         MVC   IOKEY2(1),CURACC            Company code                         
         MVC   IOKEY2+1(2),=C'S1S'         Contractor U/L+S (Spot)              
         MVC   IOKEY2+3(1),CURSUBAC+3      Media                                
         MVC   IOKEY2+4(L'CNTCONTR),0(R2)                                       
         BAS   RE,READREC                                                       
         BNE   PARSE99                                                          
*                                                                               
         USING NAMELD,R2                                                        
         L     R2,AIO2                                                          
         AH    R2,DATADISP                                                      
         SR    R1,R1                                                            
GETCTR10 CLI   0(R2),0             EOR                                          
         BE    PARSE99                                                          
         CLI   0(R2),NAMELQ        X'20' element                                
         BE    GETCTR20                                                         
         SR    RF,RF                                                            
         IC    RF,1(,R2)                                                        
         AR    R2,RF                                                            
         B     GETCTR10                                                         
*                                                                               
GETCTR20 IC    RF,1(,R2)           Length of name element                       
         STH   RF,PARNEWLN                                                      
         LA    R2,NAMEREC                                                       
         B     PARSE60                                                          
         SPACE 2                                                                
         LTORG                                                                  
         EJECT ,                                                                
***********************************************************************         
* Zone edit                                                                     
***********************************************************************         
         SPACE 1                                                                
ZONEDT   MVC   WORK,SPACES                                                      
         CLI   MODE,PROCSBAC                                                    
         JE    ZONEDT05                                                         
         CLI   MODE,PROCSBOF                                                    
         JE    ZONEDT05                                                         
         CLI   MODE,PROCTRNS                                                    
         JE    ZONEDT05                                                         
         CLC   CURACC+8(3),SPACES       IS IT A REP?                            
         JE    PARSE45                  YES, SO NO PUB DATA YET                 
         MVC   WORK(15),CURACC                                                  
         J     ZONEDT08                                                         
*                                                                               
ZONEDT05 CLC   CURSUBAC+1(11),SPACES    NO PUBLICATION                          
         JE    PARSE45                                                          
         MVC   WORK+4(11),CURSUBAC+1    WORK=C/U/L/MEDIA/PUB                    
*        CLC   CURACC+8(3),SPACES       IS IT A REP?                            
*        JE    *+10                     YES, SO USE CONTRA                      
*        MVC   WORK(15),CURACC          ELSE USE ACCOUNT                        
*                                                                               
ZONEDT08 CLI   CURACC+12,C'*'           THIS IS AN OFFICE NOT A ZONE            
         JNE   *+10                                                             
         MVC   WORK+12(2),SPACES        CLEAR OUT ZONE                          
         PACK  DUB(6),WORK+4(11)                                                
         MVC   DUB+5(1),WORK+14         MOVE IN EDITION CODE                    
         CLC   CURSUBAC+9(3),=C'ZZZ'    ALL ZONES AND EDITIONS?                 
         JNE   ZONEDT10                 NO                                      
         OC    DUB+4(2),=X'FFFF'   SET TO ALL ZONES AND EDITIONS                
*                                                                               
ZONEDT10 TM    PARELEM,X'03'       GET EDITION OR PUBLICATION?                  
         JNZ   ZONEDT20                                                         
         CLI   DUB+4,0             IS THERE A ZONE?                             
         JE    PARSE90             NO ZONE                                      
         MVC   WORK+20(2),WORK+12  MOVE IN ZONE                                 
         CLI   DUB+4,X'FF'         ALL ZONES?                                   
         JNE   *+10                                                             
*                                                                               
ZONEDT15 MVC   WORK+20(3),=C'ALL'                                               
         LA    R2,WORK+20                                                       
         J     PARSE60                                                          
*                                                                               
ZONEDT20 SR    RF,RF                                                            
         TM    PARELEM,X'80'       GET EDITION DESCRIPTION                      
         JZ    *+8                                                              
         LA    RF,C'E'                                                          
         GOTOR =V(PUBEDIT),DMCB,(8,DUB),((RF),WORK+20)                          
         LA    R2,WORK+20                                                       
         TM    PARELEM,X'80'       GET EDITION DESCRIPTION                      
         JO    PARSE60                                                          
         TM    PARELEM,X'02'       GET PUBLICATION CODE?                        
         JO    PARSE60                                                          
         CLI   DUB+5,X'FF'         IF X'FF' THEN ALL EDITIONS                   
         JE    ZONEDT15                                                         
         CLI   WORK+30,C','        RE = 1ST COMMA OF 1-234-5678,ZZZ,EEE         
         JNE   PARSE90             NO EDITION FOUND                             
         LA    R2,WORK+31          POINT TO ZONE OR EDITION                     
         CLI   DUB+4,0             WAS THERE A ZONE?                            
         JE    PARSE60             NO SO MUST BE 1-234-5678,EEE FORM            
         LA    RF,4                                                             
         CLI   0(R2),C','                                                       
         JE    ZONEDT30                                                         
         LA    R2,1(,R2)           LOOK FOR COMMA BEFORE EDITION                
         BRCT  RF,*-12                                                          
         J     PARSE90             NO EDITION, HUMM?                            
*                                                                               
ZONEDT30 LA    R2,1(,R2)           POINT PAST COMMA                             
         J     PARSE60                                                          
         EJECT ,                                                                
***********************************************************************         
*  MISSING TIME SHEETS and others                                     *         
***********************************************************************         
         SPACE 1                                                                
         USING COLD,R2                                                          
COLDAMT  L     R2,ACURCOL                                                       
         LR    RE,R2                                                            
         AH    RE,PARDSPEL         Point to amount stored in COLD DSECT         
         SR    RF,RF                                                            
         ICM   RF,3,PARFRLEN       Get length from                              
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         ZAP   DUB,0(0,RE)                                                      
*                                                                               
         TM    COLOPT2,COLFCPRT    Option to make it a constant                 
         BO    COLDAMT8            Yes                                          
         SLL   RF,4                No so clear for length in RF                 
         EX    RF,*+8                                                           
         B     *+10                                                             
         ZAP   0(4,RE),PKZERO      Clear, only once per person                  
*                                                                               
COLDAMT8 LA    R2,DUB                                                           
         LA    RF,L'DUB                                                         
         STH   RF,PARNEWLN                                                      
         B     PARSE60                                                          
         DROP  R2                                                               
***********************************************************************         
*  ON-LINE MEMO                                                       *         
***********************************************************************         
         SPACE 1                                                                
OMEMACC  LA    R1,R2*16            R1 = '00000020' FOR R2 LOAD                  
         MVC   LOAD+2(2),PARBASE   "S" TYPE (BASE+DISP)                         
         EX    R1,LOAD             R2 IS NOW SET                                
         AHI   R2,ACTKEY-ACTRECD   POINT TO ACCOUNT                             
         B     PARSE60                                                          
         EJECT ,                                                                
***********************************************************************         
*  TYPE OF TIME                                                       *         
***********************************************************************         
         SPACE 1                                                                
VALTTYC  MVI   BYTE,0                                                           
         TM    0(R2),TIMIADJ       ADJUSTED TIME                                
         BZ    *+8                                                              
         MVI   BYTE,TRSSTADJ       ADJUSTED                                     
         TM    0(R2),TIMIWO        WRITE OFF ITEM                               
         BZ    *+8                                                              
         MVI   BYTE,X'02'          WRITE OFF                                    
         LA    R2,BYTE                                                          
         B     PARSE60                                                          
*                                                                               
VALTIMC  MVI   BYTE,0                                                           
*&&US                                                                           
         CLI   0(R2),TIMTCB        CLIENT BILLIABLE                             
         BNE   *+8                                                              
         MVI   BYTE,PRTSBILQ                                                    
         CLI   0(R2),TIMTCR        CLIENT REALIZATION                           
         BNE   *+8                                                              
         MVI   BYTE,PRTSRTEQ                                                    
         CLC   =C'1N',CURSUBAC+1                                                
         BE    *+8                                                              
         CLI   0(R2),TIMTCN        CLIENT NON-BILLIABLE                         
         BNE   *+8                                                              
         MVI   BYTE,PRTSNOTQ                                                    
*&&                                                                             
         LA    R2,BYTE                                                          
         B     PARSE60                                                          
         EJECT ,                                                                
         USING COLD,R8                                                          
VALPCT   L     R8,ACURCOL                                                       
         ZAP   ANSWER,PKZERO                                                    
         SR    RF,RF                                                            
         ICM   RF,3,COLDD#         Keyword ID #                                 
         TM    THRSW,THRLST        Process at ACCLAST                           
         BZ    VALPCT15            No                                           
*                                                                               
         ZAP   ANSWER,PKONE                                                     
         CHI   RF,AC#RSTHR                                                      
         BE    VALPCT90                                                         
         CHI   RF,AC#RSTHC                                                      
         BE    VALPCT08                                                         
         CLI   MODE,PROCACC        No detail hours at PROCACC                   
         BNE   VALPCT06                                                         
         TM    COLIND1,COLPADJ$                                                 
         BZ    VALPCT90                                                         
         ZAP   ANSWER,COLPROLL                                                  
         B     VALPCT90                                                         
                                                                                
VALPCT06 ZAP   ANSWER,0(L'TIMHRS,R2)   Get the hours                            
         CHI   RF,AC#RSPCT             hours / total hours                      
         BE    VALPCT90                                                         
         CHI   RF,AC#RSMWR                                                      
         BE    VALPCT90                                                         
         TM    COLIND1,COLPADJ$    Payroll adjusted amount ?                    
         BO    PARSE45               Yes                                        
                                                                                
VALPCT08 CLC   =C'1N',CURSUBAC+1   PCTCLI OR THRCLI, ONLY 1C IS VALID           
         BNE   VALPCT90                                                         
         ZAP   ANSWER,PKZERO       CLEAR FOR CONTRA OF 1N                       
         B     VALPCT90                                                         
*                                                                               
VALPCT15 CLI   PARCC,1             PCT/MWR/PCTC or THR/THC ?                    
         BNH   VALPCT20            PCT/MWR,PCTC                                 
         ZAP   ANSWER,COLTOTHR     Total time                                   
         CLI   PARCC,2             Keyword THR or THC ?                         
         BE    VALPCT90            THR                                          
         ZAP   ANSWER,COLTOT1C     Client time only (THC keyword)               
         B     VALPCT90                                                         
*                                                                               
VALPCT20 CLI   MODE,PROCACC                                                     
         BNE   VALPCT25                                                         
         TM    COLIND1,COLPADJ$    Payroll adjusted amount ?                    
         BZ    VALPCT25            No                                           
         ZAP   ANSWER,COLPROLL                                                  
         B     VALPCT90                                                         
                                                                                
VALPCT25 ZAP   OP2,COLTOTHR        Process PCT                                  
         CLI   PARCC,1             Time/total time ?                            
         BNE   VALPCT30            Yes                                          
         CLC   =C'1N',CURSUBAC+1                                                
         BE    VALPCT90                                                         
         ZAP   OP2,COLTOT1C        Client time/total time                       
*                                                                               
VALPCT30 CP    OP2,PKZERO          Don't divide by zero                         
         BE    VALPCT90                                                         
         ZAP   OP1,PKZERO                                                       
         TP    0(L'TIMHRS,R2)                                                   
         BNZ   *+10                Not valid packed                             
         ZAP   OP1,0(L'TIMHRS,R2)                                               
         SRP   OP1,6,0             Hrs X 10000 to adjust for 4 dec Pts.         
*                                  Hrs X and addition 100 for accuracy          
         DP    OP1,OP2+12(4)       Now divide                                   
         ZAP   ANSWER,OP1(12)                                                   
         TM    COLIND1,COLPADJ$    Payroll adjusted amount ?                    
         BZ    VALPCT60            No                                           
*                                                                               
VALPCT32 MP    ANSWER,COLPROLL                                                  
         SRP   ANSWER,58,5                                                      
         B     VALPCT90                                                         
                                                                                
VALPCT60 CLC   COLDD#,=AL2(AC#RSMWR)        Man Week Ratio                      
         BNE   VALPCT90                     Yes                                 
         OC    COLTPEDS,COLTPEDS   Was this set ?                               
         BZ    VALPCT90            No                                           
         CP    COLTPEDS,PKZERO                                                  
         BE    VALPCT90            Can't divide by zero                         
         ZAP   OP2,OP1(12)         PCT prior to shift adjust                    
         ZAP   OP1,COLTOACT        Total periods worked                         
         SRP   OP1,6,0             Shift to keep significance                   
         DP    OP1,COLTPEDS        Total periods possible                       
         MP    OP2,OP1+6(PKLEN)    PCT x MWR                                    
         SRP   OP2,56,5                                                         
         ZAP   ANSWER,OP2                                                       
*                                                                               
VALPCT90 LA    R2,ANSWER                                                        
         LA    RF,L'ANSWER                                                      
         STH   RF,PARNEWLN         Set to insure correct                        
         B     PARSE60                                                          
         EJECT ,                                                                
         USING ROWD,R8                                                          
VALWCNM  L     R8,ACURROW          CURRENT ROW PROCESSING                       
         TM    ROWOPT,ROWSHRT      SHORT WORKCODE?                              
         BZ    PARSE60             LONG WORKCODE DESCRIPTION                    
         LA    R2,WCSHORT                                                       
         LA    RF,L'WCSHORT                                                     
         STH   RF,PARNEWLN         SET NEW LENGTH OF FIELD                      
         B     PARSE60                                                          
         DROP  R8                                                               
         EJECT ,                                                                
VALCNUM  SR    RF,RF                                                            
         ICM   RF,3,PARFRLEN                                                    
         LR    RE,R2                                                            
VALCNUM3 CLI   0(R2),C'0'                                                       
         BL    PARSE45             NOT A NUMBER                                 
         LA    RE,1(,RE)                                                        
         BCT   RF,VALCNUM3                                                      
         B     PARSE60                                                          
         EJECT ,                                                                
         USING TRNELD,R2                                                        
ADDVAT   ZAP   DUB,TRNBLVT1                                                     
         AP    DUB,TRNBLVT2                                                     
         AP    DUB,TRNBLVT3                                                     
         AP    DUB,TRNBLVT4                                                     
         AP    DUB,TRNBLVT5                                                     
         CP    DUB,PKZERO                                                       
         BE    PARSE45             SEE IF IN X'50' ELEMENTS                     
         LA    R2,DUB                                                           
         B     PARSE60                                                          
         EJECT ,                                                                
***********************************************************************         
*  VALIDATE AND CONVERT WRITE-OFFS FOR PROD X'77'                     *         
***********************************************************************         
         USING PTAELD,R8                                                        
VALWROF  TM    PTASTAT1,PTASPEND   CAN'T BE PENDING                             
         BO    PARSE45             NEXT                                         
         MVC   WORK(2),=C'WO'                                                   
         CLI   PTATYPE,PTATWOF     WRITE OFF                                    
         BE    VALWROF2                                                         
         MVC   WORK(2),=C'WR'                                                   
         CLI   PTATYPE,PTATWOFR    WRITE OFF RECOVERY                           
         BNE   PARSE45             NOT FOUND                                    
VALWROF2 CLC   PTAWREF(2),WORK                                                  
         BNE   VALWROF4                                                         
         MVC   WORK(L'PTAWREF),PTAWREF                                          
         LA    R2,WORK                                                          
         B     PARSE60                                                          
*                                                                               
VALWROF4 MVC   HALF,0(R2)                                                       
         LH    RF,HALF                                                          
         LPR   RF,RF                                                            
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  WORK+2(4),DUB                                                    
         LA    R2,WORK                                                          
         B     PARSE60                                                          
         DROP  R8                                                               
         EJECT ,                                                                
***********************************************************************         
*  VALIDATE COMMISSIONABLE                                            *         
***********************************************************************         
         SPACE 1                                                                
         USING PTAELD,R8                                                        
VALCOMM  TM    PTASTAT1,PTASPEND   CAN'T BE PENDING                             
         BO    PARSE45             NEXT                                         
         TM    CURSTAT,CURNONC                                                  
         BO    PARSE45             NOT COMMISSIONABLE, SO SKIP                  
         B     PARSE60             THIS ONE OK                                  
         DROP  R8                                                               
         EJECT ,                                                                
***********************************************************************         
*  EXCLUDE UNIT/LEDGER IF XCULFLAG = YES                              *         
***********************************************************************         
         SPACE 1                                                                
CNTRFIX  DS    0H                                                               
*                                                                               
* Removed Sep19/2005. Contra seems okay to me. So why this code ?               
*                                                                               
*        CLI   QPROG,PRODUCTION    IS THIS PRODUCTION CONTRA ?                  
*        BNE   CNTRFIX2                                                         
*        CLI   REALTYP,12          IF TYPE 12  THEN                             
*        BE    PARSE45             CONTRA  NOT OK FOR SJ                        
*                                                                               
CNTRFIX2 CLI   QPROG,INCOME        IS THIS INCOME     CONTRA ?                  
         BNE   PARSE60             NO, SO OK AS IS                              
         CLI   XCULFLAG,NO         WAS KEYWORD GRS$ OR REV$ USED ?              
         BE    PARSE60             NO, SO OK AS IS                              
         AHI   R2,2                CHANGE DISPLACEMENT BY TWO                   
         SR    RE,RE                                                            
         ICM   RE,3,PARTOLEN       OVER-RIDE LENGTH                             
         AHI   RE,-2               LESS BY TWO                                  
         STH   RE,PARNEWLN         NEW PARSE TO LENGTH OVERRIDE                 
         B     PARSE60             OK NOW                                       
         EJECT ,                                                                
***********************************************************************         
*  GET HIGHEST LEVEL OF SR CODE WHERE AN ADDRESS PRESIDES             *         
*      INORDER TO READ ACCOUNT LATER AND RETRIEVE ADDRESS             *         
***********************************************************************         
         SPACE 1                                                                
VALADDR  DS    0H                                                               
*&&US                                                                           
         USING ROWD,RF                                                          
         L     RF,ACURROW                                                       
         TM    ROWDAIND,ROWBDR     Using BDR attribtute instead of ADR?         
         BO    VADDR10                                                          
*&&                                                                             
         LA    R1,R8*16            R1 = '00000080' FOR R8 LOAD                  
         MVC   LOAD+2(2),PARDSPTT  LOAD SPECIAL TEST DATA AREA                  
         EX    R1,LOAD                                                          
         LTR   R8,R8                                                            
         BZ    PARSE50             NO DATA TRY NEXT PARSE ENTRY                 
         B     PARSE60             DATA FOUND, PARSE OUT DATA NOW               
*&&US                                                                           
         DROP  RF                                                               
VADDR10  LA    R1,R8*16            R1 = '00000080' FOR R8 LOAD                  
         MVC   LOAD+2(2),PARBASE   LOAD SPECIAL TEST DATA AREA                  
         EX    R1,LOAD                                                          
         AH    R8,DATADISP                                                      
*                                                                               
         USING OATELD,R8                                                        
         SR    R0,R0                                                            
VADDR20  CLI   OATEL,0             No address found try next parse ntry         
         BE    PARSE50                                                          
         CLI   OATEL,OATELQ        8C address element                           
         BE    PARSE60             Data found, parse out data now               
         IC    R0,OATLN                                                         
         AR    R8,R0                                                            
         B     VADDR20                                                          
*&&                                                                             
         EJECT ,                                                                
***********************************************************************         
*  AGEING COLUMN DATA, REVERSE SIGN OF A CREDIT TYPE AMOUNT           *         
***********************************************************************         
         SPACE 1                                                                
AGEFC$2  LA    RF,CURFCAGE         FOREIGN CURRENCY AGEING                      
         B     *+8                                                              
AGEPAY$  LA    RF,TRNSAGE          REGULAR AGEING                               
         TM    0(R8),TRNSDR        IS IT A DEBIT?                               
         BO    PARSE90             DON'T WANT                                   
         SH    R2,DATADISP         POINT TO BEGINING OF KEY                     
         OC    ACCOUSED(2,R2),ACCOUSED(R2)                                      
         BNZ   PARSE90             DON'T WANT                                   
         ZAP   0(PKLEN,R4),0(8,RF)                                              
         B     PARSE90                                                          
*                                                                               
AGEFC$1  ZAP   0(PKLEN,R4),CURFCAGE                                             
         B     AGEAMNT+6                                                        
*                                                                               
AGEAMNT  ZAP   0(PKLEN,R4),TRNSAGE                                              
         SR    R1,R1                                                            
         IC    R1,BRNCHSGN                                                      
         TM    0(R8),TRNSDR        IS IT A DEBIT?                               
         EX    R1,*+8                                                           
         B     *+8                                                              
         BC    0,AGE10             YES, SO BRANCH ACCORDINGLY                   
*                                                                               
* DR if payables                                                                
* CR if recievables                                                             
*                                                                               
         GOTO1 PARSE,DMCB,GETXCRD,XCRDTE,0,0                                    
         B     AGE20                                                            
*                                                                               
AGE10    EQU   *                                                                
*                                                                               
* CR if payables                                                                
* DR if recievables                                                             
*                                                                               
*&&US*&& CLI   QPROG,PAYABLES      PAYABLES ONLY                                
*&&US*&& BNE   PARSE90             CHECK FOR OFFSET                             
         GOTO1 PARSE,DMCB,GETXDRD,XCRDTE,0,0                                    
         BNE   PARSE90                                                          
*                                                                               
AGE20    CLC   ENDATE,XCRDTE                                                    
         BNL   PARSE90                                                          
         ZAP   0(PKLEN,R4),PKZERO  DON'T INCLUDE THIS CREDIT                    
         B     PARSE90                                                          
         EJECT ,                                                                
MMOSBRD  CLI   CURACC+3,C'N'       IF NETWORK                                   
         BE    MMOSPAY                                                          
         MVI   BROADFG,YES                                                      
         B     *+8                                                              
MMOSPAY  MVI   BROADFG,NO                                                       
         MVC   WORK(L'XPYPER),0(R2)                                             
         LA    R2,WORK                                                          
         CLI   WORK+6,BLANK                                                     
         BNH   *+8                                                              
         LA    R2,WORK+6                                                        
         CLI   WORK+6,C'-'                                                      
         BNE   *+8                                                              
         LA    R2,WORK+7                                                        
         CLI   BROADFG,YES                                                      
         BNE   PARSE60                                                          
         GOTO1 =V(GETBROAD),DMCB,(1,(R2)),DTE1,GETDAY,ADDAY                     
         LA    R2,DTE2                                                          
         B     PARSE60                                                          
         EJECT ,                                                                
***********************************************************************         
*  CONVERT YYMM TO YYMMDD SO DATCON WORKS                             *         
***********************************************************************         
         SPACE 1                                                                
         USING TRNELD,R2                                                        
DATEFIX  OC    0(2,R2),0(R2)       IS THERE A DATE?                             
         BZ    PARSE45             NO DATE FOUND                                
         CLC   0(2,R2),SPACES      IS THERE A DATE?                             
         BZ    PARSE45             NO DATE FOUND                                
         MVC   FIXDATE(2),0(R2)    MOVE YYMM TO NEW DATE LOCATION               
         TM    FIXDATE,X'F0'       IS IT A SCREWED UP MOS                       
         BNO   DATEFIX2            NO                                           
         L     R2,ADTRANS                                                       
         MVC   SAVEMOS,TRNMOS            SAVE TRANSACTION BATCH                 
         MVC   TRNMOS,FIXDATE            PUT IN MOS TO CALCULATE                
         GOTO1 =V(CONVMOS),DMCB,(X'FE',(R2)),FIXDATE                            
         MVC   TRNMOS,SAVEMOS            RESTORE ORIGINAL BATCH                 
DATEFIX2 LA    R2,FIXDATE                                                       
         B     PARSE60             CONTINUE PARSEING                            
         DROP  R2                                                               
         EJECT ,                                                                
***********************************************************************         
*  GET COLUMN HEADING 1 AND STICK IN COLUMN                           *         
***********************************************************************         
         SPACE 1                                                                
         USING ROWD,R2                                                          
GETHEAD1 L     R2,ACURROW                                                       
         ICM   R8,15,ROWPRFX       NO DATA                                      
         BZ    PARSE45                                                          
         ZIC   R1,0(,R8)           GET FULL LENGTH OF FIELD                     
         SRL   R1,1                DIVIDE BY TWO FOR LENGTH OF DATA             
         LA    R2,1(,R8)           POINT TO DATA                                
         STH   R1,PARNEWLN                                                      
         B     PARSE60                                                          
         DROP  R2                                                               
         EJECT ,                                                                
***********************************************************************         
*  GETS HARD CODE NAME OF EST USER FIELD (AOR)                        *         
***********************************************************************         
         SPACE 1                                                                
         USING BRANDD,R6                                                        
GETAORN  MVI   BYTE,YES            NAME?                                        
         B     *+8                                                              
GETAORC  MVI   BYTE,NO             CODE?                                        
         GOTO1 =A(GAOR)                                                         
         BH    PARSE99                                                          
         BL    PARSE45                                                          
         B     PARSE60                                                          
         SPACE 1                                                                
***********************************************************************         
PAPPEND  LA    R0,PARWORK                                                       
         LHI   R1,PARWORKL                                                      
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         ICM   RF,8,SPACES                                                      
         MVCL  R0,RE                                                            
         L     R6,PARADDR          List of keywords parse entries               
         SR    R0,R0                                                            
         ICM   R0,1,PARELEM        Number of entries in list                    
         BNZ   *+6                                                              
         DC    H'00'               Entry setup wrong                            
                                                                                
NEW      USING PARSED,R8                                                        
         LA    R2,PARWORK                                                       
PAPPEND2 L     R8,0(,R6)           Load new parse entry                         
         GOTO1 PARSE,DMCB,(R8),(R2),0,0                                         
         XR    RF,RF                                                            
         ICM   RF,3,NEW.PARTOLEN                                                
         AR    R2,RF               Length of data                               
         AHI   R6,4                Length of an address                         
         BCT   R0,PAPPEND2                                                      
         LA    R2,PARWORK                                                       
         B     PARSE60                                                          
         DROP  NEW                                                              
*&&DO                                                                           
COMBDATA GOTO1 PARSE,DMCB,PARADDR,WORK,0,0                                      
         L     R2,ADTRANS                                                       
         AH    R2,PARDSPEL         POINT TO REF# OR NARR                        
         SR    RF,RF                                                            
         ICM   RF,3,PARFRLEN                                                    
         BCTR  RF,0                ONE FOR 1ST PARSE ENTRY                      
         BCTR  RF,0                ONE FOR EX  INSTR.                           
         EX    RF,*+8                                                           
         B     *+10                WORK=CURBILTY(1)/NARR(15)  OR                
         MVC   WORK+1(0),0(R2)     WORK=MEDIA(1)   /REF#(6)                     
         LA    R2,WORK                                                          
         B     PARSE60                                                          
*&&                                                                             
         EJECT ,                                                                
GETFCNME GOTO1 GETFCUR                                                          
         LA    R2,CURFCCDE+8                                                    
         B     PARSE60                                                          
         EJECT ,                                                                
GETSTUDO GOTO1 PARSE,DMCB,PARADDR,WORK,0,0                                      
         L     R8,STUBASE          TABLE OF STUDIO NAMES                        
GETSTU10 CLI   0(R8),EOT           END OF TABLE                                 
         BE    PARSE99                                                          
         LA    R2,4(,R8)           POINT TO POSSIBLE NAME                       
         CLC   WORK(4),0(R8)                                                    
         BE    PARSE60                                                          
         LA    R8,40(,R8)          BUMP UP IN TABLE                             
         B     GETSTU10                                                         
         EJECT ,                                                                
***********************************************************************         
*  CHECK NARRATIVE FOR INFORMATION                                    *         
***********************************************************************         
         SPACE 1                                                                
GETNARA  GOTO1 =A(GTNARA),DMCB,(R7),(R8),(R3)                                   
         BNE   PARSE50                                                          
         B     PARSE60             R2 Passed back from routine                  
         EJECT ,                                                                
***********************************************************************         
*  GET DATA FROM NARRATIVE                                            *         
***********************************************************************         
         SPACE 1                                                                
NARDATA  TM    0(R8),TRNSDR        IS IT A DEBIT?                               
         BO    PARSE50             YES, SO GET OUT                              
*                                                                               
NARDAT05 SH    R8,PARDSPTT         BACKOUT PREVOUS DISPLACEMENT                 
         SR    RE,RE                                                            
         IC    RE,1(,R8)           GET TRANS. ELEMENT LENGTH                    
         AR    RE,R8               POINT TO END OF ELEMENT                      
         AHI   R8,(TRNNARR-TRNELD) POINT TO NARATIVE FIELD                      
         L     R6,NARBASE                                                       
         SR    R1,R1                                                            
         IC    R1,PARCC                                                         
         MHI   R1,NARLNQ2                                                       
         AR    R6,R1               POINT TO IDENIFYING STRING                   
         SR    R1,R1                                                            
         IC    R1,0(,R6)           LEN OF IDENIFYING STRING TO COMPARE          
         BCTR  R1,0                                                             
         SR    RE,R1               POINT TO END OF SCAN POINT                   
NARDAT08 EXCLC R1,0(R8),1(R6)                                                   
         BE    NARDAT09                                                         
         LA    R8,1(,R8)           BUMP BY ONE                                  
         CR    R8,RE               HAVE WE REACHED END OF SCAN POINT?           
         BNL   PARSE50             NOT TRY ANOTHER METHOD                       
         B     NARDAT08            LOOP                                         
*                                                                               
NARDAT09 AR    RE,R1               BUMP BACK TO END OF TRANSACTION              
         AHI   R6,NARLNQ1          BUMP UP TO SCAN STRING IN NARRTBL            
         CLI   0(R6),0             SEE IF WE NEED TO SCAN ANOTHER?              
         BE    NARDAT90            NO, GET DATA                                 
         IC    R1,0(,R6)           GET SCAN STRING LENGTH                       
         BCTR  R1,0                                                             
         SR    RE,R1               SCANNING END POINT                           
         LA    R8,2(R8,R1)         BUMP PAST IDENIFYING STRING                  
*                                                                               
NARDAT10 EXCLC R1,0(R8),1(R6)                                                   
         BE    NARDAT90            FOUND DATA SO GET DATA                       
         LA    R8,1(,R8)           BUMP UP ONE TO SCAN AGAIN                    
         CR    R8,RE               HAVE WE REACH END OF NARR                    
         BNL   PARSE50             NO DATA HERE                                 
         B     NARDAT10            LOOP TO SCAN                                 
*                                                                               
NARDAT90 LA    R2,2(R8,R1)         POINT R2 TO PARSE DATA                       
         B     PARSE60                                                          
         EJECT ,                                                                
***********************************************************************         
*  GET NUM2 FROM SJ TABLE                                             *         
***********************************************************************         
         SPACE 1                                                                
         USING SJINFO,R6                                                        
GETNUM2  BAS   RE,GETSJPRD                                                      
         BNE   PARSE45             NOT FOUND                                    
         L     R6,ASJBUF1          POINT TO FOUND RECORD                        
         LA    R2,SJNUM2           POINT TO NUM2                                
         B     PARSE60                                                          
         DROP  R6                                                               
         EJECT ,                                                                
***********************************************************************         
*  GET SJ ACCOUNT EQUIVALENTS FROM SJ TABLE                           *         
***********************************************************************         
         USING PARSED,R3                                                        
         USING SJINFO,R6                                                        
SJACEQU  BAS   RE,GETSJPRD         Get cli/prod                                 
         BNE   SJAC020             Not found                                    
*                                                                               
SJAC010  L     R6,ASJBUF1          Point to found record                        
         LA    R2,SJAE_A           Account equivalent section                   
         SR    R0,R0                                                            
         ICM   R0,3,PARDSPEL                                                    
         AR    R2,R0                                                            
         CLC   0(L'SJAE_A/2,R2),SPACES     Is there one supplied ?              
         BH    PARSE60                     Yes                                  
*                                                                               
SJAC020  BAS   RE,GETSJCLI         No, check client level                       
         BNE   PARSE45                                                          
         L     R6,ASJBUF1          Point to found record                        
         LA    R2,SJAE_A           Account equivalent section                   
         SR    R0,R0                                                            
         ICM   R0,3,PARDSPEL                                                    
         AR    R2,R0                                                            
         CLC   0(L'SJAE_A/2,R2),SPACES     Is there one supplied ?              
         BNH   PARSE45                     No                                   
         B     PARSE60                     Yes                                  
         DROP  R6                                                               
         EJECT ,                                                                
***********************************************************************         
*  GET SJ CLIENT BILLING GROUP FROM SJ TABLE                          *         
***********************************************************************         
                                                                                
         USING SJINFO,R6                                                        
GETGRUP  BAS   RE,GETSJCLI                                                      
         BNE   PARSE45             Not Found                                    
GETGR10  L     R6,ASJBUF1          Point to found record                        
         LA    R2,SJGRUP           Point to group billing                       
         B     PARSE60                                                          
         DROP  R6                                                               
         EJECT                                                                  
***********************************************************************         
*  GET ACCT CODE FROM X'C0' MINI-ELEMENTS OR X'4C'                    *         
***********************************************************************         
         SPACE 1                                                                
         USING SPDELD,R8                                                        
GETACCC  SR    RF,RF                                                            
         CLI   PARELEM,SPDELQ      X'4C', subsidiary posting element            
         BNE   GETACC05                                                         
         IC    RF,SPDLN            Get element length                           
         AHI   RF,-SPDLN1Q                                                      
         LA    RE,SPDACCS          Point to unit/ledger/account                 
         DROP  R8                                                               
*                                                                               
         CLI   PARCC,254           To parse cli/prd/job only                    
         BE    GETACC02                                                         
         STH   RF,PARNEWLN         New length of to parse                       
         CLI   PARCC,255           Contra compare                               
         BNE   GETACC02            No                                           
         LA    RE,CURSUBAC+1       Yes                                          
*                                                                               
GETACC02 CLC   PARXTRA,0(RE)                                                    
         BNE   PARSE50                                                          
         B     PARSE60                                                          
*                                                                               
         USING APENTRY,R2                                                       
GETACC05 ICM   RF,1,0(R8)          NUMBER OF MINI-ELEMENTS                      
         BZ    PARSE50             NOT FOUND                                    
         SR    R1,R1                                                            
*                                                                               
GETACC10 IC    R1,APENLEN          LENGTH OF ENTRY                              
         CLC   PARXTRA,APENACT                                                  
         BE    GETACC20                                                         
         AR    R2,R1               BUMP TO NEXT MINI-ELEM                       
         BCT   RF,GETACC10                                                      
         B     PARSE50             NOT FOUND                                    
*                                                                               
GETACC20 AHI   R1,-APELN2Q         LENGTH OF DATA                               
         CLM   R1,3,PARFRLEN                                                    
         BNL   *+8                 IF LOW ACCOUNT NOT LONG ENOUGH               
         STH   R1,PARNEWLN         SO USE NEW LENGTH TO PARSE                   
         LA    R2,APENACT          START OF DATA                                
         B     PARSE60                                                          
         EJECT ,                                                                
***********************************************************************         
*  GET OFFICE NAME FROM OFFTAB                                        *         
***********************************************************************         
         SPACE 1                                                                
         USING ROWD,RE                                                          
GETANAME L     RE,ACURROW                                                       
         CLC   ROWDD#,=AL2(AC#RSWC)    WC(WCN) KEYWORD?                         
         BNE   GETANM02                                                         
         CLI   QPROG,PRODUCTION        IF SJ AND WCN KEYW ONLY DO THIS          
         BNE   GETANM02                CODE IF PARSEING % OF EST BY WC          
         TM    PARCNTRL,PARBYWC                                                 
         BZ    PARSE50                                                          
         DROP  RE                                                               
GETANM02 MVC   PARWORK(30),SPACES                                               
         SR    RE,RE                                                            
         ICM   RE,3,PARDSPTT       DISPLACEMENT TO A(TABLE)                     
         AR    RE,RA                                                            
         L     R2,0(,RE)           POINT TO TABLE DATA                          
         LR    RE,R2                                                            
         SHI   RE,2                                                             
         SR    R6,R6                                                            
         ICM   R6,3,0(RE)          NUMBER OF ENTRIES IN 2 BYTE OF LABEL         
         BZ    PARSE99                                                          
         GOTO1 PARSE,DMCB,PARADDR,PARWORK,0,0                                   
         BNE   PARSE99                                                          
*&&US                                                                           
         CLI   PARELEM,2           SPECIAL CODE INDICATOR FOR MEDIA             
         BE    GETANM30                                                         
*&&                                                                             
         CLI   PARELEM,1           SPECIAL CODE INDICATOR FOR MEDIA             
         BNE   GETANM20                                                         
         CLI   PARWORK,C'J'        SYSTEM PROD ?                                
         BNE   GETANM20            COUNTINUE AS USUAL                           
         MVC   PARWORK(1),PARWORK+1       MOVE MEDIA CODE OVER                  
         MVI   PARWORK+1,BLANK                                                  
         SR    RE,RE                                                            
         ICM   RE,3,PARDSPEL       GET ALTERNATE TABLE                          
         AR    RE,RA                                                            
         L     R2,0(,RE)           POINT TO TABLE DATA                          
         LR    RE,R2                                                            
         SHI   RE,2                                                             
         SR    R6,R6                                                            
         ICM   R6,3,0(RE)          GET NUMBER OF ENTRIES                        
         BZ    PARSE99                                                          
         LHI   R8,1                LENGTH OF KEY (HARD CODED)                   
         B     GETANM25                                                         
*                                                                               
GETANM20 L     RE,PARADDR          LOAD LINK TO CODE PARSE ENTRY                
         SR    R8,R8                                                            
         ICM   R8,3,PARFRLEN-PARSED(RE)  LENGTH OF CODE                         
*                                                                               
GETANM25 SR    R1,R1                                                            
         ICM   R1,3,PARFRLEN       LENGTH OF NAME                               
         AR    R1,R8               TOTAL TABLE ENTRY LENGTH                     
         ST    R1,DMCB+12          LENGTH OF TABLE ENTRY                        
         ST    R8,DMCB+16          SIZE OF KEY IN TABLE                         
         GOTO1 BINSRCH,DMCB,(1,PARWORK),(R2),(R6),,,(R6)                        
         ICM   R2,7,DMCB+1         ADDRESS OF RECORD                            
         BZ    PARSE50             NOT FOUND                                    
         AR    R2,R8               BUMP UP PAST KEY                             
         B     PARSE60                                                          
*&&US                                                                           
GETANM30 MVC   PARWORK+1(1),PARWORK                                             
         MVC   PARWORK(1),MEDSAVLG                                              
         L     RE,PARADDR          LOAD LINK TO CODE PARSE ENTRY                
         SR    R8,R8                                                            
         ICM   R8,3,PARFRLEN-PARSED(RE)  LENGTH OF CODE                         
*                                                                               
         SR    R1,R1                                                            
         ICM   R1,3,PARFRLEN       LENGTH OF NAME                               
         AHI   R1,1                                                             
*                                                                               
         AR    R1,R8               TOTAL TABLE ENTRY LENGTH                     
         AHI   R8,1                                                             
         ST    R1,DMCB+12          LENGTH OF TABLE ENTRY                        
         ST    R8,DMCB+16          SIZE OF KEY IN TABLE                         
*                                                                               
         GOTO1 BINSRCH,DMCB,(2,PARWORK),(R2),(R6),,,(R6)                        
         ICM   R2,7,DMCB+1         ADDRESS OF RECORD                            
         BZ    PARSE50             NOT FOUND                                    
         AR    R2,R8               BUMP UP PAST KEY                             
         B     PARSE60                                                          
*&&                                                                             
         EJECT ,                                                                
*&&US                                                                           
*=====================================================================*         
*       Get MEDIA NAME FOR SSN,SU                                     *         
*=====================================================================*         
GETMEDNM MVC   WORK,SPACES                                                      
         CLC   CURACC+1(2),=C'SU'  Net                                          
         JE    GTMEDNM2            Process                                      
         CLI   CURACC+3,C'N'       IF NOT NETWORK                               
         JNE   PARSE50             Exit                                         
GTMEDNM2 MVC   PARWORK(30),SPACES                                               
         GOTO1 PARSE,DMCB,PARADDR,PARWORK,0,0                                   
         JNE   PARSE99                                                          
         LA    R1,NMEDTAB                                                       
GTMEDNM4 CLI   0(R1),X'FF'                                                      
         JE    PARSE50                                                          
         CLC   0(1,R1),PARWORK                                                  
         JE    GTMEDNM5                                                         
         LA    R1,NMEDTABL(R1)                                                  
         J     GTMEDNM4                                                         
GTMEDNM5 MVC   WORK(12),1(R1)                                                   
         LA    R2,WORK                                                          
         J     PARSE60                                                          
         EJECT ,                                                                
* SUB-MEDIA TABLE FOR NETWORK                                                   
NMEDTAB  DS    0H                                                               
         DC    C'N',CL12'NETWORK     '                                          
NMEDTABL EQU   *-NMEDTAB                                                        
         DC    C'C',CL12'CABLE       '                                          
         DC    C'S',CL12'SYNDICATION '                                          
         DC    C'D',CL12'RADIO       '                                          
         DC    C'V',CL12'VIDEO/DIGITL'                                          
         DC    C'O',CL12'OTHER       '                                          
         DC    X'FF'                                                            
         EJECT ,                                                                
*&&                                                                             
***********************************************************************         
*  GET CONTRA NAME                                                    *         
***********************************************************************         
         SPACE 1                                                                
GETCACNM MVC   IOKEY2,SPACES                                                    
         ICM   RF,15,PARADDR       ANY DATA CODE TO PARSE ?                     
         BZ    GETCANM6            IF NO (ZERO) THEN UNIT/LEDGER ONLY           
*        CLI   QPROG,PRODUCTION    PRODUCTION ONLY CODE                         
*        BNE   GETCANM2                                                         
*        CLI   REALTYP,12          EXCLUDE TYPE 12                              
*        BE    PARSE45             TRY AGAIN                                    
*                                                                               
GETCANM2 LA    RF,IOKEY2+1                                                      
         CLI   QPROG,INCOME        INCOME    ONLY CODE                          
         BNE   GETCANM4                                                         
         CLI   XCULFLAG,NO                                                      
         BE    GETCANM4                                                         
         LA    RF,IOKEY2+3                                                      
*                                  PARSE DATA CODE FOR CORRECT LEVEL            
GETCANM4 GOTO1 PARSE,DMCB,PARADDR,(RF),0,0                                      
         BNE   PARSE45                                                          
*                                                                               
GETCANM6 MVC   READUL,CURSUBAC+1                                                
         CLI   QPROG,PNL           PROFIT AND LOSS                              
         JNE   GETNAME                                                          
         CLI   READUL+1,C'6'       U/L = 16                                     
         BNE   *+8                                                              
         MVI   READUL+1,C'R'       READ 1R INSTEAD TO GET NAME                  
         CLI   PARTTYP2,0                                                       
         JE    GETNAME                                                          
         CLI   READUL+1,C'3'       U/L < 13                                     
         JL    GETNAME                                                          
         CLI   READUL+1,C'5'       U/L > 15                                     
         JH    GETNAME                                                          
*                                                                               
         USING LDGD,RE                                                          
         GOTO1 GETLDGR,DMCB,READUL                                              
         L     RE,0(,R1)                                                        
         CLI   LDG#LEVS,1          IF ONE LEVEL DON'T BOTHER                    
         JE    GETNAME                                                          
         SR    RF,RF                                                            
         IC    RF,LDGLEV1          LEN OF LEVEL 1                               
         CLI   READUL+1,C'3'       IS IT U/L 13, USE LAST 2 LEVELS ONLY         
         BNE   GETCANM8            NOT 13                                       
         LA    R1,1                                                             
         CLI   LDG#LEVS,4          4 LEVELS ?                                   
         BNE   GETCANM7            NO, SO GET LAST TWO LEVELS                   
         LA    R1,2                                                             
         IC    RF,LDGLEV2          GET LENGTH OF LEVEL 1&2 INSTEAD              
*                                                                               
GETCANM7 CLM   R1,1,PARTTYP2       IF CERTAIN LVL DON'T BUILD ALTERNATE         
         JNL   GETNAME                                                          
         DROP  RE                                                               
*                                                                               
GETCANM8 LA    RE,IOKEY2+3(RF)     POINT PAST FIRST LEVEL                       
         LA    R1,12                                                            
         SR    R1,RF               WHAT PART IS REMAINING                       
         BCTR  R1,0                LESS ON FOR EXECUTE                          
         MVC   WORK(12),SPACES                                                  
         EXMVC R1,WORK,0(RE)       REMOVE FIRST LEVEL                           
*                                                                               
         CLI   READUL+1,C'5'       IS IT U/L 15                                 
         BNE   GETCANM9            NO                                           
         CLI   PARTTYP2,4          LEVEL 4 ONLY                                 
         BNE   GETCANM9                                                         
         LA    RE,WORK+12          YES SO REMOVE LAST CHARACTER ON END          
         LA    R0,12                                                            
         CLI   0(RE),BLANK                                                      
         BH    *+10                                                             
         BCTR  RE,0                                                             
         BCT   R0,*-10                                                          
         MVI   0(RE),BLANK         WIPE OUT LAST CHARACTER                      
*                                                                               
GETCANM9 MVC   IOKEY2+3(12),WORK                                                
         MVI   READUL+1,C'R'       READ 1R INSTEAD TO GET NAME                  
         J     GETNAME                                                          
         EJECT ,                                                                
***********************************************************************         
*  GET COST ACCOUNT NAME FROM SJ TABLE                                *         
***********************************************************************         
         SPACE 1                                                                
ALT      USING PARSED,R2                                                        
*                                                                               
GETCSTNM L     R2,PARADDR             PARSE ENTRY TO WORK WITH                  
*                                                                               
GETCSTN2 CLI   ALT.PARTYPE,EOT                                                  
         BNE   *+6                                                              
         DC    H'00'               MUST BE SET UP                               
         MVC   WORK(4),ALT.PARLDGRS                                             
         NC    WORK(4),=AL4(PAR_SI)                                             
         BNZ   *+12                                                             
         LA    R2,PARSEDQ(,R2)                                                  
         B     GETCSTN2                                                         
*                                                                               
         MVC   SAVLEN,ALT.PARFRLEN+1 GET LENGTH OF CODE FOR LEVEL               
         CLI   PARCC,1                                                          
         BE    GETCOST1            IF 1 GET COST POINTER FROM SJ                
         CLC   CURCOST,SPACES      CHECK ON X'C0' DATA FOR 1C                   
         BNH   GETCOST1            NON SO GET COST POINTER FORM SJ              
         MVC   IOKEY2,SPACES       USE X'C0' DATA FOR 1C                        
         LA    R2,CURCOST+2                                                     
         B     GETCOST8                                                         
         DROP  ALT                                                              
*                                                                               
         USING SJINFO,R6                                                        
GETCOST  MVC   SAVLEN,PARFRLEN+1                                                
*                                                                               
GETCOST1 MVC   IOKEY2,SPACES                                                    
         BAS   RE,GETSJPRD         GET CLI/PROD LEVEL FIRST                     
         BNE   GETCOST2            NOT FOUND TRY CLIENT LEVEL                   
         L     R6,ASJBUF1          POINT TO FOUND RECORD                        
         CLC   SJCOSTAC,SPACES                                                  
         BH    GETCOST7                                                         
*                                                                               
GETCOST2 BAS   RE,GETSJCLI         GET CLI LEVEL                                
         BNE   PARSE45             NOT FOUND                                    
         L     R6,ASJBUF1          POINT TO FOUND RECORD                        
         CLC   SJCOSTAC,SPACES                                                  
         BNH   PARSE45                                                          
*                                                                               
GETCOST7 LA    R2,SJCOSTAC         POINT TO COST ACCOUNT                        
*                                                                               
GETCOST8 SR    R1,R1                                                            
         IC    R1,SAVLEN                                                        
         BCTR  R1,0                                                             
         EXMVC R1,IOKEY2+3,0(R2)                                                
         MVC   READUL,=C'1C'                                                    
         J     GETNAME                                                          
*                                                                               
SAVLEN   DC    X'00'                                                            
         EJECT ,                                                                
***********************************************************************         
*  GET PRODUCT GROUP INFO TO RENAME ACCOUNT CODES FOR SJ              *         
***********************************************************************         
         SPACE 1                                                                
         USING SJINFO,R6                                                        
PRGRCLI  LH    R8,SJCLIDSP         DISPLACEMENT TO CLIENT                       
         B     *+8                                                              
PRGRPRD  LH    R8,SJPRDDSP         DISPLACEMENT TO PRODUCT                      
*                                                                               
         L     R6,ASJBUF1                                                       
         BAS   RE,GETSJPRD         BIN-SEARCH INTO SJTABLE                      
         BNE   PARSE45             TRY SOMETHING ELSE                           
         LA    R2,SJPRGRCP(R8)                                                  
         SR    R1,R1                                                            
         ICM   R1,3,PARFRLEN                                                    
         EXCLC R1,0(R2),SPACES     IS THERE A CLI/PROD GROUP ?                  
         BH    PARSE60             YES, USE IT                                  
         LA    R2,SJCLIPRD(R8)     NO , USE REAL CLI/PROD INSTEAD               
         B     PARSE60             RETURN                                       
         DROP  R6                                                               
         EJECT ,                                                                
***********************************************************************         
*  GET ACCOUNT NAME                                                   *         
***********************************************************************         
         SPACE 1                                                                
GETACCNM MVC   IOKEY2,SPACES               Clear key                            
         LA    R6,IOKEY2+1                 Get UNIT/LEDGER/ACCOUNT              
         TM    PARIND3,PARULRST            Restore form parse call              
         BZ    *+8                         No                                   
         LA    R6,IOKEY2+3                 Get account code only                
*                                                                               
         GOTOR PARSE,DMCB,PARADDR,(R6),0,0                                      
         BNE   PARSE50                     No data found                        
         MVC   READUL,IOKEY2+1                                                  
         TM    PARIND3,PARULRST            Set U/L saved from parse             
         BZ    *+10                        No                                   
         MVC   READUL,PARSAVUL             Yes set UNIT/LEDGER                  
         J     GETNAME                                                          
         EJECT ,                                                                
***********************************************************************         
*                       READ AN ACCOUNT RECORD                        *         
***********************************************************************         
         SPACE 1                                                                
         USING ACCRECD,R2                                                       
READREC  L     R2,AIO2                                                          
         MVC   IOKEY,SPACES                                                     
         MVC   IOKEY(L'IOKEY2),IOKEY2                                           
         CLC   IOKEY,ACCKEY        DO WE ALREADY HAVE REC?                      
         BER   RE                  YES RETURN                                   
*                                                                               
         MVI   RESET,YES           RESET MONACHS KEY                            
         ST    RE,FULL             SAVE RETURN ADDR.                            
         L     R1,=AL4(IOREAD+IOACFIL+IOAREA2)                                  
         GOTO1 AIO                                                              
         L     RE,FULL                                                          
         BR    RE                                                               
         EJECT ,                                                                
*&&UK                                                                           
***********************************************************************         
*  READ A MASTER RECORD WITH FULL KEY ON IOKEY                        *         
*  EXIT: MASTER RECORD ON AIO2                                        *         
***********************************************************************         
         SPACE 1                                                                
READMRC  MVI   RESET,YES           RESET MONACHS KEY                            
         ST    RE,FULL             SAVE RETURN ADDR.                            
*                                                                               
         L     R1,=AL4(IOREAD+IOACDIR+IOAREA2)                                  
         GOTO1 AIO                                                              
         BNE   READMRCX                                                         
         L     R1,=AL4(IOGETREC+IOACMST+IOAREA2)                                
         GOTO1 AIO                                                              
READMRCX L     RE,FULL                                                          
         BR    RE                                                               
         EJECT ,                                                                
*&&                                                                             
         LTORG                                                                  
         EJECT ,                                                                
***********************************************************************         
*        GET CLIENT OR/AND PRODUCT ENTRY FORM SJ TABLE                *         
*        DEFAULT AND CURRENT CLI/PROD/JOB WILL BE SET FROM MODE       *         
*        PROCTRNS USING CURBASE TABLE                                 *         
***********************************************************************         
         SPACE 1                                                                
         USING SJINFO,R6                                                        
GETSTCPN MVC   SJKEY,SPACES        GET STUDIO CLI OR PROD NAME                  
         GOTO1 PARSE,DMCB,PARADDR,SJKEY,0,0                                     
         BNE   PARSE99                                                          
         LA    RE,SJNAME           BRANCH RETURN ADDRESS                        
         ST    RE,SVRE                                                          
         B     GETSJKEY                                                         
*                                                                               
GETSJCLI ST    RE,SVRE             SAVE RE                                      
         CLC   DFTCLI,SPACES       IF NO DEFAULT CLIENT THEN                    
         BNH   GETSJNOT               NONE TO BE FOUND                          
         LA    RE,CURSJACC         ->   CURRENT SJ ACCOUNT                      
         AH    RE,SJCLIDSP         ->   CLIENT                                  
         CLI   0(RE),X'FF'         CLIENT = X'FF'S ?                            
         BE    GETSJNOT            YES, NOT A CLIENT                            
         IC    RF,SJCLILEN         CLIENT LENGTH                                
         BCTR  RF,0                                                             
         EXCLC RF,0(RE),SPACES     CLIENT = ZEROS OR SPACES ?                   
         BNH   GETSJNOT            YES, NOT A CLIENT                            
         L     RE,SVRE             RESTORE RE                                   
         LH    RF,SJPRDDSP         LENGTH OF CLIENT                             
         B     GETSJ10                                                          
*                                                                               
GETSJPRD ST    RE,SVRE             SAVE RE                                      
         CLC   DFTPRD,SPACES       IF NO DEFAULT PROD THEN                      
         BNH   GETSJNOT               THERE IS NONE TO BE FOUND                 
         LA    RE,CURSJACC         ->   CURRENT SJ ACCOUNT                      
         AH    RE,SJPRDDSP         ->   PRODUCT                                 
         CLI   0(RE),X'FF'         PRODUCT = X'FF'S ?                           
         BE    GETSJNOT            YES, NOT A PRODUCT                           
         IC    RF,SJPRDLEN         PRODUCT LENGTH                               
         BCTR  RF,0                                                             
         EXCLC RF,0(RE),SPACES     PRODUCT = ZEROS OR SPACES ?                  
         BNH   GETSJNOT            YES, NOT A PRODUCT                           
         LH    RF,SJJOBDSP         LENGTH OF CLIENT+PRODUCT                     
*                                                                               
GETSJ10  MVC   SJKEY,SPACES        CLEAR KEY                                    
         BCTR  RF,0                                                             
         EXMVC RF,SJKEY,CURSJACC   MOVE IN CLI OR CLI/PROD                      
*                                                                               
GETSJKEY L     RE,SVRE             RESTORE RE                                   
         CLC   SJKEY,SPACES        IS THERE ANY DATA ?                          
         BH    GETSJ16             YES                                          
         LTR   RE,RE               SET CONDICTION CODE TO NO                    
         BR    RE                                                               
*                                                                               
GETSJ16  L     R1,ASJBUF1                                                       
         CLC   SJKEY,0(R1)         IS THIS THE SAME ENTRY                       
         BER   RE                  YES, ALREADY HAVE ENTRY                      
         ST    R4,SVR4                                                          
         L     R4,ASJBUF1                                                       
         L     RF,ASJBUF2                                                       
         CLC   SJKEY,0(RF)         IS THIS THE SAME ENTRY                       
         BNE   GETSJ20                                                          
         XC    0(SJBUFMAX,R4),0(RF) SWAP ENTRIES                                
         XC    0(SJBUFMAX,RF),0(R4)                                             
         XC    0(SJBUFMAX,R4),0(RF)                                             
         L     R4,SVR4                                                          
         SR    R1,R1               SET CC=YES                                   
         BR    RE                  YES, ALREADY HAVE ENTRY                      
*                                                                               
GETSJ20  MVC   0(SJBUFMAX,RF),0(R4) PROMOTE BUFF 1 TO BUFF 2                    
         SAM31                     31 Bit mode                                  
         MVC   0(SJBUFMAX,R4),SPACES                                            
         MVC   0(L'SJKEY,R4),SJKEY                                              
         LH    RF,SJLNQ                                                         
         GOTO1 BIN31,DMCB,(R4),ASJTABLE,NUMREC,(1,(RF)),               X        
               (0,L'SJKEY),ASJMAXQ                                              
         ICM   RE,15,DMCB                                                       
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
*                                                                               
         MVC   NUMREC,DMCB+8       SAVE OFF NUMBER OF RECS IN TABLE             
         L     RE,DMCB             MOVE DATA TO LOW CORE                        
         ST    RE,SJENTRY          SAVE OFF ADDRESS                             
         NI    SJENTRY,TURNOFF-X'80'                                            
         LH    RF,SJLNQ                                                         
         BCTR  RF,0                                                             
         EXMVC RF,0(R4),0(RE)      MOVE IN DATA                                 
*                                                                               
         TM    DMCB,X'80'          WAS RECORD FOUND                             
         BZ    GETSJ40             YES                                          
         SAM24                     24 Bit mode                                  
         GOTO1 =A(SJSAVE),DMCB,(R4)           NO SO FILL IN ENTRY               
         SAM31                     31 Bit mode                                  
*                                                                               
         L     RE,SJENTRY                                                       
         LH    RF,SJLNQ                                                         
         BCTR  RF,0                                                             
         EXMVC RF,0(RE),0(R4)      MOVE DATA TO HIGH CORE                       
*                                                                               
GETSJ40  SAM24                     24 Bit mode                                  
         L     R4,SVR4                                                          
         SR    R1,R1               SET CC=YES                                   
         L     RE,SVRE                                                          
         BR    RE                                                               
*                                                                               
GETSJNOT L     RE,SVRE             RESTORE RE                                   
         LTR   RE,RE               NOT FOUND SET CC = NO                        
         BR    RE                                                               
         DROP  R6                                                               
         SPACE 2                                                                
         LTORG                                                                  
         EJECT ,                                                                
***********************************************************************         
*        GET NAME FROM SJ TABLE                                     *           
***********************************************************************         
         SPACE 1                                                                
BLDSJPGC BAS   RE,GETSJPRD                                                      
         BNE   PARSE99                                                          
         LH    RF,SJPRDDSP         LENGTH OF CLIENT                             
         B     BLDSJPG                                                          
*                                                                               
BLDSJPGP BAS   RE,GETSJPRD                                                      
         BNE   PARSE99                                                          
         LH    RF,SJJOBDSP         LENGTH OF CLIENT + PRODUCT                   
*                                                                               
         USING SJINFO,R6                                                        
BLDSJPG  MVC   SJKEY,SPACES                                                     
         BCTR  RF,0                                                             
         L     R6,ASJBUF1                                                       
         EXMVC RF,SJKEY,SJPRGRCP                                                
         LA    RE,SJNAME           BRANCH RETURN ADDRESS                        
         ST    RE,SVRE                                                          
         B     GETSJKEY                                                         
*                                                                               
BLDSJCLI BAS   RE,GETSJCLI                                                      
         B     SJNAME                                                           
*                                                                               
BLDSJPRD BAS   RE,GETSJPRD                                                      
*                                                                               
SJNAME   BNE   PARSE99                                                          
         L     R6,ASJBUF1          ENTRY SHOULD ALWAYS BE IN SJBUF1             
         MVC   IOKEY2+3(12),SJCLIPRD                                            
         CLI   PARELEM,NAMELQ      DO WE WANT NAME OR SJ ACCT.?                 
         JNE   BLDSJACT                                                         
         MVC   PARNEWLN+1(1),SJNMELN  NAME LENGTH                               
         SAM31                                                                  
         ICM   R2,15,SJNMEPTR      NAME POINTER                                 
         JNZ   GETNME20                                                         
         SAM24                                                                  
         B     PARSE50             NO NAME                                      
*                                                                               
GETSJOBN MVC   IOKEY2,SPACES       STUDIO JOB NAME                              
         GOTO1 PARSE,DMCB,PARADDR,IOKEY2+3,0,0                                  
         BNE   PARSE99                                                          
         J     BLDSJACT                                                         
*                                                                               
BLDSJJOB MVC   IOKEY2,SPACES                                                    
         MVC   IOKEY2+3(12),CURSJACC                                            
         LA    R8,CURSJACC                                                      
         AH    R8,SJJOBDSP                                                      
         CLC   DFTJOB,SPACES                                                    
         BNH   PARSE99                  DATA NOT FOUND                          
         LA    R1,CURSJACC         ->   CURRENT SJ ACCOUNT                      
         AH    R1,SJJOBDSP         ->   JOB                                     
         CLI   0(R1),X'FF'         JOB  = X'FF'S ?                              
         BE    PARSE99             YES, NOT A PRODUCT                           
         IC    RF,SJJOBLEN         JOB  LENGTH                                  
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         CLC   0(0,R1),SPACES      JOB  = ZEROS OR SPACES ?                     
         EX    RF,0(RE)                                                         
*        EXCLC RF,0(R1),SPACES     JOB  = ZEROS OR SPACES ?                     
         BNH   PARSE99             YES, NOT A JOB                               
*                                                                               
BLDSJACT MVC   READUL,CURSJ                                                     
         LA    R2,IOKEY2                                                        
         J     GETNAME                                                          
         DROP  R6                                                               
         EJECT ,                                                                
***********************************************************************         
*  GET POSSIBLE NAME OF ACCOUNT                                       *         
***********************************************************************         
         SPACE 1                                                                
         USING NAMD,R6                                                          
GETNAME  OC    IOKEY2,SPACES                                                    
         MVC   IOKEY2(1),RCCOMPFL  COMPANY CODE                                 
         MVC   IOKEY2+1(2),READUL  UNIT/LEDGER TO READ                          
         CLI   PARELEM,NAMELQ      ARE WE LOOKING FOR A NAME? X'20'             
         JE    *+8                                                              
         CLI   PARELEM,CACELQ      X'43' GET CONTRA NAME ELEMENT                
         BNE   PARSE60             NO SO PASS BACK ACCOUNT CODE ONLY            
         XC    WORK,WORK                                                        
         LA    R6,WORK                                                          
         MVC   NAMKEY,IOKEY2+1                                                  
         LHI   RF,MAXNAMES                                                      
         GOTO1 BINSRCH,DMCB,(1,(R6)),NAMBASE,NAME#,NAMLNQ,             X        
               (0,L'NAMKEY),(RF)                                                
         XC    SVR6,SVR6                                                        
         SR    R6,R6                                                            
         ICM   R6,7,DMCB+1         LOAD WHERE INSERTED OR FOUND                 
         JZ    GETNME30            RECORD NOT FOUND AND TABLE FULL              
         ST    R6,SVR6             SAVE OFF ADDRESS ON ENTRY                    
         TM    DMCB,X'01'          FOUND?                                       
         JO    GETNME30            NO                                           
         MVC   PARNEWLN+1(1),NAMLEN   NAME FOUND IN BIN TABLE                   
         SAM31                                                                  
         ICM   R2,15,NAMADR                                                     
         JNZ   GETNME20            Found name                                   
         SAM24                                                                  
         B     PARSE45             NO NAME PRESENT                              
                                                                                
GETNME20 XR    RF,RF               Move to low core for now                     
         ICM   RF,3,PARNEWLN                                                    
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   WORK(0),0(R2)                                                    
         EX    RF,0(RE)                                                         
*        EXMVC RF,WORK,0(R2)                                                    
         LA    R2,WORK                                                          
         BRAS  RE,RTNMEFX                                                       
         SAM24                                                                  
         B     PARSE60             Get name                                     
*                                                                               
GETNME30 MVC   NAME#,DMCB+8                                                     
         BAS   RE,READREC          GO READ ACCOUNT                              
         BNE   PARSE45             DATA NOT FOUND, EXIT                         
         L     R2,AIO2                                                          
         AH    R2,DATADISP         GET TO FIRST ELEMENT                         
         LHI   RF,NAMLN1Q                                                       
         STH   RF,HALF                                                          
*        MVC   HALF,=Y(NAMLN1Q)                                                 
         SR    RF,RF                                                            
*                                                                               
GETNME35 CLI   0(R2),0             END OF RECORD?                               
         BE    PARSE45                                                          
         CLI   0(R2),NAMELQ        X'20' GET NAME ELEMENT                       
         JE    GETNME40                                                         
         CLI   0(R2),CACELQ        X'43' GET CONTRA NAME ELEMENT                
         JE    GETNME39                                                         
         IC    RF,1(,R2)                                                        
         AR    R2,RF                                                            
         J     GETNME35                                                         
*                                                                               
GETNME39 LHI   R1,CACLN1Q                                                       
         STH   R1,HALF                                                          
*        MVC   HALF,=Y(CACLN1Q)                                                 
*                                                                               
GETNME40 IC    RF,1(,R2)                                                        
         SH    RF,HALF             RF = SHOULD BE LENGTH OF NAME                
         BNP   PARSE45             BAD NAME ELEMENT                             
         STH   RF,PARNEWLN         SAVE LENGTH OF NAME                          
         AH    R2,HALF             POINT TO DATA (NAME)                         
         ICM   R1,15,SVR6                                                       
         BZ    PARSE60                                                          
         SAM31                                                                  
         L     RE,APOOLPTR                                                      
         C     RE,APOOLEOT                                                      
         JNH   *+6                                                              
         DC    H'00'                                                            
                                                                                
         STCM  RE,15,NAMADR        SAVE ADDRESS TO NAME                         
         STC   RF,NAMLEN           SAVE LENGTH OF NAME                          
         BCTR  RF,0                                                             
         BASR  R1,0                                                             
         MVC   0(0,RE),0(R2)       MOVE NAME INTO NAME POOL                     
         EX    RF,0(R1)                                                         
*        EXMVC RF,0(RE),0(R2)      MOVE NAME INTO NAME POOL                     
         LA    RE,1(RE,RF)                                                      
         ST    RE,APOOLPTR         Bump to next free area                       
         SAM24                                                                  
         B     PARSE60             Found data, so retrieve it                   
         DROP  R6                                                               
         SPACE 2                                                                
         LTORG                                                                  
         EJECT ,                                                                
*=====================================================================*         
* Check to see if we need to mark deleted for next pass               *         
* R0,R1,RF are destroyed                                              *         
*=====================================================================*         
CHK2DEL  TM    PARIND1,PARSPLT     SPLIT TYPE DATA (MULTIPLE DATA)              
         BZR   RE                                                               
         CLI   PARTYPE,ELEMENT                                                  
         JE    CHK2DEL1                                                         
         CLI   PARTYPE,ELMTYPE                                                  
         BNER  RE                                                               
                                                                                
CHK2DEL1 OI    SPLITIND,SPLITDAT   Set split data possible                      
         L     R1,FMTDELEL         Deletion pool                                
         LA    R0,MAXDELEL         Max number of deleted elements               
         ICM   RF,15,PARELADR                                                   
         BZR   RE                                                               
                                                                                
CHK2DEL2 OC    0(4,R1),0(R1)                                                    
         JNZ   CHK2DEL4                                                         
         ST    RF,0(,R1)           Save element address                         
         BR    RE                                                               
                                                                                
CHK2DEL4 C     RF,0(R1)            Do we already have ?                         
         BER   RE                  Yes                                          
         AHI   R1,4                Bump to new location                         
         SHI   R0,1                One less to process                          
         JP    CHK2DEL2                                                         
         BR    RE                  Return                                       
         DROP  R2,R5,R7                                                         
         EJECT ,                                                                
*&&DO                                                                           
***********************************************************************         
*  CHECK PAY DETAILS, Rigth bucket type and method for column ?       *         
*  R4 =  Column processing , R6 =  element processing                 *         
***********************************************************************         
         USING COLD,R4                                                          
         USING FMTRECD,R5                                                       
         USING PHSELD,R6                                                        
CKPAYDET CLI   PHSEL,PHSELQ        Did we process already ?                     
         BNER  RE                  Yes                                          
*                                                                               
CKPAYD05 CLI   COLBUCK,X'FF'       Total bucket type ?                          
         JE    CKPAYD10            Ignore bucket type filtering                 
         CLC   COLBUCK,PHSBUCK     Sal, Pen, Ben or IND type ?                  
         BNER  RE                  Return, not the right type                   
*                                                                               
CKPAYD10 CLC   COLMTHD,PHSMTHD     Match method                                 
         BNER  RE                  Return, condition code                       
         TM    PHSIND,PHSRTE                                                    
         JO    CKPAYD18                                                         
         CLC   PHSMOA,COLEND                                                    
         BHR   RE                                                               
         CLC   PHSMOA,COLSTART                                                  
         BLR   RE                                                               
         TM    PHISIND,PHISMOA     Reporting by MOA ?                           
         JZ    CKPAYD20            No, so ok, BZ is same as BE                  
CKPAYD18 CLC   PHSMOA,TEMPMOS      Reporting by moa so must match               
         BNER  RE                                                               
*                                                                               
CKPAYD20 TM    PHISIND,PHISTDTE    Reporting transaction date                   
         JZ    CKPAYD28                                                         
         CLC   TRANDTE,PHSCSDTE    Is it lower or equal to                      
         JH    *+8                 Yes, so not within range                     
         LTR   RE,RE               Set to not equal, incase equal               
         BR    RE                  Yes, so not within range                     
         CLC   TRANDTE,PHSCEDTE    Is it higher than                            
         BHR   RE                  Yes, so not within range                     
*                                                                               
CKPAYD28 TM    PHISIND,PHISTYPE    Reporting by type (bucket)                   
         JZ    CKPAYD30            No                                           
         CLC   PHSBUCK,CURBUCK                                                  
         BNER  RE                                                               
*                                                                               
CKPAYD30 TM    PHISIND,PHISCDNM    Reporting by pay code ?                      
         JZ    CKPAYD40            No                                           
         CLC   PHSCODE,CURPAYCD                                                 
         BNER  RE                                                               
*                                                                               
CKPAYD40 CLI   MODE,PROCTIME                                                    
         BER   RE                                                               
         CLI   MODE,PROCTRNS                                                    
         BER   RE                                                               
         TM    PHISIND,PHISDATE    Reporting by payroll date ?                  
         BZR   RE                  No                                           
         CLC   PHSDATE,PAYDATE                                                  
         BR    RE                                                               
         DROP  R4,R5,R6                                                         
         EJECT ,                                                                
*&&                                                                             
*&&US                                                                           
*=====================================================================*         
*       If it is a CR then reverse sign                               *         
*=====================================================================*         
         USING FFTELD,R8                                                        
         USING PARWRKD,R7                                                       
AORSIGN  CLI   FFTTYPE,FFTTAOR            Right type ?                          
         JNE   PARSE45                    No, try again                         
         TM    FFTSTAT2,FFTDR             Is it a debit ?                       
         JO    PARSE60                    Yes, okay as is                       
         LA    RF,L'ANSWER                                                      
         STH   RF,PARNEWLN                                                      
         ZAP   ANSWER,FFTAMAOR            Credit                                
         XI    ANSWER+L'ANSWER-1,X'01'    Reverse sign                          
         LA    R2,ANSWER                                                        
         J     PARSE60                                                          
         DROP  R7,R8                                                            
*&&                                                                             
         EJECT ,                                                                
*&&US                                                                           
*=====================================================================*         
*       Get Agency Media File                                         *         
*=====================================================================*         
GETAGYMF BRAS  RE,GTAGYMF                                                       
         LA    R2,WORK                                                          
         J     PARSE60                                                          
*&&                                                                             
         EJECT ,                                                                
*&&US                                                                           
*=====================================================================*         
*       Get Request Date and Time                                     *         
*=====================================================================*         
GETRQDT  BRAS  RE,GTRQDT                                                        
         LA    R2,WORK                                                          
         J     PARSE60                                                          
*&&                                                                             
         EJECT ,                                                                
*&&US                                                                           
*=====================================================================*         
*       This should be the QST type element, determine if QST or HST  *         
*       HST is NB,NS NF, ON & BC.QST is PQ                            *         
*=====================================================================*         
*                                                                               
TYPETAX  BRAS  RE,TAXCODES                                                      
         JNE   PARSE45                                                          
         J     PARSE60                                                          
*&&                                                                             
         EJECT ,                                                                
*&&UK                                                                           
*=====================================================================*         
*       This should be the chargable time (e.g zero debit amount)     *         
*=====================================================================*         
         USING SCIELD,R8                                                        
         USING TRNELD,RF                                                        
GETMVAL  L     RF,ADTRANS                                                       
         TM    TRNSTAT,TRNSDR      Debit?                                       
         JZ    PARSE90             No - exit                                    
         CP    TRNAMNT,PKZERO      zero means chargable time                    
         JNE   PARSE90             No - exit                                    
         DROP  RF                                                               
         CLI   SCIEL,SCIELQ        X'50'                                        
         JNE   PARSE45             No                                           
         CLI   SCITYPE,SCITCRAT    Memo value ?                                 
         JNE   PARSE45             No                                           
         J     PARSE60             Got one                                      
         DROP  R8                                                               
*&&                                                                             
         EJECT ,                                                                
*=====================================================================*         
*  Get user field w/media prod. code/name V.S. concodes               *         
*=====================================================================*         
         SPACE 1                                                                
UFMPGC   MVI   MPGFLD+1,C'C'       Code                                         
         J     *+8                                                              
UFMPGN   MVI   MPGFLD+1,C'N'       Name                                         
         MVI   MPGFLD,C'P'         Media product group                          
         L     RE,CONCODE          LIST OF POSSIBLE UF CODES                    
UFMPG10  CLI   0(RE),X'FF'         End of codes ?                               
         JE    PARSE45             Yes                                          
         CLC   MPGFLD,0(RE)        UF compare                                   
         JE    PARSE60             Found match                                  
         LA    RE,2(,RE)           Bump to next possible UF code                
         J     UFMPG10                                                          
         EJECT ,                                                                
***********************************************************************         
*  PAYROLL CODE/NAME                                                  *         
***********************************************************************         
                                                                                
         USING PARWRKD,R7                                                       
PAYDET   L     R8,PYCBASE          A(PAYCODE TABLE)                             
         LR    RE,R8               GET NUMBER OF ENTRIES                        
         AHI   RE,-2                                                            
         LH    R6,0(,RE)           # OF ENTRIES STUCK IN PART OF LABEL          
         GOTOR BINSRCH,DMCB,(R2),(R8),(R6),PYRENLNQ,PYRKEYLQ,256                
         SR    R2,R2                                                            
         TM    DMCB,X'01'          FOUND OR NOT                                 
         JO    PARSE99             NO DATA                                      
         L     R2,DMCB                                                          
         AH    R2,PARDSPTT         POINT TO DATA IN TABLE                       
         MVC   PARNEWLN,PARTOLEN                                                
         J     PARSE60                                                          
         DROP  R7                                                               
         EJECT ,                                                                
*=====================================================================*         
*  Get user field and check against concodes                          *         
*=====================================================================*         
                                                                                
VALUFLD  L     RE,CONCODE          LIST OF POSSIBLE UF CODES                    
VALUF10  CLI   0(RE),X'FF'         CHECK END OF CODES?                          
         JE    PARSE45             NO DATE FOUND                                
         CLC   0(2,RE),0(R8)       UF COMPARE                                   
         JE    VALUF20             FOUND                                        
         LA    RE,2(,RE)           BUMP TO NEXT POSSIBLE UF CODE                
         J     VALUF10                                                          
*                                                                               
VALUF20  DS    0H                                                               
         LR    R1,R8                                                            
         AHI   R1,(UFSSTAT-UFSCODE)                                             
         CLI   PARXTRA,1                                                        
         JNE   VALUF25                                                          
         TM    0(R1),UFSUCOM                                                    
         JO    VALUF30                                                          
         J     PARSE45                                                          
*                                                                               
VALUF25  TM    0(R1),UFSUCOM                                                    
         JO    PARSE45                                                          
*                                                                               
VALUF30  SR    R1,R1                                                            
         SH    R8,PARDSPTT                                                      
         AHI   R8,(UFSLN-UFSELD)                                                
         IC    R1,0(,R8)                                                        
         SHI   R1,(UFSDATA-UFSELD)                                              
         JNP   PARSE45                                                          
         STH   R1,PARFRLEN                                                      
         J     PARSE60             CONTINUE PARSING                             
         EJECT ,                                                                
*=====================================================================*         
*  General unique number for account per run                          *         
*=====================================================================*         
         SPACE 1                                                                
GENACC#  MVC   WORK,SPACES                                                      
         MVC   WORK(L'UNIQUE#),UNIQUE#                                          
         ZAP   DUB,#OFACNTS        Number of accounts counted so far            
         OI    DUB+7,X'0F'                                                      
         UNPK  WORK+L'UNIQUE#(6),DUB                                            
         LA    R2,WORK                                                          
         J     PARSE60                                                          
         EJECT ,                                                                
*=====================================================================*         
* Get Job comment from SJ account record                                        
*=====================================================================*         
         USING ACRL2D,R6                                                        
         USING PARWRKD,R7                                                       
GETJCOM  L     R6,AACRL2D                                                       
         MVI   CHOPWRK,BLANK       ENSURE ALL SPACES                            
         MVC   CHOPWRK+1(L'CHOPWRK-1),CHOPWRK                                   
         SR    R2,R2                                                            
         ST    R4,SVR4                                                          
*&&US*&& MVI   BYTE1,3             Start with 3rd level                         
                                                                                
         USING SCMELD,R4                                                        
         L     R4,ADACC            A(CURRENT SJ ACCOUNT)                        
GJCOM02  AH    R4,DATADISP                                                      
         LA    RE,CHOPWRK                                                       
         SR    R0,R0                                                            
GJCOM10  CLI   SCMEL,0                                                          
         JE    GJCOM50                                                          
         CLI   SCMEL,SCMELQ       Test standard comment element?                
         JNE   GJCOM20                                                          
         CLI   SCMTYPE,SCMTSTND   Test standard comment?                        
         JE    GJCOM25                                                          
*&&US*&& J     GJCOM30                                                          
GJCOM20  ZIC   R0,SCMLN                                                         
         AR    R4,R0                                                            
         J     GJCOM10                                                          
                                                                                
GJCOM25  ZIC   R1,SCMLN                                                         
         SHI   R1,SCMLN1Q          R1 = length of comment                       
         JNP   GJCOM20             No comment                                   
         AR    R2,R1               Keep length of string in R2                  
         XR    R8,R8                                                            
         ICM   R8,3,PARTOLEN       Max length of data allowed for entry         
         CR    R2,R8               Make sure it is not over the limit           
         JNH   GJCOM28             No, it is okay                               
         SR    R2,R1               Get back current length                      
         CR    R2,R8               Make sure it is not over the limit           
         JNH   GJCOM28             No, it is okay                               
         SR    R2,R1               Get back current length                      
         LR    R1,R8               Max length                                   
         SR    R1,R2               Max length less current length               
         JNP   GJCOM50             Finished                                     
         AR    R2,R1               R2 = full length                             
                                                                                
GJCOM28  BCTR  R1,0                R1 = length to move for                      
         BASR  R8,0                R8 = A(Next instruction)                     
         EX    R1,8(R8)                                                         
         J     *+10                                                             
         MVC   0(0,RE),SCMNARR                                                  
         LA    RE,2(R1,RE)                                                      
         J     GJCOM20             Get next job comment line                    
*&&US                                                                           
GJCOM30  DS    0H                                                               
         LHI   R1,6                Non standard comment max is 6                
         LA    RF,SCMNARR                                                       
GJCOM35  CLI   0(RF),C' '                                                       
         JH    GJCOM40                                                          
         AHI   RF,1                                                             
         JCT   R1,GJCOM35                                                       
*                                                                               
GJCOM40  LTR   R1,R1                                                            
         JZ    GJCOM20                                                          
         BCTR  R1,0                R1 = length to move for                      
         BASR  R8,0                R8 = A(Next instruction)                     
         EX    R1,8(R8)                                                         
         J     *+10                                                             
         MVC   0(0,RE),0(RF)                                                    
         LA    RE,2(R1,RE)                                                      
         J     GJCOM20             Get next job comment line                    
*&&                                                                             
GJCOM50  LA    R2,CHOPWRK                                                       
         SR    RE,R2                                                            
*&&UK*&& JZ    GJCOMX              No data                                      
*&&US*&& JZ    GJCOM60                                                          
         STH   RE,PARNEWLN         Set length of concatenated string            
         SR    R6,R6               Set cc to EQ                                 
         J     GJCOMX                                                           
*&&US                                                                           
GJCOM60  CLI   BYTE1,1             If at 1st level then done                    
         JE    GJCOMX                                                           
         ZIC   R1,BYTE1                                                         
         SHI   R1,1                                                             
         STC   R1,BYTE1                                                         
         L     R4,ADHEIRB          Try 2nd level                                
         CLI   BYTE1,2                                                          
         JE    GJCOM02                                                          
         L     R4,ADHEIRA          Already did 2nd - try 1st                    
         J     GJCOM02                                                          
*&&                                                                             
GJCOMX   L     R4,SVR4                                                          
         LTR   R6,R6                                                            
         JE    PARSE60                                                          
         J     PARSE99             No Data                                      
         DROP  R4,R6,R7                                                         
         EJECT ,                                                                
*&&UK                                                                           
*=====================================================================*         
* UK - Get XJob Desktop commenTS from SJ account record                         
*=====================================================================*         
         USING ACRL2D,R6                                                        
         USING PARWRKD,R7                                                       
GETXJCM  L     R6,AACRL2D                                                       
         MVI   CHOPWRK,BLANK       ENSURE ALL SPACES                            
         MVC   CHOPWRK+1(L'CHOPWRK-1),CHOPWRK                                   
         SR    R2,R2                                                            
         LA    RE,CHOPWRK                                                       
                                                                                
         USING FFTELD,RF                                                        
         L     RF,ADACC            A(CURRENT SJ ACCOUNT)                        
         AH    RF,DATADISP                                                      
         SR    R0,R0                                                            
GXJCM10  CLI   FFTEL,0                                                          
         JE    GXJCM30                                                          
         CLI   FFTEL,FFTELQ       Test freeform text element?                   
         JNE   GXJCM20                                                          
         CLI   FFTTYPE,FFTTPCOM   Test comment?                                 
         JE    GXJCM25                                                          
GXJCM20  IC    R0,FFTLN                                                         
         AR    RF,R0                                                            
         J     GXJCM10                                                          
*                                                                               
GXJCM25  ZIC   R1,FFTDLEN                                                       
         BCTR  R1,0                                                             
         BASR  R8,0                                                             
         EX    R1,8(R8)                                                         
         J     *+10                                                             
         MVC   0(0,RE),FFTDATA                                                  
         LA    RE,2(R1,RE)                                                      
*                                                                               
GXJCM30  LA    R2,CHOPWRK                                                       
         SR    RE,R2                                                            
         JZ    GXJCMX              No data                                      
         STH   RE,PARNEWLN         Set length of concatenated string            
         SR    R6,R6               Set cc to EQ                                 
*                                                                               
GXJCMX   LTR   R6,R6                                                            
         JE    PARSE60                                                          
         J     PARSE99             No Data                                      
         DROP  R6,R7,RF                                                         
                                                                                
         EJECT ,                                                                
*=====================================================================*         
* UK - Get media buy serial number                                              
*=====================================================================*         
         USING ACRL2D,R6                                                        
         USING PARWRKD,R7                                                       
GETBYSR  L     R6,AACRL2D                                                       
         MVC   WORK,SPACES         ENSURE ALL SPACES                            
                                                                                
         USING MXPELD,R2           LOOK FOR MEDIA EXTRA PAYMENT EL              
         ICM   R2,15,AELEM47                                                    
         JNZ   GETBYS02                                                         
         ICM   R2,15,AELEMDB       IF NOT FIND FFTELD                           
         JZ    GETBNOX                                                          
         J     GETBYS01                                                         
*                                                                               
GETBYS00 LLC   R0,FFTLN-FFTELD(R2) LOCATE FURTHER FFTELDS                       
         AR    R2,R0                                                            
*                                                                               
GETBYS01 CLI   0(R2),0                                                          
         JE    GETBNOX                                                          
         CLI   0(R2),FFTELQ        CHECK FFTELD                                 
         JNE   GETBYS00                                                         
         CLI   FFTTYPE-FFTELD(R2),FFTTMSER                                      
         JNE   GETBYS00            CHECK CORRECT FFTELD                         
         MVC   WORK(1),FFTDATA-FFTELD(R2)                                       
         ICM   RF,15,FFTDATA+1-FFTELD(R2)                                       
         J     GETBYS04                                                         
*                                                                               
GETBYS02 XR    RF,RF                                                            
         ICM   RF,7,MXPSER+1       GET BINARY SERIAL NO.                        
         MVC   WORK(1),MXPSER      AND MEDIA CODE                               
         CLI   MXPLN,MXPLN3Q       TEST LONGER ELEMENT                          
         JL    *+14                                                             
         ICM   RF,15,MXPSER2+1     GET LONGER SERIAL NO.                        
         MVC   WORK(1),MXPSER2     AND MEDIA CODE                               
*                                                                               
GETBYS04 LTR   RF,RF                                                            
         JZ    GETBNOX             ZERO - IGNORE IT                             
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  WORK+1(8),DUB       CONVERT NUMBER TO DISPLAY                    
         DROP  R2                                                               
         LA    R2,WORK             DATA FOUND                                   
         J     PARSE60                                                          
*                                                                               
GETBNOX  J     PARSE99                                                          
         DROP  R6,R7                                                            
         EJECT ,                                                                
*=====================================================================*         
* UK - Get transaction serial number                                            
*=====================================================================*         
                                                                                
GETTSNO  MVC   WORK,SPACES         ENSURE ALL SPACES                            
                                                                                
         USING SERELD,R2           LOOK FOR TRX SERIAL EL                       
         ICM   R2,15,AELEMD5                                                    
         JZ    GETTNOX             NO ELEMENT                                   
         BASR  R6,0                                                             
         USING *,R6                XOUT NEEDS LOCAL ADDRESSABILITY              
         XOUT  SERNM,WORK,4                                                     
         DROP  R2,R6                                                            
         LA    R2,WORK             DATA FOUND                                   
         J     PARSE60                                                          
GETTNOX  J     PARSE99                                                          
         EJECT ,                                                                
*=====================================================================*         
* UK - Get BACEL values (index on PRSBASE)                                      
*=====================================================================*         
                                                                                
GETBACV  MVC   WORK,SPACES         ENSURE ALL SPACES                            
                                                                                
         USING TRSELD,R2                                                        
         ICM   R2,15,AELEM60                                                    
         JZ    GBACV00             NO TRSEL...?                                 
         TM    TRSSTAT,TRSSVOID                                                 
         JNZ   GETBACN             VOIDED, SKIP ANY PAYMENT DETS                
         TM    TRSSTAT2,TRSSPMNT                                                
         JZ    GETBACN             NOT A 5P PAYMENT                             
         TM    TRSSTAT2,TRSSMCHQ                                                
         JNZ   GETBACN             MAN CHQ MAY NOT UNSET 'PAYMENT' STS          
         USING BACELD,R2                                                        
GBACV00  L     R2,ADTRANS                                                       
         SR    R0,R0                                                            
GBACV02  IC    R0,BACLN                                                         
         AR    R2,R0                                                            
         CLI   BACEL,0                                                          
         JE    GETBACN                                                          
         CLI   BACEL,BACELQ                                                     
         JNE   GBACV02                                                          
         LH    RF,PARBASE                                                       
         AHI   RF,-PARC48          RELATIVE 0 - 3                               
         SLL   RF,2                *4                                           
         BASR  RE,0                                                             
         AR    RF,RE                                                            
         B     6(RF)                                                            
*                                                                               
         J     GBACV04                                                          
         J     GBACV06                                                          
         J     GBACV08                                                          
         J     GBACV10                                                          
*                                                                               
GBACV04  MVC   WORK(L'BACSORT),BACSORT                                          
         J     GETBACY                                                          
*                                                                               
GBACV06  MVC   WORK(L'BACCOUNT),BACCOUNT                                        
         J     GETBACY                                                          
*                                                                               
GBACV08  MVC   WORK(L'BACBNAME),BACBNAME                                        
         J     GETBACY                                                          
*                                                                               
GBACV10  SR    RF,RF                                                            
         IC    RF,BACLN                                                         
         AHI   RF,-(BACLNQ2+1)                                                  
         BASR  RE,0                                                             
         MVC   WORK(0),BACACNAM                                                 
         EX    RF,0(RE)                                                         
         J     GETBACY                                                          
         DROP  R2                                                               
                                                                                
GETBACY  LA    R2,WORK             DATA FOUND                                   
         J     PARSE60                                                          
GETBACN  J     PARSE99                                                          
         EJECT ,                                                                
*=====================================================================*         
* UK - Get EBDEL values (index on PRSBASE)                                      
*=====================================================================*         
                                                                                
GETEBDV  MVC   WORK,SPACES         ENSURE ALL SPACES                            
                                                                                
         USING TRSELD,R2                                                        
         ICM   R2,15,AELEM60                                                    
         JZ    *+12                NO TRSEL...?                                 
         TM    TRSSTAT,TRSSVOID                                                 
         JNZ   GETEBDN             VOIDED, SKIP ANY PAYMENT DETS                
         USING EBDELD,R2                                                        
         L     R2,ADTRANS                                                       
         SR    R0,R0                                                            
GEBDV02  IC    R0,EBDLN                                                         
         AR    R2,R0                                                            
         CLI   EBDEL,0                                                          
         JE    GETEBDN                                                          
         CLI   EBDEL,EBDELQ                                                     
         JNE   GEBDV02                                                          
         LH    RF,PARBASE                                                       
         AHI   RF,-PARC52          RELATIVE 0 - 1                               
         SLL   RF,2                *4                                           
         BASR  RE,0                                                             
         AR    RF,RE                                                            
         B     6(RF)                                                            
*                                                                               
         J     GEBDV04                                                          
         J     GEBDV06                                                          
*                                                                               
GEBDV04  MVC   WORK(L'EBDIBAN),EBDIBAN                                          
         J     GETEBDY                                                          
*                                                                               
GEBDV06  MVC   WORK(L'EBDBIC),EBDBIC                                            
         J     GETEBDY                                                          
         DROP  R2                                                               
                                                                                
GETEBDY  LA    R2,WORK             DATA FOUND                                   
         J     PARSE60                                                          
GETEBDN  J     PARSE99                                                          
         EJECT ,                                                                
*                                                                               
*=====================================================================*         
* UK - Get transaction reference_serial number (MARMAST)                        
*      This routine also set CURURLID used by URLID keyword and                 
*                            CURMEMNR used by MEMONR keyword                    
*=====================================================================*         
                                                                                
GETRSER  L     R2,ADTRANS                                                       
         USING TRNELD,R2                                                        
*                                                                               
         CLC   TRNREF,SPACES                                                    
         JNH   GETRSERX            NO TRX REF!!!                                
         MVC   WORK,SPACES         ENSURE ALL SPACES                            
         LA    RF,TRNREF+L'TRNREF-1                                             
         CLI   0(RF),C' '          SKIP ALL SPACES                              
         JH    *+12                                                             
         SHI   RF,1                                                             
         J     *-12                                                             
         LA    R1,TRNREF                                                        
         SR    RF,R1               RF = LENGTH OF REF - 1                       
         LA    R1,1(,RF)                                                        
         STC   R1,BYTE             SAVE LENGTH OF REF IN BYTE                   
*                                                                               
         CLC   PRVRSOFF,CUROFF     Test same office code                        
         JNE   GRSER02             No - get data                                
         CLC   PRVRSCUR,CURFCCDE   Test same currency code                      
         JNE   GRSER02             No - get data                                
         LH    R1,RECIDX#                                                       
         SHI   R1,1                                                             
         JNP   GRSER02             Get data if it's the first tx rec            
*                                                                               
         BASR  RE,0                                                             
         CLC   TRNREF(0),PRVRFSER  TEST SAME REF ON PREVIOUS TRANS              
         EX    RF,0(RE)                                                         
         JNE   GRSER02                                                          
         MVC   WORK(L'PRVRFSER),PRVRFSER     MERGE THIS TRANS (GRPMUK)          
         J     GRSER20                                                          
*                                                                               
GRSER02  MVC   WORK(L'TRNREF),TRNREF                                            
         MVC   BYTE1,TRNTYPE        SAVED TX TYPE                               
*                                                                               
         USING SERELD,R2           LOOK FOR TRX SERIAL EL                       
         ICM   R2,15,AELEMD5                                                    
         JZ    GRSER10             NO SEREL!!!                                  
         BASR  R6,0                                                             
         USING *,R6                XOUT NEEDS LOCAL ADDRESSABILITY              
         XOUT  SERNM,WORK+20,4                                                  
         LLC   RF,BYTE             LENTH OF RE                                  
         LA    RF,WORK(RF)                                                      
         MVI   0(RF),C'_'                                                       
         MVC   1(8,RF),WORK+20                                                  
*                                                                               
* Set URL ID used by keyword URLID - format ddmmyy_ttt_xxxxx (GRPMUK)           
* URLID only used in format MARMAST after REFSER                                
* ddmmyy is the added date - (eg 060116 being 6th Jan 2016)                     
* ttt is either 'FLX' (if TRNTYPE=7) or 'M14' (if TRNTYPE=9)                    
* XXXXX is the user id number in decimal held on the transaction                
         MVC   CURURLID,SPACES                                                  
         USING TRSELD,R2                                                        
         ICM   R2,15,AELEM60       LOOK FOR TRX STATUS EL                       
         JZ    GRSER10             NO - TRSEL!!!                                
         MVC   CUROMOA,TRSPMOS     ORIGINAL MOA                                 
*                                                                               
         CLI   BYTE1,TRNTCLBL      TEST FLEXIBILL                               
         JNE   *+14                                                             
         MVC   CURURLID+6(5),=C'_FLX_'                                          
         J     GRSER04                                                          
         CLI   BYTE1,TRNTMEBL      TEST MEDIA BILL                              
         JNE   GRSER10             NO - DONE                                    
         MVC   CURURLID+6(5),=C'_M14_'                                          
*                                                                               
GRSER04  GOTO1 DATCON,DMCB,(2,TRSDATE),(0,WORK+20)                              
         MVC   CURURLID(2),WORK+24   dd                                         
         MVC   CURURLID+2(2),WORK+22 mm                                         
         CLI   WORK+20,X'F9'       TEST >= X'FA'                                
         JNH   GRSER06                                                          
         LLC   RF,WORK+20                                                       
         SHI   RF,10               CONVERT TO X'F1' TO X'F9'                    
         STC   RF,WORK+20                                                       
GRSER06  MVC   CURURLID+4(2),WORK+20 yy                                         
         CURED TRSUSER,(5,CURURLID+11),0,ALIGN=LEFT                             
         DROP  R2,R6                                                            
*                                                                               
* Set MEMO NARR used by keyword MEMONR                                          
GRSER10  DS    0H                                                               
         MVC   CURMEMNR,SPACES                                                  
         ICM   R2,15,AELEM76                                                    
         JZ    GRSER20                                                          
         USING NOTELD,R2                                                        
         SR    RF,RF                                                            
GRSER12  CLI   NOTEL,0             END OF RECORD                                
         JE    GRSER20                                                          
         CLI   NOTEL,NOTELQ                                                     
         JNE   GRSER14                                                          
         CLI   NOTLN,NOTLN1Q                                                    
         JNH   GRSER14                                                          
         MVC   CURMEMNR,SPACES                                                  
         IC    RF,NOTLN                                                         
         SHI   RF,NOTLN1Q+1                                                     
         BASR  RE,0                                                             
         MVC   CURMEMNR(0),NOTNOTE                                              
         EX    RF,0(RE)                                                         
*                                                                               
GRSER14  IC    RF,NOTLN                                                         
         AR    R2,RF                                                            
         J     GRSER12                                                          
         DROP  R2                                                               
*                                                                               
GRSER20  LA    R2,WORK             RETURN DATA                                  
         MVC   PRVRFSER,WORK       SAVE REFSER DATA                             
         MVC   PRVRSOFF,CUROFF     SAVE OFFICE CODE                             
         MVC   PRVRSCUR,CURFCCDE   SAVE CURRENCY CODE                           
         J     PARSE60                                                          
*                                                                               
GETRSERX MVC   PRVRFSER,SPACES     CLEAR PREVIOUS DATA                          
         MVC   PRVRSOFF,SPACES                                                  
         MVC   PRVRSCUR,SPACES                                                  
         MVC   CURURLID,SPACES     CLEAR URLID                                  
         XC    CUROMOA,CUROMOA     CLEAR ORIGINAL MOA                           
         J     PARSE99                                                          
                                                                                
*=====================================================================*         
* UK - Get Foreign currency amount with shift (GRPMUK)                          
*=====================================================================*         
                                                                                
GETFCAS  CLC   CURFCCDE,SPACES     ANY CURRENCY CODE                            
         JNH   PARSE99                                                          
         ZAP   DUB,CURFCAMT                                                     
         CP    DUB,PKZERO          ZERO FC AMOUNT?                              
         JE    GFCAS08             YES - OK                                     
*                                                                               
         L     RF,AFCURY           A(CURTAB)                                    
         USING CURTABD,RF                                                       
GFCAS02  CLI   0(RF),0                                                          
         JE    PARSE99             Not found                                    
         CLC   CURTCUR,CURFCCDE    Match currency code                          
         JE    *+12                                                             
         AHI   RF,L'CURFCBLK                                                    
         J     GFCAS02                                                          
         LLC   RF,CURTDECP         NUMBER OF DECIMAL PLACE                      
*                                                                               
         CHI   RF,2                ARLEADY 2 DECIMALS?                          
         JE    GFCAS08             YES - OK                                     
         JL    GFCAS04                                                          
         SHI   RF,2                CURRENCY DECML > 2                           
         LA    R1,64                                                            
         SR    R1,RF               R1 = SHIFT RIGHT FACTOR TO 2 DECML           
         SRP   DUB,0(R1),5                                                      
         J     GFCAS08                                                          
*                                                                               
GFCAS04  LA    R1,2                CURRENCY DECML < 2                           
         SR    R1,RF               R1 = SHIFT LEFT FACTOR TO 2 DECML            
         SRP   DUB,0(R1),0                                                      
GFCAS08  LA    R2,DUB                                                           
         J     PARSE60                                                          
                                                                                
         EJECT ,                                                                
*=====================================================================*         
* UK - Get office group code                                                    
*=====================================================================*         
                                                                                
GETOFGC  CLC   CUROFF,SPACES       ANY OFFICE CODE                              
         JNH   PARSE99             NO - NO OFFICE GROUP CODE                    
         USING OGRRECD,R2                                                       
         LA    R2,IOKEY                                                         
         XC    OGRKEY,OGRKEY                                                    
         MVI   OGRKTYP,OGRKTYPQ    X'2C'                                        
         MVI   OGRKSUB,OGRKOFFQ    X'04' OFFICE RECORD                          
         MVC   OGRKCPY,RCCOMPFL                                                 
         MVC   OGRKUNT(L'CURSJ),CURSJ                                           
         MVC   OGRKOFC,CUROFF      OFFICE CODE                                  
         DROP  R2                                                               
         JAS   RE,READMRC                                                       
         JNE   PARSE99                                                          
*                                                                               
         SR    RF,RF                                                            
         L     R2,AIO2                                                          
         LA    R2,OGRRFST-OGRRECD(R2)                                           
         USING PGRELD,R2                                                        
GOFGC04  CLI   PGREL,0             EOR                                          
         JE    PARSE99                                                          
         CLI   PGREL,PGRELQ        X'A0' element                                
         JE    *+14                                                             
         IC    RF,PGRLN                                                         
         AR    R2,RF                                                            
         J     GOFGC04                                                          
*                                                                               
         LA    R2,PGRCODE          RETURN OFFICE GROUP CODE                     
         J     PARSE60                                                          
*                                                                               
*=====================================================================*         
* UK - Get account billing group code (GRPMUK)                                  
*=====================================================================*         
                                                                                
         USING SORELD,RF                                                        
GETBGA   ICM   RF,15,AELEM7B                                                    
         JZ    PARSE50             NO ELEMENT                                   
         MVC   WORK,SPACES                                                      
         CLI   SORSYS,SORSMED      MEDIA SYSTEM?                                
         JNE   *+14                NO                                           
         MVC   WORK(L'SORMCLI),SORMCLI                                          
         J     GBGA02                                                           
         CLC   CURSJ,SORAUNT       SJ SOURCE ACCOUNT?                           
         JNE   PARSE50             NO                                           
         LLC   R1,SJCLILEN         Length of client                             
         SHI   R1,1                                                             
         BASR  RE,0                                                             
         MVC   WORK(0),SORAACT                                                  
         EX    R1,0(RE)                                                         
*                                                                               
         USING ACTRECD,R2                                                       
GBGA02   LA    R2,IOKEY2                                                        
         MVC   IOKEY2,SPACES                                                    
         MVC   ACTKCPY,CURACC      Company code                                 
         MVC   ACTKUNT(L'CURSJ),CURSJ                                           
         MVC   ACTKACT,WORK                                                     
         DROP  R2,RF                                                            
*                                                                               
         JAS   RE,READREC                                                       
         JNE   PARSE50                                                          
*                                                                               
         USING PPRELD,RF                                                        
         L     RF,AIO2                                                          
         AH    RF,DATADISP                                                      
         SR    R1,R1                                                            
GBGA04   CLI   PPREL,0             EOR                                          
         JE    PARSE50                                                          
         CLI   PPREL,PPRELQ        X'24' element                                
         JE    *+14                                                             
         IC    R1,PPRLN                                                         
         AR    RF,R1                                                            
         J     GBGA04                                                           
*                                                                               
         LA    R2,PPRGRUP          RETURN BILLING GROUP CODE                    
         J     PARSE60                                                          
         DROP  RF                                                               
                                                                                
*=====================================================================*         
* UK - Get billing group code using level 2 SR a/c code (GRPMUK)                
*=====================================================================*         
                                                                                
GETBGAC  GOTOR GETLDGR,DMCB,QUNIT                                               
         USING LDGD,RF                                                          
         L     RF,DMCB             Ledger entry                                 
         CLI   LDGLEV3,12          MAKE SURE IT'S 3 LEVELS SR                   
         JNE   PARSE99             NO                                           
         LLC   RE,LDGLEV2                                                       
         LLC   R1,LDGLEV1                                                       
         SR    RE,R1               RE = LENGTH OF LEVEL 2                       
         CLM   RE,1,SJCLILEN       MAKE SURE LEVEL 2 IS CLIENT CODE             
         JNE   PARSE99                                                          
         AHI   R1,3                R1 POINTING TO LEVEL 2 SR A/C CODE           
         DROP  RF                                                               
*                                                                               
         USING ACTRECD,R2                                                       
         LA    RF,CURACC(R1)       RF =  LEVEL 2 SR A/C CODE                    
         LA    R2,IOKEY2                                                        
         MVC   IOKEY2,SPACES                                                    
         MVC   ACTKCPY,CURACC      Company code                                 
         MVC   ACTKUNT(L'CURSJ),CURSJ                                           
         LLC   R1,SJCLILEN         Length of client                             
         SHI   R1,1                                                             
         BASR  RE,0                                                             
         MVC   ACTKACT(0),0(RF)    LEVEL 2 SR A/C CODE                          
         EX    R1,0(RE)                                                         
         DROP  R2                                                               
*                                                                               
         JAS   RE,READREC                                                       
         JNE   PARSE99                                                          
*                                                                               
         L     RF,AIO2                                                          
         AH    RF,DATADISP                                                      
         USING PPRELD,RF                                                        
         SR    R1,R1                                                            
GBGAC04  CLI   PPREL,0             EOR                                          
         JE    PARSE99                                                          
         CLI   PPREL,PPRELQ        X'24' element                                
         JE    *+14                                                             
         IC    R1,PPRLN                                                         
         AR    RF,R1                                                            
         J     GBGAC04                                                          
*                                                                               
         LA    R2,PPRGRUP          RETURN BILLING GROUP CODE                    
         J     PARSE60                                                          
         DROP  RF                                                               
*                                                                               
*=====================================================================*         
* UK - Get item description (leger SJ and 1R only)                              
*=====================================================================*         
                                                                                
         USING PARWRKD,R7                                                       
GETIDES  DS    0H                                                               
         CLI   QPROG,PRODUCTION    Production Scribe ?                          
         JNE   GDES02                                                           
         ICM   R2,15,AELEM59       ANY ITEM ELEMENT?                            
         JZ    PARSE99                                                          
         LA    R2,ARTSEQ-ARTELD(R2)                                             
         J     GDES04                                                           
*                                                                               
GDES02   CLI   QPROG,MANPOWER      PERSON SCRIBE ?                              
         JNE   PARSE99                                                          
         ICM   R2,15,AELMTM30      ANY ITEM ELEMENT?                            
         JZ    PARSE99                                                          
         LA    R2,TIMISEQ-TIMELD(R2)                                            
*                                                                               
T        USING PASRECD,IOKEY                                                    
GDES04   XC    T.PASKEY,T.PASKEY                                                
         MVI   T.PASKTYP,PASKTYPQ                                               
         MVI   T.PASKSUB,PASKSQ                                                 
         MVC   T.PASKCPY,RCCOMPFL                                               
         MVC   T.PASKSEQ,0(R2)     R2 POINTS TO ITEM SEQ#                       
         DROP  T                                                                
*                                                                               
         JAS   RE,READMRC                                                       
         JNE   PARSE99                                                          
*                                                                               
         XR    R1,R1                                                            
         L     RF,AIO2                                                          
         LA    RF,ARTRFST-ARTRECD(RF)                                           
         USING NAMELD,RF                                                        
GDES06   CLI   NAMEL,0             EOR                                          
         JE    PARSE99                                                          
         CLI   NAMEL,NAMELQ        X'20' ELEMENT                                
         JE    *+14                                                             
         IC    R1,NAMLN                                                         
         AR    RF,R1                                                            
         J     GDES06                                                           
*                                                                               
         IC    R1,NAMLN                                                         
         SHI   R1,NAMLN1Q          R1 = SHOULD BE LENGTH OF NAME                
         JNP   PARSE99             BAD NAME ELEMENT                             
         STH   R1,PARNEWLN         SAVE LENGTH OF NAME                          
         LA    R2,NAMEREC          RETURN ITEM DESCRIPTION                      
         J     PARSE60                                                          
         DROP  R7,RF                                                            
                                                                                
*=====================================================================*         
* UK - Get transaction ref_ser number for CASH format (GRPMUK)                  
*=====================================================================*         
                                                                                
         USING PARWRKD,R7                                                       
GETTYID  DS    0H                                                               
         MVC   WORK,SPACES                                                      
         ICM   RF,15,AELEMD9       TEST RECEIVABLE ALLOACTION                   
         JZ    GTTYID02            NO - IT'S A JOURNAL                          
         MVI   WORK,C'C'           OUTPUT CASH                                  
         USING RALELD,RF                                                        
         CLI   RALTYPE,RALTALC     REGULAR ALLOCATION (CASH)                    
         JE    *+8                                                              
GTTYID02 MVI   WORK,C'A'           OUTPUT ADJUSTMENT                            
*                                                                               
         XC    PARNEWLN,PARNEWLN                                                
         MVI   PARNEWLN+1,1                                                     
         LA    R2,WORK             R2 Passed back from routine                  
         J     PARSE60                                                          
         DROP  R7,RF                                                            
                                                                                
*=====================================================================*         
* UK - Get receipt number (GRPMUK)                                              
*=====================================================================*         
                                                                                
         USING PARWRKD,R7                                                       
GETRCTN  DS    0H                                                               
         MVC   WORK(6),SPACES                                                   
         BASR  R6,0                                                             
         USING *,R6                NEEDS LOCAL ADDRESSABILITY                   
         GOTOR PARSE,DMCB,PARADDR,WORK,0   Get Cheque number                    
         JE    *+10                                                             
         MVC   WORK(6),=C'ADJ   '  Default to 'ADJ' if no CNUM                  
*                                                                               
         LA    R2,WORK             R2 Passed back from routine                  
         J     PARSE60                                                          
         DROP  R6,R7                                                            
         EJECT ,                                                                
*=====================================================================*         
* UK - Get operation code for CASH format (GRPMUK)                              
*=====================================================================*         
                                                                                
         USING PARWRKD,R7                                                       
GETOPCD  DS    0H                                                               
         MVC   WORK,SPACES                                                      
         MVI   WORK,C'0'           OUTPUT DEFAULT                               
         ICM   RF,15,AELEMD9       TEST RECEIVABLE ALLOACTION                   
         JZ    GOPCD10             NO - IT'S A JOURNAL                          
         USING RALELD,RF                                                        
         CLI   RALTYPE,RALTALC     REGULAR ALLOCATION (CASH)                    
         JNE   GOPCD04                                                          
         CLI   RALLN,RALALC2Q                                                   
         JL    GOPCD10                                                          
         TM    RALAINDS,RALAISPC   SPECIAL ITEM?                                
         JZ    GOPCD10                                                          
         MVI   WORK,C'4'                                                        
GOPCD04  CLI   RALTYPE,RALTWOF     WRITTEN-OFF                                  
         JNE   *+8                                                              
         MVI   WORK,C'1'                                                        
         CLI   RALTYPE,RALTTTO     TRANSFERRED TO                               
         JE    *+12                                                             
         CLI   RALTYPE,RALTTFR     TRANSFERRED FROM                             
         JNE   GOPCD10                                                          
         MVI   WORK,C'9'                                                        
*                                                                               
GOPCD10  XC    PARNEWLN,PARNEWLN                                                
         MVI   PARNEWLN+1,1                                                     
         LA    R2,WORK             R2 Passed back from routine                  
         J     PARSE60                                                          
         DROP  R7,RF                                                            
         EJECT ,                                                                
*&&                                                                             
*=====================================================================*         
*  Get calendar period and month based on transaction date            *         
*=====================================================================*         
         USING CDRD,RE                                                          
GETCPED  L     RE,ACNDRWRK                                                      
         OC    TRANDTE,TRANDTE     Is the date set ?                            
         JZ    PARSE99             No, so can't process                         
                                                                                
         USING CPRCNDRD,R2                                                      
         L     R2,ACNDRBLK                                                      
         MVC   CPROF,PRSNOFF       Person's office code                         
         MVC   CPRYMD,TRANDTE      Start with this year                         
*        MVI   CPRACT,CPRLOCD      Get location detail in calendar              
         GOTOR AGETCNDR,DMCB,ACNDRBLK,80                                        
         JE    GETCP05                                                          
         TM    CPRERR,CPRNF        Record not found ?                           
         JZ    GETCP05                                                          
         DC    H'00'                                                            
                                                                                
GETCP05  L     RE,ACNDRWRK         Re-load                                      
                                                                                
GETCP10  CLC   TRANDTE,CDRSDATE                                                 
         JNL   *+6                                                              
         DC    H'00'                                                            
         CLC   TRANDTE,CDREDATE                                                 
         JNH   GETCP20                                                          
         LA    RE,CDRLNQ(,RE)                                                   
         J     GETCP10                                                          
         DROP  R2                                                               
*                                                                               
GETCP20  LA    R2,CDRMOA+1         Month                                        
         CLI   PARELEM,C'M'        Month number                                 
         JE    PARSE60                                                          
         LA    R2,CDRMOA           Year                                         
         CLI   PARELEM,C'Y'        Month number                                 
         JE    PARSE60                                                          
         LA    R2,CDRPRD#          Period #                                     
         J     PARSE60                                                          
         DROP  RE                                                               
         EJECT ,                                                                
***********************************************************************         
*  APPEND DEFAULT MEDIA ONTO REF # FOR LBILL KEYWORD FOR TY 6 RCV'S   *         
*  X-YM-1234                                                          *         
***********************************************************************         
         SPACE 1                                                                
         USING PARWRKD,R7                                                       
         USING TRNELD,R2                                                        
LBILRF6  CLC   0(6,R2),SPACES      Is there a ref #?                            
         JNH   PARSE45             No                                           
         XC    WORK,WORK                                                        
         MVC   WORK(1),CURMDC                                                   
         MVI   WORK+1,C'-'                                                      
         MVC   WORK+2(2),0(R2)     Move in ym portion                           
         MVI   WORK+4,C'-'                                                      
         MVC   WORK+5(4),2(R2)     Move in ref portion                          
         LA    R2,WORK                                                          
         LHI   R1,9                                                             
         STH   R1,PARNEWLN         Set new overide length                       
         J     PARSE60             Continue parseing                            
         DROP  R2,R7                                                            
         EJECT ,                                                                
***********************************************************************         
*  Construct LBILL for old type 9's                                   *         
*  XX-12-3456 if system and media defined on b1 profile                         
*  X-12-3456 if system/or media defined on b1 profile                           
*  X-12-3456 uses default media code                                            
***********************************************************************         
         SPACE 1                                                                
         USING PARWRKD,R7                                                       
LBILRF9  MVC   WORK,SPACES                                                      
         LA    RE,WORK                                                          
         MVI   BYTE1,NO                                                         
         SR    R1,R1               Keep count of length                         
                                                                                
         USING FFTELD,RF                                                        
         L     RF,ADTRANS                                                       
         SR    R0,R0                                                            
LBRF910  CLI   FFTEL,0                                                          
         JE    LBRF940                                                          
         CLI   FFTEL,FFTELQ       Test freeform text element?                   
         JNE   LBRF920                                                          
         CLI   FFTTYPE,FFTTMTRA   Redefined system/media                        
         JE    LBRF930                                                          
LBRF920  IC    R0,FFTLN                                                         
         AR    RF,R0                                                            
         J     LBRF910                                                          
*                                                                               
LBRF930  CLI   FFTRSYS,C' '                                                     
         JNH   LBRF935                                                          
         MVC   0(L'FFTRSYS,RE),FFTRSYS     Move in system                       
         AHI   R1,L'FFTRSYS                                                     
         AHI   RE,L'FFTRSYS                                                     
         MVI   BYTE1,YES                   Mark as found                        
LBRF935  CLI   FFTRMED,C' '                                                     
         JNH   LBRF940                                                          
         MVC   0(L'FFTRMED,RE),FFTRMED     Move in media                        
         AHI   R1,L'FFTRMED                                                     
         AHI   RE,L'FFTRMED                                                     
         MVI   BYTE1,YES                   Mark as found                        
         DROP  RF                                                               
*                                                                               
         USING TRNELD,RF                                                        
LBRF940  L     RF,ADTRANS                                                       
         CLI   BYTE1,YES                   Found system/media?                  
         JE    LBRF950                                                          
         MVC   0(1,RE),CURMDC              No so move in media code             
         MVI   1(RE),C'-'                                                       
         AHI   RE,2                                                             
         AHI   R1,2                                                             
         J     LBRF960                                                          
*                                                                               
LBRF950  MVI   0(RE),C'-'                                                       
         AHI   RE,1                                                             
         AHI   R1,1                                                             
LBRF960  MVC   0(2,RE),TRNREF                                                   
         MVI   2(RE),C'-'                                                       
         MVC   3(4,RE),TRNREF+2                                                 
         AHI   R1,L'TRNREF+1       REF LENGTH +1 FOR HYPHEN                     
         STH   R1,PARNEWLN         Set new overide length                       
         LA    R2,WORK                                                          
         J     PARSE60             Continue parseing                            
         DROP  R7,RF                                                            
         SPACE 2                                                                
         LTORG                                                                  
         EJECT ,                                                                
***********************************************************************         
*  Construct LBLLND for old type 9's                                  *         
*  XX123456 if system and media defined on b1 profile                           
*  X123456 if system/or media defined on b1 profile                             
*  X123456 uses default media code                                              
***********************************************************************         
         SPACE 1                                                                
         USING PARWRKD,R7                                                       
LBL2RF9  MVC   WORK,SPACES                                                      
         LA    RE,WORK                                                          
         MVI   BYTE1,NO                                                         
         SR    R1,R1               Keep count of length                         
                                                                                
         USING FFTELD,RF                                                        
         L     RF,ADTRANS                                                       
         SR    R0,R0                                                            
LBL2910  CLI   FFTEL,0                                                          
         JE    LBL2940                                                          
         CLI   FFTEL,FFTELQ       Test freeform text element?                   
         JNE   LBL2920                                                          
         CLI   FFTTYPE,FFTTMTRA   Redefined system/media                        
         JE    LBL2930                                                          
LBL2920  IC    R0,FFTLN                                                         
         AR    RF,R0                                                            
         J     LBL2910                                                          
*                                                                               
LBL2930  CLI   FFTRSYS,C' '                                                     
         JNH   LBL2935                                                          
         MVC   0(L'FFTRSYS,RE),FFTRSYS     Move in system                       
         AHI   R1,L'FFTRSYS                                                     
         AHI   RE,L'FFTRSYS                                                     
         MVI   BYTE1,YES                   Mark as found                        
LBL2935  CLI   FFTRMED,C' '                                                     
         JNH   LBL2940                                                          
         MVC   0(L'FFTRMED,RE),FFTRMED     Move in media                        
         AHI   R1,L'FFTRMED                                                     
         AHI   RE,L'FFTRMED                                                     
         MVI   BYTE1,YES                   Mark as found                        
         DROP  RF                                                               
*                                                                               
         USING TRNELD,RF                                                        
LBL2940  L     RF,ADTRANS                                                       
         CLI   BYTE1,YES                   Found system/media?                  
         JE    LBL2950                                                          
         MVC   0(1,RE),CURMDC              No so move in media code             
         AHI   RE,1                                                             
         AHI   R1,1                                                             
         J     LBL2950                                                          
*                                                                               
LBL2950  MVC   0(L'TRNREF,RE),TRNREF                                            
         AHI   R1,L'TRNREF         REF LENGTH +1 FOR HYPHEN                     
         STH   R1,PARNEWLN         Set new overide length                       
         LA    R2,WORK                                                          
         J     PARSE60             Continue parseing                            
         DROP  R7,RF                                                            
         LTORG                                                                  
         EJECT ,                                                                
***********************************************************************         
*  APPEND DEFAULT MEDIA ONTO REF # FOR LBLLND KEYWORD FOR TY 6 RCV'S  *         
***********************************************************************         
         SPACE 1                                                                
         USING PARWRKD,R7                                                       
         USING TRNELD,R2                                                        
LBL2RF6  CLC   0(6,R2),SPACES      Is there a ref #?                            
         JNH   PARSE45             No                                           
         XC    WORK,WORK                                                        
         MVC   WORK(1),CURMDC                                                   
         MVC   WORK+1(2),0(R2)     Move in ym portion                           
         MVC   WORK+3(4),2(R2)     Move in ref portion                          
         LA    R2,WORK                                                          
         LHI   R1,7                                                             
         STH   R1,PARNEWLN         Set new overide length                       
         J     PARSE60             Continue parseing                            
         DROP  R2,R7                                                            
         EJECT ,                                                                
***********************************************************************         
* Get reversed status (Yes/No)                                                  
***********************************************************************         
         SPACE 1                                                                
         USING ACRL2D,RF                                                        
GETRSTA  L     RF,AACRL2D                                                       
         MVC   BYTE,PARTEST                                                     
         MVC   WORK,SPACES                                                      
         MVC   WORK(L'AC@NO),AC@NO                                              
         NC    BYTE,0(R2)                                                       
         JNZ   *+10                                                             
         MVC   WORK(L'AC@YES),AC@YES                                            
         LA    R2,WORK                                                          
         J     PARSE60             MOVE IN DATA                                 
         DROP  RF                                                               
         EJECT ,                                                                
*&&UK                                                                           
***********************************************************************         
* Get Timesheet (reversed)                                                      
***********************************************************************         
         SPACE 1                                                                
         USING RSTELD,R8                                                        
         USING ACRL2D,RF                                                        
GETTIMSH L     RF,AACRL2D                                                       
         MVC   WORK(L'AC@YES),AC@YES   Default                                  
         CLI   RSTLN,RSTLN2Q                                                    
         JNH   GTIMSH02                Show 'Yes' if short element              
         TM    RSTSTAT5,RSTSNOTS                                                
         JNO   GTIMSH02                                                         
         MVC   WORK(L'AC@NO),AC@NO                                              
GTIMSH02 LA    R2,WORK                                                          
         J     PARSE60                  MOVE IN DATA                            
         DROP  RF                                                               
         EJECT ,                                                                
*&&                                                                             
*&&US                                                                           
***********************************************************************         
*  If % of estimate bit set                                                     
*  get amount from B2 element and apply the sign from the TRNAMNT               
*  This is due to a bug in production billing that does not show                
*  the amt in the B2 as a negative in the case of a reversal bill.              
***********************************************************************         
         SPACE 1                                                                
         USING PARWRKD,R7                                                       
B2AMT    DS    0H                                                               
         BRAS  RE,ADJB2AMT                                                      
         BNE   PARSE45                                                          
         B     PARSE60                                                          
         EJECT ,                                                                
***********************************************************************         
*  If doing workcode breakout (For Future Use profile)                          
*  get workcode from B2 element and look up workcode type.  This is to          
*  allow workcode type column filtering b/c when column filters are             
*  applied the workcode is 99 so the wc type is blank.                          
***********************************************************************         
         SPACE 1                                                                
         USING PARWRKD,R7                                                       
B2WCTYP  TM    PARCNTRL,PARBYWC                                                 
         JZ    PARSE45                                                          
*                                                                               
         USING WCOELD,RF                                                        
         L     RF,WCSBASE                                                       
B2WCT10  CLI   0(RF),0             END OF RECORD?                               
         JE    PARSE60                                                          
*                                                                               
B2WCT20  LA    RF,2(,RF)           BUMP PASE UNIT/LEDGER THAT IS STORED         
         CLI   0(RF),WCOELQ        X'12' WORKCODE ELEMENT                       
         JNE   *+10                                                             
         CLC   WCOCODE,0(R2)       CURRENT WC JUST PARSED FROM B2               
         JE    B2WCT30                                                          
         ZIC   R1,WCOLN                                                         
         AR    RF,R1                                                            
         J     B2WCT10                                                          
*                                                                               
B2WCT30  MVC   CURWCTY,WCOTYPE                                                  
         CLI   CURWCTY,C' '                                                     
         JNE   PARSE60                                                          
         MVI   CURWCTY,C'O'         O is the default                            
         J     PARSE60                                                          
         DROP  R7,RF                                                            
         EJECT ,                                                                
***********************************************************************         
*  Show the correct system/media code for Net                                   
*  R2 points to the MDTSYS in the X'1A' element                                 
***********************************************************************         
         SPACE 1                                                                
SM2CFX   BRAS  RE,RTSM2C            If system is Spot and media is              
         BNE   PARSE45                                                          
         B     PARSE60                                                          
***********************************************************************         
*  Fix client name for Mindshare client MFC for SP/SZ keywords                  
*  CAC,BOTH / CAC,NAME / CAN / CC,BOTH / CC,NAME                                
***********************************************************************         
         SPACE 1                                                                
NAMEFX   BRAS  RE,RTNMEFX                                                       
         B     PARSE60                                                          
         SPACE 2                                                                
         LTORG                                                                  
*&&                                                                             
***********************************************************************         
*  Get pid name from security file using pid from x'D8' element                 
*  and security alpha from requestor or cross file alpha (XPYAGY)               
***********************************************************************         
         SPACE 1                                                                
PIDN     BRAS  RE,RTNPIDN                                                       
         B     PARSE60                                                          
         SPACE 2                                                                
         LTORG                                                                  
*&&UK                                                                           
***********************************************************************         
*  Get pid person name from security file using pin from x'D8' element          
*  and security alpha from requestor                                            
***********************************************************************         
         SPACE 1                                                                
PIDPNAM  BRAS  RE,RTNPIDN          GET 8-CHAR PID FIRST                         
         BRAS  RE,RTNPNAM                                                       
         B     PARSE60                                                          
         SPACE 2                                                                
         LTORG                                                                  
***********************************************************************         
* VALIDATE IF IT'S A COUNTRY CODE                                               
***********************************************************************         
         SPACE 1                                                                
GETCTRY  CLC   PARTEST,0(R8)       COMPARE VALID COUNTRY CODE ELEMENT           
         JNE   PARSE45             NO - GET NEXT ENTRY                          
*                                                                               
         MVC   HALF,0(R2)                                                       
         GOTOR VALCTRY,DMCB,(R3),(0,HALF)                                       
         JNE   PARSE45             No data                                      
         J     PARSE60                                                          
         EJECT ,                                                                
***********************************************************************         
* VALIDATE IF IT'S A COUNTRY CODE                                               
***********************************************************************         
         SPACE 1                                                                
         USING CPJELD,R8                                                        
GETSOAC  MVC   WORK,SPACES                                                      
         CLI   CPJTYPE,CPJTOTH     TEST OTHER SOURCE ACCOUNT                    
         JNE   *+14                                                             
         MVC   WORK(L'CPJOULA),CPJOULA                                          
         J     GETSOACX                                                         
*                                                                               
         CLI   CPJTYPE,CPJTEXP     TEST EXPENSE ACCOUNT (SE)                    
         JNE   GETSOAC2                                                         
         MVI   WORK,C'S'                                                        
         MVI   WORK+1,C'E'                                                      
         MVC   WORK+2(L'CPJEXP),CPJEXP                                          
         J     GETSOACX                                                         
*                                                                               
GETSOAC2 CLI   CPJTYPE,CPJTJOB     TEST PRODUCTION JOB (SJ)                     
         JNE   PARSE90             DATA FOUND, EXIT                             
         MVC   WORK(L'CURSJ),CURSJ                                              
         MVC   WORK+L'CURSJ(L'CPJCLI),CPJCLI                                    
         LA    RF,WORK+L'CURSJ                                                  
         AH    RF,SJPRDDSP         -> PRODUCT                                   
         MVC   0(L'CPJPRO,RF),CPJPRO                                            
         LA    RF,WORK+L'CURSJ                                                  
         AH    RF,SJJOBDSP         -> JOB                                       
         MVC   0(L'CPJJOB,RF),CPJJOB                                            
*                                                                               
GETSOACX LA    R2,WORK                                                          
         J     PARSE60                                                          
         DROP  R8                                                               
         LTORG                                                                  
         EJECT ,                                                                
***********************************************************************         
* Validate Extra Data Name(s) and Value(s)                                      
***********************************************************************         
         SPACE 1                                                                
GETXDAT  GOTOR GTXDAT,DMCB,(R7),(R8)                                            
         JL    PARSE45                                                          
         JH    PARSE50                                                          
         J     PARSE60             R2 Passed back from routine                  
         SPACE 1                                                                
*&&                                                                             
***********************************************************************         
*&&US                                                                           
***********************************************************************         
         SPACE 1                                                                
PODTA    BRAS  RE,RTNPOD                                                        
         BNE   PARSE45                                                          
         B     PARSE60                                                          
         SPACE 2                                                                
         LTORG                                                                  
***********************************************************************         
***********************************************************************         
*  Set EFT/Check/CCARD payment method bit for pay scribe              *         
*  The original credit for payables does not store the payment method *         
*  If not EFT show 'Check' for debits and blank for credits           *         
***********************************************************************         
         SPACE 1                                                                
VPYMTHP  MVI   BYTE,0                                                           
         USING TRNELD,RF                                                        
         L     RF,ADTRANS                                                       
         MVC   BYTE1,TRNSTAT      Save DR/CR status                             
         DROP  RF                                                               
*                                                                               
         USING MPYELD,RF                                                        
         SR    R0,R0                                                            
VPYP10   CLI   MPYEL,0                                                          
         JE    VPYP30                                                           
         CLI   MPYEL,MPYELQ       Manual payment element (x'64')                
         JE    VPYP20                                                           
         IC    R0,MPYLN                                                         
         AR    RF,R0                                                            
         J     VPYP10                                                           
*                                                                               
VPYP20   CLI   MPYLN,MPYLN4Q                                                    
         JL    VPYP30                                                           
         TM    MPYBYTE,MPYEFT                                                   
         JZ    *+12                                                             
         OI    BYTE,MPYEFT                                                      
         J     VPYP40                                                           
*&&US                                                                           
         TM    MPYBYTE,MPYPCRD                                                  
         JZ    *+12                                                             
         OI    BYTE,MPYPCRD                                                     
         J     VPYP40                                                           
*                                                                               
         TM    MPYBYTE,MPYCCRD                                                  
         JZ    *+12                                                             
         OI    BYTE,MPYCCRD                                                     
         J     VPYP40                                                           
*&&                                                                             
VPYP30   TM    BYTE1,TRNSDR       Is this a debit?                              
         JZ    VPYP40                                                           
         OI    BYTE,X'40'                                                       
VPYP40   LA    R2,BYTE                                                          
         J     PARSE60                                                          
         DROP  RF                                                               
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*  Set EFT/Check payment method bit for pay scribe                              
*  The original credit for payables does not store the payment method *         
*  If not EFT show 'Check' for debits and blank for credits                     
***********************************************************************         
         SPACE 1                                                                
VPYMTHC  MVI   BYTE,0                                                           
         USING CEDELD,RF                                                        
         L     RF,ADTRANS                                                       
*                                                                               
         SR    R0,R0                                                            
VPYC10   CLI   CEDEL,0                                                          
         JE    VPYC30                                                           
         CLI   CEDEL,CEDELQ       Check extra detail elem (x'8a')               
         JE    VPYC20                                                           
         IC    R0,CEDLN                                                         
         AR    RF,R0                                                            
         J     VPYC10                                                           
*                                                                               
VPYC20   CLI   CEDLN,CEDLN2Q                                                    
         JL    VPYC30                                                           
         TM    CEDBYTE,CEDEFT                                                   
         JZ    *+12                                                             
         OI    BYTE,CEDEFT                                                      
         J     VPYC40                                                           
*&&US                                                                           
         TM    CEDBYTE,CEDPCRD                                                  
         JZ    *+12                                                             
         OI    BYTE,CEDPCRD                                                     
         J     VPYC40                                                           
*                                                                               
         TM    CEDBYTE,CEDCCRD                                                  
         JZ    *+12                                                             
         OI    BYTE,CEDCCRD                                                     
         J     VPYC40                                                           
*&&                                                                             
VPYC30   OI    BYTE,X'40'                                                       
*                                                                               
VPYC40   LA    R2,BYTE                                                          
         J     PARSE60                                                          
         DROP  RF                                                               
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*  Set freelancer status for person scribe                                      
*  B=BrandOcean freelancer, Y=non-BrandOcean freelancer                         
***********************************************************************         
         SPACE 1                                                                
         USING LOCELD,RF                                                        
VFRLST   MVI   BYTE,C' '                                                        
         L     RF,AELEM83                                                       
         LTR   RF,RF                                                            
         JZ    VFRLSTX                                                          
         TM    LOCATTR,LOCBFRL       BrandOcean freelance location?             
         JZ    *+12                                                             
         MVI   BYTE,C'B'                                                        
         J     VFRLSTX                                                          
         TM    LOCATTR,LOCYFRL       non-BrandOcean freelance location?         
         JZ    VFRLSTX                                                          
         MVI   BYTE,C'Y'                                                        
*                                                                               
VFRLSTX  LA    R2,BYTE                                                          
         J     PARSE60                                                          
         DROP  RF                                                               
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*&&                                                                             
*&&UK                                                                           
***********************************************************************         
*  GET EQUIVALENT NAME                                                *         
***********************************************************************         
         SPACE 1                                                                
GETEQNM  GOTOR GETENM,DMCB,(R3),(R7)                                            
         JNE   PARSE45             No data                                      
         J     PARSE60                                                          
         EJECT ,                                                                
                                                                                
***********************************************************************         
*  GET COUNTRY NAME                                                   *         
***********************************************************************         
         SPACE 1                                                                
GETCTYNM GOTOR PARSE,DMCB,PARADDR,HALF,0,0                                      
         JNE   PARSE45                     No data found                        
*                                                                               
         GOTOR VALCTRY,DMCB,(R3),(1,HALF)                                       
         JNE   PARSE45             No data                                      
         J     PARSE60                                                          
         EJECT ,                                                                
                                                                                
***********************************************************************         
*  GET ISO COUNTRY NAME                                               *         
***********************************************************************         
         SPACE 1                                                                
GETISCTN GOTOR PARSE,DMCB,PARADDR,HALF,0,0                                      
         JNE   PARSE45                     No data found                        
*                                                                               
         GOTOR VALISCT,DMCB,(R3),(1,HALF)                                       
         JNE   PARSE45             No data                                      
         J     PARSE60                                                          
         EJECT ,                                                                
                                                                                
***********************************************************************         
*  GET VAT NUMBER                                                     *         
***********************************************************************         
         SPACE 1                                                                
GETVATNM GOTOR GETVNM,DMCB,ADHEIRB,(R3),(R7)                                    
         JE    PARSE60             VAT NUMBER FOUND AT PRODUCT LEVEL            
         JL    PARSE45             DONE IF CC = LOW                             
*                                                                               
         GOTOR GETVNM,DMCB,ADHEIRA,(R3),(R7)                                    
         JE    PARSE60             VAT NUMBER FOUND AT CLIENT LEVEL             
         J     PARSE45             NO VAT NUMBER FOUND                          
         EJECT ,                                                                
                                                                                
***********************************************************************         
*  GET COUNTRY CODE                                                   *         
***********************************************************************         
         SPACE 1                                                                
GETCTYCD GOTOR GETCCD,DMCB,ADHEIRB,(R3),(R7)                                    
         JE    PARSE60             COUNTRY CODE FOUND AT PRODUCT LEVEL          
         JL    PARSE45             DONE IF CC = LOW                             
*                                                                               
         GOTOR GETCCD,DMCB,ADHEIRA,(R3),(R7)                                    
         JE    PARSE60             COUNTRY CODE FOUND AT CLIENT LEVEL           
         J     PARSE45             NO COUNTRY CODE FOUND                        
         EJECT ,                                                                
                                                                                
***********************************************************************         
*  GET JOB DESCRIPTION FROM AEXRECD                                   *         
***********************************************************************         
         SPACE 1                                                                
GETJDES  GOTOR GETJDS,DMCB,(R3),(R7)                                            
         JE    PARSE60                                                          
         J     PARSE45             No data                                      
         EJECT ,                                                                
*&&                                                                             
*=====================================================================*         
*  Validate publication or rep code                                   *         
*=====================================================================*         
                                                                                
VALREPC  CLC   CURACC+8(3),SPACES  ELSE REPC KEYWORD                            
         JNE   PARSE90                                                          
         CLI   PARELEM,1           IF = 1 THEN SP OR SQ LEDGER                  
         JE    PARSE60                                                          
         CLC   CURSUBAC+3(3),SPACES   ELSE SS, ST OR SU                         
         JNE   PARSE60                                                          
         J     PARSE90             MUST BE STATION                              
         EJECT ,                                                                
         LTORG                                                                  
***********************************************************************         
***********************************************************************         
         SPACE 1                                                                
RTSM2C   NTR1  BASE=*,LABEL=*                                                   
         CLI   0(R2),C'S'           If system is Spot and media is              
         JNE   RTSM2L               N,C,S,D or O then change system             
         CLI   1(R2),C'N'           to print as Net                             
         JE    RTSM10                                                           
         CLI   1(R2),C'C'                                                       
         JE    RTSM10                                                           
         CLI   1(R2),C'S'                                                       
         JE    RTSM10                                                           
         CLI   1(R2),C'D'                                                       
         JE    RTSM10                                                           
         CLI   1(R2),C'O'                                                       
         JNE   RTSM2L                                                           
*                                                                               
RTSM10   XC    WORK,WORK                                                        
         MVI   WORK,C'N'                                                        
         MVC   WORK+1(1),1(R2)                                                  
         LA    R2,WORK                                                          
         J     RTSM2E                                                           
*                                                                               
RTSM2L   CLI   *,X'FF'             SET CC = LOW                                 
         J     RTSM2X                                                           
RTSM2E   CR    RB,RB               SET CC = EQUAL                               
RTSM2X   XIT1  REGS=(R2)                                                        
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
***********************************************************************         
         SPACE 1                                                                
         USING ACMD,RF                                                          
         USING PARWRKD,R7                                                       
RTNMEFX  NTR1  BASE=*,LABEL=*                                                   
         L     RF,AMONACC                                                       
         CLC   ACMPFAGY,=C'H7'     For Mindshare media/pay scribe for           
         JNE   RTNMEX              client MFC for off FM override the           
         CLI   QPROG,MEDIA         client name                                  
         JE    *+12                                                             
         CLI   QPROG,PAYABLES                                                   
         JNE   RTNMEX                                                           
         CLC   0(6,R2),=C'MATTEL'                                               
         JNE   RTNMEX                                                           
         CLC   CUROFF,=C'FM'                                                    
         JNE   RTNMEX                                                           
         XC    WORK,WORK                                                        
         MVC   WORK(24),=C'FORD COMMERCIAL DIVISION'                            
         LA    R2,WORK                                                          
         LHI   R1,24                                                            
         STH   R1,PARNEWLN                                                      
*                                                                               
RTNMEX   XIT1  REGS=(R2)                                                        
         DROP  R7,RF                                                            
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*&&US                                                                           
***********************************************************************         
*  Filter on various approval statuses for BrandOcean purchase orders           
*  for the POA keyword                                                          
*                                                                               
*  Store 0000 in the key of the sort record and force dummy keyword             
*  POAN here which will store the POA pid in the data portion of the            
*  sort.  This is so that the pid does not sort since putting out               
*  additonal seed sort records with no amounts.  This wil force the             
*  real sort rec (non-seed) with the amount to sort first.                      
***********************************************************************         
         SPACE 1                                                                
         USING KYWD,R6                                                          
         USING POD,CURPODET                                                     
RTNPOD   NTR1  BASE=*,LABEL=*                                                   
         MVC   WORK(6),SPACES                                                   
         GOTO1 PARSE,DMCB,GETPORD,WORK,0  Check if related to a PO              
         BNE   RTPODL                                                           
         SR    RE,RE                                                            
         LA    RE,POAPPMX          Max of four entries                          
         LA    RF,POAUDI           Multiple audit rec info entries              
         USING POAUDI,RF                                                        
         TM    POSTATUS,POBRO                                                   
         BZ    RTPODL              Not a BrandOcean PO                          
*                                                                               
         MVC   WORK,SPACES         default to spaces                            
         XC    HALF,HALF           stick zero's in sort key for non             
         LA    R2,HALF             seed record for POA keyword so it            
         CLC   =C'POP',KYWCODE     sorts before the seed records                
         BE    RTPOD10                                                          
         CLC   =C'POAD',KYWCODE                                                 
         BE    RTPOD10                                                          
*        CLC   =C'POSUB',KYWCODE                                                
*        BE    RTPOD10                                                          
         TM    KYWIND1,KYWNME                                                   
         BZ    RTPODE                                                           
*                                                                               
RTPOD10  SR    R1,R1                                                            
         ICM   R1,3,KYWDD#                                                      
         CHI   R1,AC#RSPOA         POA keyw?                                    
         BE    *+14                                                             
         CLC   =C'POAN',KYWCODE    dummy keyw to link to POA?                   
         BNE   RTPOD15                                                          
*        TM    POPROC,POAPPX       If already done for this PO then             
*        BO    *+10                put out blanks                               
         MVC   WORK(L'POBPID),POBPID                                            
         LA    R2,WORK                                                          
         OI    POPROC,POAPPX       Set bit that done for this PO                
         B     RTPODE                                                           
*                                                                               
RTPOD15  DS    0H                                                               
*        CHI   R1,AC#RSPOS         POSUB keyw?                                  
*        BE    *+14                                                             
         CLC   =C'POSN',KYWCODE    dummy keyw to link to POSUB?                 
         BNE   RTPOD20                                                          
*        TM    POPROC,POSUBX       If already done for this PO then             
*        BO    *+10                put out blanks                               
         MVC   WORK(L'POSPID),POSPID                                            
         LA    R2,WORK                                                          
*        OI    POPROC,POSUBX       Set bit that done for this PO                
         B     RTPODE                                                           
*                                                                               
RTPOD20  DS    0H                                                               
         CHI   R1,AC#RSPP          POP keyw?                                    
         BNE   RTPOD30                                                          
*        TM    POPROC,POPOPX       If already done for this PO then             
*        BO    *+10                move in blanks                               
         MVC   WORK(L'POPPR),POPPR                                              
         LA    R2,WORK                                                          
         OI    POPROC,POPOPX                                                    
         B     RTPODE                                                           
*                                                                               
RTPOD30  DS    0H                                                               
         CHI   R1,AC#RSPAD         POAD keyw?                                   
         BNE   RTPOD40                                                          
*        TM    POPROC,POAPPDX      If already done for this PO then             
*        BO    *+10                move in blanks                               
         MVC   WORK(L'POBDATE),POBDATE                                          
         LA    R2,WORK                                                          
         OI    POPROC,POAPPDX                                                   
         B     RTPODE                                                           
*                                                                               
RTPOD40  DS    0H                                                               
         CHI   R1,AC#RSPD          POPD keyw?                                   
         BNE   RTPOD50                                                          
*        TM    POPROC,POPOPDX      If already done for this PO then             
*        BO    *+10                move in blanks                               
         MVC   WORK(L'POPPRD),POPPRD                                            
         LA    R2,WORK                                                          
         OI    POPROC,POPOPDX                                                   
         B     RTPODE                                                           
*                                                                               
RTPOD50  DS    0H                                                               
*&&DO                                                                           
         CHI   R1,AC#RSPOS         POSUB keyw?                                  
         BNE   RTPODE                                                           
*        TM    POPROC,POSUBX       If already done for this PO then             
*        BO    *+10                move in blanks                               
         MVC   WORK(L'POSPID),POSPID                                            
         LA    R2,WORK                                                          
         OI    POPROC,POSUBX                                                    
*&&                                                                             
         B     RTPODE                                                           
*                                                                               
*&&DO                                                                           
RTPOD10  LA    R2,POBPID           Default to approver pid                      
         SR    R1,R1                                                            
         ICM   R1,3,KYWDD#                                                      
         CHI   R1,AC#RSPOA         POA keyw?                                    
         BE    RTPODE                                                           
         CLC   =C'POAN',KYWCODE    dummy keyw to link to POA?                   
         BE    RTPODE                                                           
         LA    R2,POPPR            Submitter pid                                
         CHI   R1,AC#RSPP          POP keyw?                                    
         BE    RTPODE                                                           
         LA    R2,POBDATE          Approver date                                
         CHI   R1,AC#RSPAD         POAD keyword?                                
         BE    RTPODE                                                           
         LA    R2,POPPRD           Submitter date                               
         B     RTPODE                                                           
*&&                                                                             
*                                                                               
RTPODL   CLI   *,X'FF'             SET CC = LOW                                 
         B     RTPODX                                                           
RTPODE   CR    RB,RB               SET CC = EQUAL                               
RTPODX   XIT1  REGS=(R2)                                                        
         DROP  R6,RF                                                            
         SPACE 2                                                                
         LTORG                                                                  
*&&                                                                             
***********************************************************************         
* READ CON/SEC PERSON REC, RETURN 8-CHAR PID CODE                               
***********************************************************************         
         SPACE 1                                                                
         USING PARWRKD,R7                                                       
RTNPIDN  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
*&&UK*&& L     RF,ADMASTC                                                       
*&&UK*&& MVC   SECALPHA,MCRHSAGY-MASTD(RF)                                      
         MVC   HALF,SECALPHA      Default to sec alpha of request ID            
         XC    WORK,WORK                                                        
         CLI   QPROG,PAYABLES                                                   
         JNE   RTPID30                                                          
*&&UK*&& J     RTPID30                                                          
                                                                                
         USING XPYELD,RF                                                        
         L     RF,ADTRANS                                                       
         SR    R0,R0                                                            
RTPID10  CLI   XPYEL,0                                                          
         JE    RTPID30                                                          
         CLI   XPYEL,XPYELQ       Extra payment element                         
         JE    RTPID20                                                          
         IC    R0,XPYLN                                                         
         AR    RF,R0                                                            
         J     RTPID10                                                          
*                                                                               
RTPID20  CLC   XPYAGY,SPACES                                                    
         JNH   RTPID30                                                          
         CLC   XPYAGY,HALF         If the same, do not bother                   
         JE    RTPID30             checking Security for SECALPHA               
         MVC   HALF,XPYAGY                                                      
         DROP  RF                                                               
*                                                                               
         USING CT5REC,R4                                                        
RTPID22  LA    R4,IOKEY                                                         
         XC    IOKEY(L'CT5KEY),IOKEY                                            
         MVI   CT5KTYP,CT5KTYPQ           GET OVERRIDE'S SEC AGY                
         MVC   CT5KALPH,HALF                                                    
         L     R1,=AL4(IOHIGH+IOCNTRL+IOAREA3)                                  
         GOTO1 AIO                                                              
         L     R4,AIO3                                                          
         CLC   IOKEY(L'CT5KEY),0(R4)                                            
         JNE   RTPID30                                                          
         LA    R4,CT5DATA                                                       
*                                                                               
         USING CTSEAD,R4                                                        
RTPID24  CLI   CTSEAEL,EOR                                                      
         BE    RTPID30                    NOT FOUND                             
         CLI   CTSEAEL,CTSEAELQ           X'B8' - ACTION ELEM                   
         BE    RTPID26                                                          
         SR    RF,RF                                                            
         IC    RF,1(R4)                                                         
         AR    R4,RF                                                            
         B     RTPID24                                                          
*                                                                               
RTPID26  MVC   HALF,CTSEAAID              OVERRIDE'S SEC AGY                    
*                                                                               
         USING SA0REC,R4                                                        
RTPID30  LA    R4,IOKEY                                                         
         XC    IOKEY,IOKEY                                                      
         MVI   SA0KTYP,SA0KTYPQ    C'0' - PERSONAL AUTH. RECORD                 
         MVC   SA0KAGY,HALF        SECURITY ALPHA ID                            
         MVC   SA0KNUM,0(R2)                                                    
         L     R1,=AL4(IOHIGH+IOCNTRL+IOAREA3)                                  
         GOTO1 AIO                                                              
         L     R4,AIO3                                                          
         CLC   IOKEY(L'SA0KEY),0(R4)                                            
         JE    RTPID35                                                          
         MVC   WORK(L'SAPALPID),SPACES                                          
         LA    R2,WORK                                                          
         J     RTPIDX                                                           
RTPID35  TM    SA0STAT,X'20'       LOCKED                                       
         JO    RTPIDX                                                           
*                                                                               
         USING SAPALD,R4                                                        
         SR    R1,R1                                                            
*&&US*&& LA    R4,SAPEDATA-SAPEKEY(,R4)                                         
*&&UK*&& LA    R4,SA0DATA-SA0KEY(,R4)                                           
RTPID40  CLI   0(R4),0                                                          
         JE    RTPIDX                                                           
         CLI   0(R4),SAPALELQ      X'C3' - PERSONAL ID ELEM                     
         JE    RTPID50                                                          
         IC    R1,1(,R4)           NEXT ELEMENT                                 
         AR    R4,R1                                                            
         J     RTPID40                                                          
*                                                                               
RTPID50  MVC   WORK(L'SAPALPID),SAPALPID                                        
         LA    R2,WORK                                                          
*                                                                               
RTPIDX   XIT1  REGS=(R2)                                                        
         DROP  R4,R7                                                            
***********************************************************************         
* READ CON/SEC PERSON REC, RETURN 50-CHAR PERSON NAME                           
* NTRY: WORK = 8-CHAR PID CODE                                                  
***********************************************************************         
         SPACE 1                                                                
         USING PARWRKD,R7                                                       
RTNPNAM  NTR1  BASE=*,LABEL=*                                                   
         OC    WORK(L'SAPALPID),WORK                                            
         JZ    RTNPNX                                                           
         USING SAPEREC,R4                                                       
         LA    R4,IOKEY                                                         
         XC    SAPEKEY,SAPEKEY                                                  
         MVI   SAPETYP,SAPETYPQ    C'P' - PERSONAL AUTH. RECORD                 
         MVI   SAPESUB,SAPESUBQ                                                 
         MVC   SAPEAGY,SECALPHA    SECURITY ALPHA ID                            
         MVC   SAPEPID,WORK                                                     
         L     R1,=AL4(IOHIGH+IOCNTRL+IOAREA3)                                  
         GOTO1 AIO                                                              
         L     R4,AIO3                                                          
         CLC   IOKEY(SAPEDEF-SAPEKEY),0(R4)                                     
         JNE   RTNPNX                                                           
         TM    SAPESTAT,X'20'      LOCKED                                       
         JO    RTNPNX                                                           
*                                                                               
         USING SAPEREC,R4                                                       
         SR    R1,R1                                                            
         LA    R4,SAPEDATA-SAPEKEY(,R4)                                         
RTNPN10  CLI   0(R4),0                                                          
         JE    RTNPNX                                                           
         CLI   0(R4),SANAMELQ      X'C5' - PERSON NAME ELEM                     
         JE    RTNPN20                                                          
         IC    R1,1(,R4)           NEXT ELEMENT                                 
         AR    R4,R1                                                            
         J     RTNPN10                                                          
*                                                                               
RTNPN20  LA    R2,WORK                                                          
         SR    RE,RE                                                            
         USING SANAMD,R4                                                        
         LA    R1,SANAMELN                                                      
         USING SANAMELN,R1                                                      
         TM    SANAMIND,SANAMIFN   TEST FIRST NAME PRESENT                      
         JZ    RTNPN22                                                          
         LLC   RF,SANAMELN                                                      
         AHI   RF,-1                                                            
         MVC   0(0,R2),SANAME                                                   
         EX    RF,*-6                                                           
         LA    R1,2(RF,R1)                                                      
         LA    R2,2(RF,R2)                                                      
         LA    RE,2(RF,RE)         ACCUM LENGTH USED                            
*                                                                               
RTNPN22  TM    SANAMIND,SANAMIMN   TEST MIDDLE NAME PRESENT                     
         JZ    RTNPN24                                                          
         LLC   RF,SANAMELN                                                      
         AHI   RF,-1                                                            
         MVC   0(0,R2),SANAME                                                   
         EX    RF,*-6                                                           
         LA    R1,2(RF,R1)                                                      
         LA    R2,2(RF,R2)                                                      
         LA    RE,2(RF,RE)         ACCUM LENGTH USED                            
*                                                                               
RTNPN24  TM    SANAMIND,SANAMILN   TEST LAST NAME PRESENT                       
         JZ    RTNPN26                                                          
         LLC   RF,SANAMELN                                                      
         LA    R0,50               MAX L'OUTPUT                                 
         SR    R0,RE               R0=L'REMAINING SPACE                         
         JNP   RTNPNX                                                           
         CR    RF,R0               TEST > REMAINING SPACE                       
         JNH   *+6                                                              
         LR    RF,R0               MOVE IN AS MUCH AS WE CAN                    
         AHI   RF,-1                                                            
         MVC   0(0,R2),SANAME                                                   
         EX    RF,*-6                                                           
         LA    RE,1(RF,RE)         TOTAL LENGTH USED                            
*                                                                               
RTNPN26  LA    R2,WORK                                                          
         STH   RE,PARNEWLN                                                      
*                                                                               
RTNPNX   XIT1  REGS=(R2)                                                        
         DROP  R4,R7                                                            
*&&US                                                                           
*=====================================================================*         
*       Get Agency Media File                                         *         
*=====================================================================*         
         USING FFTELD,RF                                                        
GTAGYMF  NTR1  BASE=*,LABEL=*                                                   
         MVC   WORK(3),=C'N/A'                                                  
         L     RF,ADTRANS                                                       
GTAGYMF1 CLI   0(RF),0                                                          
         JE    GTAGYMFX                                                         
         CLI   QPROG,RECEIVABLE    Receivables look at FFTEL                    
         JE    *+8                                                              
         CLI   QPROG,MEDIA         and Media                                    
         JE    *+8                                                              
         CLI   QPROG,INCOME        and Income                                   
         JNE   GTAGYMF3                                                         
         CLI   FFTEL,FFTELQ                                                     
         JNE   GTAGYMF9                                                         
         CLI   FFTTYPE,FFTTMXTY    Right type?                                  
         JNE   GTAGYMF9                                                         
         CLI   FFTDLEN,FFTMLN2Q    Do we have the right length?                 
         JL    GTAGYMF9                                                         
         MVC   WORK(2),FFTMXTAG                                                 
         MVI   WORK+2,C' '                                                      
         J     GTAGYMFX                                                         
                                                                                
         USING XPYELD,RF                                                        
GTAGYMF3 CLI   QPROG,PAYABLES      Payables look at XPYEL                       
         JNE   GTAGYMF4                                                         
         CLI   XPYEL,XPYELQ                                                     
         JNE   GTAGYMF9            Bump to next element                         
         MVC   WORK(2),XPYAGY                                                   
         MVI   WORK+2,C' '                                                      
         J     GTAGYMFX                                                         
                                                                                
         USING PIDELD,RF                                                        
GTAGYMF4 CLI   QPROG,CASH          Cash looks at PIDEL                          
         JNE   GTAGYMF5                                                         
         CLI   PIDEL,PIDELQ                                                     
         JNE   GTAGYMF9            Bump to next element                         
         CLC   PIDAGY,SPACES                                                    
         BNH   GTAGYMFX                                                         
         MVC   WORK(2),PIDAGY                                                   
         MVI   WORK+2,C' '                                                      
         J     GTAGYMFX                                                         
                                                                                
GTAGYMF5 DS    0H                                                               
                                                                                
GTAGYMF9 SR    RE,RE               Bump to next elem                            
         IC    RE,1(RF)                                                         
         AR    RF,RE                                                            
         B     GTAGYMF1                                                         
                                                                                
GTAGYMFX XIT1                                                                   
         DROP  RF                                                               
         LTORG                                                                  
         EJECT ,                                                                
*=====================================================================*         
*       Get Request Date and Time                                     *         
*=====================================================================*         
GTRQDT   NTR1  BASE=*,LABEL=*                                                   
         MVC   WORK,SPACES                                                      
         GOTO1 DATCON,DMCB,(1,TDDATE),(10,WORK)                                 
         MVC   WORK+9(8),REQTIME                                                
         XIT1                                                                   
         LTORG                                                                  
         EJECT ,                                                                
***********************************************************************         
***********************************************************************         
         USING KYWD,R6                                                          
         USING SCIELD,R8                                                        
TAXCODES NTR1  BASE=*,LABEL=*                                                   
         CLI   QPROG,PRODUCTION                                                 
         JE    TYPET10             No                                           
TYPET00  CLI   SCIEL,SCIELQ        X'50'                                        
         JNE   TYPET10             No                                           
         CLI   SCITYPE,SCITTQST    QST type                                     
         JNE   TXCDL               No                                           
*                                                                               
         CP    SCIGRS,=P'0'        Both amounts zero, skip it                   
         JNE   TYPET04                                                          
         CP    SCIGBIL,=P'0'                                                    
         JNE   TYPET04                                                          
         J     TXCDL               No                                           
*                                                                               
TYPET04  CLC   KYWDD#,=AL2(AC#QST) QST keyword?                                 
         JNE   TYPET05                                                          
         CLC   SCISUBPR,=C'PQ'     For QST looking for PQ province code         
         JE    TXCDE                                                            
         J     TXCDL                                                            
*                                                                               
TYPET05  CLC   KYWDD#,=AL2(AC#RSPRV)   PROVC keyword                            
         JE    TXCDE                                                            
         CLC   KYWDD#,=AL2(AC#RSPTX)   PST keyword                              
         JE    TXCDE                                                            
         CLI   SCISUBPR,C'N'       For HST looking for NB,NS,NF,ON,BC           
         JE    TXCDE               or PE Province codes                         
         CLI   SCISUBPR,C'O'                                                    
         JE    TXCDE                                                            
         CLI   SCISUBPR,C'B'                                                    
         JE    TXCDE                                                            
         CLC   SCISUBPR,=C'PE'                                                  
         JE    TXCDE                                                            
         J     TXCDL                                                            
         DROP  R8                                                               
*                                                                               
         USING PBIELD,R8                                                        
TYPET10  CLC   KYWDD#,=AL2(AC#QST) QST keyword?                                 
         JNE   TYPET15                                                          
         CLC   PBIPRV,=C'PQ'        then looking for PQ code                    
         JE    TXCDE                                                            
         J     TXCDL                                                            
*                                                                               
TYPET15  CLI   PBIPRV,C'N'         HST looking for NB,NS,NF,ON,BC OR PE         
         JE    TXCDE                                                            
         CLC   PBIPRV,=C'PE'                                                    
         JE    TXCDE                                                            
         CLI   PBIPRV,C'O'                                                      
         JE    TXCDE                                                            
         CLI   PBIPRV,C'B'                                                      
         JE    TXCDE                                                            
         J     TXCDL                                                            
*                                                                               
TXCDL    CLI   *,X'FF'             SET CC = LOW                                 
         J     TXCDX                                                            
TXCDE    CR    RB,RB               SET CC = EQUAL                               
TXCDX    XIT1                                                                   
         DROP  R8                                                               
         SPACE 2                                                                
         LTORG                                                                  
         EJECT ,                                                                
         DROP  R6                                                               
***********************************************************************         
***********************************************************************         
         SPACE 1                                                                
         USING PARWRKD,R7                                                       
ADJB2AMT NTR1  BASE=*,LABEL=*                                                   
         TM    PARCNTRL,PARBYWC                                                 
         JZ    ADB2L                                                            
         TM    RECREAD2,REC99WC    Pre-read billing, 99 trans                   
         JZ    ADB2E                                                            
*                                                                               
         USING BILLD,RE                                                         
         USING TRNELD,RF                                                        
         L     RE,BILLTAB                                                       
ADB200   L     RF,ADTRANS                                                       
         J     ADB230                                                           
ADB210   CLI   0(RF),0                                                          
         JE    ADB270                                                           
         CLI   0(RF),BSCELQ        X'E3' - Billing source                       
         JE    ADB240                                                           
         CLI   0(RF),CPJELQ                                                     
         JE    ADB250                                                           
         CLI   0(RF),PTAELQ       Prod transaction activity (77)                
         JE    ADB260                                                           
ADB220   ZIC   R0,1(RF)                                                         
         AR    RF,R0                                                            
         J     ADB210                                                           
*                                                                               
ADB230   CLC   BILLRUN,TRN2DAY    Billing run date                              
         JNE   ADB2NX                                                           
         CLC   BILLTY,TRNBTYPE    Billing type                                  
         JNE   ADB2NX                                                           
         CLC   BILDTE,TRNDATE     Billing date                                  
         JNE   ADB2NX                                                           
         CLC   BILL#,TRNREF       Billing ref #                                 
         JNE   ADB2NX                                                           
         J     ADB220                                                           
*                                                                               
         USING BSCELD,RF                                                        
ADB240   CLC   BILLROF,BSCBOFF     Billing source office                        
         JNE   ADB2NX                                                           
         CLC   BILLRBS,BSCBSRC     Billing source code                          
         JNE   ADB2NX                                                           
         J     ADB220                                                           
*                                                                               
         USING CPJELD,RF                                                        
ADB250   NI    BYTE,X'FF'-X'80'                                                 
         CLI   CPJTYPE,CPJTREC     Type is RCV ?                                
         JNE   ADB220              No, get next element                         
         CLC   BILLRCV,CPJRULA     Compare on billing RCV account               
         JNE   ADB2NX              Not the same-get next bill tab ntry          
         OI    BYTE,X'80'          No need to compare to trnkulc                
         J     ADB220                                                           
*                                                                               
         USING PTAELD,RF                                                        
ADB260   NI    BYTE,X'FF'-X'40'                                                 
         TM    PTASTAT1,PTASREVS  Is this a reversal?                           
         JZ    ADB220             No - then no need to reverse B2               
         OI    BYTE,X'40'                                                       
         J     ADB220                                                           
*                                                                               
         USING TRNRECD,RF                                                       
ADB270   L     RF,ADTRANS                                                       
         SH    RF,DATADISP                                                      
         CLC   BILLSBR,TRNKSBR    Transaction seq #                             
         JNE   ADB2NX                                                           
         TM    BYTE,X'80'         Did we find a match on RCV acct?              
         JO    ADB280                                                           
         CLC   BILLRCV,TRNKULC                                                  
         JNE   ADB2NX                                                           
*                                                                               
         USING BESTD,R4                                                         
         USING BESELD,R3                                                        
ADB280   L     R4,BILLEST                                                       
         L     R3,PARELADR        The current B2 element from Parse rtn         
         LHI   RF,BESTMAXQ                                                      
ADB290   CLC   BESTWC,BESWC       Same workcode?                                
         JE    ADB300                                                           
         LA    R4,BESTLNQ(R4)                                                   
         JCT   RF,ADB290                                                        
*                                                                               
ADB300   MVI   PARNEWLN+1,L'ANSWER                                              
*        LA    RF,L'ANSWER                                                      
*        STH   RF,PARNEWLN                                                      
         ZAP   ANSWER,BESTNET                                                   
         TM    BYTE,X'40'         Need to reverse?                              
         JZ    *+8                                                              
         XI    ANSWER+L'ANSWER-1,X'01'    Reverse sign                          
         LA    R2,ANSWER                                                        
         J     ADB2E                                                            
*                                                                               
ADB2NX   LA    RE,BILLLNQ(RE)     Get next bill in table                        
         J     ADB200                                                           
*                                                                               
ADB2L    CLI   *,X'FF'             SET CC = LOW                                 
         J     ADB2X                                                            
ADB2E    CR    RB,RB               SET CC = EQUAL                               
ADB2X    XIT1  REGS=(R2)                                                        
         DROP  R3,R4,R7,RE,RF                                                   
***********************************************************************         
***********************************************************************         
         USING BILLD,R2                                                         
         USING BESTD,R4                                                         
         USING FMTRECD,R5                                                       
PCTBILL  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         NI    BYTE1,TURNOFF-(X'80'+X'40')                                      
         L     R2,BILLTAB                                                       
         SR    R8,R8                                                            
         ICM   R8,3,#BILLS            Number of bills                           
PCTB01   TM    BILLIND,BILLREV     If bill is unbilled (or the reversal         
         BO    PCTB90              bill then skip it                            
         OC    BILUDTE,BILUDTE                                                  
         BNZ   PCTB90                                                           
         OC    BILLEST,BILLEST        % of est bill?                            
         BZ    PCTB90                 No                                        
         L     R4,BILLEST             Point to workcode data                    
         LHI   R7,BESTMAXQ            Max number of workcodes                   
PCTB05   OC    BESTWC,BESTWC                                                    
         BZ    PCTB70                                                           
         OI    BYTE1,X'80'            Indicate we found %est bill               
         MVC   CURWCTY,BESTWCT        Move in workcode type                     
*                                                                               
         MVC   CURWKCD,=C'99'      Only get here if credit                      
         GOTO1 ARECORD,DMCB,('POSTNUL',ASRTWRK),('POSTCLR',1)                   
*                                                                               
         USING COLD,R3                                                          
         USING FLTADRD,R6                                                       
         L     R3,FMTCOL                                                        
         SR    R9,R9                                                            
         IC    R9,FMT#COLS                                                      
PCTB10   TM    COLFLAGS,COLAMT     Check columns to fill                        
         BZ    PCTB60                                                           
         TM    COLFLAGS,COLJOBR    Don't process JOBBER columns                 
         BO    PCTB60                                                           
         TM    COLFLAGS,COLBUD     Don't process BUDGET columns                 
         BO    PCTB60                                                           
         TM    COLFLAGS,COLCALC    Don't process column cals                    
         BO    PCTB60                                                           
         ICM   R6,15,COLFLTS                                                    
         BZ    PCTB30              CC=EQUAL (OK)                                
*                                                                               
PCTB20   CLI   FLTFLAG,EOT                                                      
         BE    PCTB30                                                           
         GOTO1 AFILTER,DMCB,FLTADDR,FLTDATA,0                                   
         BNE   PCTB60                                                           
         AHI   R6,FLTADRLQ                                                      
         B     PCTB20                                                           
         DROP  R6                                                               
*                                                                               
PCTB30   L     RE,ASRTWRK                                                       
         AH    RE,COLDSP                                                        
         CLC   COLDD#,=AL2(AC#RSBGS)                                            
         BNE   PCTB40                                                           
         ZAP   0(PKLEN,RE),BESTGRS      gross $                                 
*                                                                               
PCTB40   CLC   COLDD#,=AL2(AC#RSBNT)                                            
         BNE   PCTB60                                                           
         ZAP   0(PKLEN,RE),BESTNET      Net $                                   
*                                                                               
PCTB50   DS    0H                                                               
*        CLC   COLDD#,=AL2(AC#RSBCM)                                            
*        BNE   *+10                                                             
*        ZAP   0(PKLEN,RE),BILLPCOM     Previous billing commission $           
         XI    PKLEN-1(RE),X'01'        Reverse sign                            
         OI    BYTE1,X'40'                                                      
*                                                                               
PCTB60   LA    R3,COLLNQ(,R3)           Next column                             
         BCT   R9,PCTB10                                                        
*                                                                               
PCTB70   TM    BYTE1,X'40'                                                      
         BZ    PCTB85                                                           
         SR    RF,RF                                                            
         ICM   RF,3,FMTFCOL        DISPLACEMENT TO FORCED COLUMN                
         BZ    PCTB80                                                           
         A     RF,ASRTWRK                                                       
         ZAP   0(PKLEN,RF),PKONE                                                
                                                                                
PCTB80   GOTO1 APUTREC,DMCB,ASRTWRK,1                                           
         NI    BYTE1,TURNOFF-X'40'                                              
*                                                                               
PCTB85   LA    R4,BESTLNQ(R4)           Next w/c entry in BILLEST               
         BCT   R7,PCTB05                                                        
*                                                                               
PCTB90   LA    R2,BILLLNQ(R2)           Next bill                               
         BCT   R8,PCTB01                                                        
*                                                                               
         XIT1                                                                   
         DROP  R2,R4                                                            
*&&                                                                             
***********************************************************************         
*  R3=COLUMN ENTRY, FILTER COLUMNS                                    *         
***********************************************************************         
         USING COLD,R3                                                          
         USING FLTADRD,R8                                                       
GOFILT   NTR1  BASE=*,LABEL=*                                                   
         ICM   R8,15,COLFLTS                                                    
         BZ    GOFILTE                                                          
*                                                                               
GOFILT10 CLI   FLTFLAG,EOT                                                      
         JE    GOFILTE                                                          
         GOTO1 AFILTER,DMCB,FLTADDR,FLTDATA,0                                   
         JNE   GOFILTL                                                          
         AHI   R8,FLTADRLQ                                                      
         J     GOFILT10                                                         
                                                                                
GOFILTL  CLI   *,X'FF'             SET CC = LOW                                 
         J     GOFILTX                                                          
GOFILTE  CR    RB,RB               SET CC = EQUAL                               
GOFILTX  XIT1                                                                   
         DROP  R3,R8                                                            
         EJECT ,                                                                
*&&UK                                                                           
***********************************************************************         
*  GET EQUIVALENT NAME                                                *         
*                                                                     *         
* ENTY - P1=A(PARSED)                                                 *         
*      - P2=A(PARWRKD)                                                *         
*                                                                     *         
* EXIT - CC=EQU - R2=Equivalent name                                  *         
*      - CC=NEQ - No name found                                       *         
***********************************************************************         
         SPACE 2                                                                
         USING PARSED,R3                                                        
         USING AEBIND,R6                                                        
         USING PARWRKD,R7                                                       
         USING EQURECD,R8                                                       
GETENM   NTR1  BASE=*,LABEL=*                                                   
         L     R3,0(,R1)                                                        
         L     R7,4(,R1)                                                        
         LA    R8,IOKEY                                                         
         MVC   IOKEY,SPACES                                                     
         MVI   EQUKTYP,EQUKTYPQ    EQUIVALENT RECORD                            
         MVC   EQUKCPY,CURACC      COMPANY                                      
         MVC   EQUKUL,CURACC+1     UNIT/LEDGER                                  
         CLI   PARTTYP1,1          JAC-xx keyword?                              
         BNE   *+10                                                             
         MVC   EQUKUL,=C'SJ'       Yes - use SJ unit/ledger                     
         MVC   EQUKRULE,PARTTYP2   RULE (0-4)                                   
*                                                                               
         GOTO1 PARSE,DMCB,PARADDR,EQUKCODE,0,0                                  
         BNE   GETENMX                                                          
*                                                                               
         SAM31                     31 Bit mode                                  
         XC    WORK,WORK                                                        
         LA    R6,WORK                                                          
         MVC   AEBUL,EQUKUL                                                     
         MVC   AEBRULE,EQUKRULE                                                 
         MVC   AEBCODE,EQUKCODE                                                 
         LH    RF,EQNAME#                                                       
         GOTO1 BIN31,DMCB,AEBIND,AEQBASE,(RF),(1,AEBLNQ),              X        
               (0,AEBKEYQ),A(MAXAEQS)                                           
                                                                                
         XC    SVR6,SVR6                                                        
         ICM   R6,15,DMCB          LOAD WHERE INSERTED OR FOUND                 
         BZ    GETENM30            RECORD NOT FOUND AND TABLE FULL              
         ST    R6,SVR6             SAVE OFF ADDRESS ON ENTRY                    
         TM    DMCB,X'80'          FOUND?                                       
         BO    GETENM30            NO                                           
         MVC   WORK(L'AEBNAME),AEBNAME                                          
         B     GETENMOK            GET NAME                                     
*                                                                               
GETENM30 SAM24                     24 Bit mode                                  
         L     R1,=AL4(IOREAD+IOAREA1+IOACFIL)                                  
         GOTO1 AIO                                                              
         BNE   GETENMX             DATA NOT FOUND, EXIT                         
         SAM31                     31 Bit mode                                  
                                                                                
         USING NAMELD,R2                                                        
         SR    RF,RF                                                            
         L     R2,AIO1                                                          
         AH    R2,DATADISP         GET TO FIRST ELEMENT                         
GETENM35 CLI   NAMEL,0             END OF RECORD?                               
         BE    GETENMX                                                          
         CLI   NAMEL,NAMELQ        X'20' GET NAME ELEMENT                       
         BE    GETENM36                                                         
         IC    RF,NAMLN                                                         
         AR    R2,RF                                                            
         B     GETENM35                                                         
*                                                                               
GETENM36 IC    RF,NAMLN                                                         
         SHI   RF,NAMLN1Q          RF = SHOULD BE LENGTH OF NAME                
         BNP   GETENMX             BAD NAME ELEMENT                             
         STH   RF,PARNEWLN         SAVE LENGTH OF NAME                          
         LA    R2,NAMEREC          POINT TO DATA (NAME)                         
*                                                                               
         ICM   R6,15,SVR6                                                       
         BZ    GETENMOK            Table full, so cann't add                    
         MVC   AEBNAME,SPACES                                                   
         BCTR  RF,0                                                             
         EXMVC RF,AEBNAME,NAMEREC  SAVE EQUIVALENT NAME                         
*                                  FOUND DATA, SO RETRIVE IT                    
                                                                                
GETENMOK SR    R8,R8               Set cc to EQ                                 
*                                                                               
GETENMX  LTR   R8,R8                                                            
         SAM24                     24 Bit mode                                  
         XIT1  REGS=(R2)                                                        
         DROP  R2,R3,R6,R7,R8                                                   
         EJECT ,                                                                
         LTORG                                                                  
                                                                                
***********************************************************************         
*  VALIDATE COUNTRY CODE AND GET COUNTRY NAME                         *         
*                                                                     *         
* NTRY   P1          - A(PARSED)                                      *         
*        P2 BYTE 0   - 0 = GET COUNTRY CODE                           *         
*                    - 1 = GET COUNTRY NAME                           *         
*           BYTE 1-3 - A(COUNTRY CODE)                                *         
*                                                                     *         
* EXIT - CC=EQU - R2=COUNTRY CODE OR NAME                             *         
*      - CC=NEQ - INVALID COUNTRY CODE                                *         
***********************************************************************         
         SPACE 2                                                                
         USING PARSED,R3                                                        
         USING CTRYTABD,R8                                                      
VALCTRY  NTR1  BASE=*,LABEL=*                                                   
         L     R3,0(,R1)                                                        
         MVC   BYTE,4(R1)                                                       
         ICM   RF,B'0111',5(R1)                                                 
         BNZ   *+6                                                              
         DC    H'0'                                                             
         MVC   HALF,0(RF)          COUNTRY CODE                                 
*                                                                               
         LA    R8,CTRYTAB                                                       
VALCTRY4 CLC   CTRYCODE,=X'FFFF'                                                
         BE    VALCTRYX                                                         
         CLC   CTRYCODE,HALF                                                    
         BE    *+12                                                             
         AHI   R8,CTRYTABL         TRY NEXT ENTRY                               
         B     VALCTRY4                                                         
*                                                                               
         MVC   WORK,SPACES                                                      
         CLI   BYTE,0                                                           
         BNE   *+14                                                             
         MVC   WORK(2),HALF                                                     
         B     VALCTRYE                                                         
*                                                                               
         MVI   WORK,DD#ESCL        LEFT ALIGNED                                 
         MVC   WORK+1(2),CTRYNDD#  COUNTRY NAME                                 
         MVC   WORK+3(1),CTRYNMLN  LENGTH                                       
         GOTO1 ADDICTAT,DMCB,C'SL  ',WORK,0                                     
                                                                                
VALCTRYE LA    R2,WORK                                                          
         SR    R8,R8               Set cc to EQ                                 
*                                                                               
VALCTRYX LTR   R8,R8                                                            
         XIT1  REGS=(R2)                                                        
         DROP  R3,R8                                                            
         EJECT ,                                                                
         LTORG                                                                  
                                                                                
***********************************************************************         
*  VALIDATE ISO COUNTRY CODE/GET COUNTRY NAME                         *         
*                                                                     *         
* NTRY   P1          - A(PARSED)                                      *         
*        P2 BYTE 0   - 0 = GET COUNTRY CODE                           *         
*                    - 1 = GET COUNTRY NAME                           *         
*           BYTE 1-3 - A(COUNTRY CODE)                                *         
*                                                                     *         
* EXIT - CC=EQU - R2=COUNTRY CODE OR NAME                             *         
*      - CC=NEQ - INVALID COUNTRY CODE                                *         
***********************************************************************         
         SPACE 2                                                                
         USING PARSED,R3                                                        
         USING CTRYTABD,R8                                                      
VALISCT  NTR1  BASE=*,LABEL=*                                                   
         L     R3,0(,R1)                                                        
         MVC   BYTE,4(R1)                                                       
         ICM   RF,B'0111',5(R1)                                                 
         BNZ   *+6                                                              
         DC    H'0'                                                             
         MVC   HALF,0(RF)          COUNTRY CODE                                 
*                                                                               
         LARL  R8,ISOCTAB                                                       
         CLI   RCCTRY,CTRYGER                                                   
         BNE   VALISC02                                                         
         LARL  R8,ISGCTAB                                                       
VALISC02 CLC   0(2,R8),=X'FFFF'    TEST EOT                                     
         BE    VALISCTX                                                         
         CLC   HALF,0(R8)          MATCH ON 2-CHAR ISO CODE                     
         BE    *+12                                                             
         AHI   R8,ISOCTLN          TRY NEXT ENTRY                               
         B     VALISC02                                                         
*                                                                               
         MVC   WORK(24),5(R8)      MOVE IN COUNTRY NAME                         
         LA    R2,WORK                                                          
         SR    R8,R8               Set cc to EQ                                 
*                                                                               
VALISCTX LTR   R8,R8                                                            
         XIT1  REGS=(R2)                                                        
         DROP  R3,R8                                                            
         EJECT ,                                                                
         LTORG                                                                  
                                                                                
***********************************************************************         
*  GET JOB DESCRIPTION FROM ACCOUNT EXTENSION RECORD                  *         
*                                                                     *         
* ENTY - P1=A(PARSED)                                                 *         
*      - P2=A(PARWRKD)                                                *         
*                                                                     *         
* EXIT - CC=EQU - R2=Job description                                  *         
*      - CC=NEQ - No data found                                       *         
***********************************************************************         
         SPACE 2                                                                
         USING PARSED,R3                                                        
         USING AEBIND,R6                                                        
         USING PARWRKD,R7                                                       
         USING AEXRECD,R8                                                       
GETJDS   NTR1  BASE=*,LABEL=*                                                   
         L     R3,0(,R1)                                                        
         L     R7,4(,R1)                                                        
         LA    R8,IOKEY                                                         
         XC    IOKEY,IOKEY                                                      
         MVI   AEXKTYP,AEXKTYPQ    ACCOUNT EXTENSION RECORD                     
         MVI   AEXKSUB,AEXKSUBQ                                                 
         MVC   AEXKCPY,CURACC      COMPANY                                      
         MVC   AEXKULA,CURACC+1    UNIT/LEDGER/ACCOUNT                          
                                                                                
         L     R1,=AL4(IOREAD+IOAREA1+IOACFIL)                                  
         GOTO1 AIO                                                              
         BNE   GETJDSX             DATA NOT FOUND, EXIT                         
                                                                                
         L     RE,GENAREA1                                                      
         LHI   RF,GESIZEQ                                                       
         XR    R0,R0                                                            
         XR    R1,R1                                                            
         MVCL  RE,R0                                                            
                                                                                
         USING JLDELD,R2                                                        
         SR    RF,RF                                                            
         L     R2,AIO1                                                          
         AH    R2,DATADISP         GET TO FIRST ELEMENT                         
         MVC   SVREG,GENAREA1                                                   
GETJDS04 CLI   JLDEL,0             END OF RECORD?                               
         BE    GETJDS10                                                         
         CLI   JLDEL,JLDELQ        JOB LONG DESCRIPTION?                        
         BE    GETJDS08                                                         
GETJDS06 XR    RF,RF                                                            
         IC    RF,JLDLN                                                         
         AR    R2,RF                                                            
         B     GETJDS04                                                         
*                                                                               
GETJDS08 IC    RF,JLDLN                                                         
         SHI   RF,JLDLNQ           RF = SHOULD BE LENGTH OF JOB DESC            
         BNP   GETJDS06            BAD ELEMENT, LOOK FOR ANOTHER                
         L     RE,SVREG                                                         
         LR    R1,RF                                                            
         AR    R1,RE                                                            
         ST    R1,SVR1                                                          
         LA    R0,JLDDESC                                                       
         LR    R1,RF                                                            
         MVCL  RE,R0                                                            
         MVC   SVREG,SVR1                                                       
*        B     GETJDS06            (only do one element for now)                
                                                                                
GETJDS10 L     R2,GENAREA1                                                      
         CLC   0(L'SPACES,R2),SPACES DID WE PICK UP ANY NARRATIVE?              
         BNH   GETJDSX                                                          
                                                                                
* Remove <nl> from narrative                                                    
         LR    RF,R2                                                            
         LA    R0,1          INCREMENT                                          
         LA    R1,350(RF)    LIMIT       ?                                      
GETJDS12 CLI   0(RF),C'<'                                                       
         BNE   GETJDS16                                                         
         CLC   0(4,RF),=C'<nl>'                                                 
         BNE   GETJDS16                                                         
         MVC   0(4,RF),SPACES                                                   
         LA    RF,3(RF)                                                         
GETJDS16 BXLE  RF,R0,GETJDS12                                                   
                                                                                
* Call Squasher                                                                 
         GOTO1 ADSQUASH,DMCB,(R2),(0,350)                                       
         ICM   RE,15,4(R1)                                                      
         XR    RF,RF                                                            
         ICM   RF,3,PARTOLEN                                                    
         STH   RE,PARNEWLN                                                      
         CR    RE,RF                                                            
         BNH   *+8                                                              
         STH   RF,PARNEWLN                                                      
         SR    R8,R8               Set cc to EQ                                 
*                                                                               
GETJDSX  LTR   R8,R8                                                            
         XIT1  REGS=(R2)                                                        
         DROP  R2,R3,R6,R7,R8                                                   
         EJECT ,                                                                
         LTORG                                                                  
                                                                                
***********************************************************************         
* Country codes and names table                                                 
***********************************************************************         
                                                                                
       ++INCLUDE DDCTRY                                                         
         EJECT ,                                                                
                                                                                
***********************************************************************         
*  GET VAT NUMBER FOR SJ LEDGER                                       *         
*                                                                     *         
* ENTY - P1=A(RECORD)                                                 *         
*      - P2=A(PARSED)                                                 *         
*      - P3=A(PARWRKD)                                                *         
*                                                                     *         
* EXIT - CC=EQU  - R2=VAT Number                                      *         
*      - CC=LOW  - No VAT number found                                *         
*      - CC=HIGH - No VAT number found and get it from higher level   *         
***********************************************************************         
         SPACE 2                                                                
         USING FFTELD,R2                                                        
         USING PARSED,R3                                                        
         USING PARWRKD,R7                                                       
GETVNM   NTR1  BASE=*,LABEL=*                                                   
         LM    R2,R3,0(R1)                                                      
         L     R7,8(,R1)                                                        
*                                                                               
         XC    WORK,WORK                                                        
         SR    RF,RF                                                            
         AH    R2,DATADISP         GET TO FIRST ELEMENT                         
GETVNM04 CLI   FFTEL,0             END OF RECORD?                               
         BE    GETVNM20                                                         
         CLI   FFTEL,FFTELQ                                                     
         BE    *+14                                                             
GETVNM08 IC    RF,FFTLN                                                         
         AR    R2,RF                                                            
         B     GETVNM04                                                         
*                                                                               
         CLI   FFTTYPE,FFTTAXLO    VAT REGION?                                  
         BNE   *+14                                                             
         MVC   WORK(L'FFTAXLOC),FFTAXLOC                                        
         B     GETVNM08                                                         
         CLI   FFTTYPE,FFTTAXNO    VAT NUMBER                                   
         BNE   GETVNM08                                                         
         ICM   RF,1,FFTDLEN                                                     
         BZ    GETVNM08                                                         
         STC   RF,PARNEWLN         SAVE LENGTH OF VAT NUMBER                    
         SHI   RF,1                                                             
         EXMVC RF,WORK+1,FFTDATA                                                
         B     GETVNM08                                                         
*                                                                               
GETVNM20 OC    WORK+1(L'FFTAXNUM),WORK+1                                        
         BZ    *+12                                                             
         LA    R2,WORK+1                                                        
         B     GETVNME             FOUND DATA, SO RETRIVE IT                    
         CLI   RCCTRY,CTRYGER      TEST GERMANY?                                
         BNE   GETVNMH             NO GET IT FROM HIGHER LEVEL                  
         CLI   WORK,0              ANY VAT REGION ?                             
         BE    GETVNMH             NO GET IT FROM HIGHER LEVEL                  
*                                                                               
GETVNML  MVI   BYTE,0              SET CC LOW                                   
         B     GETVNMX                                                          
GETVNMH  MVI   BYTE,2              SET CC HIGH                                  
         B     GETVNMX                                                          
GETVNME  MVI   BYTE,1              SET CC EQUAL                                 
                                                                                
GETVNMX  CLI   BYTE,1                                                           
         XIT1  REGS=(R2)                                                        
         DROP  R2,R3,R7                                                         
         EJECT ,                                                                
         LTORG                                                                  
                                                                                
***********************************************************************         
*  GET COUNTRY CODE FOR SJ LEDGER                                     *         
*                                                                     *         
* ENTY - P1=A(RECORD)                                                 *         
*      - P2=A(PARSED)                                                 *         
*      - P3=A(PARWRKD)                                                *         
*                                                                     *         
* EXIT - CC=EQU  - R2=Country code                                    *         
*      - CC=LOW  - No country code found                              *         
*      - CC=HIGH - No code found and get it from higher level         *         
***********************************************************************         
         SPACE 2                                                                
         USING FFTELD,R2                                                        
         USING PARSED,R3                                                        
         USING PARWRKD,R7                                                       
GETCCD   NTR1  BASE=*,LABEL=*                                                   
         LM    R2,R3,0(R1)                                                      
         L     R7,8(,R1)                                                        
*                                                                               
         MVI   BYTE,0                                                           
         XC    HALF,HALF                                                        
         SR    RF,RF                                                            
         AH    R2,DATADISP         GET TO FIRST ELEMENT                         
GETCCD04 CLI   FFTEL,0             END OF RECORD?                               
         BE    GETCCD20                                                         
         CLI   FFTEL,FFTELQ                                                     
         BE    *+14                                                             
GETCCD08 IC    RF,FFTLN                                                         
         AR    R2,RF                                                            
         B     GETCCD04                                                         
*                                                                               
         CLI   FFTTYPE,FFTTAXLO    VAT REGION?                                  
         BNE   *+14                                                             
         MVC   BYTE,FFTAXLOC                                                    
         B     GETCCD08                                                         
         CLI   FFTTYPE,FFTTAXNO    VAT NUMBER                                   
         BNE   GETCCD08                                                         
         MVC   HALF,FFTDATA                                                     
         B     GETCCD08                                                         
*                                                                               
GETCCD20 OC    HALF,HALF                                                        
         BZ    GETCCD24            No data                                      
         GOTOR VALCTRY,DMCB,(R3),(0,HALF)                                       
         JNE   GETCCD24            It's not a valid country code                
         LA    R2,HALF                                                          
         B     GETCCDE             FOUND DATA, SO RETRIVE IT                    
*                                                                               
GETCCD24 CLI   RCCTRY,CTRYGER      TEST GERMANY?                                
         BNE   GETCCDH             NO GET IT FROM HIGHER LEVEL                  
         CLI   BYTE,0              ANY VAT REGION ?                             
         BE    GETCCDH             NO GET IT FROM HIGHER LEVEL                  
*                                                                               
GETCCDL  MVI   BYTE,0              SET CC LOW                                   
         B     GETCCDX                                                          
GETCCDH  MVI   BYTE,2              SET CC HIGH                                  
         B     GETCCDX                                                          
GETCCDE  MVI   BYTE,1              SET CC EQUAL                                 
                                                                                
GETCCDX  CLI   BYTE,1                                                           
         XIT1  REGS=(R2)                                                        
         DROP  R2,R3,R7                                                         
         EJECT ,                                                                
         LTORG                                                                  
*                                                                               
***********************************************************************         
* VALIDATE EXTRA DATA NAME(S) AND VALUE(S)                                      
***********************************************************************         
         SPACE 2                                                                
         USING ACRL2D,R3                                                        
         USING RFLELD,R4                                                        
         USING PARWRKD,R7                                                       
         USING XDFELD,R8                                                        
GTXDAT   NTR1  BASE=*,LABEL=*                                                   
         L     R3,AACRL2D                                                       
         L     R7,0(,R1)                                                        
         L     R8,4(,R1)                                                        
         MVC   TEMPAREA,SPACES                                                  
         LA    R6,TEMPAREA                                                      
         MVI   0(R6),X'FF'                                                      
         XC    WORK,WORK                                                        
         XC    XLCHOP(L'WORK),XLCHOP                                            
         MVI   BYTE1,0                                                          
         XC    HALF,HALF                                                        
*                                                                               
         USING ROWD,RE                                                          
         L     RE,ACURROW                                                       
         L     RF,ROWACOL                                                       
         MVC   BYTE,0(RF)          CURRENT 'COLUMN'/SEQ NUMBER                  
         DROP  RE                                                               
                                                                                
         L     R4,ARESREC                                                       
         AH    R4,DATADISP                                                      
                                                                                
GTXD10   CLI   RFLEL,0                                                          
         BE    GTXD35                                                           
         CLI   RFLEL,RFLELQ                                                     
         BNE   GTXD15                                                           
         CLC   RFLSEQ,BYTE                                                      
         BNE   GTXD15                                                           
         LA    R5,WORK                                                          
         CLI   RFLTYPE,RFLXDATN                                                 
         BE    GTXD20                                                           
         LA    R5,XLCHOP                                                        
         CLI   RFLTYPE,RFLXDATV                                                 
         BE    GTXD20                                                           
GTXD15   XR    RE,RE                                                            
         IC    RE,RFLLN                                                         
         AR    R4,RE                                                            
         B     GTXD10                                                           
*                                                                               
GTXD20   TM    RFLIND,RFLXDEST     Only for XDATA from Estimates?               
         BNZ   GTXDATH             Yes                                          
         XR    RE,RE               COPY RFLDATA                                 
         IC    RE,RFLLN                                                         
         SHI   RE,RFLLNQ                                                        
         SHI   RE,1                                                             
         BASR  R1,0                                                             
         EX    RE,8(R1)                                                         
         B     *+10                                                             
         MVC   1(0,R5),RFLDATA                                                  
*                                                                               
         XR    R2,R2                                                            
         LA    RE,1(R5)                                                         
         AHI   RE,L'WORK-2         POINT TO END OF WORK/XLCHOP                  
         LA    RF,L'WORK-1                                                      
         CLI   0(RE),0                                                          
         BNE   *+14                                                             
         SHI   RE,1                                                             
         BCT   RF,*-12                                                          
         DC    H'0'                                                             
         MVI   1(RE),X'FF'         MARK END OF WORK/XLCHOP DATA                 
*                                                                               
* Store length before each data in WORK/XLCHOP                                  
GTXD25   TM    0(RE),X'40'                                                      
         BNZ   GTXD30                                                           
         STC   R2,0(RE)            STORE LENGTH OF RFLDATA ENTRY                
         XR    R2,R2                                                            
         B     *+8                                                              
GTXD30   AHI   R2,1                                                             
         SHI   RE,1                                                             
         BCT   RF,GTXD25                                                        
         STC   R2,0(R5)            STORE LENGTH OF FIRST RFLDATA ENTRY          
         B     GTXD15                                                           
*                                                                               
GTXD35   NI    BYTE1,TURNOFF-MATCUR                                             
         XR    RF,RF                                                            
         IC    RF,XDFXDALN                                                      
         LA    RE,XDFXDATA                                                      
*                                                                               
         CLI   XDFXEDIT,XDFEDYQ    IS IT A YES/NO FIELD                         
         BNE   GTXD45                                                           
         LA    RE,1(RF,RE)         RE points to xdata VALUE                     
                                                                                
         CLI   0(RE),C't'          Accept 't' or Y for YES                      
         BE    *+12                                                             
         CLI   0(RE),C'Y'                                                       
         BNE   GTXD40                                                           
         LH    R2,HALF                                                          
         AHI   R2,3                                                             
         CHI   R2,L'TEMPAREA-1                                                  
         BH    GTXD100                                                          
         STH   R2,HALF                                                          
         MVI   0(R6),3             STORE LENGTH                                 
         MVC   1(3,R6),AC@YES      STORE DATA                                   
         LA    RF,4(R6)                                                         
         MVI   0(RF),X'FF'         MARK NEW END                                 
         B     GTXD60                                                           
                                                                                
GTXD40   LH    R2,HALF                                                          
         AHI   R2,2                                                             
         CHI   R2,L'TEMPAREA-1                                                  
         BH    GTXD100                                                          
         STH   R2,HALF                                                          
         MVI   0(R6),2             STORE LENGTH                                 
         MVC   1(2,R6),AC@NO       STORE DATA                                   
         LA    RF,3(R6)                                                         
         MVI   0(RF),X'FF'         MARK NEW END                                 
         B     GTXD60                                                           
*                                                                               
GTXD45   CLI   XDFXEDIT,XDFEDDQ    IS IT A DATE                                 
         BNE   GTXD50                                                           
         LA    RE,1(RF,RE)         RE points to xdata VALUE                     
         GOTO1 DATCON,DMCB,(X'81',0(RE)),(17,1(R6)) CONVERT DATE                
         LH    R2,HALF                                                          
         LLC   RF,4(R1)                                                         
         AR    R2,RF                                                            
         CHI   R2,L'TEMPAREA-1                                                  
         BH    GTXD100                                                          
         STH   R2,HALF                                                          
         MVC   0(1,R6),4(R1)       STORE LENGTH                                 
         LA    RF,1(RF,R6)                                                      
         MVI   0(RF),X'FF'         MARK NEW END                                 
         B     GTXD60                                                           
*                                                                               
GTXD50   CLI   XDFXEDIT,XDFEDAQ    IS IT AN AMOUNT                              
         BNE   GTXD55                                                           
         LA    RE,1(RF,RE)         RE points to xdata VALUE                     
         CURED (P6,0(RE)),(12,1(R6)),2,COMMAS=NO,ALIGN=LEFT,           +        
               MINUS=YES                                                        
         LA    RF,12                                                            
         LA    RE,12(R6)                                                        
         CLI   0(RE),C' '                                                       
         BH    *+14                                                             
         SHI   RE,1                                                             
         BCT   RF,*-12                                                          
         DC    H'0'                                                             
         LH    R2,HALF                                                          
         AR    R2,RF                                                            
         CHI   R2,L'TEMPAREA-1                                                  
         BH    GTXD100                                                          
         ST    R2,HALF                                                          
         STC   RF,0(R6)            STORE LENGTH                                 
         LA    RF,1(RF,R6)                                                      
         MVI   0(RF),X'FF'         MARK NEW END                                 
         B     GTXD60                                                           
*                                                                               
GTXD55   LA    RE,0(RF,RE)                                                      
         IC    RF,0(RE)            RF contains length of xdata VALUE            
         CLI   0(RE),L'TEMPAREA-2                                               
         BNH   *+8                 check if there's enough space left           
         LA    RF,L'TEMPAREA-2                                                  
         LH    R1,HALF                                                          
         LA    R1,1(RF,R1)                                                      
         CHI   R1,L'TEMPAREA-1                                                  
         BH    GTXD100                                                          
*                                                                               
         STH   R1,HALF                                                          
         STC   RF,0(R6)            STORE LENGTH                                 
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         EX    RF,8(R1)                                                         
         B     *+10                                                             
         MVC   1(0,R6),1(RE)       TEMPAREA contains xdata VALUE                
*                                                                               
         LA    RF,2(RF,R6)                                                      
         MVI   0(RF),X'FF'         MARK NEW END                                 
*                                                                               
* find xdata name match                                                         
GTXD60   OC    WORK,WORK           (SHOULD NOT BE EMPTY BUT IF IT IS,           
         BZ    GTXDATL              JUST EXIT)                                  
         LA    RF,WORK                                                          
         LA    RE,XDFXDALN                                                      
*                                                                               
GTXD65   CLC   0(1,RE),0(RF)       COMPARE LENGTHS                              
         BE    GTXD75                                                           
GTXD70   XR    R1,R1               ADVANCE TO NEXT DATA NAME                    
         IC    R1,0(RF)                                                         
         LA    RF,1(R1,RF)                                                      
         CLI   0(RF),X'FF'                                                      
         BE    GTXD95              NO MORE DATA NAMES IN WORK                   
         B     GTXD65                                                           
*                                                                               
GTXD75   XR    R2,R2                                                            
         IC    R2,0(RE)                                                         
         SHI   R2,1                                                             
         BASR  R1,0                                                             
         EX    R2,8(R1)                                                         
         B     *+10                                                             
         OC    1(0,RE),SPACES      (CAPITALIZE)                                 
         BASR  R1,0                                                             
         EX    R2,8(R1)                                                         
         B     *+10                                                             
         CLC   1(0,RE),1(RF)                                                    
         BNE   GTXD70                                                           
         OI    BYTE1,MATCUR+ONEFND FOUND DATA NAME MATCH                        
*                                                                               
* find xdata value match                                                        
         OC    XLCHOP(L'WORK),XLCHOP                                            
         BZ    GTXD95                                                           
         LA    RF,XLCHOP                                                        
*                              R6: FIRST BYTE=LENGTH, REST=DATA                 
GTXD80   CLC   0(1,R6),0(RF)       COMPARE LENGTHS                              
         BE    GTXD90                                                           
GTXD85   XR    R1,R1               ADVANCE TO NEXT DATA VALUE                   
         IC    R1,0(RF)                                                         
         LA    RF,1(R1,RF)                                                      
         CLI   0(RF),X'FF'                                                      
         BE    GTXD95              NO MORE DATA VALUES IN WORK                  
         B     GTXD80                                                           
*                                                                               
GTXD90   IC    R2,0(R6)                                                         
         SHI   R2,1                                                             
         BASR  R1,0                                                             
         EX    R2,8(R1)                                                         
         B     *+10                                                             
         OC    1(0,R6),SPACES     (CAPITALIZE)                                  
         BASR  R1,0                                                             
         EX    R2,8(R1)                                                         
         B     *+10                                                             
         CLC   1(0,R6),1(RF)      DATA VALUE MATCH?                             
         BNE   GTXD85                                                           
*                                                                               
GTXD95   TM    BYTE1,MATCUR       FOUND A MATCH FOR CURRENT DATA NAME?          
         BNZ   GTXD100                                                          
         XR    R1,R1                                                            
         IC    R1,0(R6)                                                         
         AHI   R1,1                                                             
         LH    RF,HALF                                                          
         SR    RF,R1                                                            
         STH   RF,HALF                                                          
         MVI   0(R6),X'FF'                                                      
                                                                                
GTXD100  TM    BYTE1,ONEFND       FOUND AT LEAST ONE PROPER MATCH?              
         BZ    GTXDATL            NO                                            
         ICM   R8,15,PARELADR     CHECK IF THERE ARE ANY (OTHER)                
         XR    R1,R1              DUPLICATE DATA NAME MATCHES (WHICH            
         ICM   R1,1,1(R8)         FIT IN REMAINING SPACE IN TEMPAREA)           
         BNZ   *+6                                                              
         DC    H'0'                                                             
         AR    R8,R1                                                            
         CLI   0(R8),0                                                          
         BE    GTXDATY                                                          
         CLI   0(R8),XDFELQ                                                     
         BNE   GTXDATY                                                          
         ST    R8,PARELADR                                                      
         CLI   0(R6),X'FF'         ALREADY POINTING TO NEXT SPACE               
         BE    GTXD35                                                           
         IC    R1,0(R6)                                                         
         LA    R6,1(R1,R6)         POINT TO NEXT AVAILABLE SPACE                
         B     GTXD35                                                           
*                                                                               
GTXDATH  CLI   *,0                 SET CC HIGH                                  
         B     GTXDATX                                                          
*                                                                               
GTXDATL  CLI   *,X'FF'             SET CC LOW                                   
         B     GTXDATX                                                          
*                                                                               
GTXDATY  XR    R1,R1                                                            
         XR    RE,RE                                                            
         LA    RF,TEMPAREA                                                      
GTXDY01  CLI   0(RF),X'FF'                                                      
         BE    GTXDY02                                                          
         IC    R1,0(RF)                                                         
         MVI   0(RF),C','                                                       
         LA    RF,1(R1,RF)                                                      
         AHI   R1,1                                                             
         AR    RE,R1                                                            
         B     GTXDY01                                                          
GTXDY02  LA    R2,TEMPAREA+1                                                    
         SHI   RE,1                                                             
         STH   RE,PARNEWLN                                                      
         CR    RB,RB               SET CC EQUAL                                 
GTXDATX  XIT1  REGS=(R2)                                                        
         DROP  R3,R4,R7,R8                                                      
                                                                                
ONEFND   EQU   X'01'               AT LEAST ONE MATCH FOUND                     
MATCUR   EQU   X'10'               CURRENT NAME HAS BEEN MATCHED                
                                                                                
         LTORG                                                                  
         EJECT ,                                                                
*&&                                                                             
         TITLE 'TRACE PARSE DATA'                                               
*=====================================================================*         
*        Trace through as we parse data                               *         
*=====================================================================*         
                                                                                
         USING KYWD,R6                                                          
         USING PARSED,R3                                                        
TRACE    NTR1  BASE=*,LABEL=*                                                   
         LTR   R1,R1                                                            
         BNZ   TRACE50                                                          
         L     RF,PARSE#                                                        
         LA    RF,1(,RF)                                                        
         ST    RF,PARSE#                                                        
         MVC   DATAWRK,SPACES                                                   
         MVC   DATAWRK(10),=C' PAR#     '                                       
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  DATAWRK+6(4),DUB                                                 
         LTR   R6,R6                                                            
         BZ    *+10                                                             
         MVC   DATAWRK+14(6),KYWCODE                                            
         ST    R3,FULL                                                          
         GOTO1 PRNTBL,DMCB,(22,DATAWRK),FULL,1,4,=C'1H'                         
         CLC   QUESTOR(2),=C'##'                                                
         BNE   TRACE99                                                          
         LA    RF,4                                                             
         LA    RE,QUESTOR+2                                                     
TRACE20  CLI   0(RE),BLANK                                                      
         BNH   TRACE22                                                          
         LA    RE,1(,RE)                                                        
         BCT   RF,TRACE20                                                       
*                                                                               
TRACE22  LA    RF,QUESTOR+2                                                     
         SR    RE,RF                                                            
         BNP   TRACE99                                                          
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         PACK  DUB,0(0,RF)                                                      
         NI    DUB+7,X'FC'                                                      
         CVB   R1,DUB                                                           
         C     R1,PARSE#                                                        
         BNE   *+6                                                              
         DC    H'00'                                                            
         B     TRACE99                                                          
*                                                                               
TRACE50  LH    RF,DATA#                                                         
         LA    RF,1(,RF)                                                        
         STH   RF,DATA#                                                         
         MVC   DATAWRK(10),=C' DATA     '                                       
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  DATAWRK+6(4),DUB                                                 
         LR    RF,R3                                                            
         S     RF,PRSBASE                                                       
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  DATAWRK+14(8),DUB                                                
         SR    RF,RF                                                            
         ICM   RF,3,PARTOLEN                                                    
         GOTO1 PRNTBL,DMCB,(22,DATAWRK),(R4),C'DUMP',(RF),=C'2D'                
         CLI   QSELECT,C'D'                                                     
         BNE   TRACE99                                                          
         CLC   DATA#,QUESTOR                                                    
         BNE   *+6                                                              
         DC    H'00'                                                            
*                                                                               
TRACE99  XIT1                                                                   
         SPACE 2                                                                
PARSE#   DC    F'0'                                                             
DATA#    DC    H'0'                                                             
DATAWRK  DS    CL22                                                             
         DROP  R6                                                               
         LTORG                                                                  
***********************************************************************         
*  GETS HARD CODE NAME OF EST USER FIELD (AOR)                        *         
***********************************************************************         
         SPACE 1                                                                
         USING PARSED,R3                                                        
         USING BRANDD,R6                                                        
GAOR     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLI   PARELEM,UFSELQ      X'A2' ELEMENT                                
         BNE   GETAOR15                                                         
         CLC   =C'E2',0(R8)        MUST BE ESTIMATE 2                           
         BNE   GAORXL              LOOP FOR ANOTHER ONE                         
         CLI   BYTE,YES                                                         
         BE    GETAOR08                                                         
         CLI   1(R2),BLANK         IS IT A ONE BYTE NUMBER                      
         BNE   GAORXE              POINTING AT CODE ALREADY                     
         MVC   1(1,R2),0(R2)       MOVE NUMBER IN BY ONE                        
         MVI   0(R2),C'0'          PAD WITH CHARACTER "0"                       
         B     GAORXE                                                           
*                                                                               
GETAOR08 LR    R1,R2                                                            
         L     R8,BNMBASE          A(BRAND NAME TABLE)                          
GETAOR10 CLI   0(R8),EOT           END OF TABLE?                                
         BE    GETAOR12            NONE MATCHED                                 
         LA    R2,3(,R8)           POINT TO NAME                                
         CLC   0(2,R8),0(R1)       COMPARE AGENCY CODE TO GET NAME              
         BE    GAORXE              FOUND MATCH                                  
         LA    R8,BRNDNMQ(,R8)     BUMP UP                                      
         B     GETAOR10                                                         
*                                                                               
GETAOR12 L     R2,BNMBASE          A(BRAND NAME TABLE)                          
         LA    R2,3(R2)            POINT TO DEFAULT NAME                        
         B     GAORXE                                                           
*                                                                               
GETAOR15 CLI   0(R2),C'J'          IS IT JOB?                                   
         BE    GAORXH              YES SO IGNORE                                
         ICM   R6,15,AORENTRY      CHECK PREVIOUS ENRTY                         
         BZ    GETAOR20                                                         
         CLC   BRANDKEY,0(R2)                                                   
         BE    GETAOR70            ALREADY HAVE ENTRY                           
*                                                                               
GETAOR20 LA    R6,BRANDBUF                                                      
         MVC   BRANDBUF,SPACES                                                  
         MVC   BRANDBUF(8),0(R2)   MOVE IN SYS/MEDIA/CLI/PRD                    
         MVC   BRANDEST,=C'000'    MOVE IN EST PADDING                          
         LA    R1,3                MAX LENGTH OF ESTIMATE                       
         LA    RE,10(R2)           POINT TO END OF ESTIMATE FIELD               
         LA    RF,BRANDEST         POINT TO BEGINING OF EST FIELD               
GETAOR22 CLI   0(RE),BLANK         CHECK FOR BLANKS                             
         BNE   GETAOR24            GOT LENGTH SO FINISHED                       
         BCTR  RE,R0               BUMP BACK THE ADDRESS BY ONE                 
         LA    RF,1(RF)                                                         
         BCT   R1,GETAOR22         LOOP AGAIN                                   
         B     GAORXH              NO ESTIMATE SO EXIT CC=NO                    
GETAOR24 BCTR  R1,0                ONE FOR EXCUTE (ROAD)                        
         EXMVC R1,0(RF),8(R2)      MOVE IN ESTIMATE                             
*                                                                               
         CLC   =C'SI',BRANDSYS     OVERIDE THIS MED IF SYS/MED = SI             
         BNE   *+8                                                              
         MVI   BRANDMED,C'N'                                                    
         CLC   =C'HN',BRANDSYS     OVERIDE THIS MED IF SYS/MED = HN             
         BE    *+10                                                             
         CLC   =C'IN',BRANDSYS     OVERIDE THIS SYS IF SYS/MED = IN             
         BNE   *+8                                                              
         MVI   BRANDSYS,C'S'                                                    
*                                                                               
         GOTO1 BINSRCH,DMCB,(2,BRANDBUF),BRNBASE,NBRNREC,A(BRANDLNQ),  X        
               (0,L'BRANDKEY),A(MAXBRANQ)                                       
         ICM   R6,15,DMCB                                                       
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
*                                                                               
         CLC   BRANDBUF(L'BRANDKEY),0(R6)                                       
         BNE   GAORXH                                                           
         ST    R6,AORENTRY         BRAND SAVED ENTRY                            
GETAOR70 CLI   BYTE,YES            GET NAME IF YES                              
         BE    GETAOR80                                                         
         LA    R2,BRANDAOR                                                      
         B     GAORXE                                                           
*                                                                               
GETAOR80 SR    R8,R8                                                            
         IC    R8,BRANDNME                                                      
         MHI   R8,BRNDNMQ                                                       
         A     R8,BNMBASE          NAME TABLE                                   
         LA    R2,3(,R8)           POINT TO NAME                                
         B     GAORXE                                                           
*                                                                               
GAORXH   CLI   *,0                 SET CC HIGH                                  
         B     GAORXX                                                           
GAORXL   CLI   *,X'FF'             SET CC LOW                                   
         B     GAORXX                                                           
GAORXE   CR    RB,RB               SET CC EQUAL                                 
GAORXX   DS    0H                                                               
*&&US*&& XIT1  REGS=(R2)                                                        
*&&UK*&& XIT1                                                                   
         DROP  R3,R6                                                            
         EJECT ,                                                                
***********************************************************************         
*  BALANCE OF SJ TRANSACTION DATE SENSITIVE                           *         
***********************************************************************         
         SPACE 1                                                                
         USING COLD,R2                                                          
         USING PARSED,R3                                                        
         USING FMTRECD,R5                                                       
         USING PTAELD,R8                                                        
VBALSJ   NTR1  BASE=*,LABEL=*                                                   
         L     R2,ACURCOL                                                       
         TM    TRNSSTAT,X'80'                                                   
         BO    VBALSJ08                                                         
         TM    CURIND,CURBILCR     A BILLED ONLY CREDIT?                        
         BZ    VBALSJ99            Set cc to NEQ                                
*                                                                               
VBALSJ08 ZAP   BALTAMT,PKZERO                                                   
         ZAP   BALTHRS,PKZERO                                                   
         ZAP   BALTCD,PKZERO       CASH DISCOUNT                                
         TM    PARELEM,X'08'       IF ZERO GET CD                               
         BO    VBALSJ10                                                         
         GOTO1 PARSE,DMCB,GETCSHD,BALTCD,0,0                                    
*                                                                               
VBALSJ10 ZAP   DUB,TRNSAMT         THIS IS TO REVERSE SIGN                      
         AP    DUB,BALTCD          ADD IN CD                                    
         ZAP   DOUBLE,PKZERO                                                    
*                                                                               
         USING PRTELD,R6                                                        
         ICM   R6,15,AELEM40       HOURS ELEMENT                                
         BZ    *+10                                                             
         ZAP   DOUBLE,PRTHOUR                                                   
*&&UK                                                                           
         USING SCIELD,R6                                                        
         ICM   R6,15,AELEM50T      SCITSJHR (UK ONLY)                           
         BZ    *+10                                                             
         ZAP   DOUBLE,SCIAMNT      HOURS CONTRA 1P (I THINK)                    
*&&                                                                             
         DROP  R6                                                               
*                                                                               
         LA    R6,MOADTE           LOAD TRANSACTION MOA                         
         CLI   COLDATES,COLMDTE                                                 
         BE    *+8                                                              
         LA    R6,TRANDTE          LOAD TRANSACTION DATE                        
         CLC   COLEND,0(R6)        BASED ON TRANSACTION DATE OR MOA             
         BL    VBALSJ20                                                         
         CLC   COLSTART,0(R6)                                                   
         BH    VBALSJ20                                                         
         ZAP   BALTAMT,DUB         DOLLARS                                      
         ZAP   BALTHRS,DOUBLE      HOURS                                        
*                                                                               
VBALSJ20 ICM   R8,15,APTAWRK       X'77' POOL                                   
         BZ    VBALSJ90            FINISHED                                     
VBALSJ40 CLI   PTAEL,0             END OF ELEMENTS                              
         BE    VBALSJ90            FINISHED                                     
         CLI   PTAEL,PTAELQ        MAKE SURE X'77'                              
         BNE   VBALSJ80            GET NEXT                                     
         TM    PARELEM,X'02'       IGNORE ALLOCATED?                            
         BZ    VBALSJ42            DON'T USE ANY PENDING AMOUNT                 
         CLI   PTATYPE,PTATRAL     BILLED IS ALLOCATED                          
         BE    VBALSJ45            YES, SO INCLUDE                              
*                                                                               
VBALSJ42 TM    PTASTAT1,PTASPEND   CAN'T BE PENDING                             
         BO    VBALSJ80            NEXT                                         
*                                                                               
VBALSJ45 ZAP   DUB,PTANET          DOLLAR AMOUNT                                
         TM    PARELEM,X'08'       GET BILLED CD?                               
         BO    *+10                                                             
         AP    DUB,PTACDSC         ADD IN CASH DISCOUNT                         
         MVC   HALF,PTAHOURS       FORCE ON BOUNDRY                             
         LH    RF,PTAHOURS                                                      
         CVD   RF,DOUBLE           HOUR AMOUNT                                  
         LA    R6,PTAMOA                                                        
         CLI   COLDATES,COLMDTE    BASED ON BILLED DATE OR BILLED MOA           
         BE    VBALSJ50                                                         
         LR    R6,R8                                                            
         SR    RF,RF                                                            
         IC    RF,PTALN                                                         
         AHI   RF,-3                                                            
         AR    R6,RF               POINT TO SAVED BILLED/TRNS/W-OFF DTE         
*                                                                               
VBALSJ50 CLC   COLALTEN,0(R6)                                                   
         BL    VBALSJ80                                                         
         CLC   COLALTST,0(R6)                                                   
         BH    VBALSJ80                                                         
         SP    BALTAMT,DUB         DOLLARS                                      
         SP    BALTHRS,DOUBLE      HOURS                                        
*                                                                               
VBALSJ80 SR    RF,RF                                                            
         IC    RF,PTALN                                                         
         AR    R8,RF                                                            
         B     VBALSJ40                                                         
*                                                                               
VBALSJ90 LA    R2,BALTAMT                                                       
         TM    PARELEM,X'40'       Process hours ?                              
         BZ    VBALSJ98                                                         
         LA    R2,BALTHRS                                                       
*                                                                               
VBALSJ98 SR    RE,RE               Set cc to EQ                                 
*                                                                               
VBALSJ99 LTR   RE,RE                                                            
         XIT1  REGS=(R2)                                                        
         DROP  R2,R3,R5,R8                                                      
         SPACE 1                                                                
BALTAMT  DC    PL(PKLEN)'0'                                                     
BALTHRS  DC    PL(PKLEN)'0'                                                     
BALTCD   DC    PL(PKLEN)'0'                                                     
         SPACE 1                                                                
         LTORG                                                                  
         EJECT ,                                                                
*=====================================================================*         
*       Get File maintance rate                                       *         
*=====================================================================*         
         USING FMRATED,R6                                                       
GETFRATE NTR1  BASE=*,LABEL=*                                                   
         L     R6,ARATEBLK                                                      
         XC    RATSTAT2(RAT2AMTC-RATSTAT2),RATSTAT2                             
         MVC   RATSJCPJ,CURSJACC   CLI/PROD/JOB                                 
         MVC   RATCRDTE,TRANDTE                                                 
         MVC   RATSJOFF,CURCOFF                                                 
         MVC   RATSJTSK,CURWKCD                                                 
         MVC   RAT1ROFF(14),SPACES                                              
*                                                                               
         CLI   QPROG,MANPOWER      Person Scribe ?                              
         BNE   GETFRT30                                                         
         MVC   RAT1RACT,CURACC+3                                                
         B     GETFRT40                                                         
*                                                                               
GETFRT30 CLI   QPROG,PRODUCTION                                                 
         BNE   GETFRN                                                           
         CLC   =C'1R',CURSUBAC                                                  
         BE    GETFRT32                                                         
*&&UK*&& CLC   =C'1P',CURSUBAC                                                  
*&&UK*&& BNE   GETFRN                                                           
                                                                                
GETFRT32 MVC   RAT1RACT,CURSUBAC+3                                              
*                                                                               
GETFRT40 LA    RE,RAT1RACT                                                      
         SR    R1,R1                                                            
         IC    R1,RAT1RL1                                                       
         LR    RF,R1               Save length                                  
         BCTR  R1,0                                                             
         EXMVC R1,RAT1ROFF,0(RE)                                                
*                                                                               
         IC    R1,RAT1RL2                                                       
         AR    RE,RF               Point to next level                          
         LR    RF,R1               Set for next level                           
         BCTR  R1,0                                                             
         EXMVC R1,RAT1RDPT,0(RE)                                                
*                                                                               
         IC    R1,RAT1RL3                                                       
         AR    RE,RF               Point to next level                          
         LR    RF,R1               Set for next level                           
         BCTR  R1,0                                                             
         EXMVC R1,RAT1RSUB,0(RE)                                                
*                                                                               
         IC    R1,RAT1RL4                                                       
         AR    RE,RF               Point to next level                          
         LR    RF,R1               Set for next level                           
         BCTR  R1,0                                                             
         EXMVC R1,RAT1RPER,0(RE)                                                
*                                                                               
         GOTO1 AGETFRTE,(R6)                                                    
*                                                                               
GETFRT90 OC    RATEAMNT,RATEAMNT                                                
         BZ    GETFRN              No rate                                      
         LA    R2,RATEAMNT                                                      
                                                                                
GETFRY   CR    RB,RB                                                            
         B     *+6                                                              
GETFRN   LTR   RB,RB                                                            
         XIT1  REGS=(R2)                                                        
         DROP  R6                                                               
         EJECT ,                                                                
***********************************************************************         
*  GET TIMESHEET HOURS (1R)                                                     
***********************************************************************         
         SPACE 1                                                                
         USING FMTRECD,R5                                                       
         USING TIMELD,R6                                                        
GTHRS    NTR1  BASE=*,LABEL=*                                                   
                                                                                
         OC    AELMTMS1,AELMTMS1                                                
         BZ    GTHRSN                                                           
         XC    FULL,FULL                                                        
         L     R6,AELMTMS1                                                      
         MVC   FULL+1(3),TIMHRS                                                 
         OC    CURPDTE,CURPDTE     DAILY DATE KEYWORD?                          
         BZ    *+14                                                             
         MVC   FULL+1(3),CURHRS    yes, USE CURRENT HOURS SAVED IN RL02         
         B     GTHRSY                                                           
*&&UK*&& TM    FMTROPT6,RPFFPDRD                                                
*&&US*&& TM    FMTROPT7,RPFFPDRD                                                
         BNO   GTHRSY                                                           
                                                                                
         OC    AELMTMS7,AELMTMS7                                                
         BZ    GTHRSY                                                           
                                                                                
         L     R6,AELMTMS7                                                      
         ZAP   FULL,PKZERO                                                      
         XR    RE,RE                                                            
         IC    RE,TIMLN                                                         
         AR    RE,R6                                                            
         LA    R6,TIMETDT1                                                      
GTHRS10  CLC   0(L'TIMETDT1,R6),RSTADTE                                         
         BL    GTHRS20                                                          
         CLC   0(L'TIMETDT1,R6),RENDDTE                                         
         BH    GTHRSY                                                           
         AP    FULL,L'TIMETDT1(L'TIMEHRS1,R6)                                   
GTHRS20  AHI   R6,L'TIMETDT1+L'TIMEHRS1                                         
         CR    R6,RE                                                            
         BL    GTHRS10                                                          
                                                                                
GTHRSY   LA    R2,FULL                                                          
         CR    RB,RB                                                            
         B     *+6                                                              
GTHRSN   LTR   RB,RB                                                            
         XIT1  REGS=(R2)                                                        
         DROP  R6                                                               
         SPACE 1                                                                
         EJECT ,                                                                
***********************************************************************         
*  GET EXPENDITURE TYPE NAME                                                    
***********************************************************************         
         SPACE 2                                                                
         USING PARSED,R3                                                        
         USING ETBIND,R6                                                        
         USING PARWRKD,R7                                                       
         USING ETYRECD,R8                                                       
GTETYN   NTR1  BASE=*,LABEL=*                                                   
         L     R3,0(,R1)                                                        
         L     R7,4(,R1)                                                        
*                                                                               
         LA    R8,IOKEY                                                         
         XC    IOKEY,IOKEY                                                      
         MVI   ETYKTYP,ETYKTYPQ                                                 
         MVI   ETYKSUB,ETYKSUBQ                                                 
         MVC   ETYKCPY,CURACC      COMPANY                                      
*                                                                               
         GOTO1 PARSE,DMCB,PARADDR,ETYKCODE,0,0                                  
         BNE   GTETYNN                                                          
*                                                                               
         SAM31                     31 Bit mode                                  
         XC    WORK,WORK                                                        
         LA    R6,WORK                                                          
         MVC   ETBCODE,ETYKCODE                                                 
         LH    RF,ETNAME#                                                       
         GOTO1 BIN31,DMCB,ETBIND,ETYBASE,(RF),(1,ETBLNQ),              X        
               (0,ETBKEYQ),A(MAXETY)                                            
*                                                                               
         XC    SVR6,SVR6                                                        
         ICM   R6,15,DMCB          LOAD WHERE INSERTED OR FOUND                 
         BZ    GTETYN30            RECORD NOT FOUND AND TABLE FULL              
         ST    R6,SVR6             SAVE OFF ADDRESS ON ENTRY                    
         TM    DMCB,X'80'          FOUND?                                       
         BO    GTETYN30            NO                                           
         MVC   WORK(L'ETBNAME),ETBNAME                                          
         B     GTETYNY             GET NAME                                     
*                                                                               
GTETYN30 SAM24                     24 Bit mode                                  
         L     R1,=AL4(IOHIGH+IOAREA1+IOACFIL)                                  
         GOTO1 AIO                                                              
         BNE   GTETYNN             DATA NOT FOUND, EXIT                         
         L     R2,AIO1                                                          
         CLC   IOKEY(ETYKOFFC-ETYRECD),0(R2)                                    
         BNE   GTETYNN                                                          
         SAM31                     31 Bit mode                                  
*                                                                               
         USING NAMELD,R2                                                        
         SR    RF,RF                                                            
         AH    R2,DATADISP         GET TO FIRST ELEMENT                         
GTETYN35 CLI   NAMEL,0             END OF RECORD?                               
         BE    GTETYNY                                                          
         CLI   NAMEL,NAMELQ        X'20' GET NAME ELEMENT                       
         BE    GTETYN36                                                         
         IC    RF,NAMLN                                                         
         AR    R2,RF                                                            
         B     GTETYN35                                                         
*                                                                               
GTETYN36 IC    RF,NAMLN                                                         
         SHI   RF,NAMLN1Q          RF = SHOULD BE LENGTH OF NAME                
         BNP   GTETYNN             BAD NAME ELEMENT                             
         STH   RF,PARNEWLN         SAVE LENGTH OF NAME                          
         LA    R2,NAMEREC          POINT TO DATA (NAME)                         
*                                                                               
         ICM   R6,15,SVR6                                                       
         BZ    GTETYNY             Table full, so can't add                     
         MVC   ETBNAME,SPACES                                                   
         BCTR  RF,0                                                             
         EXMVC RF,ETBNAME,NAMEREC  SAVE EXPENDITURE TYPE NAME                   
*                                  FOUND DATA, SO RETRIVE IT                    
GTETYNY  SR    R8,R8                                                            
*                                                                               
GTETYNN  LTR   R8,R8                                                            
         SAM24                     24 Bit mode                                  
         XIT1  REGS=(R2)                                                        
         DROP  R2,R3,R6,R7,R8                                                   
         EJECT ,                                                                
         LTORG                                                                  
***********************************************************************         
* Get Estimate (local) number OR status                                         
*                                                                               
* Ntry: P1 byte  0   0 for estimate number                                      
*       P1 bytes 1-3 A(FFTTESTN/FFTDATA)                                        
* Or                                                                            
*       P1 byte  0   1 for estimate status                                      
*       P1 bytes 1-3 A(FFTTESTN/FFTDATA)                                        
* Or                                                                            
*       P1 byte  0   2 to translate saved estimate status bytes                 
*       P1 bytes 1-3 A(ESTSTAS)                                                 
* Or                                                                            
*       P1 byte  0   3 for extra estimate filtering                             
*       P1 bytes 1-3 A(FFTTESTN/FFTDATA)                                        
***********************************************************************         
         SPACE 1                                                                
GTESTN   NTR1  BASE=*,LABEL=*                                                   
         MVC   BYTE,0(R1)                                                       
*                                                                               
         CLI   BYTE,2                  Translate estimate status bytes?         
         BNE   GTESN00                                                          
         L     R3,0(,R1)                                                        
         LA    R3,0(,R3)               Clear HOB                                
         BAS   RE,TRESTS                                                        
         LA    R2,BYTE2                                                         
         B     GTESTNY                                                          
*                                                                               
GTESN00  ICM   R2,B'0111',1(R1)    R2=A(FFTTESTN/FFTDATA)                       
                                                                                
         USING ESTMD,R6                                                         
         L     R6,ESTMAIN                                                       
         CLI   0(R6),0                                                          
         BNH   GTESTNN             (table not initialised)                      
GTESN02  CLI   0(R6),EOT                                                        
         BE    GTESTNN                                                          
         CLC   0(L'ESTWLG,R6),0(R2)                                             
         BE    *+12                                                             
         AHI   R6,ESTMLNQ                                                       
         B     GTESN02                                                          
                                                                                
         MVC   CURESTA1,ESTSTA1                                                 
         MVC   CURESTA2,ESTSTA2                                                 
                                                                                
         LA    R3,ESTSTA1                                                       
         BAS   RE,TRESTS                                                        
                                                                                
         CLI   BESTAS,0            Any BrO Est status filter?                   
         BE    GTESN04             no                                           
         CLI   BESTAS,X'FF'        Include all statuses?                        
         BE    GTESN04             yes                                          
         MVC   BYTE1,BESTAS                                                     
         NC    BYTE1,CBESTA                                                     
         BZ    GTESTNN                                                          
*                                                                               
GTESN04  CLI   BYTE,3              Extra filtering only?                        
         BE    GTESTNY                                                          
         CLI   BYTE,1              Also want estimate status?                   
         BNE   GTESN06                                                          
         LA    R2,BYTE2                                                         
         B     GTESTNY                                                          
*                                                                               
GTESN06  CLI   BYTE,0              Or want local estimate number?               
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   CURLCNO,ESTML#                                                   
         LA    R2,CURLCNO                                                       
         B     GTESTNY                                                          
                                                                                
TRESTS   LA    R1,ESTAB                                                         
         LA    RF,ESTABX                                                        
         XC    BYTE2,BYTE2                                                      
TRESTS02 MVC   BYTE1,1(R1)                                                      
         NC    BYTE1,0(R3)         Match on ESTKSTA1?                           
         BZ    TRESTS04                                                         
         OC    BYTE2,BYTE2                                                      
         BNZ   *+10                                                             
         MVC   BYTE2,3(R1)                                                      
         CLI   2(R1),0             Is the second status byte used?              
         BE    TRESTS03                                                         
         MVC   BYTE1,2(R1)                                                      
         NI    BYTE1,X'FF'-(ESTKFCUR+ESTKLANG+ESTKBILP+ESTKBILA)                
         NC    BYTE1,1(R3)         Match on ESTKSTA2?                           
         BZ    TRESTS04                                                         
         MVC   BYTE2,3(R1)                                                      
TRESTS03 MVC   CBESTA,0(R1)                                                     
                                                                                
TRESTS04 AHI   R1,ESTABQ                                                        
         BCT   RF,TRESTS02                                                      
         BR    RE                                                               
*                                                                               
GTESTNY  SR    R6,R6                                                            
GTESTNN  LTR   R6,R6                                                            
         XIT1  REGS=(R2)                                                        
         DROP  R6                                                               
                                                                                
ESTAB    DS    0F                                                               
         DC    AL1(BESPRG),AL1(ESTKCREA,0),C'P'                                 
ESTABQ   EQU   *-ESTAB                                                          
         DC    AL1(BESSCL),AL1(ESTKSUBM,0),C'S'                                 
         DC    AL1(BESSIN),AL1(ESTKSUBM,ESTKSINA),C'B'                          
         DC    AL1(BESCAP),AL1(ESTKCAPP,0),C'A'                                 
         DC    AL1(BESREJ),AL1(ESTKREJE,0),C'R'                                 
         DC    AL1(BESDEL),AL1(ESTKLOGD,0),C'D'                                 
         DC    AL1(BESIAP),AL1(ESTKINTA,0),C'I'                                 
         DC    AL1(BESMRG),AL1(ESTKLOGD,ESTKMERG),C'M'                          
ESTABX   EQU   (*-ESTAB)/ESTABQ                                                 
         EJECT ,                                                                
*&&UK                                                                           
***********************************************************************         
*  Get Estimate Extra Data                                                      
***********************************************************************         
         SPACE 2                                                                
         USING ACRL2D,R3                                                        
         USING PARWRKD,R7                                                       
GTEXDA   NTR1  BASE=*,LABEL=*                                                   
         L     R3,AACRL2D                                                       
         L     R7,0(,R1)                                                        
*                                                                               
         USING ROWD,RE                                                          
         L     RE,ACURROW                                                       
         L     RF,ROWACOL                                                       
         MVC   BYTE,0(RF)          CURRENT 'COLUMN'/SEQ NUMBER                  
         DROP  RE                                                               
         XC    BYTE1,BYTE1                                                      
         XC    HALF,HALF                                                        
         MVC   TEMPAREA,SPACES                                                  
         LA    R2,TEMPAREA                                                      
         MVI   0(R2),X'FF'                                                      
*                                                                               
         USING XDATED,R8                                                        
         L     R8,AXDATNE                                                       
         XR    R1,R1                                                            
GTEXDA10 CLI   XDATCOL,EOT                                                      
         BE    GTEXDAN                                                          
         CLC   XDATCOL,BYTE                                                     
         BE    GTEXDA20                                                         
         IC    R1,XDATDLN                                                       
         AR    R8,R1                                                            
         B     GTEXDA10                                                         
*                                                                               
         USING ESTRECD,R4                                                       
GTEXDA20 LA    R4,IOKEY                                                         
         XC    ESTKEY,ESTKEY                                                    
         MVI   ESTKTYP,ESTKTYPQ                                                 
         MVI   ESTKSUB,ESTKSUBQ                                                 
         MVC   ESTKCPY,CURACC                                                   
         LA    RE,CURSJACC                                                      
         ZIC   RF,SJCLILEN         Length of client                             
         BCTR  RF,0                                                             
         EXMVC RF,ESTKCLI,0(RE)                                                 
         LA    RE,1(RF,RE)         Point to product                             
         IC    RF,SJPRDLEN         Length of product                            
         BCTR  RF,0                                                             
         EXMVC RF,ESTKPRO,0(RE)                                                 
         LA    RE,1(RF,RE)         Point to job                                 
         IC    RF,SJJOBLEN         Length of product                            
         BCTR  RF,0                                                             
         EXMVC RF,ESTKJOB,0(RE)                                                 
         OC    ESTKSJ,SPACES                                                    
         PACK  DUB,CURLCNO                                                      
         CVB   R1,DUB                                                           
         STC   R1,ESTKLNO                                                       
         MVI   ESTKSEQ,1                                                        
         MVC   WORK(L'ESTKEY),ESTKEY                                            
         L     R1,=AL4(IOHIGH+IOACDIR+IOAREA1)                                  
         GOTO1 AIO                                                              
GTEXDA40 L     R1,=AL4(IOGETREC+IOACMST+IOAREA1)                                
         GOTO1 AIO                                                              
         B     GTEXDA70                                                         
*                                                                               
GTEXDA50 MVC   IOKEY,WORK                                                       
         L     R1,=AL4(IOREAD+IOACDIR+IOAREA1)                                  
         GOTO1 AIO                                                              
         L     R1,=AL4(IOSEQ+IOACDIR+IOAREA1)                                   
         GOTO1 AIO                                                              
         B     GTEXDA40                                                         
*                                                                               
GTEXDA70 L     R4,AIO1                                                          
         CLC   ESTKEY(ESTKSEQ-ESTRECD),WORK                                     
         BNE   GTEXD190                                                         
         MVC   WORK(L'ESTKEY),ESTKEY                                            
*                                                                               
         LA    R4,ESTRFST                                                       
         USING XDFELD,R4                                                        
GTEXDA80 CLI   XDFEL,0                                                          
         BE    GTEXDA50                                                         
         CLI   XDFEL,XDFELQ                                                     
         BE    GTEXDA95                                                         
GTEXDA90 XR    R1,R1                                                            
         IC    R1,XDFLN                                                         
         AR    R4,R1                                                            
         B     GTEXDA80                                                         
*                                                                               
         USING XDFPASD,R6                                                       
GTEXDA95 LA    R6,IOKEY                                                         
         XC    XDFPAS,XDFPAS                                                    
         MVI   XDFPTYP,XDFPTYPQ                                                 
         MVI   XDFPSUB,XDFPSUBQ                                                 
         MVC   XDFPCPY,CURACC                                                   
         MVC   XDFPPTR(L'XDFOCOD),XDFOCOD                                       
         L     R1,=AL4(IOREAD+IOACDIR+IOAREA3)                                  
         GOTO1 AIO                                                              
         BNE   GTEXDA90                                                         
         L     R1,=AL4(IOGETREC+IOACMST+IOAREA3)                                
         GOTO1 AIO                                                              
*                                                                               
         L     R6,AIO3                                                          
         AHI   R6,XDFRFST-XDFRECD                                               
XD       USING XDFELD,R6                                                        
         XR    R1,R1                                                            
GTEXD100 CLI   XD.XDFEL,0                                                       
         BE    GTEXDA90                                                         
         CLI   XD.XDFEL,XDFELQ                                                  
         BNE   GTEXD105                                                         
         CLC   XD.XDFSEQ,XDFOCOD+2                                              
         BNE   GTEXD105                                                         
         LA    RF,XDATNMS                                                       
         ZIC   R5,XDATNUM                                                       
         B     GTEXD110                                                         
GTEXD105 IC    R1,XD.XDFLN                                                      
         AR    R6,R1                                                            
         B     GTEXD100                                                         
*                                                                               
GTEXD110 IC    R1,XD.XDFLN                                                      
         SHI   R1,XDFLN1Q                                                       
         CLM   R1,1,0(RF)          COMPARE LENGTHS                              
         BNE   GTEXD120                                                         
         BCTR  R1,0                                                             
         OC    XD.XDFNAME(0),SPACES                                             
         EX    R1,*-6                                                           
         CLC   XD.XDFNAME(0),1(RF)                                              
         EX    R1,*-6                                                           
         BE    GTEXD130                                                         
GTEXD120 LA    RF,1(R1,RF)                                                      
         BCT   R5,GTEXD110                                                      
         B     GTEXDA90                                                         
         DROP  XD                                                               
*                                                                               
GTEXD130 NI    BYTE1,TURNOFF-MATCUR                                             
         XR    R1,R1                                                            
         CLI   0(R2),X'FF'         ALREADY POINTING TO NEXT SPACE               
         BE    *+12                                                             
         IC    R1,0(R2)                                                         
         LA    R2,1(R1,R2)         POINT TO NEXT AVAILABLE SPACE                
                                                                                
         LA    RE,XDFODTA                                                       
         CLI   XDFOTYP,XDFEDYQ     IS IT A YES/NO FIELD                         
         BNE   GTEXD145                                                         
*                                                                               
         CLI   0(RE),C't'          Accept 't' or Y for YES                      
         BE    *+12                                                             
         CLI   0(RE),C'Y'                                                       
         BNE   GTEXD140                                                         
*                                                                               
         LH    RF,HALF                                                          
         AHI   RF,3                                                             
         CHI   RF,L'TEMPAREA-1                                                  
         BH    GTEXD200                                                         
         STH   RF,HALF                                                          
         MVI   0(R2),3             STORE LENGTH                                 
         MVC   1(3,R2),AC@YES      STORE DATA                                   
         LA    RF,4(R2)                                                         
         MVI   0(RF),X'FF'         MARK NEW END                                 
         B     GTEXD160                                                         
*                                                                               
GTEXD140 LH    RF,HALF                                                          
         AHI   RF,2                                                             
         CHI   RF,L'TEMPAREA-1                                                  
         BH    GTEXD200                                                         
         STH   RF,HALF                                                          
         MVI   0(R2),2             STORE LENGTH                                 
         MVC   1(2,R2),AC@NO       STORE DATA                                   
         LA    RF,3(R2)                                                         
         MVI   0(RF),X'FF'         MARK NEW END                                 
         B     GTEXD160                                                         
*                                                                               
GTEXD145 CLI   XDFOTYP,XDFEDDQ     IS IT A DATE                                 
         BNE   GTEXD150                                                         
         GOTO1 DATCON,DMCB,(X'81',0(RE)),(17,1(R2)) CONVERT DATE                
         LH    R0,HALF                                                          
         LLC   RF,4(R1)                                                         
         AR    R0,RF                                                            
         CHI   R0,L'TEMPAREA-1                                                  
         BH    GTEXD200                                                         
         STH   R0,HALF                                                          
         MVC   0(1,R2),4(R1)       STORE LENGTH                                 
         LA    RF,1(RF,R2)                                                      
         MVI   0(RF),X'FF'         MARK NEW END                                 
         B     GTEXD160                                                         
*                                                                               
GTEXD150 CLI   XDFOTYP,XDFEDAQ     IS IT AN AMOUNT                              
         BNE   GTEXD155                                                         
         CURED (P6,0(RE)),(12,1(R2)),2,COMMAS=NO,ALIGN=LEFT,MINUS=YES           
         LA    RF,12                                                            
         LA    RE,12(R2)                                                        
         CLI   0(RE),C' '                                                       
         BH    *+14                                                             
         SHI   RE,1                                                             
         BCT   RF,*-12                                                          
         DC    H'0'                                                             
         STC   RF,0(R2)            STORE LENGTH                                 
         LA    RF,1(RF,R2)                                                      
         MVI   0(RF),X'FF'         MARK NEW END                                 
         B     GTEXD160                                                         
*                                                                               
GTEXD155 XR    R1,R1                                                            
         IC    R1,XDFLN                                                         
         SHI   R1,XDFOLNQ                                                       
         CHI   R1,L'TEMPAREA-2                                                  
         BNH   *+8                 check if there's enough space left           
         LA    R1,L'TEMPAREA-2                                                  
         LH    RF,HALF                                                          
         LA    RF,1(R1,RF)                                                      
         CHI   RF,L'TEMPAREA-1                                                  
         BH    GTEXD200                                                         
                                                                                
         STH   RF,HALF                                                          
         STC   R1,0(R2)                                                         
         BCTR  R1,0                                                             
         EXMVC R1,1(R2),0(RE)                                                   
         LA    R1,2(R1,R2)                                                      
         MVI   0(R1),X'FF'         MARK NEW END                                 
         B     GTEXD160                                                         
*                                                                               
GTEXD160 L     RE,AXDATVE          CHECK FOR XDATA VALUE MATCH                  
V        USING XDATED,RE                                                        
         XR    R0,R0                                                            
GTEXD165 CLI   V.XDATCOL,EOT                                                    
         BNE   GTEXD170                                                         
GTEXD166 OI    BYTE1,MATCUR+ONEFND                                              
         B     GTEXDA90        CHECK FOR DUPLICATE XDATA NAME ENTRY             
*                                                                               
GTEXD170 CLC   V.XDATCOL,BYTE                                                   
         BE    GTEXD172                                                         
         BH    GTEXD166                                                         
         IC    R0,V.XDATDLN                                                     
         AR    RE,R0                                                            
         B     GTEXD165                                                         
*                                                                               
GTEXD172 IC    R0,V.XDATNUM                                                     
         LA    RF,V.XDATVLS                                                     
         XR    RE,RE                                                            
GTEXD174 CLI   0(RF),EOT                                                        
         BE    GTEXDA90                                                         
         CLC   0(1,RF),0(R2)   SAME LENGTH?                                     
         BE    GTEXD180                                                         
GTEXD175 IC    RE,0(RF)                                                         
         LA    RF,1(RE,RF)                                                      
         BCT   R0,GTEXD174                                                      
         XR    R1,R1                                                            
         IC    R1,0(R2)                                                         
         AHI   R1,1                                                             
         LH    RE,HALF                                                          
         SR    RE,R1                                                            
         STH   RE,HALF                                                          
         MVI   0(R2),X'FF'                                                      
         B     GTEXDA90        CHECK FOR DUPLICATE XDATA NAME ENTRY             
*                                                                               
GTEXD180 ZIC   R1,0(R2)                                                         
         BCTR  R1,0                                                             
         EXMVC R1,XLCHOP,1(R2)                                                  
         EXOC  R1,XLCHOP,SPACES   (CAPITALIZE)                                  
         EXCLC R1,XLCHOP,1(RF)                                                  
         BNE   GTEXD175                                                         
         OI    BYTE1,MATCUR+ONEFND                                              
         B     GTEXDA90        CHECK FOR DUPLICATE XDATA NAME ENTRY             
         DROP  V                                                                
*                                                                               
GTEXD190 TM    BYTE1,MATCUR                                                     
         BNZ   GTEXD200                                                         
         XR    R1,R1                                                            
         IC    R1,0(R2)                                                         
         AHI   R1,1                                                             
         LH    RF,HALF                                                          
         SR    RF,R1                                                            
         STH   RF,HALF                                                          
         MVI   0(R2),X'FF'                                                      
*                                                                               
GTEXD200 TM    BYTE1,ONEFND                                                     
         BNZ   GTEXDAY                                                          
*                                                                               
GTEXDAN  LTR   RB,RB                                                            
         B     GTEXDAX                                                          
GTEXDAY  XR    R1,R1                                                            
         XR    RE,RE                                                            
         LA    RF,TEMPAREA                                                      
GTEXDY1  CLI   0(RF),X'FF'                                                      
         BE    GTEXDY2                                                          
         IC    R1,0(RF)                                                         
         MVI   0(RF),C','                                                       
         LA    RF,1(R1,RF)                                                      
         AHI   R1,1                                                             
         AR    RE,R1                                                            
         B     GTEXDY1                                                          
GTEXDY2  LA    R2,TEMPAREA+1                                                    
         SHI   RE,1                                                             
         STH   RE,PARNEWLN                                                      
         CR    RB,RB               SET CC EQUAL                                 
GTEXDAX  XIT1  REGS=(R2)                                                        
         DROP  R3,R6,R7,R8                                                      
         EJECT ,                                                                
         LTORG                                                                  
         SPACE 1                                                                
***********************************************************************         
*  Get Estimate name                                                  *         
***********************************************************************         
         SPACE 1                                                                
         USING PARWRKD,R7                                                       
GTENAM   NTR1  BASE=*,LABEL=*                                                   
         L     R2,0(,R1)           ESTIMATE GLOBAL NUMBER                       
         L     R7,4(,R1)                                                        
         USING EGNPASD,R4                                                       
         LA    R4,IOKEY                                                         
         XC    EGNPAS,EGNPAS                                                    
         MVI   EGNPTYP,EGNPTYPQ                                                 
         MVI   EGNPSUB,EGNPSUBQ                                                 
         MVC   EGNPCPY,CURACC                                                   
         MVC   EGNPNUM,0(R2)                                                    
         MVC   WORK(L'EGNPAS),EGNPAS                                            
         L     R1,=AL4(IOHIGH+IOACDIR+IOAREA1)                                  
         GOTO1 AIO                                                              
         CLC   WORK(EGNPCLI-EGNPASD),EGNPAS                                     
         BNE   GTENAMN                                                          
         L     R1,=AL4(IOGETREC+IOACMST+IOAREA1)                                
         GOTO1 AIO                                                              
         L     RF,AIO1                                                          
         AHI   RF,ESTRFST-ESTRECD                                               
         XR    R1,R1                                                            
         USING ENMELD,RF                                                        
GTENAM02 CLI   ENMEL,0                                                          
         BE    GTENAMN                                                          
         CLI   ENMEL,ENMELQ                                                     
         BE    *+14                                                             
         IC    R1,ENMLN                                                         
         AR    RF,R1                                                            
         B     GTENAM02                                                         
                                                                                
         IC    R1,ENMLN                                                         
         SHI   R1,ENMLNQ                                                        
         STH   R1,PARNEWLN                                                      
         BCTR  R1,0                                                             
         EXMVC R1,WORK,ENMNAME    EXTRACT ESTIMATE NAME                         
         LA    R2,WORK                                                          
         B     GTENAMY                                                          
                                                                                
GTENAMN  LTR   RB,RB                                                            
         B     *+6                                                              
GTENAMY  CR    RB,RB                                                            
         XIT1  REGS=(R2)                                                        
         SPACE 1                                                                
***********************************************************************         
*  Get Estimate currency name                                         *         
***********************************************************************         
         SPACE 1                                                                
         USING PARWRKD,R7                                                       
GTESCN   NTR1  BASE=*,LABEL=*                                                   
         L     R2,0(,R1)           Estimate currency code                       
         L     R7,4(,R1)                                                        
         USING CURTABD,RF                                                       
         L     RF,AFCURY           A(CURTAB)                                    
GTESC02  CLI   0(RF),0                                                          
         BE    GTESCNN             Not found                                    
         CLC   CURTCUR,0(R2)       Match currency code                          
         BE    *+12                                                             
         AHI   RF,L'CURFCBLK                                                    
         B     GTESC02                                                          
         LHI   RE,L'CURTSHRT-1                                                  
         TM    CURTPIND,CURTLNAM                                                
         BZ    *+8                                                              
         LHI   RE,L'CURTLONG-1                                                  
         MVC   WORK(0),CURTLONG    Currency name                                
         EX    RE,*-6                                                           
         AHI   RE,1                                                             
         STH   RE,PARNEWLN                                                      
         LA    R2,WORK                                                          
         B     GTESCNY                                                          
         DROP  RF                                                               
GTESCNN  LTR   RB,RB                                                            
         B     *+6                                                              
GTESCNY  CR    RB,RB                                                            
         XIT1  REGS=(R2)                                                        
                                                                                
***********************************************************************         
*  Get Creditor payment method                                        *         
***********************************************************************         
         SPACE 1                                                                
         USING PARWRKD,R7                                                       
GTCRPM   NTR1  BASE=*,LABEL=*                                                   
         L     R2,0(,R1)           R2=A(BACSTAT)                                
         L     R7,4(,R1)                                                        
         CLI   0(R2),BACSTCHQ                                                   
         JNE   *+14                                                             
         MVCDD WORK(14),AC#CHK                                                  
         J     GTCRP02                                                          
         CLI   0(R2),BACSTMCH                                                   
         JNE   *+14                                                             
         MVCDD WORK(14),AC#MANCH                                                
         J     GTCRP02                                                          
         CLI   0(R2),BACSTPAY                                                   
         JNE   *+14                                                             
         MVCDD WORK(14),AC#PYMNT                                                
         J     GTCRP02                                                          
         CLI   0(R2),BACSTBAC                                                   
         JNE   *+14                                                             
         MVCDD WORK(14),AC#BACS                                                 
         J     GTCRP02                                                          
         CLI   0(R2),BACSTTRF                                                   
         JNE   *+14                                                             
         MVCDD WORK(14),AC#TXFR                                                 
         J     GTCRP02                                                          
         CLI   0(R2),BACSTCUR                                                   
         JNE   *+14                                                             
         MVCDD WORK(14),AC#INTNL                                                
         J     GTCRP02                                                          
         CLI   0(R2),BACSSEPA                                                   
         JNE   GTCRPNN                                                          
         MVCDD WORK(14),AC#SEPAX                                                
GTCRP02  GOTO1 ADDICTAT,DMCB,C'SL  ',WORK,0                                     
         LHI   RE,14                                                            
         STH   RE,PARNEWLN                                                      
         LA    R2,WORK                                                          
         J     GTCRPNY                                                          
*                                                                               
GTCRPNN  LTR   RB,RB                                                            
         J     *+6                                                              
GTCRPNY  CR    RB,RB                                                            
         XIT1  REGS=(R2)                                                        
         LTORG                                                                  
                                                                                
***********************************************************************         
*  Get BrandOcean Invoice status                                      *         
***********************************************************************         
         SPACE 1                                                                
         USING PARWRKD,R7                                                       
GTINVS   NTR1  BASE=*,LABEL=*                                                   
         L     R2,0(,R1)           R2=A(TRSSTAT4)                               
         L     R7,4(,R1)                                                        
         TM    1(R2),TRSSINVQ      R2+1=(TRSSTAT5)                              
         BZ    GTINVSN             NOT A BR'OCEAN INVOICE POSTING               
         TM    0(R2),TRSSSUBT      SUBMITTED                                    
         JZ    *+14                                                             
         MVCDD WORK(14),AC#SUB2                                                 
         J     GTINV02                                                          
         TM    0(R2),TRSSSJAT      PART-APPROVED                                
         JZ    *+14                                                             
         MVCDD WORK(14),AC#PAP3                                                 
         J     GTINV02                                                          
         CLI   0(R2),TRSSFAPT      APPROVED (=0)                                
         JNE   *+14                                                             
         MVCDD WORK(14),AC#ESAPP                                                
         J     GTINV02                                                          
         TM    0(R2),TRSSREJT      REJECTED                                     
         JZ    GTINVSN                                                          
         MVCDD WORK(14),AC#REJ                                                  
GTINV02  GOTO1 ADDICTAT,DMCB,C'SL  ',WORK,0                                     
         LHI   RE,14                                                            
         STH   RE,PARNEWLN                                                      
         LA    R2,WORK                                                          
         J     GTINVSY                                                          
*                                                                               
GTINVSN  LTR   RB,RB                                                            
         J     *+6                                                              
GTINVSY  CR    RB,RB                                                            
         XIT1  REGS=(R2)                                                        
         LTORG                                                                  
                                                                                
         EJECT ,                                                                
                                                                                
***********************************************************************         
*  Get Transaction mapping type                                       *         
***********************************************************************         
         SPACE 1                                                                
         USING FMTRECD,R5                                                       
         USING PARWRKD,R7                                                       
GTYMP    NTR1  BASE=*,LABEL=*                                                   
         L     R2,0(,R1)           R2=A(TRNTYPE)                                
         L     R5,4(,R1)           R5=A(FMTRECD)                                
         L     R7,8(,R1)           R7=A(PARWRKD)                                
*                                                                               
         USING COLD,R3                                                          
         USING ROWD,RE                                                          
         L     RE,ACURROW          POINT TO CURRENT ROW                         
         OI    ROWFLAGS,ROWCDE     MAKE SURE PRINT CODE IS SET                  
         L     R3,ROWACOL          POINT TO CURRENT COLUMN                      
         DROP  RE                                                               
*                                                                               
         MVC   WORK,SPACES                                                      
         CLI   0(R2),TRNTCALC     CASH ALLOCATION (TYPE = 30)                   
         JNE   GTYMP04                                                          
         MVI   WORK,EDTMCASH      SET CHAR TO "U"                               
         ICM   RF,15,AELEMD9      TEST RECEIVABLE ALLOACTION                    
         JZ    GTYMP30                                                          
         USING RALELD,RF                                                        
         CLI   RALTYPE,RALTTFR    TEST TRANSFERRED FROM                         
         JNE   GTYMP30                                                          
         DROP  RF                                                               
*                                                                               
GTYMP04  DS    0H                                                               
* TOTAL AMOUNT WILL BE CHECKED IN EDTYMAP IN RL04 FOR NON BILLING TYPES         
         MVI   WORK,EDTMNBIL      SET CHAR TO "F" FOR NON BILLING TYPES         
         CLI   0(R2),TRNTMABL     MANUAL BILLING (TYPE = 6)                     
         JE    GTYMP08                                                          
         CLI   0(R2),TRNTCLBL     CLIENT BILLING (TYPE = 7)                     
         JE    GTYMP08                                                          
         CLI   0(R2),TRNTMEBL     MEDIA BILLING  (TYPE = 9)                     
         JE    GTYMP08                                                          
         CLI   0(R2),TRNTCALC     CASH ALLOCATION (TYPE = 30)                   
         JNE   GTYMP30                                                          
*                                                                               
GTYMP08  L     RF,COLXTRA              LOAD STACKED EQUATION                    
         MVC   BYTE,EQCOL#-EQD(RF)     MAPPING COLUMN NUMBER                    
         L     R3,FMTCOL               FIRST COLUMN                             
         LLC   RF,FMT#COLS             MAX COLUMN NUMBER                        
GTYMP12  CLC   COLNUM,BYTE                                                      
         JE    GTYMP16                 MAPPING COLUMN FOUND                     
         LA    R3,COLLNQ(,R3)                                                   
         JCT   RF,GTYMP12              GET NEXT COLUMN                          
         J     GTYMPN                  MAPPING COLUMN NOT FOUND!!!!             
*                                                                               
         USING KYWD,R6                                                          
GTYMP16  L     R6,COLINDEX         KEYWORD INDEX                                
         ZAP   PACKAMT,PKZERO                                                   
         SR    RE,RE                                                            
         ICM   RE,3,KYWPRSE                                                     
         JZ    GTYMPN              NO PARSE ON MAPPING COLUMN                   
         A     RE,PRSBASE                                                       
         GOTO1 PARSE,DMCB,(RE),PACKAMT,0,(R6)                                   
         DROP  R3,R6                                                            
* FIRST TRANSACTION AMOUNT WILL BE CHECKED FOR INVOICE TYPE                     
         MVI   WORK,EDTMINV       SET CHAR TO "I" (Invoice)                     
         CP    PACKAMT,PKZERO     TEST MAPPING COLUMN AMOUNT                    
         JNL   *+8                                                              
         MVI   WORK,EDTMCRD       SET CHAR TO "C" (CREDIT)                      
*                                                                               
GTYMP30  MVC   PARNEWLN,=Y(1)                                                   
         LA    R2,WORK                                                          
         J     GTYMPY              R2 Passed back from routine                  
         DROP  R5,R7                                                            
*                                                                               
GTYMPN   LTR   RB,RB                                                            
         J     *+6                                                              
GTYMPY   CR    RB,RB                                                            
         XIT1  REGS=(R2)                                                        
         LTORG                                                                  
                                                                                
         EJECT ,                                                                
                                                                                
***********************************************************************         
*  GET SOURCE ACCOUNT FROM X'7B' FOR LEDGER SR                        *         
***********************************************************************         
         SPACE 1                                                                
         USING SORELD,R8                                                        
GSORA    NTR1  BASE=*,LABEL=*                                                   
         L     R8,0(,R1)           R8=A(SOREL)                                  
*                                                                               
         MVC   WORK,SPACES                                                      
         CLI   SORSYS,SORSACC      TEST ACCOUNT SYSTEM                          
         JNE   GSORA04                                                          
         CLC   CURSJ,SORAULA       TEST LEDGER SJ                               
         JNE   GSORAN              NO - EXIT                                    
         MVC   WORK(L'SORAACT),SORAACT                                          
         J     GSORA10                                                          
GSORA04  MVC   WORK(L'SORMCLI),SORMCLI                                          
         LA    RF,WORK                                                          
         AH    RF,SJPRDDSP         -> PRODUCT                                   
         MVC   0(L'SORMPRO,RF),SORMPRO                                          
         LA    RF,WORK                                                          
         AH    RF,SJJOBDSP         -> CAMPAIGN                                  
         MVC   0(L'SORMCAM,RF),SORMCAM                                          
*                                                                               
GSORA10  LA    R2,WORK                                                          
         J     GSORAY                                                           
         DROP  R8                                                               
                                                                                
GSORAN   LTR   RB,RB                                                            
         J     *+6                                                              
GSORAY   CR    RB,RB                                                            
         XIT1  REGS=(R2)                                                        
         LTORG                                                                  
                                                                                
         EJECT ,                                                                
*                                                                               
***********************************************************************         
*  GET MEDIA BILLING GROUP FROM X'7B' FOR LEDGER SR                   *         
***********************************************************************         
         SPACE 1                                                                
         USING SORELD,R8                                                        
GBGM     NTR1  BASE=*,LABEL=*                                                   
         L     R8,0(,R1)           R8=A(SOREL)                                  
*                                                                               
         CLI   SORSYS,SORSMED      TEST MEDIA SYSTEM                            
         JNE   GBGMN                                                            
*                                                                               
         MVC   WORK,SPACES                                                      
         L     RF,ADMASTC                                                       
         L     RF,MCUTL-MASTD(RF)                                               
         MVC   4(1,RF),RCMESENO    SET TO READ MEDIA FILE                       
*                                                                               
         USING DMED,R2                                                          
         LA    R2,IOKEY                                                         
         XC    MEDKEY,MEDKEY                                                    
         MVC   MEDKAM,RCMEAGYB     MEDIA COMPANY CODE                           
         MVI   MEDKTYP,MEDKPASQ                                                 
         MVC   MEDKCODE,SORMMED                                                 
         GOTO1 DATAMGR,DMCB,DMREAD,MEDIR,IOKEY,IOKEY,IOWRK                      
         CLI   8(R1),0                                                          
         JNE   GBGM20              RECORD NOT ON MEDDIR                         
         MVC   BYTE1,MEDDNUM       SAVED MEDIA NUMBER                           
         DROP  R2                                                               
*                                                                               
         USING DCLI,R2                                                          
         XC    CLIKEY,CLIKEY                                                    
         MVI   CLIKTYP,CLIKTYPQ    PRIME KEY FOR MEDIA CLIENT RECORD            
         MVC   CLIKAM,RCMEAGYB     AGENCY BYTE                                  
         OC    CLIKAM,BYTE1        PUT MEDIA TYPE CODE IN KEY                   
         MVC   CLIKCLI,SORMCLI     CLIENT CODE                                  
         GOTO1 DATAMGR,DMCB,DMREAD,MEDIR,IOKEY,IOKEY,IOWRK                      
         CLI   8(R1),0                                                          
         JNE   GBGM20              RECORD NOT ON MEDDIR                         
         GOTO1 DATAMGR,DMCB,DMGET,MEDFILE,CLIDDA,AIO1,IOWRK                     
         CLI   8(R1),0                                                          
         JNE   GBGM20              GOOD RECORD EXIT HERE                        
*                                                                               
         L     R2,AIO1                                                          
         LA    RF,CLIEL            DISPLAY ELEMENT INFO                         
         USING DCLX,RF                                                          
         SR    R1,R1                                                            
GBGM04   IC    R1,CLXLEN                                                        
         AR    RF,R1                                                            
         CLI   CLXEL,0             END OF RECORD?                               
         JE    GBGM20                                                           
         CLI   CLXEL,CLXELQ        EXTRA ELEMENT                                
         JNE   GBGM04                                                           
*                                                                               
         MVC   WORK(L'CLXBGRP),CLXBGRP                                          
         LA    R2,WORK             DISPLAY MEDIA BILLING GROUP                  
         L     RF,ADMASTC                                                       
         L     RF,MCUTL-MASTD(RF)                                               
         MVC   4(1,RF),RCACSENO    SET TO READ ACCOUNT FILE                     
         J     GBGMY                                                            
         DROP  R8                                                               
*                                                                               
GBGM20   L     RF,ADMASTC                                                       
         L     RF,MCUTL-MASTD(RF)                                               
         MVC   4(1,RF),RCACSENO    SET TO READ ACCOUNT FILE                     
GBGMN    LTR   RB,RB                                                            
         J     *+6                                                              
GBGMY    CR    RB,RB                                                            
         XIT1  REGS=(R2)                                                        
                                                                                
         LTORG                                                                  
MEDIR    DC    C'MEDIR  '                                                       
MEDFILE  DC    C'MEDFIL '                                                       
                                                                                
         EJECT ,                                                                
***********************************************************************         
*  GET MEDIA BILLING GROUP FROM X'7B' FOR LEDGER SR                   *         
***********************************************************************         
         SPACE 1                                                                
         USING TRNRECD,R2                                                       
DIR      USING TRNRECD,IODIRKEY                                                 
GTRSC    NTR1  BASE=*,LABEL=*                                                   
         L     R2,0(,R1)           R8=A(TRNEL)                                  
         SH    R2,DATADISP                                                      
         MVC   IOKEY,SPACES                                                     
         MVC   DIR.TRNKEY,TRNKEY                                                
         MVI   DIR.TRNKSBR,0       READ FIRST TX REC                            
                                                                                
         MVC   WORK,SPACES                                                      
         MVI   BYTE,YES            INITIALIZE REF_SER                           
         MVC   HALF,SPACES         SAVE OFFICE CODE IN HALF                     
         MVC   THREE,RCCURR        SET DEFAULT CURRENCY CODE                    
         J     GTRSC04                                                          
*                                                                               
GTRSC02  MVI   BYTE,NO             SET NO CHANGE TO REF_SER                     
         CLI   DIR.TRNKSBR,X'FF'   TEST LAST RECORD                             
         JE    GTRSCX              YES - END                                    
         CLC   DIR.TRNKSBR,TRNKSBR TEST PASS CURRENT TX RECORD                  
         JNL   GTRSCX              YES - END                                    
         LLC   RF,DIR.TRNKSBR      GET NEXT RECORD (IOSEQ DOESN'T WORK)         
         LA    RF,1(,RF)                                                        
         STC   RF,DIR.TRNKSBR                                                   
*                                                                               
T        USING TRNRECD,R4                                                       
GTRSC04  L     R1,=AL4(IOHIGH+IOACDIR+IOAREA2)                                  
         GOTO1 AIO                                                              
         L     R4,AIO2                                                          
         CLC   TRNKEY(TRNKSBR-TRNRECD),T.TRNKEY                                 
         JNE   GTRSCX              END IF KEY CHANGED                           
         L     R1,=AL4(IOGETREC+IOACMST+IOAREA2)                                
         TM    T.TRNKSTAT,TRNSARCH TEST ARCHIVE TRANSACTION                     
         JZ    *+8                                                              
         L     R1,=AL4(IOGETREC+IOACARC+IOAREA2)                                
         GOTO1 AIO                                                              
         JE    *+6                                                              
         DC    H'0'                BAD RECORD                                   
         DROP  T                                                                
*                                                                               
         LA    R4,TRNRFST-TRNRECD(R4)                                           
GTRSC06  CLI   0(R4),0                                                          
         JE    GTRSC20                                                          
         CLI   0(R4),TRNELQ        TEST TRANSACTION ELEM                        
         JE    GTRSC10                                                          
         CLI   0(R4),ASTELQ        TEST ACCOUNT STATUS ELEM                     
         JE    GTRSC12                                                          
         CLI   0(R4),SERELQ        TEST TRX SERIAL CCOUNT STATUS ELEM           
         JE    GTRSC14                                                          
*                                                                               
GTRSC08  LLC   RF,1(R4)                                                         
         AR    R4,RF                                                            
         J     GTRSC06                                                          
*                                                                               
         USING TRNELD,R4                                                        
GTRSC10  DS    0H                                                               
         MVC   WORK+20(L'TRNREF),TRNREF                                         
         CLC   TRNOFFC,HALF                                                     
         JE    GTRSC08                                                          
         MVI   BYTE,YES            SET CHANGE TO OFFICE CODE                    
         MVC   HALF,TRNOFFC                                                     
         J     GTRSC08                                                          
*                                                                               
         USING ASTELD,R4                                                        
GTRSC12  DS    0H                                                               
         CLC   ASTCUR,THREE                                                     
         JE    GTRSC08                                                          
         MVI   BYTE,YES            SET CHANGE TO CURRENCY CODE                  
         MVC   THREE,ASTCUR                                                     
         J     GTRSC08                                                          
*                                                                               
         USING SERELD,R4                                                        
GTRSC14  DS    0H                                                               
         XOUT  SERNM,WORK+40,4                                                  
*                                                                               
         LA    RF,WORK+20+L'TRNREF-1                                            
         CLI   0(RF),C' '          SKIP ALL SPACES                              
         JH    *+12                                                             
         SHI   RF,1                                                             
         J     *-12                                                             
         MVI   1(RF),C'_'                                                       
         MVC   2(8,RF),WORK+40                                                  
         J     GTRSC08                                                          
*                                                                               
GTRSC20  CLI   BYTE,YES            DO WE WANT NEW REF_SER                       
         JNE   GTRSC02                                                          
         MVC   WORK(15),WORK+20    COPY NEW REF_SER                             
         J     GTRSC02                                                          
         DROP  R2,R4                                                            
*                                                                               
GTRSCX   LA    R2,WORK             RETURN TX REF_SER NO FOR CASH                
         XIT1  REGS=(R2)                                                        
         EJECT ,                                                                
*&&                                                                             
***********************************************************************         
*  PROCESS NARRATIVE/TEXT AT POSTING-LEVEL                            *         
***********************************************************************         
         SPACE 1                                                                
         USING PARSED,R3                                                        
         USING PARWRKD,R7                                                       
GTNARA   NTR1  BASE=*,LABEL=*                                                   
         L     R7,0(,R1)                                                        
         L     R8,4(,R1)                                                        
         L     R3,8(,R1)                                                        
*                                                                               
         L     RE,GENAREA1                                                      
         LHI   RF,GESIZEQ                                                       
         XR    R0,R0                                                            
         XR    R1,R1                                                            
         ICM   R1,8,SPACES         Pad with spaces                              
         MVCL  RE,R0                                                            
*                                                                               
         USING FFTELD,R8                                                        
         CLI   0(R8),FFTELQ        X'DB'                                        
         BNE   GETNAR09                                                         
         MVC   SVREG,GENAREA1                                                   
*                                                                               
GETNAR00 CLI   FFTTYPE,FFTTNARR    'Long' narrative                             
         BNE   GETNAR04                                                         
*                                                                               
         XR    RF,RF                                                            
         IC    RF,FFTLN                                                         
         SH    RF,PARDSPEL         Length of narrative                          
         BNP   GETNAR04            Look for another element                     
         L     RE,SVREG                                                         
         LR    R1,RF                                                            
         AR    R1,RE                                                            
         ST    R1,SVR1                                                          
         LA    R0,FFTWCNAR                                                      
         LR    R1,RF                                                            
         MVCL  RE,R0                                                            
         MVC   SVREG,SVR1                                                       
         B     GETNAR04                                                         
*                                                                               
GETNAR03 CLI   0(R8),0                                                          
         BE    GETNAR05                                                         
         CLI   0(R8),FFTELQ                                                     
         BE    GETNAR00                                                         
GETNAR04 XR    RF,RF                                                            
         IC    RF,FFTLN                                                         
         AR    R8,RF                                                            
         B     GETNAR03                                                         
*                                                                               
GETNAR05 L     RF,GENAREA1                                                      
         CLC   0(L'SPACES,RF),SPACES DID WE PICK UP ANY NARRATIVE?              
         BH    GETNAR06                                                         
         B     GETNARN                                                          
*                                                                               
GETNAR06 AHI   RF,GESIZEQ-1        Calculate length of narrative                
         LA    RE,GESIZEQ                                                       
GETNAR07 CLI   0(RF),C' '                                                       
         BH    GETNAR08                                                         
         SHI   RF,1                                                             
         BCT   RE,GETNAR07                                                      
         DC    H'0'                                                             
*                                                                               
GETNAR08 XR    R1,R1                                                            
         ICM   R1,3,PARTOLEN       Max allowed length                           
         CR    RE,R1                                                            
         BNH   *+6                                                              
         LR    RE,R1                                                            
         STH   RE,PARFRLEN                                                      
         L     R2,GENAREA1                                                      
         B     GETNAR86                                                         
*                                                                               
GETNAR09 LA    RE,PARWORK                                                       
         LA    RF,L'PARWORK                                                     
         SR    R1,R1                                                            
         ICM   R1,8,SPACES                                                      
         SR    R0,R0                                                            
         MVCL  RE,R0                                                            
                                                                                
         SR    R1,R1               R1 = length of narrative                     
         LA    RE,PARWORK                                                       
         CLI   PARTTYP2,1          Only show auto narrative                     
         BE    GETNAR12            Yes                                          
         IC    R1,1(,R8)           Length of element                            
         SH    R1,PARDSPEL         Figure out length of narrative               
         BNP   GETNAR12            No narrative                                 
         MVI   BYTE,0                                                           
                                                                                
         USING TRNELD,R8                                                        
         CLI   0(R8),TRNELQ        X'44'                                        
         BNE   GETNAR10                                                         
         CLI   QPROG,PRODUCTION                                                 
         BNE   GETNAR10                                                         
         CLC   TRNANAL,=C'99'      Is it workcode 99                            
         BNE   *+8                                                              
         LA    R1,L'TRNBLTYP-1     14 bytes of narrative only                   
         DROP  R8                                                               
*                                                                               
GETNAR10 SR    RF,RF                                                            
         ICM   RF,3,PARTOLEN       Max length of keyword                        
         CR    R1,RF               If greater than max lenght then              
         BNH   *+6                                                              
         LR    R1,RF               make it max length                           
         LR    RF,R1               R1 = Length of narrative                     
         BCTR  RF,0                                                             
         EXMVC RF,0(RE),0(R2)      Put real narative in PARWORK                 
         LA    RE,1(R1,RE)         New location                                 
                                                                                
         USING PXDELD,R8                                                        
GETNAR12 ICM   R8,15,AELEM4E       Transfer data ?                              
         BZ    GETNAR15            Yes                                          
         LA    R1,14                                                            
         MVC   0(14,RE),=CL14'Transferred to'                                   
         CLI   PXDTYPE,PXDTFROM    From type?                                   
         BNE   *+14                                                             
         LA    R1,16                                                            
         MVC   0(16,RE),=CL16'Transferred from'                                 
         LA    RE,1(R1,RE)                                                      
         MVC   0(14,RE),PXDFRTOU                                                
         AHI   RE,14                                                            
         B     GETNAR80                                                         
         DROP  R8                                                               
*                                                                               
GETNAR15 CLI   QPROG,PRODUCTION                                                 
         BNE   GETNAR80            Not production                               
         CLI   REALTYP,1           Type 1 input for purchase orders             
         BNE   GETNAR80            If not type 1 then stop                      
                                                                                
         USING FFNELD,R8                                                        
         ICM   R8,15,AELEM25                                                    
         BZ    GETNAR80                                                         
         CLI   RCCTRY,CTRYGER                                                   
         BE    GETNAR20                                                         
         LA    R1,6                                                             
         MVC   0(6,RE),=CL6'Order='                                             
         AR    RE,R1                                                            
         MVC   0(7,RE),FFNUMBER                                                 
         AHI   RE,7                                                             
         B     GETNAR80                                                         
                                                                                
GETNAR20 LA    R1,8                                                             
         MVC   0(8,RE),=CL7'Auftrag='                                           
         AR    RE,R1                                                            
         MVC   0(7,RE),FFNUMBER                                                 
         AHI   RE,7                                                             
*                                                                               
GETNAR80 LA    RF,PARWORK          Start of built narrative                     
         LR    R1,RE                                                            
         AHI   R1,1                                                             
         SR    R1,RF                                                            
                                                                                
GETNAR82 CLI   0(RE),BLANK         Check for last blank                         
         BH    GETNAR84                                                         
         BCTR  RE,0                                                             
         BCT   R1,GETNAR82                                                      
         B     GETNARN             No narrative found                           
                                                                                
GETNAR84 LA    R2,PARWORK                                                       
         XR    RF,RF                                                            
         ICM   RF,3,PARTOLEN       Max allowed length                           
         CR    R1,RF                                                            
         BNH   *+6                                                              
         LR    R1,RF                                                            
         STH   R1,PARFRLEN                                                      
*                                                                               
GETNAR86 LR    RF,R2               Remove '<nl>' from narrative                 
         LA    R0,1                R0=increment                                 
         LH    R1,PARFRLEN                                                      
         LA    R1,0(R1,RF)         R1=limit                                     
         MVI   BYTE,0                                                           
GETNAR88 CLI   0(RF),C'<'                                                       
         BNE   GETNAR90                                                         
         CLC   0(4,RF),=C'<nl>'                                                 
         BNE   GETNAR90                                                         
         MVC   0(4,RF),SPACES      Replace with spaces                          
         MVI   BYTE,1              Set string was found                         
         LA    RF,3(RF)                                                         
GETNAR90 BXLE  RF,R0,GETNAR88                                                   
                                                                                
         CLI   BYTE,1                                                           
         BNE   GETNAR99            Nothing to squash                            
         LH    RF,PARFRLEN                                                      
         GOTO1 ADSQUASH,DMCB,(R2),(0,(RF))                                      
         ICM   RF,15,4(R1)         New l'narrative                              
         STH   RF,PARFRLEN                                                      
*                                                                               
GETNAR99 B     GETNARY             Return narrative                             
         DROP  R8                                                               
                                                                                
GETNARN  LTR   RB,RB                                                            
         B     *+6                                                              
GETNARY  CR    RB,RB                                                            
         XIT1  REGS=(R2)                                                        
         LTORG                                                                  
         EJECT ,                                                                
***********************************************************************         
         TITLE 'ESTIMATE FILTER ON STATUS'                                      
         USING ACMD,R3                                                          
         USING FMTRECD,R5                                                       
ESTSTATS DS    0D                                                               
         NMOD1 0,**ESTS**                                                       
         L     RC,RLBASEC                                                       
         L     R3,AMONACC                                                       
         L     R4,ACMAJOBB                                                      
         L     R2,ACMACOL          R2=A(COLUMN TABLE)                           
         L     R8,ADGOBLOC                                                      
         ST    R2,SVR2             SAVE A(JOBBER COLUMN TABLE)                  
         MVI   ESTIND2,0           RESET                                        
*                                                                               
         USING JBLOCKD,R4                                                       
         USING ACGOD,R8                                                         
*                                                                               
         CLI   JBNEWEST,JBMCSQ     For MCS estimates, else skip                 
         BNE   ESTSTA10                                                         
                                                                                
*&&UK*&& CLI   JBORGVER,0          Any estimate found (no drafts)?              
*&&US*&& CLI   JBCURVER,0          Any estimate found (no drafts)?              
         BE    ESTBRA40                                                         
                                                                                
         USING MJETABD,R2                                                       
         L     R2,SVR2             Reload JOBBER column table                   
ESTBRA10 XR    R0,R0               (first entry is totals entry)                
         IC    R0,MJETLEN                                                       
         AR    R2,R0                                                            
                                                                                
         CLI   MJETTYP,MJETTEQ     end of table                                 
         BE    ESTBRA40                                                         
         CLI   MJETTYP,MJETTWQ     work code entry                              
         BNE   ESTBRA10                                                         
                                                                                
         OI    ESTIND2,ESTHVEST                                                 
                                                                                
         USING COLD,R3                                                          
ESTBRA15 XR    R0,R0                                                            
         ICM   R0,1,FMT#COLS                                                    
         BZ    ESTBRA40            NO COLUMNS TO CHECK                          
         L     R3,FMTCOL           COLUMN INFO                                  
                                                                                
ESTBRA20 TM    COLFLAGS,COLJOBR    test for estimate column                     
         BZ    ESTBRA30            if not get next column                       
                                                                                
*  could check COLDD#,=AL2(AC#RSBNT) against used BarndOcean keyword            
*  in JBRETCOL and then calculate offset or skip value                          
                                                                                
         XR    RF,RF                                                            
         IC    RF,COLJOBRC         JOBBER column #                              
         SHI   RF,1                                                             
         MHI   RF,L'MJETVAL                                                     
         LA    RF,MJETVAL(RF)      offset into current table entry              
         CP    0(L'MJETVAL,RF),PKZERO                                           
         BE    ESTBRA30            no activity -> check next col entry          
         OI    ACTIVITY,ACTEST     set estimate activity and finish             
         B     ESTBRA40                                                         
                                                                                
ESTBRA30 AHI   R3,COLLNQ           next column                                  
         BCT   R0,ESTBRA20                                                      
                                                                                
         B     ESTBRA10            next JOBBER table entry                      
                                                                                
ESTBRA40 TM    ESTIND,ESTJSTAT                                                  
         BZ    ESTBRA80            DON'T NEED ANYTHING ELSE                     
         CLI   FMTESTAT,C'R'                                                    
         BE    ESTBRA70            ONLY JOBS WITH HIGHER UNAPP REVS             
         OC    JBHIAPP,JBHIAPP     HAS IT BEEN APPROVED?                        
         BNZ   *+8                 YES                                          
         OI    ESTIND2,ESTUNAPP                                                 
         CLI   GONEEDAE,YES        THIS JOB NEED APPROV TO BILL                 
         BNE   *+8                 NO                                           
         OI    ESTIND2,ESTNDAPP                                                 
         CLI   GONEEDES,YES        NEED AN ESTIMATE                             
         BNE   *+8                 NO                                           
         OI    ESTIND2,ESTNDEST                                                 
         B     ESTBRA50                                                         
                                                                                
ESTBRA50 LA    R6,ESTTAB           (TKLU: leave this as it is)                  
         CLI   FMTESTAT,BLANK                                                   
         BNH   ESTBRA80                                                         
                                                                                
ESTBRA55 CLC   ESTIND2,0(R6)       Pattern on match table                       
         BNE   ESTBRA60                                                         
         CLC   FMTESTAT,1(R6)      is this the new pattern wanted?              
         BE    ESTBRA80            Yes                                          
         B     ESTSTA99            No                                           
                                                                                
ESTBRA60 AHI   R6,L'ESTTAB                                                      
         B     ESTBRA55                                                         
                                                                                
ESTBRA70 CLI   GONEEDAE,YES        Special check for higher revisions           
         BNE   ESTSTA99                                                         
         CLI   JBHIAPP,0                                                        
         BE    ESTSTA99            Jon not wanted                               
         CLC   JBHIAPP,JBHIREV                                                  
         BE    ESTSTA99                                                         
                                                                                
ESTBRA80 MVI   CURAPEST,YES                                                     
         TM    ESTIND2,ESTUNAPP    it has no approval                           
         BZ    *+12                                                             
         MVI   CURAPEST,NO                                                      
         B     ESTSTA98                                                         
                                                                                
         CLI   GONEEDAE,YES                                                     
         BNE   ESTSTA98                                                         
         CLI   GONEEDES,YES                                                     
         BNE   ESTSTA98                                                         
         OI    ACCSTAT,ACCAPPE     YES HAS APPROVAL                             
         B     ESTSTA98                                                         
*                                                                               
         USING JBCOLD,R2                                                        
ESTSTA10 LH    R1,JBNROWS          RE-LOAD NUMBER OF ROWS TO PROCESS            
         L     R2,SVR2             RE-LOAD JOBBER COLUMN TABLE                  
ESTSTA12 CLI   JBCOLTYP,JBCOLTWC   WORK CODE TYPE                               
         BE    ESTSTA15                                                         
         AH    R2,JBLCOL           NEXT ENTRY IN TABLE                          
         BCT   R1,ESTSTA12                                                      
         B     ESTSTA25            NO ESTIMATE FOUND                            
*                                                                               
ESTSTA15 OI    ESTIND2,ESTHVEST                                                 
         SPACE 1                                                                
***********************************************************************         
*  R1 = NUMBER OF ROWS LEFT, R2 = 1ST EST FOUND TO CHECK              *         
***********************************************************************         
         USING COLD,R3                                                          
ESTSTA16 SR    R0,R0                                                            
         ICM   R0,1,FMT#COLS                                                    
         BZ    ESTSTA25            NO COLUMNS TO CHECK                          
         L     R3,FMTCOL           COLUMN INFO                                  
ESTSTA18 TM    COLFLAGS,COLJOBR    IS IT A ESTIMATE COLUMN?                     
         BZ    ESTSTA20            NEXT COLUMN                                  
         SR    RF,RF                                                            
         IC    RF,COLJOBRC         JOBBER COLUMN #                              
         BCTR  RF,0                                                             
         MHI   RF,L'JBCOLV1R                                                    
         AHI   RF,(JBCOLV1R-JBCOLD)                                             
         AR    RF,R2               R2 = POINTS TO BASE OF ENTRY FOUND           
         CP    0(6,RF),PKZERO                                                   
         BE    ESTSTA20            NO ACTIVITY FOUND SO CHECK NEXT              
         OI    ACTIVITY,ACTEST     ESTIMATE ACTIVITY                            
         B     ESTSTA25            FINISHED, BIT SET                            
*                                                                               
ESTSTA20 AHI   R3,COLLNQ                                                        
         BCT   R0,ESTSTA18                                                      
*                                                                               
ESTSTA22 AH    R2,JBLCOL           NEXT POSSIBLE ESTIMATE                       
         SHI   R1,1                COUNT DOWN ROWS                              
         BZ    ESTSTA25            NO MORE                                      
         CLI   JBCOLTYP,JBCOLTWC   WORK CODE TYPE                               
         BE    ESTSTA16            START AGAIN                                  
         B     ESTSTA22            LOOK FOR ANOTHER ESTIMATE                    
*                                                                               
ESTSTA25 TM    ESTIND,ESTJSTAT                                                  
         BZ    ESTSTA96            DON'T NEED ANYTHING ELSE                     
         CLI   FMTESTAT,C'R'                                                    
         BE    ESTSTA80            ONLY JOBS WITH HIGHER UNAPP REVS             
         CLI   JBNEWEST,YES        NEW EST                                      
         BNE   ESTSTA30            NO                                           
         OC    JBHIAPP,JBHIAPP     HAS IT BEEN APPROVED?                        
         BNZ   *+8                 YES                                          
         OI    ESTIND2,ESTUNAPP                                                 
         CLI   GONEEDAE,YES        THIS JOB NEED APPROV TO BILL                 
         BNE   *+8                 NO                                           
         OI    ESTIND2,ESTNDAPP                                                 
         CLI   GONEEDES,YES        NEED AN ESTIMATE                             
         BNE   *+8                 NO                                           
         OI    ESTIND2,ESTNDEST                                                 
         B     ESTSTA72                                                         
*                                                                               
         USING JOBELD,R2                                                        
ESTSTA30 OI    ESTIND2,ESTNDAPP    OLD EST NEED APPROVAL IF UNAPP               
         CLI   GONEEDES,YES        DOES THIS JOB NEED AN ESTIMATE?              
         BNE   *+8                                                              
         OI    ESTIND2,ESTNDEST                                                 
         L     R2,ADACC            JOB USES OLD ESTIMATE                        
         AH    R2,DATADISP                                                      
         SR    R1,R1                                                            
*                                                                               
ESTSTA40 CLI   0(R2),0                                                          
         BNE   *+6                                                              
         DC    H'00'                                                            
         CLI   0(R2),JOBELQ        GET JOB ELEMENT                              
         BE    ESTSTA50                                                         
         IC    R1,1(,R2)                                                        
         AR    R2,R1                                                            
         B     ESTSTA40                                                         
*                                                                               
ESTSTA50 CLI   JOBLN,JOBLN3Q       IS EL LONG ENUF TO HAVE UPAPP BIT            
*&&US*&& BL    ESTSTA72            NO, ITS APPROVED                             
*&&UK*&& BNE   ESTSTA72            NO, ITS APPROVED                             
         TM    JOBSTA1,JOBSUEST    DOES JOB HAVE AN UNAPPROVED EST              
         BZ    ESTSTA72            NO                                           
         OI    ESTIND2,ESTUNAPP                                                 
*                                                                               
ESTSTA72 LA    R6,ESTTAB                                                        
         CLI   FMTESTAT,BLANK                                                   
         BNH   ESTSTA96                                                         
*                                                                               
ESTSTA74 CLC   ESTIND2,0(R6)       PATTERN MATCH ON TABLE                       
         BNE   ESTSTA76                                                         
         CLC   FMTESTAT,1(R6)      IS THIS THE PATTERN THEY WANT                
         BE    ESTSTA96            YES                                          
         B     ESTSTA99            NO                                           
*                                                                               
ESTSTA76 AHI   R6,L'ESTTAB                                                      
         B     ESTSTA74                                                         
*                                                                               
ESTSTA80 CLI   JBNEWEST,YES        SPECIAL CHECK FOR HIGHER REVS                
         BNE   ESTSTA99                                                         
         CLI   GONEEDAE,YES                                                     
         BNE   ESTSTA99                                                         
         CLI   JBHIAPP,0                                                        
         BE    ESTSTA99            JOB NOT WANTED                               
         CLC   JBHIAPP,JBHIREV                                                  
         BE    ESTSTA99                                                         
*                                                                               
ESTSTA96 MVI   CURAPEST,YES                                                     
         TM    ESTIND2,ESTUNAPP    IT HAS NO APPROVAL                           
         BZ    *+12                                                             
         MVI   CURAPEST,NO                                                      
         B     ESTSTA98                                                         
*                                                                               
         CLI   GONEEDAE,YES                                                     
         BNE   ESTSTA98                                                         
         CLI   GONEEDES,YES                                                     
         BNE   ESTSTA98                                                         
         OI    ACCSTAT,ACCAPPE     YES HAS APPROVAL                             
*                                                                               
ESTSTA98 SR    RA,RA                                                            
*                                                                               
ESTSTA99 LTR   RA,RA                                                            
         XMOD1                                                                  
         DROP  R5,R8                                                            
         EJECT ,                                                                
***********************************************************************         
*        NEED APPROVAL AND OLD EST JOBS                                         
***********************************************************************         
ESTTAB   DS    0XL2                                                             
         DC    X'0F',C'U'    EST PRES, NEEDANEST,EST UNAPP                      
         DC    X'0E',C'A'                        EST APP                        
         DC    X'0D',C'A'              DONT NEED,EST UNAPP                      
         DC    X'0C',C'A'                        EST APP                        
         DC    X'0B',C'N'    NO ESTIMAT NEED     EST UNAPP                      
         DC    X'0A',C'N'                        EST APP                        
         DC    X'09',C'A'               DONT NEEDEST UNAPP                      
         DC    X'08',C'A'                        EST APP                        
***********************************************************************         
*        NEW EST JOB WHICH DON'T NEED AN APPROVAL                               
***********************************************************************         
         DC    X'07',C'A'    EST PRES, NEEDANEST,EST UNAPP                      
         DC    X'06',C'A'                        EST APP                        
         DC    X'05',C'A'              DONT NEED,EST UNAPP                      
         DC    X'04',C'A'                        EST APP                        
         DC    X'03',C'N'    NO ESTIMAT NEED     EST UNAPP                      
         DC    X'02',C'N'                        EST APP                        
         DC    X'01',C'A'               DONT NEEDEST UNAPP                      
         DC    X'00',C'A'                        EST APP                        
ESTTNUM  EQU   ((*-ESTTAB)/L'ESTTAB)                                            
         SPACE 1                                                                
         LTORG                                                                  
*&&UK                                                                           
***********************************************************************         
*  FILTER ESTIMATE BY XDATA NAME(S)/VALUE(S)                          *         
*  P1 - AIO2 CONTAINS ESTIMATE RECORD                                 *         
*  NOTE: BYTE1 CONTAINS NUMBER OF MATCHES TO LOOK FOR                 *         
*  EXIT: BYTE1 CONTAINS NUMBER OF REMAINING MATCHES REQUIRED          *         
***********************************************************************         
         SPACE 1                                                                
         USING ACRL2D,R7                                                        
ESXFLT   DS    0D                                                               
         NMOD1 0,*ESXFLT*                                                       
         L     RC,RLBASEC                                                       
         L     R7,AACRL2D                                                       
         L     R2,0(,R1)           AIO2                                         
ESXFLT02 MVC   IOKEYSAV,0(R2)      SAVE ESTKEY                                  
         AHI   R2,ESTRFST-ESTRECD                                               
         USING XDFELD,R2                                                        
         CLI   XDFEL,XDFELQ        ANY XDATA SHOULD BE AT THE BEGINNING         
         BNE   ESXFLT42            NONE                                         
*                                                                               
ESXFLT04 CLI   XDFEL,0                                                          
         BE    ESXFLT46                                                         
         CLI   XDFEL,XDFELQ                                                     
         BE    ESXFLT08                                                         
ESXFLT06 XR    RE,RE                                                            
         IC    RE,XDFLN                                                         
         AR    R2,RE                                                            
         B     ESXFLT04                                                         
                                                                                
         USING XDFPASD,R5                                                       
ESXFLT08 LA    R5,IOKEY         GET XDATA RECORD                                
         XC    XDFPAS,XDFPAS                                                    
         MVI   XDFPTYP,XDFPTYPQ                                                 
         MVI   XDFPSUB,XDFPSUBQ                                                 
         MVC   XDFPCPY,RCCOMPFL                                                 
         MVC   XDFPPTR(L'XDFPPTR+L'XDFPSEQ),XDFOCOD                             
         L     R1,=AL4(IOREAD+IOACDIR+IOAREA3)                                  
         GOTO1 AIO                                                              
         BNE   ESXFLT06                                                         
         L     R1,=AL4(IOGETREC+IOACMST+IOAREA3)                                
         GOTO1 AIO                                                              
*                                                                               
         USING XDFRECD,R5                                                       
         L     R5,AIO3                                                          
         LA    R5,XDFRFST                                                       
E        USING XDFELD,R5                                                        
ESXFLT10 CLI   E.XDFEL,0                                                        
         BE    ESXFLT06            PASSED FILTERING SO FAR                      
         CLI   E.XDFEL,XDFELQ                                                   
         BNE   ESXFLT12                                                         
         CLC   E.XDFSEQ,XDFOCOD+2                                               
         BE    ESXFLT14                                                         
ESXFLT12 XR    RE,RE                                                            
         IC    RE,E.XDFLN                                                       
         AR    R5,RE                                                            
         B     ESXFLT10                                                         
*                                                                               
* Store DATA name and value from Estimate                                       
*                                                                               
ESXFLT14 XC    WORK,WORK                                                        
         LA    R8,WORK                                                          
         XR    RF,RF                                                            
         IC    RF,E.XDFLN                                                       
         SHI   RF,XDFLN1Q                                                       
         STC   RF,0(R8)            STORE LENGTH OF DATA NAME                    
         SHI   RF,1                                                             
         MVC   1(0,R8),E.XDFNAME   STORE DATA NAME                              
         EX    RF,*-6                                                           
         OC    1(0,R8),SPACES      (CAPITALIZE)                                 
         EX    RF,*-6                                                           
         LA    R8,2(RF,R8)                                                      
*                                                                               
         CLI   XDFOTYP,XDFEDYQ    IS IT A YES/NO FIELD                          
         BNE   ESXFLT18                                                         
         CLI   XDFODTA,C't'       Accept 't' or Y for YES                       
         BE    *+12                                                             
         CLI   XDFODTA,C'Y'                                                     
         BNE   ESXFLT16                                                         
*                                                                               
         MVI   0(R8),3                                                          
         MVC   1(3,R8),AC@YES                                                   
         B     ESXFLT24                                                         
*                                                                               
ESXFLT16 MVI   0(R8),2                                                          
         MVC   1(2,R8),AC@NO                                                    
         B     ESXFLT24                                                         
*                                                                               
ESXFLT18 CLI   XDFOTYP,XDFEDDQ     IS IT A DATE                                 
         BNE   ESXFLT20                                                         
         GOTO1 DATCON,DMCB,(X'81',XDFODTA),(17,1(R8)) CONVERT DATE              
         MVC   0(1,R8),4(R1)       STORE LENGTH                                 
         B     ESXFLT24                                                         
*                                                                               
ESXFLT20 CLI   XDFOTYP,XDFEDAQ     IS IT AN AMOUNT?                             
         BNE   ESXFLT22                                                         
         CURED (P6,XDFODTA),(12,1(R8)),2,COMMAS=NO,ALIGN=LEFT,         X        
               MINUS=YES                                                        
         LA    RF,12               CALCULATE REAL LENGTH OF AMOUNT              
         LA    R1,12(R8)                                                        
         CLI   0(R1),C' '                                                       
         BH    *+14                                                             
         SHI   R1,1                                                             
         BCT   RF,*-12                                                          
         DC    H'0'                                                             
         STC   RF,0(R8)            STORE REAL LENGTH OF AMOUNT                  
         B     ESXFLT24                                                         
*                                                                               
ESXFLT22 IC    RF,XDFLN                                                         
         SHI   RF,XDFOLNQ                                                       
         STC   RF,0(R8)            STORE LENGTH OF DATA VALUE                   
         SHI   RF,1                                                             
         MVC   1(0,R8),XDFODTA     STORE DATA VALUE                             
         EX    RF,*-6                                                           
         OC    1(0,R8),SPACES      (CAPITALIZE)                                 
         EX    RF,*-6                                                           
         DROP  E                                                                
*                                                                               
* Look for DATA NAME match                                                      
*                                                                               
         USING XDATED,RF                                                        
ESXFLT24 L     RF,AXDATNE                                                       
         LA    R8,WORK             R8 - points to xdata length & NAME           
         XR    R5,R5                                                            
         XR    RE,RE                                                            
ESXFLT26 ST    RF,CXDATNE                                                       
         IC    R5,XDATNUM          NUMBER OF XDATA NAMES                        
         MVC   BYTE,XDATCOL        BYTE=COLUMN NUMBER                           
         LA    RF,XDATNMS                                                       
         XR    R1,R1                                                            
*                                                                               
ESXFLT28 IC    R1,0(RF)                                                         
         CLC   0(1,RF),0(R8)       SAME LENGTH?                                 
         BNE   ESXFLT30                                                         
         BCTR  R1,0                                                             
         EXCLC R1,1(RF),1(R8)      DATA NAME MATCH?                             
         BE    ESXFLT32                                                         
         AHI   R1,1                                                             
ESXFLT30 LA    RF,1(R1,RF)                                                      
         BCT   R5,ESXFLT28         COMPARE TO NEXT XDATA NAME                   
         L     RF,CXDATNE                                                       
         IC    RE,XDATDLN                                                       
         AR    RF,RE                                                            
         CLI   0(RF),EOT           END OF TABLE?                                
         BNE   ESXFLT26                                                         
         B     ESXFLT06            YES, BUT CHECK IF ALL XDATA VALUE            
         DROP  RF                  FILTERS HAVE BEEN SATISFIED                  
*                                                                               
         USING XDATED,RF                                                        
ESXFLT32 L     RF,AXDATVE          FIND COLUMN XDATA FILTER VALUES              
         IC    R5,XDATNUM                                                       
         XR    RE,RE                                                            
ESXFLT34 ST    RF,CXDATVE                                                       
         CLC   XDATCOL,BYTE                                                     
         BE    ESXFLT36            FOUND XDATA FILTER VALUES                    
         BH    ESXFLT06                                                         
         IC    RE,XDATDLN                                                       
         AR    RF,RE                                                            
         CLI   0(RF),EOT           END OF TABLE?                                
         BNE   ESXFLT34                                                         
         B     ESXFLT06            NO XDATA VALUE FILTERS FOR COLUMN            
*                                                                               
ESXFLT36 XR    R1,R1                                                            
         IC    R1,0(R8)                                                         
         LA    R8,1(R1,R8)         R8 - points to xdata length & VALUE          
         LA    RF,XDATVLS                                                       
ESXFLT38 IC    R1,0(RF)                                                         
         CLC   0(1,RF),0(R8)       SAME LENGTH?                                 
         BNE   ESXFLT40                                                         
         BCTR  R1,0                                                             
         EXCLC R1,1(RF),1(R8)      DATA VALUE MATCH?                            
         BNE   ESXFLT40                                                         
         XR    RE,RE                                                            
         IC    RE,BYTE1                                                         
         SHI   RE,1                                                             
         STC   RE,BYTE1                                                         
         LTR   RE,RE                                                            
         BZ    ESXFLT46                                                         
         B     ESXFLT06                                                         
         AHI   R1,1                                                             
ESXFLT40 LA    RF,1(R1,RF)                                                      
         BCT   R5,ESXFLT38         COMPARE TO NEXT XDATA VALUE                  
         B     ESXFLT06                                                         
*                                                                               
         USING ESTRECD,R2                                                       
ESXFLT42 LA    R2,IOKEY            MOVE ON TO NEXT ESTIMATE                     
         L     RF,AIO2                                                          
         MVC   ESTKEY,0(RF)                                                     
         MVI   ESTKSEQ,X'FF'                                                    
         MVC   IOKEYSAV,ESTKEY                                                  
         L     R1,=AL4(IOHIGH+IOACDIR+IOAREA2)                                  
         GOTO1 AIO                                                              
         L     R1,=AL4(IOGETREC+IOACMST+IOAREA2)                                
         GOTO1 AIO                                                              
         L     R2,AIO2                                                          
         CLC   ESTKEY(ESTKLNO-ESTRECD),IOKEYSAV STILL ON EST FOR JOB?           
         BE    ESXFLTL                                                          
         B     ESXFLTH                                                          
*                                                                               
ESXFLT46 L     R2,AIO2             RE-ESTABLISH SEQUENCE                        
         MVC   IOKEY(L'ESTKEY),IOKEYSAV                                         
         L     R1,=AL4(IOREAD+IOACDIR+IOAREA2)                                  
         GOTO1 AIO                                                              
         L     R1,=AL4(IOGETREC+IOACMST+IOAREA2)                                
         GOTO1 AIO                                                              
         CLI   BYTE1,0             ALL XDATA VALUE FILTERS MATCHED?             
         BE    ESXFLTX                                                          
         L     R1,=AL4(IOSEQ+IOACDIR+IOAREA2)                                   
         GOTO1 AIO                                                              
         L     R1,=AL4(IOGETREC+IOACMST+IOAREA2)                                
         GOTO1 AIO                                                              
         CLC   ESTKEY(ESTKSEQ-ESTRECD),IOKEY  SEQUENTIAL RECORD?                
         BE    ESXFLT02                                                         
         BAS   RE,ESXREM                                                        
         CLC   ESTKEY(ESTKLNO-ESTRECD),IOKEY STILL ON AN EST FOR JOB?           
         BE    ESXFLTL                                                          
         B     ESXFLTH                                                          
*                                                                               
ESXREM   L     R1,CXESGLB          SAVE GLOBAL ESTIMATE NUMBER                  
         MVC   0(L'CURESGLB,R1),CURESGLB                                        
         AHI   R1,L'CURESGLB                                                    
         MVI   0(R1),X'FF'                                                      
         ST    R1,CXESGLB                                                       
         L     RF,POINTER          & DISREGARD RECENT ENTRY IN ESTMAIN          
         SHI   RF,ESTMLNQ                                                       
         MVI   0(RF),EOT                                                        
         ST    RF,POINTER                                                       
         BR    RE                                                               
*                                                                               
ESXFLTH  CLI   *,0                 SET CC HIGH                                  
         B     ESXFLTY                                                          
ESXFLTL  CLI   *,X'FF'             SET CC LOW                                   
         B     ESXFLTY                                                          
ESXFLTX  CR    RB,RB               SET CC EQUAL                                 
ESXFLTY  XMOD1 1                                                                
         DROP  R2,R7                                                            
         SPACE 1                                                                
*&&                                                                             
         TITLE 'Read total hours records for person'                            
*=====================================================================*         
*  Process total hours records for MTS and total hours type keywords  *         
*=====================================================================*         
                                                                                
         USING COLD,R3                                                          
         USING TTHRECD,R4                                                       
         USING FMTRECD,R5                                                       
TOTALHRS DS    0D                                                               
         NMOD1 0,**THRS**                                                       
         L     RC,RLBASEC                                                       
         MVC   WORK,STARTYR                                                     
         MVC   WORK+1(2),=X'0101'                                               
         GOTO1 DATCON,DMCB,(X'33',WORK),(1,WORK+3),(4,0)     Prior year         
         MVC   SVYEAR,WORK+3       Atempt to limit range for processing         
         MVC   TMPYEAR,SVYEAR                                                   
*                                                                               
         LH    R2,FORMAT#          Number of formats to process                 
         SR    R0,R0                                                            
TOTLHR01 IC    R0,FMT#COLS         Number of columns                            
         L     R3,FMTCOL           A(Column table)                              
         MVC   FMTBYTE1,TMPYEAR    Temporary storage by format                  
         MVC   FMTBYTE2,TMPYEAR                                                 
*                                                                               
TOTLHR02 TM    COLFLAGS,COLAMT                                                  
         BZ    TOTLHR08                                                         
         TM    COLFLAGS,COLCALC                                                 
         BO    TOTLHR08                                                         
         CLC   COLDD#,=AL2(AC#RSMTS)                                            
         BNE   TOTLHR05                                                         
         CLI   COLSTART,0          Any start date ?                             
         BE    TOTLHR03                                                         
         CLC   FMTBYTE1,COLSTART   Use lower of two                             
         BNH   TOTLHR03                                                         
         MVC   FMTBYTE1,COLSTART   Save off year (used for MTS#)                
*                                                                               
TOTLHR03 CLI   COLEND,X'FF'                                                     
         BE    TOTLHR05                                                         
         CLC   FMTBYTE2,COLEND     Use higher of two                            
         BNL   TOTLHR05                                                         
         MVC   FMTBYTE2,COLEND     Highest year                                 
*                                                                               
TOTLHR05 ZAP   COLTOTHR,PKZERO     Clear previous total hours                   
         ZAP   COLTOT1C,PKZERO     Clear previous 1C    hours                   
         ZAP   COLHOURS,PKZERO     Clear previous       hours                   
*                                                                               
TOTLHR08 AHI   R3,COLLNQ                                                        
         BCT   R0,TOTLHR02         Next column                                  
*                                                                               
         MVC   WORK(1),FMTBYTE1    Calculate # years to process                 
         MVC   WORK+1(2),=X'0101'                                               
         GOTO1 DATCON,DMCB,(1,WORK),(0,DTE1)                                    
         MVC   WORK(1),FMTBYTE2                                                 
         GOTO1 DATCON,DMCB,(1,WORK),(0,DTE2)                                    
         GOTO1 PERVERT,DMCB,DTE1,DTE2                                           
         LH    RF,16(,R1)                                                       
         LA    RF,1(,RF)                                                        
         STC   RF,FMTBYTE2         Number of years between                      
*                                                                               
         AHI   R5,FMTLNQ                                                        
         BCT   R2,TOTLHR01         Next format                                  
         EJECT                                                                  
*=====================================================================*         
* Set up for missing time sheets processing - total time records      *         
*=====================================================================*         
                                                                                
         L     R5,AFORMATS         Re-load first format                         
         BAS   RE,BLDTHR                                                        
                                                                                
         USING CPRCNDRD,R2                                                      
         SR    R0,R0                                                            
         IC    R0,FMTBYTE2         Get number of years to process               
         MVC   TMPYEAR,FMTBYTE1    Starting year                                
         L     R2,ACNDRBLK                                                      
TOTLHR60 MVC   CPROF,PRSNOFF       Person's office code                         
         MVC   CPRYY,TMPYEAR       Start with this year                         
         MVI   CPRACT,CPRLOCD      Get location detail in calendar              
         GOTO1 AGETCNDR,DMCB,ACNDRBLK,61                                        
         BE    TOTLHR62                                                         
         TM    CPRERR,CPRNF        Record not found                             
         BO    TOTLHR65            Can't post without calendar record           
                                                                                
TOTLHR62 BAS   RE,HRSPOST          Post hours to calendar                       
         BAS   RE,MTSPOST          Post to columns the MTS#                     
*                                                                               
TOTLHR65 MVC   WORK+1(2),=X'1230'                                               
         MVC   WORK(1),TMPYEAR     Add one year                                 
         GOTO1 DATCON,DMCB,(X'31',WORK),(1,WORK+3),(2,0)                        
         MVC   TMPYEAR,WORK+3                                                   
         BCT   R0,TOTLHR60         R0 = number left to process                  
         DROP  R2                                                               
                                                                                
***********************************************************************         
* Total hours process for PCT or THR keywords                         *         
*       3 choices for processing                                      *         
*         (A) Use total hours record                      - THRREC    *         
*         (B) Read Trans/TMS records & filter accordingly - THRDET    *         
*         (C) Normal process, calculate at ACCLST         - THRLST    *         
***********************************************************************         
                                                                                
TOTLHR70 TM    THRSW,THRREC        PROCESS (A)                                  
         BZ    TOTLHR80            No                                           
         BAS   RE,THRPOST                                                       
*                                                                               
TOTLHR80 TM    THRSW,THRDET        PROCESS (B)                                  
         BZ    TOTLHRSX            No                                           
         BAS   RE,THREAD           Read/Process TRANS/TMS records               
*                                                                               
TOTLHRSX XMOD1                                                                  
         DROP  R4                                                               
         EJECT                                                                  
*=====================================================================*         
* Post hours to calendar from total hours record or simulated record  *         
*=====================================================================*         
                                                                                
         USING PTHELD,R4                                                        
         USING CPRCNDRD,R2                                                      
         USING CDRD,R6                                                          
HRSPOST  NTR1                                                                   
         L     R2,ACNDRBLK                                                      
         L     R4,ATOTREC                                                       
         AH    R4,DATADISP                                                      
         ICM   R6,15,ACNDRWRK      Calendar record data                         
         BNZ   *+6                                                              
         DC    H'00'               Got to have one                              
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,CPR#PRD        Number of periods                            
         BZ    HRSPSTX             None                                         
*                                                                               
HRSPST10 CLI   0(R4),0             EOR ?                                        
         BE    HRSPSTX             Yes                                          
         CLI   0(R4),PTHELQ        X'8D' Period total hours element             
         BNE   HRSPST35            No                                           
         CLC   PTHEDT,CDRSDATE     Find element within range                    
         BL    HRSPST35                                                         
         CLC   PTHEDT,CDREDATE                                                  
         BH    HRSPST40                                                         
         CLC   PTHEDT,RTRNEND      Transaction end                              
         BNH   HRSPST20            Found period, so save total hours            
         B     HRSPSTX             At end of range                              
*                                                                               
HRSPST20 SR    R8,R8               R8 = # of sub-elements to process            
         IC    R8,PTHLN                                                         
         SHI   R8,PTHBLNQ          Remove header                                
         SRL   R8,3                Divide by 8 provided L'PTHSLNQ = 8           
         LA    R7,PTHSLNQ          Point to 1st sub-element                     
*                                                                               
         USING PTHSLNQ,R7          Sub portion of element                       
HRSPST25 CLC   PTHMOA,RMOAEND      Requested end MOA                            
         BH    HRSPST30                                                         
         AP    CDRTHRS,PTHTHRS     Save off hours for period                    
         OI    CDRIND,CDRIHIT                                                   
HRSPST30 LA    R7,L'PTHSLNQ(,R7)   All MOA'S saved for period                   
         BCT   R8,HRSPST25                                                      
*                                                                               
HRSPST35 SR    R1,R1                                                            
         ICM   R1,1,1(R4)          Next element                                 
         BNZ   *+6                                                              
         DC    H'00'                                                            
*                                                                               
         AR    R4,R1                                                            
         B     HRSPST10            Get next PTHEL element                       
         DROP  R7                                                               
*                                                                               
HRSPST40 LA    R6,CDRLNQ(,R6)      Next period, and process same elem           
         BCT   R0,HRSPST10                                                      
*                                                                               
HRSPSTX  XIT1                                                                   
         EJECT ,                                                                
*=====================================================================*         
* Post missing time sheets & MWR numbers for a given calendar         *         
*=====================================================================*         
                                                                                
MTSPOST  NTR1                                                                   
         LH    R1,FORMAT#          Number of formats to process                 
MTSPOS10 SR    R0,R0                                                            
         IC    R0,FMT#COLS                                                      
         L     R3,FMTCOL           Loop through column table                    
         LTR   R6,R6                                                            
         BZ    MTSPOSTX            Don't bother                                 
*                                                                               
MTSPOS20 CLC   COLDD#,=AL2(AC#RSMTS)    Missing time sheets ?                   
         BE    MTSPOS22                 Yes                                     
         CLC   COLDD#,=AL2(AC#RSMWR)    Man week ratio ?                        
         BNE   MTSPOS70                 No                                      
*                                                                               
MTSPOS22 L     R6,ACNDRWRK                                                      
         SR    R8,R8                                                            
         IC    R8,CPR#PRD          Number of periods                            
*                                                                               
MTSPOS25 CLI   CDR#ACTV,0          Person could of worked in period ?           
         BE    MTSPOS60            No                                           
         CLI   COLDATES,COLMDTE    MOA date based ?                             
         BNE   MTSPOS40            No                                           
         CLC   CDRMOA,COLSTART     Yes, check by MOA                            
         BL    MTSPOS60            Next column                                  
         CLC   CDRMOA,COLEND                                                    
         BH    MTSPOS60                                                         
         B     MTSPOS50                                                         
*                                                                               
MTSPOS40 CLC   CDREDATE,COLSTART   Period end date (calander)                   
         BL    MTSPOS60                                                         
         CLC   CDRSDATE,COLEND                                                  
         BH    MTSPOS60                                                         
*                                                                               
MTSPOS50 CP    CDRTHRS,PKZERO      Any hours ?                                  
         BNE   MTSPOS53            Yes                                          
         TM    CDRIND,CDRIHIT      Hours posted but net to zero ?               
         BO    MTSPOS53            Yes                                          
         CLC   COLDD#,=AL2(AC#RSMTS)    Missing time sheets ?                   
         BNE   MTSPOS60                 No                                      
*&&US                                                                           
         BAS   RE,TIMEXST                                                       
         BE    MTSPOS53            found a real zero hour timesheet             
*&&                                                                             
         AP    COLTOMTS,=P'100'    Add up MTS                                   
         B     MTSPOS60                                                         
*                                                                               
MTSPOS53 BAS   RE,ADJMTCNT         Count up other Missing Timesheets            
*                                                                               
MTSPOS55 CLC   COLDD#,=AL2(AC#RSMWR)    Man Week Ratio ?                        
         BNE   MTSPOS60                                                         
         AP    COLTOACT,=P'100'    Add up periods active for                    
*                                                                               
MTSPOS60 LA    R6,CDRLNQ(,R6)      Next period                                  
         BCT   R8,MTSPOS25                                                      
*                                                                               
MTSPOS70 LA    R3,COLLNQ(,R3)      Next column                                  
         BCT   R0,MTSPOS20                                                      
*                                                                               
         LA    R5,FMTLNQ(,R5)      Next format                                  
         BCT   R1,MTSPOS10         Start again                                  
MTSPOSTX XIT1                                                                   
*        DROP  R6                                                               
         EJECT                                                                  
*=====================================================================*         
* Adjust Missing Timesheet count                                      *         
*=====================================================================*         
         USING TSWRECD,R4                                                       
ADJMTCNT NTR1                                                                   
         XR    RF,RF                                                            
         ICM   RF,7,CDREDATE                                                    
         X     RF,=X'00FFFFFF'                                                  
         AHI   RF,1                                                             
         STCM  RF,7,CLMNEND        2'S COMP OF COLEND                           
         ICM   RF,7,CDRSDATE                                                    
         X     RF,=X'00FFFFFF'                                                  
         AHI   RF,1                                                             
         STCM  RF,7,CLMNSTRT       2'S COMP OF COLSTART                         
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R4,IOKEY                                                         
         MVI   TSWKTYP,TSWKTYPQ    x'3E'                                        
         MVI   TSWKSUB,TSWKSUBQ    x'0F'                                        
         MVC   TSWKCPY,CURACC                                                   
         MVC   TSWKEND,CLMNEND                                                  
*                                                                               
         MVC   TSWKPER,SPACES                                                   
         LA    RF,CURACC+3                                                      
         XR    R0,R0                                                            
         IC    R0,LEV3LN                                                        
         AR    RF,R0                                                            
         XR    RE,RE                                                            
         IC    RE,LEV4LN                                                        
         SR    RE,R0                                                            
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   TSWKPER(0),0(RF)                                                 
*                                                                               
         MVC   TSWKODS,SPACES                                                   
         IC    RE,LEV3LN                                                        
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   TSWKODS(0),CURACC+3                                              
ADJMTC10 L     R1,=AL4(IOAREA3+IOHIGH+IOACDIR)                                  
         GOTO1 AIO                                                              
*                                                                               
TSW      USING TSWRECD,R2                                                       
         L     R2,AIO3                                                          
         CLC   TSW.TSWKEY(TSWKEND-TSWKEY),TSWKEY                                
         BNE   AMTCNTX                                                          
         CLC   TSW.TSWKEND,CLMNEND                                              
         BL    AMTCNTX                                                          
         CLC   TSW.TSWKEND,CLMNSTRT                                             
         BH    AMTCNTX                                                          
         CLC   TSW.TSWKODS,TSWKODS                                              
         BNE   AMTCNTX                                                          
*                                                                               
         TM    TSW.TSWKSTAT,X'FF'-(TIMSDELT+X'04')                              
         BNZ   *+12                                                             
         MVI   CURBRTST,C'I'       IN PROGRESS (ALL STATUS OFF)                 
         B     ADJMTC20                                                         
         TM    TSW.TSWKSTAT,TIMSPAPP                                            
         BZ    *+12                                                             
         MVI   CURBRTST,C'P'       PART APPROVED                                
         B     ADJMTC20                                                         
                                                                                
         TM    TSW.TSWKSTAT,TIMSFAPP   FULLY APPROVED                           
         BZ    *+8                                                              
         MVI   CURBRTST,C'F'                                                    
         TM    TSW.TSWKSTAT,TIMSSUBM   SUBMITTED                                
         BZ    *+8                                                              
         MVI   CURBRTST,C'S'                                                    
         TM    TSW.TSWKSTAT,TIMSREJE   REJECTED                                 
         BZ    *+8                                                              
         MVI   CURBRTST,C'R'                                                    
*                                                                               
ADJMTC20 DS    0H                                                               
         GOTO1 AFILTER,DMCB,AFLMTSTA,CURBRTST                                   
         BNE   ADJMTC30                                                         
         AP    COLTOMTS,=P'100'    NO, add up MTS                               
*                                                                               
ADJMTC30 MVC   IOKEY,TSW.TSWKEY                                                 
         XR    RF,RF                                                            
         ICM   RF,7,TSWKEND        BUMP TO NEXT TIMESHEET PERIOD                
         AHI   RF,1                                                             
         STCM  RF,7,TSWKEND                                                     
         B     ADJMTC10                                                         
*                                                                               
AMTCNTX  XIT1                                                                   
*                                                                               
CLMNEND  DS    PL3                                                              
CLMNSTRT DS    PL3                                                              
*                                                                               
         DROP  R2                                                               
         EJECT                                                                  
*=====================================================================*         
* Adjust Missing Timesheet count                                      *         
*=====================================================================*         
TIMEXST  NTR1                                                                   
         XR    RF,RF                                                            
         ICM   RF,7,CDREDATE                                                    
         X     RF,=X'00FFFFFF'                                                  
         AHI   RF,1                                                             
         STCM  RF,7,CLMNEND        2'S COMP OF COLEND                           
         ICM   RF,7,CDRSDATE                                                    
         X     RF,=X'00FFFFFF'                                                  
         AHI   RF,1                                                             
         STCM  RF,7,CLMNSTRT       2'S COMP OF COLSTART                         
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R4,IOKEY                                                         
         MVI   TSWKTYP,TSWKTYPQ    x'3E'                                        
         MVI   TSWKSUB,TSWKSUBQ    x'0F'                                        
         MVC   TSWKCPY,CURACC                                                   
         MVC   TSWKEND,CLMNEND                                                  
*                                                                               
         MVC   TSWKPER,SPACES                                                   
         LA    RF,CURACC+3                                                      
         XR    R0,R0                                                            
         IC    R0,LEV3LN                                                        
         AR    RF,R0                                                            
         XR    RE,RE                                                            
         IC    RE,LEV4LN                                                        
         SR    RE,R0                                                            
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   TSWKPER(0),0(RF)                                                 
*                                                                               
         MVC   TSWKODS,SPACES                                                   
         IC    RE,LEV3LN                                                        
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   TSWKODS(0),CURACC+3                                              
         L     R1,=AL4(IOAREA3+IOHIGH+IOACDIR)                                  
         GOTO1 AIO                                                              
*                                                                               
TSW2     USING TSWRECD,R2                                                       
         L     R2,AIO3                                                          
         CLC   TSW2.TSWKEY(TSWKEND-TSWKEY),TSWKEY                               
         BNE   AMTCNTX                                                          
         CLC   TSW2.TSWKEND,CLMNEND                                             
         BL    AMTCNTX                                                          
         CLC   TSW2.TSWKEND,CLMNSTRT                                            
         BH    AMTCNTX                                                          
*                                                                               
TIMXSTY  CR    RB,RB                                                            
         B     *+6                                                              
TIMXSTN  LTR   RB,RB                                                            
         XIT1                                                                   
*                                                                               
         DROP  R6                                                               
         EJECT                                                                  
*=====================================================================*         
* Post total hours to columns that need them across all formats       *         
*=====================================================================*         
         USING PTHELD,R4                                                        
THRPOST  NTR1                                                                   
         L     R4,ATOTREC                                                       
         AH    R4,DATADISP                                                      
THRPST10 CLI   0(R4),0             EOR ?                                        
         BE    THRPSTX             Yes, finished                                
         CLI   0(R4),PTHELQ        X'8D'                                        
         BE    THRPST15                                                         
         CLI   0(R4),PTHELQA       X'8E'                                        
         BNE   THRPST80            Next element                                 
*                                                                               
THRPST15 ZIC   R8,PTHLN                                                         
         SHI   R8,PTHBLNQ          Remove header                                
         SRL   R8,3                Divide by 8 provided L'PTHSLNQ = 8           
         LA    R7,PTHSLNQ          Point to 1st sub-element                     
*                                                                               
         USING PTHSLNQ,R7                                                       
THRPST20 CLC   PTHMOA,RMOASTR      Only those within requested MOA              
         BL    THRPST60            Out side range, get next                     
         CLC   PTHMOA,RMOAEND                                                   
         BH    THRPST60            Out side range, get next                     
*                                                                               
         USING COLD,R3                                                          
         LH    R1,FORMAT#          Number of formats to process                 
THRPST30 SR    R0,R0                                                            
         IC    R0,FMT#COLS         Number of columns to process                 
         L     R3,FMTCOL                                                        
*                                                                               
THRPST32 TM    COLOPT2,COLTHRS     Total hours column ?                         
         BZ    THRPST40            No, next column                              
         CLC   COLDD#,=AL2(AC#RSMTS)   Exception to type                        
         BE    THRPST40                                                         
         CLI   COLDATES,COLMDTE    MOA date based ?                             
         BNE   THRPST34            No                                           
         CLC   PTHMOA,COLSTART     Yes, check by MOA                            
         BL    THRPST40            Next column                                  
         CLC   PTHMOA,COLEND                                                    
         BH    THRPST40            Next column                                  
         B     THRPST38            Post hours                                   
*                                                                               
THRPST34 CLC   PTHEDT,COLSTART     PERIOD END DATE (CALANDER)                   
         BL    THRPST40            Next column                                  
         CLC   PTHEDT,COLEND                                                    
         BH    THRPST40            Next column                                  
*                                                                               
THRPST38 AP    COLTOTHR,PTHTHRS    Total hours                                  
         AP    COLTOT1C,PTHCHRS    Total client hours                           
*                                                                               
THRPST40 LA    R3,COLLNQ(,R3)                                                   
         BCT   R0,THRPST32         Process next column                          
         DROP  R3                                                               
*                                                                               
         LA    R5,FMTLNQ(,R5)      Process next format                          
         BCT   R1,THRPST30                                                      
*                                                                               
         L     R5,AFORMATS         Re-load 1st format                           
THRPST60 LA    R7,L'PTHSLNQ(,R7)   Bump to next sub-element                     
         BCT   R8,THRPST20         Next                                         
         DROP  R7                                                               
*                                                                               
THRPST80 ZIC   RF,1(,R4)                                                        
         AR    R4,RF                                                            
         B     THRPST10            Process next element                         
*                                                                               
THRPSTX  XIT1                                                                   
         DROP  R4,R5                                                            
         EJECT ,                                                                
*=====================================================================*         
*  Build a total time record using TMS or transaction records on 1R   *         
*=====================================================================*         
                                                                                
         USING TTHRECD,R6                                                       
         USING ACRL2D,R7                                                        
BLDTHR   NTR1                                                                   
         L     R6,ATOTREC                                                       
         L     R7,AACRL2D                                                       
         XC    TTHKEY,TTHKEY                                                    
         MVI   TTHKTYP,TTHKTYPQ    X'3E' Total hours record                     
         MVI   TTHKSUB,TTHKSUBQ    X'0E' Sub   type                             
         MVI   TTHKTIME,TTHKTTOT   X'02' Total time                             
         MVC   TTHKCULA,CURACC     Move  in 1R account (PERSON)                 
         LR    R2,R6                                                            
         AH    R2,DATADISP         Start of elements to build                   
         XC    0(20,R2),0(R2)      Start fresh                                  
         XC    TTHKSMOA,TTHKSMOA   Start MOA                                    
         XC    TTHKEMOA,TTHKEMOA   End   MOA                                    
*&&DO                                                                           
*=====================================================================*         
* Read in total time records for person & build on big record (US)    *         
*=====================================================================*         
REC      USING TTHRECD,R4                                                       
         MVC   IOKEY,TTHKEY                                                     
         L     R1,=AL4(IOAREA3+IOHIGH+IOACFIL)                                  
         L     R4,AIO3                                                          
         LR    R3,R4                                                            
         AH    R3,DATADISP                                                      
*                                                                               
BLDTHR02 GOTO1 AIO                                                              
         CLC   TTHKEY(TTHKEMOA-TTHRECD),0(R4)                                   
         BNE   BLDTHRX             Finished                                     
         SR    R1,R1                                                            
         ICM   R1,3,REC.TTHRLEN                                                 
         SH    R1,DATADISP                                                      
         BCTR  R1,0                Adjust by one for EOR                        
         BNP   BLDTHR06            No elements to append                        
         LR    RF,R1                                                            
         LR    RE,R3               Elements to append from                      
         LR    R0,R2               Where to append elements to                  
         MVCL  R0,RE                                                            
         LR    R2,R0               Point to end or record                       
         MVI   0(R2),0             Mark end of record                           
         OC    TTHKSMOA,TTHKSMOA                                                
         BZ    *+10                                                             
         MVC   TTHKSMOA,REC.TTHKSMOA    Initialize values                       
         MVC   TTHKEMOA,REC.TTHKEMOA                                            
*                                                                               
BLDTHR06 L     R1,=AL4(IOAREA3+IOSEQ+IOACFIL)                                   
         B     BLDTHR02                                                         
         DROP  REC                                                              
*&&                                                                             
*                                                                               
                                                                                
DIR      USING TIMRECD,IODIRKEY                                                 
         L     R1,=AL4(IOAREA3+IOHIGH+IOACDIR)                                  
         MVC   DIR.TIMKEY,SPACES                                                
         MVC   DIR.TIMKCULA(15),CURACC                                          
         CLI   NEWOFF,YES                    2 BYTE OFFICES ?                   
         BNE   BLDTHR10                                                         
         MVI   DIR.TIMKOFF,X'41'             GET FIRST OFFICE                   
*                                                                               
         USING TIMRECD,R4                                                       
BLDTHR10 GOTO1 AIO                                                              
         L     R4,AIO3                                                          
         CLC   CURACC,TIMKCULA     Same person ?                                
         BNE   BLDTHRX             No, so finished                              
         CLC   TIMKPEDT,SPACES     Transaction date ?                           
         BNH   BLDTHR80            Yes must be a TMS or trans record            
         CLC   TIMKULC,SPACES      Contra unit/ledger account ?                 
         BNH   BLDTHR80            Yes must be eTime record                     
         CLC   =C'1J',TIMKULC      1J Contra account ?                          
         BE    BLDTHR80            Yes must be old cost transaction             
         L     R1,=AL4(IOGETREC+IOACMST+IOAREA3)                                
         TM    TIMKSTAT,TRNSARCH   TEST ARCHIVED                                
         BZ    *+8                 NO                                           
         L     R1,=AL4(IOGETREC+IOACARC+IOAREA3)                                
         GOTO1 AIO                                                              
*                                                                               
         SR    RF,RF                                                            
         LA    R5,TIMRFST          Point to first element                       
         XC    HALF,HALF           HALF = MOS                                   
         ZAP   DUB,PKZERO          DUB = HOURS                                  
         MVI   BYTE,PTHELQ         Regular hours type                           
         CLI   0(R5),TRNELQ        X'44' Would be first element, only 1         
         BNE   BLDTHR40                                                         
BLDTHR12 CLI   0(R5),0             End of record ?                              
         BE    BLDTHR30                                                         
         CLI   0(R5),SCIELQ        X'50', get hours                             
         BE    BLDTHR20                                                         
         CLI   0(R5),TRSELQ        X'60', status element                        
         BE    BLDTHR22                                                         
BLDTHR15 ZIC   RF,1(,R5)                                                        
         AR    R5,RF                                                            
         B     BLDTHR12                                                         
*                                                                               
         USING SCIELD,R5                                                        
BLDTHR20 CLI   SCITYPE,SCITHOUR    Hours type ?                                 
         BNE   BLDTHR15            Try again                                    
         ZAP   DUB,SCIAMNT         Save off hours                               
         B     BLDTHR15                                                         
*                                                                               
         USING TRSELD,R5                                                        
BLDTHR22 MVC   HALF,TRSPMOS        Transaction MOS                              
         TM    TRSSTAT2,TRSSTADJ   Adjusted hours                               
         BZ    BLDTHR15                                                         
         MVI   BYTE,PTHELQA        Adjusted hours type                          
         B     BLDTHR15                                                         
*                                                                               
BLDTHR30 BAS   RE,TIMEADD                                                       
         B     BLDTHR80                                                         
*                                                                               
BLDTHR40 CLI   0(R5),0             End of record                                
         BE    BLDTHR80            Next record                                  
         CLI   0(R5),TIMELQ        X'8B' TMS BASED                              
         BE    BLDTHR45                                                         
BLDTHR42 ZIC   RF,1(,R5)                                                        
         AR    R5,RF                                                            
         B     BLDTHR40                                                         
*                                                                               
         USING TIMELD,R5                                                        
BLDTHR45 MVI   BYTE,PTHELQ         X'8D' Regular type                           
         CLI   TIMETYP,TIMEINP     Regular input type                           
         BNE   BLDTHR42                                                         
         TM    TIMIND,TIMIADJ      Adjusted time ?                              
         BZ    *+8                                                              
         MVI   BYTE,PTHELQA        X'8E' Adjusted type                          
         MVC   HALF,TIMMOA         MOA                                          
         ZAP   DUB,TIMHRS          Hours                                        
         BAS   RE,TIMEADD                                                       
         B     BLDTHR42            Process next element                         
*                                                                               
BLDTHR80 L     R1,=AL4(IOSEQ+IOACDIR+IOAREA3)                                   
         B     BLDTHR10                                                         
*                                                                               
BLDTHRX  XIT1  ,                                                                
         DROP  DIR                                                              
         EJECT                                                                  
*                                                                               
*=====================================================================*         
*        Add or merge element data to record                          *         
*            HALF = MOA                                               *         
*            DUB  = Hours                                             *         
*            BYTE = Element code to add x'8D' or x'8E'                *         
*=====================================================================*         
                                                                                
         USING PTHELD,R2                                                        
TIMEADD  NTR1                                                                   
         LA    R2,CHOPWRK          See if element is on record                  
         L     R6,ATOTREC                                                       
         AH    R6,DATADISP                                                      
         SHI   R6,2                Addjust for CORETAB type call                
         MVC   PTHEL,BYTE          x'8D' or x'8E'                               
         MVI   PTHLN,0                                                          
         MVC   PTHEDT,TIMKPEDT                                                  
         GOTO1 ADDEL,DMCB,(C'G',=CL8'CORETAB'),(BYTE,(R6)),(3,PTHEDT)           
         CLI   DMCB+12,0                                                        
         BE    TIMEA100            Found                                        
         CLI   DMCB+12,6           Not found                                    
         BE    *+6                                                              
         DC    H'00'                                                            
*                                  Add a new element                            
         MVI   PTHLN,PTHLNQ        Single MOA length                            
         LA    R5,PTHSLNQ          Sub-element                                  
*                                                                               
         USING PTHSLNQ,R5                                                       
         MVC   PTHMOA,HALF         Save off MOA                                 
         CLC   =C'1C',TIMKCUNT                                                  
         BNE   TIMEA040                                                         
         ZAP   PTHCHRS,DUB         Save off hours                               
         ZAP   PTHTHRS,DUB         Save off hours                               
         B     TIMEA150            Add new element                              
*                                                                               
TIMEA040 CLC   =C'1N',TIMKCUNT                                                  
         BE    *+6                                                              
         DC    H'00'                                                            
*                                                                               
         ZAP   PTHCHRS,PKZERO                                                   
         ZAP   PTHTHRS,DUB                                                      
         B     TIMEA150            Add new element                              
         DROP  R5                                                               
         EJECT ,                                                                
*=====================================================================*         
*       Merge with existing element                                   *         
*=====================================================================*         
TIMEA100 L     R2,DMCB+12          A(Element found)                             
         LA    R5,PTHSLNQ          Point to 1st sub-element                     
*                                                                               
         USING PTHSLNQ,R5                                                       
         SR    R1,R1                                                            
         IC    R1,PTHLN            Element length                               
         SHI   R1,PTHBLNQ          Subtract header                              
         SRL   R1,3                Divide by 8, R1 = # of sub-elements          
*                                                                               
TIMEA110 CLC   PTHMOA,HALF         Match on MOA if possible                     
         BE    TIMEA200            Found so add hours to element                
         AHI   R5,L'PTHSLNQ        Point to next MOA if any                     
         BCT   R1,TIMEA110                                                      
         DROP  R5                                                               
*                                                                               
         LA    R1,PTHBLNQ-1        No match. Move in PTHEL header               
         EXMVC R1,CHOPWRK,PTHEL    Save off data to rebuild element             
*                                                                               
NEW      USING PTHSLNQ,R3                                                       
         LA    R3,CHOPWRK+PTHBLNQ  Point to 1st sub-element in NEW              
         IC    R1,PTHLN            Element length                               
         SHI   R1,PTHBLNQ          Subtract header                              
         SRL   R1,3                Divide by 8, R1 = # of sub-elements          
         LA    R5,PTHEL+PTHBLNQ    Point to 1st sub-element in existing         
*                                                                               
         USING PTHSLNQ,R5                                                       
TIMEA120 CLC   HALF,PTHMOA         Place MOAs in accending order                
         BL    TIMEA130                  Add new MOA                            
         MVC   NEW.PTHSLNQ,PTHSLNQ       Append old MOA & amounts               
         AHI   R3,L'PTHSLNQ              Next spot in NEW                       
         AHI   R5,L'PTHSLNQ              Next spot in OLD                       
         BCT   R1,TIMEA120                                                      
*                                                                               
TIMEA130 MVC   NEW.PTHMOA,HALF     Add new MOA                                  
         CLC   =C'1C',TIMKCUNT                                                  
         BNE   TIMEA132                                                         
         ZAP   NEW.PTHCHRS,DUB     Save off hours                               
         ZAP   NEW.PTHTHRS,DUB     Save off hours                               
         B     TIMEA135                                                         
*                                                                               
TIMEA132 CLC   =C'1N',TIMKCUNT                                                  
         BE    *+6                                                              
         DC    H'00'                                                            
         ZAP   NEW.PTHCHRS,PKZERO                                               
         ZAP   NEW.PTHTHRS,DUB                                                  
*                                                                               
TIMEA135 AHI   R3,L'PTHSLNQ        End of sub-element added                     
         LTR   R1,R1                                                            
         BZ    TIMEA140                                                         
         MHI   R1,8                Size left to move                            
         BCTR  R1,0                                                             
         EXMVC R1,NEW.PTHMOA,PTHMOA     Move in what is left                    
         DROP  NEW                                                              
*                                                                               
NEW      USING PTHELD,CHOPWRK                                                   
                                                                                
TIMEA140 IC    R1,NEW.PTHLN                                                     
         AHI   R1,L'PTHSLNQ        Added one sub-element                        
         STC   R1,NEW.PTHLN                                                     
         MVI   PTHEL,X'FF'         Mark for deletion                            
         GOTO1 ADDEL,DMCB,(C'D',=CL8'CORETAB'),(X'FF',(R6)),0                   
*                                                                               
TIMEA150 GOTO1 ADDEL,DMCB,(C'P',=CL8'CORETAB'),(R6),NEW.PTHEL,0                 
         B     TIMEA500                                                         
         DROP  NEW                                                              
*                                                                               
TIMEA200 CLC   =C'1C',TIMKCUNT                                                  
         BNE   TIMEA210                                                         
         AP    PTHCHRS,DUB     Add to previous client hours                     
         AP    PTHTHRS,DUB     Add to previous total hours                      
         B     TIMEA500                                                         
*                                                                               
TIMEA210 CLC   =C'1N',TIMKCUNT                                                  
         BE    *+6                                                              
         DC    H'00'                                                            
         AP    PTHTHRS,DUB     Save off hours                                   
         DROP  R5                                                               
*                                                                               
TIMEA500 L     R6,ATOTREC                                                       
         OC    TTHKSMOA,TTHKSMOA   First time in ?                              
         BNZ   TIMEA510            No                                           
         MVC   TTHKSMOA,HALF       Yes, so set                                  
         MVC   TTHKEMOA,HALF                                                    
*                                                                               
TIMEA510 CLC   HALF,TTHKSMOA       Compare MOA added to start MOA               
         BNL   TIMEA520                                                         
         MVC   TTHKSMOA,HALF       Replace Starting MOA                         
*                                                                               
TIMEA520 CLC   HALF,TTHKEMOA       Compare MOA added to end MOA                 
         BNH   TIMEAXIT            Process next element                         
         MVC   TTHKEMOA,HALF       Replace End MOA                              
*                                                                               
TIMEAXIT XIT1                                                                   
         DROP  R2,R4,R6                                                         
*                                                                               
         EJECT ,                                                                
***********************************************************************         
*  POST EACH HOURS TO BIN-TABLE TO PROCESS BY COLUMN WITH FILTERING   *         
***********************************************************************         
         SPACE 1                                                                
         USING TIMRECD,R4                                                       
DKEY     USING TIMRECD,IODIRKEY                                                 
*                                                                               
THREAD   NTR1                                                                   
         L     R4,AIO3                                                          
         MVC   DKEY.TIMKEY,SPACES                                               
         MVC   DKEY.TIMKCULA,CURACC                                             
         MVC   DKEY.TIMKCULC(1),CURACC       MOVE IN COMPANY CODE               
         L     R1,=AL4(IOHIGH+IOACDIR+IOAREA3)                                  
         CLI   NEWOFF,YES                    2 BYTE OFFICES ?                   
         BNE   THREAD10                                                         
         MVI   DKEY.TIMKOFF,X'41'            GET FIRST OFFICE                   
         MVI   DKEY.TIMKCULC,BLANK           RESET                              
*                                                                               
THREAD10 GOTO1 AIO                                                              
         CLC   TIMKACT(12),CURACC+3          SAME PERSON ?                      
         BNE   THREADX                       NO, SO FINISHED                    
         CLC   TIMKPEDT,SPACES               Transaction date ?                 
         BNH   *+14                          Must be TMS or trans. rec          
         CLC   TIMKULC,SPACES                eTime record ?                     
         BH    THREAD20                      No - we want this one              
         L     R1,=AL4(IOSEQ+IOACDIR+IOAREA3)                                   
         CLI   NEWOFF,YES                    2 BYTE OFFICES ?                   
         BNE   THREAD10                      NO                                 
         CLC   TIMKCULC,SPACES                                                  
         BH    THREAD10                      MUST BE CONTRA HEADER              
         MVC   DKEY.TIMKOFF,TIMKOFF                                             
         MVC   DKEY.TIMKCULC(1),CURACC     MOVE IN COMPANY CODE                 
         L     R1,=AL4(IOHIGH+IOACDIR+IOAREA3)                                  
         B     THREAD10                                                         
*                                                                               
THREAD20 MVC   THRTDTE,TIMKPEDT                                                 
         CLC   THRTDTE,RTRNSTR     REQUEST RANGE START                          
         BL    THREAD58                                                         
         CLC   THRTDTE,RTRNEND     REQUEST RANGE END                            
         BH    THREAD58                                                         
         ZAP   THRHRS,PKZERO       INITALIZE                                    
         XC    THRMOS,THRMOS                                                    
         MVC   CURWKCD,SPACES                                                   
         MVC   CURSJACC,SPACES                                                  
         MVC   CURSUBAC,TIMKCULC                                                
*        MVC   CUROFF,TIMKOFF                                                   
         MVI   CURTIME,C'N'        DEFAULT TO 1N TIME                           
         CLC   =C'1N',TIMKCUNT                                                  
         BE    *+8                                                              
         MVI   CURTIME,C'B'        DEFAULT TO BILLABLE                          
         L     R1,=AL4(IOGETREC+IOACMST+IOAREA3)                                
         GOTO1 AIO                                                              
*                                                                               
         SR    RF,RF                                                            
         L     R1,=AL4(IOSEQ+IOACDIR+IOAREA3)                                   
         LA    R6,TIMRFST          POINT TO FIRST ELEMENT                       
THREAD22 CLI   0(R6),0             EOR                                          
         BE    THREAD10                                                         
         CLI   0(R6),TRNELQ        X'44' TRANSACTION BASED                      
         BE    THREAD30                                                         
         CLI   0(R6),TIMELQ        X'8B' TMS BASED                              
         BE    THREAD50                                                         
         IC    RF,1(,R6)                                                        
         AR    R6,RF                                                            
         B     THREAD22                                                         
*                                                                               
THREAD30 CLI   0(R6),0             EOR                                          
         BE    THREAD40            PUT TO BIN TABLE                             
         CLI   0(R6),PRTELQ        X'40'                                        
         BE    THREAD33                                                         
         CLI   0(R6),SCIELQ        X'50'                                        
         BE    THREAD35                                                         
         CLI   0(R6),PCIELQ        X'51'                                        
         BE    THREAD37                                                         
         CLI   0(R6),TRSELQ        X'60'                                        
         BE    THREAD39                                                         
*                                                                               
THREAD32 SR    RF,RF                                                            
         IC    RF,1(,R6)                                                        
         AR    R6,RF                                                            
         B     THREAD30                                                         
*                                                                               
         USING PRTELD,R6                                                        
THREAD33 CLI   CURTIME,C'N'        NON-CLIENT ?                                 
         BE    THREAD32            YES                                          
         ZAP   THRHRS,PRTHOUR                                                   
*&&US                                                                           
         TM    PRTSTAT,PRTSBILQ                                                 
         BO    THREAD32            MUST BE BILLABLE                             
         MVI   CURTIME,C'R'                                                     
         TM    PRTSTAT,PRTSRTEQ    CLIENT REALIZATION ?                         
         BO    THREAD32                                                         
         MVI   CURTIME,C'N'        BACK TO NON-BILLABLE                         
*&&                                                                             
         B     THREAD32                                                         
*                                                                               
         USING SCIELD,R6                                                        
THREAD35 CLI   SCITYPE,SCITHOUR    HOURS TYPE ?                                 
         BNE   THREAD32                                                         
         ZAP   THRHRS,SCIAMNT                                                   
         B     THREAD32                                                         
*                                                                               
         USING PCIELD,R6                                                        
THREAD37 CLI   CURTIME,C'N'                                                     
         BE    THREAD32                                                         
         MVC   CURSJACC,PCICLI+3        CLI/PROD/JOB                            
         CLI   PCILN,PCILN2Q                                                    
         BL    THREAD32                                                         
         MVC   CURWKCD,PCITSK           TASK (WORKCODE)                         
         CLC   CURSJ+8(6),SPACES                                                
         BH    THREAD32                 ALREADY SET                             
         CLC   PCIPRJT+3(12),SPACES                                             
         BNH   THREAD32                                                         
         MVC   CURSJACC,PCIPRJT+3       CLI/PROD/JOB                            
         B     THREAD32                                                         
*                                                                               
         USING TRSELD,R6                                                        
THREAD39 MVC   THRMOS,TRSPMOS                                                   
         CLC   THRMOS,RMOASTR      REQUEST MOA START                            
         BL    THREAD58                                                         
         CLC   THRMOS,RMOAEND      REQUEST MOA END                              
         BH    THREAD58                                                         
         B     THREAD32                                                         
*                                                                               
THREAD40 GOTO1 POSTTHR                                                          
         B     THREAD58                                                         
*                                                                               
         USING TIMELD,R6                                                        
THREAD50 CLI   0(R6),0             EOR                                          
         BE    THREAD58                                                         
         CLI   0(R6),TIMELQ        X'8B'                                        
         BNE   THREAD52                                                         
         CLI   TIMETYP,TIMEINP     INPUT DETAIL ?                               
         BE    THREAD55                                                         
*                                                                               
THREAD52 SR    RF,RF                                                            
         IC    RF,1(,R6)                                                        
         AR    R6,RF                                                            
         B     THREAD50                                                         
*                                                                               
THREAD55 CLC   TIMACC(2),=C'SJ'                                                 
         BNE   *+10                                                             
         MVC   CURSJACC,TIMACC+2   CLI/PROD/JOB                                 
         MVI   CURTIME,C'B'        BILLABLE                                     
         CLI   TIMTTYP,TIMTCB                                                   
         BE    THREAD56                                                         
         MVI   CURTIME,C'R'        REALIZATION                                  
         CLI   TIMTTYP,TIMTCR                                                   
         BE    THREAD56                                                         
         MVI   CURTIME,C'N'        NON-BILLABLE                                 
         CLI   TIMTTYP,TIMTCN                                                   
         BE    THREAD56                                                         
         CLC   =C'1N',CURSUBAC+1                                                
         BE    THREAD56                                                         
         DC    H'00'               UNKNOWN TYPE OF TIME ?                       
*                                                                               
THREAD56 ZAP   THRHRS,TIMHRS                                                    
         MVC   THRMOS,TIMMOA                                                    
         CLC   THRMOS,RMOASTR      REQUEST MOA START                            
         BL    THREAD52                                                         
         CLC   THRMOS,RMOAEND      REQUEST MOA END                              
         BH    THREAD52                                                         
         MVC   CURWKCD,TIMTSK                                                   
         GOTO1 POSTTHR                                                          
         MVC   CURSJACC,SPACES                                                  
         B     THREAD52            NEXT ELEMENT                                 
*                                                                               
THREAD58 L     R1,=AL4(IOSEQ+IOACDIR+IOAREA3)                                   
         B     THREAD10                                                         
*                                                                               
THREADX  MVI   CURTIME,BLANK       Re-set values, done with filtering           
         MVC   CURWKCD,SPACES                                                   
         MVC   CURSUBAC,SPACES                                                  
         MVC   CURSJACC,SPACES                                                  
         XIT1                                                                   
         SPACE 1                                                                
SVYEAR   DS    XL1                 Packed year                                  
TMPYEAR  DS    XL1                 Packed year                                  
         SPACE 1                                                                
         DROP  R4,R6                                                            
         DROP  DKEY                                                             
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'POST TOTAL HOURS FOR EACH TRANS/TMS REC'                        
***********************************************************************         
* POST HOURS TO EACH COLUMN FOR PCT OR THRS                           *         
***********************************************************************         
         SPACE 1                                                                
POSTTHRS CP    THRHRS,PKZERO       ANY HOURS TO POST ?                          
         BER   RE                                                               
*                                                                               
         USING FMTRECD,R5                                                       
POSTTH00 NTR1  BASE=*,LABEL=*                                                   
         LH    R7,FORMAT#          NUBMER OF FORMATS TO PROCESS                 
         L     R5,AFORMATS         FIRST FORMAT RECORD                          
*                                                                               
         USING COLD,R3                                                          
POSTTH10 TM    FMTSW,FMTTHRON      DOES THIS FORMAT NEED PROCESS ?              
         BZ    POSTTH80            NO                                           
         SR    R0,R0                                                            
         IC    R0,FMT#COLS         NUMBER OF COLUMNS TO SCAN                    
         L     R3,FMTCOL           COLUMN DATA                                  
*                                                                               
POSTTH20 TM    COLFLAGS,COLAMT     AMOUNT COLUMN ?                              
         BZ    POSTTH40            NO                                           
         TM    COLFLAGS,COLCALC                                                 
         BO    POSTTH40                                                         
*        TM    COLOPT2,COLTHRS     TOTAL HOURS COLUMN ?                         
*        BZ    POSTTH40                                                         
         CLC   COLDD#,=AL2(AC#RSMTS)                                            
         BE    POSTTH40            NO                                           
         CLI   COLDATES,COLMDTE    MOA DATE BASED ?                             
         BNE   POSTTH25                                                         
         CLC   THRMOS,COLSTART                                                  
         BL    POSTTH40                                                         
         CLC   THRMOS,COLEND                                                    
         BH    POSTTH40                                                         
         B     POSTTH30                                                         
*                                                                               
POSTTH25 CLC   THRTDTE,COLSTART    TRANSACTION BASED                            
         BL    POSTTH40                                                         
         CLC   THRTDTE,COLEND                                                   
         BH    POSTTH40                                                         
*                                                                               
         USING FLTADRD,R4                                                       
POSTTH30 ICM   R4,15,COLFLTS                                                    
         BZ    POSTTH35                                                         
         XC    DMCB+8(4),DMCB      REGULAR COLUMN FILTER P3=0                   
         CLC   COLDD#,=AL2(AC#RSTHR)                                            
         BE    POSTTH32                                                         
         CLC   COLDD#,=AL2(AC#RSTHC)                                            
         BE    POSTTH32                                                         
         MVC   DMCB+8,=C'DENO'     DENOMINATOR FILTERS (PCT AND PCTCLI)         
*                                                                               
POSTTH32 CLI   FLTFLAG,EOT         END OF FILTERS ?                             
         BE    POSTTH35                                                         
         GOTO1 AFILTER,DMCB,FLTADDR,FLTDATA                                     
         BNE   POSTTH40                                                         
         LA    R4,FLTADRLQ(,R4)    TRY NEXT FILTER                              
         B     POSTTH32                                                         
         DROP  R4                                                               
*                                                                               
POSTTH35 AP    COLTOTHR,THRHRS     ADD UP HOURS                                 
         CLC   CURSUBAC+1(2),=C'1C'                                             
         BNE   *+10                                                             
         AP    COLTOT1C,THRHRS     ADD UP 1C TIME ONLY                          
*                                                                               
POSTTH40 LA    R3,COLLNQ(,R3)      NEXT COLUMN                                  
         BCT   R0,POSTTH20                                                      
*                                                                               
POSTTH80 LA    R5,FMTLNQ(,R5)      NEXT RECORD                                  
         BCT   R7,POSTTH10                                                      
*                                                                               
         L     R5,AFORMATS         RE-LOAD FIRST FORMAT RECORD                  
         XIT1                                                                   
         DROP  R3,R5                                                            
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'PROCESS LOCATION ELEMENTS'                                      
***********************************************************************         
*  PROCESS SAVED TIME SHEETS                                          *         
***********************************************************************         
         SPACE 1                                                                
         USING TSSRECD,R2                                                       
         USING FMTRECD,R5                                                       
SVD2TMS  NMOD1 0,**STMS**                                                       
         L     RC,RLBASEC                                                       
         XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY                                                         
         MVI   TSSKTYP,TSSKTYPQ    X'3E'                                        
         MVI   TSSKSUB,TSSKSUBQ    X'11' TIME SHEET SAVE REC                    
         MVC   TSSKCPY,CURACC      MOVE IN COMPANY CODE                         
         MVC   TSSKPER,SPACES      PERSON CODE                                  
         MVC   TSSKODS,SPACES      OFFC/DEPT/SUB DEPT                           
         SR    RF,RF                                                            
         IC    RF,LEV3LN           LENGTH OF LEVEL 3                            
         LA    RE,CURACC+3(RF)     POINT TO PERSON CODE                         
         BCTR  RF,0                                                             
         EXMVC RF,TSSKODS,CURACC+3 OFFC/DEPT/SUB DEPT                           
         LA    RF,2(,RF)           ADD IT BACK PLUS ONE                         
         LA    R1,12                                                            
         SR    R1,RF               LENGTH LESS ONE OF PERSON CODE               
         EXMVC R1,TSSKPER,0(RE)    PERSON CODE                                  
*                                                                               
         SR    R4,R4                                                            
         L     R6,ATIMSAV          STORE PED DATES IN TABLE                     
         L     R1,=AL4(IOHIGH+IOACFIL+IOBUD)                                    
SVTM10   GOTO1 AIO                                                              
         L     R2,ABUDIO                                                        
         CLI   TSSKTYP,TSSKTYPQ    X'3E'                                        
         BNE   SVTM99                                                           
         CLI   TSSKSUB,TSSKSUBQ    X'11'                                        
         BNE   SVTM99                                                           
         CLC   TSSKPER,IOKEY+(TSSKPER-TSSRECD)                                  
         BNE   SVTM99                                                           
         CLC   TSSKODS,IOKEY+(TSSKODS-TSSRECD)                                  
         BNE   SVTM99                                                           
         LR    R4,R2                                                            
         AH    R4,DATADISP                                                      
*                                                                               
         USING TIMRECD,R3                                                       
         LA    R3,TMSSVKEY                                                      
         MVC   TMSSVKEY,SPACES     BUILD KEY                                    
         MVC   TIMKCULA,CURACC     ACCOUNT                                      
         CLI   NEWOFF,YES                                                       
         BNE   *+10                                                             
         MVC   TIMKOFF,CURACC+3    OFFICE                                       
         MVC   TIMKCCPY,CURACC     CONTRA COMPANY                               
         MVC   TIMKCUNT(2),=C'1C'  DEFAULT TO 1C                                
         SR    RF,RF                                                            
         ICM   RF,7,TSSKEND        GET DATE INTO REGISTER                       
         LNR   RF,RF               UN-2'S COMPLEMENT                            
         STCM  RF,7,TIMKPEDT                                                    
         MVC   TIMKREF,=CL6'*TIME*'                                             
         MVI   TIMKSBR,0                                                        
         MVC   TRANDTE,TIMKPEDT                                                 
*                                                                               
         USING TIMELD,R4                                                        
NEW      USING TIMELD,R8                                                        
SVTM12   DS    0H                                                               
         L     R1,=AL4(IOSEQ+IOACFIL+IOBUD)                                     
         XC    AELMTMS1(AELMTMSQ),AELMTMS1                                      
         MVC   CURBLK1,SPACES                                                   
         XC    CURMMOS,CURMMOS                                                  
         MVI   CURTIME,BLANK                                                    
*                                                                               
         CLI   0(R4),0                                                          
         BE    SVTM10              NEXT RECORD                                  
         CLI   0(R4),TIMELQ        X'8B'                                        
         BNE   SVTM80              NEXT ELEMENT                                 
         CLI   TIMETYP,TIMEFLD     TYPE 4, COMMENTED FIELD                      
         BE    SVTM18              NEXT ELEMENT                                 
         CLI   TIMETYP,TIMEINP     REGULAR INPUT                                
         BE    *+6                                                              
         DC    H'00'                                                            
         ST    R4,AELMTMS1                                                      
*                                                                               
SVTM14   SR    RF,RF               LOOK AHEAD TO NEXT INPUT ELEMENT             
         IC    RF,1(,R4)           NEXT ELEMENT                                 
         AR    R4,RF                                                            
         CLI   0(R4),0             END OF RECORD                                
         BE    SVTM16              PROCESS LAST X'8B' ELEMENT                   
         CLI   0(R4),TIMELQ        IS NEXT ELEMENT AN X'8B'                     
         BNE   SVTM14              NO, SO GET NEXT ELEMENT                      
         CLI   TIMETYP,TIMEFLD     IF NEXT IS AN INPUT OR COMMENT               
         BE    SVTM16              YES, SO PROCESS LAST X'8B'                   
         CLI   TIMETYP,TIMEINP     IF NEXT IS AN INPUT                          
         BE    SVTM16              YES, SO PROCESS LAST X'8B'                   
         CLI   TIMETYP,TIMETAX                                                  
         BNE   *+12                                                             
         ST    R4,AELMTMS2                                                      
         B     SVTM14              NEXT ELEMENT                                 
         CLI   TIMETYP,TIMENAR                                                  
         BNE   SVTM14                                                           
         ST    R4,AELMTMS3                                                      
         B     SVTM14              NEXT ELEMENT                                 
*                                                                               
SVTM16   BAS   RE,TMSSET                                                        
         B     SVTM12              NEXT ELEMENT                                 
*                                                                               
SVTM18   XC    TMSSVELM,TMSSVELM                                                
         XC    TMSSVNAR,TMSSVNAR                                                
         LA    R8,TMSSVELM                                                      
         MVI   NEW.TIMEL,TIMELQ        X'8B'                                    
         MVI   NEW.TIMLN,TIMILN1Q                                               
         MVI   NEW.TIMETYP,TIMEINP      CONVERT TO INPUT TYPE                   
         MVC   NEW.TIMLINE#,TIMFLINE                                            
         MVC   NEW.TIMACC,SPACES                                                
         MVC   NEW.TIMINC,SPACES                                                
         SR    R0,R0                                                            
         ICM   R0,1,TIMFMINI                                                    
         BZ    SVTM80                                                           
         LA    R6,TIMFITEM                                                      
*                                                                               
         USING TIMFITEM,R6                                                      
SVTM20   SR    RF,RF                                                            
         IC    RF,TIMFLEN          INPUT LENGTH                                 
         AHI   RF,-(TIMFIELD-TIMFLEN)                                           
         TM    TIMFNUM,X'01'       RATE                                         
         BO    SVTM25                                                           
         TM    TIMFNUM,X'02'       INCOME                                       
         BO    SVTM42                                                           
         TM    TIMFNUM,X'04'       NARRATIVE                                    
         BO    SVTM34                                                           
         TM    TIMFNUM,X'40'       AMOUNT                                       
         BO    SVTM25                                                           
         TM    TIMFNUM+1,X'01'     TYPE                                         
         BO    SVTM75                                                           
         TM    TIMFNUM+1,X'02'     HOURS                                        
         BO    SVTM25                                                           
         TM    TIMFNUM+1,X'04'     CLIENT                                       
         BO    SVTM50                                                           
         TM    TIMFNUM+1,X'08'     PRODUCT                                      
         BO    SVTM54                                                           
         TM    TIMFNUM+1,X'10'     JOB                                          
         BO    SVTM56                                                           
         TM    TIMFNUM+1,X'20'     WORK CODE (TASK)                             
         BO    SVTM45                                                           
         TM    TIMFNUM+1,X'40'     MOA                                          
         BZ    SVTM75              NOTHING MATCHED                              
*                                                                               
         GOTO1 =V(DATVAL),DMCB,(2,TIMFIELD),TEMPDATE                            
         CLI   DMCB+3,0                                                         
         BE    SVTM75               NOT VALID SO LEAVE                          
         MVC   TEMPDATE+4(2),=C'01'                                             
         GOTO1 DATCON,DMCB,(0,TEMPDATE),(1,WORK)                                
         MVC   NEW.TIMMOA,WORK                                                  
         MVC   SAVEMOS,WORK                                                     
         MVC   MOADTE,WORK          SAVE MOA DATE                               
         B     SVTM75                                                           
*                                                                               
SVTM25   LA    RE,TIMFIELD                                                      
         CLI   0(RE),C'0'          MUST BE A NUMBER > ZERO                      
         BNL   SVTM28                                                           
         LA    RE,1(,RE)                                                        
         BCT   RF,*-12                                                          
         B     SVTM75              NO NUMBERS                                   
*                                                                               
SVTM28   MVI   BYTE,X'82'                                                       
         GOTO1 CASHVAL,DMCB,(BYTE,(RE)),(RF),0                                  
         CLI   0(R1),0                                                          
         BNE   SVTM75                                                           
         TM    TIMFNUM+1,X'02'     HOURS                                        
         BZ    SVTM30                                                           
         ZAP   NEW.TIMHRS,4(8,R1)                                               
         B     SVTM75                                                           
*                                                                               
SVTM30   TM    TIMFNUM,X'40'       AMOUNT                                       
         BZ    *+10                                                             
         ZAP   NEW.TIMAMNT,4(8,R1)                                              
         TM    TIMFNUM,X'01'       RATE                                         
         BZ    *+10                                                             
         ZAP   NEW.TIMRATE,4(8,R1)                                              
         MVI   NEW.TIMLN,TIMILN2Q                                               
         B     SVTM75                                                           
*                                                                               
SVTM34   LA    R8,TMSSVNAR                                                      
         MVI   NEW.TIMEL,TIMELQ        X'8B'                                    
         MVI   NEW.TIMETYP,TIMENAR      CONVERT TO NARR TYPE                    
         BCTR  RF,0                                                             
         EXMVC RF,NEW.TIMNARR,TIMFIELD                                          
         LA    RF,TIMNARR-TIMEL+1(,RF)                                          
         STC   RF,NEW.TIMLN                                                     
         LA    R8,TMSSVELM         RELOAD R8 TO INPUT TYPE                      
         B     SVTM75                                                           
*                                                                               
SVTM42   LA    RE,TIMFIELD                                                      
         BCTR  RF,0                GET EX MOVE LENGTH                           
         CLI   TIMFIELD,C'*'       REMOVE THIS                                  
         BNE   SVTM44                                                           
         BCTR  RF,0                LESS ONE MORE TO REMOVE "*"                  
         LA    RE,TIMFIELD+1                                                    
SVTM44   CHI   RF,11                                                            
         BNH   *+8                                                              
         LA    RF,11                                                            
         EXMVC RF,NEW.TIMINC,0(RE)                                              
         MVI   NEW.TIMLN,TIMILN2Q                                               
         B     SVTM75                                                           
*                                                                               
SVTM45   BCTR  RF,0                                                             
         CHI   RF,1                                                             
         BNH   *+8                                                              
         LA    RF,1                ONLY  MOVE UP TO 2 CHAR                      
         EXMVC RF,NEW.TIMTSK,TIMFIELD    WORKCODE (TASK)                        
         B     SVTM75                                                           
*                                                                               
         USING NONCLID,RE                                                       
SVTM50   CLM   RF,1,SJCLILEN                                                    
         BNH   *+8                                                              
         IC    RF,SJCLILEN                                                      
         MVC   NEW.TIMACC(2),=C'1N'                                             
         MVI   NEW.TIMTTYP,TIMTNC                                               
         L     RE,ANONCLI                                                       
         LH    R1,NONCLI#                                                       
SVTM51   EXCLC RF,NONCCODE,TIMFIELD                                             
         BE    SVTM52                                                           
         LA    RE,NONCLNQ(,RE)           BUMP UP BEFORE BRANCH                  
         BCT   R1,SVTM51                                                        
         MVI   NEW.TIMTTYP,TIMTCB                                               
         MVC   NEW.TIMACC(2),=C'SJ'      NOT A 1N ACCOUNT SO SJ                 
         DROP  RE                                                               
*                                                                               
SVTM52   LH    RE,SJCLIDSP                                                      
         B     SVTM58                                                           
*                                                                               
SVTM54   LH    RE,SJPRDDSP                                                      
         CLM   RF,1,SJCLILEN                                                    
         BNH   SVTM58                                                           
         IC    RF,SJPRDLEN                                                      
         B     SVTM58                                                           
*                                                                               
SVTM56   LH    RE,SJJOBDSP                                                      
         CLM   RF,1,SJCLILEN                                                    
         BNH   SVTM58                                                           
         IC    RF,SJJOBLEN                                                      
*                                                                               
SVTM58   LA    RE,NEW.TIMACC+2(RE)   BUILD POSSIBLE SJ OR 1N                    
         BCTR  RF,0                                                             
         EXMVC RF,0(RE),TIMFIELD                                                
         B     SVTM75                                                           
*                                                                               
SVTM75   SR    RF,RF                                                            
         IC    RF,TIMFLEN                                                       
         AR    R6,RF                                                            
         BCT   R0,SVTM20                                                        
         LA    RE,TMSSVELM                                                      
         ST    RE,AELMTMS1                                                      
         LA    RE,TMSSVNAR                                                      
         CLI   TMSSVNAR,TIMELQ     X'8B'                                        
         BNE   *+8                                                              
         ST    RE,AELMTMS3                                                      
         BAS   RE,TMSSET                                                        
*                                                                               
SVTM80   SR    RF,RF                                                            
         IC    RF,1(,R4)           NEXT ELEMENT                                 
         AR    R4,RF                                                            
         B     SVTM12                                                           
*                                                                               
SVTM99   XMOD1                                                                  
         DROP  R2,R3,R6                                                         
         DROP  NEW                                                              
         EJECT ,                                                                
         USING TIMRECD,R3                                                       
TMSSET   NTR1                                                                   
         LA    R3,TMSSVKEY                                                      
         ST    R3,ATMSKEY          SAVE IT, FOR PARSE TABLES                    
*                                                                               
         USING LOCELD,R4                                                        
         XC    AELEM83,AELEM83                                                  
         MVI   PRSNSTAT,X'FE'      SET TO UNKNOWN STATUS                        
         SR    R1,R1                                                            
         L     R4,APRSNWRK                                                      
         AH    R4,DATADISP                                                      
TMSSET10 CLI   0(R4),0             END OF RECORD                                
         BE    TMSSET20                                                         
         CLI   0(R4),LOCELQ        X'83' LOCATION ELEMENT                       
         BNE   TMSSET14                                                         
         CLC   LOCEND,TIMKPEDT                                                  
         BL    TMSSET14                                                         
         CLC   LOCSTART,TIMKPEDT                                                
         BH    TMSSET14                                                         
         ST    R4,AELEM83          SAVE LOCATION DATE ELEMENT                   
         MVC   PRSNSTAT,LOCSTAT    SET  LOCATION STATUS                         
TMSSET14 IC    R1,LOCLN                                                         
         AR    R4,R1                                                            
         B     TMSSET10                                                         
         DROP  R4                                                               
*                                                                               
         USING TIMELD,R4                                                        
TMSSET20 L     R4,AELMTMS1         POINTS TO CURRENT TYPE 1                     
         MVC   SAVEMOS,TIMMOA                                                   
         MVC   MOADTE(2),TIMMOA    SAVE MOA DATE                                
         MVI   MOADTE+2,01                                                      
         MVC   CUROFF,SPACES                                                    
         GOTO1 PARSE,DMCB,GETOFFC,CUROFF,0,0                                    
         XC    CURSTAT(3),CURSTAT                                               
         OI    CURSTAT,CURSVED     MARK THAT THERE IS A SAVED ITEM              
*                                                                               
         TM    REQIND,REQCMTH                                                   
         BZ    TMSSET35                                                         
         CLC   TIMKPEDT,RTRNSTR    NOW FILTER OUT TRUE REQUEST DATES            
         BL    TMSSET99                                                         
         CLC   TIMKPEDT,RTRNEND                                                 
         BH    TMSSET99                                                         
         OC    TIMMOA,TIMMOA                                                    
         BZ    TMSSET35                                                         
         CLC   TIMMOA,RMOASTR                                                   
         BL    TMSSET99                                                         
         CLC   TIMMOA,RMOAEND                                                   
         BH    TMSSET99                                                         
*                                                                               
TMSSET35 MVC   CURWKCD,SPACES                                                   
         CLI   TIMETYP,TIMEINP     IS IT A TYPE 1?                              
         BE    *+6                 FIRST ONE IN SHOULD BE INPUT TYPE            
         DC    H'00'                                                            
         CLI   TIMTTYP,TIMTCB      B TIME                                       
         BNE   *+8                                                              
         MVI   CURTIME,C'B'                                                     
         CLI   TIMTTYP,TIMTCR      R TIME                                       
         BNE   *+8                                                              
         MVI   CURTIME,C'R'                                                     
         CLI   TIMTTYP,TIMTCN      N TIME (CLIENT NON-BILLABLE)                 
         BE    *+8                                                              
         CLI   TIMTTYP,TIMTNC      N TIME (NON-CLIENT)                          
         BNE   *+8                                                              
         MVI   CURTIME,C'N'                                                     
         CLC   TIMACC(2),=C'SJ'    HAS TO BE SJ ACCOUNT                         
         BNE   TMSSET40                                                         
         MVC   CURSJ(14),TIMACC                                                 
         MVC   CURWKCD,TIMTSK                                                   
*                                                                               
TMSSET40 TM    TIMIND,TIMIADJ       ADJUSTED TIME                               
         BZ    *+8                                                              
         OI    CURSTAT,CURADJT                                                  
         TM    TIMIND,TIMIWO        WRITE-OFF TIME                              
         BZ    *+8                                                              
         OI    CURSTAT,CURWOFF                                                  
         TM    TIMSTAT,TIMTEMPO     TEMPO UPLOAD ITEM                           
         BZ    *+8                                                              
         OI    CURSTAT,CURTMPO                                                  
*&&US                                                                           
         CLC   CUROFF,SPACES                                                    
         BE    TMSSET42                                                         
         GOTO1 AFILTER,DMCB,AFLTOFF,CUROFF                                      
         BNE   TMSSET99                                                         
TMSSET42 CLC   CURSJACC,SPACES                                                  
         BE    TMSSET44                                                         
         GOTO1 AFILTER,DMCB,AFLTCLI1,CURSJ                                      
         BNE   TMSSET99                                                         
TMSSET44 CLC   CURWKCD,SPACES                                                   
         BE    TMSSET80                                                         
         GOTO1 AFILTER,DMCB,AFLTWC,CURWKCD                                      
         BNE   TMSSET99                                                         
*&&                                                                             
         USING RECXD,RE                                                         
TMSSET80 GOTO1 ARECORD,DMCB,(0,ASRTWRK),('POSTCLR',1)                           
         L     RE,ASRTWRK                                                       
         AH    RE,SRTKEYLN                                                      
         SHI   RE,RECXDQ                                                        
         MVI   RECTYPE,RECSTMS         Mark as saved TMS record                 
         NI    RECIND,TURNOFF-RECMRGE  Don't merge these type                   
         DROP  RE                                                               
*                                                                               
         GOTO1 APUTREC,DMCB,ASRTWRK,1                                           
TMSSET99 XIT1                                                                   
         DROP  R3,R4,R5                                                         
         EJECT ,                                                                
TMSSVKEY DS    CL49                                                             
TMSSVELM DS    CL(TIMILN2Q)                                                     
TMSSVTAX DS    CL(TIMTMINQ)                                                     
TMSSVNAR DS    CL(TIMNLNQ+60)                                                   
         SPACE                                                                  
         LTORG                                                                  
         TITLE 'PROCESS LOCATION ELEMENTS'                                      
***********************************************************************         
*  PROCESS LOCATION ELEMENTS, ONE PER RECORD                          *         
***********************************************************************         
         SPACE 1                                                                
         USING LOCELD,R2                                                        
         USING FMTRECD,R5                                                       
POSTLOC  DS    0D                                                               
         NMOD1 0,**LOCT**                                                       
         L     RC,RLBASEC                                                       
         L     R2,APRSNWRK                                                      
         AH    R2,DATADISP         FIND X'83' ELEMENT AND PROCESS EACH          
         MVI   PARSEALL,YES        FORCE DATA NOT TO BE COPIED                  
POSTLC10 CLI   0(R2),0                                                          
         BE    POSTLC90                                                         
         CLI   0(R2),LOCELQ                                                     
         BNE   POSTLC20                                                         
         ST    R2,AELEM83                                                       
         MVC   PRSNSTAT,LOCSTAT    SET LOCATION STATUS                          
         GOTO1 ARECORD,DMCB,('POSTNUL',ABUDWRK),('POSTCLR',1)                   
         GOTO1 APUTREC,DMCB,ABUDWRK,1                                           
*                                                                               
POSTLC20 SR    RF,RF                                                            
         IC    RF,LOCLN                                                         
         AR    R2,RF                                                            
         B     POSTLC10                                                         
*                                                                               
POSTLC90 XMOD1                                                                  
         DROP  R2,R5                                                            
         SPACE 1                                                                
         LTORG                                                                  
         TITLE 'PROCESS BUDGET'                                                 
***********************************************************************         
*  PROCESS BUDGETS FOR ACCOUNT                                  *               
***********************************************************************         
         SPACE 1                                                                
         USING BUDRECD,R2                                                       
         USING BUDD,R4                                                          
         USING FMTRECD,R5                                                       
PROCBUD  DS    0D                                                               
         NMOD1 0,**PBUD**                                                       
         L     RC,RLBASEC                                                       
         L     R4,FMTBDGT          BUDGET TABLE INFO                            
PRBUD10  OC    BUD#,BUD#           END OF BUDGET TABLE?                         
         BZ    PROCBUDX            YES                                          
         ZIC   R6,BUDACCLN                                                      
         BCTR  R6,0                                                             
         EXCLC R6,BUDACCKY,CURACC                                               
         BNE   PRBUD20             New budget key, so process                   
         LA    R4,BUDLNQ(,R4)                                                   
         B     PRBUD10                                                          
*                                                                               
PRBUD20  ST    R4,BUDSAVE          Save starting budget                         
         MVC   BUDACCKY,CURACC                                                  
         TM    PHISIND,PHISON      Process history record data ?                
         BZ    PRBUD30             No need to process                           
         GOTO1 ASETPAY,1           Initialize                                   
         OI    ACTIVITY,ACTPAYR    Processed payroll data                       
                                                                                
PRBUD30  L     R1,=AL4(IOBUD+IOHIGH+IOACFIL)                                    
         LA    R2,IOKEY                                                         
         MVC   BUDKEY,SPACES                                                    
         XC    BUDKBUDN,BUDKBUDN   BUDGET NUMBER TO ZERO                        
         MVI   BUDKTYP,BUDKTYPQ    X'1B'                                        
         EXMVC R6,BUDKCPY,CURACC   MOVE IN PART OF ACCOUNT                      
*                                                                               
PRBUD40  GOTO1 AIO                                                              
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R2,ABUDIO                                                        
         L     R4,BUDSAVE          LOAD FIRST BUDGET TO PROCESS                 
         EXCLC R6,BUDKCPY,CURACC                                                
         BNE   PROCBUDX            NO ACCOUNTS TO PROCESS                       
*                                                                               
PRBUD50  OC    BUD#,BUD#           END OF BUDGET TABLE?                         
         BZ    PRBUD170            READ NEXT SEQUENTIAL                         
         CLC   BUDKBUDN,BUD#       DOES BUDGET # MATCH TABLE BUDGET #           
         BE    *+12                FOUND BUDGET                                 
         LA    R4,BUDLNQ(,R4)                                                   
         B     PRBUD50                                                          
*&&US                                                                           
         TM    BUDIND,BUDBYOF      Is this budget by office?                    
         BZ    PRBUD55             No - continue                                
         CLC   QOFFICE,SPACES      Filtering on office?                         
         BNH   PRBUD55             No - so want all                             
*                                                                               
         USING ACMD,R3                                                          
         L     R3,AMONACC          budget by office only valid for 2            
         SR    R0,R0               char office list files                       
         ICM   R0,3,ACMOFCN        R0=N'entries in office list                  
         JNZ   *+6                                                              
         DC    H'0'                Two character must have at least 1           
         LA    R1,ACMROFL          A(List of requested offices)                 
PRBUD52  CLC   BUDKWORK,0(R1)                                                   
         BE    PRBUD55                                                          
         LA    R1,2(,R1)           Next office                                  
         BRCT  R0,PRBUD52                                                       
         B     PRBUD170            Read next budget                             
         DROP  R3                                                               
*&&                                                                             
PRBUD55  MVC   CURBUD#,BUD#        SAVE OFF BUDGET # PROCESSING                 
         MVC   CURSUBAC,BUDKCCPY   MOVE IN CURRENT CONTRA                       
         CLI   QPROG,MANPOWER      ONLY PERSON SCRIBE                           
         BNE   PRBUD60                                                          
         OI    POSTCTL,POSTPED     SET TO POST PERSON BY PERIOD                 
         TM    BUDIND,BUDBYPED     POST BY PERIOD ?                             
         BO    PRBUD60             YES, COLUMN USES CALENDAR DATES              
         CLI   BUDACCLN,12         BUDGET DOWN TO PERSON ?                      
         BE    PRBUD60                                                          
         NI    POSTCTL,TURNOFF-POSTPED                                          
*                                                                               
PRBUD60  CLI   QOPT6,C'K'                                                       
         BNE   PRBUD70                                                          
         LHI   R0,ACCORFST                                                      
         GOTO1 PRNTBL,DMCB,=C' BUDGET',(R2),C'DUMP',(R0),=C'2D'                 
*                                                                               
PRBUD70  AH    R2,DATADISP                                                      
         CLC   =C'SJ',QUNIT                                                     
         BNE   *+10                                                             
         MVC   CURSJACC,CURACC+3                                                
         CLC   =C'1C',QUNIT        INCOME TYPE 1C W/11,12 CONTRA ONLY           
         BNE   PRBUD80                                                          
         LA    RE,CURACC+3                                                      
         AH    RE,DSP2CLI                                                       
         LH    RF,SJJOBDSP         LENGTH OF CLI+PRD                            
         AHI   RF,-1                                                            
         EXMVC RF,CURSJACC,0(RE)                                                
*                                                                               
         USING ACMD,R3                                                          
PRBUD80  TM    BUDIND,BUDCNTRA     Is it budgeted by contra  ?                  
         BZ    PRBUD130            No, so continue                              
         GOTO1 SETCNTR,DMCB,CURSUBAC+1                                          
         L     R3,AMONACC                                                       
         TM    ACMCFIND,ACMCCFLT   Filter contra filters  ?                     
         BZ    PRBUD90                                                          
         GOTO1 ACMCFLTR,DMCB,CURSUBAC+1,ACMCFLTS,ACWORKD                        
         BNE   PRBUD170                                                         
*                                                                               
PRBUD90  TM    ACMCFIND,ACMCFACT   Filter contra accounts ?                     
         BZ    PRBUD130            No                                           
         L     R9,ACMCFLST                                                      
         LH    RF,ACMCFMAX         NUMBER OR ENTRIES                            
*                                                                               
PRBUD100 SR    R1,R1                                                            
         IC    R1,0(,R9)           GET LENGTH                                   
         BCTR  R1,0                                                             
         EXCLC R1,CURSUBAC+1,1(R9)                                              
         BH    PRBUD110            CHECK NEXT ACCOUNT                           
         BL    PRBUD120            ACCOUNT NOT FOUND IF BL                      
         TM    ACMCFIND,ACMCFXCL   MATCH FOUND,    INCLUDE/EXCLUDE?             
         BZ    PRBUD130            INCLUDE                                      
         B     PRBUD170            EXCLUDE                                      
*                                                                               
PRBUD110 LA    R9,15(,R9)                                                       
         BCT   RF,PRBUD100                                                      
*                                                                               
PRBUD120 TM    ACMCFIND,ACMCFXCL   NO MATCH FOUND, INCLUDE/EXCLUDE?             
         BZ    PRBUD170            EXCLUDE, NEEDED MATCH                        
         DROP  R3                                                               
*                                                                               
         USING BAMELD,R2                                                        
PRBUD130 BAS   RE,POSTBDG                                                       
         TM    POSTCTL,POSTPED     POST BY PERIOD ?                             
         BO    PRBUD170            PROCESSED BUDGETS BY CALENDAR PERIOD         
         TM    BUDSW,BUDELMS       ARE THERE ANY ELEMENT TO PROCESS             
         BZ    PRBUD170            NO                                           
*                                                                               
PRBUD140 TM    POSTCTL,POSTBYDT    POST BY DATE                                 
         BO    PRBUD150                                                         
         GOTO1 ARECORD,DMCB,('POSTBUD',ABUDWRK),('POSTCLR',1)                   
         OI    POSTMODE,POSTBUD                                                 
         GOTO1 APUTREC,DMCB,ABUDWRK,1                                           
         NI    POSTMODE,TURNOFF-POSTBUD                                         
         B     PRBUD170                                                         
*                                                                               
PRBUD150 CLI   0(R2),0             END OF RECORD?                               
         BE    PRBUD170            FINISHED PROCESSING, READ SEQUENTIAL         
         CLI   0(R2),BAMELQ        BUDGET AMOUNTS                               
         BNE   PRBUD160            GET NEXT ELEMENT                             
         ZAP   BUDAMT,BAMBUDG      ADD INTO BUDGET AMOUNT                       
         MVC   WORK,BAMMNTH        SAVE OFF MONTH                               
         MVI   WORK+2,1                                                         
         MVC   TRANDTE,WORK        DUMMY DATE FOR PARSING                       
         MVC   BILLDTE,WORK                                                     
         MVC   CURMMOS,WORK                                                     
         MVC   SAVEMOS,WORK                                                     
         MVC   DUEDTE,WORK                                                      
         MVC   MOADTE,WORK                                                      
         MVC   BMOADTE,WORK                                                     
         GOTO1 ARECORD,DMCB,('POSTBUD',ABUDWRK),('POSTCLR',1)                   
         OI    POSTMODE,POSTBUD                                                 
         GOTO1 APUTREC,DMCB,ABUDWRK,1                                           
         NI    POSTMODE,TURNOFF-POSTBUD                                         
*                                                                               
PRBUD160 ZIC   R1,1(,R2)                                                        
         AR    R2,R1                                                            
         B     PRBUD150                                                         
         DROP  R2                                                               
*                                                                               
PRBUD170 L     R1,=AL4(IOBUD+IOREAD+IOACFIL)                                    
         L     R2,ABUDIO                                                        
         MVC   IOKEY,0(R2)         RESET KEY                                    
         GOTO1 AIO                                                              
         BE    *+6                                                              
         DC    H'00'                                                            
*                                                                               
         NI    POSTCTL,TURNOFF-POSTPED       RESET BY BUDGET                    
         L     R1,=AL4(IOBUD+IOSEQ+IOACFIL)                                     
         B     PRBUD40             READ NEXT BUDGET RECORD                      
*                                                                               
PROCBUDX XMOD1                                                                  
         EJECT ,                                                                
***********************************************************************         
*  1) REMOVE ELEMENTS FROM RECORD THAT ARE OUT OF DATE RANGE          *         
*  2) IN PERSON SCRIBE PROCESS BY CALENDAR PERIODS, USING HIRE/TERM   *         
***********************************************************************         
         SPACE 1                                                                
POSTBDG  NTR1                                                                   
         NI    BUDSW,TURNOFF-BUDELMS-BUDDATA    RESET                           
         OI    BUDSW,BUDONCE                    DO ONCE EACH TIME IN            
         L     R3,ABUDIO                                                        
         AH    R3,DATADISP                                                      
POSTB010 CLI   0(R3),0             EOR                                          
         BE    POSTB800                                                         
         CLI   0(R3),BAMELQ        X'1D' BUDGET AMOUNTS                         
         BE    POSTB020                                                         
POSTB015 SR    RF,RF                                                            
         IC    RF,1(,R3)                                                        
         AR    R3,RF                                                            
         B     POSTB010                                                         
*                                                                               
         USING BAMELD,R3                                                        
POSTB020 CLC   BAMMNTH,BUDSDTE     START BUDGET RANGE                           
         BL    POSTB025                                                         
         CLC   BAMMNTH,BUDEDTE     END   BUDGET RANGE                           
         BH    POSTB025                                                         
         CLI   QPROG,GENERAL                                                    
         BE    POSTB030            Ignore MOA range for GL                      
         CLC   BAMMNTH,RMOASTR     START MOA RANGE                              
         BL    POSTB025                                                         
         CLC   BAMMNTH,RMOAEND     END   MOA RANGE                              
         BNH   POSTB030                                                         
POSTB025 MVI   0(R3),X'FF'         MARK TO IGNORE                               
         B     POSTB015                                                         
*                                                                               
         USING CPRCNDRD,R2                                                      
         USING CDRD,R6                                                          
POSTB030 OI    BUDSW,BUDELMS       ELEMENTS FOUND                               
         TM    POSTCTL,POSTPED     POST BY PERIOD ?                             
         BZ    POSTB015            CHECK NEXT ELEMENT                           
         L     R2,ACNDRBLK                                                      
         MVC   PBWORK(2),BAMMNTH   INITIALIZE YEAR TO READ                      
*        LA    R0,2                DO ONLY TWICE                                
         TM    BUDSW,BUDONCE       FIRST TIME IN ?                              
         BO    POSTB032                                                         
         CLC   BAMMNTH,CPRSMOA     IS IT IN THIS CALENDAR ?                     
         BL    POSTB032            NO                                           
         CLC   BAMMNTH,CPREMOA                                                  
         BNH   POSTB040            DIVIDE BUDGET INTO PERIODS FOR MONTH         
*                                                                               
POSTB032 TM    BUDSW,BUDDATA       DO WE HAVE DATA TO PUT ?                     
         BZ    POSTB033            NO                                           
         GOTO1 ARECORD,DMCB,('POSTBUD',ABUDWRK),('POSTCLR',1)                   
         OI    POSTMODE,POSTBUD                                                 
         GOTO1 APUTREC,DMCB,ABUDWRK,1                                           
         NI    POSTMODE,TURNOFF-POSTBUD                                         
         NI    BUDSW,TURNOFF-BUDDATA                                            
*                                                                               
POSTB033 MVC   CPROF,PRSNOFF       PERSON OFFICE                                
         MVI   CPRACT,CPRLOCD      GET LOCATION DETIAL IN CALENDAR              
         XC    CPRYMD,CPRYMD                                                    
         MVC   CPRYM,PBWORK        INITIALIZE YEAR TO READ                      
         NI    BUDSW,TURNOFF-BUDONCE                                            
         GOTO1 AGETCNDR,DMCB,ACNDRBLK,63                                        
         BE    POSTB036              NO CALENDAR FOUND                          
         TM    CPRERR,CPRNF        Record not found                             
         BO    POSTB015                                                         
*                                                                               
*OSTB034 MVC   PBWORK+1(2),=X'1231'                    LAST DAY OF YEAR         
*        GOTO1 DATCON,DMCB,(X'31',PBWORK),(1,PBWORK),(2,0)    NEXT YEAR         
*        BCT   R0,POSTB032                                                      
*        B     POSTB015            COUNDN'T FIND CALENDAR                       
*                                                                               
POSTB036 CLC   BAMMNTH,CPRSMOA     IS IT IN THIS CALENDAR ?                     
         BL    POSTB015            NO CALENDAR FOR THIS BUDGET MONTH            
         CLC   BAMMNTH,CPREMOA                                                  
         BNH   *+6                                                              
         DC    H'00'                                                            
*                                                                               
POSTB040 L     R6,ACNDRWRK         FIND MOA IN CALENDAR                         
*                                                                               
         SR    R0,R0                                                            
         IC    R0,CPR#PRD          NUMBER OF PERIODS IN CALENDAR                
POSTB041 CLC   BAMMNTH,CDRMOA                                                   
         BE    POSTB042                                                         
         LA    R6,CDRLNQ(,R6)                                                   
         BCT   R0,POSTB041                                                      
         DC    H'00'               SHOULD HAVE BEEN FOUND                       
*                                                                               
POSTB042 SR    R1,R1                                                            
         IC    R1,CDR#ACTV         NUMBER OF DAYS ACTIVE IN PERIOD              
         CLI   BUDACCLN,12         BUDGETED DOWN TO PERSON ?                    
         BE    *+8                 YES                                          
         IC    R1,CDR#DAYS         NO, SO GET # OF DAYS IN PERIOD               
         CVD   R1,DUB                                                           
         ZAP   OP1,DUB                                                          
         MP    OP1,BAMBUDG                                                      
         IC    R1,CDR#MDAY         NUMBER OF DAYS IN MONTH                      
         CVD   R1,DUB                                                           
         DP    OP1,DUB                                                          
         TM    POSTCTL,POSTBYDT                                                 
         BZ    POSTB050                                                         
         ZAP   BUDAMT,OP1(8)       ADD INTO BUDGET AMOUNT                       
         MVC   TRANDTE,CDREDATE    CALENDAR END DATE                            
         MVC   CURMMOS,CDRMOA                                                   
         MVC   SAVEMOS,CDRMOA                                                   
         MVC   MOADTE,CDRMOA                                                    
         GOTO1 ARECORD,DMCB,('POSTBUD',ABUDWRK),('POSTCLR',1)                   
         OI    POSTMODE,POSTBUD                                                 
         GOTO1 APUTREC,DMCB,ABUDWRK,1                                           
         NI    POSTMODE,TURNOFF-POSTBUD                                         
         B     POSTB060            NEXT BUDGET ELEMENT                          
*                                                                               
POSTB050 MVC   SAVEMOS,CDRMOA                                                   
         ZAP   CDRBUD,OP1(8)                                                    
         OI    BUDSW,BUDDATA       SET TO INDICATE WE HAD DATA                  
*                                                                               
POSTB060 LA    R6,CDRLNQ(,R6)                                                   
         CLC   SAVEMOS,CDRMOA                                                   
         BE    POSTB042            PROCESS ANOTHER WITH SAME MOA                
         B     POSTB015            NEXT BUDGET ELEMENT                          
*                                                                               
POSTB800 TM    BUDSW,BUDDATA       DO WE HAVE DATA TO PUT ?                     
         BZ    POSTB900            NO                                           
         GOTO1 ARECORD,DMCB,('POSTBUD',ABUDWRK),('POSTCLR',1)                   
         OI    POSTMODE,POSTBUD                                                 
         GOTO1 APUTREC,DMCB,ABUDWRK,1                                           
         NI    POSTMODE,TURNOFF-POSTBUD                                         
         NI    BUDSW,TURNOFF-BUDDATA                                            
*                                                                               
POSTB900 XIT1                                                                   
         SPACE 1                                                                
PBWORK   DS    CL10                                                             
         DROP  R3,R6                                                            
         SPACE 1                                                                
         LTORG                                                                  
         DROP  R2,R4,R5                                                         
         EJECT                                                                  
***********************************************************************         
*                                                                               
***********************************************************************         
         USING ROWD,R2                                                          
         USING UTABD,R3                                                         
         USING FMTRECD,R5                                                       
REPLACE  NTR1  BASE=*,LABEL=*                                                   
         L     R2,0(,R1)           R2 = Row entry                               
         L     R3,ROWCON           R3 = Start of data block                     
         L     R9,4(,R1)           R9 = Data to potentially replace             
         ST    R9,SVREG                                                         
         SR    R0,R0                                                            
         IC    R0,UTAB#OF          R0 = # of entries                            
         LA    R4,UTABDHDR         R4 = Start of data info                      
         XC    @REPLNME,@REPLNME                                                
*                                                                               
         USING UTABDHDR,R4         Data header                                  
REPL050  SR    R1,R1                                                            
         IC    R1,UTABCC           R1 = Condition code                          
         SR    RF,RF                                                            
         IC    RF,UTABDLEN         RF = Length                                  
         LA    R6,UTABDATA         R6 = data                                    
         L     R9,SVREG                                                         
*                                                                               
REPL070  CLI   0(R6),C'?'          Wild card ?                                  
         BE    REPL080             Ok no mater what                             
         CLC   0(1,R6),0(R9)                                                    
         EX    R1,*+8                                                           
         B     REPL100             Not equal try next                           
         BC    0,REPL080                                                        
*        NOP   0                   For running IDF debugger                     
*                                                                               
REPL080  AHI   R6,1                Next character to match on                   
         AHI   R9,1                                                             
         BCT   RF,REPL070          Did we match everything ?                    
         B     REPL150             Found match, now replace                     
*                                                                               
REPL100  SR    RF,RF                                                            
         IC    RF,UTABTLEN         Length of total entry                        
         AR    R4,RF               Next entry                                   
         BCT   R0,REPL050                                                       
         B     REPLXIT             No match, leave data as is                   
         DROP  R4                                                               
*                                                                               
REPL150  L     R9,SVREG            Re-load data to replace                      
         L     R0,GENAREA2         Clear GENAREA2 to spaces                     
         LA    R1,GESIZEQ                                                       
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         ICM   RF,8,SPACES                                                      
         MVCL  R0,RE                                                            
         L     R8,GENAREA2         Area to build new string                     
*                                                                               
         USING UTABDLEN,R6                                                      
REPL160  CLI   0(R6),EOT           End of entries                               
         BE    REPL300             Finished no more to replace                  
         MVC   BYTE,UTABDLEN       Length and/or indication of keyword          
         NI    BYTE,TURNOFF-UTABDKYW  Length less x'80' bit                     
         SR    R4,R4                                                            
         IC    R4,BYTE             Length of data entry                         
         TM    UTABDLEN,UTABDKYW   Parse data (Keyword)                         
         BZ    REPL200             No, straight data                            
         ICM   R7,15,UTAB@PAR      Get parse address                            
         BZ    REPL170             None supplied                                
         DROP  R6                                                               
*                                                                               
         XC    WORK,WORK                                                        
         GOTO1 PARSE,DMCB,(R7),WORK,0,0                                         
         BNE   REPL170             No data retrieved                            
         BCTR  R4,0                                                             
         EXMVC R4,0(R8),WORK       Building new replacement data                
*                                                                               
REPL170  AHI   R6,UTABKYWQ         Next entry for replacement                   
         LA    R8,1(R4,R8)         Next location to append to                   
         B     REPL160             Is there more ?                              
*                                                                               
REPL200  AHI   R6,1                Point at data                                
         MVC   0(1,R8),0(R9)       Default to original character                
         CLI   0(R6),C'?'          Skip this byte                               
         BE    *+10                                                             
         MVC   0(1,R8),0(R6)       Move in new character                        
*                                                                               
REPL220  AHI   R8,1                                                             
         AHI   R9,1                                                             
         BCT   R4,REPL200                                                       
                                                                                
         AHI   R6,1                Point to next entry                          
         LA    R4,UTABDHDR                                                      
         USING UTABDHDR,R4                                                      
         TM    UTABDIND,UTABINME   Replacement name                             
         BZ    REPL160                                                          
         ST    R6,@REPLNME                                                      
                                                                                
         USING UTABDLEN,R6                                                      
         SR    RF,RF                                                            
         IC    RF,UTABDLEN                                                      
         LA    R6,1(RF,R6)         Next entry                                   
         B     REPL160             Is there more ?                              
         DROP  R4,R6                                                            
*                                                                               
REPL300  SR    R4,R4                                                            
         ICM   R4,3,ROWKYSZ                                                     
         BZ    REPLXIT                                                          
         L     R0,SVREG                                                         
         LA    R1,GESIZEQ                                                       
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         ICM   RF,8,SPACES                                                      
         MVCL  R0,RE                                                            
*                                                                               
         L     R0,SVREG            Copy GENAREA2 to XLCHOP                      
         L     RE,GENAREA2                                                      
         LA    R1,1(,R4)                                                        
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
*                                                                               
REPLXIT  XIT1                                                                   
         DROP  R2,R3,R5                                                         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
         TITLE 'DEBUG ROUTINE TO SEE WHAT IS GOING ON'                          
***********************************************************************         
*        DUMP OUT RECORDS AND THE CORRESPONDING MODE                  *         
*        P1   =   AL1(Length of over-ride comment)                    *         
*                 AL3(Address of comment)                             *         
*        P2   =   A(Address of record / emulated record)              *         
***********************************************************************         
         SPACE 1                                                                
DEBUGER  NMOD1 0,**DBUG**                                                       
         L     RC,RLBASEC                                                       
         SR    R3,R3                                                            
         IC    R3,0(,R1)           LENGTH OF COMMENT                            
         L     R2,0(,R1)                                                        
         L     R5,4(,R1)                                                        
         MVC   COMMODE,SPACES                                                   
         MVC   COMDESC,SPACES                                                   
         AHI   R3,-1                                                            
         BNP   DEBUG10                                                          
         EXMVC R3,COMDESC,0(R2)                                                 
*                                                                               
DEBUG10  MVC   COMMODE,=CL15'UNKNOWN'                                           
         SR    RF,RF                                                            
         IC    RF,MODE             GET MONACC MODE #                            
         CVD   RF,DEBDUB                                                        
         OI    DEBDUB+7,X'0F'                                                   
         UNPK  COMMODE+9(2),DEBDUB                                              
         TM    POSTMODE,POSTBKT                                                 
         BZ    *+10                                                             
         MVC   COMMODE,=CL15'BUCKET'                                            
*                                                                               
         TM    POSTMODE,POSTJBR    POST ESTIMATE/JOBBER AMOUNTS                 
         BZ    *+10                                                             
         MVC   COMMODE,=CL15'JOBBER/EST'                                        
*                                                                               
         TM    POSTMODE,POSTTRN                                                 
         BZ    *+10                                                             
         MVC   COMMODE,=CL15'TRANSACT'                                          
*                                                                               
         CLI   MODE,PROCTIME                                                    
         BNE   *+10                                                             
         MVC   COMMODE,=CL15'TMS'                                               
*                                                                               
         TM    POSTMODE,POSTBUD                                                 
         BZ    *+10                                                             
         MVC   COMMODE,=CL15'BUDGET'                                            
*                                                                               
         LH    R0,SRTRECLN                                                      
         GOTO1 PRNTBL,DMCB,(60,COMMENT),(R5),C'DUMP',(R0),=C'2D'                
         XMOD1                                                                  
         SPACE 1                                                                
         DS    0D                                                               
DEBDUB   DS    PL8                                                              
COMMENT  DS    0CL65                                                            
         DC    CL6' MODE='                                                      
COMMODE  DC    CL15' '                                                          
COMDESC  DC    CL44' '                                                          
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'Put vertical percent records to BUFFALO'                        
         USING FMTRECD,R5                                                       
         USING BUFFALOD,R8                                                      
VERTICAL DS    0D                                                               
         NMOD1 0,**VRT%**                                                       
         L     RC,RLBASEC                                                       
         L     R8,ABUFF            Buffalo area                                 
         L     R2,0(,R1)           Action                                       
         CLC   =C'PUT',0(R2)                                                    
         BNE   VERT50                                                           
         L     R9,4(,R1)           A(Record to put)                             
         L     R2,ABUFWRK          Move key to buffwrk A(DESTINATION)           
         SR    R3,R3                                                            
         LH    R3,BFLKEYLN                                                      
         LR    RE,R9               A(SOURCE)                                    
         LR    RF,R3               Length of key                                
         MVCL  R2,RE               R2 will point to end of key                  
                                                                                
         USING RECXD,R2                                                         
         SHI   R2,RECXDQ           Special record type info                     
         LR    RE,R9               A(SOURCE)                                    
         AH    RE,SRTKEYXT                                                      
         MVC   RECXD(RECXDQ),0(RE)  Move in xtra details                        
         MVI   RECTYPE,RECVPCT      Vertical %                                  
         DROP  R2                                                               
*                                                                               
         L     R2,ABUFWRK          Move accums to end of key                    
         MVI   0(R2),RECVPCT       Mark as vert% record for BUFFALO             
         AH    R2,BFLKEYLN         Point to end of key                          
         IC    R3,FMT#ACMS         Number of accumulators                       
         MHI   R3,PKLEN            Length of accums                             
         LR    RE,R9               A(SOURCE)                                    
         AH    RE,SRTDATLN         Point to accums in source                    
         LR    RF,R3               Length of accums                             
         MVCL  R2,RE                                                            
         ZAP   0(PKLEN,R2),PKONE   R2 points to end of accums                   
*                                                                               
         USING COLD,R3                                                          
         L     R3,FMTCOL           Perpare for any rates                        
         ZIC   RF,FMT#COLS                                                      
VERT10   TM    COLIND2,COLRATE     Is it a rate type column ?                   
         BZ    VERT12                                                           
         LA    R2,PKLEN(,R2)       Point to new end                             
         ZAP   0(PKLEN,R2),PKZERO  Clear rate area                              
VERT12   LA    R3,COLLNQ(,R3)      Next column                                  
         BCT   RF,VERT10                                                        
*                                                                               
         USING ROWD,R3                                                          
         USING RECXD,RF                                                         
         ZIC   R2,FMT#ROWS         Number of rows to check                      
         L     R3,FMTLROW          Point to last row                            
VERT20   TM    ROWKYIND,ROWKYVRT   Vertical percent row ?                       
         BZ    VERT32              No                                           
         SR    RE,RE               Start of sort key length at 0                
         ICM   RE,3,ROWKYSZ        Row size                                     
         AH    RE,ROWKYDSP         Plus displacement to row                     
         L     RF,ABUFWRK                                                       
         AR    RE,RF               RE = Location to clear from                  
         AH    RF,BFLKEYLN         Length of buffalo key                        
         SHI   RF,RECXDQ           Less extra data of key                       
         MVC   RECLVL,ROWNUM       Stick in row level                           
         SR    RF,RE               RF = Length to clear                         
         BNM   *+6                                                              
         DC    H'00'               Something is wrong, negative length          
         DROP  RF                                                               
                                                                                
         XCEFL                                                                  
*                                                                               
         TM    UPSI,UPSISRTI       Dump out some records ?                      
         BZ    VERT30              No                                           
         L     R0,BUFFLALL                                                      
         GOTO1 PRNTBL,DMCB,=C'VERT',ABUFWRK,C'DUMP',(R0),=C'2D'                 
*                                                                               
VERT30   GOTO1 BUFFALO,DMCB,=C'PUT',ABUFF,ABUFWRK                               
*                                                                               
VERT32   CLC   ROWNUM,FMTRNK#1+1                                                
         BNE   VERT35                                                           
         L     R9,ABUFWRK          Begining of key                              
         AH    R9,FMTRNKBY                                                      
         XC    1(PKLEN+1,R9),1(R9)                                              
*                                                                               
VERT35   SHI   R3,ROWLNQ           Bump back one row                            
         BCT   R2,VERT20                                                        
         B     VERT99                                                           
         EJECT ,                                                                
*=====================================================================*         
*  FLUSH VERTICAL PERCENT INTO SORTER                                 *         
*=====================================================================*         
                                                                                
VERT50   CLC   =C'FLUSH',0(R2)                                                  
         BE    *+6                                                              
         DC    H'00'                                                            
*                                                                               
         L     RE,ASRTWRK                                                       
         LH    RF,SRTRECLN                                                      
         XCEFL                                                                  
*                                                                               
         L     RE,ABUFWRK                                                       
         LH    RF,SRTRECLN                                                      
         XCEFL                                                                  
*                                                                               
         L     R4,ABUFWRK          Get first vertial %                          
         MVI   0(R4),RECVPCT       Vertical %                                   
         LA    R1,=C'HIGH'                                                      
         ST    R1,DMCB                                                          
*                                                                               
VERT55   GOTO1 BUFFALO,DMCB,,ABUFF,ABUFWRK,1                                    
         TM    DMCB+8,X'80'        EOF ?                                        
         BO    VERT99              Yes                                          
         CLI   0(R4),RECVPCT       Is this a vertical % ?                       
         BNE   VERT99              No, so exit                                  
         L     R2,ASRTWRK          Yes so re-build, A(Source)                   
         SR    R3,R3                                                            
         LH    R3,BFLKEYLN                                                      
         SHI   R3,RECXDQ                                                        
         LR    RE,R4               RE = Buffalo record                          
         LR    RF,R3               Length of key                                
         MVCL  R2,RE                                                            
*                                                                               
         L     R2,ASRTWRK          Point to A(Sort work)                        
         MVI   0(R2),0             Wipe out vertical % type at begining         
                                                                                
         USING RECXD,R2                                                         
         AH    R2,SRTKEYXT         Point to extra data area                     
         LR    RE,R4               Get to buffalo extra data area               
         AH    RE,BFLKEYLN                                                      
         SHI   RE,RECXDQ                                                        
         MVC   RECXD(RECXDQ),0(RE)      Move in extra data                      
         NI    RECIND,TURNOFF-RECMRGE   This is on becasue of PROCACC           
         DROP  R2                                                               
*                                                                               
         L     R2,ASRTWRK          Point to A(Sort work)                        
         AH    R2,SRTDATLN         Point to where to move accumns in            
         SR    R3,R3                                                            
         IC    R3,FMT#ACMS         Number of accums                             
         MHI   R3,PKLEN            Length of accumulators                       
         LR    RE,R4               A(Buffalo record)                            
         AH    RE,BFLKEYLN         Point to accums in buffalo rec               
         LR    RF,R3               Length of accumulators                       
         MVCL  R2,RE               Append                                       
*                                                                               
         L     R9,ASRTWRK          Point to sort work                           
         TM    TSARSW,TSARON       Are we using TSAR at all ?                   
         BZ    VERT75              No                                           
         TM    SORTSW,SORTDATA     Did we put any data to sorter yet ?          
         BO    VERT75                      Yes, so keep using sorter            
         GOTO1 ATSAR,DMCB,=C'PUT',(R9)     No,  add to tsar                     
         B     VERT80                                                           
*                                                                               
VERT75   GOTO1 ADSORTER,DMCB,=C'PUT',(R9)  Add to sorter                        
*                                                                               
VERT80   LA    R1,=C'SEQ'                                                       
         ST    R1,DMCB                                                          
         L     R4,ABUFWRK                                                       
         B     VERT55                                                           
*                                                                               
VERT99   XMOD1                                                                  
         DROP  R3,R5,R8                                                         
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'Get purchase order record details'                              
***********************************************************************         
*  Get PO details                                                               
*        P1 = A(PO#)                                                            
*        P2 = A(PO Workcode)                                                    
*  Return                                                                       
*        Set CURPODET area - See DSECT POD                                      
*        Set CURPOWC  area - See DSECT POWCD                                    
***********************************************************************         
         USING POD,CURPODET                                                     
GETPODT  DS    0D                                                               
         NMOD1 0,**POD***                                                       
         L     RC,RLBASEC                                                       
         L     RE,0(,R1)                                                        
         MVC   TEMPPO,0(RE)        Save of PO                                   
         L     RE,4(,R1)                                                        
         MVC   TEMPPOWC,0(RE)      Save of PO workcode                          
                                                                                
*        CLC   SAVEMOS,RMOAEND     Only use those from requested MOA            
*        BH    GETPOXMD            Higher, leave                                
                                                                                
         CLC   PO#,TEMPPO          Do we already have this PO ?                 
         BE    GETPO200            Yes, get work code values                    
         XC    CURPODET,CURPODET                                                
         MVC   PO#,TEMPPO                                                       
         MVC   POAUTH,SPACES                                                    
         MVC   POVNDR,SPACES                                                    
         OI    POSTATUS,PONONE     Set to none found                            
         LA    RF,POLNQ            Length of record                             
         SR    R5,R5                                                            
         ICM   R5,3,#OFPO          Number of PO's in table                      
         BNZ   GETPO004                                                         
         MVC   @POBYWC,APOBYWC     Initialize                                   
                                                                                
BIN      USING POD,R6                                                           
                                                                                
GETPO004 SAM31                     31 bit mode                                  
         GOTO1 BIN31,DMCB,POD,APODATA,(R5),(1,(RF)),A(L'PO#),MAXPO#             
         ICM   R6,15,0(R1)                                                      
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
*                                                                               
         MVC   #OFPO,10(R1)        Save of number of records                    
         TM    0(R1),X'80'         Record not found ?                           
         BO    *+12                                                             
*        OI    BIN.POPROC,POAPPX+POAPPDX+POPOPX+POPOPDX+POSUBX                  
         OI    BIN.POPROC,POAPPX+POAPPDX+POPOPX+POPOPDX                         
         B     GETPO100            Record found                                 
         SAM24                     Return to 24 bit mode                        
                                                                                
         USING ORDRECD,R2                                                       
         LA    R2,IOKEY                                                         
         XC    ORDKEY,ORDKEY                                                    
         MVI   ORDKTYP,ORDKTYPQ    X'1A' PURCHASE ORDER RECORD                  
         MVC   ORDKCPY,RCCOMPFL                                                 
         MVC   ORDKORD,PO#         Order number                                 
         L     R1,=AL4(IOHIGH+IOACDIR+IOAREA2)                                  
         GOTO1 AIO                                                              
         BNE   GETPO200            Not found                                    
GETPO012 L     R1,=AL4(IOGETREC+IOACMST+IOAREA2)                                
         GOTO1 AIO                                                              
*                                                                               
         NI    POSTATUS,TURNOFF-PONONE                                          
         MVC   PO@,@POBYWC                                                      
         SR    R1,R1                                                            
         L     R2,AIO2                                                          
         CLI   ORDKSEQ,X'00'       Only do this for the main record             
         BNE   GETPO014                                                         
         TM    ORDRSTAT,ORDSFMCH   Fully matched ?                              
         BZ    *+8                                                              
         OI    POSTATUS,POFULL     Yes                                          
         MVC   POSTAT,ORDRSTAT                                                  
         MVC   POSTAT2,ORDRSTA2    Current status of order                      
GETPO014 LA    R2,ORDRFST                                                       
         SAM31                     31 bit mode                                  
*                                                                               
GETPO020 CLI   0(R2),EOR           End of record                                
         BE    GETPO080                                                         
         CLI   0(R2),TRSELQ        X'60' Transaction status element             
         BE    GETPO024                                                         
         CLI   0(R2),ORDELQ        X'67' Order details                          
         BE    GETPO030                                                         
         CLI   0(R2),OAMELQ        X'68' Order amounts by workcode              
         BE    GETPO060                                                         
         CLI   0(R2),EXOELQ        X'97' Expense order Analysis                 
         BE    GETPO070                                                         
*                                                                               
GETPO022 ZIC   R1,1(,R2)                                                        
         AR    R2,R1                                                            
         B     GETPO020                                                         
*                                                                               
         USING TRSELD,R2                                                        
GETPO024 GOTO1 DATCON,DMCB,(2,TRSDATE),(1,POPPRD)  PO preparer date             
         B     GETPO022            Next element                                 
*                                                                               
         USING ORDELD,R2                                                        
GETPO030 LA    RE,CURSJ                                                         
         CLI   QPROG,PRODUCTION                                                 
         BE    *+8                                                              
         LA    RE,CURACC+1                                                      
         CLC   ORDACCU,0(RE)       Right PO ?                                   
         BNE   GETPO080            Try next record                              
         MVC   PODATE,ORDDATE      Date                                         
*&&US*&& MVC   PODUE,ORDDDTE       Due date                                     
*&&US*&& MVC   POVNDR,ORDSUPU      Supplier unit/ledger account                 
*&&UK*&& MVC   POVNDR(L'ORDSUPA),ORDSUPA    Supplier account only               
         TM    ORDSTAT,ORDSEBUY    Order from BrandOcean?                       
         BZ    GPO3020             skip POAUTH and get info from audit          
         OI    POSTATUS,POBRO      record                                       
*&&US*&& MVC   POAUTH,ORDAUTH      Authorization                                
         MVC   POPPR,ORDCPID       PO preparer pid                              
*&&DO                                                                           
         CLI   ORDLN,ORDLN4Q                                                    
         BL    *+10                                                             
         MVC   POSPID,ORDCSUBM     PO submitter pid                             
*&&                                                                             
*        MVC   POPPRD,ORDAMDT      PO preparer date                             
*        MVC   POPPRD,ORDDATE      PO preparer date                             
         TM    RECREAD3,RECPOAP    Reporting PO approver info?                  
         BZ    GPO3025             No then don't bother with this               
         TM    POSTAT2,POPAPP      Is it partially approved or fully            
         BO    GETPO32             approved? Then read the audit rec            
         TM    POSTAT2,POAPPR      to store the approver pid and dates          
         BO    GETPO32             read it for goods received too which         
         TM    POSTAT,ORDGDRCV     is considered approved                       
         BZ    GPO3025                                                          
GETPO32  BRAS  RE,ORDAPPR          establish sequence                           
         TM    POSTATUS,POBROAP    Do we want this PO based on PO               
         BZ    GETPOXIT            approver filter dates?                       
*        BRAS  RE,CHKPOA           Check if want this BrandOcean PO             
*        BNE   GETPOXIT                                                         
         B     GPO3025                                                          
GPO3020  TM    DATEFLT2,DATEPOAD   If filtering on po approver date             
         BO    GETPOXIT            do not show non-BrandO PO's                  
         MVC   POAUTH,ORDAUTH      Authorization                                
GPO3025  DS    0H                                                               
*&&UK                                                                           
         CLI   ORDLN,ORDLN2Q                                                    
         BL    GETPO040                                                         
         MVC   POACKST,ORDGSTAT    Acknowledgement status                       
*&&                                                                             
*&&US*&& CLI   ORDLN,ORDLN2Q                                                    
*&&UK*&& CLI   ORDLN,ORDLN3Q                                                    
         BL    GETPO040                                                         
*        OI    POSTATUS,POFULL                                                  
         TM    DATEFLT2,DATETRM    Alt type E-for prod means po due dte         
         BZ    GETPO032                                                         
         CLC   PODUE,SPACES        If no due date skip to next                  
         BNH   GETPOXIT                                                         
         CLC   ALTNEND,PODUE       Alternate end date                           
         BL    GETPOXIT                                                         
         CLC   ALTNSTR,PODUE       Alternate start date                         
         BH    GETPOXIT                                                         
*                                                                               
GETPO032 TM    ORDSTAT,ORDSPRES                                                 
         BZ    *+8                                                              
         OI    POSTATUS,POPRESTO                                                
         TM    ORDSTAT,ORDSPART                                                 
         BZ    GETPO040                                                         
         NI    POSTATUS,TURNOFF-POFULL                                          
         OI    POSTATUS,POPART                                                  
                                                                                
GETPO040 MVC   BIN.POD(POLNQ),POD  Save off PO to bin table                     
         B     GETPO022            Next element                                 
         DROP  R2                  ORDELD                                       
                                                                                
         USING POWCD,R4            Highcore area                                
         USING OAMELD,R2                                                        
GETPO060 L     R4,@POBYWC          Location to put workcode details             
         MVC   POWC,OAMWORK        Move in workcode                             
         MVI   POWCUSE,X'00'                                                    
         ZAP   POAMNT,OAMAMNT      Amount                                       
         ZAP   POPAID,OAMIVAL      Invoice amount                               
         ZAP   PONOW$,PKZERO                                                    
         TM    POSTATUS,POFULL     Fully matched                                
         BO    GETPO062                                                         
         ZAP   PONOW$,POAMNT       What is remaining                            
         SP    PONOW$,POPAID                                                    
                                                                                
GETPO062 SR    RF,RF                                                            
         IC    RF,PO#WC                                                         
         AHI   RF,1                                                             
         STC   RF,PO#WC            Number of workcode for PO                    
         MVC   BIN.PO#WC,PO#WC                                                  
         AHI   R4,POWCLNQ                                                       
         ST    R4,@POBYWC                                                       
         B     GETPO022            Next element                                 
         DROP  R2,R4               OMAELD, POWCD                                
                                                                                
         USING EXOELD,R2                                                        
GETPO070 MVC   POCROF,EXOCOF       Credit office                                
         B     GETPO022            Next element                                 
         DROP  R2                  EXOELD                                       
                                                                                
         USING ORDRECD,R2                                                       
GETPO080 SAM24                     Return to 24 bit mode                        
         L     R1,=AL4(IOSEQ+IOACDIR+IOAREA2)                                   
         GOTO1 AIO                                                              
         L     R2,AIO2                                                          
         CLC   IOKEY(ORDKSEQ-ORDKEY),0(R2)                                      
         BE    GETPO012                                                         
         SAM31                     31 bit mode                                  
                                                                                
GETPO100 MVC   CURPODET,BIN.POD    Set PO data                                  
         DROP  BIN                 approver info                                
                                                                                
         USING POWCD,R4            Highcore area                                
GETPO200 SAM31                                                                  
         ICM   R4,15,PO@           A(Start of PO workcodes)                     
         SR    RF,RF                                                            
         ICM   RF,1,PO#WC          Number of PO workcodes                       
         BZ    GETPO220            None if zero, clear values                   
                                                                                
GETPO210 CLC   POWC,TEMPPOWC       Match on workcode                            
         BE    GETPO240            Found                                        
         AHI   R4,POWCLNQ          Try next                                     
         BCT   RF,GETPO210                                                      
                                                                                
CUR      USING POWCD,CURPOWC                                                    
                                                                                
GETPO220 MVC   CUR.POWC,TEMPPOWC  Save workcode                                 
         ZAP   CUR.POAMNT,PKZERO                                                
         ZAP   CUR.POPAID,PKZERO                                                
         ZAP   CUR.PONOW$,PKZERO                                                
         B     GETPOXIT                                                         
                                                                                
GETPO240 CLI   POWCUSE,C'Y'                                                     
         BE    GETPO220                                                         
         MVC   CUR.POWCD(POWCLNQ),POWCD                                         
         MVI   POWCUSE,C'Y'                                                     
         TM    POSTATUS,POPRESTO                                                
         BZ    *+8                                                              
         OI    POIND,POIPRSTO                                                   
         TM    POSTATUS,POBRO                                                   
         BZ    *+8                                                              
         OI    POIND,POEBUYER      From Ebuyer (BrandOcean)                     
                                                                                
         OI    POIND,POIPART       Partly matched                               
         TM    POSTATUS,POFULL                                                  
         BZ    GETPOXIT                                                         
         OI    POIND,POIFULL       Fully matched                                
         NI    POIND,TURNOFF-POIPART                                            
         DROP  CUR                                                              
         DROP  R4                                                               
*                                                                               
GETPOXIT SAM24                     Set to 24 bit mode                           
GETPOXMD XMOD1 1                                                                
         SPACE 1                                                                
TEMPPO   DS    CL(L'PO#)                                                        
TEMPPOWC DS    CL2                                                              
         LTORG                                                                  
***********************************************************************         
* READ PURCHASE ORDER AUDIT RECORD FOR APPROVER INFORMATION                     
***********************************************************************         
         USING POD,CURPODET                                                     
         USING AUDRECD,R2                                                       
ORDAPPR  NTR1  BASE=*,LABEL=*                                                   
         LA    R2,IOKEY                                                         
         XC    AUDKEY,AUDKEY                                                    
         MVI   AUDKTYP,AUDKTYPQ                                                 
         MVI   AUDKSUB,AUDKSUBQ                                                 
         MVC   AUDKCPY,RCCOMPFL                                                 
         MVI   AUDKAUDT,AUDKORD                                                 
         MVC   AUDKORDN,PO#                                                     
         L     R4,ABUDIO                                                        
         L     R1,=AL4(IOBUD+IOHIGH+IOACFIL)                                    
         GOTO1 AIO                                                              
         J     OAPP10                                                           
*                                                                               
OAPPNX   L     R4,ABUDIO                                                        
         L     R1,=AL4(IOBUD+IOSEQ+IOACFIL)                                     
         GOTO1 AIO                                                              
OAPP10   CLC   IOKEY(AUDKSEQ-AUDRECD),0(R4)                                     
         JNE   ORDAPPX                                                          
*                                                                               
         LA    RF,POAUDI           Area to store approvers                      
         USING POAUDI,RF                                                        
         AH    R4,DATADISP                                                      
         USING STCELD,R4                                                        
         SR    RE,RE                                                            
         LA    RE,POAPPMX          Max number of approvers                      
OAPP20   CLI   0(R4),EOR           END OF RECORD                                
         JE    OAPPNX              Read next                                    
         CLI   0(R4),STCELQ        X'1B' Status change element                  
         JNE   OAPP22                                                           
         CLI   STCIND,STCISTA      Order status                                 
         JE    OAPP30                                                           
         CLI   STCIND,STCIORD2     Order status - new style                     
         JE    OAPP40                                                           
OAPP22   ZIC   R1,STCLN                                                         
         AR    R4,R1                                                            
         J     OAPP20                                                           
*                                                                               
         USING COLD,R3                                                          
OAPP30   CLI   STCDFR,STCODATA     Don't process the data changes               
         JE    OAPP22                                                           
         CLI   STCDFR,STCOOPEN     Don't process the open status                
         JE    OAPP22                                                           
         CLI   STCDTO,STCOPAPP     Part approved?                               
         JNE   *+16                No                                           
         CLI   STCDFR,STCOFAPP     YES MAKE SURE IT WASN'T FULLY                
         JE    OAPP22              approved before this                         
         J     OAPP32                                                           
         CLI   STCDTO,STCOFAPP     Fully approved?                              
         JNE   OAPP22              no read next                                 
*                                                                               
OAPP32   TM    DATEFLT2,DATEPOAD   Purchase order approver date filter          
         JZ    OAPP34                                                           
         CLI   STCDTO,STCOPAPP     If part approved or fully approved           
         JE    *+12                compare with filter dates first              
         CLI   STCDTO,STCOFAPP                                                  
         JNE   OAPP34                                                           
         CLC   ALTNEND,STCDATE     ALTERNATE END DATE                           
         JL    OAPP22              read next                                    
         CLC   ALTNSTR,STCDATE     ALTERNATE START DATE                         
         JH    OAPP22                                                           
OAPP34   MVC   POBPID,STCPERS      Approver                                     
         MVC   POBDATE,STCDATE     Approver date                                
*        MVC   POSPID,STCPERS                                                   
         J     OAPP50                                                           
*                                  New-style STCEL:                             
OAPP40   MVC   BYTE,STCOTYP                                                     
         NI    BYTE,X'0F'          turn off high nib (Added via bits)           
         CLI   BYTE,STCOAPPQ       If APPROVED - skip other checks              
         JE    OAPP42                                                           
         CLI   BYTE,STCOMATQ       Don't process Order Matching                 
         JE    OAPP22                                                           
         CLI   BYTE,STCOXDCQ       Don't process Order Extra Data Chng          
         JE    OAPP22                                                           
         CLI   BYTE,STCOXDAQ       Don't process Order Extra Data Add           
         JE    OAPP40A             but get POAUTH from STCOXDCH                 
         CLI   BYTE,STCOWCCQ       Don't process Order Change/Add WC            
         JE    OAPP22                                                           
         J     OAPP40X                                                          
*                                                                               
OAPP40A  XR    R5,R5                                                            
         IC    R5,STCLN                                                         
         SHI   R5,(STCOXDCH-STCEL)                                              
         CHI   R5,L'POAUTH                                                      
         BNH   *+8                                                              
         LHI   R5,L'POAUTH                                                      
         BCTR  R5,0                                                             
         EXMVC R5,POAUTH,STCOXDCH                                               
         J     OAPP22              <SPEC-6974> POA not working as expec         
*                                                                               
OAPP40X  CLI   STCLN,STCOLN2Q      Do we have a big enough element?             
         JL    OAPP42                                                           
*&&DO                                                                           
         JNL   OAPP41                                                           
         CLI   STCDTO,0            To status?                                   
         JE    OAPP22              no, read next                                
         J     OAPP42                                                           
*&&                                                                             
OAPP41   CLI   STCOTOST,STCOPAPR   Part approved?                               
         JNE   *+16                No                                           
         CLI   STCOFRST,STCOAPPD   Yes make sure it wasn't fully                
         JE    OAPP22              approved before this                         
         J     OAPP42                                                           
         CLI   STCOTOST,STCOAPPD   Fully approved?                              
         JNE   OAPP22              no read next                                 
         CLI   STCOFRST,STCOCOMP   Unless it comes from COMPLETED               
         JE    OAPP22                                                           
         CLI   STCOFRST,STCOAPPD   Or comes from APPROVED                       
         JE    OAPP22                                                           
*                                                                               
OAPP42   TM    DATEFLT2,DATEPOAD   Purchase order approver date filter          
         JZ    OAPP44                                                           
         CLI   STCOTOST,STCOPAPR   If part approved or fully approved           
         JE    *+12                compare with filter dates first              
         CLI   STCOTOST,STCOAPPD                                                
         JNE   OAPP44                                                           
         CLC   ALTNEND,STCODTE     ALTERNATE END DATE                           
         JL    OAPP22                                                           
         CLC   ALTNSTR,STCODTE     ALTERNATE START DATE                         
         JH    OAPP22                                                           
*                                                                               
OAPP44   MVC   POBPID,STCOPID                                                   
         MVC   POBDATE,STCODTE                                                  
*        MVC   POSPID,STCOPID                                                   
*                                                                               
OAPP50   OI    POSTATUS,POBROAP    Set bit that at least one approval           
         LA    RF,POAUDILQ(RF)                                                  
         JCT   RE,OAPP22                                                        
*                                                                               
ORDAPPX  XIT1                                                                   
         DROP  RF                                                               
*                                                                               
         TITLE 'EVALUATE POSTFIX NOTATION'                                      
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
         USING ROWD,R2                                                          
         USING COLD,R3                                                          
         USING FMTRECD,R5                                                       
         USING EQD,R6                                                           
EVALUATE NMOD1 0,**EVAL**                                                       
         L     RC,RLBASEC                                                       
         L     R3,0(,R1)           GET COLUMN WORKING ON                        
         L     R4,4(,R1)           BASE OF ACCUM LINE                           
         L     R9,8(,R1)           BASE OF RECORD                               
         L     R6,COLXTRA          LOAD STACKED EQUATION                        
         MVC   EVDEC#,COL#DEC      Number of decimals to store as               
         MVC   EVIND4,COLIND4      Calculation Indicator                        
         MVC   EVDD#,COLDD#        Data Dictionary equate                       
         LA    R7,EVSTACK          EVALUATION STACK                             
         MVI   EVBYTE,BLANK        CLEAR                                        
*                                                                               
EVAL10   CLI   EQTYPE,EQEND        ANY MORE ITEMS ON STACK?                     
         BE    EVAL90              NO                                           
         LH    R3,EQDSP            GET DISPLACEMENT FOR COLUMN                  
         CLI   EQTYPE,EQCOL        COLUMN DISPLACEMENT                          
         BNE   EVAL12              NO                                           
         AR    R3,R4               ADD BASE OF ACCUM LINE                       
         TM    EQIND,EQREV         REVERSE SIGN OF COLUMN                       
         BZ    EVAL15                                                           
         TM    FMTIND,FMTNOREV     THIS MUST BE OFF TO REVERSE SIGN             
         BO    EVAL15                                                           
         MVI   EVBYTE,C'R'         REVERSE                                      
         B     EVAL15                                                           
*                                                                               
EVAL12   CLI   EQTYPE,EQROW        ROW DISPLACEMENT                             
         BNE   EVAL20              NO                                           
         LTR   R9,R9                                                            
         BZ    EVALZERO            CAN'T PERFORM OPERATION                      
         AR    R3,R9               POINT INTO REC INSTEAD OF ACCUM LINE         
*                                                                               
EVAL15   OC    0(PKLEN,R3),0(R3)   Was there an Error before ?                  
         BZ    EVALERR                     Yes                                  
         ZAP   0(PKLEN,R7),0(PKLEN,R3)     Save value on stack                  
*                                                                               
         CLI   EVBYTE,C'R'         Reverse sign for special keywords ?          
         BNE   EVAL16              No                                           
         MP    0(PKLEN,R7),PKNEG   Yes                                          
         MVI   EVBYTE,BLANK        Clear reverse indication                     
*                                                                               
EVAL16   DS    0H                                                               
*&&DO                              Display for now (PCA01445)                   
         LR    RF,R6                                                            
         AHI   RF,PKLEN            Look ahead to stacked operator               
         CLI   EQTYPE-EQD(RF),EQOPTR                                            
         BNE   *-8                                                              
         CLI   EQROUT#-EQD(RF),4   Only tinker with DPs if division             
         BNE   EVAL17                                                           
         L     RF,FMTCOL           lookup dp's from column used in calc         
         SR    RE,RE               (poss. foreign currency)                     
         IC    RE,EQCOL#                                                        
         AHI   RE,-1                                                            
         MHI   RE,COLLNQ                                                        
         AR    RF,RE               Displace to column definition                
         CLI   COLDCMLS-COLD(RF),2                                              
         BNL   EVAL17                                                           
         IC    RE,EVDEC#                                                        
         CLI   COLDCMLS-COLD(RF),1                                              
         BE    *+8                                                              
         AHI   RE,1                Incr. EVDEC# by 1 (1dp) or 2 (0dp)           
         AHI   RE,1                                                             
         STC   RE,EVDEC#                                                        
EVAL17   DS    0H                                                               
*&&                                                                             
         CLC   EVDEC#,EQDEC#       Are they the same decimal amounts ?          
         BE    EVAL18              Yes                                          
         ZIC   R1,EVDEC#           Number of decimal places want                
         ZIC   RF,EQDEC#           Number of decimal places have                
         SR    R1,RF               R1 = shift factor to get us there            
         SRP   0(PKLEN,R7),0(R1),0                                              
         BNO   *+6                                                              
         DC    H'00'               Overflow                                     
*                                                                               
EVAL18   LA    R7,PKLEN(,R7)       Push stack                                   
         B     EVALNEXT            Next                                         
*                                                                               
EVAL20   CLI   EQTYPE,EQVERT       Column number of vertical %                  
         BNE   EVAL25              No                                           
         ZIC   R2,EQROWLVL         Get row level                                
         MHI   R2,ROWLNQ           Multiply by length of row info               
         A     R2,FMTROW           Add base of row table                        
         L     R3,ROWVPACM         Point to row vertical % accum line           
         AH    R3,EQDSP            Add in displacement to column                
         ZAP   OP2,0(PKLEN,R3)     Set up to divide                             
         CLC   EVDEC#,EQDEC#       Are they the same decimal amounts ?          
         BE    EVAL22              Yes                                          
         ZIC   R1,EVDEC#           Number of decimal places want                
         ZIC   RF,EQDEC#           Number of decimal places have                
         SR    R1,RF               R1 = shift factor to get us there            
         SRP   OP2,0(R1),0                                                      
         BNO   *+6                                                              
         DC    H'00'               Overflow                                     
*                                                                               
EVAL22   AHI   R7,-PKLEN           Pop stack                                    
         ZAP   OP1,0(PKLEN,R7)     Pop next operand                             
         SRP   OP1,2,0                                                          
         B     EVALDIV             Carry out division                           
*                                                                               
EVAL25   CLI   EQTYPE,EQFRGN       FORIEGN RATE FUNCTION                        
         BNE   EVAL30              NO                                           
         AHI   R7,-PKLEN           POP STACK                                    
         ZAP   OP1,0(PKLEN,R7)                                                  
         LH    R3,EQDSP            GET DISPLACEMENT FOR COLUMN                  
         AR    R3,R4               ADD BASE OF ACCUM LINE                       
         ZAP   OP2,PKZERO                                                       
         MVO   OP2,1(5,R3)                                                      
         TM    0(R3),X'01'         DIVIDE BY RATE?                              
         BO    EVALDIV             YES                                          
         B     EVALMULT            NO, MULTIPLY                                 
*                                                                               
EVAL30   CLI   EQTYPE,EQDATE       DATE CALCULATION                             
         BNE   EVAL35              NO                                           
         LTR   R3,R9                                                            
         BZ    EVALZERO            CAN'T PERFORM OPERATION                      
         AH    R3,EQDSP                                                         
         GOTO1 DATCON,DMCB,(1,(R3)),(0,DTE1)                                    
         LR    R3,R9                                                            
         LA    R6,EQLNQ(,R6)                                                    
         AH    R3,EQDSP                                                         
         GOTO1 DATCON,DMCB,(1,(R3)),(0,DTE2)                                    
         CLC   DTE1,SPACES                                                      
         BNH   EVALZERO            EVALUATE TO ZERO                             
         CLC   DTE2,SPACES                                                      
         BNH   EVALZERO            EVALUATE TO ZERO                             
         GOTO1 PERVERT,DMCB,DTE1,DTE2                                           
         LH    R7,DMCB+8                                                        
*&&UK                                                                           
         CHI   R7,0                IS DAYS DIFFERENT A NEGATIVE VALUE?          
         BL    *+10                                                             
         BCTR  R7,0                POSITIVE - TAKE A DAY OFF                    
         B     *+8                                                              
         AHI   R7,1                NEGATIVE - ADD A DAY                         
*&&                                                                             
         MHI   R7,100                                                           
         CVD   R7,DUB                                                           
         LA    R7,DUB+PKLEN                                                     
         B     EVAL90                                                           
*                                                                               
EVAL35   CLI   EQTYPE,EQBIN#       BINARY CONSTANT                              
         BNE   EVAL40              NO                                           
         L     R1,EQCONST          YES, BINARY CONSTANT                         
         CVD   R1,0(,R7)           CONVERT CONSTANT TO DECIMAL                  
         LA    R7,PKLEN(,R7)       PUSH STACK                                   
         B     EVALNEXT            NEXT                                         
*                                                                               
EVAL40   CLI   EQTYPE,EQTOTL       TOTAL FOR ROW OR COLUMN                      
         BNE   EVAL45              NO                                           
         ZIC   R2,EQROWLVL         GET ROW LEVEL                                
         MHI   R2,ROWLNQ           MULTIPLY BY LENGTH OF ROW INFO               
         A     R2,FMTROW           ADD BASE OF ROW TABLE                        
         L     R3,ROWVPACM         POINT TO ROW VERTICAL % ACCUM LINE           
         AH    R3,EQDSP            ADD IN DISPLACEMENT TO COLUMN                
         ZAP   OP1,0(PKLEN,R3)                                                  
         B     EVAL70                                                           
*                                                                               
EVAL45   CLI   EQTYPE,EQSUM        CUME() OR SUM() KEYWORD                      
         BNE   EVAL50              NO                                           
         L     R3,EQADDR           LOAD ADDRESS OF COLUMN DATA                  
         AHI   R7,-PKLEN           POP ANSWER OFF OF STACK                      
         ZAP   OP1,0(PKLEN,R7)     SWAP RUNNING TOTAL WITH CURRENT AMT.         
         ZAP   0(PKLEN,R7),COLDUB  WE SWAP DATA BACK IN ACCTOT ROUTINE          
         ZAP   COLDUB,OP1          SO THAT IT TOTALS CORRECTLY                  
         LA    R7,PKLEN(,R7)       PUSH DATA BACK ON                            
         B     EVAL70                                                           
*                                                                               
EVAL50   CLI   EQTYPE,EQOPTR       *** Operator ***                             
         BE    *+6                 Yes                                          
         DC    H'00'               Unknown                                      
*                                                                               
         AHI   R7,-PKLEN           POP operand 2                                
         ZAP   OP2,0(PKLEN,R7)                                                  
         AHI   R7,-PKLEN           POP operand 1                                
         ZAP   OP1,0(PKLEN,R7)                                                  
         SR    RF,RF                                                            
         ICM   RF,1,EQROUT#        Valid routine                                
         BNZ   *+6                                                              
         DC    H'0'                No such routine                              
*                                                                               
         SLL   RF,2                                                             
         B     *(RF)               Branch to routine to evaluate                
         B     EVALADD                                                          
         B     EVALSUB                                                          
         B     EVALMULT                                                         
         B     EVALDIV                                                          
*                                                                               
EVALADD  AP    OP1,OP2             **    Add    ***                             
         B     EVAL70                                                           
*                                                                               
EVALSUB  SP    OP1,OP2             *** Subtract ***                             
         B     EVAL70                                                           
*                                                                               
EVALMULT MP    OP1,OP2+8(8)        *** Mulitply ***                             
*        LA    R2,62                                                            
*        CLI   EQTYPE,EQFRGN       FORIEGN RATE FUNCTION                        
*        BNE   *+8                                                              
*        LA    R2,59                                                            
         LA    R2,64                                                            
         SR    R1,R1                                                            
         IC    R1,EVDEC#                                                        
         SR    R2,R1               Shift, decimals started with                 
         SRP   OP1,0(R2),5         Back to EVDEC# amount                        
         B     EVAL70                                                           
*                                                                               
EVALDIV  CLI   EQSIGN,EQPCT        Is it a percentage calculation ?             
         BNE   *+10                                                             
         SRP   OP1,2,0                                                          
         SR    R2,R2               ***  Divide  ***                             
         IC    R2,EVDEC#                                                        
         SRP   OP1,0(R2),0         Shift by number of decimals stored           
*&&US                                                                           
         TM    CFKIND,CFKBUN             Billing unavailable?                   
         BZ    EVAL66                    . no                                   
         CLC   EVDD#,=AL2(AC#RSBAV)      BADAYS?                                
         BNE   EVAL66                    . no                                   
         XC    ANSWER,ANSWER                                                    
         B     EVAL99                                                           
*&&                                                                             
EVAL66   CP    OP2,PKZERO          Divide by zero?                              
         BNE   EVAL68              . no, continue                               
*&&US                                                                           
         TM    EVIND4,COLCFAV      Div by zero results zero (cashflow)          
         BZ    EVALERR             . no, error                                  
*&&                                                                             
         ZAP   OP1,PKZERO          . yes, return zero                           
         B     EVAL70                                                           
*                                                                               
EVAL68   DP    OP1,OP2+8(8)        Divide                                       
         ZAP   OP1,OP1(8)          Get rid of remaninder                        
*                                                                               
EVAL70   ZAP   0(PKLEN,R7),OP1+8(8)      Push answer onto stack                 
         LA    R7,PKLEN(,R7)                                                    
*                                                                               
EVALNEXT LA    R6,EQLNQ(,R6)       NEXT ON STACK                                
         B     EVAL10              LOOP                                         
*                                                                               
EVALERR  XC    ANSWER,ANSWER                                                    
         TM    FMTIND,FMTIERR      Show errors                                  
         BO    EVAL99                                                           
         ZAP   ANSWER,PKZERO       Don't show the errors                        
         B     EVAL99              Exit CC not equal (error occured)            
*                                                                               
EVALZERO ZAP   ANSWER,PKZERO       MAKE ANSWER ZERO                             
         SR    RA,RA                                                            
         B     EVAL99              EXIT CC NOT EQUAL                            
*                                                                               
EVAL90   AHI   R7,-PKLEN           POP ANSWER OFF OF STACK                      
         ZAP   ANSWER,0(PKLEN,R7)                                               
         SR    RA,RA                                                            
EVAL99   LTR   RA,RA                                                            
         XMOD1                                                                  
         DROP  R5                                                               
         SPACE 1                                                                
EVBYTE   DS    CL1                                                              
EVDEC#   DS    XL1                 Number of decimals working with              
EVIND4   DS    XL1                 Calculation Indicator                        
EVDD#    DS    XL2                 Data Dictionary number                       
         EJECT ,                                                                
         LTORG                                                                  
         TITLE 'BUILD TABLE OF SJ CLI/PRD AND RELATED DATA'                     
         USING ACWORKD,RC                                                       
         USING ACRLD,RA                                                         
         USING ACTRECD,R3                                                       
         USING SJINFO,R6                                                        
         USING FMTRECD,R5                                                       
***********************************************************************         
*  CREATE TABLE WITH SJ CLI/PROD/COST ACC/NUM2                        *         
***********************************************************************         
SJSAVE   DS    0D                                                               
         NMOD1 0,**SJBD**                                                       
         L     RC,RLBASEC                                                       
         L     R6,0(,R1)           BUILD SJ AREA                                
         MVI   SJNMELN,0           LENGTH OF NAME IS ZERO SO FAR                
         XC    SJNMEPTR,SJNMEPTR   POINTER TO NAME IS ZERO                      
*                                                                               
         LA    R3,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,RCCOMPFL                                                 
         MVC   ACTKUNT(2),=C'SJ'                                                
SJSAVE20 MVC   ACTKACT,SJCLIPRD                                                 
         L     R1,=AL4(IOHIGH+IOACFIL+IOAREA1)                                  
         GOTO1 AIO                                                              
         BE    *+6                 READ WAS GOOD                                
         DC    H'00'               BAD READ CHECK PARA 3 (CC)                   
*                                                                               
         L     R3,AIO1                                                          
         CLC   ACTKACT,SJCLIPRD    SAME CLIENT/PRD?                             
         BNE   SJSAVE99            NO, NOT FOUND ON SJ                          
*                                                                               
         LH    RF,SJLNQ            Length of entry                              
         BCTR  RF,0                                                             
         EXMVC RF,SJCLIPRD,SPACES                                               
         IC    RF,SJCLILEN         MOVE IN CLIENT                               
         BCTR  RF,0                                                             
         EXMVC RF,SJCLIPRD,ACTKACT                                              
         EXMVC RF,SJPRGRCP,ACTKACT                                              
         LA    R3,ACTKACT                                                       
         AH    R3,SJPRDDSP                                                      
         IC    RF,SJPRDLEN         LENGTH OF PRODUCT                            
         BCTR  RF,0                                                             
         LA    R4,SJCLIPRD         MOVE IN PRODUCT PART                         
         AH    R4,SJPRDDSP         DISPLACMENT TO PRODUCT                       
         EXMVC RF,0(R4),0(R3)                                                   
         LA    R4,SJPRGRCP         MOVE IN PRODUCT PART                         
         AH    R4,SJPRDDSP         DISPLACEMENT TO PRODUCT                      
         EXMVC RF,0(R4),0(R3)                                                   
*                                                                               
         L     R2,AIO1                                                          
         AH    R2,DATADISP                                                      
SJSAVE30 CLI   0(R2),0             END OF RECORD                                
         BE    SJSAVE50                                                         
         CLI   0(R2),NAMELQ        GET NAME ELEMENT X'20'                       
         BE    SJSAVNME                                                         
         CLI   0(R2),OTHELQ        GET OTHER ELEMENT X'23'                      
         BE    SJSAVOTH                                                         
         CLI   0(R2),PPRELQ        PRODUCTION PROFLIE ELEMENT                   
         BE    SJSAVPRF                                                         
         CLI   0(R2),FFNELQ        FREEFORM NUMBER ELEMENT X'25'                
         BE    SJSAVFFN                                                         
         CLI   0(R2),FFTELQ        FREEFORM TEXT   ELEMENT X'25'                
         BE    SJSAVFFT                                                         
SJSAVNXT SR    RF,RF                                                            
         IC    RF,1(,R2)           GET ELEMENT LENGTH                           
         AR    R2,RF                                                            
         B     SJSAVE30                                                         
*                                                                               
         USING NAMELD,R2                                                        
SJSAVNME SAM31                                                                  
         SR    RF,RF               ELEMENT CODE,LENGTH                          
         IC    RF,NAMLN                                                         
         SHI   RF,2                ELEMENT CODE,LENGTH                          
         BNP   SJSAVNXT                                                         
         STC   RF,SJNMELN          SAVE LENGTH                                  
         BCTR  RF,0                ONE FOR EXECUTE                              
         L     RE,APOOLPTR         CURRENT POINTER INTO NAME POOL               
         ST    RE,SJNMEPTR                                                      
         EXMVC RF,0(RE),NAMEREC    SAVE NAME                                    
         LA    RE,1(RF,RE)         BUMP UP TO NEXT FREE SPACE                   
         C     RE,APOOLEOT         END OF TABLE                                 
         BNH   *+6                                                              
         DC    H'0'                TABLE FULL                                   
         ST    RE,APOOLPTR         SAVE NEW LOCATION                            
         SAM24                                                                  
         B     SJSAVNXT                                                         
*                                                                               
         USING OTHELD,R2                                                        
SJSAVOTH SR    RF,RF                                                            
         IC    RF,SJPRDLEN                                                      
         BCTR  RF,0                                                             
         LA    R3,SJPRGRCP         SJ PRODUCT GROUP CLIENT PRODUCT              
         AH    R3,SJPRDDSP                                                      
         EXMVC RF,0(R3),OTHNUM     FIRST SAVE NEW PRD GROUP PRD                 
         LA    R3,OTHNUM+1(RF)     POINT PAST PRD                               
         IC    RF,SJCLILEN         CHECK TO SEE IF OTHNUM IS                    
         BCTR  RF,0                (CLI/PRD) OR (PRD)                           
         EXCLC RF,0(R3),SPACES     WAS IT CLI/PRD CODE?                         
         BE    SJSAVNXT            NO, JUST PRD, USE ORIGINAL CLI               
         LH    RF,SJJOBDSP                                                      
         BCTR  RF,0                                                             
         EXMVC RF,SJPRGRCP,OTHNUM   SAVE PRD GROUP CLI & PRD                    
         B     SJSAVNXT                                                         
*                                                                               
         USING PPRELD,R2                                                        
SJSAVPRF MVC   SJCOSTAC,PPRCOSTA                                                
         MVC   SJGRUP,PPRGRUP                                                   
         B     SJSAVNXT                                                         
*                                                                               
         USING FFNELD,R2                                                        
SJSAVFFN MVC   SJNUM2,SPACES                                                    
         SR    RF,RF                                                            
         IC    RF,FFNLN                                                         
         AHI   RF,-3                                                            
         BNP   SJSAVNXT                                                         
         EXMVC RF,SJNUM2,FFNONUM                                                
         B     SJSAVNXT                                                         
*                                                                               
         USING FFTELD,R2                                                        
SJSAVFFT CLI   FFTTYPE,FFTTEPTR    Freeform Acct equivalent                     
         BNE   SJSAVNXT                                                         
         SR    RF,RF                                                            
         IC    RF,FFTSEQ           Get which one                                
*        BCTR  RF,0                                                             
*        SLL   RF,1                Multipy by 2                                 
         LA    RF,SJAEUSED(RF)     Account equivlent used entry                 
         SR    R3,R3                                                            
         IC    R3,0(,RF)           Get displacment from SJAE_A                  
         LA    RE,SJAE_A(R3)       Point to acct. equiv. location               
         SR    RF,RF                                                            
         IC    RF,FFTDLEN                                                       
         SHI   RF,1                                                             
         BNP   SJSAVNXT                                                         
         EX    RF,*+8                                                           
         B     SJSAVNXT                                                         
         MVC   0(0,RE),FFTDATA                                                  
*                                                                               
         USING BIGPRNTD,R4                                                      
SJSAVE50 TM    UPSI,UPSIDMSJ       DUMP SJ TABLE                                
         BZ    SJSAVE99                                                         
         L     R4,VBIGPRNT                                                      
         L     RF,NUMREC                                                        
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  XP+4(5),DUB                                                      
         MVC   XP+10(SJNMELN-SJINFO),SJINFO                                     
         SR    RF,RF                                                            
         IC    RF,SJNMELN                                                       
         BCTR  RF,0                                                             
         SAM31                                                                  
         ICM   RE,15,SJNMEPTR                                                   
         BZ    SJSAVE63                                                         
         EXMVC RF,XP+15+(SJNMELN-SJINFO),0(RE)                                  
SJSAVE63 SAM24                                                                  
         GOTO1 REPORT                                                           
*                                                                               
SJSAVE99 XMOD1 1                                                                
         DROP  R2,R3,R4,R5,R6                                                   
         SPACE 1                                                                
         LTORG                                                                  
         EJECT ,                                                                
*=====================================================================*         
* Relative GETEL code                                                           
*=====================================================================*         
         GETEL R3,DATADISP,ELCODE                                               
         EJECT ,                                                                
RANKWRK  DCB   DSORG=PS,                                               X        
               RECFM=FB,                                               X        
               MACRF=(GM,PM),                                          X        
               BLKSIZE=1,                                              X        
               LRECL=1,                                                X        
               DDNAME=RANKWK,                                          X        
               EODAD=RANK90                                                     
*&&DO                                                                           
OUTWRK   DCB   DSORG=PS,                                               X        
               RECFM=FB,                                               X        
               MACRF=(GM,PM),                                          X        
               BLKSIZE=1,                                              X        
               LRECL=1,                                                X        
               DDNAME=OUT,                                             X        
               EODAD=OUT90                                                      
*&&                                                                             
         EJECT ,                                                                
       ++INCLUDE ACISOCTRY                                                      
*&&UK                                                                           
       ++INCLUDE ACISOCTRYG                                                     
*&&                                                                             
QSRTD    DSECT                     QUICK SORT                                   
QSMOA    DS    XL2                 Payroll MOA                                  
QSDATE   DS    XL3                 Payroll date                                 
QSKEYLNQ EQU   *-QSRTD                                                          
QSADDR   DS    AL4                 Address of element                           
QSLNQ    EQU   *-QSRTD                                                          
                                                                                
         EJECT ,                                                                
*ACREPRLWRK                                                                     
         PRINT OFF                                                              
       ++INCLUDE ACREPRLWRK                                                     
         PRINT ON                                                               
*DDCTRYEQUS                                                                     
         PRINT OFF                                                              
       ++INCLUDE DDCTRYEQUS                                                     
         PRINT ON                                                               
*ACGETRATEC                                                                     
FMRATED  DSECT                                                                  
         PRINT OFF                                                              
       ++INCLUDE ACGETRATEC                                                     
         PRINT ON                                                               
*&&UK                                                                           
*DDCTRYD                                                                        
         PRINT OFF                                                              
       ++INCLUDE DDCTRYD                                                        
         PRINT ON                                                               
*MEFILMED                                                                       
         PRINT OFF                                                              
DMED     DSECT                                                                  
       ++INCLUDE MEFILMED                                                       
         PRINT ON                                                               
*MEFILCLI                                                                       
         PRINT OFF                                                              
DCLI     DSECT                                                                  
       ++INCLUDE MEFILCLI                                                       
         PRINT ON                                                               
*MEFILCLXEL                                                                     
         PRINT OFF                                                              
       ++INCLUDE MEFILCLXEL                                                     
         PRINT ON                                                               
*&&                                                                             
*DDDDEQUS                                                                       
         PRINT OFF                                                              
       ++INCLUDE DDDDEQUS                                                       
         PRINT ON                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'212ACREPRL06 03/02/21'                                      
         END                                                                    
