*          DATA SET DXTRACT    AT LEVEL 095 AS OF 11/17/20                      
*PHASE DXTRACTA                                                                 
*INCLUDE DMUTLCT                                                                
*INCLUDE ENDOFMOD                                                               
*INCLUDE LOGIO                                                                  
*INCLUDE PRINT                                                                  
*INCLUDE PRINTERL                                                               
*INCLUDE HELLO                                                                  
*INCLUDE HELEN                                                                  
*INCLUDE HEXOUT                                                                 
*INCLUDE HEXIN                                                                  
*INCLUDE CARDS                                                                  
*INCLUDE NUMVAL                                                                 
*INCLUDE TIMBER                                                                 
*INCLUDE DATVAL                                                                 
*INCLUDE DATCON                                                                 
*INCLUDE ADDAY                                                                  
*INCLUDE MOBILE                                                                 
*INCLUDE COVAIL                                                                 
*INCLUDE GETBROAD                                                               
*INCLUDE PERVAL                                                                 
*INCLUDE DMDMGRL                                                                
*INCLUDE XSORT                                                                  
*INCLUDE GETBOOK                                                                
*INCLUDE CRYPT                                                                  
*INCLUDE SCANNER                                                                
*INCLUDE GETDAY                                                                 
*INCLUDE GETFACT                                                                
*INCLUDE ESSWTO                                                                 
*INCLUDE PQSERV                                                                 
*INCLUDE REFORM                                                                 
*INCLUDE DXCNVX                                                                 
*INCLUDE STXITER                                                                
*INCLUDE SMFOUT                                                                 
         IEABRCX DEFINE                                                         
         TITLE 'DXTRACT - EXTRACT SYSTEM FILE DATA'                             
         PRINT NOGEN                                                            
DXTRACT  CSECT                                                                  
*                                                                               
         NBASE 0,**XTRC**,RA,R9,R8,WORK=A(WORKC)                                
*                                                                               
         ENTRY SSB                 FOR DATAMGR                                  
         ENTRY DXBLOCK                                                          
*                                                                               
         L     RC,=A(WORKD)                                                     
         USING WORKD,RC            RC=A(GLOBAL W/S)                             
         ST    RB,RBSAVE                                                        
*                                                                               
         MVI   MVSPARM,0                                                        
         L     R1,0(R1)            GET MVS PARMS                                
         SR    RF,RF                                                            
         LH    RF,0(R1)                                                         
         LTR   RF,RF                                                            
         BZ    INIT010                                                          
         CLI   2(R1),C'0'          CHECK FIRST PARMS=1                          
         BE    INIT010                                                          
         MVI   MVSPARM,1           SET MVSPARM FLAG                             
*                                                                               
INIT010  EQU   *                                                                
         TIME  MIC,TIMEST,LINKAGE=SYSTEM                                        
         LG    GRF,TIMEST                                                       
         SRLG  GRF,GRF,12                                                       
         STG   GRF,TIMEST                                                       
*                                                                               
         ICM   RE,15,=V(ENDOFMOD)  SET STXIT IF END OF MODULE CSECT             
         B     INIT020                                                          
         ST    RB,DUB                                                           
         ST    RE,DUB+4                                                         
         OI    DUB+4,X'80'                                                      
         GOTO1 =V(STXITER),DMCB,DUB                                             
*                                                                               
INIT020  EQU   *                                                                
         L     R7,VCPRINT                                                       
         USING DPRINT,R7                                                        
         MVC   TITLE(20),=C'FILE EXTRACT PROGRAM'                               
         B     MAIN                                                             
         EJECT                                                                  
*                                                                               
EQXIT    CR    RB,RB                                                            
         J     XIT                                                              
NEQXIT   LTR   RB,RB                                                            
XIT      XIT1                                                                   
*                                                                               
***********************************************************************         
* MAIN CONTROL CODE                                                   *         
***********************************************************************         
         SPACE 1                                                                
MAIN     EQU   *                                                                
*                                                                               
         BRAS  RE,GENINIT          GENERAL INITIALISATION                       
*                                                                               
*                                                                               
         L     RF,=A(SSB)          SET DSPACE=A AS DEFAULT                      
         MVI   SSODSPAC-SSOOFF(RF),C'A'                                         
*                                                                               
         LA    R5,DUB                                                           
         EXTRACT (5),FIELDS=TIOT                                                
         L     R5,DUB                                                           
         LA    R5,24(R5)                                                        
         SR    R6,R6                                                            
*                                                                               
MVPQ101  CLI   0(R5),0             TEST FOR END OF TIOT TABLE                   
         BE    MVPQ103                                                          
         CLC   4(8,R5),=C'ADVPQDD0' TEST DDNAME=ADVPQDD0                        
         BE    MVPQ102A                                                         
         CLC   4(8,R5),=C'CSCPQDD0' TEST DDNAME=CSCPQDD0                        
         BE    MVPQ102C                                                         
         CLC   4(8,R5),=C'FQAPQDD0' TEST DDNAME=FQAPQDD0                        
         BE    MVPQ102Q                                                         
         CLC   4(8,R5),=C'REPPQDD0' TEST DDNAME=REPPQDD0                        
         BE    MVPQ102R                                                         
         CLC   4(8,R5),=C'TSTPQDD0' TEST DDNAME=TSTPQDD0                        
         BE    MVPQ102T                                                         
         CLC   4(8,R5),=C'TSTCTDD0' TEST DDNAME=TSTPQDD0                        
         BE    MVPQ102T                                                         
         IC    R6,0(R5)            GET LENGTH OF THIS ENTRY                     
         AR    R5,R6                                                            
         B     MVPQ101                                                          
*                                                                               
MVPQ102A L     RF,=A(SSB)          SET DSPACE=A                                 
         MVI   SSODSPAC-SSOOFF(RF),C'A'                                         
         B     MVPQ103                                                          
MVPQ102C L     RF,=A(SSB)          SET DSPACE=C                                 
         MVI   SSODSPAC-SSOOFF(RF),C'C'                                         
         B     MVPQ103                                                          
MVPQ102Q L     RF,=A(SSB)          SET DSPACE=Q                                 
         MVI   SSODSPAC-SSOOFF(RF),C'Q'                                         
         B     MVPQ103                                                          
MVPQ102R L     RF,=A(SSB)          SET DSPACE=R                                 
         MVI   SSODSPAC-SSOOFF(RF),C'R'                                         
         B     MVPQ103                                                          
MVPQ102T L     RF,=A(SSB)          SET DSPACE=T                                 
         MVI   SSODSPAC-SSOOFF(RF),C'T'                                         
MVPQ103  DS    0H                                                               
*                                                                               
         GOTO1 =A(VALCARDS)        VALIDATE JCL CARD DATA LINE                  
         BNE   MERR010               EXIT IF ERROR                              
*                                                                               
         GOTO1 =A(SETLRECL)                                                     
*                                                                               
         GOTO1 =A(INITHDB),(RC)    INITIALISE HOST DATABASE ACCESS              
*                                                                               
         CLI   GENSMF,C'T'                                                      
         BNE   MTLOOP                                                           
*                                                                               
         L     R6,=A(SMFTRACE)                                                  
         OPEN  ((R6),(OUTPUT))                                                  
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
*                                  MAIN PROCESS LOOP, RETURN HERE               
*                                    AFTER WAITING EXTRACT TRAWL TIME           
MTLOOP   EQU   *                                                                
*                                                                               
         GOTO1 =A(OPENCUPD),(RC)   OPEN CONTROL FILES FOR UPDATE                
*                                                                               
         GOTO1 =A(SDATIME),(RC)    SET UP DATE AND TIME VALUES                  
*                                                                               
         GOTO1 =A(OPENHDB),(RC)    OPEN HOST DATABASE CONNECTION                
         BNE   MERR160               EXIT IF ERROR                              
*                                                                               
         GOTO1 =A(REPMODE),(RC)    PRINT OUT RUN MODE REPORT                    
*                                                                               
         CLI   MODE,DXPQRQ         TEST IF EXTRACT MODE = PQ REPORT             
         BNE   MBTAB                                                            
         BRAS  RE,INITPQR          INITIALISE PQ REPORT EXTRACT                 
         BNE   MERR120                                                          
*                                                                               
MPLOOP   BRAS  RE,GETPQR           GET NEXT PQ REPORT FOR EXTRACT               
         BNE   MERR130                                                          
         CLI   PQEOF,C'N'                                                       
         BE    MBTAB                                                            
         GOTO1 =A(CLOSCTFL),(RC)                                                
         B     MTLPNEXT                                                         
*                                  LOOP FOR EACH SYSTEM IN EXTRACT              
MBTAB    BRAS  RE,BXSYSTAB         BUILD SYSTEM EXTRACT DRIVER TABLE            
         BNE   MERR030                                                          
         BRAS  RE,BXSYSLM          MODIFY SYSTEM EXTRACT DRIVER TABLE           
         BNE   MERR030                                                          
         CLI   MODE,DXPQRQ                                                      
         BE    *+14                                                             
         CLC   ASXDTAB,SXDTEND     EXIT IF NULL SYSTEM EXTRACT TABLE            
         BE    MXNULL                                                           
*                                  LOOP FOR EACH SYSTEM IN EXTRACT              
*                                    DRIVER TABLE                               
MSLOOP   EQU   *                                                                
         BRAS  RE,LOOPINIT         REINITIALISATION FOR SYSTEM LOOP             
*                                                                               
         BRAS  RE,SETSTPTR         SET SYSTEM TABLE POINTERS                    
         BNE   MSLPEXIT              EXIT AT END OF TABLE                       
*                                                                               
         BRAS  RE,SEXSYS           SET SYSTEM EXTRACT MODULE DATA BLOCK         
         BNE   MERR040               EXIT IF ERROR                              
*                                                                               
         GOTO1 =A(REPSYS),(RC)     ELSE PRINT OUT SYSTEM FILE REPORT            
*                                                                               
MSOPEN   GOTO1 =A(OPENFIL),(RC)    OPEN SYSTEM FILES                            
         BNE   MERR050               EXIT IF ERROR                              
*                                                                               
         GOTO1 =A(SAVESMF),DMCB,(1,0) SMF FOR ENTIRE JOB                        
*                                                                               
MSQL     CLI   MODE,DXSQLQ         TEST IF EXTRACT MODE = SQL ONLY              
         BNE   MSSTAT                                                           
         BRAS  RE,PROCSQL          EXTRACT PROCESS IN SQL ONLY MODE             
         IPM   RE                  INSERT PROGRAM MASK                          
         ST    RE,SVREG                                                         
         GOTO1 =A(SAVESMF),DMCB,(2,0) FOR SPECIFIC AGENCY                       
         L     RE,SVREG                                                         
         SPM   RE                  SET PROGRAM MASK                             
         BNE   MERR150               EXIT IF ERROR                              
         B     MSCLOSE                                                          
*                                                                               
MSSTAT   CLI   MODE,DXSTATQ        TEST IF EXTRACT MODE = STATISTICS            
         BNE   MSSTAC                                                           
         BRAS  RE,PROCSTAT         EXTRACT PROCESS IN STATISTIC MODE            
         IPM   RE                  INSERT PROGRAM MASK                          
         ST    RE,SVREG                                                         
         GOTO1 =A(SAVESMF),DMCB,(2,0) FOR SPECIFIC AGENCY                       
         L     RE,SVREG                                                         
         SPM   RE                  SET PROGRAM MASK                             
         BNE   MERR150               EXIT IF ERROR                              
         B     MSCLOSE                                                          
*                                                                               
MSSTAC   CLI   MODE,DXSTATCSQ      TEST IF EXTRACT MODE = STATBCS(GER)          
         BNE   MSPQR                                                            
         BRAS  RE,PROCSTAT         EXTRACT PROCESS IN STATISTIC MODE            
         IPM   RE                  INSERT PROGRAM MASK                          
         ST    RE,SVREG                                                         
         GOTO1 =A(SAVESMF),DMCB,(2,0) FOR SPECIFIC AGENCY                       
         L     RE,SVREG                                                         
         SPM   RE                  SET PROGRAM MASK                             
         BNE   MERR150               EXIT IF ERROR                              
         B     MSCLOSE                                                          
*                                                                               
MSPQR    CLI   MODE,DXPQRQ         TEST IF EXTRACT MODE = PQ REPORT             
         BNE   MSLOAD                                                           
         BRAS  RE,PROCPQR          EXTRACT PROCESS IN PQ REPORT MODE            
         IPM   RE                  INSERT PROGRAM MASK                          
         ST    RE,SVREG                                                         
         GOTO1 =A(SAVESMF),DMCB,(2,0) FOR SPECIFIC AGENCY                       
         L     RE,SVREG                                                         
         SPM   RE                  SET PROGRAM MASK                             
         BNE   MERR140               EXIT IF ERROR                              
         B     MSCLOSE                                                          
*                                                                               
MSLOAD   CLI   MODE,DXLOADQ        TEST IF EXTRACT MODE = LOAD                  
         BNE   MSUPDT                                                           
         CLI   POSTONLY,C'Y'                                                    
         BE    MSCLOSE                                                          
         BRAS  RE,PROCLOAD         EXTRACT PROCESS IN LOAD MODE                 
         IPM   RE                  INSERT PROGRAM MASK                          
         ST    RE,SVREG                                                         
         GOTO1 =A(SAVESMF),DMCB,(2,0) FOR SPECIFIC AGENCY                       
         L     RE,SVREG                                                         
         SPM   RE                  SET PROGRAM MASK                             
         BNE   MERR060               EXIT IF ERROR                              
         B     MSCLOSE                                                          
*                                                                               
MSUPDT   CLI   MODE,DXUPDTQ        TEST IF EXTRACT MODE = UPDATE                
         BNE   MSTRANS                                                          
         CLI   POSTONLY,C'Y'                                                    
         BE    MSCLOSE                                                          
         GOTO1 =A(PROCUPDT),(RC)   EXTRACT PROCESS IN UPDATE MODE               
         IPM   RE                  INSERT PROGRAM MASK                          
         ST    RE,SVREG                                                         
         GOTO1 =A(SAVESMF),DMCB,(2,0) FOR SPECIFIC AGENCY                       
         L     RE,SVREG                                                         
         SPM   RE                  SET PROGRAM MASK                             
         BNE   MERR080               EXIT IF ERROR                              
         CLI   ENDMODE,C'N'        ETST END MODE REQUESTED                      
         BE    MSCLOSE                                                          
         GOTO1 =A(PROCEND),(RC)    EXTRACT PROCESS IN UPDATE END MODE           
         BNE   MERR200               EXIT IF ERROR                              
         B     MSCLOSE                                                          
*                                                                               
MSTRANS  CLI   MODE,DXTRANSQ       TEST IF EXTRACT MODE = TRANS UPDATE          
         BNE   MERR070                                                          
         GOTO1 =A(PROCTRAN),(RC)   EXTRACT PROCESS IN TRANS UPDATE MODE         
         IPM   RE                  INSERT PROGRAM MASK                          
         ST    RE,SVREG                                                         
         GOTO1 =A(SAVESMF),DMCB,(2,0) FOR SPECIFIC AGENCY                       
         L     RE,SVREG                                                         
         SPM   RE                  SET PROGRAM MASK                             
         BNE   MERR080               EXIT IF ERROR                              
         B     MSCLOSE                                                          
*                                                                               
MSCLOSE  GOTO1 =A(CLOSEFIL),(RC)   CLOSE SYSTEM FILES                           
         BNE   MERR090               EXIT IF ERROR                              
         CLI   WRITE,C'Y'          TEST WRITE ON                                
         BNE   MSLPNEXT                                                         
         CLI   HOSTDB,C'Y'                                                      
         BNE   MSCL010                                                          
         MVC   P(80),=CL80'FINAL COMMIT TO HOST DATABASE'                       
         GOTO1 VPRINTER                                                         
MSCL010  GOTO1 =A(COMMHDB),(RC)    COMMIT HOST DATABASE UPDATES                 
         BNE   MERR170               EXIT IF ERROR                              
         GOTO1 =A(LOGHDB),(RC)     WRITE EXTRACT LOG TO HOST DATABASE           
         BNE   MERR190               EXIT IF ERROR                              
         CLI   POSTONLY,C'Y'                                                    
         BE    *+12                                                             
         CLI   FILEFLAG,C'N'       TEST IF EXTRACT FILES CREATED                
         BE    MSLPNEXT                                                         
         CLI   MODE,DXPQRQ         TEST IF EXTRACT MODE = PQ REPORT             
         BNE   *+12                                                             
         CLI   PQRFLAG,C'N'        TEST IF PQ REPORT FILE EXTRACTED OK          
         BE    MSLPNEXT                                                         
         CLI   AUTOFLAG,ON         CHECK IF AUTO UPDATE MODE                    
         BNE   MSLPNEXT                                                         
*                                                                               
         CLI   WRTXFFLG,C'Y'                                                    
         BNE   MSLPNEXT                                                         
         CLI   HOSTDB,C'Y'                                                      
         BE    MSLPNEXT                                                         
         GOTO1 =A(WRTXFCT),(RC)    WRITE EXTRACT FILE CONTROL RECORDS           
         BNE   MERR110                                                          
*                                                                               
MSLPNEXT EQU   *                     DRIVER TABLE                               
         CLI   POSTONLY,C'Y'                                                    
         BE    MTLPEXIT                                                         
         CLI   AUTOFLAG,ON         EXIT IF NON-AUTO MODE                        
         BE    MSLOOP              ELSE LOOP TO NEXT SYSTEM                     
         B     MTLPEXIT                                                         
*                                  HERE AT END OF THIS EXTRACT TRAWL            
MSLPEXIT EQU   *                                                                
         GOTO1 =A(SDATIME),(RC)    SET UP DATE AND TIME VALUES                  
         CLI   MODE,DXPQRQ         TEST IF EXTRACT MODE = PQ REPORT             
         BNE   MCCLOSE                                                          
         CLI   AUTOFLAG,OFF        TEST IF NOT AUTO MODE                        
         BE    MCCLOSE                                                          
         CLI   INPCODE,DXTIREPQ                                                 
         BE    MCCLOSE                                                          
         XC    REFORMID,REFORMID   CLEAR REFORM ID PARAMETERS                   
         XC    SYSFILT,SYSFILT     FOR NEXT REPORT                              
         XC    SUBFILT,SUBFILT                                                  
         OC    UIDFILT,UIDFILT     TESAT IF SINGLE REPORT FILTER                
         BZ    MPLOOP                                                           
         OC    SUBIDFLT,SUBIDFLT                                                
         BZ    MPLOOP                                                           
         OC    REPNOFLT,REPNOFLT                                                
         BZ    MPLOOP              LOOP TO GET NEXT REPORT                      
*                                                                               
MCCLOSE  GOTO1 =A(CLOSCTFL),(RC)   CLOSE CONTROL SYSTEM IF STILL OPEN           
*                                                                               
MTLPNEXT EQU   *                                                                
         GOTO1 =A(CLOSHDB),(RC)    CLOSE HOST DATABASE CONNECTION               
         BNE   MERR180               EXIT IF ERROR                              
         MVI   STARFLAG,C'N'       SET START FLAG TO NO                         
         CLI   AUTOFLAG,ON         EXIT IF NON-AUTO MODE                        
         BNE   MTLPEXIT                                                         
         CLI   INPCODE,DXTIREPQ                                                 
         BE    MTLPEXIT                                                         
         CLI   DAILYFLG,ON         EXIT IF DAILY UPDATE MODE                    
         BE    MTLPEXIT                                                         
         CLI   ONCEFLG,C'Y'        EXIT IF FREQUENCY=ONCE                       
         BE    MTLPEXIT                                                         
         CLI   MODE,DXLOADQ        EXIT IF EXTRACT MODE = LOAD                  
         BE    MTLPEXIT                                                         
         CLI   MODE,DXSQLQ         EXIT IF EXTRACT MODE = SQL                   
         BE    MTLPEXIT                                                         
         CLI   MODE,DXSTATQ        EXIT IF EXTRACT MODE = STATISTICS            
         BE    MTLPEXIT                                                         
         CLI   MODE,DXSTATCSQ      EXIT IF EXTRACT MODE = STATBCS(GER)          
         BE    MTLPEXIT                                                         
         CLI   SKIPWAIT,C'Y'       TEST TRAWL NEEDS TO BE CONTINUED             
         BE    MTLP010             YES, ALWAYS DO IT                            
         CLI   CLOSFLAG,C'Y'       EXIT IF OPERATOR CLOSE                       
         BE    MTLPEXIT                                                         
         CLI   RUNFLAG,C'1'        EXIT IF ONLY RUN ONCE                        
         BE    MTLPEXIT                                                         
         CLI   MVSPARM,1                                                        
         BE    MTLPEXIT                                                         
MTLP010  GOTO1 =A(WAITER),(RC)     WAIT TRAWL INTERVAL TIME                     
         CLI   OPERSTOP,C'Y'         AND CHECK FOR OPERATOR COMMS.              
         BE    MTLPEXIT            EXIT IF OPERATOR STOP REQUEST                
         B     MTLOOP              DO NEXT EXTRACT TRAWL                        
*                                                                               
MTLPEXIT EQU   *                   EXIT FROM EXTRACT TRAWL LOOP                 
         CLI   HOSTDB,C'Y'                                                      
         BNE   MXIT                                                             
         CLI   HDBSTATE,0                                                       
         BE    MXIT                                                             
         MVI   RETCODE,128                                                      
         OC    RETCODE,HDBSTATE                                                 
         B     MXIT                                                             
*                                                                               
MERR     MVI   RETCODE,X'FF'       HERE IF PROCESS ERROR                        
         B     MXIT                                                             
*                                                                               
MXNULL   EQU   *                   EXIT IF NULL SYSTEM EXTRACT TABLE            
         MVI   MSGNUM,MSNULLQ                                                   
         GOTO1 =A(MSGPRT),(RC)                                                  
         B     MXIT                                                             
*                                                                               
MXIT     EQU   *                   EXIT FROM SYSTEM                             
         GOTO1 =A(CLOSCTFL),(RC)   CLOSE CONTROL SYSTEM IF STILL OPEN           
         MVI   MSGNUM,MSENDQ                                                    
         GOTO1 =A(MSGPRT),(RC)                                                  
*                                                                               
MXBASE   EQU   *                                                                
*&&US*&& CLI   RETCODE,0                                                        
*&&US*&& BNE   MXBASERC                                                         
*&&US*&& CLI   EMPTYFIL,C'N'       AT LEAST ONE FILE IS NOT EMPTY               
*&&US*&& BE    *+8                                                              
*&&US*&& MVI   RETCODE,1                                                        
MXBASERC CLC   RETCODE,MAXRETCD    HAS AN OVERLAY SET A HIGHER CODE             
         BNL   MXBASESMF                                                        
         MVC   RETCODE,MAXRETCD    YES, RETURN IT                               
*                                                                               
MXBASESMF DS   0H                  WRITE OUT SMF RECORDS                        
         CLI   GENSMF,C'N'                                                      
         BE    MXBASEX                                                          
*                                                                               
         GOTO1 =A(SAVESMF),DMCB,(1,0) SMF FOR ENTIRE JOB                        
         TIME  MIC,TIMEEND,LINKAGE=SYSTEM                                       
         LG    GRF,TIMEEND                                                      
         SRLG  GRF,GRF,12                                                       
         STG   GRF,TIMEEND                                                      
         BRAS  RE,WRITESMF                                                      
*                                                                               
         CLI   GENSMF,C'T'                                                      
         BNE   MXBASEX                                                          
*                                                                               
         L     R6,=A(SMFTRACE)                                                  
         CLOSE ((R6))                                                           
*                                                                               
MXBASEX  XBASE RC=RETCODE,RL=1     RETURN TO MVS                                
*                                                                               
         USING DXBLOCKD,R1                                                      
SETMAXRC IPM   RE                  SAVE CC                                      
         L     R1,0(,R1)                                                        
         CLC   MAXRETCD,DXRETCDE   HAS A HIGHER DXRETCDE BEEN SET               
         JNL   *+10                                                             
         MVC   MAXRETCD,DXRETCDE   YES, ITS THE NEW MAX                         
         SPM   RE                  RESTORE CC                                   
         BR    RE                                                               
         DROP  R1                                                               
         EJECT                                                                  
***********************************************************************         
* DXTRACT MAIN PROCESS ERROR RETURNS - ABEND CODE 750+                *         
***********************************************************************         
         SPACE 1                                                                
MERR010  EQU   *                                                                
         GOTO1 =A(CLOSCTFL),(RC)                                                
         MVI   ERROR,ERVALCQ                                                    
         GOTO1 =A(ERRPRT),(RC)                                                  
         ABEND 750,DUMP                                                         
MERR030  EQU   *                                                                
         GOTO1 =A(CLOSCTFL),(RC)                                                
         MVI   ERROR,ERBXSYSQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         ABEND 752,DUMP                                                         
MERR040  EQU   *                                                                
         GOTO1 =A(CLOSCTFL),(RC)                                                
         MVI   ERROR,ERSEXSQ                                                    
         GOTO1 =A(ERRPRT),(RC)                                                  
         ABEND 753,DUMP                                                         
MERR050  EQU   *                                                                
         GOTO1 =A(CLOSCTFL),(RC)                                                
         MVI   ERROR,EROPESFQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         ABEND 754,DUMP                                                         
MERR060  EQU   *                                                                
         GOTO1 =A(CLOSCTFL),(RC)                                                
         MVI   ERROR,ERPLOADQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         ABEND 755,DUMP                                                         
MERR070  EQU   *                                                                
         GOTO1 =A(CLOSCTFL),(RC)                                                
         MVI   ERROR,ERMODEQ                                                    
         GOTO1 =A(ERRPRT),(RC)                                                  
         ABEND 756,DUMP                                                         
MERR080  EQU   *                                                                
         GOTO1 =A(CLOSCTFL),(RC)                                                
         MVI   ERROR,ERPUPDTQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         ABEND 757,DUMP                                                         
MERR090  EQU   *                                                                
         GOTO1 =A(CLOSCTFL),(RC)                                                
         MVI   ERROR,ERCLOSFQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         ABEND 758,DUMP                                                         
MERR110  EQU   *                                                                
         GOTO1 =A(CLOSCTFL),(RC)                                                
         MVI   ERROR,ERWRTXFQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         ABEND 760,DUMP                                                         
MERR120  EQU   *                                                                
         GOTO1 =A(CLOSCTFL),(RC)                                                
         MVI   ERROR,ERIPQRQ                                                    
         GOTO1 =A(ERRPRT),(RC)                                                  
         ABEND 761,DUMP                                                         
MERR130  EQU   *                                                                
         GOTO1 =A(CLOSCTFL),(RC)                                                
         MVI   ERROR,ERGETPQQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         ABEND 762,DUMP                                                         
MERR140  EQU   *                                                                
         GOTO1 =A(CLOSCTFL),(RC)                                                
         MVI   ERROR,ERPPQRQ                                                    
         GOTO1 =A(ERRPRT),(RC)                                                  
         ABEND 763,DUMP                                                         
MERR150  EQU   *                                                                
         GOTO1 =A(CLOSCTFL),(RC)                                                
         MVI   ERROR,ERPSQLQ                                                    
         GOTO1 =A(ERRPRT),(RC)                                                  
         ABEND 764,DUMP                                                         
MERR160  EQU   *                                                                
         GOTO1 =A(CLOSCTFL),(RC)                                                
         MVI   ERROR,ERHDBOPQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         ABEND 765,DUMP                                                         
MERR170  EQU   *                                                                
         GOTO1 =A(CLOSCTFL),(RC)                                                
         MVI   ERROR,ERHDBCOQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         ABEND 766,DUMP                                                         
MERR180  EQU   *                                                                
         GOTO1 =A(CLOSCTFL),(RC)                                                
         MVI   ERROR,ERHDBCLQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         ABEND 767,DUMP                                                         
MERR190  EQU   *                                                                
         GOTO1 =A(CLOSCTFL),(RC)                                                
         MVI   ERROR,ERHDBLXQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         ABEND 768,DUMP                                                         
MERR200  EQU   *                                                                
         GOTO1 =A(CLOSCTFL),(RC)                                                
         MVI   ERROR,ERHDBLXQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         ABEND 769,DUMP                                                         
         EJECT                                                                  
***********************************************************************         
* REINITIALISATION ON MAIN SYSTEM PROCESS LOOP                        *         
***********************************************************************         
         SPACE 1                                                                
LOOPINIT NTR1  ,                                                                
         MVI   FILEFLAG,C'N'       RESET EXTRACT FILES CREATED FLAG             
         L     RE,ASFLIST          CLEAR SAVED XFILE LIST FOR THIS PASS         
         ST    RE,ASFNEXT                                                       
         L     RF,=A(SFLISTX)                                                   
         SR    RF,RE                                                            
         XCEF                                                                   
         L     RF,=A(EXFTAB)                                                    
         ST    RF,AEXFTNXT                                                      
         XC    ALDCBNUM,ALDCBNUM   RESET NUMBER OF USED DCBS                    
         XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* BUILD SYSTEM EXTRACT DRIVER TABLE                                   *         
***********************************************************************         
         SPACE 1                                                                
BXSYSTAB NTR1  ,                                                                
         MVI   MSGNUM,MSBXSYSQ                                                  
         GOTO1 =A(MSGPRT),(RC)                                                  
*                                                                               
         L     RE,ASXDTAB          INITIALISE SYSTEM EXTRACT AGENCY             
         ST    RE,SXDTEND            TABLE POINTERS                             
         ST    RE,SXDTNXT                                                       
         ST    RE,SXDTPTR                                                       
         L     RE,ASLLIST                                                       
         ST    RE,ASLNEXT                                                       
         L     RF,=A(SLLISTX)                                                   
         SR    RF,RE                                                            
         XCEF                                                                   
         L     RE,ASFLIST                                                       
         ST    RE,ASFNEXT                                                       
         L     RF,=A(SFLISTX)                                                   
         SR    RF,RE                                                            
         XCEF                                                                   
         L     RE,ADBLIST                                                       
         ST    RE,ADBNEXT                                                       
         L     RF,=A(DBLISTX)                                                   
         SR    RF,RE                                                            
         XCEF                                                                   
         L     RE,ASXDBEXT                                                      
         ST    RE,ASXDBNXT                                                      
         L     RF,=A(SXDBEXTX)                                                  
         SR    RF,RE                                                            
         XCEF                                                                   
         L     RE,=A(SXDTABC)                                                   
         L     RF,=A(SXDTABX)                                                   
         SR    RF,RE                                                            
         XCEF                                                                   
*                                                                               
         CLI   HEADFLAG,C'X'                                                    
         BE    BXST010                                                          
*                                                                               
         CLI   HOSTDB,C'Y'                                                      
         BE    *+12                                                             
         CLI   AUTOFLAG,ON         TEST DRIVER MODE                             
         BE    BXST010                                                          
         BRAS  RE,SINGLES          USE JCL PARAMETER CARD INPUT                 
         BNE   BXSTNO                                                           
         B     BXSTOK                                                           
*                                  USE CONTROL FILE DRIVER RECORDS              
BXST010  L     R4,ASXDTAB          POINT TO SYSTEM DRIVER TABLE                 
         SR    R6,R6                                                            
         USING SXDTABD,R4                                                       
         LR    RE,R4                                                            
         LA    RF,SXDTABL                                                       
         XCEF                                                                   
*                                                                               
         LA    R2,IOKEY            READ XAGENCY EXTRACT DRIVER RECORDS          
         USING GXTRD,R2                                                         
         XC    GXKEY,GXKEY         CLEAR RECORD KEY                             
         MVI   GXKREC,GXAKRECQ     SET XAGENCY RECORD TYPE                      
         L     R2,ARECBUFF         READ HIGH FOR FIRST RECORD                   
*                                  READ HIGH WITH FLUSH                         
         GOTO1 VDATAMGR,DMCB,(X'24',DMRDHI),GENDIR,IOKEY,(R2),DMWORK            
         TM    8(R1),X'FF'-X'80'   ONLY ALLOW EOF ERROR                         
         BZ    *+6                                                              
         DC    H'0'                DATAMANAGER RETURN NOT 0 OR EOF              
         CLI   8(R1),0                                                          
         BNE   BXSTEND                                                          
         CLI   GXKREC,GXAKRECQ     TEST FOR XAGENCY RECORD                      
         BNE   BXSTEND                                                          
         B     BXSTDATA                                                         
*                                  READ SEQN WITH FLUSH                         
BXSTLOOP GOTO1 VDATAMGR,DMCB,(X'24',DMRSEQ),GENDIR,GXKEY,(R2),DMWORK            
         TM    8(R1),X'FF'-X'80'   ONLY ALLOW EOF ERROR                         
         BZ    *+6                                                              
         DC    H'0'                DATAMANAGER RETURN NOT 0 OR EOF              
         CLI   8(R1),0                                                          
         BNE   BXSTEND                                                          
         CLI   GXKREC,GXAKRECQ     TEST FOR XAGENCY RECORD                      
         BNE   BXSTEND                                                          
*                                  GETREC WITH FLUSH                            
BXSTDATA MVC   DMDA,GXDDA                                                       
         GOTO1 VDATAMGR,DMCB,(X'24',GETREC),GENFIL,DMDA,(R2),DMWORK             
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                CAN'T FIND RECORD                            
*                                                                               
BXST100  LA    R3,GXFIRST(R2)      PROCESS ELEMENT DATA                         
*                                                                               
BXST110  CLI   0(R3),0                                                          
         BE    BXST180                                                          
         CLI   0(R3),GXSDELQ       FIND SYSTEM DEFINITION ELEMENT               
         BE    BXST120                                                          
         CLI   0(R3),GXGNELQ       FIND FILE GENERATION # ELEMENT               
         BE    BXST160                                                          
         CLI   0(R3),GXPCELQ       FIND PASSWORD ENCRYPT ELEMENT                
         BE    BXST170                                                          
         CLI   0(R3),GXBDELQ       FIND BDE CONTROL ELEMENT                     
         BE    BXST172                                                          
BXST112  SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     BXST110                                                          
                                                                                
*----------------------------------                                             
* PROCESS SYSTEM DEFINITION ELEMENT                                             
*----------------------------------                                             
         USING GXSDEL,R3                                                        
BXST120  CLI   GXSDELL,GXSDELLQ                                                 
         BE    BXST130                                                          
*                                                                               
         CLI   MODE,DXUPDTQ        ONLY MATCH ON THRD# FOR MODE=UPDATE          
         BNE   BXST121                                                          
         CLC   GXSDTHD,THREAD      MUST MATCH ON THREAD# (DEFAULT IS 0)         
         BNE   BXST200             EXIT IF THIS THREAD# NE.                     
*                                                                               
BXST121  OC    GXSDFDAT,GXSDFDAT   ANY DATE RANGE VALUE?                        
         BNZ   BXST128             YES - USE THIS XAGY DATE RANGE VALUE         
*                                                                               
* NOTES: SAME QUARTER CODE IN SPREPDB02                                         
* FOR QUARTER CALCULATION, SUNDAY'S DATE IS USED FOR SATURDAY'S LOAD            
*                                                                               
         OC    GXSDQTRB,GXSDQTRB   ANY QUARTER BACK/FORWARD VALUES?             
         BZ    BXST129             NO  - EXIT                                   
         SR    R0,R0                                                            
         IC    R0,GXSDQTRB         GET QUARTER BACK                             
         MHI   R0,3                                                             
         AHI   R0,2                GO BACK 2 EXTRA MONTHS                       
         LNR   R0,R0                                                            
*                                                                               
         MVC   TODAYQTR,TODAY                                                   
         CLI   MODE,DXLOADQ        IS THIS A LOAD?                              
         BNE   BXST121X             -NO                                         
         GOTO1 VGETDAY,DMCB,(0,TODAYQTR),(0,WORK)                               
         CLI   DMCB,6              IS THIS A SATURDAY?                          
         BNE   BXST121X             -NO                                         
*                                   -YES, ADD A DAY TO MAKE IT SUNDAY           
         GOTO1 VADDAY,DMCB,(C'D',TODAY),TODAYQTR,1                              
*                                                                               
BXST121X DS    0H                                                               
*                                                                               
         MVC   WORK(6),TODAYQTR                                                 
         MVC   WORK+4(2),=C'15'                                                 
*                                                                               
BXST122  GOTO1 VADDAY,DMCB,(C'M',WORK),WORK+6,(R0)                              
*                                                                               
         MVC   WORK(6),WORK+6                                                   
         CLC   WORK+2(2),=C'01'   TEST FOR A MONTH THAT STARTS A QTR            
         BE    BXST123                                                          
         CLC   WORK+2(2),=C'04'                                                 
         BE    BXST123                                                          
         CLC   WORK+2(2),=C'07'                                                 
         BE    BXST123                                                          
         CLC   WORK+2(2),=C'10'                                                 
         BE    BXST123                                                          
         LHI   R0,1                SET TO ADVANCE A MONTH                       
         B     BXST122                                                          
*                                                                               
* GET BROADCAST MONTH DATES FROM MOBILE                                         
*                                                                               
BXST123  MVC   WORK+6(6),WORK      SET END DATE=TO DATE                         
         GOTO1 VMOBILE,DMCB,(2,WORK),(1,WORK+16)                                
*                                                                               
         GOTO1 VDATCON,DMCB,(2,WORK+16),(1,SXDFDATP)                            
         GOTO1 VDATCON,DMCB,(2,WORK+16),(2,SXDFDATC)                            
*                                                                               
* SPECIAL NOTE FOR QUARTER FORWARD.                                             
* IF THE EXTRACT IS EXCUTED IN THE 1ST MONTH OF THE QUARTER,                    
* THE CURRENT QUARTER IS READ AS ONE OF THE QUARTERS GOING FORWARD.             
* FOR EXAMPLE, FOR 3 QUARTERS FORWARD, AN EXTRACT RUN IN JANUARY,               
* WILL INCLUDE THE 1ST, 2ND AND 3RD QUARTERS.                                   
* WHEREAS, AN EXTRACT RUN IN FEBRUARY WILL INCLUDE THE 1ST, 2ND, 3RD            
* AND 4TH QUARTERS.                                                             
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,GXSDQTRF       GET QUARTERS FORWARD                         
         BP    *+8                                                              
         LHI   R0,2                DEFAULT TO 2 QUARTERS FORWARD                
         BCTR  R0,0                ARITHMETIC                                   
         MHI   R0,3                X 3                                          
         AHI   R0,2                AND 2 MORE MONTH                             
         MVC   WORK(6),TODAYQTR                                                 
         MVC   WORK+4(2),=C'15'                                                 
*                                                                               
BXST125  GOTO1 VADDAY,DMCB,(C'M',WORK),WORK+6,(R0)                              
         MVC   WORK(6),WORK+6                                                   
         CLC   WORK+2(2),=C'03'   TEST FOR A MONTH THAT ENDS A QTR              
         BE    BXST126                                                          
         CLC   WORK+2(2),=C'06'                                                 
         BE    BXST126                                                          
         CLC   WORK+2(2),=C'09'                                                 
         BE    BXST126                                                          
         CLC   WORK+2(2),=C'12'                                                 
         BE    BXST126                                                          
         LHI   R0,1                SET TO ADVANCE A MONTH                       
         B     BXST125                                                          
*                                                                               
BXST126  MVC   WORK+6(6),WORK      SET END DATE=TO DATE                         
         MVC   WORK+4(2),=C'01'                                                 
         MVC   WORK+10(2),=C'31'                                                
         GOTO1 VMOBILE,DMCB,(2,WORK),(1,WORK+16)                                
*                                  SET BRDMON END DATE                          
         GOTO1 VDATCON,DMCB,(2,WORK+18),(1,SXDTDATP)                            
         GOTO1 VDATCON,DMCB,(2,WORK+18),(2,SXDTDATC)                            
         B     BXST129                                                          
*                                  USE DATE RANGE VALUES                        
BXST128  GOTO1 VDATCON,DMCB,(3,GXSDFDAT),(1,SXDFDATP)                           
         GOTO1 VDATCON,DMCB,(3,GXSDTDAT),(1,SXDTDATP)                           
         GOTO1 VDATCON,DMCB,(3,GXSDFDAT),(2,SXDFDATC)                           
         GOTO1 VDATCON,DMCB,(3,GXSDTDAT),(2,SXDTDATC)                           
*                                                                               
BXST129  MVC   SXDTFLG1,GXSDFLG1                                                
         CLI   TSTFLAG,C' '        CHECK FOR TEST SYTEM FILTER FLAG SET         
         BE    BXST130                                                          
         CLI   TSTFLAG,C'N'                                                     
         BE    *+16                                                             
         TM    GXSDFLG1,GXSDFTSQ   FILTER ON TEST SYSTEM FILE EXTRACT           
         BZ    BXST200                                                          
         B     BXST130                                                          
         TM    GXSDFLG1,GXSDFTSQ   FILTER ON LIVE SYSTEM FILE EXTRACT           
         BNZ   BXST200                                                          
*                                                                               
BXST130  MVC   SXDTAGY,GXAKAGY     AGENCY ID                                    
         MVC   SXDTSYS,GXSDSYS     SYSTEM CODE                                  
         CLI   VERFTYP,C'X'        TEST FOR EXCLUSIVE VERSION FILTER            
         BNE   BXST130A                                                         
         CLI   VERNUM,0            TEST VERSION NUMBER FILTER                   
         BE    *+14                                                             
         CLC   VERNUM,GXSDVER                                                   
         BNE   BXST200             EXIT IF THIS VERSION NE. FILTER              
BXST130A OC    SUBFILT,SUBFILT     TEST SUB SYSTEM FILTER                       
         BZ    *+14                                                             
         CLC   SUBFILT,GXSDSUB                                                  
         BNE   BXST200             EXIT IF THIS SUB SYSTEM NE. FILTER           
         GOTO1 GETSUB,GXSDSUB      GET SUB SYSTEM INFO                          
         BNE   BXST200                                                          
         MVC   SXDTSUB,SUBSYS                                                   
         MVC   SXDTSUBC,SUBCHAR                                                 
         MVC   AGYAID,GXAKAGY                                                   
         OC    AGYFILT,AGYFILT     TEST AGENCY FILTER                           
         BZ    *+14                                                             
         CLC   AGYAID,AGYFILT                                                   
         BNE   BXST200             EXIT IF THIS AGENCY .NE. FILTER              
         MVC   SYSTEM,GXSDSYS                                                   
         OC    SYSFILT,SYSFILT     TEST SYSTEM FILTER                           
         BZ    *+14                                                             
         CLC   SYSTEM,SYSFILT                                                   
         BNE   BXST200             EXIT IF THIS SYSTEM .NE. FILTER              
*                                                                               
         XC    AGYSAVE,AGYSAVE                                                  
         XC    SVFLAG,SVFLAG                                                    
         MVC   SXDTSAGY,SXDTAGY                                                 
         GOTO1 =A(GETACC),(RC)     GET DATA FROM AGENCY ACCESS RECORD           
         BNE   BXSTER2                                                          
         CLC   AGYSAVE,SPACES                                                   
         BNH   *+10                                                             
         MVC   SXDTSAGY,AGYSAVE                                                 
         TM    SVFLAG,SVFUATQ                                                   
         BZ    *+8                                                              
         OI    SXDTFLG2,SXDTUATQ                                                
         OC    SYSXFILT,SYSXFILT   TEST SYSTEM FILE NUM FILTER                  
         BZ    *+14                                                             
         CLC   SENUM,SYSXFILT                                                   
         BNE   BXST200             EXIT IF THIS SYSTEM NUM .NE. FILTER          
*                                                                               
         MVC   SXDTSEN,SENUM                                                    
         MVC   SXDTAGB,AGYBIN                                                   
         MVC   SXDTPIN,AGYPIN                                                   
         MVC   SXDTCTRY,AGYCNTRY                                                
         CLI   COUNTRY,X'FF'                                                    
         BE    *+14                                                             
         CLC   COUNTRY,AGYCNTRY                                                 
         BNE   BXST200                                                          
         GOTO1 =A(GETSYL),(RC)     GET DATA FROM SYSLIST SYSTEM RECORD          
         BNE   BXSTER3                                                          
*                                                                               
         MVC   SXDTSCHR,SYSCHAR                                                 
         MVC   SXDTSLNM,SYSLNAM                                                 
         MVC   SXDTSCOD,SYSCODE                                                 
         MVC   SXDTPLFM,PLATFORM                                                
         MVC   SXDTLEV,GXSDLEV                                                  
         CLI   VERNUM,0                                                         
         BE    *+14                                                             
         MVC   SXDTVER,VERNUM                                                   
         B     *+10                                                             
         MVC   SXDTVER,GXSDVER                                                  
         MVC   SXDTFLT1,GXSDFLT1                                                
         MVC   SXDTFLT2,GXSDFLT2                                                
         MVC   SXDTFLT3,GXSDFLT3                                                
         OC    EXTYPE,EXTYPE                                                    
         BZ    *+14                                                             
         MVC   SXDTTYP,EXTYPE                                                   
         B     *+10                                                             
         MVC   SXDTTYP,GXSDTYP                                                  
         MVI   SXDTXFLG,0                                                       
         ZAP   SXDTRNUM,=PL8'0'                                                 
         ZAP   SXDTBNUM,=PL8'0'                                                 
         ZAP   SXDTMTOT,=PL8'0'                                                 
         MVI   SXDTFTYP,SXDTFTMQ                                                
         MVC   SXDTFCOD,EXFCODE                                                 
         MVC   SXDTFTIM,EXFTIME                                                 
         OC    SXDTFCOD,SXDTFCOD   DO WE HAVE A JCL OVERRIDE?                   
         BNZ   BXST134             USE THE OVERRIDE                             
         OC    GXSDFCOD,GXSDFCOD   FILTER ON EXTRACT FREQUENCY CODE             
         BZ    BXST200             IGNORE IF NOT SET                            
         MVC   SXDTFCOD,GXSDFCOD   SAVE EXTRACT FREQUENCY CODE & TIME           
BXST134  MVC   SXDTFTIM,GXSDFTIM                                                
         CLI   SXDTFCOD,GXSDFCNQ   FILTER ON EXTRACT FREQUENCY CODE             
         BE    BXST200                                                          
         CLI   MODE,DXPQRQ                                                      
         BNE   BXST138                                                          
         CLI   SXDTFCOD,GXSDFCPQ   FILTER ON PRINTQ MODE EXTRACT                
         BNE   BXST200                                                          
         B     BXST150                                                          
BXST138  EQU   *                                                                
         CLI   POSTONLY,C'Y'                                                    
         BE    BXST150                                                          
         CLI   MODE,DXLOADQ                                                     
         BE    BXST150                                                          
         CLI   MODE,DXSQLQ                                                      
         BE    BXST150                                                          
         CLI   MODE,DXSTATQ                                                     
         BE    BXST150                                                          
         CLI   MODE,DXSTATCSQ                                                   
         BE    BXST150                                                          
BXST140  CLI   DAILYFLG,OFF        FILTER ON DAILY UPDATE EXTRACT               
         BE    BXST142                                                          
         CLI   SXDTFCOD,GXSDFCDQ                                                
         BNE   BXST200                                                          
         B     BXST150                                                          
BXST142  CLI   SXDTFCOD,GXSDFCEQ   FILTER ON TIME PERIOD UPDATE EXTRACT         
         BNE   BXST200                                                          
         B     BXST150                                                          
*                                                                               
BXST150  EQU   *                                                                
         MVI   SXDTHDR,0                                                        
         CLI   HEADFLAG,C'N'                                                    
         BE    *+10                                                             
         MVC   SXDTHDR,GXSDHDR                                                  
         MVC   SXDTPSZ,APALLOCP                                                 
         MVC   SXDTSSZ,ASALLOCP                                                 
         OC    APALLOCP,APALLOCP                                                
         BNZ   BXST112                                                          
         OC    GXSDPSZ,GXSDPSZ                                                  
         BZ    *+10                                                             
         MVC   SXDTPSZ,GXSDPSZ                                                  
         OC    GXSDSSZ,GXSDSSZ                                                  
         BZ    *+10                                                             
         MVC   SXDTSSZ,GXSDSSZ                                                  
         B     BXST112             GET NEXT ELEMENT                             
         DROP  R3                                                               
                                                                                
*----------------------------------                                             
* PROCESS FILE GENERATION # ELEMENT                                             
*----------------------------------                                             
         USING GXGNEL,R3                                                        
BXST160  CLI   CLEARFLG,C'N'                                                    
         BE    BXST162                                                          
         CLI   ZEROFLG,C'N'                                                     
         BE    BXST162                                                          
         XC    GXGNNUM,GXGNNUM                                                  
         MVC   SXDTORGN,GXGNNUM                                                 
         B     BXST164                                                          
BXST162  MVC   SXDTORGN,GXGNNUM                                                 
         LA    RF,1                                                             
         CLC   GXGNNUM,=XL2'FFFF'                                               
         BE    *+12                                                             
BXST164  ICM   RF,3,GXGNNUM                                                     
         LA    RF,1(RF)                                                         
         STCM  RF,3,SXDTGNUM                                                    
         B     BXST112             GET NEXT ELEMENT                             
         DROP  R3                                                               
                                                                                
*----------------------------------                                             
* PROCESS PASSWORD ENCRYPT ELEMENT                                              
*----------------------------------                                             
         USING GXPCEL,R3                                                        
BXST170  MVC   SXDTEKEY,GXPCKEY                                                 
         B     BXST112             GET NEXT ELEMENT                             
         DROP  R3                                                               
                                                                                
*----------------------------------                                             
* PROCESS BDE CONTROL ELEMENT                                                   
*----------------------------------                                             
         USING GXBDEL,R3                                                        
BXST172  CLI   SENDFLAG,C'A'       ACC-BDE                                      
         BE    BXST174                                                          
         CLI   SENDFLAG,C'B'       BDE                                          
         BNE   BXST112                                                          
*                                                                               
         USING SXBDETD,R1                                                       
BXST174  ICM   R1,15,ASXBDET       BDE TABLE                                    
         XR    RE,RE               RE=A(BDE TABLE ENTRY)                        
         LHI   RF,SXBDEMAX         MAXIMUM BDE DESTINATIONS SUPPORTED           
BXST175  LTR   RE,RE               DO WE FIND AN EMPTY SLOT ALREADY?            
         BNZ   BXST176             YES: MOVE ON                                 
         CLI   SXBDEAGY,0          IS THIS ONE EMPTY?                           
         BNE   BXST176             NO                                           
         LR    RE,R1               YES: SAVE IT                                 
         B     BXST177                                                          
BXST176  CLC   SXBDEAGY,GXAKAGY    MATCH ON AGENCY                              
         BNE   BXST177                                                          
         CLC   SXBDESYS,GXAKSYS    MATCH ON SYSTEM                              
         BNE   BXST177                                                          
         CLC   SXBDESUB,GXAKSUB    MATCH ON SUBSYSTEM                           
         BE    BXST178                                                          
BXST177  AHI   R1,SXBDETL          MOVE TO NEXT SLOT IN BDE TABLE               
         BCT   RF,BXST175                                                       
         LTR   R1,RE                                                            
         JZ    *+2                 *NO ROOM IN BDE TABLE*                       
*                                                                               
BXST178  MVC   SXBDEAGY,GXAKAGY    AGENCY                                       
         MVC   SXBDESYS,GXAKSYS    SYSTEM                                       
         MVC   SXBDESUB,GXAKSUB    SUBSYSTEM                                    
         MVC   SXBDEEDI,GXBDEDI    BDE EDICT ID                                 
         MVC   SXBDEUIN,GXBDUIN    BDE PQ USER ID                               
         MVC   SXBDEFIL,GXBDFIL    BDE FILE NAME                                
         MVC   SXBDESBJ,GXBDSUB    BDE SUBJECT                                  
         B     BXST112             GET NEXT ELEMENT                             
         DROP  R1,R3                                                            
                                                                                
*----------------------------------                                             
* GET NEXT RECORD                                                               
*----------------------------------                                             
BXST180  LA    R4,SXDTABL(R4)      UPDATE SYSTEM DRIVER TABLE POINTERS          
         CLM   R4,15,=A(SXDTABX)                                                
         BNL   BXSTER4             ABEND - SXDTAB OVERFLOW                      
         ST    R4,SXDTPTR          AFTER ELEMENT PROCESSING                     
         LA    R6,1(R6)                                                         
         B     BXST300             GET NEXT RECORD                              
*                                                                               
BXST200  EQU   *                   CLEAR SYSTEM ENTRY AND GET NEXT              
         LR    RE,R4                                                            
         LA    RF,SXDTABL                                                       
         XCEF                                                                   
         B     BXST300                                                          
*                                                                               
BXST300  EQU   *                   GET NEXT XAGENCY RECORD                      
         B     BXSTLOOP                                                         
*                                                                               
BXSTEND  EQU   *                   HERE AFTER LAST XAGENCY RECORD               
         ST    R4,SXDTEND          SAVE SYSTEM DRIVER TABLE END POINTER         
         L     R4,ASXDTAB                                                       
         LA    R0,5                SORT TABLE TO GROUP SYSTEMS TOGETHER         
         LA    RF,SXDTABL                                                       
         GOTO1 VXSORT,DMCB,(X'00',(R4)),(R6),(RF),(R0),0                        
*                                                                               
         XC    SXDTFLSA,SXDTFLSA                                                
         XC    SXDTFLEA,SXDTFLEA                                                
*                                                                               
         BRAS  RE,BXSLUIDS                                                      
         BNE   BXSTNO                                                           
*                                                                               
         B     BXSTOK                                                           
*                                  ERROR CONDITIONS                             
BXSTER1  EQU   *                   INVALID SUB SYSTEM                           
         MVI   ERROR,ERINSUNQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         MVC   P(11),=C'SUBSYSTEM: '                                            
         GOTO1 VHEXOUT,DMCB,SUBSYS,P+11,1,=C'TOG'                               
         GOTO1 VPRINTER                                                         
         B     BXSTNO                                                           
BXSTER2  EQU   *                   ERROR IN GETACC AGY ACCESS ROUTINE           
*        MVI   ERROR,ERGETACQ                                                   
*        GOTO1 =A(ERRPRT),(RC)                                                  
         MVC   P(8),=C'AGENCY: '                                                
         MVC   P+8(L'AGYAID),AGYAID                                             
         MVC   P+20(40),=CL40'##ERROR## IN GETACC AGY ACCESS ROUTINE'           
         GOTO1 VPRINTER                                                         
         OC    AGYFILT,AGYFILT     TEST AGENCY FILTER                           
         BZ    BXST200             EXIT IF SPECIFIC AGENCY FILTER               
         B     BXSTNO                                                           
BXSTER3  EQU   *                   ERROR IN GETSYL SYSLIST READ ROUTINE         
         MVI   ERROR,ERGETSYQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         MVC   P(7),=C'SENUM: '                                                 
         GOTO1 VHEXOUT,DMCB,SENUM,P+7,1,=C'TOG'                                 
         MVC   P+20(8),=C'AGENCY: '                                             
         MVC   P+28(L'AGYAID),AGYAID                                            
         GOTO1 VPRINTER                                                         
         B     BXSTNO                                                           
BXSTER4  EQU   *                   SYSTABC TABLE OVERFLOW                       
         MVI   ERROR,ERSYSOVQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     BXSTNO                                                           
*                                                                               
BXSTNO   B     NO                  EXIT ERROR                                   
BXSTOK   B     YES                 EXIT OK                                      
         DROP  R2,R4                                                            
         EJECT                                                                  
***********************************************************************         
* BUILD SYSTEM EXTRACT DRIVER TABLE, SUB SYSTEM LM                    *         
***********************************************************************         
BXSYSLM  NTR1  ,                                                                
*                                                                               
*                                  NO LM FOR MODE=PQ/SQL/TRANS                  
         CLI   MODE,DXPQRQ         TEST IF EXTRACT MODE = PQ REPORT             
         BE    BXSLMOK                                                          
         CLI   MODE,DXSQLQ         TEST IF EXTRACT MODE = SQL ONLY              
         BE    BXSLMOK                                                          
         CLI   MODE,DXTRANSQ       TEST IF EXTRACT MODE = TRANS                 
         BE    BXSLMOK                                                          
*                                                                               
         MVI   MSGNUM,MSBXSLMQ                                                  
         GOTO1 =A(MSGPRT),(RC)                                                  
*                                                                               
         L     R4,ASXDTAB          POINT TO SYSTEM DRIVER TABLE                 
         USING SXDTABD,R4                                                       
*                                                                               
BXSLM10  C     R4,SXDTEND          EXIT IF END OF TABLE                         
         BE    BXSLM90             DONE - NOW RESET SUB-EX TABLE                
*                                                                               
         MVC   CUNTFLAG,SXDTCTRY   INITIALISE COUNTRY FLAG FOR 2 PASSES         
BXSLM20  L     R5,=A(SEXTAB)       GET EXTRACT LOAD MODULE                      
BXSLM30  CLI   0(R5),0                                                          
         BE    BXSLM50                                                          
         CLC   SEXCODE(1,R5),SXDTSCOD                                           
         BNE   BXSLM40                                                          
         CLC   SEXSUBS(1,R5),SXDTSUB                                            
         BNE   BXSLM40                                                          
         CLI   CUNTFLAG,X'FF'      FIRST PASS FOR COUNTRY MATCH                 
         BE    BXSLM80                                                          
         CLC   SEXCTRY(1,R5),SXDTCTRY                                           
         BE    BXSLM80                                                          
BXSLM40  LA    R5,L'SEXTAB(R5)                                                  
         B     BXSLM30                                                          
*                                                                               
BXSLM50  CLI   CUNTFLAG,X'FF'                                                   
*        BE    BXSLMER             EXIT WITH ERROR                              
         BNE   *+6                                                              
         DC    H'0'                                                             
         MVI   CUNTFLAG,X'FF'                                                   
         B     BXSLM20                                                          
*                                                                               
BXSLM80  EQU    *                                                               
         LA    RE,SEXEXT(R5)                                                    
         ST    RE,SXDTASEX         SAVE A(A(SUB-SYS EXTRACT PROGRAM))           
*                                                                               
         LA    R4,SXDTABL(R4)      NEXT ENTRY                                   
         B     BXSLM10                                                          
*                                                                               
BXSLM90  EQU   *                   RESET OPEN AND CLOSE FLAG                    
         L     R1,=A(SEXTAB)                                                    
BXSLM93  CLI   0(R1),0             END OF TABLE                                 
         BE    BXSLMOK             DONE                                         
         MVI   SEXEXFLG(R1),0                                                   
         LA    R1,L'SEXTAB(R1)                                                  
         B     BXSLM93                                                          
*                                                                               
BXSLMER  EQU   *                   MODULE NOT FOUND                             
         MVI   ERROR,ERLMNFQ                                                    
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     BXSLMNO                                                          
*                                                                               
BXSLMNO  B     NO                  EXIT ERROR                                   
BXSLMOK  B     YES                 EXIT OK                                      
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* BUILD SYSTEM EXTRACT DRIVER TABLE ESS SERVER LISTS                  *         
***********************************************************************         
         SPACE 1                                                                
BXSLUIDS NTR1  ,                                                                
         MVI   MSGNUM,MSBXSLSQ                                                  
         GOTO1 =A(MSGPRT),(RC)                                                  
*                                  USE CONTROL FILE DRIVER RECORDS              
         L     R4,ASXDTAB          POINT TO SYSTEM DRIVER TABLE                 
         USING SXDTABD,R4                                                       
         L     R5,ASLNEXT                                                       
         USING SXSLLSTD,R5                                                      
         LR    R6,R5                                                            
         MVC   SXSLLSTD(SXSLLSTL),SPACES                                        
*                                                                               
BXSL010  C     R4,SXDTEND          EXIT IF END OF TABLE                         
         BE    BXSLOK                                                           
         ST    R5,SXDTSLSA                                                      
*                                                                               
BXSL020  LA    R2,IOKEY            READ XSERVER DEFINITION RECORDS              
         USING GXTRD,R2                                                         
         XC    GXKEY,GXKEY         CLEAR RECORD KEY                             
         MVI   GXKREC,GXSARECQ     SET XSERVER RECORD TYPE                      
         MVC   GXSAAGY,SXDTAGY                                                  
         MVC   GXSASYS,SXDTSYS                                                  
         MVC   GXSASUB,SXDTSUB                                                  
         L     R2,ARECBUFF         READ HIGH FOR FIRST RECORD                   
*                                                                               
         GOTO1 VDATAMGR,DMCB,(X'24',DMRDHI),GENDIR,IOKEY,(R2),DMWORK            
         TM    8(R1),X'FF'-X'80'   ONLY ALLOW EOF ERROR                         
         BZ    *+6                                                              
         DC    H'0'                DATAMANAGER RETURN NOT 0 OR EOF              
         CLI   8(R1),0                                                          
         BNE   BXSL500             EOF                                          
         CLC   GXKEY(GXSAEID-GXKEY),IOKEY                                       
         BNE   BXSL500                                                          
         OC    ESSID,ESSID                                                      
         BZ    *+14                                                             
         CLC   GXSAEID,ESSID                                                    
         BNE   BXSLNEXT                                                         
         OC    GXSAAPID,GXSAAPID                                                
         BZ    BXSLTRAN                                                         
         B     BXSLNEXT                                                         
*                                  GET NEXT POINTER IN SEQUENCE                 
BXSLNEXT EQU   *                   READ SEQN WITH FLUSH                         
         GOTO1 VDATAMGR,DMCB,(X'24',DMRSEQ),GENDIR,IOKEY,(R2),DMWORK            
         TM    8(R1),X'FF'-X'80'   ONLY ALLOW EOF ERROR                         
         BZ    *+6                                                              
         DC    H'0'                DATAMANAGER RETURN NOT 0 OR EOF              
         CLI   8(R1),0                                                          
         BNE   BXSL500                                                          
         CLC   GXKEY(GXSAEID-GXKEY),IOKEY                                       
         BNE   BXSL500                                                          
         OC    ESSID,ESSID                                                      
         BZ    *+14                                                             
         CLC   GXSAEID,ESSID                                                    
         BNE   BXSLNEXT                                                         
         OC    GXSAAPID,GXSAAPID                                                
         BNZ   BXSLAPAR                                                         
         BZ    BXSLTRAN                                                         
*                                                                               
*        PROCESS SERVER TRANSFER CONTROL RECORD                                 
*                                                                               
BXSLTRAN EQU   *                                                                
         XC    IOKEYSV,IOKEYSV     CLEAR PREVIOUS KEY FOR EACH PASS             
         TM    GXDCTL+1,GXCTINQ    IGNORE IF INHIBIT MODE FLAG SET              
         BNZ   BXSLNEXT                                                         
         MVC   IOKEYSV,GXKEY                                                    
         LR    R5,R6                                                            
         LA    R6,SXSLAPAR                                                      
         OC    ESSID,ESSID         TEST ESSID FILTER                            
         BZ    *+14                                                             
         CLC   ESSID,GXSAEID                                                    
         BNE   BXSLNEXT                                                         
         MVC   SXSLEID,GXSAEID                                                  
         MVI   SXSLANUM,0                                                       
         MVC   DMDA,GXDDA                                                       
*                                  GETREC WITH FLUSH                            
         GOTO1 VDATAMGR,DMCB,(X'24',GETREC),GENFIL,DMDA,(R2),DMWORK             
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                CAN'T FIND RECORD                            
*                                                                               
         LA    R3,GXFIRST(R2)      PROCESS ELEMENT DATA                         
         USING GXSTEL,R3                                                        
*                                                                               
BXSL100  CLI   GXSTEL,0                                                         
         BE    BXSLNEXT                                                         
         CLI   GXSTEL,GXSTELQ      FIND TRANSFER CONTROL ELEMENT                
         BE    BXSL120                                                          
BXSL110  SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     BXSL100                                                          
*                                                                               
BXSL120  EQU   *                   PROCESS TRANSFER CONTROL ELEMENT             
         MVC   SXSLFCOD,GXSTFCOD                                                
         MVC   SXSLFTIM,GXSTFTIM                                                
         MVC   SXSLMODE,GXSTMODE                                                
         MVC   SXSLPLFM,=CL8'SYBASE'                                            
         MVI   SXSLLOAD,0                                                       
         CLI   REPLFLAG,C'Y'                                                    
         BE    BXSL126                                                          
         CLI   CLEARFLG,C'N'                                                    
         BE    BXSL121                                                          
         MVI   SXSLLOAD,C'1'                                                    
         B     BXSL126                                                          
BXSL121  CLI   MODE,DXLOADQ                                                     
         BE    BXSL121A                                                         
         B     BXSL126                                                          
BXSL121A CLI   LOADCON,0                                                        
         BE    BXSL122                                                          
         MVC   SXSLLOAD,LOADCON                                                 
         B     BXSL126                                                          
BXSL122  CLI   GXSTELL,GXSTELLQ                                                 
         BL    BXSL126                                                          
         CLI   GXSTLOAD,C'0'                                                    
         BE    BXSL124                                                          
         CLI   GXSTLOAD,C'1'                                                    
         BE    BXSL124                                                          
         CLI   GXSTLOAD,C'2'                                                    
         BE    BXSL124                                                          
         B     BXSL126                                                          
BXSL124  MVC   SXSLLOAD,GXSTLOAD                                                
BXSL126  EQU   *                                                                
         CLI   CLEARFLG,C'N'                                                    
         BE    BXSL128                                                          
         CLI   ZEROFLG,C'N'                                                     
         BE    BXSL128                                                          
         XC    GXSTCRFN,GXSTCRFN                                                
         B     BXSL129                                                          
BXSL128  LA    RF,1                                                             
         CLC   GXSTCRFN,=XL2'FFFF'                                              
         BE    *+12                                                             
BXSL129  ICM   RF,3,GXSTCRFN                                                    
         LA    RF,1(RF)                                                         
         STCM  RF,3,SXSLFNUM                                                    
         B     BXSLNEXT                                                         
*                                                                               
*        PROCESS SERVER APPLICATION CONTROL RECORD                              
*                                                                               
         USING SXSLAPAR,R6                                                      
BXSLAPAR EQU   *                                                                
         TM    GXDCTL+1,GXCTINQ    IGNORE IF INHIBIT MODE FLAG SET              
         BNZ   BXSLNEXT                                                         
         CLC   GXKEY(GXSAAPID-GXKEY),IOKEYSV                                    
         BNE   BXSLNEXT            ONLY PROCESS IF XTRANS RECORD FOUND          
         MVC   DMDA,GXDDA                                                       
*                                  GETREC WITH FLUSH                            
         GOTO1 VDATAMGR,DMCB,(X'24',GETREC),GENFIL,DMDA,(R2),DMWORK             
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                CAN'T FIND RECORD                            
*                                                                               
         MVC   SXSLAPAR(SXSLAPAL),SPACES                                        
         MVC   SXSLSKEY,GXSAAPID                                                
         MVC   SXSLPROG,=CL32'TRANS.EXE'                                        
         LA    R3,GXFIRST(R2)      PROCESS ELEMENT DATA                         
*                                                                               
BXSL200  CLI   0(R3),0                                                          
         BE    BXSL300                                                          
         CLI   0(R3),GXAPELQ       FIND APPLICATION CONTROL ELEMENT             
         BE    BXSL220                                                          
         CLI   0(R3),GXPRELQ       FIND PROGRAM ELEMENT                         
         BE    BXSL230                                                          
BXSL210  SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     BXSL200                                                          
*                                                                               
         USING GXAPEL,R3                                                        
BXSL220  EQU   *                   PROCESS APPLICATION CONTROL ELEMENT          
         OC    GXAPSNAM,GXAPSNAM                                                
         BZ    *+10                                                             
         MVC   SXSLSNAM,GXAPSNAM                                                
         OC    GXAPDBNM,GXAPDBNM                                                
         BZ    *+10                                                             
         MVC   SXSLDBNM,GXAPDBNM                                                
         OC    GXAPUSER,GXAPUSER                                                
         BZ    *+10                                                             
         MVC   SXSLUSER,GXAPUSER                                                
         OC    GXAPPASS,GXAPPASS                                                
         BZ    *+10                                                             
         MVC   SXSLPASS,GXAPPASS                                                
         B     BXSL210                                                          
*                                                                               
         USING GXPREL,R3                                                        
BXSL230  EQU   *                   PROCESS APPLICATION CONTROL ELEMENT          
         OC    GXPRNAME,GXPRNAME                                                
         BZ    BXSL232                                                          
         CLC   GXPRNAME,SPACES                                                  
         BE    BXSL232                                                          
         MVC   SXSLPROG,GXPRNAME                                                
*                                                                               
BXSL232  CLI   MODEPQL,C'Y'        MODE=PQ W/ LOAD OPTION?                      
         BE    BXSL234             YES, USE LOAD COMMAND LINE                   
         CLI   MODE,DXLOADQ                                                     
         BE    BXSL234                                                          
         CLI   GXPRELL,GXPRELLQ                                                 
         BL    BXSL234                                                          
         OC    GXPRUCOM,GXPRUCOM                                                
         BZ    BXSL210                                                          
         CLC   GXPRUCOM,SPACES                                                  
         BE    BXSL210                                                          
         MVC   SXSLPARM,GXPRUCOM                                                
         B     BXSL210                                                          
*                                                                               
BXSL234  OC    GXPRLCOM,GXPRLCOM                                                
         BZ    BXSL210                                                          
         CLC   GXPRLCOM,SPACES                                                  
         BE    BXSL210                                                          
         MVC   SXSLPARM,GXPRLCOM                                                
         B     BXSL210                                                          
*                                                                               
BXSL300  CLC   ESSPROG,SPACES      DEAL WITH PARM OVERRIDES                     
         BE    *+10                                                             
         MVC   SXSLPROG,ESSPROG                                                 
         CLC   ESSCMND,SPACES                                                   
         BE    *+10                                                             
         MVC   SXSLPARM,ESSCMND                                                 
         CLC   SXDTEKEY,SPACES                                                  
         BE    BXSL330                                                          
         OC    SXDTEKEY,SXDTEKEY                                                
         BZ    BXSL330                                                          
         LA    RF,SXSLPARM                                                      
         LA    RE,SXSLPARM                                                      
         LA    R0,L'SXSLPARM                                                    
BXSL310  CLC   0(L'SXDTEKEY+3,RF),SPACES                                        
         BE    BXSL320                                                          
         LA    RF,1(RF)                                                         
         BCT   R0,BXSL310                                                       
BXSL320  CLM   R0,1,=AL1(L'SXDTEKEY+3)                                          
         BL    BXSL330                                                          
         CR    RF,RE                                                            
         BE    *+8                                                              
         LA    RF,1(RF)                                                         
         MVI   0(RF),C'-'                                                       
         MVI   1(RF),X'92'                                                      
         LA    RF,2(RF)                                                         
         MVC   0(L'SXDTEKEY,RF),SXDTEKEY                                        
BXSL330  SR    RF,RF                                                            
         IC    RF,SXSLANUM                                                      
         LA    RF,1(RF)                                                         
         STC   RF,SXSLANUM                                                      
         LA    R6,SXSLAPAL(R6)                                                  
         CLM   R6,15,=A(SLLISTX)                                                
         BNL   BXSLER1             ABEND IF SLLIST OVERFLOW                     
         B     BXSLNEXT                                                         
*                                                                               
BXSL500  ST    R6,SXDTSLEA         UPDATE SYSTEM DRIVER TABLE POINTERS          
         LA    R4,SXDTABL(R4)                                                   
         LR    R5,R6                                                            
         B     BXSL010                                                          
*                                                                               
BXSLEND  ST    R6,ASLNEXT                                                       
         B     BXSLOK                                                           
*                                                                               
BXSLER1  EQU   *                   SLLIST TABLE OVERFLOW                        
         MVI   ERROR,ERSYLOVQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     BXSLNO                                                           
*                                                                               
BXSLNO   B     NO                  EXIT ERROR                                   
BXSLOK   B     YES                 EXIT OK                                      
         DROP  R2,R3,R4,R5,R6                                                   
         EJECT                                                                  
***********************************************************************         
* BUILD SINGLE SYSTEM EXTRACT TABLE ENTRY FROM INPUT PARAMETER CARDS  *         
***********************************************************************         
         SPACE 1                                                                
SINGLES  NTR1  ,                                                                
         L     R4,ASXDTAB                                                       
         USING SXDTABD,R4                                                       
         MVC   SXDTAGY,AGYFILT                                                  
         MVC   SXDTSYS,SYSFILT                                                  
         MVC   SXDTSUB,SUBFILT                                                  
         MVC   SXDTSUBC,SUBCHAR                                                 
         MVC   SXDTVER,VERNUM                                                   
         MVC   AGYAID,AGYFILT                                                   
         MVC   SYSTEM,SYSFILT                                                   
         MVC   SUBSYS,SUBFILT                                                   
         XC    AGYSAVE,AGYSAVE                                                  
         XC    SVFLAG,SVFLAG                                                    
         MVC   SXDTSAGY,SXDTAGY                                                 
         GOTO1 =A(GETACC),(RC)     GET DATA FROM AGENCY ACCESS RECORD           
         BE    *+6                                                              
         DC    H'00'                                                            
         CLC   AGYSAVE,SPACES                                                   
         BNH   *+10                                                             
         MVC   SXDTSAGY,AGYSAVE                                                 
         TM    SVFLAG,SVFUATQ                                                   
         BZ    *+8                                                              
         OI    SXDTFLG2,SXDTUATQ                                                
         MVC   SXDTSEN,SENUM                                                    
         MVC   SXDTAGB,AGYBIN                                                   
         MVC   SXDTPIN,AGYPIN                                                   
         MVC   SXDTCTRY,AGYCNTRY                                                
         GOTO1 =A(GETSYL),(RC)     GET DATA FROM SYSLIST SYSTEM RECORD          
         BE    *+6                                                              
         DC    H'00'                                                            
         MVC   SXDTSCOD,SYSCODE                                                 
         MVC   SXDTSCHR,SYSCHAR                                                 
         MVC   SXDTSLNM,SYSLNAM                                                 
         MVC   SXDTPLFM,PLATFORM                                                
         MVC   SXDTFLT1(3),XFILTERS                                             
         MVC   SXDTTYP,EXTYPE                                                   
         MVI   SXDTXFLG,0                                                       
         ZAP   SXDTRNUM,=PL8'0'                                                 
         ZAP   SXDTBNUM,=PL8'0'                                                 
         ZAP   SXDTMTOT,=PL8'0'                                                 
         MVI   SXDTFTYP,SXDTFTMQ                                                
         MVC   SXDTFCOD,EXFCODE                                                 
         MVC   SXDTFTIM,EXFTIME                                                 
         CLI   HEADFLAG,C'N'                                                    
         BE    *+8                                                              
         OI    SXDTHDR,X'01'                                                    
         MVC   SXDTPSZ,APALLOCP                                                 
         MVC   SXDTSSZ,ASALLOCP                                                 
         CLI   HOSTDB,C'Y'                                                      
         BE    SING100                                                          
*                                                                               
         L     R5,ASLNEXT                                                       
         USING SXSLLSTD,R5                                                      
         ST    R5,SXDTSLSA                                                      
         LA    R6,SXSLAPAR                                                      
         USING SXSLAPAR,R6                                                      
         MVC   SXSLPLFM,PLATFORM                                                
         MVC   SXSLLOAD,LOADCON                                                 
         MVC   SXSLEID,ESSID                                                    
         XC    SXSLFNUM,SXSLFNUM                                                
         MVC   SXSLFNUM,=XL2'0001'                                              
         MVI   SXSLANUM,1                                                       
         MVI   SXSLFCOD,C'L'                                                    
         MVI   SXSLMODE,C'L'                                                    
         XC    SXSLFTIM,SXSLFTIM                                                
         MVC   SXSLSKEY,APPLKEY                                                 
         XC    SXSLPROG,SXSLPROG                                                
         XC    SXSLPARM,SXSLPARM                                                
         MVC   SXSLSNAM,SERVERID                                                
         MVC   SXSLDBNM,DATABASE                                                
         MVC   SXSLUSER,SQLUSER                                                 
         MVC   SXSLPASS,PASSWORD                                                
         LA    R6,SXSLAPAL(R6)                                                  
         ST    R6,SXDTSLEA                                                      
         ST    R6,ASLNEXT                                                       
*                                                                               
         LA    R4,SXDTABL(R4)      JUST THE ONE TABLE ENTRY                     
         ST    R4,SXDTEND                                                       
         B     SINGOK                                                           
*                                                                               
SING100  EQU   *                                                                
         L     R5,ADBNEXT                                                       
         USING SXDBLSTD,R5                                                      
         ST    R5,SXDTDBSA                                                      
* ??     MVC   SXDBID,HDBID                                                     
         MVC   SXDBAUTH,DB2AUTH                                                 
         MVC   SXDBLOCN,DB2LOCN                                                 
         LA    R5,SXDBLSTL(R5)                                                  
         ST    R5,SXDTDBEA                                                      
         ST    R5,ADBNEXT                                                       
*                                                                               
         L     R5,ASXDBNXT                                                      
         USING SXDBEXTD,R5                                                      
         ST    R5,SXDTDBXT                                                      
*                                                                               
         LA    R5,SXDBEXTL(R5)                                                  
         ST    R5,ASXDBNXT                                                      
*                                                                               
         LA    R4,SXDTABL(R4)      JUST THE ONE TABLE ENTRY                     
         ST    R4,SXDTEND                                                       
         B     SINGOK                                                           
*                                                                               
SINGNO   B     NO                                                               
SINGOK   B     YES                                                              
         DROP  R4,R5,R6                                                         
         EJECT                                                                  
***********************************************************************         
* SET POINTERS TO NEXT SYSTEM GROUP IN SYSTEM EXTRACT DRIVER TABLE    *         
***********************************************************************         
         SPACE 1                                                                
SETSTPTR NTR1  ,                                                                
         L     RF,SXDTNXT          A(NEXT SYSTEM GROUP IN TABLE)                
         USING SXDTABD,RF                                                       
         C     RF,SXDTEND          EXIT IF END OF TABLE                         
         BE    SSTPNO                                                           
         MVC   SYSTEM,SXDTSYS      SAVE VALUES FOR NEXT SYSTEM                  
         MVC   SENUM,SXDTSEN                                                    
         MVC   SYSCODE,SXDTSCOD                                                 
         MVC   SUBSYS,SXDTSUB                                                   
         MVC   SUBCHAR,SXDTSUBC                                                 
         MVC   SYSCTRY,SXDTCTRY                                                 
         ST    RF,SXDTPTR          A(FIRST TABLE ENTRY FOR THIS SYSTEM)         
         CLI   MODE,DXUPDTQ        IF EXTRACT MODE <> UPDATE THEN ONLY          
         BNE   SSTP012             DO ONE SUB SYSTEM AT A TIME                  
*                                  ELSE DO ALL SUBSYSTEMS PER SENUM             
SSTP010  CLC   SENUM,SXDTSEN                                                    
         BNE   SSTP020                                                          
         LA    RF,SXDTABL(RF)                                                   
         B     SSTP010                                                          
*                                                                               
SSTP012  LA    RF,SXDTABL(RF)                                                   
*                                                                               
SSTP020  ST    RF,SXDTNXT          SAVE A(NEXT SYSTEM IN TABLE)                 
         B     SSTPOK                                                           
*                                                                               
SSTPNO   B     NO                  EXIT END OF TABLE                            
SSTPOK   B     YES                 EXIT OK                                      
         DROP  RF                                                               
         EJECT                                                                  
***********************************************************************         
* SET UP SYSTEM EXTRACT MODULE CONTROL DATA BLOCK                     *         
***********************************************************************         
         SPACE 1                                                                
SEXSYS   NTR1  ,                                                                
*                                                                               
         L     R4,ADXBLOCK         A(DATA BLOCK)                                
         USING DXBLOCKD,R4                                                      
*                                                                               
         MVC   DXWRITE,WRITE                                                    
         MVC   DXMAXREC,MAXRECS                                                 
         MVC   DXCOMMAX,COMMAX                                                  
         MVC   DXDAFORM,DATEFORM                                                
         MVC   DXCLI,CLIENT                                                     
         MVC   DXCLIS,CLIENTS                                                   
         MVC   DXCLIE,CLIENTE                                                   
         MVC   DXNET,NETWORK                                                    
         MVC   DXKEY,KEYFIT                                                     
*                                  COPY COMFACS TO COMFAC2                      
         LARL  RE,COMFAC2                                                       
         STCM  RE,15,DXCOMFAC      PASS A(COMFAC2) TO SUBSYS PROGRAM            
         LHI   RF,CCFACLEN-CFACSTRT                                             
         L     R0,ACOMFACS                                                      
         LR    R1,RF                                                            
         MVCL  RE,R0                                                            
*                                                                               
         CLI   FUADFLG,C'Y'        FILTUAD=Y?                                   
         BNE   *+8                                                              
         OI    DXFLAGS,DXFFUAD                                                  
*                                                                               
         CLI   AAGYFLAG,C'Y'       ALLAGY=Y?                                    
         BNE   SSYS005                                                          
         OI    DXFLAGS,DXFAAGY     EXTRACT FOR ALL AGENIES                      
         CLC   EXTYPE,=CL3'IDK'    THIS IS ONLY ALLOWED FOR                     
         JNE   *+2                 IDK EXTRACT NOW                              
*                                                                               
SSYS005  L     RF,=V(DDSIO)        RF=A(CL8'DDSIO') IN DMDMGRL                  
         MVC   DXDDSIO,0(RF)       PASS DDSIO NAME TO OVERLAYS                  
         L     RF,=V(ADDSIO)       RF=A(A(DDSIO)) IN DMDMGRL                    
         MVC   DXADDSIO,0(RF)      PASS A(DDSIO) TO OVERLAYS                    
         L     RF,=A(SSB)                                                       
         MVC   DXDSPAC,SSODSPAC-SSOOFF(RF)                                      
         STCM  RF,15,DXSSB         PASS A(SSB) TO OVERLAYS                      
*                                                                               
         L     RF,=A(PUTXREC)                                                   
         STCM  RF,15,DXPUT                                                      
*                                                                               
         L     RF,=V(DXCNVX)                                                    
         STCM  RF,15,DXCNV                                                      
*                                                                               
         MVC   DXSTSPTR,SXDTPTR                                                 
         MVC   DXSTEPTR,SXDTNXT                                                 
*                                                                               
         MVC   DXCENT,CENTURY                                                   
         MVC   DXDATEN,DATEN                                                    
         MVC   DXDATENC,DATENC                                                  
         OC    TIMENOW,TIMENOW                                                  
         BZ    *+14                                                             
         MVC   DXTIMEN,TIMENOW                                                  
         B     *+10                                                             
         MVC   DXTIMEN,TIMEN                                                    
         MVC   DXFDATEP,XFDATEP                                                 
         MVC   DXTDATEP,XTDATEP                                                 
         MVC   DXFDATEC,XFDATEC                                                 
         MVC   DXTDATEC,XTDATEC                                                 
         MVC   DXJOBNAM,JOBNAME                                                 
         MVC   DXJDATE,JDATE                                                    
         MVC   DXJTIME,JTIME                                                    
*                                                                               
         MVI   DXACTION,C'L'                                                    
*                                                                               
         MVC   DXARECB,ASYSREC                                                  
         MVC   DXACPYB,ACPYBUFF                                                 
         MVC   DXAXREC,AXREC                                                    
         MVC   DXASQLB,ASQLBUFF                                                 
*                                                                               
         MVC   DXSYSTEM,SYSTEM                                                  
         MVC   DXSENUM,SENUM                                                    
         MVC   DXSYSCOD,SYSCODE                                                 
         MVC   DXSUBSYS,SUBSYS                                                  
*                                                                               
         MVC   DXUSER,SPACES                                                    
         MVC   DXEORSTR,SPACES                                                  
         MVC   DXEORLEN,SPACES                                                  
         MVC   DXTXTCOD,TEXTCODE                                                
         MVC   DXNULCOD,NULLCODE                                                
         MVC   DXMONCOD,MONYCODE                                                
         MVC   DXESCAPE,ESCODE                                                  
         MVC   DXDELIM,DELIM                                                    
         MVC   DXNLIFCD,NULLIFCD                                                
         MVC   DXTRANS,TRANSCOD                                                 
         MVC   DXFIXED,FIXEDFLG                                                 
         MVC   DXFORMAT,FORMCODE                                                
         CLI   VCHARFLG,C'N'                                                    
         BNE   *+8                                                              
         OI    DXFORMAT,DXTFVNOQ                                                
         CLI   QUOTEFLG,C'Y'                                                    
         BNE   *+8                                                              
         OI    DXFORMAT,DXTFQUOQ                                                
         MVC   DXERROR,ERRFLG                                                   
*                                                                               
         MVC   DXUSER,USERPARM                                                  
         MVC   DXTSTRUN,TSTRUN                                                  
         MVC   DXAGXBUF,AGXBUF                                                  
         MVC   DXDBSSYS,DB2SSYS                                                 
* ??     MVC   DXDBID,HDBID                                                     
         MVC   DXDBAUTH,DB2AUTH                                                 
         MVC   DXDBLOCN,DB2LOCN                                                 
*                                                                               
         XC    DXFTIME,DXFTIME                                                  
         XC    DXTTIME,DXTTIME                                                  
         GOTO1 TIMEDIFF,DMCB,TIMEND,EXTRATIM,DXTTIME                            
         OC    FFTIME,FFTIME                                                    
         BZ    *+10                                                             
         MVC   DXFTIME,FFTIME                                                   
         OC    FTTIME,FTTIME                                                    
         BZ    *+10                                                             
         MVC   DXTTIME,FTTIME                                                   
*                                                                               
         XC    DXFDA,DXFDA                                                      
         XC    DXTDA,DXTDA                                                      
         MVI   DXRTEXT,0                                                        
         LA    R0,DXRTMAX                                                       
         LA    RE,DXRTTAB                                                       
         XC    0(DXRTTLN,RE),0(RE)                                              
         LA    RE,DXRTTLN(RE)                                                   
         BCT   R0,*-10                                                          
         DROP  R4                                                               
*                                                                               
         CLI   MODE,DXPQRQ         TEST IF EXTRACT MODE = PQ REPORT             
         BE    SSYSOK                                                           
         CLI   MODE,DXSQLQ         TEST IF EXTRACT MODE = SQL ONLY              
         BE    SSYSOK                                                           
         CLI   MODE,DXTRANSQ       TEST IF EXTRACT MODE = TRANS                 
         BE    SSYSOK                                                           
*                                                                               
         MVC   CUNTFLAG,SYSCTRY    LOAD PROGRAM WITH COUNTRY CODE 1ST           
         MVI   LOADFLAG,C'N'       NOT YET LOADED                               
         L     R2,=A(SEXTAB)       GET EXTRACT LOAD MODULE                      
SSYS020  CLI   0(R2),0                                                          
         BE    SSYS035                                                          
         CLC   SEXCODE(1,R2),SYSCODE    DO FOR ALL SAME SYSTEM                  
         BNE   SSYS030                                                          
         CLC   SEXCTRY(1,R2),SYSCTRY                                            
         BNE   SSYS030                                                          
*                                                                               
         OC    SUBFILT,SUBFILT          ANY SUB-SYSTEM FILTER GIVEN?            
         BZ    SSYS022                  NO - SKIP SUBSYS CHECK                  
*                                                                               
         CLC   SEXSUBS(1,R2),SUBSYS     YES - ONLY LOAD THIS SUBSYS             
         BNE   SSYS030                                                          
         B     SSYS024                                                          
*                                                                               
SSYS022  DS    0H                                                               
         BRAS  RE,ISNOLOAD         TEST IF PHASE IS A NO-LOAD                   
         BE    SSYS030             IT IS: SKIP LOADSUB                          
*                                                                               
SSYS024  DS    0H                                                               
         BRAS  RE,LOADSUB          LOAD PROGRAM                                 
         MVI   LOADFLAG,C'Y'       LOADED ALREADY FOR THAT CNTRY                
SSYS030  LA    R2,L'SEXTAB(R2)                                                  
         B     SSYS020                                                          
*                                                                               
SSYS035  EQU   *                                                                
         CLI   LOADFLAG,C'Y'       LOADED ALREADY FOR THAT CNTRY?               
         BE    SSYS070             YES - EXIT                                   
*                                                                               
SSYS040  EQU   *                   LOAD PROGRAM W/O COUNTRY CODE                
         L     R2,=A(SEXTAB)       GET EXTRACT LOAD MODULE                      
SSYS050  CLI   0(R2),0                                                          
         BE    SSYS070                                                          
         CLC   SEXCODE(1,R2),SYSCODE    DO FOR ALL SAME SYSTEM                  
         BNE   SSYS060                                                          
*                                                                               
         OC    SUBFILT,SUBFILT          ANY SUB-SYSTEM FILTER GIVEN?            
         BZ    SSYS052                  NO - SKIP SUBSYS CHECK                  
*                                                                               
         CLC   SEXSUBS(1,R2),SUBSYS     YES - ONLY LOAD THIS SUBSYS             
         BNE   SSYS060                                                          
         B     SSYS054                                                          
*                                                                               
SSYS052  DS    0H                                                               
         BRAS  RE,ISNOLOAD         TEST IF PHASE IS A NO-LOAD                   
         BE    SSYS060             IT IS: SKIP LOADSUB                          
*                                                                               
SSYS054  DS    0H                                                               
         BRAS  RE,LOADSUB          LOAD PROG IF NOT ALREADY LOADED              
SSYS060  LA    R2,L'SEXTAB(R2)                                                  
         B     SSYS050                                                          
*                                                                               
SSYS070  B     SSYSOK                                                           
*                                                                               
SSYSNO   B     NO                                                               
SSYSOK   B     YES                                                              
         EJECT                                                                  
***********************************************************************         
* LOAD THE SUB-SYSTEM EXTRACT PROGRAM                                 *         
*INPUT: R2=A(CURRENT SUB-SYSTEM EXTRACT TABLE ENTRY)                  *         
***********************************************************************         
LOADSUB  NTR1  ,                                                                
*                                                                               
         ICM   R0,15,SEXEXT(R2)    ALREADY LOADED?                              
         BNZ   LDSUBX              YES-EXIT                                     
         MVC   WORK,SPACES                                                      
         LA    R3,WORK                                                          
*                                                                               
         OC    LOADPHS,LOADPHS     PHASE OVERRIDE ENTERED?                      
         BZ    LDSUB10                                                          
         MVC   SEXNAME(8,R2),LOADPHS                                            
         MVC   0(8,R3),LOADPHS                                                  
         B     LDSUB60                                                          
*                                                                               
LDSUB10  DS    0H                                                               
         MVC   0(8,R3),SEXNAME(R2)                                              
         CLI   TESTCHAR,C' '                                                    
         BE    LDSUB60                                                          
*                                                                               
         LR    RF,R3                                                            
         LA    R0,8                                                             
LDSUB20  CLI   0(RF),C' '                                                       
         BE    LDSUB30                                                          
         LA    RF,1(RF)                                                         
         BCT   R0,LDSUB20                                                       
         BCTR  RF,0                                                             
LDSUB30  MVC   0(1,RF),TESTCHAR                                                 
         LOAD  EPLOC=(3),ERRET=LDSUB50                                          
         B     LDSUB70                                                          
LDSUB50  EQU   *                   LOAD TEST PRG FAILED, CHECK ERROR            
         CHI   R1,X'0806'          MISSING TEST PROGRAM                         
         BE    *+6                 TRY RELOAD LIVE PROGRAM                      
         DC    H'0'                                                             
*&&DO                                                                           
*                                  EMAIL WARNING                                
         MVC   P,SPACES                                                         
         LA    RE,P                                                             
         MVC   0(9,RE),=CL9'AUTONOTE*'                                          
         AHI   RE,9                                                             
         MVC   0(40,RE),EMAILADR                                                
         AHI   RE,39                                                            
         CLI   0(RE),C' '                                                       
         BNE   *+8                                                              
         BCT   RE,*-8                                                           
         AHI   RE,1                                                             
*                                                                               
         MVI   0(RE),C':'                                                       
         AHI   RE,1                                                             
         MVC   0(22,RE),=CL22'MISSING TEST PROGRAM -'                           
         AHI   RE,22                                                            
         MVC   0(8,RE),0(R3)                                                    
         GOTO1 VDATAMGR,DMCB,=C'OPMSG',(L'P,P)                                  
*&&                                                                             
*                                                                               
         MVC   0(8,R3),SEXNAME(R2) TRY RELOAD LIVE PROGRAM                      
*                                                                               
LDSUB60  EQU    *                  LOAD LIVE PROGRAM                            
         LOAD  EPLOC=(3),ERRET=LDSUB65                                          
         B     LDSUB70                                                          
*                                                                               
LDSUB65  EQU   *                   LOAD PROG FAILED, CHECK ERROR                
         CHI   R1,X'0806'          MISSING LIVE PROGRAM                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                  EMAIL WARNING                                
         MVC   P,SPACES                                                         
         LA    RE,P                                                             
         MVC   0(9,RE),=CL9'AUTONOTE*'                                          
         AHI   RE,9                                                             
         MVC   0(40,RE),EMAILADR                                                
         AHI   RE,39                                                            
         CLI   0(RE),C' '                                                       
         BNE   *+8                                                              
         BCT   RE,*-8                                                           
         AHI   RE,1                                                             
*                                                                               
         MVI   0(RE),C':'                                                       
         AHI   RE,1                                                             
         MVC   0(22,RE),=CL22'MISSING LIVE PROGRAM -'                           
*                                                                               
         OC    LOADPHS,LOADPHS     PHASE OVERRIDE ENTERED?                      
         BZ    *+10                                                             
         MVC   0(22,RE),=CL22'MISSING PGM OVERRIDE -'                           
*                                                                               
         AHI   RE,22                                                            
         MVC   0(8,RE),0(R3)                                                    
         GOTO1 VDATAMGR,DMCB,=C'OPMSG',(L'P,P)                                  
         DC    H'0'                                                             
*                                                                               
LDSUB70  EQU   *                   MARK ALL ENTRIES WITH PROGRAM NAME           
         LR    R4,R0               R4=ADDR                                      
         LR    R5,R1               R5=LENGTH                                    
         SLL   R5,8                SHIFT OFF HIGH ORDER BYTE                    
         SRL   R5,5                TIMES 8 (LEN WAS IN DOUBLEWORDS)             
*                                                                               
         STCM  R4,15,SEXEXT(R2)    LOAD ADDRESS TO CURRENT ENTRY                
         L     R1,=A(SEXTAB)                                                    
LDSUB80  CLI   0(R1),0             END OF TABLE                                 
         BE    LDSUB90             DONE                                         
         OC    SEXEXT(4,R1),SEXEXT(R1)    LOADED?                               
         BNZ   LDSUB85                    YES - NEXT                            
         CLC   SEXNAME(8,R2),SEXNAME(R1)  SAME PROGRAM NAME?                    
         BNE   LDSUB85                    NO - NEXT                             
         STCM  R0,15,SEXEXT(R1)           YES - SAVE ADDRESS                    
LDSUB85  LA    R1,L'SEXTAB(R1)                                                  
         B     LDSUB80                                                          
LDSUB90  EQU    *                                                               
*                                                                               
*XXXXXX* LOADED AT XXXXXX, LENGTH=NNNNNNNN, MEMORY LEFT=NNNNNNNN                
*                                                                               
         MVC   P,SPACES                                                         
         MVC   P(8),0(R3)          ACTUAL LOAD NAME (IN WORK)                   
         MVC   P+9(9),=C'LOADED AT'                                             
         ST    R4,FULL             R0=LOAD ADDRESS                              
         GOTOR VHEXOUT,DMCB,FULL+1,P+19,3,0                                     
         MVC   P+25(9),=C', LENGTH='                                            
         EDIT  (R5),(8,P+34),ZERO=NOBLANK,FILL=0                                
         MVC   P+42(14),=C', MEMORY LEFT='                                      
         GOTO1 VCOVAIL,DMCB,C'LOOK'                                             
         CLC   DMCB+4,=F'0'                                                     
         BNE   *+6                                                              
         DC    H'0'                                                             
         L     RF,DMCB+8                                                        
         EDIT  (RF),(8,P+56),ZERO=NOBLANK,FILL=0                                
         MVI   P+64,C'.'                                                        
                                                                                
         LR    RF,R4                                                            
         LR    R0,R5               LOCATE FIRST BOOK, LEVEL & DATE INFO         
         AHI   R0,-39              SUBTRACT LENGTH OF BOOK= ETC. DATA           
         BNP   LDSUB95                                                          
         AR    RF,R0                                                            
         SR    R1,R1                                                            
         BASR  RE,0                                                             
         CLC   =C'BOOK=',00(RF)    BOOK=  AT +00                                
         JNE   *+10                                                             
         CLC   =C'LEVEL=',16(RF)   LEVEL= AT +16                                
         JNE   *+10                                                             
         CLC   =C'DATE=',26(RF)    DATE=  AT +26                                
         JNE   *+6                                                              
         LR    R1,RF                                                            
         BCTR  RF,0                                                             
         BCTR  R0,RE                                                            
         LTR   R1,R1               TEST BOOK INFO FOUND                         
         JZ    LDSUB95                                                          
         MVC   P+66(39),0(R1)                                                   
*                                                                               
LDSUB95  GOTO1 VPRINTER                                                         
*                                                                               
LDSUBX   B     YES                                                              
LDSUBXX  EQU   *                                                                
         DC    H'0'                                                             
         EJECT                                                                  
***********************************************************************         
* PROCESS EXTRACT LOAD MODE                                           *         
***********************************************************************         
         SPACE 1                                                                
PROCLOAD NTR1  ,                                                                
         MVI   MSGNUM,MSPLOADQ                                                  
         GOTO1 =A(MSGPRT),(RC)                                                  
         L     R4,ADXBLOCK         GET ADDRESS SYSTEM CONTROL BLOCK             
         USING DXBLOCKD,R4                                                      
*                                                                               
         MVI   DXMODE,DXLOADQ      SET LOAD MODE                                
         GOTO1 =A(CALLSEX),(RC)    CALL SYSTEM EXTRACT MODULE                   
         BNE   PLODNO                                                           
*                                                                               
         MVI   MSGNUM,MSPLOAXQ                                                  
         GOTO1 =A(MSGPRT),(RC)                                                  
         B     PLODOK                                                           
*                                                                               
PLODNO   B     NO                  EXIT ERROR                                   
PLODOK   B     YES                 EXIT OK                                      
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* INITIALISE FOR PQ REPORT EXTRACT                                    *         
***********************************************************************         
         SPACE 1                                                                
INITPQR  NTR1                                                                   
         MVC   P(40),=CL40'INITIALISE PQ REPORT EXTRACT'                        
         GOTO1 VPRINTER                                                         
         L     RE,=V(UTL)          SWITCH TO CONTROL SYSTEM                     
         MVI   4(RE),CONTROLQ                                                   
*                                  INITILISE PQ SERVICE BLOCK                   
         L     R3,=A(PQSERVC)                                                   
         USING PQSERVD,R3                                                       
         LR    RE,R3                                                            
         LA    RF,PQSERVLN                                                      
         XCEF                                                                   
         ICM   RF,15,=A(PQBUFF)                                                 
         STCM  RF,15,PQSBUFF                                                    
         XC    PQSNLXTB,PQSNLXTB                                                
         CLI   INPCODE,DXTIREPQ                                                 
         BNE   IPQR010                                                          
         MVI   PQSDSET,C'Y'                                                     
         MVC   P(40),=CL40'INPUT=REPORT DATA SET'                               
         GOTO1 VPRINTER                                                         
*                                                                               
IPQR010  EQU   *                                                                
*                                  INITIALISE PQ SERVICE ROUTINES               
         GOTO1 VPQSERV,DMCB,PQSERVD,ACOMFACS                                    
         OC    PQSRETC,PQSRETC                                                  
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                  GET PQ FILE NUMBER ENTRIES                   
         GOTO1 PQSRGFIL,DMCB,PQSERVD,ACOMFACS                                   
         OC    PQSRETC,PQSRETC                                                  
         BZ    *+6                                                              
         DC    H'0'                                                             
         MVC   PQSPQID,=CL8'PRTQUE'                                             
*                                                                               
         LA    RF,PQSFNTRY                                                      
         STCM  RF,15,PQSFPNTR                                                   
         BRAS  RE,INITPQF          INITILAISE PQ FILE BUFFER                    
         BNE   IPQRNO                                                           
         B     IPQROK                                                           
*                                                                               
IPQROK   SR    RC,RC                                                            
IPQRNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R3                                                               
         EJECT                                                                  
***********************************************************************         
* INTIALISE PQ FILE BUFFER                                            *         
***********************************************************************         
         SPACE 1                                                                
INITPQF  NTR1                                                                   
         L     RE,=V(UTL)          SWITCH TO CONTROL SYSTEM                     
         MVI   4(RE),CONTROLQ                                                   
*                                                                               
         L     R3,=A(PQSERVC)                                                   
         USING PQSERVD,R3                                                       
         ICM   RF,15,PQSFPNTR                                                   
*                                                                               
         MVC   PQSUSER,UIDFILT                                                  
         MVC   PQSPQID+4(1),1(RF)                                               
*                                  INITIALISE PQ BUFFER FOR THIS PQID           
         GOTO1 PQSRINIT,DMCB,PQSERVD,ACOMFACS                                   
         OC    PQSRETC,PQSRETC                                                  
         BZ    *+6                                                              
         DC    H'0'                                                             
         XC    PQSINDX,PQSINDX                                                  
         B     IPQFOK                                                           
*                                                                               
IPQFOK   SR    RC,RC                                                            
IPQFNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R3                                                               
         EJECT                                                                  
***********************************************************************         
* GET NEXT PQ REPORT FOR EXTRACT                                      *         
***********************************************************************         
         SPACE 1                                                                
GETPQR   NTR1                                                                   
         MVC   P(40),=CL40'GET NEXT PQ REPORT FOR EXTRACT'                      
         GOTO1 VPRINTER                                                         
         L     RE,=V(UTL)          SWITCH TO CONTROL SYSTEM                     
         MVI   4(RE),CONTROLQ                                                   
         MVI   PQEOF,C'N'                                                       
*                                                                               
         L     R3,=A(PQSERVC)                                                   
         USING PQSERVD,R3                                                       
         CLI   INPCODE,DXTIREPQ                                                 
         BE    GPQR011                                                          
*                                  GET NEXT REPORT INDEX                        
GPQR010  EQU   *                                                                
         GOTO1 PQSRNEXT,DMCB,PQSERVD,ACOMFACS                                   
         OC    PQSRETC,PQSRETC                                                  
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLI   PQSEOF,C'Y'                                                      
         BE    GPQR100                                                          
*                                  FILTER ON REPORT ATTRIBUTES                  
         TM    PQSATTB,PQATJOBI    TEST JOB INPUT (CONTAINS JCL)                
         BNZ   GPQRNEXT                                                         
         TM    PQSATTB,PQATERR     TEST REPORT IN ERROR                         
         BNZ   GPQRNEXT                                                         
*                                  ??                                           
*        TM    PQSTYPE,PQTYDL                                                   
*        BZ    GPQRNEXT                                                         
*                                  FILTER ON REPORT USERID                      
         OC    UIDFILT,UIDFILT                                                  
         BZ    *+14                                                             
         CLC   PQSUSER,UIDFILT                                                  
         BNE   GPQRNEXT                                                         
*                                  FILTER ON REPORT SUBID                       
         OC    SUBIDFLT,SUBIDFLT                                                
         BZ    *+14                                                             
         CLC   PQSSUBID,SUBIDFLT                                                
         BNE   GPQRNEXT                                                         
*                                  FILTER ON REPORT NUMBER                      
         OC    REPNOFLT,REPNOFLT                                                
         BZ    *+14                                                             
         CLC   PQSREPNO,REPNOFLT                                                
         BNE   GPQRNEXT                                                         
*                                                                               
GPQR011  EQU   *                                                                
         OC    REFORMID,REFORMID                                                
         BNZ   GPQR012                                                          
         CLI   AUTOFLAG,OFF                                                     
         BE    GPQR012                                                          
         TM    PQSTYPE,PQTYSQL                                                  
         BZ    GPQRNEXT                                                         
*                                  FILTER ON REPORT STATUS                      
         TM    PQSSTAT,PQSTSE      TEST NOT SENT                                
         BNZ   GPQRNEXT                                                         
         TM    PQSSTAT,PQSTAC      TEST ACTIVIE                                 
         BNO   GPQRNEXT                                                         
*                                                                               
GPQR012  EQU   *                                                                
         GOTO1 GETUSER,PQSUSER     GET USERID RECORD VALUES                     
         JNE   *+2                                                              
         MVC   USERNUM,PQSUSER     SAVE USERID NUMBER FOR LATER COMPARE         
         MVC   AGYFILT,WORK+10                                                  
         MVC   P(26),HASHES                                                     
         GOTO1 VPRINTER                                                         
         MVC   P(28),=CL28'READING PRINT QUEUE REPORT: '                        
         MVC   P+28(10),USERID                                                  
         MVC   P+39(3),PQSSUBID                                                 
         SR    RF,RF                                                            
         ICM   RF,3,PQSREPNO                                                    
         MVI   P+42,C','                                                        
         EDIT  (RF),(5,P+43),ZERO=NOBLANK,FILL=0                                
         GOTO1 VHEXOUT,DMCB,PQSTYPE,P+50,1,=C'TOG'                              
         GOTO1 VHEXOUT,DMCB,PQSATTB,P+53,1,=C'TOG'                              
         GOTO1 VHEXOUT,DMCB,PQSSTAT,P+56,1,=C'TOG'                              
         MVC   P+53(1),PQSCLASS                                                 
         GOTO1 VPRINTER                                                         
         MVC   P(26),HASHES                                                     
         GOTO1 VPRINTER                                                         
*                                                                               
         MVC   PQREPORT(10),USERID                                              
         MVI   PQREPORT+10,C','                                                 
         MVC   PQREPORT+11(3),PQSSUBID                                          
         MVI   PQREPORT+14,C','                                                 
         SR    RF,RF                                                            
         ICM   RF,3,PQSREPNO                                                    
         EDIT  (RF),(5,PQREPORT+15),ZERO=NOBLANK,FILL=0                         
*                                                                               
         CLI   REFSTFLG,C'A'                                                    
         BNE   GPQR013                                                          
         MVC   P,SPACES                                                         
         LA    RE,P                                                             
         MVC   0(9,RE),=CL9'AUTONOTE*'                                          
         AHI   RE,9                                                             
         MVC   0(40,RE),EMAILADR                                                
         AHI   RE,39                                                            
         CLI   0(RE),C' '                                                       
         BNE   *+8                                                              
         BCT   RE,*-8                                                           
         AHI   RE,1                                                             
*                                                                               
         MVI   0(RE),C':'                                                       
         AHI   RE,1                                                             
         MVC   0(22,RE),=CL22'RDR REPORT IN ACTIVE -'                           
         AHI   RE,22                                                            
         MVC   0(20,RE),PQREPORT                                                
         GOTO1 VDATAMGR,DMCB,=C'OPMSG',(L'P,P)                                  
GPQR013  EQU   *                                                                
*                                                                               
*                                  GET PQ REPORT HEADER ATTRIBUTES              
         GOTO1 PQSRATTR,DMCB,PQSERVD,ACOMFACS                                   
         OC    PQSRETC,PQSRETC                                                  
         BZ    *+6                                                              
         DC    H'0'                                                             
         OC    REFORMID,REFORMID                                                
         BNZ   GPQR014                                                          
         CLI   AUTOFLAG,OFF        USE REFORM ID FROM JCL IF NOT AUTO           
         BE    *+10                                                             
         MVC   REFORMID,PQSDESC+6  GET REFORM ID                                
*                                                                               
GPQR014  EQU   *                                                                
         BRAS  RE,INITRQD          INITIALISE REQUEST DETAILS BLOCK             
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   P(40),=CL40'INITIALISE REFORM ID:'                               
         MVC   P+22(L'AGYFILT),AGYFILT                                          
         MVC   P+24(L'REFORMID),REFORMID                                        
         GOTO1 VPRINTER                                                         
         L     R2,=A(REFORMC)      SET UP REFORM INITIALISATION CALL            
         USING REFORMD,R2                                                       
         LR    RE,R2                                                            
         ICM   RF,15,=AL4(REFORML)                                              
         LA    R0,*                                                             
         L     R1,=F'0'                                                         
         MVCL  RE,R0                                                            
         OI    REFSFLG1,REFSINIQ   SET INITIALISE FLAG                          
         CLI   DIETFLAG,C'Y'       TEST DIET SQL FLAG = YES                     
         BE    *+8                                                              
         OI    REFMODE,REFMESSQ    SET ESS CONTROL MODE                         
         MVC   REFAGY,AGYFILT                                                   
         MVC   REFID,REFORMID                                                   
*                                  CALL REFORM FOR INITIALISATION               
         GOTO1 VREFORM,DMCB,(R2),ASQLBUFF,ACOMFACS                              
         TM    REFSFLG1,REFSERRQ                                                
         BZ    GPQR020                                                          
*                                                                               
         BRAS  RE,PREFERR                                                       
         XC    REFORMID,REFORMID   CLEAR REFORM ID                              
         B     GPQRNEXT                                                         
*                                  GET EXTRACT SYSTEM AND SUB SYSTEM            
GPQR020  EQU   *                                                                
         CLI   SENDFLAG,C'B'                                                    
         BNE   GPQR021                                                          
         ICM   RF,15,ASXBDET                                                    
         USING SXBDETD,RF                                                       
*                                                                               
         XC    SXBDEUIN,SXBDEUIN                                                
         XC    SXBDEEDI,SXBDEEDI                                                
         XC    SXBDEFIL,SXBDEFIL                                                
         XC    SXBDESUB,SXBDESUB                                                
         DROP  RF                                                               
*                                                                               
         TM    REFMODE,REFMBDEQ    FILTER ON BDE MODE REFORM                    
         BZ    GPQR020A                                                         
         CLC   REFBDEID,SPACES     EXTRACT ANY BDE ID                           
         BE    GPQR022                                                          
         OC    REFBDEID,REFBDEID                                                
         BZ    GPQR022                                                          
         CLC   REFBDEID,=CL8'Y       '                                          
         BE    GPQR022                                                          
         GOTO1 =A(GETBDE),(RC)     GET BDE CONTROL RECORD INFO                  
         BNE   GPQR020A                                                         
         B     GPQR022                                                          
GPQR020A EQU   *                                                                
         XC    REFORMID,REFORMID                                                
         B     GPQRNEXT                                                         
GPQR021  TM    REFMODE,REFMBDEQ    FILTER ON BDE MODE REFORM                    
         BZ    GPQR022                                                          
         XC    REFORMID,REFORMID                                                
         B     GPQRNEXT                                                         
GPQR022  CLI   AUTOFLAG,ON                                                      
         BE    *+14                                                             
         OC    SYSFILT,SYSFILT                                                  
         BNZ   GPQROK                                                           
         OC    REFXSYS,REFXSYS                                                  
         BZ    GPQR030                                                          
         MVC   SYSFILT,REFXSYS                                                  
         MVC   SUBFILT,REFXSUB                                                  
         B     GPQROK                                                           
*                                                                               
GPQR030  MVC   P(40),=CL40'NO REFORM EXTRACT SYSTEM DEFINED'                    
         GOTO1 VPRINTER                                                         
         XC    REFORMID,REFORMID   CLEAR REFORM ID                              
         B     GPQRNEXT                                                         
*                                                                               
GPQR100  OC    UIDFILT,UIDFILT                                                  
         BNZ   GPQREOF                                                          
         ICM   RF,15,PQSFPNTR      GET NEXT PQ FILE ID                          
         LA    RF,L'PQSFNTRY(RF)                                                
         OC    0(L'PQSFLSTX,RF),0(RF)                                           
         BZ    GPQREOF                                                          
         STCM  RF,15,PQSFPNTR                                                   
         BRAS  RE,INITPQF          INITIALISE PQ FILE BUFFER                    
         BNE   GPQRNO                                                           
         B     GPQRNEXT                                                         
*                                                                               
GPQRNEXT EQU   *                                                                
         CLI   INPCODE,DXTIREPQ                                                 
         BE    GPQROK                                                           
         B     GPQR010                                                          
*                                                                               
GPQREOF  MVI   PQEOF,C'Y'                                                       
         OC    UIDFILT,UIDFILT                                                  
         BZ    GPQROK                                                           
         OC    SUBIDFLT,SUBIDFLT                                                
         BZ    GPQROK                                                           
         OC    REPNOFLT,REPNOFLT                                                
         BZ    GPQROK                                                           
         MVC   P(28),HASHES                                                     
         GOTO1 VPRINTER                                                         
         MVC   P(30),=CL30'PRINT QUEUE REPORT NOT FOUND: '                      
         MVC   P+30(10),USERID                                                  
         MVC   P+41(3),SUBIDFLT                                                 
         MVI   P+44,C','                                                        
         SR    RF,RF                                                            
         ICM   RF,3,REPNOFLT                                                    
         EDIT  (RF),(5,P+45),ZERO=NOBLANK,FILL=0                                
         GOTO1 VPRINTER                                                         
         MVC   P(28),HASHES                                                     
         GOTO1 VPRINTER                                                         
         B     GPQROK                                                           
*                                                                               
GPQROK   SR    RC,RC                                                            
GPQRNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R3                                                               
         EJECT                                                                  
***********************************************************************         
* GET USER ID RECORD DATA                                             *         
* R1=A(UIDFILT)                                                       *         
***********************************************************************         
         SPACE 1                                                                
GETUSER  NTR1                                                                   
*                                                                               
         XC    WORK,WORK                                                        
         LA    R2,IOKEY                                                         
         USING CTIKEY,R2                                                        
         XC    CTIKEY,CTIKEY                                                    
         MVI   CTIKTYP,CTIKTYPQ                                                 
         MVC   CTIKNUM,0(R1)                                                    
         LAY   R2,IO              READ USER ID RECORD                           
*                                                                               
         GOTO1 VDATAMGR,DMCB,DMREAD,CTFILE,IOKEY,(R2),0                         
         CLI   8(R1),0                                                          
         BNE   GUSENO                                                           
*                                                                               
         XC    USERID,USERID                                                    
         XC    USERAGY,USERAGY                                                  
         LA    R3,CTIDATA                                                       
GUSE010  CLI   0(R3),0                                                          
         BE    GUSE100                                                          
         CLI   0(R3),X'02'                                                      
         BE    GUSE030                                                          
         CLI   0(R3),X'06'                                                      
         BE    GUSE040                                                          
GUSE020  SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     GUSE010                                                          
GUSE030  MVC   WORK(10),2(R3)                                                   
         MVC   USERID(10),2(R3)                                                 
         B     GUSE020                                                          
GUSE040  MVC   WORK+10(2),2(R3)                                                 
         B     GUSE020                                                          
GUSE100  OC    WORK(10),WORK                                                    
         BZ    GUSENO                                                           
         OC    WORK+10(2),WORK+10                                               
         BZ    GUSENO                                                           
         B     GUSEOK                                                           
*                                                                               
GUSEOK   SR    RC,RC                                                            
GUSENO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* PROCESS EXTRACT SQL ONLY MODE                                       *         
***********************************************************************         
         SPACE 1                                                                
PROCSQL  NTR1                                                                   
         MVI   MSGNUM,MSPSQLQ                                                   
         GOTO1 =A(MSGPRT),(RC)                                                  
         L     R5,ADXBLOCK         GET ADDRESS SYSTEM CONTROL BLOCK             
         USING DXBLOCKD,R5                                                      
         L     R4,DXSTPTR          GET SYSTEM TABLE ENTRY POINTER               
         USING SXDTABD,R4                                                       
         L     RF,AEXFTNXT         A(TABLE OF EXTRACT FILE DCBS/DDS)            
         MVC   SXDTXDCB,0(RF)      SAVE A(DCB)                                  
         MVC   SXDTXDDN,4(RF)      SAVE DD NAME                                 
         GOTO1 =A(OPENEXFL),(RC)   OPEN NEXT EXTRACT DATA SET                   
         BNE   PSQLNO                EXIT IF ERROR                              
         ICM   RF,15,AEXFTNXT      UPDATE POINTER TO NEXT EXFTAB ENTRY          
         LA    RF,12(RF)                                                        
         CLM   RF,15,=A(EXFTABX)                                                
         BNL   PSQLER1             ABEND EXFTAB OVERFLOW                        
         STCM  RF,15,AEXFTNXT                                                   
         L     RF,ALDCBNUM         INCR # OF ALLOCATED DCBS                     
         AHI   RF,1                                                             
         ST    RF,ALDCBNUM                                                      
         TM    SQLFLAG,SQLFBEFQ                                                 
         BZ    PSQL100             BUILD DUMMY FILE IF NO SQL SPECIFIED         
         MVC   SQLBOOK,SQLBOOKB                                                 
         GOTO1 =A(PROCSQB),(RC)    PROCESS SQL QUERY BOOK                       
         BNE   PSQLNO                EXIT IF ERROR                              
*                                                                               
PSQL100  MVI   MSGNUM,MSPSQXQ                                                   
         GOTO1 =A(MSGPRT),(RC)                                                  
         B     PSQLOK                                                           
*                                                                               
PSQLER1  EQU   *                   EXFTAB TABLE OVERFLOW                        
         MVI   ERROR,EREXFOVQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     PSQLNO                                                           
*                                                                               
PSQLOK   SR    RC,RC                                                            
PSQLNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R4,R5                                                            
         EJECT                                                                  
***********************************************************************         
* PROCESS EXTRACT STATISTICS MODE                                     *         
***********************************************************************         
         SPACE 1                                                                
PROCSTAT NTR1  ,                                                                
         MVI   MSGNUM,MSPSTATQ                                                  
         GOTO1 =A(MSGPRT),(RC)                                                  
         L     R4,ADXBLOCK         GET ADDRESS SYSTEM CONTROL BLOCK             
         USING DXBLOCKD,R4                                                      
*                                                                               
         CLI   MODE,DXSTATCSQ                                                   
         BE    PROCSTCS                                                         
         MVI   DXMODE,DXSTATQ      SET LOAD MODE HARPCHECK                      
         B     PROCST40                                                         
PROCSTCS MVI   DXMODE,DXSTATCSQ    SET LOAD MODE HC BUY COST                    
*                                                                               
PROCST40 DS    0H                                                               
         GOTO1 =A(CALLSEX),(RC)    CALL SYSTEM EXTRACT MODULE                   
         BNE   PSTANO                                                           
         MVI   MSGNUM,MSPSTAXQ                                                  
         GOTO1 =A(MSGPRT),(RC)                                                  
         B     PSTAOK                                                           
*                                                                               
PSTANO   B     NO                  EXIT ERROR                                   
PSTAOK   B     YES                 EXIT OK                                      
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* PROCESS EXTRACT PQ REPORT MODE - READ PQ REPORT                     *         
***********************************************************************         
         SPACE 1                                                                
PROCPQR  NTR1                                                                   
         MVI   MSGNUM,MSPPQRQ                                                   
         GOTO1 =A(MSGPRT),(RC)                                                  
*                                                                               
*CREATE THE EXTRACT FILE EVEN THE DATASET MAY BE EMPTY                          
         L     R5,ADXBLOCK         GET ADDRESS SYSTEM CONTROL BLOCK             
         USING DXBLOCKD,R5                                                      
         L     R4,DXSTPTR          GET SYSTEM TABLE ENTRY POINTER               
         USING SXDTABD,R4                                                       
         L     RF,AEXFTNXT         A(TABLE OF EXTRACT FILE DCBS/DDS)            
         MVC   SXDTXDCB,0(RF)      SAVE A(DCB)                                  
         MVC   SXDTXDDN,4(RF)      SAVE DD NAME                                 
         GOTO1 =A(OPENEXFL),(RC)   OPEN NEXT EXTRACT DATA SET                   
         BNE   PPQRNO                EXIT IF ERROR                              
         ICM   RF,15,AEXFTNXT      UPDATE POINTER TO NEXT EXFTAB ENTRY          
         LA    RF,12(RF)                                                        
         CLM   RF,15,=A(EXFTABX)                                                
         BNL   PPQRER1             ABEND EXFTAB OVERFLOW                        
         STCM  RF,15,AEXFTNXT                                                   
         L     RF,ALDCBNUM         INCR # OF ALLOCATED DCBS                     
         AHI   RF,1                                                             
         ST    RF,ALDCBNUM                                                      
         CLI   MODE,DXUPDTQ        NO SQL IN UPDATE MODE ??                     
         BE    PPQR003                                                          
         TM    SQLFLAG,SQLFBEFQ                                                 
         BZ    PPQR003                                                          
         MVC   SQLBOOK,SQLBOOKB                                                 
         GOTO1 =A(PROCSQB),(RC)    PROCESS SQL QUERY BOOK                       
         BNE   PPQRNO                EXIT IF ERROR                              
         DROP  R4,R5                                                            
*                                                                               
PPQR003  EQU   *                                                                
         L     RE,=V(UTL)          SWITCH TO CONTROL SYSTEM                     
         MVI   4(RE),CONTROLQ                                                   
         MVI   PQRFLAG,C'N'        FLAG PQ REPORT FILE NOT EXTRACTED            
         MVI   PQRERROR,C'N'       FLAG PQ REPORT EXTRACT NO ERROR              
         LA    RF,1                                                             
         STCM  RF,15,ERRCUNT       SET MAX ERROR COUNT                          
         L     R4,ADXBLOCK         GET ADDRESS SYSTEM CONTROL BLOCK             
         USING DXBLOCKD,R4                                                      
         L     R3,=A(PQSERVC)                                                   
         USING PQSERVD,R3                                                       
         L     R2,=A(REFORMC)                                                   
         USING REFORMD,R2                                                       
         MVC   MAXIOS,DXMAXREC                                                  
*                                  READ PQ REPORT FROM 2ND PAGE                 
*                                  (SKIP REQUEST DETAILS)                       
         MVC   PQSPAGE,=F'2'                                                    
         CLI   INPCODE,DXTIREPQ                                                 
         BNE   PPQR006                                                          
         CLI   SKIPFLAG,C'Y'                                                    
         BE    *+14                                                             
         MVC   PQSPAGE,=F'0'                                                    
         B     *+10                                                             
         MVC   PQSPAGE,=F'1'                                                    
PPQR006  EQU   *                                                                
         GOTO1 PQSRRPAG,DMCB,PQSERVD,ACOMFACS                                   
         OC    PQSRETC,PQSRETC                                                  
         BNZ   PPQRERR                                                          
         CLI   INPCODE,DXTIREPQ                                                 
         BE    PPQR008                                                          
*                                  READ PQ REPORT FIRST LINE                    
         GOTO1 PQSRFLIN,DMCB,PQSERVD,ACOMFACS                                   
         OC    PQSRETC,PQSRETC                                                  
         BNZ   PPQRERR                                                          
*                                                                               
PPQR008  EQU   *                                                                
         MVC   P(80),=CL80'PROCPQR TEST TRACE 1'                                
         GOTO1 VPRINTER                                                         
         CLI   PQSEOF,C'Y'                                                      
         BE    PPQR014                                                          
         MVC   P(80),=CL80'PROCPQR TEST TRACE 2'                                
         GOTO1 VPRINTER                                                         
         B     PPQR012                                                          
*                                  READ PQ REPORT NEXT LINE                     
PPQR010  GOTO1 PQSRNLIN,DMCB,PQSERVD,ACOMFACS                                   
         OC    PQSRETC,PQSRETC                                                  
         BNZ   PPQRERR                                                          
         CLI   PQSEOF,C'Y'                                                      
         BE    PPQR014                                                          
         TM    REFSFLG1,REFSCBAQ   TEST REFORM CALL BACK FLAG                   
         BZ    PPQREOF                                                          
*                                  CALL REFORM SUB ROUTINE                      
PPQR012  OI    REFSFLG1,REFSDATQ   INDICATE PQ REPORT DATA PASED                
         CLI   INPCODE,DXTIREPQ                                                 
         BNE   PPQR013                                                          
         ICM   RF,15,PQSLEN        DROP BLANK DATA LINES                        
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   PQSIOL+1(0),SPACES                                               
         BNE   PPQR013                                                          
         OI    REFSFLG1,REFSCBAQ   SET REFORM CALL BACK FLAG                    
         MVC   P(80),=CL80'PROCPQR TEST TRACE 3'                                
         GOTO1 VPRINTER                                                         
         B     PPQR010                                                          
*                                                                               
PPQR013  EQU   *                                                                
         MVC   REFDATA,PQSIOL+1    SAVE PQ REPORT LINE DATA                     
         ICM   RF,15,PQSLEN                                                     
         BCTR  RF,0                                                             
         STCM  RF,15,REFDLEN       SAVE PQ REPORT LINE LENGTH                   
*                                                                               
         TM    DEBUGFLG,DEBFPQQ    TEST DEBUG PQ FLAG SET                       
         BZ    PPQR020                                                          
         GOTO1 VPRINTER                                                         
         MVC   P(40),=CL40'PQ REPORT DATA LINE INPUT'                           
         GOTO1 VPRINTER                                                         
         ICM   RF,15,REFDLEN                                                    
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   P+20(0),REFDATA                                                  
         GOTO1 VHEXOUT,DMCB,REFDLEN,P,4,=C'TOG'                                 
         GOTO1 VHEXOUT,DMCB,PQSIOL,P+10,1,=C'TOG'                               
         GOTO1 VPRINTER                                                         
         B     PPQR020                                                          
*                                  HERE AT EOF OF PQ REPORT                     
PPQR014  EQU   *                                                                
         OI    REFSFLG1,REFSENDQ   INDICATE PQ REPORT EOF                       
*                                                                               
*                                  CALL REFORM SUB ROUTINE                      
PPQR020  EQU   *                                                                
         GOTO1 VREFORM,DMCB,(R2),ASQLBUFF,ACOMFACS                              
         TM    REFSFLG1,REFSERRQ   TEST ERROR RETURN                            
         BZ    PPQR030                                                          
         MVI   PQRERROR,C'Y'       FLAG PQ REPORT EXTRACT ERROR                 
         BRAS  RE,PREFERR                                                       
         TM    REFERFLG,REFEFCOQ   TEST CONTINUE AFTER ERROR                    
         BZ    PPQREOF                                                          
         ICM   RF,15,ERRCUNT                                                    
         BNZ   PPQR022                                                          
         MVC   P(40),=CL40'MAX. NUMBER OF ERRORS EXCEEDED'                      
         GOTO1 VPRINTER                                                         
         B     PPQREOF                                                          
*                                  PUT OUTPUT DATA LINE TO DATA SET             
PPQR022  BCTR  RF,0                                                             
         STCM  RF,15,ERRCUNT                                                    
*                                  PUT OUTPUT DATA LINE TO DATA SET             
PPQR030  TM    REFSFLG1,REFSOUTQ   TEST DATA IN OUTPUT AREA                     
         BZ    PPQR040                                                          
*                                                                               
         TM    DEBUGFLG,DEBFPQQ    TEST DEBUG PQ FLAG SET                       
         BZ    *+8                                                              
         BRAS  RE,PQDEBUG                                                       
*                                  PUT OUTPUT DATA LINE TO DATA SET             
         GOTO1 DXPUT,DMCB,ASQLBUFF,(R4)                                         
*                                                                               
         BRAS  RE,DECIOC                                                        
         BNE   PPQREOF                                                          
*                                                                               
PPQR040  TM    REFSFLG1,REFSGETQ   TEST GET NEW PQ DATA LINE FLAG               
         BO    PPQR010                                                          
         TM    REFSFLG1,REFSCBAQ   TEST REFORM CALL BACK FLAG                   
         BO    PPQR020                                                          
         B     PPQREOF             EXIT PQ REPORT REFORM EXTRACT                
*                                                                               
PPQREOF  EQU   *                                                                
         CLI   PQRERROR,C'Y'       TEST PQ REPORT EXTRACT ERROR                 
         BE    PPQRERR                                                          
*                                                                               
         MVI   PQRFLAG,C'Y'        FLAG PQ REPORT FILE EXTRACTED OK             
*                                                                               
         MVC   P(41),HASHES                                                     
         GOTO1 VPRINTER                                                         
         MVC   P(43),=CL43'EXTRACT COMPLETED FROM PRINT QUEUE REPORT: '         
         MVC   P+43(10),USERID                                                  
         MVC   P+54(3),PQSSUBID                                                 
         MVI   P+57,C','                                                        
         SR    RF,RF                                                            
         ICM   RF,3,PQSREPNO                                                    
         EDIT  (RF),(5,P+58),ZERO=NOBLANK,FILL=0                                
         GOTO1 VPRINTER                                                         
         MVC   P(41),HASHES                                                     
         GOTO1 VPRINTER                                                         
*                                                                               
         MVI   MSGNUM,MSPPQXQ                                                   
         GOTO1 =A(MSGPRT),(RC)                                                  
*                                                                               
         CLI   AUTOFLAG,ON         CHECK IF AUTO UPDATE MODE                    
         BNE   PPQROK                                                           
*                                  MARK PQ REPORT SENT                          
         CLI   INPCODE,DXTIREPQ                                                 
         BE    PPQROK                                                           
   GOTO1 VDATAMGR,DMCB,(0,=C'SENT'),PQSPQID,PQSINDX,PQSIOL,PQSBUFF              
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
         B     PPQROK                                                           
*                                                                               
PPQRERR  EQU   *                                                                
         MVI   PQRERROR,C'Y'                                                    
         MVC   P(40),HASHES                                                     
         GOTO1 VPRINTER                                                         
         MVC   P(42),=CL42'ERROR EXTRACTING FROM PRINT QUEUE REPORT: '          
         MVC   P+42(10),USERID                                                  
         MVC   P+53(3),PQSSUBID                                                 
         MVI   P+56,C','                                                        
         SR    RF,RF                                                            
         ICM   RF,3,PQSREPNO                                                    
         EDIT  (RF),(5,P+57),ZERO=NOBLANK,FILL=0                                
         GOTO1 VPRINTER                                                         
         MVC   P(40),HASHES                                                     
         GOTO1 VPRINTER                                                         
         B     PPQROK                                                           
*                                                                               
PPQRER1  EQU   *                   EXFTAB TABLE OVERFLOW                        
         MVI   ERROR,EREXFOVQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     PPQRNO                                                           
*                                                                               
PPQROK   SR    RC,RC                                                            
PPQRNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R2,R3,R4                                                         
         SPACE 1                                                                
***********************************************************************         
* PRINT OUT REFORM CALL ERROR REPORT DETAILS                          *         
***********************************************************************         
         SPACE 1                                                                
PREFERR  NTR1                                                                   
         ZAP   LINE,=P'99'                                                      
         L     R2,=A(REFORMC)                                                   
         USING REFORMD,R2                                                       
         MVI   ERROR,ERPQREFQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         MVC   P(40),=CL40'RETURN CODE:'                                        
         EDIT  REFSCODE,(6,P+13),FILL=0,ZERO=NOBLANK                            
         GOTO1 VPRINTER                                                         
         MVC   P(21),HASHES                                                     
         GOTO1 VPRINTER                                                         
         MVC   P(21),=CL21'REFORM ERROR MESSAGE:'                               
         MVC   P+22(80),REFEREP                                                 
         GOTO1 VPRINTER                                                         
         MVC   P(21),HASHES                                                     
         GOTO1 VPRINTER                                                         
         MVC   P(29),=CL29'LAST PQ REPORT DATA LINE READ'                       
         GOTO1 VPRINTER                                                         
         ICM   RF,15,REFDLEN                                                    
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   P(0),REFDATA                                                     
         GOTO1 VPRINTER                                                         
         LA    R3,REFDBUFF                                                      
         LA    R5,L'REFDBUFF(R3)                                                
         LA    R4,P                                                             
         LA    R0,80                                                            
*                                                                               
PRER010  CLI   0(R3),X'00'                                                      
         BE    PRER020                                                          
PRER012  CR    R3,R5                                                            
         BNL   PRER020                                                          
         MVC   0(1,R4),0(R3)                                                    
         LA    R3,1(R3)                                                         
         LA    R4,1(R4)                                                         
         BCT   R0,PRER010                                                       
         GOTO1 VPRINTER                                                         
         CLI   0(R3),X'00'                                                      
         BE    PRER022                                                          
         LA    R4,P                                                             
         LA    R0,80                                                            
         B     PRER012                                                          
*                                                                               
PRER020  EQU   *                                                                
         GOTO1 VPRINTER                                                         
*                                                                               
PRER022  BRAS  RE,PQDEBUG                                                       
*                                                                               
         CLI   REFSTFLG,C'E'                                                    
         BNE   PRER050                                                          
         MVC   P,SPACES                                                         
         LA    RE,P                                                             
         MVC   0(9,RE),=CL9'AUTONOTE*'                                          
         AHI   RE,9                                                             
         MVC   0(40,RE),EMAILADR                                                
         AHI   RE,39                                                            
         CLI   0(RE),C' '                                                       
         BNE   *+8                                                              
         BCT   RE,*-8                                                           
         AHI   RE,1                                                             
*                                                                               
         MVI   0(RE),C':'                                                       
         AHI   RE,1                                                             
         MVC   0(21,RE),=CL21'RDR REPORT IN ERROR -'                            
         AHI   RE,21                                                            
         MVC   0(20,RE),PQREPORT                                                
         OC    0(20,RE),SPACES                                                  
         GOTO1 VDATAMGR,DMCB,=C'OPMSG',(L'P,P)                                  
PRER050  EQU   *                                                                
*                                                                               
         CLI   RFABDFLG,C'Y'       ABEND FOR ANY REFORM ERROR?                  
         BNE   *+6                 NO                                           
         DC    H'0'                YES                                          
*                                                                               
         XIT1                                                                   
         DROP  R2                                                               
         SPACE 1                                                                
***********************************************************************         
* PRINT PQ REPORT REFORM DEBUG DATA                                   *         
***********************************************************************         
         SPACE 1                                                                
PQDEBUG  NTR1                                                                   
         L     R2,=A(REFORMC)                                                   
         USING REFORMD,R2                                                       
         L     R3,=A(PQSERVC)                                                   
         USING PQSERVD,R3                                                       
         GOTO1 VPRINTER                                                         
         MVC   P(40),=CL40'PQ REPORT REFORM DEBUG REPORT'                       
         GOTO1 VPRINTER                                                         
         OC    REFDEPTR,REFDEPTR                                                
         BZ    PBUGX                                                            
         LH    R4,=Y(REFDEBUG-REFORMD)                                          
         LA    R4,REFORMD(R4)                                                   
         GOTO1 VPRINTER                                                         
         MVC   P(40),=CL40'PQ REPORT LINE -'                                    
         MVC   P+20(5),=CL5'PAGE:'                                              
         MVC   P+34(5),=CL5'LINE:'                                              
         MVC   P+48(21),=CL21'NORMALISATION COLUMN:'                            
         EDIT  PQSPAGE,(6,P+26),ZERO=NOBLANK,ALIGN=LEFT                         
         EDIT  PQSLINE,(6,P+40),ZERO=NOBLANK,ALIGN=LEFT                         
         EDIT  REFPCOL,(6,P+70),ZERO=NOBLANK,ALIGN=LEFT                         
         GOTO1 VPRINTER                                                         
         MVC   P(40),=CL40'REFORM OUTPUT DATA ROW: '                            
         EDIT  REFDROW,(6,P+26),ZERO=NOBLANK,ALIGN=LEFT                         
         GOTO1 VPRINTER                                                         
         MVC   P(6),=CL6'COLUMN'                                                
         MVC   P+8(18),=CL18'REPORT INPUT FIELD'                                
         MVC   P+35(19),=CL19'REFORM OUTPUT FIELD'                              
         MVC   P+62(15),=CL15'FORMULA ELEMENT'                                  
         GOTO1 VPRINTER                                                         
         MVC   P(6),=CL6'------'                                                
         MVC   P+8(18),=CL19'-------------------'                               
         MVC   P+35(19),=CL19'-------------------'                              
         MVC   P+62(15),=CL19'-------------------'                              
         GOTO1 VPRINTER                                                         
         LA    R5,1                                                             
*                                                                               
PBUG010  OC    0(8,R4),0(R4)                                                    
         BZ    PBUG100                                                          
         EDIT  (R5),(6,P),ZERO=NOBLANK,ALIGN=LEFT                               
         ICM   RE,15,0(R4)                                                      
         BNZ   PBUG012                                                          
         MVC   P+8(9),=CL9'##ERROR##'                                           
         B     PBUG032                                                          
*                                                                               
PBUG012  EQU   *                                                                
         LA    RF,P+8                                                           
         LA    R0,20                                                            
         MVI   BYTE,C'"'                                                        
         CLI   0(RE),C'"'                                                       
         BE    PBUG020                                                          
         MVI   BYTE,C' '                                                        
         CLI   0(RE),C' '                                                       
         BE    PBUG022                                                          
*                                                                               
PBUG020  MVC   0(1,RF),0(RE)                                                    
         LA    RF,1(RF)                                                         
         LA    RE,1(RE)                                                         
         BCT   R0,PBUG022                                                       
         BCTR  RF,0                                                             
         MVI   0(RF),C'>'                                                       
         B     PBUG024                                                          
PBUG022  CLC   0(1,RE),BYTE                                                     
         BNE   PBUG020                                                          
         MVC   0(1,RF),0(RE)                                                    
*                                                                               
PBUG024  EQU   *                                                                
         ICM   RE,15,ASQLBUFF                                                   
         LA    RE,4(RE)                                                         
         SR    R1,R1                                                            
         ICM   R1,3,4(R4)                                                       
         BNZ   PBUG026                                                          
         MVC   P+35(9),=CL9'##ERROR##'                                          
         B     PBUG032                                                          
*                                                                               
PBUG026  AR    RE,R1                                                            
         LA    RF,P+35                                                          
         LA    R0,20                                                            
*                                                                               
PBUG030  CLI   0(RE),C';'                                                       
         BE    PBUG032                                                          
         CLI   0(RE),C','                                                       
         BE    PBUG032                                                          
         CLI   0(RE),C')'                                                       
         BE    PBUG032                                                          
         MVC   0(1,RF),0(RE)                                                    
         LA    RF,1(RF)                                                         
         LA    RE,1(RE)                                                         
         BCT   R0,PBUG030                                                       
         BCTR  RF,0                                                             
         MVI   0(RF),C'>'                                                       
*                                                                               
PBUG032  EQU   *                                                                
         LA    RE,REFFORM                                                       
         ICM   R1,3,6(R4)                                                       
         AR    RE,R1                                                            
         LA    RF,P+62                                                          
         LA    R0,20                                                            
*                                                                               
PBUG040  CLI   0(RE),C';'                                                       
         BE    PBUG042                                                          
         MVC   0(1,RF),0(RE)                                                    
         LA    RF,1(RF)                                                         
         LA    RE,1(RE)                                                         
         BCT   R0,PBUG040                                                       
         BCTR  RF,0                                                             
         MVI   0(RF),C'>'                                                       
*                                                                               
PBUG042  EQU   *                                                                
         GOTO1 VPRINTER                                                         
         LA    R5,1(R5)                                                         
         LA    R4,8(R4)                                                         
         B     PBUG010                                                          
*                                                                               
PBUG100  EQU   *                                                                
         TM    REFSFLG1,REFSERRQ                                                
         BZ    PBUG110                                                          
         MVC   P(34),HASHES                                                     
         GOTO1 VPRINTER                                                         
         MVC   P(34),=CL34'ERROR IN PROCESSING COLUMN:       '                  
         BCTR  R5,0                                                             
         EDIT  (R5),(6,P+28),ZERO=NOBLANK,ALIGN=LEFT                            
         GOTO1 VPRINTER                                                         
         MVC   P(34),HASHES                                                     
         GOTO1 VPRINTER                                                         
*                                                                               
PBUG110  MVC   P(40),=CL40'----------'                                          
         GOTO1 VPRINTER                                                         
         MVC   P(40),=CL40'END OF ROW'                                          
         GOTO1 VPRINTER                                                         
         MVC   P(40),=CL40'----------'                                          
         GOTO1 VPRINTER                                                         
*                                                                               
PBUGX    EQU   *                                                                
         XIT1                                                                   
         DROP  R2,R3                                                            
         SPACE 1                                                                
***********************************************************************         
* DECREMENT MAXIMUM IO COUNT                                          *         
***********************************************************************         
         SPACE 1                                                                
DECIOC   NTR1                                                                   
         ICM   RF,15,MAXIOS                                                     
         BCTR  RF,0                                                             
         STCM  RF,15,MAXIOS                                                     
         BZ    DIOCNO                                                           
         B     DIOCOK                                                           
DIOCOK   SR    RC,RC                                                            
DIOCNO   LTR   RC,RC                                                            
         XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* INITIALISE REQUEST DETAILS BLOCK                                    *         
***********************************************************************         
         SPACE 1                                                                
INITRQD  NTR1                                                                   
         L     R3,=A(PQSERVC)                                                   
         USING PQSERVD,R3                                                       
         L     R4,=A(SQLBUFF)      REQUEST DETAILS BLOCK WORK AREA              
         LR    RE,R4                                                            
         ICM   RF,15,=AL4(10000)                                                
         LA    R0,*                                                             
         L     R1,=F'0'                                                         
         MVCL  RE,R0               CLEAR BLOCK                                  
         CLI   INPCODE,DXTIREPQ    IGNORE FOR INPUT=REPORT MODE                 
         BE    IRQDOK                                                           
*                                  READ FIRST PQ REPORT PAGE                    
         MVC   PQSPAGE,=F'1'                                                    
         GOTO1 PQSRRPAG,DMCB,PQSERVD,ACOMFACS                                   
         OC    PQSRETC,PQSRETC                                                  
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                  READ REPORT LINE                             
IRQD010  GOTO1 PQSRNLIN,DMCB,PQSERVD,ACOMFACS                                   
         OC    PQSRETC,PQSRETC                                                  
         BZ    *+6                                                              
         DC    H'0'                                                             
         CLI   PQSEOF,C'Y'         EXIT EOF OR END OF PAGE                      
         BE    IRQDOK                                                           
         CLI   PQSEJECT,C'Y'                                                    
         BE    IRQDOK                                                           
         CLC   PQSPAGE,=F'1'                                                    
         BNE   IRQDOK                                                           
         ICM   RF,15,PQSLEN                                                     
         BCTR  RF,0                                                             
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R4),PQSIOL+1    MOVE LINE INTO BLOCK                         
         LA    R4,2(RF,R4)         TERMINATED BY X'00'                          
         C     R4,=A(SQLBUFFX)                                                  
         BL    IRQD010                                                          
         DC    H'0'                                                             
*                                                                               
IRQDOK   SR    RC,RC                                                            
IRQDNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R3                                                               
         EJECT                                                                  
***********************************************************************         
* ROUTINE TO GET SUB SYSTEM TABLE DATA                                *         
* NTRY: R1=A(SUB SYSTEM NUMBER)                                       *         
* EXIT: SUBSYS, SUBNAME, SUBCHAR                                      *         
***********************************************************************         
         SPACE 1                                                                
GETSUB   NTR1  ,                                                                
         USING SUBLSTD,RE                                                       
         L     RE,=A(SUBLST)       CHECK IN TABLE OF VALID SYSTEMS              
         LA    RE,6(RE)                                                         
         MVC   SUBSYS(L'SUBLNUM),0(R1)                                          
*                                                                               
GSUB010  CLI   SUBLNUM,0                                                        
         BE    GSUBNO                                                           
         CLC   0(1,R1),SUBLNUM                                                  
         BE    GSUB020                                                          
         LA    RE,SUBLLEN(RE)                                                   
         B     GSUB010                                                          
*                                                                               
GSUB020  EQU   *                                                                
         MVC   SUBNAME(L'SUBLNAME),SUBLNAME  GET FULL SYSTEM NAME               
         MVC   SUBCHAR(L'SUBLKEY1),SUBLKEY1                                     
         MVC   SUBSYS(L'SUBLNUM),SUBLNUM                                        
         B     GSUBOK                                                           
*                                                                               
GSUBNO   B     NO                                                               
GSUBOK   B     YES                                                              
         EJECT                                                                  
***********************************************************************         
* SUBTRACT P2 HUNDREDS SECONDS FROM TIME IN P1 HHMMSSTH FORMAT,       *         
* RESULT IN P3, HHMMSSTH FORMAT                                       *         
***********************************************************************         
         SPACE 1                                                                
TIMEDIFF NTR1                                                                   
         LM    R2,R4,0(R1)                                                      
         L     RF,0(R2)                                                         
         SRL   RF,20                                                            
         XC    DUB,DUB                                                          
         ST    RF,DUB+4                                                         
         OI    DUB+7,X'0F'                                                      
         CVB   RF,DUB                                                           
         SR    RE,RE                                                            
         M     RE,=F'360000'                                                    
         ST    RF,0(R4)                                                         
         L     RF,0(R2)                                                         
         SLL   RF,8                                                             
         SRL   RF,20                                                            
         ST    RF,DUB+4                                                         
         OI    DUB+7,X'0F'                                                      
         CVB   RF,DUB                                                           
         MH    RF,=H'6000'                                                      
         A     RF,0(R4)                                                         
         ST    RF,0(R4)                                                         
         L     RF,0(R2)                                                         
         SLL   RF,16                                                            
         SRL   RF,12                                                            
         ST    RF,DUB+4                                                         
         OI    DUB+7,X'0F'                                                      
         CVB   RF,DUB                                                           
         A     RF,0(R4)                                                         
         S     RF,0(R3)                                                         
*                                                                               
         SR    R0,R0                                                            
*                                                                               
         SR    RE,RE                                                            
         D     RE,=F'100'                                                       
         CVD   RE,DUB                                                           
         L     RE,DUB+4                                                         
         SRL   RE,4                                                             
         OR    R0,RE                                                            
*                                                                               
         SR    RE,RE                                                            
         D     RE,=F'60'                                                        
         CVD   RE,DUB                                                           
         L     RE,DUB+4                                                         
         SRL   RE,4                                                             
         SLL   RE,8                                                             
         OR    R0,RE                                                            
*                                                                               
         SR    RE,RE                                                            
         D     RE,=F'60'                                                        
         CVD   RE,DUB                                                           
         L     RE,DUB+4                                                         
         SRL   RE,4                                                             
         SLL   RE,16                                                            
         OR    R0,RE                                                            
*                                                                               
         SR    RE,RE                                                            
         D     RE,=F'60'                                                        
         CVD   RE,DUB                                                           
         L     RE,DUB+4                                                         
         SRL   RE,4                                                             
         SLL   RE,24                                                            
         OR    R0,RE                                                            
*                                                                               
         ST    R0,0(R4)                                                         
         B     TDIFOK                                                           
*                                                                               
TDIFNO   B     NO                                                               
TDIFOK   B     YES                                                              
*                                                                               
YES      SR    RC,RC               RETURN CC EQUAL                              
NO       LTR   RC,RC               RETURN CC NOT EQUAL                          
         XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
         DROP  RB,RA,R9                                                         
         EJECT                                                                  
***********************************************************************         
* OPEN SYSTEM FILES                                                   *         
***********************************************************************         
         SPACE 1                                                                
OPENFIL  NMOD1 0,*OPNFIL*                                                       
         LR    RC,R1                                                            
*                                                                               
         L     R5,ADXBLOCK         A(DATA BLOCK)                                
         USING DXBLOCKD,R5                                                      
*                                  SET UTL SENUM                                
         L     RE,=V(UTL)                                                       
         MVC   4(1,RE),SENUM                                                    
*                                                                               
         CLI   INTAPE,C'Y'         TAPE FILE INPUT                              
         BNE   OFIL010                                                          
*&&UK*&& L     R6,=A(RCVTAPE)                                                   
*&&US                                                                           
         CLI   SYSCODE,C'R'        SPECIAL DCB FOR REP SYSTEM                   
         BNE   *+12                                                             
         L     R6,=A(RCVTAPER)                                                  
         B     OFIL002                                                          
         CLI   SYSCODE,C'P'        SPECIAL DCB FOR PRINT SYSTEM                 
         BNE   *+12                                                             
         L     R6,=A(RCVTAPEP)                                                  
         B     OFIL002                                                          
         CLI   SYSCODE,C'S'        SPECIAL DCB FOR SPOT SYSTEM                  
         BNE   *+12                                                             
         L     R6,=A(RCVTAPEP)                                                  
         B     OFIL002                                                          
         CLI   SYSCODE,C'N'        SPECIAL DCB FOR NET SYSTEM                   
         BNE   *+12                                                             
         L     R6,=A(RCVTAPEP)                                                  
         B     OFIL002                                                          
         L     R6,=A(RCVTAPE)                                                   
OFIL002  EQU   *                                                                
*&&                                                                             
         OPEN  ((R6),(INPUT))                                                   
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
OFIL010  EQU   *                                                                
         CLI   SQLOUT,C'Y'         WRITE SQL STATMENTS OUT                      
         BNE   OFIL020                                                          
         L     R6,=A(SQLOUTD)                                                   
         OPEN  ((R6),(OUTPUT))                                                  
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
OFIL020  EQU   *                                                                
         CLI   UDBERR,C'Y'         WRITE DXUDB ERROR SQL STATEMENTS             
         BNE   OFIL100                                                          
         L     R6,=A(UDBERRD)                                                   
         OPEN  ((R6),(OUTPUT))                                                  
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
OFIL100  EQU   *                                                                
         L     RF,DXSTSPTR         SET SYSTEM TABLE ENTRY POINTER               
         ST    RF,DXSTPTR            TO START OF TABLE                          
         CLI   MODE,DXPQRQ         TEST IF EXTRACT MODE = PQ REPORT             
         BE    OFILOK                                                           
         CLI   MODE,DXSQLQ         TEST IF EXTRACT MODE = SQL ONLY              
         BE    OFILOK                                                           
         CLI   MODE,DXTRANSQ       TEST IF EXTRACT MODE = TRANS UPDATE          
         BE    OFILOK                                                           
         CLI   XTRFLG,C'Y'         SUB SYS EXTRACT?                             
         BNE   OFILOK                                                           
*                                                                               
         MVI   DXMODE,DXOPENQ      CALL SUB SYSTEM MODULE IN OPEN MODE          
         L     R2,=A(SEXTAB)                                                    
OFIL130  CLI   0(R2),0             END OF TABLE                                 
         BE    OFIL200             DONE                                         
*                                                                               
         TM    SEXEXFLG(R2),SEXEXOPQ    CALL W/OPEN MODE ALREADY?               
         BO    OFIL160                  YES - NEXT                              
         ICM   RF,15,SEXEXT(R2)    A(SUB-SYSTEM EXTRACT PROGRAM)                
         BZ    OFIL160                                                          
         MVI   DXRETCDE,0                                                       
         MVI   DXSEGAFT,C'N'                                                    
         GOTO1 (RF),ADXBLOCK       CALL IT                                      
         BRAS  RE,SETMAXRC                                                      
         BNE   OFILERR1            EXIT IF ERROR RETURN                         
         OI    SEXEXFLG(R2),SEXEXOPQ    MARK OPENED                             
*                                                                               
         LR    R3,R2               CHECK REST FOR THE SAME PROGRAM              
OFIL140  CLI   0(R3),0             END OF TABLE                                 
         BE    OFIL160             CHECK NEXT EXTRACT PROGRAM                   
         TM    SEXEXFLG(R3),SEXEXOPQ    CALL W/OPEN MODE ALREADY?               
         BO    OFIL150                  YES - NEXT                              
         CLC   SEXNAME(8,R3),SEXNAME(R2)      SAME PROGRAM NAME?                
         BNE   OFIL150                        NO -  SKIP IT                     
         OI    SEXEXFLG(R3),SEXEXOPQ          YES - MARK OPENED                 
OFIL150  LA    R3,L'SEXTAB(R3)                                                  
         B     OFIL140                                                          
*                                                                               
OFIL160  LA    R2,L'SEXTAB(R2)                                                  
         B     OFIL130                                                          
OFIL200  B     OFILOK                                                           
*                                                                               
OFILERR1 EQU   *                                                                
         MVI   ERROR,ERSUBSYQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     OFILNO                                                           
*                                                                               
OFILOK   SR    RC,RC               EXIT OK                                      
OFILNO   LTR   RC,RC               EXIT ERROR                                   
         XIT1                                                                   
         DROP  R5                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* CLOSE SYSTEM FILES                                                  *         
***********************************************************************         
         SPACE 1                                                                
CLOSEFIL NMOD1 0,*CLOFIL*                                                       
         LR    RC,R1                                                            
*                                                                               
         MVI   MSGNUM,MSCLOSEQ                                                  
         GOTO1 =A(MSGPRT),(RC)                                                  
*                                                                               
         L     R5,ADXBLOCK         A(DATA BLOCK)                                
         USING DXBLOCKD,R5                                                      
*                                  SET UTL SENUM                                
         L     RE,=V(UTL)                                                       
         MVC   4(1,RE),SENUM                                                    
*                                                                               
         CLI   INTAPE,C'Y'         CLOSE TAPE INPUT FILE                        
         BNE   CFIL010                                                          
*&&UK*&& L     R6,=A(RCVTAPE)                                                   
*&&US                                                                           
         CLI   SYSCODE,C'R'        SPECIAL DCB FOR REP SYSTEM                   
         BNE   *+12                                                             
         L     R6,=A(RCVTAPER)                                                  
         B     CFIL002                                                          
         CLI   SYSCODE,C'P'        SPECIAL DCB FOR PRINT SYSTEM                 
         BNE   *+12                                                             
         L     R6,=A(RCVTAPEP)                                                  
         B     CFIL002                                                          
         CLI   SYSCODE,C'S'        SPECIAL DCB FOR SPOT SYSTEM                  
         BNE   *+12                                                             
         L     R6,=A(RCVTAPEP)                                                  
         B     CFIL002                                                          
         CLI   SYSCODE,C'N'        SPECIAL DCB FOR NET SYSTEM                   
         BNE   *+12                                                             
         L     R6,=A(RCVTAPEP)                                                  
         B     CFIL002                                                          
         L     R6,=A(RCVTAPE)                                                   
CFIL002  EQU   *                                                                
*&&                                                                             
         CLOSE ((R6))                                                           
*                                                                               
CFIL010  EQU   *                                                                
         CLI   SQLOUT,C'Y'         WRITE SQL STATMENTS OUT                      
         BNE   CFIL020                                                          
         L     R6,=A(SQLOUTD)                                                   
         CLOSE ((R6))                                                           
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
CFIL020  EQU   *                                                                
         CLI   UDBERR,C'Y'         WRITE DXUDB ERROR SQL STATEMENTS             
         BNE   CFIL100                                                          
         L     R6,=A(UDBERRD)                                                   
         CLOSE ((R6))                                                           
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
CFIL100  EQU   *                                                                
         L     RF,DXSTSPTR         SET SYSTEM TABLE ENTRY POINTER               
         ST    RF,DXSTPTR            TO START OF TABLE                          
         CLI   MODE,DXPQRQ         TEST IF EXTRACT MODE = PQ REPORT             
         BE    CFIL200                                                          
         CLI   MODE,DXSQLQ         TEST IF EXTRACT MODE = SQL ONLY              
         BE    CFIL200                                                          
         CLI   MODE,DXTRANSQ       TEST IF EXTRACT MODE = TRANS UPDATE          
         BE    CFIL200                                                          
         CLI   XTRFLG,C'Y'         SUB SYS EXTRACT?                             
         BNE   CFIL200                                                          
*                                                                               
         MVI   DXMODE,DXCLOSEQ     CALL SUB SYSTEM MODULE IN CLOSE MODE         
         L     R2,=A(SEXTAB)                                                    
CFIL110  CLI   0(R2),0             END OF TABLE                                 
         BE    CFIL200             DONE                                         
*                                                                               
         TM    SEXEXFLG(R2),SEXEXCLQ    CALL W/CLOSE MODE ALREADY?              
         BO    CFIL160                  YES - NEXT                              
         ICM   RF,15,SEXEXT(R2)    A(SUB-SYSTEM EXTRACT PROGRAM)                
         BZ    CFIL160                                                          
         MVI   DXRETCDE,0                                                       
         MVI   DXSEGAFT,C'N'                                                    
         GOTO1 (RF),ADXBLOCK       CALL IT                                      
         BRAS  RE,SETMAXRC                                                      
         BNE   CFILERR1            EXIT IF ERROR RETURN                         
         OI    SEXEXFLG(R2),SEXEXCLQ    MARK CLOSED                             
*                                                                               
         LR    R3,R2               CHECK REST FOR THE SAME PROGRAM              
CFIL140  CLI   0(R3),0             END OF TABLE                                 
         BE    CFIL160             CHECK NEXT EXTRACT PROGRAM                   
         TM    SEXEXFLG(R3),SEXEXCLQ    CALL W/OPEN MODE ALREADY?               
         BO    CFIL150                  YES - NEXT                              
         CLC   SEXNAME(8,R3),SEXNAME(R2)      SAME PROGRAM NAME?                
         BNE   CFIL150                        NO -  SKIP IT                     
         OI    SEXEXFLG(R3),SEXEXCLQ          YES - MARK OPENED                 
CFIL150  LA    R3,L'SEXTAB(R3)                                                  
         B     CFIL140                                                          
*                                                                               
CFIL160  LA    R2,L'SEXTAB(R2)                                                  
         B     CFIL110                                                          
*                                                                               
*&&US                                                                           
CFIL200  CLI   WRITE,C'Y'          CLOSE EXTRACT FILES                          
         BNE   CFILOK                                                           
*&&                                                                             
*&&UK                                                                           
*        CLOSE ANYTHING IN SHARED DDSIO NOT CLOSED BY EXTRACT PROGS             
*        UNLESS WE ARE A CONTROL SYSTEM EXTRACT - KEEP CONTROL OPEN             
*                                                                               
CFIL200  L     RE,=V(UTL)                                                       
         CLI   4(RE),CONTROLQ                                                   
         BE    CFIL210                                                          
         GOTO1 VDATAMGR,DMCB,DMCLSE,=C'FILES',,AIOL                             
*                                                                               
CFIL210  CLI   WRITE,C'Y'          CLOSE EXTRACT FILES                          
         BNE   CFILOK                                                           
*&&                                                                             
                                                                                
*----------------------------------                                             
* CLOSE EXTRACT FILES                                                           
*----------------------------------                                             
         L     R4,SXDTPTR          A(ENTRY IN SYSTEM DRIVER TABLE)              
         USING SXDTABD,R4                                                       
*                                                                               
CFIL220  C     R4,SXDTNXT          EXIT AT END OF SYSTEM DRIVER TABLE           
         BE    CFILOK                                                           
         ST    R4,DXSTPTR          ??                                           
*                                                                               
         OC    SXDTXDCB,SXDTXDCB   TEST EXTRACT FILE OPENED                     
         BNZ   CFIL240                                                          
         CLI   HEADFLAG,C'O'                                                    
         BE    *+12                                                             
         CLI   HEADFLAG,C'X'                                                    
         BNE   CFIL250                                                          
         GOTO1 =A(PUTXREC),DMCB,0,ADXBLOCK                                      
         BNE   CFILNO                                                           
CFIL240  MVI   LASTFILE,C'Y'                                                    
         GOTO1 =A(CLOSEXFL),(RC)                                                
         BNE   CFILNO                                                           
*                                                                               
CFIL250  CLI   CLEARFLG,C'N'       CHECK IF CLEAR FLAG ON                       
         BE    CFIL270                                                          
         GOTO1 =A(CLEARXCR),(RC)   CLEAR OLD EXTRACT CONTROL RECORDS            
         BNE   CFILNO                                                           
*                                                                               
CFIL270  EQU   *                                                                
         MVC   P(40),=CL40'RECORD COUNT:'                                       
         SP    SXDTRNUM,=PL2'2'                                                 
         EDIT  SXDTRNUM,(16,P+14),ZERO=NOBLANK,ALIGN=LEFT                       
         AP    SXDTRNUM,=PL2'2'                                                 
*                                                                               
CFIL280  LA    R4,SXDTABL(R4)                                                   
         B     CFIL220                                                          
*                                                                               
CFILERR1 MVI   ERROR,ERSUBSYQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     CFILNO                                                           
*                                                                               
CFILOK   SR    RC,RC               EXIT OK                                      
CFILNO   LTR   RC,RC               EXIT ERROR                                   
         XIT1                                                                   
         DROP  R4,R5                                                            
         LTORG                                                                  
                                                                                
***********************************************************************         
* VALIDATE JCL CARD DATA LINES AS DEFINED IN CARDTBL                  *         
***********************************************************************         
         DS    0D                                                               
VALCARDS NMOD1 0,**VALC**,RA                                                    
         L     RC,=A(WORKD)        RC=A(GLOBAL WORK)                            
*                                                                               
         MVI   MSGNUM,MSSYSINQ                                                  
         GOTO1 =A(MSGPRT),(RC)                                                  
         B     VCLP1A                                                           
*                                                                               
VCLP1    MVC   P+72(8),SPACES      CLEAR LEVEL #'S FROM SYSIN LINES             
         GOTO1 VPRINTER            SYSPRINT SYSIN CARDS                         
VCLP1A   GOTO1 VCARDS,DMCB,P,=C'RE00'                                           
         CLC   =C'/*',P            IF END OF JCL                                
         BE    VCEND                 CHECK REQUIRED CARDS INPUT                 
         CLC   =C'*',P             BUMP AROUND COMMENT CARD                     
         BE    VCLP1A                                                           
*                                                                               
         L     RE,=A(CARDTBL)      INITIALISE TABLE POINTER                     
*                                                                               
VCLP2    CLI   0(RE),0             END OF TABLE                                 
         BE    VCERR1              CARD NOT IN TABLE                            
         SR    RF,RF                                                            
         IC    RF,CLENGTH(RE)                                                   
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   P(0),CSTRING(RE)    COMPARE STRING                               
         BE    VCLP2X                                                           
         LA    RE,L'CARDTBL(RE)    GET NEXT ENTRY                               
         B     VCLP2                                                            
*                                                                               
VCLP2X   SR    RF,RF               MATCH FOUND                                  
         IC    RF,CROUTINE(RE)                                                  
         SLL   RF,2                                                             
         B     *+0(RF)             BRANCH TO PROCESSING ROUTINE                 
*                                    FROM JUMP TABLE                            
         B     VCSYSTEM                                                         
         B     VCAGENCY                                                         
         B     VCMEDIA                                                          
         B     VCTIME                                                           
         B     VCINPUT                                                          
         B     VCDATE                                                           
         B     VCCMPANY                                                         
         B     VCMODE                                                           
         B     VCTYPE                                                           
         B     VCFACPAK                                                         
         B     VCWRITE                                                          
         B     VCPATCH                                                          
         B     VCDDSIO                                                          
         B     VCMEDAGY                                                         
         B     VCMAXREC                                                         
         B     VCPSIZE                                                          
         B     VCSSIZE                                                          
         B     VCPLFORM                                                         
         B     VCDFORM                                                          
         B     VCHEADER                                                         
         B     VCTTIM                                                           
         B     VCETIM                                                           
         B     VCSTIM                                                           
         B     VCNAME                                                           
         B     VCSEND                                                           
         B     VCSUBSYS                                                         
         B     VCCLOSE                                                          
         B     VCSTART                                                          
         B     VCEXFCOD                                                         
         B     VCEXFTIM                                                         
         B     VCDELIM                                                          
         B     VCEOR                                                            
         B     VCTEXT                                                           
         B     VCNULL                                                           
         B     VCMONEY                                                          
         B     VCSERVER                                                         
         B     VCDBASE                                                          
         B     VCSQLUSE                                                         
         B     VCPASSWD                                                         
         B     VCRESET                                                          
         B     VCCOMMIT                                                         
         B     VCAPPKEY                                                         
         B     VCTEST                                                           
         B     VCSQL                                                            
         B     VCLOAD                                                           
         B     VCCLEAR                                                          
         B     VCFROM                                                           
         B     VCUSERID                                                         
         B     VCPQID                                                           
         B     VCSQLBEF                                                         
         B     VCSQLAFT                                                         
         B     VCTST                                                            
         B     VCREFORM                                                         
         B     VCRECOV                                                          
         B     VCDIET                                                           
         B     VCCNTRY                                                          
         B     VCAUTO                                                           
         B     VCDEBUG                                                          
         B     VCDUMP                                                           
         B     VCESS                                                            
         B     VCVER                                                            
         B     VCUSERP                                                          
         B     VCREPLAC                                                         
         B     VCHOSTDB                                                         
         B     VCDBAUTH                                                         
         B     VCDBSSYS                                                         
         B     VCFILTS                                                          
         B     VCZERO                                                           
         B     VCDELETE                                                         
         B     VCFORMAT                                                         
         B     VCFIXED                                                          
         B     VCENDMOD                                                         
         B     VCTRANS                                                          
         B     VCESCAPE                                                         
         B     VCNULLIF                                                         
         B     VCSCHEMA                                                         
         B     VCLOCATN                                                         
         B     VCERROR                                                          
         B     VCTIMNOW                                                         
         B     VCDBID                                                           
         B     VCSQLOUT                                                         
         B     VCUDBERR                                                         
         B     VCCONT                                                           
         B     VCUPDATE                                                         
         B     VCDSPACE                                                         
         B     VCHEXOUT                                                         
         B     VCQUOTES                                                         
         B     VCVCHAR                                                          
         B     VCREADO                                                          
         B     VCOFFLIN                                                         
         B     VCSKIP                                                           
         B     VCPOST                                                           
         B     VCPDSN                                                           
         B     VCWRTXF                                                          
         B     VCXTRACT                                                         
         B     VCFLTUAD                                                         
         B     VCREFSTA                                                         
         B     VCEMAIL                                                          
         B     VCRUN                                                            
         B     VCSFA                                                            
         B     VCCLI                                                            
         B     VCNET                                                            
         B     VCKEY                                                            
         B     VCRFABD                                                          
         B     VCDSNLMT                                                         
         B     VCOVRDSN                                                         
         B     VCDSNAME                                                         
         B     VCALLAGY                                                         
         B     VESSPROG                                                         
         B     VESSCMND                                                         
         B     VCTHREAD                                                         
         B     VCTDATE                                                          
         B     VCFLASH                                                          
         B     VCCLIRNG                                                         
         B     VCCLOXMO                                                         
         B     VBSCHDR                                                          
         B     VCTSLICE                                                         
         B     VCHOPDSN                                                         
         B     VCTSTRUN                                                         
         B     VCAGXBUF                                                         
         B     VSMF                                                             
         B     V8KEXFILE                                                        
         B     VKPEMPTY                                                         
         B     VLOADPHS                                                         
*                                  EXIT/ERROR CONDITIONS                        
*                                  CHECK REQUIRED INPUT                         
VCEND    EQU   *                                                                
*                                                                               
         OC    USERID,USERID                                                    
         BZ    VCEN100                                                          
         MVC   P(20),=CL20'BEFORE CTFILE OPEN'                                  
         GOTO1 VPRINTER                                                         
         GOTO1 =A(OPENCUPD),(RC)   OPEN CONTROL FILES FOR UPDATE/READ           
*                                                                               
         LA    R2,IOKEY                                                         
         USING CTIKEY,R2                                                        
         XC    CTIKEY,CTIKEY                                                    
         MVI   CTIKTYP,CTIKTYPQ                                                 
         MVC   CTIKID,USERID                                                    
         LAY   R2,IO              READ USER ID RECORD                           
*                                                                               
         GOTO1 VDATAMGR,DMCB,DMREAD,CTFILE,IOKEY,(R2),0                         
         CLI   8(R1),0                                                          
         BNE   VCERR7                                                           
         MVC   P(20),=CL20'AFTER CTFILE READ'                                   
         GOTO1 VPRINTER                                                         
*                                                                               
         XC    UIDFILT,UIDFILT                                                  
         XC    USERAGY,USERAGY                                                  
         LA    R3,CTIDATA                                                       
VCENU10  CLI   0(R3),0                                                          
         BE    VCENU90                                                          
         CLI   0(R3),X'02'                                                      
         BE    VCENU30                                                          
         CLI   0(R3),X'06'                                                      
         BE    VCENU40                                                          
VCENU20  SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     VCENU10                                                          
VCENU30  MVC   UIDFILT,2(R3)                                                    
         B     VCENU20                                                          
VCENU40  MVC   USERAGY,2(R3)                                                    
         B     VCENU20                                                          
VCENU90  OC    UIDFILT,UIDFILT                                                  
         BZ    VCERR7                                                           
         OC    USERAGY,USERAGY                                                  
         BZ    VCERR7                                                           
         MVC   P(20),=CL20'AFTER USERID PROCESS'                                
         GOTO1 VPRINTER                                                         
         DROP  R2                                                               
*                                                                               
VCEN100  OC    USERAGY,USERAGY                                                  
         BZ    VCEN120                                                          
         OC    AGYFILT,AGYFILT                                                  
         BZ    VCEN110                                                          
         CLC   AGYFILT,USERAGY                                                  
         BNE   VCERR7                                                           
         B     VCEN120                                                          
VCEN110  MVC   AGYFILT,USERAGY                                                  
VCEN120  CLI   MODE,DXPQRQ                                                      
         BE    VCEN140                                                          
         OC    SYSFILT,SYSFILT                                                  
         BZ    VCERR4                                                           
         CLI   AUTOFLAG,ON                                                      
         BE    VCEN130                                                          
         OC    SUBFILT,SUBFILT                                                  
         BZ    VCERR8                                                           
         OC    AGYFILT,AGYFILT                                                  
         BZ    VCERR10                                                          
         B     VCEN140                                                          
VCEN130  EQU   *                                                                
         CLI   POSTONLY,C'Y'                                                    
         BE    VCEN140                                                          
         CLI   MODE,DXLOADQ                                                     
         BE    VCEN140                                                          
         CLI   MODE,DXSQLQ                                                      
         BE    VCEN140                                                          
         CLI   MODE,DXSTATQ                                                     
         BE    VCEN140                                                          
         CLI   MODE,DXSTATCSQ                                                   
         BE    VCEN140                                                          
         CLI   DAILYFLG,ON                                                      
         BE    VCEN140                                                          
         CLI   INTAPE,C'Y'                                                      
         BE    VCEN140                                                          
         CLI   HOSTDB,C'Y'                                                      
         BE    VCEN140                                                          
         OC    SUBFILT,SUBFILT                                                  
         BNZ   VCERR9                                                           
         OC    AGYFILT,AGYFILT                                                  
         BNZ   VCERR11                                                          
         B     VCEN140                                                          
*                                                                               
VCEN140  DS    0H                                                               
         CLC   LOADPHS,SPACES                                                   
         BNH   VCEN150                                                          
         CLI   MODE,DXLOADQ                                                     
         BNE   VCERR13                                                          
         OC    AGYFILT,AGYFILT                                                  
         BZ    VCERR13                                                          
         B     VCEN150                                                          
*                                                                               
VCEN150  DS    0H                                                               
         B     VCOK                                                             
*                                  CARD DATA ERROR CONDITIONS                   
VCERR1   MVC   P+72(8),SPACES                                                   
         GOTO1 VPRINTER            INVALID CARD                                 
         MVI   ERROR,ERINCCIQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     VCNO                                                             
*                                                                               
VCERR2   MVC   P+72(8),SPACES                                                   
         GOTO1 VPRINTER            MISSING SYSTEM DEFINITION                    
         MVI   ERROR,ERMISSDQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     VCNO                                                             
*                                                                               
VCERR3   MVC   P+72(8),SPACES                                                   
         GOTO1 VPRINTER            INVALID SYSTEM NAME                          
         MVI   ERROR,ERINSYNQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     VCNO                                                             
*                                                                               
VCERR4   MVC   P+72(8),SPACES                                                   
         GOTO1 VPRINTER            MISSING SYSTEM NAME                          
         MVI   ERROR,ERMISSNQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     VCNO                                                             
*                                                                               
VCERR5   MVC   P+72(8),SPACES                                                   
         GOTO1 VPRINTER            INVALID SUB SYSTEM NAME                      
         MVI   ERROR,ERINSUNQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     VCNO                                                             
*                                                                               
VCERR6   MVC   P+72(8),SPACES                                                   
         GOTO1 VPRINTER            INVALID AGENCY FILTER                        
         MVI   ERROR,ERINAGYQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     VCNO                                                             
*                                                                               
VCERR7   MVC   P+72(8),SPACES                                                   
         GOTO1 VPRINTER            INVALID USERID/AGENCY FILTERS                
         MVI   ERROR,ERINUSEQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     VCNO                                                             
*                                                                               
VCERR8   MVC   P+72(8),SPACES                                                   
         GOTO1 VPRINTER            MISSING SUB SYSTEM FILTER                    
         MVI   ERROR,ERMISUFQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     VCNO                                                             
*                                                                               
VCERR9   MVC   P+72(8),SPACES                                                   
         GOTO1 VPRINTER            SUB SYSTEM FILTER NOT ALLOWED                
         MVI   ERROR,ERNASUFQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     VCNO                                                             
*                                                                               
VCERR10  MVC   P+72(8),SPACES                                                   
         GOTO1 VPRINTER            MISSING AGENCY FILTER                        
         MVI   ERROR,ERMIAGYQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     VCNO                                                             
*                                                                               
VCERR11  MVC   P+72(8),SPACES                                                   
         GOTO1 VPRINTER            AGENCY FILTER NOT ALLOWED                    
         MVI   ERROR,ERNAAGYQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     VCNO                                                             
*                                                                               
VCERR12  MVC   P+72(8),SPACES                                                   
         GOTO1 VPRINTER            INVALID CLIENT RANGE                         
         MVI   ERROR,ERCRNGQ                                                    
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     VCNO                                                             
*                                                                               
VCERR13  MVC   P+72(8),SPACES                                                   
         GOTO1 VPRINTER            LOADPHASE= REQUIREMENTS NOT MET              
         MVI   ERROR,ERLDPHSQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     VCNO                                                             
*                                                                               
VCOK     SR    RC,RC               EXIT ERROR CONDITION                         
VCNO     LTR   RC,RC               EXIT OK                                      
         XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* ROUTINES TO PROCESS EACH JCL CARD DATA LINE                         *         
***********************************************************************         
         SPACE 1                                                                
VCSYSTEM EQU    *                   SYSTEM=                                     
         LA    R4,P+7                                                           
         SR    RF,RF                                                            
*                                                                               
VCSY010  CLI   0(R4),C' '                                                       
         BE    VCSY012                                                          
         CLI   0(R4),C'='                                                       
         BE    VCSY012                                                          
         LA    RF,1(RF)                                                         
         LA    R4,1(R4)                                                         
         B     VCSY010                                                          
*                                                                               
VCSY012  LTR   RF,RF                                                            
         BZ    VCERR3                                                           
         BCTR  RF,0                                                             
         L     R3,=A(SYSLST)                                                    
         USING SYSLSTD,R3                                                       
         LA    R3,6(R3)            R3=A(SYSTEM LIST)                            
*                                                                               
VCSY020  CLI   0(R3),0             TEST E-O-T                                   
         BE    VCSY024                                                          
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   SYSLNAME(0),P+7                                                  
         BE    VCSY030                                                          
VCSY022  LA    R3,SYSLLEN(R3)      NO - BUMP TO NEXT TABLE ENTRY                
         B     VCSY020                                                          
*                                                                               
VCSY024  L     R3,=A(SYSLEX)                                                    
         LA    R3,6(R3)            R3=A(EXTENDED SYSTEM LIST)                   
*                                                                               
VCSY026  CLI   0(R3),0             TEST E-O-T                                   
         BE    VCERR3                                                           
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   SYSLNAME(0),P+7                                                  
         BE    VCSY030                                                          
VCSY028  LA    R3,SYSLLEN(R3)      NO - BUMP TO NEXT TABLE ENTRY                
         B     VCSY026                                                          
*                                                                               
VCSY030  MVC   SYSCODE,SYSLRPLT    RETURN SYSTEM CODE                           
*&&US                                                                           
         CLI   SYSLNUM,X'03'       OVERRIDE FOR NET SYSTEM                      
         BNE   *+8                                                              
         MVI   SYSCODE,C'N'                                                     
*&&                                                                             
         CLI   SYSTEM,1            TEST FOR SERVICE SYSTEM                      
         BNE   *+8                                                              
         MVI   SYSCODE,C'0'        OVERRIDE BLANK                               
         MVC   SYSFILT,SYSLNUM     AND SYSTEM NUMBER                            
*                                                                               
         CLI   0(R4),C' '                                                       
         BE    VCLP1                                                            
         CLI   0(R4),C'='                                                       
         BNE   VCERR1                                                           
*                                                                               
VCSY100  EQU   *                                                                
         LA    R4,1(R4)                                                         
         CLI   0(R4),C' '                                                       
         BE    VCERR1                                                           
*                                                                               
         LA    R1,VALCHRS                                                       
VCSY110  CLI   0(R1),X'FF'                                                      
         BE    VCERR1                                                           
         CLC   0(1,R1),0(R4)                                                    
         BE    VCSY120                                                          
         LA    R1,1(R1)                                                         
         B     VCSY110                                                          
*                                                                               
VCSY120  CLI   1(R4),C' '                                                       
         BE    VCSY150                                                          
*                                                                               
         LA    R1,VALCHRS                                                       
VCSY130  CLI   0(R1),X'FF'                                                      
         BE    VCERR1                                                           
         CLC   0(1,R1),1(R4)                                                    
         BE    VCSY150                                                          
         LA    R1,1(R1)                                                         
         B     VCSY130                                                          
*                                                                               
VCSY150  EQU   *                                                                
*                                  FIND THE SENUM FOR FILE CODE FILTER          
         MVC   SESNAM,=CL5'S=???'                                               
         MVC   SESNAM+2(1),SYSCODE                                              
         MVC   SESNAM+3(2),0(R4)   2 CHAR SYSTEM FILE CODE                      
*                                                                               
         GOTO1 =V(DMDDNAME),DMCB,(X'24',=C'DDNAME'),SESNAM,0                    
         CLI   8(R1),0                                                          
         BNE   *+14                                                             
         L     RF,8(R1)            GET A(FILE INFO LIST)                        
         MVC   SYSXFILT,1(RF)      EXTRACT SENUM                                
*                                                                               
         B     VCLP1                                                            
         DROP  R3                                                               
         EJECT                                                                  
VCAGENCY EQU   *                   AGENCY=                                      
         MVC   AGYFILT,P+7                                                      
         B     VCLP1                                                            
         SPACE 1                                                                
VCCMPANY EQU   *                   COMPANY=                                     
         GOTO1 VHEXIN,DMCB,P+8,CPYFILT,2,0                                      
         CLC   12(4,R1),=F'1'                                                   
         BNE   VCERR1                                                           
         B     VCLP1                                                            
         SPACE 1                                                                
VCMEDIA  EQU   *                   MEDIA=                                       
         CLI   P+6,C'T'                                                         
         BE    VCME010                                                          
         CLI   P+6,C'P'                                                         
         BE    VCME010                                                          
         B     VCERR1                                                           
VCME010  MVC   FILTER1,P+6                                                      
         B     VCLP1                                                            
         SPACE 1                                                                
VCTIME   EQU   *                   TIME=HHMM-HHMM                               
         LA    R0,9                                                             
         GOTO1 VTIMBER,DMCB,(X'80',(R0)),(X'01',XFTIMEP),P+5                    
         CLI   0(R1),0                                                          
         BNE   VCTI010                                                          
         SR    R1,R1                                                            
         ICM   R1,12,XFTIMEP                                                    
         STCM  R1,15,FFTIME                                                     
         SR    R1,R1                                                            
         ICM   R1,12,XTTIMEP                                                    
         STCM  R1,15,FTTIME                                                     
         B     VCLP1                                                            
VCTI010  EQU   *                   TIME=HHMM                                    
         LA    R0,4                                                             
         GOTO1 VTIMBER,DMCB,(X'C0',(R0)),(X'01',XFTIMEP),P+5                    
         CLI   0(R1),0                                                          
         BNE   VCERR1                                                           
         SR    R1,R1                                                            
         ICM   R1,12,XFTIMEP                                                    
         STCM  R1,15,FFTIME                                                     
         STCM  R1,15,FTTIME                                                     
         B     VCLP1                                                            
         SPACE 1                                                                
*                                                                               
***********************************************************************         
* TIMESLICE=HHMMSS-HHMMSS                                                       
***********************************************************************         
VCTSLICE EQU   *                                                                
         GOTO1 =A(VALTIME),DMCB,P+10,SLICEFRO                                   
         BNE   VCERR1                                                           
         GOTO1 =A(VALTIME),DMCB,P+17,SLICETO                                    
         BNE   VCERR1                                                           
         B     VCLP1                                                            
*                                                                               
VCINPUT  EQU   *                   INPUT=                                       
         CLC   P+6(4),=C'TAPE'                                                  
         BNE   *+8                                                              
         MVI   INTAPE,C'Y'                                                      
         LA    RE,P+6                                                           
         CLI   0(RE),C' '                                                       
         BE    VCERR1                                                           
         L     RF,=A(INPTAB)                                                    
         SR    R1,R1                                                            
VCIN010  CLI   0(RF),0                                                          
         BE    VCERR1                                                           
         IC    R1,0(RF)                                                         
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         CLC   1(0,RF),0(RE)                                                    
         BE    VCIN020                                                          
         LA    RF,L'INPTAB(RF)                                                  
         B     VCIN010                                                          
VCIN020  MVC   INPCODE,9(RF)                                                    
         B     VCLP1                                                            
         SPACE 1                                                                
VCDATE   EQU   *                   DATE=START-END                               
         LA    R3,WORK                                                          
         LA    R0,30                                                            
         USING PERVALD,R3                                                       
         GOTO1 VPERVAL,DMCB,((R0),P+5),(0,(R3))                                 
         CLI   4(R1),0                                                          
         BNE   VCERR1                                                           
         MVC   XFDATE,PVALBSTA                                                  
         MVC   XTDATE,PVALBEND                                                  
         B     VCLP1                                                            
         DROP  R3                                                               
         SPACE 1                                                                
VCMODE   EQU   *                   MODE=                                        
         CLI   MODE,DXUPDTQ        RESET DEFAULT MODE                           
         BNE   *+8                                                              
         MVI   MODE,0                                                           
         LAY   RE,MODETAB                                                       
VCMO010  CLI   0(RE),X'FF'                                                      
         BE    VCERR1                                                           
         CLC   0(8,RE),P+5                                                      
         BE    VCMO020                                                          
         LA    RE,L'MODETAB(RE)                                                 
         B     VCMO010                                                          
VCMO020  OC    MODE,8(RE)          OR IN THE MODE BIT                           
         MVI   MODEPQL,C'N'        MODE=PQ W/O LOAD OPTION                      
         CLC   =C'PRINTQ,L',P+5                                                 
         BNE   VCLP1                                                            
         MVI   MODEPQL,C'Y'        MODE=PQ W/ LOAD OPTION                       
         B     VCLP1                                                            
         SPACE 1                                                                
VCTYPE   EQU   *                   TYPE=                                        
         CLC   P+5(4),=CL4'AUTO'                                                
         BNE   *+12                                                             
         MVI   AUTOFLAG,ON                                                      
         B     VCLP1                                                            
         MVC   EXTYPE,P+5                                                       
         B     VCLP1                                                            
         SPACE 1                                                                
VCFACPAK EQU   *                   FACPAK=                                      
         CLI   P+7,C'1'                                                         
         BL    VCERR1                                                           
         CLI   P+7,C'Z'                                                         
         BH    VCERR1                                                           
         MVC   FACID,P+7                                                        
         B     VCLP1                                                            
         SPACE 1                                                                
VCWRITE  EQU   *                   WRITE=                                       
         MVC   WRITE,P+6                                                        
         CLI   WRITE,C'Y'          UPDATE OUTPUT FILE                           
         BE    VCWR020                                                          
         CLI   WRITE,C'N'          INHIBIT WRITES (BUT NOT ALL)                 
         BNE   VCERR1                                                           
VCWR020  CLI   P+7,C'X'            YX/NX = INHIBIT DMGR WRITES VIA SSB          
         BNE   VCLP1               (PREVENTS *ALL* DMGR WRITES)                 
         L     RF,=A(SSB)                                                       
         OI    SSOMTIND-SSOOFF(RF),SSOWRTN                                      
         B     VCLP1                                                            
         SPACE 1                                                                
VCPATCH  EQU   *                   PATCH=111111 11                              
         XC    FULL,FULL           GET DISPLACEMENT INTO FULL                   
         GOTO1 VHEXIN,DMCB,P+6,FULL+1,6                                         
         CLC   DMCB+12(4),=F'3'                                                 
         BNE   VCERR1              MUST BE 6 HEX DIGITS                         
         LA    R2,P+71             FIND LENGTH OF PATCH DATA                    
         LH    RE,=H'-1'                                                        
         LA    RF,P+12                                                          
         CLI   0(R2),C' '                                                       
         BNE   *+12                                                             
         BXH   R2,RE,*-8                                                        
         B     VCERR1                                                           
         SR    R2,RF               L'PATCH DATA IN R2                           
         GOTO1 VHEXIN,DMCB,P+13,WORK,(R2)                                       
         ICM   R1,15,DMCB+12       GET L'HEX PATCH DATA IN R1                   
         BZ    VCERR1              ZERO IS NOT ALLOWED                          
         BCTR  R1,0                                                             
         L     RF,FULL             PATCH DISPLACEMENT IN RF                     
         A     RF,RBSAVE           RF = A(AREA TO BE PATCHED)                   
         EX    R1,*+8              MOVE IN THE PATCH DATA                       
         B     VCLP1                                                            
         MVC   0(0,RF),WORK                                                     
         SPACE 1                                                                
VCDDSIO  EQU   *                   DDSIO=                                       
         L     RF,=V(DDSIO)                                                     
         LTR   RF,RF                                                            
         BZ    VCERR1                                                           
         MVC   0(8,RF),P+6                                                      
         B     VCLP1                                                            
         SPACE 1                                                                
VCMEDAGY EQU   *                   MEDAGY=                                      
         GOTO1 VNUMVAL,DMCB,P+7,(X'02',0)                                       
         CLI   0(R1),0                                                          
         BNE   VCERR1                                                           
         L     R1,4(R1)                                                         
         C     R1,=F'15'                                                        
         BH    VCERR1                                                           
         C     R1,=F'1'                                                         
         BL    VCERR1                                                           
         SLL   R1,4                                                             
         STC   R1,MEDAGY                                                        
         B     VCLP1                                                            
         SPACE 1                                                                
VCMAXREC EQU   *                   MAXRECS=                                     
         GOTO1 VNUMVAL,DMCB,P+8,(X'02',0)                                       
         CLI   0(R1),0                                                          
         BNE   VCERR1                                                           
         L     R1,4(R1)                                                         
         C     R1,MAXRECS                                                       
         BH    VCERR1                                                           
         C     R1,=F'1'                                                         
         BL    VCERR1                                                           
         ST    R1,MAXRECS                                                       
         B     VCLP1                                                            
         SPACE 1                                                                
VCPSIZE  EQU   *                   PSIZE=                                       
         GOTO1 VNUMVAL,DMCB,P+6,(X'02',0)                                       
         CLI   0(R1),0                                                          
         BNE   VCERR1                                                           
         L     R1,4(R1)                                                         
         SR    RF,RF                                                            
         ICM   RF,7,APALLOCM                                                    
         CR    R1,RF                                                            
         BH    VCERR1                                                           
         C     R1,=F'1'                                                         
         BL    VCERR1                                                           
         STCM  R1,7,APALLOCP                                                    
         B     VCLP1                                                            
         SPACE 1                                                                
VCSSIZE  EQU   *                   SSIZE=                                       
         GOTO1 VNUMVAL,DMCB,P+6,(X'02',0)                                       
         CLI   0(R1),0                                                          
         BNE   VCERR1                                                           
         L     R1,4(R1)                                                         
         SR    RF,RF                                                            
         ICM   RF,7,ASALLOCM                                                    
         CR    R1,RF                                                            
         BH    VCERR1                                                           
         C     R1,=F'1'                                                         
         BL    VCERR1                                                           
         STCM  R1,7,ASALLOCP                                                    
         B     VCLP1                                                            
         SPACE 1                                                                
VCPLFORM EQU   *                   PLATFORM=                                    
         LA    RE,P+9                                                           
         CLI   0(RE),C' '                                                       
         BE    VCERR1                                                           
         L     RF,=A(PLATTAB)                                                   
         SR    R1,R1                                                            
VCPL010  CLI   0(RF),0                                                          
         BE    VCERR1                                                           
         IC    R1,0(RF)                                                         
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         CLC   1(0,RF),0(RE)                                                    
         BE    VCPL020                                                          
         LA    RF,L'PLATTAB(RF)                                                 
         B     VCPL010                                                          
VCPL020  MVC   PLATFORM,9(RF)                                                   
         B     VCLP1                                                            
         SPACE 1                                                                
VCDFORM  EQU   *                   DATEFORM=                                    
         GOTO1 VNUMVAL,DMCB,P+9,(X'02',0)                                       
         CLI   0(R1),0                                                          
         BNE   VCERR1                                                           
         L     R1,4(R1)                                                         
         C     R1,=F'15'                                                        
         BH    VCERR1                                                           
         C     R1,=F'0'                                                         
         BL    VCERR1                                                           
         STC   R1,DATEFORM                                                      
         B     VCLP1                                                            
         SPACE 1                                                                
VCHEADER EQU   *                   HEADER=                                      
         CLI   P+7,C'N'                                                         
         BE    VCHD010                                                          
         CLI   P+7,C'X'            READ CTFILE XREC'S TO BUILD HEADER           
         BE    VCHD010                                                          
         CLI   P+7,C'O'                                                         
         BNE   VCLP1                                                            
VCHD010  MVC   HEADFLAG,P+7                                                     
         B     VCLP1                                                            
         SPACE 1                                                                
VCTTIM   EQU   *                   FREQUENCY=                                   
         CLC   P+10(5),=CL5'DAILY'                                              
         BNE   *+12                                                             
         MVI   DAILYFLG,ON                                                      
         B     VCLP1                                                            
         CLC   P+10(5),=CL5'ONCE'                                               
         BNE   *+12                                                             
         MVI   ONCEFLG,C'Y'                                                     
         B     VCLP1               DAILY UPDATES                                
         GOTO1 VNUMVAL,DMCB,P+10,(2,0)                                          
         CLI   DMCB,0                                                           
         BNE   VCERR1              NOT NUMERIC                                  
         L     R1,DMCB+4                                                        
         MH    R1,=H'100'          SCALE THE TIME TO HUNDREDS OF SECS           
         ST    R1,TRAWLTIM                                                      
         B     VCLP1                                                            
         SPACE 1                                                                
VCETIM   EQU   *                   EXTRATIME=                                   
         GOTO1 VNUMVAL,DMCB,P+10,(2,0)                                          
         CLI   DMCB,0                                                           
         BNE   VCERR1              NOT NUMERIC                                  
         L     R1,DMCB+4                                                        
         MH    R1,=H'100'          SCALE THE TIME TO HUNDREDS OF SECS           
         ST    R1,EXTRATIM                                                      
         B     VCLP1                                                            
         SPACE 1                                                                
VCSTIM   EQU   *                   SLEEPTIME=                                   
         GOTO1 VNUMVAL,DMCB,P+10,(2,0)                                          
         CLI   DMCB,0                                                           
         BNE   VCERR1              NOT NUMERIC                                  
         L     R1,DMCB+4                                                        
         MH    R1,=H'100'          SCALE THE TIME TO HUNDREDS OF SECS           
         ST    R1,SLEEPTIM                                                      
         B     VCLP1                                                            
         SPACE 1                                                                
         SPACE 1                                                                
VCNAME   EQU   *                   NAME=SHORT                                   
         CLC   P+5(5),=CL5'SHORT'                                               
         BNE   VCLP1                                                            
         MVI   DSNFLAG,C'S'        SET DATA SET NAME FLAG TO SHORT FORM         
         B     VCLP1                                                            
         SPACE 1                                                                
VCSEND   EQU   *                   SEND=NO/YES/LUID                             
         CLC   P+5(2),=CL2'NO'                                                  
         BE    VCLP1                                                            
         CLC   P+5(3),=CL3'YES'                                                 
         BNE   *+12                                                             
         MVI   SENDFLAG,C'Y'                                                    
         B     VCLP1                                                            
         CLC   P+5(3),=CL3'BDE'                                                 
         BNE   *+12                                                             
         MVI   SENDFLAG,C'B'                                                    
         B     VCLP1                                                            
         CLC   P+5(7),=CL7'ACC-BDE'                                             
         BNE   *+12                                                             
         MVI   SENDFLAG,C'A'                                                    
         B     VCLP1                                                            
         MVI   SENDFLAG,C'L'                                                    
         MVC   ESSID,P+5                                                        
         B     VCLP1                                                            
         SPACE 1                                                                
VCSUBSYS EQU   *                   SUBSYS=                                      
         USING SUBLSTD,RE                                                       
         L     RE,=A(SUBLST)       CHECK IN TABLE OF VALID SYSTEMS              
         LA    RE,6(RE)                                                         
*                                                                               
VCSU010  CLI   SUBLNUM,0                                                        
         BE    VCERR5                                                           
         CLC   P+7(L'SUBLNAME),SUBLNAME                                         
         BE    VCSU020                                                          
         LA    RE,SUBLLEN(RE)                                                   
         B     VCSU010                                                          
*                                                                               
VCSU020  MVC   SUBSYS(L'SUBLNUM),SUBLNUM   SET SYSTEM NUMBER FROM LIST          
         MVC   SUBCHAR(L'SUBCHAR),SUBLKEY1  GET SYSTEM KEY CHARACTER            
         MVC   SUBNAME(L'SUBLNAME),SUBLNAME  GET FULL SYSTEM NAME               
         MVC   SUBFILT,SUBSYS                                                   
         B     VCLP1                                                            
         DROP  RE                                                               
         SPACE 1                                                                
VCCLOSE  EQU   *                   CLOSE=YES                                    
         MVC   CLOSFLAG,P+6                                                     
         CLI   CLOSFLAG,C'N'                                                    
         BE    VCLP1                                                            
         CLI   CLOSFLAG,C'Y'                                                    
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCRUN    EQU   *                   RUN=1/NO                                     
         MVC   RUNFLAG,P+4                                                      
         CLI   RUNFLAG,C'N'                                                     
         BE    VCLP1                                                            
         CLI   RUNFLAG,C'1'                                                     
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCSFA    EQU   *                   SKIPFILEA=YES/NO                             
         MVC   SFAFLAG,P+10                                                     
         CLI   SFAFLAG,C'N'                                                     
         BE    VCLP1                                                            
         CLI   SFAFLAG,C'Y'                                                     
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCCLI    EQU   *                   CLI=CL3                                      
         MVC   CLIENT,P+4                                                       
         B     VCLP1                                                            
         SPACE 1                                                                
VCNET    EQU   *                   NET=CL5                                      
         MVC   NETWORK,P+4                                                      
         B     VCLP1                                                            
         SPACE 1                                                                
VCKEY    EQU   *                   KEY=CL64                                     
         MVC   KEYFIT,P+4                                                       
         B     VCLP1                                                            
         SPACE 1                                                                
VCSTART  EQU   *                   START=YES/ON/OVERRIDE                        
         MVC   STARFLAG,P+6                                                     
         CLI   STARFLAG,C'N'                                                    
         BE    VCLP1                                                            
         CLI   STARFLAG,C'Y'                                                    
         BE    VCLP1                                                            
         CLI   STARFLAG,C'O'                                                    
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCEXFCOD EQU   *                   EXFCODE=                                     
         MVC   EXFCODE,P+8                                                      
         B     VCLP1                                                            
         SPACE 1                                                                
VCEXFTIM EQU   *                   EXFTIME=                                     
         LA    R0,5                                                             
         GOTO1 VTIMBER,DMCB,(X'C0',(R0)),(X'02',EXFTIME),P+8                    
         CLI   0(R1),0                                                          
         BNE   VCERR1                                                           
         B     VCLP1                                                            
         SPACE 1                                                                
VCDELIM  EQU   *                   DELIMITER=                                   
         LA    RE,P+10                                                          
         CLI   0(RE),C' '                                                       
         BE    VCERR1                                                           
         L     RF,=A(DELIMTAB)                                                  
         SR    R1,R1                                                            
VCDE010  CLI   0(RF),0                                                          
         BE    VCDE030                                                          
         IC    R1,1(RF)                                                         
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         CLC   2(0,RF),0(RE)                                                    
         BE    VCDE020                                                          
         LA    RF,L'DELIMTAB(RF)                                                
         B     VCDE010                                                          
VCDE020  MVC   DELIM,0(RF)                                                      
         B     VCLP1                                                            
VCDE030  MVC   DELIM,0(RE)                                                      
         B     VCLP1                                                            
         SPACE 1                                                                
VCEOR    EQU   *                   EOR=                                         
         LA    RE,P+4                                                           
         CLI   0(RE),C' '                                                       
         BE    VCERR1                                                           
         L     RF,=A(EORTAB)                                                    
         SR    R1,R1                                                            
VCEO010  CLI   0(RF),0                                                          
         BE    VCEO030                                                          
         IC    R1,0(RF)                                                         
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         CLC   1(0,RF),0(RE)                                                    
         BE    VCEO020                                                          
         LA    RF,L'EORTAB(RF)                                                  
         B     VCEO010                                                          
VCEO020  MVC   EORSTR,10(RF)                                                    
         MVC   EORLEN,9(RF)                                                     
         B     VCLP1                                                            
VCEO030  MVC   EORSTR,0(RE)                                                     
         MVI   EORLEN,1                                                         
         B     VCLP1                                                            
         SPACE 1                                                                
VCTEXT   EQU   *                   TEXT=                                        
         CLC   P+5(4),=C'NONE'                                                  
         BE    VCLP1                                                            
         MVC   TEXTCODE,P+5                                                     
         B     VCLP1                                                            
         SPACE 1                                                                
VCNULL   EQU   *                   NULL=                                        
         LA    RE,P+5                                                           
         CLI   0(RE),C' '                                                       
         BE    VCERR1                                                           
         L     RF,=A(NULLTAB)                                                   
         SR    R1,R1                                                            
VCNU010  CLI   0(RF),0                                                          
         BE    VCERR1                                                           
         IC    R1,0(RF)                                                         
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         CLC   1(0,RF),0(RE)                                                    
         BE    VCNU020                                                          
         LA    RF,L'NULLTAB(RF)                                                 
         B     VCNU010                                                          
VCNU020  MVC   NULLCODE,9(RF)                                                   
         B     VCLP1                                                            
         SPACE 1                                                                
VCMONEY  EQU   *                   MONEY=                                       
         CLC   P+6(4),=C'NONE'                                                  
         BE    VCLP1                                                            
         MVC   MONYCODE,P+6                                                     
         B     VCLP1                                                            
         SPACE 1                                                                
VCSERVER EQU   *                   SERVER=                                      
         MVC   SERVERID,P+7                                                     
         B     VCLP1                                                            
         SPACE 1                                                                
VCAPPKEY EQU   *                   APPLICATION=                                 
         MVC   APPLKEY,P+12                                                     
         B     VCLP1                                                            
         SPACE 1                                                                
VCDBASE  EQU   *                   DATABASE=                                    
         MVC   DATABASE,P+9                                                     
         B     VCLP1                                                            
         SPACE 1                                                                
VCSQLUSE EQU   *                   SQLUSER=                                     
         MVC   SQLUSER,P+8                                                      
         B     VCLP1                                                            
         SPACE 1                                                                
VCPASSWD EQU   *                   PASSWORD=                                    
         MVC   PASSWORD,P+9                                                     
         B     VCLP1                                                            
         SPACE 1                                                                
VCRESET  EQU   *                   RESET=                                       
         MVC   RESETFLG,P+6                                                     
         CLI   RESETFLG,C'N'                                                    
         BE    VCLP1                                                            
         CLI   RESETFLG,C'Y'                                                    
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCCOMMIT EQU   *                   COMMIT=                                      
         CLI   P+7,C'N'                                                         
         BNE   VCCO010                                                          
         MVI   COMFLAG,C'N'                                                     
         B     VCLP1                                                            
*                                                                               
VCCO010  GOTO1 VNUMVAL,DMCB,P+7,(X'02',0)                                       
         CLI   0(R1),0                                                          
         BNE   VCERR1                                                           
         L     R1,4(R1)                                                         
         LTR   R1,R1                                                            
         BM    VCERR1                                                           
         CVD   R1,DUB                                                           
         CP    DUB,COMMAX                                                       
         BH    VCERR1                                                           
         MVC   COMMAX,DUB                                                       
         B     VCLP1                                                            
         SPACE 1                                                                
VCTEST   EQU   *                   TEST=                                        
         CLI   P+5,C' ' EMPTY TEST= LEAVES TESTCHAR AT DEFAULT(C' ')            
         BE    VCLP1                                                            
         MVC   TESTCHAR,P+5                                                     
         CLI   TESTCHAR,C'A'                                                    
         BL    VCERR1                                                           
         CLI   TESTCHAR,C'Z'                                                    
         BH    VCERR1                                                           
         B     VCLP1                                                            
         SPACE 1                                                                
VCSQL    EQU   *                   SQL=                                         
         MVC   SQLBOOKB,P+4                                                     
         OI    SQLFLAG,SQLFBEFQ                                                 
         B     VCLP1                                                            
         SPACE 1                                                                
VCLOAD   EQU   *                   LOAD=                                        
         MVC   LOADCON,P+5                                                      
         CLI   LOADCON,C'0'                                                     
         BE    VCLP1                                                            
         CLI   LOADCON,C'1'                                                     
         BE    VCLP1                                                            
         CLI   LOADCON,C'2'                                                     
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCCLEAR  EQU   *                   CLEAR=                                       
         MVC   CLEARFLG,P+6                                                     
         CLI   CLEARFLG,C'N'                                                    
         BE    VCLP1                                                            
         CLI   CLEARFLG,C'Y'                                                    
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCFROM   EQU   *                   FROM=                                        
         GOTO1 VNUMVAL,DMCB,P+5,(X'02',0)                                       
         CLI   0(R1),0                                                          
         BNE   VCERR1                                                           
         L     R1,4(R1)                                                         
         C     R1,=F'1'                                                         
         BL    VCERR1                                                           
         CVD   R1,DUB                                                           
         MVC   FROMCNT,DUB                                                      
         B     VCLP1                                                            
         SPACE 1                                                                
VCUSERID EQU   *                   USERID=                                      
         MVC   USERID,P+7          SAVE IT FOR LATER VALIDATION                 
         B     VCLP1                                                            
         SPACE 1                                                                
VCPQID   EQU   *                   PQID=                                        
         MVI   WORK,C' '                                                        
         MVC   WORK+1(L'WORK-1),WORK                                            
         LA    RF,P+5                                                           
         BRAS  RE,PACKIN                                                        
         BZ    VCERR1                                                           
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   WORK(0),P+5                                                      
         LA    R2,ELEMENT          SCAN INTO SUBID,SEQNUM                       
         GOTO1 VSCANNER,DMCB,(C'C',WORK),(R2)                                   
         CLI   4(R1),2                                                          
         BNE   VCERR1                                                           
*                                                                               
         CLI   0(R2),2             SUBID MUST BE 2 OR 3 CHARS                   
         BL    VCERR1                                                           
         CLI   0(R2),3                                                          
         BH    VCERR1                                                           
*                                                                               
         MVC   SUBIDFLT,12(R2)     RETURN SUB ID                                
*                                                                               
         LA    RE,SUBIDFLT         MASSAGE SUBID                                
         LA    RF,3                                                             
         CLI   0(RE),C'A'                                                       
         BNL   *+8                                                              
         MVI   0(RE),C'.'                                                       
         LA    RE,1(RE)                                                         
         BCT   RF,*-16                                                          
*                                                                               
         LA    R2,32(R2)           POINT TO SECOND FIELD IN BLOCK               
         CLI   0(R2),0             SEQNUM MUST HAVE NON-ZERO LENGTH             
         BE    VCERR1                                                           
         TM    2(R2),X'80'         MUST BE NUMERIC                              
         BZ    VCERR1                                                           
         OC    4(4,R2),4(R2)       MUST BE NON-ZERO                             
         BZ    VCERR1                                                           
         CLC   4(4,R2),=F'65000'   MUST BE <= 65000                             
         BH    VCERR1                                                           
*                                                                               
         MVC   REPNOFLT,6(R2)      RETURN SEQUENCE NUMBER                       
         B     VCLP1                                                            
         SPACE 1                                                                
VCSQLBEF EQU   *                   SQLBEFORE=                                   
         MVC   SQLBOOKB,P+10                                                    
         OI    SQLFLAG,SQLFBEFQ                                                 
         B     VCLP1                                                            
         SPACE 1                                                                
VCSQLAFT EQU   *                   SQLAFTER=                                    
         MVC   SQLBOOKA,P+9                                                     
         OI    SQLFLAG,SQLFAFTQ                                                 
         B     VCLP1                                                            
         SPACE 1                                                                
VCTST    EQU   *                   TST=                                         
         MVC   TSTFLAG,P+4                                                      
         CLI   TSTFLAG,C'N'                                                     
         BE    VCLP1                                                            
         CLI   TSTFLAG,C'Y'                                                     
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCREFORM EQU   *                   REFORM=                                      
         MVC   REFORMID,P+7                                                     
         B     VCLP1                                                            
         SPACE 1                                                                
VCRECOV  EQU   *                   RECOVERY=                                    
*&&US                                                                           
         CLI   P+9,C'Y'                                                         
         BNE   VCLP1                                                            
         L     RF,=A(SSB)                                                       
         NI    3(RF),X'FF'-X'02'   SET OFFLINE RECOVERY ON                      
         OI    3(RF),X'08'         RECOVER COPIES                               
         B     VCLP1                                                            
*&&                                                                             
*&&UK                                                                           
         L     RF,=A(SSB)                                                       
         NI    3(RF),X'FF'-X'02'   SET OFFLINE RECOVERY ON                      
         OI    5(RF),SSOFRCVR      FULL RECOVERY                                
         CLI   P+9,C'Y'            RECOVERY=Y                                   
         BE    VCLP1                                                            
*                                                                               
         OI    3(RF),X'02'         SET OFFLINE RECOVERY OFF                     
         NI    5(RF),255-SSOFRCVR                                               
         CLI   P+9,C'N'            RECOVERY=N                                   
         BE    VCLP1                                                            
         B     VCERR1                                                           
*&&                                                                             
         SPACE 1                                                                
VCDIET   EQU   *                   DIET=                                        
         MVC   DIETFLAG,P+5                                                     
         CLI   DIETFLAG,C'N'                                                    
         BE    VCLP1                                                            
         CLI   DIETFLAG,C'Y'                                                    
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCCNTRY  EQU   *                   COUNTRY=                                     
         USING CTRYTABD,RE                                                      
         L     RE,=A(CTRYTAB)      CHECK IN TABLE OF VALID COUNTRIES            
         LA    RE,6(RE)                                                         
*                                                                               
VCCN010  CLI   CTRYCODE,X'FF'                                                   
         BE    VCERR1                                                           
         CLC   P+8(L'CTRYSHR),CTRYSHR                                           
         BE    VCCN020                                                          
         CLC   P+8(L'CTRYNAM),CTRYNAM                                           
         BE    VCCN020                                                          
         CLC   P+8(L'CTRYSHRN),CTRYSHRN                                         
         BE    VCCN020                                                          
         CLC   P+8(L'CTRYNAMN),CTRYNAMN                                         
         BE    VCCN020                                                          
         LA    RE,CTRYTABL(RE)                                                  
         B     VCCN010                                                          
*                                                                               
VCCN020  MVC   COUNTRY,CTRYCODE    SAVE INTERNAL COUNTRY CODE                   
         B     VCLP1                                                            
         SPACE 1                                                                
VCAUTO   EQU   *                   AUTO=                                        
         CLI   P+5,C'N'                                                         
         BE    VCLP1                                                            
         CLI   P+5,C'Y'                                                         
         BNE   VCERR1                                                           
         MVI   AUTOFLAG,ON                                                      
         B     VCLP1                                                            
         SPACE 1                                                                
VCDEBUG  EQU   *                   DEBUG=                                       
         CLC   P+6(2),=CL2'PQ'                                                  
         BNE   *+12                                                             
         OI    DEBUGFLG,DEBFPQQ                                                 
         B     VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCDUMP   EQU   *                   DUMP=                                        
         CLC   P+5(2),=CL2'OS'                                                  
         BE    VCLP1                                                            
         CLC   P+5(3),=CL3'MVS'                                                 
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCESS    EQU   *                   ESS=ESSID                                    
         MVC   ESSID,P+4                                                        
         B     VCLP1                                                            
         SPACE 1                                                                
VCVER    EQU   *                   VERSION=                                     
         GOTO1 VNUMVAL,DMCB,P+8,(X'02',0)                                       
         CLI   0(R1),0                                                          
         BNE   VCERR1                                                           
         L     R1,4(R1)                                                         
         C     R1,=F'255'                                                       
         BH    VCERR1                                                           
         C     R1,=F'1'                                                         
         BL    VCERR1                                                           
         STC   R1,VERNUM                                                        
         B     VCLP1                                                            
         SPACE 1                                                                
VCUSERP  EQU   *                   USERPARM=                                    
         MVC   USERPARM,P+9                                                     
         B     VCLP1                                                            
         SPACE 1                                                                
VCREPLAC EQU   *                   REPLACE=                                     
         MVC   REPLFLAG,P+8                                                     
         CLI   REPLFLAG,C'N'                                                    
         BE    VCLP1                                                            
         CLI   REPLFLAG,C'Y'                                                    
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCHOSTDB EQU   *                   HOSTDB=                                      
         MVC   HOSTDB,P+7                                                       
         CLI   HOSTDB,C'N'                                                      
         BE    VCLP1                                                            
         CLI   HOSTDB,C'Y'                                                      
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCWRTXF  EQU   *                   WRTCTFILE=                                   
         MVC   WRTXFFLG,P+10                                                    
         CLI   WRTXFFLG,C'N'                                                    
         BE    VCLP1                                                            
         CLI   WRTXFFLG,C'Y'                                                    
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCXTRACT EQU   *                   XTRACT=                                      
         MVC   XTRFLG,P+7                                                       
         CLI   XTRFLG,C'N'                                                      
         BE    VCLP1                                                            
         CLI   XTRFLG,C'Y'                                                      
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCFLTUAD EQU   *                   FILTUAD=                                     
         MVC   FUADFLG,P+8                                                      
         CLI   FUADFLG,C'N'                                                     
         BE    VCLP1                                                            
         CLI   FUADFLG,C'Y'                                                     
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCREFSTA EQU   *                   RFMSTATUS=                                   
         CLC   P+10(5),=CL5'ERROR'                                              
         BNE   *+12                                                             
         MVI   REFSTFLG,C'E'                                                    
         B     VCLP1                                                            
         CLC   P+10(6),=CL6'ACTIVE'                                             
         BNE   VCERR1                                                           
         MVI   REFSTFLG,C'A'                                                    
         B     VCLP1                                                            
         SPACE 1                                                                
VCEMAIL  EQU   *                   EMAIL=    (40 CHAR)                          
         MVC   EMAILADR,P+6                                                     
         B     VCLP1                                                            
         SPACE 1                                                                
VCRFABD  EQU   *                   RFABEND=                                     
         MVC   RFABDFLG,P+8                                                     
         CLI   RFABDFLG,C'N'                                                    
         BE    VCLP1                                                            
         CLI   RFABDFLG,C'Y'                                                    
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCDSNAME EQU   *                   DSNAME=                                      
         MVC   ODSNAME,P+7                                                      
         B     VCLP1                                                            
         SPACE 1                                                                
VCOVRDSN EQU   *                   ODSN=                                        
         MVC   OVRDSN,P+5                                                       
         B     VCLP1                                                            
         SPACE 1                                                                
VCDBAUTH EQU   *                   DB2AUTHID=                                   
         MVC   DB2AUTH,P+10                                                     
         B     VCLP1                                                            
         SPACE 1                                                                
VCDBSSYS EQU   *                   DB2SUBSYS=                                   
         MVC   DB2SSYS,P+10                                                     
         B     VCLP1                                                            
         SPACE 1                                                                
VCFILTS  EQU   *                   FILTERS=                                     
         MVC   XFILTERS,P+8                                                     
         B     VCLP1                                                            
         SPACE 1                                                                
VCZERO   EQU   *                   ZERO=                                        
         MVC   ZEROFLG,P+5                                                      
         CLI   ZEROFLG,C'N'                                                     
         BE    VCLP1                                                            
         CLI   ZEROFLG,C'Y'                                                     
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCDELETE EQU   *                   DELETE=                                      
         MVC   DELFLG,P+7                                                       
         CLI   DELFLG,C'N'                                                      
         BE    VCLP1                                                            
         CLI   DELFLG,C'Y'                                                      
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCFORMAT EQU   *                   FORMAT=                                      
         LA    RE,P+7                                                           
         CLI   0(RE),C' '                                                       
         BE    VCERR1                                                           
         L     RF,=A(FORMTAB)                                                   
         SR    R1,R1                                                            
VCFO010  CLI   0(RF),0                                                          
         BE    VCERR1                                                           
         IC    R1,0(RF)                                                         
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         CLC   1(0,RF),0(RE)                                                    
         BE    VCFO020                                                          
         LA    RF,L'FORMTAB(RF)                                                 
         B     VCFO010                                                          
VCFO020  MVC   FORMCODE,9(RF)                                                   
         B     VCLP1                                                            
         SPACE 1                                                                
VCFIXED  EQU   *                   FIXED=                                       
         MVC   FIXEDFLG,P+6                                                     
         CLI   FIXEDFLG,C'N'                                                    
         BE    VCLP1                                                            
         CLI   FIXEDFLG,C'Y'                                                    
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCENDMOD EQU   *                   ENDMODE=                                     
         MVC   ENDMODE,P+8                                                      
         CLI   ENDMODE,C'N'                                                     
         BE    VCLP1                                                            
         CLI   ENDMODE,C'Y'                                                     
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCCLOXMO EQU   *                   CLOXMODE=                                    
         MVC   CLOXMODE,P+9                                                     
         CLI   CLOXMODE,C'N'       FORCE NO CLOX MODE                           
         BE    VCLP1                                                            
         CLI   CLOXMODE,C'Y'       FORCE CLOX MODE                              
         BE    VCLP1                                                            
         CLI   CLOXMODE,C'D'       DEFAULT CLOX MODE TO XAGY                    
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCTSTRUN EQU   *                   TSTRUN=                                      
         MVC   TSTRUN,P+7                                                       
         J     VCLP1                                                            
         SPACE 1                                                                
VCAGXBUF EQU   *                   AGXBUF=                                      
         MVC   AGXBUF,P+7                                                       
         CLI   AGXBUF,C'Y'                                                      
         JE    VCLP1                                                            
         CLI   AGXBUF,C'N'                                                      
         JNE   *+2                                                              
         J     VCLP1                                                            
         SPACE 1                                                                
VCTRANS  EQU   *                   TRANSACT=                                    
         GOTO1 VNUMVAL,DMCB,P+9,(X'02',0)                                       
         CLI   0(R1),0                                                          
         BNE   VCERR1                                                           
         L     R1,4(R1)                                                         
         C     R1,=F'15'                                                        
         BH    VCERR1                                                           
         C     R1,=F'0'                                                         
         BL    VCERR1                                                           
         STC   R1,TRANSCOD                                                      
         B     VCLP1                                                            
         SPACE 1                                                                
VCDSNLMT EQU   *                   DSNLIMIT=/DCBLIMIT=                          
         GOTO1 VNUMVAL,DMCB,P+9,(X'02',0)                                       
         CLI   0(R1),0                                                          
         BNE   VCERR1                                                           
         L     R1,4(R1)                                                         
         C     R1,=AL4(EXFTABQ)                                                 
         BH    VCERR1                                                           
         C     R1,=F'2'                                                         
         BL    VCERR1                                                           
         ST    R1,DCBLIMIT                                                      
         B     VCLP1                                                            
         SPACE 1                                                                
VCESCAPE EQU   *                   ESCAPE=                                      
         CLC   P+7(4),=C'NONE'                                                  
         BE    VCLP1                                                            
         MVC   ESCODE,P+7                                                       
         B     VCLP1                                                            
         SPACE 1                                                                
VCNULLIF EQU   *                   NULLIF=                                      
         LA    RE,P+7                                                           
         CLI   0(RE),C' '                                                       
         BE    VCERR1                                                           
         L     RF,=A(NLIFTAB)                                                   
         SR    R1,R1                                                            
VCNI010  CLI   0(RF),0                                                          
         BE    VCERR1                                                           
         IC    R1,0(RF)                                                         
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         CLC   1(0,RF),0(RE)                                                    
         BE    VCNI020                                                          
         LA    RF,L'NLIFTAB(RF)                                                 
         B     VCNI010                                                          
VCNI020  MVC   NULLIFCD,9(RF)                                                   
         B     VCLP1                                                            
         SPACE 1                                                                
VCSCHEMA EQU   *                   SCHEMA=                                      
         MVC   DB2AUTH,P+7                                                      
         B     VCLP1                                                            
         SPACE 1                                                                
VCLOCATN EQU   *                   LOCATION=                                    
         MVC   DB2LOCN,P+9                                                      
         B     VCLP1                                                            
         SPACE 1                                                                
VCERROR  EQU   *                   ERROR=                                       
         MVC   ERRFLG,P+6                                                       
         CLI   ERRFLG,C'N'                                                      
         BE    VCLP1                                                            
         CLI   ERRFLG,C'Y'                                                      
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCTIMNOW EQU   *                   TIMENOW=                                     
         MVC   TIMENOW,P+8                                                      
         B     VCLP1                                                            
         SPACE 1                                                                
VCDBID   EQU   *                   DBID=                                        
         MVC   HDBID,P+5                                                        
         B     VCLP1                                                            
         SPACE 1                                                                
VCSQLOUT EQU   *                   SQLOUT=                                      
         MVC   SQLOUT,P+7                                                       
         CLI   SQLOUT,C'N'                                                      
         BE    VCLP1                                                            
         CLI   SQLOUT,C'Y'                                                      
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCUDBERR EQU   *                   UDBERR=                                      
         MVC   UDBERR,P+7                                                       
         CLI   UDBERR,C'N'                                                      
         BE    VCLP1                                                            
         CLI   UDBERR,C'Y'                                                      
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCCONT   EQU   *                   CONTINUE=                                    
         MVC   CONTFLG,P+9                                                      
         CLI   CONTFLG,C'N'                                                     
         BE    VCLP1                                                            
         CLI   CONTFLG,C'Y'                                                     
         BE    VCLP1                                                            
         CLI   CONTFLG,C'V'                                                     
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCUPDATE EQU   *                   UPDATE=                                      
         MVC   UPDFLAG,P+7                                                      
         CLI   UPDFLAG,C'N'                                                     
         BE    VCLP1                                                            
         CLI   UPDFLAG,C'Y'                                                     
         BE    VCLP1                                                            
         B     VCERR1                                                           
VCVCHAR  EQU   *                   VARCHAR=                                     
         MVC   VCHARFLG,P+8                                                     
         CLI   VCHARFLG,C'N'                                                    
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCDSPACE EQU   *                   DSPACE=                                      
         MVC   DSPFLAG,P+7                                                      
         L     RF,=A(SSB)          SET DSPACE= FLAG                             
         MVC   SSODSPAC-SSOOFF(1,RF),DSPFLAG                                    
         B     VCLP1                                                            
         SPACE 1                                                                
         SPACE 1                                                                
VCHEXOUT EQU   *                   HEXOUT=                                      
         CLI   P+7,C'Y'                                                         
         BE    VCLP1                                                            
         CLI   P+7,C'N'                                                         
         BNE   VCERR1                                                           
         MVI   TEXTCODE,DXTHONOQ                                                
         B     VCLP1                                                            
         SPACE 1                                                                
VCQUOTES EQU   *                   QUOTES=                                      
         MVC   QUOTEFLG,P+7                                                     
         CLI   QUOTEFLG,C'Y'                                                    
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCREADO  EQU   *                   READ=                                        
         MVC   READOFLG,P+5                                                     
         CLI   READOFLG,C'Y'                                                    
         BE    VCLP1                                                            
         CLI   READOFLG,C'N'                                                    
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCOFFLIN EQU   *                   OFFLINE=                                     
         MVC   OFFLFLAG,P+8                                                     
         CLI   OFFLFLAG,C'Y'                                                    
         BE    VCLP1                                                            
         CLI   OFFLFLAG,C'N'                                                    
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCSKIP   EQU   *                   SKIP=                                        
         MVC   SKIPFLAG,P+5                                                     
         CLI   SKIPFLAG,C'Y'                                                    
         BE    VCLP1                                                            
         CLI   SKIPFLAG,C'N'                                                    
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCALLAGY EQU   *                   ALLAGY=                                      
         MVC   AAGYFLAG,P+7                                                     
         CLI   AAGYFLAG,C'N'                                                    
         BE    VCLP1                                                            
         CLI   AAGYFLAG,C'Y'       EVEN THIS IS ON, YOU STILL NEED TO           
         BE    VCLP1                 SET AGY=, IN ORDER TO OPEN FILE            
         B     VCERR1                                                           
         SPACE 1                                                                
VESSPROG EQU   *                   ESSPROGRAM=                                  
         MVC   ESSPROG,P+11                                                     
         B     VCLP1                                                            
         SPACE 1                                                                
VESSCMND EQU   *                   ESSCOMMAND=                                  
         MVC   ESSCMND,P+11                                                     
         B     VCLP1                                                            
         SPACE 1                                                                
VCTHREAD EQU   *                   THREAD=                                      
         GOTO1 VNUMVAL,DMCB,P+7,(X'02',0)                                       
         CLI   0(R1),0                                                          
         BNE   VCERR1                                                           
         L     R1,4(R1)                                                         
         CHI   R1,255                                                           
         BH    VCERR1                                                           
         STC   R1,THREAD                                                        
         B     VCLP1                                                            
         SPACE 1                                                                
VCTDATE  EQU   *                   TESTDATE=YYMMDD                              
         GOTO1 VDATCON,DMCB,(0,P+9),TODAY     OVERRIDE TODAY                    
         B     VCLP1                                                            
         SPACE 1                                                                
VCPOST   EQU *                     POSTONLY=                                    
         MVC   POSTONLY,P+9                                                     
         L     RF,=A(DXBLOCK)                                                   
         USING DXBLOCKD,RF                                                      
         MVC   DXPONLY,P+9         POSTONLY OPTION IN DXBLOCK                   
         DROP  RF                                                               
         CLI   POSTONLY,C'Y'                                                    
         BE    VCLP1                                                            
         CLI   POSTONLY,C'N'                                                    
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCPDSN   EQU   *                   POSTDSN=(POSTDSN)                            
         CLC   =C'(POSTDSN)',P+8                                                
         BNE   VCPDSN10                                                         
         GOTO1 VDYNALOC,DMCB,(C'D',=CL8'POSTDSN'),POSTDSN                       
         CLI   DMCB+4,0                                                         
         BE    VCERR1                                                           
         OC    POSTDSN,SPACES                                                   
         MVC   P(44),POSTDSN                                                    
         GOTO1 VPRINTER                                                         
         B     VCLP1                                                            
VCPDSN10 MVC   POSTDSN,P+8         POSTDSN=DSN                                  
         B     VCLP1                                                            
         SPACE 1                                                                
VCFLASH  EQU   *                   FLASH=Y/N/*                                  
         L     RF,=A(SSB)                                                       
         USING FASSBOD,RF          WARNING! OVERLAYS MAY USE OWN SSB            
         CLI   P+6,C'A'            TEST IF VALID FLASH CHARACTER                
         BL    VCERR1                                                           
         CLI   P+6,C'N'            FLASH=N MEANS NO FLASH COPY                  
         BE    VCLP1                                                            
         OI    SSOFLAG2,SSO2FLSH                                                
         MVC   SSOFLSHI(1),P+6                                                  
         CLI   P+6,C'Y'            FLASH=Y IS DEFAULT SO SET TO FLASH=S         
         BNE   VCLP1               TO CAUSE DSN=FLS.XXX...                      
         MVI   SSOFLSHI,C'S'                                                    
         B     VCLP1                                                            
         DROP  RF                                                               
         SPACE 1                                                                
VBSCHDR  EQU   *                   BASICHDR=Y/N                                 
         MVC   BASICHDR,P+9                                                     
         CLI   BASICHDR,C'Y'                                                    
         BE    VCLP1                                                            
         CLI   BASICHDR,C'N'                                                    
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCHOPDSN EQU   *                   CHOPDSN=Y/N                                  
         MVC   CHOPDSN,P+8                                                      
         CLI   CHOPDSN,C'Y'                                                     
         BE    VCLP1                                                            
         CLI   CHOPDSN,C'N'                                                     
         BE    VCLP1                                                            
         B     VCERR1                                                           
         SPACE 1                                                                
VCCLIRNG EQU   *                   CLIRANGE=ABC-XYZ                             
         MVC   WORK,SPACES                                                      
         LA    RF,P+9                                                           
         BRAS  RE,PACKIN                                                        
         BZ    VCERR12                                                          
*                                                                               
         CHI   R1,7                                                             
         BH    VCERR12                                                          
*                                                                               
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   WORK(0),P+9                                                      
*                                                                               
         LA    R2,ELEMENT                                                       
         GOTO1 VSCANNER,DMCB,(C'C',WORK),(1,ELEMENT),C',=,-'                    
         CLI   4(R1),1                                                          
         BNE   VCERR12                                                          
*                                                                               
         MVC   CLIENTS,12(R2)                                                   
         OC    CLIENTS,SPACES                                                   
         MVC   CLIENTE,22(R2)                                                   
         OC    CLIENTE,SPACES                                                   
*                                                                               
         B     VCLP1                                                            
*                                                                               
VSMF     EQU   *                   SMF=                                         
         CLI   P+4,C' '            EMPTY SMF= CARD WORKS SAME AS SMF=N          
         BE    VCLP1                                                            
         MVC   GENSMF,P+4                                                       
         CLI   GENSMF,C'Y'                                                      
         BE    VCLP1                                                            
         CLI   GENSMF,C'T'         T=TRACE                                      
         BE    VCLP1                                                            
         CLI   GENSMF,C'N'                                                      
         BE    VCLP1                                                            
         B     VCERR1                                                           
*                                                                               
V8KEXFILE EQU  *                   8KEXFILE=                                    
         CLI   P+9,C' '            DEFAULT IS 'N'                               
         BE    VCLP1                                                            
         MVC   EXFILE8K,P+9                                                     
         CLI   EXFILE8K,C'Y'                                                    
         BE    VCLP1                                                            
         CLI   EXFILE8K,C'N'                                                    
         BE    VCLP1                                                            
         B     VCERR1                                                           
*                                                                               
VKPEMPTY EQU   *                   KEEPEMPTY=                                   
         CLI   P+10,C' '           DEFAULT IS 'N'                               
         BE    VCLP1                                                            
         MVC   KPEMPTY,P+10                                                     
         CLI   KPEMPTY,C'Y'                                                     
         BE    VCLP1                                                            
         CLI   KPEMPTY,C'N'                                                     
         BE    VCLP1                                                            
         B     VCERR1                                                           
*                                                                               
VLOADPHS EQU   *                   LOADPHASE=                                   
         CLI   P+10,C' '           EMPTY VALUES ALLOWED                         
         BE    VCLP1                                                            
         MVC   LOADPHS,P+10                                                     
         B     VCLP1                                                            
*                                                                               
PACKIN   EQU   *                                                                
         SR    R1,R1               GET STRING LENGTH                            
         LA    R0,60                                                            
*                                                                               
PIN010   CLI   0(RF),C' '                                                       
         BE    PINOK                                                            
         CLI   0(RF),0                                                          
         BE    PINNO                                                            
         LA    RF,1(RF)                                                         
         LA    R1,1(R1)                                                         
         BCT   R0,PIN010                                                        
         B     PINNO                                                            
*                                                                               
PINNO    SR    R1,R1                                                            
PINOK    LTR   R1,R1                                                            
         BR    RE                                                               
         LTORG                                                                  
         DROP  RB,RA                                                            
         EJECT                                                                  
***********************************************************************         
* PRINT ERROR MESSAGE                                                 *         
***********************************************************************         
         SPACE 1                                                                
         DS    0D                                                               
ERRPRT   NMOD1 0,**ERRP**                                                       
         LR    RC,R1                                                            
         L     RE,=A(ERRTAB)                                                    
         SR    RF,RF                                                            
         ICM   RF,1,ERROR                                                       
         MH    RF,=H'60'                                                        
         AR    RE,RF                                                            
         MVC   P,SPACES                                                         
         TIME  DEC                                                              
         ST    R0,PRNTDUB                                                       
         UNPK  PRNTTIME,PRNTDUB(4)                                              
         MVC   P(2),PRNTTIME                                                    
         MVI   P+2,C':'                                                         
         MVC   P+3(2),PRNTTIME+2                                                
         MVI   P+5,C':'                                                         
         MVC   P+6(2),PRNTTIME+4                                                
         MVC   P+10(9),=CL9'##ERROR##'                                          
         MVC   P+20(60),0(RE)                                                   
         GOTO1 VPRINTER                                                         
         MVI   ERROR,0                                                          
         XIT1                                                                   
         LTORG                                                                  
         SPACE 2                                                                
         EJECT                                                                  
***********************************************************************         
* PRINT STATUS MESSAGE                                                *         
***********************************************************************         
         SPACE 1                                                                
         DS    0D                                                               
MSGPRT   NMOD1 0,**MSGP**                                                       
         LR    RC,R1                                                            
         L     RE,=A(MSGTAB)                                                    
         SR    RF,RF                                                            
         ICM   RF,1,MSGNUM                                                      
         MH    RF,=H'60'                                                        
         AR    RE,RF                                                            
         MVC   P,SPACES                                                         
         MVC   P+20(60),0(RE)                                                   
         TIME  DEC                                                              
         ST    R0,PRNTDUB                                                       
         UNPK  PRNTTIME,PRNTDUB(4)                                              
         MVC   P(2),PRNTTIME                                                    
         MVI   P+2,C':'                                                         
         MVC   P+3(2),PRNTTIME+2                                                
         MVI   P+5,C':'                                                         
         MVC   P+6(2),PRNTTIME+4                                                
         GOTO1 VPRINTER                                                         
         MVI   MSGNUM,0                                                         
         XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* PROCESS EXTRACT UPDATE MODE - READ RECOVERY FILE FOR SYSTEM         *         
* TRAWL THROUGH FILE FROM LAST DISK ADDRESS PROCESSED UP              *         
* UP TO END TIME = (TIME NOW)-EXTRATIME                               *         
***********************************************************************         
         SPACE 1                                                                
         DS    0D                                                               
PROCUPDT NMOD1 0,**PUPD**,RA                                                    
         LR    RC,R1                                                            
         MVI   MSGNUM,MSPUPDTQ                                                  
         GOTO1 =A(MSGPRT),(RC)                                                  
*                                                                               
*CREATE THE EXTRACT FILE EVEN THE DATASET MAY BE EMPTY                          
         L     R5,ADXBLOCK         GET ADDRESS SYSTEM CONTROL BLOCK             
         USING DXBLOCKD,R5                                                      
         L     R4,DXSTPTR          GET SYSTEM TABLE ENTRY POINTER               
         USING SXDTABD,R4                                                       
         L     RF,AEXFTNXT         A(TABLE OF EXTRACT FILE DCBS/DDS)            
         MVC   SXDTXDCB,0(RF)      SAVE A(DCB)                                  
         MVC   SXDTXDDN,4(RF)      SAVE DD NAME                                 
         GOTO1 =A(OPENEXFL),(RC)   OPEN NEXT EXTRACT DATA SET                   
         BNE   PUPDNO                EXIT IF ERROR                              
         ICM   RF,15,AEXFTNXT      UPDATE POINTER TO NEXT EXFTAB ENTRY          
         LA    RF,12(RF)                                                        
         CLM   RF,15,=A(EXFTABX)                                                
         BNL   PUPDER1             ABEND EXFTAB OVERFLOW                        
         STCM  RF,15,AEXFTNXT                                                   
         L     RF,ALDCBNUM         INCR # OF ALLOCATED DCBS                     
         AHI   RF,1                                                             
         ST    RF,ALDCBNUM                                                      
         CLI   MODE,DXUPDTQ        NO SQL IN UPDATE MODE ??                     
         BE    PUPD010                                                          
         TM    SQLFLAG,SQLFBEFQ                                                 
         BZ    PUPD010                                                          
         MVC   SQLBOOK,SQLBOOKB                                                 
         GOTO1 =A(PROCSQB),(RC)    PROCESS SQL QUERY BOOK                       
         BNE   PUPDNO                EXIT IF ERROR                              
         DROP  R4,R5                                                            
*                                                                               
PUPD010  EQU   *                                                                
         L     R4,ADXBLOCK         R4=A(EXTRACT CONTROL DATA BLOCK)             
         USING DXBLOCKD,R4                                                      
         L     R6,DXARECB          R6=A(RECOVERY RECORD BUFFER)                 
         USING RECDS,R6                                                         
         MVI   DXMODE,DXUPDTQ      SET UPDATE MODE                              
*                                                                               
         CLI   INTAPE,C'Y'         TEST IF RECOVERY FILE TAPE INPUT             
         BE    PUPD020               OR RECOVERY FILE DISK INPUT                
*                                                                               
         CLI   HOSTDB,C'Y'                                                      
         BNE   PUPD012                                                          
         GOTO1 =A(BRLHDB),(RC)                                                  
         BNE   PUPDNO                                                           
         B     PUPD014                                                          
*                                                                               
PUPD012  EQU   *                                                                
         BRAS  RE,BXRCVSYS         GET CONTROL BLOCK DATA FROM LAST             
         BNE   PUNO010               XLOG RECOVERY LOG RECORD                   
*                                                                               
PUPD014  EQU   *                                                                
         BRAS  RE,OPENSYS          OPEN DATA MANAGER SYSTEM FILES AND           
*                                  - CHECK IF EXTENDED VERMONTS IN USE          
         MVI   TRAWLEND,NOTEND     SET END OF TRAWL FLAG                        
         MVI   FIRSTFLG,C'Y'       SET FIRST RECOVERY RECORD FLAG               
         MVC   RCVDA,DXFDA         USE INITIAL DISK ADDRESS FROM XLOG           
*&&US                                                                           
         OC    RCVDA,RCVDA                                                      
         BNZ   PUPD016             NOT FIRST TRAWL IF NOT ZERO                  
         MVC   RCVDA,=XL4'00000000' LEAVE NULL FOR UK                           
*&&                                                                             
PUPD016  CLI   DXEXTVMT,C'Y'       USING EXTENDED VERMONT METHOD?               
         BNE   PUPD018             NO, OLD METHOD STARTS AT DXFDA=DXTDA         
         BRAS  RE,GETEXVMT         GET EXTENDED VERMONT DATA                    
*                                                                               
PUPD018  MVC   P(20),=CL20'START DISK ADDRESS:'                                 
         GOTO1 VHEXOUT,DMCB,RCVDA,P+20,4,=C'TOG'                                
         CLI   DXEXTVMT,C'Y'       USING EXTENDED VERMONT METHOD?               
         BNE   PUPD019             NO, SKIP                                     
         MVC   EXTVODA,RCVDA       YES, SAVE ORIGINAL START ADDRESS             
         CLC   RCVDA,EXTVFDA       EXTVFDA IS EARLIER START OF ANY              
         BNH   PUPD019             UNEXTRACTED TASKS FROM LAST TRAWL            
         MVC   RCVDA,EXTVFDA       USE IT AS START ADDRESS IF < RCVDA           
         MVI   P+29,C'('                                                        
         GOTO1 VHEXOUT,DMCB,RCVDA,P+30,4,=C'TOG'                                
         MVI   P+38,C')'                                                        
PUPD019  GOTO1 VPRINTER                                                         
*                                  LOOP TO HERE FOR EACH SOURCE RECORD          
PUPD020  EQU   *                                                                
         LR    RE,R6               CLEAR RECORD/COPY BUFFER AREAS               
         ICM   RF,15,=AL4(10000)                                                
         LA    R0,*                                                             
         L     R1,=F'0'                                                         
         MVCL  RE,R0                                                            
*        L     RE,DXACPYB                                                       
*        ICM   RF,15,=AL4(10000)                                                
*        LA    R0,*                                                             
*        L     R1,=F'0'                                                         
*        MVCL  RE,R0                                                            
         CLI   INTAPE,C'Y'                                                      
         BNE   PUPD022                                                          
         LR    R0,R6                READ RECOVERY FROM TAPE FILE                
*&&UK*&& L     R5,=A(RCVTAPE)                                                   
*&&US                                                                           
         CLI   SYSCODE,C'R'        SPECIAL DCB FOR REP SYSTEM                   
         BNE   *+12                                                             
         L     R5,=A(RCVTAPER)                                                  
         B     PUPD021                                                          
         CLI   SYSCODE,C'P'        SPECIAL DCB FOR PRINT SYSTEM                 
         BNE   *+12                                                             
         L     R5,=A(RCVTAPEP)                                                  
         B     PUPD021                                                          
         CLI   SYSCODE,C'S'        SPECIAL DCB FOR SPOT SYSTEM                  
         BNE   *+12                                                             
         L     R5,=A(RCVTAPEP)                                                  
         B     PUPD021                                                          
         CLI   SYSCODE,C'N'        SPECIAL DCB FOR NET SYSTEM                   
         BNE   *+12                                                             
         L     R5,=A(RCVTAPEP)                                                  
         B     PUPD021                                                          
         L     R5,=A(RCVTAPE)                                                   
PUPD021  EQU   *                                                                
*&&                                                                             
         GET   (R5),(0)             GET RECORD FROM RECOVERY TAPE               
         B     PUPD050                                                          
*                                   CHECK FROM/TO DATE FILTER                   
*                                                                               
PUPD022  CLI   MVSRCVF,C'Y'         CHECK MVS DATA SET RECOVERY ON              
*        BE    PUPD024                                                          
         LAY   R0,IOL               READ RECOVERY FROM DISK FILE                
*        AS OF APRIL 2019:                                                      
*        X'2C' (DON'T CLEAR RTASKID) OBSOLETE. DMGR NO LONGER CLEARS IT         
*        X'2C' ALSO DOES NOT USE FULL TRACK READ (EVEN WITH X'10' SET)          
*        GOTO1 VDATAMGR,DMCB,(X'2C',DMRSEQ),DMRFIL,RCVDA,(R0),ATRKBUFF          
*        NOW USING:                                                             
*        X'28' = RETURN DELETED RECOVERY RECORDS.                               
*        X'10' = FULL TRACK READ                                                
         GOTO1 VDATAMGR,DMCB,(X'38',DMRSEQ),DMRFIL,RCVDA,(R0),ATRKBUFF          
         TM    8(R1),X'80'         TEST E-O-F POSTED                            
         BO    PUPD100                                                          
         CLI   8(R1),0             TEST ERROR POSTED                            
         BE    PUPD030                                                          
*                                                                               
*                                  RECOVERY DISK FILE IO ERRORS                 
*                                                                               
         MVC   P(28),=C'DISK ERROR ON RECOVERY FILE='                           
         MVC   P+28(8),DMRFIL                                                   
         GOTO1 VPRINTER                                                         
         MVC   P(17),=C'DA=XXXXXXXX,DMCB='                                      
         MVC   P+80(24),DMCB                                                    
***      GOTO1 VHEXOUT,DMCB,RCVDA,P+34,,=C'TOG'                                 
         GOTO1 VHEXOUT,DMCB,RCVDA,P+3,4,=C'TOG'                                 
         GOTO1 (RF),(R1),P+80,P+17,20,=C'TOG'                                   
         MVI   P+80,C' '                                                        
         MVC   P+81(23),P+80                                                    
         GOTO1 VPRINTER                                                         
         B     PUPDNO                                                           
*&&DO                                                                           
PUPD024  LR    R0,R6               READ RECOVERY FROM MVS DATA SET              
         L     R5,=A(MVSRCVDS)                                                  
         GET   (R5),(0)                                                         
         B     PUPD050                                                          
*                                  END OF MVS DATA SET RECOVERY                 
PUPDEOM  EQU   *                                                                
         GOTO1 =A(CLOSEMVS),(RC)   CLOSE MVS DATA SET                           
         MVI   MVSRCVF,C'N'        FLAG MVS DATA SET RECOVERY OFF               
         B     PUPD020                                                          
*&&                                                                             
*                                                                               
*                                  RECOVERY DISK FILE RECORD FOUND OK           
*                                                                               
PUPD030  EQU   *                                                                
         LH    R1,DMCB+18          GET RECORD LENGTH                            
         LA    R1,4(R1)                                                         
         XC    RECLN(4),RECLN                                                   
         STH   R1,RECLN                                                         
         LA    RF,RECVHDR                                                       
         SH    R1,=H'4'                                                         
         LR    RE,R0                                                            
         MOVE  ((RF),(R1)),(RE)    MOVE RECORD TO TAPE BUFFER                   
*                                                                               
PUPD040  CLI   FIRSTFLG,C'Y'                                                    
         BNE   PUPD050                                                          
         MVC   DXFDA,RCVDA         SAVE FIRST DA PROCESSED THIS TIME            
         MVI   FIRSTFLG,C'N'                                                    
*                                                                               
PUPD050  CLI   RTASKID,X'FF'       CHECK TASK NOT 'DELETED'                     
         BNE   PUPD052                                                          
         CLI   MVSRCVF,C'Y'        CHECK MVS RECOVERY ALREADY ON                
         BE    PUPD052                                                          
         CLC   RECVHDR+L'RECVHDR(8),STARTJOB                                    
         BNE   PUPD020             CHECK START OF OFFLINE JOB HEADER            
         CLC   RECLN,=H'96'                                                     
         BNE   PUPD020             CHECK IF MVS DATA SET RECOVERY               
*                                                                               
         J     PUPD020             IGNORE MVS HEADERS - DMGR WILL READ          
*&&DO                                                                           
         MVC   MVSDSN,RECVHDR+L'RECVHDR+24                                      
         GOTO1 =A(OPENMVS),(RC)    OPEN MVS DATA SET                            
         MVI   MVSRCVF,C'Y'        FLAG MVS DATA SET RECOVERY ON                
         B     PUPD020                                                          
*&&                                                                             
PUPD052  BRAS  RE,FILTIME          FILTER FROM-TO TIME                          
         BL    PUPD100             END                                          
         BH    PUPD020             SKIP                                         
*                                                                               
         BRAS  RE,FILSLICE                                                      
         BNE   PUPD020             SKIP                                         
*                                                                               
         CLI   OFFLFLAG,0          CHECK FOR OFFLINE=Y/N FLAG                   
         BE    PUPD053B                                                         
         CLI   OFFLFLAG,C'Y'                                                    
         BE    PUPD053A                                                         
         CLI   RTASKID,0           RTASKID CAN BE ZERO OFFLINE                  
         BE    PUPD020                                                          
         CLI   RTASKID,X'FD'               OR FD OR FE OFFLINE                  
         BNL   PUPD020             FF (DELETED) ELIMINATED ABOVE                
         B     PUPD053B            CONTINUE IF ONLINE ONLY                      
*                                                                               
PUPD053A EQU   *                   OFFLINE=Y                                    
         CLI   RTASKID,0           RTASKID CAN BE ZERO OFFLINE                  
         BE    PUPD053B                                                         
         CLI   RTASKID,X'FD'               OR FD OR FE OFFLINE                  
         BL    PUPD020             FF (DELETED) ELIMINATED ABOVE                
*                                                                               
PUPD053B EQU   *                                                                
         TM    RRECTY,X'80'        IGNORE POINTER COPIES/CHANGES                
         BO    PUPD020                                                          
         CLI   RRECTY,X'01'        SAVE COPIES                                  
         BNE   PUPD054                                                          
         LH    R1,RECLN                                                         
         L     RF,DXACPYB                                                       
         LR    RE,R6                                                            
         MOVE  ((RF),(R1)),(RE)    MOVE RECOVERY RECORD TO COPY BUFFER          
         B     PUPD020                                                          
*                                                                               
PUPD054  CLI   INTAPE,C'Y'         TEST IF TAPE INPUT                           
         BE    PUPD060                                                          
         CLI   AUTOFLAG,ON         TEST IF AUTO MODE                            
         BNE   PUPD060                                                          
         CLI   DAILYFLG,ON         TEST IF DAILY UPDATE MODE                    
         BE    PUPD060                                                          
         LA    RF,TRAWL            'ORIGINAL' TRAWL                             
         CLI   DXEXTVMT,C'Y'       EXTENDED VERMONT TRAWL METHOD?               
         BNE   *+8                                                              
         LA    RF,EXTTRAWL         EXTENDED VERMONT TRAWL                       
         BASR  RE,RF               PROCESS RECORDS WITHIN TRAWL PERIOD          
         BNE   PUPDNO                                                           
         CLI   TRAWLEND,END                                                     
         BNE   PUPD020             GET NEXT RECOVERY RECORD                     
         B     PUPD100               UNTIL END OF TRAWL                         
*                                                                               
PUPD060  EQU   *                   PROCESS ALL RECORDS ON FILE                  
         BRAS  RE,SETHTYP          CALL SYSTEM EXTRACT MODULE                   
         GOTO1 =A(CALLSEX),(RC)    CALL SYSTEM EXTRACT MODULE                   
         BNE   PUPDNO                                                           
         B     PUPD020             GET NEXT RECOVERY RECORD                     
*                                                                               
PUPD100  EQU   *                                                                
         CLI   INTAPE,C'Y'         IF NOT RECOVERY FILE TAPE INPUT              
         BE    PUPDOK                                                           
*                                                                               
         CLI   HOSTDB,C'Y'                                                      
         BNE   PUPD110                                                          
         GOTO1 =A(WRLHDB),(RC)                                                  
         BNE   PUPDNO                                                           
         B     PUPDOK                                                           
*                                                                               
PUPD110  EQU   *                                                                
         BRAS  RE,WXRCVSYS         WRITE XLOG DISK FILE TRAWL RECORD            
         BNE   PUPDNO                                                           
         B     PUPDOK                                                           
*                                                                               
PUPDEOT  EQU   *                   END OF TAPE FILE                             
         B     PUPDOK                                                           
*                                                                               
PUPDER1  EQU   *                   EXFTAB TABLE OVERFLOW                        
         MVI   ERROR,EREXFOVQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     PUPDNO                                                           
*                                                                               
PUPDNO   EQU   *                   EXIT ERROR                                   
         CLI   INTAPE,C'Y'         UNLESS RECOVERY FILE TAPE INPUT              
         BE    PUNO010                                                          
         BRAS  RE,CLOSESYS           CLOSE DATA MANAGER SYSTEM FILES            
PUNO010  LTR   RC,RC                                                            
         XIT1                                                                   
*                                                                               
PUPDOK   EQU   *                   EXIT OK                                      
         CLI   INTAPE,C'Y'         UNLESS RECOVERY FILE TAPE INPUT              
         BE    PUPO010                                                          
         BRAS  RE,CLOSESYS           CLOSE DATA MANAGER SYSTEM FILES            
         MVC   P(20),=CL20'END DISK ADDRESS:'                                   
         GOTO1 VHEXOUT,DMCB,DXTDA,P+20,4,=C'TOG'                                
         GOTO1 VPRINTER                                                         
PUPO010  MVI   MSGNUM,MSPUPDXQ                                                  
         GOTO1 =A(MSGPRT),(RC)                                                  
         SR    RC,RC                                                            
         LTR   RC,RC                                                            
         XIT1                                                                   
*                                                                               
PUPDERR  EQU   *                   SAFE ABEND FROM PROCUPD                      
         LR    R3,R0                                                            
         MVC   DMCBSAVE(24),DMCB                                                
         GOTO1 =A(DEQCTRL),(RC)                                                 
         GOTO1 =A(CLOSCTFL),(RC)                                                
         MVI   ERROR,ERPUPDTQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         MVC   P(40),=CL40'XLOG RECORD WRITE ERROR EXIT: '                      
         EDIT  (R3),(8,P+30),ZERO=NOBLANK,ALIGN=LEFT                            
         GOTO1 VPRINTER                                                         
         MVC   P(40),=CL40'DMCB+8: '                                            
         GOTO1 VHEXOUT,DMCB,DMCBSAVE+8,P+8,1,=C'TOG'                            
         GOTO1 VPRINTER                                                         
         ABEND 770,DUMP                                                         
         DROP  R4,R6                                                            
         EJECT                                                                  
***********************************************************************         
* UPDATE RECOVERY FILE TRAWL STATE TABLE AND CALL EXTRACT MODULE      *         
*                                                                     *         
* ALGORITHM IS: (NOTE: DA = DISK-ADDRESS) ALSO SEE DESCRIPTION OF     *         
*                                         TASK-TABLE BELOW            *         
*                                                                     *         
* TRAWL:                                                              *         
*   GET A((TASK-TABLE) ENTRY FOR (THIS-TASK))                         *         
*   IF ((RECOVERY-DA) <= (TASK-LOW-DA)) THEN GOTO (TRAWL-EXIT-OK)     *         
*   IF ((RECOVERY-DATE) < (TODAY)) THEN GOTO (TRAWL-MAIN)             *         
*   IF ((RECOVERY-DATE) > (TODAY)) THEN GOTO (TRAWL-END)              *         
*   IF (OPERATOR CLOSE IS YES) THEN GOTO (TRAWL-MAIN)                 *         
*   IF ((LOW TASK LAST SIN) = (RECOVERY-SIN) AND                      *         
*      (LOW TASK LAST SID) = (RECOVERY-SID)) THEN GOTO (TRAWL-ERROR1) *         
*   IF ((RECOVERY-TIME) >= (EXTRACT-TO-TIME)) THEN GOTO (TRAWL-EXTRA) *         
*                                                                     *         
* TRAWL-MAIN:                                                         *         
*   CALL (SUB-SYSTEM-EXTRACT-MODULE)                                  *         
*   SET (EXTRACT-TO-DA) TO (RECOVERY-DA)                              *         
*   SET (TASK-HIGH-DA) TO (RECOVERY-DA)                               *         
*   SET (TASK-EVENT-FLAG) TO (ON)                                     *         
*   SET (TASK-HIGH-SIN) TO (RECOVERY-SIN)                             *         
*   SET (TASK-HIGH-SID) TO (RECOVERY-SID)                             *         
*   GOTO (TRAWL-EXIT-OK)                                              *         
*                                                                     *         
* TRAWL-EXTRA:                                                        *         
*   IF ((RECOVERY-TIME) >= (TIME-NOW)) THEN GOTO (TRAWL-END)          *         
*   IF ((TASK-EVENT-FLAG) = (OFF)) THEN GOTO (TRAWL-EXIT-OK)          *         
*   IF ((RECOVERY-SIN) <> (TASK-HIGH-SIN) AND                         *         
*       (RECOVERY-SID) <> (TASK-SID))                                 *         
*     THEN {                                                          *         
*      SET (TASK-EVENT-FLAG) TO (OFF)                                 *         
*      IF (ALL (TASK-EVENT-FLAGS) = (OFF)) THEN GOTO (TRAWL-END)      *         
*      GOTO (TRAWL-EXIT-OK)                                           *         
*          }                                                          *         
*   CALL (SUB-SYSTEM-EXTRACT-MODULE)                                  *         
*   SET (TASK-HIGH-DA) TO (RECOVERY-DA)                               *         
*   GOTO (TRAWL-EXIT-OK)                                              *         
*                                                                     *         
* TRAWL-END:                                                          *         
*   SET (TRAWL-END-FLAG) TO (ON)                                      *         
*                                                                     *         
* TRAWL-EXIT-OK:                                                      *         
*   EXIT ROUTINE CC .EQ.                                              *         
*                                                                     *         
* TRAWL-ERROR1                                                        *         
*   PRINT ERROR MESSAGE AND ABEND                                     *         
*                                                                     *         
* TASK-TABLE: (SEE DXRTTAB IN DXDSECTS)                               *         
*   TABLE CONTAINS ENTRIES DESCRIBING EXTRACT STATE FOR EACH POSSIBLE *         
*   FACPAK TASK ID. EACH ENTRY CONSISTS OF:                           *         
*     TASK-LOW-DA - DA OF LAST RECOVERY RECORD LAST TRAWL             *         
*     TASK-HIGH-DA - DA OF LAST RECOVERY RECORD EXTRACTED THIS TRAWL  *         
*     TASK-LOW-SIN - SYSTEM INPUT NUMBER OF LAST RECOVERY RECORD      *         
*                      LAST TRAWL                                     *         
*     TASK-LOW-SID - SYSTEM ID OF LAST RECOVERY RECORD LAST TRAWL     *         
*     TASK-HIGH-SIN - SYSTEM INPUT NUMBER OF LAST RECOVERY RECORD     *         
*     TASK-HIGH-SID - SYSTEM ID OF LAST RECOVERY RECORD               *         
*     TASK-EVENT-FLAG - FLAG RECOVERY RECORD HAS BEEN FOUND FOR THIS  *         
*                       TASK                                          *         
*                                                                     *         
***********************************************************************         
         SPACE 1                                                                
         USING RECDS,R6                                                         
X        USING DXBLOCKD,R4         **R4 & R5 DSECTS ARE OVERLAPPED**            
TRAWL    NTR1  ,                                                                
*                                                                               
         USING DXRTTAB,R5                                                       
         BRAS  RE,GETTSKT          GET A(TASK-TABLE) FOR THIS TASK              
*                                                                               
         BRAS  RE,GETSID           GET RECOVERY RECORD SYSTEM ID                
*                                                                               
         CLC   RCVDA,DXRTLDA       IF (RECOVERY-DA)<=(TASK-LOW-DA)              
         BNH   TRAWOK                THEN GOTO (TRAWL-EXIT-OK)                  
         CLC   RDATE,DATENB        IF (RECOVERY-DATE)>(TODAY)                   
         BH    TRAWEND               THEN GOTO (TRAWL-END)                      
*                                                                               
**IF TOO MANY DCB OPENED, GOTO (TRAWL-END)                                      
         CLC   ALDCBNUM,DCBLIMIT                                                
         BL    *+12                                                             
         MVI   SKIPWAIT,C'Y'       SKIP WAITING ON NEXT LOOP                    
         B     TRAWEND                                                          
*                                                                               
         CLC   RDATE,DATENB        IF (RECOVERY-DATE)<(TODAY)                   
         BL    TRAW020               THEN GOTO (TRAWL-MAIN)                     
*                                                                               
         CLI   CLOSFLAG,C'Y'       IF (OPERATOR CLOSE IS YES)                   
         BE    TRAW020               THEN GOTO (TRAWL-MAIN)                     
         CLI   RSYSID,X'00'        CONTINUE IF SYSTEM ID = 0 (OFFLINE)          
         BE    TRAW010                                                          
         OC    DXRTLSN,DXRTLSN     CHECK UNFINISHED TASK FROM LAST PASS         
         BZ    TRAW010               UNLESS NULL TASK ID (I.E. OFFLINE)         
         CLC   DXRTLSN,RSIN+1      TEST LAST SYSTEM INPUT NUMBER                
         BNE   TRAW010                                                          
         CLC   DXRTLSI,RSYSID      TEST LAST SYSTEM ID                          
         BNE   TRAW010                                                          
         CLI   RPRG,0              PLOUGH ON IF SERVICE PROGRAM UPDATE          
         BE    TRAW010                                                          
         B     TRAW010                                                          
         B     TRAWER1             DIE IF UNFINISHED TASK                       
*                                                                               
TRAW010  EQU   *                                                                
         CLI   HOSTDB,C'Y'                                                      
         BE    TRAW020                                                          
*                                                                               
         TM    X.DXRTEXT,DXRTEXQ  ALREADY IN THE EXTRA TRAWL RANGE?             
         BO    TRAWEXT              YES, GOTO (TRAWL-EXTRA)                     
         ICM   R1,15,RTIME        IF (RECOVERY-TIME)>=(EXTRACT-TO-TIME)         
         ICM   RF,15,X.DXTTIME        THEN GOTO (TRAWL-EXTRA)                   
         BRAS  RE,COMPTIME                                                      
         BNL   TRAWEXT                                                          
*                                                                               
*                                  (TRAWL-MAIN)                                 
*                                                                               
TRAW020  BRAS  RE,SETHTYP          CALL (SUB-SYSTEM-EXTRACT-MODULE)             
         GOTO1 =A(CALLSEX),(RC)    CALL SYSTEM EXTRACT MODULE                   
         BNE   TRAWNO              ERROR EXIT                                   
*                                                                               
         MVC   X.DXTDA,RCVDA       SET (EXTRACT-TO-DA) TO (RECOVERY-DA)         
         MVC   DXRTHDA,RCVDA       SET (TASK-HIGH-DA) TO (RECOVERY-DA)          
         MVI   DXRTEVF,1           SET (TASK-EVENT-FLAG) TO (ON)                
         MVC   DXRTHSN,RSIN+1      SET (TASK-HIGH-SIN) TO (RECV.-SIN)           
         MVC   DXRTHSI,RSYSID      SET (TASK-HIGH-SID) TO (RECV.-SID)           
         B     TRAWOK              GOTO (TRAWL-EXIT-OK)                         
*                                                                               
*                                  (TRAWL-EXTRA)                                
TRAWEXT  EQU   *                                                                
         OI    X.DXRTEXT,DXRTEXQ   SET IN THE EXTRA TRAWL RANGE                 
         ICM   R1,15,RTIME         IF (RECOVERY-TIME)>=(TIME-NOW)               
         ICM   RF,15,TIMEND          THEN GOTO (TRAWL-END)                      
         BRAS  RE,COMPTIME                                                      
         BNL   TRAWEND                                                          
*                                                                               
TREX010  CLI   DXRTEVF,0           IF (TASK-EVENT-FLAG) = (OFF)                 
         BE    TRAWOK                THEN GOTO (TRAWL-EXIT-OK)                  
         CLC   RSIN+1(3),DXRTHSN   IF (RECOVERY-SIN)<>(TASK-HIGH-SIN)           
         BNE   TREX012               AND                                        
         CLC   RSYSID,DXRTHSI         (RECOVERY-SID)<>(TASK-HIGH-SID)           
         BE    TREX020               THEN{                                      
TREX012  MVI   DXRTEVF,0               SET (TASK-EVENT-FLAG) TO (OFF)           
         BRAS  RE,CHKTDONE             IF ALL(TASK-EVENT-FLAGS)=(OFF)           
         BE    TRAWEND                   THEN GOTO (TRAWL-END) }                
         B     TRAWOK                  GOTO (TRAWL-EXIT-OK)                     
*                                                                               
TREX020  BRAS  RE,SETHTYP          CALL (SUB-SYSTEM-EXTRACT-MODULE)             
         GOTO1 =A(CALLSEX),(RC)    CALL SYSTEM EXTRACT MODULE                   
         BNE   TRAWNO              ERROR EXIT                                   
*                                                                               
         MVC   DXRTHDA,RCVDA       SET (TASK-HIGH-DA) TO (RECOVERY-DA)          
         B     TRAWOK              GOTO (TRAWL-EXIT-OK)                         
*                                                                               
*                                  (TRAWL-END)                                  
TRAWEND  EQU   *                                                                
         MVI   TRAWLEND,END        SET (TRAWL-END-FLAG) TO (ON)                 
         MVI   X.DXRTEXT,0                                                      
         B     TRAWOK                                                           
*                                  (TRAWL-EXIT-OK)                              
TRAWOK   SR    RC,RC                                                            
*                                  (TRAWL-EXIT-ERROR)                           
TRAWNO   LTR   RC,RC                                                            
         XIT1                                                                   
*                                  (TRAWL-ERROR1)                               
TRAWER1  EQU   *                   HERE IF 'UNFINISHED' TASK PROCESSING         
         GOTO1 =A(CLOSCTFL),(RC)                                                
         MVI   ERROR,ERTRAW1Q                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         MVC   P(40),=CL40'RECOVERY RECORD DETAILS:'                            
         GOTO1 VPRINTER                                                         
         MVC   P(40),=CL40'DISK ADDRESS:'                                       
         GOTO1 VHEXOUT,DMCB,RCVDA,P+20,4,=C'TOG'                                
         MVC   P+31(40),=CL40'SIN #:'                                           
         GOTO1 VHEXOUT,DMCB,RSIN+1,P+38,3,=C'TOG'                               
         MVC   P+47(40),=CL40'FACPAK ID:'                                       
         GOTO1 VHEXOUT,DMCB,RSYSID,P+58,1,=C'TOG'                               
         GOTO1 VPRINTER                                                         
         MVC   P(40),=CL40'HEADER:'                                             
         GOTO1 VHEXOUT,DMCB,(R6),P+20,28,=C'TOG'                                
         GOTO1 VPRINTER                                                         
         ABEND 780,DUMP                                                         
         DROP  R5,R6                                                            
         DROP  X                                                                
         EJECT                                                                  
***********************************************************************         
* GET RECOVERY RECORD SYSTEM ID                                       *         
* ON ENTRY R6 = A(RECOVERY HEADER)                                    *         
***********************************************************************         
         SPACE 1                                                                
         USING RECDS,R6                                                         
GETSID   EQU   *                                                                
         MVI   RSYSID,0                                                         
         TM    RTIME,X'80'                                                      
         BZ    GSIDOK                                                           
         ZIC   RF,RTIME+3                                                       
         SRL   RF,4                                                             
         STC   RF,RSYSID                                                        
*                                                                               
GSIDOK   BR    RE                                                               
         DROP  R6                                                               
         EJECT                                                                  
***********************************************************************         
* GET TASK TABLE ENTRY ADDRESS                                        *         
* ON ENTRY R6 = A(RECOVERY HEADER)                                    *         
* ON ENTRY R4 = A(EXTRACT DATA BLOCK)                                 *         
* ON EXIT  R5 = A(TASK TABLE ENTRY)                                   *         
***********************************************************************         
         SPACE 1                                                                
         USING RECDS,R6                                                         
         USING DXBLOCKD,R4                                                      
GETTSKT  EQU   *                                                                
         LA    RF,TTABLIST         POINT TO LIST OF TASK IDS                    
         SR    R1,R1               R1 = TASK ID NUMBER                          
         CLI   RTASKID,X'00'       OLD VERMONTS TREAT ALL OFFLINE AS            
         BE    GTSK020             ONE TASK.                                    
         CLI   RTASKID,X'FD'       OFFLINE CAN BE FD OR FE OFFLINE AS           
         BNL   GTSK020             WELL AS ZERO                                 
GTSK010  CLC   RTASKID,0(RF)                                                    
         BE    GTSK020                                                          
         LA    R1,1(R1)                                                         
         LA    RF,1(RF)                                                         
         CLI   0(RF),0                                                          
         BNE   GTSK010                                                          
         B     GTSKER1                                                          
*                                                                               
GTSK020  EQU   *                                                                
         LA    R5,DXRTTAB          SET R5=A(TASK-TABLE ENTRY)                   
         MH    R1,=YL2(DXRTTLN)                                                 
         AR    R5,R1                                                            
         B     GTSKOK                                                           
*                                                                               
GTSKOK   BR    RE                                                               
*                                                                               
GTSKER1  EQU   *                   ERROR IN RECOVERY TASK CONTROL BLOCK         
         GOTO1 =A(CLOSCTFL),(RC)                                                
         MVI   ERROR,ERGTSK1Q                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         MVC   P(40),=CL40'RECOVERY RECORD DETAILS:'                            
         GOTO1 VPRINTER                                                         
         MVC   P(40),=CL40'DISK ADDRESS:'                                       
         GOTO1 VHEXOUT,DMCB,RCVDA,P+20,4,=C'TOG'                                
         MVC   P+31(40),=CL40'SIN #:'                                           
         GOTO1 VHEXOUT,DMCB,RSIN+1,P+38,3,=C'TOG'                               
         MVC   P+47(40),=CL40'FACPAK ID:'                                       
         GOTO1 VHEXOUT,DMCB,RSYSID,P+58,1,=C'TOG'                               
         GOTO1 VPRINTER                                                         
         MVC   P(40),=CL40'HEADER:'                                             
         GOTO1 VHEXOUT,DMCB,(R6),P+20,28,=C'TOG'                                
         GOTO1 VPRINTER                                                         
         ABEND 781,DUMP                                                         
         DROP  R4,R6                                                            
         SPACE 1                                                                
***********************************************************************         
* CHECK ALL TASK ACTIVITY DONE, OR ALL(TASK-EVENT-FLAGS) = OFF        *         
* ON ENTRY R4 = A(EXTRACT DATA BLOCK)                                 *         
***********************************************************************         
         SPACE 1                                                                
         USING DXBLOCKD,R4                                                      
CHKTDONE EQU   *                                                                
         LA    RF,DXRTTAB          CHECK EACH ENTRY IN TASK-TABLE               
         USING DXRTTAB,RF                                                       
         LA    R0,DXRTMAX                                                       
CTDN010  CLI   DXRTEVF,0           CHECK (TASK-EVENT-FLAG)=(OFF)                
         BNE   CTDNX               EXIT CC .NE. IF EVENT PENDING                
         LA    RF,DXRTTLN(RF)                                                   
         BCT   R0,CTDN010                                                       
         CR    R0,R0               IF ALL EVENTS CLEARED SET CC .EQ.            
CTDNX    BR    RE                                                               
         DROP  RF,R4                                                            
         EJECT                                                                  
***********************************************************************         
* TRAWL PROCESS FOR EXTENDED VERMONT METHOD                           *         
***********************************************************************         
         SPACE 1                                                                
         USING RECDS,R6                                                         
X        USING DXBLOCKD,R4         **R4 & R5 DSECTS ARE OVERLAPPED**            
EXTTRAWL NTR1  ,                                                                
         CLC   RCVDA,X.DXTDA       HAVE WE REACHED TRAWL END?                   
         BH    XTRAWEND            YES, END TRAWL                               
*                                                                               
*        LOOK FOR SIN IN DXRTTAB.                                               
*        DXRTLSN = SIN                                                          
*        DXRTLDA = LOW DISK ADDRESS OF THE TASK WITH THAT SIN, FROM             
*                  THE INPUT XLOG RECORD. THE TASK WAS ACTIVE DURING            
*                  THE LAST TRAWL, SO MAY BE EXTRACTED IF COMPLETE.             
*        DXRTHDA - LOW DISK ADDRESS OF THE TASK WITH THAT SIN, FROM             
*                  A VERMONT HEADER. THE TASK IS ACTIVE DURING THIS             
*                  TRAWL SO CANNOT BE EXTRACTED. THIS BECOMES AN ENTRY          
*                  IN THE OUTPUT XLOG RECORD.                                   
*        IF DXRTLDA AND DXRTHDA ARE BOTH SET:                                   
*           IF THEY ARE THE SAME, THEN THE SAME TASK IS STILL ACTIVE.           
*           IF DIFFERENT, THEY ARE TWO CONSECUTIVE OFFLINE TASKS WITH           
*           THE SAME SIN. THE FIRST HAS COMMITED AND CAN BE EXTRACTED.          
*           TEH SECOND IS STILL ACTIVE AND MUST NOT BE EXTRACTED YET.           
*                                                                               
         LA    R5,X.DXRTTAB        SEE IF SIN IN DXRTTAB                        
         USING DXRTTAB,R5                                                       
XTRAW010 OC    DXRTLSN,DXRTLSN     EMPTY DXRTTAB ENTRY (END OF XLOGS)           
         BZ    XTRAW012            YES, NOTHING FOUND                           
         CLC   DXRTLSN,RSIN+1      SAME SIN?                                    
         BE    XTRAW020            YES, GOT IT                                  
         LA    R5,DXRTTLN(,R5)     NEXT DXRTTAB ENTRY                           
         B     XTRAW010                                                         
XTRAW012 XR    R5,R5               ZERO R5 IF NOT IN TABLE                      
*                                                                               
XTRAW020 CLC   RCVDA,EXTVODA       ARE WE BEYOND THE END OF LAST TRAWL?         
         BH    XTRAW030            YES, SKIP                                    
*                                                                               
*        WE ARE IN THE AREA COVERED BY PREVIOUS TRAWLS LOOKING FOR ANY          
*        RECORDS THAT WERE IGNORED BECAUSE THEIR TASK WAS ACTIVE BUT            
*        IS NOW COMPLETE. THESE RECORDS CAN NOW BE EXTRACTED. WE MUST           
*        IGNORE ANY OTHERS AS THEY HAVE ALREADY BEEN EXTRACTED.                 
*        ONE THING TO WATCH: TWO CONSECUTIVE OFFLINE TASKS CAN HAVE THE         
*        SAME SIN, BUT WILL HAVE DIFFERENT START ADDRESSES. IN THOSE            
*        CASES, WE CAN EXTRACT RECORDS FROM THE FIRST (COMPLETED) TASK          
*        BUT IGNORE THOSE FROM THE STILL ACTIVE TASK.                           
*                                                                               
         LTR   R5,R5               IS SIN IN TABLE?                             
         BZ    XTRAWOK             NO, SO ALREADY EXTRACTED                     
         OC    DXRTLDA,DXRTLDA     WAS IT IN XLOG? (DXRTLDA=XLOG START)         
         BZ    XTRAWOK             NO, ALREADY EXTRACTED                        
         CLC   RCVDA,DXRTLDA       IS DISK ADDRESS LOWER THAN XLOG STRT         
         BL    XTRAWOK             YES, ALREADY EXTRACTED                       
         OC    DXRTHDA,DXRTHDA     IS SIN IN AN ACTIVE VERMONT?                 
         BZ    XTRAW040            NO, CAN EXTRACT IT NOW                       
         CLI   CLOSFLAG,C'Y'       IF CLOSING, WE MUST EXTRACT IT.              
         BE    XTRAW040            (WARNING ALREADY ISSUED AT START)            
         CLC   RCVDA,DXRTHDA       IS RECORD WITHIN VERMONT RANGE?              
         BNL   XTRAWOK             YES, NEW TASK. CAN'T EXTRACT IT.             
         B     XTRAW040            ELSE EXTRACT IT NOW                          
*                                                                               
*        WE ARE IN THE AREA NOT YET COVERED BY A TRAWL. WE CAN EXTRACT          
*        ANY RECORDS THAT DO NOT BELONG TO AN ACTIVE TASK.                      
*                                                                               
XTRAW030 LTR   R5,R5               WE ARE IN GENERAL EXTRACT PERIOD             
         BZ    XTRAW040            NOT IN TABLE, SO OK TO EXTRACT               
         XC    DXRTLDA,DXRTLDA     CLEAR XLOG ENTRY                             
*                                                                               
         OC    DXRTHDA,DXRTHDA     IS SIN IN ACTIVE VERMONT?                    
         BZ    XTRAW040            NO, OK TO EXTRACT                            
         CLI   CLOSFLAG,C'Y'       IF CLOSING, WE MUST EXTRACT RECORD           
         BE    XTRAW040            (WARNING ALREADY ISSUED AT START)            
         CLC   RCVDA,DXRTHDA       IS THIS RECORD WITHIN VERMONT RANGE          
         BNL   XTRAWOK             YES, DON'T EXTRACT IT.                       
*                                                                               
XTRAW040 CLC   ALDCBNUM,DCBLIMIT   IF TOO MANY DCBS OPENED ALREADY              
         BL    XTRAW050                                                         
         MVI   SKIPWAIT,C'Y'       SKIP TRAWL WAIT SO RESTARTS AT ONCE          
         MVC   X.DXTDA,EXTVFDA     SET WHERE WE REACHED FOR NEXT TRAWL          
         B     XTRAWEND            AND END THIS TRAWL                           
*                                                                               
XTRAW050 BRAS  RE,SETHTYP          CALL (SUB-SYSTEM-EXTRACT-MODULE)             
         GOTO1 =A(CALLSEX),(RC)    CALL SYSTEM EXTRACT MODULE                   
         BNE   XTRAWNO             ERROR EXIT                                   
         MVC   EXTVFDA,RCVDA       WHERE WE'VE REACHED FOR XTRAW040             
         B     XTRAWOK                                                          
*                                                                               
XTRAWEND EQU   *                                                                
         MVI   TRAWLEND,END        SET (TRAWL-END-FLAG) TO (ON)                 
*                                                                               
XTRAWOK  SR    RC,RC                                                            
*                                                                               
XTRAWNO  LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R5,R6                                                            
         DROP  X                                                                
         EJECT                                                                  
***********************************************************************         
* SET RECORD TYPE CODE IN HEADER                                      *         
***********************************************************************         
         SPACE 1                                                                
         USING RECDS,R6                                                         
         USING DXBLOCKD,R4                                                      
SETHTYP  EQU   *                                                                
         CLI   RRECTY,X'02'        TEST IF CHANGE RECOVERY RECORD TYPE          
         BNE   *+12                                                             
         MVI   DXACTION,C'C'                                                    
         B     SHTYX                                                            
         CLI   RRECTY,X'03'        TEST IF ADD RECOVERY RECORD TYPE             
         BNE   SHTYX                                                            
         MVI   DXACTION,C'A'                                                    
         B     SHTYX                                                            
*                                                                               
SHTYX    BR    RE                                                               
         DROP  R4,R6                                                            
         EJECT                                                                  
***********************************************************************         
* BUILD EXTRACT RECOVERY SYSTEM LOG DATA IN DATA BLOCK                *         
* R4 = A(SYSTEM EXTRACT MODULE DATA BLOCK)                            *         
***********************************************************************         
         SPACE 1                                                                
         USING DXBLOCKD,R4                                                      
BXRCVSYS NTR1  ,                                                                
         MVI   MSGNUM,MSBXLOGQ                                                  
         GOTO1 =A(MSGPRT),(RC)                                                  
*                                                                               
         CLI   AUTOFLAG,OFF                                                     
         BE    BXRSOK                                                           
         CLI   DAILYFLG,ON                                                      
         BE    BXRSOK                                                           
*                                                                               
BXRS010  EQU   *                                                                
         L     RE,=V(UTL)                                                       
         MVI   4(RE),CONTROLQ                                                   
         CLI   STARFLAG,C'Y'       TEST IF START FLAG IS ON                     
         BNE   BXRS012                                                          
         BRAS  RE,CLEARLOG         CLEAR EXISTING SYSTEM LOG RECORDS            
         BNE   BXRSNO                                                           
         B     BXRSOK              AND EXIT                                     
*                                                                               
BXRS012  LA    R2,IOKEY                                                         
         USING GXTRD,R2                                                         
         XC    GXKEY,GXKEY        CLEAR RECORD KEY                              
         MVI   GXKREC,GXRKRECQ                                                  
         MVC   GXRKSEN,DXSENUM                                                  
         MVC   GXRKDAT,=XL2'FFFF'                                               
         XC    GXRKDAT,DATENC                                                   
         MVC   GXRKTMC,=XL4'FFFFFFFF'                                           
         XC    GXRKTMC,TIMEND                                                   
         L     R2,ARECBUFF        READ HIGH FOR FIRST LOG RECORD                
*                                 READ HIGH WITH FLUSH                          
         GOTO1 VDATAMGR,DMCB,(X'24',DMRDHI),GENDIR,IOKEY,(R2),DMWORK            
         TM    8(R1),X'FF'-X'80'   ONLY ALLOW EOF ERROR                         
         BZ    *+6                                                              
         DC    H'0'                DATAMANAGER RETURN NOT 0 OR EOF              
         CLI   8(R1),0                                                          
         BNE   BXRSNO                                                           
         CLC   GXKEY(GXRKDAT-GXKEY),IOKEY                                       
         BNE   BXRSOK                                                           
         CLC   GXRKTHD,THREAD      SAME THREAD#?                                
         BNE   BXRS030             NO - READ NEXT RECORD                        
         B     BXRSDATA                                                         
*                                                                               
BXRS030  L     R2,ARECBUFF                                                      
         GOTO1 VDATAMGR,DMCB,(X'24',DMRSEQ),GENDIR,IOKEY,(R2),DMWORK            
         TM    8(R1),X'FF'-X'80'   ONLY ALLOW EOF ERROR                         
         BZ    *+6                                                              
         DC    H'0'                DATAMANAGER RETURN NOT 0 OR EOF              
         CLI   8(R1),0                                                          
         BNE   BXRSNO                                                           
         CLC   GXKEY(GXRKDAT-GXKEY),IOKEY                                       
         BNE   BXRSOK                                                           
         CLC   GXRKTHD,THREAD      SAME THREAD#?                                
         BNE   BXRS030             NO - READ NEXT RECORD                        
         B     BXRSDATA                                                         
*                                                                               
*                                  GETREC WITH FLUSH                            
BXRSDATA MVC   DMDA,GXDDA                                                       
         GOTO1 VDATAMGR,DMCB,(X'24',GETREC),GENFIL,DMDA,(R2),DMWORK             
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                CAN'T FIND RECORD                            
*                                                                               
         LA    R3,GXFIRST(R2)                                                   
*                                                                               
BXRS100  CLI   0(R3),0                                                          
         BE    BXRS200                                                          
         CLI   0(R3),GXRSELQ       PROCESS SYSTEM LOG ELEMENT                   
         BE    BXRS120                                                          
         CLI   0(R3),GXSIELQ       PROCESS LAST TASK SIN ELEMENT                
         BE    BXRS130                                                          
BXRS110  SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     BXRS100                                                          
*                                                                               
         USING GXRSEL,R3                                                        
BXRS120  EQU   *                   PROCESS RECOVERY SYSTEM LOG ELEMENT          
         CLI   STARFLAG,C'O'       SET START FLAG OVERRIDE                      
         BE    BXRS122                                                          
         TM    GXRSTFL,X'01'       IF LAST PASS WAS CLOSE FORCE RESTART         
         BZ    BXRS122                                                          
         MVI   STARFLAG,C'Y'       SET START FLAG TO ON                         
         BRAS  RE,CLEARLOG         CLEAR EXISTING SYSTEM LOG RECORDS            
         BNE   BXRSNO                                                           
         B     BXRSOK              AND EXIT                                     
BXRS122  MVC   DXFTIME,GXRSTTM                                                  
         MVC   DXFDA,GXRSTDA                                                    
         MVC   DXTDA,GXRSTDA                                                    
         MVI   DXRTEXT,0                                                        
         LA    R0,DXRTMAX                                                       
         LA    RE,DXRTTAB                                                       
         LA    RF,GXRSLDA                                                       
         USING DXRTTAB,RE                                                       
BXRS124  MVC   DXRTLDA,0(RF)                                                    
         XC    DXRTHDA,DXRTHDA                                                  
         XC    DXRTLSN,DXRTLSN                                                  
         XC    DXRTLSI,DXRTLSI                                                  
         XC    DXRTHSN,DXRTHSN                                                  
         XC    DXRTHSI,DXRTHSI                                                  
         MVI   DXRTEVF,0                                                        
         LA    RE,DXRTTLN(RE)                                                   
         LA    RF,L'GXRSLDA(RF)                                                 
         BCT   R0,BXRS124                                                       
         DROP  RE                                                               
         B     BXRS110                                                          
*                                                                               
         USING GXSIEL,R3                                                        
BXRS130  EQU   *                   PROCESS LAST TASK SIN ELEMENT                
         LA    R0,DXRTMAX                                                       
         LA    RE,DXRTTAB                                                       
         LA    RF,GXSIVAL                                                       
         USING DXRTTAB,RE                                                       
BXRS134  MVC   DXRTLSN,0(RF)                                                    
         MVC   DXRTLSI,3(RF)                                                    
         XC    DXRTHSN,DXRTHSN                                                  
         XC    DXRTHSI,DXRTHSI                                                  
         LA    RE,DXRTTLN(RE)                                                   
         LA    RF,L'GXSIVAL(RF)                                                 
         BCT   R0,BXRS134                                                       
         DROP  RE                                                               
         B     BXRS110                                                          
*                                                                               
BXRS200  EQU   *                   EXIT AFTER ELEMENT DATA PROCESSED            
         B     BXRSOK                                                           
*                                                                               
BXRSOK   SR    RC,RC                                                            
BXRSNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R2,R3,R4                                                         
         EJECT                                                                  
***********************************************************************         
* CLEAR OLD SYSTEM LOG RECORDS IF RE START FLAG ON                    *         
* R4 = A(SYSTEM EXTRACT MODULE DATA BLOCK)                            *         
***********************************************************************         
         SPACE 1                                                                
         USING DXBLOCKD,R4                                                      
CLEARLOG NTR1  ,                                                                
         MVI   MSGNUM,MSCXLOGQ                                                  
         GOTO1 =A(MSGPRT),(RC)                                                  
*                                                                               
         GOTO1 =A(ENQCTRL),(RC)    ENQUEUE CONTROL SYSTEM FOR UPDATES           
*                                                                               
         LA    R2,IOKEY                                                         
         USING GXTRD,R2                                                         
         XC    GXKEY,GXKEY        CLEAR RECORD KEY                              
         MVI   GXKREC,GXRKRECQ                                                  
         MVC   GXRKSEN,DXSENUM                                                  
         L     R2,ARECBUFF        READ HIGH FOR FIRST LOG RECORD                
*                                  READ HIGH FOR UPDATE WITH FLUSH              
         GOTO1 VDATAMGR,DMCB,(X'A4',DMRDHI),GENDIR,IOKEY,(R2),DMWORK            
         CLI   8(R1),0                                                          
         BE    *+12                                                             
         LA    R0,1                                                             
         B     CLOGERR             DATAMANAGER RETURN NOT 0 OR EOF              
         CLC   GXKEY(GXRKDAT-GXKEY),IOKEY                                       
         BNE   CLOGEX                                                           
         CLC   GXRKTHD,THREAD      SAME THREAD#?                                
         BNE   CLOG010             NO-READ NEXT XLOG RECORD                     
         B     CLOG020                                                          
*                                                                               
CLOG010  L     R2,ARECBUFF                                                      
         GOTO1 VDATAMGR,DMCB,(X'A4',DMRSEQ),GENDIR,IOKEY,(R2),DMWORK            
         CLI   8(R1),0                                                          
         BE    *+12                                                             
         LA    R0,2                                                             
         B     CLOGERR             DATAMANAGER RETURN NOT 0 OR EOF              
         CLC   GXKEY(GXRKDAT-GXKEY),IOKEY                                       
         BNE   CLOGEX                                                           
         CLC   GXRKTHD,THREAD      SAME THREAD#?                                
         BNE   CLOG010             NO-READ NEXT XLOG RECORD                     
         B     CLOG020                                                          
*                                                                               
CLOG020  MVC   DMDA,GXDDA                                                       
         MVC   IOKEY(L'GXKEY),GXKEY                                             
         L     R2,ARECBUFF        READ HIGH FOR FIRST LOG RECORD                
         OI    GXDSTAT,X'80'       SET DELETE FLAG IN DIRECTORY                 
         GOTO1 VDATAMGR,DMCB,(X'00',DMWRT),GENDIR,IOKEY,(R2),DMWORK             
         CLI   8(R1),0                                                          
         BE    *+12                                                             
         LA    R0,3                                                             
         B     CLOGERR                                                          
*                                  GETREC WITH FLUSH                            
         GOTO1 VDATAMGR,DMCB,(X'A4',GETREC),GENFIL,DMDA,(R2),DMWORK             
         CLI   8(R1),0                                                          
         BE    *+12                                                             
         LA    R0,4                                                             
         B     CLOGERR                                                          
         OI    GXFSTAT,X'80'       SET DELETE FLAG IN DIRECTORY                 
         GOTO1 VDATAMGR,DMCB,PUTREC,GENFIL,DMDA,(R2),DMWORK                     
         CLI   8(R1),0                                                          
         BE    *+12                                                             
         LA    R0,5                                                             
         B     CLOGERR                                                          
         B     CLOG010                                                          
*                                                                               
CLOGEX   EQU   *                                                                
         GOTO1 =A(DEQCTRL),(RC)    DEQUEUE CONTROL SYSTEM                       
*&&UK                                                                           
         L     RE,=V(UTL)          COMMIT CONTROL SYSTEM                        
         MVC   BYTE,4(RE)                                                       
         MVI   4(RE),CONTROLQ                                                   
         LAY   RF,IO                                                            
         GOTO1 VDATAMGR,DMCB,=C'COMMIT ',=C'CONTROL',(RF)                       
         L     RE,=V(UTL)                                                       
         MVC   4(1,RE),BYTE                                                     
*&&                                                                             
         B     CLOGOK                                                           
*                                                                               
CLOGERR  EQU   *                                                                
         MVC   DMCBSAVE(24),DMCB                                                
         GOTO1 =A(DEQCTRL),(RC)                                                 
         GOTO1 =A(CLOSCTFL),(RC)                                                
         LA    RF,DMCBSAVE                                                      
         B     CLOGNO                                                           
*                                                                               
CLOGOK   SR    RC,RC                                                            
CLOGNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R2,R4                                                            
         EJECT                                                                  
***********************************************************************         
* WRITE EXTRACT RECOVERY SYSTEM LOG DATA FROM DATA BLOCK (XLOG RECORD)*         
* R4 = A(SYSTEM EXTRACT MODULE DATA BLOCK)                            *         
***********************************************************************         
         SPACE 1                                                                
         USING DXBLOCKD,R4                                                      
WXRCVSYS NTR1  ,                                                                
         MVI   MSGNUM,MSWRTRSQ                                                  
         GOTO1 =A(MSGPRT),(RC)                                                  
*                                                                               
         CLI   AUTOFLAG,OFF                                                     
         BE    WXRSOK                                                           
         CLI   DAILYFLG,ON                                                      
         BE    WXRSOK                                                           
*                                                                               
WXRS010  EQU   *                                                                
         GOTO1 =A(ENQCTRL),(RC)    ENQUEUE CONTROL SYSTEM FOR UPDATES           
         L     RE,=V(UTL)                                                       
         MVI   4(RE),CONTROLQ                                                   
         LA    R2,IOKEY                                                         
         USING GXTRD,R2                                                         
         XC    GXKEY,GXKEY        CLEAR RECORD KEY                              
         MVI   GXKREC,GXRKRECQ                                                  
         MVC   GXRKSEN,DXSENUM                                                  
         MVC   GXRKDAT,=XL2'FFFF'                                               
         XC    GXRKDAT,DATENC                                                   
         MVC   GXRKTMC,=XL4'FFFFFFFF'                                           
         XC    GXRKTMC,TIMEND                                                   
         MVC   GXRKTHD,THREAD      THREAD#                                      
         L     R2,ARECBUFF                                                      
*                                 CHECK RECORD NOT FOUND                        
*                                 READ UPDATE/DELETES WITH FLUSH                
         GOTO1 VDATAMGR,DMCB,(X'AC',DMREAD),GENDIR,IOKEY,(R2),DMWORK            
         CLI   8(R1),X'10'                                                      
         BE    *+12                                                             
         LA    R0,1                                                             
         B     PUPDERR                                                          
*                                                                               
WXRSDATA EQU   *                   BUILD RECORD DATA                            
         MVC   GXKEY,IOKEY                                                      
         XC    GXFSTAT(GXFIRST-GXKEYL),GXFSTAT                                  
         MVC   GXFLEN,=AL2(GXFIRST)                                             
         OI    GXFCTL,GXFTCMP      SET DATE/TIME COMPLEMENTED                   
*                                  BUILD RECOVERY FILE LOG ELEMENT              
         XC    ELEMENT,ELEMENT                                                  
         LA    R3,ELEMENT                                                       
         USING GXRSEL,R3                                                        
         MVI   GXRSEL,GXRSELQ                                                   
         MVI   GXRSELL,GXRSELLQ                                                 
         MVI   GXRSNUM,DXRTMAX                                                  
         MVC   GXRSDAT,DATENC                                                   
         XC    GXRSTIM,TIMEND                                                   
         MVC   GXRSFTM,DXFTIME                                                  
         CLI   STARFLAG,C'Y'                                                    
         BNE   *+8                                                              
         OI    GXRSFFL,X'01'                                                    
         CLI   SKIPWAIT,C'Y'                                                    
         BE    *+16                                                             
         CLI   CLOSFLAG,C'N'                                                    
         BE    *+8                                                              
         OI    GXRSTFL,X'01'                                                    
         MVC   GXRSTTM,DXTTIME                                                  
         CLC   DXFDA,DXTDA                                                      
         BH    *+14                                                             
         MVC   GXRSFDA,DXFDA                                                    
         B     *+10                                                             
         MVC   GXRSFDA,DXTDA                                                    
         MVC   GXRSTDA,DXTDA                                                    
         LA    R0,DXRTMAX                                                       
         LA    RE,DXRTTAB                                                       
         USING DXRTTAB,RE                                                       
         LA    RF,GXRSLDA                                                       
         XR    R1,R1                                                            
         CLI   DXEXTVMT,C'Y'       USING EXTENDED VERMONT METHOD?               
         BE    WXRS124             YES, SLIGHTLY DIFFERENT BUILD                
WXRS122  OC    DXRTHDA,DXRTHDA                                                  
         BZ    *+14                                                             
         MVC   0(4,RF),DXRTHDA                                                  
         B     *+10                                                             
         MVC   0(4,RF),DXRTLDA                                                  
         LA    RE,DXRTTLN(RE)                                                   
         LA    RF,L'GXRSLDA(RF)                                                 
         BCT   R0,WXRS122                                                       
         B     WXRS128                                                          
WXRS124  OC    DXRTHDA,DXRTHDA     DXRTHDA=VRCXA1ST FROM VERMONTS               
         BZ    WXRS125                                                          
         MVC   0(4,RF),DXRTHDA                                                  
         LA    RF,L'GXRSLDA(RF)                                                 
         LA    R1,1(R1)                                                         
WXRS125  LA    RE,DXRTTLN(RE)                                                   
         BCT   R0,WXRS124                                                       
         STC   R1,GXRSNUM          NUMBER OF ACTIVE VERMONTS                    
         DROP  RE                                                               
*                                                                               
WXRS128  GOTO1 VHELLO,DMCB,(C'P',GENFIL),(R2),ELEMENT,0                         
         CLI   12(R1),0                                                         
         BE    *+12                                                             
         LA    R0,2                                                             
         B     PUPDERR                                                          
*                                  BUILD LAST TASK SIN ELEMENT                  
         XC    ELEMENT,ELEMENT                                                  
         LA    R3,ELEMENT                                                       
         USING GXSIEL,R3                                                        
         MVI   GXSIEL,GXSIELQ                                                   
         MVI   GXSIELL,GXSIELLQ                                                 
         LA    R0,DXRTMAX                                                       
         LA    RE,DXRTTAB                                                       
         USING DXRTTAB,RE                                                       
         LA    RF,GXSIVAL                                                       
         CLI   DXEXTVMT,C'Y'       USING EXTENDED VERMONT METHOD?               
         BE    WXRS136             YES, SLIGHTLY DIFFERENT BUILD                
WXRS132  OC    DXRTHSN,DXRTHSN                                                  
         BZ    WXRS133                                                          
         MVC   0(3,RF),DXRTHSN                                                  
         MVC   3(1,RF),DXRTHSI                                                  
         B     WXRS134                                                          
WXRS133  MVC   0(4,RF),DXRTLSN                                                  
         MVC   3(1,RF),DXRTLSI                                                  
WXRS134  LA    RE,DXRTTLN(RE)                                                   
         LA    RF,L'GXSIVAL(RF)                                                 
         BCT   R0,WXRS132                                                       
         B     WXRS138                                                          
WXRS136  OC    DXRTHDA,DXRTHDA     DXRTHDA=VRCXA1ST FROM VERMONTS               
         BZ    WXRS137                                                          
         MVC   0(4,RF),DXRTLSN     SIN FROM VERMONTS OR LAST XLOG               
         MVC   3(1,RF),DXRTLSI                                                  
         LA    RF,L'GXSIVAL(RF)                                                 
WXRS137  LA    RE,DXRTTLN(RE)                                                   
         BCT   R0,WXRS136                                                       
         DROP  RE                                                               
*                                                                               
WXRS138  GOTO1 VHELLO,DMCB,(C'P',GENFIL),(R2),ELEMENT,0                         
         CLI   12(R1),0                                                         
         BE    *+12                                                             
         LA    R0,3                                                             
         B     PUPDERR                                                          
*                                  ADD ACTIVITY ELEMENT                         
         GOTO1 =A(SETACT),(RC)                                                  
         BE    *+12                                                             
         LA    R0,4                                                             
         B     PUPDERR                                                          
*                                                                               
**********************************************************************          
*&&US*&& MVC   P(15),=CL15'BEFORE ADDREC1:'                                     
*&&US*&& BRAS  RE,PRTEOF                                                        
**********************************************************************          
*                                  ADD RECORD                                   
         MVC   IOKEY(GXKEYL),0(R2)                                              
         GOTO1 VDATAMGR,DMCB,(X'00',ADDREC),GENFIL,IOKEY,(R2),DMWORK            
         CLI   8(R1),0                                                          
         BE    *+12                                                             
         LA    R0,5                                                             
         B     PUPDERR                                                          
*                                                                               
         MVC   ADDRDA,IOKEY        SAVE DISK ADDRESS                            
*                                                                               
**********************************************************************          
*&&US*&& MVC   P(15),=CL15'AFTER  ADDREC1:'                                     
*&&US*&& BRAS  RE,PRTEOF                                                        
**********************************************************************          
*                                                                               
         GOTO1 =A(DEQCTRL),(RC)    DEQUEUE CONTROL SYSTEM                       
         B     WXRSOK                                                           
*                                                                               
WXRSOK   SR    RC,RC                                                            
WXRSNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R2,R3,R4                                                         
         EJECT                                                                  
***********************************************************************         
* IF MODE=UPDATE, DXTRACT NEEDS THE SYSTEM'S RECOVERY FILE (READ-ONLY)*         
*        FOR US, OPEN ALL FILES IN THE EXTRACT SYSTEM                 *         
*        FOR UK, OPEN ONLY THE EXTRACT SYSTEM'S RECOVERY FILE         *         
***********************************************************************         
         SPACE 1                                                                
OPENSYS  NTR1                                                                   
         L     R4,ADXBLOCK         R4=A(EXTRACT CONTROL DATA BLOCK)             
         USING DXBLOCKD,R4                                                      
*                                                                               
         CLI   DXSENUM,CONTROLQ    EXIT IF EXTRACT SYSTEM IS CONTROL            
         BE    OSYSOK              CONTROL RECOVERY IS OPENED ELSEWHERE         
*                                  SET UTL SENUM                                
         L     RE,=V(UTL)                                                       
         MVC   4(1,RE),DXSENUM                                                  
*                                                                               
*        SCAN THE SYSTEM'S FILE LIST LOOKING FOR THE RECOVERY FILE,             
*                                                                               
         GOTO1 VDMOD000,DMCB,A(FINDSYS),(DXSENUM,0)                             
         L     RF,4(,R1)           PICK UP A(SYSFLES FILE TABLE)                
         CLC   DXSENUM,0(RF)                                                    
         BE    *+6                                                              
         DC    H'0'                JUST MAKE SURE WE HAVE RIGHT LIST            
                                                                                
         LH    R0,2(,RF)           NUMBER OF FILES                              
         LA    RF,4(,RF)           FIRST FILE                                   
         USING SYSFLSTD,RF                                                      
OSYS010  TM    SYSFIND1,SFRCV      HAVE WE FOUND THE RECOVERY FILE?             
         BO    OSYS012             YES                                          
         LA    RF,8(,RF)           NEXT FILE                                    
         BCT   R0,OSYS010                                                       
         B     OSYSERR1            CAN'T FIND RECOVERY FILE                     
                                                                                
OSYS012  L     R1,4(,RF)           A(RECOVERY FILE DTF)                         
         ST    R1,RCVADTF          SAVE FOR DACLOSE                             
         USING DTFPHD,R1                                                        
*                                                                               
         MVI   DXEXTVMT,C'N'       PRESET NOT USING EXTENDED VERMONTS           
         TM    DIND,DINDVRX        TEST EXTENDED VERMONTS                       
         BZ    OSYS014                                                          
         MVI   DXEXTVMT,C'Y'       YES, SET USING EXTENDED VERMONTS             
         CLC   EXTVMT,DXEXTVMT     ALREADY NOTIFIED                             
         BE    OSYS014                                                          
         MVC   P(34),=C'RECOVERY FILE HAS EXTENDED FORMAT.'                     
         MVC   P+35(19),=C'EXTRATIME NOT USED.'                                 
         GOTO1 VPRINTER                                                         
OSYS014  MVC   EXTVMT,DXEXTVMT     SAVE EXTVMT STATE                            
*                                                                               
*&&DO                                                                           
         CLI   DXSENUM,X'66'       TEMPORARY FIX TO HANDLE ACC0 GLOBAL          
         BNE   OSYS010             FILES FOR US                                 
         L     RF,=A(SSB)                                                       
         USING FASSBOD,RF                                                       
         MVI   SSODSPAC,C'T'       SET DATASPACE CODE                           
         DROP  RF                                                               
*&&                                                                             
*&&US                                                                           
*                                                                               
*        FOR US OPEN ALL FILES IN SYSTEM                                        
*                                                                               
         DROP  R1                                                               
         GOTO1 VDATAMGR,DMCB,DMOPEN,DMUTL,DMRDONLY                              
         B     OSYSOK                                                           
*&&                                                                             
*&&UK                                                                           
*                                                                               
*        FOR UK SAVE RECOVERY FILE NAME AND OPEN IT USING DMOPEN                
*                                                                               
         MVI   WORK,C'N'           BUILD 'N???RCV X' OPEN LIST                  
         MVC   WORK+1(6),DTFFID    COPY 1ST 6 CHARS FILE ID                     
         MVI   WORK+7,C' '                                                      
         MVI   WORK+8,C'X'                                                      
         DROP  R1                                                               
         GOTO1 VDATAMGR,DMCB,DMOPEN,DMUTL,WORK,AIOL,0                           
         BE    OSYSOK                                                           
*&&                                                                             
                                                                                
OSYSERR1 MVI   ERROR,ERCOSRFQ      CAN'T OPEN SYSTEM'S RECOVERY FILE            
         GOTO1 =A(ERRPRT),(RC)                                                  
         ABEND 782,DUMP                                                         
*                                                                               
OSYSOK   SR    RC,RC                                                            
OSYSNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R4                                                               
         SPACE 1                                                                
***********************************************************************         
* CLOSE DATA MANAGER SYSTEM FILES                                     *         
***********************************************************************         
         SPACE 1                                                                
CLOSESYS NTR1                                                                   
         L     R4,ADXBLOCK         R4=A(EXTRACT CONTROL DATA BLOCK)             
         USING DXBLOCKD,R4                                                      
*                                                                               
         CLI   DXSENUM,CONTROLQ                                                 
         BE    CSYSOK              EXIT IF EXTRACT SYSTEM IS CONTROL            
*                                  SET UTL SENUM                                
*&&US                                                                           
         L     RE,=V(UTL)                                                       
         MVC   4(1,RE),DXSENUM                                                  
*                                  CLOSE SYSTEM DISK FILES                      
         GOTO1 VDMOD000,DMCB,A(DMODCSYS),(DXSENUM,AIOL)                         
*&&                                                                             
*&&UK                                                                           
         L     RF,RCVADTF                                                       
         XC    DMCB(6*4),DMCB                                                   
         GOTO1 VDADDS,DMCB,A(DACLOSE),,,(RF)                                    
*&&                                                                             
*                                                                               
CSYSOK   SR    RC,RC                                                            
CSYSNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* COMPARE RECOVERY HEADER TIME AND TIME IN FULL WORD HHMMSSHH FORMAT  *         
* R1 = RECOVERY HEADER TIME                                           *         
* RF = COMPARE TIME                                                   *         
* RETURN COMPARE STATE IN .CC.                                        *         
***********************************************************************         
         SPACE 1                                                                
COMPTIME EQU   *                                                                
         LTR   R1,R1            TEST IF CON FILE FORMAT                         
         BP    CTIM010                                                          
         SLL   R1,2             GET RID OF TOP 2 BITS                           
         SRL   R1,10                                                            
         B     CTIM020                                                          
CTIM010  EQU   *                                                                
         SLL   R1,2             GET RID OF TOP TWO BITS                         
         SRL   R1,6                                                             
CTIM020  EQU   *                                                                
         SLL   R1,8             SHIFT TO COMMON HMMSS00 FORMAT                  
         CR    R1,RF                                                            
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
* FILSLICE - CHECK IF RECORD FALLS INTO DEFINED TIME SLICE                      
* ON ENTRY R6 = A(RECOVERY HEADER)                                    *         
***********************************************************************         
         SPACE 1                                                                
         USING RECDS,R6                                                         
FILSLICE NTR1                                                                   
         OC    SLICEFRO,SLICEFRO                                                
         JZ    EQXIT                                                            
*                                                                               
         ICM   R1,15,RTIME                                                      
         ICM   RF,15,SLICEFRO                                                   
         BRAS  RE,COMPTIME                                                      
         JL    NEQXIT                                                           
*                                                                               
         ICM   R1,15,RTIME                                                      
         ICM   RF,15,SLICETO                                                    
         BRAS  RE,COMPTIME                                                      
         JH    NEQXIT                                                           
*                                                                               
         J     EQXIT                                                            
         LTORG                                                                  
         DROP  R6                                                               
*                                                                               
***********************************************************************         
* FILTIME - FILTER ON FROM-TO TIME                                    *         
* ON ENTRY R6 = A(RECOVERY HEADER)                                    *         
***********************************************************************         
         SPACE 1                                                                
         USING RECDS,R6                                                         
FILTIME  NTR1                                                                   
         CLI   STARFLAG,C'Y'                                                    
         BE    FILT100                                                          
         OC    FFTIME,FFTIME                                                    
         BZ    FILT100                                                          
         ICM   R1,15,RTIME                                                      
         ICM   RF,15,FFTIME                                                     
         BRAS  RE,COMPTIME                                                      
         BNL   FILT100                                                          
         CLC   FFTIME,TIMEND                                                    
         BL    FILTSKIP                                                         
         CLC   RDATE,DATENB                                                     
         BNE   FILTSKIP                                                         
*                                                                               
FILT100  EQU   *                                                                
         CLI   CLOSFLAG,C'Y'                                                    
         BE    FILTCONT                                                         
         OC    FTTIME,FTTIME                                                    
         BZ    FILTCONT                                                         
         ICM   R1,15,RTIME                                                      
         ICM   RF,15,FTTIME                                                     
         BRAS  RE,COMPTIME                                                      
         BNL   FILTEND                                                          
         CLC   FTTIME,TIMEND                                                    
         BL    FILTCONT                                                         
         CLC   RDATE,DATENB                                                     
         BNE   FILTCONT                                                         
         B     FILTEND                                                          
*                                                                               
FILTCONT EQU   *                                                                
         SR    RF,RF                                                            
         CR    RF,RF                                                            
         XIT1                                                                   
*                                                                               
FILTEND  EQU   *                                                                
         SR    RF,RF                                                            
         LA    RE,1                                                             
         CR    RF,RE                                                            
         XIT1                                                                   
*                                                                               
FILTSKIP EQU   *                                                                
         SR    RF,RF                                                            
         LA    RE,1                                                             
         CR    RE,RF                                                            
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
         DROP  RB,RA                                                            
         EJECT                                                                  
***********************************************************************         
* EXTRACT EXTENDED VERMONT DATA AND SET TRAWL END                     *         
***********************************************************************         
         SPACE 1                                                                
         DS    0D                                                               
GETEXVMT NMOD1 0,**GEVM**                                                       
         LR    RC,R1                                                            
*                                                                               
         L     R4,ADXBLOCK         R4=A(EXTRACT CONTROL DATA BLOCK)             
         USING DXBLOCKD,R4                                                      
*                                                                               
         L     R2,RCVADTF                                                       
         USING DTFPHD,R2                                                        
         XC    WORK(12),WORK       GET DNEXT(/USED/ALLOCATED) IN WORK           
         GOTO1 VDATAMGR,DMCB,DMKEY,DMRFIL,(3,WORK)                              
         OC    WORK+4(4),WORK+4    IF ANY SPACE USED,                           
         JNZ   GEVM010             GET BLOCK AT DNEXT (NOW IN WORK(4))          
         XC    DXTDA,DXTDA         ELSE SET END ADDR TO START OF FILE           
         J     GEVM050             NOTHING IN FILE YET SO NO VERMONTS           
*                                                                               
GEVM010  GOTO1 VDADDS,DMCB,A(RDID),ARECBUFF,0,(R2),WORK,0                       
         OC    8(2,R1),8(R1)                                                    
         JNZ   *+2                 BLOCK NOT FOUND (MAY NEED RETRY!!)           
         OC    10(2,R1),10(R1)     TEST LENGTH                                  
         JZ    *+2                 IF ZERO, BLOCK NO GOOD                       
*                                                                               
         L     R2,ARECBUFF         R2 NOW POINTS TO LATEST BLOCK                
         USING VRCVHDR,R2                                                       
         CLC   VRCV1STR,=Y(VRCX1STQ) MAKE SURE REALLY EXTENDED VERMONTS         
         JNE   *+2                 DIE IF NOT                                   
         MVC   DXTDA,VRCVDA        DXTDA NOW DA LAST REC IN LAST BLOCK          
*                                                                               
*        MERGE VERMONT DATA INTO DXRTTAB ALREADY CONTAINING XLOG DATA           
*        IF SINS MATCH, AN ACTIVE SIN WAS ACTIVE AT END OF LAST TRAWL.          
*        DXRTLDA = LOW DISK ADDRESS FROM XLOG                                   
*        DXRTHDA = LOW DISK ADDRESS FROM VERMONT (TO GO INTO NEXT XLOG)         
*                                                                               
GEVM020  LA    R0,VRCVMAXQ         MAXIMUM VERMONT ENTRIES                      
         LA    RF,VRCXNTRY         FIRST EXTENDED VERMONT ENTRY                 
         XR    R1,R1               NUMBER OF ASCTIVE VERMONT ENTRIES            
         USING VRCXNTRY,RF                                                      
GEVM022  OC    VRCVSIN#,VRCVSIN#   VERMONT ENTRY ACTIVE                         
         BZ    GEVM028             NO, NEXT                                     
         LA    R1,1(,R1)           COUNT IT                                     
         LA    RE,DXRTTAB          SEE IF ITS SIN IS IN DXRTTAB ALREADY         
         USING DXRTTAB,RE                                                       
GEVM024  OC    DXRTLSN,DXRTLSN     EMPTY DXRTTAB ENTRY (END OF XLOGS)           
         BZ    GEVM026             YES, USE IT                                  
         CLC   DXRTLSN,VRCVSIN#    SAME SIN?                                    
         BE    GEVM026             YES, USE IT                                  
         LA    RE,DXRTTLN(,RE)     NEXT DXRTTAB ENTRY                           
         B     GEVM024                                                          
GEVM026  MVC   DXRTLSN,VRCVSIN#    COPY SIN                                     
         MVC   DXRTLSI,VRCVFID#    COPY TASK ID                                 
         MVC   DXRTHDA,VRCXA1ST    COPY FIRST RECOVERY DISK ADDRESS             
GEVM028  LA    RF,VRCXLNQ(,RF)     NEXT EXTENDED VERMONT ENTRY                  
         BCT   R0,GEVM022                                                       
         DROP  R2,RE,RF                                                         
*                                                                               
*        IF CLOSE FLAG IS SET, ALL VERMONTS SHOULD BE EMPTY. IF THEY            
*        AREN'T, THERE IS EITHER AN UPDATIVE TASK THAT IS STILL ACTIVE          
*        OR A TASK HAS ENDED WITHOUT CLEARING ITS VERMONT ENTRY.                
*        NEITHER IS A ACCEPTABLE SO ISSUE A WARNING.                            
*                                                                               
         CLI   CLOSFLAG,C'Y'       SKIP IF NOT CLOSING                          
         BNE   GEVM050                                                          
         LTR   R1,R1               AND IF NO ACTIVE VERMONTS.                   
         BZ    GEVM050                                                          
         MVI   ERROR,ERVMACQ       ERROR MESSAGE AND AUTONOTE                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         LARL  R3,AUTOACVM                                                      
         WTO   TEXT=(R3),MCSFLAG=HRDCPY                                         
*                                                                               
*        XLOG RECORDS FOR EXTENDED VERMONT METHOD CONTAIN THE SIN               
*        AND LOWEST DISK ADDRESS OF EACH ACTIVE TASK AT LAST TRAWL END.         
*        SET EXTVFDA TO LOWEST OF THEM THAT IS NOT STILL ACTIVE.                
*        NOTE THAT OFFLINE CAN HAVE THE SAME SIN FOR MULTIPLE COMMITS.          
*        IF THE START ADDRESS IN THE XLOG IS DIFFERENT FROM THAT IN THE         
*        VERMONT, THEY ARE DIFFERENT. THE XLOG TASK CAN BE EXTRACTED.           
*                                                                               
GEVM050  MVC   EXTVFDA,DXFDA       PRESET WHERE LAST TRAWL ENDED                
         OC    EXTVFDA,EXTVFDA     IF ALREADY AT THE START, EXIT                
         BZ    GEVMOK                                                           
         LA    RF,DXRTTAB          RESET START TO LOWEST DISK ADDRESS           
         USING DXRTTAB,RF          FROM XLOG RECORD SAVED IN DXRTTAB            
         LA    R0,VRCVMAXQ         (CANNOT BE MORE ENTRIES THAN THIS)           
GEVM052  OC    DXRTLSN,DXRTLSN     NO MORE ENTRIES IF SIN ZERO                  
         BZ    GEVM058                                                          
         OC    DXRTHDA,DXRTHDA     IS SIN STILL AN ACTIVE TASK                  
         BZ    GEVM054                                                          
         CLC   DXRTLDA,DXRTHDA     YES, IF IT HAS SAME START ADDRESS...         
         BE    GEVM056             ...IT'S THE SAME TASK, SO IGNORE IT          
GEVM054  OC    DXRTLDA,DXRTLDA     IGNORE DISK ADDRESS IF ZERO                  
         BZ    GEVM056                                                          
         CLC   DXRTLDA,EXTVFDA     IS IT LESS THAN CURRENT START?               
         BNL   GEVM056                                                          
         MVC   EXTVFDA,DXRTLDA     YES, MAKE IT NEW CURRENT START               
GEVM056  LA    RF,DXRTTLN(,RF)                                                  
         BCT   R0,GEVM052                                                       
         DROP  RF                                                               
*                                                                               
*        VERMONT START RECORD NUMBER MUST BE DECREMENTED BY ONE BECAUSE         
*        DMRSEQ READS THE *NEXT* RECORD.                                        
*        BTW, REC 0 IS FINE FOR DMRSEQ SO NO NEED TO BACK UP TO THE             
*        PREVIOUS BLOCK OR TRACK. IT'LL JUST READ RECORD 1                      
*                                                                               
GEVM058  CLC   EXTVFDA,DXFDA       DID WE CHANGE EXTVFDA?                       
         BE    GEVMOK              NO, XLOGS EMPTY OR ALL STILL ACTIVE          
         LLC   R0,EXTVFDA+3        PICK UP RECORD NUMBER FROM DA                
         BCTR  R0,0                DECREMENT IT (16 OR 20 BIT)                  
         STC   R0,EXTVFDA+3        OK FOR DMRSEQ EVEN IF ZERO                   
*                                                                               
GEVMOK   SR    RC,RC                                                            
GEVMNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R4                                                               
         SPACE 1                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* CALL SYSTEM EXTRACT MODULE FOR EACH SYSTEM ENTRY IN SYSTABD         *         
***********************************************************************         
         SPACE 1                                                                
         DS    0D                                                               
CALLSEX  NMOD1 0,**CSEX**                                                       
         LR    RC,R1                                                            
         CLI   XTRFLG,C'Y'         SUB SYS EXTRACT?                             
         BNE   CSEXOK              NO - EXIT                                    
*                                                                               
         L     R4,ADXBLOCK         GET ADDRESS SYSTEM CONTROL BLOCK             
         USING DXBLOCKD,R4                                                      
         L     R5,DXSTSPTR         PROCESS EACH ENTRY IN SYSTEM TABLE           
*                                                                               
         L     R6,DXARECB          R6=A(RECOVERY RECORD BUFFER)                 
         USING RECDS,R6                                                         
*                                                                               
         XC    DXRGIN,DXRGIN                                                    
         TM    RTIME,X'40'         ANY EXT REC?                                 
         BZ    CSEX070             NO-SKIP OVER                                 
*                                                                               
         LR    RE,R6                                                            
         LH    R1,RECLN                                                         
         BCTR  R1,0                                                             
         AR    RE,R1               RE=A(LAST BYTE)--EXT REC LENGTH              
         LLC   R1,0(RE)            R1=EXT REC LENGTH                            
         BCTR  R1,0                                                             
         SR    RE,R1               RE=A(EXT REC)                                
         USING RECVEXTD,RE                                                      
         TM    RGESTAT,RGESRCNH    TEST FROM A JOB WITH HARP=N                  
         BO    CSEXOK              YES, IGNORE THIS RECORD                      
         MVC   DXRGIN,RGIN                                                      
         DROP  RE                                                               
*                                                                               
         NI    RTIME,X'FF'-X'40'   CLEAR NEW RECOVERY EXTENSION BIT             
         DROP  R6                                                               
*                                                                               
*                                  SAVE ACTION CODE IN CASE                     
*                                  SUB SYSTEM CHANGES IT                        
CSEX070  MVC   ACTSAVE,DXACTION    (E.G. RESTORE/DELETE)                        
*                                                                               
CSEXLOOP C     R5,DXSTEPTR         TEST END OF TABLE                            
         BE    CSEXOK                                                           
         ST    R5,DXSTPTR          SAVE SYSTEM TABLE ENTRY POINTER              
*                                  CALL EXTRACT SYSTEM MODULE                   
         USING SXDTABD,R5                                                       
         CLI   CONTFLG,C'N'                                                     
         BNE   *+12                                                             
         TM    SXDTFLG2,SXDTFUEQ   TEST UPDATE ERROR OCCURRED                   
         BNZ   CSEX100                                                          
*                                                                               
         BRAS  RE,RSTDXBLK                                                      
*                                                                               
         L     RF,SXDTASEX         A(A(SUB-SYSTEM EXTRACT PROGRAM))             
         ICM   RF,15,0(RF)                                                      
         BZ    CSEX100                                                          
         MVI   DXRETCDE,0                                                       
         MVI   DXSEGAFT,C'N'                                                    
         GOTO1 (RF),ADXBLOCK                                                    
         BRAS  RE,SETMAXRC                                                      
         BNE   CSEXERR1            EXIT IF ERROR RETURN                         
*                                  RESTORE ACTION CODE IN CASE                  
*                                  SUB SYSTEM CHANGES IT                        
CSEX100  MVC   DXACTION,ACTSAVE    (E.G. RESTORE/DELETE)                        
*                                                                               
         LA    R5,SXDTABL(R5)      GET NEXT SYSTEM TABLE ENTRY                  
         B     CSEXLOOP                                                         
*                                                                               
CSEXERR1 MVI   ERROR,ERSUBSYQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     CSEXNO                                                           
*                                                                               
CSEXOK   SR    RC,RC                                                            
CSEXNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R4,R5                                                            
         SPACE 1                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*RESET DXBLOCKD VALUES BASE ON JCL/XAGY VALUES                        *         
*INPUT: R4 = A(DXBLOCK)                                               *         
*       R5 = A(SXDTAB)                                                *         
***********************************************************************         
RSTDXBLK NTR1  ,                                                                
         USING DXBLOCKD,R4                                                      
         USING SXDTABD,R5                                                       
*                                  RESET ALL DATE RANGE VALUES                  
         XC    DXFDATEP,DXFDATEP                                                
         XC    DXTDATEP,DXTDATEP                                                
         XC    DXFDATEC,DXFDATEC                                                
         XC    DXTDATEC,DXTDATEC                                                
*                                                                               
         OC    XFDATEP,XFDATEP     ANY JCL DATE RANGE?                          
         BNZ   RDK10               YES - USE IT                                 
         OC    SXDFDATP,SXDFDATP   ANY XAGY DATE RANGE/QUARTERS?                
         BNZ   RDK20               YES - USE IT                                 
         B     RDKX                                                             
*                                                                               
RDK10    MVC   DXFDATEP,XFDATEP    JCL DATE RANGE                               
         MVC   DXTDATEP,XTDATEP                                                 
         MVC   DXFDATEC,XFDATEC                                                 
         MVC   DXTDATEC,XTDATEC                                                 
         B     RDKX                                                             
*                                                                               
RDK20    MVC   DXFDATEP,SXDFDATP   XAGY DATE RANGE                              
         MVC   DXTDATEP,SXDTDATP                                                
         MVC   DXFDATEC,SXDFDATC                                                
         MVC   DXTDATEC,SXDTDATC                                                
         B     RDKX                                                             
*                                                                               
RDKX     XIT1                                                                   
         DROP  R4,R5                                                            
         SPACE 1                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* PROCESS EXTRACT TRANS MODE - READ INPUT FILE DCB INFILE             *         
* INFILE CONTAINS RECORDS PREVIOUSLY EXTRATCTED IN "EXTRACT"  OR "SQL"*         
* FLAT FILE FORMAT                                                    *         
* RECORD TRANSFERRED TO DXUDB PROCESS FOR DATABASE UPDATE             *         
***********************************************************************         
         SPACE 1                                                                
         DS    0D                                                               
PROCTRAN NMOD1 0,**PTRA**                                                       
         LR    RC,R1                                                            
         MVI   MSGNUM,MSPTRANQ                                                  
         GOTO1 =A(MSGPRT),(RC)                                                  
*                                                                               
         L     R2,=A(INFILE)                                                    
         OPEN  ((R2),(INPUT))                                                   
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R5,ADXBLOCK         R4=A(EXTRACT CONTROL DATA BLOCK)             
         USING DXBLOCKD,R5                                                      
         L     R4,DXSTPTR          GET SYSTEM TABLE ENTRY POINTER               
         USING SXDTABD,R4                                                       
         L     R3,DXASQLB          R3=A(RECORD)                                 
*                                                                               
PTRA010  EQU   *                                                                
         L     R2,=A(INFILE)                                                    
         GET   (R2),(R3)                                                        
*                                   CHECK FROM/TO DATE FILTER                   
         GOTO1 =A(UPDTHDB),(RC)                                                 
         BNE   PTRANO                                                           
         CLI   CONTFLG,C'N'                                                     
         BNE   *+12                                                             
         TM    SXDTFLG2,SXDTFUEQ   TEST UPDATE ERROR OCCURRED                   
         BNZ   PTRAOK                                                           
         B     PTRA010             GET NEXT INFILE RECORD                       
*                                                                               
PTRAEIN  EQU   *                   END OF INFILE                                
         B     PTRAOK                                                           
*                                                                               
PTRANO   EQU   *                   EXIT ERROR                                   
         L     R2,=A(RCVTAPE)                                                   
         CLOSE ((R2))                                                           
         LTR   RC,RC                                                            
         XIT1                                                                   
*                                                                               
PTRAOK   EQU   *                   EXIT OK                                      
         L     R2,=A(RCVTAPE)                                                   
         CLOSE ((R2))                                                           
         MVI   MSGNUM,MSPTRAXQ                                                  
         GOTO1 =A(MSGPRT),(RC)                                                  
         SR    RC,RC                                                            
         LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R4,R5                                                            
         LTORG                                                                  
                                                                                
***********************************************************************         
* CALL EXTRACT AFTER EXTRACT FILE CLOSE COMPLETED                               
***********************************************************************         
         DS    0D                                                               
CLOSEDXF NMOD1 0,**CDXF**                                                       
         LR    RC,R1                                                            
*                                                                               
         L     R3,ADXBLOCK         GET ADDRESS SYSTEM CONTROL BLOCK             
         USING DXBLOCKD,R3                                                      
         ICM   R4,15,DXSTPTR       CURRENT SEXTAB ENTRY                         
         BZ    CDXFNO              EXIT: NO EXTRACT ENTRY                       
         USING SXDTABD,R4                                                       
         OC    SXDTXDCB,SXDTXDCB   TEST EXTRACT FILE OPENED                     
         BZ    CDXFOK              EXIT OK: NO EXTRACT FILE OPENED              
*                                                                               
         MVI   MSGNUM,MSCLOSDQ     PRINT CLOSED MODE MESSAGE                    
         GOTO1 =A(MSGPRT),(RC)                                                  
*                                                                               
         MVC   MODESAVE,DXMODE     SAVE EXTRACT MODE                            
         MVI   DXMODE,DXCLOXDQ     SET EXTRACT FILE CLOSED MODE                 
         L     RF,SXDTASEX         A(A(SUB-SYSTEM EXTRACT PROGRAM))             
         ICM   RF,15,0(RF)                                                      
         BZ    CDXFNO              EXIT: SO SUBSYSTEM EXTRACT ADDRESS           
         MVI   DXRETCDE,0          RESET RETURN CODE                            
         MVI   DXSEGAFT,C'N'                                                    
         GOTO1 (RF),ADXBLOCK       CALL SUBSYSTEM EXTRACT                       
         BRAS  RE,SETMAXRC         RESOLVE RETURN CODE                          
         BNE   CDXFNO              EXIT: IF ERROR RETURN                        
         MVC   DXMODE,MODESAVE     RESTORE MODE                                 
*                                                                               
CDXFOK   SR    RC,RC               EXIT EQUAL                                   
CDXFNO   LTR   RC,RC               ERROR EXIT                                   
         XIT1                                                                   
         DROP  R3,R4                                                            
         LTORG                                                                  
                                                                                
***********************************************************************         
* PROCESS EXTRACT UPDATE END MODE                                     *         
***********************************************************************         
         DS    0D                                                               
PROCEND  NMOD1 0,**PEND**                                                       
         LR    RC,R1                                                            
         MVI   MSGNUM,MSPENDQ                                                   
         GOTO1 =A(MSGPRT),(RC)                                                  
         L     R4,ADXBLOCK         GET ADDRESS SYSTEM CONTROL BLOCK             
         USING DXBLOCKD,R4                                                      
*                                                                               
         MVI   DXMODE,DXENDQ       SET UPDATE END MODE                          
         GOTO1 =A(CALLSEX),(RC)    CALL SYSTEM EXTRACT MODULE                   
         BNE   PENDNO                                                           
*                                                                               
         MVI   MSGNUM,MSPENDXQ                                                  
         GOTO1 =A(MSGPRT),(RC)                                                  
         B     PENDOK                                                           
*                                                                               
PENDNO   EQU   *                   EXIT ERROR                                   
         LTR   RC,RC                                                            
         XIT1                                                                   
*                                                                               
PENDOK   EQU   *                   EXIT OK                                      
         SR    RC,RC                                                            
         LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R4                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* OPEN EXTRACT FILES FOR EACH AGENCY IN SYSTEM EXTRACT DRIVER TABLE   *         
* R4=A(SXDTTAB)                                                       *         
***********************************************************************         
         SPACE 1                                                                
         USING SXDTABD,R4                                                       
         DS    0D                                                               
OPENEXFL NMOD1 0,**OPNX**                                                       
         LR    RC,R1                                                            
*                                                                               
         BRAS  RE,BXDSNAME         BUILD EXTRACT FILE DATA SET NAME             
         BNE   OXFLNO              EXIT IF ERROR                                
*                                  DYNAMICALLY ALLOCATE MVS FILE                
*                                    WITH UNALLOCATE ON CLOSE                   
         MVC   SXDTXDSN,EXDSNAME   SAVE DSN                                     
         MVC   APALLOC,SXDTPSZ                                                  
         MVC   ASALLOC,SXDTSSZ                                                  
         GOTO1 =A(ALLOCEX),(RC)    DYANMICALLY ALLOCATE MVS DATA SET            
* GOTO1 VDYNALOC,DMCB,(X'10',SXDTXDDN),(X'81',APALLOC),(X'80',SXDTXDSN)         
*                                                                               
         MVC   P(20),=CL20'ALLOCATE DSN:'                                       
         MVC   P+20(L'SXDTXDSN),SXDTXDSN                                        
         GOTO1 VPRINTER                                                         
*                                                                               
         ICM   R5,15,SXDTXDCB      OPEN EXTRACT FILE                            
         OPEN  ((R5),OUTPUT)                                                    
*                                                                               
         L     RE,ALDSNNUM         INCR # OF ALLOCATED DSN                      
         AHI   RE,1                                                             
         ST    RE,ALDSNNUM                                                      
*                                                                               
         CLI   MODE,DXPQRQ         TEST IF EXTRACT MODE = PQ REPORT             
         BNE   OXFL010                                                          
         CLI   DIETFLAG,C'Y'       TEST IF DIET SQL FLAG = Y                    
         BE    OXFLOK                                                           
*                                                                               
OXFL010  BRAS  RE,PROCHDR          PROCESS EXTRACT HEADER                       
         BNE   OXFLNO                EXIT IF ERROR                              
         B     OXFLOK                EXIT OK                                    
*                                                                               
OXFLOK   SR    RC,RC               EXIT OK                                      
OXFLNO   LTR   RC,RC               EXIT ERROR                                   
         XIT1                                                                   
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* BUILD EXTRACT DATA SET NAME                                         *         
* R4 POINTS TO SYSTEM EXTRACT TABLE ENTRY                             *         
***********************************************************************         
         SPACE 1                                                                
         USING SXDTABD,R4                                                       
BXDSNAME NTR1  ,                                                                
         CLI   WRITE,C'Y'                                                       
         BNE   BDSNOK                                                           
         MVC   EXDSNAME,SPACES                                                  
         LA    R3,EXDSNAME                                                      
*&&UK*&& MVC   0(8,R3),=CL8'ESS.XTR.'                                           
*&&US*&& MVC   0(8,R3),=CL8'DDS.XTR.'                                           
         OC    ODSNAME,ODSNAME                                                  
         BZ    *+10                                                             
         MVC   0(8,R3),ODSNAME                                                  
         LA    R3,8(R3)                                                         
         CLI   SXDTAGY,C'A'                                                     
         BL    BDSN020                                                          
         CLI   SXDTAGY,C'Z'                                                     
         BH    BDSN020                                                          
         CLI   SXDTAGY+1,C'A'                                                   
         BL    BDSN010                                                          
         CLI   SXDTAGY+1,C'Z'                                                   
         BH    BDSN010                                                          
         B     BDSN030                                                          
BDSN010  CLI   SXDTAGY+1,C'0'                                                   
         BL    BDSN020                                                          
         CLI   SXDTAGY+1,C'9'                                                   
         BH    BDSN020                                                          
         B     BDSN030                                                          
BDSN020  MVI   0(R3),C'H'                                                       
         LA    R3,1(R3)                                                         
         GOTO1 VHEXOUT,DMCB,SXDTAGY,(R3),2,=C'TOG'                              
         LA    R3,4(R3)                                                         
         B     BDSN040                                                          
BDSN030  MVC   0(2,R3),SXDTAGY                                                  
         LA    R3,2(R3)                                                         
BDSN040  CLI   DSNFLAG,C'S'                                                     
         BNE   BDSNLONG                                                         
*                                                                               
BDSNSHRT MVI   0(R3),C'.'                                                       
         LA    R3,1(R3)                                                         
         MVC   0(3,R3),SXDTTYP                                                  
         LA    R3,3(R3)                                                         
         B     BDSNOK                                                           
*                                                                               
BDSNLONG MVC   0(1,R3),SXDTSCOD                                                 
         MVC   1(1,R3),SXDTSUBC                                                 
         MVI   2(R3),C'.'                                                       
         SR    RF,RF                                                            
         ICM   RF,3,SXDTGNUM                                                    
         EDIT  (RF),(6,3(R3)),ZERO=NOBLANK,FILL=0                               
         MVI   3(R3),C'G'                                                       
         MVI   9(R3),C'.'                                                       
         MVC   10(3,R3),SXDTTYP                                                 
         MVI   13(R3),C'.'                                                      
         MVI   14(R3),C'D'                                                      
         MVC   15(6,R3),DATEN+2                                                 
         MVI   21(R3),C'.'                                                      
         MVI   22(R3),C'T'                                                      
         MVC   23(6,R3),TIMEN                                                   
*                                                                               
         B     BDSNOK                                                           
*                                                                               
BDSNOK   SR    RC,RC                                                            
BDSNNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* PROCESS EXTRACT HEADER FOR THIS RUN                                 *         
* R4 POINTS TO SYSTEM EXTRACT TABLE ENTRY                             *         
***********************************************************************         
         SPACE 1                                                                
         USING SXDTABD,R4                                                       
PROCHDR  NTR1  ,                                                                
         CLI   SXDTHDR,0                                                        
         BE    PHDROK                                                           
*&&DO                                                                           
         CLI   SXDTPLFM,0          CAREFUL NOT TO CRAP ON FIRST                 
         BE    *+12                EXTRACT RECORD IN DXARECB                    
         L     R2,AXREC                                                         
         B     *+8                                                              
         L     R2,ASQLBUFF                                                      
*&&                                                                             
         L     R2,AHDRBUFF                                                      
*                                                                               
         USING DXHDRD,R2                                                        
         MVC   DXHDRLEN(2),=AL2(DXHDRDL)                                        
         MVC   DXHDRTYP,DXHDRDQ                                                 
         MVC   DXHDRRTY-1(1),DELIM                                              
*                                                                               
         MVI   DXHDRRTY,C'L'                                                    
         CLI   MODE,DXLOADQ                                                     
         BE    PHDR004                                                          
         CLI   MODEPQL,C'Y'        MODE=PQ W/ LOAD OPTION?                      
         BE    PHDR004                                                          
         MVI   DXHDRRTY,C'U'                                                    
*                                                                               
PHDR004  MVC   DXHDRCDT-1(1),DELIM                                              
         MVC   DXHDRCDT,DATEN                                                   
         MVC   DXHDRCTI-1(1),DELIM                                              
         MVC   DXHDRCTI,TIMEN                                                   
*                                                                               
         MVC   DXHDRLEV-1(1),DELIM                                              
         EDIT  SXDTLEV,(3,DXHDRLEV),ZERO=NOBLANK,FILL=0                         
         MVC   DXHDRVER-1(1),DELIM                                              
         EDIT  SXDTVER,(3,DXHDRVER),ZERO=NOBLANK,FILL=0                         
         MVC   DXHDRAGA-1(1),DELIM                                              
         MVC   DXHDRAGA,SXDTAGY                                                 
         CLI   DXHDRAGA,C'*'                                                    
         BNE   *+8                                                              
         MVI   DXHDRAGA,C'@'                                                    
         MVC   DXHDRAGB-1(1),DELIM                                              
         EDIT  SXDTAGB,(3,DXHDRAGB),ZERO=NOBLANK,FILL=0                         
         MVC   DXHDRPIN-1(1),DELIM                                              
         EDIT  SXDTPIN,(5,DXHDRPIN),ZERO=NOBLANK,FILL=0                         
         MVC   DXHDRFAC-1(1),DELIM                                              
         MVC   DXHDRFAC,FACID                                                   
         OI    DXHDRFAC,X'F0'                                                   
         MVC   DXHDRSYS-1(1),DELIM                                              
         MVC   DXHDRSYS,SXDTSCOD                                                
         MVC   DXHDRSFC-1(1),DELIM                                              
         MVC   DXHDRSFC,SXDTSCHR                                                
         MVC   DXHDRSUB-1(1),DELIM                                              
         MVC   DXHDRSUB,SXDTSUBC                                                
         MVC   DXHDRRTP-1(1),DELIM                                              
         MVC   DXHDRRTP,SXDTTYP                                                 
         MVC   DXHDRFLT-1(1),DELIM                                              
         MVC   DXHDRFLT(1),SXDTFLT1                                             
         MVC   DXHDRFLT+1(1),SXDTFLT2                                           
         MVC   DXHDRFLT+2(1),SXDTFLT3                                           
         CLC   DXHDRFLT,SPACES                                                  
         BNE   *+8                                                              
         MVI   DXHDRFLT,C'*'                                                    
         MVC   DXHDRTXT-1(1),DELIM                                              
         MVC   DXHDRTXT,=CL8'HEADER'                                            
*                                                                               
         MVC   DXHDRDX(1),DELIM                                                 
         MVC   DXHDRDX+1(1),DELIM                                               
*                                                                               
         CLI   BASICHDR,C'Y'                                                    
         BE    PHDR030                                                          
*                                                                               
         CLI   HOSTDB,C'Y'                                                      
         BE    PHDR030                                                          
*                                                                               
         L     R5,SXDTSLSA                                                      
         C     R5,SXDTSLEA                                                      
         BE    PHDR030                                                          
         LA    R3,DXHDRSL                                                       
         USING SXSLLSTD,R5                                                      
         USING DXHDRSL,R3                                                       
*                                                                               
PHDRSLL  MVC   DXHDREID-1(1),DELIM                                              
         MVC   DXHDREID,SXSLEID                                                 
         MVC   DXHDRFNM-1(1),DELIM                                              
         SR    RF,RF                                                            
         ICM   RF,3,SXSLFNUM                                                    
         EDIT  (RF),(8,DXHDRFNM),ZERO=NOBLANK,FILL=0                            
         MVC   DXHDRFRC-1(1),DELIM                                              
         MVI   DXHDRFRC,C'E'                                                    
         MVC   DXHDRFRT-1(1),DELIM                                              
         MVC   DXHDRFRT,=CL6'000000'                                            
         LA    R0,4                                                             
         GOTO1 VTIMBER,DMCB,(X'40',(R0)),(2,SXSLFTIM),(1,DXHDRFRT)              
         CLI   0(R1),0                                                          
         BNE   PHDRNO                                                           
         MVC   DXHDRFRT+4(2),=CL2'00'                                           
         MVC   DXHDRMOD-1(1),DELIM                                              
         MVI   DXHDRMOD,C'N'                                                    
         MVC   DXHDRANM-1(1),DELIM                                              
         EDIT  SXSLANUM,(3,DXHDRANM),ZERO=NOBLANK,FILL=0                        
         LA    R6,SXSLAPAR                                                      
         USING SXSLAPAR,R6                                                      
         LA    R3,DXHDRAP                                                       
         CLI   SXSLANUM,0                                                       
         BE    PHDR020                                                          
         MVC   COUNTER,SXSLANUM                                                 
         USING DXHDRAP,R3                                                       
PHDR010  MVC   DXHDRSKY-1(1),DELIM                                              
         MVC   DXHDRSKY,SXSLSKEY                                                
         MVC   DXHDRPRG-1(1),DELIM                                              
         MVC   DXHDRPRG,SXSLPROG                                                
         MVC   DXHDRPAR-1(1),DELIM                                              
         MVC   DXHDRPAR,SXSLPARM                                                
*                                  REMOVE FIELDS AT LEVEL 1.0 AND BELOW         
*                                  INCLUDING DXHDRPRG AND DXHDRPAR              
         CLI   SXDTLEV,1           LEVEL 1                                      
         BH    PHDR012                                                          
         CLI   SXDTVER,0           VERSION 0                                    
         BH    PHDR012                                                          
         LA    RE,L'DXHDRPRG+L'DXHDRPAR+2                                       
         SR    R3,RE               SHIFT DSECT POINTER BACK                     
*                                                                               
PHDR012  MVC   DXHDRSRN-1(1),DELIM                                              
         MVC   DXHDRSRN,SXSLSNAM                                                
         MVC   DXHDRDBN-1(1),DELIM                                              
         MVC   DXHDRDBN,SXSLDBNM                                                
         MVC   DXHDRUID-1(1),DELIM                                              
         MVC   DXHDRUID,SXSLUSER                                                
         MVC   DXHDRPWD-1(1),DELIM                                              
         MVC   WORK(10),SXSLPASS                                                
         CLI   SXDTLEV,1           LEVEL 1                                      
         BH    PHDR014                                                          
         CLI   SXDTVER,0           VERSION 0                                    
         BNH   PHDR016                                                          
*                                  TEST FOR PASSWORD ENCRYPTION                 
PHDR014  CLC   SXDTEKEY,SPACES                                                  
         BE    PHDR016                                                          
         OC    SXDTEKEY,SXDTEKEY                                                
         BZ    PHDR016                                                          
         MVC   WORK(L'SXSLPASS),SXSLPASS                                        
         GOTO1 VCRYPT,DMCB,L'SXSLPASS,WORK,SXDTEKEY                             
         CLI   0(R1),0                                                          
         BNE   PHDRER1                                                          
         MVC   DXHDRPWD,WORK                                                    
         B     PHDR018                                                          
*                                                                               
PHDR016  MVC   DXHDRPWD,SXSLPASS                                                
*                                                                               
PHDR018  LA    R6,SXSLAPAL(R6)                                                  
         LA    R3,DXHDRAPL(R3)                                                  
         SR    RF,RF                                                            
         ICM   RF,1,COUNTER                                                     
         BCT   RF,*+8                                                           
         B     PHDR020                                                          
         STCM  RF,1,COUNTER                                                     
         B     PHDR010                                                          
         DROP  R6                                                               
*                                                                               
PHDR020  EQU   *                                                                
*                                                                               
PHDRSLN  EQU   *                                                                
         LR    R5,R6                                                            
         C     R5,SXDTSLEA                                                      
         BL    PHDRSLL                                                          
         MVC   0(1,R3),DELIM                                                    
         MVC   1(1,R3),DELIM                                                    
         LA    R3,2(R3)                                                         
         SR    R3,R2                                                            
         STCM  R3,3,DXHDRLEN                                                    
         DROP  R3,R5                                                            
*                                                                               
PHDR030  CLI   WRITE,C'Y'                                                       
         BNE   PHDROK                                                           
         AP    SXDTRNUM,=PL8'1'    BUMP RECORD NUMBER AND BYTE COUNT            
         SR    RF,RF                                                            
         ICM   RF,3,0(R2)                                                       
         CVD   RF,DUB                                                           
         AP    SXDTBNUM,DUB                                                     
         ICM   R6,15,SXDTXDCB                                                   
         PUT   (R6),DXHDRD                                                      
         B     PHDROK                                                           
*                                                                               
PHDRER1  EQU   *                   CRYPT ERROR                                  
         LR    R3,R1                                                            
         MVI   ERROR,ERCRYPTQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         MVC   P(40),=CL40'RETURN CODE:'                                        
         GOTO1 VHEXOUT,DMCB,(R3),P+13,4,=C'TOG'                                 
         GOTO1 VPRINTER                                                         
         B     PHDRNO                                                           
*                                                                               
PHDROK   SR    RC,RC                                                            
PHDRNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R2,R4                                                            
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* WRITE EXTRACT FILE CONTROL RECORDS                                  *         
***********************************************************************         
         SPACE 1                                                                
         DS    0D                                                               
WRTXFCT  NMOD1 0,**WXFC**                                                       
         LR    RC,R1                                                            
         MVI   MSGNUM,MSWRTXCQ                                                  
         GOTO1 =A(MSGPRT),(RC)                                                  
*                                                                               
         GOTO1 =A(ENQCTRL),(RC)    ENQUEUE CONTROL SYSTEM FOR UPDATES           
*                                                                               
WXFC002  EQU   *                                                                
         L     R4,SXDTPTR          A(ENTRY IN SYSTEM DRIVER TABLE)              
         USING SXDTABD,R4                                                       
*                                                                               
WXFC010  C     R4,SXDTNXT          EXIT AT END OF SYSTEM DRIVER TABLE           
         BE    WXFC120                                                          
*                                                                               
         CLI   POSTONLY,C'Y'                                                    
         BE    *+14                                                             
         OC    SXDTXDCB,SXDTXDCB   TEST EXTRACT FILE OPENED                     
         BZ    WXFC112                                                          
*                                                                               
         ICM   R6,15,SXDTFLSA                                                   
         BZ    WXFC100                                                          
         USING SXFLLSTD,R6                                                      
         XC    FILEGCNT,FILEGCNT                                                
         BRAS  RE,RESFNUM                                                       
*                                                                               
WXFC020  CLM   R6,15,SXDTFLEA                                                   
         BH    WXFC112                                                          
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,FILEGCNT                                                    
         LA    RF,1(RF)                                                         
         STCM  RF,3,FILEGCNT                                                    
         CLC   FILEGCNT,=Y(5000)                                                
         BL    *+12                                                             
         LA    R0,1                                                             
         B     SAFEND                                                           
*                                                                               
         MVC   DATENC,SXFLDATE                                                  
         MVC   TIMEND,SXFLTIME                                                  
         MVC   SXDTRNUM,SXFLRNUM                                                
         MVC   SXDTBNUM,SXFLBNUM                                                
         MVC   SXDTMTOT,SXFLMTOT                                                
         MVC   SXDTXDSN,SXFLXDSN                                                
*                                                                               
         LA    RF,1                                                             
         CLC   SXDTGNUM,=XL2'FFFF'                                              
         BE    *+12                                                             
         ICM   RF,3,SXDTGNUM                                                    
         LA    RF,1(RF)                                                         
         STCM  RF,3,SXDTGNUM                                                    
*                                                                               
         CLC   SXDTGNUM,SXFLGNUM                                                
         BE    *+12                                                             
         LA    R0,100                                                           
         B     SAFEND                                                           
*                                                                               
         SR    RF,RF                                                            
         L     R5,SXDTSLSA                                                      
         USING SXSLLSTD,R5                                                      
*                                                                               
WXFC030  C     R5,SXDTSLEA                                                      
         BE    WXFC100                                                          
         LA    RF,1                                                             
         CLC   SXSLFNUM,=XL2'FFFF'                                              
         BE    *+12                                                             
         ICM   RF,3,SXSLFNUM                                                    
         LA    RF,1(RF)                                                         
         STCM  RF,3,SXSLFNUM                                                    
         SR    RF,RF                                                            
         IC    RF,SXSLANUM                                                      
         MH    RF,=AL2(SXSLAPAL)                                                
         AR    R5,RF                                                            
         LA    R5,SXSLLSTL(R5)                                                  
         B     WXFC030                                                          
         DROP  R5                                                               
*                                                                               
WXFC100  EQU   *                                                                
         CLI   POSTONLY,C'Y'                                                    
         BNE   *+10                                                             
         MVC   SXDTXDSN,POSTDSN                                                 
         CLI   SENDFLAG,C'B'                                                    
         BE    WXFC110                                                          
         BRAS  RE,WRTFDR           WRITE XFILE DEFINITION RECORD                
         BNE   WXFCERR                                                          
         BRAS  RE,WRTAGY           WRITE XAGENCY RECORD                         
         BNE   WXFCERR                                                          
         BRAS  RE,WRTAFP           WRITE AGENCY XFILE PASSIVE                   
         BNE   WXFCERR                                                          
         BRAS  RE,WRTSFP           WRITE SERVER XFILE PASSIVE                   
         BNE   WXFCERR               AND UPDATE SERVER APPLICATION REC.         
         CLI   SENDFLAG,C'A'                                                    
         BNE   WXFC111                                                          
         GOTO1 =A(WRTBDE),(RC)     WRITE BDE CONTROL RECORDS                    
         B     WXFC111                                                          
*                                                                               
WXFC110  EQU   *                                                                
         GOTO1 =A(WRTBDE),(RC)     WRITE BDE CONTROL RECORDS                    
         BNE   WXFCERR                                                          
         BRAS  RE,WRTAGY           WRT XAGY REC TO UPDATE FILE GEN#             
         BNE   WXFCERR                                                          
*                                                                               
WXFC111  EQU   *                                                                
         BRAS  RE,WRTOPER          WRITE MESSAGES TO OPERATOR CONSOLE           
         OC    SXDTFLSA,SXDTFLSA                                                
         BZ    WXFC112                                                          
         ICM   R6,15,SXFLNEXT                                                   
         BNZ   WXFC020                                                          
*                                                                               
WXFC112  LA    R4,SXDTABL(R4)                                                   
         B     WXFC010                                                          
*                                                                               
WXFC120  EQU   *                                                                
         GOTO1 =A(DEQCTRL),(RC)    DEQUEUE CONTROL SYSTEM                       
         B     WXFCOK                                                           
*                                                                               
WXFCERR  EQU   *                                                                
         GOTO1 =A(DEQCTRL),(RC)    DEQUEUE CONTROL SYSTEM                       
         B     WXFCNO                                                           
*                                                                               
WXFCOK   SR    RC,RC                                                            
WXFCNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R4,R6                                                            
         EJECT                                                                  
***********************************************************************         
* RESET FILE NUMBERS IN EXTRACT SYSTEM TABLE                          *         
* R4 = A(SYSTEM EXTRACT TABLE ENTRY)                                  *         
***********************************************************************         
         SPACE 1                                                                
         USING SXDTABD,R4                                                       
RESFNUM  NTR1  ,                                                                
*                                                                               
RFNU010  CLC   SXDTGNUM,SXDTORGN                                                
         BE    RFNUOK                                                           
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,SXDTGNUM                                                    
         BCTR  RF,0                                                             
         LTR   RF,RF                                                            
         BZ    *+8                                                              
         B     RFNU012                                                          
         OC    SXDTORGN,SXDTORGN                                                
         BZ    RFNU012                                                          
         ICM   RF,3,=XL2'FFFF'                                                  
*                                                                               
RFNU012  STCM  RF,3,SXDTGNUM                                                    
         L     R5,SXDTSLSA                                                      
         USING SXSLLSTD,R5                                                      
*                                                                               
RFNU020  C     R5,SXDTSLEA                                                      
         BE    RFNU010                                                          
         SR    RF,RF                                                            
         ICM   RF,3,SXSLFNUM                                                    
         BCTR  RF,0                                                             
         LTR   RF,RF                                                            
         BZ    *+8                                                              
         B     RFNU022                                                          
         OC    SXDTORGN,SXDTORGN                                                
         BZ    RFNU022                                                          
         ICM   RF,3,=XL2'FFFF'                                                  
*                                                                               
RFNU022  STCM  RF,3,SXSLFNUM                                                    
         SR    RF,RF                                                            
         IC    RF,SXSLANUM                                                      
         MH    RF,=AL2(SXSLAPAL)                                                
         AR    R5,RF                                                            
         LA    R5,SXSLLSTL(R5)                                                  
         B     RFNU020                                                          
         DROP  R5                                                               
*                                                                               
RFNUOK   SR    RC,RC                                                            
RFNUNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* WRITE XFILE DEFINITION RECORD FOR EXTRACT FILE                      *         
* R4 = A(SYSTEM EXTRACT TABLE ENTRY)                                  *         
***********************************************************************         
         SPACE 1                                                                
         USING SXDTABD,R4                                                       
WRTFDR   NTR1  ,                                                                
*                                                                               
         L     RE,=V(UTL)          SWITCH TO CONTROL SYSTEM                     
         MVI   4(RE),CONTROLQ                                                   
*                                                                               
WFDR010  LA    R2,IOKEY                                                         
         USING GXTRD,R2                                                         
         XC    GXKEY,GXKEY        BUILD FILE RECORD KEY                         
         MVI   GXKREC,GXFKRECQ                                                  
         MVC   GXFKDAT,DATENC                                                   
         XC    GXFKDAT,=XL2'FFFF'                                               
         MVC   GXFKTIM,TIMEND                                                   
         XC    GXFKTIM,=XL4'FFFFFFFF'                                           
         MVC   GXFKAGY,SXDTAGY                                                  
         MVC   GXFKSYS,SXDTSYS                                                  
         MVC   GXFKSUB,SXDTSUB                                                  
         L     R2,ARECBUFF                                                      
*                                  READ FOR UPDATE/DELETES WITH FLUSH           
         GOTO1 VDATAMGR,DMCB,(X'AC',DMREAD),GENDIR,IOKEY,(R2),DMWORK            
         CLI   8(R1),X'10'         CHECK RECORD NOT FOUND                       
         BE    *+12                                                             
         LA    R0,2                                                             
         B     SAFEND                                                           
*                                                                               
WFDRDATA EQU   *                   BUILD RECORD DATA                            
         MVC   GXKEY,IOKEY                                                      
         XC    GXFSTAT(GXFIRST-GXKEYL),GXFSTAT                                  
         MVC   GXFLEN,=AL2(GXFIRST)                                             
         OI    GXFCTL,GXFTCMP      SET DATE/TIME COMPLEMENTED                   
*                                  BUILD FILE DEFINITION ELEMENT                
         XC    ELEMENT,ELEMENT                                                  
         LA    R3,ELEMENT                                                       
         USING GXFDEL,R3                                                        
         MVI   GXFDEL,GXFDELQ                                                   
         MVI   GXFDELL,GXFDELLQ                                                 
         MVC   GXFDDAC,DATENC                                                   
         MVC   GXFDTIC,TIMEND                                                   
         MVC   GXFDTYP,SXDTTYP                                                  
         MVI   GXFDMOD,C'L'                                                     
         CLI   MODE,DXUPDTQ                                                     
         BNE   *+8                                                              
         MVI   GXFDMOD,C'U'                                                     
         CLI   MODE,DXPQRQ                                                      
         BNE   *+8                                                              
         MVI   GXFDMOD,C'P'                                                     
         MVC   GXFDRNM,SXDTRNUM                                                 
         MVC   GXFDBNM,SXDTBNUM                                                 
         MVC   GXFDMTO,SXDTMTOT                                                 
         MVC   GXFDAGY,SXDTAGY                                                  
         MVC   GXFDSYS,SXDTSYS                                                  
         MVC   GXFDSEN,SXDTSEN                                                  
         MVC   GXFDSUB,SXDTSUB                                                  
         MVC   GXFDDSN,SXDTXDSN                                                 
         CLI   STARFLAG,C'Y'                                                    
         BNE   *+8                                                              
         OI    GXFDFFL,X'01'                                                    
         CLI   CLOSFLAG,C'N'                                                    
         BE    *+8                                                              
         OI    GXFDTFL,X'01'                                                    
         L     RE,ADXBLOCK                                                      
         USING DXBLOCKD,RE                                                      
         MVC   GXFDFTM,DXFTIME                                                  
         MVC   GXFDTTM,DXTTIME                                                  
         CLC   DXFDA,DXTDA                                                      
         BH    *+14                                                             
         MVC   GXFDFDA,DXFDA                                                    
         B     *+10                                                             
         MVC   GXFDFDA,DXTDA                                                    
         MVC   GXFDTDA,DXTDA                                                    
         DROP  RE                                                               
         MVC   GXFDFLG1,SXDTFLG1                                                
*                                                                               
         GOTO1 VHELLO,DMCB,(C'P',GENFIL),(R2),ELEMENT,0                         
         CLI   12(R1),0                                                         
         BE    *+12                                                             
         LA    R0,3                                                             
         B     SAFEND                                                           
*                                  BUILD FILE GENERATION NUMBER ELEMENT         
         XC    ELEMENT,ELEMENT                                                  
         LA    R3,ELEMENT                                                       
         USING GXGNEL,R3                                                        
         MVI   GXGNEL,GXGNELQ                                                   
         MVI   GXGNELL,GXGNELLQ                                                 
         MVC   GXGNNUM,SXDTGNUM                                                 
         GOTO1 VHELLO,DMCB,(C'P',GENFIL),(R2),ELEMENT,0                         
         CLI   12(R1),0                                                         
         BE    *+12                                                             
         LA    R0,4                                                             
         B     SAFEND                                                           
*                                  BUILD FILE TRANSMISSION ELEMENT              
         L     R5,SXDTSLSA                                                      
         USING SXSLLSTD,R5                                                      
WFDR020  EQU   *                                                                
         C     R5,SXDTSLEA                                                      
         BE    WFDR100                                                          
         XC    ELEMENT,ELEMENT                                                  
         LA    R3,ELEMENT                                                       
         USING GXFTEL,R3                                                        
         MVI   GXFTEL,GXFTELQ                                                   
         MVI   GXFTELL,GXFTELLQ                                                 
         MVC   GXFTEID,SXSLEID                                                  
         MVC   GXFTPLFM,SXSLPLFM                                                
         CLC   FILEGCNT,=Y(1)                                                   
         BH    *+10                                                             
         MVC   GXFTLOAD,SXSLLOAD                                                
         MVC   GXFTFNUM,SXSLFNUM                                                
         LA    R6,SXSLAPAR                                                      
         USING SXSLAPAR,R6                                                      
         LA    R1,GXFTSLST                                                      
         USING GXFTSLST,R1                                                      
         SR    RF,RF                                                            
         ICM   RF,1,SXSLANUM                                                    
         BZ    WFDR030                                                          
*                                                                               
WFDR022  MVC   GXFTSKEY,SXSLSKEY                                                
         LA    R6,SXSLAPAL(R6)                                                  
         LA    R1,GXFTSLQ(R1)                                                   
         BCT   RF,WFDR022                                                       
         SR    R1,R3                                                            
         STC   R1,GXFTELL                                                       
         DROP  R1,R6                                                            
*                                                                               
WFDR030  GOTO1 VHELLO,DMCB,(C'P',GENFIL),(R2),ELEMENT,0                         
         CLI   12(R1),0                                                         
         BE    *+12                                                             
         LA    R0,5                                                             
         B     SAFEND                                                           
         SR    RF,RF                                                            
         IC    RF,SXSLANUM                                                      
         MH    RF,=AL2(SXSLAPAL)                                                
         AR    R5,RF                                                            
         LA    R5,SXSLLSTL(R5)                                                  
         B     WFDR020                                                          
         DROP  R5                                                               
*                                  ADD ACTIVITY ELEMENT                         
WFDR100  GOTO1 =A(SETACT),(RC)                                                  
         BNE   WFDRNO                                                           
*                                                                               
**********************************************************************          
*&&US*&& MVC   P(15),=CL15'BEFORE ADDREC2:'                                     
*&&US*&& BRAS  RE,PRTEOF                                                        
**********************************************************************          
*                                  ADD RECORD                                   
         MVC   IOKEY(GXKEYL),0(R2)                                              
         GOTO1 VDATAMGR,DMCB,(X'00',ADDREC),GENFIL,IOKEY,(R2),DMWORK            
         CLI   8(R1),0                                                          
         BE    *+12                                                             
         LA    R0,6                                                             
         B     SAFEND                                                           
         MVC   FILEDA,IOKEY        SAVE DISK ADDRESS                            
         MVC   ADDRDA,IOKEY        SAVE DISK ADDRESS                            
**********************************************************************          
*&&US*&& MVC   P(15),=CL15'AFTER  ADDREC2:'                                     
*&&US*&& BRAS  RE,PRTEOF                                                        
**********************************************************************          
         B     WFDROK                                                           
*                                                                               
WFDROK   SR    RC,RC               EXIT OK                                      
WFDRNO   LTR   RC,RC               EXIT ERROR                                   
         XIT1                                                                   
         DROP  R2,R3,R4                                                         
         EJECT                                                                  
***********************************************************************         
* UPDATE FILE GENERATION # IN XAGENCY RECORD                          *         
* R4 = A(SYSTEM EXTRACT TABLE ENTRY)                                  *         
***********************************************************************         
         SPACE 1                                                                
         USING SXDTABD,R4                                                       
WRTAGY   NTR1  ,                                                                
*                                                                               
         L     RE,=V(UTL)          SWITCH TO CONTROL SYSTEM                     
         MVI   4(RE),CONTROLQ                                                   
*                                                                               
WAGY010  LA    R2,IOKEY                                                         
         USING GXTRD,R2                                                         
         XC    GXKEY,GXKEY        BUILD FILE RECORD KEY                         
         MVI   GXKREC,GXAKRECQ                                                  
         MVC   GXAKAGY,SXDTAGY                                                  
         MVC   GXAKSYS,SXDTSYS                                                  
         MVC   GXAKSUB,SXDTSUB                                                  
         L     R2,ARECBUFF                                                      
*                                 CHECK RECORD NOT FOUND                        
*                                 READ UPDATE/DELETES WITH FLUSH                
         GOTO1 VDATAMGR,DMCB,(X'AC',DMREAD),GENDIR,IOKEY,(R2),DMWORK            
         CLI   8(R1),0                                                          
         BE    *+12                                                             
         LA    R0,7                                                             
         B     SAFEND                                                           
*                                                                               
         MVC   DMDA,GXDDA                                                       
         GOTO1 VDATAMGR,DMCB,(X'AC',GETREC),GENFIL,DMDA,(R2),DMWORK             
         CLI   8(R1),0                                                          
         BE    *+12                                                             
         LA    R0,8                                                             
         B     SAFEND                                                           
         LA    R3,GXFIRST(R2)                                                   
*                                                                               
WAGY100  CLI   0(R3),0                                                          
         BE    WAGY130                                                          
         CLI   0(R3),GXGNELQ                                                    
         BE    WAGY120                                                          
WAGY110  SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     WAGY100                                                          
*                                                                               
         USING GXGNEL,R3                                                        
WAGY120  EQU   *                   UPDATE FILE GENERATION # ELEMENT             
         CLI   CLEARFLG,C'N'                                                    
         BE    WAGY122                                                          
         CLI   ZEROFLG,C'N'                                                     
         BE    WAGY122                                                          
         MVC   GXGNNUM,SXDTGNUM                                                 
         B     WAGY124                                                          
WAGY122  EQU   *                                                                
         LA    RF,1                                                             
         CLC   GXGNNUM,=XL2'FFFF'                                               
         BE    *+12                                                             
         ICM   RF,3,GXGNNUM                                                     
         LA    RF,1(RF)                                                         
         CLM   RF,3,SXDTGNUM                                                    
         BE    *+12                                                             
         LA    R0,9                                                             
         B     SAFEND                                                           
         STCM  RF,3,GXGNNUM                                                     
WAGY124  EQU   *                                                                
         B     WAGY200                                                          
*                                                                               
WAGY130  LA    R3,ELEMENT          ADD FILE GENERATION NUMBER ELEMENT           
         XC    ELEMENT,ELEMENT                                                  
         MVI   GXGNEL,GXGNELQ                                                   
         MVI   GXGNELL,GXGNELLQ                                                 
         MVC   GXGNNUM,SXDTGNUM                                                 
*                                                                               
         GOTO1 VHELLO,DMCB,(C'P',GENFIL),(R2),ELEMENT,0                         
         CLI   12(R1),0                                                         
         BE    *+12                                                             
         LA    R0,10                                                            
         B     SAFEND                                                           
         B     WAGY200                                                          
         DROP  R3                                                               
*                                  UPDATE RECORD                                
WAGY200  GOTO1 VDATAMGR,DMCB,PUTREC,GENFIL,DMDA,(R2),DMWORK                     
         CLI   8(R1),0                                                          
         BE    *+12                                                             
         LA    R0,11                                                            
         B     SAFEND                                                           
         B     WAGYOK                                                           
*                                                                               
WAGYOK   SR    RC,RC               EXIT OK                                      
WAGYNO   LTR   RC,RC               EXIT ERROR                                   
         XIT1                                                                   
         DROP  R2,R4                                                            
         EJECT                                                                  
***********************************************************************         
* WRITE AGENCY FILE DEFINITION RECORD PASSIVE                         *         
* FILEDA = DISK A(FILE DEFINITION DA RECORD)                          *         
* R4 = A(SYSTEM EXTRACT TABLE ENTRY)                                  *         
***********************************************************************         
         SPACE 1                                                                
         USING SXDTABD,R4                                                       
WRTAFP   NTR1  ,                                                                
*                                                                               
         L     RE,=V(UTL)          SWITCH TO CONTROL SYSTEM FILES               
         MVI   4(RE),CONTROLQ                                                   
*                                                                               
WAFP010  LA    R2,IOKEY                                                         
         USING GXTRD,R2                                                         
         XC    GXKEY,GXKEY        BUILD FILE RECORD KEY                         
         MVI   GXKREC,GXAFRECQ                                                  
         MVC   GXAFAGY,SXDTAGY                                                  
         MVC   GXAFSYS,SXDTSYS                                                  
         MVC   GXAFSUB,SXDTSUB                                                  
         MVC   GXAFDAT,DATENC                                                   
         XC    GXAFDAT,=XL2'FFFF'                                               
         MVC   GXAFTIM,TIMEND                                                   
         XC    GXAFTIM,=XL4'FFFFFFFF'                                           
         L     R2,ARECBUFF                                                      
*                                  CHECK RECORD NOT FOUND                       
*                                  READ FOR UPDATE/DELETES WITH FLUSH           
         GOTO1 VDATAMGR,DMCB,(X'AC',DMREAD),GENDIR,IOKEY,(R2),DMWORK            
         CLI   8(R1),X'10'                                                      
         BE    *+12                                                             
         LA    R0,12                                                            
         B     SAFEND                                                           
*                                                                               
WAFPDATA EQU   *                   BUILD RECORD DATA                            
         MVC   GXKEY,IOKEY                                                      
         MVC   GXDDA,FILEDA                                                     
         XC    GXDSTAT(GXDDA-GXDSTAT),GXDSTAT                                   
*                                  ADD RECORD                                   
         MVC   IOKEY(GXKEYL),0(R2)                                              
         GOTO1 VDATAMGR,DMCB,(X'00',DMADD),GENDIR,IOKEY,(R2),DMWORK             
         CLI   8(R1),0                                                          
         BE    *+12                                                             
         LA    R0,13                                                            
         B     SAFEND                                                           
         B     WAFPOK                                                           
*                                                                               
WAFPOK   SR    RC,RC               EXIT OK                                      
WAFPNO   LTR   RC,RC               EXIT ERROR                                   
         XIT1                                                                   
         DROP  R2,R4                                                            
         EJECT                                                                  
***********************************************************************         
* WRITE SERVER LUID FILE DEFINITION RECORD PASSIVE                    *         
* AND UPDATE SERVER APPLICATION RECORD                                *         
* FILEDA = DISK A(FILE DEFINITION DA RECORD)                          *         
* R4 = A(SYSTEM EXTRACT TABLE ENTRY)                                  *         
***********************************************************************         
         SPACE 1                                                                
         USING SXDTABD,R4                                                       
WRTSFP   NTR1  ,                                                                
*                                                                               
         L     RE,=V(UTL)          SWITCH TO CONTROL SYSTEM FILES               
         MVI   4(RE),CONTROLQ                                                   
*                                                                               
         L     R5,SXDTSLSA                                                      
         USING SXSLLSTD,R5                                                      
WSFP010  C     R5,SXDTSLEA                                                      
         BE    WSFPOK                                                           
*                                                                               
         LA    R2,IOKEY                                                         
         USING GXTRD,R2                                                         
         XC    GXKEY,GXKEY        BUILD SERVER FILE PASSIVE RECORD KEY          
         MVI   GXKREC,GXSFRECQ                                                  
         MVC   GXSFEID,SXSLEID                                                  
         MVC   GXSFAGY,SXDTAGY                                                  
         MVC   GXSFSYS,SXDTSYS                                                  
         MVC   GXSFSUB,SXDTSUB                                                  
         MVC   GXSFFNUM,SXSLFNUM                                                
         L     R2,ARECBUFF                                                      
*                                  CHECK RECORD NOT FOUND                       
*                                  READ FOR UPDATE DELETES WITH FLUSH           
         GOTO1 VDATAMGR,DMCB,(X'AC',DMREAD),GENDIR,IOKEY,(R2),DMWORK            
         CLI   8(R1),X'10'                                                      
         BE    WSFP020                                                          
         CLI   8(R1),X'02'                                                      
         BE    WSFP030                                                          
         LA    R0,14                                                            
         B     SAFEND                                                           
*                                                                               
WSFP020  MVC   GXKEY,IOKEY                                                      
         MVC   GXDDA,FILEDA                                                     
         XC    GXDSTAT(GXDDA-GXDSTAT),GXDSTAT                                   
*                                  ADD RECORD                                   
         MVC   IOKEY(GXKEYL),0(R2)                                              
         GOTO1 VDATAMGR,DMCB,(X'00',DMADD),GENDIR,IOKEY,(R2),DMWORK             
         CLI   8(R1),0                                                          
         BE    *+12                                                             
         LA    R0,15                                                            
         B     SAFEND                                                           
         B     WSFP040                                                          
*                                                                               
WSFP030  MVC   GXKEY,IOKEY                                                      
         MVC   GXDDA,FILEDA                                                     
         XC    GXDSTAT(GXDDA-GXDSTAT),GXDSTAT                                   
*                                  OVERWRITE DELETED RECORD                     
         MVC   IOKEY(GXKEYL),0(R2)                                              
         GOTO1 VDATAMGR,DMCB,(X'00',DMWRT),GENDIR,IOKEY,(R2),DMWORK             
         CLI   8(R1),0                                                          
         BE    *+12                                                             
         LA    R0,15                                                            
         B     SAFEND                                                           
         B     WSFP040                                                          
*                                                                               
WSFP040  EQU   *                                                                
         LA    R2,IOKEY            UPDATE SERVER APPLICATION RECORD             
         USING GXTRD,R2                                                         
         XC    GXKEY,GXKEY                                                      
         MVI   GXKREC,GXSKRECQ                                                  
         MVC   GXSKEID,SXSLEID                                                  
         MVC   GXSKAGY,SXDTAGY                                                  
         MVC   GXSKSYS,SXDTSYS                                                  
         MVC   GXSKSUB,SXDTSUB                                                  
         L     R2,ARECBUFF                                                      
*                                  READ FOR UPDATE WITH FLUSH                   
         GOTO1 VDATAMGR,DMCB,(X'A4',DMREAD),GENDIR,IOKEY,(R2),DMWORK            
         CLI   8(R1),0                                                          
         BE    *+12                                                             
         LA    R0,16                                                            
         B     SAFEND                                                           
*                                  GETREC WITH FLUSH                            
         MVC   DMDA,GXDDA                                                       
         GOTO1 VDATAMGR,DMCB,(X'A4',GETREC),GENFIL,DMDA,(R2),DMWORK             
         CLI   8(R1),0                                                          
         BE    *+12                                                             
         LA    R0,17                                                            
         B     SAFEND                                                           
         LA    R3,GXFIRST(R2)                                                   
*                                                                               
WSFP100  CLI   0(R3),0                                                          
         BNE   *+12                                                             
         LA    R0,18                                                            
         B     SAFEND                                                           
         CLI   0(R3),GXSTELQ                                                    
         BE    WSFP120                                                          
WSFP110  SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     WSFP100                                                          
*                                                                               
         USING GXSTEL,R3                                                        
WSFP120  EQU   *                   UPDATE XTRANSFER ELEMENT                     
*                                  BUMP CREATE FILE#                            
         LA    RF,1                                                             
         CLC   GXSTCRFN,=XL2'FFFF'                                              
         BE    *+12                                                             
         ICM   RF,3,GXSTCRFN                                                    
         LA    RF,1(RF)                                                         
         CLM   RF,3,SXSLFNUM                                                    
         BE    *+12                                                             
         LA    R0,19                                                            
         B     SAFEND                                                           
         STCM  RF,3,GXSTCRFN                                                    
         CLI   MODE,DXLOADQ        IN LOAD MODE SET OTHER FILE#S TO ONE         
         BNE   WSFP200             LESS THAN FIRST GENERATED FILE#              
         CLI   SXSLLOAD,0                                                       
         BE    WSFP200                                                          
         CLI   SXSLLOAD,C'0'                                                    
         BE    WSFP200                                                          
         CLC   FILEGCNT,=Y(1)                                                   
         BH    WSFP200                                                          
         BCTR  RF,0                                                             
         STCM  RF,3,GXSTNOFN                                                    
         STCM  RF,3,GXSTREFN                                                    
         STCM  RF,3,GXSTCOFN                                                    
         B     WSFP200                                                          
         DROP  R3                                                               
*                                  UPDATE RECORD                                
WSFP200  GOTO1 VDATAMGR,DMCB,PUTREC,GENFIL,DMDA,(R2),DMWORK                     
         CLI   8(R1),0                                                          
         BE    *+12                                                             
         LA    R0,20                                                            
         B     SAFEND                                                           
         SR    RF,RF                                                            
         IC    RF,SXSLANUM                                                      
         MH    RF,=AL2(SXSLAPAL)                                                
         AR    R5,RF                                                            
         LA    R5,SXSLLSTL(R5)                                                  
         B     WSFP010                                                          
         DROP  R5                                                               
*                                                                               
WSFPOK   SR    RC,RC               EXIT OK                                      
WSFPNO   LTR   RC,RC               EXIT ERROR                                   
         XIT1                                                                   
         DROP  R2,R4                                                            
         SPACE 1                                                                
***********************************************************************         
*  SAFE ABEND - R0=(ERROR CODE) DEQUEUE AND CLOSE CONTROL SYSTEM FILES*         
*  HERE IF ERROR WHILE WRITING EXTRACT FILE CONTROL RECORDS           *         
***********************************************************************         
         SPACE 1                                                                
         USING SXDTABD,R4                                                       
SAFEND   EQU   *                                                                
         LR    R3,R0                                                            
         MVC   DMCBSAVE(24),DMCB                                                
         GOTO1 =A(DEQCTRL),(RC)    DEQUEUE CONTROL SYSTEM                       
         GOTO1 =A(CLOSCTFL),(RC)                                                
         MVI   ERROR,ERWRTXFQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         MVC   P(40),=CL40'SAFEND EXIT CODE: '                                  
         MVC   P(40),=CL40'XFILE RECORD WRITE ERROR EXIT: '                     
         EDIT  (R3),(8,P+31),ZERO=NOBLANK,ALIGN=LEFT                            
         GOTO1 VPRINTER                                                         
         MVC   P(40),=CL40'DMCB+8: '                                            
         GOTO1 VHEXOUT,DMCB,DMCBSAVE+8,P+8,1,=C'TOG'                            
         GOTO1 VPRINTER                                                         
         MVC   P(40),=CL40'AGENCY: '                                            
         MVC   P+8(2),SXDTAGY                                                   
         GOTO1 VPRINTER                                                         
         ABEND 771,DUMP                                                         
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* WRITE FILE CREATED MESSAGES TO OPERATOR CONSOLE                     *         
* R4 = A(SYSTEM EXTRACT TABLE ENTRY)                                  *         
***********************************************************************         
         SPACE 1                                                                
         USING SXDTABD,R4                                                       
WRTOPER  NTR1                                                                   
         L     R5,SXDTSLSA                                                      
         USING SXSLLSTD,R5                                                      
WROP010  EQU   *                                                                
         C     R5,SXDTSLEA                                                      
         BE    WROPX                                                            
         LA    R6,SXSLAPAR                                                      
         USING SXSLAPAR,R6                                                      
         SR    RF,RF                                                            
         ICM   RF,1,SXSLANUM                                                    
         BZ    WROP030                                                          
*                                                                               
WROP020  BRAS  RE,FORMOPM                                                       
         LA    R6,SXSLAPAL(R6)                                                  
         BCT   RF,WROP020                                                       
*                                                                               
WROP030  SR    RF,RF                                                            
         IC    RF,SXSLANUM                                                      
         MH    RF,=AL2(SXSLAPAL)                                                
         AR    R5,RF                                                            
         LA    R5,SXSLLSTL(R5)                                                  
         B     WROP010                                                          
*                                                                               
WROPX    XIT1                                                                   
         SPACE 1                                                                
***********************************************************************         
* FORMAT SQL FILE CREATED MESSAGE FOR OPERATOR CONSOLE                *         
* R4 = A(SYSTEM EXTRACT TABLE ENTRY)                                  *         
***********************************************************************         
         SPACE 1                                                                
FORMOPM  NTR1                                                                   
         MVC   P,SPACES                                                         
         MVC   P(24),=CL24'SQL FILE CREATED:   '                                
         LA    R2,P+24                                                          
         MVC   0(8,R2),SXSLEID                                                  
         LA    R2,8(R2)                                                         
         MVI   0(R2),C','                                                       
         LA    R2,1(R2)                                                         
         CLI   SXDTAGY,C'A'                                                     
         BL    FOPM020                                                          
         CLI   SXDTAGY,C'Z'                                                     
         BH    FOPM020                                                          
         CLI   SXDTAGY,C'A'                                                     
         BL    FOPM010                                                          
         CLI   SXDTAGY,C'Z'                                                     
         BH    FOPM010                                                          
         B     FOPM030                                                          
FOPM010  CLI   SXDTAGY,C'0'                                                     
         BL    FOPM020                                                          
         CLI   SXDTAGY,C'9'                                                     
         BH    FOPM020                                                          
         B     FOPM030                                                          
FOPM020  MVI   0(R2),C'H'                                                       
         LA    R2,1(R2)                                                         
         GOTO1 VHEXOUT,DMCB,SXDTAGY,(R2),2,=C'TOG'                              
         LA    R2,4(R2)                                                         
         B     FOPM040                                                          
FOPM030  MVC   0(2,R2),SXDTAGY                                                  
         LA    R2,2(R2)                                                         
FOPM040  MVC   0(1,R2),SXDTSCOD                                                 
         LA    R2,1(R2)                                                         
         MVC   0(1,R2),SXDTSUBC                                                 
         LA    R2,1(R2)                                                         
         MVI   0(R2),C','                                                       
         LA    R2,1(R2)                                                         
         SR    RF,RF                                                            
         ICM   RF,3,SXDTGNUM                                                    
         EDIT  (RF),(6,0(R2)),ZERO=NOBLANK,FILL=0                               
         MVI   0(R2),C'G'                                                       
         LA    R2,6(R2)                                                         
         MVI   0(R2),C','                                                       
         LA    R2,1(R2)                                                         
FOPM050  SR    RF,RF                                                            
         ICM   RF,3,SXSLFNUM                                                    
         EDIT  (RF),(6,0(R2)),ZERO=NOBLANK,FILL=0                               
         MVI   0(R2),C'T'                                                       
         LA    R2,6(R2)                                                         
         MVI   0(R2),C','                                                       
         LA    R2,1(R2)                                                         
         LA    R1,SXSLSKEY                                                      
         LA    R0,8                                                             
         CLI   0(R1),C' '                                                       
         BE    FOPM050                                                          
FOPM060  CLI   0(R1),C' '                                                       
         BE    FOPM070                                                          
         CLI   0(R1),0                                                          
         BE    *+10                                                             
         MVC   0(1,R2),0(R1)                                                    
         LA    R2,1(R2)                                                         
         LA    R1,1(R1)                                                         
         BCT   R0,FOPM060                                                       
FOPM070  MVI   0(R2),C','                                                       
         LA    R2,1(R2)                                                         
         MVC   0(5,R2),=CL5'RC = '                                              
         LA    R2,5(R2)                                                         
         MVC   0(6,R2),=CL6'000000'                                             
         MVC   WTOMSGD,P                                                        
         GOTO1 VPRINTER                                                         
         TM    SXDTFLG1,GXSDFMLQ                                                
         BZ    FOPM080                                                          
         GOTO1 VESSWTO,DMCB,X'FF000001',(L'WTOMSG,WTOMSG)                       
         B     FOPM090                                                          
FOPM080  EQU   *                                                                
         GOTO1 VESSWTO,DMCB,X'FE000001',(L'WTOMSG,WTOMSG)                       
FOPM090  EQU   *                                                                
         MVC   P,SPACES                                                         
         XIT1                                                                   
         DROP  R4,R5,R6                                                         
         LTORG                                                                  
                                                                                
***********************************************************************         
* WRITE BDE CONTROL RECORDS                                           *         
***********************************************************************         
         DS    0D                                                               
         USING SXDTABD,R4                                                       
WRTBDE   NMOD1 0,**WBDE**                                                       
         LR    RC,R1                                                            
         MVI   MSGNUM,MSWRBDEQ                                                  
         GOTO1 =A(MSGPRT),(RC)                                                  
*                                                                               
         USING SXBDETD,R6                                                       
         ICM   R6,15,ASXBDET       BDE TABLE                                    
         LHI   RF,SXBDEMAX                                                      
WBDE02   CLC   SXBDEAGY,SXDTAGY    MATCH ON AGENCY                              
         BNE   WBDE04                                                           
         CLC   SXBDESYS,SXDTSYS    MATCH ON SYSTEM                              
         BNE   WBDE04                                                           
         CLC   SXBDESUB,SXDTSUB    MATCH ON SUBSYSTEM                           
         BE    WBDE10                                                           
WBDE04   AHI   R6,SXBDETL                                                       
         BCT   RF,WBDE02                                                        
         DC    H'0'                MISSING BDE CONTROL INFORMATION              
*                                                                               
WBDE10   L     RF,=A(SSB)          SET DSPACE= FLAG                             
         CLI   DSPFLAG,C'T'                                                     
         BNE   *+8                                                              
         MVI   SSODSPAC-SSOOFF(RF),C'T'                                         
         CLI   DSPFLAG,C'N'                                                     
         BNE   *+8                                                              
         MVI   SSODSPAC-SSOOFF(RF),C'N'                                         
*                                                                               
         XC    WORK,WORK           PRINT LINE FOR PRTQUE CALLS                  
         LA    R2,WORK                                                          
         USING PQPLD,R2                                                         
         MVC   QLSRCID,SXBDEUIN                                                 
         MVI   QLEXTRA,X'FF'       OPEN PRINT QUEUE REPORT                      
         MVC   QLSUBID,=C'BDF'                                                  
         MVI   QLCLASS,C'G'        MUST BE CLASS "G" REPORT                     
         MVI   QLLINET,X'C0'                                                    
         MVI   QLLINEW,132                                                      
         MVC   QLRETNL,=H'36'                                                   
         MVC   QLRETND,=H'2'                                                    
         MVC   QLDESC,=C'DXTRACT BDE'                                           
*                                                                               
         CLC   =XL2'0000',USERNUM                                               
         BE    WBDE15                                                           
         CLC   USERNUM,SXBDEUIN    SAME USERID AS THE CLASS "G" REPORT          
         BE    WBDE15                                                           
         GOTO1 VDATAMGR,DMCB,=C'OPMSG',=C'AUTONOTE*US-MF_FAC_NOTIFY,US-+        
               RDR: DXTRACT WARNING, USERID MISMATCH'                           
         DC    H'0'          STOP HERE, BETTER THAN SEND WRONG DATA OUT         
*                                                                               
WBDE15   ICM   RE,15,ABDEBUFF                                                   
         XCEFL (RE),14336          CLEAR PQ C/I BUFFER                          
*                                                                               
         GOTO1 VDATAMGR,DMCB,=C'DMPRINT',=C'PRTQUE',0,WORK,ABDEBUFF             
         CLI   DMCB+8,0                                                         
         BE    WBDE20                                                           
*                                                                               
         MVC   P+11(13),=C'*** ERROR ***'                                       
         MVC   P+30(28),=C'COULD NOT OPEN PRTQUE REPORT'                        
         GOTO1 VPRINTER                                                         
         DC    H'0'                                                             
         B     WBDENO                                                           
*                                                                               
WBDE20   MVC   P(L'QLSRCID),QLSRCID                                             
         MVC   P+10(L'QLSUBID),QLSUBID                                          
         MVC   P+20(L'QLREPRNO),QLREPRNO                                        
         MVC   P+30(L'QLREPRCI),QLREPRCI                                        
         GOTO1 VPRINTER                                                         
*                                                                               
         MVI   WORK,X'89'          SET SKIP TO TOP OF PAGE                      
         MVC   WORK+1(132),SPACES                                               
         GOTO1 VDATAMGR,DMCB,=C'DMPRINT',=C'PRTQUE',0,WORK,ABDEBUFF             
         CLI   DMCB+8,0                                                         
         BNE   WBDEERR                                                          
*                                                                               
*1ST RECORD: HEADER WITH EDICT RECORD KEY                                       
         MVI   WORK,X'09'          SET SINGLE SPACE WRITE                       
         MVC   WORK+1(132),SPACES                                               
         MVC   WORK+5(11),=C'*HDR*EDICT='                                       
         MVC   WORK+16(L'SXBDEEDI),SXBDEEDI   8-BYTE EDICT RECORD NAME          
         MVI   WORK+38,C'D'                                                     
         GOTO1 VDATAMGR,DMCB,=C'DMPRINT',=C'PRTQUE',0,WORK,ABDEBUFF             
         CLI   DMCB+8,0                                                         
         BNE   WBDEERR                                                          
*                                                                               
*2ND RECORD: ++DDS CARD FOR "SUB" - "SUBJECT" FIELD IN BDE CUI                  
         MVI   WORK,X'09'          SET SINGLE SPACE WRITE                       
         MVC   WORK+1(132),SPACES                                               
         MVC   WORK+1(14),=C'++DDS      SUB'                                    
         MVC   WORK+16(L'SXBDESBJ),SXBDESBJ                                     
         GOTO1 VDATAMGR,DMCB,=C'DMPRINT',=C'PRTQUE',0,WORK,ABDEBUFF             
         CLI   DMCB+8,0                                                         
         BNE   WBDEERR                                                          
*                                                                               
*3RD RECORD: ++DDS CARD FOR "FIL" - "DOC NAME" FIELD IN BDE CUI                 
         MVI   WORK,X'09'          SET SINGLE SPACE WRITE                       
         MVC   WORK+1(132),SPACES                                               
         MVC   WORK+1(14),=C'++DDS      FIL'                                    
         MVC   WORK+16(L'SXDTXDSN),SXDTXDSN                                     
         CLC   =C'(SAME AS DSN)',SXBDEFIL                                       
         BE    WBDE30                                                           
         MVC   WORK+16(L'SXBDEFIL),SXBDEFIL                                     
WBDE30   GOTO1 VDATAMGR,DMCB,=C'DMPRINT',=C'PRTQUE',0,WORK,ABDEBUFF             
         CLI   DMCB+8,0                                                         
         BNE   WBDEERR                                                          
*                                                                               
*4TH RECORD: ++DDS CARD FOR "EXT" - FILE NAME EXTENSION TYPE                    
         MVI   WORK,X'09'          SET SINGLE SPACE WRITE                       
         MVC   WORK+1(132),SPACES                                               
         MVC   WORK+1(18),=C'++DDS      EXT TXT'                                
         GOTO1 VDATAMGR,DMCB,=C'DMPRINT',=C'PRTQUE',0,WORK,ABDEBUFF             
         CLI   DMCB+8,0                                                         
         BNE   WBDEERR                                                          
*                                                                               
*5TH RECORD: ++DDS CARD FOR "DSN" - MVS DATASET NAME TO BE TRANSFERRED          
         MVI   WORK,X'09'          SET SINGLE SPACE WRITE                       
         MVC   WORK+1(132),SPACES                                               
         MVC   WORK+1(14),=C'++DDS      DSN'                                    
         MVC   WORK+16(L'SXDTXDSN),SXDTXDSN                                     
         GOTO1 VDATAMGR,DMCB,=C'DMPRINT',=C'PRTQUE',0,WORK,ABDEBUFF             
         CLI   DMCB+8,0                                                         
         BNE   WBDEERR                                                          
*                                                                               
*5TH RECORD: ONE DUMMY LINE (MUST HAVE AT LEAST ONE LINE OF NOT ++DDS)          
         MVI   WORK,X'09'          SET SINGLE SPACE WRITE                       
         MVC   WORK+1(132),SPACES                                               
         MVC   WORK+1(16),=C'*** ANYTHING ***'                                  
         GOTO1 VDATAMGR,DMCB,=C'DMPRINT',=C'PRTQUE',0,WORK,ABDEBUFF             
         CLI   DMCB+8,0                                                         
         BNE   WBDEERR                                                          
*                                                                               
         MVI   WORK,X'FF'          SET END OF REPORT                            
         MVC   WORK+1(132),SPACES                                               
         GOTO1 VDATAMGR,DMCB,=C'DMPRINT',=C'PRTQUE',0,WORK,ABDEBUFF             
         B     WBDEOK                                                           
*                                                                               
WBDEERR  MVC   P+11(13),=C'*** ERROR ***'                                       
         MVC   P+30(27),=C'COULD NOT WRITE PRTQUE LINE'                         
         GOTO1 VPRINTER                                                         
         DC    H'0'                                                             
         B     WBDENO                                                           
*                                                                               
WBDEOK   GOTO1 =V(DMISGENQ),DMCB,C'TASK'    CLEAN-UP TASK PRTQ ENQUEUES         
         J     EQXIT                                                            
*                                                                               
WBDENO   GOTO1 =V(DMISGENQ),DMCB,C'TASK'    CLEAN-UP TASK PRTQ ENQUEUES         
         J     NEQXIT                                                           
*                                                                               
         DROP  R4,R6                                                            
         LTORG                                                                  
                                                                                
***********************************************************************         
* GET BDE CONTROL RECORD INFO                                         *         
* R2=AREFORMD                                                         *         
***********************************************************************         
         DS    0D                                                               
         USING REFORMD,R2                                                       
GETBDE   NMOD1 0,**GBDE**                                                       
         LR    RC,R1                                                            
*                                                                               
         LA    R4,IOKEY            READ BDE CONTROL RECORD                      
         USING GBDRD,R4                                                         
         XC    GBDRKEY,GBDRKEY     CLEAR RECORD KEY                             
         MVI   GBDRKREC,GBDRRECQ   SET BDE RECORD TYPE                          
         MVC   GBDRAGY,REFAGY                                                   
         MVC   GBDEID,REFBDEID                                                  
         L     R4,ARECBUFF                                                      
*                                                                               
         GOTO1 VDATAMGR,DMCB,(X'24',DMREAD),GENDIR,IOKEY,(R4),DMWORK            
         CLI   8(R1),0                                                          
         BNE   GBDEERR                                                          
         MVC   DMDA,GBDDA                                                       
         GOTO1 VDATAMGR,DMCB,(X'24',GETREC),GENFIL,DMDA,(R4),DMWORK             
         CLI   8(R1),0                                                          
         BNE   GBDEERR                                                          
*                                                                               
         LA    R3,GBFIRST(R4)      PROCESS ELEMENT DATA                         
GBDE110  CLI   0(R3),0                                                          
         BE    GBDEERR                                                          
         CLI   0(R3),GBDEELQ       FIND BDE CONTROL ELEMENT                     
         BE    GBDE200                                                          
GBDE120  SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     GBDE110                                                          
*----------------------------------                                             
* PROCESS BDE CONTROL ELEMENT                                                   
*----------------------------------                                             
         USING GXBDEL,R3                                                        
         USING SXBDETD,R1                                                       
GBDE200  ICM   R1,15,ASXBDET       BDE TABLE                                    
         XR    RE,RE               RE=A(BDE TABLE ENTRY)                        
         LHI   RF,SXBDEMAX         MAXIMUM BDE DESTINATIONS SUPPORTED           
*                                                                               
GBDE202  LTR   RE,RE               DO WE FIND AN EMPTY SLOT ALREADY?            
         BNZ   GBDE204             YES: MOVE ON                                 
         CLI   SXBDEAGY,0          IS THIS ONE EMPTY?                           
         BNE   GBDE204             NO                                           
         LR    RE,R1               YES: SAVE IT                                 
         B     GBDE206                                                          
GBDE204  CLC   SXBDEAGY,GBDRAGY    MATCH ON AGENCY                              
         BNE   GBDE206                                                          
         CLC   SXBDESYS,REFXSYS    MATCH ON SYSTEM                              
         BNE   GBDE206                                                          
         CLC   SXBDESUB,REFXSUB    MATCH ON SUBSYSTEM                           
         BE    GBDE208                                                          
GBDE206  AHI   R1,SXBDETL          MOVE TO NEXT SLOT IN BDE TABLE               
         BCT   RF,GBDE202                                                       
         LTR   R1,RE                                                            
         JZ    GBDEERRF            NO ROOM IN BDE TABLE                         
*                                                                               
GBDE208  MVC   SXBDEAGY,GBDRAGY    AGENCY                                       
         MVC   SXBDESYS,REFXSYS    SYSTEM                                       
         MVC   SXBDESUB,REFXSUB    SUBSYSTEM                                    
         MVC   SXBDEEDI,GXBDEDI    BDE EDICT ID                                 
         MVC   SXBDEUIN,GXBDUIN    BDE PQ USER ID                               
         MVC   SXBDEFIL,GXBDFIL    BDE FILE NAME                                
         MVC   SXBDESBJ,GXBDSUB    BDE SUBJECT                                  
         B     GBDEOK                                                           
         DROP  R1                                                               
*                                                                               
GBDEERRF MVC   P+25(4),=C'FULL'                                                 
GBDEERR  MVC   P+11(13),=C'*** ERROR ***'                                       
         MVC   P+30(27),=C'COULD NOT GET BDE CONTROL  '                         
         GOTO1 VPRINTER                                                         
         DC    H'0'                                                             
*                                                                               
GBDEOK   SR    RC,RC                                                            
GBDENO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R3,R4                                                            
         LTORG                                                                  
                                                                                
***********************************************************************         
* CLEAR OLD EXTRACT CONTROL RECORDS                                   *         
* R4 = A(SYSTEM EXTRACT TABLE ENTRY)                                  *         
***********************************************************************         
         SPACE 1                                                                
         DS    0D                                                               
CLEARXCR NMOD1 0,**CXCR**                                                       
         LR    RC,R1                                                            
         GOTO1 =A(ENQCTRL),(RC)    ENQUEUE CONTROL SYSTEM FOR UPDATES           
*                                                                               
         BRAS  RE,RESXTR           RESET XTRANSFER RECORDS                      
         BNE   CXCRERR                                                          
         BRAS  RE,DELXFL           DELETE OLD XFILE RECORDS                     
         BNE   CXCRERR                                                          
*                                                                               
CXCREX   GOTO1 =A(DEQCTRL),(RC)    DEQUEUE CONTROL SYSTEM                       
         B     CXCROK                                                           
*                                                                               
CXCRERR  GOTO1 =A(DEQCTRL),(RC)    DEQUEUE CONTROL SYSTEM                       
         B     CXCRNO                                                           
*                                                                               
CXCROK   SR    RC,RC                                                            
CXCRNO   LTR   RC,RC                                                            
         XIT1                                                                   
*                                                                               
         EJECT                                                                  
***********************************************************************         
* DELETE OLD XFILE RECORDS AND ASSOCIATED PASSIVES                    *         
* R4 = A(SYSTEM EXTRACT TABLE ENTRY)                                  *         
***********************************************************************         
         SPACE 1                                                                
         USING SXDTABD,R4                                                       
DELXFL   NTR1  ,                                                                
         MVC   P(24),=C'DELETE OLD XFILE RECORDS'                               
         GOTO1 VPRINTER                                                         
         L     RE,=V(UTL)          SWITCH TO CONTROL SYSTEM                     
         MVI   4(RE),CONTROLQ                                                   
         LA    R2,IOKEY            READ XFILE RECORDS                           
         USING GXTRD,R2                                                         
         XC    GXKEY,GXKEY         CLEAR RECORD KEY                             
         MVI   GXKREC,GXAFRECQ     SET XFILE AGENCY PASSIVE RECORD TYPE         
         MVC   GXAFAGY,SXDTAGY                                                  
         MVC   GXAFSYS,SXDTSYS                                                  
         MVC   GXAFSUB,SXDTSUB                                                  
         L     R2,ARECBUFF         READ HIGH FOR FIRST RECORD                   
*                                                                               
         GOTO1 VDATAMGR,DMCB,(X'A4',DMRDHI),GENDIR,IOKEY,(R2),DMWORK            
         TM    8(R1),X'FF'-X'80'   ONLY ALLOW EOF ERROR                         
         BZ    *+12                                                             
         LA    R0,300              DATAMANAGER RETURN NOT 0 OR EOF              
         B     CXCREND                                                          
         B     DXFLDATA                                                         
*                                  READ WITH FLUSH                              
DXFLLOOP MVC   IOKEY(L'GXKEY),IOKEYSV                                           
         L     R2,ARECBUFF                                                      
         GOTO1 VDATAMGR,DMCB,(X'A4',DMREAD),GENDIR,IOKEY,(R2),DMWORK            
         TM    8(R1),X'FF'-X'80'   ONLY ALLOW EOF ERROR                         
         BZ    *+12                                                             
         LA    R0,301              DATAMANAGER RETURN NOT 0 OR EOF              
         B     CXCREND                                                          
         CLI   DELXFLAG,C'N'                                                    
         BE    DXFLSEQN                                                         
         OI    GXDSTAT,X'80'       SET DELETE FLAG IN DIRECTORY                 
         GOTO1 VDATAMGR,DMCB,(X'00',DMWRT),GENDIR,IOKEY,(R2),DMWORK             
         BE    *+12                                                             
         LA    R0,303                                                           
         B     CXCREND                                                          
*                                  READ SEQN WITH FLUSH                         
DXFLSEQN GOTO1 VDATAMGR,DMCB,(X'A4',DMRSEQ),GENDIR,GXKEY,(R2),DMWORK            
         TM    8(R1),X'FF'-X'80'   ONLY ALLOW EOF ERROR                         
         BZ    *+12                                                             
         LA    R0,302              DATAMANAGER RETURN NOT 0 OR EOF              
         B     CXCREND                                                          
         B     DXFLDATA                                                         
*                                                                               
DXFLDATA CLI   8(R1),0                                                          
         BNE   DXFLEND                                                          
         CLC   GXKEY(GXAFSUB+L'GXAFSUB-GXKEY),IOKEY                             
         BNE   DXFLEND                                                          
         MVI   DELXFLAG,C'Y'                                                    
         MVC   IOKEYSV(L'GXKEY),GXKEY                                           
         MVC   SVDATE,GXAFDAT                                                   
         MVC   SVTIME,GXAFTIM                                                   
         MVC   DMDA,GXDDA                                                       
*                                                                               
         LA    R2,IOKEY                                                         
         XC    GXKEY,GXKEY                                                      
         MVI   GXKREC,GXFKRECQ                                                  
         MVC   GXFKDAT,SVDATE                                                   
         MVC   GXFKTIM,SVTIME                                                   
         MVC   GXFKAGY,SXDTAGY                                                  
         MVC   GXFKSYS,SXDTSYS                                                  
         MVC   GXFKSUB,SXDTSUB                                                  
         GOTO1 VDATAMGR,DMCB,(X'A4',DMREAD),GENDIR,IOKEY,(R2),DMWORK            
         CLI   8(R1),0                                                          
         BE    *+12                                                             
         LA    R0,304                                                           
         B     DXFLLOOP            CONTINUE TO NEXT IF NOT FOUND                
*                                                                               
*                                  GETREC WITH FLUSH                            
         L     R2,ARECBUFF                                                      
         GOTO1 VDATAMGR,DMCB,(X'A4',GETREC),GENFIL,DMDA,(R2),DMWORK             
         CLI   8(R1),0                                                          
         BE    *+12                                                             
         LA    R0,306              CAN'T FIND RECORD                            
         B     CXCREND                                                          
*                                                                               
DXFL100  LA    R3,GXFIRST(R2)      PROCESS ELEMENT DATA                         
*                                                                               
DXFL110  CLI   0(R3),0                                                          
         BE    DXFL200                                                          
         CLI   0(R3),GXFTELQ       FIND SYSTEM DEFINITION ELEMENT               
         BE    DXFL130                                                          
DXFL120  SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     DXFL110                                                          
*                                                                               
         USING GXFTEL,R3                                                        
DXFL130  EQU   *                                                                
         OC    ESSID,ESSID         TEST ESSID FILTER                            
         BZ    DXFL132                                                          
         CLC   GXFTEID,ESSID                                                    
         BE    DXFL132                                                          
         MVI   DELXFLAG,C'N'                                                    
         B     DXFL120                                                          
*                                                                               
DXFL132  LA    R2,IOKEY                                                         
         XC    GXKEY,GXKEY                                                      
         MVI   GXKREC,GXSFRECQ                                                  
         MVC   GXSFEID,GXFTEID                                                  
         MVC   GXSFAGY,SXDTAGY                                                  
         MVC   GXSFSYS,SXDTSYS                                                  
         MVC   GXSFSUB,SXDTSUB                                                  
         MVC   GXSFFNUM,GXFTFNUM                                                
         GOTO1 VDATAMGR,DMCB,(X'A4',DMREAD),GENDIR,IOKEY,(R2),DMWORK            
         CLI   8(R1),0                                                          
         BE    *+12                                                             
         LA    R0,307                                                           
*        B     CXCREND                                                          
         B     DXFL120             CONTINUE TO NEXT IF NOT FOUND                
         OI    GXDSTAT,X'80'       SET DELETE FLAG IN DIRECTORY                 
         GOTO1 VDATAMGR,DMCB,(X'00',DMWRT),GENDIR,IOKEY,(R2),DMWORK             
         BE    *+12                                                             
         LA    R0,308                                                           
         B     CXCREND                                                          
         B     DXFL120                                                          
*                                                                               
DXFL200  CLI   DELXFLAG,C'N'                                                    
         BE    DXFLLOOP                                                         
         LA    R2,IOKEY                                                         
         XC    GXKEY,GXKEY                                                      
         MVI   GXKREC,GXFKRECQ                                                  
         MVC   GXFKDAT,SVDATE                                                   
         MVC   GXFKTIM,SVTIME                                                   
         MVC   GXFKAGY,SXDTAGY                                                  
         MVC   GXFKSYS,SXDTSYS                                                  
         MVC   GXFKSUB,SXDTSUB                                                  
         GOTO1 VDATAMGR,DMCB,(X'A4',DMREAD),GENDIR,IOKEY,(R2),DMWORK            
         CLI   8(R1),0                                                          
         BE    *+12                                                             
         LA    R0,304                                                           
*        B     CXCREND                                                          
         B     DXFLLOOP            CONTINUE TO NEXT IF NOT FOUND                
         OI    GXDSTAT,X'80'       SET DELETE FLAG IN DIRECTORY                 
         GOTO1 VDATAMGR,DMCB,(X'00',DMWRT),GENDIR,IOKEY,(R2),DMWORK             
         BE    *+12                                                             
         LA    R0,305                                                           
         B     CXCREND                                                          
         L     R2,ARECBUFF                                                      
         GOTO1 VDATAMGR,DMCB,(X'A4',GETREC),GENFIL,DMDA,(R2),DMWORK             
         CLI   8(R1),0                                                          
         BE    *+12                                                             
         LA    R0,309                                                           
         B     CXCREND                                                          
         OI    GXFSTAT,X'80'       SET DELETE FLAG IN RECORD                    
         GOTO1 VDATAMGR,DMCB,PUTREC,GENFIL,DMDA,(R2),DMWORK                     
         CLI   8(R1),0                                                          
         BE    *+12                                                             
         LA    R0,310                                                           
         B     CXCREND                                                          
         B     DXFLLOOP                                                         
*                                                                               
DXFLEND  EQU   *                                                                
         B     DXFLOK                                                           
*                                                                               
DXFLOK   SR    RC,RC                                                            
DXFLNO   LTR   RC,RC                                                            
         XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* RESET XTRANSFER RECORDS FOR CLEAR OR RELOAD                         *         
* R4 = A(SYSTEM EXTRACT TABLE ENTRY)                                  *         
***********************************************************************         
         SPACE 1                                                                
         USING SXDTABD,R4                                                       
RESXTR   NTR1  ,                                                                
         MVC   P(23),=C'RESET XTRANSFER RECORDS'                                
         GOTO1 VPRINTER                                                         
         L     RE,=V(UTL)          SWITCH TO CONTROL SYSTEM                     
         MVI   4(RE),CONTROLQ                                                   
         LA    R2,IOKEY                                                         
         USING GXTRD,R2                                                         
         XC    GXKEY,GXKEY         CLEAR RECORD KEY                             
         MVI   GXKREC,GXSARECQ     READ XTRANSFER AGENCY PASSIVES               
         MVC   GXSAAGY,SXDTAGY                                                  
         MVC   GXSASYS,SXDTSYS                                                  
         MVC   GXSASUB,SXDTSUB                                                  
         OC    ESSID,ESSID         TEST ESSID FILTER                            
         BZ    *+10                                                             
         MVC   GXSAEID,ESSID                                                    
         L     R2,ARECBUFF         READ HIGH FOR FIRST RECORD                   
*                                                                               
         GOTO1 VDATAMGR,DMCB,(X'A4',DMRDHI),GENDIR,IOKEY,(R2),DMWORK            
         TM    8(R1),X'FF'-X'80'   ONLY ALLOW EOF ERROR                         
         BZ    *+12                                                             
         LA    R0,1                DATAMANAGER RETURN NOT 0 OR EOF              
         B     CXCREND                                                          
         B     RXTRDATA                                                         
*                                  READ WITH FLUSH                              
RXTRLOOP MVC   IOKEY(L'GXKEY),IOKEYSV                                           
         GOTO1 VDATAMGR,DMCB,(X'A4',DMREAD),GENDIR,IOKEY,(R2),DMWORK            
         TM    8(R1),X'FF'-X'80'   ONLY ALLOW EOF ERROR                         
         BZ    *+12                                                             
         LA    R0,311              DATAMANAGER RETURN NOT 0 OR EOF              
         B     CXCREND                                                          
*                                  READ SEQN WITH FLUSH                         
RXTRSEQN GOTO1 VDATAMGR,DMCB,(X'A4',DMRSEQ),GENDIR,GXKEY,(R2),DMWORK            
         TM    8(R1),X'FF'-X'80'   ONLY ALLOW EOF ERROR                         
         BZ    *+12                                                             
         LA    R0,312              DATAMANAGER RETURN NOT 0 OR EOF              
         B     CXCREND                                                          
         B     RXTRDATA                                                         
*                                                                               
RXTRDATA CLI   8(R1),0                                                          
         BNE   RXTREND                                                          
         CLC   GXKEY(GXSAEID-GXKEY),IOKEY                                       
         BNE   RXTREND                                                          
         OC    ESSID,ESSID         TEST ESSID FILTER                            
         BZ    *+14                                                             
         CLC   GXSAEID,ESSID                                                    
         BNE   RXTREND                                                          
         MVC   IOKEYSV(L'GXKEY),GXKEY                                           
         OC    GXSAAPID,GXSAAPID                                                
         BNZ   RXTRAPAR                                                         
         MVC   DMDA,GXDDA                                                       
*                                  GETREC WITH FLUSH                            
         GOTO1 VDATAMGR,DMCB,(X'A4',GETREC),GENFIL,DMDA,(R2),DMWORK             
         CLI   8(R1),0                                                          
         BE    *+12                                                             
         LA    R0,313              CAN'T FIND RECORD                            
         B     CXCREND                                                          
*                                                                               
RXTR100  LA    R3,GXFIRST(R2)      PROCESS ELEMENT DATA                         
*                                                                               
RXTR110  CLI   0(R3),0                                                          
         BE    RXTR200                                                          
         CLI   0(R3),GXSTELQ       FIND TRANSFER CONTROL ELEMENT                
         BE    RXTR130                                                          
RXTR120  SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     RXTR110                                                          
*                                                                               
         USING GXSTEL,R3                                                        
RXTR130  EQU   *                                                                
         CLI   CLEARFLG,C'N'                                                    
         BE    RXTR132                                                          
         CLI   ZEROFLG,C'N'                                                     
         BE    RXTR132                                                          
         XC    GXSTCRFN,GXSTCRFN                                                
RXTR132  EQU   *                                                                
         MVC   GXSTNOFN,GXSTCRFN                                                
         MVC   GXSTREFN,GXSTCRFN                                                
         MVC   GXSTCOFN,GXSTCRFN                                                
         B     RXTR120                                                          
*                                                                               
RXTR200  EQU   *                                                                
*                                  UPDATE RECORD                                
         GOTO1 VDATAMGR,DMCB,PUTREC,GENFIL,DMDA,(R2),DMWORK                     
         CLI   8(R1),0                                                          
         BE    *+12                                                             
         LA    R0,313                                                           
         B     CXCREND                                                          
         B     RXTRLOOP                                                         
*                                                                               
RXTRAPAR EQU   *                                                                
         B     RXTRLOOP                                                         
*                                                                               
RXTREND  EQU   *                                                                
         B     RXTROK                                                           
*                                                                               
RXTROK   SR    RC,RC                                                            
RXTRNO   LTR   RC,RC                                                            
         XIT1                                                                   
         SPACE 1                                                                
***********************************************************************         
*  SAFE ABEND - R0=(ERROR CODE) DEQUEUE AND CLOSE CONTROL SYSTEM FILES*         
***********************************************************************         
         SPACE 1                                                                
CXCREND  EQU   *                                                                
         LR    R3,R0                                                            
         MVC   DMCBSAVE(24),DMCB                                                
         GOTO1 =A(DEQCTRL),(RC)    DEQUEUE CONTROL SYSTEM                       
         GOTO1 =A(CLOSCTFL),(RC)                                                
         MVI   ERROR,ERCLRXFQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         MVC   P(40),=CL40'RETURN CODE:'                                        
         GOTO1 VHEXOUT,DMCB,(R3),P+13,4,=C'TOG'                                 
         GOTO1 VPRINTER                                                         
         ABEND 772,DUMP                                                         
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* CLOSE EXTRACT FILES FOR EACH AGENCY IN SYSTEM TABLE                 *         
***********************************************************************         
         SPACE 1                                                                
         USING SXDTABD,R4                                                       
         DS    0D                                                               
CLOSEXFL NMOD1 0,**CEXF**                                                       
         LR    RC,R1                                                            
         MVI   SQLAONLY,C'N'                                                    
         L     R7,VCPRINT                                                       
         MVC   P(20),=CL20'CLOSE EXFILE:'                                       
         MVC   P+20(44),SXDTXDSN                                                
         ICM   RF,15,VPRINTER                                                   
         GOTO1 VPRINTER                                                         
         CLI   LASTFILE,C'N'                                                    
         BE    CXFL010                                                          
         TM    SQLFLAG,SQLFAFTQ                                                 
         BZ    CXFL010                                                          
*                                                                               
         CP    SXDTRNUM,=PL8'0'    ANY DATA?                                    
         BE    CXFL004             NO                                           
         CP    SXDTRNUM,=PL8'1'    MORE THAN JUST HEADER?                       
         BNE   CXFL005             YES                                          
         CLI   SXDTHDR,0           ONLY HEADER?                                 
         BE    CXFL005             NO - HAVE 1 LINE OF DATA                     
CXFL004  MVI   SQLAONLY,C'Y'                                                    
*                                                                               
CXFL005  MVC   SQLBOOK,SQLBOOKA                                                 
         GOTO1 =A(PROCSQB),(RC)    PROCESS SQL QUERY BOOK                       
         BNE   CXFLNO                EXIT IF ERROR                              
*                                                                               
CXFL010  CLI   MODE,DXPQRQ         TEST IF EXTRACT MODE = PQ REPORT             
         BNE   CXFL012                                                          
         CLI   DIETFLAG,C'Y'       TEST IF DIET SQL FLAG = Y                    
         BE    CXFL014                                                          
*                                                                               
CXFL012  BRAS  RE,PROCTRL          PROCESS EXTRACT TRAILER                      
         BNE   CXFLNO                EXIT IF ERROR                              
*                                                                               
CXFL014  ICM   R5,15,SXDTXDCB      CLOSE EXTRACT FILE                           
         CLOSE ((R5))                                                           
*                                  CHECK FOR NULL FILE                          
         CLI   HOSTDB,C'Y'         TEST FILE COMITTED OK TO HOSTDB              
         BNE   CXFL016                                                          
         CLI   DELFLG,C'N'         TEST DELETE=YES FLAG SET                     
         BE    CXFL090                                                          
         CLI   CONTFLG,C'N'                                                     
         BNE   *+12                                                             
         TM    SXDTFLG2,SXDTFUEQ   TEST UPDATE ERROR OCCURRED                   
         BNZ   CXFL090             LEAVE FILE INTACT                            
         MVI   FILEFLAG,C'Y'       FLAG EXTRACT FILE CREATED                    
         B     CXFL040             BUT DELETE FILE                              
*                                                                               
CXFL016  EQU   *                                                                
*                                                                               
         CLI   MODE,DXPQRQ         OTHER TESTS TO DELETE FILE                   
         BNE   *+12                                                             
         CLI   PQRERROR,C'Y'       TEST PQ REPORT EXTRACT ERROR                 
         BE    CXFL040                                                          
*                                                                               
         CLC   =C'MC',SXDTAGY      ALLOW EMPTY FILE FOR MC AND H9               
         BE    CXFL100                                                          
         CLC   =C'H9',SXDTAGY                                                   
         BE    CXFL100                                                          
         CLC   =C'DU',SXDTAGY                                                   
         BE    CXFL100                                                          
         CLC   =C'GZ',SXDTAGY                                                   
         BE    CXFL100                                                          
*                                                                               
         CLI   MODE,DXSQLQ         TEST IF EXTRACT MODE = SQL ONLY              
         BE    CXFL100             ALLOW EMPTY FILE                             
*                                                                               
         CLI   SFAFLAG,C'Y'        SKIP FILE W/ SQL AFTER ONLY?                 
         BNE   *+12                NO                                           
         CLI   SQLAONLY,C'Y'                                                    
         BE    CXFL040                                                          
*                                                                               
         CLI   SXDTHDR,0           WITH OR WITHOUT HEADER/TRAILER               
         BE    CXFL020                                                          
         CP    SXDTRNUM,=PL8'2'    NO ENTRIES WITH HEADER/TRAILER               
         BNE   CXFL090                                                          
         B     CXFL040                                                          
CXFL020  CP    SXDTRNUM,=PL8'0'    NO ENTRIES WITHOUT HEADER/TRAILER            
         BNE   CXFL090                                                          
*                                                                               
CXFL040  DS    0H                                                               
         CLI   KPEMPTY,C'Y'        KEEPING EMPTY DATASETS?                      
         BE    CXFL090                                                          
*                                                                               
         GOTO1 =A(DELEXFL),(RC)    ELSE DELETE EXTRACT FILE                     
         B     CXFLOK                                                           
*                                                                               
CXFL090  MVI   EMPTYFIL,C'N'       AT LEAST ONE FILE IS NOT EMPTY               
*                                                                               
CXFL100  MVI   FILEFLAG,C'Y'       FLAG EXTRACT FILE CREATED                    
         BRAS  RE,SVFLIST          SAVE INFO FOR LAST FILE IN SFLIST            
*                                                                               
         CLI   CLOXMODE,C'N'       CLOSED EXTRACT FILE MODE?                    
         BE    CXFLOK              NO: SKIP THIS MODE                           
         CLI   CLOXMODE,C'Y'       CLOSED EXTRACT FILE MODE?                    
         BE    CXFL110             YES: CALL SUBSYSTEM EXTRACT                  
         TM    SXDTFLG1,GXSDFXCQ   PROCESS EXTRACT FILE AFTER CLOSE?            
         BZ    CXFLOK              NO: DON'T CALL SUBSYSTEM EXTRACT             
CXFL110  GOTO1 =A(CLOSEDXF),(RC)   CALL SUBSYSTEM EXTRACT AFTER CLOSE           
         BNE   CXFLNO                                                           
*                                                                               
CXFLOK   SR    RC,RC               EXIT OK                                      
         B     CXFLX                                                            
CXFLNO   GOTO1 =A(DEQCTRL),(RC)    DEQUEUE CONTROL SYSTEM/EXIT ERROR            
CXFLX    LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* PROCESS EXTRACT TRAILER FOR THIS FILE                               *         
* R4 POINTS TO SYSTEM EXTRACT TABLE ENTRY                             *         
***********************************************************************         
         SPACE 1                                                                
         USING SXDTABD,R4                                                       
PROCTRL  NTR1  ,                                                                
         CLI   SXDTHDR,0                                                        
         BE    PTRLOK                                                           
         L     R2,AXREC                                                         
         USING DXTRLD,R2                                                        
         MVC   DXTRLLEN(2),=AL2(DXTRLSLL+DXTRLDL)                               
         MVC   DXTRLTYP,DXTRLDQ                                                 
         MVC   DXTRLRTY-1(1),DELIM                                              
*                                                                               
         MVI   DXTRLRTY,C'L'                                                    
         CLI   MODE,DXLOADQ                                                     
         BE    PTRL004                                                          
         CLI   MODEPQL,C'Y'        MODE=PQ W/ LOAD OPTION?                      
         BE    PTRL004                                                          
         MVI   DXTRLRTY,C'U'                                                    
*                                                                               
PTRL004  MVC   DXTRLCDT-1(1),DELIM                                              
         MVC   DXTRLCDT,DATEN                                                   
         MVC   DXTRLCTI-1(1),DELIM                                              
         MVC   DXTRLCTI,TIMEN                                                   
*                                                                               
         MVC   DXTRLLEV-1(1),DELIM                                              
         EDIT  SXDTLEV,(3,DXTRLLEV),ZERO=NOBLANK,FILL=0                         
         MVC   DXTRLVER-1(1),DELIM                                              
         EDIT  SXDTVER,(3,DXTRLVER),ZERO=NOBLANK,FILL=0                         
         MVC   DXTRLAGA-1(1),DELIM                                              
         MVC   DXTRLAGA,SXDTAGY                                                 
         CLI   DXTRLAGA,C'*'                                                    
         BNE   *+8                                                              
         MVI   DXTRLAGA,C'@'                                                    
         MVC   DXTRLAGB-1(1),DELIM                                              
         EDIT  SXDTAGB,(3,DXTRLAGB),ZERO=NOBLANK,FILL=0                         
         MVC   DXTRLPIN-1(1),DELIM                                              
         EDIT  SXDTPIN,(5,DXTRLPIN),ZERO=NOBLANK,FILL=0                         
         MVC   DXTRLFAC-1(1),DELIM                                              
         MVC   DXTRLFAC,FACID                                                   
         OI    DXTRLFAC,X'F0'                                                   
         MVC   DXTRLSYS-1(1),DELIM                                              
         MVC   DXTRLSYS,SXDTSCOD                                                
         MVC   DXTRLSFC-1(1),DELIM                                              
         MVC   DXTRLSFC,SXDTSCHR                                                
         MVC   DXTRLSUB-1(1),DELIM                                              
         MVC   DXTRLSUB,SXDTSUBC                                                
         MVC   DXTRLRTP-1(1),DELIM                                              
         MVC   DXTRLRTP,SXDTTYP                                                 
         MVC   DXTRLFLT-1(1),DELIM                                              
         MVC   DXTRLFLT(1),SXDTFLT1                                             
         MVC   DXTRLFLT+1(1),SXDTFLT2                                           
         MVC   DXTRLFLT+2(1),SXDTFLT3                                           
         CLC   DXTRLFLT,SPACES                                                  
         BNE   *+8                                                              
         MVI   DXTRLFLT,C'*'                                                    
         MVC   DXTRLTXT-1(1),DELIM                                              
         MVC   DXTRLTXT,=CL8'TRAILER'                                           
*                                                                               
         MVC   DXTRLDX(1),DELIM                                                 
         MVC   DXTRLDX+1(1),DELIM                                               
*                                                                               
         LA    R3,DXTRLSL                                                       
         USING DXTRLSL,R3                                                       
         MVC   DXTRLNM-1(1),DELIM                                               
         EDIT  SXDTMTOT,(12,DXTRLNM),ZERO=NOBLANK,FILL=0                        
         MVC   DXTRLFRC-1(1),DELIM                                              
         MVC   DXTRLFRC,SXDTFCOD                                                
         CLI   DXTRLFRC,C'L'                                                    
         BNE   *+8                                                              
         MVI   DXTRLFRC,C'E'                                                    
         CLI   LASTFILE,C'Y'                                                    
         BNE   *+8                                                              
         MVI   DXTRLFRC,C'L'                                                    
         MVC   DXTRLFRT-1(1),DELIM                                              
         LA    R0,4                                                             
         GOTO1 VTIMBER,DMCB,(X'40',(R0)),(2,SXDTFTIM),(1,DXTRLFRT)              
         CLI   0(R1),0                                                          
         BNE   PTRLNO                                                           
         MVC   DXTRLFRT+4(2),=CL2'00'                                           
         MVC   DXTRLFTY-1(1),DELIM                                              
         MVC   DXTRLFTY,SXDTFTYP                                                
         MVC   DXTRLFID-1(1),DELIM                                              
         MVC   DXTRLFID,SXDTXDSN                                                
         CLC   OVRDSN,SPACES       ANY OVERRIDE DSN?                            
         BE    *+10                NO - EXIT                                    
         MVC   DXTRLFID,OVRDSN     YES - USE IT                                 
         DROP  R3                                                               
*                                                                               
         CLI   CHOPDSN,C'Y'                                                     
         BNE   PTRL005                                                          
*                                                                               
* REMOVE LAST PORTION OF DSN (E.G. ".FIX", ".BKUP", ETC)                        
         LA    RF,DXTRLFID+L'DXTRLFID-1 DSN LAST CHAR                           
         CLI   0(RF),C'.'                                                       
         BE    *+12                                                             
         MVI   0(RF),C' '                                                       
         BCT   RF,*-12                                                          
         MVI   0(RF),C' '                                                       
*                                                                               
PTRL005  DS    0H                                                               
         MVC   DXTRLDLX(1),DELIM                                                
         MVC   DXTRLDLX+1(1),DELIM                                              
*                                                                               
         CLI   WRITE,C'Y'                                                       
         BNE   PTRLOK                                                           
         ICM   R6,15,SXDTXDCB                                                   
         AP    SXDTRNUM,=PL8'1'    BUMP RECORD NUMBER AND BYTE COUNT            
         SR    RF,RF                                                            
         ICM   RF,3,0(R2)                                                       
         CVD   RF,DUB                                                           
         AP    SXDTBNUM,DUB                                                     
         MVC   DXTRLNR-1(1),DELIM                                               
         EDIT  SXDTRNUM,(8,DXTRLNR),ZERO=NOBLANK,FILL=0                         
         MVC   DXTRLNB-1(1),DELIM                                               
         EDIT  SXDTBNUM,(10,DXTRLNB),ZERO=NOBLANK,FILL=0                        
         PUT   (R6),DXTRLD                                                      
         B     PTRLOK                                                           
*                                                                               
PTRLOK   SR    RC,RC                                                            
PTRLNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R2,R4                                                            
         EJECT                                                                  
***********************************************************************         
* SAVE LAST FILE GENERATION INFO ON LIST FOR SEGMENTED FILES          *         
* R4 = A(SYSTEM EXTRACT TABLE ENTRY)                                  *         
***********************************************************************         
         SPACE 1                                                                
         USING SXDTABD,R4                                                       
SVFLIST  NTR1  ,                                                                
         USING SXFLLSTD,R5                                                      
         ICM   RF,15,ASFNEXT                                                    
         ICM   R5,15,SXDTFLEA                                                   
         BZ    SVFL010                                                          
         STCM  RF,15,SXFLNEXT                                                   
         B     SVFL020                                                          
*                                                                               
SVFL010  STCM  RF,15,SXDTFLSA                                                   
*                                                                               
SVFL020  LR    R5,RF                                                            
         STCM  R5,15,SXDTFLEA                                                   
         MVC   SXFLGNUM,SXDTGNUM                                                
         MVC   SXFLDATE,DATENC                                                  
         MVC   SXFLTIME,TIMEND                                                  
         MVC   SXFLRNUM,SXDTRNUM                                                
         MVC   SXFLBNUM,SXDTBNUM                                                
         MVC   SXFLMTOT,SXDTMTOT                                                
         MVC   SXFLXDSN,SXDTXDSN                                                
         LA    R5,SXFLLSTL(R5)                                                  
         CLM   R5,15,=A(SFLISTX)                                                
         BL    *+6                                                              
         DC    H'0'                                                             
         STCM  R5,15,ASFNEXT                                                    
*                                                                               
SVFLOK   SR    RC,RC                                                            
SVFLNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R4                                                               
         SPACE 1                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* PROCESS SQL QUERY BOOK AND ADD RECORD TO EXTRACT FILE               *         
* R4 POINTS TO SYSTEM EXTRACT TABLE ENTRY                             *         
***********************************************************************         
         SPACE 1                                                                
         USING SXDTABD,R4                                                       
         DS    0D                                                               
PROCSQB  NMOD1 0,**PSQB**                                                       
         LR    RC,R1                                                            
         L     R7,VCPRINT                                                       
         MVC   P(16),=C'PROCESS SQL BOOK'                                       
         MVC   P+18(10),SQLBOOK                                                 
         GOTO1 VPRINTER                                                         
         MVC   AGYAID,SXDTAGY                                                   
         MVC   GENNUM,SXDTGNUM     SAVE FOR FORMSQLB RTN                        
         DROP  R4                                                               
         LAY   R3,IOL                                                           
         USING CTLREC,R3           R3=A(BOOK RECORD)                            
         XC    CTLKEY,CTLKEY                                                    
         MVI   CTLKTYP,CTLKTYPQ                                                 
         MVI   CTLKSCR,CTLKXTRQ                                                 
         MVC   CTLKNAME,SQLBOOK                                                 
*                                                                               
         L     RE,=V(UTL)          SWITCH TO CONTROL SYSTEM                     
         MVI   4(RE),CONTROLQ                                                   
*                                                                               
         L     RF,ACTFILE                                                       
         L     RF,ISPDKEY-ISDTF(,RF)                                            
         MVC   IOKEY,0(RF)         SAVE CURRENT CTFILE KEY                      
*                                                                               
PSQB010  EQU   *                                                                
         L     R4,=A(SQLWORK)                                                   
*                                  GET BOOK RECORD LINES                        
PSQB012  GOTO1 VGETBOOK,DMCB,(R3),WORK,VDATAMGR                                 
         LA    R1,DMCB                                                          
         TM    8(R1),X'80'         END OF BOOK                                  
         BO    PSQB100                                                          
         CLI   8(R1),0             OK                                           
         BE    PSQB020                                                          
         TM    8(R1),X'02'         DELETED - CAN IGNORE IT                      
         BO    PSQB012                                                          
         TM    8(R1),X'50'         DATAMGR ERROR - RECORD NOT FOUND             
         BNZ   PSQBER1                                                          
*                                                                               
PSQB020  CLI   WORK,C'*'           COMMENT LINE - IGNORE IT                     
         BE    PSQB012                                                          
         LA    RF,67(R4)                                                        
         L     RE,=A(SQLWORK)                                                   
         SR    RF,RE                                                            
         CLM   RF,15,=F'1000'                                                   
         BNL   PSQBER2                                                          
         MVC   0(67,R4),WORK                                                    
         LA    R4,67(R4)                                                        
         LA    RF,WORK                                                          
         LA    RF,67(RF)                                                        
         CLI   0(RF),C' '                                                       
         BNE   PSQB012                                                          
*                                                                               
         L     R2,AXREC                                                         
         USING DXSQLD,R2                                                        
         MVC   DXSQLLEN(2),=AL2(DXSQLDL)                                        
         MVC   DXSQLTYP,DXSQLDQ    ASSUME SQL BEFORE TYPE                       
         CLC   SQLBOOK,SQLBOOKB    SQL BOOK BEFORE?                             
         BE    *+10                                                             
         MVC   DXSQLTYP,DXSQADQ    SQL AFTER TYPE                               
         MVC   DXSQLRTY-1(1),DELIM                                              
         MVI   DXSQLRTY,C'S'                                                    
         MVC   DXSQLLIN-1(1),DELIM                                              
         BRAS  RE,FORMSQLB         CONVERT FORMULA IN SQL BUFFER                
         CLI   WRITE,C'Y'          WRITE EXTRACT RECORD TO FILE                 
         BNE   PSQB010                                                          
         GOTO1 =A(PUTXREC),DMCB,DXSQLD,ADXBLOCK                                 
         BNE   PSQBNO                                                           
         B     PSQB010                                                          
*                                                                               
PSQB100  GOTO1 VDATAMGR,DMCB,DMREAD,CTFILE,IOKEY,(R3),0 RESET READ SEQ          
*                                                                               
         L     RE,=V(UTL)          RESTORE SYSTEM SE NUMBER IN UTL              
         MVC   4(1,RE),SENUM                                                    
         B     PSQBOK                                                           
*                                                                               
PSQBER1  EQU   *                   ERROR EXIT                                   
         MVI   ERROR,ERSQLBRQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     PSQBNO                                                           
*                                                                               
PSQBER2  EQU   *                   ERROR EXIT                                   
         MVI   ERROR,ERSQLBOQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     PSQBNO                                                           
*                                                                               
PSQBOK   SR    RC,RC                                                            
PSQBNO   LTR   RC,RC                                                            
         XIT1                                                                   
         SPACE 1                                                                
***********************************************************************         
* CONVERT FORMULA IN SQL BUFFER                                       *         
* {AG} OR {AGENCY} - REPLACE WITH 2 CHARACTER AGENCY ALPHA ID         *         
* {AID} - REPLACE WITH AUTHID: DB2AUTHID=AUTHID OR SCHEMA=AUTHID CARD *         
* {TODAY}  - REPLACE WITH TODAY' DATE IN YYYYMMDD                     *         
* {GENNUM} - REPLACE WITH FILE GENERATION NUMBER                      *         
***********************************************************************         
         SPACE 1                                                                
FORMSQLB NTR1  ,                                                                
         SR    R6,R6                                                            
         LA    R5,DXSQLLIN                                                      
         L     R3,=A(SQLWORK)                                                   
*                                                                               
FSQL010  CR    R3,R4                                                            
         BNL   FSQL100                                                          
         CLI   0(R3),C'{'                                                       
         BE    FSQL030                                                          
*                                                                               
FSQL020  MVC   0(1,R5),0(R3)                                                    
         LA    R6,1(R6)                                                         
         LA    R5,1(R5)                                                         
         LA    R3,1(R3)                                                         
         B     FSQL010                                                          
*                                                                               
FSQL030  CLC   0(4,R3),=CL4'{AG}'                                               
         BNE   FSQL040                                                          
         MVC   0(2,R5),AGYAID                                                   
         LA    R3,4(R3)                                                         
         LA    R5,2(R5)                                                         
         LA    R6,2(R6)                                                         
         B     FSQL010                                                          
*                                                                               
FSQL040  CLC   0(8,R3),=CL8'{AGENCY}'                                           
         BNE   FSQL050                                                          
         MVC   0(2,R5),AGYAID                                                   
         LA    R3,8(R3)                                                         
         LA    R5,2(R5)                                                         
         LA    R6,2(R6)                                                         
         B     FSQL010                                                          
*                                                                               
FSQL050  CLC   0(5,R3),=CL5'{AID}'                                              
         BNE   FSQL060                                                          
         LA    R3,5(R3)                                                         
         LA    RF,DB2AUTH                                                       
         CLC   DB2AUTH,SPACES                                                   
         BNE   *+6                                                              
         DC    H'0'                                                             
         LA    R0,L'DB2AUTH                                                     
         LA    RF,DB2AUTH                                                       
FSQL052  EQU   *                                                                
         CLI   0(RF),C' '                                                       
         BE    FSQL054                                                          
         MVC   0(1,R5),0(RF)                                                    
         LA    R5,1(R5)                                                         
         LA    RF,1(RF)                                                         
         LA    R6,1(R6)                                                         
         BCT   R0,FSQL052                                                       
FSQL054  EQU   *                                                                
         B     FSQL010                                                          
*                                                                               
FSQL060  CLC   0(7,R3),=CL7'{TODAY}'                                            
         BNE   FSQL070                                                          
         MVC   0(8,R5),DATEN                                                    
         LA    R3,7(R3)                                                         
         LA    R5,8(R5)                                                         
         LA    R6,8(R6)                                                         
         B     FSQL010                                                          
*                                                                               
FSQL070  CLC   0(8,R3),=CL8'{GENNUM}'                                           
         BNE   FSQL020                                                          
         XR    RF,RF                                                            
         ICM   RF,3,GENNUM                                                      
         EDIT  (RF),(6,0(R5)),ZERO=NOBLANK,FILL=0                               
         LA    R3,8(R3)                                                         
         LA    R5,6(R5)                                                         
         LA    R6,6(R6)                                                         
         B     FSQL010                                                          
*                                                                               
FSQL100  EQU   *                                                                
         SR    RF,RF                                                            
         ICM   RF,3,DXSQLLEN                                                    
         AR    RF,R6                                                            
         STCM  RF,3,DXSQLLEN                                                    
         MVC   0(1,R5),DELIM                                                    
         MVC   1(1,R5),DELIM                                                    
         XIT1                                                                   
         DROP  R2,R3                                                            
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* ADD GENFIL ACTIVITY RECORD                                          *         
* R2 = A(RECORD)                                                      *         
***********************************************************************         
         SPACE 1                                                                
         DS    0D                                                               
SETACT   NMOD1 0,**SACT**                                                       
         LR    RC,R1                                                            
*                                                                               
         LA    R3,ELEMENT                                                       
         XC    ELEMENT,ELEMENT                                                  
         USING GACTELD,R3                                                       
         MVI   GACTEL,GACTELQ                                                   
         MVI   GACTLN,GACTLNQ                                                   
         MVC   GACTADT,DATENB                                                   
         MVC   GACTCDT,DATENB                                                   
*                                                                               
         GOTO1 VHELLO,DMCB,(C'P',GENFIL),(R2),ELEMENT,0                         
         CLI   12(R1),0                                                         
         BE    SACTOK                                                           
         LA    R0,14                                                            
         GOTO1 =A(DEQCTRL),(RC)    DEQUEUE CONTROL SYSTEM                       
         GOTO1 =A(CLOSCTFL),(RC)                                                
         MVI   ERROR,ERSACTQ                                                    
         GOTO1 =A(ERRPRT),(RC)                                                  
         ABEND 774,DUMP                                                         
*                                                                               
SACTOK   SR    RC,RC               EXIT OK                                      
SACTNO   LTR   RC,RC               EXIT ERROR                                   
         XIT1                                                                   
         DROP  R3                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* SET UP DATE AND TIME VALUES                                         *         
***********************************************************************         
         SPACE 1                                                                
         DS    0D                                                               
SDATIME  NMOD1 0,**SDTM**                                                       
         LR    RC,R1                                                            
         SR    R0,R0                                                            
         SR    R1,R1                                                            
*                                  GET THE CURRENT TIME IN BINARY               
TIME010  TIME  BIN                                                              
         LTR   RF,RF                                                            
         JNZ   *+2                 BAD RETURN FROM MACRO                        
         ST    R0,TIMENB                                                        
*                                                                               
         SR    R0,R0                                                            
         SR    R1,R1                                                            
*                                  GET THE CURRENT MVS DATE/TIME                
TIME020  TIME                                                                   
         LTR   RF,RF                                                            
         JNZ   *+2                 BAD RETURN FROM MACRO                        
         ST    R0,MVSTIME                                                       
         ST    R1,MVSDATE                                                       
*                                                                               
*                                  GET DATE NOW IN VARIOUS FORMATS              
         GOTO1 VDATCON,DMCB,(5,0),(20,DATEN)                                    
         GOTO1 VDATCON,DMCB,(5,0),(2,DATENC)                                    
         GOTO1 VDATCON,DMCB,(5,0),(3,DATENB)                                    
         OC    JDATE,JDATE                                                      
         BNZ   *+10                                                             
         MVC   JDATE,DATEN                                                      
*                                                                               
         L     R1,MVSTIME                                                       
         STCM  R1,15,TIMEND                                                     
*                                  CONVERT TIME NOW TO EBCDIC                   
         SRL   R1,28                                                            
         STC   R1,TIMEN                                                         
         OI    TIMEN,X'F0'                                                      
         L     R1,MVSTIME                                                       
         SRL   R1,24                                                            
         STC   R1,TIMEN+1                                                       
         OI    TIMEN+1,X'F0'                                                    
         L     R1,MVSTIME                                                       
         SRL   R1,20                                                            
         STC   R1,TIMEN+2                                                       
         OI    TIMEN+2,X'F0'                                                    
         L     R1,MVSTIME                                                       
         SRL   R1,16                                                            
         STC   R1,TIMEN+3                                                       
         OI    TIMEN+3,X'F0'                                                    
         L     R1,MVSTIME                                                       
         SRL   R1,12                                                            
         STC   R1,TIMEN+4                                                       
         OI    TIMEN+4,X'F0'                                                    
         L     R1,MVSTIME                                                       
         SRL   R1,8                                                             
         STC   R1,TIMEN+5                                                       
         OI    TIMEN+5,X'F0'                                                    
         L     R1,MVSTIME                                                       
         SRL   R1,4                                                             
         STC   R1,TIMEN+6                                                       
         OI    TIMEN+6,X'F0'                                                    
         L     R1,MVSTIME                                                       
         STC   R1,TIMEN+7                                                       
         OI    TIMEN+7,X'F0'                                                    
         OC    JTIME,JTIME                                                      
         BNZ   *+10                                                             
         MVC   JTIME,TIMEN                                                      
*                                                                               
*                                  CONVERT INPUT PARAMETER CARD                 
*                                    FILTER DATE/TIMES                          
*                                                                               
         GOTO1 VDATCON,DMCB,(3,XFDATE),(20,XFDATEE)                             
         GOTO1 VDATCON,DMCB,(3,XTDATE),(20,XTDATEE)                             
         GOTO1 VDATCON,DMCB,(3,XFDATE),(2,XFDATEC)                              
         GOTO1 VDATCON,DMCB,(3,XTDATE),(2,XTDATEC)                              
         GOTO1 VDATCON,DMCB,(3,XFDATE),(1,XFDATEP)                              
         GOTO1 VDATCON,DMCB,(3,XTDATE),(1,XTDATEP)                              
*                                                                               
         LA    R0,9                                                             
         GOTO1 VTIMBER,DMCB,(0,(R0)),(X'01',XFTIMEP),(1,WORK)                   
         CLI   0(R1),0                                                          
         BE    *+6                                                              
         DC    H'00'                                                            
         MVC   XFTIMEE(4),WORK                                                  
         MVC   XFTIMEE+4(2),=CL2'00'                                            
         MVC   XTTIMEE(4),WORK+5                                                
         MVC   XTTIMEE+4(2),=CL2'00'                                            
         B     SDATOK                                                           
*                                                                               
SDATOK   SR    RC,RC               EXIT OK                                      
SDATNO   LTR   RC,RC               EXIT ERROR                                   
         XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* PRINT OUT EXTRACT JOB RUN MODE REPORT                               *         
***********************************************************************         
         SPACE 1                                                                
         DS    0D                                                               
REPMODE  NMOD1 0,**RMOD**                                                       
         LR    RC,R1                                                            
         MVC   P,SPACES                                                         
         GOTO1 VPRINTER                                                         
         MVC   P(80),=CL80'EXTRACT JOB RUN TIME PARAMETERS'                     
         MVC   P+40(22),=C'DATE:           TIME: '                              
         MVC   P+46(8),DATEN                                                    
         MVC   P+62(8),TIMEN                                                    
         GOTO1 VPRINTER                                                         
RMODMOD  EQU   *                                                                
         MVC   P(20),=CL20'MODE:'                                               
         CLI   MODE,DXLOADQ                                                     
         BE    RMODLOD                                                          
         CLI   MODE,DXUPDTQ                                                     
         BE    RMODUPD                                                          
         CLI   MODE,DXPQRQ                                                      
         BE    RMODPQR                                                          
         CLI   MODE,DXSQLQ                                                      
         BE    RMODSQL                                                          
         CLI   MODE,DXSTATQ                                                     
         BE    RMODSTAT                                                         
         CLI   MODE,DXSTATCSQ                                                   
         BE    RMODSTAC                                                         
         B     RMODUNK                                                          
RMODLOD  MVC   P+20(60),=CL60'LOAD DATA FROM SYSTEM FILES'                      
         GOTO1 VPRINTER                                                         
         B     RMODTYP                                                          
RMODUPD  MVC   P+20(60),=CL60'UPDATE DATA FROM SYSTEM RECOVERY FILES'           
         GOTO1 VPRINTER                                                         
         B     RMODTYP                                                          
RMODPQR  MVC   P+20(60),=CL60'EXTRACT DATA FROM PQ REPORT REFORM'               
         GOTO1 VPRINTER                                                         
         B     RMODTYP                                                          
RMODSQL  MVC   P+20(60),=CL60'EXTRACT SQL STATEMENTS ONLY'                      
         GOTO1 VPRINTER                                                         
         B     RMODTYP                                                          
RMODSTAT MVC   P+20(60),=CL60'EXTRACT SQL STATISTICS'                           
         GOTO1 VPRINTER                                                         
         B     RMODTYP                                                          
RMODSTAC MVC   P+20(60),=CL60'EXTRACT SQL STATISTICS BUY COSTS (GER)'           
         GOTO1 VPRINTER                                                         
         B     RMODTYP                                                          
RMODUNK  MVC   P+20(60),=CL60'UNKNOWN'                                          
         GOTO1 VPRINTER                                                         
         B     RMODTYP                                                          
RMODTYP  EQU   *                                                                
         MVC   P(20),=CL20'TYPE:'                                               
         CLI   AUTOFLAG,ON                                                      
         BE    RMODAUT                                                          
         MVC   P+6(3),EXTYPE                                                    
         MVC   P+20(60),=CL60'OFFLINE EXTRACT USING SYSIN PARAMETERS'           
         GOTO1 VPRINTER                                                         
         B     RMODSTA                                                          
RMODAUT  MVC   P+20(60),=CL60'AUTOMATIC EXTRACT USING CONTROL XRECORDS'         
         GOTO1 VPRINTER                                                         
         CLI   MODE,DXUPDTQ                                                     
         BNE   RMODSTA                                                          
         MVC   P(40),=CL40'EXTRACT LOOP TIME:'                                  
         EDIT  TRAWLTIM,(10,P+30),ZERO=NOBLANK,ALIGN=LEFT                       
         MVC   P+42(30),=CL30'IN HUNDRETHS OF SECONDS'                          
         GOTO1 VPRINTER                                                         
         MVC   P(40),=CL40'EXTRACT RECOVERY SEARCH TIME:'                       
         EDIT  EXTRATIM,(10,P+30),ZERO=NOBLANK,ALIGN=LEFT                       
         MVC   P+42(30),=CL30'IN HUNDRETHS OF SECONDS'                          
         GOTO1 VPRINTER                                                         
         B     RMODSTA                                                          
         GOTO1 VPRINTER                                                         
         B     RMODOK                                                           
RMODSTA  EQU   *                                                                
         CLI   MODE,DXUPDTQ                                                     
         BNE   RMODCLO                                                          
         CLI   STARFLAG,C'Y'                                                    
         BNE   RMODCLO                                                          
         MVC   P(60),=CL60'START=YES HAS BEEN SET FOR THIS PASS'                
         GOTO1 VPRINTER                                                         
         B     RMODCLO                                                          
RMODCLO  EQU   *                                                                
         CLI   MODE,DXUPDTQ                                                     
         BNE   RMODTST                                                          
         CLI   CLOSFLAG,C'Y'                                                    
         BNE   RMODTST                                                          
         MVC   P(60),=CL60'CLOSE=YES HAS BEEN SET FOR THIS PASS'                
         GOTO1 VPRINTER                                                         
         B     RMODTST                                                          
RMODTST  EQU   *                                                                
         CLI   TSTFLAG,C'Y'                                                     
         BNE   RMODHDB                                                          
         MVC   P(60),=CL60'TST=YES HAS BEEN SET'                                
         GOTO1 VPRINTER                                                         
         B     RMODEND                                                          
RMODHDB  EQU   *                                                                
         CLI   HOSTDB,C'Y'                                                      
         BNE   RMODEND                                                          
         MVC   P(60),=CL60'HOSTDB=YES HAS BEEN SET'                             
         GOTO1 VPRINTER                                                         
         B     RMODEND                                                          
RMODEND  EQU   *                                                                
         GOTO1 VPRINTER                                                         
         B     RMODOK                                                           
*                                                                               
RMODOK   SR    RC,RC               EXIT OK                                      
RMODNO   LTR   RC,RC               EXIT ERROR                                   
         XIT1                                                                   
         LTORG                                                                  
                                                                                
***********************************************************************         
* PRINT OUT EXTRACT SYSTEM FILE REPORT                                *         
***********************************************************************         
         DS    0D                                                               
REPSYS   NMOD1 0,**RSYS**                                                       
         LR    RC,R1                                                            
         CLI   MODE,DXPQRQ         EXIT IF EXTRACT MODE = PQ REPORT             
         BE    RSYSOK                                                           
         L     R5,SXDTPTR          A(NEXT SYSTEM GROUP IN TABLE)                
         USING SXDTABD,R5                                                       
         MVC   P,SPACES                                                         
         GOTO1 VPRINTER                                                         
         MVI   MSGNUM,MSPROSFQ                                                  
         GOTO1 =A(MSGPRT),(RC)                                                  
*                                                                               
RSYSSYS  MVC   P(20),=CL20'SYSTEM:'                                             
         L     R3,=A(SYSLST)                                                    
         USING SYSLSTD,R3                                                       
         LA    R3,6(R3)            RF=A(SYSTEM LIST)                            
*                                                                               
RSYS010  CLI   0(R3),0             TEST E-O-T                                   
         BE    RSYS022                                                          
         CLC   SYSLNUM,SXDTSYS                                                  
         BE    RSYS030                                                          
RSYS020  LA    R3,SYSLLEN(R3)                                                   
         B     RSYS010                                                          
*                                                                               
RSYS022  L     R3,=A(SYSLST)                                                    
         LA    R3,6(R3)            RF=A(EXTENDED SYSTEM LIST)                   
*                                                                               
RSYS024  CLI   0(R3),0             TEST E-O-T                                   
         BE    RSYSOK                                                           
         CLC   SYSLNUM,SXDTSYS                                                  
         BE    RSYS030                                                          
RSYS026  LA    R3,SYSLLEN(R3)                                                   
         B     RSYS024                                                          
*                                                                               
RSYS030  MVC   P+8(L'SYSLNAME),SYSLNAME                                         
         CLI   SXDTSYS,X'0A'                                                    
         BE    RSYS100                                                          
         CLI   SXDTSYS,X'01'                                                    
         BE    RSYS100                                                          
* 11.25.2013 TZIH                                                               
* PRINTING FULL SYSTEM NAME (E.G. SPOTI2) INSTEAD OF 1 CHARACTER                
         MVC   P+20(14),=CL14'SE FILE NAME: '                                   
*        MVC   P+35(1),SXDTSCHR                                                 
         MVC   P+34(7),SYSLNAM                                                  
         MVC   P+42(10),=CL10'SE NUMBER:'                                       
         GOTO1 VHEXOUT,DMCB,SXDTSEN,P+55,1,=C'TOG'                              
*                                                                               
RSYS100  GOTO1 VPRINTER                                                         
         B     RSYSOK                                                           
*                                                                               
RSYSOK   SR    RC,RC               EXIT OK                                      
RSYSNO   LTR   RC,RC               EXIT ERROR                                   
         XIT1                                                                   
         DROP  R3,R5                                                            
         LTORG                                                                  
                                                                                
***********************************************************************         
* ENQUEUE CONTROL SYSTEM                                              *         
***********************************************************************         
         SPACE 1                                                                
         DS    0D                                                               
ENQCTRL  NMOD1 0,**ENQC**                                                       
         LR    RC,R1                                                            
         CLI   READOFLG,C'N'                                                    
         BE    ECTR002                                                          
         MVC   P(40),=CL40'INVALID UPDATES WITH READ=Y'                         
         GOTO1 VPRINTER                                                         
         DC    H'0'                                                             
ECTR002  EQU   *                                                                
         CLI   ENQCFLAG,C'Y'                                                    
         BE    ECTRLX                                                           
*                                                                               
         MVC   P(20),=CL20'ENQUEUE CONTROL:'                                    
         MVC   P+20(8),=CL8'DSKADDR='                                           
         GOTO1 VHEXOUT,DMCB,ADDRDA,P+28,4,=C'TOG'                               
         GOTO1 VPRINTER                                                         
*&&UK                                                                           
         L     RE,=V(UTL)          SWITCH TO CONTROL SYSTEM                     
         MVC   BYTE,4(RE)                                                       
         MVI   4(RE),CONTROLQ                                                   
         LAY   RF,IO                                                            
         GOTO1 VDATAMGR,DMCB,(X'80',GETREC),GENFIL,DAFST,(RF),DMWORK            
         L     RE,=V(UTL)          SWITCH BACK                                  
         MVC   4(1,RE),BYTE                                                     
*&&                                                                             
         MVC   ENQCMND,=C'ENQCTL  '                                             
         GOTO1 VDATAMGR,DMCBENQ,(0,ENQCMND),(C'T',=C'CTRL')                     
         TM    8(R1),X'01'                                                      
         BO    ECTR010             SYSTEM IS ALREADY ENQUEUED                   
         GOTO1 VDATAMGR,DMCBENQ,(0,ENQCMND),(C'E',=C'CTRL')                     
*                                                                               
ECTR010  MVI   ENQCFLAG,C'Y'                                                    
*                                                                               
*&&US*&& BRAS  RE,CHKCTFLS         CHECK IF DSPACE MATCH CTFILES                
*                                                                               
ECTRLX   XIT1                                                                   
DAFST    DC    X'00001101'                                                      
         LTORG                                                                  
                                                                                
***********************************************************************         
* DEQUEUE CONTROL SYSTEM                                              *         
***********************************************************************         
         DS    0D                                                               
DEQCTRL  NMOD1 0,**DEQC**                                                       
         LR    RC,R1                                                            
         CLI   ENQCFLAG,C'N'                                                    
         BE    DCTRLX                                                           
         MVC   P(20),=CL20'DEQUEUE CONTROL:'                                    
         MVC   P+20(8),=CL8'DSKADDR='                                           
         GOTO1 VHEXOUT,DMCB,ADDRDA,P+28,4,=C'TOG'                               
         GOTO1 VPRINTER                                                         
*                                                                               
         GOTO1 VDATAMGR,DMCBENQ,(0,ENQCMND),(C'D',=C'CTRL')                     
         MVI   ENQCFLAG,C'N'                                                    
*                                                                               
DCTRLX   XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
**********************************************************************          
* OPEN DATA MANAGER CONTROL FILE FOR UPDATE                          *          
**********************************************************************          
         DS    0D                                                               
*&&UK                                                                           
OPENCUPD NMOD1 0,**OCUP**                                                       
         LR    RC,R1                                                            
         CLI   CONSOPEN,C'Y'                                                    
         BE    OPENCUX                                                          
*                                                                               
         MVC   WORK(L'CTFILES),CTFILES CTFILE/GENDIR/GENFIL/CTRCVR=UPDT         
*                                                                               
         CLI   READOFLG,C'Y'       TEST READ-ONLY                               
         BE    OPCU010             YE, SKIP                                     
*                                                                               
         L     RE,=A(SSB)          NOT READONLY. CONTROL MAY BE UPDATED         
         TM    3(RE),X'02'         TEST NO OFFLINE RECOVERY                     
         BO    OPCU020             YES, SEE IF NEED CONTROL RECOVERY            
         B     OPCU030             ELSE MUST OPEN ALL FILES FOR UPDATE          
*                                                                               
OPCU010  MVI   WORK+(1-1)*8,C'N'   READ-ONLY. NO CONTROL UPDATES                
         MVI   WORK+(2-1)*8,C'N'   OPEN FILES READ-ONLY                         
         MVI   WORK+(3-1)*8,C'N'                                                
*                                                                               
OPCU020  MVI   WORK+(4-1)*8,C'X'   REMOVE CTRCVR                                
         CLI   SYSCODE,C'C'        IF NOT CONTROL SYSTEM EXTRACT                
         BNE   OPCU030                                                          
         CLI   MODE,DXLOADQ        OR MODE=LOAD CONTROL EXTRACT                 
         BE    OPCU030             WE DON'T NEED RECOVERY FILE                  
         MVI   WORK+(4-1)*8,C'N'   ELSE OPEN CTRCVR READ-ONLY                   
*                                                                               
OPCU030  LARL  RF,IOL                                                           
         GOTO1 VDATAMGR,DMCB,DMOPEN,CONTROL,WORK,(RF),0                         
*                                  GET DTF ADDRESS OF GENDIR                    
         GOTO1 VDATAMGR,DMCB,=C'DTFADR',GENDIR                                  
         ICM   RF,15,12(R1)                                                     
         BNZ   *+6                                                              
         DC    H'00'                                                            
         LA    RF,0(RF)                                                         
         ST    RF,AGENDIR                                                       
*                                  GET DTF ADDRESS OF GENFIL                    
         GOTO1 VDATAMGR,DMCB,=C'DTFADR',GENFIL                                  
         ICM   RF,15,12(R1)                                                     
         BNZ   *+6                                                              
         DC    H'00'                                                            
         LA    RF,0(RF)                                                         
         ST    RF,AGENFIL                                                       
*                                  GET DTF ADDRESS OF CTFILE                    
         GOTO1 VDATAMGR,DMCB,=C'DTFADR',CTFILE                                  
         ICM   RF,15,12(R1)                                                     
         BNZ   *+6                                                              
         DC    H'00'                                                            
         LA    RF,0(RF)                                                         
         ST    RF,ACTFILE                                                       
*                                                                               
         MVI   CONSOPEN,C'Y'                                                    
*                                                                               
OPENCUX  XIT1                                                                   
         LTORG                                                                  
CTFILES  DC    C'UCTFILE UGENDIR UGENFIL UCTRCVR X'                             
                                                                                
*&&                                                                             
*&&US                                                                           
OPENCUPD NMOD1 0,**OCUP**                                                       
         LR    RC,R1                                                            
         CLI   CONSOPEN,C'Y'                                                    
         BE    OPENCUX                                                          
*                                                                               
OPCU010  EQU   *                                                                
         CLI   READOFLG,C'Y'                                                    
         BE    OPCU020                                                          
         GOTO1 VDATAMGR,DMCB,DMOPEN,CONTROL,CTFILEU,AIOL,0                      
         B     OPCU030                                                          
*                                                                               
OPCU020  EQU   *                                                                
         CLI   MODE,DXLOADQ        TEST IF EXTRACT MODE = LOAD                  
         BE    OPCU023             YES - DON'T NEED RECOVERY FILE               
         GOTO1 VDATAMGR,DMCB,DMOPEN,CONTROL,CTFILES,AIOL,0                      
         B     OPCU030                                                          
OPCU023  GOTO1 VDATAMGR,DMCB,DMOPEN,CONTROL,CTFILESL,AIOL,0                     
*                                  GET DTF ADDRESS OF GENDIR                    
OPCU030  EQU   *                                                                
         GOTO1 VDATAMGR,DMCB,=C'DTFADR',GENDIR                                  
         ICM   RF,15,12(R1)                                                     
         BNZ   *+6                                                              
         DC    H'00'                                                            
         LA    RF,0(RF)                                                         
         ST    RF,AGENDIR                                                       
*                                  GET DTF ADDRESS OF GENFIL                    
         GOTO1 VDATAMGR,DMCB,=C'DTFADR',GENFIL                                  
         ICM   RF,15,12(R1)                                                     
         BNZ   *+6                                                              
         DC    H'00'                                                            
         LA    RF,0(RF)                                                         
         ST    RF,AGENFIL                                                       
*                                  GET DTF ADDRESS OF CTFILE                    
         GOTO1 VDATAMGR,DMCB,=C'DTFADR',CTFILE                                  
         ICM   RF,15,12(R1)                                                     
         BNZ   *+6                                                              
         DC    H'00'                                                            
         LA    RF,0(RF)                                                         
         ST    RF,ACTFILE                                                       
*                                                                               
         MVI   CONSOPEN,C'Y'                                                    
*                                                                               
OPENCUX  XIT1                                                                   
         LTORG                                                                  
                                                                                
*&&                                                                             
**********************************************************************          
* CLOSE DATA MANAGER CONTROL FILE                                    *          
**********************************************************************          
         DS    0D                                                               
CLOSCTFL NMOD1 0,**CCTF**                                                       
         LR    RC,R1                                                            
         CLI   CONSOPEN,C'N'                                                    
         BE    CLOSCTX                                                          
         L     RE,=V(UTL)          SWITCH TO CONTROL SYSTEM                     
         MVI   4(RE),CONTROLQ                                                   
         GOTO1 VDATAMGR,DMCB,DMCLSE,=C'FILES',,AIOL                             
         MVI   CONSOPEN,C'N'                                                    
*                                                                               
CLOSCTX  XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
*&&US                                                                           
**********************************************************************          
* CHKCTFLS - CHECK IF CTFILES/DSPACE VALUES MATCH                    *          
**********************************************************************          
*                                                                               
CHKCTFLS NTR1  BASE=*                                                           
*                                                                               
         BC    0,CHKCTX            FIRST TIME THROUGH, DON'T EXIT               
         MVI   *-3,X'F0'           ONLY CHECK CTFILE DSN'S ONCE                 
*                                                                               
         MVI   BYTE,0              BIT FLAGS FOR LIVE                           
         MVI   BYTE2,0             BIT FLAGS FOR TST                            
*                                                                               
         L     RF,=A(SSB)                                                       
         CLI   SSODSPAC-SSOOFF(RF),C'A'                                         
         BNE   *+8                                                              
         OI    BYTE,X'80'          DSPACE SET FOR LIVE                          
         CLI   SSODSPAC-SSOOFF(RF),C'R'                                         
         BNE   *+8                                                              
         OI    BYTE,X'80'          DSPACE SET FOR LIVE                          
         CLI   SSODSPAC-SSOOFF(RF),C'T'                                         
         BNE   *+8                                                              
         OI    BYTE2,X'80'         DSPACE SET FOR TST                           
*                                                                               
         CLI   SSODSPAC-SSOOFF(RF),C'N'                                         
         BNE   *+12                                                             
         OI    BYTE,X'88'          FOR DSPACE=N, ALLOW CTFILE OVERRIDE          
         OI    BYTE2,X'88'             BUT GENDIR&FIL+QDC MUST BE MATCH         
*                                                                               
         GOTO1 VDYNALOC,DMCB,(C'D',=CL8'DDSQDC'),CTDSN                          
         OC    CTDSN,SPACES                                                     
         CLC   =CL44'FAC.DDSQDC',CTDSN                                          
         BNE   *+8                                                              
         OI    BYTE,X'40'          QDC SET FOR LIVE                             
*&&US*&& CLC   =CL44'TST.DDSQDC',CTDSN                                          
*&&UK*&& CLC   =CL44'FAC.DDSQDC0',CTDSN                                         
         BNE   *+8                                                              
         OI    BYTE2,X'40'         QDC SET FOR TST                              
*                                                                               
         GOTO1 VDYNALOC,DMCB,(C'D',=CL8'GENDIR'),CTDSN                          
         OC    CTDSN,SPACES                                                     
         CLC   =CL44'CON.GENDIR',CTDSN                                          
         BNE   *+8                                                              
         OI    BYTE,X'20'          GENDIR SET FOR LIVE                          
         CLC   =CL44'CON.GENDIR0',CTDSN                                         
         BNE   *+8                                                              
         OI    BYTE2,X'20'         GENDIR SET FOR TST                           
         CLC   =CL44'TST.GENDIR',CTDSN                                          
         BNE   *+8                                                              
         OI    BYTE2,X'20'         GENDIR SET FOR TST                           
*                                                                               
         GOTO1 VDYNALOC,DMCB,(C'D',=CL8'GENFIL'),CTDSN                          
         OC    CTDSN,SPACES                                                     
         CLC   =CL44'CON.GENFIL',CTDSN                                          
         BNE   *+8                                                              
         OI    BYTE,X'10'          GENFIL SET FOR LIVE                          
         CLC   =CL44'CON.GENFIL0',CTDSN                                         
         BNE   *+8                                                              
         OI    BYTE2,X'10'         GENFIL SET FOR TST                           
         CLC   =CL44'TST.GENFIL',CTDSN                                          
         BNE   *+8                                                              
         OI    BYTE2,X'10'         GENFIL SET FOR TST                           
*                                                                               
         GOTO1 VDYNALOC,DMCB,(C'D',=CL8'CTFILE'),CTDSN                          
         OC    CTDSN,SPACES                                                     
         CLC   =CL44'CON.CTFILE',CTDSN                                          
         BNE   *+8                                                              
         OI    BYTE,X'08'          CTFILE SET FOR LIVE                          
         CLC   =CL44'CON.TSTFIL',CTDSN                                          
         BNE   *+8                                                              
         OI    BYTE2,X'08'         CTFILE SET FOR TST                           
         CLC   =CL44'TST.CTFILE',CTDSN                                          
         BNE   *+8                                                              
         OI    BYTE2,X'08'         CTFILE SET FOR TST                           
*                                                                               
         CLI   BYTE,B'11111000'                                                 
         BE    CHKCTX              GOOD - ALL LIVE FILES                        
         CLI   BYTE2,B'11111000'                                                
         BE    CHKCTX              GOOD - ALL TST FILES                         
*                                                                               
         CLI   BYTE,0                                                           
         BNE   CHKCTERR            ERROR - CTFILES/DSPACE NOT MATCH             
         CLI   BYTE2,0                                                          
         BNE   CHKCTERR            ERROR - CTFILES/DSPACE NOT MATCH             
         B     CHKCTX                                                           
*                                                                               
CHKCTERR GOTO1 =A(DEQCTRL),(RC)                                                 
         GOTO1 VDATAMGR,DMCB,=C'OPMSG',=C'AUTONOTE*US-MF_FAC_NOTIFY:CTF+        
               ILES - DSPACE MISMATCH!'                                         
         DC    H'0'                CTFILES/DSPACE NOT MATCH                     
*                                                                               
CHKCTX   XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
*&&                                                                             
*&&US                                                                           
**********************************************************************          
* PRTEOF  - PRINT OUT THE EOFS FROM THE DTF                          *          
**********************************************************************          
*                                                                               
PRTEOF   NTR1  BASE=*                                                           
*                                                                               
         BC    0,PRTEOF20          FIRST TIME THROUGH                           
         MVI   *-3,X'F0'           ONLY SAVE ADDRESSES FOR 1ST TIME             
*                                                                               
         GOTO1 VDDNAME,DMCB,=C'DDNAME',=C'SYS=CON  ',0                          
         ICM   RE,15,DMCB+8                                                     
         JZ    *+2                                                              
*                                                                               
         ICM   RE,15,DDNAASFL-DDNADATA(RE)                                      
         USING SYSFLSTD,RE                                                      
         SR    R0,R0                                                            
         SR    R2,R2                                                            
         ICM   R0,3,SYSF#FLS       NUMBER OF FILES                              
*                                                                               
         AHI   RE,SYSFLIST-SYSFLSTD                                             
PRTEOF02 DS    0H                                                               
         CLI   SYSFILE#,X'AE'      GENDIR?                                      
         JE    PRTEOF08                                                         
PRTEOF04 CLI   SYSFILE#,X'AF'      GENFIL?                                      
         JE    PRTEOF09                                                         
PRTEOF05 AHI   RE,SYSFLNQ                                                       
         JCT   R0,PRTEOF02                                                      
*                                  DO WE HAVE ALL ADDRESSES WE NEEDED?          
         OC    ADNEXT,ADNEXT                                                    
         JZ    *+2                                                              
         OC    AOVLAST,AOVLAST                                                  
         JZ    *+2                                                              
         OC    APDLAST,APDLAST                                                  
         JZ    *+2                                                              
         J     PRTEOF20                                                         
*                                                                               
PRTEOF08 ICM   R2,7,SYSFADTF        GENDIR, IS FILE                             
         USING ISDTF,R2                                                         
         LAY   R1,ISOVLAST                                                      
         ST    R1,AOVLAST                                                       
         LAY   R1,ISPDLAST                                                      
         ST    R1,APDLAST                                                       
         J     PRTEOF05                                                         
PRTEOF09 ICM   R2,7,SYSFADTF        GENFIL, DA FILE                             
         USING DTFPHD,R2                                                        
         LAY   R1,DNEXT                                                         
         ST    R1,ADNEXT                                                        
         J     PRTEOF05                                                         
         DROP  RE,R2                                                            
*                                                                               
PRTEOF20 DS    0H                                                               
         L     R2,AOVLAST                                                       
         GOTO1 VHEXOUT,DMCB,(R2),EOFLOVL,4,=C'TOG'                              
         L     R2,APDLAST                                                       
         GOTO1 VHEXOUT,DMCB,(R2),EOFLPDL,4,=C'TOG'                              
         L     R2,ADNEXT                                                        
         GOTO1 VHEXOUT,DMCB,(R2),EOFLDNXT,4,=C'TOG'                             
         MVC   P+20(EOFLINEQ),EOFLINE                                           
         GOTO1 VPRINTER                                                         
*                                                                               
PRTEOFX  XIT1                                                                   
EOFLINE  DC    0C                                                               
         DC    C'GENDIR: OVLAST='                                               
EOFLOVL  DC    C'XXXXXXXX'                                                      
         DC    C' PDLAST='                                                      
EOFLPDL  DC    C'XXXXXXXX'                                                      
         DC    C'  GENFIL: DNEXT='                                              
EOFLDNXT DC    C'XXXXXXXX'                                                      
EOFLINEQ EQU   *-EOFLINE                                                        
         LTORG                                                                  
         EJECT                                                                  
*&&                                                                             
***********************************************************************         
* GET AGENCY ACCESS RECORD DATA FROM CONTROL FILE                     *         
***********************************************************************         
         DS    0D                                                               
GETACC   NMOD1 0,**GACC**                                                       
         LR    RC,R1                                                            
         LAY   R3,IOL                                                           
         USING CT5REC,R3           R3=A(RECORD)                                 
         XC    CT5KEY,CT5KEY                                                    
         MVI   CT5KTYP,CT5KTYPQ                                                 
         MVC   CT5KALPH,AGYAID                                                  
         GOTO1 VDATAMGR,DMCB,DMREAD,CTFILE,CT5REC,CT5REC                        
         CLI   8(R1),0                                                          
         BE    GACC010                                                          
         CLI   8(R1),X'10'                                                      
         BE    GACCNO                                                           
         DC    H'0'                DIE IF IO ERROR                              
*                                                                               
GACC010  LA    R3,CT5DATA          FIND SYSTEM ELEMENT ON RECORD                
         MVI   BYTE,0              FLAG FOR SYSTEM ELEMENT                      
         SR    R0,R0                                                            
GACC020  CLI   0(R3),0             TEST E-O-R                                   
         BE    GACC100                                                          
*                                                                               
         CLI   0(R3),X'02'         TEST PRINCIPLE ID ELEMENT                    
         BNE   *+14                                                             
         MVC   AGYPIN,2(R3)        SAVE PRINCIPLE ID NUMBER                     
         B     GACC030                                                          
*                                                                               
         CLI   0(R3),CTSYSELQ      TEST SYSTEM ELEMENT                          
         BE    GACC040                                                          
*                                                                               
         CLI   0(R3),CTAGDELQ      AGENCY DETAILS ELEMENT                       
         BE    GACC050                                                          
*                                                                               
         CLI   0(R3),CTSEAELQ      X'B8' SECURITY AGENCY ALPHA ID ELEM          
         BNE   GACC030                                                          
         MVC   AGYSAVE,CTSEAAID-CTSEAD(R3)                                      
*                                                                               
GACC030  IC    R0,1(R3)                                                         
         AR    R3,R0                                                            
         B     GACC020                                                          
*                                                                               
         USING CTSYSD,R3                                                        
GACC040  CLC   CTSYSNUM,SYSTEM     MATCH SYSTEM NUMBER                          
         BNE   GACC030                                                          
         MVI   BYTE,X'FF'          FLAG SYSTEM ELEMENT FOUND                    
         MVC   SENUM,CTSYSSE                                                    
         MVC   AGYBIN,CTSYSAGB                                                  
         B     GACC030                                                          
*                                                                               
         USING CTAGDD,R3                                                        
GACC050  CLI   CTAGDLEN,CTAGDLNQ                                                
         BNH   GACC030                                                          
         MVC   AGYCNTRY,CTAGDCTY                                                
         TM    CTAGOPTS,CTAGUAT                                                 
         BZ    *+8                                                              
         OI    SVFLAG,SVFUATQ                                                   
         B     GACC030                                                          
*                                                                               
GACC100  CLI   BYTE,X'FF'          CHECK SYSTEM ELEMENT FOUND                   
         BE    GACCOK                                                           
*                                                                               
GACC110  CLI   SYSTEM,1            TEST FOR SERVICE SYSTEM EXTRACT              
         BE    GACC120                                                          
         CLI   SYSTEM,X'FF'        TEST FOR PQ SYSTEM EXTRACT                   
         BE    GACC120                                                          
         CLI   SYSTEM,X'FE'        TEST FOR WORKER SYSTEM EXTRACT               
         BE    GACC120                                                          
         B     GACCNO              ELSE EXIT WITH ERROR                         
GACC120  MVC   SENUM,SYSTEM                                                     
         XC    AGYBIN,AGYBIN                                                    
         B     GACCOK                                                           
*                                                                               
GACCOK   SR    RC,RC                                                            
GACCNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R3                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* SET SYSTEM CODE FROM SYSTEM LIST RECORD                             *         
***********************************************************************         
         DS    0D                                                               
GETSYL   NMOD1 0,**GSYL**                                                       
         LR    RC,R1                                                            
         LAY   R3,IOL                                                           
         USING CTWREC,R3           R3=A(RECORD)                                 
         XC    CTWKEY,CTWKEY       READ SPECIFIC SYSTEM SYSLIST RECORD          
         MVI   CTWKTYP,C'W'        IF PRESENT                                   
         MVI   CTWKREC,C'S'                                                     
         MVC   CTWKSYSN,SYSTEM                                                  
         GOTO1 VDATAMGR,DMCB,DMREAD,CTFILE,CTWREC,CTWREC                        
         CLI   8(R1),0                                                          
         BNE   GSYL010                                                          
*                                                                               
         LA    R3,CTWDATA          FIND SYSTEM ELEMENT ON RECORD                
         USING SYSELD,R3           R3=A(FIRST ELEMENT)                          
         SR    R0,R0                                                            
GSYL002  CLI   SYSEL,0             TEST E-O-R                                   
         BE    GSYL010                                                          
         CLI   SYSEL,SYSELQ                                                     
         BNE   GSYL004                                                          
         CLC   SYSSYS,SYSTEM       MATCH SYSTEM NUMBER                          
         BNE   GSYL004                                                          
         CLC   SYSSEN,SENUM        MATCH SYSTEM SE NUMBER                       
         BE    GSYL030                                                          
GSYL004  IC    R0,SYSLEN                                                        
         AR    R3,R0                                                            
         B     GSYL002                                                          
*                                                                               
GSYL010  LAY   R3,IOL                                                           
         USING CTWREC,R3           R3=A(RECORD)                                 
         XC    CTWKEY,CTWKEY       READ DEFAULT SYSTEM SYSLIST RECORD           
         MVI   CTWKTYP,C'W'                                                     
         MVI   CTWKREC,C'S'                                                     
         GOTO1 VDATAMGR,DMCB,DMREAD,CTFILE,CTWREC,CTWREC                        
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                DIE IF CANT READ RECORD                      
*                                                                               
         LA    R3,CTWDATA          FIND SYSTEM ELEMENT ON RECORD                
         USING SYSELD,R3           R3=A(FIRST ELEMENT)                          
         SR    R0,R0                                                            
GSYL012  CLI   SYSEL,0             TEST E-O-R                                   
         BE    GSYL100                                                          
         CLI   SYSEL,SYSELQ                                                     
         BNE   GSYL020                                                          
         CLC   SYSSYS,SYSTEM       MATCH SYSTEM NUMBER                          
         BNE   GSYL020                                                          
         CLC   SYSSEN,SENUM        MATCH SYSTEM SE NUMBER                       
         BE    GSYL030                                                          
GSYL020  IC    R0,SYSLEN                                                        
         AR    R3,R0                                                            
         B     GSYL012                                                          
*                                                                               
GSYL030  MVC   SYSLNAM,SYSNAME     SAVE LOGICAL SYSTEM NAME                     
         MVI   SYSCHAR,C'0'        DEFAULT VALUE FOR SINGLE SYSTEMS             
         LA    RE,SNUMLIST         GET SYSTEM FILE CODE                         
         CLI   SYSNUM,0                                                         
         BE    GSYL034                                                          
         CLI   SYSNUM,36                                                        
         BH    GSYL034                                                          
         ZIC   R1,SYSNUM                                                        
GSYL032  CLI   0(RE),0             TEST E-O-L                                   
         BE    GSYLNO                                                           
         LA    RE,1(RE)                                                         
         BCT   R1,GSYL032                                                       
         MVC   SYSCHAR,0(RE)       CONVERT SENUM TO CHAR                        
         DROP  R3                                                               
*                                                                               
GSYL034  L     R3,=A(SYSLST)                                                    
         USING SYSLSTD,R3                                                       
         LA    R3,6(R3)            R3=A(SYSTEM LIST)                            
*                                                                               
GSYL040  CLI   0(R3),0             TEST E-O-T                                   
         BE    GSYLNO                                                           
         CLC   SYSLNUM,SYSTEM                                                   
         BE    GSYL044                                                          
GSYL042  LA    R3,SYSLLEN(R3)      NO - BUMP TO NEXT TABLE ENTRY                
         B     GSYL040                                                          
*                                                                               
GSYL044  MVC   SYSCODE,SYSLRPLT    RETURN SYSTEM CODE                           
*&&US                                                                           
         CLI   SYSLNUM,X'03'       OVERRIDE FOR NET SYSTEM                      
         BNE   *+8                                                              
         MVI   SYSCODE,C'N'                                                     
*&&                                                                             
         CLI   SYSTEM,1            TEST FOR SERVICE SYSTEM                      
         BNE   *+8                                                              
         MVI   SYSCODE,C'0'        OVERRIDE BLANK                               
         B     GSYLOK                                                           
*                                                                               
GSYL100  L     R3,=A(SYSLEX)       EXTENDED SYSTEM LIST                         
         USING SYSLSTD,R3                                                       
         LA    R3,6(R3)            R3=A(SYSTEM LIST)                            
*                                                                               
GSYL110  CLI   0(R3),0             TEST E-O-T                                   
         BE    GSYLNO                                                           
         CLC   SYSLNUM,SYSTEM                                                   
         BE    GSYL130                                                          
GSYL120  LA    R3,SYSLLEN(R3)      NO - BUMP TO NEXT TABLE ENTRY                
         B     GSYL110                                                          
*                                                                               
GSYL130  MVC   SYSCODE,SYSLRPLT    RETURN SYSTEM CODE                           
         MVC   SYSCHAR,SYSCODE                                                  
         MVC   SYSLNAM,SYSLNAME                                                 
         B     GSYLOK                                                           
*                                                                               
GSYLOK   SR    RC,RC                                                            
GSYLNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R3                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* INITIALISE HOST DATABASE ACCESS                                     *         
***********************************************************************         
         DS    0D                                                               
INITHDB  NMOD1 0,**IHDB**                                                       
         LR    RC,R1                                                            
         CLI   HOSTDB,C'Y'                                                      
         BNE   IHDBOK                                                           
         MVC   P(80),=CL80'INITIALISING HOST DATABASE INTERFACE'                
         GOTO1 VPRINTER                                                         
         MVC   WORK,SPACES                                                      
         LA    R3,WORK                                                          
         MVC   0(8,R3),=CL8'DXUDB'                                              
         LOAD  EPLOC=(3)                                                        
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         STCM  R0,15,ADXUDB                                                     
         B     IHDBOK                                                           
*                                                                               
IHDBOK   SR    RC,RC                                                            
IHDBNO   LTR   RC,RC                                                            
         XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* OPEN HOST DATABASE CONNECTION                                       *         
***********************************************************************         
         DS    0D                                                               
OPENHDB  NMOD1 0,**OHDB**                                                       
         LR    RC,R1                                                            
         CLI   HOSTDB,C'Y'                                                      
         BNE   OHDBOK                                                           
*                                                                               
         MVC   P(80),=CL80'OPENING HOST DATABASE INTERFACE'                     
         GOTO1 VPRINTER                                                         
*                                                                               
         L     RF,ADXBLOCK                                                      
         USING DXBLOCKD,RF                                                      
         MVC   DXDBSSYS,DB2SSYS                                                 
* ??     MVC   DXDBID,HDBID                                                     
         MVC   DXDBAUTH,DB2AUTH                                                 
         MVC   DXDBLOCN,DB2LOCN                                                 
         DROP  RF                                                               
*                                                                               
         LA    R4,DXUDBPAR                                                      
         USING DXUDBD,R4                                                        
         XC    DXUDBPAR,DXUDBPAR                                                
         MVC   DXUPADXB,ADXBLOCK                                                
         MVC   DXUPIFCD,=AL1(DXUPIOPQ)                                          
         ICM   RF,15,AUDBMSG                                                    
         STCM  RF,15,DXUPSBLK                                                   
         MVC   0(2,RF),=AL2(UDBMSGLQ)                                           
         GOTO1 ADXUDB,DXUDBPAR                                                  
         SAM24                                                                  
         OC    DXUPRCDS,DXUPRCDS                                                
         BZ    OHDB100                                                          
         GOTO1 =A(WLOGHDB)                                                      
         B     OHDBNO                                                           
*                                                                               
OHDB100  EQU   *                                                                
         MVC   P(80),=CL80'OPENED HOST DATABASE OK'                             
         GOTO1 VPRINTER                                                         
         B     OHDBOK                                                           
*                                                                               
OHDBOK   SR    RC,RC                                                            
OHDBNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R4                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* CLOSE HOST DATABASE CONNECTION                                      *         
***********************************************************************         
         DS    0D                                                               
CLOSHDB  NMOD1 0,**CHDB**                                                       
         LR    RC,R1                                                            
         CLI   HOSTDB,C'Y'                                                      
         BNE   CHDBOK                                                           
*                                                                               
         MVC   P(80),=CL80'CLOSING HOST DATABASE'                               
         GOTO1 VPRINTER                                                         
*                                                                               
         LA    R4,DXUDBPAR                                                      
         USING DXUDBD,R4                                                        
         XC    DXUDBPAR,DXUDBPAR                                                
         MVC   DXUPADXB,ADXBLOCK                                                
         MVC   DXUPIFCD,=AL1(DXUPICLQ)                                          
         ICM   RF,15,AUDBMSG                                                    
         STCM  RF,15,DXUPSBLK                                                   
         MVC   0(2,RF),=AL2(UDBMSGLQ)                                           
         GOTO1 ADXUDB,DXUDBPAR                                                  
         SAM24                                                                  
         OC    DXUPRCDS,DXUPRCDS                                                
         BZ    CHDB100                                                          
         GOTO1 =A(WLOGHDB)                                                      
         B     CHDBNO                                                           
*                                                                               
CHDB100  EQU   *                                                                
         MVC   P(80),=CL80'CLOSED HOST DATABASE OK'                             
         GOTO1 VPRINTER                                                         
         B     CHDBOK                                                           
*                                                                               
CHDBOK   SR    RC,RC                                                            
CHDBNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R4                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* UPDATE HOST DATABASE                                                *         
***********************************************************************         
         DS    0D                                                               
UPDTHDB  NMOD1 0,**UHDB**                                                       
         LR    RC,R1                                                            
         CLI   HOSTDB,C'Y'                                                      
         BNE   UHDBOK                                                           
         CLI   UPDFLAG,C'N'                                                     
         BE    UHDBOK                                                           
*                                                                               
         L     RF,ADXBLOCK                                                      
         USING DXBLOCKD,RF                                                      
         CLC   DXDBID,SPACES                                                    
         BE    UHDBOK                                                           
         DROP  RF                                                               
*                                                                               
         ICM   RF,15,HDBCOUNT                                                   
         LA    RE,1                                                             
         AR    RF,RE                                                            
         STCM  RF,15,HDBCOUNT                                                   
         ICM   RF,15,HDBINC                                                     
         AR    RF,RE                                                            
         STCM  RF,15,HDBINC                                                     
         LA    RE,1000                                                          
         CR    RF,RE                                                            
         BL    UHDB010                                                          
         XC    HDBINC,HDBINC                                                    
         MVC   P(80),=CL80'UPDATING HOST DATABASE RECORD NUMBER: '              
         EDIT  HDBCOUNT,(9,P+39),ZERO=NOBLANK,FILL=0                            
         GOTO1 VPRINTER                                                         
*                                                                               
UHDB010  LA    R4,DXUDBPAR                                                      
         USING DXUDBD,R4                                                        
         XC    DXUDBPAR,DXUDBPAR                                                
         STCM  R3,15,DXUPAREC                                                   
         MVC   DXUPADXB,ADXBLOCK                                                
         MVC   DXUPIFCD,=AL1(DXUPIUPQ)                                          
         ICM   RF,15,AUDBMSG                                                    
         STCM  RF,15,DXUPSBLK                                                   
         MVC   0(2,RF),=AL2(UDBMSGLQ)                                           
         GOTO1 ADXUDB,DXUDBPAR                                                  
         SAM24                                                                  
         OC    DXUPRCDS,DXUPRCDS                                                
         BZ    UHDB100                                                          
*                                                                               
         L     RF,ADXBLOCK         GET ADDRESS SYSTEM CONTROL BLOCK             
         USING DXBLOCKD,RF                                                      
         L     RF,DXSTPTR                                                       
         DROP  RF                                                               
         USING SXDTABD,RF                                                       
         OI    SXDTFLG2,SXDTFUEQ   SET UPDATE ERROR OCCURRED                    
         DROP  RF                                                               
*                                                                               
         OI    HDBSTATE,HDBSUPEQ   SET UPDATE ERROR OCCURRED                    
*                                                                               
         GOTO1 =A(WLOGHDB)                                                      
*                                                                               
         CLI   UDBERR,C'Y'         WRITE SQL ERROR STATEMENTS OUT               
         BNE   UHDBOK                                                           
         CLC   DXUPRCDS(2),=YL2(999)                                            
         BNE   UHDBOK                                                           
         L     R6,=A(UDBERRD)                                                   
         ICM   R5,15,DXUPASQL                                                   
         BNZ   *+6                                                              
         DC    H'0'                                                             
         SR    RE,RE                                                            
         ICM   RE,3,0(R5)                                                       
         CHI   RE,4                                                             
         BL    UHDBOK                                                           
         PUT   (R6),(R5)                                                        
         CLI   CONTFLG,C'N'                                                     
         BE    UHDBOK                                                           
*                                                                               
UHDB100  EQU   *                                                                
         CLI   SQLOUT,C'Y'         WRITE SQL STATEMENTS OUT                     
         BNE   UHDBOK                                                           
         L     R6,=A(SQLOUTD)                                                   
         ICM   R5,15,DXUPASQL                                                   
         BNZ   *+6                                                              
         DC    H'0'                                                             
         SR    RE,RE                                                            
         ICM   RE,3,0(R5)                                                       
         CHI   RE,4                                                             
         BL    UHDBOK                                                           
         PUT   (R6),(R5)                                                        
         B     UHDBOK                                                           
*                                                                               
UHDBOK   SR    RC,RC                                                            
UHDBNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R4                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* COMMIT LAST CHANGES                                                 *         
***********************************************************************         
         SPACE 1                                                                
         DS    0D                                                               
COMMHDB  NMOD1 0,**CMHD**                                                       
         LR    RC,R1                                                            
         CLI   HOSTDB,C'Y'                                                      
         BNE   COHDOK                                                           
*                                                                               
         L     RF,ADXBLOCK         GET ADDRESS SYSTEM CONTROL BLOCK             
         USING DXBLOCKD,RF                                                      
         L     RF,DXSTPTR                                                       
         DROP  RF                                                               
         USING SXDTABD,RF                                                       
*                                                                               
         CLI   CONTFLG,C'Y'                                                     
         BE    *+12                                                             
         TM    SXDTFLG2,SXDTFUEQ   TEST UPDATE ERROR OCCURRED                   
         BNZ   COHD100                                                          
*                                                                               
         DROP  RF                                                               
         CLI   COMFLAG,C'N'                                                     
         BE    COHD100                                                          
*                                                                               
         MVC   P(80),=CL80'COMMITING HOST DATABASE RECORD NUMBER: '             
         EDIT  HDBCOUNT,(9,P+41),ZERO=NOBLANK,FILL=0                            
         GOTO1 VPRINTER                                                         
*                                                                               
         LA    R4,DXUDBPAR                                                      
         USING DXUDBD,R4                                                        
         XC    DXUDBPAR,DXUDBPAR                                                
         MVC   DXUPADXB,ADXBLOCK                                                
         MVC   DXUPIFCD,=AL1(DXUPICMQ)                                          
         ICM   RF,15,AUDBMSG                                                    
         STCM  RF,15,DXUPSBLK                                                   
         MVC   0(2,RF),=AL2(UDBMSGLQ)                                           
         GOTO1 ADXUDB,DXUDBPAR                                                  
         SAM24                                                                  
         OC    DXUPRCDS,DXUPRCDS                                                
         BZ    COHDOK                                                           
         GOTO1 =A(WLOGHDB)                                                      
         B     COHDOK                                                           
*                                                                               
COHD100  EQU   *                                                                
         LA    R4,DXUDBPAR                                                      
         USING DXUDBD,R4                                                        
         XC    DXUDBPAR,DXUDBPAR                                                
         MVC   DXUPADXB,ADXBLOCK                                                
         MVC   DXUPIFCD,=AL1(DXUPIRBQ)                                          
         ICM   RF,15,AUDBMSG                                                    
         STCM  RF,15,DXUPSBLK                                                   
         MVC   0(2,RF),=AL2(UDBMSGLQ)                                           
         GOTO1 ADXUDB,DXUDBPAR                                                  
         SAM24                                                                  
         OC    DXUPRCDS,DXUPRCDS                                                
         BZ    COHDOK                                                           
         GOTO1 =A(WLOGHDB)                                                      
         B     COHDOK                                                           
*                                                                               
COHDOK   SR    RC,RC                                                            
COHDNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R4                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* WRITE EXTRACT DATA AND UPDATE LOG                                   *         
***********************************************************************         
         SPACE 1                                                                
         DS    0D                                                               
LOGHDB   NMOD1 0,**LOHD**                                                       
         LR    RC,R1                                                            
         CLI   HOSTDB,C'Y'                                                      
         BNE   LOHDOK                                                           
         CLI   MODE,DXTRANSQ       TEST IF EXTRACT MODE = TRANS UPDATE          
         BE    LOHD100                                                          
*                                                                               
         MVC   P(80),=CL80'LOGGING HOST DATABASE'                               
         GOTO1 VPRINTER                                                         
*                                                                               
         L     RF,ADXBLOCK         GET ADDRESS SYSTEM CONTROL BLOCK             
         USING DXBLOCKD,RF                                                      
         L     RF,DXSTPTR                                                       
         DROP  RF                                                               
         USING SXDTABD,RF                                                       
* ??     TM    SXDTFLG2,SXDTFUEQ   TEST UPDATE ERROR OCCURRED                   
* ??     BNZ   LOHDOK                                                           
         DROP  RF                                                               
* ??     CLI   COMFLAG,C'N'                                                     
* ??     BE    LOHDOK                                                           
*                                                                               
         LA    R4,DXUDBPAR                                                      
         USING DXUDBD,R4                                                        
         XC    DXUDBPAR,DXUDBPAR                                                
         MVC   DXUPADXB,ADXBLOCK                                                
         MVC   DXUPIFCD,=AL1(DXUPIXLQ)                                          
         ICM   RF,15,AUDBMSG                                                    
         STCM  RF,15,DXUPSBLK                                                   
         MVC   0(2,RF),=AL2(UDBMSGLQ)                                           
         GOTO1 ADXUDB,DXUDBPAR                                                  
         SAM24                                                                  
         OC    DXUPRCDS,DXUPRCDS                                                
         BZ    LOHD100                                                          
         GOTO1 =A(WLOGHDB)                                                      
         B     LOHDOK                                                           
*                                                                               
LOHD100  EQU   *                                                                
         CLI   UPDFLAG,C'N'                                                     
         BE    LOHDOK                                                           
         L     RF,ADXBLOCK         GET ADDRESS SYSTEM CONTROL BLOCK             
         USING DXBLOCKD,RF                                                      
         CLC   DXDBID,SPACES                                                    
         BE    LOHDOK                                                           
         L     RF,DXSTPTR                                                       
         DROP  RF                                                               
         USING SXDTABD,RF                                                       
* ??     TM    SXDTFLG2,SXDTFUEQ   TEST UPDATE ERROR OCCURRED                   
* ??     BNZ   LOHDOK                                                           
         DROP  RF                                                               
*                                                                               
         LA    R4,DXUDBPAR                                                      
         USING DXUDBD,R4                                                        
         XC    DXUDBPAR,DXUDBPAR                                                
         MVC   DXUPADXB,ADXBLOCK                                                
         MVC   DXUPIFCD,=AL1(DXUPIULQ)                                          
         ICM   RF,15,AUDBMSG                                                    
         STCM  RF,15,DXUPSBLK                                                   
         MVC   0(2,RF),=AL2(UDBMSGLQ)                                           
         GOTO1 ADXUDB,DXUDBPAR                                                  
         SAM24                                                                  
         OC    DXUPRCDS,DXUPRCDS                                                
         BZ    LOHDOK                                                           
         GOTO1 =A(WLOGHDB)                                                      
         B     LOHDOK                                                           
*                                                                               
LOHDOK   SR    RC,RC                                                            
LOHDNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R4                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* BUILD EXTRACT RECOVERY LOG DATA                                     *         
***********************************************************************         
         SPACE 1                                                                
         DS    0D                                                               
BRLHDB   NMOD1 0,**BRHD**                                                       
         LR    RC,R1                                                            
         CLI   HOSTDB,C'Y'                                                      
         BNE   BRHDOK                                                           
*                                                                               
         CLI   AUTOFLAG,OFF                                                     
         BE    BRHDOK                                                           
         CLI   DAILYFLG,ON                                                      
         BE    BRHDOK                                                           
*                                                                               
BRHD010  EQU   *                                                                
*                                                                               
         MVC   P(80),=CL80'BUILDING RECOVERY HOST DATABASE'                     
         GOTO1 VPRINTER                                                         
*                                                                               
         L     R5,ADXBLOCK         GET ADDRESS SYSTEM CONTROL BLOCK             
         USING DXBLOCKD,R5                                                      
         L     R3,DXSTPTR                                                       
         USING SXDTABD,R3                                                       
* ??     TM    SXDTFLG2,SXDTFUEQ   TEST UPDATE ERROR OCCURRED                   
* ??     BNZ   BRHDOK                                                           
*                                                                               
         L     R6,SXDTDBXT                                                      
         USING SXDBEXTD,R6                                                      
         CLI   STARFLAG,C'Y'       TEST IF START FLAG IS ON                     
         BNE   BRHD020                                                          
         XC    DXTDA,DXTDA         CLEAR EXISTING SYSTEM LOG RECORDS            
         B     BRHDOK                                                           
*                                                                               
BRHD020  EQU   *                                                                
         LA    R4,DXUDBPAR                                                      
         USING DXUDBD,R4                                                        
         XC    DXUDBPAR,DXUDBPAR                                                
         MVC   DXUPADXB,ADXBLOCK                                                
         MVC   DXUPIFCD,=AL1(DXUPIBRQ)                                          
         ICM   RF,15,AUDBMSG                                                    
         STCM  RF,15,DXUPSBLK                                                   
         MVC   0(2,RF),=AL2(UDBMSGLQ)                                           
         GOTO1 ADXUDB,DXUDBPAR                                                  
         SAM24                                                                  
         OC    DXUPRCDS,DXUPRCDS                                                
         BZ    BRHD100                                                          
         GOTO1 =A(WLOGHDB)                                                      
         DC    H'0'                                                             
         B     BRHDOK                                                           
*                                                                               
BRHD100  EQU   *                                                                
         MVC   DXTDA,SXDBRDA                                                    
*        MVC   SXDBRDAT,DATENC                                                  
*        MVC   SXDBRTIM,TIMEN                                                   
*                                                                               
BRHDOK   SR    RC,RC                                                            
BRHDNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R3,R4,R5,R6                                                      
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* WRITE EXTRACT RECOVERY LOG DATA                                     *         
***********************************************************************         
         SPACE 1                                                                
         DS    0D                                                               
WRLHDB   NMOD1 0,**WRHD**                                                       
         LR    RC,R1                                                            
         CLI   HOSTDB,C'Y'                                                      
         BNE   WRHDOK                                                           
*                                                                               
         CLI   AUTOFLAG,OFF                                                     
         BE    WRHDOK                                                           
         CLI   DAILYFLG,ON                                                      
         BE    WRHDOK                                                           
*                                                                               
WRHD010  EQU   *                                                                
*                                                                               
         MVC   P(80),=CL80'WRITING RECOVERY HOST DATABASE'                      
         GOTO1 VPRINTER                                                         
*                                                                               
         L     R5,ADXBLOCK         GET ADDRESS SYSTEM CONTROL BLOCK             
         USING DXBLOCKD,R5                                                      
         L     R3,DXSTPTR                                                       
         USING SXDTABD,R3                                                       
* ??     TM    SXDTFLG2,SXDTFUEQ   TEST UPDATE ERROR OCCURRED                   
* ??     BNZ   WRHDOK                                                           
         L     R6,SXDTDBXT                                                      
         USING SXDBEXTD,R6                                                      
         MVC   SXDBRDA,DXTDA                                                    
         MVC   SXDBRDAT,DATENC                                                  
         MVC   SXDBRTIM,TIMEN                                                   
*                                                                               
         LA    R4,DXUDBPAR                                                      
         USING DXUDBD,R4                                                        
         XC    DXUDBPAR,DXUDBPAR                                                
         MVC   DXUPADXB,ADXBLOCK                                                
         MVC   DXUPIFCD,=AL1(DXUPIWRQ)                                          
         ICM   RF,15,AUDBMSG                                                    
         STCM  RF,15,DXUPSBLK                                                   
         MVC   0(2,RF),=AL2(UDBMSGLQ)                                           
         GOTO1 ADXUDB,DXUDBPAR                                                  
         SAM24                                                                  
         OC    DXUPRCDS,DXUPRCDS                                                
         BZ    WRHDOK                                                           
         GOTO1 =A(WLOGHDB)                                                      
         B     WRHDOK                                                           
*                                                                               
WRHDOK   SR    RC,RC                                                            
WRHDNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R3,R4,R5,R6                                                      
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* WRITE DXUDB ERROR LOG TO MVS DATA SET                               *         
***********************************************************************         
         SPACE 1                                                                
         DS    0D                                                               
WLOGHDB  NTR1  BASE=*                                                           
         CLI   HOSTDB,C'Y'                                                      
         BNE   WLOGOK                                                           
         ICM   RF,15,LOGCNT                                                     
         BZ    WLOGOK                                                           
         BCTR  RF,0                                                             
         STCM  RF,15,LOGCNT                                                     
         GOTO1 VPRINTER                                                         
         MVC   P(40),=CL40'<<< DXUDB ERROR LOG MESSAGES >>>'                    
         GOTO1 VPRINTER                                                         
*                                                                               
         ICM   RF,15,AUDBMSG                                                    
         BZ    WLOGOK                                                           
         OC    0(2,RF),0(RF)                                                    
         BZ    WLOGOK                                                           
         MVC   LOGLEN,0(RF)                                                     
         LA    RF,2(RF)                                                         
         STCM  RF,15,LOGPTR                                                     
*                                                                               
         BRAS  RE,BLDSNAME         BUILD LOG DATA SET NAME                      
*                                  DYNAMICALLY ALLOCATE MVS FILE                
         MVC   TXTDD+6(7),=CL7'LOGFILE'                                         
         MVI   TXTDD+5,7                                                        
         LA    R1,ARBLKCTA         DYNAMIC ALLOCATION PARAMETER BLOCK           
         DYNALLOC                                                               
         LTR   RF,RF                                                            
         BZ    WLOG010             DATASET WAS CREATED OK                       
*                                                                               
         LA    R1,ARBLKMOD         TRY DYNAMIC ALLOCATION OF EXISTING           
         DYNALLOC                  LOGFILE DATA SET WITH DISP=MOD               
         LTR   RF,RF                                                            
         BZ    WLOG010                                                          
*                                                                               
         MVC   P+11(13),=C'<<< ERROR >>>'                                       
         MVC   P+30(22),=C'DYNALLOC ERROR CODE = '                              
         GOTO1 VHEXOUT,DMCB,RBLKCATA+4,P+52,2,=C'TOG'                           
         CLC   =F'4',DMCB+16                                                    
         BNE   WLOGNO                                                           
         MVC   P+56(15),=C',  INFO CODE = '                                     
         GOTO1 VHEXOUT,DMCB,RBLKCATA+6,P+71,2,=C'TOG'                           
         CLC   =F'4',DMCB+16                                                    
         BNE   WLOGNO                                                           
         GOTO1 VPRINTER                                                         
         B     WLOGNO                                                           
*                                                                               
WLOG010  OPEN  (LOGFILE,OUTPUT)                                                 
         LTR   RF,RF                                                            
         BZ    WLOG012                                                          
*                                                                               
         MVC   P+11(13),=C'<<< ERROR >>>'                                       
         MVC   P+30(22),=C'LOG FILE OPEN ERROR'                                 
         GOTO1 VPRINTER                                                         
         B     WLOGNO                                                           
*                                                                               
WLOG012  BRAS  RE,WHDBLHDR         WRITE HDB LOG HEADER                         
         PUT   LOGFILE,P                                                        
         GOTO1 VPRINTER                                                         
*                                                                               
WLOG020  EQU   *                                                                
         BRAS  RE,GETLOGLN                                                      
         CLI   LOGEOF,C'Y'                                                      
         BE    WLOG040                                                          
         B     WLOG030                                                          
*                                                                               
WLOG030  PUT   LOGFILE,P                                                        
         GOTO1 VPRINTER                                                         
         B     WLOG020                                                          
*                                                                               
WLOG040  EQU   *                                                                
         BRAS  RE,WHDBLTRL         WRITE HDB LOG TRAILER                        
*                                                                               
WLOG100  EQU   *                                                                
         CLOSE (LOGFILE)                                                        
         LTR   RF,RF                                                            
         BZ    WLOG102                                                          
*                                                                               
         MVC   P+11(13),=C'<<< ERROR >>>'                                       
         MVC   P+30(22),=C'LOG FILE CLOSE ERROR'                                
         GOTO1 VPRINTER                                                         
         B     WLOGNO                                                           
*                                                                               
WLOG102  MVC   TXTUNDD+6(7),=CL7'LOGFILE'                                       
         MVI   TXTUNDD+5,7                                                      
         MVC   TXTDSN+6(44),LOGDSN                                              
         LA    R1,ARBLKUNA         DYNAMIC UNALLOCATION PARAMETER BLOCK         
         DYNALLOC                                                               
         LTR   RF,RF                                                            
         BZ    WLOG110                                                          
*                                                                               
         MVC   P+11(13),=C'<<< ERROR >>>'                                       
         MVC   P+30(22),=C'DYNALLOC ERROR CODE = '                              
         GOTO1 VHEXOUT,DMCB,RBLKUNA+4,P+52,2,=C'TOG'                            
         CLC   =F'4',DMCB+16                                                    
         BNE   WLOGNO                                                           
         MVC   P+56(15),=C',  INFO CODE = '                                     
         GOTO1 VHEXOUT,DMCB,RBLKUNA+6,P+71,2,=C'TOG'                            
         CLC   =F'4',DMCB+16                                                    
         BNE   WLOGNO                                                           
         GOTO1 VPRINTER                                                         
         B     WLOGNO                                                           
*                                                                               
WLOG110  EQU   *                                                                
         GOTO1 VPRINTER                                                         
         MVC   P(40),=CL40'<<< END OF DXUDB ERROR LOG MESSAGES >>>'             
         GOTO1 VPRINTER                                                         
         B     WLOGOK                                                           
*                                                                               
WLOGNO   SR    RC,RC                                                            
WLOGOK   LTR   RC,RC                                                            
         XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* WRITE HDB LOG HEADER                                                *         
***********************************************************************         
         SPACE 1                                                                
WHDBLHDR NTR1                                                                   
*                                                                               
         ICM   R4,15,ADXBLOCK                                                   
         BZ    WHLH100                                                          
         USING DXBLOCKD,R4                                                      
         BZ    WHLH100                                                          
         CLC   DXSTSPTR,DXSTEPTR                                                
         BE    WHLH100                                                          
         ICM   R5,15,DXSTPTR                                                    
         BZ    WHLH100                                                          
         USING SXDTABD,R5                                                       
         MVC   P,SPACES                                                         
         GOTO1 VPRINTER                                                         
         MVC   P(80),=CL80'START OF DXUDB EXCEPTION LOG'                        
         PUT   LOGFILE,P                                                        
         GOTO1 VPRINTER                                                         
         LA    R2,P                                                             
         GOTO1 WRTKWD,DMCB,(R2),=CL4'DATE',4,DATEN,L'DATEN                      
         ICM   R2,15,0(R1)                                                      
         MVI   0(R2),C','                                                       
         LA    R2,1(R2)                                                         
         GOTO1 WRTKWD,DMCB,(R2),=CL4'TIME',4,TIMEN,L'TIMEN                      
         ICM   R2,15,0(R1)                                                      
         MVI   0(R2),C','                                                       
         LA    R2,1(R2)                                                         
         GOTO1 WRTKWD,DMCB,(R2),=CL3'JOB',3,DXJOBNAM,L'DXJOBNAM                 
         ICM   R2,15,0(R1)                                                      
         MVI   0(R2),C','                                                       
         LA    R2,1(R2)                                                         
         GOTO1 WRTKWD,DMCB,(R2),=CL6'AGENCY',6,SXDTAGY,L'SXDTAGY                
         ICM   R2,15,0(R1)                                                      
         MVI   0(R2),C','                                                       
         LA    R2,1(R2)                                                         
         GOTO1 FORMSYS,DMCB,SXDTSYS,WORK                                        
         GOTO1 WRTKWD,DMCB,(R2),=CL6'SYSTEM',6,WORK,7                           
         ICM   R2,15,0(R1)                                                      
         MVI   0(R2),C','                                                       
         LA    R2,1(R2)                                                         
         GOTO1 FORMSUB,DMCB,SXDTSUB,WORK                                        
         GOTO1 WRTKWD,DMCB,(R2),=CL6'SUBSYS',6,WORK,7                           
         ICM   R2,15,0(R1)                                                      
         MVI   0(R2),C','                                                       
         LA    R2,1(R2)                                                         
         GOTO1 WRTKWD,DMCB,(R2),=CL9'DB2SUBSYS',9,DXDBSSYS,L'DXDBSSYS           
         ICM   R2,15,0(R1)                                                      
         MVI   0(R2),C','                                                       
         LA    R2,1(R2)                                                         
         GOTO1 WRTKWD,DMCB,(R2),=CL9'DBID',4,DXDBID,L'DXDBID                    
         PUT   LOGFILE,P                                                        
         GOTO1 VPRINTER                                                         
         MVC   P,SPACES                                                         
         MVC   P(80),=CL80'MVS EXTRACT DATA SET NAME='                          
         MVC   P+26(44),SXDTXDSN                                                
         PUT   LOGFILE,P                                                        
         GOTO1 VPRINTER                                                         
WHLH100  EQU   *                                                                
         XIT1                                                                   
         DROP  R4,R5                                                            
         EJECT                                                                  
***********************************************************************         
* WRITE HDB LOG TRAILER                                               *         
***********************************************************************         
         SPACE 1                                                                
WHDBLTRL NTR1                                                                   
         MVC   P,SPACES                                                         
         MVC   P(80),=CL80'END OF DXUDB EXCEPTION LOG'                          
         PUT   LOGFILE,P                                                        
         GOTO1 VPRINTER                                                         
         MVC   P,SPACES                                                         
         GOTO1 VPRINTER                                                         
         XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* WRITE KEYWORD=TEXT                                                  *         
***********************************************************************         
         SPACE 1                                                                
WRTKWD   NTR1                                                                   
         LM    R2,R6,0(R1)                                                      
         BCTR  R4,0                                                             
         EX    R4,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),0(R3)                                                    
         LA    R2,1(R2,R4)                                                      
         MVI   0(R2),C'='                                                       
         LA    R2,1(R2)                                                         
         BCTR  R6,0                                                             
         EX    R6,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),0(R5)                                                    
         LA    R2,0(R2,R6)                                                      
WKWD010  CLI   0(R2),C' '                                                       
         BNE   WKWD100                                                          
         BCTR  R2,0                                                             
         BCT   R6,WKWD010                                                       
WKWD100  EQU   *                                                                
         LA    R2,1(R2)                                                         
         STCM  R2,15,0(R1)                                                      
         XIT1                                                                   
         EJECT                                                                  
**********************************************************************          
* FORMAT SYSTEM FIELD FROM DXDSECTS INTERNAL TO SQL COMPATIBLE       *          
* P1 - A(SYSTEM NUMBER 1 BYTE)                                       *          
* P2 - A(SYSTEM NAME 7 CHARACTERS)                                   *          
**********************************************************************          
FORMSYS  NTR1                                                                   
         LM    R2,R3,0(R1)                                                      
         MVC   0(7,R3),SPACES                                                   
         L     R4,=A(SYSLST)                                                    
         USING SYSLSTD,R4                                                       
         LA    R4,6(R4)            R4=A(SYSTEM LIST)                            
*                                                                               
FSYS010  CLI   0(R4),0             TEST E-O-T                                   
         BE    FSYSERR1                                                         
         CLC   SYSLNUM,0(R2)                                                    
         BE    FSYS030                                                          
FSYS020  LA    R4,SYSLLEN(R4)                                                   
         B     FSYS010                                                          
*                                                                               
FSYS030  MVC   0(7,R3),SYSLNAME                                                 
         B     FSYSOK                                                           
*                                                                               
FSYSERR1 EQU   *                                                                
         DC    H'0'                                                             
*                                                                               
FSYSOK   SR    RC,RC                                                            
FSYSNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R4                                                               
         EJECT                                                                  
**********************************************************************          
* FORMAT SUBSYSTEM FIELD FROM DXDSECTS INTERNAL TO SQL COMPATIBLE    *          
* P1 - A(SUB SYSTEM NUMBER 1 BYTE)                                   *          
* P2 - A(SUB SYSTEM NAME 7 CHARACTERS)                               *          
**********************************************************************          
FORMSUB  NTR1                                                                   
         LM    R2,R3,0(R1)                                                      
         MVC   0(7,R3),SPACES                                                   
         L     R4,=A(SUBLST)                                                    
         USING SUBLSTD,R4                                                       
         LA    R4,6(R4)            R4=A(SYSTEM LIST)                            
*                                                                               
FSUB010  CLI   SUBLNUM,0           TEST E-O-T                                   
         BE    FSUBERR1                                                         
         CLC   SUBLNUM,0(R2)                                                    
         BE    FSUB030                                                          
FSUB020  LA    R4,SUBLLEN(R4)                                                   
         B     FSUB010                                                          
*                                                                               
FSUB030  MVC   0(7,R3),SUBLNAME                                                 
         B     FSUBOK                                                           
*                                                                               
FSUBERR1 EQU   *                                                                
         DC    H'0'                                                             
*                                                                               
FSUBOK   SR    RC,RC                                                            
FSUBNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* BUILD PQ REPORT EXTRACT MVS DATA SET NAME                           *         
***********************************************************************         
         SPACE 1                                                                
BLDSNAME NTR1                                                                   
*&&UK*&& MVC   LOGDSN(44),=CL44'ESS.XLG.'                                       
*&&US*&& MVC   LOGDSN(44),=CL44'DDS.XLG.'                                       
         MVC   LOGDSN+8(8),JOBNAME                                              
         LA    RF,8                                                             
         LA    R2,LOGDSN+15                                                     
BLDN010  CLI   0(R2),C' '                                                       
         BNE   BLDN020                                                          
         BCTR  R2,0                                                             
         BCT   RF,BLDN010                                                       
         DC    H'0'                                                             
BLDN020  EQU   *                                                                
         LA    R2,1(R2)                                                         
         MVI   0(R2),C'.'                                                       
         LA    R2,1(R2)                                                         
         MVI   0(R2),C'D'                                                       
         MVC   1(6,R2),JDATE+2                                                  
         LA    R2,7(R2)                                                         
         MVI   0(R2),C'.'                                                       
         LA    R2,1(R2)                                                         
         MVI   0(R2),C'T'                                                       
         MVC   1(6,R2),JTIME                                                    
*                                                                               
         MVC   TXTDSN+6(44),LOGDSN                                              
         MVC   P,SPACES                                                         
         GOTO1 VPRINTER                                                         
         MVC   P(80),=CL80'WRITING TO LOG DATA SET NAME='                       
         MVC   P+29(44),LOGDSN                                                  
         GOTO1 VPRINTER                                                         
         XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* GET LOG FILE LINE                                                   *         
***********************************************************************         
         SPACE 1                                                                
GETLOGLN NTR1                                                                   
         MVI   LOGEOF,C'N'                                                      
         SR    R2,R2                                                            
         ICM   R2,3,LOGLEN                                                      
         CLC   LOGLEN,=AL2(80)                                                  
         BL    GLINEND                                                          
         ICM   R3,15,LOGPTR                                                     
         MVC   P(132),0(R3)                                                     
         SHI   R2,132                                                           
         STCM  R2,3,LOGLEN                                                      
         LA    R3,132(R3)                                                       
         STCM  R3,15,LOGPTR                                                     
         B     GLINX                                                            
*                                                                               
GLINEND  MVI   LOGEOF,C'Y'                                                      
GLINX    EQU   *                                                                
         XIT1                                                                   
         SPACE 1                                                                
***********************************************************************         
* FORMAT CONSOLE ERROR MESSAGE                                        *         
* R4 = A(SYSTEM EXTRACT TABLE ENTRY)                                  *         
***********************************************************************         
         SPACE 1                                                                
FORMHUM  NTR1                                                                   
         ICM   R4,15,ADXBLOCK                                                   
         BZ    FHUMOK                                                           
         USING DXBLOCKD,R4                                                      
         BZ    FHUMOK                                                           
         CLC   DXSTSPTR,DXSTEPTR                                                
         BE    FHUMOK                                                           
         ICM   R5,15,DXSTPTR                                                    
         BZ    FHUMOK                                                           
         USING SXDTABD,R5                                                       
         MVC   P,SPACES                                                         
         MVC   P,SPACES                                                         
         MVC   P(22),=CL22'SQL UPDATE ERROR LOG: '                              
         LA    R2,P+22                                                          
         MVC   0(L'LOGDSN,R2),LOGDSN                                            
         MVC   WTOMSGD,P                                                        
         GOTO1 VPRINTER                                                         
         TM    SXDTFLG1,GXSDFMLQ                                                
         BZ    FHUM080                                                          
         GOTO1 VESSWTO,DMCB,X'FF000001',(L'WTOMSG,WTOMSG)                       
         B     FHUM090                                                          
FHUM080  EQU   *                                                                
         GOTO1 VESSWTO,DMCB,X'FE000001',(L'WTOMSG,WTOMSG)                       
FHUM090  EQU   *                                                                
FHUMOK   MVC   P,SPACES                                                         
         XIT1                                                                   
         DROP  R4,R5                                                            
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
         DS    0D                                                               
LOGFILE  DCB   DDNAME=LOGFILE,MACRF=(GM,PM),DSORG=PS,RECFM=FB,         +        
               LRECL=132,BLKSIZE=16500                                          
         SPACE 2                                                                
* CREATE LOGFILE DATASETS -- DYNAMIC ALLOCATION                                 
*                                                                               
         DS    0F                                                               
ARBLKCTA DC    X'80',AL3(RBLKCATA) R1 POINTS TO THIS BEFORE DYNALLOC            
*                                                                               
RBLKCATA DC    X'1401000000000000',A(ACATALLT),X'0000000000000000'              
*                                                                               
ACATALLT DC    X'00',AL3(TXTDD)                                                 
         DC    X'00',AL3(TXTDSN)                                                
         DC    X'00',AL3(TXTDISP)                                               
         DC    X'00',AL3(TXTNDISP)                                              
         DC    X'00',AL3(TXTBLKLN)                                              
         DC    X'00',AL3(TXTPRI)                                                
         DC    X'00',AL3(TXTSEC)                                                
         DC    X'00',AL3(TXTRLSE)                                               
         DC    X'80',AL3(TXTUNIT)                                               
         SPACE 2                                                                
* EXISTING LOGFILE DATASET -- DYNAMIC ALLOCATION WITH DISP MOD                  
*                                                                               
         DS    0F                                                               
ARBLKMOD DC    X'80',AL3(RBLKMOD) R1 POINTS TO THIS BEFORE DYNALLOC             
*                                                                               
RBLKMOD  DC    X'1401000000000000',A(AMODALLT),X'0000000000000000'              
*                                                                               
AMODALLT DC    X'00',AL3(TXTDD)                                                 
         DC    X'00',AL3(TXTDSN)                                                
         DC    X'80',AL3(TXTDISPM)                                              
         SPACE 2                                                                
* EXISTING EXFILE DATASET -- DYNAMIC ALLOCATION                                 
*                                                                               
         DS    0F                                                               
ARBLKEXA DC    X'80',AL3(RBLKEXTA) R1 POINTS TO THIS BEFORE DYNALLOC            
*                                                                               
RBLKEXTA DC    X'1401000000000000',A(AEXTALLT),X'0000000000000000'              
*                                                                               
AEXTALLT DC    X'00',AL3(TXTDD)                                                 
         DC    X'00',AL3(TXTDSN)                                                
         DC    X'80',AL3(TXTDISPS)                                              
         SPACE 2                                                                
* LOGFILE DATASETS -- DYNAMIC UNALLOCATION BY DDNAME                            
*                                                                               
         DS    0F                                                               
ARBLKUNA DC    X'80',AL3(RBLKUNA)  R1 POINTS TO THIS BEFORE DYNALLOC            
*                                                                               
RBLKUNA  DC    X'1402000000000000',A(ACATUNT),X'0000000000000000'               
*                                                                               
ACATUNT  DC    X'80',AL3(TXTUNDD)                                               
         SPACE 2                                                                
         SPACE 3                                                                
TXTDD    DC    AL2(DALDDNAM),X'00010008',CL8' '        DDNAME=........          
TXTDSN   DC    AL2(DALDSNAM),X'0001002C',CL44' '       DSN=............         
TXTDISPS DC    AL2(DALSTATS),X'0001000108'             DISP=(SHR,.....)         
TXTDISPM DC    AL2(DALSTATS),X'0001000102'             DISP=(MOD,.....)         
TXTDISP  DC    AL2(DALSTATS),X'0001000104'             DISP=(NEW,.....)         
TXTNDISP DC    AL2(DALNDISP),X'0001000102'                 =(...,CATLG)         
TXTDISPO DC    AL2(DALSTATS),X'0001000101'             DISP=(OLD,...)           
TXTNDISD DC    AL2(DALNDISP),X'0001000104'                 =(...,DEL)           
TXTBLKLN DC    AL2(DALBLKLN),X'00010003',AL3(16500)    SPACE=(16500,...         
TXTPRI   DC    AL2(DALPRIME),X'00010003',AL3(25)            =(..(25,...         
TXTSEC   DC    AL2(DALSECND),X'00010003',AL3(40)            =(...,40),.         
TXTRLSE  DC    AL2(DALRLSE),X'0000'                         =(...,RLSE)         
TXTUNIT  DC    AL2(DALUNIT),X'00010005',C'SYSDA'       UNIT=SYSDA               
TXTUNDD  DC    AL2(DUNDDNAM),X'00010008',CL8' '        DDNAME=........          
TXTREMOV DC    AL2(DUNREMOV),X'0000'                   REMOVE INUSE ATR         
         SPACE 2                                                                
LOGDSN   DC    CL44'XLOG.ESSNNNNN.SERVERNM.DATABASE.AAASS.FNNNNN'               
         EJECT                                                                  
         EJECT                                                                  
***********************************************************************         
* IF LESS THAN THE REQUESTED TIME INTERVAL HAS ELAPSED SINCE THE      *         
* LAST PASS THEN WAIT UNTIL THE FULL INTERVAL HAS EXPIRED             *         
* ALSO CHECK FOR AN OPERATOR INTERRUPT.                               *         
***********************************************************************         
         SPACE 1                                                                
         DS    0D                                                               
WAITER   NMOD1 0,**WAIT**                                                       
         LR    RC,R1                                                            
*&&UK                                                                           
         L     RE,=V(UTL)          COMMIT CONTROL SYSTEM BEFORE WAIT            
         MVC   BYTE,4(RE)                                                       
         MVI   4(RE),CONTROLQ                                                   
         LAY   RF,IO                                                            
         GOTO1 VDATAMGR,DMCB,=C'COMMIT ',=C'CONTROL',(RF)                       
         L     RE,=V(UTL)                                                       
         MVC   4(1,RE),BYTE                                                     
*&&                                                                             
         XC    ALDCBNUM,ALDCBNUM   RESET NUMBER OF USED DCBS                    
         XC    ALDSNNUM,ALDSNNUM   RESET NUMBER OF ALLOCATED DSN                
*                                                                               
         CLI   SKIPWAIT,C'Y'       SKIP WAITING?                                
         BNE   WAIT010             NO - CONTINUE TO WAIT                        
         MVI   SKIPWAIT,C'N'       YES - RESET FLAG AND EXIT                    
         MVI   MSGNUM,MSSKWTQ            WITH MESSAGE                           
         GOTO1 =A(MSGPRT),(RC)                                                  
         GOTO1 VPRINTER                                                         
         B     WAITX                                                            
*                                                                               
WAIT010  MVI   MSGNUM,MSWAITQ                                                   
         GOTO1 =A(MSGPRT),(RC)                                                  
         GOTO1 VPRINTER                                                         
*                                                                               
WAITLOOP SR    R0,R0                                                            
*                                  GET THE CURRENT TIME                         
         TIME  BIN                                                              
         LTR   RF,RF                                                            
         JNZ   *+2                 BAD RETURN FROM MACRO                        
*                                                                               
         S     R0,TIMENB           R0 = ELAPSED TIME SINCE START                
         BNM   WAIT020             IF NEGATIVE WE CROSSED MIDNIGHT SO           
         A     R0,=A(24*60*60*100)    ADD 24 HOURS IN 100THS SEC                
WAIT020  L     R2,TRAWLTIM         R2 = THE WAIT INTERVAL                       
         CR    R0,R2               HAVE WE WAITED THE FULL INTERVAL?            
         BNL   WAITX               YES                                          
*                                                                               
         L     RF,SLEEPTIM         GO TO SLEEP TIME                             
         ST    RF,STIMERVL                                                      
         STIMERM SET,ID=STIMER1,BINTVL=STIMERVL,WAIT=YES                        
         LTR   RF,RF               WAIT THE REQUESTED INTERVAL                  
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     RF,AOPERECB         A(OPERATOR ECB)                              
         TM    0(RF),X'40'         DID THE OPERATOR INTERRUPT?                  
         BZ    *+8                 NO                                           
         BRAS  RE,CHKOPER          EXAMINE THE OPERATOR INTERRUPT               
         CLI   OPERSTOP,C'Y'                                                    
         BE    WAITX                                                            
         CLI   CLOSFLAG,C'Y'                                                    
         BE    WAITX                                                            
         B     WAITLOOP                                                         
*                                                                               
WAITX    XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* THE OPERATOR HAS INTERRUPTED WITH EITHER A 'STOP' OR 'MODIFY'       *         
* COMMAND.  EXAMINE THE COMMAND AND TAKE THE APPROPRIATE ACTION.      *         
***********************************************************************         
         SPACE 1                                                                
CHKOPER  NTR1                                                                   
         L     RF,ACOMM                                                         
         USING COMLIST,RF                                                       
         L     R2,COMCIBPT         A(CIB)                                       
         LA    R3,COMCIBPT         A(A(CIB))                                    
         DROP  RF                                                               
*                                                                               
         USING CIBNEXT,R2                                                       
         CLI   CIBVERB,CIBSTOP     DID OPERATOR ENTER 'STOP'?                   
         BNE   CH10                                                             
         MVI   OPERSTOP,C'Y'       YES -- SET STOP FLAG                         
         GOTO1 VLOGIO,DMCB,X'FF000001',=C'STOP COMMAND ACCEPTED'                
         MVI   MSGNUM,MSOSTOPQ                                                  
         GOTO1 =A(MSGPRT),(RC)                                                  
         B     CHX                                                              
*                                                                               
CH10     CLI   CIBVERB,CIBMODFY    DID OPERATOR ENTER 'MODIFY'?                 
         BE    *+6                 YES                                          
         DC    H'0'                WHAT DID THE OPERATOR DO?                    
*                                                                               
         CLC   CIBDATLN,=H'5'      LENGTH OF 'MODIFY' STRING                    
         BNE   CHBAD                                                            
         CLC   =C'CLOSE',CIBDATA   TOGGLE JESMSG SWITCH?                        
         BNE   CHBAD                                                            
         MVI   CLOSFLAG,C'Y'       SET CLOSE SWITCH                             
         MVC   OPMS3+33(5),=C'CLOSE'                                            
         L     R1,AASCB            A(ASCB)                                      
         MVC   HALF,ASCBASID-ASCB(R1)                                           
         GOTO1 VHEXOUT,DMCB,HALF,OPMS3+7,2,=C'TOG'                              
         CLC   =F'4',DMCB+16                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         GOTO1 VLOGIO,DMCB,X'FF000001',(L'OPMS3,OPMS3)                          
         MVI   MSGNUM,MSOCLOSQ                                                  
         GOTO1 =A(MSGPRT),(RC)                                                  
         B     CHX                                                              
*                                                                               
CHBAD    GOTO1 VLOGIO,DMCB,X'FF000001',=C'*INVALID DXTRACT COMMAND*'            
*                                                                               
CHX      L     RF,ACOMM                                                         
         USING COMLIST,RF                                                       
         LA    R3,COMCIBPT         A(A(CIB))                                    
         DROP  RF                                                               
         QEDIT ORIGIN=(R3),BLOCK=(R2)  FREE THE CIB                             
*                                                                               
         XIT1                                                                   
         DROP  R2                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* DELETE NULL EXTRACT FILE                                            *         
* R4=A(SXDTTAB)                                                       *         
***********************************************************************         
         SPACE 1                                                                
         USING SXDTABD,R4                                                       
         DS    0D                                                               
DELEXFL  NMOD1 0,**DXFL**                                                       
         LR    RC,R1                                                            
         TM    SXDTXFLG,SXDTXFDO   IS THIS OVERRIDE DSN?                        
         BO    DXFLX               EXIT, DON'T DELETE DATASET                   
*                                                                               
         MVC   TXDDSN+6(44),SXDTXDSN  LOAD DYNALLOC BLOCK WITH DS INFO          
         MVC   TXDDD+6(8),SXDTXDDN                                              
         MVC   TXDUNDD+6(8),SXDTXDDN                                            
*                                  DYNAMICALLY PURGE MVS FILE                   
         LA    R1,ARBLKDLA                                                      
         DYNALLOC                                                               
         LTR   RF,RF                                                            
         BNZ   DXFLX              EXIT DATASET NOT DELETED OK                   
*                                  DYNAMICALLY DEALLOCATE MVS FILE              
         LA    R1,ARBLKUN2                                                      
         DYNALLOC                                                               
         LTR   RF,RF                                                            
         BZ    *+6                 DATASET WAS DEALLOCATED OK                   
         DC    H'0'                  ELSE ERROR                                 
*                                  DYNAMICALLY DEALLOCATE MVS FILE              
         MVC   P(16),=C'DELETED EXFILE: '                                       
         MVC   P+20(44),SXDTXDSN                                                
         GOTO1 VPRINTER                                                         
*                                                                               
         XC    SXDTXDCB,SXDTXDCB   CLEAR DCB, SO NO UPDATE TO CTFILE            
*                                                                               
DXFLX    XIT1                                                                   
         DROP  R4                                                               
         SPACE 1                                                                
         LTORG                                                                  
         SPACE 2                                                                
* DELETE FTPFILE DATASETS -- DYNAMIC ALLOCATION                                 
*                                                                               
         DS    0F                                                               
ARBLKDLA DC    X'80',AL3(RBLKDELA) R1 POINTS TO THIS BEFORE DYNALLOC            
*                                                                               
RBLKDELA DC    X'1401000000000000',A(ADELALLT),X'0000000000000000'              
*                                                                               
ADELALLT DC    X'00',AL3(TXDDSN)                                                
         DC    X'00',AL3(TXDDISPO)                                              
         DC    X'80',AL3(TXDNDISD)                                              
         SPACE 2                                                                
* FTPFILE DATASETS -- DYNAMIC UNALLOCATION BY DSN                               
*                                                                               
         DS    0F                                                               
ARBLKUN2 DC    X'80',AL3(RBLKUNA2) R1 POINTS TO THIS BEFORE DYNALLOC            
*                                                                               
RBLKUNA2 DC    X'1402000000000000',A(ACATUNT2),X'0000000000000000'              
*                                                                               
ACATUNT2 DC    X'80',AL3(TXDDSN)                                                
         SPACE 3                                                                
TXDDD    DC    AL2(DALDDNAM),X'00010008',CL8' '        DDNAME                   
TXDUNDD  DC    AL2(DUNDDNAM),X'00010008',CL8' '        DDNAME                   
TXDDSN   DC    AL2(DALDSNAM),X'0001002C',CL44' '       DSN=............         
TXDDISP  DC    AL2(DALSTATS),X'0001000104'             DISP=(NEW,.....)         
TXDNDISP DC    AL2(DALNDISP),X'0001000102'                 =(...,CATLG)         
TXDDISPO DC    AL2(DALSTATS),X'0001000101'             DISP=(OLD,...)           
TXDNDISD DC    AL2(DALNDISP),X'0001000104'                 =(...,DEL)           
TXDBLKLN DC    AL2(DALBLKLN),X'00010003',AL3(16500)    SPACE=(16500,...         
TXDPRI   DC    AL2(DALPRIME),X'00010003',AL3(25)            =(..(25,...         
TXDSEC   DC    AL2(DALSECND),X'00010003',AL3(40)            =(...,40),.         
TXDRLSE  DC    AL2(DALRLSE),X'0000'                         =(...,RLSE)         
TXDUNIT  DC    AL2(DALUNIT),X'00010005',C'SYSDA'       UNIT=SYSDA               
         EJECT                                                                  
*&&DO                                                                           
***********************************************************************         
* DYNAMICALLY ALLOCATE AND OPEN MVS DATA SET FOR RECOVERY             *         
***********************************************************************         
         SPACE 1                                                                
         DS    0D                                                               
OPENMVS  NMOD1 0,**OMVS**                                                       
         LR    RC,R1                                                            
         MVC   TOMDSN+6(44),MVSDSN                                              
         MVC   TOMDD+6(8),=CL8'MVSRCVDS'                                        
         MVI   TOMDD+5,8                                                        
*                                                                               
         LA    R1,ARBLKALM                                                      
         DYNALLOC                                                               
         LTR   RF,RF                                                            
         BZ    OMVS020             DATASET WAS ALLOCATED OK                     
*                                                                               
         MVC   P+11(13),=C'<<< ERROR >>>'                                       
         MVC   P+30(22),=C'DYNALLOC ERROR CODE = '                              
         GOTO1 VHEXOUT,DMCB,RBLKALM+4,P+52,2,=C'TOG'                            
         CLC   =F'4',DMCB+16                                                    
         BNE   OMVS010                                                          
         MVC   P+56(15),=C',  INFO CODE = '                                     
         GOTO1 VHEXOUT,DMCB,RBLKALM+6,P+71,2,=C'TOG'                            
         CLC   =F'4',DMCB+16                                                    
         BNE   OMVS010                                                          
         CLC   RBLKALM+4(2),=XL2'0410'                                          
         BNE   OMVS010                                                          
         B     OMVS010             ??                                           
*                                                                               
OMVS010  EQU   *                                                                
         GOTO1 VPRINTER                                                         
         DC    H'0'                                                             
*                                                                               
OMVS020  EQU   *                                                                
         L     R5,=A(MVSRCVDS)                                                  
         OPEN  ((R5),INPUT)        OPEN EXTRACT FILE                            
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         MVC   P(21),=C'OPENED MVS DATA SET: '                                  
         MVC   P+21(44),MVSDSN                                                  
         GOTO1 VPRINTER                                                         
         XIT1                                                                   
         SPACE 1                                                                
         LTORG                                                                  
         SPACE 1                                                                
* EXISTING MVS DATASET -- DYNAMIC ALLOCATION                                    
*                                                                               
         DS    0F                                                               
ARBLKALM DC    X'80',AL3(RBLKALM) R1 POINTS TO THIS BEFORE DYNALLOC             
*                                                                               
RBLKALM  DC    X'1401000000000000',A(ACATALM),X'0000000000000000'               
*                                                                               
ACATALM  DC    X'00',AL3(TOMDD)                                                 
         DC    X'00',AL3(TOMDSN)                                                
         DC    X'80',AL3(TOMDISPS)                                              
         SPACE 2                                                                
TOMDD    DC    AL2(DALDDNAM),X'00010008',CL8' '        DDNAME=........          
TOMDSN   DC    AL2(DALDSNAM),X'0001002C',CL44' '       DSN=............         
TOMDISPS DC    AL2(DALSTATS),X'0001000108'             DISP=(SHR,.....)         
         EJECT                                                                  
***********************************************************************         
* CLOASE AND DYNAMICALLY DEALLOCATE MVS DATA SET FOR RECOVERY         *         
***********************************************************************         
         SPACE 1                                                                
         DS    0D                                                               
CLOSEMVS NMOD1 0,**CMVS**                                                       
         LR    RC,R1                                                            
         L     R5,=A(MVSRCVDS)                                                  
         CLOSE ((R5))              CLOSE MVS DATA SET                           
         MVC   TCMDSN+6(44),MVSDSN                                              
         LA    R1,ARBLKUNM                                                      
         DYNALLOC                                                               
         MVC   P(21),=C'CLOSED MVS DATA SET: '                                  
         MVC   P+21(44),MVSDSN                                                  
         GOTO1 VPRINTER                                                         
         XIT1                                                                   
         SPACE 1                                                                
         LTORG                                                                  
         SPACE 2                                                                
* MVS DATASETS -- DYNAMIC UNALLOCATION BY DSN                                   
*                                                                               
         DS    0F                                                               
ARBLKUNM DC    X'80',AL3(RBLKUNM)  R1 POINTS TO THIS BEFORE DYNALLOC            
*                                                                               
RBLKUNM  DC    X'1402000000000000',A(ACATUNM),X'0000000000000000'               
*                                                                               
ACATUNM  DC    X'00',AL3(TCMDSN)                                                
         DC    X'80',AL3(TCMREMOV)                                              
         SPACE 3                                                                
TCMDSN   DC    AL2(DALDSNAM),X'0001002C',CL44' '       DSN=............         
TCMREMOV DC    AL2(DUNREMOV),X'0000'                   REMOVE INUSE ATR         
*&&                                                                             
         EJECT                                                                  
***********************************************************************         
* DYNAMICALLY ALLOCATE MVS DATA SET FOR EXTRACT DATA                  *         
* (REPLACES PREVIOS CALL TO DDDYNALLOC)                               *         
* R4=A(SXDTTAB)                                                       *         
***********************************************************************         
         SPACE 1                                                                
         USING SXDTABD,R4                                                       
         DS    0D                                                               
ALLOCEX  NMOD1 0,**DYNX**                                                       
         LR    RC,R1                                                            
* GOTO1 VDYNALOC,DMCB,(X'10',SXDTXDDN),(X'81',APALLOC),(X'80',SXDTXDSN)         
         MVC   TAXDSN+6(44),SXDTXDSN                                            
         MVC   TAXDD+6(8),SXDTXDDN                                              
         MVI   TAXDD+5,8                                                        
         MVC   TAXPRI+6(3),APALLOC                                              
         MVC   TAXSEC+6(3),ASALLOC                                              
*                                                                               
         LA    R1,ARBLKALX                                                      
         DYNALLOC                                                               
         LTR   RF,RF                                                            
         BZ    ALEXX               DATASET WAS ALLOCATED OK                     
         CLC   =XL2'0410',RBLKALX+4                                             
         BE    ALEX020             OR DD CARD ALREADY EXISTS                    
*                                                                               
         MVC   P+11(13),=C'<<< ERROR >>>'                                       
         MVC   P+30(22),=C'DYNALLOC ERROR CODE = '                              
         GOTO1 VHEXOUT,DMCB,RBLKALX+4,P+52,2,=C'TOG'                            
         CLC   =F'4',DMCB+16                                                    
         BNE   ALEX010                                                          
         MVC   P+56(15),=C',  INFO CODE = '                                     
         GOTO1 VHEXOUT,DMCB,RBLKALX+6,P+71,2,=C'TOG'                            
         CLC   =F'4',DMCB+16                                                    
         BNE   ALEX010                                                          
         CLC   RBLKALX+4(2),=XL2'0410'                                          
         BNE   ALEX010                                                          
         B     ALEX010             ??                                           
*                                                                               
ALEX010  GOTO1 VPRINTER                                                         
         DC    H'0'                                                             
*                                                                               
ALEX020  EQU   *                   RETURN THE OVERRIDE DSN                      
         GOTO1 VDYNALOC,DMCB,(C'D',SXDTXDDN),WORK                               
         MVC   SXDTXDSN,WORK                                                    
         OC    SXDTXDSN,SPACES                                                  
         OI    SXDTXFLG,SXDTXFDO   MARK OVERRIDE AND AVOID DELLOCATION          
*                                                                               
ALEXX    XIT1                                                                   
         SPACE 1                                                                
         LTORG                                                                  
         SPACE 1                                                                
* NEW EXTRACT MVS DATASET -- DYNAMIC ALLOCATION                                 
*                                                                               
         DS    0F                                                               
ARBLKALX DC    X'80',AL3(RBLKALX) R1 POINTS TO THIS BEFORE DYNALLOC             
*                                                                               
RBLKALX  DC    X'1401000000000000',A(ACATALX),X'0000000000000000'               
*                                                                               
ACATALX  DC    X'00',AL3(TAXDD)                                                 
         DC    X'00',AL3(TAXDSN)                                                
         DC    X'00',AL3(TAXDISP)                                               
         DC    X'00',AL3(TAXNDISP)                                              
         DC    X'00',AL3(TAXTRK)                                                
*        DC    X'00',AL3(TAXCYL)                                                
         DC    X'00',AL3(TAXPRI)                                                
         DC    X'00',AL3(TAXSEC)                                                
         DC    X'00',AL3(TAXRLSE)                                               
         DC    X'00',AL3(TAXUNIT)                                               
         DC    X'80',AL3(TAXUNAL)                                               
         SPACE 1                                                                
TAXDD    DC    AL2(DALDDNAM),X'00010008',CL8' '        DDNAME=........          
TAXDSN   DC    AL2(DALDSNAM),X'0001002C',CL44' '       DSN=............         
TAXDISPS DC    AL2(DALSTATS),X'0001000108'             DISP=(SHR,.....)         
TAXDISP  DC    AL2(DALSTATS),X'0001000104'             DISP=(NEW,.....)         
TAXNDISP DC    AL2(DALNDISP),X'0001000102'                 =(...,CATLG)         
TAXDISPO DC    AL2(DALSTATS),X'0001000101'             DISP=(OLD,...)           
TAXNDISD DC    AL2(DALNDISP),X'0001000104'                 =(...,DEL)           
TAXTRK   DC    AL2(DALTRK),X'0000'                    SPACE=(TRKS...            
*TAXCYL   DC    AL2(DALCYL),X'0000'                    SPACE=(CYL...            
TAXPRI   DC    AL2(DALPRIME),X'00010003',AL3(20)            = ..(20,.           
TAXSEC   DC    AL2(DALSECND),X'00010003',AL3(30)            = .,30),.           
TAXRLSE  DC    AL2(DALRLSE),X'0000'                         = ...,RLSE)         
TAXUNIT  DC    AL2(DALUNIT),X'00010005',C'SYSDA'       UNIT=SYSDA               
TAXUNAL  DC    AL2(DALCLOSE),X'00000000'               UNALLOCATE CLOSE         
         EJECT                                                                  
***********************************************************************         
* PUT RECORD TO EXTRACT FILE                                          *         
* P1=A(RECORD)                                                        *         
* P2=A(DXBLOCK)                                                       *         
***********************************************************************         
         SPACE 1                                                                
         DS    0D                                                               
PUTXREC  NMOD1 0,**PUTX**                                                       
         L     RC,=A(WORKD)        RC=A(GLOBAL WORK)                            
         L     R3,0(R1)            R3=A(RECORD)                                 
         L     R5,4(R1)            R5=A(DXBLOCK)                                
         L     R7,VCPRINT          R7=A(PRINTER IO)                             
         USING DXBLOCKD,R5                                                      
         MVC   SEGAFT,DXSEGAFT     SAVE CALLER'S DXSEGAFT                       
         MVI   DXSEGAFT,C'N'       AND RESET IT                                 
         L     R4,DXSTPTR          GET SYSTEM TABLE ENTRY POINTER               
         USING SXDTABD,R4                                                       
         CLI   CONTFLG,C'N'                                                     
         BNE   *+12                                                             
         TM    SXDTFLG2,SXDTFUEQ   TEST UPDATE ERROR OCCURRED                   
         BNZ   PXRCOK                                                           
         OC    SXDTXDCB,SXDTXDCB   CHECK FILE OPENED                            
         BNZ   PXRC010                                                          
         L     RF,AEXFTNXT         A(TABLE OF EXTRACT FILE DCBS/DDS)            
         MVC   SXDTXDCB,0(RF)      SAVE A(DCB)                                  
         MVC   SXDTXDDN,4(RF)      SAVE DD NAME                                 
         MVI   SXDTFTYP,SXDTFTMQ   RESET MULTIPART SEGMENTATION FLAG            
         GOTO1 =A(OPENEXFL),(RC)   OPEN NEXT EXTRACT DATA SET                   
         BNE   PXRCNO                EXIT IF ERROR                              
         ICM   RF,15,AEXFTNXT      UPDATE POINTER TO NEXT EXFTAB ENTRY          
         LA    RF,12(RF)                                                        
         CLM   RF,15,=A(EXFTABX)                                                
         BNL   PXRCER1             EXFTAB OVERFLOW                              
         STCM  RF,15,AEXFTNXT                                                   
         L     RF,ALDCBNUM         INCR # OF ALLOCATED DCBS                     
         AHI   RF,1                                                             
         ST    RF,ALDCBNUM                                                      
         CLI   MODE,DXUPDTQ        NO SQL IN UPDATE MODE ??                     
         BE    PXRC010                                                          
         TM    SQLFLAG,SQLFBEFQ                                                 
         BZ    PXRC010                                                          
         MVC   SQLBOOK,SQLBOOKB                                                 
         GOTO1 =A(PROCSQB),(RC)    PROCESS SQL QUERY BOOK                       
         BNE   PXRCNO                EXIT IF ERROR                              
*                                  CALL EXTRACT SYSTEM MODULE                   
PXRC010  AP    SXDTRNUM,=PL8'1'    RECORD NUMBER                                
         CP    SXDTRNUM,FROMCNT    TEST EXTRACT FROM RECORD NUMBER              
         BL    PXRCOK              REACHED                                      
         BH    PXRC030                                                          
         ZAP   SXDTRNUM,=PL8'2'                                                 
         ZAP   FROMCNT,=PL8'0'                                                  
*                                                                               
PXRC030  EQU   *                                                                
         LTR   R3,R3               EXIT IF DUMMY UPDATE                         
         BZ    PXRCOK                                                           
         L     R2,SXDTXDCB                                                      
         PUT   (2),(3)                                                          
*                                                                               
         GOTO1 =A(UPDTHDB),(RC)    UPDATE HOST DATABASE                         
         BNE   PXRCNO                EXIT IF ERROR                              
         CLI   CONTFLG,C'N'                                                     
         BNE   *+12                                                             
         TM    SXDTFLG2,SXDTFUEQ   TEST UPDATE ERROR OCCURRED                   
         BNZ   PXRCOK                                                           
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,0(R3)                                                       
         CVD   RF,DUB                                                           
         AP    SXDTBNUM,DUB        BYTE NUMBER                                  
*                                                                               
         USING DXSQLD,R3                                                        
         CLC   DXSQLTYP,DXSQADQ    SQL AFTER TYPE?                              
         BE    PXRCOK              YES-SKIP COMMIT COUNT CHECKING               
         DROP  R3                                                               
*                                                                               
         CLI   SEGAFT,C'Y'         WANT FILE SEGMENTED AFTER WRITE?             
         BE    PXRC035             YES, DO IT                                   
         CP    DXCOMMAX,=P'0'      COMMIT=0 MEANS DON'T SEGMENT                 
         BE    PXRCOK                                                           
         CP    SXDTRNUM,DXCOMMAX   TEST COMMIT COUNT MAXIMUM EXCEEEDED          
         BNH   PXRCOK                                                           
*                                                                               
         CLI   DXSYSCOD,C'N'         IF NETPAK, IGNORE MAX CHECK                
         BNE   PXRC035                                                          
         CLI   DXSUBSYS,X'01'        FOR SQL SUBSYSTEM                          
         BE    PXRCOK                                                           
*                                                                               
PXRC035  MVC   P(16),=C'SEGMENT EXFILE: '                                       
         MVC   P+20(44),SXDTXDSN                                                
         ICM   RF,15,VPRINTER                                                   
         GOTO1 VPRINTER                                                         
*                                                                               
         MVI   SXDTFTYP,C'P'       FLAG MULTIPART SEGMENTATION MODE             
         MVI   LASTFILE,C'N'                                                    
         GOTO1 =A(CLOSEXFL),(RC)   CLOSE CURRENT EXTRACT DATA SET               
         BNE   PXRCNO                EXIT IF ERROR                              
*                                                                               
         GOTO1 =A(COMMHDB),(RC)    COMMIT CHANGES TO HOST DATABASE              
         BNE   PXRCNO                EXIT IF ERROR                              
*                                  RESTORE EXTRACT UTL SENUM                    
         L     RE,=V(UTL)                                                       
         MVC   4(1,RE),DXSENUM                                                  
*                                                                               
         GOTO1 =A(SDATIME),(RC)    RESET DATE AND TIME                          
*                                                                               
         LA    RF,1                BUMP NEXT FILE GENERATION NUMBER             
         CLC   SXDTGNUM,=XL2'FFFF' FOR NEXT SEGMENTED FILE                      
         BE    *+12                                                             
         ICM   RF,3,SXDTGNUM                                                    
         LA    RF,1(RF)                                                         
         STCM  RF,3,SXDTGNUM                                                    
*                                                                               
         CLI   HOSTDB,C'Y'                                                      
         BE    PXRC100                                                          
*                                                                               
         L     R3,SXDTSLSA                                                      
         USING SXSLLSTD,R3                                                      
PXRC040  C     R3,SXDTSLEA                                                      
         BE    PXRC100                                                          
         LA    RF,1                BUMP FILE TRANSFER NUMBER                    
         CLC   SXSLFNUM,=XL2'FFFF' FOR NEXT SEGMENTED FILE                      
         BE    *+12                                                             
         ICM   RF,3,SXSLFNUM                                                    
         LA    RF,1(RF)                                                         
         STCM  RF,3,SXSLFNUM                                                    
         SR    RF,RF                                                            
         IC    RF,SXSLANUM                                                      
         MH    RF,=AL2(SXSLAPAL)                                                
         AR    R3,RF                                                            
         LA    R3,SXSLLSTL(R3)                                                  
         B     PXRC040                                                          
         DROP  R3                                                               
*                                                                               
PXRC100  ZAP   SXDTRNUM,=PL8'0'    RESET EXTRACT FILE PARAMETERS                
         ZAP   SXDTBNUM,=PL8'0'                                                 
* ??     ZAP   SXDTMTOT,=PL8'0'                                                 
         GOTO1 =A(OPENEXFL),(RC)   OPEN NEXT EXTRACT DATA SET                   
         BNE   PXRCNO                EXIT IF ERROR                              
         B     PXRCOK                                                           
*                                                                               
PXRCER1  EQU   *                   EXFTAB TABLE OVERFLOW                        
         MVI   ERROR,EREXFOVQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         B     PXRCNO                                                           
*                                  PUTXREC ERROR ABEND                          
PXRCNO   EQU   *                                                                
         MVI   ERROR,ERPUTXRQ                                                   
         GOTO1 =A(ERRPRT),(RC)                                                  
         ABEND 790,DUMP                                                         
*                                  EXIT OK                                      
PXRCOK   SR    RC,RC                                                            
         LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R4,R5                                                            
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
CONTROLQ EQU   X'0A'               CONTROL SYSTEM UTL SENUM                     
NOTEND   EQU   X'00'                                                            
END      EQU   X'FF'                                                            
OFF      EQU   X'00'                                                            
ON       EQU   X'FF'                                                            
LOG      EQU   X'FE'                                                            
**XTRTQ   EQU   X'5E'               FIELD SEPERATOR CHR                         
*                                                                               
*                                                                               
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *           
* VALIDATE TIME HHMMSS                                                          
*                                                                               
* P1 - A(INPUT)                                                                 
* P2 - A(FULLWORD) FOR HHMMSS00 OUTPUT                                          
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *           
VALTIME  NTR1  BASE=*,LABEL=*                                                   
         L     R2,0(R1)            A(INPUT)                                     
         L     R3,4(R1)            A(OUTPUT)                                    
*                                                                               
* VALIDATE HOURS                                                                
         CLC   =C'00',0(R2)                                                     
         JH    NEQXIT                                                           
         CLC   =C'23',0(R2)                                                     
         JL    NEQXIT                                                           
*                                                                               
* VALIDATE MINUTES                                                              
         CLC   =C'00',2(R2)                                                     
         JH    NEQXIT                                                           
         CLC   =C'59',2(R2)                                                     
         JL    NEQXIT                                                           
*                                                                               
* VALIDATE SECONDS                                                              
         CLC   =C'00',4(R2)                                                     
         JH    NEQXIT                                                           
         CLC   =C'59',4(R2)                                                     
         JL    NEQXIT                                                           
*                                                                               
         PACK  FULL,0(6,R2)                                                     
         L     R4,FULL                                                          
         SRL   R4,4                                                             
         SLL   R4,8                                                             
         ST    R4,0(R3)                                                         
*                                                                               
         J     EQXIT                                                            
         LTORG                                                                  
*                                                                               
*                                                                               
*                                                                               
***********************************************************************         
* GENERAL INITIALISATION                                              *         
***********************************************************************         
GENINIT  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LA    R5,ATIOT                                                         
         EXTRACT (R5),FIELDS=TIOT                                               
         L     R5,ATIOT                                                         
*                                                                               
         MVC   P,SPACES                                                         
         MVC   WTOMSG,SPACES                                                    
         MVC   WTOMSG(8),0(R5)                                                  
         MVI   WTOMSG+8,C'.'                                                    
         MVC   WTOMSG+9(8),8(R5)                                                
         MVI   WTOMSG+17,C'.'                                                   
         MVC   JOBNAME,0(R5)                                                    
*                                                                               
         EXTRACT ACOMM,FIELDS=COMM                                              
         L     RF,ACOMM            SET UP OPERATOR COMMUNICATIONS               
         USING COMLIST,RF                                                       
         MVC   AOPERECB+1(3),COMECBPT+1                                         
         MVC   ECBLST,AOPERECB     A(ECB)                                       
         L     R2,COMCIBPT         GET A(CIB)                                   
         LA    R3,COMCIBPT         GET A(A(CIB))                                
         DROP  RF                                                               
*                                                                               
         USING CIBNEXT,R2                                                       
         CLI   CIBVERB,CIBSTART    WAS DXTRACT BROUGHT UP WITH 'START'?         
         BNE   NOSTART                                                          
         DROP  R2                                                               
         QEDIT ORIGIN=(R3),BLOCK=(R2)  YES -- FREE THE CIB                      
NOSTART  QEDIT ORIGIN=(R3),CIBCTR=1    NOW ALLOW MODIFIES                       
*                                                                               
         EXTRACT EXTRAVL,'S',FIELDS=(ASID)                                      
         L     R3,EXTRAVL          MVS JOB ACCOUNTING INFORMATION               
         LOCASCB ASID=(R3)         PUTS A(ASCB) INTO R1                         
         ST    R1,AASCB            SAVE A(ASCB)                                 
*                                                                               
         MVC   OPMS3,=CL36'ASID = XXXX:  START/END MESSAGES XXX'                
         MVI   OPERSTOP,C'N'                                                    
         MVI   DAILYFLG,OFF                                                     
         MVI   ONCEFLG,C'N'                                                     
         MVC   TRAWLTIM,=F'360000'   DEFAULT TRAWL TIME = 1 HOUR                
         MVC   EXTRATIM,=F'60000'    DEFAULT TRAWL EXTRA TIME = 10 MINS         
         MVC   SLEEPTIM,=F'3000'     DEFAULT SLEEP TIME = 30 SECS               
         MVI   CONSOPEN,C'N'       CONTROL SYSTEM CLOSED                        
         MVI   INTAPE,C'N'         RECOVERY NOT FROM TAPE                       
         MVI   INPCODE,0           INPUT= DEFAULT                               
         MVI   TRANSCOD,0          TRANSACT= DEFAULT                            
         MVI   DATEFORM,0          DATEFORM= DEFAULT                            
         MVI   WRITE,C'Y'          WRITE OUPUT FLAG ON                          
         MVI   RETCODE,0           SET MVS RETURN CODE TO OK                    
         MVI   MAXRETCD,0          SET MAX DXRETCDE SO FAR                      
         MVI   HDBSTATE,0          SET HOST UPDATE STATUS                       
         MVI   SYSFILT,0           CLEAR SYSTEM FILTER                          
         XC    SYSXFILT,SYSXFILT   CLEAR SYSTEM FILE NUM FILTER                 
         MVI   DSNFLAG,C'L'        SET DATA SET NAME FLAG TO LONG FORM          
         MVI   SENDFLAG,C'N'       SET TRANSMIT FILES FLAG TO OFF               
         MVI   ENQCFLAG,C'N'       SET CONTROL SYSTEM NOT ENQUEUED              
         MVI   CLOSFLAG,C'N'       SET CLOSE SWITCH TO NO                       
         MVI   RUNFLAG,C'N'        SET RUN SWITCH TO NO                         
         MVI   SFAFLAG,C'N'        SET SKIP FILE W/ SQL AFTER ONLY OFF          
         MVI   STARFLAG,C'N'       SET START SWITCH TO NO                       
         MVI   RESETFLG,C'Y'       SET RESET FLAG TO YES                        
         MVI   CLEARFLG,C'N'       SET CLEAR FLAG TO NO                         
         MVI   ZEROFLG,C'N'        SET FILE NUMBER ZERO FLAG TO NO              
         MVI   DELFLG,C'N'         SET DELETE MVS DATA SET FLAG TO NO           
         MVI   REPLFLAG,C'N'       SET REPLACE LOAD MODE FLAG TO NO             
         MVI   AUTOFLAG,OFF                                                     
         MVI   PQRFLAG,C'N'                                                     
         MVI   PQRERROR,C'N'                                                    
         MVI   DSPFLAG,0                                                        
         MVI   LOADCON,0           SET LOAD REFRESH LEVEL                       
         MVI   TESTCHAR,C' '       SET SUBSYSTEM TEST PHASE CHARACTER           
         MVI   TSTFLAG,C' '        SET TEST SYSTEM FILE FILTER FLAG             
         MVI   NULLCODE,0          SET NULL=  CODE DEFAULT                      
         MVI   NULLIFCD,0          SET NULLIF=  CODE DEFAULT                    
         MVI   TEXTCODE,0          SET HEXOUT=  CODE DEFAULT                    
         MVC   USERPARM,SPACES     INITIALISE USER PARAMETER BLOCK              
         MVC   TSTRUN,SPACES                                                    
         MVI   AGXBUF,C'N'                                                      
         MVI   HOSTDB,C'N'         SET HOST DATA BASE FLAG TO NO                
         MVI   WRTXFFLG,C'Y'       SET WRITE TO CTFILE FLAG                     
         MVI   XTRFLG,C'Y'         SET WRITE TO CTFILE FLAG                     
         MVI   FUADFLG,C'N'        SET NET UAD FILTER FLAG                      
         MVI   REFSTFLG,0          SET REFORM STATUS FILTER FLAG                
         MVC   HDBID,SPACES        INITIALISE HOST DATABASE ID                  
         MVC   DB2AUTH,SPACES                                                   
         MVC   DB2LOCN,SPACES                                                   
         MVC   DB2SSYS,SPACES                                                   
         MVC   ESSPROG,SPACES                                                   
         MVC   ESSCMND,SPACES                                                   
         MVI   DIETFLAG,C'N'       SET DIET SQL PQ REPORT EXTRACT FLAG          
         MVI   FORMCODE,0          FORMAT= DEFAULT                              
         MVI   FIXEDFLG,C'N'       FIXED= DEFAULT                               
         MVI   ERRFLG,C'N'         ERROR= DEFAULT                               
         MVI   ENDMODE,C'N'        ENDMODE= DEFAULT                             
         MVI   CLOXMODE,C'D'       CLOXMODE= DEFAULT                            
         MVI   DELIM,C';'          DELIM= DEFAULT                               
         MVI   ESCODE,0            ESCAPE= DEFAULT                              
         MVI   SQLOUT,C'N'         SQLOUT= DEFAULT                              
         MVI   UDBERR,C'N'         UDBERR= DEFAULT                              
         MVI   CONTFLG,C'N'        CONTINUE= DEFAULT                            
         MVI   UPDFLAG,C'Y'        UPDATE=                                      
         MVI   COMFLAG,C'Y'        COMMIT=                                      
         MVI   VCHARFLG,0          VARCHAR=                                     
         MVI   QUOTEFLG,0          QUOTES=                                      
         MVI   READOFLG,C'N'       READ=                                        
         XC    ODSNAME,ODSNAME     DSNAME=                                      
         MVI   OFFLFLAG,0          OFFLINE=                                     
         MVI   SKIPFLAG,C'Y'       SKIP=                                        
         MVI   AAGYFLAG,C'N'       ALLAGY=                                      
         MVI   THREAD,0            THREAD=                                      
         MVI   POSTONLY,C'N'       POSTONLY=                                    
         MVC   POSTDSN,SPACES      INITIALISE THE DSN                           
         MVC   OVRDSN,SPACES       INITIALISE OVERRIDE DSN                      
         XC    EXTYPE,EXTYPE                                                    
         MVI   FILTER1,C' '        SET FILETR 1 VALUE TO NULL                   
         MVC   XFILTERS,SPACES     SET EXTRACT FILTERS TO DEFAULT               
         MVI   SQLFLAG,0           SET SQL BOOK FLAG TO NO                      
         XC    SQLBOOK,SQLBOOK     INITIALISE SQL BOOK KEY                      
         XC    SQLBOOKB,SQLBOOKB   INITIALISE SQL BOOK BEFORE KEY               
         XC    SQLBOOKA,SQLBOOKA   INITIALISE SQL BOOK AFTER KEY                
         XC    TIMENOW,TIMENOW     TIME NOW OVERRIDE                            
         MVI   MVSRCVF,C'N'        FLAG MVS DATA SET RECOVERY OFF               
         MVI   PLATFORM,DXTPSYBQ   DEFAULT PLATFORM=SYBASE                      
         MVI   AGYCNTRY,0          INITIALISE AGENCY COUNTRY CODE               
         MVI   COUNTRY,X'FF'       INITIALISE COUNTRY CODE                      
         MVI   CUNTFLAG,0          INITIALISE COUNTRY CODE FLAG                 
         MVI   DEBUGFLG,0          INITIALISE DEBUG FLAG                        
         MVI   DUMPCODE,0          INITIALISE DUMP CODE                         
         MVI   VERNUM,0            CLEAR VERSION NUMBER FILTER                  
*&&UK*&& MVI   VERFTYP,C'X'        VERSION NUMBER FILTER TYPE INCLUSIVE         
*&&US*&& MVI   VERFTYP,C'I'        VERSION NUMBER FILTER TYPE EXCLUSIVE         
         XC    FFTIME,FFTIME                                                    
         XC    FTTIME,FTTIME                                                    
         LA    RF,100                                                           
         STCM  RF,15,LOGCNT                                                     
         MVI   BASICHDR,C'N'                                                    
         MVI   CHOPDSN,C'N'                                                     
         MVI   GENSMF,C'Y'         DEFAULT IS SMF=Y                             
         MVI   EXFILE8K,C'N'       DEFAULT EXFILE LRECL IS 2K                   
         MVI   KPEMPTY,C'N'                                                     
         XC    LOADPHS,LOADPHS                                                  
         XC    SLICEFRO,SLICEFRO                                                
         XC    SLICETO,SLICETO                                                  
*                                                                               
         GOTO1 VDATCON,DMCB,(5,0),TODAY                                         
*                                                                               
         L     RF,=A(SXDTABC)      SET UP INDIRECT ADDRESS POINTERS             
         ST    RF,ASXDTAB                                                       
         L     RF,=A(DXBLOCK)                                                   
         ST    RF,ADXBLOCK                                                      
         L     RF,=A(SLLIST)                                                    
         ST    RF,ASLLIST                                                       
         ST    RF,ASLNEXT                                                       
         L     RF,=A(SFLIST)                                                    
         ST    RF,ASFLIST                                                       
         ST    RF,ASFNEXT                                                       
         L     RF,=A(DBLIST)                                                    
         ST    RF,ADBLIST                                                       
         ST    RF,ADBNEXT                                                       
         L     RF,=A(SXDBEXT)                                                   
         ST    RF,ASXDBEXT                                                      
         ST    RF,ASXDBNXT                                                      
         L     RF,=A(SXBDET)                                                    
         ST    RF,ASXBDET                                                       
         L     RF,=A(RECBUFF)                                                   
         ST    RF,ARECBUFF                                                      
         L     RF,=A(SYSREC)                                                    
         ST    RF,ASYSREC                                                       
         L     RF,=A(CPYBUFF)                                                   
         ST    RF,ACPYBUFF                                                      
         L     RF,=A(XREC)                                                      
         ST    RF,AXREC                                                         
         L     RF,=A(SQLBUFF)                                                   
         ST    RF,ASQLBUFF                                                      
         L     RF,=A(TRKBUFF)                                                   
         ST    RF,ATRKBUFF                                                      
         ST    RF,ABDEBUFF                                                      
         L     RF,=A(EXFTAB)                                                    
         ST    RF,AEXFTNXT                                                      
         L     RF,=A(UDBMSG)                                                    
         ST    RF,AUDBMSG                                                       
         L     RF,=A(HDRBUFF)                                                   
         ST    RF,AHDRBUFF                                                      
         L     RF,=A(SMFBUFF)                                                   
         ST    RF,ASMFBUFF                                                      
         L     RF,=A(SMFBUFFX)                                                  
         ST    RF,ASMFBUFX                                                      
*                                                                               
         XC    CPULAST,CPULAST                                                  
         XC    IOLAST,IOLAST                                                    
*                                                                               
         L     RF,=A(DXBLOCK)                                                   
         USING DXBLOCKD,RF                                                      
         MVI   DXPONLY,C'N'        POSTONLY OPTION IN DXBLOCK                   
         DROP  RF                                                               
         XIT1                                                                   
         LTORG                                                                  
*                                                                               
*                                                                               
*                                                                               
* CHECK IF PHASE SHOULD *NOT* BE LOADED FOR TYPE=AUTO                           
* R2 EXPECTED TO POINT TO A SEXTAB ENTRY                                        
* ON EXIT CC EQUAL IF PHASE IS IN THE NO-LOAD TABLE                             
ISNOLOAD NTR1  BASE=*,LABEL=*                                                   
         L     R1,=A(NOLOADTB)                                                  
*                                                                               
ISNOL10  CLI   0(R1),X'00'         EOT?                                         
         JE    NO                  PHASE IS *NOT* IN NO-LOAD TABLE              
         CLC   0(2,R2),0(R1)       COMPARE SYSTEM-SUBSYSTEM                     
         JE    YES                 MATCH FOUND DO *NOT* LOAD THIS PHASE         
         LA    R1,L'NOLOADTB(R1)                                                
         B     ISNOL10                                                          
         LTORG                                                                  
*                                                                               
*                                                                               
*                                                                               
* P1 HOB: 1=JOB STATS, 2=SPECIFIC AGENCY                                        
SAVESMF  NTR1  BASE=*,LABEL=*                                                   
         XC    SMFAGY,SMFAGY                                                    
         CLI   0(R1),1             JOB STATS?                                   
         BNE   *+10                                                             
         MVC   SMFAGY,=X'FFFF'     INDICATE THIS SMF REC IS JOB TOTAL           
*                                                                               
         L     R4,ADXBLOCK         A(DATA BLOCK)                                
         USING DXBLOCKD,R4                                                      
*                                                                               
         L     R2,DXSTPTR                                                       
         USING SXDTABD,R2                                                       
*                                                                               
         CLC   SMFAGY,=X'FFFF'     IS THIS SMF REC JOB TOTAL?                   
         BE    *+10                                                             
         MVC   SMFAGY,SXDTAGY                                                   
*                                                                               
         USING SMFBUFD,R3                                                       
         L     R3,ASMFBUFF                                                      
         LHI   R0,SMFBMAX          MAX TABLE ENTRIES                            
*                                                                               
SVSMF10  OC    SMFBAGY,SMFBAGY                                                  
         BZ    SVSMF20                                                          
         CLC   SMFBAGY,SMFAGY                                                   
         BE    SVSMF20                                                          
         LA    R3,SMFBUFDLQ(R3)                                                 
         BCT   R0,SVSMF10                                                       
*                                                                               
SVSMF20  DS    0H                                                               
         MVC   SMFBAGY,SMFAGY                                                   
*                                                                               
         IEABRCX ENABLE                                                         
         TIMEUSED STORADR=CPUSAVE,LINKAGE=SYSTEM,CPU=MIC                        
         IEABRCX DISABLE                                                        
*                                                                               
         LG    GR1,CPUSAVE         TOTAL CPU TIME USED                          
         SG    GR1,CPULAST         DIFFERENCE FROM LAST COUNT                   
         MVC   CPULAST,CPUSAVE                                                  
*                                                                               
         AG    GR1,SMFBCPU         CPU USED SO FAR BY THIS AGENCY               
         STG   GR1,SMFBCPU                                                      
*                                                                               
         L     RF,AASCB                                                         
         LG    GR1,ASCBIOSX-ASCB(RF) TOTAL IOS FOR THIS ADDRESS SPACE           
         SG    GR1,IOLAST          DIFFERENCE FROM LAST COUNT                   
         MVC   IOLAST,ASCBIOSX-ASCB(RF)                                         
*                                                                               
         AG    GR1,SMFBIO                                                       
         STG   GR1,SMFBIO                                                       
*                                                                               
         XIT1                                                                   
         LTORG                                                                  
         DROP                                                                   
*                                                                               
*                                                                               
*                                                                               
         PUSH USING                                                             
         DROP                                                                   
*                                                                               
WRITESMF NTR1  BASE=*,LABEL=*                                                   
         L     RC,=A(WORKD)                                                     
         USING WORKD,RC            RC=A(GLOBAL W/S)                             
         L     R4,ADXBLOCK         A(DATA BLOCK)                                
         USING DXBLOCKD,R4                                                      
*                                                                               
         USING SMFBUFD,R3                                                       
         L     R3,ASMFBUFF         CPU/IO BY AGENCY BUFFER                      
*                                                                               
WRSMF10  DS    0H                  CPU/IO BY AGENCY BUFFER LOOP                 
         C     R3,ASMFBUFX         BUFFER END?                                  
         BNL   WRITESMFX                                                        
         OC    SMFBAGY,SMFBAGY     BUFFER END?                                  
         BZ    WRITESMFX                                                        
*                                                                               
* FIND SXDTAB ENTRY FOR CURRENT SMF BUFFER AGENCY                               
*                                                                               
         L     R5,DXSTSPTR                                                      
         L     RF,DXSTEPTR                                                      
         USING SXDTABD,R5                                                       
*                                                                               
         CLC   =X'FFFF',SMFBAGY    JOB TOTAL RECORD?                            
         BE    WRSMF20             YES, DON'T LOOK FOR AGY IN SXD TAB           
*                        NOTE, R5 STILL POINTING TO 1ST SXD TAB ENTTRY          
*                                                                               
WRSMF15  CR    R5,RF               SXD TABLE END?                               
         JNL   WRSMF100           YES - LOOK FOR NEXT AGY IN SMF BUFFER         
*                                                                               
         CLC   SXDTAGY,SMFBAGY     MATCH TO AGENCY IN SMF TABLE                 
         BE    WRSMF20                                                          
*                                                                               
         LA    R5,SXDTABL(R5)                                                   
         B     WRSMF15                                                          
*                                                                               
WRSMF20  DS    0H                                                               
         XC    SMFRDW,SMFRDW       SMF RECORD RDW                               
         MVC   SMFRDW,=AL2(SMFXCRDLQ+4)                                         
*                                                                               
         XC    SMFREC,SMFREC                                                    
         LA    R2,SMFREC                                                        
         USING SMFXCRD,R2                                                       
*                                                                               
         MVC   SMFXCLEN,=AL2(SMFXCRDLQ)                                         
*                                                                               
         CLC   =X'FFFF',SMFBAGY    JOB TOTAL RECORD?                            
         BE    WRSMF40                                                          
*                                                                               
* JOB TOTAL RECORD THAT RUNS ACROSS AGENCIES (AUTOFLAG=ON)                      
* WON'T CONTAIN INFORMATION FROM SXD TABLE                                      
*                                                                               
* JOB TOTAL RECORD FOR SINGLE AGENCY WILL USE THIS AGENCY'S                     
* SXD TABLE ENTRY                                                               
*                                                                               
         MVC   SMFXCAGY,SXDTAGY                                                 
*                                                                               
         L     RF,SXDTSLSA                                                      
         LTR   RF,RF                                                            
         BZ    *+10                                                             
         MVC   SMFXCESS,0(RF)                                                   
*                                                                               
         MVC   SMFXCDSN,SXDTXDSN                                                
*                                                                               
         ZAP   DMCB(16),SXDTBNUM   DMCB IS DOUBLEWORD-ALIGNED                   
         CVBG  GRF,DMCB                                                         
         STG   GRF,DUB                                                          
         MVC   SMFXCSIZ,DUB        OUTPUT FILE SIZE                             
*                                                                               
WRSMF40  DS    0H                                                               
         LAY   RE,MODETAB                                                       
*                                                                               
WRSMF42  CLI   0(RE),X'FF'                                                      
         BE    WRSMF50                                                          
         CLC   MODE,8(RE)                                                       
         BE    *+12                                                             
         LA    RE,L'MODETAB(RE)                                                 
         B     WRSMF42                                                          
         MVC   SMFXCMOD,0(RE)                                                   
*                                                                               
WRSMF50  DS    0H                                                               
         MVC   SMFXCTYP(3),EXTYPE                                               
         CLI   AUTOFLAG,ON         CHECK IF AUTO UPDATE MODE                    
         BNE   *+10                                                             
         MVC   SMFXCTYP,=C'AUTO'                                                
         OC    SMFXCTYP,=C'    '                                                
*                                                                               
         MVC   SMFXCSYS,DXSENUM                                                 
         MVC   SMFXCST,TIMEST                                                   
         MVC   SMFXCET,TIMEEND                                                  
         MVC   SMFXCCPU,SMFBCPU                                                 
         MVC   SMFXCIOC,SMFBIO                                                  
         MVC   SMFXCRC,RETCODE                                                  
*                                                                               
         CLI   GENSMF,C'T'                                                      
         BE    WRSMF90                                                          
*                                                                               
         GOTO1 =V(SMFOUT),DMCB,F'17',SMFREC                                     
         B     WRSMF100                                                         
*                                                                               
WRSMF90  DS    0H                                                               
         L     R6,=A(SMFTRACE)                                                  
         PUT   (R6),SMFRDW                                                      
*                                                                               
WRSMF100 DS    0H                                                               
         LA    R3,SMFBUFDLQ(R3)       NEXT ENTRY IN SMF TABLE                   
         B     WRSMF10                                                          
*                                                                               
WRITESMFX DS   0H                                                               
         XIT1                                                                   
         LTORG                                                                  
         POP   USING                                                            
*                                                                               
*                                                                               
*                                                                               
         PUSH USING                                                             
         DROP                                                                   
SETLRECL NTR1  BASE=*,LABEL=*                                                   
         CLI   EXFILE8K,C'Y'       SETTING 8K LRECL FOR EXFILES?                
         BNE   SETLRECLX           NO, JUST EXIT                                
*                                                                               
         L     R2,=A(EXFTAB)       TABLE OF EXFILE DCB ADDRESSES                
         L     R3,=A(EXFTABX)      A(EOT)                                       
*                                                                               
SETLR10  CR    R2,R3               REACHED EOT?                                 
         BNL   SETLRECLX           YES, EXIT                                    
*                                                                               
         USING IHADCB,R4           DEFINED BY DCBD MACRO                        
         L     R4,0(R2)            A(DCB)                                       
         MVC   DCBLRECL,=AL2(EXF8KQ) SET LRECL=8192                             
*                                                                               
         LA    R2,12(R2)                                                        
         B     SETLR10                                                          
*                                                                               
SETLRECLX DS   0H                                                               
         XIT1                                                                   
         LTORG                                                                  
         POP   USING                                                            
*                                                                               
*                                                                               
*                                                                               
***********************************************************************         
* GLOBAL WORKING STORAGE                                                        
***********************************************************************         
WORKD    DS    0D                                                               
*                                                                               
STIMER1  DS    XL4                                                              
STIMERVL DS    F                                                                
EXTRAVL  DS    F                                                                
ECBLST   DC    X'80',AL3(0)        A(OPERATOR ECB IS STORED HERE)               
*                                                                               
AOPERECB DC    A(0)                A(ECB OPERATOR INTERUPT)                     
ACOMM    DC    A(0)                A(COMMUNICATIONS PARAMETER LIST)             
AASCB    DC    A(0)                A(ASCB) FROM EXTRACT                         
ATIOT    DC    F'0'                                                             
         SPACE 1                                                                
         EJECT                                                                  
VDATAMGR DC    V(DATAMGR)                                                       
VDMOD000 DC    V(DMOD000)                                                       
VDADDS   DC    V(DADDS)                                                         
VDDNAME  DC    V(DMDDNAME)                                                      
VLOGIO   DC    V(LOGIO)                                                         
VCPRINT  DC    V(CPRINT)                                                        
VPRINT   DC    V(PRINT)                                                         
VPRINTER DC    V(PRINTER)                                                       
VHELLO   DC    V(HELLO)                                                         
VHEXOUT  DC    V(HEXOUT)                                                        
VHEXIN   DC    V(HEXIN)                                                         
VCARDS   DC    V(CARDS)                                                         
VNUMVAL  DC    V(NUMVAL)                                                        
VTIMBER  DC    V(TIMBER)                                                        
VDATVAL  DC    V(DATVAL)                                                        
VDATCON  DC    V(DATCON)                                                        
VPERVAL  DC    V(PERVAL)                                                        
VDYNALOC DC    V(DYNALLOC)                                                      
VXSORT   DC    V(XSORT)                                                         
VGETBOOK DC    V(GETBOOK)                                                       
VCRYPT   DC    V(CRYPT)                                                         
VSCANNER DC    V(SCANNER)                                                       
VGETDAY  DC    V(GETDAY)                                                        
VGETRET  DC    V(GETRET)                                                        
VGETFACT DC    V(GETFACT)                                                       
VESSWTO  DC    V(ESSWTO)                                                        
VPQSERV  DC    V(PQSERV)                                                        
VREFORM  DC    V(REFORM)                                                        
VADDAY   DC    V(ADDAY)                                                         
VMOBILE  DC    V(MOBILE)                                                        
VCOVAIL  DC    V(COVAIL)                                                        
*                                                                               
* COMFACS MOVED BELOW EXFILE DCBS TO FREE SPACE IN WORKD                        
ACOMFACS DC    A(COMFACS)                                                       
*ACOMFACS DS    0D                                                              
*       ++INCLUDE DDCOMFACSC                                                    
*COMFAC2  DC    (CCFACLEN-CFACSTRT)X'00'                                        
*                                                                               
EXDSNAME DC    CL44'JOMU.TEST1                    '                             
STARTJOB DC    CL8'**SJOB**'                                                    
DMUTL    DC    C'UTL    '                                                       
DMRDONLY DC    C'NALL    X'                                                     
DMOPEN   DC    C'OPEN   '                                                       
DMREAD   DC    C'DMREAD '                                                       
DMRSEQ   DC    C'DMRSEQ '                                                       
DMRDHI   DC    C'DMRDHI '                                                       
DMADD    DC    C'DMADD  '                                                       
DMWRT    DC    C'DMWRT  '                                                       
DMCLSE   DC    C'DMCLSE '                                                       
DMFAST   DC    C'DMFAST '                                                       
DMKEY    DC    C'DMKEY  '                                                       
GFILE    DC    C'GFILE  '                                                       
PRTQUE   DC    C'PRTQUE '                                                       
SYSFLES  DC    C'SYSFLES'                                                       
GETREC   DC    C'GETREC '                                                       
PUTREC   DC    C'PUTREC '                                                       
ADDREC   DC    C'ADDREC '                                                       
DMRFIL   DC    C'RECOVER'                                                       
CONTROL  DC    C'CONTROL'                                                       
CTFILE   DC    C'CTFILE '                                                       
GENDIR   DC    C'GENDIR '                                                       
GENFIL   DC    C'GENFIL '                                                       
*&&US                                                                           
CTFILES  DC    C'NCTFILE NGENDIR NGENFIL NCTRCVR X'                             
CTFILESL DC    C'NCTFILE NGENDIR NGENFIL X'                                     
CTFILEU  DC    C'UCTFILE UGENDIR UGENFIL UCTRCVR X'                             
*&&                                                                             
MEDFILE  DC    C'MEDFIL '                                                       
MEDFILQ  EQU   X'42'                                                            
MEDDIR   DC    C'MEDDIR '                                                       
ACCDIR   DC    C'ACCDIR '                                                       
DMDA     DC    F'0'                SYSTEM FILE DISK ADDRESS                     
RCVDA    DC    F'0'                RECOVERY FILE DISK ADDRESS                   
EXTVFDA  DC    F'0'                START DISK ADDR IF EXTENDED VERMONTS         
EXTVODA  DC    F'0'                ORIGINAL START IF EXTENDED VERMONTS          
FILEDA   DC    F'0'                SAVED XFILE DISK ADDRESS                     
ADNEXT   DC    F'0'                A(GENFIL'S DNEXT FORM DTF)                   
AOVLAST  DC    F'0'                A(GENDIR'S OVLAST FORM DTF)                  
APDLAST  DC    F'0'                A(GENDIR'S PDLAST FORM DTF)                  
ADDRDA   DC    F'0'                LAST ADDREC DISK ADDRESS                     
MAXRECS  DC    F'999999999'                                                     
HDBCOUNT DC    F'0'                                                             
HDBINC   DC    F'0'                                                             
ERRCUNT  DC    F'1'                                                             
COMMAX   DC    PL8'99999999'                                                    
FROMCNT  DC    PL8'0'                                                           
ACTIVITY DC    CL1'Y'                                                           
APALLOCP DC    XL3'000000'                                                      
ASALLOCP DC    XL3'000000'                                                      
APALLOC  DC    XL3'000000'                                                      
ASALLOC  DC    XL3'000000'                                                      
APALLOCM DC    XL3'002711'                                                      
ASALLOCM DC    XL3'002711'                                                      
MAJORNAM DC    C'DXTRACT '                                                      
MINORNAM DC    C'        '                                                      
VALCHRS  DC    C'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%&&*-+',X'FF'          
HASHES   DC    50C'#'                                                           
*                                                                               
* TABLE OF VALID MODES INPUT VIA MODE=CARD                                      
         SPACE 1                                                                
TTABLIST DC    C'123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ',X'00'                     
         SPACE 1                                                                
SNUMLIST DC    C'0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ',X'00'                    
         SPACE 2                                                                
*                                                                               
*&&UK                                                                           
         DS    0D                                                               
RCVTAPE  DCB   DDNAME=RCVTAPE,MACRF=(GM),DSORG=PS,RECFM=VB,            +        
               EODAD=PUPDEOT                                                    
*                                                                               
*VSRCVDS DCB   DDNAME=MVSRCVDS,MACRF=(GM),DSORG=PS,RECFM=VB,           +        
               EODAD=PUPDEOM                                                    
*                                                                               
INFILE   DCB   DDNAME=INFILE,MACRF=(GM),DSORG=PS,RECFM=VB,             +        
               EODAD=PTRAEIN                                                    
*                                                                               
SQLOUTD  DCB   DDNAME=SQLOUT,MACRF=(PM),DSORG=PS,RECFM=VB,             +        
               LRECL=2048,BLKSIZE=8120                                          
*                                                                               
UDBERRD  DCB   DDNAME=UDBERR,MACRF=(PM),DSORG=PS,RECFM=VB,             +        
               LRECL=2048,BLKSIZE=8120                                          
*&&                                                                             
*                                                                               
*&&US                                                                           
         DS    0D                                                               
RCVTAPE  DCB   DDNAME=RCVTAPE,DSORG=PS,RECFM=VB,LRECL=8200,            +        
               MACRF=(GM),EODAD=PUPDEOT                                         
*                                                                               
         DS    0D                                                               
RCVTAPER DCB   DDNAME=RCVTAPE,DSORG=PS,RECFM=VB,LRECL=8200,            +        
               MACRF=(GM),EODAD=PUPDEOT                                         
*                                                                               
         DS    0D                                                               
RCVTAPEP DCB   DDNAME=RCVTAPE,DSORG=PS,RECFM=VB,                       +        
               MACRF=(GM),EODAD=PUPDEOT                                         
*                                                                               
         DS    0D                                                               
*VSRCVDS DCB   DDNAME=MVSRCVDS,MACRF=(GM),DSORG=PS,RECFM=VB,           +        
               LRECL=2028,BLKSIZE=7476,EODAD=PUPDEOM                            
*                                                                               
INFILE   DCB   DDNAME=INFILE,DSORG=PS,RECFM=VB,MACRF=(GM),             +        
               LRECL=2048,BLKSIZE=8120,EODAD=PTRAEIN                            
*                                                                               
SQLOUTD  DCB   DDNAME=SQLOUT,DSORG=PS,RECFM=VB,MACRF=(PM),             +        
               LRECL=2048,BLKSIZE=0                                             
*                                                                               
UDBERRD  DCB   DDNAME=UDBERR,DSORG=PS,RECFM=VB,MACRF=(PM),             +        
               LRECL=2048,BLKSIZE=0                                             
*&&                                                                             
         SPACE 1                                                                
       ++INCLUDE DXRECID                                                        
         EJECT                                                                  
DUB      DS    D                                                                
PRNTDUB  DS    D                                                                
CPUSAVE  DS    D                                                                
CPULAST  DS    D                                                                
IOLAST   DS    D                                                                
TIMEST   DS    2D                                                               
TIMEEND  DS    2D                                                               
DMCB     DS    6F                                                               
DMCBENQ  DS    6F                                                               
DMCBSAVE DS    6F                                                               
*                                                                               
FULL     DS    F                                                                
SVREG    DS    F                   REGISTER SAVE AREA                           
RELO     DS    A                                                                
RBSAVE   DS    A                                                                
HALF     DS    H                                                                
DMWORK   DS    12D                 DATAMANAGER WORK AREA                        
BYTE     DS    XL1                                                              
BYTE2    DS    XL1                                                              
COUNTER  DS    XL1                                                              
FILEGFST DS    CL1                 FIRST FILE GENERATED FLAG                    
FILEGCNT DS    XL2                 FILE GENERATION COUNT                        
DELXFLAG DS    CL1                 DELETE XFILE RECORD CLEARANCE FLAG           
ACTSAVE  DS    CL1                 SAVE DXACTION IN CASE SUBSYS CHANGES         
MODESAVE DS    CL1                 SAVE DXMODE                                  
*                                                                               
ERROR    DS    XL1                 ERROR CODE                                   
MSGNUM   DS    XL1                 STATUS MESSAGE NUMBER                        
FIRSTFLG DS    XL1                 START OF RECOVERY FILE FLAG (N/Y)            
PRNTTIME DS    CL7                 FOR MSGPRT ROUTINE                           
*                                                                               
OPERSTOP DS    CL1                 OPERATOR STOP REQUEST FLAG (N/Y)             
OPMS1    DS    CL31                OPERATOR COMMS - MESSAGE BUFFER 1            
OPMS3    DS    CL36                OPERATOR COMMS - MESSAGE BUFFER 2            
*                                                                               
WTOMSG   DS    0CL128                                                           
WTOMSGK  DS    CL28                                                             
WTOMSGD  DS    CL100                                                            
*                                                                               
MVSPARM  DS    XL1                 MVS STEP CONTROL INPUT PARAMETER             
MVSTIME  DS    F                   IBM TIME BINARY 100S SECS                    
MVSDATE  DS    F                   IBM DATE JULIAN                              
*                                                                               
JOBNAME  DS    CL8                 JOB NAME                                     
JDATE    DS    CL8                 JOB START DATE YYMMDD                        
JTIME    DS    CL8                 JOB START TIME HHMMSS                        
CENTURY  DS    CL2                 CURRENT CENTURY EBCDIC VALUE                 
DATEN    DS    CL8                 DATE NOW EBCDIC                              
DATENC   DS    XL2                 DATE NOW COMPRESSED                          
DATENB   DS    XL3                 DATE NOW BINARY                              
TIMEN    DS    CL8                 TIME NOW EBCDIC (HHMMSSTH)                   
TIMENOW  DS    CL8                 TIME NOW EBCDIC (HHMMSSTH) OVERRIDE          
TIMEND   DS    XL4                 TIME NOW DECIMAL UNSIGNED PACKED             
TIMENB   DS    F                   TIME NOW BINARY FULL WORD                    
SVDATE   DS    XL2                 SAVE DATE VALUE                              
SVTIME   DS    XL4                 SAVE TIME VALUE                              
TODAY    DS    CL6                 TODAY'S DATE (YYMMDD)                        
*FOR QUARTER CALCULATION, SUNDAY'S DATE IS USED FOR SATURDAY'S LOAD             
TODAYQTR DS    CL6                 TODAY'S DATE (YYMMDD)                        
*                                                                               
AGYSAVE  DS    CL2                 AGENCY ALPHA SAVE                            
*                                                                               
RETCODE  DS    XL1                 MVC JOB STEP RETUN CODE (X'FF' = OK)         
MAXRETCD DS    XL1                 MAX OF ALL DXRETCDE VALUES                   
HDBSTATE DS    XL1                 HOST DATABASE STATUS CODE                    
HDBSUPEQ EQU   X'01'               UPDATE ERROR OCCURRED                        
CONSOPEN DS    CL1                 CONTROL SYSTEM OPEN FLAG (N/Y)               
TRAWLEND DS    XL1                 RECOVERY EXTRACT TRAWL END FLAG              
*                                                                               
MVSRCVF  DS    CL1                 MVS DATA SET RECOVERY FLAG                   
MVSDSN   DS    CL44                                                             
FILEFLAG DS    CL1                 FLAG EXTRACT FILES HAVE BEEN CREATED         
EMPTYFIL DC    CL1'Y'              Y=ALL EXTRACT FILES ARE EMPTY                
*                                                                               
*                                  JCL INPUT CONTROL CARD PARAMETERS            
AGYFILT  DS    CL2                 AGENCT ALPHA ID FILTER                       
SYSFILT  DS    XL1                 SYSTEM NUMBER FILTER                         
SUBFILT  DS    XL1                 SUB SYSTEM CODE FILTER                       
SYSXFILT DS    XL1                 SYSTEM FILE NUMBER FILTER                    
USERID   DS    CL10                USER ID                                      
USERNUM  DC    XL2'0000'           USERID NUMBER                                
UIDFILT  DS    XL2                 USERID NUMBER FILTER                         
USERAGY  DS    CL2                 USERID AGENCY ALPHA                          
SUBIDFLT DS    CL3                 PQ REPORT SUB IF FILTER                      
REPNOFLT DS    XL2                 PQ REPORT SEQUENCE NUMBER FILTER             
PLATFORM DS    XL1                 SERVER PLATFORM BYTE (SQL = X'01')           
AGYCNTRY DS    XL1                 AGENCY ALPHA ID COUNTRY CODE                 
COUNTRY  DS    XL1                 COUNTRY CODE                                 
CUNTFLAG DS    XL1                 COUNTRY CODE FLAG                            
DEBUGFLG DS    XL1                 DEBUG FLAG                                   
DEBFPQQ  EQU   X'01'               DEBUG FLAG PQ REFORM REPORT                  
DUMPCODE DS    CL1                 DUMP CODE                                    
DATEFORM DS    XL1                 DATE FORMAT FILTER FLAG                      
DELIM    DS    CL1                 EXTRACT FIELD DELIMITER CHARACTER            
EORSTR   DS    CL8                 EXTRACT END OF RECORD STRING                 
EORLEN   DS    XL1                 EXTRACT END OF RECORD STRING LENGTH          
TEXTCODE DS    XL1                 EXTRACT TEXT FIELD FORMAT CODE               
NULLCODE DS    XL1                 EXTRACT NULL FIELD FORMAT CODE               
NULLIFCD DS    XL1                 EXTRACT NULLIF FORMAT CODE                   
MONYCODE DS    XL1                 EXTRACT MONEY FIELD FORMAT CODE              
HEADFLAG DS    XL1                 HEADER OUTPUT FILTER FLAG (N/Y)              
AUTOFLAG DS    XL1                 EXTRACT AUTO MODE FLAG                       
CLOSFLAG DS    CL1                 CLOSE SWITCH FLAG                            
RUNFLAG  DS    CL1                 RUN SWITCH FLAG                              
SFAFLAG  DS    CL1                 SKIP FILE WITH SQL AFTER BOOK ONLY           
STARFLAG DS    CL1                 START RECOVERY FILE FLAG                     
VCHARFLG DS    CL1                 VARCHAR= FLAG                                
QUOTEFLG DS    CL1                 QUOTES= FLAG                                 
READOFLG DS    CL1                 READ= FLAG                                   
ODSNAME  DS    CL8                 DSNAME= OVERRIDE                             
OFFLFLAG DS    CL1                 OFFLINE= FLAG                                
SKIPFLAG DS    CL1                 SKIP= FLAG                                   
AAGYFLAG DS    CL1                 ALLAGY= FLAG(Y=EXTRACT FOR ALL AGY)          
THREAD   DS    XL1                 THREAD= NUMBER                               
POSTONLY DS    CL1                 POSTONLY= FLAG                               
PQEOF    DS    CL1                 PQ REPORT END OF FILE FLAG                   
LASTFILE DS    CL1                 LAST XFILE IN SEGMENTATION SEQUENCE          
SQLAONLY DS    CL1                 NO DATA BEFORE SQL AFTER BOOK ADDED          
MODE     DS    XL1                 EXTRACT MODE BYTE                            
MODEPQL  DS    XL1                 Y = USE LOAD CMD LINE WHEN MODE=PQ           
WRITE    DS    CL1                 WRITE OUPUT FILTER FLAG (N/Y)                
MEDAGY   DS    XL1                 MEDIA AGENCY CODE FILTER                     
CPYFILT  DS    XL1                 ACCOUNT COMPANY CODE FILTER                  
FACID    DS    CL1                 FACPAK FILTER ID                             
FILTER1  DS    XL1                 GENERAL FILTER 1                             
XFILTERS DS    CL3                 XGENCY FILTERS                               
INTAPE   DS    CL1                 RECOVERY FILE ON TAPE FLAG                   
INPCODE  DS    XL1                 INPUT= CODE                                  
TRANSCOD DS    XL1                 TRANSACT= CODE                               
EXTYPE   DS    CL3                 EXTRACT RECORD TYPE CODE                     
DSNFLAG  DS    CL1                 DATA SET NAME SHORT FLAG                     
SENDFLAG DS    CL1                 SEND FILE FLAG (SEE ALSO ESSID)              
ENQCFLAG DS    CL1                 ENQUEUED CONTROL SYSTEM FLAG (Y/N)           
EXFCODE  DS    CL1                 EXTRACT FREQUENCY CODE                       
EXFTIME  DS    XL2                 EXTRACT FREQUENCY TIME                       
DAILYFLG DS    CL1                 EXTRACT DAILY UPDATE FLAG                    
ONCEFLG  DS    CL1                 EXTRACT FREQUENCY=ONCE FLAG                  
SKIPWAIT DS    CL1                 SKIP WAITING FLAG                            
ALDSNNUM DS    F                   NUMBER OF ALLOCATED DSN                      
ALDCBNUM DS    F                   NUMBER OF USED DCBS                          
DCBLIMIT DC    AL4(EXFTABQ)        INPUTED DCB # LIMIT                          
*&&UK*&& ORG   *-4                                                              
*&&UK*&& DC    AL4(32)             LOWER UK DEFAULT ELSE MEMORY PROBS           
*&&UK*&& ORG   ,                                                                
TRAWLTIM DS    F                   TRAWL TIME PARAMETER (100S OF SECS)          
EXTRATIM DS    F                   EXTRA TRAWL TIME PARAMETER 100S S.           
SLEEPTIM DS    F                   WAIT SWAP OUT STIMER VALUE 100S S.           
ESSID    DS    CL8                 ESS ID FILTER                                
APPLKEY  DS    CL8                 SQL SERVER APPLICATION KEY                   
SERVERID DS    CL16                SQL SERVER ID                                
DATABASE DS    CL16                SQL SERVER DATABASE NAME                     
SQLUSER  DS    CL16                SQL DATABASE USER ID                         
PASSWORD DS    CL16                SQL SERVER PASSWORD                          
RESETFLG DS    CL1                 RESET TRANSFER TABLE FLAG                    
CLEARFLG DS    CL1                 CLEAR ESS CONTROL FLAG                       
ZEROFLG  DS    CL1                 ZERO FILE NUMBER FLAG                        
DELFLG   DS    CL1                 DELETE MVS DATA SET FLAG                     
REPLFLAG DS    CL1                 REPLACE LOAD MODE CONTROL FLAG               
LOADCON  DS    CL1                 LOAD CONTROL                                 
TESTCHAR DS    CL1                 SUB SYSTEM PHASE TEST CHARACTER              
TSTFLAG  DS    CL1                 TEST SYSTEM FILES FILTER FLAG                
LOADFLAG DS    CL1                 SUB SYSTEM PHASE ALREADY LOADED              
PQRFOUND DS    CL1                 PQ REPORT FILE FOUND                         
PQRFLAG  DS    CL1                 PQ REPORT FILE EXTRACTED FLAG                
PQRERROR DS    CL1                 PQ REPORT FILE EXTRACT ERROR FLAG            
DIETFLAG DS    CL1                 DIET SQL PQ REPORT EXTRACT FLAG              
FORMCODE DS    XL1                 FORMAT= CODE                                 
FIXEDFLG DS    CL1                 FIXED= FLAG                                  
SQLOUT   DS    CL1                 SQLOUT= FLAG                                 
UDBERR   DS    CL1                 UDBERR= FLAG                                 
CONTFLG  DS    CL1                 CONTINUE= FLAG                               
UPDFLAG  DS    CL1                 UPDATE= FLAG                                 
DSPFLAG  DS    CL1                 DSPACE= FLAG                                 
COMFLAG  DS    CL1                 COMMIT=N FLAG                                
ERRFLG   DS    CL1                 ERROR= FLAG                                  
ENDMODE  DS    CL1                 ENDMODE= FLAG                                
CLOXMODE DS    CL1                 CLOXMODE= FLAG                               
ESCODE   DS    CL1                 ESCAPE= CODE                                 
SQLFLAG  DS    XL1                 SQL QUERY BOOK FLAG                          
SQLFBEFQ EQU   X'01'               SQL QUERY BOOK FLAG BEFORE                   
SQLFAFTQ EQU   X'02'               SQL QUERY BOOK FLAG AFTER                    
SQLBOOK  DS    CL10                SQL QUERY BOOK ID                            
SQLBOOKB DS    CL10                SQL QUERY BOOK ID BEFORE                     
SQLBOOKA DS    CL10                SQL QUERY BOOK ID AFTER                      
REFORMID DS    CL5                 REFORM ID                                    
MAXIOS   DS    XL4                 MAXIMUM IOS                                  
VERNUM   DS    XL1                 VERSION NUMBER FILTER                        
VERFTYP  DS    XL1                 VERSION NUMBER FILTER TYPE=X/I               
USERPARM DS    CL32                USER DEFINED PARAMETER BLOCK                 
CTDSN    DS    CL44                CTFILE DSN CHECKING                          
POSTDSN  DS    CL44                DSN TO POST TO CT FILE                       
OVRDSN   DS    CL44                DSN OVERRIDE FOR THE TRAILER RECORD          
HOSTDB   DS    CL1                 HOST DATA BASE (E.G. DB2) FLAG               
WRTXFFLG DS    CL1                 WRITE TO CTFILE FLAG                         
XTRFLG   DS    CL1                 SUB SYS EXTRACT FLAG                         
FUADFLG  DS    CL1                 NET UAD FILTER FLAG                          
REFSTFLG DS    CL1                 REFORM STATUS FILTER FLAG (A/E)              
RFABDFLG DS    CL1                 REFORM ERROR ABEND FLAG (Y/N)                
HDBID    DS    CL30                HOST DATABASE CONNECT (AUTH) ID              
DB2AUTH  DS    CL8                 DB2 DATABASE AUTH ID                         
DB2LOCN  DS    CL16                DB2 SUB SYSTEM LOCATION ID                   
DB2SSYS  DS    CL4                 DB2 SUB SYSTEM ID                            
ESSPROG  DS    CL32                OVERRIDE XAPPLIC ESS PROGRAM NAME            
ESSCMND  DS    CL48                OVERRIDE XAPPLIC ESS COMMAND LINE            
TSTRUN   DS    CL2                 TSTRUN= CARD VALUE                           
AGXBUF   DS    CL1                 AGXBUF= CARD VALUE                           
*                                                                               
CLIENT   DS    CL3                 CLIENT FILTER                                
CLIENTS  DS    CL3                 CLIENT RANGE START                           
CLIENTE  DS    CL3                 CLIENT RANGE END                             
NETWORK  DS    CL5                 NETWORK FILTER                               
KEYFIT   DS    CL64                KEY FILTER                                   
*                                                                               
SLICEFRO DS    F                   TIME SLICE FROM                              
SLICETO  DS    F                   TIME SLICE TO                                
FFTIME   DS    F                   FILTER FROM TIME                             
FTTIME   DS    F                   FILTER TO TIME                               
XFDATE   DS    F                   FILTER FROM DATE                             
XTDATE   DS    F                   FILTER TO DATE                               
XFTIMEP  DS    XL2                 FILTER FROM TIME PACKED (HHMM)               
XTTIMEP  DS    XL2                 FILTER TO TIME PACKED                        
XFTIMEE  DS    CL6                 FILTER FROM TIME EBCDIC                      
XTTIMEE  DS    CL6                 FILTER TO TIME EBCDIC                        
XFDATEE  DS    CL8                 FILTER FROM DATE EBCDIC                      
XTDATEE  DS    CL8                 FILTER TO DATE EBCDIC                        
XFDATEC  DS    XL2                 FILTER FROM DATE COMPRESSED                  
XTDATEC  DS    XL2                 FILTER TO DATE COMPRESSED                    
XFDATEP  DS    XL3                 FILTER FROM DATE PWOS                        
XTDATEP  DS    XL3                 FILTER TO DATE PWOS                          
*                                                                               
SYSTEM   DS    XL1                 SYSTEM BINARY CODE                           
SUBSYS   DS    XL1                 SUB SYSTEM BINARY CODE                       
SUBCHAR  DS    CL1                 SUB SYSTEM CHARACTER CODE                    
SUBNAME  DS    XL7                 SUB SYSTEM NAME                              
SYSCODE  DS    CL1                 SYSTEM CHARACTER CODE                        
SYSCHAR  DS    CL1                 SYSTEM FILE CODE CODE                        
SYSLNAM  DS    CL7                 LOGICAL SYSTEM NAME                          
SYSCTRY  DS    XL1                 SYSTEM COUNTRY CODE                          
SENUM    DS    XL1                 SYSTEM SE NUMBER                             
SESNAM   DS    XL5                 PARM "S=AIT" FOR GET SENUM                   
AGYAID   DS    CL2                 AGENCY APLHA ID                              
AGYBIN   DS    XL1                 AGENCY BINARY CODE                           
AGYPIN   DS    XL2                 AGENCY PRINCIPLE ID NUMBER                   
RSYSID   DS    XL1                 RECOVERY RECORD SYSTEM ID                    
LOGEOF   DS    XL1                 DXUDB ERROR LOG END OF FILE FLAG             
LOGLEN   DS    XL2                 DXUDB ERROR LOG BUFFER LENGTH LEFT           
LOGPTR   DS    A                   DXUDB ERROR BUFFER POINTER                   
LOGCNT   DS    XL4                 LOG RECORD COUNT                             
GENNUM   DS    XL2                 FILE GEN (FOR FORMSQLB)                      
SEGAFT   DS    X                   DXSEGAFT VALUE FOR DXPUT ROUTINE.            
BASICHDR DS    C                   BASICHDR= CARD VALUE                         
CHOPDSN  DS    C                   CHOPDSN= CARD VALUE                          
GENSMF   DS    C                   GENERATE SMF RECORDS (N,Y,T)                 
EXFILE8K DS    C                   8K EXFILE LRECL (Y,N), DEFAULT=N             
KPEMPTY  DS    C                   KEEP EMPTY OUTPUT FILE                       
LOADPHS  DS    CL8                 OVERRIDE PHASE NAME                          
SMFAGY   DS    CL2                 AGENCY FOR CURRENT SMF RECORD                
EXTVMT   DS    C                                                                
*                                                                               
         DS    0D                                                               
DXUDBPAR DS    XL(DXUDBPLQ)        DXUDB PARAMETER BLOCK                        
*                                                                               
RCVADTF  DS    A                   RECOVERY FILE DTF ADDRESS                    
*                                                                               
ASYSEXT  DS    A                   A(SYSTEM EXTRACT MODULE)                     
SXDTPTR  DS    A                   A(CURRENT ENTRY IN SXDTAB)                   
SXDTEND  DS    A                   A(END OF SXDTAB)                             
SXDTNXT  DS    A                   A(NEXT SYSTEM GROUP IN SXDTAB)               
ASXDTAB  DS    A                   A(SYSTEM EXTRACT DRIVER TABLE)               
ADXBLOCK DS    A                   A(EXTRACT CONTROL DATA BLOCK)                
ASLLIST  DS    A                   A(SERVER LUID LIST BLOCK)                    
ASLNEXT  DS    A                   A(NEXT FREE SPACE IN SLLIST)                 
ASFLIST  DS    A                   A(FILE GENERATION LIST BLOCK)                
ASFNEXT  DS    A                   A(NEXT FREE SPACE IN SFLIST)                 
ADBLIST  DS    A                   A(DATABASE UPDATE LIST BLOCK)                
ADBNEXT  DS    A                   A(NEXT FREE SPACE IN DBLIST)                 
ASXDBEXT DS    A                   A(HOST DATABASE EXTENSION BLOCK)             
ASXDBNXT DS    A                   A(NEXT FREE SPACE IN SXDBEXT)                
ASXBDET  DS    A                   A(BDE CONTROL TABLE)                         
ASXBDNXT DS    A                   A(NEXT FREE SPACE IN SXBDET)                 
ARECBUFF DS    A                   A(GENERAL RECORD BUFFER)                     
ASYSREC  DS    A                   A(SUB SYSTEM RECORD BUFFER)                  
ACPYBUFF DS    A                   A(RECOVERY RECORD COPY BUFFER)               
AXREC    DS    A                   A(EXTRACT RECORD BUFFER)                     
ASQLBUFF DS    A                   A(SQL RECORD BUFFER)                         
ATRKBUFF DS    A                   A(DISK IO BUFFER)                            
ABDEBUFF DS    A                   A(BDE PQ BUFFER)                             
AGENDIR  DS    A                   A(GENDIR) FROM DTFADR                        
AGENFIL  DS    A                   A(GENFIL) FROM DTFADR                        
ACTFILE  DS    A                   A(CTFILE) FROM DTFADR                        
AEXFTNXT DS    A                   A(NEXT ENTRY IN EXFTAB)                      
ADXUDB   DS    A                   A(DXUDB)                                     
AUDBMSG  DS    A                   A(DXUDB RETURN MESSAGE AREA)                 
AHDRBUFF DS    A                   A(HEADER RECORD BUFFER)                      
ASMFBUFF DS    A                   A(SMF RECORD BUFFER)                         
ASMFBUFX DS    A                   A(SMF RECORD BUFFER END)                     
AIOL     DC    A(IOL)                                                           
AIO      DC    A(IO)                                                            
*                                                                               
ENQCMND  DS    CL8                 SAVE ENQDEQ COMMAND NAME                     
*                                                                               
PQREPORT DS    CL20                PQ REPORT (USERID/SUBID/REP#)                
*&&US                                                                           
EMAILADR DC    CL40'US-MF_FAC_NOTIFY'   EMAIL ADDR FOR WARNING MESSAGE          
*&&                                                                             
*&&UK                                                                           
EMAILADR DC    CL40'TCLEDDLO'      EMAIL ADDR FOR WARNING MESSAGE               
*&&                                                                             
*                                                                               
SVFLAG   DS    X                                                                
SVFUATQ  EQU   X'01'               UAT AGENCY                                   
*                                                                               
IOKEYSV  DS    CL32                SAVE RECORD KEY BUFFER                       
IOKEY    DS    CL32                RECORD KEY BUFFER                            
WORK     DS    XL256               GENERAL WORK AREA                            
ELEMENT  DS    XL256               RECORD ELEMENT WORK AREA                     
SMFRDW   DS    XL4                 SMF RDW                                      
SMFREC   DS    XL256               SMF RECORD                                   
*                                                                               
         DS    0H                                                               
MODETAB  DS    0CL9                                                             
         DC    C'UPDATE  ',AL1(DXUPDTQ)                                         
         DC    C'LOAD    ',AL1(DXLOADQ)                                         
         DC    C'PRINTQ  ',AL1(DXPQRQ)                                          
         DC    C'PRINTQ,L',AL1(DXPQRQ)                                          
         DC    C'SQL     ',AL1(DXSQLQ)                                          
         DC    C'RESET   ',AL1(DXSQLQ)                                          
         DC    C'STAT    ',AL1(DXSTATQ)                                         
         DC    C'STATBCS ',AL1(DXSTATCSQ)   GERMANY ONLY (PR000858)             
         DC    C'TRANS   ',AL1(DXTRANSQ)                                        
         DC    X'FF'                                                            
*                                                                               
WORKX    DS    0D                                                               
*                                                                               
IOL      DS    F                   GENERAL IO AREA                              
IO       DC    64000X'00'                                                       
         EJECT                                                                  
*                                                                               
SSB      DS    0D                                                               
*&&US*&& DC    X'0000',X'FF'                                                    
*&&US*&& DC    X'02'               FOR DATAMGR (OFFLINE NO RECOVERY)            
*&&US*&& DC    1020X'00'                                                        
*&&UK*&& DC    X'0000',X'FF'                                                    
*&&UK*&& DC    X'0C'               RECOVERY ON + SSOSLOCK (GLOBAL)              
*&&UK*&& DC    X'00'                                                            
*&&UK*&& DC    X'08'               FULL RECOVERY WITH BACKOUT                   
*&&UK*&& DC    1018X'00'                                                        
*                                                                               
* INDIRECT ADDRESSABILITY FROM HERE                                             
*                                                                               
AUTOACVM DC    AL2(AUTOACVMLQ-2)                                                
         DC    C'AUTONOTE*'                                                     
*&&US*&& DC    C'US-MF_FAC_NOTIFY'                                              
*&&UK*&& DC    C'EU-FAC-TEAM'                                                   
         DC    C':WARNING. ACTIVE VERMONT(S) AT CLOSE'                          
AUTOACVMLQ EQU   *-AUTOACVM                                                     
         SPACE 1                                                                
ERRTAB   DS    0H                  ERROR REPORT STRINGS                         
ERDSNFQ  EQU   0                                                                
         DC    CL60'DATASET NOT FOUND IN PAN LIBRARY'                           
ERINCCIQ EQU   1                                                                
         DC    CL60'INVALID CONTROL CARD INPUT'                                 
ERMISSDQ EQU   2                                                                
         DC    CL60'MISSING SYSTEM DEFINITION'                                  
ERINSYNQ EQU   3                                                                
         DC    CL60'INVALID SYSTEM NAME'                                        
ERMISSNQ EQU   4                                                                
         DC    CL60'MISSING SYSTEM NAME'                                        
ERINSUNQ EQU   5                                                                
         DC    CL60'INVALID SUB SYSTEM NAME'                                    
ERINAGYQ EQU   6                                                                
         DC    CL60'INVALID AGENCY ALPHA ID'                                    
ERINUSEQ EQU   7                                                                
         DC    CL60'INVALID USERID/AGENCY FILTER'                               
ERVALCQ  EQU   8                                                                
         DC    CL60'ERROR IN SYSIN CARD VALIDATION ROUTINE'                     
ERBXSYSQ EQU   9                                                                
         DC    CL60'ERROR IN BUILD EXTRACT SYSTEM TABLE ROUTINE'                
ERSEXSQ  EQU   10                                                               
         DC    CL60'ERROR IN SUB SYSTEM MODULE CONFIG. ROUTINE'                 
EROPESFQ EQU   11                                                               
         DC    CL60'ERROR IN EXTRACT SYSTEM FILE OPEN ROUTINE'                  
ERPLOADQ EQU   12                                                               
         DC    CL60'ERROR IN EXTRACT LOAD ROUTINE'                              
ERMODEQ  EQU   13                                                               
         DC    CL60'ERROR IN EXTRACT MODE DEFINITION'                           
ERPUPDTQ EQU   14                                                               
         DC    CL60'ERROR IN EXTRACT UPDATE ROUTINE'                            
ERCLOSFQ EQU   15                                                               
         DC    CL60'ERROR IN EXTRACT SYSTEM FILE CLOSE ROUTINE'                 
ERWRTXFQ EQU   16                                                               
         DC    CL60'ERROR WRITING EXTRACT FILE CONTROL RECORDS'                 
ERIPQRQ  EQU   17                                                               
         DC    CL60'ERROR IN PQ REPORT EXTRACT INITIALISATION ROUTINE'          
ERGETPQQ EQU   18                                                               
         DC    CL60'ERROR IN GET PQ REPORT EXTRACT DETAILS ROUTINE'             
ERPPQRQ  EQU   19                                                               
         DC    CL60'ERROR IN PQ REPORT EXTRACT ROUTINE'                         
ERPSQLQ  EQU   20                                                               
         DC    CL60'ERROR IN SQL ONLY STATEMENT EXTRACT ROUTINE'                
ERSYSOVQ EQU   21                                                               
         DC    CL60'SXDTABC OVERFLOW > MAX. SIZE SYSTEM TABLE'                  
ERINSENQ EQU   22                                                               
         DC    CL60'INVALID SE NUMBER'                                          
ERMISUFQ EQU   23                                                               
         DC    CL60'MISSING SUB SYSTEM FILTER'                                  
ERNASUFQ EQU   24                                                               
         DC    CL60'SUB SYSTEM FILTER NOT ALLOWED IN THIS EXTRACT MODE'         
ERMIAGYQ EQU   25                                                               
         DC    CL60'MISSING AGENCY ID FILTER'                                   
ERNAAGYQ EQU   26                                                               
         DC    CL60'AGENCY ID FILTER NOT ALLOWED IN THIS EXTRACT MODE'          
ERSYLOVQ EQU   27                                                               
         DC    CL60'SLLIST OVERFLOW > MAX. SIZE ESS SERVER LIST'                
ERGETACQ EQU   28                                                               
         DC    CL60'ERROR IN GETACC AGENCY ACCESS RECORD READ ROUTINE'          
ERGETSYQ EQU   29                                                               
         DC    CL60'ERROR IN GETSYL SYSLIST RECORD READ ROUTINE'                
EREXFOVQ EQU   30                                                               
         DC    CL60'EXFTAB OVERFLOW > MAX. SIZE EXTRACT FILE DCB TABLE'         
ERCRYPTQ EQU   31                                                               
         DC    CL60'ERROR RETURN FROM DDCRYPT ROUTINE'                          
ERCLRXFQ EQU   32                                                               
         DC    CL60'ERROR IN CLEAR EXTRACT FILE CONTROL RECORD ROUTINE'         
ERSACTQ  EQU   33                                                               
         DC    CL60'ERROR UPDATING ACTIVITY ELEMENT IN CONTROL RECORD'          
ERPUTXRQ EQU   34                                                               
         DC    CL60'ERROR PUTXREC, PUT RECORD TO EXTRACT FILE ROUTINE'          
ERTRAW1Q EQU   35                                                               
         DC    CL60'UNFINISED TASK IN RECOVERY UPDATE EXTRACT ROUTINE'          
ERGTSK1Q EQU   36                                                               
         DC    CL60'ERROR IN GETTSKT ROUTINE, TASK TABLE PROBLEM'               
ERPQREFQ EQU   37                                                               
         DC    CL60'ERROR PQ REPORT EXTRACT DDREFORM CALL'                      
ERSQLBRQ EQU   38                                                               
         DC    CL60'ERROR READING SQL BOOK RECORD'                              
ERSQLBOQ EQU   39                                                               
         DC    CL60'ERROR PROCESSING SQL BOOK RECORD - MEMORY OVERFLOW'         
ERSUBSYQ EQU   40                                                               
         DC    CL60'ERROR RETURN FROM EXTRACT SUB SYSTEM MODULE'                
ERHDBOPQ EQU   41                                                               
         DC    CL60'ERROR IN HOST DATA BASE OPEN ROUTINE'                       
ERHDBCOQ EQU   42                                                               
         DC    CL60'ERROR IN HOST DATA BASE COMMIT ROUTINE'                     
ERHDBCLQ EQU   43                                                               
         DC    CL60'ERROR IN HOST DATA BASE CLOSE ROUTINE'                      
ERHDBLXQ EQU   44                                                               
         DC    CL60'ERROR IN HOST DATA BASE LOGXTR ROUTINE'                     
ERLMNFQ  EQU   45                                                               
         DC    CL60'LOAD MODULE NOT FOUND FOR THIS SYSTEM,SUBSYSTEM'            
ERCOSRFQ EQU   46                                                               
         DC    CL60'CAN''T OPEN EXTRACT SYSTEM''S RECOVERY FILE'                
ERCRNGQ  EQU   47                                                               
         DC    CL60'INVALID CLIENT CODE RANGE'                                  
ERVMACQ  EQU   48                                                               
         DC    CL60'ACTIVE VERMONT(S) FOUND AT CLOSE - SEE XLOG'                
ERLDPHSQ EQU   49                                                               
         DC    CL60'LOADPHASE= REQUIRES MODE=LOAD AND SPECIFIC AGENCY'          
                                                                                
***********************************************************************         
* STATUS MESSAGE STRINGS                                                        
***********************************************************************         
MSGTAB   DS    0H                                                               
MSBXSYSQ EQU   0                                                                
         DC    CL60'BUILD EXTRACT SYSTEM TABLE FROM XAGENCY RECORDS'            
MSBXSLSQ EQU   1                                                                
         DC    CL60'BUILD ESS SERVER LISTS FOM XTRANS/XAPPLIC RECORDS'          
MSPLOADQ EQU   2                                                                
         DC    CL60'PROCESS EXTRACT SYSTEM FILES IN LOAD MODE'                  
MSPSQLQ  EQU   3                                                                
         DC    CL60'PROCESS EXTRACT SYSTEM IN SQL ONLY MODE'                    
MSPPQRQ  EQU   4                                                                
         DC    CL60'PROCESS EXTRACT SYSTEM IN PQ REPORT MODE'                   
MSPUPDTQ EQU   5                                                                
         DC    CL60'PROCESS EXTRACT SYSTEM FILES IN UPDATE MODE'                
MSBXLOGQ EQU   6                                                                
         DC    CL60'BUILD RECOVERY CONTROL TABLE FROM XLOG RECORDS'             
MSCXLOGQ EQU   7                                                                
         DC    CL60'CLEAR RECOVERY CONTROL XLOG RECORDS FOR RESTART'            
MSWRTRSQ EQU   8                                                                
         DC    CL60'WRITE RECOVERY CONTROL XLOG RECORDS AFTER UPDATE'           
MSWRTXCQ EQU   9                                                                
         DC    CL60'WRITE EXTRACT FILE CONTROL XFILE RECORDS'                   
MSWAITQ  EQU   10                                                               
         DC    CL60'WAIT FOR OPERATOR COMMS OR LOOP TIME OUT'                   
MSENDQ   EQU   11                                                               
         DC    CL60'END OF EXTRACT JOB'                                         
MSSYSINQ EQU   12                                                               
         DC    CL60'SYSIN JCL PARAMETER CARDS:'                                 
MSOSTOPQ EQU   13                                                               
         DC    CL60'OPERATOR STOP COMMAND ACCEPTED'                             
MSOCLOSQ EQU   14                                                               
         DC    CL60'OPERATOR CLOSE DOWN COMMAND ACCEPTED'                       
MSPLOAXQ EQU   15                                                               
         DC    CL60'EXTRACT LOAD MODE COMPLETED THIS PASS OK'                   
MSPSQXQ  EQU   16                                                               
         DC    CL60'EXTRACT SQL ONLY MODE COMPLETED THIS PASS OK'               
MSPPQXQ  EQU   17                                                               
         DC    CL60'EXTRACT PQ REPORT MODE COMPLETED THIS PASS OK'              
MSPUPDXQ EQU   18                                                               
         DC    CL60'EXTRACT UPDATE MODE COMPLETED THIS PASS OK'                 
MSNULLQ  EQU   19                                                               
         DC    CL60'NO EXTRACT SUB SYSTEMS FOUND'                               
MSPSTATQ EQU   20                                                               
         DC    CL60'PROCESS EXTRACT STATISTICS MODE'                            
MSPSTAXQ EQU   21                                                               
         DC    CL60'EXTRACT STATISTICS MODE COMPLETED THIS PASS OK'             
MSPTRANQ EQU   22                                                               
         DC    CL60'PROCESS EXTRACT SYSTEM FILES IN TRANS MODE'                 
MSPTRAXQ EQU   23                                                               
         DC    CL60'EXTRACT TRANS MODE COMPLETED THIS PASS OK'                  
MSPENDQ  EQU   24                                                               
         DC    CL60'PROCESS EXTRACT SYSTEM FILES IN UPDATE END MODE'            
MSPENDXQ EQU   25                                                               
         DC    CL60'EXTRACT UPDATE END MODE COMPLETED THIS PASS OK'             
MSWRBDEQ EQU   26                                                               
         DC    CL60'WRITE EXTRACT BDE CONTROL RECORDS TO PQ'                    
MSBXSLMQ EQU   27                                                               
         DC    CL60'BUILD SUB SYSTEM EXTRACT LOAD MODULES'                      
MSCLOSEQ EQU   28                                                               
         DC    CL60'CLOSE DOWN SYSTEM FILES'                                    
MSCLOSDQ EQU   29                                                               
         DC    CL60'CALL SUB SYSTEM AFTER EXTRACT FILE CLOSE'                   
MSPROSFQ EQU   30                                                               
         DC    CL60'PROCESSING EXTRACT SYSTEM FILE'                             
MSSKWTQ  EQU   31                                                               
         DC    CL60'EXFILE LIMIT WAS REACHED. AUTO EXTRACT CONTINUING'          
*                                                                               
PQSERVC  DC    (PQSERVLN)X'00'    PQSERV DATA BLOCK                             
         SPACE 2                                                                
* FASYSLST                                                                      
         PRINT OFF                                                              
       ++INCLUDE FASYSLST                                                       
         PRINT ON                                                               
* DXSYSLEX                                                                      
         PRINT OFF                                                              
       ++INCLUDE DXSYSLEX                                                       
         PRINT ON                                                               
* FACTRYTAB                                                                     
         PRINT OFF                                                              
       ++INCLUDE FACTRYTAB                                                      
         PRINT ON                                                               
         SPACE 1                                                                
* DXSUBLST                                                                      
       ++INCLUDE DXSUBLST                                                       
         SPACE 1                                                                
* SYSTEM EXTRACT MODULE TABLE                                                   
*                                                                               
         DS    0D                                                               
SEXTAB   DS    0XL16                                                            
         DC    C'C',X'01',X'00',AL4(0),X'00',CL8'CXTRACT ' SQL                  
         DC    C'C',X'02',X'00',AL4(0),X'00',CL8'CXTRACT ' SEC                  
         DC    C'C',X'03',X'00',AL4(0),X'00',CL8'CXTRACT ' PRESTO               
         DC    C'C',X'04',X'00',AL4(0),X'00',CL8'CXTRACT ' TEMPO                
*&&US*&& DC    C'C',X'09',X'00',AL4(0),X'00',CL8'GXTRACT ' PRISMA               
*&&US*&& DC    C'C',X'12',X'00',AL4(0),X'00',CL8'GXTRACT ' SQL2                 
         DC    C'C',X'13',X'00',AL4(0),X'00',CL8'CXTRACT ' SQL3                 
*&&US*&& DC    C'C',X'D1',X'00',AL4(0),X'00',CL8'CXTRACT ' XML1                 
*&&US*&& DC    C'C',X'D2',X'00',AL4(0),X'00',CL8'CXTRACT ' XML2                 
*&&US*&& DC    C'A',X'01',X'00',AL4(0),X'00',CL8'AXTRACG ' SQL                  
         DC    C'A',X'03',X'00',AL4(0),X'00',CL8'PXTRACT ' PRESTO               
         DC    C'A',X'04',X'00',AL4(0),X'00',CL8'AXTRACT ' TEMPO                
*        DC    C'A',X'08',X'00',AL4(0),X'00',CL8'AXTRCOM ' COM                  
*&&US*&& DC    C'A',X'0A',X'00',AL4(0),X'00',CL8'AXTRBLK ' BLK                  
         DC    C'A',X'0E',X'00',AL4(0),X'00',CL8'AXTRACT ' PRD                  
*                                                                               
*&&UK*&& DC    C'A',X'0F',X'00',AL4(0),X'00',CL8'AGXTRCT ' DMS                  
*&&US*&& DC    C'A',X'10',X'00',AL4(0),X'00',CL8'AGXTRCT ' WAREHSE              
*                                                                               
*&&US*&& DC    C'A',X'11',X'00',AL4(0),X'00',CL8'AXTRACT ' SQL1                 
*&&US*&& DC    C'A',X'12',X'00',AL4(0),X'00',CL8'AXTRACT ' SQL2                 
*&&US*&& DC    C'A',X'13',X'00',AL4(0),X'00',CL8'AXTRACG ' SQL3                 
*&&UK*&& DC    C'A',X'13',X'00',AL4(0),X'00',CL8'AXTRACT ' SQL3                 
*&&US*&& DC    C'A',X'14',X'00',AL4(0),X'00',CL8'AXTRACT ' SQL4                 
*&&US*&& DC    C'A',X'15',X'00',AL4(0),X'00',CL8'AXTRACT ' SQL5                 
*&&US*&& DC    C'A',X'16',X'00',AL4(0),X'00',CL8'AXTRACT ' SQL6                 
*&&US*&& DC    C'A',X'17',X'00',AL4(0),X'00',CL8'AXTRACT ' SQL7                 
*&&US*&& DC    C'A',X'18',X'00',AL4(0),X'00',CL8'AXTRACT ' SQL8                 
*&&US*&& DC    C'A',X'19',X'00',AL4(0),X'00',CL8'AXTRACT ' SQL9                 
*&&UK*&& DC    C'A',X'2F',X'00',AL4(0),X'00',CL8'ADXTRCT ' ERP                  
*&&US*&& DC    C'T',X'01',X'00',AL4(0),X'00',CL8'TAXTRCT '                      
*&&US*&& DC    C'T',X'0F',X'00',AL4(0),X'00',CL8'LXTRACT '                      
*&&US*&& DC    C'T',X'E1',X'00',AL4(0),X'00',CL8'OXTRACT '                      
*&&UK*&& DC    C'A',X'07',X'00',AL4(0),X'00',CL8'APXTRCT ' PROD                 
*&&UK*&& DC    C'M',X'0D',X'00',AL4(0),X'00',CL8'APXMXTR '                      
*&&UK*&& DC    C'M',X'10',X'00',AL4(0),X'00',CL8'APXMXTR '                      
*&&UK*&& DC    C'M',X'01',X'00',AL4(0),X'00',CL8'MXTRACT '                      
*&&UK*&& DC    C'M',X'09',X'00',AL4(0),X'00',CL8'MXTRACT ' PRISMA E             
*&&UK*&& DC    C'M',X'11',X'00',AL4(0),X'00',CL8'MXTRACT '                      
*&&UK*&& DC    C'M',X'13',X'00',AL4(0),X'00',CL8'MXTRACT '                      
*&&UK*&& DC    C'M',X'01',X'03',AL4(0),X'00',CL8'MXGXTRC '                      
*&&UK*&& DC    C'M',X'20',X'00',AL4(0),X'00',CL8'MXTRACT '                      
*&&UK*&& DC    C'B',X'01',X'03',AL4(0),X'00',CL8'MXBXTRC '                      
*&&US*&& DC    C'S',X'01',X'00',AL4(0),X'00',CL8'SXTRACT '                      
*&&US*&& DC    C'S',X'09',X'00',AL4(0),X'00',CL8'SXTRACT '                      
*&&US*&& DC    C'S',X'0A',X'00',AL4(0),X'00',CL8'SXTRACT '                      
*&&US*&& DC    C'S',X'11',X'00',AL4(0),X'00',CL8'SXTRACT '                      
*&&US*&& DC    C'S',X'12',X'00',AL4(0),X'00',CL8'SXTRACT '                      
*&&US*&& DC    C'S',X'13',X'00',AL4(0),X'00',CL8'SXTRACT '                      
*&&US*&& DC    C'S',X'14',X'00',AL4(0),X'00',CL8'SXTRACT '                      
*&&US*&& DC    C'S',X'15',X'00',AL4(0),X'00',CL8'SXTRACT '                      
*&&US*&& DC    C'S',X'16',X'00',AL4(0),X'00',CL8'SXTRACT '                      
*&&US*&& DC    C'S',X'17',X'00',AL4(0),X'00',CL8'SXTRACT '                      
*&&US*&& DC    C'S',X'18',X'00',AL4(0),X'00',CL8'SXTRACT '                      
*&&US*&& DC    C'S',X'19',X'00',AL4(0),X'00',CL8'SXTRACT '                      
*&&US*&& DC    C'S',X'E1',X'00',AL4(0),X'00',CL8'SXTRACT '                      
*&&US*&& DC    C'S',X'E2',X'00',AL4(0),X'00',CL8'SXTRACT '                      
*&&US*&& DC    C'S',X'E6',X'00',AL4(0),X'00',CL8'SXTRACT '                      
*&&US*&& DC    C'S',X'E7',X'00',AL4(0),X'00',CL8'SXTRACT '                      
*&&US*&& DC    C'S',X'E8',X'00',AL4(0),X'00',CL8'SXTRACT '                      
*&&US*&& DC    C'S',X'E9',X'00',AL4(0),X'00',CL8'SXTRACT '                      
*&&US*&& DC    C'S',X'EA',X'00',AL4(0),X'00',CL8'SXTRACT '                      
*&&US*&& DC    C'S',X'EB',X'00',AL4(0),X'00',CL8'SXTRACT '                      
*&&US*&& DC    C'S',X'EC',X'00',AL4(0),X'00',CL8'SXTRACT '                      
*&&US*&& DC    C'R',X'01',X'00',AL4(0),X'00',CL8'RXTRACT '                      
*&&US*&& DC    C'R',X'0A',X'00',AL4(0),X'00',CL8'RXTRACT '                      
*&&US*&& DC    C'R',X'11',X'00',AL4(0),X'00',CL8'RXTRACT '                      
*&&US*&& DC    C'R',X'12',X'00',AL4(0),X'00',CL8'RXTRACT '                      
*&&US*&& DC    C'R',X'13',X'00',AL4(0),X'00',CL8'RXTRACT '                      
*&&US*&& DC    C'R',X'14',X'00',AL4(0),X'00',CL8'RXTRACT '                      
*&&US*&& DC    C'R',X'15',X'00',AL4(0),X'00',CL8'RXTRACT '                      
*&&US*&& DC    C'R',X'16',X'00',AL4(0),X'00',CL8'RXTRACT '                      
*&&US*&& DC    C'R',X'17',X'00',AL4(0),X'00',CL8'RXTRACT '                      
*&&US*&& DC    C'R',X'18',X'00',AL4(0),X'00',CL8'RXTRACT '                      
*&&US*&& DC    C'R',X'19',X'00',AL4(0),X'00',CL8'RXTRACT '                      
*&&US*&& DC    C'R',X'E1',X'00',AL4(0),X'00',CL8'RXTRACT '                      
*&&US*&& DC    C'P',X'01',X'00',AL4(0),X'00',CL8'QXTRACT '                      
*&&US*&& DC    C'P',X'09',X'00',AL4(0),X'00',CL8'QXTRACT '                      
*&&US*&& DC    C'P',X'0A',X'00',AL4(0),X'00',CL8'QXTRBLK '                      
*&&US*&& DC    C'P',X'11',X'00',AL4(0),X'00',CL8'QXTRACT '                      
*&&US*&& DC    C'P',X'12',X'00',AL4(0),X'00',CL8'QXTRACT '                      
*&&US*&& DC    C'P',X'13',X'00',AL4(0),X'00',CL8'QXTRACT '                      
*&&US*&& DC    C'P',X'14',X'00',AL4(0),X'00',CL8'QXTRACT '                      
*&&US*&& DC    C'P',X'15',X'00',AL4(0),X'00',CL8'QXTRACT '                      
*&&US*&& DC    C'P',X'16',X'00',AL4(0),X'00',CL8'QXTRACT '                      
*&&US*&& DC    C'P',X'17',X'00',AL4(0),X'00',CL8'QXTRACT '                      
*&&US*&& DC    C'P',X'18',X'00',AL4(0),X'00',CL8'QXTRACT '                      
*&&US*&& DC    C'P',X'19',X'00',AL4(0),X'00',CL8'QXTRACT '                      
*&&US*&& DC    C'P',X'E1',X'00',AL4(0),X'00',CL8'QXTRACT '                      
*&&US*&& DC    C'P',X'E2',X'00',AL4(0),X'00',CL8'QXTRACT '                      
*&&US*&& DC    C'N',X'01',X'00',AL4(0),X'00',CL8'NXTRACT '                      
*&&US*&& DC    C'N',X'09',X'00',AL4(0),X'00',CL8'NXTRACT '                      
*&&US*&& DC    C'N',X'0A',X'00',AL4(0),X'00',CL8'NXTRBLK '                      
*&&US*&& DC    C'N',X'11',X'00',AL4(0),X'00',CL8'NXTRACT '                      
*&&US*&& DC    C'N',X'12',X'00',AL4(0),X'00',CL8'NXTRACT '                      
*&&US*&& DC    C'N',X'13',X'00',AL4(0),X'00',CL8'NXTRACT '                      
*&&US*&& DC    C'N',X'14',X'00',AL4(0),X'00',CL8'NXTRACT '                      
*&&US*&& DC    C'N',X'15',X'00',AL4(0),X'00',CL8'NXTRACT '                      
*&&US*&& DC    C'N',X'16',X'00',AL4(0),X'00',CL8'NXTRACT '                      
*&&US*&& DC    C'N',X'17',X'00',AL4(0),X'00',CL8'NXTRACT '                      
*&&US*&& DC    C'N',X'18',X'00',AL4(0),X'00',CL8'NXTRACT '                      
*&&US*&& DC    C'N',X'19',X'00',AL4(0),X'00',CL8'NXTRACT '                      
*&&US*&& DC    C'N',X'E1',X'00',AL4(0),X'00',CL8'NXTRACT '                      
*&&US*&& DC    C'N',X'E2',X'00',AL4(0),X'00',CL8'NXTRACT '                      
*&&US*&& DC    C'N',X'E3',X'00',AL4(0),X'00',CL8'NXTRACT '                      
*&&US*&& DC    C'N',X'E4',X'00',AL4(0),X'00',CL8'NXTRACT '                      
*&&US*&& DC    C'N',X'E5',X'00',AL4(0),X'00',CL8'NXTRACT '                      
*&&US*&& DC    C'N',X'E6',X'00',AL4(0),X'00',CL8'NXTRACT '                      
*&&US*&& DC    C'N',X'E8',X'00',AL4(0),X'00',CL8'NXTRACT '                      
SEXTABX  DC    X'00'                                                            
SEXCODE  EQU   0                                                                
SEXSUBS  EQU   1                                                                
SEXCTRY  EQU   2                                                                
SEXEXFLG EQU   3                   OPEN(BIT80),CLOSE(BIT40)                     
SEXEXOPQ EQU   X'80'                                                            
SEXEXCLQ EQU   X'40'                                                            
SEXEXT   EQU   4                                                                
SEXNAME  EQU   8                                                                
*                                                                               
* NO LOAD TABLE: DON'T LOAD PHASE FOR THIS SYSTEM-SUBSYSTEM WHEN                
* RUNNING WITH TYPE=AUTO                                                        
* XL1(SYSTEM),XL1(SUBSYSTEM)                                                    
NOLOADTB DS    0XL2                                                             
         DC    C'C',X'12'          GXTRACT                                      
         DC    C'A',X'08'          AXTRCOM                                      
         DC    C'A',X'0A'          AXTRBLK                                      
         DC    C'A',X'10'          AGXTRCT                                      
         DC    C'P',X'0A'          QXTRBLK                                      
         DC    C'N',X'0A'          NXTRBLK                                      
NOLOADTX DC    X'00'               EOT                                          
*                                                                               
* CARDTBL DEFINES JOB CONTROL INPUT PARAMETER CARDS                             
* AL1    LENGTH OF CARD NAME                                                    
* AL1    ACTION ROUTINE NUMBER                                                  
* XL1    ACTION FLAGS                                                           
* CL12   CARD NAME                                                              
*                                                                               
CARDTBL  DS    0CL15                                                            
         DC    AL1(07,01),X'00',CL12'SYSTEM='                                   
         DC    AL1(07,02),X'00',CL12'AGENCY='                                   
         DC    AL1(06,03),X'00',CL12'MEDIA='                                    
         DC    AL1(05,04),X'00',CL12'TIME='                                     
         DC    AL1(06,05),X'00',CL12'INPUT='                                    
         DC    AL1(05,06),X'00',CL12'DATE='                                     
         DC    AL1(08,07),X'00',CL12'COMPANY='                                  
         DC    AL1(05,08),X'00',CL12'MODE='                                     
         DC    AL1(05,09),X'00',CL12'TYPE='                                     
         DC    AL1(07,10),X'00',CL12'FACPAK='                                   
         DC    AL1(06,11),X'00',CL12'WRITE='                                    
         DC    AL1(06,12),X'00',CL12'PATCH='                                    
         DC    AL1(06,13),X'00',CL12'DDSIO='                                    
         DC    AL1(07,14),X'00',CL12'MEDAGY='                                   
         DC    AL1(08,15),X'00',CL12'MAXRECS='                                  
         DC    AL1(06,16),X'00',CL12'PSIZE='                                    
         DC    AL1(06,17),X'00',CL12'SSIZE='                                    
         DC    AL1(09,18),X'00',CL12'PLATFORM='                                 
         DC    AL1(09,19),X'00',CL12'DATEFORM='                                 
         DC    AL1(07,20),X'00',CL12'HEADER='                                   
         DC    AL1(10,21),X'00',CL12'FREQUENCY='                                
         DC    AL1(10,22),X'00',CL12'EXTRATIME='                                
         DC    AL1(10,23),X'00',CL12'SLEEPTIME='                                
         DC    AL1(05,24),X'00',CL12'NAME='                                     
         DC    AL1(05,25),X'00',CL12'SEND='                                     
         DC    AL1(07,26),X'00',CL12'SUBSYS='                                   
         DC    AL1(06,27),X'00',CL12'CLOSE='                                    
         DC    AL1(06,28),X'00',CL12'START='                                    
         DC    AL1(08,29),X'00',CL12'EXFCODE='                                  
         DC    AL1(08,30),X'00',CL12'EXFTIME='                                  
         DC    AL1(10,31),X'00',CL12'DELIMITER='                                
         DC    AL1(04,32),X'00',CL12'EOR='                                      
         DC    AL1(05,33),X'00',CL12'TEXT='                                     
         DC    AL1(05,34),X'00',CL12'NULL='                                     
         DC    AL1(06,35),X'00',CL12'MONEY='                                    
         DC    AL1(07,36),X'00',CL12'SERVER='                                   
         DC    AL1(09,37),X'00',CL12'DATABASE='                                 
         DC    AL1(08,38),X'00',CL12'SQLUSER='                                  
         DC    AL1(09,39),X'00',CL12'PASSWORD='                                 
         DC    AL1(06,40),X'00',CL12'RESET='                                    
         DC    AL1(07,41),X'00',CL12'COMMIT='                                   
         DC    AL1(12,42),X'00',CL12'APPLICATION='                              
         DC    AL1(05,43),X'00',CL12'TEST='                                     
         DC    AL1(04,44),X'00',CL12'SQL='                                      
         DC    AL1(05,45),X'00',CL12'LOAD='                                     
         DC    AL1(06,46),X'00',CL12'CLEAR='                                    
         DC    AL1(05,47),X'00',CL12'FROM='                                     
         DC    AL1(07,48),X'00',CL12'USERID='                                   
         DC    AL1(05,49),X'00',CL12'PQID='                                     
         DC    AL1(10,50),X'00',CL12'SQLBEFORE='                                
         DC    AL1(09,51),X'00',CL12'SQLAFTER='                                 
         DC    AL1(04,52),X'00',CL12'TST='                                      
         DC    AL1(07,53),X'00',CL12'REFORM='                                   
         DC    AL1(09,54),X'00',CL12'RECOVERY='                                 
         DC    AL1(05,55),X'00',CL12'DIET='                                     
         DC    AL1(08,56),X'00',CL12'COUNTRY='                                  
         DC    AL1(05,57),X'00',CL12'AUTO='                                     
         DC    AL1(06,58),X'00',CL12'DEBUG='                                    
         DC    AL1(05,59),X'00',CL12'DUMP='                                     
         DC    AL1(04,60),X'00',CL12'ESS='                                      
         DC    AL1(08,61),X'00',CL12'VERSION='                                  
         DC    AL1(09,62),X'00',CL12'USERPARM='                                 
         DC    AL1(08,63),X'00',CL12'REPLACE='                                  
         DC    AL1(07,64),X'00',CL12'HOSTDB='                                   
         DC    AL1(10,65),X'00',CL12'DB2AUTHID='                                
         DC    AL1(10,66),X'00',CL12'DB2SUBSYS='                                
         DC    AL1(08,67),X'00',CL12'FILTERS='                                  
         DC    AL1(05,68),X'00',CL12'ZERO='                                     
         DC    AL1(07,69),X'00',CL12'DELETE='                                   
         DC    AL1(07,70),X'00',CL12'FORMAT='                                   
         DC    AL1(06,71),X'00',CL12'FIXED='                                    
         DC    AL1(08,72),X'00',CL12'ENDMODE='                                  
         DC    AL1(09,73),X'00',CL12'TRANSACT='                                 
         DC    AL1(07,74),X'00',CL12'ESCAPE='                                   
         DC    AL1(07,75),X'00',CL12'NULLIF='                                   
         DC    AL1(07,76),X'00',CL12'SCHEMA='                                   
         DC    AL1(09,77),X'00',CL12'LOCATION='                                 
         DC    AL1(06,78),X'00',CL12'ERROR='                                    
         DC    AL1(08,79),X'00',CL12'TIMENOW='                                  
         DC    AL1(05,80),X'00',CL12'DBID='                                     
         DC    AL1(07,81),X'00',CL12'SQLOUT='                                   
         DC    AL1(07,82),X'00',CL12'UDBERR='                                   
         DC    AL1(09,83),X'00',CL12'CONTINUE='                                 
         DC    AL1(07,84),X'00',CL12'UPDATE='                                   
         DC    AL1(07,85),X'00',CL12'DSPACE='                                   
         DC    AL1(07,86),X'00',CL12'HEXOUT='                                   
         DC    AL1(07,87),X'00',CL12'QUOTES='                                   
         DC    AL1(08,88),X'00',CL12'VARCHAR='                                  
         DC    AL1(05,89),X'00',CL12'READ='                                     
         DC    AL1(08,90),X'00',CL12'OFFLINE='                                  
         DC    AL1(05,91),X'00',CL12'SKIP='                                     
         DC    AL1(09,92),X'00',CL12'POSTONLY='                                 
         DC    AL1(08,93),X'00',CL12'POSTDSN='                                  
         DC    AL1(10,94),X'00',CL12'WRTCTFILE='                                
         DC    AL1(07,95),X'00',CL12'XTRACT='                                   
         DC    AL1(08,96),X'00',CL12'FILTUAD='                                  
         DC    AL1(10,97),X'00',CL12'RFMSTATUS='                                
         DC    AL1(06,98),X'00',CL12'EMAIL='                                    
         DC    AL1(04,99),X'00',CL12'RUN='                                      
         DC    AL1(10,100),X'00',CL12'SKIPFILEA='                               
         DC    AL1(04,101),X'00',CL12'CLI='                                     
         DC    AL1(04,102),X'00',CL12'NET='                                     
         DC    AL1(04,103),X'00',CL12'KEY='                                     
         DC    AL1(08,104),X'00',CL12'RFABEND='                                 
         DC    AL1(09,105),X'00',CL12'DSNLIMIT=' (ORIGINAL)                     
         DC    AL1(09,105),X'00',CL12'DCBLIMIT=' (PREFERRED)                    
         DC    AL1(05,106),X'00',CL12'ODSN='                                    
         DC    AL1(07,107),X'00',CL12'DSNAME='                                  
         DC    AL1(07,108),X'00',CL12'ALLAGY='                                  
         DC    AL1(11,109),X'00',CL12'ESSPROGRAM='                              
         DC    AL1(11,110),X'00',CL12'ESSCOMMAND='                              
         DC    AL1(07,111),X'00',CL12'THREAD='                                  
         DC    AL1(09,112),X'00',CL12'TESTDATE='                                
         DC    AL1(06,113),X'00',CL12'FLASH='                                   
         DC    AL1(09,114),X'00',CL12'CLIRANGE='                                
         DC    AL1(09,115),X'00',CL12'CLOXMODE='                                
         DC    AL1(09,116),X'00',CL12'BASICHDR='                                
         DC    AL1(10,117),X'00',CL12'TIMESLICE='                               
         DC    AL1(08,118),X'00',CL12'CHOPDSN='                                 
         DC    AL1(07,119),X'00',CL12'TSTRUN='                                  
         DC    AL1(07,120),X'00',CL12'AGXBUF='                                  
         DC    AL1(04,121),X'00',CL12'SMF='                                     
         DC    AL1(09,122),X'00',CL12'8KEXFILE='                                
         DC    AL1(10,123),X'00',CL12'KEEPEMPTY='                               
         DC    AL1(10,124),X'00',CL12'LOADPHASE='                               
CARDTBLX DC    AL1(00)                                                          
CLENGTH  EQU   0                                                                
CROUTINE EQU   1                                                                
CFLAG    EQU   2                                                                
CSTRING  EQU   3                                                                
         EJECT                                                                  
* DELIMITER KEYWORD TABLE                                                       
*                                                                               
         DS    0D                                                               
DELIMTAB DS    0XL12                                                            
         DC    C' ',X'05',CL10'SPACE     '                                      
         DC    C':',X'05',CL10'COLON     '                                      
         DC    C';',X'09',CL10'SEMICOLON '                                      
         DC    C'|',X'04',CL10'PIPE      '                                      
         DC    X'05',X'03',CL10'TAB       '                                     
         DC    AL1(DXTDNONQ),X'04',CL10'NONE      '                             
DELIMTX  DC    X'00'                                                            
         SPACE 1                                                                
* EOR (END OF RECORD) KEYWORD TABLE                                             
*                                                                               
         DS    0D                                                               
EORTAB   DS    0XL18                                                            
         DC    X'05',CL8'SPACE   ',AL1(01),CL8' '                               
         DC    X'04',CL8'CRLF    ',AL1(02),AL1(CRQ,LFQ),CL6' '                  
         DC    X'02',CL8'CR      ',AL1(01),AL1(CRQ),CL7' '                      
         DC    X'02',CL8'LF      ',AL1(01),AL1(LFQ),CL7' '                      
EORTABX  DC    X'00'                                                            
CRQ      EQU   X'0D'                                                            
LFQ      EQU   X'25'                                                            
         SPACE 1                                                                
* PLATFORM KEYWORD TABLE                                                        
*                                                                               
         DS    0D                                                               
PLATTAB  DS    0XL10                                                            
         DC    X'06',CL8'SYBASE  ',AL1(DXTPSYBQ)                                
         DC    X'03',CL8'DB2     ',AL1(DXTPDB2Q)                                
         DC    X'05',CL8'MSSQL   ',AL1(DXTPMSSQ)                                
         DC    X'05',CL8'OTHER   ',AL1(DXTPOTHQ)                                
         DC    X'04',CL8'NONE    ',AL1(DXTPNONQ)                                
PLATTABX DC    X'00'                                                            
         SPACE 1                                                                
* INPUT FILE TYPE KEYWORD TABLE                                                 
*                                                                               
         DS    0D                                                               
INPTAB   DS    0XL10                                                            
         DC    X'04',CL8'TAPE    ',AL1(DXTITAPQ)                                
         DC    X'07',CL8'EXTRACT ',AL1(DXTIEXTQ)                                
         DC    X'03',CL8'SQL     ',AL1(DXTISQLQ)                                
         DC    X'03',CL8'REPORT  ',AL1(DXTIREPQ)                                
INPTABX  DC    X'00'                                                            
         SPACE 1                                                                
         SPACE 1                                                                
* FORMAT KEYWORD TABLE                                                          
*                                                                               
         DS    0D                                                               
FORMTAB  DS    0XL10                                                            
         DC    X'06',CL8'BINARY  ',AL1(DXTFBINQ)                                
         DC    X'06',CL8'EXPORT  ',AL1(DXTFEXPQ)                                
FORMTABX DC    X'00'                                                            
         SPACE 1                                                                
* NULL CODE KEYWORD TABLE                                                       
*                                                                               
         DS    0D                                                               
NULLTAB  DS    0XL10                                                            
         DC    X'04',CL8'ZERO    ',AL1(DXTNZERQ)                                
         DC    X'06',CL8'SPACES  ',AL1(DXTNSPCQ)                                
         DC    X'04',CL8'NULL    ',AL1(DXTNNULQ)                                
         DC    X'04',CL8'NONE    ',AL1(DXTNNONQ)                                
         DC    X'01',CL8'N       ',AL1(DXTNOLNQ)                                
NULLTABX DC    X'00'                                                            
         SPACE 1                                                                
* NULLIF CODE KEYWORD TABLE                                                     
*                                                                               
         DS    0D                                                               
NLIFTAB  DS    0XL10                                                            
         DC    X'04',CL8'ZERO    ',AL1(DXTNIZRQ)                                
         DC    X'06',CL8'SPACES  ',AL1(DXTNISPQ)                                
         DC    X'04',CL8'NULL    ',AL1(DXTNINLQ)                                
NLIFTABX DC    X'00'                                                            
*                                                                               
* EXFILE EXTRACT FILE DEFINITION TABLE                                          
*                                                                               
EXFTAB   DS    0D                                                               
         DC    AL4(EXFILE1),CL8'EXFILE1 '                                       
         DC    AL4(EXFILE2),CL8'EXFILE2 '                                       
         DC    AL4(EXFILE3),CL8'EXFILE3 '                                       
         DC    AL4(EXFILE4),CL8'EXFILE4 '                                       
         DC    AL4(EXFILE5),CL8'EXFILE5 '                                       
         DC    AL4(EXFILE6),CL8'EXFILE6 '                                       
         DC    AL4(EXFILE7),CL8'EXFILE7 '                                       
         DC    AL4(EXFILE8),CL8'EXFILE8 '                                       
         DC    AL4(EXFILE9),CL8'EXFILE9 '                                       
         DC    AL4(EXFILEA),CL8'EXFILEA '                                       
         DC    AL4(EXFILEB),CL8'EXFILEB '                                       
         DC    AL4(EXFILEC),CL8'EXFILEC '                                       
         DC    AL4(EXFILED),CL8'EXFILED '                                       
         DC    AL4(EXFILEE),CL8'EXFILEE '                                       
         DC    AL4(EXFILEF),CL8'EXFILEF '                                       
         DC    AL4(EXFILEG),CL8'EXFILEG '                                       
         DC    AL4(EXFILEH),CL8'EXFILEH '                                       
         DC    AL4(EXFILEI),CL8'EXFILEI '                                       
         DC    AL4(EXFILEJ),CL8'EXFILEJ '                                       
         DC    AL4(EXFILEK),CL8'EXFILEK '                                       
         DC    AL4(EXFILEL),CL8'EXFILEL '                                       
         DC    AL4(EXFILEM),CL8'EXFILEM '                                       
         DC    AL4(EXFILEN),CL8'EXFILEN '                                       
         DC    AL4(EXFILEO),CL8'EXFILEO '                                       
         DC    AL4(EXFILEP),CL8'EXFILEP '                                       
         DC    AL4(EXFILEQ),CL8'EXFILEQ '                                       
         DC    AL4(EXFILER),CL8'EXFILER '                                       
         DC    AL4(EXFILES),CL8'EXFILES '                                       
         DC    AL4(EXFILET),CL8'EXFILET '                                       
         DC    AL4(EXFILEU),CL8'EXFILEU '                                       
         DC    AL4(EXFILEV),CL8'EXFILEV '                                       
         DC    AL4(EXFILEW),CL8'EXFILEW '                                       
         DC    AL4(EXFILEX),CL8'EXFILEX '                                       
         DC    AL4(EXFILEY),CL8'EXFILEY '                                       
         DC    AL4(EXFILEZ),CL8'EXFILEZ '                                       
         DC    AL4(EXFIL11),CL8'EXFIL11 '                                       
         DC    AL4(EXFIL12),CL8'EXFIL12 '                                       
         DC    AL4(EXFIL13),CL8'EXFIL13 '                                       
         DC    AL4(EXFIL14),CL8'EXFIL14 '                                       
         DC    AL4(EXFIL15),CL8'EXFIL15 '                                       
         DC    AL4(EXFIL16),CL8'EXFIL16 '                                       
         DC    AL4(EXFIL17),CL8'EXFIL17 '                                       
         DC    AL4(EXFIL18),CL8'EXFIL18 '                                       
         DC    AL4(EXFIL19),CL8'EXFIL19 '                                       
         DC    AL4(EXFIL20),CL8'EXFIL20 '                                       
         DC    AL4(EXFIL21),CL8'EXFIL21 '                                       
         DC    AL4(EXFIL22),CL8'EXFIL22 '                                       
         DC    AL4(EXFIL23),CL8'EXFIL23 '                                       
         DC    AL4(EXFIL24),CL8'EXFIL24 '                                       
         DC    AL4(EXFIL25),CL8'EXFIL25 '                                       
         DC    AL4(EXFIL26),CL8'EXFIL26 '                                       
         DC    AL4(EXFIL27),CL8'EXFIL27 '                                       
         DC    AL4(EXFIL28),CL8'EXFIL28 '                                       
         DC    AL4(EXFIL29),CL8'EXFIL29 '                                       
         DC    AL4(EXFIL30),CL8'EXFIL30 '                                       
         DC    AL4(EXFIL31),CL8'EXFIL31 '                                       
         DC    AL4(EXFIL32),CL8'EXFIL32 '                                       
         DC    AL4(EXFIL33),CL8'EXFIL33 '                                       
         DC    AL4(EXFIL34),CL8'EXFIL34 '                                       
         DC    AL4(EXFIL35),CL8'EXFIL35 '                                       
         DC    AL4(EXFIL36),CL8'EXFIL36 '                                       
         DC    AL4(EXFIL37),CL8'EXFIL37 '                                       
         DC    AL4(EXFIL38),CL8'EXFIL38 '                                       
         DC    AL4(EXFIL39),CL8'EXFIL39 '                                       
EXFTABX  DC    X'00'                                                            
EXFTABQ  EQU   (EXFTABX-EXFTAB)/12-1                                            
         SPACE 2                                                                
*                                                                               
* EXTRACT FILE DCBS                                                             
*                                                                               
* RECORD LENGTH EQUATES                                                         
EXF2KQ   EQU   2048                2K FOR US                                    
EXF8KQ   EQU   8192                8K FOR UK, AND US 8KEXFILE OPTION            
*                                                                               
*&&US                                                                           
EXFILE1  DCB   DDNAME=EXFILE1,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILE2  DCB   DDNAME=EXFILE2,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILE3  DCB   DDNAME=EXFILE3,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILE4  DCB   DDNAME=EXFILE4,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILE5  DCB   DDNAME=EXFILE5,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILE6  DCB   DDNAME=EXFILE6,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILE7  DCB   DDNAME=EXFILE7,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILE8  DCB   DDNAME=EXFILE8,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILE9  DCB   DDNAME=EXFILE9,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILEA  DCB   DDNAME=EXFILEA,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILEB  DCB   DDNAME=EXFILEB,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILEC  DCB   DDNAME=EXFILEC,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILED  DCB   DDNAME=EXFILED,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILEE  DCB   DDNAME=EXFILEE,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILEF  DCB   DDNAME=EXFILEF,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILEG  DCB   DDNAME=EXFILEG,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILEH  DCB   DDNAME=EXFILEH,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILEI  DCB   DDNAME=EXFILEI,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILEJ  DCB   DDNAME=EXFILEJ,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILEK  DCB   DDNAME=EXFILEK,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILEL  DCB   DDNAME=EXFILEL,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILEM  DCB   DDNAME=EXFILEM,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILEN  DCB   DDNAME=EXFILEN,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILEO  DCB   DDNAME=EXFILEO,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILEP  DCB   DDNAME=EXFILEP,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILEQ  DCB   DDNAME=EXFILEQ,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILER  DCB   DDNAME=EXFILER,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILES  DCB   DDNAME=EXFILES,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILET  DCB   DDNAME=EXFILET,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILEU  DCB   DDNAME=EXFILEU,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILEV  DCB   DDNAME=EXFILEV,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILEW  DCB   DDNAME=EXFILEW,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILEX  DCB   DDNAME=EXFILEX,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILEY  DCB   DDNAME=EXFILEY,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFILEZ  DCB   DDNAME=EXFILEZ,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL11  DCB   DDNAME=EXFIL11,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL12  DCB   DDNAME=EXFIL12,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL13  DCB   DDNAME=EXFIL13,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL14  DCB   DDNAME=EXFIL14,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL15  DCB   DDNAME=EXFIL15,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL16  DCB   DDNAME=EXFIL16,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL17  DCB   DDNAME=EXFIL17,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL18  DCB   DDNAME=EXFIL18,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL19  DCB   DDNAME=EXFIL19,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL20  DCB   DDNAME=EXFIL20,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL21  DCB   DDNAME=EXFIL21,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL22  DCB   DDNAME=EXFIL22,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL23  DCB   DDNAME=EXFIL23,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL24  DCB   DDNAME=EXFIL24,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL25  DCB   DDNAME=EXFIL25,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL26  DCB   DDNAME=EXFIL26,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL27  DCB   DDNAME=EXFIL27,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL28  DCB   DDNAME=EXFIL28,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL29  DCB   DDNAME=EXFIL29,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL30  DCB   DDNAME=EXFIL30,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL31  DCB   DDNAME=EXFIL31,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL32  DCB   DDNAME=EXFIL32,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL33  DCB   DDNAME=EXFIL33,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL34  DCB   DDNAME=EXFIL34,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL35  DCB   DDNAME=EXFIL35,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL36  DCB   DDNAME=EXFIL36,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL37  DCB   DDNAME=EXFIL37,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL38  DCB   DDNAME=EXFIL38,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
EXFIL39  DCB   DDNAME=EXFIL39,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF2KQ,BLKSIZE=0                                           
*&&                                                                             
*&&UK                                                                           
EXFILE1  DCB   DDNAME=EXFILE1,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILE2  DCB   DDNAME=EXFILE2,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILE3  DCB   DDNAME=EXFILE3,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILE4  DCB   DDNAME=EXFILE4,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILE5  DCB   DDNAME=EXFILE5,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILE6  DCB   DDNAME=EXFILE6,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILE7  DCB   DDNAME=EXFILE7,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILE8  DCB   DDNAME=EXFILE8,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILE9  DCB   DDNAME=EXFILE9,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILEA  DCB   DDNAME=EXFILEA,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILEB  DCB   DDNAME=EXFILEB,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILEC  DCB   DDNAME=EXFILEC,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILED  DCB   DDNAME=EXFILED,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILEE  DCB   DDNAME=EXFILEE,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILEF  DCB   DDNAME=EXFILEF,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILEG  DCB   DDNAME=EXFILEG,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILEH  DCB   DDNAME=EXFILEH,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILEI  DCB   DDNAME=EXFILEI,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILEJ  DCB   DDNAME=EXFILEJ,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILEK  DCB   DDNAME=EXFILEK,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILEL  DCB   DDNAME=EXFILEL,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILEM  DCB   DDNAME=EXFILEM,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILEN  DCB   DDNAME=EXFILEN,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILEO  DCB   DDNAME=EXFILEO,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILEP  DCB   DDNAME=EXFILEP,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILEQ  DCB   DDNAME=EXFILEQ,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILER  DCB   DDNAME=EXFILER,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILES  DCB   DDNAME=EXFILES,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILET  DCB   DDNAME=EXFILET,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILEU  DCB   DDNAME=EXFILEU,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILEV  DCB   DDNAME=EXFILEV,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILEW  DCB   DDNAME=EXFILEW,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILEX  DCB   DDNAME=EXFILEX,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILEY  DCB   DDNAME=EXFILEY,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFILEZ  DCB   DDNAME=EXFILEZ,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL11  DCB   DDNAME=EXFIL11,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL12  DCB   DDNAME=EXFIL12,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL13  DCB   DDNAME=EXFIL13,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL14  DCB   DDNAME=EXFIL14,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL15  DCB   DDNAME=EXFIL15,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL16  DCB   DDNAME=EXFIL16,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL17  DCB   DDNAME=EXFIL17,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL18  DCB   DDNAME=EXFIL18,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL19  DCB   DDNAME=EXFIL19,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL20  DCB   DDNAME=EXFIL20,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL21  DCB   DDNAME=EXFIL21,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL22  DCB   DDNAME=EXFIL22,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL23  DCB   DDNAME=EXFIL23,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL24  DCB   DDNAME=EXFIL24,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL25  DCB   DDNAME=EXFIL25,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL26  DCB   DDNAME=EXFIL26,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL27  DCB   DDNAME=EXFIL27,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL28  DCB   DDNAME=EXFIL28,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL29  DCB   DDNAME=EXFIL29,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL30  DCB   DDNAME=EXFIL30,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL31  DCB   DDNAME=EXFIL31,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL32  DCB   DDNAME=EXFIL32,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL33  DCB   DDNAME=EXFIL33,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL34  DCB   DDNAME=EXFIL34,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL35  DCB   DDNAME=EXFIL35,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL36  DCB   DDNAME=EXFIL36,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL37  DCB   DDNAME=EXFIL37,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL38  DCB   DDNAME=EXFIL38,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
EXFIL39  DCB   DDNAME=EXFIL39,DSORG=PS,RECFM=VB,MACRF=(PM),            *        
               LRECL=EXF8KQ,BLKSIZE=0                                           
*&&                                                                             
*                                                                               
SMFTRACE DCB   DDNAME=SMFTRACE,                                        C        
               DSORG=PS,                                               C        
               LRECL=4096,                                             C        
               RECFM=VB,                                               C        
               MACRF=PM                                                         
*                                                                               
COMFACS  DS    0D                                                               
       ++INCLUDE DDCOMFACSC                                                     
COMFAC2  DC    (CCFACLEN-CFACSTRT)X'00'                                         
*                                                                               
         EJECT                                                                  
         PRINT OFF                                                              
         IEZCOM                                                                 
         PRINT ON                                                               
         EJECT                                                                  
         IHAASCB DSECT=YES,LIST=YES                                             
         EJECT                                                                  
         DSECT                                                                  
         IEZCIB                                                                 
         PRINT ON                                                               
         EJECT                                                                  
WORKC    CSECT                     ** WORKING STORAGE POOL 1 **                 
*        DS    200000X'00'                                                      
         DS    300000X'00'                                                      
*                                                                               
DXBLOCK  CSECT                     SYSTEM EXTRACT DATA CONTROL BLOCK            
         DC    (DXBLOCKL)X'00'                                                  
DXBLOCKX EQU   *                                                                
*                                                                               
SXDTABC  CSECT                     SYSTEM AGENCY EXTRACT DRIVER TABLE           
         DC    (500*(SXDTABL))X'00'                                             
SXDTABX  EQU   *                                                                
*                                                                               
SLLIST   CSECT                     SERVER LUID LIST BLOCK                       
         DC    (500*(SXSLLSTL+(5*SXSLAPAL)))X'00'                               
SLLISTX  EQU   *                                                                
*                                                                               
SFLIST   CSECT                     FILE GENERATION LIST                         
*&&US*&& DC    (500*(SXFLLSTL))X'00'                                            
*&&UK*&& DC    (2500*(SXFLLSTL))X'00'                                           
SFLISTX  EQU   *                                                                
*                                                                               
DBLIST   CSECT                     HOST DATABASE UPDATE LIST BLOCK              
         DC    (500*(SXDBLSTL))X'00'                                            
DBLISTX  EQU   *                                                                
*                                                                               
SXDBEXT  CSECT                     HOST DATABASE SYSTEM EXTENSION TABLE         
         DC    (200*(SXDBEXTL))X'00'                                            
SXDBEXTX EQU   *                                                                
*                                                                               
SXBDET   CSECT ,                   SUSB SYSTEM BDE CONTROL TABLE                
         DC    (SXBDEMAX*SXBDETL)X'00'                                          
SXBDETX  EQU   *                                                                
SXBDEMAX EQU   500                                                              
*                                                                               
RECBUFF  CSECT                     RECORD IO AREA                               
         DS    64000X                                                           
RECBUFFX EQU   *                                                                
*                                                                               
SYSREC   CSECT                     SUB SYSTEM RECORD IO AREA                    
         DS    64000X                                                           
SYSRECX  EQU   *                                                                
*                                                                               
CPYBUFF  CSECT                     RECOVERY RECORD COPY AREA                    
         DS    64000X                                                           
CPYBUFFX EQU   *                                                                
*                                                                               
XREC     CSECT                     EXTRACT RECORD BUFFER                        
         DS    64000X                                                           
XRECX    EQU   *                                                                
*                                                                               
SQLBUFF  CSECT                     SQL DATA BUFFER                              
         DS    64000X                                                           
SQLBUFFX EQU   *                                                                
*                                                                               
TRKBUFF  CSECT                     DISK IO TRACK BUFFER                         
         DS    (60000)XL1                                                       
TRKBUFFX EQU   *                                                                
*                                                                               
REFORMC  CSECT                                                                  
         DS    XL(REFORML)         REFORM DATA BLOCK                            
REFORMCX EQU   *                                                                
*                                                                               
PQBUFF   CSECT                     PQ BUFFER                                    
         DS    (14336)XL1                                                       
PQBUFFX  EQU   *                                                                
*                                                                               
SQLWORK  CSECT                     SQL BOOK WORK AREA                           
         DS    1000X                                                            
SQLWORKX EQU   *                                                                
*                                                                               
UDBMSG   CSECT                     DXUDB MESSAGE AREA                           
         DS    XL(UDBMSGLQ)                                                     
UDBMSGLQ EQU   10000                                                            
UDBMSGX  EQU   *                                                                
*                                                                               
HDRBUFF  CSECT                     HEADER RECORD BUFFER                         
         DS    XL(2048+4)                                                       
HDRBUFFX EQU   *                                                                
*                                                                               
*                                                                               
*                                                                               
SMFBUFD  DSECT                                                                  
SMFBAGY  DS    CL2                                                              
         DS    CL6                                                              
SMFBCPU  DS    CL8                                                              
SMFBIO   DS    CL8                                                              
SMFBUFDLQ EQU  *-SMFBUFD                                                        
*                                                                               
SMFBMAX  EQU   10                  SMF BUFFER ENTRIES                           
*                                                                               
SMFBUFF  CSECT                     SMF RECORD BUFFER                            
         DS    XL(SMFBMAX*SMFBUFDLQ)                                            
SMFBUFFX EQU   *                                                                
*                                                                               
*                                                                               
*                                                                               
         EJECT                                                                  
* DXDSECTS                                                                      
       ++INCLUDE DXDSECTS                                                       
         SPACE 1                                                                
* DXSUBLSTD                                                                     
       ++INCLUDE DXSUBLSTD                                                      
         SPACE 1                                                                
* DXHDRD                                                                        
       ++INCLUDE DXHDRD                                                         
         SPACE 1                                                                
* DXTRLD                                                                        
       ++INCLUDE DXTRLD                                                         
         SPACE 1                                                                
* DXSQLD                                                                        
       ++INCLUDE DXSQLD                                                         
         SPACE 1                                                                
* DXUDBD                                                                        
       ++INCLUDE DXUDBD                                                         
         SPACE 1                                                                
* GEGENFILE                                                                     
         PRINT OFF                                                              
       ++INCLUDE GEGENFILE                                                      
         PRINT ON                                                               
         SPACE 1                                                                
* GEGENXTR                                                                      
       ++INCLUDE GEGENXTR                                                       
         SPACE 1                                                                
* GEGENBDR                                                                      
       ++INCLUDE GEGENBDR                                                       
         SPACE 1                                                                
* CTGENFILE                                                                     
         PRINT OFF                                                              
       ++INCLUDE CTGENFILE                                                      
         PRINT ON                                                               
* DDSYSELD                                                                      
         PRINT OFF                                                              
       ++INCLUDE DDSYSELD                                                       
         PRINT ON                                                               
         SPACE 1                                                                
* FASYSLSTD                                                                     
         PRINT OFF                                                              
       ++INCLUDE FASYSLSTD                                                      
         PRINT ON                                                               
         SPACE 1                                                                
* FAFACTS                                                                       
         PRINT OFF                                                              
       ++INCLUDE FAFACTS                                                        
         PRINT ON                                                               
         SPACE 1                                                                
* FAUTL                                                                         
         PRINT OFF                                                              
       ++INCLUDE FAUTL                                                          
         PRINT ON                                                               
         SPACE 1                                                                
* FACTRY                                                                        
         PRINT OFF                                                              
       ++INCLUDE FACTRY                                                         
         PRINT ON                                                               
         SPACE 1                                                                
* DDDPRINTL                                                                     
         PRINT OFF                                                              
       ++INCLUDE DDDPRINTL                                                      
         PRINT ON                                                               
         SPACE 1                                                                
* DDPERVALD                                                                     
         PRINT OFF                                                              
       ++INCLUDE DDPERVALD                                                      
         PRINT ON                                                               
         SPACE 1                                                                
* DMDTFIS                                                                       
         PRINT OFF                                                              
       ++INCLUDE DMDTFIS                                                        
         PRINT ON                                                               
         SPACE 1                                                                
* DMGREQUS                                                                      
         PRINT OFF                                                              
       ++INCLUDE DMGREQUS                                                       
         PRINT ON                                                               
         SPACE 1                                                                
* DDPQSERVD                                                                     
       ++INCLUDE DDPQSERVD                                                      
         SPACE 1                                                                
* DDREFORMD                                                                     
       ++INCLUDE DDREFORMD                                                      
         SPACE 1                                                                
* DMPRTQD                                                                       
         PRINT OFF                                                              
       ++INCLUDE DMPRTQD                                                        
         PRINT ON                                                               
         SPACE 1                                                                
* DMPRTQK                                                                       
         PRINT OFF                                                              
       ++INCLUDE DMPRTQK                                                        
         PRINT ON                                                               
* DMPRTQL                                                                       
         PRINT OFF                                                              
       ++INCLUDE DMPRTQL                                                        
         PRINT ON                                                               
         SPACE 1                                                                
* DMSYSFD                                                                       
         PRINT OFF                                                              
       ++INCLUDE DMSYSFD                                                        
         PRINT ON                                                               
* DMDTFPH                                                                       
         PRINT OFF                                                              
       ++INCLUDE DMDTFPH                                                        
         PRINT ON                                                               
*                                                                               
         SPACE 1                                                                
* FASSBOFF                                                                      
FASSBOD  DSECT                                                                  
       ++INCLUDE FASSBOFF                                                       
         SPACE 1                                                                
         EJECT                                                                  
* DMDDNAMED                                                                     
         DSECT                                                                  
       ++INCLUDE DMDDNAMED                                                      
         SPACE 1                                                                
         EJECT                                                                  
* DMRCVREXT                                                                     
RECVEXTD DSECT                                                                  
       ++INCLUDE DMRCVREXT                                                      
         SPACE 1                                                                
         EJECT                                                                  
* DSECT TO COVER RECOVERY HEADER                                                
*                                                                               
RECDS    DSECT                                                                  
RECLN    DS    XL2                 TOTAL RECORD LENGTH                          
         DS    XL2                                                              
       ++INCLUDE DMRCVRHDR                                                      
         EJECT                                                                  
* DSECT TO COVER VERMONT RECOVERY BLOCK                                         
       ++INCLUDE DMRCVRD                                                        
         EJECT                                                                  
         IEFZB4D2                                                               
*                                                                               
       ++INCLUDE DDSMFXCR                                                       
*                                                                               
         DCBD  DSORG=PS,DEVD=DA                                                 
*                                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'095DXTRACT   11/17/20'                                      
         END                                                                    
