*          DATA SET SPREPK402  AT LEVEL 019 AS OF 09/29/20                      
*PHASE SPK402A                                                                  
*INCLUDE BUFFERIN                                                               
*INCLUDE COVAIL                                                                 
*INCLUDE LOCKET                                                                 
*INCLUDE MEDPIGL                                                                
*INCLUDE SCANNER                                                                
                                                                                
***********************************************************************         
* QOPT1  -  RE-ALLOCATION OPTION                                      *         
* QOPT2  -  BASIS- D=DEMO,$=DOLLAR,N=NTP SPOTS,C=CASH                 *         
* QOPT3  -  ALLOCATE EXCESS                                           *         
* QOPT4  -  Y=TEST                                                    *         
* QOPT5  -  CANADIAN MEDIA IF COMBINED GOALS                          *         
* QOPT6  -  ZERO WEEK OPTION OVERRIDE                                 *         
* QOPT7  -  Y=SPLIT 30 OPTION                                         *         
***********************************************************************         
                                                                                
SPK402   TITLE '- SPOTPAK BRAND ALLOCATION PROGRAM'                             
                                                                                
***********************************************************************         
* USER    JIRA       DATE                  CHANGE LOG                 *         
* ---- ----------  -------- ----------------------------------------- *         
* AKAT SPEC-50249  09/29/20 INCREASE ENVS3MAX TO 150                  *         
* AKAT MOSTK-19    04/27/16 NEW -CM BAND SUPPORT FOR IHEART RADIO     *         
* AKAT DSSTK-262   01/07/16 KL REPORT TO HONOR SPILL OPT FOR MEDIA C  *         
*                                                                     *         
***********************************************************************         
SPK402   CSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 0,**SPK402                                                       
         L     RA,0(R1)                                                         
         LR    R9,RA                                                            
         AHI   R9,4096                                                          
         USING SPWORKD,RA,R9                                                    
         LA    RC,SPACEND                                                       
         USING WORKD,RC                                                         
         L     R8,MEDBUFF                                                       
         USING MEDBLOCK,R8                                                      
L        USING GBUFFK,LASTBKEY                                                  
S        USING GBUFFK,SAVEBKEY                                                  
                                                                                
         CLI   MODE,PROCBUY                                                     
         BE    PRBUY                                                            
         CLI   MODE,PROCGOAL                                                    
         BE    PRGOAL                                                           
         CLI   MODE,STAFRST                                                     
         BE    STAF                                                             
         CLI   MODE,STALAST                                                     
         BE    STAL                                                             
         CLI   MODE,MKTFRST                                                     
         BE    MKTF                                                             
         CLI   MODE,MKTLAST                                                     
         BE    MKTL                                                             
         CLI   MODE,ESTFRST                                                     
         BE    ESTF                                                             
         CLI   MODE,CLTFRST                                                     
         BE    CLTF                                                             
         CLI   MODE,REQFRST                                                     
         BE    REQF                                                             
         CLI   MODE,REQLAST                                                     
         BE    REQL                                                             
         CLI   MODE,RUNLAST                                                     
         BE    RUNL                                                             
         CLI   MODE,RUNFRST                                                     
         BE    RUNF                                                             
         J     EXIT                                                             
                                                                                
PATCHR   DC    (PATCHL)X'00'       PATCH AREA                                   
         EJECT                                                                  
***********************************************************************         
* FIRST FOR RUN                                                       *         
***********************************************************************         
                                                                                
RUNF     LA    R0,WORKD            CLEAR SPACEND TO BINARY ZEROES               
         LHI   R1,WORKL                                                         
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         LA    R0,WORKD            MOVE LITERALS TO W/S                         
         LHI   R1,LITERALL                                                      
         L     RE,=A(LITERAL)                                                   
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
         L     RF,=A(SAVER8RA)                                                  
         STM   R8,RA,0(RF)         SAVE R8-RA FOR SPHOOK/HEADHOOK               
                                                                                
         MVC   HEADHOOK,AHEDBLD    SET A(HEADHOOK)                              
                                                                                
         SR    RE,RE               SET EXCLUSION TABLE BINSRCH PARMS            
         L     RF,AXCTAB                                                        
         SR    R0,R0                                                            
         LHI   R1,XCTTABL                                                       
         LHI   R2,XCTTABL                                                       
         LHI   R3,XCTTMAX                                                       
         STM   RE,R3,XCTPARS                                                    
                                                                                
         L     RF,VMASTC           SET RUN TIME FLAGS                           
         L     R0,=F'2000000'      AND ACQUIRE BUFFER STORAGE                   
         OC    MCREMPQK-MASTD(,RF),MCREMPQK-MASTD(RF)                           
         BZ    *+8                                                              
         OI    RUNFLAG,RUNFSOON    SET RUNNING SOON                             
                                                                                
         GOTOR VCOVAIL,DMCB,C'GET',(R0),(R0)                                    
         OC    4(4,R1),4(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                                                             
         L     RF,4(R1)                                                         
         MVC   0(8,RF),=C'*BRDTAB*'                                             
         L     RE,8(R1)            GET LENGTH                                   
         LHI   R0,12               (R0=L'TABLE HEADER)                          
         SR    RE,R0               SUBTRACT FROM TABLE SIZE                     
         BP    *+6                                                              
         DC    H'0'                                                             
         STCM  RE,15,BRDTABL       SET AS TABLE SIZE IN W/S                     
         STCM  RE,15,8(RF)         AND ALSO KEEP IN TABLE                       
         AR    RF,R0                                                            
         ST    RF,ABRDTAB          SET A(START OF TABLE)                        
         AR    RF,RE               RF=A(END OF TABLE)                           
         L     RE,VMASTC           SET END AS NEW DUMP END                      
         ST    RF,MCDMPEND-MASTD(RE)                                            
                                                                                
         L     RE,SSB              SET TO RECOVER OFFLINE COPIES                
         OI    SSOSTAT2-SSBD(RE),SSOSROLC                                       
                                                                                
RUNFX    J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* FIRST FOR REQUEST                                                   *         
***********************************************************************         
                                                                                
REQF     MVI   REQFLAG1,0                                                       
         OI    RQOPTS,RQOPTS_1DEC  FORCE 1 DECIMAL REPORTING                    
                                                                                
         GOTOR DATCON,DMCB,(0,QSTART),(2,CSTART)                                
         GOTOR (RF),(R1),(0,QEND),(2,CEND)                                      
                                                                                
         LHI   RE,PTDEMO-PTBUFFD                                                
         LHI   RF,L'PTDEMO-1                                                    
         LHI   R0,PTWGHT-PTBUFFD                                                
         LHI   R1,L'PTWGHT-1                                                    
         STM   RE,R1,DEMOVALS      SET DISPS/LENS OF DEMO VALUES                
                                                                                
         MVI   PGRUNA,NOQ                                                       
         CLI   QPGR,SPACE          IF PGR REQ                                   
         BNH   *+8                                                              
         MVI   PGRUNA,YESQ         SET TO INCLUDE UNA IN PGR/POL REQ            
         MVC   PATCH(PATCHL),PATCHR                                             
         MVC   MEDNUMPE,FW1                                                     
         LHI   R0,MEDXCHG-MEDDATA                                               
         ST    R0,MEDLCHNK                                                      
         LHI   R0,MAXWEEKS+1                                                    
         STCM  R0,15,MEDNUMWK                                                   
                                                                                
         MVI   RQDAYPT,YESQ                                                     
         MVI   RQEQUIV,YESQ                                                     
         MVC   PAGE,HW1                                                         
         XC    XCTNREC,XCTNREC     SET NO EXCLUSION TABLE ENTRIES               
                                                                                
         MVC   SVQSTA,SPACES       SAVE REQUESTED STATION                       
         MVC   SVBIGSTA,SPACES                                                  
         CLI   QSTA,SPACE                                                       
         BNH   REQF02                                                           
         CLI   QSTA,ZONE                                                        
         BNL   REQF02                                                           
         CLC   ALL3,QSTA                                                        
         BE    REQF02                                                           
         MVC   SVQSTA(L'QSTA),QSTA SAVE REQUESTED STATION                       
         CLI   QSTA+4,C'T'         DROP T OF WXXXT                              
         BNE   *+8                                                              
         MVI   SVQSTA+4,SPACE                                                   
         CLI   QSTA+4,C'C'         CONVERT 'C' TO 'N'                           
         BNE   REQF02                                                           
         CLI   QMED,C'R'           MEDIA R?                                     
         BE    REQF02              YES - BAND C IS IHEART - NOT CANADA!         
         MVI   SVQSTA+4,C'N'                                                    
                                                                                
REQF02   CLI   QPGR,SPACE          TEST PRODUCT GROUP REQUEST                   
         BNH   REQF04                                                           
         CLI   QPRD,ZONE           UNLESS HAVE SINGLE PRODUCT GROUP REQ         
         BNL   *+12                                                             
         MVI   QPGR,SPACE          FORGET THE WHOLE THING                       
         B     REQF04                                                           
                                                                                
         NI    QPGR,FF-SPACE       MAKE LOWER CASE FOR POL                      
         LA    RF,QPRD+L'QPRD-1    GET LENGTH OF PGR CODE                       
         CLI   0(RF),SPACE                                                      
         BE    *+12                                                             
         CLI   0(RF),ASTERISK                                                   
         BNE   *+8                                                              
         BCT   RF,*-16                                                          
         LA    R0,QPRD                                                          
         SR    RF,R0                                                            
         STC   RF,PRDCLCLN         COMPARE LENGTH (-1)                          
         MVC   SVPGRQ,QPRD         SAVE PRODUCT GROUP CODE                      
                                                                                
REQF04   TM    RUNFLAG,RUNFSOON    TEST RUNNING SOON                            
         JZ    EXIT                                                             
         CLI   QOPT4,YESQ          TEST IF AN UPDATIVE SOON RUN                 
         JE    EXIT                                                             
         OI    RUNFLAG,RUNFLOCK    SET MUST ISSUE UNLOCK AT RUNLAST             
                                                                                
         USING LKKEYD,LOCKKEYW     AND BUILD LOCK KEY                           
         XC    LOCKEY,LOCKEY                                                    
         L     RF,VMASTC                                                        
         L     RF,MCUTL-MASTD(RF)                                               
         MVC   LOCKSE,4(RF)                                                     
         MVC   LOCKAGY,QAGY                                                     
         MVC   LOCKRTY,=AL2(LKBARTYQ)                                           
         MVC   LOCKKEY,SPACES                                                   
         MVC   LKBAMED,QMED                                                     
         MVC   LKBACLT,QCLT                                                     
         CLC   QEST,ALL            FOR A MULTIPLE ESTIMATE REQUEST              
         JE    EXIT                ALL ESTIMATES WERE LOCKED                    
         CLC   =C'NO',QEST                                                      
         JE    EXIT                                                             
         CLI   QESTEND,SPACE                                                    
         JNE   EXIT                                                             
         MVC   LKBAEST,QEST        ELSE A SINGLE ESTIMATE WAS LOCKED            
         J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* LAST FOR REQUEST                                                    *         
***********************************************************************         
                                                                                
REQL     TM    REQFLAG1,REQFQUIT+REQFESTE TEST TO QUIT REQUEST/EST ERRS         
         JNZ   EXIT                                                             
         CLI   RQMED,NETLETQ       DONE IF NOT NETWORK                          
         JNE   EXIT                                                             
         MVI   MODE,ESTLAST                                                     
         B     MKTL02              FOR NETWORK DO ALLOC NOW                     
                                                                                
***********************************************************************         
* LAST FOR RUN                                                        *         
***********************************************************************         
                                                                                
RUNL     GOTOR BU1CLO              CLOSE BUFFER 1                               
         GOTOR BU2CLO              CLOSE BUFFER 2                               
                                                                                
         TM    RUNFLAG,RUNFLOCK    ISSUE UNLOCK IF UPDATIVE SOON RUN            
         JZ    EXIT                                                             
         GOTOR VLOCKET,DMCB,('LKUNLKQ',LKKEYD),ACOMFACS                         
         CLI   4(R1),0                                                          
         JE    EXIT                                                             
         DC    H'0'                                                             
                                                                                
***********************************************************************         
* FIRST FOR CLIENT                                                    *         
***********************************************************************         
                                                                                
CLTF     GOTOR CLTFST                                                           
         J     EXIT                                                             
                                                                                
***********************************************************************         
* FIRST FOR ESTIMATE                                                  *         
***********************************************************************         
                                                                                
ESTF     GOTOR ESTFST                                                           
         CLI   RQMED,NETLETQ       FOR NETWORK                                  
         BE    MKTF02              MKTFRST DONE NOW                             
         J     EXIT                                                             
                                                                                
***********************************************************************         
* FIRST FOR STATION                                                   *         
***********************************************************************         
                                                                                
STAF     XC    NETSTAV(NETSTAVL),NETSTAV                                        
         J     EXIT                                                             
                                                                                
***********************************************************************         
* LAST FOR STATION                                                    *         
***********************************************************************         
                                                                                
STAL     GOTOR GETPXC                                                           
         J     EXIT                                                             
                                                                                
***********************************************************************         
* PROCESS A GOAL RECORD                                               *         
***********************************************************************         
                                                                                
PRGOAL   GOTOR PRCGOL                                                           
         J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* FIRST FOR MARKET                                                    *         
***********************************************************************         
                                                                                
MKTF     CLI   RQMED,NETLETQ       FOR NETWORK SKIP MKTFRST                     
         JE    EXIT                (DONE AT ESTFRST)                            
MKTF02   L     RF,AENV1SET         CLEAR ENV 1 TAB                              
         L     RF,ENVSATAB-ENVSETD(RF)                                          
         MVI   ENVS1KEY-ENVTABD(RF),ENVSEOTQ                                    
         L     RF,AENV2SET         CLEAR ENV 2 TAB                              
         L     RF,ENVSATAB-ENVSETD(RF)                                          
         MVI   ENVS2KEY-ENVTABD(RF),ENVSEOTQ                                    
         L     RF,AENV3SET         CLEAR ENV 3 TAB                              
         L     RF,ENVSATAB-ENVSETD(RF)                                          
         MVI   ENVS3KEY-ENVTABD(RF),ENVSEOTQ                                    
                                                                                
         GOTOR BU1INI              INITIALIZE BUFFER 1                          
         GOTOR BU2INI              INITIALIZE BUFFER 2                          
                                                                                
         MVI   DSCNT,0                                                          
         NI    REQFLAG1,FF-(REQFCHDR)                                           
         MVI   MKTBUYGL,0                                                       
         XC    XCTNREC,XCTNREC     CLEAR EXCLUSION TABLE                        
         L     RF,PRDBUFF          CLEAR PTSTAT IN PRDBUFF                      
         LHI   R0,UGPIGPRD                                                      
         NI    PTSTAT-PTBUFFD(RF),PTSPIGPQ+PTSPIGEQ+PTSPPGEQ+PTSCLSEQ           
         AH    RF,PRDBUFLN                                                      
         BCT   R0,*-8                                                           
                                                                                
MKTFX    J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* LAST FOR MARKET                                                     *         
*                                                                     *         
* NOTE - ENTER AT MKTL02 FOR NETWORK AT REQLAST                       *         
***********************************************************************         
                                                                                
MKTL     CLI   RQMED,NETLETQ       FOR NETWORK SKIP MKTLAST                     
         JE    EXIT                (DONE AT REQLAST)                            
                                                                                
MKTL02   GOTOR GETPXC              GET 'ALL' STATION EXCLUSIONS                 
         GOTOR PARREP              PRINT PARAMETER REPORT                       
         GOTOR SETSLT              SET SLOT COUNTS FOR ENV1'S                   
         GOTOR CPYGOL              COPY GOALS FOR SUB-DAYPARTS                  
         GOTOR DPTBAL              DAYPART BALANCING                            
                                                                                
         TM    DIAGNOP2,DPRTBUFQ   TEST TRACE REQUIRED                          
         BZ    *+8                                                              
         GOTOR TRCBUF              YES - PRINT BUFFER 1 TRACE                   
                                                                                
         XC    NPRDS,NPRDS                                                      
         XC    GBUFFK,GBUFFK                                                    
         XC    L.GBUFFK,L.GBUFFK                                                
         GOTOR BU1RDH              READ HIGH BUFFER 1                           
         B     MKTL10                                                           
MKTL08   GOTOR BU1RSQ              READ SEQUENTIAL BUFFER 1                     
MKTL10   BZ    *+14                                                             
         MVC   GBUFFK(L'GBDPT+L'GBSLN),FFS                                      
         B     *+14                                                             
         OC    GBROW(GBROWL),GBROW SKIP NULL RECORDS                            
         BZ    MKTL08                                                           
         CLC   GBDPT,L.GBDPT       TEST CHANGE OF DAYPART                       
         BNE   MKTL12              YES                                          
         CLC   GBSLN,L.GBSLN       TEST CHANGE OF SPOT LENGTH                   
         BE    MKTL32                                                           
MKTL12   MVC   S.GBUFFK,GBUFFK                                                  
         OC    L.GBUFFK,L.GBUFFK                                                
         BZ    MKTL30                                                           
         MVC   DPTDESC,=CL24'All Dayparts/Lengths'                              
         CLC   ALLDS,L.GBDPT                                                    
         BE    MKTL20                                                           
         MVC   DPTDESC,=CL24'Daypart/Length = '                                 
         LA    R3,DPTDESC+17                                                    
         MVC   0(3,R3),ALL                                                      
         CLI   L.GBDPT,ALLDPT                                                   
         BE    MKTL18                                                           
         L     RF,ADDPTTAB         A(DAYPART LIST)                              
MKTL14   CLC   L.GBDPT,0(RF)                                                    
         BE    MKTL16                                                           
         AHI   RF,5                                                             
         CLI   0(RF),0                                                          
         BNE   MKTL14              IF EXPANSION NOT FOUND USE CODE              
         MVC   2(1,R3),L.GBDPT                                                  
         MVC   0(2,R3),SPACES                                                   
         B     MKTL18                                                           
MKTL16   MVC   0(3,R3),2(RF)                                                    
         CLI   0(R3),SPACE         IF EXPANSION NOT FOUND USE CODE              
         BH    MKTL18                                                           
         MVC   2(1,R3),0(RF)                                                    
MKTL18   CLI   L.GBSLN,ALLSLN                                                   
         BNE   *+18                                                             
         MVI   3(R3),SLASH                                                      
         MVC   4(3,R3),ALL                                                      
         B     MKTL20                                                           
         EDIT  (B1,L.GBSLN),(3,4(R3)),ALIGN=LEFT                                
MKTL20   NI    REQFLAG1,FF-(REQFESTE) CLEAR EST CHECK SWITCH                    
         OC    NPRDS,NPRDS                                                      
         BZ    MKTL24              NO GOALS                                     
                                                                                
         GOTOR WKYBAL              DO RESCALING                                 
         GOTOR CHKEST              TEST ALL NEEDED ESTS OPEN                    
         JNE   ENDREQ                                                           
                                                                                
         CLI   ZERWKSW,0           ZERO WEEK ERROR                              
         BNE   MKTL26              SKIP ALLOC                                   
         MVI   CELLD,TPREDEM-TABDATA WRITE OUT FROM +4                          
         TM    REQFLAG1,REQFMIXB   UNLESS MIXED GOAL BASE                       
         BZ    *+8                                                              
         MVI   CELLD,TRSCGOL-TABDATA THEN USE +0                                
         MVI   TYP,TRSCGOLQ        FINAL GOALS                                  
         L     R1,ABUFF1                                                        
         USING BUFFD,R1                                                         
         OI    BUFFINDS,BUFFIRCM                                                
         GOTOR ROWOUT                                                           
         NI    BUFFINDS,FF-(BUFFIRCM)                                           
         DROP  R1                                                               
MKTL24   CLI   RSWKOPT,RSWKBALQ    SKIP ALLOC IF DOING BALANCING ONLY           
         BE    MKTL30                                                           
         GOTOR ALLOC                                                            
*                                  PRINT SUMMARY (WEEKLY) REPORT                
MKTL26   LH    R0,NWKSP1           WEEKS (INCLUDING TOTAL)                      
         LHI   R1,MAXWKPP          MAX WEEKS PER REPORT PAGE                    
         SR    R2,R2               STARTING WEEK NUMBER                         
MKTL28   CR    R0,R1               WILL WHATS LEFT FIT ON THIS PAGE             
         BNL   *+6                                                              
         LR    R1,R0               YES, DO IT ALL                               
         STH   R1,RPTNWKS                                                       
         STC   R2,RPTSWK                                                        
         GOTOR SUMRPT                                                           
         AHI   R2,MAXWKPP                                                       
         SR    R0,R1                                                            
         BP    MKTL28              DO NEXT SET OF WEEKS                         
                                                                                
         GOTOR PGMRCP              PROGRAM RECAP                                
                                                                                
MKTL30   LHI   RF,24               SET 'CELL WIDTH'                             
         STH   RF,CELLWID          ISN'T 8 ENOUGH? DOES IT MATTER?              
         LH    RF,NWKS                                                          
         AHI   RF,1                                                             
         MH    RF,CELLWID                                                       
         AHI   RF,TABDATA-TABD                                                  
         STH   RF,LROW             LENGTH OF ROW                                
         A     RF,ASUPROW                                                       
         ST    RF,ATOTROW          TOTAL ROW                                    
         AH    RF,LROW                                                          
         ST    RF,AFSTBRD          1ST BRAND                                    
         XC    NPRDS,NPRDS                                                      
         XC    LPRDSLN,LPRDSLN                                                  
         GOTOR CLRBRD              CLEAR BRDTAB TO BINARY ZEROES                
         MVC   GBUFFK,S.GBUFFK     RESTORE SEQ READING                          
         CLI   GBUFFK,FF                                                        
         BE    MKTL52                                                           
         GOTOR BU1RDH              READ HIGH BUFFER 1                           
         MVC   L.GBUFFK,GBUFFK                                                  
         SR    RF,RF                                                            
         IC    RF,DSCNT            COUNT NUMBER OF DAYPART/SLNS                 
         AHI   RF,1                                                             
         STC   RF,DSCNT                                                         
MKTL32   MVI   CELLD,TRSCGOL-TABDATA CONTINUATION OF DAYPART/SLN                
         CLI   GBTYP,TRSCGOLQ                                                   
         BE    MKTL40                                                           
         CLI   GBTYP,TGOLDEMQ      GOAL DEMO                                    
         BE    MKTL34                                                           
         CLI   GBTYP,TGOLDOLQ      GOAL DOLLARS                                 
         BE    MKTL36                                                           
         B     MKTL08                                                           
MKTL34   CLI   GOALOPT,GOALDOLS    DOLLARS OR RATINGS                           
         BE    MKTL08                                                           
         B     MKTL38                                                           
MKTL36   CLI   GOALOPT,GOALDOLS                                                 
         BNE   MKTL08                                                           
MKTL38   CLI   GBTYP,TPREDEMQ                                                   
         BNL   MKTL40                                                           
         CLI   GBPRD,SUPPRD        SUPPLY                                       
         BE    MKTL40                                                           
         CLI   DSSW,DSSYESQ        IF HAVE DAYPART RESCALED                     
         BE    MKTL08              USE INTERMEDIATE GOALS HERE-TYP 41           
MKTL40   CLI   GBPRD,SUPPRD        COUNT PRODUCTS                               
         BE    MKTL46                                                           
         CLI   GBPRD,TOTPRD                                                     
         BE    MKTL46                                                           
         CLC   GBPRD,LPRD                                                       
         BE    MKTL46                                                           
         MVC   LPRD,GBPRD                                                       
         MVC   LSLN,GBSLN                                                       
         LH    RF,NPRDS            BUMP PRODUCT COUNT                           
         CHI   RF,MAXPRDM                                                       
         BNL   *+16                                                             
         AHI   RF,1                                                             
         STH   RF,NPRDS                                                         
         B     MKTL46                                                           
         MVC   P1(45),=C'*** Too many products in market NNNN, Max=NNN'         
         BCTR  RF,0                                                             
         CVD   RF,DUB                                                           
         OI    DUB+L'DUB-1,DIGIT                                                
         UNPK  P1+42(3),DUB                                                     
         MVC   P1+32(4),MKT                                                     
         GOTOR REPORT                                                           
         J     EXIT                                                             
                                                                                
MKTL46   GOTOR ROWIN                                                            
         B     MKTL08                                                           
                                                                                
MKTL52   CLI   DSCNT,1             TEST MULTIPLE DAYPART/SLNS PRESENT           
         BNH   MKTL56                                                           
         XC    L.GBUFFK,L.GBUFFK                                                
         MVC   DPTDESC,=CL24'All Dayparts/Lengths'                              
*                                  PRINT SUMMARY (WEEKLY) REPORT                
         LH    R0,NWKSP1           WEEKS (INCLUDING TOTAL)                      
         LHI   R1,MAXWKPP          MAX WEEKS PER REPORT PAGE                    
         SR    R2,R2               STARTING WEEK NUMBER                         
MKTL54   CR    R0,R1               WILL WHATS LEFT FIT ON THIS PAGE             
         BNL   *+6                                                              
         LR    R1,R0               YES, DO IT ALL                               
         STH   R1,RPTNWKS                                                       
         STC   R2,RPTSWK                                                        
         GOTOR SUMRPT                                                           
         AHI   R2,MAXWKPP                                                       
         SR    R0,R1                                                            
         BP    MKTL54              DO NEXT SET OF WEEKS                         
         GOTOR PGMRCP              PROGRAM RECAP                                
                                                                                
MKTL56   MVI   PBMODE,PBMLSTQ                                                   
         GOTOR PRTBUF                                                           
         GOTOR UPDBUY                                                           
MKTLX    J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* LOOK-UP AND POST PRODUCT EXCLUSIONS                                 *         
***********************************************************************         
                                                                                
GETPXC   NTR1  ,                                                                
         CLC   STA,SVQSTA          IF RIGHT STATION FOR ONE STA REQ             
         BNE   *+10                                                             
         MVC   SVBIGSTA,BIGSTA     SAVE FULL STATION                            
                                                                                
         MVI   FULL,XCTETSTA       SET STATION LOOKUP                           
         MVC   FULL+1(L'PXCKSTA),BSTA                                           
         CLI   QMED,COMLETQ        TEST COMBINED CANDIAN REQUEST                
         BNE   *+8                                                              
         MVI   FULL+3,2            YES - FIX THE STATION KEY                    
         CLI   MODE,STALAST                                                     
         BE    GETPXC02                                                         
         MVI   FULL,XCTETMKT       SET MARKET LOOKUP                            
         MVC   FULL+1(L'PXCKSTA),FFS                                            
                                                                                
GETPXC02 LA    R2,KEY              READ PRODUCT EXCLUSION RECORDS               
         USING PXCRECD,R2                                                       
         XC    PXCKEY,PXCKEY                                                    
         MVI   PXCKTYP+0,PXCKTYPQ                                               
         MVI   PXCKTYP+1,PXCKSUBQ                                               
         MVC   PXCKAGM,BAGYMD                                                   
         MVC   PXCKCLT,BCLT                                                     
         MVC   PXCKSTA,FULL+1      SET STATION                                  
                                                                                
         L     RF,APXCREC                                                       
         ST    RF,AREC                                                          
         GOTOR HIGH                                                             
         B     GETPXC06                                                         
GETPXC04 LA    R2,KEY                                                           
         GOTOR SEQ                                                              
GETPXC06 CLC   PXCKEY(PXCKSTA-PXCKEY),KEYSAVE                                   
         BNE   GETPXC22                                                         
         OC    FULL+1(L'PXCKSTA),FULL+1                                         
         BZ    *+14                                                             
         CLC   PXCKSTA,FULL+1                                                   
         BNE   GETPXC22                                                         
         CLI   PXCKEST,0           TEST REC FOR ALL ESTS                        
         BE    GETPXC10                                                         
         CLI   BEST,0              TEST REQ BY EST                              
         BE    GETPXC08            NO - USE ESTLST                              
         CLC   PXCKEST,BEST                                                     
         BE    GETPXC10                                                         
         BL    GETPXC04                                                         
         CLI   BESTEND,0                                                        
         BE    GETPXC04                                                         
         CLC   PXCKEST,BESTEND                                                  
         BH    GETPXC04                                                         
         B     GETPXC10                                                         
GETPXC08 LLC   RF,PXCKEST          TEST ESTIMATE APPLICABLE                     
         LA    RE,ESTLST-L'PXCKEST(RF)                                          
         CLI   0(RE),0                                                          
         BNE   GETPXC10                                                         
         LA    RE,PESTLST-L'EKEYEST(RF)                                         
         CLI   0(RE),0             TEST POL ESTIMATE LIST TOO                   
         BE    GETPXC04                                                         
                                                                                
GETPXC10 GOTOR GET                 GET ACTUAL RECORD                            
         L     R2,APXCREC                                                       
         LA    R3,PXCEL01                                                       
         USING PXCEL05,R3                                                       
         SR    R0,R0                                                            
GETPXC12 CLI   PXCEL05,0           TEST EOR                                     
         BE    GETPXC04                                                         
         CLI   PXCEL05,PXCEL05Q                                                 
         BNE   GETPXC14                                                         
         CLC   PXCSTDTE,BQENDP     TEST OVERLAPS REQUEST DATES                  
         BH    GETPXC14                                                         
         CLC   PXCEDTE,BQSTARTP                                                 
         BNL   GETPXC16                                                         
GETPXC14 IC    R0,PXC05LEN         BUMP TO NEXT ELEMENT                         
         AR    R3,R0                                                            
         B     GETPXC12                                                         
                                                                                
GETPXC16 XC    WORK,WORK           BUILD XCTAB ITEM                             
         LA    RF,WORK                                                          
         USING XCTABD,RF                                                        
         MVC   XCTETYPE,FULL       SET ENTRY TYPE                               
         MVC   XCTSPE(XCTSPEL),PXCKSTA                                          
         MVC   XCTDATA(XCTDATAL),PXCPGM                                         
         CLI   XCTTYPE,XCTSPCLQ    TEST SPECIAL 'PROGRAM'                       
         BNL   GETPXC18            NO                                           
         CLI   XCTTYPE,XCTTDOWQ    TEST DAY                                     
         BE    GETPXC20                                                         
         OC    XCTETIME,XCTETIME   IF ONLY 1 TIME                               
         BNZ   *+10                                                             
         MVC   XCTETIME,XCTSTIME   SET END = START                              
         B     GETPXC20                                                         
GETPXC18 OC    XCTPGM,SPACES                                                    
                                                                                
GETPXC20 GOTOR BINSRCH,XCTPARS,(1,XCTABD)                                       
         OC    1(3,R1),1(R1)       TEST FULL                                    
         BNZ   GETPXC14                                                         
         MVC   P1(38),=C'**Too many product exclusion records**'                
         MVC   P2(L'RQBYPSSL),RQBYPSSL                                          
         J     ENDREQ                                                           
                                                                                
GETPXC22 CLC   QCODE,QPROGKLL      TEST CANADIAN KL REQUEST                     
         BNE   GETPXCX                                                          
         CLI   QMED,COMLETQ        TEST COMBINED CANDIAN REQUEST                
         BNE   GETPXCX                                                          
         CLI   MODE,STALAST        TEST STATION LAST                            
         BNE   GETPXCX                                                          
         CLI   FULL,XCTETNET       TEST ALREADY DONE NETWORK STATION            
         BE    GETPXCX                                                          
         OC    NETSSTA,NETSSTA     TEST NETWORK STATION RESOLVED                
         BZ    GETPXCX                                                          
         MVI   FULL,XCTETNET                                                    
         MVC   FULL+1(L'NETSSTA),NETSSTA                                        
         B     GETPXC02            GO BACK FOR NETWORK EXCLUSIONS               
                                                                                
GETPXCX  J     EXIT                                                             
         DROP  R2,R3,RF                                                         
         EJECT                                                                  
***********************************************************************         
* PROCESS BUY                                                         *         
***********************************************************************         
                                                                                
PRBUY    CLI   SPLTOPT,0           SPLIT PIGGY OPTION?                          
         BE    PRBUY24                                                          
         L     R2,ADBUY                                                         
         USING BUYREC,R2                                                        
         CLI   BDSEC,SECS30        ONLY DEAL WITH 30 SECOND SPOTS               
         BNE   PRBUYX                                                           
         CLI   SPLTOPT,SECS15                                                   
         BE    PRBUY06                                                          
         LA    R3,BDELEM           30 MODE IN SPLIT RUN SITUATION               
         USING REGELEM,R3                                                       
         SR    R0,R0                                                            
PRBUY02  CLI   RCODE,0             EOR                                          
         BE    PRBUY24                                                          
         CLI   RCODE,RCPOLOQ       SPOT ELEMS                                   
         BL    PRBUY04                                                          
         CLI   RCODE,RCPOLFQ                                                    
         BH    PRBUY04                                                          
         CLI   RLEN,RLREGLNQ       IF UNALLOCATED, OK                           
         BE    PRBUY04                                                          
         CLI   RLEN,RLPOL2LQ       IF NOW A PIGGY, SKIP                         
         BNE   PRBUY04                                                          
         OI    RSTATUS,RSHIATSQ    MAKE A HIATUS, SO SPOTHOOK IGNORES           
PRBUY04  IC    R0,RLEN             BUMP TO NEXT ELEMENT                         
         AR    R3,R0                                                            
         B     PRBUY02                                                          
         DROP  R3                                                               
                                                                                
***********************************************************************         
* NOTE: FOR 15 SPLITS TWO PASSES THRU RECORD TO SPLIT 30 INTO 2 15'S  *         
***********************************************************************         
                                                                                
PRBUY06  MVI   SPLTPASS,1          FIRST PASS                                   
         L     R0,ASBUYREC         SAVE BUY RECORD                              
         LHI   R1,MAXRECL                                                       
         LA    RE,BUYREC                                                        
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         MVI   BDSEC,SECS15        SET NEW LENGTH                               
         LA    R3,BDELEM           FIRST ELEM                                   
         USING REGELEM,R3                                                       
         SR    R0,R0                                                            
PRBUY08  CLI   RCODE,0             EOR                                          
         BE    PRBUY14                                                          
         CLI   RCODE,RCPOLOQ       SPOT ELEMS                                   
         BL    PRBUY12                                                          
         CLI   RCODE,RCPOLFQ                                                    
         BH    PRBUY12                                                          
         CLI   RLEN,RLREGLNQ       IF UNALLOCATED, OK                           
         BE    PRBUY12                                                          
         CLI   RLEN,RLPOL1LQ       IF NOT NOW A PIGGY, UNALLOCATE               
         BNE   PRBUY10                                                          
         OI    RSTATUS,RSHIATSQ    MAKE A HIATUS, SO SPOTHOOK IGNORES           
         B     PRBUY12             WILL IGNORE                                  
PRBUY10  CLI   RLEN,RLPOL2LQ       IF NOW A PIGGY, REMOVE 2ND                   
         BNE   PRBUY12                                                          
PIG      USING REGELEM,WORK                                                     
         MVC   PIG.REGELEM(RLPOL2LQ),REGELEM                                    
         MVI   PIG.RLEN,RLPOL1LQ                                                
         GOTOR RECUP,DMCB,BUYREC,REGELEM                                        
         GOTOR (RF),(R1),,PIG.REGELEM,REGELEM                                   
         DROP  PIG                                                              
PRBUY12  IC    R0,RLEN             BUMP TO NEXT ELEMENT                         
         AR    R3,R0                                                            
         B     PRBUY08                                                          
         DROP  R3                                                               
                                                                                
PRBUY14  GOTOR DIVBUY              DIVIDE COST ETC. BY 2                        
         GOTOR PRCBUY                                                           
         BNE   PRBUYX                                                           
         MVI   SPLTPASS,2          2ND PASS                                     
         LA    R0,BUYREC           RESTORE BUY RECORD                           
         LHI   R1,MAXRECL                                                       
         L     RE,ASBUYREC                                                      
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         MVI   BDSEC,SECS15        SET NEW LENGTH                               
         LA    R3,BDELEM           FIRST ELEM                                   
         USING REGELEM,R3                                                       
         SR    R0,R0                                                            
PRBUY16  CLI   RCODE,0             EOR                                          
         BE    PRBUY22                                                          
         CLI   RCODE,RCPOLOQ       SPOT ELEMS                                   
         BL    PRBUY20                                                          
         CLI   RCODE,RCPOLFQ                                                    
         BH    PRBUY20                                                          
         CLI   RLEN,RLREGLNQ       IF UNALLOCATED, OK                           
         BE    PRBUY20                                                          
         CLI   RLEN,RLPOL1LQ       IF NOT NOW A PIGGY, UNALLOCATE               
         BNE   PRBUY18                                                          
         OI    RSTATUS,RSHIATSQ    MAKE A HIATUS, SO SPOTHOOK IGNORES           
         B     PRBUY20                                                          
PRBUY18  CLI   RLEN,RLPOL2LQ       IF NOW A PIGGY, REMOVE 1ST                   
         BNE   PRBUY20                                                          
PIG      USING REGELEM,WORK                                                     
         MVC   PIG.REGELEM(RLPOL2LQ),REGELEM                                    
         MVI   PIG.RLEN,RLPOL1LQ                                                
         MVC   PIG.RPALLOC,RPALLOC2 USE 2ND, NOT FIRST                          
         GOTOR RECUP,DMCB,BUYREC,REGELEM                                        
         GOTOR (RF),(R1),,PIG.REGELEM,REGELEM                                   
         DROP  PIG                                                              
PRBUY20  IC    R0,RLEN             BUMP TO NEXT ELEMENT                         
         AR    R3,R0                                                            
         B     PRBUY16                                                          
         DROP  R3                                                               
                                                                                
PRBUY22  GOTOR DIVBUY              DIVIDE COST ETC. BY 2                        
                                                                                
PRBUY24  GOTOR PRCBUY                                                           
                                                                                
PRBUYX   J     EXIT                                                             
         DROP  R2                                                               
         EJECT                                                                  
********************************************************************            
* DIVBUY - DIVIDE COST AND DEMOS BY 2 FOR 30 SEC SPLITS            *            
* NOTE - RESULTS ARE NOT ROUNDED                                   *            
********************************************************************            
                                                                                
         USING BUYREC,R2                                                        
DIVBUY   NTR1  ,                                                                
         SR    R1,R1               BDCOST                                       
         ICM   R1,7,BDCOST                                                      
         SRA   R1,1                                                             
         STCM  R1,7,BDCOST                                                      
         LA    R3,BDELEM           GO THROUGH ELEMS                             
         USING NDELEM,R3                                                        
DIVBUY02 CLI   NDCODE,0            EOR                                          
         BE    DIVBUYX                                                          
         CLI   NDCODE,NDCORGQ      REGULAR DEMO ELEM                            
         BE    DIVBUY06                                                         
         CLI   NDCODE,NDCSPLQ      SPILL                                        
         BE    DIVBUY06                                                         
         CLI   NDCODE,RCPOLOQ      SPOT ELEM                                    
         BL    DIVBUY04                                                         
         CLI   NDCODE,RCPOLFQ      SPOT ELEM                                    
         BNH   DIVBUY10                                                         
DIVBUY04 SR    R0,R0               BUMP TO NEXT ELEMENT                         
         IC    R0,NDLEN                                                         
         AR    R3,R0                                                            
         B     DIVBUY02                                                         
                                                                                
DIVBUY06 SR    R0,R0               DEMO ELEMENTS                                
         IC    R0,NDLEN            ELEM LENGTH                                  
         SHI   R0,NDEMNO-NDCODE    MINUS FIXED AREA                             
         BNP   DIVBUY04            NO DEMOS                                     
         SRA   R0,3                8 BYTES PER DEMO                             
         LA    RE,NDEMNO                                                        
         USING NDEMNO,RE                                                        
DIVBUY08 MVC   BYTE,NDEMRAW        DEAL WITH HIGH ORDER BIT                     
         NI    BYTE,NDEMMANQ       SAVE HOB IN BYTE                             
         NI    NDEMRAW,FF-NDEMMANQ TURN OFF HOB IN DEMO VALUE                   
         ICM   R1,15,NDEMRAW       DEMO VALUE                                   
         SRA   R1,1                                                             
         STCM  R1,15,NDEMRAW       DEMO VALUE/2                                 
         OC    NDEMRAW,BYTE        RESTORE HOB IF SET                           
         AHI   RE,NDEMLNQ          NEXT DEMO                                    
         BCT   R0,DIVBUY08                                                      
         B     DIVBUY04                                                         
         DROP  RE                                                               
         USING REGELEM,R3                                                       
DIVBUY10 SR    R1,R1               SPOT ELEMENTS                                
         ICM   R1,7,RPCOST                                                      
         SRA   R1,1                                                             
         STCM  R1,7,RPCOST                                                      
         B     DIVBUY04                                                         
DIVBUYX  J     EXIT                                                             
         DROP  R2,R3                                                            
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* ADD PRODUCTS TO BUYREC AND WRITE TO FILE                            *         
***********************************************************************         
                                                                                
UPDBUY   NTR1  BASE=*,LABEL=*                                                   
         OC    ASPTTAB,ASPTTAB     IF NO SPOT TABLE THERE WAS                   
         BZ    UPDBUYX             SOME EARLIER ERROR, SO QUIT                  
         TM    MKTBUYGL,MKTBHBUY+MKTBHGOL                                       
         BNO   UPDBUYX             GOALS AND BUYS                               
         MVI   RCWRITE,YESQ                                                     
         CLI   QOPT4,YESQ          FOR TEST RUN                                 
         BNE   *+8                                                              
         MVI   RCWRITE,NOQ         SUPPRESS WRITE                               
                                                                                
         L     RF,ABRDTAB          CLEAR FOR CS REPORT                          
         MVI   0(RF),0                                                          
         MVC   SVDMOUTS,DMOUTBTS   SORT BY DISK ADDR                            
         MVI   DMOUTBTS,0          MASK DMGR ERRORS                             
         XC    NETLOOP,NETLOOP                                                  
L        USING SBUFFK,LASTBKEY                                                  
         XC    L.SBUFFK(SBUFFKL),L.SBUFFK                                       
                                                                                
UPDBUY04 LA    R5,W                BUILD LIST OF SPOTS                          
         USING SBUFFRD,R5                                                       
         L     R2,ASPTTAB          START OF TABLE                               
         SR    R0,R0               SPOT COUNTER                                 
         CLI   L.SBUFFK,FF                                                      
         BE    UPDBUY12                                                         
         MVC   SBUFFK(SBUFFKL),L.SBUFFK                                         
         GOTOR BU2RDH                                                           
         B     UPDBUY10                                                         
UPDBUY08 GOTOR BU2RSQ                                                           
UPDBUY10 BZ    *+12                                                             
         MVI   SBUFFRD,FF          END OF SPOTS                                 
         B     UPDBUY12                                                         
         CLI   SBRTYP,SBRTYPQ      TEST RECORD TYPE                             
         BNE   UPDBUY08                                                         
         OC    L.SBUFFK(SBUFFKL),L.SBUFFK                                       
         BNZ   *+10                                                             
         MVC   L.SBUFFK(SBUFFKL),SBUFFK                                         
         CLC   SBUFFK(SBSEQ-SBUFFK),L.SBUFFK                                    
         BNE   UPDBUY12                                                         
         MVC   0(SBFIXLN,R2),SBUFFRD                                            
         AHI   R2,SBFIXLN                                                       
         AHI   R0,1                BUMP SPOT COUNT                              
         B     UPDBUY08                                                         
UPDBUY12 XC    0(SBFIXLN,R2),0(R2) CLEAR AFTER LAST ENTRY                       
         MVC   L.SBUFFK(SBUFFKL),SBUFFK SET FOR NEXT TIME                       
         ST    R0,SPTTABN                                                       
         LTR   R0,R0                                                            
         BZ    UPDBUY32                                                         
                                                                                
         L     R5,ASPTTAB                                                       
         USING SBUFFRD,R5                                                       
         MVC   KEY+(BUYKDA-BUYREC)(L'BUYKDA),SBDA                               
         MVC   AREC,ADBUY                                                       
         GOTOR GET                                                              
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         XC    ADDLIST,ADDLIST     CLEAR PROD LIST                              
         XC    X,X                 CLEAR SPOT COUNT SAVE LIST                   
         MVI   OVFMSW,NOQ          CLEAR OVERFLOW MESSAGE SWITCH                
         L     R0,SPTTABN                                                       
         MVI   SPLTSVPR,0          CLEAR FOR SPLIT PIGGY OPTION                 
         GOTOR PUTPRD              SET SPOT ALLOCS                              
         AHI   R5,SBFIXLN                                                       
         BCT   R0,*-8                                                           
         GOTOR DMPREC                                                           
         OC    ADDLIST,ADDLIST     TEST ANY CHANGE TO REC                       
         BZ    UPDBUY15            NO                                           
         CLI   RCWRITE,NOQ         IS IT A TEST RUN                             
         BE    UPDBUY15                                                         
         LA    RE,ADDLIST                                                       
         ST    RE,DM6                                                           
         GOTOR PUT                                                              
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
UPDBUY15 CLC   QCODE,QPROGKLL      TEST CANADIAN KL REQUEST                     
         BNE   UPDBUY16                                                         
         CLI   QMED,COMLETQ        TEST COMBINED CANADIAN REQUEST               
         BNE   UPDBUY16                                                         
         CLI   QOPT5,YESQ          TEST DON'T UPDATE NETWORK BUYS               
         BE    UPDBUY16                                                         
         GOTOR UPDNET              UPDATE NETWORK LEVEL BUYS ETC.               
                                                                                
UPDBUY16 GOTOR CHDRPT,ADBUY        CHILD SPOT                                   
         OC    ADDLIST,ADDLIST                                                  
         BZ    UPDBUY30                                                         
         CLI   RQMED,NETLETQ                                                    
         BNE   UPDBUY30                                                         
         CLI   COUNTRY,CANLETQ                                                  
         BNE   UPDBUY30                                                         
                                                                                
         L     R2,ADBUY            FIRST TIME FOR NETWORK- BUILD LIST           
         AHI   R2,BDELEM-BUYREC    OF MKT/STA'S                                 
         USING NTWKELEM,R2                                                      
         L     R7,ANETLIST                                                      
         SR    R0,R0                                                            
UPDBUY18 CLI   NTWKCODE,0                                                       
         BE    UPDBUY22                                                         
         CLI   NTWKCODE,NTWKCODQ                                                
         BNE   UPDBUY20                                                         
         MVC   0(L'NTWKMKST,R7),NTWKMKST                                        
         AHI   R7,L'NTWKMKST                                                    
UPDBUY20 IC    R0,NTWKLEN                                                       
         AR    R2,R0                                                            
         B     UPDBUY18                                                         
                                                                                
UPDBUY22 MVI   0(R7),FF            SET EOL                                      
         L     R7,ANETLIST                                                      
UPDBUY24 ST    R7,NETLOOP                                                       
         CLI   0(R7),FF            EOL                                          
         BE    UPDBUY30                                                         
         XC    KEY,KEY             READ NEXT RECORD                             
         L     RF,ADBUY                                                         
         MVC   KEY(13),0(RF)                                                    
         MVC   KEY+4(5),0(R7)      MOVE IN MKT/STA                              
         MVI   KEY+10,0                                                         
         MVI   KEY+12,1                                                         
         MVC   KEY+11(1),10(RF)    LINE NO.                                     
         USING BUYREC,RF           BUY RECORD DSECT                             
         TM    BUYRCNTL,BUYRLN2    2-BYTE BUYLINE?                              
         BZ    *+10                NO                                           
         MVC   KEY+11(2),BUYRLIN   YES - CONVERT 1 BYTE TO 2 BYTE               
         DROP  RF                                                               
*                                                                               
         GOTOR HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         L     RF,ADBUY                                                         
         ST    RF,AREC                                                          
         GOTOR GET                                                              
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         XC    ADDLIST,ADDLIST                                                  
         L     R5,ASPTTAB          SET SPOT ALLOCS                              
         L     R0,SPTTABN                                                       
         MVI   OVFMSW,NOQ          CLEAR OVERFLOW MESSAGE SWITCH                
         MVI   SPLTSVPR,0          CLEAR FOR SPLIT PIGGY OPTION                 
         GOTOR PUTPRD                                                           
         AHI   R5,SBFIXLN                                                       
         BCT   R0,*-8                                                           
         DROP  R5                                                               
*                                  WRITE EXPLODED CAN NET BUYS                  
         GOTOR DMPREC                                                           
         OC    ADDLIST,ADDLIST                                                  
         BZ    UPDBUY28                                                         
         CLI   RCWRITE,NOQ         IS IT A TEST RUN                             
         BE    UPDBUY28                                                         
         LA    RE,ADDLIST                                                       
         ST    RE,DM6                                                           
         GOTOR PUT                                                              
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
UPDBUY28 AHI   R7,L'NTWKMKST                                                    
         B     UPDBUY24                                                         
                                                                                
UPDBUY30 XC    NETLOOP,NETLOOP                                                  
         B     UPDBUY04                                                         
                                                                                
UPDBUY32 GOTOR CHDRPT,0            CHILD SPOT REPORT                            
         MVC   DMOUTBTS,SVDMOUTS   RESTORE BITS                                 
                                                                                
UPDBUYX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* INSERT PRODUCTS INTO BUY REC                                        *         
***********************************************************************         
                                                                                
         USING SBUFFRD,R5                                                       
PUTPRD   NTR1  ,                                                                
         TM    SBSTAT2,SBSPRALQ    SKIP IF PRE-ALLOCATED                        
         BNZ   PUTPRDX                                                          
         MVC   WKDATB,SBDATE       SET SPOT DATE                                
         L     R7,ADBUY                                                         
         USING BUYREC,R7                                                        
         MVI   SPTCNT,0                                                         
         LA    R2,BDELEM                                                        
         USING REGELEM,R2                                                       
         MVI   BYTE,0              RESET SPOT COUNTER                           
PUTPRD02 SR    R0,R0                                                            
         IC    R0,RLEN                                                          
         AR    R2,R0                                                            
         CLI   RCODE,0             EOR SHOULD NOT OCCUR                         
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLI   RCODE,RCPOLOQ                                                    
         BL    PUTPRD02                                                         
         CLI   RCODE,RCPOLFQ                                                    
         BH    PUTPRD02                                                         
         TM    RSTATUS,RSMINUSQ+RSMINSDQ+RSHIATSQ                               
         BNZ   PUTPRD02                                                         
         SR    RF,RF                                                            
         IC    RF,SPTCNT           BUMP GLOBAL SPOT NO.                         
         AHI   RF,1                                                             
         STC   RF,SPTCNT                                                        
         LA    RF,SBUFFRD          GET DISP INTO SPOT COUNTER TAB               
         S     RF,ASPTTAB                                                       
         SR    RE,RE                                                            
         LHI   R0,SBFIXLN                                                       
         DR    RE,R0                                                            
         LA    RE,X(RF)            RE = A(BYTE FOR THIS SPOT)                   
         OC    NETLOOP,NETLOOP     TEST EXPLODED BUY                            
         BNZ   PUTPRD04            YES                                          
         CLC   RDATE,WKDATB        NO, TEST RIGHT DATE                          
         BNE   PUTPRD02                                                         
         CLI   0(RE),0             ON FIRST FOR DATE                            
         BNE   *+10                                                             
         MVC   0(1,RE),SPTCNT      SAVE RELATIVE GLOBAL SPOT NUMBER             
         B     PUTPRD06                                                         
                                                                                
PUTPRD04 CLC   0(1,RE),SPTCNT      TEST HAVE REACHED RIGHT SPOT                 
         BH    PUTPRD02                                                         
                                                                                
PUTPRD06 SR    RF,RF               BUMP SPT COUNTER                             
         IC    RF,BYTE                                                          
         AHI   RF,1                                                             
         STC   RF,BYTE                                                          
         CLC   BYTE,SBSPTNO        TEST RIGHT SPOT                              
         BNE   PUTPRD02                                                         
         CLI   SPLTOPT,SECS15      IF 15 SPLITS                                 
         BNE   PUTPRD12                                                         
         TM    SBSEQ,X'01'         IS IT 2ND OF A PAIR?                         
         BNZ   PUTPRD08                                                         
         MVC   SPLTSVPR,SBPRD1     NO, THEN FIRST, SO SAVE THIS PRODUCT         
         B     PUTPRDX             AND DONE FOR NOW                             
                                                                                
PUTPRD08 XC    DUB,DUB             MUST BE 2ND OF A PAIR                        
         MVC   DUB+0(1),SPLTSVPR                                                
         MVI   DUB+1,SECS15                                                     
         MVC   DUB+2(1),SBPRD1                                                  
         MVI   DUB+3,SECS15                                                     
         CLI   DUB+0,0             1ST UNALLOCATED?                             
         BNE   PUTPRD10                                                         
         CLI   DUB+2,0             AND 2ND?                                     
         BE    *+6                                                              
         DC    H'0'                ONLY ONE ALLOC'D- SHOULD NOT HAPPEN          
         XC    DUB,DUB                                                          
         MVI   DUB+1,SECS30                                                     
         B     PUTPRD14                                                         
PUTPRD10 CLI   DUB+2,0                                                          
         BNE   PUTPRD14                                                         
         DC    H'0'                ONLY ONE ALLOC'D- SHOULD NOT HAPPEN          
                                                                                
PUTPRD12 XC    DUB,DUB             HAVE FOUND SPOT                              
         CLI   SBPRD1,0            NONE IF UNALLOCATED                          
         BE    PUTPRD14                                                         
         CLI   SBPRD1,UNAPRD2                                                   
         BE    PUTPRD14                                                         
         MVC   DUB+0(1),SBPRD1     SET FOR SINGLE BRAND                         
         MVC   DUB+1(1),BDSEC                                                   
         SR    RF,RF                                                            
         IC    RF,SBPRD1           FIND PRODUCT TABLE ENTRY                     
         BCTR  RF,0                                                             
         MH    RF,PRDBUFLN                                                      
         A     RF,PRDBUFF                                                       
         TM    PTSTAT-PTBUFFD(RF),PTSPIGPQ                                      
         BZ    PUTPRD14                                                         
         MVC   DUB+0(1),PTPPBRD1-PTBUFFD(RF) 1ST PRODUCT                        
         MVC   DUB+1(1),PTPPSHR1-PTBUFFD(RF) 1ST LEN                            
         MVC   DUB+2(1),PTPPBRD2-PTBUFFD(RF) 2ND PRODUCT                        
         MVC   DUB+3(1),PTPPSHR2-PTBUFFD(RF) 2ND LEN                            
PUTPRD14 MVC   WORK(RLPOL2LQ),REGELEM SAVE ELEM                                 
         XC    FULL,FULL                                                        
         CLI   RLEN,RLREGLNQ                                                    
         BNH   PUTPRD16                                                         
         MVC   FULL(2),RPALLOC                                                  
         CLI   RLEN,RLPOL1LQ       IS IT NOW A PIG                              
         BNH   PUTPRD16                                                         
         MVC   FULL+2(2),RPALLOC2                                               
PUTPRD16 CLC   FULL,DUB            TEST ALLOCATION CHANGED                      
         BE    PUTPRDX             NO, DONE                                     
PUTPRD18 GOTOR RECUP,DMCB,BUYREC,REGELEM  DELETE ELEM                           
UPD      USING REGELEM,WORK                                                     
         MVI   UPD.RLEN,RLREGLNQ   INITIALIZE AS UNALLOCATED                    
         CLI   DUB+0,0             TEST ANY ALLOCATION                          
         BE    PUTPRD20                                                         
         MVI   UPD.RLEN,RLPOL1LQ   1 PRODUCT                                    
         XC    UPD.RPALLOC,UPD.RPALLOC                                          
         MVC   UPD.RPALLOC(2),DUB+0                                             
         CLI   DUB+2,0                                                          
         BE    PUTPRD20                                                         
         MVI   UPD.RLEN,RLPOL2LQ   2 PRODUCTS                                   
         XC    UPD.RPALLOC2,UPD.RPALLOC2                                        
         MVC   UPD.RPALLOC2(2),DUB+2                                            
PUTPRD20 GOTOR (RF),(R1),,UPD.REGELEM,(C'R',REGELEM)                            
         CLI   8(R1),0             TEST RECORD TOO BIG                          
         BNE   PUTPRD22                                                         
         DROP  UPD                                                              
         CLI   OVFMSW,YESQ         TEST ALREADY PRINTED MESSAGE                 
         BE    PUTPRDX                                                          
         MVI   OVFMSW,YESQ                                                      
         MVI   P1,ASTERISK                                                      
         MVC   P1+1(L'P1-1),P1                                                  
         MVC   P2,P1                                                            
         MVI   SPACING,2                                                        
         GOTOR REPORT                                                           
         MVC   P1(56),=C'** Buy record has too many spots to hold alloc*        
               ation data'                                                      
         MVI   P2,0                                                             
         MVC   P3(44),=C'** Split the record and rerun the allocation'          
         MVI   P4,0                                                             
         MVC   P5(43),=C'** Estimate=NNN, Station=XXXXXXXX, Line=XXX'           
         GOTOR MSUNPK,DMCB,(X'80',BUYMSTA),WORK,P5+25                           
         EDIT  (B1,BUYKEST),(3,P5+12),FILL=0                                    
         EDIT  (B1,BUYKBUY),(3,P5+40),FILL=0                                    
         MVI   SPACING,2                                                        
         GOTOR REPORT                                                           
         MVI   P1,ASTERISK                                                      
         MVC   P1+1(L'P1-1),P1                                                  
         MVC   P2,P1                                                            
         J     ENDREQ                                                           
PUTPRD22 GOTOR ADDLST,DUB+0        ADD PRODUCT 1 TO ADDLIST                     
         GOTOR ADDLST,DUB+2        ADD PRODUCT 2 TO ADDLIST                     
PUTPRDX  J     EXIT                                                             
         DROP  R2,R5,R7                                                         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* UPDATE ASSOCIATED BUYS FOR CANADIAN COMBINED MEDIA REQUEST          *         
***********************************************************************         
                                                                                
         USING SBUFFRD,R5                                                       
UPDNET   NTR1  BASE=*,LABEL=*                                                   
         L     R2,ADBUY                                                         
         USING BUYREC,R2           R2=A(BUY RECORD)                             
         MVC   SBUYKEY,BUYKEY      SAVE CURRENT BUY KEY                         
         LA    R3,BDELEM                                                        
         USING REGELEM,R3                                                       
         L     R4,APRDTAB          R4=A(PRODUCT ALLOCATION TABLE)               
         USING PRDTABD,R4                                                       
         SR    R0,R0                                                            
         SR    R6,R6               R6=PRODUCT ALLOCATION ENTRIES                
         SR    R7,R7               R7=SEQUENCE NUMBER                           
UPDNET02 CLI   RCODE,0             TEST END OF BUY RECORD                       
         BE    UPDNET14                                                         
         CLI   RCODE,RCPOLOQ       TEST ORIGINAL POOL ELEMENT                   
         BE    UPDNET04                                                         
         CLI   RCODE,RCPOTOQ       TEST POOL OTO ELEMENT                        
         BNE   UPDNET12                                                         
         TM    RSTATUS,RSMINUSQ+RSMINSDQ                                        
         BNZ   UPDNET06                                                         
UPDNET04 AHI   R7,1                BUMP SEQUENCE NUMBER                         
UPDNET06 TM    RSTATUS,RSHIATSQ    SKIP HIATUS, MINUS, PAID ETC.                
         BNZ   UPDNET12                                                         
         TM    RSTATUS,RSMINUSQ+RSMINSDQ                                        
         BNZ   UPDNET12                                                         
         OC    RPAY,RPAY                                                        
         BNZ   UPDNET12                                                         
         CLC   RDATE,CSTART        TEST SPOT WITHIN REQUEST RANGE               
         BL    UPDNET12                                                         
         CLC   RDATE,CEND                                                       
         BH    UPDNET12                                                         
                                                                                
         LA    RF,REGELEM          SKIP MATCHED SPOTS, AS PER BUY PROG          
         SR    RE,RE                                                            
UPDNET08 IC    RE,1(RF)                                                         
         AR    RF,RE                                                            
         CLI   0(RF),0                                                          
         BE    UPDNET10                                                         
         CLI   0(RF),RCPOLOQ                                                    
         BL    UPDNET08                                                         
         CLI   0(RF),RCPOLFQ                                                    
         BNH   UPDNET10                                                         
         CLI   0(RF),ACCODEQ                                                    
         BE    UPDNET12            FOUND AFFID SO SPOT MATCHED - IGNORE         
         B     UPDNET08                                                         
                                                                                
UPDNET10 XC    PRDTABD(PRDTABL),PRDTABD                                         
         STC   R7,PRDTSEQN         BUILD PRODUCT ALLOCATION TABLE ENTRY         
         MVC   PRDTDATE,RDATE                                                   
         CLI   RLEN,RLREGLNQ       TEST THIS SPOT ALLOCATED                     
         BNH   UPDNET11            NO                                           
         MVC   PRDTALC1,RPALLOC                                                 
         CLI   RLEN,RLPOL1LQ                                                    
         BNH   *+10                                                             
         MVC   PRDTALC2,RPALLOC2                                                
UPDNET11 AHI   R4,PRDTABL                                                       
         AHI   R6,1                                                             
UPDNET12 IC    R0,RLEN             BUMP TO NEXT BUY RECORD ELEMENT              
         AR    R3,R0                                                            
         B     UPDNET02                                                         
                                                                                
UPDNET14 MVI   PRDTSEQN,0          SET END OF TABLE                             
         LTR   R6,R6               TEST ANY ALLOCATION ENTRIES BUILT            
         BZ    UPDNETX                                                          
                                                                                
         LA    R3,BDELEM                                                        
         USING NTWKELEM,R3         LOCATE NETWORK STATION ELEMENT               
         SR    R0,R0                                                            
UPDNET16 CLI   NTWKCODE,0          LOCATE NETWORK STATION ELEMENT               
         BNE   *+6                                                              
         DC    H'0'                CAN'T FIND IT                                
         CLI   NTWKCODE,NTWKCODQ                                                
         BE    *+14                                                             
         IC    R0,NTWKLEN          BUMP TO NEXT ELEMENT ON RECORD               
         AR    R3,R0                                                            
         B     UPDNET16                                                         
                                                                                
         MVC   WORK+0(4),ZONES                                                  
         MVC   WORK+4(4),NTWKMKST                                               
         MVI   WORK+8,C'N'                                                      
         GOTOR MSPACK,DMCB,WORK+0,WORK+4,WORK+10                                
         LA    R2,KEY              BUILD KEY OF NETWORK BUY RECORD              
         MVC   BUYKEY(BUYKBUY-BUYKEY),SBUYKEY                                   
         MVC   BUYKMSTA,WORK+10                                                 
         MVI   BUYKBUY,0                                                        
         MVC   BUYKBUY+1(L'BUYKBUY-1),SBUYKEY+(BUYKBUY-BUYKEY)                  
         GOTOR HIGH                                                             
         CLC   BUYKEY,KEYSAVE                                                   
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R2,ADBUY                                                         
         ST    R2,AREC                                                          
         GOTOR GETBUY              READ THE NETWORK BUY RECORD                  
         GOTOR UPDPRD              COPY PRODUCT ALLOCATIONS TO IT               
                                                                                
         LLH   R1,BUYRLEN                                                       
         CHI   R1,MAXRECL-1        TEST WE HAVE ENOUGH SPACE FOR RECORD         
         JNH   *+6                                                              
         DC    H'0'                NO - MAKE THE SAVE RECORD BIGGER             
         L     R0,ASBUYREC                                                      
         LA    RE,BUYREC                                                        
         LR    RF,R1                                                            
         MVCL  R0,RE               SAVE CURRENT BUY RECORD IN SBUYREC           
                                                                                
         L     R3,ASBUYREC         GET OTHER EXPLODED RECORDS                   
         SR    R1,R1                                                            
         ICM   R1,3,BUYRLEN-BUYREC(R3)                                          
         AR    R1,R3                                                            
         MVI   0(R1),0                                                          
                                                                                
         AHI   R3,BDELEM-BUYREC                                                 
         USING NTWKELEM,R3                                                      
         SR    R0,R0                                                            
UPDNET18 CLI   NTWKCODE,0          TEST END OF RECORD                           
         BE    UPDNETX                                                          
         CLI   NTWKELEM,NTWKCODQ   TEST NETWORK STATION ELEMENT                 
         BNE   UPDNET20                                                         
         CLC   NTWKMKST,SBUYKEY+(BUYKMSTA-BUYREC)                               
         BE    UPDNET20                                                         
         LA    R2,KEY                                                           
         MVC   BUYKEY(BUYKBUY-BUYKEY),SBUYKEY                                   
         MVC   BUYKMSTA,NTWKMKST                                                
         MVI   BUYKBUY,0                                                        
         MVC   BUYKBUY+1(L'BUYKBUY-1),SBUYKEY+(BUYKBUY-BUYKEY)                  
         GOTOR HIGH                                                             
         CLC   BUYKEY,KEYSAVE                                                   
         BNE   UPDNET20                                                         
         GOTOR GETBUY              GET OTHER EXPLODED BUY RECORD                
         L     R2,ADBUY                                                         
         GOTOR UPDPRD              COPY PRODUCT ALLOCATIONS TO IT               
                                                                                
UPDNET20 IC    R0,NTWKLEN          BUMP TO NEXT ELEMENT ON RECORD               
         AR    R3,R0                                                            
         B     UPDNET18                                                         
                                                                                
UPDNETX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* UPDATE OTHER BUY WITH PRODUCT ALLOCATIONS                           *         
***********************************************************************         
                                                                                
UPDPRD   NTR1  ,                                                                
         L     R4,APRDTAB          R4=A(PRODUCT ALLOCATION TABLE)               
         XC    ADDLIST,ADDLIST                                                  
                                                                                
UPDPRD02 CLI   PRDTSEQN,0          TEST END OF ALLOCATION TABLE                 
         BE    UPDPRD24                                                         
         LA    R3,BDELEM                                                        
         USING REGELEM,R3                                                       
         SR    R7,R7               R7=SEQUENCE NUMBER                           
UPDPRD04 CLI   RCODE,0             TEST END OF BUY RECORD                       
         BE    UPDPRD22                                                         
         CLI   RCODE,RCPOLOQ       TEST ORIGINAL POOL ELEMENT                   
         BE    UPDPRD06                                                         
         CLI   RCODE,RCPOTOQ       TEST POOL OTO ELEMENT                        
         BNE   UPDPRD20                                                         
         TM    RSTATUS,RSMINUSQ+RSMINSDQ                                        
         BNZ   UPDPRD08                                                         
UPDPRD06 AHI   R7,1                                                             
UPDPRD08 CLM   R7,1,PRDTSEQN                                                    
         BNE   UPDPRD20                                                         
         CLC   RDATE,PRDTDATE      ENSURE POINTING TO THE CORRECT WEEK          
         BE    *+6                                                              
         DC    H'0'                DIE IF DATES DON'T MATCH                     
         CLI   QOPT1,YESQ          TEST RE-ALLOCATE OPTION SET                  
         BE    *+12                                                             
         CLI   RLEN,RLREGLNQ       NO - IGNORE IF ALREADY ALLOCATED             
         BH    UPDPRD22                                                         
         TM    RSTATUS,RSHIATSQ                                                 
         BNZ   UPDPRD22                                                         
         TM    RSTATUS,RSMINUSQ+RSMINSDQ                                        
         BNZ   UPDPRD22                                                         
         OC    RPAY,RPAY                                                        
         BNZ   UPDPRD22                                                         
                                                                                
         LA    RF,REGELEM          SKIP MATCHED SPOTS, AS PER BUY PROG          
         SR    RE,RE                                                            
UPDPRD10 IC    RE,1(RF)                                                         
         AR    RF,RE                                                            
         CLI   0(RF),0                                                          
         BE    UPDPRD12                                                         
         CLI   0(RF),RCPOLOQ                                                    
         BL    UPDPRD10                                                         
         CLI   0(RF),RCPOLFQ                                                    
         BNH   UPDPRD12                                                         
         CLI   0(RF),ACCODEQ                                                    
         BE    UPDPRD22            FOUND AFFID SO SPOT MATCHED - IGNORE         
         B     UPDPRD10                                                         
                                                                                
UPDPRD12 OC    PRDTALC1,PRDTALC1   TEST UNALLOCATED                             
         BNZ   UPDPRD13                                                         
         CLI   RLEN,RLREGLNQ       TEST SPOT ALREADY UNALLOCATED                
         BNH   UPDPRD22            YES - IGNORE                                 
NEW      USING REGELEM,WORK        BUILD UNALLOCATED SPOT ELEMENT               
         XC    NEW.REGELEM(RLREGLNQ),NEW.REGELEM                                
         MVC   NEW.REGELEM(RNUM-REGELEM),REGELEM                                
         MVI   NEW.RLEN,RLREGLNQ                                                
         B     UPDPRD18                                                         
                                                                                
UPDPRD13 CLI   RLEN,RLREGLNQ       TEST ALLOCATED                               
         BNH   UPDPRD16                                                         
         CLC   PRDTALC1,RPALLOC    TEST PRODUCT 1 CHANGED                       
         BNE   UPDPRD16                                                         
         OC    PRDTALC2,PRDTALC2                                                
         BNZ   UPDPRD14                                                         
         CLI   RLEN,RLPOL1LQ                                                    
         BNE   UPDPRD16                                                         
         B     UPDPRD22                                                         
                                                                                
UPDPRD14 CLI   RLEN,RLPOL2LQ                                                    
         BNE   UPDPRD16                                                         
         CLC   PRDTALC2,RPALLOC2                                                
         BE    UPDPRD22                                                         
                                                                                
UPDPRD16 MVC   NEW.REGELEM(RLREGLNQ),REGELEM                                    
         MVI   NEW.RLEN,RLPOL1LQ                                                
         MVC   NEW.RPALLOC,PRDTALC1                                             
         MVC   DUB+0(2),PRDTALC1                                                
         XC    DUB+2(2),DUB+2                                                   
         OC    PRDTALC2,PRDTALC2                                                
         BZ    UPDPRD18                                                         
         MVI   NEW.RLEN,RLPOL2LQ                                                
         MVC   NEW.RPALLOC2,PRDTALC2                                            
         MVC   DUB+2(2),PRDTALC2                                                
                                                                                
UPDPRD18 GOTOR RECUP,DMCB,(C'S',BUYREC),REGELEM,0                               
         GOTOR RECUP,DMCB,(C'S',BUYREC),NEW.REGELEM,REGELEM                     
         GOTOR ADDLST,NEW.RPALLOC                                               
         GOTOR ADDLST,NEW.RPALLOC2                                              
         B     UPDPRD22                                                         
                                                                                
UPDPRD20 IC    R0,RLEN             BUMP TO NEXT ELEMENT ON RECORD               
         AR    R3,R0                                                            
         B     UPDPRD04                                                         
                                                                                
UPDPRD22 AHI   R4,PRDTABL          BUMP TO NEXT PRODUCT TABLE ENTRY             
         B     UPDPRD02                                                         
                                                                                
UPDPRD24 OC    ADDLIST,ADDLIST     TEST ANY CHANGE TO RECORD                    
         BZ    UPDPRDX             NO                                           
                                                                                
         GOTOR DMPREC                                                           
                                                                                
UPDPRD26 CLI   RCWRITE,NOQ         IS IT A TEST RUN?                            
         BE    UPDPRDX                                                          
         LA    RE,ADDLIST                                                       
         ST    RE,DM6                                                           
         GOTOR PUTBUY                                                           
         CLI   DMCB+8,0                                                         
         BE    UPDPRDX                                                          
         DC    H'0'                                                             
                                                                                
UPDPRDX  J     EXIT                                                             
         DROP  R2,R3,R4,RB,NEW                                                  
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* SUMMARY REPORT                                                      *         
***********************************************************************         
                                                                                
SUMRPT   NTR1  BASE=*,LABEL=*                                                   
L        USING GBUFFK,LASTBKEY                                                  
         LA    R8,SUMRPT                                                        
         AHI   R8,4096                                                          
         USING SUMRPT+4096,R8                                                   
         MVI   FORCEHED,YESQ                                                    
         LH    RF,NTARGETS         SET 'CELL WIDTH'                             
         MHI   RF,SUMAUDL          8 BYTES FOR EACH TARG (PRE + ACH)            
         AHI   RF,SUMDATAL         PLUS FIXED 9 WORDS-FIRST OF SUMCELLS         
         STH   RF,CELLWID                                                       
         LH    RF,NWKSP1                                                        
         MH    RF,CELLWID                                                       
         AHI   RF,TABDATA-TABD                                                  
         STH   RF,LROW             LENGTH OF ROW                                
         A     RF,ASUPROW                                                       
         ST    RF,ATOTROW          TOTAL ROW                                    
         AH    RF,LROW                                                          
         ST    RF,AFSTBRD          1ST BRAND                                    
         XC    0(TABDATA-TABD,RF),0(RF)                                         
         LH    RF,RPTNWKS          SET COLUMN SPACING CONTROLS                  
         BCTR  RF,0                                                             
         MHI   RF,L'SRLTAB         BASED ON NO. OF WEEKS                        
         A     RF,ASRLTAB                                                       
         MVC   ROWDISP+1(1),0(RF)  START OF ROW DESC                            
         MVC   AMTDISP+1(1),1(RF)  OVER TO TOTAL COLUMN                         
         MVC   WEEKWID+1(1),2(RF)  SPACE BETWEEN COLUMNS                        
                                                                                
         XC    GBUFFR,GBUFFR                                                    
         MVC   GBUFFK(L'GBDPT+L'GBSLN),L.GBDPT                                  
         XC    NPRDS,NPRDS                                                      
         MVI   SUMRPTSW,0                                                       
         GOTOR CLRBRD              CLEAR BRDTAB TO BINARY ZEROES                
         GOTOR BU1RDH              READ HIGH BUFFER 1                           
         B     SUMRPT06                                                         
SUMRPT04 GOTOR BU1RSQ              READ SEQUENTIAL BUFFER 1                     
SUMRPT06 BZ    *+8                                                              
         MVI   GBUFFK,FF                                                        
         TM    DIAGNOP1,DNDXPRTQ                                                
         BZ    SUMRPT08                                                         
         GOTOR HEXOUT,HEXP,GBUFFR,P1,L'GBUFFR,NOL                               
         GOTOR REPORT                                                           
SUMRPT08 CLI   GBUFFK,FF                                                        
         BE    *+14                                                             
         OC    L.GBUFFK,L.GBUFFK                                                
         BZ    SUMRPT10                                                         
         CLC   GBDPT,L.GBDPT                                                    
         BNE   SUMRPT16                                                         
         CLC   GBSLN,L.GBSLN                                                    
         BE    SUMRPT10                                                         
         CLI   L.GBSLN,0           TEST REPORT FOR ALL SLN'S                    
         BNE   SUMRPT16            NO - HAVE SLN BREAK                          
         CLI   GBPRD,TOTPRD        FOR TOTALS MUST MATCH SLN                    
         BNE   SUMRPT10                                                         
         CLI   GBTYP,TGOLDEMQ      BUT NEED GOALS                               
         BE    SUMRPT10                                                         
         CLI   GBTYP,TGOLDOLQ                                                   
         BNE   SUMRPT04                                                         
SUMRPT10 CLI   GBPRD,UNAPRD2       BYPASS 'UNALLOCATED'                         
         BE    SUMRPT04                                                         
         CLI   GBPRD,SUPPRD        FOR SUPPLY                                   
         BNE   SUMRPT12                                                         
         SR    RE,RE                                                            
         IC    RE,GBTYP                                                         
         CLI   GBTYP,TPRET00Q      EXCEPT FOR TARGETS                           
         BH    *+8                                                              
         AHI   RE,X'20'            CHANGE TYP CODE TO                           
         STC   RE,GBTYP            LINE UP WITH ACH                             
SUMRPT12 L     R1,ASCELLS                                                       
SUMRPT14 CLI   0(R1),FF            SKIP ONES NOT NEEDED HERE                    
         BE    SUMRPT04                                                         
         CLC   GBTYP,0(R1)                                                      
         BE    *+12                                                             
         AHI   R1,L'SCELLS                                                      
         B     SUMRPT14                                                         
         L     R0,ASCELLS          GET CELL NO. FROM POSITION                   
         SR    R1,R0                                                            
         SLL   R1,2                X 4                                          
         STC   R1,CELLD                                                         
         GOTOR ROWIN                                                            
         CLI   GBPRD,TOTPRD        TOTAL ROW MAY BE NULL                        
         BE    *+8                 SO DON'T                                     
         MVI   SUMRPTSW,1          SET ACTIVITY SWITCH                          
         B     SUMRPT04                                                         
                                                                                
SUMRPT16 CLI   SUMRPTSW,0          NO DATA FOR DPT/SLN                          
         BE    SUMRPT72                                                         
         CLI   ZERWKSW,0           ZERO WEEK ERROR                              
         BE    SUMRPT20                                                         
         MVC   P1(91),=C'*** Market NNNN, Daypart/Length =         has *        
               week(s) with Buys but no Goals - bypassed ***'                   
         MVC   P1+11(L'MKT),MKT                                                 
         MVC   P1+17(L'DPTDESC),DPTDESC                                         
         CLI   RQMED,NETLETQ                                                    
         BNE   *+10                                                             
         MVC   P1(16),SPACES       NO MKT FOR NETWORK                           
         GOTOR REPORT                                                           
         B     SUMRPT72                                                         
SUMRPT20 MVI   FORCEHED,YESQ                                                    
         L     RF,AFSTBRD          SET EXCESS ROW                               
         SR    RE,RE                                                            
SUMRPT22 CLI   TABPRD-TABD(RF),0                                                
         BE    SUMRPT24                                                         
         AHI   RE,1                                                             
         AH    RF,LROW                                                          
         B     SUMRPT22                                                         
SUMRPT24 ST    RF,AEXCROW          A(ROW FOR EXCESS)                            
         STH   RE,NPRDS                                                         
         LR    R0,RF               CLEAR EXCESS ROW                             
         LH    R1,LROW                                                          
         GOTOR CLEAR                                                            
         L     RF,AEXCROW                                                       
         MVI   TABPRD-TABD(RF),UNAPRD2                                          
         MVI   TABPRDA-TABD(RF),UNAPRD2                                         
                                                                                
***********************************************************************         
* SET UNALLOCATED TOTALS AND SET TOTAL ACH = SUPPLY                   *         
***********************************************************************         
                                                                                
         L     R3,ASUPROW          SUPPLY                                       
         USING TABD,R3                                                          
         L     R4,ATOTROW          TOTALS                                       
TOT      USING TABD,R4                                                          
         MVI   TOT.TABPRD,TOTPRD                                                
         CLC   TOT.SUMASD,SUMASD                                                
         BE    SUMRPT34            IF SO - NO UNALL                             
         L     R5,AEXCROW          UNALLOCATED                                  
SUMRPT26 LH    R0,RPTNWKS          START AT TOTAL COLUMN                        
         SR    R2,R2                                                            
         IC    R2,RPTSWK           START WEEK NO                                
         MH    R2,CELLWID                                                       
         AHI   R2,TABDATA-TABD                                                  
*                                  LOOP THRU THIS WEEK                          
SUMRPT28 LA    R7,SUMASD-SUMDATA(R2)                                            
         LH    RE,CELLWID                                                       
         SRL   RE,2                NO. OF WORDS                                 
         SHI   RE,3                SKIP GOALS                                   
         SRL   RE,1                DO EVERY OTHER ONE (SKIP PRE)                
         L     RF,0(R3,R7)                                                      
         C     RF,0(R4,R7)         IF SUPPLY UNITS = ACH UNITS                  
         BE    SUMRPT32            THEN NO UNALLOCATED FOR WEEK                 
SUMRPT30 L     RF,0(R3,R7)         SUPPLY                                       
         S     RF,0(R4,R7)         LESS TOTAL ACH                               
         ST    RF,0(R5,R7)         = UNALLOCATED                                
         L     RF,0(R3,R7)                                                      
         ST    RF,0(R4,R7)         SET TOTAL = SUPPLY                           
         AHI   R7,8                NEXT WORD                                    
         BCT   RE,SUMRPT30                                                      
SUMRPT32 AH    R2,CELLWID          NEXT WEEK                                    
         BCT   R0,SUMRPT28                                                      
                                                                                
SUMRPT34 MVI   FORCEHED,YESQ       NOW DO REPORT FOR EACH BRAND                 
         MVI   RCSUBPRG,20                                                      
         MVI   PCTOPT,YESQ         ACTIVATE PERCENTAGE OPTION                   
*                                  SORT BRANDS IN PRINT ORDER                   
         L     R3,AFSTBRD          FIRST BUILD TABLE OF ADDRS                   
         L     R4,AEXCROW          SET ABRDSRT                                  
         AH    R4,LROW             AFTER PRODUCT TABLE                          
         AH    R4,LROW             LEAVE A ZERO ROW                             
         ST    R4,ABRDSRT                                                       
         SR    RF,RF                                                            
SUMRPT54 CLI   TABPRD,0                                                         
         BE    SUMRPT56                                                         
         MVC   0(1,R4),TABPRDA                                                  
         STCM  R3,15,1(R4)                                                      
         AH    R3,LROW             NEXT PRODUCT                                 
         AHI   R4,5                NEXT TABLE ENTRY                             
         AHI   RF,1                COUNT PRODUCTS                               
         B     SUMRPT54                                                         
SUMRPT56 MVI   0(R4),FF            SET END OF TABLE                             
         LTR   RF,RF                                                            
         BZ    SUMRPT60            NO PRODUCTS                                  
         GOTOR XSORT,DMCB,ABRDSRT,(RF),5,1,0                                    
         CLI   RPTOPTN,RPTORCPQ    IF DOING ONLY RECAP SKIP WEEKLY RPT          
         BE    SUMRPT64                                                         
         L     R4,ABRDSRT                                                       
SUMRPT58 CLI   0(R4),FF            END                                          
         BE    SUMRPT60                                                         
         ICM   R3,15,1(R4)         A(BRAND ROW)                                 
         ST    R3,THISPRD                                                       
         GOTOR BRDREP              DO BRAND REPORT                              
         AHI   R4,5                                                             
         B     SUMRPT58                                                         
SUMRPT60 L     R3,ATOTROW                                                       
         ST    R3,THISPRD                                                       
         GOTOR BRDREP              DO TOTALS                                    
SUMRPT62 SR    RF,RF               DO RECAP REPORT                              
         IC    RF,RPTSWK           (BUT ONLY AFTER LAST SET OF WEEKS)           
         AH    RF,RPTNWKS                                                       
         CH    RF,NWKSP1                                                        
         BL    SUMRPT66                                                         
         GOTOR REPORT              AT END OF WEEK REPORT                        
SUMRPT64 GOTOR RECRPT                                                           
SUMRPT66 MVI   WORK,0                                                           
         L     R3,ASUPROW                                                       
         OC    SUMASD(L'SUMASD+L'SUMPSD),SUMASD                                 
         BZ    SUMRPT70                                                         
SUMRPT68 MVI   WORK,1                                                           
         L     R3,ATOTROW                                                       
         OC    SUMGLDD(L'SUMGLDD+L'SUMGLRD),SUMGLDD                             
         BNZ   SUMRPT72                                                         
SUMRPT70 GOTOR REPORT                                                           
         MVC   P1(24),=C'*** No supply for market'                              
         CLI   WORK,0                                                           
         BE    *+10                                                             
         MVC   P1+7(6),=C'Goals '                                               
         MVC   P1+25(4),MKT                                                     
         LA    RF,P1+31                                                         
         CLI   RQMED,NETLETQ                                                    
         BNE   *+8                                                              
         LA    RF,P1+18                                                         
         MVC   0(24,RF),DPTDESC                                                 
         MVI   SPACING,2                                                        
         MVC   P2,SPACES                                                        
         GOTOR REPORT                                                           
                                                                                
SUMRPT72 MVI   RCSUBPRG,0                                                       
                                                                                
SUMRPTX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* REPORT FOR ONE BRAND                                                *         
***********************************************************************         
                                                                                
BRDREP   NTR1  ,                                                                
         MVC   SRPNL1,SPACES                                                    
         MVC   SRPNL2,SPACES                                                    
         GOTOR REPORT                                                           
         L     R3,THISPRD                                                       
         MVI   HCLASS,0                                                         
         CLI   TABPRD,TOTPRD                                                    
         BNE   BRDREP02                                                         
         MVC   SRPNL1(L'TOTALSL),TOTALSL                                        
         MVC   SRPNL2(12),DASHES                                                
         B     BRDREP14                                                         
BRDREP02 CLI   TABPRD,UNAPRD2                                                   
         BNE   BRDREP04                                                         
         MVC   SRPNL1(16),=C'***  Unallocated'                                  
         OC    SUMASD,SUMASD                                                    
         BZ    BRDREPX             SKIP IF NO UNALLOCATED                       
         B     BRDREP08                                                         
BRDREP04 SR    RF,RF                                                            
         IC    RF,TABPRD                                                        
         BCTR  RF,0                                                             
         MH    RF,PRDBUFLN                                                      
         A     RF,PRDBUFF                                                       
         USING PTBUFFD,RF                                                       
         CLI   PTPRDN,0                                                         
         BE    BRDREPX                                                          
         MVC   HPRD,PTPRDA                                                      
         MVC   SRPNL1(L'PTPRDA),PTPRDA                                          
         LA    R7,SRPNL1+5                                                      
         MVC   0(L'PTPPNAME,R7),PTPPNAME                                        
         TM    PTSTAT,PTSPIGPQ     TEST PIGGY                                   
         BNZ   *+10                YES, NAME HAS CNTL INFO                      
         MVC   0(L'PTNAME,R7),PTNAME                                            
         MVC   HCLASS,PTCLASS      AND CLASS                                    
         DROP  RF                                                               
BRDREP08 LA    R7,SRPNL1+34        UNDERLINE                                    
         CLI   0(R7),SPACE                                                      
         BH    *+8                                                              
         BCT   R7,*-8                                                           
         LA    R0,SRPNL1                                                        
         SR    R7,R0                                                            
         EX    R7,*+8                                                           
         B     *+10                                                             
         MVC   SRPNL2(0),DASHES                                                 
         CLI   TABPRD,UNAPRD2      NO SPECIALS FOR UNALLOCATED                  
         BE    BRDREP14                                                         
         LA    RF,SRPNL1+2         BREAK IN UNDERLINING                         
         CLI   0(RF),SPACE                                                      
         BNE   *+8                                                              
         MVI   L'SRPNL1+0(RF),SPACE                                             
         MVI   L'SRPNL1+1(RF),SPACE                                             
         MVI   L'SRPNL1+2(RF),SPACE                                             
BRDREP12 LA    R7,SRPNL1(R7)                                                    
         CLI   TABPRI,YESQ                                                      
         BNE   *+14                                                             
         MVC   3(3,R7),=C'(P)'                                                  
         AHI   R7,4                                                             
         CLI   HCLASS,SPACE                                                     
         BNH   BRDREP14                                                         
         MVC   3(L'CLASSEQL,R7),CLASSEQL                                        
         GOTOR SETCLS,HCLASS                                                    
         MVC   9(1,R7),CLASS1                                                   
         BH    BRDREP14                                                         
         MVI   10(R7),COMMA                                                     
         MVC   11(1,R7),CLASS2                                                  
BRDREP14 CLI   LINE,47                                                          
         BL    *+8                                                              
         MVI   FORCEHED,YESQ                                                    
         LA    R6,P1                                                            
         AH    R6,ROWDISP                                                       
         MVC   0(L'SRPNL1,R6),SRPNL1                                            
         MVC   L'P1(L'SRPNL2,R6),SRPNL2                                         
         MVI   NOMID,YESQ          SUPPRESS CONTINUED MESSAGE                   
         GOTOR REPORT                                                           
         MVI   NOMID,NOQ                                                        
         LA    R7,SRPNL1+L'SRPNL1-1                                             
         CLI   0(R7),SPACE                                                      
         BH    *+8                                                              
         BCT   R7,*-8                                                           
         MVC   3(11,R7),=C'(Continued)'                                         
                                                                                
***********************************************************************         
* GOALS                                                               *         
***********************************************************************         
                                                                                
         GOTOR REPORT                                                           
         LA    R2,P1                                                            
         AH    R2,ROWDISP          START OF ROW DESCS                           
         CLI   TABPRD,UNAPRD2      NO GOALS FOR UNALLOCATED                     
         BE    BRDREP52                                                         
         MVC   0(6,R2),=C'Goals-'                                               
         MVC   L'P1(5,R2),DASHES                                                
         AHI   R2,L'P1*2                                                        
         MVC   2(6,R2),=C'-None-'  NO GOALS FOR THIS PRODUCT                    
         OC    SUMGLDD(L'SUMGLDD+L'SUMGLRD),SUMGLDD TEST ANY GOALS              
         BZ    BRDREP50                                                         
         MVC   2(6,R2),=C'Budget'                                               
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,SUMGLDD          GOAL DOLLARS                                 
         LH    R5,RPTNWKS                                                       
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NO                                
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
BRDREP16 ICM   R1,15,0(R6)         SET IN DOLLARS                               
         BZ    BRDREP20                                                         
         CLI   RQMED,NETLETQ       NO ROUND FOR NETWORK                         
         BE    BRDREP18                                                         
         M     R0,FW1                                                           
         LH    RF,HW100                                                         
         GOTOR DIVIDE                                                           
         LTR   R1,R1                                                            
         BZ    BRDREP20                                                         
BRDREP18 EDIT  (R1),(8,0(R4)),FLOAT=$                                           
BRDREP20 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP16                                                      
         AHI   R2,L'P1             NEXT LINE                                    
         CLI   TABPRD,TOTPRD       PCT OF TOTAL BUDGET                          
         BE    BRDREP30                                                         
         CLI   PCTOPT,NOQ                                                       
         BE    BRDREP30                                                         
         MVC   2(4,R2),=C' Pct'                                                 
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,SUMGLDD                                                       
         L     R7,ATOTROW                                                       
         AHI   R7,SUMGLDD-TABD                                                  
         LH    R5,RPTNWKS                                                       
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NO                                
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
         AR    R7,RF                                                            
BRDREP22 L     R1,0(R6)                                                         
         M     R0,FW1000           1 DECIMAL                                    
         L     RF,0(R7)                                                         
         GOTOR DIVIDE                                                           
         EDIT  (R1),(8,0(R4)),1,ZERO=BLANK                                      
         AH    R6,CELLWID          NEXT WEEK                                    
         AH    R7,CELLWID                                                       
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP22                                                      
         AHI   R2,L'P1             NEXT LINE                                    
         CLI   GOALOPT,GOALDOLS                                                 
         BNE   BRDREP30                                                         
         TM    DIAGNOP1,FF-(DENVBEFQ+DNDXPRTQ)                                  
         BZ    BRDREP30                                                         
         MVC   2(9,R2),=C' Rescaled'    RESCALED $ GOALS                        
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,SUMRSGD                                                       
         LH    R5,RPTNWKS                                                       
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NO                                
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
BRDREP24 ICM   R1,15,0(R6)         GET IN DOLLARS                               
         BZ    BRDREP28                                                         
         CLI   RQMED,NETLETQ       NO ROUND FOR NETWORK                         
         BE    BRDREP26                                                         
         M     R0,FW1                                                           
         LH    RF,HW100                                                         
         GOTOR DIVIDE                                                           
         LTR   R1,R1                                                            
         BZ    BRDREP28                                                         
BRDREP26 EDIT  (R1),(8,0(R4)),FLOAT=$                                           
BRDREP28 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP24                                                      
         AHI   R2,L'P1             NEXT LINE                                    
BRDREP30 CLI   TABPRD,TOTPRD       FOR TOTALS                                   
         BNE   *+12                                                             
         TM    REQFLAG1,REQFMIXG   SKIP IF MIXED GOALS                          
         BNZ   BRDREP50                                                         
         LHI   RF,UGPIGPRD+1       SET DEMO NAME                                
         CLI   TABPRD,TOTPRD       USE POL FOR TOTAL                            
         BE    *+10                                                             
         IC    RF,TABPRD                                                        
         BCTR  RF,0                                                             
         MH    RF,PRDBUFLN                                                      
         A     RF,PRDBUFF                                                       
         GOTOR DEMNAM,PTDEMNO-PTBUFFD(RF)                                       
         MVC   HDEMO,WORK                                                       
         MVC   2(L'DEMNNAME+L'DEMNNADP,R2),WORK+L'DEMNDEMN                      
         LR    R4,R2               SET  GOAL DEMO LINE                          
         AH    R4,AMTDISP          START OF AMOUNTS                             
         LA    R6,SUMGLRD          GOAL DEMO DISPL                              
         LH    R5,RPTNWKS                                                       
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NO                                
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
BRDREP32 CLI   RQMED,NETLETQ       NO DECIMAL FOR NETWORK                       
         BNE   BRDREP34            AUDIENCES                                    
         CLI   HDEMO+1,RATINGQ                                                  
         BE    BRDREP34                                                         
         CLI   HDEMO+1,EXDRTGQ                                                  
         BE    BRDREP34                                                         
         EDIT  (B4,0(R6)),(8,0(R4)),ZERO=BLANK                                  
         B     BRDREP36                                                         
BRDREP34 EDIT  (B4,0(R6)),(8,0(R4)),1,ZERO=BLANK                                
BRDREP36 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP32                                                      
         AHI   R2,L'P1             NEXT LINE                                    
         TM    REQFLAG1,REQFMIXG   SKIP PCTS MIXED GOALS                        
         BNZ   BRDREP50                                                         
         CLI   TABPRD,TOTPRD       AND FOR TOTAL                                
         BE    BRDREP40                                                         
         CLI   PCTOPT,NOQ                                                       
         BE    BRDREP40                                                         
         MVC   2(4,R2),=C' Pct'                                                 
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,SUMGLRD          GOAL DEMO DISPL                              
         L     R7,ATOTROW          TOTAL ROW                                    
         AHI   R7,SUMGLRD-TABD                                                  
         LH    R5,RPTNWKS                                                       
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NUMBER                            
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
         AR    R7,RF                                                            
BRDREP38 L     R1,0(R6)                                                         
         M     R0,FW1000           1 DECIMAL                                    
         L     RF,0(R7)                                                         
         GOTOR DIVIDE                                                           
         EDIT  (R1),(8,0(R4)),1,ZERO=BLANK                                      
         AH    R6,CELLWID          NEXT WEEK                                    
         AH    R7,CELLWID                                                       
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP38                                                      
         AHI   R2,L'P1             NEXT LINE                                    
BRDREP40 MVC   2(4,R2),=C' CPM'    CPP/M                                        
         CLI   HDEMO+1,RATINGQ                                                  
         BE    *+12                                                             
         CLI   HDEMO+1,EXDRTGQ                                                  
         BNE   *+8                                                              
         MVI   2+3(R2),C'P'                                                     
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,TABD                                                          
         LH    R5,RPTNWKS                                                       
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NO                                
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
BRDREP42 L     R1,SUMGLDD-TABD(R6) GOAL DOLLARS                                 
         L     RF,CPPROUND                                                      
         CLI   HDEMO+1,RATINGQ                                                  
         BE    *+8                                                              
         CLI   HDEMO+1,EXDRTGQ                                                  
         BE    *+8                                                              
         L     RF,CPMROUND                                                      
         MR    R0,RF                                                            
         L     RF,SUMGLRD-TABD(R6) GOAL DEMO                                    
         GOTOR DIVIDE                                                           
         EDIT  (R1),(8,0(R4)),2,ZERO=BLANK                                      
         AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP42                                                      
         AHI   R2,L'P1             NEXT LINE                                    
         CLI   GOALOPT,GOALDEMS                                                 
         BNE   BRDREP50                                                         
         TM    DIAGNOP1,FF-(DENVBEFQ+DNDXPRTQ)                                  
         BZ    BRDREP50            DO RESCALE ONLY IF TRACE                     
         MVC   2(9,R2),=C' Rescaled'                                            
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,SUMRSGD                                                       
         LH    R5,RPTNWKS                                                       
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NO                                
         MH    RE,CELLWID                                                       
         AR    R6,RF                                                            
BRDREP44 CLI   RQMED,NETLETQ       NO DECIMAL FOR NETWORK                       
         BNE   BRDREP46            AUDIENCES                                    
         CLI   HDEMO+1,RATINGQ                                                  
         BE    BRDREP46                                                         
         CLI   HDEMO+1,EXDRTGQ                                                  
         BE    BRDREP46                                                         
         EDIT  (B4,0(R6)),(8,0(R4)),ZERO=BLANK                                  
         B     BRDREP48                                                         
BRDREP46 EDIT  (B4,0(R6)),(8,0(R4)),1,ZERO=BLANK                                
BRDREP48 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP44                                                      
         AHI   R2,L'P1             NEXT LINE                                    
BRDREP50 MVI   SPACING,2           PRINT WHOLE GOAL SECTION                     
         GOTOR REPORT                                                           
                                                                                
***********************************************************************         
* ACHIEVEMENT                                                         *         
***********************************************************************         
                                                                                
BRDREP52 LA    R2,P1                                                            
         AH    R2,ROWDISP                                                       
         MVC   0(12,R2),=C'Achievement-'                                        
         MVC   L'P1(11,R2),DASHES                                               
         AHI   R2,L'P1*2                                                        
         OC    SUMASD,SUMASD        TEST ANY ACH SPOTS                          
         BNZ   BRDREP54                                                         
         MVC   2(28,R2),=C'-No allocation for brand XXX-'                       
         MVC   27(3,R2),HPRD                                                    
         CLI   TABPRD,TOTPRD                                                    
         BNE   *+10                                                             
         MVC   2+15(30,R2),SPACES                                               
         MVI   SPACING,2                                                        
         GOTOR REPORT                                                           
         B     BRDREPX                                                          
BRDREP54 MVC   2(L'SPOTSL,R2),SPOTSL                                            
         CLI   RQMED,NETLETQ                                                    
         BNE   *+10                                                             
         MVC   2(L'UNITSL,R2),UNITSL UNITS FOR NETWORK                          
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,SUMASD           SPOTS                                        
         LH    R5,RPTNWKS                                                       
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NO                                
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
BRDREP56 EDIT  (B4,0(R6)),(8,X),1  NO                                           
         MVC   2(6,R4),X           DROP .0                                      
         AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP56                                                      
         AHI   R2,L'P1             NEXT LINE                                    
         CLI   TABPRD,TOTPRD       NO PCTS FOR TOTAL                            
         BE    BRDREP65                                                         
         CLI   PCTOPT,NOQ                                                       
         BE    BRDREP65                                                         
         MVC   2(4,R2),=C' Pct'    PCT OF TOTAL SPOTS                           
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,SUMASD                                                        
         L     R7,ATOTROW                                                       
         AHI   R7,SUMASD-TABD                                                   
         LH    R5,RPTNWKS                                                       
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NO                                
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
         AR    R7,RF                                                            
BRDREP64 L     R1,0(R6)                                                         
         M     R0,FW1000           1 DECIMAL                                    
         L     RF,0(R7)                                                         
         GOTOR DIVIDE                                                           
         EDIT  (R1),(8,0(R4)),1,ZERO=BLANK                                      
         AH    R6,CELLWID          NEXT WEEK                                    
         AH    R7,CELLWID                                                       
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP64                                                      
         AHI   R2,L'P1             NEXT LINE                                    
BRDREP65 MVC   2(4,R2),=C'Cost'    ACH DOLLARS                                  
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,SUMADD                                                        
         LH    R5,RPTNWKS                                                       
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NO                                
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
BRDREP66 ICM   R1,15,0(R6)                                                      
         BZ    BRDREP70                                                         
         CLI   RQMED,NETLETQ       NO ROUND FOR NETWORK                         
         BE    BRDREP68                                                         
         M     R0,FW1                                                           
         LH    RF,HW100            GET IN DOLLARS                               
         GOTOR DIVIDE                                                           
         LTR   R1,R1                                                            
         BZ    BRDREP70                                                         
BRDREP68 EDIT  (R1),(8,0(R4)),FLOAT=$                                           
BRDREP70 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP66                                                      
         AHI   R2,L'P1             NEXT LINE                                    
*                                  PCT OF DOLLARS                               
         CLI   TABPRD,TOTPRD       SKIP PCT FOR TOTAL                           
         BE    BRDREP82                                                         
         CLI   PCTOPT,NOQ                                                       
         BE    BRDREP74                                                         
         MVC   2(4,R2),=C' Pct'                                                 
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,SUMADD           DOLLARS                                      
         L     R7,ATOTROW                                                       
         AHI   R7,SUMADD-TABD                                                   
         LH    R5,RPTNWKS                                                       
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NO                                
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
         AR    R7,RF                                                            
BRDREP72 L     R1,0(R6)                                                         
         M     R0,FW1000           1 DECIMAL                                    
         L     RF,0(R7)                                                         
         GOTOR DIVIDE                                                           
         EDIT  (R1),(8,0(R4)),1,ZERO=BLANK                                      
         AH    R6,CELLWID          NEXT WEEK                                    
         AH    R7,CELLWID                                                       
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP72                                                      
         AHI   R2,L'P1                                                          
         CLI   TABPRD,TOTPRD       SKIP INDEX FOR TOTAL                         
         BNE   BRDREP74                                                         
         CLI   INDXOPT,INDXPCTQ    IF INDEX OF PCTS                             
         BE    BRDREP82                                                         
BRDREP74 MVC   2(6,R2),=C' Index'                                               
         LR    R4,R2                                                            
         MVC   CURDISP,=Y(SUMADD-TABD)                                          
         AH    R4,AMTDISP                                                       
         LA    R6,TABD                                                          
         L     R7,ATOTROW                                                       
         LH    R5,RPTNWKS                                                       
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NO                                
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
         AR    R7,RF                                                            
BRDREP76 CLI   INDXOPT,INDXPCTQ    TEST INDEX OF PCTS                           
         BE    BRDREP78            YES                                          
         LH    R1,CURDISP          NO - USE RAW NUMBERS                         
         L     R1,0(R1,R6)         PRODUCT ACH                                  
         M     R0,FW100                                                         
         L     RF,SUMGLDD-TABD(R6) / PRODUCT GOAL                               
         B     BRDREP80                                                         
BRDREP78 LH    R1,CURDISP                                                       
         L     R1,0(R1,R6)         PRODUCT ACH                                  
         M     R0,FW1000                                                        
         L     RF,SUMGLDD-TABD(R6) / PRODUCT GOAL                               
         GOTOR DIVIDE                                                           
         BNH   *+14                                                             
         MVC   0(8,R4),HIGHVALS                                                 
         B     BRDREP81                                                         
         M     R0,SUMGLDD-TABD(R7) X TOTAL GOAL                                 
         LH    RF,CURDISP                                                       
         L     RF,0(RF,R7)         / TOTAL ACH                                  
         MH    RF,HW10                                                          
BRDREP80 GOTOR DIVIDE                                                           
         EDIT  (R1),(8,0(R4))                                                   
BRDREP81 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R7,CELLWID                                                       
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP76                                                      
         AHI   R2,L'P1             NEXT LINE                                    
BRDREP82 MVI   SPACING,2           CPP/M                                        
         GOTOR REPORT              PRINT SPOTS AND DOLLARS                      
                                                                                
         GOTOR DEMNAM,DEMNMS       NOW DO DEMO ACHIEVEMENTS                     
         MVC   HDEMO,WORK                                                       
         MVC   CURDISP,=Y(SUMARD-TABD)                                          
         MVI   PRESW,NOQ           SET NOT DOING PRE-ALLOCS                     
         GOTOR FMTDEM,0                                                         
         SR    R5,R5                                                            
         ICM   R5,3,NTARGETS       NOW TARGETS                                  
         BZ    BRDREP86                                                         
         LA    R4,TARGETS                                                       
         LHI   R6,SUMAT1D-TABD     1ST TARG                                     
BRDREP84 GOTOR DEMNAM,0(R4)        DEM NAME IN                                  
         MVC   HDEMO,WORK                                                       
         STH   R6,CURDISP                                                       
         LR    R1,R4                                                            
         LA    R0,TARGETS-L'TARGETS                                             
         SR    R1,R0                                                            
         SRL   R1,2                                                             
         GOTOR FMTDEM                                                           
         AHI   R4,L'TARGETS                                                     
         AHI   R6,SUMAUDL                                                       
         BCT   R5,BRDREP84                                                      
*                                  PRE-ALLOCATED                                
BRDREP86 OC    SUMPSD,SUMPSD       TEST ANY PRE-SPOTS                           
         BZ    BRDREPX             NO - SKIP SECTION                            
         LA    R2,P1                                                            
         AH    R2,ROWDISP                                                       
         MVC   0(14,R2),=C'Pre-allocated-'                                      
         MVC   L'P1(13,R2),DASHES                                               
         AHI   R2,L'P1*2                                                        
         MVC   2(L'SPOTSL,R2),SPOTSL                                            
         CLI   RQMED,NETLETQ                                                    
         BNE   *+10                                                             
         MVC   2(L'UNITSL,R2),UNITSL UNITS FOR NETWORK                          
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,SUMPSD                                                        
         LH    R5,RPTNWKS                                                       
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NO                                
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
BRDREP88 EDIT  (B4,0(R6)),(8,X),1  NO                                           
         MVC   2(6,R4),X           DROP .0                                      
         AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP88                                                      
         AHI   R2,L'P1             NEXT LINE                                    
         MVC   2(4,R2),=C'Cost'                                                 
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,SUMPDD                                                        
         LH    R5,RPTNWKS                                                       
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NO                                
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
BRDREP96 L     R1,0(R6)                                                         
         CLI   RQMED,NETLETQ       DON'T ROUND FOR NETWORK                      
         BE    BRDREP98                                                         
         M     R0,FW1                                                           
         LH    RF,HW100                                                         
         GOTOR DIVIDE                                                           
BRDREP98 LTR   R1,R1                                                            
         BZ    BRDREPA2                                                         
         EDIT  (R1),(8,0(R4)),FLOAT=$                                           
BRDREPA2 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,BRDREP96                                                      
         GOTOR REPORT                                                           
         GOTOR DEMNAM,DEMNMS                                                    
         MVC   HDEMO,WORK                                                       
         MVC   CURDISP,=Y(SUMPRD-TABD)                                          
         MVI   PRESW,YESQ          SET DOING PRE-ALLOCS                         
         GOTOR FMTDEM,0                                                         
         SR    R5,R5                                                            
         ICM   R5,3,NTARGETS                                                    
         BZ    BRDREPX             NO TARGETS                                   
         LA    R4,TARGETS                                                       
         LHI   R6,SUMPT1D-TABD     PRE TARG1                                    
BRDREPA4 GOTOR DEMNAM,0(R4)                                                     
         MVC   HDEMO,WORK                                                       
         LR    R1,R4                                                            
         LA    R0,TARGETS-L'TARGETS                                             
         SR    R1,R0                                                            
         SRL   R1,2                                                             
         STH   R6,CURDISP                                                       
         GOTOR FMTDEM                                                           
         AHI   R4,L'TARGETS        NEXT TARGET                                  
         AHI   R6,SUMAUDL                                                       
         BCT   R5,BRDREPA4                                                      
BRDREPX  J     EXIT                                                             
         EJECT                                                                  
FMTDEM   NTR1  ,                                                                
         LA    R2,P1                                                            
         AH    R2,ROWDISP                                                       
         MVC   2(L'DEMNNADP+L'DEMNNAME,R2),HDEMO+L'DEMNDEMN                     
*                                  SHOW IF A BRAND TARGET                       
         CLI   TABPRD,TOTPRD       NOT FOR TOTAL                                
         BE    FMTDEM06                                                         
         CLI   TABPRD,UNAPRD2      OR UNALLOCATED                               
         BE    FMTDEM06                                                         
         LTR   R1,R1               OR CORP                                      
         BZ    FMTDEM06                                                         
         SR    RF,RF                                                            
         IC    RF,TABPRD                                                        
         BCTR  RF,0                                                             
         MH    RF,PRDBUFLN                                                      
         A     RF,PRDBUFF                                                       
         AHI   RF,PTTRGS-PTBUFFD                                                
         LA    RE,NTGVARS          FOR BCT THRU BRD TARGS                       
FMTDEM02 CLM   R1,1,0(RF)                                                       
         BE    FMTDEM04                                                         
         AHI   RF,1                                                             
         BCT   RE,FMTDEM02                                                      
         B     FMTDEM06                                                         
FMTDEM04 LA    R4,9(R2)            SLOT FOR TARGET TAG FOR NORMAL DEM           
         SHI   RE,NTGVARS+1                                                     
         LPR   RE,RE                                                            
         STC   RE,2(R4)                                                         
         OI    2(R4),ZONE                                                       
         MVI   0(R4),OPAREN                                                     
         MVI   1(R4),C'T'                                                       
         MVI   3(R4),CPAREN                                                     
FMTDEM06 LA    R6,TABD                                                          
         AH    R6,CURDISP                                                       
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LH    R5,RPTNWKS                                                       
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NO                                
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
FMTDEM08 CLI   RQMED,NETLETQ       NO DECIMAL FOR NETWORK                       
         BNE   FMTDEM10            AUDIENCES                                    
         CLI   HDEMO+1,RATINGQ                                                  
         BE    FMTDEM10                                                         
         CLI   HDEMO+1,EXDRTGQ                                                  
         BE    FMTDEM10                                                         
         EDIT  (B4,0(R6)),(8,0(R4)),ZERO=BLANK                                  
         B     FMTDEM12                                                         
FMTDEM10 EDIT  (B4,0(R6)),(8,0(R4)),1,ZERO=BLANK                                
FMTDEM12 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,FMTDEM08                                                      
         CLI   PRESW,YESQ          DONE IF DOING PRE'S                          
         BE    FMTDEM38                                                         
         AHI   R2,L'P1             NEXT LINE                                    
*                                  PCT ACHIEVED                                 
         CLI   TABPRD,TOTPRD       NO PCTS FOR TOTAL                            
         BE    FMTDEM16                                                         
         CLI   PCTOPT,NOQ                                                       
         BE    FMTDEM16                                                         
         MVC   2(4,R2),=C' Pct'                                                 
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,TABD                                                          
         AH    R6,CURDISP                                                       
         L     R7,ATOTROW                                                       
         AH    R7,CURDISP                                                       
         LH    R5,RPTNWKS                                                       
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NO                                
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
         AR    R7,RF                                                            
FMTDEM14 L     R1,0(R6)                                                         
         M     R0,FW1000           1 DECIMAL                                    
         L     RF,0(R7)                                                         
         GOTOR DIVIDE                                                           
         EDIT  (R1),(8,0(R4)),1,ZERO=BLANK                                      
         AH    R6,CELLWID          NEXT WEEK                                    
         AH    R7,CELLWID                                                       
         AH    R4,WEEKWID                                                       
         BCT   R5,FMTDEM14                                                      
         AHI   R2,L'P1             NEXT LINE                                    
FMTDEM16 SR    RF,RF               INDEX                                        
         IC    RF,TABPRD           SKIP INDEX IF NOT                            
         BCTR  RF,0                BRANDS GOALED DEMO                           
         MH    RF,PRDBUFLN                                                      
         A     RF,PRDBUFF                                                       
         A     RF,DEMOVDD          (ADD DISP. TO DEMO LIST)                     
         CLC   HDEMO(L'DEMNDEMN),0(RF)                                          
         BNE   FMTDEM26                                                         
         CLI   TABPRD,TOTPRD       SKIP INDEX FOR TOTAL                         
         BNE   FMTDEM18                                                         
         CLI   INDXOPT,INDXPCTQ    IF INDEX OF PCTS                             
         BE    FMTDEM26                                                         
FMTDEM18 MVC   2(6,R2),=C' Index'                                               
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,TABD                                                          
         L     R7,ATOTROW                                                       
         LH    R5,RPTNWKS                                                       
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NO                                
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
         AR    R7,RF                                                            
FMTDEM20 CLI   INDXOPT,INDXPCTQ    TEST INDX OF PCTS                            
         BE    FMTDEM22            YES                                          
         LH    R1,CURDISP          NO - USE RAW NUMBERS                         
         L     R1,0(R1,R6)         PRODUCT ACH                                  
         M     R0,FW100                                                         
         L     RF,SUMGLRD-TABD(R6) / PRODUCT GOAL                               
         B     FMTDEM24                                                         
FMTDEM22 TM    REQFLAG1,REQFMIXG   NO PCT INDEX IF MIXED GOALS                  
         BZ    *+14                                                             
         MVC   2(6,R2),SPACES                                                   
         B     FMTDEM26                                                         
         LH    R1,CURDISP                                                       
         L     R1,0(R1,R6)         PRODUCT ACH                                  
         ST    R1,FULL             SAVE PRODUCT ACH                             
         L     R1,SUMGLRD-TABD(R6) / PRODUCT GOAL                               
         LR    RF,R1               DIVISOR                                      
         L     R1,FULL             RESTORE PRODUCT ACH                          
         M     R0,FW1000                                                        
         GOTOR DIVIDE                                                           
         M     R0,SUMGLRD-TABD(R7) X TOTAL GOAL                                 
         LH    RF,CURDISP                                                       
         L     RF,0(RF,R7)         / TOTAL ACH                                  
         MH    RF,HW10                                                          
FMTDEM24 GOTOR DIVIDE                                                           
         EDIT  (R1),(8,0(R4))                                                   
         AH    R6,CELLWID          NEXT WEEK                                    
         AH    R7,CELLWID                                                       
         AH    R4,WEEKWID                                                       
         BCT   R5,FMTDEM20                                                      
         AHI   R2,L'P1             NEXT LINE                                    
FMTDEM26 MVC   2(4,R2),=C' CPM'    CPP/M                                        
         CLI   HDEMO+1,RATINGQ                                                  
         BE    *+12                                                             
         CLI   HDEMO+1,EXDRTGQ                                                  
         BNE   *+8                                                              
         MVI   2+3(R2),C'P'                                                     
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,TABD                                                          
         LH    R5,RPTNWKS                                                       
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NO                                
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
FMTDEM28 L     R1,SUMADD-TABD(R6)  ACH DOLLARS                                  
         L     RF,CPPROUND                                                      
         CLI   HDEMO+1,RATINGQ                                                  
         BE    *+8                                                              
         CLI   HDEMO+1,EXDRTGQ                                                  
         BE    *+8                                                              
         L     RF,CPMROUND                                                      
         MR    R0,RF                                                            
         LH    RF,CURDISP                                                       
         L     RF,0(R6,RF)         ACH DEMO                                     
         GOTOR DIVIDE                                                           
         BNH   *+14                                                             
         MVC   0(8,R4),HIGHVALS                                                 
         B     FMTDEM30                                                         
         EDIT  (R1),(8,0(R4)),2,ZERO=BLANK                                      
FMTDEM30 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,FMTDEM28                                                      
         AHI   R2,L'P1             NEXT LINE                                    
*                                  CPM INDEX                                    
         CLI   TABPRD,TOTPRD       SKIP CPM INDEX FOR TOTALS                    
         BE    FMTDEM36                                                         
         MVC   2(10,R2),=C' CPM index'                                          
         CLI   HDEMO+1,RATINGQ                                                  
         BE    *+12                                                             
         CLI   HDEMO+1,EXDRTGQ                                                  
         BNE   *+8                                                              
         MVI   2+3(R2),C'P'                                                     
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,TABD                                                          
         L     R7,ATOTROW                                                       
         LH    R5,RPTNWKS                                                       
         SR    RF,RF                                                            
         IC    RF,RPTSWK           START WEEK NO                                
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
         AR    R7,RF                                                            
FMTDEM32 L     R1,SUMADD-TABD(R6)  PRODUCT DOLLARS                              
         M     R0,FW1000                                                        
         LH    RF,CURDISP                                                       
         L     RF,0(R6,RF)         PRODUCT DEMO                                 
         GOTOR DIVIDE                                                           
         BNH   *+14                                                             
         MVC   0(8,R4),HIGHVALS                                                 
         B     FMTDEM34                                                         
         LH    RF,CURDISP                                                       
         M     R0,0(R7,RF)         X TOTAL DEMO                                 
         L     RF,SUMADD-TABD(R7)  / TOTAL DOLLARS                              
         MH    RF,HW10                                                          
         GOTOR DIVIDE                                                           
         EDIT  (R1),(8,0(R4))                                                   
FMTDEM34 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R7,CELLWID                                                       
         AH    R4,WEEKWID                                                       
         BCT   R5,FMTDEM32                                                      
FMTDEM36 MVI   SPACING,2                                                        
FMTDEM38 GOTOR REPORT                                                           
FMTDEMX  J     EXIT                                                             
         DROP  R3,R8,TOT                                                        
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* RECAP REPORT                                                        *         
***********************************************************************         
                                                                                
RECRPT   NTR1  BASE=*,LABEL=*                                                   
         MVI   FORCEHED,YESQ                                                    
         MVI   RCSUBPRG,10                                                      
         XC    WKDISP,WKDISP       SET TO DO TOTAL 'WEEK'                       
         L     R4,ABRDSRT          USE SORTED BRAND TABLE                       
RECRPT02 CLI   0(R4),FF            END                                          
         BE    RECRPT04                                                         
         ICM   R3,15,1(R4)         A(BRAND ROW)                                 
         ST    R3,THISPRD                                                       
         GOTOR RCRFMT                                                           
         AHI   R4,5                                                             
         B     RECRPT02                                                         
RECRPT04 L     R3,ATOTROW          NOW DO TOTAL                                 
         ST    R3,THISPRD                                                       
         GOTOR RCRFMT                                                           
RECRPTX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* FORMAT DATA FOR 1 BRAND/WEEK                                        *         
***********************************************************************         
                                                                                
RCRFMT   NTR1  ,                                                                
         USING TABD,R3                                                          
         LA    R2,P1                                                            
         USING RRLIND,R2                                                        
         CLI   TABPRD,TOTPRD                                                    
         BNE   *+14                                                             
         MVC   RRBRD(L'TOTALSL),TOTALSL                                         
         B     RCRFMT10                                                         
         CLI   TABPRD,UNAPRD2                                                   
         BNE   RCRFMT02                                                         
         LH    R8,WKDISP                                                        
         LA    RF,TABD(R8)                                                      
         OC    SUMASD-TABD(,RF),SUMASD-TABD(RF) TEST ANY ALLOCS                 
         BZ    RCRFMTX                          NO SKIP UNALL PRODUCT           
         MVC   RRBRD(16),=C'*** Unallocated*'                                   
         B     RCRFMT10                                                         
                                                                                
RCRFMT02 SR    R4,R4                                                            
         IC    R4,TABPRD                                                        
         BCTR  R4,0                                                             
         MH    R4,PRDBUFLN                                                      
         A     R4,PRDBUFF                                                       
         USING PTBUFFD,R4                                                       
         MVC   RRBRD,PTPRDA                                                     
         MVC   RRBRDN(L'PTPPNAME),PTPPNAME                                      
         TM    PTSTAT,PTSPIGPQ         TEST PIGGY                               
         BNZ   *+10                    YES, NAME HAS CNTL INFO                  
         MVC   RRBRDN(L'PTNAME),PTNAME                                          
         LA    R5,RRBRDN+L'P1                                                   
         CLI   TABPRI,YESQ                                                      
         BNE   RCRFMT06                                                         
         MVC   0(3,R5),=C'(P)'                                                  
         AHI   R5,4                                                             
RCRFMT06 CLI   TABPRDC,0                                                        
         BNH   RCRFMT08                                                         
         MVC   0(L'CLASSEQL,R5),CLASSEQL                                        
         GOTOR SETCLS,TABPRDC                                                   
         MVC   6(1,R5),CLASS1                                                   
         BH    RCRFMT08                                                         
         MVI   7(R5),COMMA                                                      
         MVC   8(1,R5),CLASS2                                                   
RCRFMT08 ST    R4,ZPRD             SAVE A(PRODUCT ENTRY)                        
RCRFMT10 LH    R8,WKDISP           R8 = PERMANENT WEEK DISPLACEMENT             
*                                  UNITS                                        
         MVC   RRDESC(L'SPOTSL),SPOTSL                                          
         CLI   RQMED,NETLETQ                                                    
         BNE   *+10                                                             
         MVC   RRDESC(L'UNITSL),UNITSL                                          
         L     R1,SUMASD(R8)                                                    
         EDIT  (R1),(8,X),1        NO                                           
         MVC   RRACH+2(6),X        DROP .0                                      
         L     R4,ATOTROW                                                       
         L     RF,SUMASD-TABD(R4,R8)                                            
         L     R1,SUMASD(R8)                                                    
         M     R0,FW100                                                         
         GOTOR DIVIDE                                                           
         EDIT  (R1),(3,RRAPCT)                                                  
         AHI   R2,L'P1             NEXT LINE                                    
*                                  COSTS                                        
         MVC   RRDESC(4),=C'Cost'                                               
         L     R1,SUMGLDD(R8)      GOAL DOLLARS                                 
         LTR   R1,R1                                                            
         BZ    RCRFMT20                                                         
         CLI   RQMED,NETLETQ       NO ROUND FOR NETWORK                         
         BE    RCRFMT18                                                         
         M     R0,FW1                                                           
         LH    RF,HW100                                                         
         GOTOR DIVIDE                                                           
         LTR   R1,R1                                                            
         BZ    RCRFMT20                                                         
RCRFMT18 EDIT  (R1),(8,RRGOAL),FLOAT=$,ZERO=NOBLANK                             
RCRFMT20 L     R4,ATOTROW                                                       
         L     RF,SUMGLDD-TABD(R4,R8)                                           
         L     R1,SUMGLDD(R8)                                                   
         M     R0,FW100                                                         
         GOTOR DIVIDE                                                           
         EDIT  (R1),(3,RRGPCT)     GOAL DOLLARS PCT                             
         L     R1,SUMADD(R8)       ACH DOLLARS                                  
         LTR   R1,R1                                                            
         BZ    RCRFMT24                                                         
         CLI   RQMED,NETLETQ       NO ROUND FOR NETWORK                         
         BE    RCRFMT22                                                         
         M     R0,FW1                                                           
         LH    RF,HW100                                                         
         GOTOR DIVIDE                                                           
         LTR   R1,R1                                                            
         BZ    RCRFMT24                                                         
RCRFMT22 EDIT  (R1),(8,RRACH),FLOAT=$,ZERO=NOBLANK                              
RCRFMT24 L     RF,SUMADD-TABD(R4,R8)                                            
         L     R1,SUMADD(R8)                                                    
         M     R0,FW100                                                         
         GOTOR DIVIDE                                                           
         EDIT  (R1),(3,RRAPCT)     ACH DOLLARS PCT                              
         CLI   INDXOPT,INDXPCTQ    TEST INDEX OF PCTS                           
         BE    RCRFMT26                                                         
*                                  INDEX OF RAW NOS.                            
         L     R1,SUMADD(R8)       ACH DOLLARS                                  
         M     R0,FW100                                                         
         L     RF,SUMGLDD(R8)      / GOAL DOLLARS                               
         B     RCRFMT28                                                         
*                                  PCT INDEX                                    
RCRFMT26 L     R1,SUMADD(R8)       PRODUCT ACH                                  
         M     R0,FW1000                                                        
         L     RF,SUMGLDD(R8)      / PRODUCT GOAL DOLLARS                       
         GOTOR DIVIDE                                                           
         M     R0,SUMGLDD-TABD(R4,R8) X TOTAL GOAL                              
         L     RF,SUMADD-TABD(R4,R8)  / TOTAL ACH                               
         MH    RF,HW10                                                          
RCRFMT28 GOTOR DIVIDE                                                           
         EDIT  (R1),(4,RRINDX)                                                  
         AHI   R2,L'P1             NEXT LINE                                    
*                                  DEMOS                                        
         MVC   HDEMO,DEMNMS        FIRST DO CORP                                
         MVC   CURDISP,=Y(SUMARD-TABD)                                          
         GOTOR RCFDEM                                                           
*                                  NOW DO GOALED DEMO                           
         CLI   TABPRD,UNAPRD2      NOT FOR UNALL                                
         BE    RCRFMT40                                                         
         CLI   TABPRD,TOTPRD       SPECIAL FOR TOTAL                            
         BE    RCRFMT36                                                         
         L     R4,ZPRD                                                          
         LA    RF,PTBUFFD                                                       
         A     RF,DEMOVDD          RF=A(DEMO LIST)                              
         MVC   HDEMO(L'DEMNDEMN),0(RF)                                          
         CLC   HDEMO(L'DEMNDEMN),DEMNMS                                         
         BE    RCRFMT30            SKIP IF EQUAL CORP                           
         LA    RF,TARGETS          FIND IN TARGET LIST                          
         CLC   HDEMO(L'DEMNDEMN),0(RF)                                          
         BE    *+12                                                             
         AHI   RF,L'TARGETS                                                     
         B     *-14                                                             
         LA    R0,TARGETS                                                       
         SR    RF,R0                                                            
         SLL   RF,1                8 BYTES PER TARG                             
         AHI   RF,SUMAT1D-TABD                                                  
         STH   RF,CURDISP          SET DISPLACEMENT                             
         LA    R2,P1                                                            
         GOTOR RCFDEM                                                           
RCRFMT30 TM    REQFLAG1,REQFTRGS   TARGS 1-N                                    
         BZ    RCRFMT40                                                         
         LA    R4,PTTRGS                                                        
         LA    R7,NTGVARS                                                       
RCRFMT32 CLI   0(R4),0                                                          
         BE    RCRFMT34                                                         
         SR    R6,R6                                                            
         IC    R6,0(R4)            GET FROM TARG LIST                           
         BCTR  R6,0                                                             
         SLL   R6,2                                                             
         LA    RF,TARGETS(R6)                                                   
         MVC   HDEMO(L'DEMNDEMN),0(RF)                                          
         CLC   HDEMO(L'DEMNDEMN),DEMNMS                                         
         BE    RCRFMT34                                                         
         L     RF,ZPRD                                                          
         A     RF,DEMOVDD                                                       
         CLC   HDEMO(L'DEMNDEMN),0(RF)                                          
         BE    RCRFMT34                                                         
         SLL   R6,1                8 BYTES PER TARG                             
         AHI   R6,SUMAT1D-TABD                                                  
         STH   R6,CURDISP                                                       
         LA    R2,P1                                                            
         GOTOR RCFDEM                                                           
RCRFMT34 AHI   R4,1                                                             
         BCT   R7,RCRFMT32                                                      
         B     RCRFMT40                                                         
                                                                                
RCRFMT36 SR    R7,R7                                                            
         ICM   R7,3,NTARGETS       FOR TOTAL DO ALL TARGS                       
         BZ    RCRFMT40                                                         
         LA    R6,TARGETS                                                       
         LHI   RF,SUMAT1D-TABD                                                  
RCRFMT38 MVC   HDEMO(L'DEMNDEMN),0(R6)                                          
         STH   RF,CURDISP                                                       
         LA    R2,P1                                                            
         GOTOR RCFDEM                                                           
         AHI   R6,L'TARGETS        NEXT TARG                                    
         AHI   RF,SUMAUDL                                                       
         BCT   R7,RCRFMT38                                                      
RCRFMT40 GOTOR REPORT                                                           
RCRFMTX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* RECAP REPORT - DEMO LINE                                            *         
***********************************************************************         
                                                                                
RCFDEM   NTR1  ,                                                                
         GOTOR DEMNAM,HDEMO                                                     
         MVC   RRDESC(L'DEMNNADP+L'DEMNNAME),WORK+L'DEMNDEMN                    
*                                  SET DEMO RELATION TO PRODUCT                 
         CLI   TABPRD,UNAPRD2      NOT FOR UNALL OR TOTAL                       
         BNL   RCFDEM16                                                         
         MVC   WORK(10),SPACES                                                  
         MVI   WORK,OPAREN                                                      
         LA    R5,WORK+1                                                        
         CLC   HDEMO(L'DEMNDEMN),DEMNMS                                         
         BNE   RCFDEM02                                                         
         MVC   0(2,R5),=C'C,'      CORPORATE                                    
         AHI   R5,2                                                             
                                                                                
RCFDEM02 TM    REQFLAG1,REQFMIXG                                                
         BZ    RCFDEM04                                                         
         L     RF,ZPRD                                                          
         A     RF,DEMOVDD                                                       
         CLC   HDEMO(L'DEMNDEMN),0(RF)                                          
         BNE   RCFDEM04                                                         
         MVC   0(2,R5),=C'G,'      GOALED DEMO                                  
         AHI   R5,2                                                             
RCFDEM04 LHI   R7,MAXTARGS         FIND IN TARG LIST                            
         LA    R6,TARGETS                                                       
RCFDEM06 CLC   HDEMO(L'DEMNDEMN),0(R6)                                          
         BE    RCFDEM08                                                         
         AHI   R6,L'TARGETS                                                     
         BCT   R7,RCFDEM06                                                      
         B     RCFDEM14                                                         
                                                                                
RCFDEM08 LA    R0,TARGETS-L'TARGETS                                             
         SR    R6,R0                                                            
         SRL   R6,2                SEE IF A TARG FOR THIS PRODUCT               
         STC   R6,BYTE                                                          
         LHI   R7,NTGVARS                                                       
         L     R4,ZPRD                                                          
         LA    R6,PTTRGS                                                        
RCFDEM10 CLC   BYTE,0(R6)                                                       
         BE    RCFDEM12                                                         
         AHI   R6,1                                                             
         BCT   R7,RCFDEM10                                                      
         B     RCFDEM14                                                         
RCFDEM12 LA    R0,PTTRGS-1                                                      
         SR    R6,R0                                                            
         MVI   0(R5),C'T'                                                       
         STC   R6,1(R5)            TARG NUMBER FOR PRODUCT                      
         OI    1(R5),ZONE                                                       
         MVI   2(R5),COMMA                                                      
         AHI   R5,3                                                             
RCFDEM14 BCTR  R5,0                                                             
         MVI   0(R5),CPAREN                                                     
         CLC   WORK(3),=C'(C)'     IF CORP ONLY - DON'T PRINT                   
         BE    RCFDEM16                                                         
         CLI   WORK,CPAREN                                                      
         BE    RCFDEM16                                                         
         MVC   RRDESC+12(10),WORK                                               
RCFDEM16 MVI   GOLDEMSW,NOQ        NOT GOALED DEMO                              
         CLI   TABPRD,UNAPRD2      UNALL                                        
         BE    RCFDEM26                                                         
         CLI   TABPRD,TOTPRD       TOTAL                                        
         BNE   RCFDEM18                                                         
         CLC   HDEMO(L'DEMNDEMN),BASEDEM ONLY IF THIS IS CORP                   
         BNE   RCFDEM26                                                         
         TM    REQFLAG1,REQFMIXG   AND NO MIXED GOALS                           
         BNZ   RCFDEM26                                                         
         B     RCFDEM20                                                         
RCFDEM18 L     RF,ZPRD                                                          
         A     RF,DEMOVDD                                                       
         CLC   HDEMO(L'DEMNDEMN),0(RF)                                          
         BNE   RCFDEM26                                                         
RCFDEM20 MVI   GOLDEMSW,YESQ       SET IS GOALED DEMO                           
         L     R1,SUMGLRD(R8)      GOAL                                         
         CLI   RQMED,NETLETQ       NO DECIMAL FOR NETWORK                       
         BNE   RCFDEM22            AUDIENCES                                    
         CLI   HDEMO+1,RATINGQ                                                  
         BE    RCFDEM22                                                         
         CLI   HDEMO+1,EXDRTGQ                                                  
         BE    RCFDEM22                                                         
         EDIT  (R1),(8,RRGOAL),ZERO=NOBLANK                                     
         B     RCFDEM24                                                         
RCFDEM22 EDIT  (R1),(8,RRGOAL),1,ZERO=NOBLANK                                   
RCFDEM24 TM    REQFLAG1,REQFMIXG   SKIP PCT IF MIXED GOALS                      
         BNZ   RCFDEM26                                                         
         MVC   RRGPCT,=C'100'      100 PCT FOR TOTALS                           
         CLI   TABPRD,TOTPRD                                                    
         BE    RCFDEM26                                                         
         L     R4,ATOTROW                                                       
         L     R1,SUMGLRD(R8)                                                   
         M     R0,FW100                                                         
         L     RF,SUMGLRD-TABD(R4,R8)                                           
         GOTOR DIVIDE                                                           
         EDIT  (R1),(3,RRGPCT)                                                  
RCFDEM26 LA    RF,0(R3,R8)         ACH DEMO                                     
         AH    RF,CURDISP                                                       
         L     R1,0(RF)                                                         
         CLI   RQMED,NETLETQ       NO DECIMAL FOR NETWORK                       
         BNE   RCFDEM28            AUDIENCES                                    
         CLI   HDEMO+1,RATINGQ                                                  
         BE    RCFDEM28                                                         
         CLI   HDEMO+1,EXDRTGQ                                                  
         BE    RCFDEM28                                                         
         EDIT  (R1),(8,RRACH),ZERO=NOBLANK                                      
         B     RCFDEM30                                                         
RCFDEM28 EDIT  (R1),(8,RRACH),1,ZERO=NOBLANK                                    
*                                  ACH PCT                                      
RCFDEM30 MVC   RRAPCT,=C'100'      100 PCT FOR TOTALS                           
         CLI   TABPRD,TOTPRD                                                    
         BE    RCFDEM32                                                         
         L     R4,ATOTROW                                                       
         LA    RE,0(R3,R8)                                                      
         AH    RE,CURDISP                                                       
         L     R1,0(RE)            THIS PRODUCT                                 
         M     R0,FW100                                                         
         LA    RE,0(R4,R8)                                                      
         AH    RE,CURDISP                                                       
         L     RF,0(RE)            TOTAL FOR DEMO                               
         GOTOR DIVIDE                                                           
         EDIT  (R1),(3,RRAPCT)                                                  
RCFDEM32 CLI   GOLDEMSW,YESQ       NO INDEX IF NOT GOALED DEMO                  
         BNE   RCFDEM40                                                         
         CLI   INDXOPT,INDXPCTQ    TEST PCT INDX                                
         BE    RCFDEM36                                                         
RCFDEM34 LA    RF,0(R3,R8)         RAW NO. INDEX                                
         AH    RF,CURDISP                                                       
         L     R1,0(RF)                                                         
         M     R0,FW100                                                         
         L     RF,SUMGLRD(R8)                                                   
         B     RCFDEM38                                                         
*                                  PCT INDEX                                    
RCFDEM36 TM    REQFLAG1,REQFMIXG   SKIP IF MIXED GOALS                          
         BNZ   RCFDEM40                                                         
         MVC   RRINDX+1(3),=C'100' 100 PCT FOR TOTALS                           
         CLI   TABPRD,TOTPRD                                                    
         BE    RCFDEM40                                                         
         LA    RF,0(R3,R8)                                                      
         AH    RF,CURDISP                                                       
         L     R1,0(RF)            PRODUCT ACH                                  
         LR    R6,R1               SAVE PRODUCT ACH                             
         L     R1,SUMGLRD(R8)      / PRODUCT GOAL                               
         LR    RF,R1               DIVISOR                                      
         LR    R1,R6               RESTORE PRODUCT ACH                          
         M     R0,FW1000                                                        
         GOTOR DIVIDE                                                           
         L     R4,ATOTROW                                                       
         M     R0,SUMGLRD-TABD(R4,R8) X TOTAL GOAL                              
         LA    RF,0(R4,R8)                                                      
         AH    RF,CURDISP                                                       
         L     RF,0(RF)            / TOTAL ACH                                  
         MH    RF,HW10                                                          
RCFDEM38 GOTOR DIVIDE                                                           
         EDIT  (R1),(4,RRINDX)                                                  
*                                  CPP/M                                        
RCFDEM40 AHI   R2,L'P1             NEXT LINE                                    
         LA    RF,RRDESC+1                                                      
         MVC   0(3,RF),=C'CPP'                                                  
         CLI   HDEMO+1,RATINGQ                                                  
         BE    *+8                                                              
         CLI   HDEMO+1,EXDRTGQ                                                  
         BE    *+10                                                             
         MVC   0(3,RF),=C'CPM'                                                  
         CLI   GOLDEMSW,YESQ       GOAL CPM ONLY IF GOALED DEMO                 
         BNE   RCFDEM42                                                         
         L     R1,SUMGLDD(R8)      GOAL DOLLARS                                 
         L     RF,CPPROUND                                                      
         CLI   HDEMO+1,RATINGQ                                                  
         BE    *+8                                                              
         CLI   HDEMO+1,EXDRTGQ                                                  
         BE    *+8                                                              
         L     RF,CPMROUND                                                      
         MR    R0,RF                                                            
         L     RF,SUMGLRD(R8)      GOAL DEMO                                    
         GOTOR DIVIDE                                                           
         EDIT  (R1),(8,RRGOAL),2                                                
RCFDEM42 L     R1,SUMADD(R8)       ACH DOLLARS                                  
         L     RF,CPPROUND                                                      
         CLI   HDEMO+1,RATINGQ                                                  
         BE    *+8                                                              
         CLI   HDEMO+1,EXDRTGQ                                                  
         BE    *+8                                                              
         L     RF,CPMROUND                                                      
         MR    R0,RF                                                            
         LA    RF,0(R3,R8)                                                      
         AH    RF,CURDISP                                                       
         L     RF,0(RF)            ACH DEMO                                     
         GOTOR DIVIDE                                                           
         EDIT  (R1),(8,RRACH),2                                                 
         GOTOR REPORT                                                           
RCFDEMX  J     EXIT                                                             
         DROP  R2,R3,R4                                                         
                                                                                
ZPRD     DS    A                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* CHILD SPOT REPORT                                                   *         
***********************************************************************         
                                                                                
CHDRPT   NTR1  BASE=*,LABEL=*                                                   
         TM    REQFLAG1,REQFCHDR   TEST NEED CHILD REPORT                       
         BZ    CHDRPTX                                                          
         L     R8,MEDBUFF                                                       
         USING MEDBLOCK,R8                                                      
         USING CSD,R6              R6 USED THROUGHOUT                           
         LTR   R7,R1               R7 = A(BUYREC)                               
         BZ    CHDRPT16            IF NONE - PRINT REPORT                       
         L     R7,0(R7)            R7=A(BUY RECORD)                             
         XC    X,X                 LIST OF PRODUCTS IN X                        
         GOTOR MEDPSL,DMCB,SPWORKD,X                                            
         XC    SPOTHOOK,SPOTHOOK                                                
         MVI   MEDEXTCS,YESQ                                                    
         MVI   MEDEXTDM,0                                                       
         LA    R3,X                                                             
CHDRPT02 CLC   0(1,R3),2(R3)                                                    
         BNE   CHDRPT06                                                         
CHDRPT04 AHI   R3,2                                                             
         CLI   0(R3),0             EOL                                          
         BE    CHDRPT56                                                         
         B     CHDRPT02                                                         
CHDRPT06 MVC   MEDBRAND,0(R3)                                                   
         MVI   MEDSPTLN,0                                                       
         MVC   SAVKEY,SVBUYKEY     PRESERVE SVBUYKEY                            
         MVC   SVBUYKEY,0(R7)      SET SVBUYKEY FOR MEDGETBUY                   
         MVI   NOPRDNTP,SPACE                                                   
         L     RE,ADCLT                                                         
         AHI   RE,COPT1-CLTHDR                                                  
         TM    0(RE),COP1GMI       TEST GMI OPTION                              
         BZ    CHDRPT08            NO                                           
         CLI   QOPT2,NOQ           TEST NTP ALLOCATION                          
         BNE   CHDRPT08                                                         
         MVI   NOPRDNTP,YESQ       SET SUPPRESS TALENT FACTORS BY PRD           
CHDRPT08 GOTOR MEDGETBY,DMCB,SPWORKD,2                                          
         MVC   SVBUYKEY,SAVKEY                                                  
         L     RF,MEDPERD+4        USE PERIOD TOTAL                             
         USING MEDDATA,RF                                                       
         L     R6,ABRDTAB          PRODUCT TAB                                  
CHDRPT10 CLC   MEDBRAND,CSPRD                                                   
         BE    CHDRPT12                                                         
         CLI   CSPRD,0             END                                          
         BE    CHDRPT14                                                         
         LA    R6,CSD+CSDL         NEXT                                         
         B     CHDRPT10                                                         
CHDRPT12 L     R1,CSNTP            ADD TO EXISTING PRODUCT                      
         A     R1,MEDCSNTP                                                      
         ST    R1,CSNTP                                                         
         L     R1,CSPAY                                                         
         A     R1,MEDCSPAY                                                      
         ST    R1,CSPAY                                                         
         B     CHDRPT04            NEXT PRODUCT                                 
CHDRPT14 MVC   CSPRD,MEDBRAND      NEW PRODUCT                                  
         MVC   CSNTP,MEDCSNTP                                                   
         MVC   CSPAY,MEDCSPAY                                                   
         MVI   CSD+CSDL,0                                                       
         B     CHDRPT04            NEXT PRODUCT                                 
         EJECT                                                                  
***********************************************************************         
* PRINT CHILD SPOT REPORT                                             *         
***********************************************************************         
                                                                                
CHDRPT16 XC    GBUFFK,GBUFFK       FIRST GET GOALS FROM BUFF TAB                
         GOTOR BU1RDH              READ HIGH BUFFER 1                           
         B     CHDRPT20                                                         
CHDRPT18 GOTOR BU1RSQ              READ SEQUENTIAL BUFFER 1                     
CHDRPT20 BNZ   CHDRPT28                                                         
         CLI   GBPRD,SUPPRD        SKIP SUPPLY                                  
         BE    CHDRPT18                                                         
         CLI   GBPRD,TOTPRD        AND TOTALS                                   
         BE    CHDRPT18                                                         
         MVI   BYTE,TGOLDEMQ                                                    
         CLI   GOALOPT,GOALDOLS                                                 
         BNE   *+8                                                              
         MVI   BYTE,TGOLDOLQ                                                    
         CLC   GBTYP,BYTE          TEST RIGHT TYPE                              
         BNE   CHDRPT18                                                         
         L     R6,ABRDTAB          FIND IN PRODUCT TAB                          
CHDRPT22 CLC   GBPRD,CSPRD                                                      
         BE    CHDRPT24                                                         
         CLI   CSPRD,0             END                                          
         BE    CHDRPT26                                                         
         LA    R6,CSD+CSDL         NEXT                                         
         B     CHDRPT22                                                         
CHDRPT24 ICM   RF,15,GBTOT                                                      
         A     RF,CSGOAL           ADD TO EXISTING PRODUCT                      
         ST    RF,CSGOAL                                                        
         B     CHDRPT18                                                         
CHDRPT26 MVC   CSPRD,GBPRD         NEW PRODUCT                                  
         MVC   CSGOAL,GBTOT                                                     
         MVI   CSD+CSDL,0                                                       
         B     CHDRPT18                                                         
CHDRPT28 L     R6,ABRDTAB          COUNT PRODUCTS                               
         SR    R4,R4                                                            
CHDRPT30 CLI   CSPRD,0                                                          
         BE    CHDRPT32                                                         
         AHI   R4,1                                                             
         LA    R6,CSD+CSDL                                                      
         B     CHDRPT30                                                         
*                                  SORT IN DESCENDING GOAL ORDER                
CHDRPT32 GOTOR XSORT,DMCB,(C'D',ABRDTAB),(R4),CSDL,4,4                          
         L     R6,ABRDTAB          ADD UP PRODUCT TOTALS TO                     
         XC    X(CSACCSL),X        MARKET TOTAL IN X                            
CHDRPT34 CLI   CSPRD,0                                                          
         BE    CHDRPT36                                                         
         L     RE,CSNTP                                                         
         A     RE,CSPAY                                                         
         ST    RE,CSTOT            SET CSTOT = CSNTP + CSPAY                    
         LM    RE,R1,X                                                          
         A     RE,CSGOAL                                                        
         A     RF,CSNTP                                                         
         A     R0,CSPAY                                                         
         A     R1,CSTOT                                                         
         STM   RE,R1,X                                                          
         LA    R6,CSD+CSDL         NEXT PRODUCT                                 
         B     CHDRPT34                                                         
*                                  ROUND TO DOLLARS                             
CHDRPT36 MVC   CSACCS(CSACCSL),X   SET MARKET TOTS AT END OF TABLE              
         L     R6,ABRDTAB                                                       
CHDRPT38 LA    R5,CSACCS                                                        
         LHI   R4,CSACCSN                                                       
CHDRPT40 L     R1,0(R5)                                                         
         SR    R0,R0                                                            
         LH    RF,HW100                                                         
         GOTOR DIVIDE                                                           
         ST    R1,0(R5)                                                         
         AHI   R5,L'CSACCS                                                      
         BCT   R4,CHDRPT40                                                      
         CLI   CSPRD,0                                                          
         BE    CHDRPT42                                                         
         LA    R6,CSD+CSDL                                                      
         B     CHDRPT38                                                         
CHDRPT42 MVC   X(CSACCSL),CSACCS   PUT ROUNDED DOLLARS BACK IN X                
         LA    R2,X+4              PUT IN X+16,+20,+24 RATIOS USED              
         LHI   R3,3                IN INDX CALC - SOLVES OVRFLO PROB            
CHDRPT44 L     R1,X                                                             
         M     R0,FW1000                                                        
         L     RF,0(R2)                                                         
         GOTOR DIVIDE                                                           
         ST    R1,12(R2)                                                        
         AHI   R2,4                                                             
         BCT   R3,CHDRPT44                                                      
         MVI   RCSUBPRG,80                                                      
         MVI   FORCEHED,YESQ                                                    
         L     R6,ABRDTAB                                                       
CHDRPT46 CLI   CSPRD,0             REPORT CALC AND PRINT LOOP                   
         BE    CHDRPT48                                                         
         OC    CSACCS(CSACCSL),CSACCS                                           
         BZ    CHDRPT52                                                         
         SR    RF,RF               GET PRODUCT CODE AND NAME                    
         IC    RF,CSPRD                                                         
         BCTR  RF,0                                                             
         MH    RF,PRDBUFLN                                                      
         A     RF,PRDBUFF                                                       
         MVC   CSPCOD,PTPRDA-PTBUFFD(RF)                                        
         MVC   CSPNAM,PTNAME-PTBUFFD(RF)                                        
         B     CHDRPT50                                                         
CHDRPT48 MVC   CSPCOD+4(19),=C'** Market totals **'                             
CHDRPT50 L     R1,CSGOAL                                                        
         LA    R2,CSPGLD           GOAL                                         
         GOTOR CHDDOL                                                           
         L     R1,CSGOAL                                                        
         L     RF,X+(CSGOAL-CSACCS)                                             
         LA    R2,CSPGLP           GOAL PCT                                     
         GOTOR CHDPCT                                                           
         L     R1,CSNTP                                                         
         LA    R2,CSPNTPD          NTP DOLLARS                                  
         GOTOR CHDDOL                                                           
         L     R1,CSNTP                                                         
         L     RF,X+(CSNTP-CSACCS)                                              
         LA    R2,CSPNTPP          NTP PCT                                      
         GOTOR CHDPCT                                                           
         L     R1,CSNTP                                                         
         M     R0,X+16                                                          
         L     RF,CSGOAL                                                        
         MH    RF,HW10                                                          
         LA    R2,CSPNTPI          NTP INDX                                     
         GOTOR CHDPCT2                                                          
         L     R1,CSPAY                                                         
         LA    R2,CSPPAYD          PAY DOLLARS                                  
         GOTOR CHDDOL                                                           
         L     R1,CSPAY                                                         
         L     RF,X+(CSPAY-CSACCS)                                              
         LA    R2,CSPPAYP          PAY PCT                                      
         GOTOR CHDPCT                                                           
         L     R1,CSPAY                                                         
         M     R0,X+20                                                          
         L     RF,CSGOAL                                                        
         MH    RF,HW10                                                          
         LA    R2,CSPPAYI          PAY INDX                                     
         GOTOR CHDPCT2                                                          
         L     R1,CSTOT                                                         
         LA    R2,CSPTOTD          TOTAL DOLLARS                                
         GOTOR CHDDOL                                                           
         L     R1,CSTOT                                                         
         L     RF,X+(CSTOT-CSACCS)                                              
         LA    R2,CSPTOTP          TOTAL PCT                                    
         GOTOR CHDPCT                                                           
         L     R1,CSTOT                                                         
         M     R0,X+24                                                          
         L     RF,CSGOAL                                                        
         MH    RF,HW10                                                          
         LA    R2,CSPTOTI          TOTAL INDX                                   
         GOTOR CHDPCT2                                                          
         MVI   SPACING,2                                                        
         GOTOR REPORT                                                           
         CLI   CSPRD,0                                                          
         BE    CHDRPT54                                                         
CHDRPT52 LA    R6,CSD+CSDL                                                      
         B     CHDRPT46                                                         
CHDRPT54 MVI   RCSUBPRG,0                                                       
CHDRPT56 MVI   MEDEXTCS,NOQ                                                     
CHDRPTX  J     EXIT                                                             
         EJECT                                                                  
CHDDOL   EDIT  (R1),(7,0(R2))      ROUND DOLLARS AND PRINT                      
         BR    RE                                                               
                                                                                
CHDPCT   M     R0,FW100            CALC PCT AND PRINT                           
CHDPCT2  ST    RE,SAVERE                                                        
         GOTOR DIVIDE                                                           
         EDIT  (R1),(3,0(R2))                                                   
         L     RE,SAVERE                                                        
         BR    RE                                                               
         DROP  R6,RB,RF                                                         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* PROGRAM/PRODUCT RECAP                                               *         
***********************************************************************         
                                                                                
PGMRCP   NTR1  BASE=*,LABEL=*                                                   
         OC    NPRDS,NPRDS         SKIP IF NO PRODUCTS                          
         BZ    PGMRCPX                                                          
         SR    RE,RE               BUILD BINSRCH PARAMS                         
         L     RF,AFSTBRD          FIND END OF BRAND TABLE                      
         CLI   TABPRD-TABD(RF),0   FOR START OF PROGRAM TABLE                   
         BE    *+12                                                             
         AH    RF,LROW                                                          
         B     *-12                                                             
         AHI   RF,15               LEAVE SOME SLACK AND ALIGN                   
         SRL   RF,3                                                             
         SLL   RF,3                                                             
         SR    R0,R0               # ENTRIES                                    
         LH    R1,NPRDS            ENTRY LENGTH= PRODUCT COUNT                  
         AHI   R1,1                PLUS UNA                                     
         SLL   R1,1                X 2 BYTE PER COUNTER                         
         AHI   R1,PPRKL+4          + KEY LENGTH + 4 BYTES FOR TOTAL             
         LHI   R2,PPRKL            KEY LENGTH                                   
         LHI   R3,2500             MAX                                          
         STM   RE,R3,BINPARS                                                    
         LA    R5,W                READ UNITS                                   
         USING SBUFFRD,R5                                                       
         XC    SBUFFK(SBUFFL),SBUFFK                                            
         MVC   SBDPT(L'SBDPT+L'SBSLN),L.GBDPT                                   
         GOTOR BU2RDH                                                           
         B     PGMRCP04                                                         
PGMRCP02 GOTOR BU2RSQ                                                           
PGMRCP04 BNZ   PGMRCP24                                                         
         CLC   SBDPT,L.GBDPT                                                    
         BNE   PGMRCP24                                                         
         CLC   SBSLN,L.GBSLN                                                    
         BNE   PGMRCP24                                                         
*                                  SET TABLE ENTRY                              
         CLI   SBRTYP,SBRTYPQ      ONLY SPOT TYPE RECORDS                       
         BNE   PGMRCP02                                                         
         L     R6,ADBUY            USE BUY REC AS WORK AREA                     
         USING PPRD,R6                                                          
         LA    R0,PPRD             CLEAR                                        
         L     R1,BINLREC          LENGTH OF ENTRY                              
         GOTOR CLEAR                                                            
         LH    RF,SBENV1           SET ENV DESC                                 
         BCTR  RF,0                                                             
         MH    RF,HWENV1LN                                                      
         L     RE,AENV1SET                                                      
         A     RF,ENVSATAB-ENVSETD(RE)                                          
         USING ENVTABD,RF                                                       
         MVC   PPRNET,ENVS1STA     NETWORK/STATION                              
         MVC   PPRPGM,ENVS1PGM     PROGRAM NAME                                 
         MVC   PPRPGMC,ENVS1PGC    PROGRAM CODE                                 
         DROP  RF                                                               
         LHI   RF,1                ELSE UNITS                                   
         ICM   R0,15,PPRTOT                                                     
         AR    R0,RF                                                            
         STCM  R0,15,PPRTOT                                                     
         CLI   SBUNLEN,0           BUMP UNA UNITS/SECONDS                       
         BE    PGMRCP06                                                         
         LHI   RF,1                ELSE UNITS                                   
         LH    RE,NPRDS            POINT TO UNA POS                             
         SLL   RE,1                                                             
         LA    RE,PPRCNTS(RE)                                                   
         AH    RF,0(RE)                                                         
         STH   RF,0(RE)                                                         
PGMRCP06 LA    R4,SBPRD1           SLOT 1                                       
         LHI   R3,SBMAXALC                                                      
PGMRCP08 CLI   0(R4),0             UNA SLOT - DONE                              
         BE    PGMRCP20                                                         
         CLI   1(R4),0             IF ALLOC SLEN = 0                            
         BNE   *+10                                                             
         MVC   1(1,R4),SBSLN       SET TO SLN FOR LINE                          
         CLI   0(R4),UNAPRD2       ALLOCATED TO UNA                             
         BNE   PGMRCP10                                                         
         LHI   RF,1                ELSE UNITS                                   
         LH    RE,NPRDS            POINT TO UNA POS                             
         SLL   RE,1                                                             
         LA    RE,PPRCNTS(RE)                                                   
         AH    RF,0(RE)                                                         
         STH   RF,0(RE)                                                         
         B     PGMRCP18            NEXT SLOT                                    
PGMRCP10 L     R2,AFSTBRD          FIND PRODUCT/LEN SEQ                         
         USING TABD,R2                                                          
         SR    RF,RF                                                            
PGMRCP12 CLC   TABPRD,0(R4)        TEST RIGHT PRODUCT                           
         BNE   PGMRCP14                                                         
         CLC   TABSLN,1(R4)        AND SLN                                      
         BE    PGMRCP16                                                         
         CLI   TABSLN,ALLSLN       OK IF SLN'S NOT SEPARATE                     
         BE    PGMRCP16                                                         
PGMRCP14 AHI   RF,1                BUMP PRODUCT/SLN COUNTER                     
         AH    R2,LROW             NEXT PRODUCT/SLN                             
         B     PGMRCP12                                                         
PGMRCP16 SLL   RF,1                2 BYTES PER PRODUCT                          
         LA    RF,PPRCNTS(RF)      POINT TO POS IN PPR TAB ENTRY                
         LH    RE,0(RF)                                                         
         AHI   RE,1                COUNT UNITS NOT SECONDS                      
         STH   RE,0(RF)                                                         
PGMRCP18 AHI   R4,2                NEXT SLOT                                    
         BCT   R3,PGMRCP08                                                      
                                                                                
PGMRCP20 GOTOR PGMSET              SET IN BSTAB                                 
         XC    PPRPGM,PPRPGM                                                    
         XC    PPRPGMC,PPRPGMC                                                  
         MVI   PPRPGM,FF           DO NET/TYP TOTALS                            
         GOTOR PGMSET              SET IN BSTAB                                 
         XC    PPRNET,PPRNET                                                    
         MVI   PPRNET,FF           DO TOTAL TOTALS                              
         GOTOR PGMSET              SET IN BSTAB                                 
         B     PGMRCP02                                                         
*                                  HAVE READ ALL UNITS                          
PGMRCP24 OC    BINNREC,BINNREC     TEST ANY SPOTS                               
         BZ    PGMRCPX                                                          
         MVI   RCSUBPRG,37         FOR HEADLINE ROUTINE                         
*                                  DO 22 PRODUCTS PER PAGE                      
         LH    R5,NPRDS            PRODUCT COUNT                                
         AHI   R5,1                PLUS UNA                                     
         SR    RF,RF                                                            
PGMRCP26 LR    R0,R5                                                            
         MVI   BYTE,YESQ                                                        
         CHI   R0,RCPPPG           MAX PER PAGE                                 
         BNH   *+12                                                             
         LHI   R0,RCPPPG                                                        
         MVI   BYTE,NOQ                                                         
         STC   R0,NPRDPRNT         NUMBER TO DO THIS TIME                       
         STC   RF,NPRDSKIP         NUMBER TO SKIP                               
                                                                                
         L     RF,APGMHD2          SET HEADLINES                                
         CLI   RPRGOPTN,YESQ       TEST PRG TYPE USED                           
         BE    PGMRCP28                                                         
         L     RE,APGMHD1                                                       
         MVC   L'P1*0+8(4,RE),SPACES                                            
         MVC   L'P1*1+8(4,RE),SPACES                                            
         MVC   L'P1*2+8(4,RE),SPACES                                            
                                                                                
PGMRCP28 LA    R1,30(RF)                                                        
         MVC   0(L'SPOTSL,R1),SPOTSL                                            
         L     R2,AFSTBRD                                                       
         USING TABD,R2                                                          
         CLI   NPRDSKIP,0          NUMBER OF PRODUCTS TO SKIP THIS TIME         
         BE    PGMRCP32                                                         
         SR    RF,RF                                                            
         IC    RF,NPRDSKIP                                                      
         AH    R2,LROW                                                          
         BCT   RF,*-4                                                           
PGMRCP32 SR    RF,RF                                                            
         IC    RF,NPRDPRNT         NUMBER OF PRODUCTS TO DO THIS TIME           
                                                                                
         L     R1,APGMHD1                                                       
         AHI   R1,35                                                            
         MVC   000(L'P1-35,R1),SPACES    CLEAR PRODUCT HEADS                    
         MVC   L'P1(L'P1-35,R1),SPACES                                          
         MVC   L'P1*2(L'P1-35,R1),SPACES                                        
PGMRCP34 SR    RE,RE                                                            
         IC    RE,TABPRD                                                        
         BCTR  RE,0                                                             
         MH    RE,PRDBUFLN                                                      
         A     RE,PRDBUFF                                                       
         AHI   RE,PTPRDA-PTBUFFD                                                
         MVC   DUB(3),0(RE)                                                     
         CLI   2(RE),SPACE         SHIFT AB- TO -AB                             
         BH    *+14                                                             
         MVC   DUB+1(2),0(RE)                                                   
         MVI   DUB,SPACE                                                        
         LA    RE,DUB                                                           
         MVC   L'P1+1(3,R1),0(RE)  NO- JUST SET PRODUCT CODE                    
         CLI   TABPRD,UNAPRD2      FOR UNA                                      
         BNE   PGMRCP38                                                         
         MVC   1(3,R1),=C'UN-'                                                  
         MVC   L'P1+1(3,R1),ALL3                                                
PGMRCP38 MVC   L'P1*2+1(3,R1),DASHES                                            
         AHI   R1,4                NEXT POSITION                                
         AH    R2,LROW                                                          
         BCT   RF,PGMRCP34                                                      
                                                                                
         MVI   FORCEHED,YESQ       TEST WHETHER FINAL SET                       
                                                                                
         L     R6,BINATAB                                                       
         L     R7,BINNREC                                                       
PGMRCP40 CLI   PPRNET,FF                                                        
         BNE   PGMRCP42                                                         
         MVC   PPRLNET(7),=C'*Total*'                                           
         MVI   SPACING,2                                                        
         B     PGMRCP44                                                         
PGMRCP42 MVC   WORK+2(3),PPRNET                                                 
         GOTOR MSUNPK,DMCB,(X'80',WORK),FULL,DUB                                
         MVC   PPRLNET,DUB                                                      
PGMRCP44 MVC   PPRLTYP,PPRTYP                                                   
         CLI   PPRTYP,SPACE                                                     
         BH    PGMRCP46                                                         
         CLI   RPRGOPTN,YESQ       TEST PRG TYPE USED                           
         BNE   PGMRCP46                                                         
         MVC   PPRLTYP(4),=C'None'                                              
PGMRCP46 CLI   PPRTYP,FF                                                        
         BNE   *+14                                                             
         MVC   PPRLTYP,ALL3                                                     
         MVI   SPACING,2                                                        
         MVC   PPRLPGM,PPRPGM                                                   
         CLI   PPRPGM,FF                                                        
         BNE   *+14                                                             
         MVC   PPRLPGM(7),=C'*Total*'                                           
         MVI   SPACING,2                                                        
         ICM   R1,15,PPRTOT                                                     
         BNZ   *+12                                                             
         MVI   PPRLTOT+4,SPACE     LEAVE FOR FILL CHARACTER                     
         B     PGMRCP50                                                         
PGMRCP48 EDIT  (R1),(6,PPRLTOT)                                                 
PGMRCP50 SR    RF,RF                                                            
         IC    RF,NPRDSKIP         PRODUCTS TO SKIP                             
         SLL   RF,1                2 BYTE PER PRODUCT                           
         LA    R3,PPRCNTS(RF)                                                   
         LA    R4,PPRLCNTS                                                      
         SR    R8,R8                                                            
         IC    R8,NPRDPRNT         NUMBER OF PRODUCTS TO DO                     
PGMRCP52 OC    0(2,R3),0(R3)                                                    
         BNZ   *+12                                                             
         MVI   3(R4),SPACE         LEAVE FOR FILL CHARACTER                     
         B     PGMRCP56                                                         
         EDIT  (B2,0(R3)),(4,0(R4)),ZERO=NOBLANK                                
PGMRCP56 AHI   R3,2                                                             
         AHI   R4,4                                                             
         BCT   R8,PGMRCP52                                                      
         GOTOR REPORT                                                           
         A     R6,BINLREC                                                       
         BCT   R7,PGMRCP40                                                      
                                                                                
         SR    R0,R0                                                            
         IC    R0,NPRDPRNT         NUMBER TO DO THIS TIME                       
         SR    RF,RF                                                            
         IC    RF,NPRDSKIP         NUMBER TO SKIP                               
         AR    RF,R0               BUMP NUMBER TO SKIP                          
         SR    R5,R0                                                            
         BP    PGMRCP26            TEST ANY LEFT                                
                                                                                
PGMRCPX  J     EXIT                                                             
         DROP  R2                                                               
                                                                                
PGMSET   NTR1  ,                                                                
         GOTOR BINSRCH,BINPARS,(1,PPRD)                                         
         OC    1(3,R1),1(R1)       TEST FULL                                    
         BNZ   *+6                                                              
         DC    H'0'                                                             
         CLI   0(R1),1             TEST NEW                                     
         BE    PGMSETX             YES - DONE                                   
         L     R7,0(R1)            NO- ADD TO EXISTING TOTALS                   
         ICM   RF,15,PPRTOT-PPRD(R7) DO TOTAL SEPARATELY                        
         ICM   RE,15,PPRTOT          BECAUSE 4 BYTES, NOT 2                     
         AR    RF,RE                                                            
         STCM  RF,15,PPRTOT-PPRD(R7)                                            
         LH    R5,NPRDS            FOR BCT                                      
         AHI   R5,1                PLUS UNA                                     
         AHI   R7,PPRCNTS-PPRD     EXISTING RECORD                              
         LA    R8,PPRCNTS          NEW COUNTS                                   
PGMSET02 LH    RF,0(R7)                                                         
         AH    RF,0(R8)                                                         
         STH   RF,0(R7)                                                         
         AHI   R7,L'PPRCNTS                                                     
         AHI   R8,2                                                             
         BCT   R5,PGMSET02                                                      
PGMSETX  J     EXIT                                                             
         DROP  R5,R6,RB                                                         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* FIRST FOR ESTIMATE                                                  *         
***********************************************************************         
                                                                                
ESTFST   NTR1  BASE=*,LABEL=*                                                   
         CLI   DPTFLT,0                                                         
         BNE   ESTFST02                                                         
         CLI   QPROG+58,SPACE      DAYPART FILT AT +58                          
         BNH   ESTFST02                                                         
         MVC   DPTFLT,QPROG+58                                                  
         MVI   DPTFLTG,0                                                        
         GOTOR GETDPT,DPTFLT       FIND DAYPART GROUP FOR FILTER                
         BNE   ESTFST02                                                         
         MVC   DPTFLTG,1(RF)                                                    
         NI    DPTFLTG,ZONE        CLEAR LOW NIBBLE                             
                                                                                
ESTFST02 L     RF,ADEST                                                         
         USING ESTHDR,RF                                                        
         MVC   DAILYSW,EDAILY      SAVE DAILY GOAL STATUS                       
         CLI   EOWSDAY,0           IF OUT OF WEEK START DAY PRESENT             
         BE    *+10                                                             
         MVC   SPOTPROF+8(1),EOWSDAY   ADJUST SPOTPROF                          
         DROP  RF                                                               
                                                                                
         GOTOR MEDDATE,DMCB,SPWORKD                                             
         GOTOR VPRDBLD,WORKD       BUILD PRODUCT LIST                           
         XC    ACTDEMS,ACTDEMS     CLEAR ACTIVE DEMO LIST                       
         MVI   ACTDEMSL,FF         BASE ALWAYS ACTIVE                           
         XC    NTARGETS,NTARGETS                                                
         XC    TARGETS(TARGETSL),TARGETS                                        
         LA    R0,DEMNMS                                                        
         GOTOR CLEAR,DEMNMSL                                                    
         NI    REQFLAG1,FF-(REQFMIXG+REQFMIXB+REQFTRGS)                         
         CLI   GDEMOPTN,YESQ       TEST OPTION TO FORCE TO RATINGS              
         BNE   ESTFST12                                                         
         L     RF,PRDBUFF          LOOP THRU PRODUCT LIST                       
         USING PTBUFFD,RF                                                       
         LHI   R0,CPLDMAXN         MAX PRODUCTS                                 
ESTFST04 CLI   PTBUFFD,PTBEOTQ     TEST END OF TABLE                            
         BE    ESTFST10                                                         
         LA    RE,PTDEMNO          ADJUST DEMOS                                 
         USING PTDEMNO,RE                                                       
         LHI   R1,PTDEMMAX                                                      
ESTFST06 OC    PTDEMNO,PTDEMNO                                                  
         BZ    ESTFST08                                                         
         CLI   PTDEMTYP,USERDEMO   NOT FOR USER DEMS                            
         BE    ESTFST08                                                         
         MVI   PTDEMTYP,PTDEMRQ    SET TO RATING                                
ESTFST08 AHI   RE,L'PTDEMNO        NEXT DEMO                                    
         BCT   R1,ESTFST06                                                      
ESTFST10 AH    RF,PRDBUFLN                                                      
         BCT   R0,ESTFST04                                                      
         DROP  RE                                                               
                                                                                
***********************************************************************         
* CREATE SPECIAL PRODUCT ENTRY FOR 'OTHER PIGGYBACKS'- PRE-ALLOCS     *         
***********************************************************************         
                                                                                
ESTFST12 L     RF,PRDBUFF                                                       
         LH    RE,PRDBUFLN                                                      
         MHI   RE,UGPIGPRD-1       USE A VERY HIGH ENTRY                        
         AR    RF,RE               USING 217 (=UNA) DOESNT WORK                 
         CLI   PTBUFFD,PTBEOTQ     TEST ALREADY USED                            
         BNE   ESTFST14            YES, DON'T ALLOW UNGOALED PIGS               
         MVI   PTPRPIGT,PTPRPIGQ                                                
         MVC   PTPRPCOD,=AL2(PTPRPCOQ)                                          
         MVC   PTNAME,=CL20'*Other Piggybacks*'                                 
         MVI   UNGPIG,UGPIGPRD                                                  
ESTFST14 L     RF,PRDBUFF          SET A(POL ENTRY)                             
         LH    RE,PRDBUFLN                                                      
         MHI   RE,CPLDMAXN-1                                                    
         AR    RF,RE               POINT TO POL ENTRY                           
         ST    RF,APOLPRD                                                       
         MVC   BASEDEM,PTDEMNO     SAVE POL (CORP) DEMO                         
         DROP  RF                                                               
         L     R6,PRDBUFF          LOOP TO SET MIX SWITCHES                     
         USING PTBUFFD,R6                                                       
         LHI   R0,UGPIGPRD         MAX PRODUCTS                                 
ESTFST16 CLI   PTBUFFD,PTBEOTQ                                                  
         BE    ESTFST18                                                         
         CLI   FCGLOPTN,YESQ       TEST 'FORCE' GOALS                           
         BNE   *+10                                                             
         MVC   PTDEMNO,BASEDEM     TO BE FOR CORP DEMO                          
         CLC   PTDEMNO,BASEDEM                                                  
         BE    ESTFST18                                                         
         OI    REQFLAG1,REQFMIXG   SET HAVE MIXED GOALS                         
         CLI   GOALOPT,GOALDOLS    IF BASIS NOT DOLLARS                         
         BE    ESTFST18                                                         
         OI    REQFLAG1,REQFMIXB   SET HAVE MIXED BASIS                         
ESTFST18 AH    R6,PRDBUFLN                                                      
         BCT   R0,ESTFST16                                                      
                                                                                
         L     RE,APALLST                                                       
         XC    0(L'PALLST,RE),0(RE)                                             
         XC    L'PALLST(L'PCLLST,RE),L'PALLST(RE)                               
         CLI   UNGPIG,0                                                         
         BE    ESTFST20                                                         
         SR    RF,RF                                                            
         IC    RF,UNGPIG           PRE-SET UNGOALED PIGGY PRODUCT               
         A     RF,APALLST                                                       
         MVI   0(RF),253           SET TO PRINT AT END                          
ESTFST20 L     R6,PRDBUFF                                                       
         LHI   R0,CPLDMAXN-1       MAX PRODUCTS                                 
ESTFST22 MVI   PTSTAT,0            CLEAR ALL STATUS BITS                        
         CLI   PTBUFFD,PTBEOTQ                                                  
         BE    ESTFST46                                                         
         L     RF,ADCLT            FIND CODE IN CLTHDR                          
         AHI   RF,CPLDATA-CLTHDR                                                
         LR    RE,RF                                                            
         CLC   PTPRDN,3(RF)                                                     
         BE    *+12                                                             
         AHI   RF,CPLDATAL                                                      
         B     *-14                                                             
         SR    RF,RE                                                            
         SRL   RF,2                                                             
         AHI   RF,1                POSITION OF CODE IN LIST                     
         SR    RE,RE               SET PRODUCT SEQUENCE CODE                    
         IC    RE,PTPRDN                                                        
         A     RE,APALLST                                                       
         STC   RF,0(RE)                                                         
         CLI   PTCLASS,SPACE       SET PRODUCT CLASS                            
         BNE   *+8                                                              
         MVI   PTCLASS,0                                                        
         MVC   L'PALLST(L'PTCLASS,RE),PTCLASS                                   
                                                                                
***********************************************************************         
* TEST FOR PIGGY-BACK PRODUCTS                                        *         
***********************************************************************         
                                                                                
         CLC   =C'PB=',PTPPNPBE    TEST NAME = 'PB=AA(A)-NNN,BB(B)-MMM'         
         BNE   ESTFST24                            PRD1-SHR1,PRD2-SHR2          
         MVC   X(80),SPACES                                                     
         MVC   X(L'PTPPNFOR),PTPPNFOR                                           
         XC    WORK,WORK                                                        
         GOTOR VSCANNER,DMCB,(C'C',X),WORK,C',=,-'                              
PIG      USING PTPPVALS,DUB                                                     
         CLI   WORK,0              TEST FIRST PRODUCT SET                       
         BE    ESTFST23                                                         
         CLI   WORK+11,0           TEST FIRST SHARE SET                         
         BE    ESTFST23                                                         
         MVC   PIG.PTPPSHR1,WORK+11                                             
         GOTOR FNDPRD,PIG.PTPPBRD1                                              
         BNE   ESTFST23                                                         
         MVC   WORK(32),WORK+32    SECOND PRODUCT/SHARE                         
         CLI   WORK,0              TEST SECOND PRODUCT SET                      
         BE    ESTFST23                                                         
         CLI   WORK+11,0           TEST SECOND SHARE SET                        
         BE    ESTFST23                                                         
         MVC   PIG.PTPPSHR2,WORK+11                                             
         GOTOR FNDPRD,PIG.PTPPBRD2                                              
         BNE   ESTFST23                                                         
         OI    PTSTAT,PTSPIGPQ     SET STATUS AND PRODUCT/SHARE VALUES          
         MVC   PTPPVALS,PIG.PTPPVALS                                            
         B     ESTFST24                                                         
         DROP  PIG                                                              
ESTFST23 OI    PTSTAT,PTSPIGEQ     SET PIGGY ERROR                              
                                                                                
***********************************************************************         
* SET TARGETS                                                         *         
***********************************************************************         
                                                                                
ESTFST24 LA    R5,PTTRGS           TARGET POSITION CODES                        
         LA    R4,TG1VAR           1ST TARGET VARIABLE                          
ESTFST26 CLI   0(R5),0                                                          
         BE    ESTFST44            **PATCH HERE TO NO-OP TARGETS**              
         SR    R2,R2                                                            
         IC    R2,0(R5)                                                         
         MHI   R2,L'PTDEMNO                                                     
         LA    R2,PTDEMNO-L'PTDEMNO(R2)                                         
         CLC   0(L'PTDEMNO,R2),BASEDEM                                          
         BNE   ESTFST28                                                         
         MVI   0(R5),0             CLEAR AS TARG                                
         B     ESTFST44                                                         
ESTFST28 LA    R3,TARGETS          FIND DEMO IN TARG LIST                       
         LHI   RF,MAXTARGS                                                      
ESTFST30 OC    0(L'PTDEMNO,R3),0(R3)                                            
         BZ    ESTFST32            SET NEW                                      
         CLC   0(L'PTDEMNO,R2),0(R3)                                            
         BE    ESTFST38            ALREADY HAVE                                 
         AHI   R3,L'TARGETS        NEXT TARG ENTRY                              
         BCT   RF,ESTFST30                                                      
         MVC   P1(20),=C'**Too many targets**'                                  
         MVC   P2(L'RQBYPSSL),RQBYPSSL                                          
         MVI   SKIPSPEC,YESQ                                                    
         J     ENDREQ                                                           
                                                                                
ESTFST32 MVC   0(L'PTDEMNO,R3),0(R2)                                            
         L     RF,APOLPRD          GET ITS POS IN POL DEMO LIST                 
         AHI   RF,PTDEMNO-PTBUFFD                                               
         LHI   R1,PTDEMMAX                                                      
ESTFST34 CLC   0(L'PTDEMNO,R3),0(RF)                                            
         BE    ESTFST36                                                         
         AHI   RF,L'PTDEMNO                                                     
         BCT   R1,ESTFST34                                                      
         MVC   P2(55),=C'**Demo missing from POL estimate header - prod*        
               uct XXX**'                                                       
         MVC   P2+50(L'PTPRDA),PTPRDA                                           
         MVC   P1(L'QAREA),QAREA                                                
         MVI   SKIPSPEC,YESQ                                                    
         J     ENDREQ                                                           
                                                                                
ESTFST36 LHI   RE,PTDEMMAX                                                      
         SR    R1,RE                                                            
         LPR   R1,R1                                                            
         STC   R1,3(R3)            SET POLP POS IN TARG LIST                    
         LR    RE,R3               SET REL TARG NO. IN ACTDEMS                  
         LA    RF,TARGETS-L'TARGETS                                             
         SR    RE,RF                                                            
         SRL   RE,2                                                             
         STC   RE,ACTDEMSL(R1)                                                  
         LH    RF,NTARGETS         COUNT OF TARGETS                             
         AHI   RF,1                                                             
         STH   RF,NTARGETS                                                      
         B     ESTFST40                                                         
                                                                                
ESTFST38 SR    RF,RF               ALREADY HAVE DEMO AS TARGET                  
         IC    RF,3(R3)                                                         
         SR    RE,RE                                                            
         IC    RE,ACTDEMSL(RF)     GET RELATIVE TARG NO.                        
                                                                                
ESTFST40 LTR   R5,R5               IF NOT DOING GOALED DEMO                     
         BZ    ESTFST46                                                         
         STC   RE,0(R5)            SET REL TARG NO. IN PTBUFF                   
ESTFST44 AHI   R4,L'TG1VAR         NEXT TARG VARIABLE                           
         AHI   R5,1                NEXT TARG                                    
         LA    RF,PTTRGS+NTGVARS   END OF TARGS                                 
         CR    R5,RF                                                            
         BL    ESTFST26                                                         
         CLC   PTDEMNO,BASEDEM     UNLESS GOALED DEMO IS CORP                   
         BE    ESTFST46                                                         
         LA    R2,PTDEMNO          SET IT IN TARG LIST ALSO                     
         SR    R5,R5                                                            
         B     ESTFST28                                                         
ESTFST46 AH    R6,PRDBUFLN         NEXT PRODUCT                                 
         BCT   R0,ESTFST22                                                      
                                                                                
         OC    NTARGETS,NTARGETS   TEST ANY TARGS PRESENT                       
         BZ    *+8                                                              
         OI    REQFLAG1,REQFTRGS                                                
         MVI   MEDEXTDM,1                                                       
         TM    REQFLAG1,REQFTRGS                                                
         BZ    *+8                                                              
         MVI   MEDEXTDM,PTDEMMAX                                                
                                                                                
         LA    R4,DEMNMS           SET DEMO NAMES                               
         USING DEMNAMD,R4                                                       
         L     R2,APOLPRD                                                       
         AHI   R2,PTDEMLST-PTBUFFD                                              
POL      USING PTDEMLST,R2                                                      
         LHI   R5,PTDEMMAX                                                      
ESTFST48 OC    POL.PTDEMNO,POL.PTDEMNO                                          
         BZ    ESTFST56                                                         
         MVC   DEMNDEMN,POL.PTDEMNO                                             
         GOTOR DEMOCON,DMCB,DEMNDEMN,(2,DEMNNAME),(C'S',ADBLOCK),      X        
               (SPOTPROF+9,SPUSRNMS)                                            
         MVC   DEMNNADP,SPACES     NAD DEMO PREFIX                              
         CLI   DEMNDEMN+1,USERDEMO USER DEMO?                                   
         BNE   ESTFST52                                                         
         CLI   DEMNNAME,SPACE      DID DEMOCON GIVE US A NAME?                  
         BH    ESTFST52                                                         
         SR    RF,RF               NO - GET NAME FROM ESTIMATE HEADER           
         IC    RF,DEMNDEMN+L'DEMNDEMN-1                                         
         MHI   RF,L'EUSRNML                                                     
         A     RF,ADEST                                                         
         AHI   RF,EUSRNML-L'EUSRNML-ESTHDR                                      
         MVC   DEMNNAME,0(RF)                                                   
ESTFST52 MVI   DEMNRVSA,DEMNRATQ   USE BYTE AFTER NAME AS RATING                
         CLI   DEMNDEMN+1,RATINGQ  VS AUDIENCE INDICATOR                        
         BE    ESTFST54                                                         
         CLI   DEMNNAME,C'R'       THIS TEST MOSTLY FOR UDEMS                   
         BE    ESTFST54                                                         
         MVI   DEMNRVSA,DEMNAUDQ                                                
ESTFST54 AHI   R2,L'PTDEMNO                                                     
         AHI   R4,DEMNLENQ                                                      
         BCT   R5,ESTFST48                                                      
         DROP  POL,R4                                                           
                                                                                
ESTFST56 CLI   DAILYSW,YESQ        IF DOING DAILY GOALS                         
         BNE   ESTFST60                                                         
         L     R2,AWEEKLST         BUILD LIST OF DAYS                           
         SR    R4,R4                                                            
         MVC   WORK(L'QSTART),QSTART                                            
         LHI   R0,MAXWEEKS                                                      
ESTFST58 LR    RF,R4                                                            
         CLC   WORK(L'QSTART),QEND PAST QEND?                                   
         BH    ESTFST70                                                         
         GOTOR DATCON,DMCB,WORK,(2,0(R2))                                       
         MVC   2(2,R2),0(R2)       END DATE OF PAIR                             
         GOTOR ADDAY,DMCB,WORK,WORK,1                                           
         AHI   R2,L'MEDQ1WKS       NEXT DATE SLOT                               
         AHI   R4,1                                                             
         BCT   R0,ESTFST58                                                      
         B     ESTFST68                                                         
ESTFST60 L     RF,AWEEKLST         ELSE MAKE COPY OF MEDWEEKS                   
         MVC   0(15*L'MEDQ1WKS,RF),MEDQ1WKS                                     
         CLI   MEDQ2WKS,0          ARE ANY WEEKS IN 2ND QUARTER                 
         BE    ESTFST62            NO                                           
*                                  YES, ADD THEM AT END OF QTR1                 
         LHI   R0,15               BECAUSE WEEK PROCESSING THROUGHOUT           
         CLI   0(RF),0             PROGRAM DEPENDS ON A                         
         BE    *+12                CONTINUOUS LIST                              
         AHI   RF,L'MEDQ1WKS                                                    
         BCT   R0,*-12                                                          
         MVC   0(15*L'MEDQ1WKS,RF),MEDQ2WKS                                     
                                                                                
ESTFST62 MVI   15*L'MEDQ1WKS(RF),0                                              
         L     RE,AWEEKLST         COUNT WEEKS                                  
         SR    RF,RF                                                            
ESTFST64 CLI   0(RE),0                                                          
         BE    *+16                                                             
         AHI   RF,1                                                             
         AHI   RE,L'MEDQ1WKS                                                    
         B     ESTFST64                                                         
         CHI   RF,MAXWEEKS                                                      
         BNH   ESTFST70                                                         
ESTFST68 MVC   P1(27),=C'**Request period too long**'                           
         J     ENDREQ                                                           
ESTFST70 STH   RF,NWKS                                                          
         AHI   RF,1                                                             
         STH   RF,NWKSP1                                                        
         MVC   ASUPROW,ABRDTAB                                                  
*                                  SET REALLOC START DATE                       
         MVC   REALLSDT,FFS        NO REALLOCATION                              
         CLI   REALLOC,NOQ                                                      
         BE    ESTFST72                                                         
         XC    REALLSDT,REALLSDT   REALLOCATE ALL                               
         CLI   REALLOC,YESQ                                                     
         BE    ESTFST72                                                         
         MVC   BYTE,REALLOC        REALLOCATE STARTING WITH WEEK N              
         NI    BYTE,DIGIT                                                       
         SR    RF,RF                                                            
         IC    RF,BYTE                                                          
         CLI   REALLOC,ZONE                                                     
         BNL   *+8                                                              
         AHI   RF,9                                                             
         BCTR  RF,0                                                             
         MHI   RF,L'MEDQ1WKS                                                    
         A     RF,AWEEKLST                                                      
         MVC   REALLSDT,0(RF)                                                   
ESTFST72 GOTOR BU1INI                                                           
                                                                                
         L     R2,ABUFF2                                                        
         USING BUFFD,R2                                                         
         LH    RE,NTARGETS         ON NUMBER OF TARGETS                         
         SLL   RE,2                4 BYTES PER TARG                             
         AHI   RE,SBFIXEND-SBDATA                                               
         STH   RE,BUFFLCOM                                                      
         DROP  R2                                                               
                                                                                
         GOTOR BU2INI                                                           
                                                                                
ESTFSTX  J     EXIT                                                             
         DROP  R6                                                               
         EJECT                                                                  
***********************************************************************         
* LOOK-UP PIGGY-BACK PRODUCT CODE IN PRODUCT BUFFER                   *         
***********************************************************************         
                                                                                
FNDPRD   ST    RE,SAVERE           SAVE RE (USED FOR BCT LOOP)                  
         L     RF,PRDBUFF          SEARCH PRODUCT TABLE                         
         LHI   RE,UGPIGPRD         MAX PRODUCTS                                 
         USING PTBUFFD,RF                                                       
FNDPRD02 CLC   PTPRDA,WORK+12                                                   
         BNE   FNDPRD04                                                         
         MVC   0(L'PTPRDN,R1),PTPRDN                                            
         L     RE,SAVERE                                                        
         CR    RE,RE               SET CC=EQUAL IF FOUND                        
         BR    RE                                                               
FNDPRD04 AH    RF,PRDBUFLN                                                      
         BCT   RE,FNDPRD02                                                      
         L     RE,SAVERE                                                        
         LTR   RE,RE               SET CC=NOT EQUAL IF NOT FOUND                
         BR    RE                                                               
         DROP  RB,RF                                                            
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* FIRST FOR CLIENT                                                    *         
***********************************************************************         
                                                                                
CLTFST   NTR1  BASE=*,LABEL=*                                                   
         XC    PROGPROA(L'PROGPROA+L'PROGPROB),PROGPROA                         
         XC    WORK,WORK                                                        
         MVI   WORK,C'S'-SPACE                                                  
         MVC   WORK+1(2),QPROG     SET TO READ K4, K5 OR KL PROFILES            
         MVI   WORK+3,C'A'                                                      
         MVC   WORK+4(2),AGY                                                    
         MVC   WORK+6(1),MED                                                    
         MVC   WORK+7(3),CLIENT                                                 
         L     RF,ADCLT                                                         
         AHI   RF,COFFICE-CLTHDR                                                
         MVI   WORK+10,ASTERISK                                                 
         MVC   WORK+11(1),0(RF)                                                 
         MVC   X(16),WORK          SAVE PROFILE KEY                             
                                                                                
         GOTOR GETPROF,DMCB,WORK,PROGPROA,DATAMGR                               
         OC    PROGPROA,PROGPROA   TEST FOUND KXA                               
         BNZ   CLTFST02                                                         
         CLC   QPROG,QPROGK4L      IF RUNNING K4                                
         BE    CLTFST02            DON'T LOOK FOR K5A                           
         MVC   WORK+1(2),QPROGK4L  NO - TRY FOR K4A                             
         GOTOR (RF),(R1)                                                        
                                                                                
CLTFST02 MVC   WORK(16),X          READ SPK4B PROFILE                           
         MVC   WORK+1(2),QPROG     SET TO READ K4, K5 OR KL                     
         MVI   WORK+3,C'B'                                                      
         GOTOR (RF),(R1),,PROGPROB                                              
         OC    PROGPROB,PROGPROB   ELSE TEST FOUND KXB                          
         BNZ   CLTFST04                                                         
         CLC   QPROG,QPROGK4L      IF RUNNING K4                                
         BE    CLTFST04            DON'T LOOK FOR K5B                           
         MVC   WORK+1(2),QPROGK4L  NO - TRY FOR K4B                             
         GOTOR (RF),(R1)                                                        
                                                                                
CLTFST04 NI    REQFLAG2,FF-(REQFOSTA) ONE STATION REALLOCATION OPTION           
         CLI   OSTAOPTN,YESQ       IF OPTION SET TO YES                         
         BNE   CLTFST06                                                         
         OI    REQFLAG2,REQFOSTA                                                
         CLI   SVQSTA,SPACE        AND WAS SINGLE STATION REQ                   
         BNH   CLTFST06            RESET QSTA TO ALL                            
         MVC   QSTA,ALL            (IT WAS SAVED IN SVQSTA)                     
                                                                                
CLTFST06 CLI   QSTA,SPACE                                                       
         BH    *+10                                                             
         MVC   QSTA(4),ALL                                                      
                                                                                
         MVI   FCRDBUYS,YESQ                                                    
         L     RF,ADBLOCK          SET A FEW DBLOCK THINGS                      
         MVC   DBFILE-DBLOCK(L'DBFILE,RF),=C'TP '                               
         MVC   DBSELMED-DBLOCK(L'DBSELMED,RF),QMED                              
         NI    REQFLAG2,FF-(REQFSSLN+REQFSDPT)                                  
         MVC   GOALOPT,ALOCOPTN                                                 
         MVC   RSWKOPT,GOALOPTN                                                 
         MVC   ZERWKOPT,ZEROOPTN                                                
         CLI   QOPT6,SPACE         QOPT6 = ZERO WEEK OPTION OVERRIDE            
         BE    *+10                                                             
         MVC   ZERWKOPT,QOPT6                                                   
         CLI   DSEPOPTN,YESQ                                                    
         BNE   *+8                                                              
         OI    REQFLAG2,REQFSDPT                                                
         CLI   DSECOPTN,YESQ                                                    
         BNE   *+8                                                              
         OI    REQFLAG2,REQFSSLN                                                
         MVC   INTRVLS(INTRVLSL),BTVLOPTN INTERVAL CONTROLS                     
*                                  ADJUST TO MAKE SENSE                         
         CLI   PINTPCT,0           PCTS FROM 0 TO 100                           
         BNE   *+8                                                              
         MVI   PINTPCT,100                                                      
         CLI   CINTPCT,0                                                        
         BNE   *+8                                                              
         MVI   CINTPCT,100                                                      
         CLI   PINTRVL,0           IF INTERVLS ARE 0 PCTS SHOULD BE 0           
         BNE   *+8                                                              
         MVI   PINTPCT,0                                                        
         CLI   CINTRVL,0                                                        
         BNE   *+8                                                              
         MVI   CINTPCT,0                                                        
         CLI   PINTRVL,1           IF PROD PROGRAM EXCL                         
         BNE   *+16                                                             
         CLI   PINTPCT,100         PCT MUST BE AT LEAST 100                     
         BNL   *+8                                                              
         MVI   PINTPCT,100                                                      
         CLI   CINTRVL,1           IF CLASS PROGRAM EXCL                        
         BNE   *+16                                                             
         CLI   CINTPCT,100         PCT MUST BE AT LEAST 100                     
         BNL   *+8                                                              
         MVI   CINTPCT,100                                                      
         MVC   OBJWGTS(OBJWGTSL),OBJ1WGHT WEIGHTS FOR OBJECTIVES                
         MVC   RQMED,QMED          SAVE REQUESTED MEDIA                         
         MVC   BRQAM,BAGYMD        SAVE EXTRACTED AGENCY/MEDIA                  
                                                                                
         CLI   QMED,COMLETQ                                                     
         BNE   CLTFST16                                                         
         MVC   RQMED,QOPT5                                                      
         NI    BRQAM,ZONE                                                       
         MVI   BYTE,X'01'                                                       
         CLI   RQMED,NETLETQ                                                    
         BNE   *+8                                                              
         MVI   BYTE,NETMEDQ                                                     
         OC    BRQAM,BYTE                                                       
                                                                                
CLTFST16 MVC   REALLOC,QOPT1                                                    
         MVC   SPLTOPT,QOPT7       SPLIT 30 OPTION                              
         CLI   REALLOC,SPACE                                                    
         BNE   *+8                                                              
         MVI   REALLOC,NOQ                                                      
         CLI   QOPT3,NOQ                                                        
         BE    *+8                                                              
         MVI   QOPT3,YESQ          EXCESS OPT DEFAULTS TO YES                   
         MVC   EXCSOPT,QOPT3                                                    
         MVC   NTPSW,QOPT2         QOPT2 FOR NTP OPT AS WELL AS GOAL            
         CLI   NTPSW,NTPSNTPO      NTP ONLY                                     
         BE    CLTFST18                                                         
         CLI   NTPSW,NTPSCASH      CASH ONLY                                    
         BE    CLTFST18                                                         
         MVI   NTPSW,NTPSBOTH      BOTH                                         
         CLI   QOPT2,SPACE                                                      
         BE    CLTFST18                                                         
         MVC   GOALOPT,QOPT2       OVERRIDE FOR GOALOPT                         
                                                                                
CLTFST18 MVC   TRGBASE,GOALOPT     SET TARGET VALUE BASIS                       
         TM    REQFLAG1,REQFMIXB                                                
         BZ    *+8                                                              
         MVI   TRGBASE,GOALDOLS    MUST BE DOLLARS IF MIXED GOALS               
                                                                                
***********************************************************************         
* NOTE - FORCE CPM TARGET MAXIMIZATION NOT VALUE PER BASE DEMO POINT  *         
***********************************************************************         
                                                                                
         MVI   TRGBASE,GOALDOLS    BASE ALWAYS DOLLARS                          
         LA    RE,OBJWGTS          SET REQ OVERRIDES OF WGTS                    
         LA    RF,QBOOK1           WGTS AT QBOOK1                               
         LA    R1,VARWGTS                                                       
         LHI   R0,VARWGTSN                                                      
CLTFST20 CLI   0(RF),SPACE                                                      
         BNH   CLTFST22                                                         
         MVC   0(1,RE),0(RF)                                                    
         NI    0(RE),DIGIT         STRIP ZONE                                   
         CLI   0(RF),C'A'          A = 10                                       
         BNE   *+8                                                              
         MVI   0(RE),10                                                         
CLTFST22 XC    0(L'VARWGTS,R1),0(R1)                                            
         MVC   L'VARWGTS-L'OBJWGTS(L'OBJWGTS,R1),0(RE)                          
         AHI   R1,L'VARWGTS                                                     
         AHI   RE,L'OBJWGTS        NEXT WGT                                     
         AHI   RF,1                                                             
         BCT   R0,CLTFST20                                                      
         OC    OBJWGTS(OBJWGTSL),OBJWGTS TEST ANY WEIGHTS                       
         BNZ   CLTFST28                                                         
         MVC   P1(17),=C'**No SKxA profile'                                     
         MVC   P2(L'QAREA),QAREA                                                
         J     ENDREQ                                                           
                                                                                
***********************************************************************         
* ADJUST ENV VARIABLE WEIGHTS TO REDUCE THEIR IMPACT. FACTOR EACH     *         
* WEIGHT DOWN SO THE SUM OF THE WEIGHTS EQUALS THE LARGEST WEIGHT     *         
* GIVEN.  THIS IS DONE BECAUSE PEOPLE TEND TO OVERSTATE THESE WEIGHTS *         
* AND THESE VARIABLES ARE LESS VISIBLE.                               *         
***********************************************************************         
                                                                                
CLTFST28 LA    R2,ENV1VAR          ENV VARIABLES ARE 3                          
         LHI   R3,ENVNVAR          THRU 5                                       
         SR    RF,RF               FOR SUM                                      
         SR    R4,R4               FOR LARGEST                                  
CLTFST30 A     RF,0(R2)            SUM                                          
         C     R4,0(R2)            TEST VS LARGEST                              
         BNL   *+8                                                              
         L     R4,0(R2)                                                         
         AHI   R2,L'ENV1VAR                                                     
         BCT   R3,CLTFST30                                                      
                                                                                
         LA    R2,ENV1VAR                                                       
         LHI   R3,ENVNVAR                                                       
CLTFST32 ICM   R1,15,0(R2)         CURRENT WEIGHT                               
         BZ    CLTFST34                                                         
         MR    R0,R4               X LARGEST                                    
         GOTOR DIVIDE              / SUM                                        
         LTR   R1,R1               DON'T REDUCE TO ZERO                         
         BP    *+8                                                              
         LHI   R1,1                                                             
         ST    R1,0(R2)            = NEW WEIGHT                                 
CLTFST34 AHI   R2,L'ENV1VAR                                                     
         BCT   R3,CLTFST32                                                      
                                                                                
***********************************************************************         
* SET ROUNDING MULTIPLIER FOR CPP/M'S                                 *         
* NOTE- DIFFERENT FOR NETWORK VS. SPOT AND RATING VS. AUDIENCES       *         
* BUT DIFFERENCE IS STRICTLY OBSERVED ONLY ON USER REPORTS            *         
***********************************************************************         
                                                                                
         LA    RE,FW10             SPOT DOLLARS ARE IN CENTS                    
         LA    RF,FW10                                                          
         CLI   RQMED,NETLETQ                                                    
         BNE   *+12                                                             
         LA    RE,FW100            NETWORK IN DOLLARS                           
         LA    RF,FW1000                                                        
         MVC   CPMROUND,0(RE)                                                   
         MVC   CPPROUND,0(RF)                                                   
                                                                                
***********************************************************************         
* MOVE ALL ENV ACONS AND VARS TO ENV SET AREAS                        *         
***********************************************************************         
                                                                                
         LA    RE,ENV1VAR                                                       
         LA    R1,AENV1SET                                                      
         LHI   R0,NENVS                                                         
CLTFST36 L     RF,0(R1)                                                         
         MVC   ENVSVAR-ENVSETD(,RF),0(RE) VARIABLES                             
         AHI   RE,L'ENV1VAR        NEXT VAR                                     
         AHI   R1,L'AENV1SET       NEXT ENV SET                                 
         BCT   R0,CLTFST36                                                      
                                                                                
         XC    DPSLFLT,DPSLFLT     SET DAYPART/SLN FILTERS                      
         MVI   DPTFLTG,0                                                        
         CLI   QPROG+59,SPACE      SLN FILT AT +59(2)                           
         BNH   CLTFST46                                                         
         CLI   QPROG+59,ZONE                                                    
         BL    CLTFST46                                                         
CLTFST42 MVC   HALF,QPROG+59       SLN(2)                                       
         OC    HALF,ZONES                                                       
         PACK  DUB,HALF                                                         
         CVB   R0,DUB                                                           
         STC   R0,SLNFLT                                                        
         B     CLTFST46                                                         
CLTFST44 MVC   P2(21),=C'Invalid length filter'                                 
         MVC   P1(L'QAREA),QAREA                                                
         J     ENDREQ                                                           
CLTFST46 CLI   SPLTOPT,YESQ        IF SPLTOPT                                   
         BE    *+12                                                             
         MVI   SPLTOPT,0                                                        
         B     CLTFSTX                                                          
         CLI   SLNFLT,0            IF LENGTH FILTER NOT GIVEN                   
         BNE   *+8                                                              
         MVI   SLNFLT,SECS15       ASSUME 15                                    
         CLI   SLNFLT,SECS15       LEN MUST BE 15 OR 30                         
         BE    CLTFST52                                                         
         CLI   SLNFLT,SECS30                                                    
         BNE   CLTFST44                                                         
CLTFST52 MVC   SPLTOPT,SLNFLT      SET SPLTOPT = FILTER LENGTH                  
         CLI   SPLTOPT,SECS15      ON 15 RUN FORCE TO ALLOCATE                  
         BNE   CLTFSTX             EXCESS (SOME BUG MAY CAUSE                   
         MVI   EXCSOPT,YESQ        PARTIAL ALLOCATION)                          
CLTFSTX  J     EXIT                                                             
         DROP  RB                                                               
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* CHECK ALL ESTIMATES OPEN                                            *         
***********************************************************************         
                                                                                
CHKEST   NTR1  BASE=*,LABEL=*                                                   
         NI    REQFLAG1,FF-(REQFESTE)                                           
         CLC   =C'NO',QEST                                                      
         BE    CHKEST06                                                         
         CLC   ALL3,QEST                                                        
         BE    CHKESTX                                                          
         CLI   QESTEND,SPACE                                                    
         BE    CHKESTX                                                          
                                                                                
***********************************************************************         
* FOR RANGE OF ESTIMATES FIRST BUILD LIST OF POL ESTIMATES            *         
***********************************************************************         
                                                                                
         XC    ESTLST,ESTLST       CLEAR ESTIMATE LIST                          
         LA    R8,KEY                                                           
         USING ESTHDR,R8                                                        
         L     RF,ADCLT            COPY CLIENT KEY                              
         MVC   EKEY,0(RF)                                                       
         MVC   EKEYPRD,=C'POL'                                                  
         OC    QEST(L'QEST+L'QESTEND),ZONES                                     
         PACK  DUB,QEST                                                         
         CVB   R0,DUB                                                           
         STC   R0,EKEYEST          START EST                                    
         PACK  DUB,QESTEND                                                      
         CVB   R0,DUB                                                           
         STC   R0,DUB              END EST                                      
         GOTOR HIGH                                                             
         B     CHKEST04                                                         
CHKEST02 GOTOR SEQ                                                              
CHKEST04 LA    R8,KEY                                                           
         CLC   EKEY(EKEYEST-EKEY),KEYSAVE                                       
         BNE   CHKEST06                                                         
         CLC   EKEYEST,DUB                                                      
         BH    CHKEST06                                                         
         GOTOR GETEST                                                           
         L     R8,ADEST                                                         
         CLC   QSTART,EEND         TEST EST WITHIN REQUEST PERIOD               
         BH    CHKEST02                                                         
         CLC   QEND,ESTART                                                      
         BL    CHKEST02                                                         
         SR    RF,RF                                                            
         IC    RF,EKEYEST          ADD ESTIMATE NUMBER TO LIST                  
         LA    RF,ESTLST-L'EKEYEST(RF)                                          
         MVC   0(L'EKEYEST,RF),EKEYEST                                          
         B     CHKEST02                                                         
                                                                                
CHKEST06 L     R2,AFSTBRD                                                       
         USING TABD,R2                                                          
         LH    R0,NPRDS                                                         
CHKEST08 SR    R3,R3                                                            
         IC    R3,TABPRD                                                        
         BCTR  R3,0                                                             
         MH    R3,PRDBUFLN                                                      
         A     R3,PRDBUFF                                                       
         USING PTBUFFD,R3                                                       
         CLI   PTPRDA,PTPRPIGQ     TEST A DUMMY PIGGY PRODUCT                   
         BNE   CHKEST10            NO, OK                                       
         SR    R1,R1                                                            
         IC    R1,PTPPBRD1         1ST BRAND                                    
         BCTR  R1,0                                                             
         MH    R1,PRDBUFLN                                                      
         A     R1,PRDBUFF                                                       
         GOTOR CHKPRD                                                           
         SR    R1,R1                                                            
         IC    R1,PTPPBRD2         2ND BRAND                                    
         BCTR  R1,0                                                             
         MH    R1,PRDBUFLN                                                      
         A     R1,PRDBUFF                                                       
         GOTOR CHKPRD                                                           
         B     CHKEST12                                                         
CHKEST10 GOTOR CHKPRD,PTBUFFD                                                   
CHKEST12 AH    R2,LROW             NEXT PRODUCT                                 
         BCT   R0,CHKEST08                                                      
CHKESTX  TM    REQFLAG1,REQFESTE   SET CC=NOT EQUAL ON ERROR                    
         J     EXIT                                                             
         DROP  R2,R3,R8                                                         
         EJECT                                                                  
***********************************************************************         
* DO ONE PRODUCT                                                      *         
***********************************************************************         
                                                                                
         USING PTBUFFD,R1                                                       
CHKPRD   NTR1  ,                   RF POINT TO TABLE ENTRY                      
CKE      USING EKEY,KEY                                                         
         L     RF,ADCLT                                                         
         XC    CKE.EKEY,CKE.EKEY                                                
         MVC   CKE.EKEY(EKEYPRD-EKEY),0(RF)                                     
         MVC   CKE.EKEYPRD,PTPRDA                                               
         LA    R1,ESTLST           TRY ALL POL ESTIMATES                        
         LHI   R0,L'ESTLST                                                      
CHKPRD02 CLI   0(R1),0             TEST UNUSED ENTRY                            
         BE    CHKPRD04                                                         
         MVC   CKE.EKEYEST,0(R1)   READ FOR ESTIMATE                            
         GOTOR HIGH                                                             
         CLC   CKE.EKEY,KEYSAVE                                                 
         BE    CHKPRD04                                                         
         MVC   P1(57),=C'**Est NNN for Prd XXX not on file- Market NNNN*        
                bypassed**'                                                     
         SR    RE,RE                                                            
         IC    RE,KEYSAVE+(EKEYEST-EKEY)                                        
         CVD   RE,DUB                                                           
         OI    DUB+L'DUB-1,DIGIT                                                
         UNPK  P1+6(3),DUB                                                      
         MVC   P1+18(L'EKEYPRD),KEYSAVE+(EKEYPRD-EKEY)                          
         MVC   P1+42(4),MKT                                                     
         GOTOR REPORT                                                           
         OI    REQFLAG1,REQFESTE   SET ERROR                                    
CHKPRD04 AHI   R1,L'EKEYEST        NEXT EST                                     
         BCT   R0,CHKPRD02                                                      
CHKPRDX  J     EXIT                                                             
         DROP  R1,RB,CKE                                                        
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* CALC PRODUCT/CLASS SLOTS                                            *         
***********************************************************************         
                                                                                
SETSLT   NTR1  BASE=*,LABEL=*                                                   
         L     R4,AENV1SET                                                      
         L     R4,ENVSATAB-ENVSETD(R4)                                          
         USING ENVTABD,R4                                                       
SETSLT02 CLI   ENVS1KEY,ENVSEOTQ                                                
         BE    SETSLTX                                                          
         GOTOR MILMIN,ENVS1STR                                                  
         STCM  R1,3,DUB+0                                                       
         GOTOR MILMIN,ENVS1END                                                  
         STCM  R1,3,DUB+2                                                       
         SR    R0,R0               COUNT NO. OF DAYS IN ROTATOR                 
         SR    R1,R1                                                            
         IC    R1,ENVS1DAY                                                      
         SLL   R1,32-DAYWEEK                                                    
         LA    RF,DAYWEEK                                                       
         SR    RE,RE                                                            
SETSLT04 SLDL  R0,1                                                             
         LTR   R0,R0                                                            
         BZ    *+10                                                             
         AHI   RE,1                                                             
         SR    R0,R0                                                            
         BCT   RF,SETSLT04                                                      
SETSLT06 STC   RE,DUB+4            NO. OF DAYS                                  
         XC    ENVS1SLP,ENVS1SLP                                                
         CLI   PINTPCT,0           NO BRAND CHECKING                            
         BE    SETSLT08                                                         
         GOTOR GETSLT,PINTVALS     PRODUCT INTERVAL AND PCT                     
         STCM  R1,3,ENVS1SLP                                                    
SETSLT08 XC    ENVS1SLC,ENVS1SLC                                                
         CLI   CINTPCT,0           NO CLASS TIME CHECKING                       
         BE    SETSLT10                                                         
         MVC   ENVS1SLC,ENVS1SLP                                                
         CLC   CINTVALS,PINTVALS                                                
         BE    SETSLT10                                                         
         GOTOR GETSLT,CINTVALS     INTERVAL AND PCT 2                           
         STCM  R1,3,ENVS1SLC                                                    
SETSLT10 AHI   R4,ENVS1LEN                                                      
         B     SETSLT02                                                         
SETSLTX  J     EXIT                                                             
         EJECT                                                                  
GETSLT   MVC   HALF,0(R1)                                                       
         LHI   RF,1                                                             
         CLI   HALF,1              ONE MINUTE                                   
         BE    GETSLT04            CONVENTION FOR PROGRAM EXCL                  
         CLC   DUB(2),DUB+2        CHECK START VS END                           
         BNH   *+16                                                             
         LH    R0,DUB+2            IF HIGH TIMES SPAN 6A                        
         AHI   R0,MINHOUR*HOURDAY  ADJUST END TIME +24 HOURS                    
         STH   R0,DUB+2                                                         
         LH    R3,DUB                                                           
         SR    R0,R0                                                            
         IC    R0,HALF                                                          
GETSLT02 AR    R3,R0                                                            
         CH    R3,DUB+2                                                         
         BNL   GETSLT04                                                         
         AHI   RF,1                                                             
         B     GETSLT02                                                         
GETSLT04 LR    R1,RF                                                            
         SR    RF,RF                                                            
         IC    RF,DUB+4            X NO. OF DAYS IN ROTATOR                     
         MR    R0,RF                                                            
         SR    RF,RF               X PCT                                        
         IC    RF,HALF+1                                                        
         MR    R0,RF                                                            
         SLDA  R0,1                                                             
         D     R0,FW10             LEAVE UNITS AS N.N                           
         LTR   R1,R1                                                            
         BNP   *+8                                                              
         AHI   R1,1                                                             
         SRA   R1,1                                                             
GETSLTX  BR    RE                                                               
                                                                                
MILMIN   SR    R0,R0               CONVERT TIME TO MILITARY FORMAT              
         ICM   R0,3,0(R1)                                                       
         LR    R1,R0                                                            
         BZR   RE                  LEAVE ZERO RESULT                            
         SR    R0,R0                                                            
         D     R0,FW100                                                         
         MHI   R1,MINHOUR                                                       
         AR    R1,R0                                                            
         BR    RE                                                               
         DROP  R4,RB                                                            
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* PROCESS BUY                                                         *         
***********************************************************************         
                                                                                
PRCBUY   NTR1  BASE=*,LABEL=*                                                   
         L     R2,ADBUY                                                         
         USING BUYREC,R2                                                        
         USING MEDBLOCK,R8                                                      
         CLC   QPROG,QPROGKLL      IF KL PROGRAM                                
         BNE   PRCBUY02                                                         
         MVC   BYTE,BUYKAM         KEEP ONLY NET BUYS                           
         NI    BYTE,DIGIT                                                       
         CLI   BYTE,NETMEDQ                                                     
         BNE   PRCBUYX                                                          
*                                  NTP(TRADE) VS CASH                           
PRCBUY02 CLI   QOPT2,NTPSNTPO      TEST NTP ALLOCATION                          
         BNE   PRCBUY08                                                         
         TM    BDCIND2,BDCCONVQ    THIS MEANS BDCIND IS A CHAR                  
         BZ    PRCBUY04                                                         
         CLI   BDCIND,BDCNTP       ALLOW ONLY NTP SPOTS                         
         BNE   PRCBUYX                                                          
         B     PRCBUY06                                                         
PRCBUY04 TM    BDCIND,OLDNTO       OLD NTO TEST                                 
         BNZ   PRCBUYX             NO, REJECT                                   
PRCBUY06 OI    REQFLAG1,REQFCHDR   SET NEED CHILD REPORT                        
         B     PRCBUY14                                                         
                                                                                
PRCBUY08 CLI   QOPT2,NTPSCASH      TEST CASH ONLY ALLOCATION                    
         BNE   PRCBUY14            NO, OK                                       
         TM    BDCIND2,BDCCONVQ    THIS MEANS BDCIND IS A CHAR                  
         BZ    PRCBUY10                                                         
         CLI   BDCIND,BDCNTP       SKIP NTP SPOTS                               
         BE    PRCBUYX                                                          
         B     PRCBUY14                                                         
PRCBUY10 TM    BDCIND,OLDNTO       OLD NTP TEST                                 
         BZ    PRCBUYX             YES, REJECT                                  
                                                                                
PRCBUY14 CLI   DPTFLT,0            TEST DAYPART FILTER                          
         BE    PRCBUY20                                                         
         CLC   BDDAYPT,DPTFLT      DOES BUY DAYPART MATCH                       
         BE    PRCBUY20            YES, ACCEPT                                  
         CLI   DGRPOPTN,YESQ       ARE WE DOING DAYPART GROUPS                  
         BNE   PRCBUYX                                                          
         MVI   BYTE,0                                                           
         GOTOR GETDPT,BDDAYPT      YES - FILTER ON GROUP                        
         BNE   *+14                                                             
         MVC   BYTE,1(RF)          SET DAYPART GROUP                            
         NI    BYTE,ZONE           CLEAR LOW NIBBLE                             
         CLC   BYTE,DPTFLTG                                                     
         BNE   PRCBUYX                                                          
                                                                                
PRCBUY20 CLI   SLNFLT,0                                                         
         BE    PRCBUY22                                                         
         CLC   BDSEC,SLNFLT                                                     
         BNE   PRCBUYX                                                          
                                                                                
PRCBUY22 XC    SPTSEQ,SPTSEQ                                                    
         MVC   SAVMKTN,KEY+(BUYKMKTN-BUYKEY)                                    
         MVC   KEY+(BUYKMKTN-BUYKEY)(L'BUYKMKTN),BUYKMKTN                       
         CLI   RQMED,NETLETQ       IF NETWORK REQ                               
         BNE   PRCBUY28                                                         
         OC    BUYKMKTN,BUYKMKTN   MARKET MUST BE ZERO                          
         BNZ   PRCBUYX                                                          
         CLC   BRQAM,BUYKAM        AND MUST BE RIGHT MEDIA                      
         BNE   PRCBUYX                                                          
         CLI   COUNTRY,CANLETQ     FOR CANADA NETWORK                           
         BNE   PRCBUY32            SET OFF BUY COST OVERRIDE BIT                
         LA    R3,BDELEM                                                        
         USING REGELEM,R3                                                       
         SR    R0,R0                                                            
PRCBUY24 CLI   REGELEM,0                                                        
         BE    PRCBUY32                                                         
         CLI   REGELEM,RCPOLOQ                                                  
         BL    PRCBUY26                                                         
         CLI   REGELEM,RCPOTOQ                                                  
         BH    PRCBUY26                                                         
         NI    RSTATUS,FF-RSRATOVQ                                              
PRCBUY26 IC    R0,RLEN                                                          
         AR    R3,R0                                                            
         B     PRCBUY24                                                         
         DROP  R3                                                               
*                                  NON-NETWORK REQ (RQMED)                      
PRCBUY28 CLI   QMED,COMLETQ        IF NOT COMBINED                              
         BNE   PRCBUY30            THEN OK                                      
         CLC   BRQAM,BUYKAM        COMBINED (AND TV) TV OK                      
         BE    PRCBUY32                                                         
         OC    BUYKMKTN,BUYKMKTN   NON-ZERO MARKET NETWORK OK                   
         BZ    PRCBUYX                                                          
***      B     PRCBUY32                                                         
                                                                                
PRCBUY30 CLI   SPILLOPT,SPILLINC   TEST TO INCORPORATE SPILL                    
         BE    PRCBUY32                                                         
         CLC   BUYKMKTN,SAVMKTN                                                 
         BNE   PRCBUYX                                                          
                                                                                
PRCBUY32 MVC   SPOTHOOK,ASPHOOK                                                 
         XC    HLDDEM(HLDDEML),HLDDEM                                           
         LA    R5,W                                                             
         USING SBUFFRD,R5                                                       
         XC    SBUFFRD(SBTOTLN),SBUFFRD                                         
         MVC   SBDPT(L'ALLDS),ALLDS SET FIELDS COMMON TO BUY                    
         TM    REQFLAG2,REQFSDPT                                                
         BZ    *+10                                                             
         MVC   SBDPT,BDDAYPT                                                    
         TM    REQFLAG2,REQFSSLN                                                
         BZ    *+10                                                             
         MVC   SBSLN,BDSEC         SET LENGTH                                   
         MVI   SBRTYP,SBRTYPQ      RECORD TYPE                                  
         MVC   SBDA,KEY+(BUYKDA-BUYKEY)                                         
         MVC   SBSTA,BUYKSTAC                                                   
         MVI   SBLIN,0             1 BYTE BUYLINE                               
         MVC   SBLIN+1(1),BUYKBUY  1 BYTE LINE NUMBER                           
         TM    BUYRCNTL,BUYRLN2    2-BYTE BUYLINE?                              
         BZ    *+10                NO                                           
         MVC   SBLIN,BUYRLIN       YES - MOVE 2 BYTES                           
*                                                                               
         MVC   SBSTIM,BDTIMST      START TIME                                   
         MVC   SBEST,BUYKEST                                                    
                                                                                
         CLC   QCODE,QPROGKLL      TEST CANADIAN REQUEST                        
         BNE   PRCBUY36                                                         
         CLI   QMED,COMLETQ        TEST CANADIAN COMBINED MEDIA                 
         BNE   PRCBUY36                                                         
         LA    R1,BDELEM                                                        
         USING NTWKELEM,R1                                                      
         SR    R0,R0                                                            
PRCBUY34 CLI   NTWKCODE,0          CAN'T FIND NETWORK ELEMENT                   
         JE    EXITN                                                            
         CLI   NTWKCODE,NTWKCODQ                                                
         BE    *+14                                                             
         IC    R0,NTWKLEN                                                       
         AR    R1,R0                                                            
         B     PRCBUY34                                                         
         OC    NETSNET,NETSNET     TEST FIRST BUY FOR STATION                   
         BZ    *+16                                                             
         CLC   NETSNET,NTWKMKST    NO - MUST BE SAME NETWORK                    
         BE    PRCBUY36                                                         
         DC    H'0'                                                             
         MVC   NETSNET,NTWKMKST    SET NETWORK CODE                             
         MVC   WORK(4),ZONES       AND ESTABLISH NETWORK STATION                
         MVC   WORK+4(L'NETSNET),NETSNET                                        
         MVI   WORK+4+L'NETSNET,C'T'                                            
         GOTOR MSPACK,DMCB,WORK+0,WORK+4,WORK+10                                
         MVC   NETSSTA,WORK+12     EXTRACT STATION                              
         MVI   NETSSTA+2,2         AND FUDGE IT                                 
         DROP  R1                                                               
                                                                                
PRCBUY36 MVC   SBNETSTA,NETSSTA    SET NETWORK STATION FOR CANADA               
         GOTOR BUYENV,SBUFFRD      CREAT/ADD TO ENV TABLES                      
         L     R0,APIGLST          BUILD A LIST OF ALL PRODUCTS                 
         GOTOR CLEAR,PIGLSTL                                                    
                                                                                
***********************************************************************         
* NOTE-MEDPIGL IS LIKE MEDPRDL BUT BUILDS LIST OF BRANDS AND PIG PAIRS*         
***********************************************************************         
                                                                                
         L     RF,APIGLST                                                       
         CLC   BRQAM,BUYKAM        IF NETWORK BUY ON COMBINED RUN               
         BE    *+12                                                             
         MVI   0(RF),UNAPRD1       SET UNA AS PRODUCT IN LIST                   
         AHI   RF,L'PIGLST                                                      
         GOTOR VMEDPIGL,DMCB,SPWORKD,(RF)                                       
         L     R3,APIGLST                                                       
         CLI   PIGLSTX-PIGLST(R3),0                                             
         BE    *+6                                                              
         DC    H'0'                TOO MANY BRANDS IN THIS BUY RECORD           
         MVI   PRESW,YESQ          FIRST LOOK FOR PRE-ALLOCS                    
PRCBUY38 MVC   SPHFILT,0(R3)       SET PRODUCT/LENGTH FILTER FOR HOOK           
         MVI   SPHPRD,0                                                         
         MVI   MEDBRAND,FF                                                      
         CLI   0(R3),UNAPRD1       MUST SEARCH SPECIFICALLY FOR UNA'S           
         BNE   *+8                                                              
         MVI   MEDBRAND,UNAPRD1                                                 
         SR    RF,RF                                                            
         IC    RF,0(R3)            SWAP POL AND PRODUCT PRDBUFF ENTRIES         
         BCTR  RF,0                                                             
         MH    RF,PRDBUFLN                                                      
         A     RF,PRDBUFF                                                       
         ST    RF,THISPRD                                                       
         L     RE,ASVPTBF                                                       
         MVC   0(PTXBUFFL,RE),0(RF)                                             
         L     RE,APOLPRD                                                       
         MVC   0(PTXBUFFL,RF),0(RE)                                             
         MVI   MEDSPTLN,0                                                       
         MVI   NOPRDNTP,SPACE                                                   
         L     RF,ADCLT                                                         
         TM    COPT1-CLTHDR(RF),COP1GMI                                         
         BZ    PRCBUY40            NO                                           
         CLI   QOPT2,NTPSNTPO      TEST NTP ALLOCATION                          
         BNE   PRCBUY40                                                         
         MVI   NOPRDNTP,YESQ       SET SUPPRESS TALENT FACTORS BY PRD           
PRCBUY40 GOTOR MEDGETBY,DMCB,SPWORKD,2                                          
         L     RF,THISPRD                                                       
         L     RE,ASVPTBF                                                       
         MVC   0(PTXBUFFL,RF),0(RE)                                             
         L     RF,MEDPERD+4                                                     
         USING MEDDATA,RF                                                       
         OC    MEDBYSPT,MEDBYSPT   TEST ANY SPOTS                               
         BZ    PRCBUY72                                                         
         OC    HLDDEM(HLDDEML),HLDDEM TEST HAVE CALCULATED SPOT DEMO            
         BNZ   PRCBUY48                                                         
         LHI   RE,1                                                             
         TM    REQFLAG1,REQFTRGS                                                
         BZ    *+8                                                              
         LHI   RE,PTDEMMAX                                                      
         LA    R6,MEDBY1                                                        
         LA    R4,ACTDEMSL                                                      
PRCBUY42 CLI   0(R4),0             TEST DEMO AN ACTIVE TARGET                   
         BE    PRCBUY46            NO                                           
         L     R1,0(R6)                                                         
         SR    R0,R0                                                            
         D     R0,MEDBYSPT                                                      
         LR    R0,R1                                                            
         SR    R1,R1                                                            
         CLI   0(R4),FF            IF BASE DEMO                                 
         BE    *+12                SET IMMEDIATELY                              
         IC    R1,0(R4)            ELSE GET TARG NO.                            
         SLL   R1,2                                                             
         ST    R0,HLDDEM(R1)                                                    
PRCBUY46 AHI   R6,L'MEDBY1+L'MEDBY1EQ                                           
         AHI   R4,L'ACTDEMSL                                                    
         BCT   RE,PRCBUY42                                                      
                                                                                
***********************************************************************         
* FOR ALL REAL BRANDS PUT ALREADY ACHIEVED INTO BUFFER                *         
***********************************************************************         
                                                                                
PRCBUY48 CLI   0(R3),FF                                                         
         BE    PRCBUY72                                                         
         XC    GBUFFR,GBUFFR                                                    
         MVC   GBDPT,SBDPT                                                      
         MVC   GBSLN,SBSLN                                                      
         MVI   GBTYP,TPREDEMQ      GOALS                                        
PRCBUY50 MVC   GBPRD,SPHPRD        PRODUCT RETURNED BY SPHOOK                   
         SR    RF,RF                                                            
         IC    RF,GBPRD                                                         
         A     RF,APALLST                                                       
         MVC   GBPALPH,0(RF)       PRODUCT SEQ CODE AND CLASS                   
         MVC   GBPCLAS,L'PALLST(RF)                                             
         CLI   GBPRD,UNAPRD1       UNA                                          
         BNE   *+8                                                              
         MVI   GBPRD,UNAPRD2                                                    
         L     RF,MEDPERD+4                                                     
         MVC   GBTOT,MEDBYP        PERIOD TOTAL                                 
         CLI   GBTYP,TPREDEMQ                                                   
         BE    PRCBUY52                                                         
         MVC   GBTOT,MEDBYD        DOLLARS                                      
         CLI   GBTYP,TPREDOLQ                                                   
         BE    PRCBUY52                                                         
         L     R0,MEDBYSPT         SPOTS                                        
         MH    R0,HW10             TO 0.0                                       
         STCM  R0,15,GBTOT                                                      
PRCBUY52 L     R1,MEDAFRST                                                      
         LA    R6,GBWKS                                                         
PRCBUY54 CLI   0(R1),0             SKIP GAPS                                    
         BE    PRCBUY58                                                         
         L     RF,4(R1)                                                         
         MVC   0(L'GBWKS,R6),MEDBYP WEEKLY DEMOS                                
         CLI   GBTYP,TPREDEMQ                                                   
         BE    PRCBUY56                                                         
         MVC   0(L'GBWKS,R6),MEDBYD DOLLARS                                     
         CLI   GBTYP,TPREDOLQ                                                   
         BE    PRCBUY56                                                         
         L     R0,MEDBYSPT         SPOTS                                        
         MH    R0,HW10             TO 0.0                                       
         ST    R0,0(R6)                                                         
PRCBUY56 AHI   R6,L'GBWKS          NEXT WEEK                                    
PRCBUY58 AHI   R1,L'MEDQ1WKS                                                    
         C     R1,MEDALAST         TEST AT END                                  
         BNH   PRCBUY54                                                         
         GOTOR BU1PUT              PUT BUFFER 1 RECORD                          
                                                                                
         MVI   GBPRD,TOTPRD                                                     
         MVI   GBPALPH,FF                                                       
         MVI   GBPCLAS,0                                                        
         GOTOR BU1PUT                                                           
                                                                                
PRCBUY60 CLI   GBTYP,TPREUNTQ                                                   
         BE    PRCBUY62            DONE-DO 2ND TARGS                            
         SR    RF,RF                                                            
         IC    RF,GBTYP                                                         
         AHI   RF,1                                                             
         STC   RF,GBTYP                                                         
         B     PRCBUY50                                                         
PRCBUY62 TM    REQFLAG1,REQFTRGS   DO 2ND TARGETS FOR PRE-ALLOCS                
         BZ    PRCBUY72                                                         
         LHI   R0,PTDEMMAX-1                                                    
         SR    R6,R6               FOR DEMO INDEX                               
PRCBUY64 LR    RF,R6                                                            
         SRL   RF,3                                                             
         LA    RF,ACTDEMSL+L'ACTDEMSL(RF) TEST DEMO AN ACTIVE TARGET            
         CLI   0(RF),0                                                          
         BE    PRCBUY70            NO                                           
         L     RF,MEDPERD+4                                                     
         L     RE,MEDBY2(R6)                                                    
         LTR   RE,RE                                                            
         BZ    PRCBUY70                                                         
         STCM  RE,15,GBTOT                                                      
         L     R1,MEDAFRST                                                      
         LA    RE,GBWKS                                                         
PRCBUY66 CLI   0(R1),0             SKIP GAPS                                    
         BE    PRCBUY68                                                         
         L     RF,4(R1)                                                         
         L     RF,MEDBY2(R6)       TARGET                                       
         ST    RF,0(RE)                                                         
         AHI   RE,L'GBWKS          NEXT WEEK                                    
PRCBUY68 AHI   R1,L'MEDQ1WKS                                                    
         C     R1,MEDALAST         TEST AT END                                  
         BNH   PRCBUY66                                                         
         LR    RF,R6                                                            
         SRL   RF,3                                                             
         IC    RF,ACTDEMSL+L'ACTDEMSL(RF)                                       
         AHI   RF,TPRET00Q         SET TYPE CODE                                
         STC   RF,GBTYP                                                         
         MVC   GBPRD,MEDBRAND                                                   
         SR    RF,RF                                                            
         IC    RF,GBPRD                                                         
         A     RF,APALLST                                                       
         MVC   GBPALPH,0(RF)                                                    
         MVC   GBPCLAS,L'PALLST(RF)                                             
         GOTOR BU1PUT              PUT BUFFER 1 RECORD                          
                                                                                
         MVI   GBPRD,TOTPRD        TOTALS                                       
         MVI   GBPALPH,FF                                                       
         MVI   GBPCLAS,0                                                        
         GOTOR BU1PUT                                                           
                                                                                
PRCBUY70 AHI   R6,8                NEXT TARGET                                  
         BCT   R0,PRCBUY64                                                      
                                                                                
PRCBUY72 AHI   R3,L'PIGLST         NEXT ENTRY                                   
         CLI   0(R3),0                                                          
         BNE   PRCBUY38                                                         
                                                                                
         OI    MKTBUYGL,MKTBHBUY   **SUPPLY** - SET HAVE BUYS                   
         MVI   MEDBRAND,FF                                                      
         MVI   SPHFILT,FF                                                       
         MVI   MEDSPTLN,0                                                       
         OC    HLDDEM(HLDDEML),HLDDEM IF DON'T HAVE DEMO NEED                   
         BNZ   PRCBUY78            TRIP TO MEDGETBY TO GET IT                   
         GOTOR MEDGETBY,DMCB,SPWORKD,2                                          
         L     RF,MEDPERD+4                                                     
         OC    MEDBYSPT,MEDBYSPT   TEST ANY SPOTS                               
         BZ    PRCBUYX                                                          
         LHI   RE,1                                                             
         TM    REQFLAG1,REQFTRGS                                                
         BZ    *+8                                                              
         LHI   RE,PTDEMMAX                                                      
         LA    R3,MEDBY1                                                        
         LA    R4,ACTDEMSL                                                      
PRCBUY74 CLI   0(R4),0             TEST DEMO AN ACTIVE TARGET                   
         BE    PRCBUY76            NO                                           
         L     R1,0(R3)                                                         
         SR    R0,R0                                                            
         D     R0,MEDBYSPT                                                      
         LR    R0,R1                                                            
         SR    R1,R1                                                            
         CLI   0(R4),FF            IF BASEDEM SET IMMEDIATELY                   
         BE    *+12                                                             
         IC    R1,0(R4)            ELSE GET TARG NO.                            
         SLL   R1,2                                                             
         ST    R0,HLDDEM(R1)                                                    
PRCBUY76 AHI   R3,L'MEDBY1+L'MEDBY1EQ                                           
         AHI   R4,L'ACTDEMSL                                                    
         BCT   RE,PRCBUY74                                                      
                                                                                
PRCBUY78 MVI   PRESW,NOQ           SET NOT LOOKING FOR PRE-ALLOCS               
         GOTOR MEDGETBY,DMCB,SPWORKD,2                                          
         XC    GBUFFR,GBUFFR                                                    
         MVC   GBDPT(L'ALLDS),ALLDS                                             
         TM    REQFLAG2,REQFSDPT                                                
         BZ    *+10                                                             
         MVC   GBDPT,BDDAYPT       DAYPART                                      
         TM    REQFLAG2,REQFSSLN                                                
         BZ    *+10                                                             
         MVC   GBSLN,BDSEC         SPOT LENGTH                                  
         MVI   GBTYP,TGOLDEMQ      GOAL SUPPLY                                  
*                                  (PRODUCT = 0 FOR SUPPLY)                     
PRCBUY80 L     RF,MEDPERD+4                                                     
         MVC   GBTOT,MEDBYP        DEMO VALUE                                   
         CLI   GBTYP,TGOLDEMQ                                                   
         BE    PRCBUY82                                                         
         MVC   GBTOT,MEDBYD        DOLLARS                                      
         CLI   GBTYP,TGOLDOLQ                                                   
         BE    PRCBUY82                                                         
         L     R0,MEDBYSPT         SPOTS                                        
         MH    R0,HW10             TO 0.0                                       
         STCM  R0,15,GBTOT                                                      
PRCBUY82 L     R1,MEDAFRST                                                      
         LA    RE,GBWKS                                                         
PRCBUY84 CLI   0(R1),0             SKIP GAPS                                    
         BE    PRCBUY88                                                         
         L     RF,4(R1)                                                         
         MVC   0(L'GBWKS,RE),MEDBYP                                             
         CLI   GBTYP,TGOLDEMQ                                                   
         BE    PRCBUY86                                                         
         MVC   0(L'GBWKS,RE),MEDBYD DOLLARS                                     
         CLI   GBTYP,TGOLDOLQ                                                   
         BE    PRCBUY86                                                         
         L     R0,MEDBYSPT         SPOTS                                        
         MH    R0,HW10             TO 0.0                                       
         ST    R0,0(RE)                                                         
PRCBUY86 AHI   RE,L'GBWKS          NEXT WEEK                                    
PRCBUY88 AHI   R1,L'MEDQ1WKS                                                    
         C     R1,MEDALAST         TEST AT END                                  
         BNH   PRCBUY84                                                         
         GOTOR BU1PUT              PUT BUFFER 1 RECORD                          
                                                                                
         CLI   GBTYP,TGOLUNTQ      TEST HAVE DONE SPOTS                         
         BE    PRCBUY90            YES - DONE                                   
         SR    RF,RF                                                            
         IC    RF,GBTYP            BUMP TYPE                                    
         AHI   RF,1                                                             
         STC   RF,GBTYP                                                         
         B     PRCBUY80                                                         
PRCBUY90 TM    REQFLAG1,REQFTRGS   NOW SET 2ND TARGET SUPPLY                    
         BZ    PRCBUYX                                                          
         LHI   R0,PTDEMMAX-1                                                    
         SR    R3,R3               FOR DEMO INDEX                               
PRCBUY92 LR    RF,R3                                                            
         SRL   RF,3                                                             
         LA    RF,ACTDEMSL+L'ACTDEMSL(RF) TEST DEMO AN ACTIVE TARGET            
         CLI   0(RF),0                                                          
         BE    PRCBUY98            NO                                           
         L     RF,MEDPERD+4                                                     
         L     RE,MEDBY2(R3)                                                    
         LTR   RE,RE                                                            
         BZ    PRCBUY98                                                         
         STCM  RE,15,GBTOT                                                      
         L     R1,MEDAFRST                                                      
         LA    RE,GBWKS                                                         
PRCBUY94 CLI   0(R1),0             SKIP GAPS                                    
         BE    PRCBUY96                                                         
         L     RF,4(R1)                                                         
         L     RF,MEDBY2(R3)       TARGET                                       
         ST    RF,0(RE)                                                         
         AHI   RE,L'GBWKS          NEXT WEEK                                    
PRCBUY96 AHI   R1,L'MEDQ1WKS                                                    
         C     R1,MEDALAST         TEST AT END                                  
         BNH   PRCBUY94                                                         
         LR    RF,R3                                                            
         SRL   RF,3                                                             
         IC    RF,ACTDEMSL+L'ACTDEMSL(RF)                                       
         AHI   RF,TACHT00Q         SET TYPE CODE                                
         STC   RF,GBTYP                                                         
         GOTOR BU1PUT              PUT BUFFER 1 RECORD                          
                                                                                
PRCBUY98 AHI   R3,8                NEXT TARGET                                  
         BCT   R0,PRCBUY92                                                      
                                                                                
PRCBUYX  J     EXITY                                                            
         DROP  R2,R5,RB,RF                                                      
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* PROCESS A GOAL RECORD                                               *         
***********************************************************************         
                                                                                
PRCGOL   NTR1  BASE=*,LABEL=*                                                   
         TM    KEY+(GKEYAGY-GKEY),GKEYPPPQ SKIP PASSIVE PIGGYBACK PTR           
         BNZ   PRCGOLX                                                          
         L     R7,ADGOAL                                                        
         USING GOALREC,R7                                                       
         CLI   DPTFLT,0            TEST DAYPART FILTER                          
         BE    PRCGOL02                                                         
         CLC   GKEYDPT,DPTFLT                                                   
         BNE   PRCGOLX                                                          
                                                                                
PRCGOL02 CLC   QPROG,QPROGKLL      IF KL PROGRAM                                
         BNE   PRCGOL04                                                         
         MVC   BYTE,GKEYAM         KEEP ONLY 'COMBINED' GOALS                   
         NI    BYTE,DIGIT                                                       
         CLI   BYTE,GKEYMCGQ                                                    
         BNE   PRCGOLX                                                          
                                                                                
PRCGOL04 CLI   DGRPOPTN,YESQ       IF DOING DAYPART GROUPS                      
         BNE   PRCGOL08                                                         
         GOTOR GETDPT,GKEYDPT      LOOK UP DAYPART IN TABLE                     
         BNE   PRCGOLX                                                          
         MVC   BYTE,1(RF)          SET GROUP                                    
         TM    BYTE,ZONE           OK IF FIRST 'DIGIT' IS 0 ???                 
         BZ    PRCGOL08                                                         
         NI    BYTE,DIGIT                                                       
         CLI   BYTE,1              ELSE 2ND MUST BE 1                           
         BNE   PRCGOLX                                                          
                                                                                
PRCGOL08 CLI   GKEYSEC,0           IF TOTAL LENGTH=0 (BUG IN $GOAL?)            
         BNE   *+10                                                             
         MVC   GKEYSEC,GKEYSLN     USE OTHER SLN                                
         CLI   SPLTOPT,SECS15      IF DOING 15 SPLITS?                          
         BNE   *+12                                                             
         CLI   GKEYSEC,SECS15      ONLY USE 15 SECOND GOALS                     
         BNE   PRCGOLX                                                          
         CLI   SLNFLT,0            LENGTH FILTER                                
         BE    PRCGOL12                                                         
         CLC   GKEYSEC,SLNFLT                                                   
         BNE   PRCGOLX                                                          
                                                                                
PRCGOL12 MVI   GOLACTSW,NOQ        CLEAR ACTIVITY FOR THIS REC                  
         L     RF,ABUFF1           SET REPLACE DATA OPT                         
         OI    BUFFINDS-BUFFD(RF),BUFFIRCM                                      
         MVC   MEDBRAND,GKEYPRD                                                 
         MVC   MEDSPTLN,GKEYSEC                                                 
         MVC   MEDDPNO,GKEYDPT                                                  
         GOTOR GOLPIG              HANDLE PIGGYBACKS                            
         MVI   MEDNOPIG,YESQ       DON'T SPLIT UP PIGGY DOLLARS                 
         GOTOR MEDGETGL,DMCB,SPWORKD                                            
         XC    GBUFFR,GBUFFR                                                    
         MVC   GBDPT(L'ALLDS),ALLDS                                             
         TM    REQFLAG2,REQFSDPT                                                
         BZ    *+10                                                             
         MVC   GBDPT,GKEYDPT       DAYPART                                      
         TM    REQFLAG2,REQFSSLN                                                
         BZ    *+10                                                             
         MVC   GBSLN,GKEYSEC       SPOT LEN                                     
                                                                                
PRCGOL14 MVI   GBTYP,TGOLDEMQ      ORIGINAL GOALS                               
                                                                                
PRCGOL16 MVC   GBPRD,MEDBRAND      PRODUCT                                      
         SR    RF,RF                                                            
         IC    RF,GBPRD                                                         
         LR    RE,RF                                                            
         BCTR  RE,0                                                             
         MH    RE,PRDBUFLN                                                      
         A     RE,PRDBUFF          ENSURE PRODUCT IS RESOLVED                   
         CLI   PTPRDN-PTBUFFD(RE),0                                             
         BE    PRCGOLX                                                          
         A     RF,APALLST                                                       
         MVC   GBPALPH,0(RF)       PRODUCT SEQ CODE AND CLASS                   
         MVC   GBPCLAS,L'PALLST(RF)                                             
         MVI   GBPRI,NOQ                                                        
         TM    GDSTAT,GDSXALCQ                                                  
         BZ    *+8                                                              
         MVI   GBPRI,YESQ                                                       
         L     RF,MEDPERD+4                                                     
         USING MEDDATA,RF                                                       
         CLI   GBTYP,TGOLDEMQ      DEMO                                         
         BE    PRCGOL20                                                         
         L     R1,MEDGLD           DOLLARS (DOLLARS/100 FOR NETWORK)            
         CLI   RQMED,NETLETQ                                                    
         BNE   PRCGOL18                                                         
         M     R0,FW1                                                           
         LH    RF,HW100                                                         
         GOTOR DIVIDE                                                           
PRCGOL18 STCM  R1,15,GBTOT                                                      
         B     PRCGOL22                                                         
                                                                                
PRCGOL20 MVC   GBTOT,MEDGL1        GOALS                                        
         SR    R1,R1                                                            
         IC    R1,MEDBRAND         GET BRAND DEMO                               
         BCTR  R1,0                                                             
         MH    R1,PRDBUFLN                                                      
         A     R1,PRDBUFF                                                       
         MVC   HDEM,PTDEMNO-PTBUFFD(R1)                                         
         CLI   HDEM+1,RATINGQ      OK IF RATING                                 
         BE    PRCGOL22                                                         
         CLI   HDEM+1,EXDRTGQ      OR EXTENDED RTG                              
         BE    PRCGOL22                                                         
         L     R1,MEDGL1           ELSE DIVIDE BY 10                            
         M     R0,FW1                                                           
         LH    RF,HW10                                                          
         GOTOR DIVIDE                                                           
         STCM  R1,15,GBTOT                                                      
                                                                                
PRCGOL22 OC    GBTOT,GBTOT                                                      
         BZ    PRCGOL36                                                         
         MVI   GOLACTSW,YESQ       SET RECORD ACTIVITY                          
         L     R4,MEDAFRST                                                      
         LA    R2,GBWKS                                                         
PRCGOL24 CLI   0(R4),0             SKIP GAPS                                    
         BE    PRCGOL32                                                         
         L     RF,4(R4)                                                         
         CLI   GBTYP,TGOLDEMQ      DEMO                                         
         BE    PRCGOL28                                                         
         L     R1,MEDGLD           DOLLARS (DOLLARS/100 FOR NETWORK)            
         CLI   RQMED,NETLETQ                                                    
         BNE   PRCGOL26                                                         
         M     R0,FW1                                                           
         LH    RF,HW100                                                         
         GOTOR DIVIDE                                                           
PRCGOL26 ST    R1,0(R2)                                                         
         B     PRCGOL30                                                         
                                                                                
PRCGOL28 MVC   0(L'GBWKS,R2),MEDGL1 GOAL                                        
         CLI   HDEM+1,RATINGQ      OK IF RATING                                 
         BE    PRCGOL30                                                         
         CLI   HDEM+1,EXDRTGQ      OR EXTENDED RATING                           
         BE    PRCGOL30                                                         
         L     R1,MEDGL1           ELSE DIVIDE BY 10                            
         M     R0,FW1                                                           
         LH    RF,HW10                                                          
         GOTOR DIVIDE                                                           
         ST    R1,0(R2)                                                         
PRCGOL30 AHI   R2,L'GBWKS          NEXT WEEK                                    
PRCGOL32 AHI   R4,L'MEDQ1WKS                                                    
         C     R4,MEDALAST         TEST AT END                                  
         BNH   PRCGOL24                                                         
                                                                                
PRCGOL34 OC    GBROW(GBROWL),GBROW                                              
         BZ    PRCGOL36                                                         
         GOTOR BU1PUT              PUT BUFFER 1 RECORD                          
                                                                                
         MVI   GBPRD,TOTPRD        PRODUCT TOTALS                               
         MVI   GBPALPH,FF                                                       
         MVI   GBPCLAS,0                                                        
         MVI   GBPRI,NOQ                                                        
         GOTOR BU1PUT                                                           
                                                                                
PRCGOL36 CLI   GBTYP,TGOLDOLQ      TEST HAVE DONE DOLLARS                       
         BE    PRCGOL38                                                         
         MVI   GBTYP,TGOLDOLQ      NO - DO NOW                                  
         B     PRCGOL16                                                         
*                                  SET STATUS IN PRDBUFF                        
PRCGOL38 CLI   GOLACTSW,YESQ       TEST REC ACTIVE                              
         BNE   PRCGOL54            NO, DONE                                     
         OI    MKTBUYGL,MKTBHGOL   SET HAVE GOALS                               
         SR    R2,R2                                                            
         IC    R2,MEDBRAND                                                      
         BCTR  R2,0                                                             
         MH    R2,PRDBUFLN                                                      
         A     R2,PRDBUFF                                                       
         USING PTBUFFD,R2          UPDATE PRODUCT BUFFER ENTRY                  
         OI    PTSTAT,PTSACTVQ     SET BRAND ACTIVE                             
         TM    GDSTAT,GDSXALCQ     TEST IGNORE SET FOR ALLOCATIONS              
         BZ    *+8                                                              
         OI    PTSTAT,PTSPRTYQ     YES - SET PRIORTY                            
         TM    PTSTAT,PTSPIGPQ     TEST PIGGY PAIR                              
         BZ    PRCGOL40                                                         
         SR    RE,RE                                                            
         IC    RE,PTPPSHR1         1ST SHARE                                    
         SR    R0,R0                                                            
         IC    R0,PTPPSHR2         2ND SHARE                                    
         AR    RE,R0                                                            
         CLM   RE,1,GKEYSEC        SUM MUST = LENGTH                            
         BE    *+8                                                              
         OI    PTSTAT,PTSPPGEQ     SET GOAL SLN ERROR                           
                                                                                
PRCGOL40 LA    R3,GDELEM           CHECK DAY OF WEEK MASK                       
         USING GLEMENT,R3                                                       
         XC    FULL,FULL           DATES                                        
         XC    DUB,DUB             MASKS                                        
PRCGOL42 MVI   DUB,0               CLEAR DAY MASK                               
         CLI   GLCODE,0            EOR                                          
         BE    PRCGOL50            FINISH UP LAST                               
         CLI   GLCODE,GLCODEQ      GOAL WEEKLY ELEMENT                          
         BE    PRCGOL46                                                         
PRCGOL44 SR    R0,R0               BUMP TO NEXT ELEMENT ON RECORD               
         IC    R0,GLEN                                                          
         AR    R3,R0                                                            
         B     PRCGOL42                                                         
                                                                                
PRCGOL46 CLC   GLWEEK,BQSTARTP     SKIP IF BEFORE START                         
         BL    PRCGOL44                                                         
         CLC   GLWEEK,BQENDP       OR IF AFTER END                              
         BH    PRCGOL44                                                         
         CLI   GLEN,GLEN3Q         NO MASK IF ELEM NOT LONG ENOUGH              
         BL    PRCGOL48                                                         
         CLI   GLDAY,0             OR IF DAY MASK IS NULL                       
         BE    PRCGOL48                                                         
         CLI   GLDAY,GLDAYMSQ      OR IF M-SU                                   
         BE    PRCGOL48                                                         
         MVC   DUB(1),GLDAY        ELSE SET MASK                                
PRCGOL48 CLC   DUB(1),DUB+1        ARE MASKS THE SAME                           
         BNE   PRCGOL50                                                         
         MVC   FULL+2(2),GLWEEK    YES, SAVE LATEST WEEK                        
         B     PRCGOL44            AND GET NEXT ELEM                            
                                                                                
PRCGOL50 CLI   DUB+1,0             IS ANY ENTRY READY TO FINISH                 
         BE    PRCGOL52            NO, START A NEW ONE                          
*                                  YES, FINISH UP                               
         XC    WORK,WORK           BUILD XCTAB ITEM                             
         LA    R5,WORK                                                          
         USING XCTABD,R5                                                        
         MVI   XCTETYPE,XCTETMKT   ENTRY TYPE=MARKET                            
         MVC   XCTSTA,FFS          STATION=ALL                                  
         MVC   XCTPRD,PTPRDA       PRODUCT                                      
         MVC   XCTEST,GKEYEST      EST                                          
         MVI   XCTTYPE,XCTTDOWQ    SET TYPE=DAY OF WEEK                         
         MVC   XCTDAY,DUB+1        SAVED DAY OF WEEK                            
         XI    XCTDAY,X'7F'        COMPLEMENT                                   
         MVC   XCTDPT,GKEYDPT      DAYPART                                      
         MVC   XCTSLN,GKEYSEC      LENGTH                                       
         GOTOR DATCON,DMCB,(2,FULL+2),X                                         
         GOTOR ADDAY,DMCB,X,X+6,6                                               
         GOTOR DATCON,DMCB,(0,X+6),(2,FULL+2)                                   
         MVC   XCTDATES(XCTDATEL),FULL                                          
         GOTOR BINSRCH,XCTPARS,(1,XCTABD)                                       
         OC    1(3,R1),1(R1)       TEST FULL                                    
         BNZ   PRCGOL52                                                         
         MVC   P1(23),=C'**Too many exclusions**'                               
         MVC   P2(L'RQBYPSSL),RQBYPSSL                                          
         J     ENDREQ                                                           
                                                                                
PRCGOL52 CLI   GLCODE,0            IF AT EOR                                    
         BE    PRCGOL54            DONE                                         
         MVC   DUB+1(1),DUB        ELSE MOVE THIS DAY MASK TO OLD               
         MVC   FULL+0(2),GLWEEK    START WEEK                                   
         MVC   FULL+2(2),GLWEEK                                                 
         B     PRCGOL44            NEXT ELEMENT                                 
                                                                                
PRCGOL54 L     RF,ABUFF1                                                        
         NI    BUFFINDS-BUFFD(RF),FF-(BUFFIRCM)                                 
                                                                                
PRCGOLX  J     EXIT                                                             
         DROP  R2,R3,R5                                                         
         EJECT                                                                  
***********************************************************************         
* ROUTINE TO HANDLE PIGGYBACK GOALS                                   *         
***********************************************************************         
                                                                                
GOLPIG   CLI   GKEYPRD2,0          TEST HAVE 2ND PRODUCT                        
         BER   RE                  NO, RETURN                                   
                                                                                
GOLPIGN  NTR1  ,                   SEARCH FOR PAIR IN PRODUCT TABLE             
ARG      USING PTPPVALS,DUB        BUILD SEARCH ARGUMENT                        
         MVC   ARG.PTPPBRD1,GKEYPRD                                             
         MVC   ARG.PTPPBRD2,GKEYPRD2                                            
         MVC   ARG.PTPPSHR1,GKEYSLN                                             
         SR    RF,RF                                                            
         IC    RF,GKEYSEC          TOTAL                                        
         SR    R0,R0                                                            
         IC    R0,GKEYSLN                                                       
         SR    RF,R0                                                            
         STC   RF,ARG.PTPPSHR2     2ND SHARE                                    
         L     R6,PRDBUFF                                                       
         USING PTBUFFD,R6                                                       
         XC    HALF,HALF                                                        
         XC    FULL,FULL                                                        
         LHI   R0,UGPIGPRD                                                      
         SR    R1,R1               R1 POINTS TO FIRST FOUND FREE ENTRY          
GOLPIG04 CLI   PTBUFFD,PTBEOTQ     TEST USED                                    
         BNE   GOLPIG06                                                         
         LTR   R1,R1               TEST FIRST UNUSED ENTRY                      
         BNZ   *+8                                                              
         LA    R1,PTBUFFD          SAVE A(FIRST UNUSED)                         
         B     GOLPIG10                                                         
GOLPIG06 CLI   PTPRPIGT,PTPRPIGQ   LOOK FOR HIGHEST MADE UP PRODUCT             
         BNE   GOLPIG08                                                         
         CLC   PTPRPCOD,=AL2(PTPRPCOQ)                                          
         BE    GOLPIG08                                                         
         MVC   HALF,PTPRPCOD       SAVE HIGHEST NON-PIGGY USED                  
GOLPIG08 CLC   PTPPVALS,ARG.PTPPVALS                                            
         BE    GOLPIG16                                                         
GOLPIG10 AH    R6,PRDBUFLN         BUMP TO NEXT PRODUCT                         
         BCT   R0,GOLPIG04                                                      
                                                                                
         LTR   R6,R1               CREATE NEW PRD FOR THIS PIGGY PAIR           
         BNZ   *+6                                                              
         DC    H'0'                                                             
         S     R1,PRDBUFF                                                       
         SR    R0,R0                                                            
         LH    RF,PRDBUFLN                                                      
         DR    R0,RF                                                            
         AHI   R1,1                                                             
         STC   R1,PTPRDN           SET PRODUCT NUMBER                           
         MVC   PTPPVALS,ARG.PTPPVALS                                            
         DROP  ARG                                                              
         MVI   PTPRPIGT,PTPRPIGQ   SET DUMMY PIGGY-BACK PRODUCT                 
         OC    HALF,ZONES          ENSURE PRODUCT CODE AS *NN                   
         PACK  DUB,HALF            BUMP HIGHEST USED                            
         AP    DUB,=P'1'                                                        
         OI    DUB+L'DUB-1,DIGIT                                                
         UNPK  PTPRPCOD,DUB        AND SET IT                                   
         SR    R2,R2                                                            
         IC    R2,GKEYPRD          GET ENTRY FOR FIRST PRODUCT                  
         BCTR  R2,0                                                             
         MH    R2,PRDBUFLN                                                      
         A     R2,PRDBUFF          COPY TARGS, ETC                              
PPRD1    USING PTBUFFD,R2                                                       
         MVC   PTTRGS,PPRD1.PTTRGS                                              
                                                                                
         LA    RE,PTBUFFD                                                       
         A     RE,DEMOVDD                                                       
         LA    RF,PPRD1.PTBUFFD                                                 
         A     RF,DEMOVDD                                                       
         L     R1,DEMOVDL                                                       
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),0(RF)       COPY DEMO LIST                               
                                                                                
         LA    RE,PTBUFFD                                                       
         A     RE,DEMOVWD                                                       
         LA    RF,PPRD1.PTBUFFD                                                 
         A     RF,DEMOVWD                                                       
         L     R1,DEMOVWL                                                       
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),0(RF)       COPY DEMO WEIGHTS                            
                                                                                
         MVI   PTSTAT,PTSPIGPQ     SET IS PIGGY                                 
         SR    R3,R3                                                            
         IC    R3,GKEYPRD2         NOW FOR 2ND PRODUCT                          
         BCTR  R3,0                                                             
         MH    R3,PRDBUFLN                                                      
         A     R3,PRDBUFF                                                       
PPRD2    USING PTBUFFD,R3                                                       
*                                  CHECK FOR CLASS CONFLICTS                    
         CLI   PPRD1.PTCLASS,0     IF FIRST PRODUCT CLASS IS 0                  
         BH    *+14                                                             
         MVC   PTCLASS,PPRD2.PTCLASS USE SECOND                                 
         B     GOLPIG14                                                         
         CLI   PPRD2.PTCLASS,0     IF 2ND PRODUCT CLASS IS 0                    
         BH    *+14                                                             
         MVC   PTCLASS,PPRD1.PTCLASS USE FIRST                                  
         B     GOLPIG14                                                         
*                                  BOTH PRODUCTS HAVE SOMETHING                 
         CLI   PPRD1.PTCLASS,TWOPTCLS                                           
         BNH   GOLPIG12                                                         
         CLI   PPRD2.PTCLASS,TWOPTCLS                                           
         BNH   GOLPIG12                                                         
*                                  BOTH PRODUCTS HAVE SINGLE CLASSES            
         CLI   PPRD1.PTCLASS,C'I'  BOTH MUST BE A-I                             
         BH    GOLPIG12                                                         
         CLI   PPRD2.PTCLASS,C'I'                                               
         BH    GOLPIG12                                                         
         PACK  PTCLASS,PPRD1.PTCLASS                                            
         NI    PTCLASS,ZONE                                                     
         MVC   WORK(L'PTCLASS),PPRD2.PTCLASS                                    
         NI    WORK,DIGIT                                                       
         OC    PTCLASS,WORK                                                     
         B     GOLPIG14                                                         
GOLPIG12 OI    PTSTAT,PTSCLSEQ     SET HAVE CLASS ERROR                         
GOLPIG14 LA    R1,PTNAME                                                        
         MVC   0(L'PTPPNAME,R1),SPACES                                          
         MVC   0(3,R1),=C'PB='                                                  
         MVC   3(L'PTPRDA,R1),PPRD1.PTPRDA                                      
         AHI   R1,3+L'PTPRDA-1                                                  
         CLI   0(R1),SPACE                                                      
         BE    *+8                                                              
         AHI   R1,1                                                             
         MVI   0(R1),DASH                                                       
         SR    RF,RF                                                            
         IC    RF,PTPPSHR1                                                      
         CVD   RF,DUB                                                           
         OI    DUB+L'DUB-1,DIGIT                                                
         UNPK  1(2,R1),DUB                                                      
         MVI   3(R1),COMMA                                                      
         MVC   4(L'PTPRDA,R1),PPRD2.PTPRDA                                      
         AHI   R1,4+L'PTPRDA-1                                                  
         CLI   0(R1),SPACE                                                      
         BE    *+8                                                              
         AHI   R1,1                                                             
         MVI   0(R1),DASH                                                       
         IC    RF,PTPPSHR2                                                      
         CVD   RF,DUB                                                           
         OI    DUB+L'DUB-1,DIGIT                                                
         UNPK  1(2,R1),DUB                                                      
         SR    R1,R1               SET ALPHA CODE AND CLASS                     
         IC    R1,PTPRDN                                                        
         A     R1,APALLST                                                       
         PACK  DUB,PTPRPCOD        NN OF #NN PRODUCT CODE                       
         CVB   RF,DUB                                                           
         AHI   RF,240              ALPHA AT +240 (PRINT AT END)                 
         STC   RF,0(R1)                                                         
         MVC   L'PALLST(L'PTCLASS,R1),PTCLASS                                   
GOLPIG16 MVC   MEDBRAND,PTPRDN     SET PRODUCT CODE                             
GOLPIGX  J     EXIT                                                             
         DROP  R6,R7,RB,RF,PPRD1,PPRD2                                          
                                                                                
GOLACTSW DS    C                   GOAL RECORD ACTIVE (YESQ/NOQ)                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* SET BUY IN ENV TABLES                                               *         
***********************************************************************         
                                                                                
BUYENV   NTR1  BASE=*,LABEL=*                                                   
         LR    R2,R1                                                            
         USING SBUFFRD,R2                                                       
         LA    R3,WORK                                                          
         USING ENVTABD,R3                                                       
         L     R7,ADBUY                                                         
         USING BUYREC,R7                                                        
                                                                                
         XC    ENVTABD(ENVS1LEN),ENVTABD                                        
         MVC   ENVS1STA,BUYMSTA+2  NOTE-BUYMSTA ALSO SET BY NETNU               
         MVC   ENVS1DAY,BDDAY      USE ROTATOR                                  
         MVC   ENVS1TIM,BDTIMST                                                 
         OC    BDTIMEND,BDTIMEND   IF ONLY ONE TIME                             
         BNZ   *+10                                                             
         MVC   ENVS1END,ENVS1STR   SET END = START                              
         MVC   ENVS1PGM,BDPROGRM                                                
         OC    ENVS1PGM,SPACES                                                  
         GOTOR GETENV,DMCB,AENV1SET,ENVS1KLN,ENVS1LEN,ENVS1MAX,SBENV1           
                                                                                
         XC    ENVTABD(ENVS2LEN),ENVTABD                                        
         MVC   ENVS2STA,BUYMSTA+2                                               
         GOTOR GETENV,DMCB,AENV2SET,ENVS2KLN,ENVS2LEN,ENVS2MAX,SBENV2           
                                                                                
         XC    ENVTABD(ENVS3LEN),ENVTABD                                        
         MVC   ENVS3DAY,BDDAY      USE BUY DESC ROTATOR                         
         GOTOR GETENV,DMCB,AENV3SET,ENVS3KLN,ENVS3LEN,ENVS3MAX,SBENV3           
                                                                                
BUYENVX  J     EXIT                                                             
                                                                                
GETENV   STM   RE,R0,12(RD)                                                     
         LM    RE,RF,0(R1)                                                      
         L     RE,ENVSATAB-ENVSETD(RE) RE=A(TABLE)                              
         BCTR  RF,0                    RF=L'KEY-1                               
NEW      USING ENVTABD,RE                                                       
         LHI   R0,1                                                             
GETENV02 EX    RF,*+8              TEST KEY MATCHES                             
         BE    GETENV04                                                         
         CLC   NEW.ENVTABD(0),ENVTABD                                           
         CLI   NEW.ENVTABD,ENVSEOTQ                                             
         BE    *+16                                                             
         A     RE,8(R1)                                                         
         AHI   R0,1                                                             
         B     GETENV02                                                         
         C     R0,12(R1)           TEST TABLE SIZE EXCEEDED                     
         BNH   *+6                                                              
         DC    H'0'                                                             
         L     RF,8(R1)            RF=L'ENTRY                                   
         EX    RF,*+8              MOVE NEW ENTRY IN                            
         B     *+10                                                             
         MVC   NEW.ENVTABD(0),ENVTABD                                           
         LA    RF,NEW.ENVTABD(RF)                                               
         MVI   0(RF),ENVSEOTQ                                                   
GETENV04 L     RE,16(R1)                                                        
         STH   R0,0(RE)            SET ENVIRONMENT POINTER                      
                                                                                
GETENVX  LM    RE,R0,12(RD)                                                     
         BR    RE                                                               
         DROP  R2,R3,RB,NEW                                                     
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* REPORT PARAMETERS OF REQUEST                                        *         
***********************************************************************         
                                                                                
PARREP   NTR1  BASE=*,LABEL=*,WORK=(R5,PARWRKL)                                 
         LA    R8,PARREP                                                        
         AHI   R8,4096                                                          
         USING PARREP+4096,R8                                                   
         USING PARWRKD,R5                                                       
         MVI   PARPIGE,0                                                        
         LHI   R0,UGPIGPRD-1       SET FOR PRDBUFF BCT                          
         MH    R0,PRDBUFLN         (SKIP *UP AND BEYOND)                        
         A     R0,PRDBUFF                                                       
         ST    R0,PARPBUFX                                                      
                                                                                
         LH    RF,PRDBUFLN         SORT PRODUCT TABLE FOR LIST                  
         MHI   RF,CPLDMAXN-1                                                    
         A     RF,PRDBUFF          SET ONE BYTE CODES                           
         LHI   R0,CPLDMAXN-1       FOR ALL BRANDS                               
         SH    RF,PRDBUFLN                                                      
         STC   R0,0(RF)                                                         
         BCT   R0,*-8                                                           
         L     R0,PRDBUFF                                                       
         LH    RF,PRDBUFLN                                                      
         GOTOR XSORT,DMCB,(R0),UGPIGPRD-1,(RF),3,1                              
                                                                                
         MVI   FORCEHED,YESQ                                                    
         MVI   RCSUBPRG,40                                                      
         MVI   SPACING,2                                                        
         GOTOR REPORT                                                           
         MVC   P1(29),=C'Run control options in effect'                         
         MVC   P2(29),DASHES                                                    
         MVI   SPACING,2                                                        
         GOTOR REPORT                                                           
         MVC   P1(26),=C'**Live run - file marked**'                            
         CLI   QOPT4,YESQ                                                       
         BNE   *+10                                                             
         MVC   P1(L'TRUNFNML),TRUNFNML                                          
         MVI   SPACING,2                                                        
         GOTOR REPORT                                                           
         MVC   P1(34),=C'Allocation basis..............Cost'                    
         CLI   GOALOPT,GOALDOLS                                                 
         BE    PARREP00                                                         
         MVC   P1+30(DEMNNAML),DEMNMS+(DEMNNADP-DEMNAMD)                        
         CLI   P1+30,SPACE                                                      
         BNE   PARREP00                                                         
         MVC   P1+30(DEMNNAML+1),P+31                                           
         B     *-14                                                             
PARREP00 TM    REQFLAG1,REQFMIXB                                                
         BZ    *+10                                                             
         MVC   P1+30(16),=C'Mixed demo goals'                                   
         GOTOR REPORT                                                           
         CLI   GOALOPT,GOALDOLS                                                 
         BE    PARREP02                                                         
         TM    REQFLAG1,REQFMIXB                                                
         BZ    PARREP04                                                         
PARREP02 MVC   P1(30),=C'Corporate demo................'                        
         MVC   P1+30(L'DEMNNAME),DEMNMS+(DEMNNAME-DEMNAMD)                      
         GOTOR REPORT                                                           
PARREP04 MVC   P1(32),=C'Allocate excess supply........No'                      
         CLI   EXCSOPT,NOQ                                                      
         BE    *+10                                                             
         MVC   P1+30(3),=C'Yes'                                                 
         GOTOR REPORT                                                           
         MVC   P1(32),=C'Goal balancing option.........No'                      
         CLI   RSWKOPT,RSWKNOQ                                                  
         BE    PARREP06                                                         
         MVC   P1+30(3),=C'Yes'                                                 
         CLI   RSWKOPT,RSWKYESQ                                                 
         BE    PARREP06                                                         
         MVC   P1+33(7),=C',Report'                                             
PARREP06 GOTOR REPORT                                                           
         MVC   P1(32),=C'Re-allocation option..........No'                      
         CLI   REALLOC,NOQ                                                      
         BE    PARREP08                                                         
         MVC   P1+30(3),=C'Yes'                                                 
         CLI   REALLOC,YESQ                                                     
         BE    PARREP08                                                         
         GOTOR DATCON,DMCB,(2,REALLSDT),(5,P1+30)                               
PARREP08 GOTOR REPORT                                                           
         MVC   P1(36),=C'Weeks with no goals...........Ignore'                  
         CLI   ZERWKOPT,ZERWIGNQ                                                
         BE    PARREP10                                                         
         MVC   P1+30(6),=C'Error '                                              
         CLI   ZERWKOPT,ZERWERRQ                                                
         BE    PARREP10                                                         
         MVC   P1+30(17),=C'Use previous week'                                  
         CLI   ZERWKOPT,ZERWPRVQ                                                
         BE    PARREP10                                                         
         MVC   P1+30(17),=C'Use average week '                                  
PARREP10 GOTOR REPORT                                                           
         CLI   DPTFLT,0            SKIP IF HAVE DAYPART FILTER                  
         BNE   PARREP12                                                         
         MVC   P1(32),=C'Allocate dayparts separately..No'                      
         TM    REQFLAG2,REQFSDPT                                                
         BZ    *+10                                                             
         MVC   P1+30(3),=C'Yes'                                                 
         GOTOR REPORT                                                           
PARREP12 CLI   SLNFLT,0            SKIP IF HAVE SLN FILTER                      
         BNE   PARREP14                                                         
         MVC   P1(32),=C'Allocate lengths separately...No'                      
         TM    REQFLAG2,REQFSSLN                                                
         BZ    *+10                                                             
         MVC   P1+30(3),=C'Yes'                                                 
         GOTOR REPORT                                                           
PARREP14 MVC   P1(33),=C'Daypart filter................All'                     
         CLI   DPTFLT,0                                                         
         BE    *+16                                                             
         MVC   P1+30(3),SPACES                                                  
         MVC   P1+30(L'DPTFLT),DPTFLT                                           
         GOTOR REPORT                                                           
         MVC   P1(33),=C'Spot length filter............All'                     
         CLI   SLNFLT,0                                                         
         BE    PARREP18                                                         
PARREP16 EDIT  (B1,SLNFLT),(3,P1+30),ALIGN=LEFT                                 
PARREP18 GOTOR REPORT                                                           
         MVC   P1(38),=C'Indexing basis................Percents'                
         CLI   INDXOPT,INDXPCTQ                                                 
         BE    *+10                                                             
         MVC   P1+30(13),=C'Actual values'                                      
         GOTOR REPORT                                                           
         MVC   P1(33),=C'Reports requested.............All'                     
         CLI   RPTOPTN,RPTOALLQ                                                 
         BE    PARREP20                                                         
         MVC   P1+30(10),=C'Recap only'                                         
         CLI   RPTOPTN,RPTORCPQ                                                 
         BE    PARREP20                                                         
         MVC   P1+30(22),=C'Weekly summary + recap'                             
PARREP20 GOTOR REPORT                                                           
         MVC   P1(36),=C'CPM/CPP equalization basis....Weekly'                  
         CLI   CPMSOPTN,CPMSWKYQ                                                
         BE    *+10                                                             
         MVC   P1+30(17),=C'By Daypart/Length'                                  
         GOTOR REPORT                                                           
         MVI   SPACING,3                                                        
         GOTOR REPORT                                                           
         L     R7,AINTTAB          DO TIME INTERVALS                            
         LA    R3,PINTRVL                                                       
         LHI   R4,INTTABN                                                       
PARREP24 MVC   P1(30),0(R7)                                                     
         MVC   P2(30),30(R7)                                                    
         EDIT  (B1,0(R3)),(3,P1+30),ZERO=NOBLANK,ALIGN=LEFT                     
         CLI   0(R3),0                                                          
         BNE   *+14                                                             
         MVC   P1+34(10),=C'(Not used)'                                         
         B     PARREP26                                                         
         CLI   0(R3),1                                                          
         BNE   *+14                                                             
         MVC   P1+30(7),=C'Program'                                             
         B     PARREP26                                                         
         MVC   P1+34(7),=C'Minutes'                                             
PARREP26 EDIT  (B1,1(R3)),(3,P2+30),ZERO=NOBLANK,ALIGN=LEFT                     
         MVI   SPACING,3                                                        
         GOTOR REPORT                                                           
         AHI   R7,L'INTTAB                                                      
         AHI   R3,2                                                             
         BCT   R4,PARREP24                                                      
*                                  LIST OBJECTIVES AND WEIGHTS                  
         MVC   P1(41),=C'Weights assigned to allocation objectives'             
         MVC   P2(30),DASHES                                                    
         MVC   P2+30(11),DASHES                                                 
         MVI   SPACING,2                                                        
         GOTOR REPORT                                                           
         MVC   P1+2(18),=C'Scale from 0 to 10'                                  
         MVI   P2,0                                                             
         MVC   P3+2(37),=C' 0 = No importance (ignore objective)'               
         MVC   P4+2(21),=C'10 = Great importance'                               
         MVI   SPACING,2                                                        
         GOTOR REPORT                                                           
         L     R3,AOBJTAB                                                       
         LA    R4,OBJWGTS                                                       
         LA    R2,P1                                                            
PARREP28 MVC   0(30,R2),0(R3)                                                   
         EDIT  (B1,0(R4)),(2,30(R2)),ZERO=NOBLANK,ALIGN=LEFT                    
         AHI   R2,L'P1                                                          
PARREP32 AHI   R3,L'OBJTAB                                                      
         AHI   R4,1                                                             
         CLI   0(R3),FF                                                         
         BNE   PARREP28                                                         
         MVI   SPACING,2                                                        
         GOTOR REPORT                                                           
*                                  DO BRAND LIST                                
         MVI   PMHLSW,PMHLBRDQ     BRAND LIST HEADS                             
         CLI   LINE,48             ALLOW SOME ROOM                              
         BNH   PARREP34                                                         
         MVI   FORCEHED,YESQ       LET HEDBLD TAKE CARE OF HEADS                
         B     PARREP36                                                         
PARREP34 LHI   R0,PARHDN                                                        
         LA    R2,P1                                                            
         L     R3,APARHD1                                                       
         MVC   0(L'PARHD1,R2),0(R3)                                             
         AHI   R2,L'P1                                                          
         AHI   R3,L'PARHD1                                                      
         BCT   R0,*-14                                                          
         MVI   SPACING,2                                                        
         GOTOR REPORT                                                           
PARREP36 MVI   PARINACT,NOQ                                                     
         L     R6,PRDBUFF                                                       
         USING PTBUFFD,R6                                                       
PARREP38 CLI   1(R6),SPACE         TEST A REAL BRAND                            
         BNH   PARREP82            AND SKIP                                     
PARREP40 MVC   PMBBRD,PTPRDA                                                    
         TM    PTSTAT,PTSACTVQ     TEST ACTIVE                                  
         BNZ   *+12                                                             
         MVI   PMBBSTAT,ASTERISK   FLAG INACTIVE PRODUCTS                       
         MVI   PARINACT,YESQ       SET HAVE INACTIVES                           
         MVC   PMBBNM(L'PTPPNAME),PTPPNAME                                      
         TM    PTSTAT,PTSPIGPQ     TEST PIGGY BACK                              
         BNZ   *+10                YES- ONLY 16 BYTES                           
         MVC   PMBBNM(L'PTNAME),PTNAME                                          
         TM    DIAGNOP1,FF         IF TRACING                                   
         BZ    PARREP42            PRINT PRODUCT CODE                           
         GOTOR HEXOUT,HEXP,PTPRDN,PMBXDTS+18,1,NOL                              
PARREP42 MVC   PMBPRI,=C' No'                                                   
         TM    PTSTAT,PTSPRTYQ                                                  
         BZ    *+10                                                             
         MVC   PMBPRI,=C'Yes'                                                   
         GOTOR SETCLS,PTCLASS                                                   
         BE    PARREP44                                                         
         MVC   PMBCLAS,CLASS1                                                   
         BH    PARREP44            NO                                           
         MVI   PMBCLAS+1,COMMA                                                  
         MVC   PMBCLAS+2(1),CLASS2                                              
PARREP44 LA    R2,PTTRGS           TARGETS                                      
         LHI   R0,NTGVARS                                                       
         LA    R3,PMBTRG1                                                       
PARREP46 SR    RF,RF                                                            
         ICM   RF,1,0(R2)                                                       
         BZ    PARREP50                                                         
         MHI   RF,L'TARGETS                                                     
         LA    RF,TARGETS-L'TARGETS(RF)                                         
         LA    RE,DEMNMS                                                        
         USING DEMNAMD,RE                                                       
         LHI   R1,PTDEMMAX         FOR BCT                                      
PARREP48 CLC   DEMNDEMN,0(RF)                                                   
         BE    *+14                                                             
         AHI   RE,DEMNLENQ                                                      
         BCT   R1,PARREP48                                                      
         DC    H'0'                                                             
         MVC   0(L'DEMNNADP+L'DEMNNAME,R3),DEMNNADP                             
PARREP50 AHI   R2,1                NEXT TARG                                    
         AHI   R3,PMBTRG2-PMBTRG1                                               
         BCT   R0,PARREP46                                                      
                                                                                
         LA    RF,PTDEMNO          GOALED DEMO                                  
         LA    RE,DEMNMS                                                        
         USING DEMNAMD,RE                                                       
         LHI   R0,PTDEMMAX         FOR BCT                                      
PARREP52 CLC   DEMNDEMN,0(RF)                                                   
         BE    *+14                                                             
         AHI   RE,DEMNLENQ                                                      
         BCT   R0,PARREP52                                                      
         DC    H'0'                                                             
         MVC   PMBGDEM,DEMNNADP                                                 
         DROP  RE                                                               
                                                                                
         L     R7,XCTATAB          EXCLUSIONS                                   
         ICM   R4,15,XCTNREC                                                    
         BZ    PARREP74                                                         
         USING XCTABD,R7                                                        
PARREP54 CLC   XCTPRD,PTPRDA       TEST RIGHT PRODUCT                           
         BNE   PARREP72                                                         
         MVC   PMBXEST,ALL                                                      
         CLI   XCTEST,0                                                         
         BE    PARREP56                                                         
         SR    R0,R0                                                            
         IC    R0,XCTEST                                                        
         CVD   R0,DUB                                                           
         OI    DUB+L'DUB-1,DIGIT                                                
         UNPK  PMBXEST,DUB                                                      
PARREP56 MVC   PMBXSTA(3),ALL                                                   
         CLI   XCTSTA,FF                                                        
         BE    PARREP58                                                         
         MVC   FULL(3),XCTSTA                                                   
         GOTOR MSUNPK,DMCB,(X'80',FULL-2),WORK,PMBXSTA                          
         CLI   RQMED,NETLETQ                                                    
         BNE   *+8                                                              
         MVI   PMBXSTA+4,SPACE                                                  
PARREP58 CLI   XCTTYPE,XCTTTODQ    TEST IF TIME OF DAY                          
         BE    PARREP60                                                         
         CLI   XCTTYPE,XCTTADYQ    OR TIME + DAY                                
         BNE   PARREP62                                                         
PARREP60 MVC   PMBXPGM(5),=C'Time='                                             
         GOTOR UNTIME,DMCB,XCTDAY,PMBXPGM+5                                     
         CLI   XCTTYPE,XCTTADYQ                                                 
         BNE   PARREP66                                                         
         LA    RF,PMBXPGM+20       FIND END OF TIME                             
         CLI   0(RF),SPACE                                                      
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVI   1(RF),SLASH                                                      
         AHI   RF,2                                                             
         GOTOR CODAY,DMCB,XCTDOW,(RF)                                           
         B     PARREP66                                                         
PARREP62 CLI   XCTTYPE,XCTTDOWQ    TEST IF DAY OF WEEK                          
         BNE   PARREP64                                                         
         MVC   PMBXPGM(5),=C'Days='                                             
         GOTOR CODAY,DMCB,XCTDAY,PMBXPGM+5                                      
         CLI   XCTDPT,0            TEST IF HAVE DAYPART/SLN                     
         BE    PARREP66            NO, DONE                                     
         LA    RE,PMBXPGM+L'PMBXPGM-1                                           
         CLI   0(RE),SPACE                                                      
         BH    *+8                                                              
         BCT   RE,*-8                                                           
         MVI   2(RE),OPAREN                                                     
         MVC   3(1,RE),XCTDPT                                                   
         EDIT  (B1,XCTSLN),(3,4(RE)),ALIGN=LEFT                                 
         AR    RE,R0                                                            
         MVI   4(RE),CPAREN                                                     
         B     PARREP66                                                         
PARREP64 MVC   PMBXPGM,XCTPGM                                                   
PARREP66 MVC   PMBXDTS+3(5),=C'Start'                                           
         CLI   XCTSDATE,0                                                       
         BE    PARREP68                                                         
         GOTOR DATCON,DMCB,(2,XCTSDATE),(5,PMBXDTS)                             
         CLC   XCTSDATE,XCTEDATE                                                
         BE    PARREP70                                                         
PARREP68 MVI   PMBXDTS+8,DASH                                                   
         MVC   PMBXDTS+9(3),=C'End'                                             
         CLI   XCTEDATE,FF                                                      
         BE    PARREP70                                                         
         GOTOR (RF),(R1),(2,XCTEDATE),(5,PMBXDTS+9)                             
PARREP70 GOTOR REPORT                                                           
PARREP72 A     R7,XCTLREC          NEXT ENTRY                                   
         BCT   R4,PARREP54                                                      
PARREP74 CLI   PMBBRD,SPACE                                                     
         BNH   PARREP76                                                         
         MVC   PMBXEST(8),=C'--None--'                                          
         GOTOR REPORT                                                           
PARREP76 TM    PTSTAT,PTSPIGEQ     TEST PIGGY FORMAT ERROR                      
         BZ    PARREP78                                                         
         MVC   P1(32),=C'***Piggyback pair brand error***'                      
         GOTOR REPORT                                                           
         MVI   PARPIGE,YESQ                                                     
         B     PARREP82                                                         
PARREP78 TM    PTSTAT,PTSPPGEQ     TEST PIGGY GOAL LENGTH ERROR                 
         BZ    PARREP80                                                         
         MVC   P1(47),=C'***Invalid goal length for this product pair***        
               *'                                                               
         GOTOR REPORT                                                           
         MVI   PARPIGE,YESQ                                                     
PARREP80 TM    PTSTAT,PTSCLSEQ     TEST PIGGY PRODUCT CLASS ERROR               
         BZ    PARREP82                                                         
         MVI   PARPIGE,YESQ                                                     
         MVC   P1(58),=C'***Conflicting or invalid classes for this pro*        
               duct pair**'                                                     
         GOTOR REPORT                                                           
PARREP82 AH    R6,PRDBUFLN                                                      
         C     R6,PARPBUFX                                                      
         BL    PARREP38                                                         
         L     R0,PRDBUFF                                                       
         LH    RF,PRDBUFLN                                                      
         GOTOR XSORT,DMCB,(R0),UGPIGPRD-1,(RF),1,0                              
         L     RF,PRDBUFF          CLEAR EXTRA ONE BYTE CODES                   
         LHI   R0,UGPIGPRD                                                      
PARREP84 CLI   1(RF),SPACE                                                      
         BH    *+8                                                              
         MVI   0(RF),0                                                          
         AH    RF,PRDBUFLN                                                      
         BCT   R0,PARREP84                                                      
         CLI   PARINACT,YESQ                                                    
         BNE   PARREP86                                                         
         GOTOR REPORT                                                           
         MVC   P1(26),=C'* -no goals for this brand'                            
         GOTOR REPORT                                                           
PARREP86 TM    REQFLAG1,REQFMIXB   MIXED GOAL BASIS NOT ALLOWED                 
         BZ    PARREP88                                                         
         GOTOR REPORT                                                           
         MVC   P1(43),=C'**Mixed demo allocation basis not allowed**'           
         MVC   P2(L'RQBYPSSL),RQBYPSSL                                          
         J     ENDREQ                                                           
PARREP88 CLI   PARPIGE,YESQ                                                     
         BNE   PARREPX                                                          
         MVC   P1(26),=C'**Piggyback brand errors**'                            
         MVC   P2(L'RQBYPSSL),RQBYPSSL                                          
         J     ENDREQ                                                           
PARREPX  MVI   PMHLSW,0                                                         
         MVI   RCSUBPRG,0                                                       
         J     EXIT                                                             
         DROP  R5,R6,R7,R8,RB                                                   
                                                                                
         LTORG                                                                  
                                                                                
PARWRKD  DSECT                                                                  
PARPBUFX DS    A                                                                
PARPIGE  DS    XL1                 PIGGYBACK ERROR                              
PARINACT DS    C                   INACTIVE SWITCH                              
PARWRKL  EQU   *-PARWRKD                                                        
SPK402   CSECT                                                                  
         EJECT                                                                  
***********************************************************************         
* DO WEEKLY GOAL BALANCING                                            *         
***********************************************************************         
                                                                                
WKYBAL   NTR1  BASE=*,LABEL=*                                                   
         L     RF,ATOTROW                                                       
         USING TABD,RF                                                          
         OC    TRSCGOL,TRSCGOL     TEST ANY GOALS TO BALANCE                    
         BZ    WKYBALX                                                          
         MVI   EXCSW,NOQ                                                        
         LH    RF,NWKS                                                          
         AHI   RF,1                                                             
         STH   RF,NWKSP1                                                        
         LH    RF,LROW                                                          
         MH    RF,NPRDS                                                         
         A     RF,AFSTBRD                                                       
         ST    RF,AEXCROW          A(ROW FOR EXCESS SUPPLY)                     
         L     RE,ATOTROW                                                       
         MVC   TABKEY,TABKEY-TABD(RE)                                           
         MVI   TABPRD,UNAPRD2      UNA PRODUCT                                  
         MVI   TABPRDA,UNAPRD2                                                  
         DROP  RF                                                               
                                                                                
***********************************************************************         
* FIND ANY WEEKS WITH NO GOALS AND EITHER SUBRACT THEIR SUPPLY FROM   *         
* TOTAL, OR SET PROPORTIONED CAMPAIGN GOALS FOR THAT WEEK, OR USE     *         
* PRIOR WEEKS GOAL OR SET ERROR AND EXIT                              *         
***********************************************************************         
                                                                                
         MVI   ZERWKSW,0                                                        
         LH    R3,NWKS             FOR BCT                                      
         L     R4,ASUPROW          POINT TO SUPPLY ROW                          
SUPTOT   USING TABD,R4                                                          
         LA    R5,SUPTOT.TABD                                                   
         AH    R5,CELLWID          WEEK 1                                       
SUPWKT   USING TABD,R5                                                          
         L     R7,ATOTROW          POINT TO TOTAL ROW                           
         AH    R7,CELLWID          WEEK 1                                       
TOTWKT   USING TABD,R7                                                          
WKYBAL02 OC    TOTWKT.TRSCGOL,TOTWKT.TRSCGOL                                    
         BNZ   WKYBAL16            YES - NEXT WEEK                              
         CLI   DSSW,DSSCURQ        IF DOING DAYPART RESCALING                   
         BE    WKYBAL04            SPECIAL WEEK OPTIONS DO NOT APPLY            
         CLI   ZERWKOPT,ZERWZERQ   OPT TO USE ZERO GOAL WEEKS                   
         BE    WKYBAL08                                                         
         CLI   ZERWKOPT,ZERWPRVQ   OPT TO USE PRIOR WEEKS GOAL                  
         BE    WKYBAL10                                                         
         CLI   ZERWKOPT,ZERWERRQ   ERROR OPT                                    
         BNE   WKYBAL04                                                         
         OC    SUPWKT.TRSCGOL,SUPWKT.TRSCGOL                                    
         BZ    WKYBAL16                                                         
         MVI   ZERWKSW,1           SET ERROR IF ANY SUPPLY                      
         B     WKYBALX                                                          
                                                                                
WKYBAL04 L     RF,SUPTOT.TRSCGOL   SUBTRACT SUPPLY FROM TOTAL                   
         S     RF,SUPWKT.TRSCGOL                                                
         ST    RF,SUPTOT.TRSCGOL                                                
         B     WKYBAL16                                                         
                                                                                
WKYBAL08 L     R8,ATOTROW          USE CAMPAIGN GOALS                           
         B     WKYBAL12                                                         
WKYBAL10 LR    R8,R7               USE PRIOR WEEKS GOALS                        
         SH    R8,CELLWID          NB-FIRST WEEK GOES TO CAMPAIGN TOTAL         
*                                  SET TO CAMPAIGN/PREVIOUS WEEK GOALS          
TOTBAS   USING TABD,R8                                                          
WKYBAL12 OC    SUPWKT.TRSCGOL,SUPWKT.TRSCGOL                                    
         BZ    WKYBAL16            SKIP IF NO SUPPLY                            
         L     R1,SUPWKT.TRSCGOL                                                
         M     R0,FW100000                                                      
         L     RF,TOTBAS.TRSCGOL                                                
         GOTOR DIVIDE                                                           
         ST    R1,FACTOR1          = SUP/OTHER GOAL GOAL                        
         L     R6,ATOTROW                                                       
TOTALS   USING TABD,R6                                                          
         LR    R2,R7                                                            
CURWKT   USING TABD,R2                                                          
WKYBAL14 L     R1,TOTBAS.TRSCGOL                                                
         M     R0,FACTOR1                                                       
         L     RF,FW100000                                                      
         GOTOR DIVIDE                                                           
         ST    R1,CURWKT.TRSCGOL                                                
         A     R1,TOTALS.TRSCGOL   ADD INTO TOTAL COLUMN                        
         ST    R1,TOTALS.TRSCGOL                                                
         AH    R6,LROW             NEXT PRODUCT                                 
         AH    R2,LROW                                                          
         AH    R8,LROW                                                          
         CLI   TOTALS.TABKEY,0     END OF PRODUCTS                              
         BNE   WKYBAL14                                                         
WKYBAL16 AH    R5,CELLWID          BUMP TO NEXT WEEK                            
         AH    R7,CELLWID                                                       
         BCT   R3,WKYBAL02                                                      
                                                                                
***********************************************************************         
* SET ORIG GOALS AT +4 FOR LATER COMPARISON +16 FOR PRINT             *         
* IF EXCSOPT=N CREATE EXCESS ROW WITH LEFTOVER FOR WEEK AND           *         
* THEN TREAT AS A REGULAR BRAND                                       *         
***********************************************************************         
                                                                                
WKYBAL18 LH    R6,NWKSP1                                                        
         SR    R2,R2               START AT TOTAL COLUMN                        
WKYBAL20 L     R3,ATOTROW                                                       
         USING TABD,R3                                                          
         L     RF,TRSCGOL(R2)                                                   
         ST    RF,TPREDEM(R2)      ORIGINAL GOAL                                
         ST    RF,TSAVDEM(R2)      SET IN WORK GOAL                             
                                                                                
         L     R3,AFSTBRD                                                       
         XC    RSREGTOT(L'RSREGTOT+L'RSPRITOT),RSREGTOT                         
WKYBAL22 L     RF,TRSCGOL(R2)      ORIG GOAL                                    
         ST    RF,TPREDEM(R2)      SET IN WORK GOAL                             
         ST    RF,TSAVDEM(R2)      SAVE FOR REPORT                              
         LA    RE,RSREGTOT         POST TO REGULAR BAND TOTAL                   
         CLI   TABPRI,YESQ                                                      
         BNE   *+8                                                              
         LA    RE,RSPRITOT         OR PRIORITY BRAND TOTAL                      
         A     RF,0(RE)                                                         
         ST    RF,0(RE)                                                         
         AH    R3,LROW             NEXT PRODUCT                                 
         C     R3,AEXCROW                                                       
         BNH   WKYBAL22                                                         
                                                                                
         L     R5,ASUPROW          SAVING EXCESS                                
SAVEXC   USING TABD,R5                                                          
         L     RF,SAVEXC.TRSCGOL(R2) SUPPLY                                     
         ST    RF,SAVEXC.TSAVDEM(R2) SAVE                                       
         L     RE,RSREGTOT                                                      
         A     RE,RSPRITOT         RE = TOTAL GOAL                              
         CR    RF,RE               TEST ANY EXCESS                              
         BNH   WKYBAL26            NO                                           
         CLI   EXCSOPT,YESQ        IF NOT ALLOCATING EXCESS                     
         BNE   WKYBAL24                                                         
         OC    RSREGTOT,RSREGTOT   OR IF ALL BRANDS ARE PRIORITY                
         BNZ   WKYBAL26            (OR THER ARE NO BRANDS)                      
WKYBAL24 MVI   EXCSW,YESQ                                                       
         L     R5,AEXCROW                                                       
         SR    RF,RE                                                            
         LH    RE,NPRDS            BUT AVOID CREATING EXCESS ROW                
         AHI   RE,1                OUT OF ROUNDING ERRORS                       
         CR    RF,RE               MUST BE MORE THAN 1 PER PRODUCT              
         BNH   WKYBAL26                                                         
         ST    RF,SAVEXC.TRSCGOL(R2) SET LEFTOVER IN EXCESS ROW                 
         ST    RF,SAVEXC.TPREDEM(R2)                                            
         ST    RF,SAVEXC.TSAVDEM(R2)                                            
         OC    RSREGTOT,RSREGTOT                                                
         BNZ   WKYBAL26                                                         
         LA    RF,SAVEXC.TPREDOL(R2)                                            
         MVI   0(RF),FF            SET HAVE ONLY PRI BRANDS FOR WEEK            
                                                                                
WKYBAL26 AH    R2,CELLWID          NEXT WEEK                                    
         BCT   R6,WKYBAL20                                                      
         CLI   EXCSW,YESQ          ADD FOR TOTAL OF WEEKLY EXCESSES             
         BNE   WKYBAL36                                                         
         L     R3,AEXCROW                                                       
         LH    R0,NWKS                                                          
         LH    R2,CELLWID                                                       
         SR    RF,RF                                                            
         A     RF,TRSCGOL(R2)                                                   
         AH    R2,CELLWID          NEXT WEEK                                    
         BCT   R0,*-8                                                           
         C     RF,TRSCGOL          TEST SUM OF WEEKS VS ACTUAL TOTAL            
         BH    WKYBAL30                                                         
         ST    RF,TRSCGOL          SET TOTAL EXCESS                             
         ST    RF,TPREDEM          SET IN WORK GOAL                             
         B     WKYBAL36                                                         
                                                                                
***********************************************************************         
* HERE IF HAVE MIXTURE OF EXCESS AND NON-EXCESS WEEKS                 *         
***********************************************************************         
                                                                                
WKYBAL30 CLI   EXCSOPT,YESQ        DON'T RESCALE IF ALLOCATING EXCESS           
         BE    WKYBAL36                                                         
         L     R3,AEXCROW                                                       
         L     R1,TRSCGOL          ACTUAL TOTAL EXCESS                          
         M     R0,FW10000                                                       
         GOTOR DIVIDE              / SUM OF WEEKS WITH EXCESS                   
         ST    R1,FACTOR1                                                       
         L     RF,FW10000                                                       
         LH    R6,NWKS                                                          
         LH    R2,CELLWID                                                       
WKYBAL32 LA    R7,TPREDOL(R2)      DON'T RESCALE                                
         CLI   0(R7),FF            IF PRI ONLY WEEK                             
         BE    WKYBAL34                                                         
         L     R1,TRSCGOL(R2)                                                   
         LTR   R1,R1                                                            
         BNP   WKYBAL34                                                         
         M     R0,FACTOR1                                                       
         GOTOR DIVIDE                                                           
         LTR   R1,R1               DON'T REDUCE TO ZERO                         
         BP    *+8                                                              
         LHI   R1,1                                                             
         ST    R1,TRSCGOL(R2)                                                   
         ST    R1,TPREDEM(R2)                                                   
         ST    R1,TSAVDEM(R2)                                                   
WKYBAL34 MVI   0(R7),0                                                          
         AH    R2,CELLWID          NEXT WEEK                                    
         BCT   R6,WKYBAL32                                                      
WKYBAL36 SR    R2,R2               RESCALE TOTAL COLUMN                         
         GOTOR RSVERT                                                           
         L     R3,AFSTBRD          SET RESCALED GOAL IN TABGOAL                 
WKYBAL38 MVC   TABGOAL,TPREDEM                                                  
         AH    R3,LROW                                                          
         C     R3,AEXCROW                                                       
         BNH   WKYBAL38                                                         
         GOTOR RSPRNT              PRINT RESCALING WORKSHEET                    
                                                                                
         MVI   RSLCNT,0            RESCALING LOOP                               
WKYBAL40 LH    R2,CELLWID          START AT WEEK 1                              
         LH    R0,NWKS             FOR BCT                                      
         GOTOR RSVERT              DO VERTICLE RESCALE                          
         AH    R2,CELLWID          NEXT WEEK                                    
         BCT   R0,*-8                                                           
                                                                                
***********************************************************************         
* NOW ADD ACROSS FOR TOTAL AND COMPARE TO LAST RESULTS                *         
***********************************************************************         
                                                                                
         L     R3,AFSTBRD                                                       
         MVI   RSCHGSW,NOQ         SET NO CHANGE                                
WKYBAL44 LH    R2,CELLWID          START AT WEEK 1                              
         LH    R0,NWKS                                                          
         SR    RF,RF                                                            
         A     RF,TPREDEM(R2)                                                   
         AH    R2,CELLWID                                                       
         BCT   R0,*-8                                                           
         LR    RE,RF                                                            
         S     RE,TPREDEM                                                       
         LPR   RE,RE                                                            
         C     RE,FW1                                                           
         BNH   *+8                                                              
         MVI   RSCHGSW,YESQ        SET HAVE CHANGE                              
         MVC   TPREDOL,TPREDEM     SAVE OLD RESULT                              
         ST    RF,TPREDEM          SET NEW WORK GOAL                            
         AH    R3,LROW             NEXT PRODUCT                                 
         C     R3,AEXCROW                                                       
         BNH   WKYBAL44                                                         
         CLI   RSWKOPT,RSWKNOQ     IF NO WEEKLY BALANCING THEN DONE             
         BE    WKYBAL52                                                         
         CLI   RSCHGSW,NOQ         OR IF NO CHANGE                              
         BE    WKYBAL52                                                         
         SR    RF,RF                                                            
         IC    RF,RSLCNT           OR IF TOO MANY TIMES AROUND LOOP             
         CHI   RF,RLOOPMAX                                                      
         BE    WKYBAL52                                                         
         AHI   RF,1                                                             
         STC   RF,RSLCNT                                                        
         GOTOR RSPRNT              PRINT RESCALING WORKSHEET                    
                                                                                
***********************************************************************         
* NOW RESCALE HORIZONTALLY AND TRY AGAIN                              *         
***********************************************************************         
                                                                                
         L     R3,AFSTBRD                                                       
WKYBAL46 ICM   R1,15,TABGOAL       ORIG GOALS (BUT ONCE RESCALED)               
         M     R0,FW10000                                                       
         BZ    WKYBAL50                                                         
         L     RF,TPREDEM          / CURRENT WORK GOAL                          
         GOTOR DIVIDE                                                           
         ST    R1,FACTOR1          = RESCALE FACTOR                             
         C     R1,FW10000          SKIP IF NO CHANGE                            
         BE    WKYBAL50                                                         
         LH    R2,CELLWID          START AT WEEK 1                              
         LH    R7,NWKS                                                          
WKYBAL48 L     R1,TPREDEM(R2)                                                   
         ST    R1,TPREDOL(R2)      SAVE CURRENT FOR LATER COMPARE               
         M     R0,FACTOR1                                                       
         L     RF,FW10000                                                       
         GOTOR DIVIDE                                                           
         C     R1,TMINRES(R2)      TEST VS MINIMUN                              
         BNL   *+8                                                              
         L     R1,TMINRES(R2)                                                   
         ST    R1,TPREDEM(R2)      SET NEW WORK GOAL                            
         AH    R2,CELLWID          NEXT WEEK                                    
         BCT   R7,WKYBAL48                                                      
WKYBAL50 AH    R3,LROW             NEXT ROW                                     
         C     R3,AEXCROW                                                       
         BNH   WKYBAL46                                                         
         B     WKYBAL40            TAKE IT FROM THE TOP                         
                                                                                
***********************************************************************         
* MAKE SURE NO BRANDS ARE 'BALANCED' OUT OF EXISTENCE                 *         
***********************************************************************         
                                                                                
WKYBAL52 L     R3,AFSTBRD                                                       
WKYBAL54 SR    R2,R2               START AT TOTAL COLUMN                        
         LH    R7,NWKSP1                                                        
WKYBAL56 L     RF,TRSCGOL(R2)      TEST ANY ORIGINAL GOAL                       
         LTR   RF,RF                                                            
         BZ    WKYBAL58            NO - IGNORE                                  
         L     RF,TPREDEM(R2)      TEST ANY 'BALANCED' GOAL                     
         LTR   RF,RF                                                            
         BNZ   WKYBAL58            YES - IGNORE                                 
         LHI   RF,1                SET BALANCED GOAL TO 1                       
         ST    RF,TPREDEM(R2)      (KEEPS BRAND ALIVE IN WEEK)                  
WKYBAL58 AH    R2,CELLWID                                                       
         BCT   R7,WKYBAL56                                                      
         AH    R3,LROW                                                          
         C     R3,AEXCROW                                                       
         BNH   WKYBAL54                                                         
                                                                                
***********************************************************************         
* SET TOTAL GOAL = SUPPLY  AT +4 (REPLACE REG BRAND TOTAL)            *         
***********************************************************************         
                                                                                
         L     R4,ATOTROW                                                       
TOT      USING TABD,R4                                                          
         L     R5,ASUPROW                                                       
SUP      USING TABD,R5                                                          
         SR    R2,R2                                                            
         LH    R0,NWKSP1                                                        
         L     RE,SUP.TRSCGOL(R2)                                               
         ST    RE,TOT.TPREDEM(R2)                                               
         AH    R2,CELLWID                                                       
         BCT   R0,*-12                                                          
         GOTOR RSPRNT              PRINT RESCALING WORKSHEET                    
                                                                                
*                                  PRINT RESCALING REPORT                       
         LH    RF,NWKSP1           WEEKS (INCLUDING TOTAL)                      
         LHI   R1,MAXWKPP          MAX WEEKS PER REPORT PAGE                    
         SR    R0,R0               STARTING WEEK NUMBER                         
WKYBAL62 CR    RF,R1               WILL WHATS LEFT FIT ON THIS PAGE             
         BNL   *+6                                                              
         LR    R1,RF               YES, DO IT ALL                               
         STH   R1,RPTNWKS                                                       
         STC   R0,RPTSWK                                                        
         GOTOR RSREPT              RESCALING REPORT                             
         AHI   R0,MAXWKPP          WEEKS PER PAGE                               
         SR    RF,R1                                                            
         BP    WKYBAL62            DO NEXT SET OF WEEKS                         
WKYBALX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* VERTICLE RESCALER                                                   *         
***********************************************************************         
                                                                                
RSVERT   NTR1  ,                                                                
         L     R3,AFSTBRD         SET REG TOT AND PRI TOT                       
BRD      USING TABD,R3                                                          
         L     R5,ATOTROW                                                       
TOT      USING TABD,R5                                                          
         L     R6,ASUPROW                                                       
SUP      USING TABD,R6                                                          
         SR    R0,R0                                                            
         ST    R0,TOT.TPREDEM(R2)  CLEAR REG TOT                                
         ST    R0,TOT.TPREDOL(R2)  CLEAR PRI TOT                                
RSVERT02 LA    RE,TOT.TPREDOL(R2)  PRI TOT                                      
         CLI   BRD.TABPRI,YESQ                                                  
         BE    *+8                                                              
         LA    RE,TOT.TPREDEM(R2)  REG TOT                                      
         L     RF,0(RE)                                                         
         A     RF,BRD.TPREDEM(R2)                                               
         ST    RF,0(RE)                                                         
         AH    R3,LROW             NEXT PRODUCT                                 
         C     R3,AEXCROW                                                       
         BNH   RSVERT02                                                         
*                                  SET SUPPLY AMOUNTS                           
         L     RF,SUP.TRSCGOL(R2)  TOTAL SUPPLY                                 
         L     RE,TOT.TPREDOL(R2)  TOTAL PRI GOAL                               
         ST    RF,SUP.TPREDOL(R2)  SET PRI SUPPLY = TOTAL SUPPLY                
         SR    R0,R0               AND CLEAR REG SUPPLY                         
         ST    R0,SUP.TPREDEM(R2)                                               
         CR    RF,RE               IF TOTAL SUPPLY L.E. PRI SUPPLY              
         BNH   RSVERT04                                                         
         ST    RE,SUP.TPREDOL(R2)  SET PRI SUPPLY=TOTAL PRI GOAL                
         SR    RF,RE                                                            
         ST    RF,SUP.TPREDEM(R2)  AND REG SUPPLY TO REMAINDER                  
*                                  GET RESCALING FACTORS                        
RSVERT04 L     R1,SUP.TPREDEM(R2)  REG SUPPLY                                   
         M     R0,FW10000                                                       
         L     RF,TOT.TPREDEM(R2)  REG GOAL TOTAL                               
         GOTOR DIVIDE                                                           
         ST    R1,FACTOR1          REG PRODUCT FACTOR                           
         L     R1,SUP.TPREDOL(R2)  PRI SUPPLY                                   
         M     R0,FW10000                                                       
         L     RF,TOT.TPREDOL(R2)  PRI GOAL                                     
         GOTOR DIVIDE                                                           
         ST    R1,FACTOR2          PRI FACTOR                                   
         L     R3,AFSTBRD                                                       
RSVERT06 LA    RF,FACTOR2                                                       
         CLI   TABPRI,YESQ                                                      
         BE    *+8                                                              
         LA    RF,FACTOR1                                                       
         L     R1,BRD.TPREDEM(R2)  BRD GOAL                                     
         M     R0,0(RF)            X FACTOR                                     
         L     RF,FW10000                                                       
         GOTOR DIVIDE                                                           
         ST    R1,BRD.TPREDEM(R2)  SET RESULT                                   
         CLI   RSLCNT,0            ON FIRST TIME SET                            
         BNE   RSVERT08            SET MINIMUN RESCALING LIMIT                  
         LTR   R1,R1                                                            
         BNP   RSVERT08                                                         
         M     R0,FW10             10 PCT OF 1ST RESCALING                      
         LH    RF,HW100                                                         
         GOTOR DIVIDE                                                           
         LTR   R1,R1                                                            
         BP    *+8                                                              
         LHI   R1,1                                                             
         ST    R1,BRD.TMINRES(R2)                                               
RSVERT08 AH    R3,LROW             NEXT PRODUCT                                 
         C     R3,AEXCROW                                                       
         BNH   RSVERT06                                                         
RSVERTX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* PRINT RESCALING WORKSHEET                                           *         
***********************************************************************         
                                                                                
RSPRNT   TM    DIAGNOP1,DPRTRESQ                                                
         BZR   RE                                                               
RSPRNTN  NTR1  ,                                                                
         MVI   FORCEHED,YESQ                                                    
         MVI   SKIPSPEC,YESQ                                                    
         MVC   P1(19),=C'Rescaling worksheet'                                   
         MVC   P2(19),DASHES                                                    
         MVI   SPACING,2                                                        
         GOTOR REPORT                                                           
         L     R3,ASUPROW                                                       
RSPRNT02 XC    X,X                                                              
         GOTOR HEXOUT,HEXP,TABD,X,TABDATA-TABD,NOL                              
         MVC   P1(12),X                                                         
         MVC   P2(12),X+12                                                      
         EDIT  TABGOAL,(8,P3+2),ZERO=NOBLANK                                    
         LH    RF,NWKSP1           WEEKS (INCLUDING TOTAL)                      
         LHI   R1,MAXWKPP          MAX WEEKS PER REPORT PAGE                    
         SR    R0,R0               STARTING WEEK NUMBER                         
RSPRNT04 CR    RF,R1               WILL WHATS LEFT FIT ON THIS PAGE             
         BNL   *+6                                                              
         LR    R1,RF               YES, DO IT ALL                               
         STH   R1,RPTNWKS                                                       
         STC   R0,RPTSWK                                                        
         GOTOR RSPTAB              RESCALING REPORT                             
         AHI   R0,MAXWKPP          WEEKS PER PAGE                               
         SR    RF,R1                                                            
         BP    RSPRNT04            DO NEXT SET OF WEEKS                         
         AH    R3,LROW             NEXT PRODUCT                                 
         C     R3,AEXCROW                                                       
         BNH   RSPRNT02                                                         
         J     EXIT                                                             
                                                                                
RSPTAB   NTR1  ,                                                                
         LA    R2,P1+12                                                         
         LH    R4,RPTNWKS                                                       
         LA    R6,TABDATA-TABD(R3)                                              
         SR    RF,RF                                                            
         IC    RF,RPTSWK           STARTING WEEK NO                             
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
RSPTAB02 LH    R5,CELLWID                                                       
         SRL   R5,2                                                             
         LR    R7,R2                                                            
RSPTAB04 EDIT  (B4,0(R6)),(8,0(R7)),ZERO=NOBLANK                                
         AHI   R7,L'P1             NEXT CELL ON NEXT LINE                       
         AHI   R6,L'TRSCGOL                                                     
         BCT   R5,RSPTAB04                                                      
         AHI   R2,8                NEXT WEEK                                    
         BCT   R4,RSPTAB02                                                      
         MVI   SPACING,2                                                        
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT                                                           
RSPTABX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* RESCALING REPORT                                                    *         
***********************************************************************         
                                                                                
RSREPT   NTR1  ,                                                                
         CLI   RSWKOPT,RSWKREPQ    NEED BALANCE REPORT                          
         BE    *+12                                                             
         CLI   RSWKOPT,RSWKBALQ    ONLY BALANCING                               
         BNE   RSREPTX                                                          
         MVI   FORCEHED,YESQ                                                    
         MVI   RCSUBPRG,50                                                      
         MVI   NOMID,YESQ                                                       
         LH    RF,RPTNWKS          SET COLUMN SPACING CONTROLS                  
         BCTR  RF,0                                                             
         MHI   RF,L'RSLTAB                                                      
         A     RF,ARSLTAB                                                       
         MVC   ROWDISP+1(1),0(RF)  START OF ROW DESC                            
         MVC   AMTDISP+1(1),1(RF)  OVER TO TOTAL COLUMN                         
         MVC   WEEKWID+1(1),2(RF)  SPACE BETWEEN COLUMNS                        
RSREPT04 LH    R7,RPTNWKS          SET TOTAL ROW                                
         SR    R2,R2                                                            
         IC    R2,RPTSWK           STARTING WEEK NO                             
         MH    R2,CELLWID                                                       
RSREPT06 SR    RE,RE                                                            
         L     R3,AFSTBRD                                                       
         USING TABD,R3                                                          
RSREPT08 CLI   TABPRD,0                                                         
         BE    RSREPT10                                                         
         CLI   TABPRD,UNAPRD2                                                   
         BE    RSREPT10                                                         
         A     RE,TSAVDEM(R2)                                                   
         AH    R3,LROW                                                          
         B     RSREPT08                                                         
RSREPT10 L     RF,ATOTROW                                                       
         ST    RE,TSAVDEM-TABD(RF,R2)                                           
         AH    R2,CELLWID          NEXT WEEK                                    
         BCT   R7,RSREPT06                                                      
*                                  SORT BRANDS IN PRINT ORDER                   
         L     R3,AFSTBRD          FIRST BUILD TABLE OF ADDRS                   
         L     R4,AEXCROW          SET ABRDSRT                                  
         AH    R4,LROW             AFTER PRODUCT TABLE                          
         AH    R4,LROW             LEAVE A ZERO ROW                             
         ST    R4,ABRDSRT                                                       
         SR    RF,RF                                                            
RSREPT12 CLI   TABPRD,0                                                         
         BE    RSREPT14                                                         
         MVC   0(1,R4),TABPRDA                                                  
         STCM  R3,15,1(R4)                                                      
         AH    R3,LROW             NEXT PRODUCT                                 
         AHI   R4,5                NEXT TABLE ENTRY                             
         AHI   RF,1                COUNT PRODUCTS                               
         B     RSREPT12                                                         
RSREPT14 MVI   0(R4),FF            SET END OF TABLE                             
         LTR   RF,RF                                                            
         BNP   RSREPT18            NO PRODUCTS                                  
         GOTOR XSORT,DMCB,ABRDSRT,(RF),5,1,0                                    
         L     R3,ASUPROW          SUPPLY                                       
         ST    R3,THISPRD                                                       
         GOTOR RSBRDR                                                           
         L     R4,ABRDSRT          BRANDS                                       
RSREPT16 CLI   0(R4),FF            END                                          
         BE    RSREPT18                                                         
         ICM   R3,15,1(R4)         A(BRAND ROW)                                 
         ST    R3,THISPRD                                                       
         GOTOR RSBRDR              DO BRAND REPORT                              
         AHI   R4,5                                                             
         B     RSREPT16                                                         
RSREPT18 L     R3,ATOTROW                                                       
         ST    R3,THISPRD                                                       
         GOTOR RSBRDR              DO TOTALS                                    
RSREPT20 L     R2,ATOTROW                                                       
         OC    TABDATA-TABD(8,R2),TABDATA-TABD(R2) TEST ANY GOALS               
         BNZ   RSREPT22                                                         
         GOTOR REPORT                                                           
         MVC   P1(23),=C'*** No goals for market'                               
         MVC   P1+24(4),MKT                                                     
         LA    RF,P1+30                                                         
         CLI   RQMED,NETLETQ                                                    
         BNE   *+8                                                              
         LA    RF,P1+17                                                         
         MVC   0(L'DPTDESC,RF),DPTDESC                                          
         MVI   SPACING,2                                                        
         MVC   P2,SPACES                                                        
         GOTOR REPORT                                                           
RSREPT22 CLI   DSSW,DSSYESQ        IF DID DAYPART RESCALING                     
         BNE   RSREPT24                                                         
         CLI   PBMODE,PBMDPTQ      AND THIS IS A WEEK RESCALE                   
         BE    RSREPT24                                                         
         MVC   P1(65),=C'Note- ''Before'' figures are derived from over*        
               all daypart rescaling'                                           
         MVC   P2+6(62),=C'(possibly adjusted by daypart to daypart rol*        
               l-up adjustments),'                                              
         MVC   P3+6(32),=C'they are not the original goals.'                    
         GOTOR REPORT                                                           
RSREPT24 CLI   DSSW,DSSCURQ        IF DOING DAYPART RESCALING                   
         BNE   RSREPT26                                                         
         CLI   PBMODE,PBMDPTQ      AND THIS IS A DAYPART RESCALE RPT            
         BNE   RSREPT26                                                         
         CLI   DGRPOPTN,YESQ       AND DAYPART GROUP OPTION ON                  
         BNE   RSREPT26                                                         
         MVC   P1(80),=C'Note- Daypart group option is in effect. The '*        
               'Before'' goals for any sub-dayparts'                            
         MVC   P2+6(79),=C'have been copied from the master day-part an*        
               d factored according to the supply.'                             
         GOTOR REPORT                                                           
RSREPT26 MVI   RCSUBPRG,0                                                       
RSREPTX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* FORMAT AND PRINT BRAND REPORT LINE                                  *         
***********************************************************************         
                                                                                
RSBRDR   NTR1  ,                                                                
         MVC   SRPNL1,SPACES                                                    
         MVC   SRPNL2,SPACES                                                    
         L     R3,THISPRD                                                       
         CLI   TABPRD,0            SUPPLY                                       
         BNE   RSBRDR02                                                         
         MVC   SRPNL1(12),=C'** Supply **'                                      
         B     RSBRDR12                                                         
RSBRDR02 CLI   TABPRD,TOTPRD                                                    
         BNE   RSBRDR04                                                         
         MVC   SRPNL1(L'TOTALSL),TOTALSL                                        
         B     RSBRDR12                                                         
RSBRDR04 CLI   TABPRD,UNAPRD2                                                   
         BNE   RSBRDR06                                                         
         OC    TRSCGOL(L'TRSCGOL+L'TPREDEM),TRSCGOL                             
         BZ    RSBRDRX             SKIP IF NONE                                 
         MVC   SRPNL1(11),=C'***  Excess'                                       
         B     RSBRDR10                                                         
RSBRDR06 SR    RF,RF                                                            
         IC    RF,TABPRD                                                        
         BCTR  RF,0                                                             
         MH    RF,PRDBUFLN                                                      
         A     RF,PRDBUFF                                                       
         USING PTBUFFD,RF                                                       
         CLI   PTPRDN,0                                                         
         BNE   *+6                                                              
         DC    H'0'                BAD PRODUCT                                  
         MVC   HPRD,PTPRDA                                                      
         MVC   SRPNL1(L'PTPRDA),PTPRDA                                          
         LA    R7,SRPNL1+5                                                      
         MVC   0(L'PTPPNAME,R7),PTPPNAME                                        
         TM    PTSTAT,PTSPIGPQ     TEST PIGGY BACK                              
         BNZ   *+10                YES-ONLY 16 BYTES                            
         MVC   0(L'PTNAME,R7),PTNAME                                            
         DROP  RF                                                               
RSBRDR10 CLI   TABPRI,YESQ                                                      
         BNE   RSBRDR12                                                         
         LA    R7,SRPNL1+40                                                     
         CLI   0(R7),SPACE                                                      
         BH    *+8                                                              
         BCT   R7,*-8                                                           
         MVC   3(3,R7),=C'(P1)'                                                 
         AHI   R7,4                                                             
RSBRDR12 LA    R6,P1                                                            
         AH    R6,ROWDISP                                                       
         MVC   0(L'SRPNL1,R6),SRPNL1                                            
         MVC   L'P1(L'SRPNL2,R6),SRPNL2                                         
         MVC   SRPNL1,SPACES                                                    
         MVC   SRPNL2,SPACES                                                    
         LA    R2,P1                                                            
         AH    R2,ROWDISP                                                       
         CLI   TABPRD,0                                                         
         BE    RSBRDR14                                                         
         LA    R2,P2                                                            
         AH    R2,ROWDISP          START OF ROW DESCS                           
         CLI   TABPRD,UNAPRD2      NO BEFORE FOR EXCESS ROW                     
         BE    RSBRDR26                                                         
         LR    RF,R2               POSITION OF BEFORE/AFTER                     
         AH    RF,AMTDISP                                                       
         AHI   RF,-7               7 BEFORE AMOUNTS                             
         MVC   0(6,RF),=C'Before'                                               
RSBRDR14 LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,TSAVDEM          ORIGINAL GOAL                                
         LH    R5,RPTNWKS                                                       
         SR    RF,RF                                                            
         IC    RF,RPTSWK           STARTING WEEK NO                             
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
RSBRDR16 L     R1,0(R6)                                                         
         CLI   GOALOPT,GOALDOLS                                                 
         BNE   RSBRDR20                                                         
         LTR   R1,R1                                                            
         BZ    RSBRDR18                                                         
         CLI   RQMED,NETLETQ       NO ROUND FOR NETWORK                         
         BE    RSBRDR18                                                         
         M     R0,FW1                                                           
         LH    RF,HW100                                                         
         GOTOR DIVIDE                                                           
RSBRDR18 EDIT  (R1),(8,0(R4)),ZERO=NOBLANK                                      
         B     RSBRDR24                                                         
RSBRDR20 CLI   RQMED,NETLETQ       NO DECIMAL FOR NETWORK                       
         BNE   RSBRDR22            AUDIENCES                                    
         CLI   BASEDEM+1,RATINGQ                                                
         BE    RSBRDR22                                                         
         EDIT  (R1),(8,0(R4)),ZERO=NOBLANK                                      
         B     RSBRDR24                                                         
RSBRDR22 EDIT  (R1),(8,0(R4)),1,ZERO=NOBLANK                                    
RSBRDR24 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,RSBRDR16                                                      
         AHI   R2,L'P1             NEXT LINE                                    
RSBRDR26 CLI   TABPRD,0            NO AFTER FOR SUPPLY                          
         BE    RSBRDR38                                                         
         LR    RF,R2               POSITION OF BEFORE/AFTER                     
         AH    RF,AMTDISP                                                       
         AHI   RF,-7               7 BEFORE AMOUNTS                             
         MVC   0(5,RF),=C'After'                                                
         CLI   TABPRD,TOTPRD       FOR TOTALS                                   
         BNE   *+12                                                             
         L     R3,ASUPROW          USE SUPPLY AS 'AFTER'                        
         B     RSBRDR14                                                         
         LR    R4,R2                                                            
         AH    R4,AMTDISP                                                       
         LA    R6,TPREDEM                                                       
         LH    R5,RPTNWKS                                                       
         SR    RF,RF                                                            
         IC    RF,RPTSWK           STARTING WEEK NO                             
         MH    RF,CELLWID                                                       
         AR    R6,RF                                                            
RSBRDR28 L     R1,0(R6)            GET IN DOLLARS                               
         CLI   GOALOPT,GOALDOLS                                                 
         BNE   RSBRDR32                                                         
         LTR   R1,R1                                                            
         BZ    RSBRDR30                                                         
         CLI   RQMED,NETLETQ       NO ROUND FOR NETWORK                         
         BE    RSBRDR30                                                         
         M     R0,FW1                                                           
         LH    RF,HW100                                                         
         GOTOR DIVIDE                                                           
RSBRDR30 EDIT  (R1),(8,0(R4)),ZERO=NOBLANK                                      
         B     RSBRDR36                                                         
RSBRDR32 CLI   RQMED,NETLETQ       NO DECIMAL FOR NETWORK                       
         BNE   RSBRDR34            AUDIENCES                                    
         CLI   BASEDEM+1,RATINGQ                                                
         BE    RSBRDR34                                                         
         EDIT  (R1),(8,0(R4)),ZERO=NOBLANK                                      
         B     RSBRDR36                                                         
RSBRDR34 EDIT  (R1),(8,0(R4)),1,ZERO=NOBLANK                                    
RSBRDR36 AH    R6,CELLWID          NEXT WEEK                                    
         AH    R4,WEEKWID                                                       
         BCT   R5,RSBRDR28                                                      
         AHI   R2,L'P1             NEXT LINE                                    
RSBRDR38 MVI   SPACING,2                                                        
         GOTOR REPORT                                                           
RSBRDRX  J     EXIT                                                             
         DROP  R3,RB,SUPWKT,SUPTOT,SAVEXC,TOT,TOTALS,TOTBAS,SUP,TOTWKT          
         DROP  BRD,CURWKT                                                       
                                                                                
RSREGTOT DS    F                   REGULAR BRAND TOTAL                          
RSPRITOT DS    F                   PRIORITY BRAND TOTAL                         
EXCSW    DS    C                   WKYBAL S/R EXCESS SWITCH                     
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* DAYPART RESCALING                                                   *         
*                                                                     *         
* TREAT DAYPART/SLNS AS 'WEEKS' AND USE WKYBAL                        *         
***********************************************************************         
                                                                                
DPTBAL   NTR1  BASE=*,LABEL=*                                                   
         MVI   DSSW,DSSNOQ                                                      
         TM    REQFLAG2,REQFSDPT+REQFSSLN MUST BE SEPARATE DPT/LEN              
         BNO   DPTBALX                                                          
         CLI   RSWKOPT,RSWKNOQ     AND RESCALE OPT                              
         BE    DPTBALX                                                          
         TM    REQFLAG1,REQFMIXB   AND NOT MIXED GOAL BASIS                     
         BNZ   DPTBALX                                                          
         OC    DPSLFLT,DPSLFLT     AND DAYPART/LENGTH FILTER NOT SET            
         BNZ   DPTBALX                                                          
         MVI   PBMODE,PBMDPTQ      DAYPART MODE FOR PRTBUF                      
         MVI   DSSW,DSSCURQ        SET CURRENTLY DOING DAYPART RESCALE          
         LHI   RF,24               SET 'CELL WIDTH'                             
         STH   RF,CELLWID                                                       
         LA    RF,MAXWEEKS+1       USE MAX WKS FOR DAYPART WKYBAL               
         MH    RF,CELLWID                                                       
         AHI   RF,TABDATA-TABD                                                  
         STH   RF,LROW             LENGTH OF ROW                                
         A     RF,ASUPROW                                                       
         ST    RF,ATOTROW          TOTAL ROW                                    
         AH    RF,LROW                                                          
         ST    RF,AFSTBRD          1ST BRAND                                    
         MVC   SAVNWKS,NWKS        SAVE NWKS                                    
         XC    NWKS,NWKS                                                        
         XC    NPRDS,NPRDS                                                      
         GOTOR CLRBRD              CLEAR BRDTAB TO BINARY ZEROES                
         XC    DSTAB(DSTABL),DSTAB CLEAR DAYPART/SLN TABLE                      
         LA    R2,DSTAB                                                         
         XC    L.GBUFFK,L.GBUFFK                                                
         XC    DPTBALWK,DPTBALWK   START AT TOTAL COLUMN                        
         XC    GBUFFK,GBUFFK                                                    
         GOTOR BU1RDH              READ HIGH BUFFER 1                           
         B     DPTBAL06                                                         
DPTBAL04 GOTOR BU1RSQ              READ SEQUENTIAL BUFFER 1                     
DPTBAL06 BNZ   DPTBAL20                                                         
         OC    GBROW(GBROWL),GBROW SKIP RECS WITH NULL VALUES                   
         BZ    DPTBAL04                                                         
         LHI   R0,TGOLDEMQ         RATINGS                                      
         CLI   GOALOPT,GOALDEMS                                                 
         BE    *+8                                                              
         LHI   R0,TGOLDOLQ         OR DOLLARS                                   
         CLM   R0,1,GBTYP                                                       
         BNE   DPTBAL04                                                         
         CLC   GBDPT,L.GBDPT                                                    
         BNE   DPTBAL08                                                         
         CLC   GBSLN,L.GBSLN                                                    
         BE    DPTBAL10            NO                                           
DPTBAL08 MVC   L.GBUFFK,GBUFFK                                                  
         MVC   0(L'DSTAB,R2),GBDPT SAVE DAYPART/SLN IN DSTAB                    
         AHI   R2,L'DSTAB                                                       
         LH    RF,DPTBALWK         NEXT 'WEEK'                                  
         AH    RF,CELLWID                                                       
         STH   RF,DPTBALWK                                                      
         LH    RF,NWKS             BUMP 'DAYPART' COUNT                         
         AHI   RF,1                                                             
         STH   RF,NWKS                                                          
DPTBAL10 L     R6,ASUPROW                                                       
         CLI   GBPRD,SUPPRD        SUPPLY                                       
         BE    DPTBAL16                                                         
         L     R6,ATOTROW                                                       
         CLI   GBPRD,TOTPRD        TOTAL                                        
         BE    DPTBAL16                                                         
         L     R6,AFSTBRD          FIND RIGHT PRODUCT                           
         USING TABD,R6                                                          
DPTBAL12 CLC   TABPRD,GBPRD                                                     
         BE    DPTBAL16                                                         
         CLI   TABPRD,0                                                         
         BNE   DPTBAL14                                                         
         LH    R1,NPRDS            BUMP NO OF PRODUCTS                          
         AHI   R1,1                                                             
         STH   R1,NPRDS                                                         
         B     DPTBAL16                                                         
DPTBAL14 AH    R6,LROW                                                          
         B     DPTBAL12                                                         
DPTBAL16 MVC   TABKEY,GBUFFK                                                    
         OC    TABCOMM,TABCOMM                                                  
         BNZ   *+10                                                             
         MVC   TABCOMM,GBUFFC                                                   
         ICM   R1,15,GBTOT                                                      
         L     R0,TRSCGOL          ADD TO TOTAL COL                             
         AR    R0,R1                                                            
         ST    R0,TRSCGOL                                                       
         AH    R6,DPTBALWK                                                      
         ST    R1,TRSCGOL                                                       
         B     DPTBAL04                                                         
         DROP  R6                                                               
DPTBAL20 CLC   NWKS,HW1            SKIP IF ONLY ONE DAYPART                     
         BH    DPTBAL22                                                         
         MVI   DSSW,DSSNOQ         NO DAYPART RESCALING                         
         B     DPTBAL36                                                         
DPTBAL22 GOTOR WKYBAL                                                           
                                                                                
***********************************************************************         
* NOW READ ORIGINAL ROWS AND REWRITE RESCALED GOALS - TYP 41          *         
***********************************************************************         
                                                                                
         MVC   DPTBALWK,CELLWID    START AT 'WEEK' 1                            
         LA    R2,DSTAB                                                         
DPTBAL24 L     R3,ATOTROW                                                       
         USING TABD,R3                                                          
         LH    R4,DPTBALWK                                                      
DPTBAL26 XC    GBUFFK,GBUFFK                                                    
         MVC   GBUFFK,TABKEY       KEY FOR BUFF                                 
         MVC   GBDPT(L'GBDPT+L'GBSLN),0(R2) DAYPART/SLN FROM TABLE              
         GOTOR BU1GET                                                           
         BNZ   DPTBAL34            SKIP IF THIS PRODUCT/DPT NOT ACTIVE          
*                                  CALC FACTOR                                  
*                                  SCALE EACH WEEK TO NEW TOTALS                
         CLC   GBTOT,FW1           BUT IF GBTOT NOT GREATER THAN 1 THEN         
         BH    DPTBAL28            COMPLETE BUY/GOAL DAYPART MISMATCH           
*                                  AND CAN'T PROCEED (PREVENTS A                
*                                  DIVISION DUMP)                               
         MVC   P1(29),=C'**Buy/Goal daypart mismatch**'                         
         MVC   P2(L'RQBYPSSL),RQBYPSSL                                          
         J     ENDREQ                                                           
DPTBAL28 L     R1,TPREDEM(R4)                                                   
         M     R0,FW100000                                                      
         MVC   FULL,GBTOT                                                       
         L     RF,FULL                                                          
         GOTOR DIVIDE                                                           
         ST    R1,FACTOR1                                                       
         L     R1,TPREDEM(R4)                                                   
         STCM  R1,15,GBTOT                                                      
         LH    R5,SAVNWKS          FOR BCT                                      
         LA    R6,GBWKS                                                         
DPTBAL30 ICM   R1,15,0(R6)                                                      
         BZ    DPTBAL32                                                         
         M     R0,FACTOR1                                                       
         L     RF,FW100000                                                      
         GOTOR DIVIDE                                                           
         LTR   R1,R1               DON'T REDUCE TO ZERO                         
         BP    *+8                                                              
         LHI   R1,1                                                             
         ST    R1,0(R6)                                                         
DPTBAL32 AHI   R6,L'GBWKS                                                       
         BCT   R5,DPTBAL30                                                      
         MVI   GBTYP,TRSCGOLQ                                                   
         MVC   GBUFFC,TABCOMM                                                   
         L     RF,ABUFF1                                                        
         OI    BUFFINDS-BUFFD(RF),BUFFIRCM                                      
         GOTOR BU1PUT              PUT BUFFER 1 RECORD                          
         L     RF,ABUFF1                                                        
         NI    BUFFINDS-BUFFD(RF),FF-(BUFFIRCM)                                 
DPTBAL34 AH    R3,LROW             NEXT PRODUCT                                 
         CLI   TABPRD,0                                                         
         BNE   DPTBAL26                                                         
         AHI   R2,L'DSTAB          NEXT DAYPART/SLN                             
         CLI   0(R2),0             END                                          
         BE    DPTBAL36                                                         
         LH    RF,DPTBALWK                                                      
         AH    RF,CELLWID                                                       
         STH   RF,DPTBALWK                                                      
         B     DPTBAL24                                                         
DPTBAL36 MVC   NWKS,SAVNWKS        RESTORE NWKS                                 
         LH    RF,NWKS                                                          
         AHI   RF,1                                                             
         STH   RF,NWKSP1                                                        
         CLI   DSSW,DSSCURQ                                                     
         BNE   DPTBALX                                                          
         GOTOR PRTBUF                                                           
         MVI   DSSW,DSSYESQ        SET HAVE DONE DAYPART RESACLE                
                                                                                
DPTBALX  MVI   PBMODE,0                                                         
         J     EXIT                                                             
         DROP  R3,RB                                                            
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* ROUTINE TO COPY GOALS FOR SUB-DAYPARTS                              *         
*                                                                     *         
* NOTE- CHANGE MADE MAY92 TO ALLOW BUYS FOR MASTER DAYPART,           *         
*       I.E. TO TREAT IT AS A SUB-DAYPART AS WELL.                    *         
***********************************************************************         
                                                                                
CPYGOL   NTR1  BASE=*,LABEL=*                                                   
         CLI   DGRPOPTN,YESQ       MUST BE DOING SUB-GOUPS                      
         BNE   CPYGOLX                                                          
         TM    REQFLAG2,REQFSDPT   MUST BE SEPARATE DAYPARTS                    
         BZ    CPYGOLX                                                          
         TM    REQFLAG1,REQFMIXB   AND NOT MIXED GOAL BASIS                     
         BNZ   CPYGOLX                                                          
                                                                                
***********************************************************************         
* ** PASS 1 **                                                        *         
*                                                                     *         
* GO THRU BUFFER AND SUM SUPPLY FOR ACTIVE SUB-DPTS BY GROUP          *         
* (INCLUDING MASTER AS SUB)                                           *         
***********************************************************************         
                                                                                
         XC    GBUFFK,GBUFFK                                                    
         XC    S.GBUFFK,S.GBUFFK                                                
         L     RE,ADGTDOL                                                       
         XC    0(L'DGRDOL,RE),0(RE)                                             
         L     RE,ADGTDEM                                                       
         XC    0(L'DGRDEM,RE),0(RE)                                             
         GOTOR BU1RDH              READ HIGH BUFFER 1                           
         B     CPYGOL04                                                         
CPYGOL02 GOTOR BU1RSQ              READ SEQUENTIAL BUFFER 1                     
CPYGOL04 BNZ   CPYGOL14                                                         
         CLI   GBPRD,SUPPRD        SUPPLY                                       
         BNE   CPYGOL02            NO, SKIP                                     
         CLI   GBTYP,TGOLDEMQ      DEMO                                         
         BE    CPYGOL06                                                         
         CLI   GBTYP,TGOLDOLQ      DOLLARS                                      
         BNE   CPYGOL02                                                         
CPYGOL06 GOTOR GETDPT,GBDPT        SEE IF IT IS A SUB-DAYPART                   
         BNE   CPYGOL02                                                         
         MVC   BYTE,1(RF)                                                       
         TM    BYTE,ZONE           FIRST DIGIT MUST NOT BE B'0'                 
         BZ    CPYGOL02                                                         
CPYGOL10 TM    DIAGNOP1,DNDXPRTQ   TRACE READS?                                 
         BZ    CPYGOL12                                                         
         GOTOR HEXOUT,HEXP,GBUFFR,P1+3,L'GBUFFR,NOL                             
         MVI   P1,C'S'             SUB GROUPS                                   
         GOTOR REPORT                                                           
CPYGOL12 ICM   RF,15,GBTOT         ADD UP TOTALS (NOT WEEKLY)                   
         L     RE,ADGTDEM          DEMO TOTALS                                  
         CLI   GBTYP,TGOLDEMQ                                                   
         BE    *+8                                                              
         L     RE,ADGTDOL          4 TOTALS                                     
         SR    R1,R1                                                            
         IC    R1,BYTE             INDEX BY DAYPART GROUP                       
         SRL   R1,4                ISOLATE 1ST DIGIT                            
         SLL   R1,2                X 4                                          
         A     RF,0(RE,R1)         ADD TO DAYPART GROUP ACCUM                   
         ST    RF,0(RE,R1)                                                      
         B     CPYGOL02                                                         
                                                                                
***********************************************************************         
* ** PASS 2 **                                                        *         
*                                                                     *         
* FIND EACH ACTIVE SUB-DAYPART AGAIN AND COPY GROUP GOALS BUT PUT OFF *         
* MASTER AS SUB UNTIL PASS 3                                          *         
***********************************************************************         
                                                                                
CPYGOL14 XC    GBUFFK,GBUFFK                                                    
         XC    S.GBUFFK,S.GBUFFK                                                
         GOTOR BU1RDH              READ HIGH BUFFER 1                           
         B     CPYGOL18                                                         
CPYGOL16 GOTOR BU1RSQ              READ SEQUENTIAL BUFFER 1                     
CPYGOL18 BNZ   CPYGOL40                                                         
         CLI   GBPRD,SUPPRD        SUPPLY                                       
         BNE   CPYGOL16            NO, SKIP                                     
         CLI   GBTYP,TGOLDEMQ      DEMO                                         
         BE    *+12                                                             
         CLI   GBTYP,TGOLDOLQ      DOLLARS                                      
         BNE   CPYGOL16                                                         
         GOTOR GETDPT,GBDPT        SEE IF IT IS A SUB-DAYPART                   
         BNE   CPYGOL16                                                         
         MVC   BYTE,1(RF)          SET GROUP CODE                               
         NI    BYTE,DIGIT          CLEAR HIGH NIBBLE                            
         CLI   BYTE,2              2ND DIGIT MUST BE 2+                         
         BL    CPYGOL16            (NO MASTER AS SUB NOW)                       
CPYGOL24 MVC   S.GBUFFK,GBUFFK     SAVE THIS BUFFER KEY                         
         MVC   FULL,GBTOT          SAVE TOTAL                                   
*                                  NOW FIND THE MASTER DAYPART                  
         MVC   BYTE,1(RF)          RESET CURRENT GROUP                          
         NI    BYTE,ZONE           CLEAR LOW NIBBLE                             
         OI    BYTE,1              SET TO 1 - NOW HAS MASTER DPTNUM             
         GOTOR GETDPC,BYTE                                                      
         BNE   CPYGOL38                                                         
         XC    GBUFFR,GBUFFR       READ DAYPART GROUP GOALS                     
         MVC   GBDPT,0(RF)         DAYPART                                      
         MVC   GBSLN,S.GBSLN       SLN                                          
         MVC   L.GBUFFK,GBUFFK                                                  
         GOTOR BU1RDH              READ HIGH BUFFER 1                           
         B     CPYGOL30                                                         
CPYGOL28 GOTOR BU1RSQ              READ SEQUENTIAL BUFFER 1                     
CPYGOL30 BNZ   CPYGOL38                                                         
         CLC   GBDPT(L'GBDPT+L'GBSLN),L.GBDPT                                   
         BNE   CPYGOL38                                                         
         CLI   GBPRD,SUPPRD        SKIP SUPPLY                                  
         BE    CPYGOL28                                                         
         CLC   GBTYP,S.GBTYP       RIGHT TYPE?                                  
         BNE   CPYGOL28                                                         
CPYGOL32 MVC   L.GBUFFK,GBUFFK                                                  
         MVC   GBDPT,S.GBUFFK      COPY TO SUB-DAYPART                          
         LA    R4,GBTOT                                                         
         LH    R5,NWKSP1                                                        
         L     RE,ADGTDEM          DEMO TOTALS FOR DAYPART GROUPS               
         CLI   GBTYP,TGOLDEMQ                                                   
         BE    *+8                                                              
         L     RE,ADGTDOL          DOLLARS TOTALS                               
         SR    R1,R1                                                            
         IC    R1,BYTE             BYTE STILL HAS DAYPART GROUP NUM             
         SRL   R1,4                ISOLATE FIRST DIGIT                          
         SLL   R1,2                INDEX INTO TOTALS                            
         AR    RE,R1                                                            
         L     RF,0(RE)                                                         
CPYGOL34 L     R1,0(R4)            GROUP DAYPART GOAL                           
         M     R0,FULL             X SUB-DAYPART SUPPLY                         
         GOTOR DIVIDE              / TOTAL SUPPLY FOR GROUP                     
         ST    R1,0(R4)            = NEW SUB-DAYPART GOAL                       
         AHI   R4,4                                                             
         BCT   R5,CPYGOL34                                                      
         GOTOR BU1PUT              PUT BUFFER 1 RECORD                          
         TM    DIAGNOP1,DNDXPRTQ   TRACE READS?                                 
         BZ    CPYGOL36                                                         
         GOTOR HEXOUT,HEXP,GBUFFR,P1+3,L'GBUFFR,NOL                             
         MVI   P1,C'C'             COPIED GOALS                                 
         GOTOR REPORT                                                           
CPYGOL36 MVC   GBUFFK,L.GBUFFK     RESTORE SEQ                                  
         GOTOR BU1RDH              READ HIGH BUFFER 1                           
         B     CPYGOL28                                                         
CPYGOL38 MVC   GBUFFK,S.GBUFFK     RESET SEQ AND CONTINUE                       
         GOTOR BU1RDH              READ HIGH BUFFER 1                           
         B     CPYGOL16                                                         
                                                                                
***********************************************************************         
* ** PASS 3 **                                                        *         
*                                                                     *         
* DELETE DAYPART GROUP GOALS (BUT FOR MASTER AS SUB REWRITE FACTORED  *         
* GOALS)                                                              *         
***********************************************************************         
                                                                                
CPYGOL40 XC    GBUFFK,GBUFFK                                                    
         XC    CGSVBFS(CGSVBFSL),CGSVBFS                                        
         GOTOR BU1RDH              READ HIGH BUFFER 1                           
         B     CPYGOL44                                                         
CPYGOL42 GOTOR BU1RSQ              READ SEQUENTIAL BUFFER 1                     
CPYGOL44 BNZ   CPYGOLX                                                          
         GOTOR GETDPT,GBDPT        SEE IF IT IS A GROUP DAYPART                 
         BNE   CPYGOL42                                                         
         MVC   BYTE,1(RF)          SET DAYPART NUM                              
         TM    BYTE,ZONE           1ST DIGIT MUST BE NON-ZERO                   
         BZ    CPYGOL42                                                         
         NI    BYTE,DIGIT                                                       
         CLI   BYTE,2              AND 2ND DIGIT MUST BE LESS THAN 2            
         BNL   CPYGOL42                                                         
         MVC   BYTE,1(RF)          SET DAYPART NUMBER AGAIN                     
         CLI   GBPRD,SUPPRD        IF SUPPLY                                    
         BNE   CPYGOL52                                                         
         LA    RF,SVBUF11          DEMO BUFF KEY                                
         CLI   GBTYP,TGOLDEMQ                                                   
         BE    CPYGOL50                                                         
         LA    RF,SVBUF12          COST BUFF KEY                                
         CLI   GBTYP,TGOLDOLQ                                                   
         BNE   CPYGOL42            ELSE SKIP                                    
*                                  SAVE SUPPLY KEY & TOTAL/GET NEXT             
CPYGOL50 MVC   0(L'GBUFFK,RF),GBUFFK                                            
         MVC   L'GBUFFK(4,RF),GBTOT                                             
         B     CPYGOL42                                                         
CPYGOL52 SR    R2,R2               GOALS                                        
         LA    RF,SVBUF11                                                       
         CLI   GBTYP,TGOLDEMQ                                                   
         BE    *+16                                                             
         LA    RF,SVBUF12                                                       
         CLI   GBTYP,TGOLDOLQ                                                   
         BNE   CPYGOL42                                                         
         CLC   GBDPT(L'GBDPT+L'GBSLN),0(RF)  TEST RIGHT DAYPART/SLN             
         BNE   CPYGOL54                                                         
         ICM   R2,15,L'GBUFFK(RF)  VALUE                                        
         BZ    CPYGOL54                                                         
         SR    RF,RF                                                            
         IC    RF,BYTE             DAYPART GRP NUMBER                           
         SRL   RF,4                ISOLATE FIRST DIGIT                          
         SLL   RF,2                INDEX INTO TOTALS                            
         L     RE,ADGTDEM                                                       
         CLI   GBTYP,TGOLDEMQ                                                   
         BE    *+8                                                              
         L     RE,ADGTDOL                                                       
         L     RF,0(RE,RF)         TOTAL SUPPLY FOR GROUP                       
CPYGOL54 LA    R4,GBTOT                                                         
         LH    R5,NWKSP1                                                        
CPYGOL56 L     R1,0(R4)            COMPLEMENT THE AMOUNTS                       
         LTR   R2,R2               R2 HAS FACTOR IF HAVE SUPPLY                 
         BZ    CPYGOL58            FOR MASTER DAYPART                           
         MR    R0,R2                                                            
         GOTOR DIVIDE              / RF (GROUP TOTAL)                           
         L     RE,0(R4)                                                         
         LCR   RE,RE               COMPLEMENT ORIGINAL AMOUNT                   
         AR    R1,RE               AND ADD FACTOR LEAVING ONLY IT               
         B     CPYGOL60                                                         
CPYGOL58 LCR   R1,R1               COMPLEMENT AMOUNTS TO CLEAR THEM             
CPYGOL60 ST    R1,0(R4)                                                         
         AHI   R4,4                                                             
         BCT   R5,CPYGOL56                                                      
         GOTOR BU1PUT              PUT BUFFER 1 RECORD                          
         TM    DIAGNOP1,DNDXPRTQ   TRACE READS?                                 
         BZ    CPYGOL42                                                         
         GOTOR HEXOUT,HEXP,GBUFFR,P1+3,L'GBUFFR,NOL                             
         MVI   P1,C'D'             DELETED GOALS                                
         GOTOR REPORT                                                           
         B     CPYGOL42                                                         
CPYGOLX  J     EXIT                                                             
         DROP  RB                                                               
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* MOVE SUPPLY/GOAL TO TABLE ROW                                       *         
***********************************************************************         
                                                                                
ROWIN    NTR1  BASE=*,LABEL=*                                                   
         L     R2,ASUPROW          POINT TO SUPPLY ROW                          
         CLI   GBPRD,SUPPRD        TEST SUPPLY PRODUCT                          
         BE    ROWIN10                                                          
         L     R2,ATOTROW          POINT TO TOTAL ROW                           
         CLI   GBPRD,TOTPRD        TEST TOTAL PRODUCT                           
         BE    ROWIN10                                                          
         L     R2,AFSTBRD          FIND RIGHT PRODUCT                           
         USING TABD,R2                                                          
ROWIN02  CLC   TABPRD,GBPRD        PRODUCT MUST AGREE                           
         BE    ROWIN04                                                          
         CLI   TABPRD,0            TEST END OF PRODUCT BUFFER                   
         BE    *+12                                                             
         AH    R2,LROW             NO - BUMP TO NEXT ENTRY                      
         B     ROWIN02                                                          
         LA    R0,TABD             YES - CLEAR AND USE LAST ROW                 
         LH    R1,LROW                                                          
         GOTOR CLEAR                                                            
ROWIN04  MVI   TABGLDEM,0          SET GOAL DEMO                                
         CLI   GBPRD,UNAPRD2                                                    
         BNL   ROWIN10                                                          
         TM    REQFLAG1,REQFMIXB   TEST MIXED GOAL BASIS                        
         BZ    ROWIN10                                                          
         SR    RE,RE                                                            
         IC    RE,GBPRD                                                         
         BCTR  RE,0                                                             
         MH    RE,PRDBUFLN                                                      
         A     RE,PRDBUFF                                                       
         CLC   BASEDEM,PTDEMNO-PTBUFFD(RE)                                      
         BE    ROWIN10                                                          
         MVC   TABGLDEM,PTTRGS-PTBUFFD(RE)                                      
ROWIN10  MVC   TABKEY,GBUFFK       SET KEY                                      
         OC    TABCOMM,GBUFFC      SET COMMENT                                  
         LA    R1,GBROW                                                         
         SR    RF,RF                                                            
         IC    RF,CELLD            ADD DISPLACEMENT TO REQUIRED CELL            
         LA    RF,TABDATA(RF)      AND POINT TO ACCUMULATOR                     
         LA    R0,GBROWN           R0=N'GBROW ENTRIES                           
ROWIN12  L     RE,0(R1)                                                         
         A     RE,0(RF)                                                         
         ST    RE,0(RF)                                                         
         AH    RF,CELLWID          NEXT WEEK                                    
         AHI   R1,L'GBWKS                                                       
         BCT   R0,ROWIN12                                                       
ROWINX   J     EXIT                                                             
         DROP  R2,RB                                                            
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* WRITE SUPPLY/GOAL TABLE BACK TO BUFFER                              *         
***********************************************************************         
                                                                                
ROWOUT   NTR1  BASE=*,LABEL=*                                                   
         L     R2,ATOTROW                                                       
         USING TABD,R2                                                          
ROWOUT02 XC    GBUFFR,GBUFFR                                                    
         MVC   GBUFFK(L'GBUFFK+L'GBUFFC),TABKEY                                 
         MVC   GBTYP,TYP           SET TYPE                                     
         CLI   TYP,TRSCGOLQ                                                     
         BNE   ROWOUT04                                                         
         CLI   DSSW,DSSYESQ                                                     
         BNE   ROWOUT04                                                         
         GOTOR BU1GET              READ REC ALREADY THERE                       
         BZ    ROWOUT04                                                         
         XC    GBUFFR,GBUFFR                                                    
         MVC   GBUFFK(L'GBUFFK+L'GBUFFC),TABKEY                                 
         MVC   GBTYP,TYP           SET TYPE                                     
ROWOUT04 SR    RE,RE                                                            
         IC    RE,CELLD            USE RIGHT CELL                               
         LA    RE,TABDATA(RE)      START AT TOTAL COLUMN                        
         LH    R0,NWKSP1                                                        
         LA    R1,GBTOT                                                         
ROWOUT06 L     RF,0(R1)            COMPLEMENT WHATEVER WAS THER                 
         LCR   RF,RF               IN ORDER TO REPLACE IT NOT ADD TO IT         
         A     RF,0(RE)                                                         
         ST    RF,0(R1)                                                         
         AHI   R1,L'TRSCGOL                                                     
         AH    RE,CELLWID                                                       
         BCT   R0,ROWOUT06                                                      
         MVC   GBUFFC,TABCOMM                                                   
         GOTOR BU1PUT              PUT BUFFER 1 RECORD                          
         AH    R2,LROW                                                          
         CLI   TABPRD,0            END                                          
         BNE   ROWOUT02                                                         
ROWOUTX  J     EXIT                                                             
         DROP  R2,RB                                                            
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* PRINT SUPPLY/GOAL BUFFER RECORDS                                    *         
***********************************************************************         
                                                                                
PRTBUF   TM    DIAGNOP1,DPRDSPTQ                                                
         BZR   RE                                                               
PRTBUFN  NTR1  BASE=*,LABEL=*                                                   
         CLI   PBMODE,PBMDRUQ                                                   
         BE    PRTBUF14                                                         
         CLI   PBMODE,PBMDPTQ                                                   
         BNE   PRTBUF02                                                         
         TM    DIAGNOP1,DPRTRESQ                                                
         BZ    PRTBUFX                                                          
         MVC   P1(17),=C'Daypart rescaling'                                     
         MVC   P2(17),DASHES                                                    
         B     PRTBUF04                                                         
PRTBUF02 MVC   P1(18),=C'Supply/Goal BUFFER'                                    
         MVC   P2(18),DASHES                                                    
PRTBUF04 MVI   FORCEHED,YESQ                                                    
         MVI   SPACING,2                                                        
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT                                                           
         MVC   P1+15(L'TOTALL),TOTALL                                           
         MVC   P2+15(L'TOTALL),DASHES                                           
         LHI   R5,1                                                             
         LA    R2,P1+20                                                         
PRTBUF06 EDIT  (R5),(2,5(R2))                                                   
         MVC   L'P1+3(5,R2),DASHES                                              
         AHI   R2,8                                                             
         AHI   R5,1                                                             
         CH    R5,NWKS                                                          
         BH    *+12                                                             
         CHI   R5,14               NO MORE THAN 14 WEEKS                        
         BNH   PRTBUF06                                                         
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT                                                           
         XC    L.GBUFFK,L.GBUFFK                                                
         XC    GBUFFK,GBUFFK                                                    
         GOTOR BU1RDH              READ HIGH BUFFER 1                           
         B     PRTBUF12                                                         
PRTBUF10 GOTOR BU1RSQ              READ SEQUENTIAL BUFFER 1                     
PRTBUF12 BNZ   PRTBUF36                                                         
         CLC   GBUFFK(GBTYP-GBUFFK),L.GBUFFK                                    
         BE    PRTBUF24                                                         
         MVC   L.GBUFFK,GBUFFK                                                  
PRTBUF14 MVI   P1,0                                                             
         MVC   P2(1),GBDPT                                                      
         CLI   GBDPT,ALLDPT                                                     
         BNE   *+8                                                              
         MVI   P2,ASTERISK                                                      
         MVC   P2+1(3),ALL                                                      
         CLI   GBSLN,ALLSLN                                                     
         BE    PRTBUF16                                                         
         EDIT  (B1,GBSLN),(3,P2+1),ALIGN=LEFT                                   
PRTBUF16 CLI   GBPRD,SUPPRD                                                     
         BNE   *+14                                                             
         MVC   P2+5(6),=C'Supply'                                               
         B     PRTBUF22                                                         
         CLI   GBPRD,UNAPRD2                                                    
         BNE   *+14                                                             
         MVC   P2+5(3),=C'Una'                                                  
         B     PRTBUF22                                                         
         CLI   GBPRD,TOTPRD                                                     
         BNE   *+14                                                             
         MVC   P2+5(L'TOTALL),TOTALL                                            
         B     PRTBUF22                                                         
         MVC   P2+5(4),=C'Prd='                                                 
         GOTOR HEXOUT,HEXP,GBPRD,P2+9,1,NOL                                     
         GOTOR (RF),(R1),GBPALPH,P2+12                                          
         MVI   P2+11,SLASH                                                      
         CLI   GBPRI,YESQ                                                       
         BNE   *+8                                                              
         MVI   P2+15,C'P'                                                       
         CLI   PBMODE,PBMDRUQ                                                   
         BE    PRTBUF22                                                         
         TM    REQFLAG1,REQFTRGS                                                
         BZ    PRTBUF20                                                         
         MVC   P2+17(6),=C'Targs='                                              
         SR    R6,R6                                                            
         IC    R6,GBPRD                                                         
         BCTR  R6,0                                                             
         MH    R6,PRDBUFLN                                                      
         A     R6,PRDBUFF                                                       
         AHI   R6,PTTRGS-PTBUFFD                                                
         LA    R4,P2+23                                                         
         LHI   R3,NTGVARS                                                       
PRTBUF18 EDIT  (B1,0(R6)),(2,0(R4)),ZERO=NOBLANK                                
         AHI   R4,3                                                             
         AHI   R6,1                                                             
         BCT   R3,PRTBUF18                                                      
PRTBUF20 GOTOR SETCLS,GBPCLAS                                                   
         BE    PRTBUF22                                                         
         MVC   P2+30(L'CLASSEQL),CLASSEQL                                       
         MVC   P2+36(1),CLASS1                                                  
         BH    PRTBUF22            NO                                           
         MVI   P2+37,COMMA                                                      
         MVC   P2+38(1),CLASS2                                                  
PRTBUF22 MVC   P3(11),DASHES                                                    
         CLI   PBMODE,PBMDRUQ                                                   
         BNE   *+10                                                             
         MVC   P2+40(14),=C'Daypart rollup'                                     
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT                                                           
PRTBUF24 L     R2,ATYPTAB                                                       
PRTBUF26 CLC   GBTYP,0(R2)                                                      
         BE    PRTBUF28                                                         
         CLI   0(R2),FF                                                         
         BE    PRTBUF28                                                         
         AHI   R2,L'TYPTAB                                                      
         B     PRTBUF26                                                         
PRTBUF28 MVC   P1+2(9),1(R2)                                                    
         CLI   GBPRD,SUPPRD                                                     
         BNE   *+10                                                             
         MVC   P1+2(4),SPACES                                                   
         LA    R2,P1+12                                                         
         LA    R4,GBTOT                                                         
         LH    R5,NWKS                                                          
         AHI   R5,1                                                             
         CHI   R5,MAXWKPP          15 WEEKS MAX FOR PRINTOUT                    
         BNH   *+8                                                              
         LHI   R5,MAXWKPP                                                       
PRTBUF30 L     R1,0(R4)                                                         
         MVC   BYTE,GBTYP                                                       
         NI    BYTE,DIGIT                                                       
         CLI   BYTE,X'02'          ROUND DOLLARS                                
         BE    PRTBUF32                                                         
         CLI   GBTYP,TRSCGOLQ      AND RESCALED GOALS (IF DOLLARS)              
         BNE   PRTBUF34                                                         
         CLI   GOALOPT,GOALDOLS                                                 
         BNE   PRTBUF34                                                         
PRTBUF32 A     R1,FW50                                                          
         M     R0,FW1                                                           
         D     R0,FW100                                                         
PRTBUF34 EDIT  (R1),(8,0(R2)),FLOAT=-                                           
         AHI   R2,8                                                             
         AHI   R4,4                                                             
         BCT   R5,PRTBUF30                                                      
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT                                                           
         CLI   PBMODE,PBMDRUQ                                                   
         BE    PRTBUFX                                                          
         B     PRTBUF10                                                         
PRTBUF36 MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT                                                           
PRTBUFX  J     EXIT                                                             
         DROP  RB                                                               
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* PRINT ENVIRONMENT COUNTER TABLES                                    *         
***********************************************************************         
                                                                                
PRTENV   NTR1  BASE=*,LABEL=*                                                   
         TM    PEMODE,PEMPREQ      TEST PRE ALLOC                               
         BZ    *+16                                                             
         TM    DIAGNOP1,DENVBEFQ   YES-TEST TO DO PRE                           
         BZ    PRTENVX                                                          
         B     *+12                                                             
         TM    DIAGNOP1,DENVAFTQ   TEST TO DO POST                              
         BZ    PRTENVX                                                          
         TM    PEMODE,PEMPSTQ      SKIP 'ACTUAL' COUNTS                         
         BNZ   PRTENVX                                                          
                                                                                
PRTENV04 SR    R7,R7               SET ENVIRONMENT POINTER                      
         IC    R7,ENVNO                                                         
         SLL   R7,2                                                             
         L     R7,AENV1SET-L'AENV1SET(R7)                                       
         USING ENVSETD,R7                                                       
         MVI   SPACING,2                                                        
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT                                                           
         MVC   P1(19),=C'Env X counter table'                                   
         MVC   P1+4(1),ENVNO                                                    
         OI    P1+4,ZONE                                                        
         MVC   P2(19),DASHES                                                    
         MVC   P1+21(7),=C'Daypart'                                             
         MVC   P1+29(1),L.GBDPT                                                 
         CLI   L.GBDPT,ALLDPT                                                   
         BNE   *+8                                                              
         MVI   P1+29,ASTERISK                                                   
         MVC   P1+30(L'ALL3),ALL                                                
         CLI   L.GBSLN,ALLSLN                                                   
         BE    PRTENV06                                                         
         EDIT  (B1,L.GBSLN),(3,P1+30),ALIGN=LEFT                                
PRTENV06 MVC   P1+35(11),=C'Pre-alloc  '                                        
         TM    PEMODE,PEMPREQ                                                   
         BNZ   *+10                                                             
         MVC   P1+35(15),=C'Post-alloc     '                                    
         TM    PEMODE,PEMPSTQ                                                   
         BZ    *+10                                                             
         MVC   P1+53(25),=C'**Unequivalenced counts**'                          
PRTENV08 MVI   P3,0                                                             
         L     RE,APRTHD1                                                       
         MVC   P4(L'PRTHD1),0(RE)                                               
         MVC   P5(L'PRTHD2),L'PRTHD1(RE)                                        
         MVC   P6(L'PRTHD3),L'PRTHD1+L'PRTHD2(RE)                               
         LHI   R5,1                                                             
         LA    R2,P5+20                                                         
PRTENV10 EDIT  (R5),(2,4(R2))                                                   
         MVC   L'P1+1(8,R2),DASHES                                              
         AHI   R2,9                                                             
         AHI   R5,1                                                             
         CH    R5,NWKS                                                          
         BH    PRTENV12                                                         
         CHI   R5,MAXWKPP2         NO MORE THAN 12 WEEKS                        
         BNH   PRTENV10                                                         
PRTENV12 MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT                                                           
         OC    ENVSTLEN,ENVSTLEN                                                
         BZ    PRTENVX                                                          
         SR    R2,R2                                                            
         SR    R3,R3                                                            
PRTENV14 L     RE,APRDTRT          PRODUCT/CLASS SEQ + CODE                     
         C     R3,ENVPCNT          TEST A PRODUCT                               
         BL    *+8                                                              
         L     RE,ACLSTRT          OR CLASS                                     
         LR    RF,RE                                                            
         LHI   R0,L'CLSTRT                                                      
PRTENV16 CLM   R3,1,0(RE)                                                       
         BE    *+14                                                             
         AHI   RE,1                                                             
         BCT   R0,PRTENV16                                                      
         DC    H'0'                                                             
         SR    RE,RF                                                            
         STC   RE,P1+9                                                          
         MVI   P1+11,C'C'                                                       
         C     R3,ENVPCNT                                                       
         BNL   PRTENV18                                                         
         STC   RE,BYTE                                                          
         GOTOR HEXOUT,HEXP,BYTE,P1+9,1,NOL                                      
         MVI   P1+11,C'P'                                                       
PRTENV18 EDIT  (R3),(3,P1+5),ZERO=NOBLANK                                       
         LTR   R3,R3               IF PRD DISP = 0, DO ENV CODE + SE            
         BNZ   PRTENV26                                                         
PRTENV20 STH   R2,HALF             ENV CODE AND SEQ                             
         LA    R4,ENVSTTAB                                                      
PRTENV22 CLC   HALF,0(R4)          FIND IN ENTRY                                
         BE    *+12                                                             
         AHI   R4,2                                                             
         B     PRTENV22                                                         
         LA    R0,ENVSTTAB                                                      
         SR    R4,R0                                                            
         SRL   R4,1                                                             
         EDIT  (R4),(3,P1+2)                                                    
         EDIT  (R2),(2,P1+0),ZERO=NOBLANK                                       
                                                                                
PRTENV26 LR    RF,R3               PRINT COUNTERS                               
         MH    RF,ENVPRDD                                                       
         LR    RE,R2                                                            
         MH    RE,ENVENVD                                                       
         LA    R8,0(RF,RE)                                                      
         LR    R6,R8                                                            
                                                                                
         L     RE,ENVSACNT         COUNTS                                       
         L     RF,ENVSASHR         SHARES                                       
         TM    PEMODE,PEMPSTQ                                                   
         BZ    *+12                                                             
         L     RE,ENVSACTC         ACTUAL COUNTS                                
         L     RF,ENVSACNT         AND EQUIV COUNTS                             
         AR    R8,RE                                                            
         AR    R6,RF                                                            
         LA    R4,P1+13                                                         
         LH    R5,NWKS                                                          
         CHI   R5,MAXWKPP2                                                      
         BNH   *+8                                                              
         LHI   R5,MAXWKPP2                                                      
PRTENV28 EDIT  (B2,0(R8)),(4,0(R4))                                             
         OI    3(R4),ZONE                                                       
         MVI   4(R4),SLASH                                                      
         EDIT  (B2,0(R6)),(4,5(R4)),ALIGN=LEFT                                  
         OI    5(R4),ZONE                                                       
         CLC   0(2,R8),0(R6)                                                    
         BNH   PRTENV30                                                         
         LA    RF,5(R4)                                                         
         AR    RF,R0                                                            
         MVI   0(RF),ASTERISK      OVERAGE                                      
PRTENV30 AHI   R4,9                                                             
         AHI   R8,2                                                             
         AHI   R6,2                                                             
         BCT   R5,PRTENV28                                                      
                                                                                
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT                                                           
         AHI   R3,1                NEXT PRODUCT/CLASS                           
         C     R3,ENVTCNT                                                       
         BL    PRTENV14                                                         
*                                  SPOT TOTALS FOR ENV                          
         MVC   P1+2(11),=C'Spot totals'                                         
         LH    R5,NWKSP1                                                        
         LA    R4,P1+13                                                         
         LR    R6,R2                                                            
         MHI   R6,(MAXWEEKS+1)*2                                                
         A     R6,ENVSATOT         POINT TO RIGHT SET                           
PRTENV32 EDIT  (B2,0(R6)),(5,0(R4)),ZERO=NOBLANK                                
         AHI   R4,9                                                             
         AHI   R6,2                                                             
         BCT   R5,PRTENV32                                                      
         MVI   SKIPSPEC,YESQ                                                    
         MVI   SPACING,2                                                        
         GOTOR REPORT                                                           
         SR    R3,R3                                                            
         AHI   R2,1                NEXT ENV CODE                                
         C     R2,ENVSWCNT                                                      
         BL    PRTENV14                                                         
         L     R4,ENVSATAB         A(ENVN TABLE)                                
         MVI   SKIPSPEC,YESQ                                                    
         MVI   SPACING,2                                                        
         GOTOR REPORT                                                           
         MVC   P1(11),=C'Env x table'                                           
         MVC   P1+4(1),ENVNO                                                    
         OI    P1+4,ZONE                                                        
         MVC   P2(11),DASHES                                                    
         GOTOR REPORT                                                           
         LHI   R6,1                R6=COUNTER                                   
                                                                                
         USING ENVTABD,R4                                                       
PRTENV34 CLI   ENVS1KEY,ENVSEOTQ   TEST END OF TABLE                            
         BE    PRTENVX                                                          
         EDIT  (R6),(3,P1+1)                                                    
                                                                                
         CLI   ENVNO,ENVNPGMQ      TEST PROGRAM ENVIRONMENT                     
         BNE   PRTENV36                                                         
         MVC   WORK+2(3),ENVS1STA                                               
         GOTOR MSUNPK,DMCB,(X'80',WORK),DUB,P1+5                                
         CLI   RQMED,NETLETQ                                                    
         BNE   *+8                                                              
         MVI   P1+5+4,SPACE                                                     
         GOTOR CODAY,DMCB,ENVS1DAY,P1+13                                        
         GOTOR UNTIME,DMCB,ENVS1TIM,P1+21                                       
         MVC   P1+33(L'ENVS1PGC),ENVS1PGC                                       
         MVC   P1+40(L'ENVS1PGM),ENVS1PGM                                       
         EDIT  (B2,ENVS1SLP),(5,P1+62),ZERO=NOBLANK                             
         EDIT  (B2,ENVS1SLC),(5,P1+68),ZERO=NOBLANK                             
         AHI   R4,ENVS1LEN                                                      
         B     PRTENV40                                                         
                                                                                
PRTENV36 CLI   ENVNO,ENVNSTAQ      TEST STATION/MARKET ENVIRONMENT              
         BNE   PRTENV38                                                         
         MVC   WORK+2(3),ENVS2STA                                               
         GOTOR MSUNPK,DMCB,(X'80',WORK),DUB,P1+5                                
         CLI   RQMED,NETLETQ                                                    
         BNE   *+8                                                              
         MVI   P1+5+4,SPACE                                                     
         AHI   R4,ENVS2LEN                                                      
         B     PRTENV40                                                         
                                                                                
PRTENV38 CLI   ENVNO,ENVNDOWQ      TEST DAY-OF-WEEK ENVIRONMENT                 
         BNE   PRTENV40                                                         
         GOTOR CODAY,DMCB,ENVS3DAY,P1+5                                         
         MVI   SKIPSPEC,YESQ                                                    
         AHI   R4,ENVS3LEN                                                      
                                                                                
PRTENV40 MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT                                                           
         AHI   R6,1                BUMP COUNT                                   
         B     PRTENV34                                                         
                                                                                
PRTENVX  J     EXIT                                                             
         DROP  R4,R7,RB                                                         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* PRINT SPOT TABLE                                                    *         
***********************************************************************         
                                                                                
PRTSPT   NTR1  BASE=*,LABEL=*                                                   
         TM    DIAGNOP1,DPRDSPTQ                                                
         JZ    EXIT                                                             
         CLI   PSMODE,PSMSINQ                                                   
         BE    PRTSPT12                                                         
         MVC   P1(10),=C'Spot table'                                            
         MVC   P2(10),DASHES                                                    
         MVI   SPACING,2                                                        
         MVI   FORCEHED,YESQ                                                    
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT                                                           
PRTSPT02 L     RE,ASPTHD1                                                       
         MVC   P1,0(RE)                                                         
         MVC   P2(L'SPTHD2),L'SPTHD1(RE)                                        
         MVI   P3,0                                                             
         LA    R2,P4                                                            
         USING SLINED,R2                                                        
         CLI   RQMED,NETLETQ                                                    
         BNE   PRTSPT04                                                         
         EDIT  WAVCOST,(8,SLCOST)                                               
         B     PRTSPT06                                                         
PRTSPT04 EDIT  WAVCOST,(8,SLCOST),2                                             
PRTSPT06 EDIT  WAVBASD,(7,SLBASE),1                                             
         LA    R6,AWKAVGS          TARG AVERAGE 'COSTS'                         
         LA    R4,SLTARG1                                                       
         SR    R3,R3                                                            
         ICM   R3,3,NTARGETS                                                    
         BZ    PRTSPT10                                                         
         CHI   R3,3                                                             
         BNH   *+8                                                              
         LHI   R3,3                ONLY 3                                       
PRTSPT08 EDIT  (B4,0(R6)),(7,0(R4)),2                                           
         AHI   R6,L'AWKAVGS                                                     
         AHI   R4,SLTARG2-SLTARG1                                               
         BCT   R3,PRTSPT08                                                      
PRTSPT10 MVC   SLDPT(19),=C'**Averages/Ratios**'                                
         MVI   SPACING,2                                                        
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT                                                           
PRTSPT12 LA    R5,W                                                             
         USING SBUFFRD,R5                                                       
         CLI   PSMODE,PSMSPTQ                                                   
         BNE   PRTSPT14                                                         
         L     R5,ASPTTAB                                                       
         CLI   0(R5),FF            TEST NONE                                    
         BE    PRTSPTX                                                          
         B     PRTSPT20                                                         
PRTSPT14 CLI   PSMODE,PSMSINQ                                                   
         BE    PRTSPT20                                                         
         XC    SBUFFRD(SBTOTLN),SBUFFRD                                         
         MVI   SBDPT,0                                                          
         GOTOR BU2RDH              READ HIGH BUFFER 2                           
         B     PRTSPT18                                                         
PRTSPT16 GOTOR BU2RSQ              READ SEQUENTIAL BUFFER 2                     
PRTSPT18 BNZ   PRTSPTX                                                          
         CLI   SBRTYP,SBRTYPQ      TEST UNIT RECORD                             
         BNE   PRTSPT16                                                         
PRTSPT20 LA    R2,P1                                                            
         MVC   SLDPT,SBDPT                                                      
         CLI   SBDPT,ALLDPT                                                     
         BNE   *+8                                                              
         MVI   SLDPT,ASTERISK                                                   
         MVC   SLSLN,ALL                                                        
         CLI   SBSLN,ALLSLN                                                     
         BE    PRTSPT22                                                         
         EDIT  (B1,SBSLN),(3,SLSLN),ALIGN=LEFT                                  
PRTSPT22 EDIT  (B1,SBWK),(2,SLWK)                                               
         EDIT  (B2,SBLIN),(3,SLLIN)                                             
         EDIT  (B1,SBSEQ),(3,SLSEQ)                                             
         EDIT  (B2,SBENV1),(3,SLENV1)                                           
         EDIT  (B2,SBENV2),(3,SLENV2)                                           
         EDIT  (B2,SBENV3),(3,SLENV3)                                           
         EDIT  (B1,SBPDLEN),(3,SLPDLEN)                                         
         EDIT  (B1,SBUNLEN),(3,SLUNLEN)                                         
         GOTOR HEXOUT,HEXP,SBDA,SLDA,4,NOL                                      
         GOTOR (RF),(R1),SBDAY,SLDAY,1                                          
         GOTOR (RF),(R1),SBSTAT,SLSTAT,2                                        
         GOTOR DATCON,DMCB,(2,SBDATE),(4,SLDATE)                                
         EDIT  (B1,SBSPTNO),(2,SLSPTNO)                                         
         GOTOR FRMPRD,DMCB,SBPRD1,SLALLOC+(L'P1*0)                              
         GOTOR FRMPRD,DMCB,SBPRD2,SLALLOC+(L'P1*0)+7                            
         CLI   RQMED,NETLETQ                                                    
         BNE   PRTSPT28                                                         
         EDIT  (B4,SBCOST),(8,SLCOST)                                           
         B     PRTSPT30                                                         
PRTSPT28 EDIT  (B4,SBCOST),(8,SLCOST),2                                         
PRTSPT30 EDIT  (B4,SBCDEM),(7,SLBASE),1                                         
         ICM   R1,15,SBCOST        CPM                                          
         M     R0,CPPROUND                                                      
         ICM   RF,15,SBCDEM                                                     
         GOTOR DIVIDE                                                           
         EDIT  (R1),(7,SLBASE+L'P1),2                                           
         TM    REQFLAG1,REQFTRGS                                                
         BZ    PRTSPT42                                                         
         SR    R3,R3                                                            
         ICM   R3,3,NTARGETS                                                    
         BZ    PRTSPT42                                                         
         CHI   R3,3                                                             
         BNH   *+8                                                              
         LHI   R3,3                ONLY 3 PRINT HERE                            
         LA    R4,SBTARGS                                                       
         LA    R6,SLTARG1                                                       
PRTSPT34 EDIT  (B4,0(R4)),(7,0(R6)),1                                           
         CLI   TRGBASE,GOALDOLS                                                 
         BNE   PRTSPT38                                                         
         ICM   R1,15,SBCOST                                                     
         M     R0,CPPROUND                                                      
         B     PRTSPT40                                                         
PRTSPT38 ICM   R1,15,SBCDEM                                                     
         M     R0,FW100                                                         
PRTSPT40 L     RF,0(R4)                                                         
         GOTOR DIVIDE                                                           
         EDIT  (R1),(7,L'P1(R6)),2                                              
         AHI   R4,L'SBTARGS                                                     
         AHI   R6,8                                                             
         BCT   R3,PRTSPT34                                                      
PRTSPT42 GOTOR MSUNPK,DMCB,(X'80',SBSTA-2),WORK,SLSTA                           
         CLI   RQMED,NETLETQ                                                    
         BNE   *+8                                                              
         MVI   SLSTA+4,SPACE                                                    
         SR    R0,R0                                                            
         IC    R0,SBEST                                                         
         CVD   R0,DUB                                                           
         OI    DUB+L'DUB-1,DIGIT                                                
         UNPK  SLEST,DUB                                                        
         MVI   SKIPSPEC,YESQ                                                    
         MVI   SPACING,2                                                        
         GOTOR REPORT                                                           
                                                                                
         CLI   PSMODE,PSMSINQ                                                   
         BE    PRTSPTX                                                          
         CLI   PSMODE,PSMSPTQ                                                   
         BNE   PRTSPT16                                                         
         A     R5,SPTTABL                                                       
         CLI   0(R5),FF                                                         
         BNE   PRTSPT20                                                         
PRTSPTX  J     EXIT                                                             
         DROP  R2,RB                                                            
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* PRINT SPOT VARIABLE ANALYSIS                                        *         
***********************************************************************         
                                                                                
PRTVAR   TM    DIAGNOP1,DPRTVARQ                                                
         BZR   RE                                                               
PRTVARN  NTR1  BASE=*,LABEL=*                                                   
         LHI   R1,DSUPSTRQ         SPOT PHASE                                   
         CLI   ALPHASE,ALPSPTQ                                                  
         BE    PRTVAR02                                                         
         LHI   R1,DSUPBTRQ         BRAND PHASE                                  
         CLI   ALPHASE,ALPBRDQ                                                  
         BE    PRTVAR02                                                         
         LHI   R1,DSUPXTRQ         EXCH PHASE                                   
PRTVAR02 EX    R1,*+8              TEST TO SUPPRESS TRACE                       
         BNZ   PRTVARX                                                          
         TM    DIAGNOP2,0                                                       
         CLI   PVMODE2,PVMODE2Q    DOING ONE ITEM - NOT HEADS                   
         BE    PRTVAR50                                                         
PRTVAR04 MVC   P1,SPACES                                                        
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT                                                           
         MVC   P1(14),=C'Product status'                                        
         MVC   P2(14),DASHES                                                    
         MVC   P1+17(8),=C'Daypart='                                            
         MVC   P1+25(1),L.GBDPT                                                 
         CLI   P1+25,ALLDPT                                                     
         BNE   *+8                                                              
         MVI   P1+25,ASTERISK                                                   
         MVC   P1+26(3),ALL                                                     
         CLI   L.GBSLN,ALLSLN                                                   
         BE    PRTVAR06                                                         
         EDIT  (B1,L.GBSLN),(3,P1+26),ALIGN=LEFT                                
PRTVAR06 MVC   P1+30(L'WEEKL),WEEKL                                             
         MVI   P1+30+L'WEEKL,EQUAL                                              
         EDIT  (B1,WEEKNO),(2,P1+35)                                            
         MVC   P1+38(6),=C'CPP/M='                                              
         L     R1,WKCPD                                                         
         CLI   ZSPASS,ZSPYESQ                                                   
         BNE   *+8                                                              
         L     R1,AWKNZCPD                                                      
         EDIT  (R1),(7,P1+45),2                                                 
         MVC   P1+55(15),=C'Zero spot pass='                                    
         MVC   P1+70(1),ZSPASS                                                  
         CLI   PVMODE1,ALPSPTQ                                                  
         BNE   PRTVAR08                                                         
         MVC   P1+75(24),=C'**Spot selection phase**'                           
         B     PRTVAR10                                                         
PRTVAR08 CLI   PVMODE1,ALPBRDQ                                                  
         BNE   *+14                                                             
         MVC   P1+75(25),=C'**Brand selection phase**'                          
         B     PRTVAR10                                                         
         CLI   PVMODE1,ALPXCHQ                                                  
         BNE   *+10                                                             
         MVC   P1+75(24),=C'**Brand exchange phase**'                           
PRTVAR10 L     RE,AVARHD1                                                       
         MVC   P3(L'VARHD1),0(RE)                                               
         MVC   P4(L'VARHD2),L'VARHD1(RE)                                        
         MVC   P5(L'VARHD3),L'VARHD1+L'VARHD2(RE)                               
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT                                                           
         L     R2,AFSTBRD                                                       
         USING TABD,R2                                                          
PRTVAR12 GOTOR HEXOUT,HEXP,TABPRD,P1+0,L'TABPRD,NOL                             
         LA    R0,TABD                                                          
         C     R0,BESTPRD                                                       
         BNE   PRTVAR14                                                         
         CLI   PVMODE1,ALPSPTQ                                                  
         BNE   PRTVAR14                                                         
         MVI   P1+2,ASTERISK                                                    
PRTVAR14 CLI   TABPRI,YESQ                                                      
         BNE   *+8                                                              
         MVI   P1+3,C'P'                                                        
         GOTOR SETCLS,TABPRDC                                                   
         BE    PRTVAR16                                                         
         MVC   P1+4(1),CLASS1                                                   
         MVC   P1+5(1),CLASS2                                                   
PRTVAR16 MVI   P1+7,ASTERISK                                                    
         CLI   TABSLN,ALLSLN          ALL SLN'S TOGETHER                        
         BE    PRTVAR18                                                         
         SR    R0,R0                                                            
         IC    R0,TABSLN                                                        
         EDIT  (R0),(2,P1+7)          SLN                                       
PRTVAR18 LA    R4,P1+10                                                         
         SR    R6,R6                                                            
         IC    R6,TABPRD                                                        
         BCTR  R6,0                                                             
         MH    R6,PRDBUFLN                                                      
         A     R6,PRDBUFF                                                       
         AHI   R6,PTTRGS-PTBUFFD                                                
         LHI   R3,NTGVARS                                                       
PRTVAR20 EDIT  (B1,0(R6)),(2,0(R4))                                             
         AHI   R4,2                                                             
         AHI   R6,1                                                             
         BCT   R3,PRTVAR20                                                      
                                                                                
PRTVAR22 LA    R5,P1+14                                                         
         LHI   R6,3                                                             
         LA    R4,TRSCGOL-TABD(R2)                                              
         GOTOR PVEDIT                                                           
         LR    R4,R2                                                            
         AH    R4,WKDISP                                                        
         LHI   R6,5                                                             
         GOTOR PVEDIT                                                           
         L     R4,TABROLL                                                       
         EDIT  (R4),(9,0(R5)),FLOAT=- ROLL-UP                                   
         AHI   R5,9                                                             
         L     R4,TABGOAL                                                       
         EDIT  (R4),(9,0(R5)),FLOAT=- NEW GOAL                                  
         AHI   R5,9                                                             
         LR    R4,R2               CPP/M                                        
         AH    R4,WKDISP                                                        
         L     R1,8(R4)                                                         
         M     R0,CPPROUND                                                      
         L     RF,4(R4)                                                         
         GOTOR DIVIDE                                                           
         EDIT  (R1),(9,1(R5)),2                                                 
         AHI   R5,10                                                            
         TM    REQFLAG1,REQFTRGS   TARGETS                                      
         BZ    PRTVAR28                                                         
         CLI   TABPRD,UNAPRD2                                                   
         BNL   PRTVAR28                                                         
         SR    R4,R4                                                            
         IC    R4,TABPRD                                                        
         BCTR  R4,0                                                             
         MH    R4,PRDBUFLN                                                      
         A     R4,PRDBUFF                                                       
         AHI   R4,PTTRGS-PTBUFFD                                                
         LHI   R3,2                                                             
PRTVAR24 SR    RF,RF                                                            
         ICM   RF,1,0(R4)                                                       
         BZ    PRTVAR26                                                         
         SLL   RF,2                                                             
         AR    RF,R2                                                            
         AH    RF,WKDISP                                                        
         L     R1,TABTA1-L'TABTA1-TABDATA(RF)                                   
         EDIT  (R1),(9,0(R5)),ZERO=NOBLANK                                      
PRTVAR26 AHI   R4,1                                                             
         AHI   R5,9                                                             
         BCT   R3,PRTVAR24                                                      
PRTVAR28 MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT                                                           
PRTVAR30 AH    R2,LROW                                                          
         CLI   TABPRD,0                                                         
         BNE   PRTVAR12                                                         
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT                                                           
         CLI   PVMODE1,ALPSPTQ                                                  
         BNE   PRTVAR34                                                         
PRTVAR32 MVC   P2(24),=C'Statn Est Lin Seq  Alloc'                              
         MVC   P3(24),=C'----- --- --- ---  -----'                              
         B     PRTVAR40                                                         
PRTVAR34 CLI   PVMODE1,ALPBRDQ                                                  
         BNE   PRTVAR40                                                         
         MVC   P1(5),=C'Spot='                                                  
         L     R5,THISSPT                                                       
         GOTOR MSUNPK,DMCB,(X'80',SBSTA-2),WORK,P1+6                            
         CLI   RQMED,NETLETQ                                                    
         BNE   *+8                                                              
         MVI   P1+6+4,SPACE                                                     
         SR    R0,R0                                                            
         IC    R0,SBEST                                                         
         CVD   R0,DUB                                                           
         OI    DUB+L'DUB-1,DIGIT                                                
         UNPK  P1+12(3),DUB                                                     
         EDIT  (B2,SBLIN),(3,P1+16)                                             
         EDIT  (B1,SBSEQ),(3,P1+20)                                             
         MVI   P1+19,DASH                                                       
         LA    RF,SBCOST                                                        
         CLI   TRGBASE,GOALDOLS                                                 
         BE    *+8                                                              
         LA    RF,SBCDEM                                                        
         OC    0(4,RF),0(RF)                                                    
         BNZ   *+8                                                              
         MVI   P2+19,C'Z'          ZERO SPOT                                    
         MVC   P2(6),=C'Alloc='    FORMAT CURRENT ALLOCATIONS (6)               
         GOTOR FRMPRD,DMCB,SBPRD1,P2+6+(7*0)                                    
         GOTOR FRMPRD,DMCB,SBPRD2,P2+6+(7*1)                                    
                                                                                
PRTVAR40 LA    R4,P1+52                                                         
         L     R5,AVARHDS                                                       
         LHI   R6,VARWGTSN                                                      
PRTVAR42 MVC   000(8,R4),00(R5)                                                 
         MVC   L'P1(8,R4),08(R5)                                                
         MVC   L'P1*2(8,R4),16(R5)                                              
         AHI   R5,L'VARHDS                                                      
         AHI   R4,8                                                             
         BCT   R6,PRTVAR42                                                      
         L     RE,AVARHSUM                                                      
         MVC   000(8,R4),0(RE)                                                  
         MVC   L'P1(8,R4),8(RE)                                                 
         MVC   L'P1*2(8,R4),16(RE)                                              
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT                                                           
PRTVAR46 MVC   P1(6),=C'Status'                                                 
         MVC   P2(6),=C'Weight'                                                 
         LA    R6,P1+52                                                         
         LA    R3,VARWGTS                                                       
         LHI   R2,VARWGTSN                                                      
PRTVAR48 CLI   VARCTLD(R3),0       TEST NO-OPED                                 
         BE    *+10                                                             
         MVC   000+3(5,R6),=C'No-op'                                            
         L     R1,0(R3)            WEIGHT                                       
         EDIT  (R1),(8,L'P1(R6)),FLOAT=-                                        
         OI    L'P1+7(R6),ZONE                                                  
         AHI   R3,L'VARWGTS                                                     
         AHI   R6,8                                                             
         BCT   R2,PRTVAR48                                                      
         MVI   SKIPSPEC,YESQ                                                    
         MVI   SPACING,2                                                        
         GOTOR REPORT                                                           
         B     PRTVARX                                                          
*                                  DETAIL LINE                                  
PRTVAR50 CLI   PVMODE1,ALPSPTQ     SPOT PHASE                                   
         BE    PRTVAR70                                                         
         CLI   PVMODE1,ALPXCHQ     EXCHANGE PHASE                               
         BE    PRTVAR60                                                         
         L     R3,THISPRD          BRAND PHASE                                  
         MVC   P1+3(2),=C'P1='                                                  
         GOTOR HEXOUT,HEXP,TABPRD,P1+5,L'TABPRD,NOL                             
         MVI   P1+7,DASH                                                        
         SR    R0,R0                                                            
         IC    R0,TABSLN                                                        
         EDIT  (R0),(3,P1+8)                                                    
         C     R3,BESTPRD                                                       
         BNE   *+8                                                              
         MVI   P1+11,ASTERISK                                                   
         L     R5,THISSPT                                                       
         TM    SBSTAT,SBSPRRJQ                                                  
         BZ    *+14                                                             
         MVC   P1+13(3),=C'Pri'    PRIORITY REJECT                              
         B     PRTVAR56                                                         
         TM    SBSTAT,SBSEXRJQ                                                  
         BZ    *+14                                                             
         MVC   P1+13(4),=C'Excl'   EXCL REJECT                                  
         B     PRTVAR56                                                         
         TM    SBSTAT,SBSENRJQ     ENV REJECT                                   
         BZ    *+14                                                             
         MVC   P1+13(3),=C'Env'                                                 
         B     PRTVAR56                                                         
PRTVAR52 LA    R4,VARVALS                                                       
         LA    R2,P1+52                                                         
         LHI   R6,VARWGTSN                                                      
PRTVAR54 EDIT  (B4,0(R4)),(8,0(R2)),FLOAT=-                                     
         OI    7(R2),ZONE                                                       
         AHI   R4,4                                                             
         AHI   R2,8                                                             
         BCT   R6,PRTVAR54                                                      
         CLC   BRDVAL,MAXNEG                                                    
         BNE   *+14                                                             
         MVC   5(3,R2),DASHES                                                   
         B     PRTVAR56                                                         
         EDIT  (B4,BRDVAL),(8,0(R2)),FLOAT=-                                    
         OI    7(R2),ZONE                                                       
PRTVAR56 MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT                                                           
         B     PRTVARX                                                          
                                                                                
PRTVAR60 MVC   P1(2),=C'A='        SWAP PRINT                                   
         L     R5,SPOTA                                                         
         L     R4,SLOTA                                                         
         LA    R6,P1+2                                                          
         GOTOR PVSVAL                                                           
         MVC   P1+27(2),=C'B='                                                  
         L     R5,SPOTB                                                         
         L     R4,SLOTB                                                         
         LA    R6,P1+29                                                         
         GOTOR PVSVAL                                                           
         MVC   P1+54(4),=C'Val='                                                
         EDIT  (B4,CURVAL),(8,P1+58),FLOAT=-                                    
         OI    P1+65,ZONE                                                       
         MVC   P1+67(5),=C'Exch='                                               
         CLC   NEWVAL,MAXNEG                                                    
         BNE   *+14                                                             
         MVC   P1+72(6),=C'Reject'                                              
         B     PRTVAR68                                                         
         EDIT  (B4,NEWVAL),(8,P1+72),FLOAT=-                                    
         OI    P1+79,ZONE                                                       
         L     RF,CURVAL                                                        
         C     RF,NEWVAL                                                        
         BH    *+8                                                              
         MVI   P1+80,ASTERISK      SWAP HAS HAPPENED                            
PRTVAR62 TM    DIAGNOP1,DPRTCMPQ   TEST FULL PRINT                              
         BZ    PRTVAR68                                                         
         MVC   P2+9(2),=C'AA'                                                   
         MVC   P3+9(2),=C'BB'                                                   
         MVC   P4+9(2),=C'AB'                                                   
         MVC   P5+9(2),=C'BA'                                                   
         LA    R4,SWAPS                                                         
         LHI   R3,SWAPSN                                                        
         LA    R2,P2+42                                                         
PRTVAR64 LHI   R7,SWAPN                                                         
         LR    R6,R2                                                            
PRTVAR66 EDIT  (B4,0(R4)),(8,0(R6)),FLOAT=-                                     
         OI    7(R6),ZONE                                                       
         AHI   R6,8                                                             
         AHI   R4,4                                                             
         BCT   R7,PRTVAR66                                                      
         AHI   R2,L'P1                                                          
         BCT   R3,PRTVAR64                                                      
PRTVAR68 MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT                                                           
         L     RF,CURVAL           AFTER SWAP                                   
         C     RF,NEWVAL                                                        
         BL    PRTVAR04            PRINT PRODUCT TABLE                          
         B     PRTVARX                                                          
                                                                                
PRTVAR70 L     R5,THISSPT          SPOT PHASE                                   
         USING SBUFFRD,R5                                                       
         CLI   SBUNLEN,0           SKIP ALREADY COMPLETELY ALLOCATED            
         BE    PRTVARX                                                          
         TM    SBSTAT,SBSZPRJQ     ZERO PASS REJECT                             
         BNZ   PRTVARX             SKIP                                         
         GOTOR MSUNPK,DMCB,(X'80',SBSTA-2),WORK,P1                              
         CLI   RQMED,NETLETQ                                                    
         BNE   *+8                                                              
         MVI   P1+4,SPACE                                                       
         SR    R0,R0                                                            
         IC    R0,SBEST                                                         
         CVD   R0,DUB                                                           
         OI    DUB+L'DUB-1,DIGIT                                                
         UNPK  P1+6(3),DUB                                                      
         EDIT  (B2,SBLIN),(3,P1+10)                                             
         EDIT  (B1,SBSEQ),(3,P1+14)                                             
         GOTOR FRMPRD,DMCB,SBPRD1,P1+19+(7*0)                                   
         GOTOR FRMPRD,DMCB,SBPRD2,P1+19+(7*1)                                   
         C     R5,BESTSPT                                                       
         BNE   *+8                                                              
         MVI   P1+17,ASTERISK      FLAG IF BEST SO FAR                          
         TM    SBSTAT,SBSEXRJQ     TEST ANY EXCLUSION                           
         BZ    *+12                                                             
         MVI   P1+17,C'X'                                                       
         B     PRTVAR78                                                         
         TM    SBSTAT,SBSPRRJQ     PRIORITY REJECT                              
         BZ    *+12                                                             
         MVI   P1+17,C'P'                                                       
         B     PRTVAR78                                                         
         TM    SBSTAT,SBSENRJQ     ENV REJECT                                   
         BZ    *+12                                                             
         MVI   P1+17,C'E'                                                       
         B     PRTVAR78                                                         
         LA    R6,P1+52                                                         
         LA    R2,VARWGTS                                                       
         LA    R3,VARVALS                                                       
         LHI   R4,VARWGTSN                                                      
PRTVAR76 EDIT  (B4,0(R3)),(8,0(R6)),FLOAT=-   VARIABLE                          
         OI    7(R6),ZONE                                                       
         AHI   R2,L'VARWGTS                   NEXT VARIABLE                     
         AHI   R3,L'VARVALS                                                     
         AHI   R6,8                                                             
         BCT   R4,PRTVAR76                                                      
         EDIT  (B4,SPTVAL),(8,0(R6)),FLOAT=-  WGT SUM                           
PRTVAR78 MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT                                                           
PRTVARX  J     EXIT                                                             
         EJECT                                                                  
PVEDIT   EDIT  (B4,0(R4)),(9,0(R5)),FLOAT=-                                     
         OI    8(R5),ZONE                                                       
         AHI   R4,4                                                             
         AHI   R5,9                                                             
         BCT   R6,PVEDIT                                                        
         BR    RE                                                               
                                                                                
PVSVAL   NTR1  ,                                                                
         GOTOR MSUNPK,DMCB,(X'80',SBSTA-2),WORK,0(R6)                           
         CLI   RQMED,NETLETQ                                                    
         BNE   *+8                                                              
         MVI   4(R6),SPACE                                                      
         SR    R0,R0                                                            
         IC    R0,SBEST                                                         
         CVD   R0,DUB                                                           
         OI    DUB+L'DUB-1,DIGIT                                                
         UNPK  5(3,R6),DUB                                                      
         MVI   9(R6),DASH                                                       
         ICM   R0,3,SBLIN                                                       
         CVD   R0,DUB                                                           
         OI    DUB+L'DUB-1,DIGIT                                                
         UNPK  10(2,R6),DUB                                                     
         XR    R0,R0                                                            
         IC    R0,SBSEQ                                                         
         CVD   R0,DUB                                                           
         OI    DUB+L'DUB-1,DIGIT                                                
         UNPK  13(3,R6),DUB                                                     
         MVI   18(R6),OPAREN       PRODUCT AND LEN OF SLOT                      
         MVI   23(R6),CPAREN                                                    
         GOTOR HEXOUT,HEXP,0(R4),19(R6),2,NOL                                   
         LA    RF,SBCOST                                                        
         CLI   TRGBASE,GOALDOLS                                                 
         BE    *+8                                                              
         LA    RF,SBCDEM                                                        
         OC    0(4,RF),0(RF)                                                    
         BNZ   *+8                                                              
         MVI   17(R6),C'Z'         ZERO SPOT                                    
PVSVALX  J     EXIT                                                             
         DROP  R2,R5,RB                                                         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* DO THE ALLOCATION                                                   *         
***********************************************************************         
                                                                                
ALLOC    NTR1  BASE=*,LABEL=*                                                   
         LH    RF,NTARGETS         SET 'CELL WIDTH'                             
         SLL   RF,2                NO. OF TARGETS* 4                            
         AHI   RF,TABTA1-TABDATA   PLUS DISP TO START OF TARGS                  
         STH   RF,CELLWID          =CELL WIDTH                                  
         LH    RF,NWKSP1                                                        
         MH    RF,CELLWID                                                       
         AHI   RF,TABDATA-TABD                                                  
         STH   RF,LROW             LENGTH OF ROW                                
         A     RF,ASUPROW                                                       
         ST    RF,ATOTROW          TOTAL ROW                                    
         AH    RF,LROW                                                          
         ST    RF,AFSTBRD          1ST BRAND                                    
         GOTOR CLRBRD              CLEAR BRDTAB TO BINARY ZEROES                
         MVC   GBUFFK,L.GBUFFK     START OF DPT/SLN                             
         GOTOR BU1RDH              READ HIGH BUFFER 1                           
         B     ALLOC04                                                          
ALLOC02  GOTOR BU1RSQ              READ SEQUENTIAL BUFFER 1                     
ALLOC04  BZ    *+12                                                             
         MVI   GBDPT,FF                                                         
         B     *+14                                                             
         OC    GBROW(GBROWL),GBROW SKIP IF NO DATA                              
         BZ    ALLOC02                                                          
         CLC   GBDPT,L.GBDPT                                                    
         BNE   ALLOC16                                                          
         CLC   GBSLN,L.GBSLN                                                    
         BNE   ALLOC16                                                          
         CLI   GBPRD,SUPPRD        TEST SUPPLY                                  
         BNE   ALLOC10                                                          
         SR    RF,RF                                                            
         IC    RF,GBTYP            LINE UP OTHER SUPPLY CODES                   
         CLI   GBTYP,TPRET00Q      EXCEPT FOR TARGETS                           
         BH    ALLOC08                                                          
         AHI   RF,TACHDEMQ-TPREDEMQ                                             
         STC   RF,GBTYP                                                         
         B     ALLOC10                                                          
*                                  FOR TARGS -LINE UP                           
ALLOC08  SHI   RF,TACHT00Q-TPRET00Q                                             
         STC   RF,GBTYP                                                         
ALLOC10  MVI   CELLD,TRSCGOL-TABDATA                                            
         CLI   GBTYP,TRSCGOLQ      RESCALED GOALS  (+0)                         
         BE    ALLOC14                                                          
         CLI   GBPRD,FF            SKIP TOTALS FOR PRE-ALLOCS                   
         BE    ALLOC02                                                          
         MVI   CELLD,TPREDEM-TABDATA                                            
         CLI   GBTYP,TPREDEMQ      ACHIEVED RATINGS  (+4)                       
         BE    ALLOC14                                                          
         MVI   CELLD,TPREDOL-TABDATA                                            
         CLI   GBTYP,TPREDOLQ      ACHIEVED DOLLARS  (+8)                       
         BE    ALLOC14                                                          
         MVI   CELLD,TPREUNT-TABDATA                                            
         CLI   GBTYP,TPREUNTQ      ACH SPOTS         (+12)                      
         BE    ALLOC14                                                          
         CLI   GBTYP,TPRET01Q      TARGET PRE-ALLOCS                            
         BL    ALLOC02                                                          
         CLI   GBTYP,TACHT00Q                                                   
         BH    ALLOC02                                                          
         SR    RF,RF                                                            
         IC    RF,GBTYP                                                         
         SHI   RF,TPRET01Q                                                      
         SLL   RF,2                                                             
         AHI   RF,TABTA1-TABDATA   START OF TARGS                               
         STC   RF,CELLD                                                         
ALLOC14  GOTOR ROWIN                                                            
         B     ALLOC02                                                          
*                                  SET TOTAL REMAINDERS AT +16                  
ALLOC16  L     R3,ATOTROW          START WITH TOTAL ROW                         
         USING TABD,R3                                                          
         L     R4,AFSTBRD          FIRST SET TOTAL ROW 'KEY'                    
         MVC   TABKEY(TABVALL),TABKEY-TABD(R4)                                  
         MVI   TABPRD,FF                                                        
         MVI   TABPRDA,FF                                                       
         MVI   TABPRI,NOQ                                                       
         MVI   TABPRDC,0                                                        
ALLOC18  CLI   TABPRD,0                                                         
         BE    ALLOC26                                                          
         CLI   TABPRD,UNAPRD2      FOR UNA                                      
         BNE   *+8                                                              
         MVI   TABPRDC,0           NO CLASS                                     
         L     RF,TRSCGOL          RESCALED GOAL                                
         L     R0,TPREDOL          LESS EITHER DOLLARS                          
         CLI   GOALOPT,GOALDOLS                                                 
         BE    ALLOC20                                                          
         L     R0,TPREDEM          OR DEMO VALUE                                
         TM    REQFLAG1,REQFMIXB   IF MIXED GOAL BASIS                          
         BZ    ALLOC20                                                          
         SR    RE,RE                                                            
         ICM   RE,1,TABGLDEM                                                    
         BZ    ALLOC20             AND BRAND DEMO NOT = CORP                    
         SLL   RE,2                                                             
         L     R0,TABTA1-L'TABTA1(RE)                                           
ALLOC20  SR    RF,R0                                                            
         ST    RF,TSAVDEM          SET REMAINDER                                
         MVI   TABACTWK,0          COUNT ACTIVE WEEKS FOR BRAND                 
         LH    R4,CELLWID                                                       
         LH    R7,NWKS                                                          
ALLOC22  L     RF,TRSCGOL(R4)                                                   
         LTR   RF,RF                                                            
         BZ    ALLOC24                                                          
         SR    RF,RF                                                            
         IC    RF,TABACTWK                                                      
         AHI   RF,1                                                             
         STC   RF,TABACTWK                                                      
ALLOC24  AH    R4,CELLWID          NEXT WEEK                                    
         BCT   R7,ALLOC22                                                       
         AH    R3,LROW             NEXT PRODUCT                                 
         B     ALLOC18                                                          
                                                                                
ALLOC26  GOTOR SETENV,TABD         SET ENVIRONMENT TABLES                       
                                                                                
         LHI   R2,1                DO ALLOCS ONE WEEK AT A TIME                 
ALLOC30  STC   R2,WEEKNO                                                        
         LR    RF,R2                                                            
         MH    RF,CELLWID                                                       
         AHI   RF,TABDATA-TABD                                                  
         STH   RF,WKDISP                                                        
                                                                                
***********************************************************************         
* ADJUST FOR ROLL-UPS FROM PREVIOUS WEEK AND RESCALE AJDUSTED GOALS - *         
* SET IN TABGOAL AND SET REMAINDERS AT +16                            *         
***********************************************************************         
                                                                                
         XC    FULL,FULL                                                        
         L     R3,AFSTBRD                                                       
ALLOC32  CLI   TABPRD,0                                                         
         BE    ALLOC38                                                          
         XC    TABGOAL,TABGOAL                                                  
         LR    R5,R3                                                            
         AH    R5,WKDISP                                                        
         OC    0(4,R5),0(R5)       SKIP IF NOT ACTIVE IN WEEK                   
         BZ    ALLOC36                                                          
         L     RF,TABROLL                                                       
         LTR   RF,RF                                                            
         BNM   ALLOC34             JUST ADD A NON-NEG ROLL-UP                   
         L     R0,0(R5)            DON'T REDUCE GOAL BY MORE THAN HALF          
         LPR   RE,RF                                                            
         SLL   RE,1                                                             
         CR    RE,R0                                                            
         BNH   ALLOC34                                                          
         LCR   RF,R0                                                            
         SRA   RF,1                                                             
ALLOC34  A     RF,0(R5)                                                         
         ST    RF,TABGOAL                                                       
         A     RF,FULL             CUME ADJUSTED GOALS                          
         ST    RF,FULL                                                          
ALLOC36  AH    R3,LROW             NEXT PRODUCT                                 
         B     ALLOC32                                                          
ALLOC38  L     RF,ATOTROW          NOW RESCALE ADJUSTED GOALS                   
         AH    RF,WKDISP                                                        
         L     R1,0(RF)            TOTAL OF ORIG RESCALED GOALS                 
         M     R0,FW10000                                                       
         L     RF,FULL                                                          
         GOTOR DIVIDE                                                           
         ST    R1,FACTOR1          RESCALING FACTOR                             
         L     R3,AFSTBRD                                                       
ALLOC40  CLI   TABPRD,0                                                         
         BE    ALLOC48                                                          
         LR    R5,R3                                                            
         AH    R5,WKDISP                                                        
         OC    0(4,R5),0(R5)       SKIP IF NOT ACTIVE                           
         BZ    ALLOC46                                                          
         L     R1,TABGOAL                                                       
         TM    REQFLAG1,REQFMIXB   DON'T RESCALE IF MIXED GOALS                 
         BNZ   ALLOC42                                                          
         M     R0,FACTOR1                                                       
         L     RF,FW10000                                                       
         GOTOR DIVIDE                                                           
         ST    R1,TABGOAL                                                       
ALLOC42  L     R0,8(R5)            LESS ACH                                     
         CLI   GOALOPT,GOALDOLS    DOLLARS                                      
         BE    ALLOC44                                                          
         L     R0,4(R5)            OR DEMO                                      
         TM    REQFLAG1,REQFMIXB   IF MIXED DEMO GOALS                          
         BZ    ALLOC44                                                          
         SR    RE,RE                                                            
         ICM   RE,1,TABGLDEM                                                    
         BZ    ALLOC44             AND BRAND DEMO NOT = CORP                    
         BCTR  RE,0                                                             
         SLL   RE,2                                                             
         L     R0,TABTA1-TABDATA(R5,RE) USE BRAND DEMO                          
ALLOC44  SR    R1,R0                                                            
         ST    R1,16(R5)           = REMAINDER FOR WEEK                         
ALLOC46  AH    R3,LROW             NEXT PRODUCT                                 
         B     ALLOC40                                                          
ALLOC48  GOTOR ALWEEK              DO ALLOC FOR THIS WEEK                       
         MVC   WORK(L'KEY),KEY     DO AN IO TO INTERRUPT                        
         XC    KEY,KEY             THE CPU TIMER                                
         GOTOR HIGH                TO PREVENT SPURIOUS LOOP DUMPS               
         MVC   KEY,WORK                                                         
         GOTOR HIGH                                                             
                                                                                
***********************************************************************         
* FIRST RE-COMPUTE CUMULATIVE REMAINDER FOR THIS WEEK                 *         
***********************************************************************         
                                                                                
ALLOC50  CLI   RSWKOPT,NOQ         OPTION TO RESCALE BY WEEK                    
         BE    ALLOC64                                                          
         CH    R2,NWKS             DON'T DO AFTER LAST WEEK                     
         BE    ALLOC64                                                          
                                                                                
ALLOC54  L     R3,AFSTBRD                                                       
ALLOC56  CLI   TABPRD,0                                                         
         BE    ALLOC64                                                          
         LR    R6,R3                                                            
         AH    R6,CELLWID          SKIP TOTAL WEEK                              
         AH    R6,WKDISP           SET NEXT WEEK FOR END CHECK                  
         LA    R5,TRSCGOL                                                       
         AH    R5,CELLWID          SKIP TOTAL WEEK                              
         SR    RF,RF                                                            
ALLOC58  CR    R5,R6               TEST THIS WEEK                               
         BNL   ALLOC62                                                          
         A     RF,0(R5)            GOAL                                         
         L     R0,8(R5)            LESS DOLLARS                                 
         CLI   GOALOPT,GOALDOLS                                                 
         BE    ALLOC60                                                          
         L     R0,4(R5)            OR DEMO                                      
         TM    REQFLAG1,REQFMIXB   IF MIXED DEMO GOALS                          
         BZ    ALLOC60                                                          
         SR    RE,RE                                                            
         ICM   RE,1,TABGLDEM                                                    
         BZ    ALLOC60             AND BRAND DEMO NOT = CORP                    
         BCTR  RE,0                                                             
         SLL   RE,2                                                             
         L     R0,TABTA1-TABDATA(R5,RE) USE BRAND DEMO                          
ALLOC60  SR    RF,R0                                                            
         AH    R5,CELLWID          NEXT WEEK                                    
         B     ALLOC58                                                          
ALLOC62  ST    RF,TABROLL          SET ROLLED UP REMAINDER                      
         AH    R3,LROW             NEXT PRODUCT                                 
         B     ALLOC56                                                          
ALLOC64  AHI   R2,1                BUMP TO NEXT WEEK                            
         CH    R2,NWKS                                                          
         BNH   ALLOC30                                                          
                                                                                
***********************************************************************         
* PUT TOTAL ACH RATING,DOLLARS,SPOTS IN TOTAL ROW                     *         
***********************************************************************         
                                                                                
         LHI   R2,TABDATA-TABD     START AT TOTAL COLUMN                        
         LH    R7,NWKSP1           FOR WEEK BCT                                 
ALLOC66  L     R4,ATOTROW          TOTAL ROW                                    
         L     R3,AFSTBRD          FIRST BRAND                                  
ALLOC68  CLI   TABPRD,0                                                         
         BE    ALLOC74                                                          
         CLI   TABPRD,UNAPRD2      SKIP 'UNA'                                   
         BE    ALLOC72                                                          
         LH    R0,CELLWID                                                       
         SRL   R0,2                CELLWID / 4 FOR BCT                          
         LA    R5,0(R3,R2)         THIS BRAND                                   
         LA    R6,0(R4,R2)         TOTAL                                        
ALLOC70  L     RF,0(R5)                                                         
         A     RF,0(R6)                                                         
         ST    RF,0(R6)                                                         
         AHI   R5,4                                                             
         AHI   R6,4                                                             
         BCT   R0,ALLOC70                                                       
ALLOC72  AH    R3,LROW             NEXT PRODUCT                                 
         B     ALLOC68                                                          
ALLOC74  AH    R2,CELLWID          NEXT WEEK                                    
         BCT   R7,ALLOC66                                                       
                                                                                
         MVI   ENVNO,0             PRINT ENVIRONMENT TABLES                     
ALLOC76  SR    R7,R7                                                            
         IC    R7,ENVNO            BUMP ENVIRONMENT NUMBER                      
         AHI   R7,1                                                             
         STC   R7,ENVNO                                                         
         CLI   ENVNO,NENVS         TEST ALL DONE                                
         BH    ALLOC80                                                          
         SLL   R7,2                                                             
         L     R7,AENV1SET-L'AENV1SET(R7)                                       
         USING ENVSETD,R7                                                       
         OC    ENVSVAR,ENVSVAR     IS VARIABLE ACTIVE                           
         BNZ   ALLOC78             YES - PRINT                                  
         CLI   ENVNO,ENVNPGMQ      ELSE SKIP UNLESS ENV1                        
         BNE   ALLOC76                                                          
         CLI   PINTRVL,0           AND TIMER INTERVALS ACTIVE                   
         BNE   ALLOC78                                                          
         CLI   CINTRVL,0                                                        
         BE    ALLOC76                                                          
ALLOC78  MVI   PEMODE,0            DO POST ALLOC ENV COUNTERS                   
         GOTOR PRTENV              PRINT ENVIRONMENT TABLES TRACE               
         OI    PEMODE,PEMPSTQ      ALSO DO ACTUAL COUNTS                        
         GOTOR PRTENV                                                           
         B     ALLOC76                                                          
         DROP  R7                                                               
                                                                                
ALLOC80  L     R3,AFSTBRD                                                       
ALLOC82  CLI   TABPRD,0                                                         
         BE    ALLOC84                                                          
         GOTOR DPTADJ                                                           
         AH    R3,LROW                                                          
         B     ALLOC82                                                          
                                                                                
***********************************************************************         
* BEFORE WRITING ACHIEVEMENTS BACK TO BUFFER SET TOTAL ROWS FOR       *         
* INDIVIDUAL SLN'S                                                    *         
***********************************************************************         
                                                                                
ALLOC84  MVI   CELLD,TPREDEM-TABDATA WRITE TOTALS BACK TO BUFFER                
         MVI   TYP,TACHDEMQ        RATING                                       
         GOTOR ROWOUT                                                           
         MVI   CELLD,TPREDOL-TABDATA                                            
         MVI   TYP,TACHDOLQ        DOLLARS                                      
         GOTOR ROWOUT                                                           
         MVI   CELLD,TPREUNT-TABDATA SPOTS                                      
         MVI   TYP,TACHUNTQ                                                     
         GOTOR ROWOUT                                                           
         TM    REQFLAG1,REQFTRGS   TARGETS                                      
         BZ    ALLOC106                                                         
         LH    R0,NTARGETS                                                      
         MVI   CELLD,TABTA1-TABDATA STARTING CELLD                              
         MVI   TYP,TACHT01Q         STARTING TYP                                
ALLOC104 GOTOR ROWOUT                                                           
         IC    R1,CELLD            BUMP CELL DISPLACEMENT                       
         AHI   R1,L'TABTA1                                                      
         STC   R1,CELLD                                                         
         IC    R1,TYP              BUMP TYPE                                    
         AHI   R1,1                                                             
         STC   R1,TYP                                                           
         BCT   R0,ALLOC104                                                      
ALLOC106 MVC   GBUFFK,S.GBUFFK     RESET BUFFER 'KEY'                           
         GOTOR BU1RDH              READ HIGH BUFFER 1                           
ALLOCX   J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* ROLL DAYPART REMAINDERS FORWARD                                     *         
***********************************************************************         
                                                                                
DPTADJ   NTR1  ,                                                                
         CLI   DSSW,YESQ           SKIP IF NO DAYPART RESCALING                 
         BNE   DPTADJX                                                          
         TM    REQFLAG1,REQFMIXB   OR MIXED DEMO GOALS                          
         BNZ   DPTADJX                                                          
         OC    TSAVDEM,TSAVDEM     NO REMAINDER TO ROLL                         
         BZ    DPTADJX                                                          
         MVC   GBUFFK(L'GBDPT+L'GBSLN),L.GBDPT                                  
         MVI   GBUFFK+L'GBDPT+L'GBSLN,FF                                        
         GOTOR BU1RDH              READ HIGH TO GET NEXT SLN                    
         B     DPTADJ04                                                         
DPTADJ02 GOTOR BU1RSQ              READ SEQUENTIAL BUFFER 1                     
DPTADJ04 BNZ   DPTADJX                                                          
         OC    GBROW(GBROWL),GBROW SKIP IF ALL VALUES NULL                      
         BZ    DPTADJ02                                                         
         CLI   GBTYP,TRSCGOLQ      LOOK FOR RESCALED GOALS                      
         BNE   DPTADJ02                                                         
         CLC   GBDPT,L.GBDPT                                                    
         BNE   DPTADJ06                                                         
         CLC   GBSLN,L.GBSLN                                                    
         BE    DPTADJ02                                                         
DPTADJ06 CLC   TABPRD,GBPRD        TEST RIGHT PRODUCT                           
         BNE   DPTADJ02                                                         
         MVC   FULL,GBTOT                                                       
         L     R1,FULL                                                          
         L     RF,TSAVDEM          HOLD REMAINDER                               
         ST    RF,DUB                                                           
         XC    TSAVDEM,TSAVDEM     CLEAR REMAINDER                              
                                                                                
***********************************************************************         
* DON'T ADJUST COMING DPTS GOAL BY MORE THAN HALF                     *         
***********************************************************************         
                                                                                
         LPR   RF,RF               REM                                          
         SLL   RF,1                X 2                                          
         C     RF,FULL             COMP TO GOAL                                 
         BNH   DPTADJ08            NOT MORE THAN HALF                           
         L     RF,FULL             GOAL                                         
         SRL   RF,1                / 2                                          
         L     RE,DUB              REM                                          
         LTR   RE,RE               IF REM NEG - ADD 1/2 OF GOAL                 
         BNP   *+6                 TO REM                                       
         LCR   RF,RF               ELSE SUBTRACT                                
         AR    RE,RF                                                            
         ST    RE,TSAVDEM          SAVE ADDITIONAL REMAINDER                    
         LCR   RF,RF               REVERSE FOR GOAL ADJ                         
         ST    RF,DUB                                                           
DPTADJ08 A     R1,DUB                                                           
         M     R0,FW10000                                                       
         L     RF,FULL                                                          
         GOTOR DIVIDE                                                           
         ST    R1,FACTOR1                                                       
         LA    R5,GBTOT                                                         
         LH    R7,NWKSP1                                                        
DPTADJ10 L     R1,0(R5)                                                         
         M     R0,FACTOR1                                                       
         L     RF,FW10000                                                       
         GOTOR DIVIDE                                                           
         S     R1,0(R5)            REMOVE EXISTING NUMBER SO                    
         ST    R1,0(R5)            BUFFERIN WILL REPLACE NOT ADD                
         AHI   R5,L'GBTOT                                                       
         BCT   R7,DPTADJ10                                                      
         GOTOR BU1PUT              PUT BUFFER 1 RECORD                          
         MVI   PBMODE,PBMDRUQ                                                   
         GOTOR PRTBUF                                                           
         MVI   PBMODE,0                                                         
DPTADJ12 OC    TSAVDEM,TSAVDEM     ANY MORE REMAINDER                           
         BNZ   DPTADJ02            YES                                          
DPTADJX  J     EXIT                                                             
         DROP  R3,RB                                                            
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* SET ENVIRONMENT COUNTER TABLES                                      *         
***********************************************************************         
                                                                                
SETENV   NTR1  BASE=*,LABEL=*                                                   
         L     RF,AENV1SET         FIRST COUNT ENV1 TABLE ENTRIES               
         L     RF,ENVSATAB-ENVSETD(RF)                                          
         SR    R0,R0                                                            
         CLI   0(RF),FF            END                                          
         BE    *+16                                                             
         AHI   R0,1                                                             
         AHI   RF,ENVS1LEN                                                      
         B     *-16                                                             
         ST    R0,ENV1CNT                                                       
                                                                                
         MVI   ENVNO,0             SET ENV TABLES                               
SETENV02 SR    R8,R8                                                            
         IC    R8,ENVNO            BUMP ENVIRONMENT NUMBER                      
         AHI   R8,1                                                             
         STC   R8,ENVNO                                                         
         CLI   ENVNO,NENVS         TEST ALL DONE                                
         BH    SETENV68                                                         
         SLL   R8,2                                                             
         L     R8,AENV1SET-L'AENV1SET(R8)                                       
         USING ENVSETD,R8                                                       
                                                                                
         AHI   R1,15              SET START OF ENV TABLE                        
         SRL   R1,3               (R1) POINTS TO WHERE TABLE CAN START          
         SLL   R1,3               SKIP 8 AND DOUBLE WORD ALIGN                  
         MVC   0(8,R1),=C'*ENCNTS*'                                             
         MVC   2(1,R1),ENVNO                                                    
         OI    2(R1),ZONE                                                       
         AHI   R1,8                                                             
         ST    R1,ENVSACNT                                                      
         ST    R1,ENVSACTC         PRETEND HAVE ACTUAL COUNT TABLE              
*                                  (SAVES CHECKING AT SETENV38)                 
         SR    R2,R2                                                            
         OC    ENVSVAR,ENVSVAR     SKIP IF VARIABLE NOT ACTIVE                  
         BNZ   SETENV04                                                         
         CLI   ENVNO,ENVNPGMQ      BUT WILL NEED ENV 1                          
         BNE   SETENV38                                                         
         CLI   PINTRVL,0           IF TIME INTERVAL CHECK ACTIVE                
         BNE   SETENV04                                                         
         CLI   CINTRVL,0                                                        
         BE    SETENV38                                                         
                                                                                
SETENV04 L     RE,APRDTRT                                                       
         MVI   0(RE),FF            SET PRODUCT/CLASS LISTS                      
         MVC   1(L'PRDTRT-1,RE),0(RE)                                           
         MVC   L'PRDTRT(L'CLSTRT,RE),0(RE)                                      
                                                                                
         SR    R2,R2               START WITH PRODUCT SEQ 0                     
         L     R3,AFSTBRD                                                       
         USING TABD,R3                                                          
SETENV06 CLI   TABPRD,0                                                         
         BE    SETENV10                                                         
         OC    TRSCGOL(L'TRSCGOL+L'TPREDEM+L'TPREDOL),TRSCGOL                   
         BZ    SETENV08                                                         
         SR    RF,RF                                                            
         IC    RF,TABPRD                                                        
         A     RF,APRDTRT                                                       
         CLI   0(RF),FF            ALREADY COUNTED                              
         BNE   SETENV08                                                         
         STC   R2,0(RF)            SET POSITION CODE                            
         AHI   R2,1                                                             
SETENV08 AH    R3,LROW             NEXT PRODUCT                                 
         B     SETENV06                                                         
                                                                                
SETENV10 ST    R2,ENVPCNT          COUNT OF PRODUCTS                            
         CLI   CINTRVL,0           TEST NEED CLASSES                            
         BE    SETENV16                                                         
         L     R3,AFSTBRD                                                       
SETENV12 CLI   TABPRD,0                                                         
         BE    SETENV16                                                         
         OC    TRSCGOL,TRSCGOL     ONLY ACTIVES                                 
         BZ    SETENV14                                                         
         GOTOR SETCLS,TABPRDC                                                   
         BE    SETENV14            NO CLASS                                     
         SR    RF,RF               FIRST CLASS SHOULD BE SET                    
         IC    RF,CLASS1                                                        
         A     RF,ACLSTRT                                                       
         CLI   0(RF),FF            ALREADY COUNTED                              
         BNE   *+12                                                             
         STC   R2,0(RF)            SET POSITION CODE                            
         AHI   R2,1                                                             
         SR    RF,RF                                                            
         ICM   RF,1,CLASS2         SECOND MAY BE ZERO                           
         BZ    SETENV14                                                         
         A     RF,ACLSTRT                                                       
         CLI   0(RF),FF            ALREADY COUNTED                              
         BNE   *+12                                                             
         STC   R2,0(RF)            SET POSITION CODE                            
         AHI   R2,1                                                             
SETENV14 AH    R3,LROW             NEXT PRODUCT                                 
         B     SETENV12                                                         
         DROP  R3                                                               
                                                                                
SETENV16 ST    R2,ENVTCNT          COUNT OF PRODUCTS + CLASSES                  
         LR    RF,R2                                                            
         S     RF,ENVPCNT          LESS PRODUCT COUNT                           
         ST    RF,ENVCCNT          = COUNT OF CLASSES                           
         LTR   R2,R2                                                            
         BZ    SETENV38            NO PRODUCTS/CLASSES                          
                                                                                
         LH    RF,NWKSP1                                                        
         SLL   RF,1                2 BYTES PER WEEK                             
         STH   RF,ENVPRDD          DISPL FOR PRODUCT/CLASS                      
         MH    R2,ENVPRDD                                                       
         STH   R2,ENVENVD          DISPL FOR ENV CODE                           
         L     R0,ENVSATOT         CLEAR SPOT COUNTS AND TRT TABLE              
         L     R1,ENVSLTOT                                                      
         GOTOR CLEAR                                                            
                                                                                
         L     R0,ENVSMAXN                                                      
         LA    RF,ENVSTTAB         CLEAR TRT TABLE                              
         MVC   0(2,RF),FFS                                                      
         AHI   RF,2                                                             
         BCT   R0,*-10                                                          
                                                                                
                                                                                
         LA    R5,W                NOW READ SPOTS AND POST                      
         USING SBUFFRD,R5                                                       
         XC    SBUFFK(SBUFFKL),SBUFFK                                           
         MVC   SBDPT(L'GBDPT+L'GBSLN),L.GBDPT                                   
         SR    R2,R2                                                            
         GOTOR BU2RDH              READ HIGH BUFFER 2                           
         B     SETENV24                                                         
SETENV22 GOTOR BU2RSQ              READ SEQUENTIAL BUFFER 2                     
SETENV24 BNZ   SETENV38                                                         
         CLI   SBRTYP,SBRTYPQ      TEST RIGHT RECORD TYPE                       
         BNE   SETENV22                                                         
         CLC   SBDPT,L.GBDPT                                                    
         BNE   SETENV38                                                         
         CLC   SBSLN,L.GBSLN                                                    
         BNE   SETENV38                                                         
         SR    RF,RF                                                            
         IC    RF,ENVNO                                                         
         SLL   RF,1                                                             
         LH    RF,SBENV1-L'SBENV1(RF) POINT TO RIGHT ENV CODE                   
         SLL   RF,1                                                             
         LA    RF,ENVSTTAB(RF)     POINT TO TOTAL COUNTERS                      
         CLC   0(2,RF),FFS         TEST ALREADY USED                            
         BNE   *+12                YES                                          
         STCM  R2,3,0(RF)          NO- SET NEW TRANS NUMBER                     
         AHI   R2,1                                                             
                                                                                
         SR    R6,R6               BUMP NO. OF SPOTS - TOTAL                    
         ICM   R6,3,0(RF)                                                       
         MHI   R6,(MAXWEEKS+1)*2                                                
         A     R6,ENVSATOT         POINTS TO CTRS FOR THIS ENV                  
         LH    RF,0(R6)                                                         
         LH    R1,HW10             1.0 UNITS                                    
         AR    RF,R1                                                            
         STH   RF,0(R6)                                                         
                                                                                
         SR    RF,RF               BUMP SPOTS FOR WEEK                          
         IC    RF,SBWK             WEEK IS ADDITIONAL DISPL                     
         SLL   RF,1                                                             
         AR    R6,RF                                                            
         LH    RF,0(R6)                                                         
         AR    RF,R1               BUMP BY EQUIV UNITS                          
         STH   RF,0(R6)                                                         
                                                                                
         CLI   SBPRD1,0            TEST PRE-ALLOCATED                           
         BE    SETENV22            NO                                           
         SR    RF,RF               YES - POST TO COUNTERS                       
         IC    RF,SBPRD1           (CAN ONLY BE ONE PROD)                       
         A     RF,APRDTRT                                                       
         SR    RE,RE                                                            
         IC    RE,0(RF)                                                         
         CHI   RE,FF               SKIP IF PRODUCT HAS NO GOALS                 
         BE    SETENV22                                                         
         OC    ENVSVAR,ENVSVAR     TEST VAR ACTIVE                              
         BNZ   SETENV30                                                         
         CLI   ENVNO,ENVNPGMQ      BUT WILL NEED ENV 1                          
         BNE   SETENV22                                                         
         CLI   PINTRVL,0           IF TIME INTERVAL CHECK ACTIVE                
         BNE   SETENV30                                                         
         CLI   CINTRVL,0                                                        
         BE    SETENV22                                                         
SETENV30 MH    RE,ENVPRDD          X DISP FOR A PRODUCT                         
         SR    R6,R6                                                            
         IC    R6,ENVNO            POINT TO RIGHT ENV CODE                      
         SLL   R6,1                                                             
         LH    R6,SBENV1-L'SBENV1(R6)                                           
         SLL   R6,1                                                             
         LH    RF,ENVSTTAB(R6)                                                  
         MH    RF,ENVENVD          DISP FOR AN ENV                              
         AR    RF,RE               TOTAL DISP                                   
         LR    R6,RF               SAVE TOTAL DISP                              
         A     RF,ENVSACNT         PLUS START OF TABLE                          
         LH    R1,HW10             1.0 UNITS                                    
         LH    RE,0(RF)            BUMP PRE COUNTER - TOTAL                     
         AR    RE,R1               BUMP BY EQUIV UNITS                          
         STH   RE,0(RF)                                                         
         SR    RE,RE                                                            
         IC    RE,SBWK             AND FOR WEEK                                 
         SLL   RE,1                2 BYTES PER WEEK                             
         AR    RF,RE                                                            
         LH    RE,0(RF)                                                         
         AR    RE,R1               BUMP BY EQUIV UNITS                          
         STH   RE,0(RF)                                                         
*                                  NOW DO CLASS                                 
SETENV32 CLI   CINTRVL,0           DON'T NEED CLASSES                           
         BE    SETENV22                                                         
         CLI   ENVNO,ENVNPGMQ      CLASSES ONLY FOR ENV1                        
         BNE   SETENV22                                                         
                                                                                
         SR    R1,R1                                                            
         IC    R1,SBPRD1                                                        
         A     R1,APCLLST          POINT TO CLASS FOR PRODUCT                   
         GOTOR SETCLS                                                           
         BE    SETENV22            NO CLASS                                     
                                                                                
SETENV34 SR    RF,RF                                                            
         ICM   RF,1,CLASS1                                                      
         BZ    SETENV36            NO CLASS                                     
         A     RF,ACLSTRT                                                       
         SR    RE,RE                                                            
         IC    RE,0(RF)                                                         
         MH    RE,ENVPRDD          DISP FOR PRODUCT/CLASS                       
         SR    R6,R6                                                            
         IC    R6,ENVNO            POINT TO RIGHT ENV CODE                      
         SLL   R6,1                                                             
         LH    R6,SBENV1-L'SBENV1(R6)                                           
         SLL   R6,1                                                             
         LH    RF,ENVSTTAB(R6)                                                  
         MH    RF,ENVENVD          DISP FOR ENV CODE                            
         AR    RF,RE                                                            
         LR    R6,RF               SAVE TOTAL DISP                              
         A     RF,ENVSACNT         PLUS START OF TABLE                          
         LH    R1,HW10             1.0 UNITS                                    
         LH    RE,0(RF)            BUMP PRE COUNTER - TOTAL                     
         AR    RE,R1               BUMP BY EQUIV UNITS                          
         STH   RE,0(RF)                                                         
                                                                                
         SR    RE,RE                                                            
         IC    RE,SBWK             AND FOR WEEK                                 
         SLL   RE,1                2 BYTES PER WEEK                             
         AR    RF,RE                                                            
         LH    RE,0(RF)                                                         
         AR    RE,R1               BUMP BY EQUIV UNITS                          
         STH   RE,0(RF)                                                         
                                                                                
SETENV36 CLI   CLASS2,0            TEST NEED TO DO 2ND OF 2 PART CLASS          
         BE    SETENV22            NO                                           
         MVC   CLASS1,CLASS2                                                    
         MVI   CLASS2,0                                                         
         B     SETENV34                                                         
                                                                                
SETENV38 ST    R2,ENVSWCNT         COUNT OF ENVS                                
         MH    R2,ENVENVD                                                       
         ST    R2,ENVSTLEN         LENGTH OF ENVN TABLE                         
         A     R2,ENVSACTC                                                      
*                                  SET START OF ENV1 SHARES TABLE               
         AHI   R2,15               SKIP 8 AND DOUBLE WORD ALIGN                 
         SRL   R2,3                                                             
         SLL   R2,3                                                             
         MVC   0(8,R2),=C'*ENSHRS*'                                             
         MVC   2(1,R2),ENVNO                                                    
         OI    2(R2),ZONE                                                       
         AHI   R2,8                                                             
         ST    R2,ENVSASHR                                                      
                                                                                
SETENV40 OC    ENVSWCNT,ENVSWCNT   NOW SET PRODUCT/CLASS SPOT SHARES            
         BZ    SETENV66                                                         
         SR    R3,R3               PRODUCT/CLASS NO.                            
                                                                                
SETENV42 L     R4,APRDTRT          SET PCTS FOR PRODUCT/CLASS IN X              
         MVI   BYTE,C'P'           SET DOING PRODUCT                            
         C     R3,ENVPCNT                                                       
         BL    *+12                                                             
         L     R4,ACLSTRT                                                       
         MVI   BYTE,C'C'           OR CLASS                                     
         LR    R0,R4                                                            
         CLM   R3,1,0(R4)          FIND PRODUCT/CLASS CODE                      
         BE    *+12                                                             
         AHI   R4,1                                                             
         B     *-12                                                             
         SR    R4,R0               CODE IS DISP INTO LIST                       
         STC   R4,FULL                                                          
         XC    W,W                                                              
                                                                                
         L     R4,AFSTBRD          SCAN PRODUCT TABLES                          
         USING TABD,R4                                                          
SETENV44 CLI   TABPRD,0                                                         
         BE    SETENV54                                                         
         CLI   BYTE,C'P'                                                        
         BNE   SETENV46                                                         
         CLC   TABPRD,FULL                                                      
         BE    SETENV48                                                         
         B     SETENV52                                                         
                                                                                
SETENV46 CLC   TABPRDC,FULL        TEST VS PRODUCT CLASS                        
         BE    SETENV48            IF EQUAL-POST                                
         GOTOR SETCLS,TABPRDC                                                   
         BH    SETENV52                                                         
         CLC   CLASS1,FULL                                                      
         BE    SETENV48                                                         
         CLC   CLASS2,FULL                                                      
         BNE   SETENV52                                                         
                                                                                
SETENV48 LH    R5,NWKSP1           ADD INTO W                                   
         LA    R6,W                                                             
         LA    R7,TRSCGOL                                                       
SETENV50 L     RF,0(R6)                                                         
         A     RF,0(R7)                                                         
         ST    RF,0(R6)                                                         
         AH    R7,CELLWID                                                       
         AHI   R6,4                                                             
         BCT   R5,SETENV50                                                      
SETENV52 AH    R4,LROW             NEXT PRODUCT                                 
         B     SETENV44                                                         
                                                                                
SETENV54 LH    R5,NWKSP1           SET PCTS                                     
         LA    R6,W                                                             
         L     R4,ATOTROW                                                       
         LA    R4,TRSCGOL          START AT TOTAL COLUMN                        
SETENV56 L     R1,0(R6)                                                         
         M     R0,FW100                                                         
         L     RF,0(R4)                                                         
         GOTOR DIVIDE                                                           
         ST    R1,0(R6)                                                         
         AHI   R6,4                                                             
         AH    R4,CELLWID                                                       
         BCT   R5,SETENV56                                                      
                                                                                
         SR    R2,R2               ENV NO.                                      
SETENV58 LR    R7,R2               SET SPOT SHARES FOR 1 ENV + PRD/CLS          
         MHI   R7,(MAXWEEKS+1)*2                                                
         A     R7,ENVSATOT         POINT TO CTRS FOR THIS ENV                   
         AHI   R7,2                START AT WEEK 1                              
         L     R6,ENVSASHR         START OF SHARES                              
         LR    RF,R2               ENV DISP                                     
         MH    RF,ENVENVD                                                       
         LR    RE,R3               PRODUCT/CLASS DISP                           
         MH    RE,ENVPRDD          PRODUCT/CLASS DISP                           
         AR    R6,RF                                                            
         AR    R6,RE               R6 NOW POINTS TO PROPER COUNTERS             
         ST    R6,DUB              SAVE COUNTER ADDRESS                         
         AHI   R6,2                POINT TO WEEK 1                              
         LH    R5,NWKS                                                          
         LA    R4,W+4              PCTS ARE IN W (WK 1 AT +4)                   
         LH    RF,HW100            DIVISOR                                      
         XC    FULL,FULL           FOR UNROUNDED SUM                            
SETENV60 LH    R1,0(R7)                                                         
         LTR   R1,R1                                                            
         BNP   SETENV62                                                         
         ICM   RE,15,0(R4)         TEST ANY PCT                                 
         BZ    SETENV62                                                         
         MR    R0,RE               X PCT                                        
         LR    RE,R1                                                            
         A     RE,FULL             SUM UNROUNDED SHARES                         
         ST    RE,FULL                                                          
         GOTOR DIVIDE              / DIVISOR                                    
         CH    R1,HW10             TEST VS MINIMUM SHARE                        
         BNL   *+8                                                              
         LH    R1,HW10             SHARE MUST BE AT LEAST MINIMUM               
         STH   R1,0(R6)                                                         
SETENV62 AHI   R4,4                NEXT PCT                                     
         AHI   R6,2                NEXT WEEK                                    
         AHI   R7,2                                                             
         BCT   R5,SETENV60                                                      
*                                  NOW SET TOTAL                                
         ICM   R1,15,FULL          UNROUNDED SUM                                
         BZ    SETENV64                                                         
         M     R0,FW1                                                           
         GOTOR DIVIDE              ROUND                                        
         CH    R1,HW10             TEST VS MINIMUM SHARE                        
         BNL   *+8                                                              
         LH    R1,HW10             SHARE MUST BE AT LEAST MINIMUM               
         L     RF,DUB                                                           
         STH   R1,0(RF)                                                         
                                                                                
SETENV64 AHI   R2,1                NEXT ENV                                     
         C     R2,ENVSWCNT         TEST DONE                                    
         BL    SETENV58                                                         
         AHI   R3,1                NEXT PRODUCT/CLASS                           
         C     R3,ENVTCNT          TEST DONE                                    
         BL    SETENV42                                                         
                                                                                
SETENV66 MVI   PEMODE,PEMPREQ      PRE -ALLOCS                                  
         GOTOR PRTENV              PRINT ENV TABLES                             
         OI    PEMODE,PEMPSTQ      ALSO ACTUAL COUNTS                           
         GOTOR PRTENV                                                           
         L     R1,ENVSTLEN                                                      
         A     R1,ENVSASHR         POINT TO NEXT AREA                           
         B     SETENV02                                                         
                                                                                
SETENV68 AHI   R1,15               SET START OF SPOT TABLE                      
         SRL   R1,3                SKIP 8 AND DOUBLE WORD ALIGN                 
         SLL   R1,3                                                             
         MVC   0(8,R1),=C'*SPTTAB*'                                             
         AHI   R1,8                                                             
         ST    R1,ASPTTAB                                                       
                                                                                
SETENVX  J     EXIT                                                             
         DROP  R4,R5,R8,RB                                                      
                                                                                
ENV1CNT  DS    F                   TOTAL COUNT OF ENV 1'S                       
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* DUMP RECORD                                                         *         
***********************************************************************         
                                                                                
DMPREC   NTR1  LABEL=NO                                                         
         TM    DIAGNOP2,DPRTBUYQ   TEST TO PRINT REC                            
         JZ    DMPRECX                                                          
         GOTOR HEXOUT,HEXP,ADDLIST,P1,L'ADDLIST,NOL                             
         GOTOR (RF),(R1),KEY+(BUYKDA-BUYKEY),P2,4                               
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT                                                           
         L     R5,AREC                                                          
         SR    R2,R2                                                            
         ICM   R2,3,BUYRLEN-BUYREC(R5)                                          
         LA    R3,0(R5,R2)                                                      
DMPREC02 LR    R4,R3                                                            
         SR    R4,R5                                                            
         JNP   DMPREC04                                                         
         CHI   R4,32                                                            
         JNH   *+8                                                              
         LHI   R4,32                                                            
         XC    WORK,WORK                                                        
         GOTOR HEXOUT,HEXP,(R5),P1+1,(R4),NOL                                   
         MVC   WORK(32),0(R5)                                                   
         L     RE,ATRTTAB                                                       
         TR    WORK(32),0(RE)                                                   
         BCTR  R4,0                                                             
         BASR  RE,0                                                             
         EX    R4,8(RE)                                                         
         J     *+10                                                             
         MVC   P1+79(0),WORK                                                    
         MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT                                                           
         LA    R5,1(R5,R4)                                                      
         J     DMPREC02                                                         
DMPREC04 MVI   SKIPSPEC,YESQ                                                    
         GOTOR REPORT                                                           
DMPRECX  J     EXIT                                                             
                                                                                
DEMNAM   LA    RF,DEMNMS           GET FULL DEMO NAME IN WORK+3                 
         USING DEMNAMD,RF                                                       
         MVC   WORK(L'DEMNDEMN),0(R1)                                           
         MVC   WORK+L'DEMNDEMN(20),SPACES                                       
         LA    R0,DEMNMSL                                                       
         CLC   DEMNDEMN,WORK                                                    
         JE    *+14                                                             
         AHI   RF,DEMNLENQ                                                      
         BRCT  R0,*-14                                                          
         BR    RE                                                               
         MVC   WORK+L'DEMNDEMN(L'DEMNNAME),DEMNNAME                             
         CLI   DEMNDEMN,0                                                       
         JE    *+10                                                             
         MVC   WORK+L'DEMNDEMN(L'DEMNNADP+L'DEMNNAME),L'DEMNDEMN(RF)            
         BR    RE                                                               
         DROP  RF                                                               
                                                                                
CLEAR    STM   RE,R1,12(RD)                                                     
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
CLEARX   LM    RE,R1,12(RD)                                                     
         BR    RE                                                               
                                                                                
GETWKN   L     RF,AWEEKLST         LOOK UP WEEK NUMBER                          
         LHI   R0,1                                                             
GETWKN02 CLC   0(2,R1),2(RF)                                                    
         JNH   GETWKN04                                                         
         CLI   0(RF),0                                                          
         JE    GETWKN04                                                         
         AHI   RF,L'MEDQ1WKS                                                    
         AHI   R0,1                                                             
         J     GETWKN02                                                         
GETWKN04 LR    RF,R0                                                            
         BR    RE                                                               
                                                                                
***********************************************************************         
* DIVIDE 64 BIT VALUE IN R0/R1 BY 32 BIT VALUE IN RF - EXIT WITH THE  *         
* RESULT IN THE LOW ORDER 32 BITS OF R1 AND CC OF EQUAL IF THE RESULT *         
* FITS INTO 32 BITS ELSE EXIT WITH CONDITION CODE OF HIGH AND RETURN  *         
* ZERO RESULT                                                         *         
***********************************************************************         
                                                                                
DIVIDE   LTR   RF,RF               TEST DIVIDE BY ZERO                          
         JNZ   *+8                                                              
         SR    R1,R1               YES - RETURN ZERO                            
         BR    RE                                                               
         STM   R0,R1,DIVDUB        SAVE 64 BIT VALUE                            
         LG    GR1,DIVDUB          GET 64 BIT VALUE INTO GR1                    
         MGHI  GR1,2               MULTIPLY DIVIDEND BY 2                       
         DSGFR GR0,RF              DIVIDE BY 32 BIT DIVISOR                     
         LTGR  GR1,GR1             TEST QUOTIENT IS NEGATIVE                    
         JNP   *+8                                                              
         AGHI  GR1,1               NO - ADD 1                                   
         SRAG  GR1,GR1,1           DIVIDE QUOTIENT BY 2                         
         CG    GR1,MAXBVAL         TEST QUOTIENT EXCEEDS 31 BIT VALUE           
         JH    *+8                                                              
         CR    RE,RE               NO - SET CONDITION CODE TO EQUAL             
         BR    RE                                                               
         SR    R1,R1               SET QUOTIENT TO ZERO                         
         CR    RE,R1               AND SET CONDITION CODE TO HIGH               
         BR    RE                                                               
                                                                                
ADDLST   CLI   0(R1),0             ADD PRODUCT TO LIST                          
         BER   RE                                                               
         LA    RF,ADDLIST                                                       
ADDLST02 CLI   0(RF),0                                                          
         JE    ADDLST04                                                         
         CLC   0(1,RF),0(R1)                                                    
         BER   RE                                                               
         AHI   RF,1                                                             
         J     ADDLST02                                                         
ADDLST04 MVC   0(1,RF),0(R1)                                                    
         BR    RE                                                               
                                                                                
BU1INI   ST    RE,SAVERE                                                        
         GOTOR BUFFERIN,DMCB,('BUFFAINI',ABUFF1),0,ACOMFACS                     
BU1INIX  L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
BU1CLO   ST    RE,SAVERE                                                        
         GOTOR BUFFERIN,DMCB,('BUFFACLO',ABUFF1),0,ACOMFACS                     
BU1CLOX  L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
BU1RDH   ST    RE,SAVERE                                                        
         GOTOR BUFFERIN,DMCB,('BUFFARDH',ABUFF1),GBUFFR,ACOMFACS                
         GOTOR BU1HEX,BU1RDHL                                                   
         TM    DM2,EOFQ                                                         
BU1RDHX  L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
BU1RSQ   ST    RE,SAVERE                                                        
         GOTOR BUFFERIN,DMCB,('BUFFASEQ',ABUFF1),GBUFFR,ACOMFACS                
         GOTOR BU1HEX,BU1RSQL                                                   
         TM    DM2,EOFQ                                                         
BU1RSQX  L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
BU1GET   ST    RE,SAVERE                                                        
         GOTOR BUFFERIN,DMCB,('BUFFAGET',ABUFF1),GBUFFR,ACOMFACS                
         TM    DM2,NTFQ                                                         
BU1GETX  L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
BU1PUT   ST    RE,SAVERE                                                        
         CLC   DIEKEY,GBUFFK                                                    
         JNE   *+6                                                              
         DC    H'0'                                                             
         GOTOR BU1HEX,BU1PUTL                                                   
         GOTOR BUFFERIN,DMCB,('BUFFAPUT',ABUFF1),GBUFFR,ACOMFACS                
BU1PUTX  L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
BU1HEX   TM    DIAGNOP2,DPRTBUFQ   TEST TRACE REQUIRED                          
         BZR   RE                                                               
         NTR1  LABEL=NO                                                         
         MVC   P1(7),0(R1)                                                      
         GOTOR HEXOUT,HEXP,GBUFFK,P1+7,GBWKS-GBUFFK,NOL                         
         GOTOR (RF),(R1),GBWKS,P2+7,GBWKSL/2,NOL                                
         GOTOR (RF),(R1),GBWKS+(GBWKSL/2),P3+7,GBWKSL/2,NOL                     
         MVI   P4,0                                                             
         GOTOR REPORT                                                           
         J     EXIT                                                             
                                                                                
         USING SBUFFRD,R5                                                       
BU2INI   ST    RE,SAVERE                                                        
         GOTOR BUFFERIN,DMCB,('BUFFAINI',ABUFF2),0,ACOMFACS                     
         L     RE,0(R1)                                                         
         LH    RE,BUFFLREC-BUFFD(RE)                                            
         ST    RE,SPTTABL                                                       
BU2INIX  L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
BU2CLO   ST    RE,SAVERE                                                        
         GOTOR BUFFERIN,DMCB,('BUFFACLO',ABUFF2),0,ACOMFACS                     
BU2CLOX  L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
BU2RDH   ST    RE,SAVERE                                                        
         GOTOR BUFFERIN,DMCB,('BUFFARDH',ABUFF2),SBUFFRD,ACOMFACS               
         GOTOR BU2HEX,BU2RDHL                                                   
         TM    DM2,EOFQ                                                         
BU2RDHX  L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
BU2RSQ   ST    RE,SAVERE                                                        
         GOTOR BUFFERIN,DMCB,('BUFFASEQ',ABUFF2),SBUFFRD,ACOMFACS               
         GOTOR BU2HEX,BU2RSQL                                                   
         TM    DM2,EOFQ                                                         
BU2RSQX  L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
BU2PUT   ST    RE,SAVERE                                                        
         GOTOR ,DMCB,('BUFFAPUT',ABUFF2),SBUFFRD,ACOMFACS                       
         GOTOR BU2HEX,BU2PUTL                                                   
         GOTOR BUFFERIN,DMCB                                                    
BU2PUTX  L     RE,SAVERE                                                        
         BR    RE                                                               
         DROP  R5                                                               
                                                                                
BU2HEX   TM    DIAGNOP2,DPRTBUFQ   TEST TRACE REQUIRED                          
         BZR   RE                                                               
         NTR1  LABEL=N                                                          
         MVC   P1(7),0(R1)                                                      
         LM    R2,R3,DM1                                                        
         LH    R2,BUFFLREC-BUFFD(R2)                                            
         GOTOR HEXOUT,HEXP,(R3),P1+7,SBFIXLN,NOL                                
         GOTOR REPORT                                                           
         AHI   R3,SBFIXLN                                                       
         SHI   R2,SBFIXLN                                                       
         JZ    EXIT                                                             
BU2HEX02 LHI   R0,50                                                            
         CR    R2,R0                                                            
         JH    *+6                                                              
         LR    R0,R2                                                            
         GOTOR HEXOUT,HEXP,(R3),P1+7,(R0),NOL                                   
         GOTOR REPORT                                                           
         AR    R3,R0                                                            
         SR    R2,R0                                                            
         JP    BU2HEX02                                                         
         J     EXIT                                                             
                                                                                
GETDPT   L     RF,ADDPTTAB         LOOK-UP DAYPART IN TABLE                     
GETDPT02 CLI   0(RF),0                                                          
         JNE   *+8                                                              
         LTR   RE,RE                                                            
         BR    RE                                                               
         CLC   0(L'GBDPT,R1),0(RF)                                              
         BER   RE                                                               
         AHI   RF,5                                                             
         J     GETDPT02                                                         
                                                                                
GETDPC   L     RF,ADDPTTAB         LOOK-UP DAYPART CODE IN TABLE                
GETDPC02 CLI   0(RF),0                                                          
         JNE   *+8                                                              
         LTR   RE,RE                                                            
         BR    RE                                                               
         CLC   0(1,R1),1(RF)                                                    
         BER   RE                                                               
         AHI   RF,5                                                             
         J     GETDPC02                                                         
                                                                                
SETCLS   MVI   CLASS1,0                                                         
         MVI   CLASS2,0                                                         
         CLI   0(R1),0                                                          
         BER   RE                  CC = EQUAL FOR NO CLASS                      
         MVC   CLASS1,0(R1)                                                     
         CLI   0(R1),TWOPTCLS      CC = HIGH FOR SINGLE CLASS                   
         BHR   RE                                                               
         PACK  CLASS1,0(1,R1)                                                   
         NI    CLASS1,DIGIT                                                     
         OI    CLASS1,ATOIBITS                                                  
         MVC   CLASS2,0(R1)                                                     
         NI    CLASS2,DIGIT                                                     
         OI    CLASS2,ATOIBITS                                                  
         CLI   CLASS1,FF           CC = LOW FOR 2-PART CLASS                    
         BR    RE                                                               
                                                                                
CLRBRD   STM   RE,R1,12(RD)        CLEAR BRDTAB TO BINARY ZEROES                
         L     R0,ABRDTAB                                                       
         L     R1,BRDTABL                                                       
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
CLRBRDX  LM    RE,R1,12(RD)                                                     
         BR    RE                                                               
                                                                                
FRMPRD   ST    RE,SAVERE           FORMAT ALLOCATION FOR PRODUCT/LENGTH         
         LM    RF,R0,0(R1)                                                      
         MVC   X(6),SPACES                                                      
         OC    0(2,RF),0(RF)                                                    
         JZ    FRMPRD02                                                         
         MVI   X+2,DASH            'XX-LEN'                                     
         SR    RE,RE                                                            
         IC    RE,1(RF)                                                         
         CVD   RE,DUB                                                           
         OI    DUB+L'DUB-1,DIGIT                                                
         UNPK  X+3(3),DUB                                                       
         GOTOR HEXOUT,(R1),(RF),X,1,NOL                                         
FRMPRD02 LR    RF,R0                                                            
         MVC   0(6,RF),X                                                        
FRMPRDX  L     RE,SAVERE                                                        
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
* PRINT BUFFER TRACE                                                  *         
***********************************************************************         
                                                                                
TRCBUF   NTR1  LABEL=NO            PRINT BUFFER TRACE                           
         XC    GBUFFK,GBUFFK                                                    
         GOTOR BU1RDH              READ HIGH BUFFER 1                           
         J     *+8                                                              
TRCBUF02 GOTOR BU1RSQ              READ SEQUENTIAL BUFFER 1                     
         JNZ   TRCBUFX                                                          
         GOTOR HEXOUT,HEXP,GBUFFK,P1,GBWKS-GBUFFK,NOL                           
         GOTOR (RF),(R1),GBWKS,P2,GBWKSL/2,NOL                                  
         GOTOR (RF),(R1),GBWKS+(GBWKSL/2),P3,GBWKSL/2,NOL                       
         MVI   P4,0                                                             
         GOTOR REPORT                                                           
         J     TRCBUF02                                                         
TRCBUFX  J     EXIT                                                             
                                                                                
ENDREQ   GOTOR REPORT              PRINT ERROR LINE                             
         OI    REQFLAG1,REQFQUIT   SET FORCED END OF REQUEST                    
         GOTOR AENDREQ                                                          
         J     EXIT                                                             
                                                                                
EXITY    LHI   RE,1                                                             
         J     EXITCC                                                           
EXITN    LHI   RE,0                                                             
EXITCC   CHI   RE,1                                                             
                                                                                
EXIT     XIT1  ,                                                                
         EJECT                                                                  
***********************************************************************         
* MODULE TO ALLOCATE ONE WEEK                                         *         
***********************************************************************         
                                                                                
ALWEEK   NTR1  BASE=*,LABEL=*                                                   
         LA    R8,ALWEEK                                                        
         AHI   R8,4096                                                          
         USING ALWEEK+4096,R8                                                   
         GOTOR AWKINI              INITIALIZE FOR WEEK ALLOCATION               
         SR    RF,RF                                                            
         ICM   RF,3,AWKAPRDS       TEST ANY ACTIVE BRANDS                       
         BZ    ALWEEK96                                                         
                                                                                
***********************************************************************         
* SPOT SELECTION PHASE                                                *         
***********************************************************************         
                                                                                
         MVI   ALPHASE,ALPSPTQ                                                  
         MVI   ZSPASS,ZSPNOQ       DO ONLY NON-ZERO SPOTS                       
         MVC   WSECS,AWKRSECS      TOTAL LENGTH TO BE ALLOCATED                 
         L     R3,AFSTBRD          CLEAR BRAND SWITCHES                         
         USING TABD,R3                                                          
ALWEEK02 CLI   TABPRD,0                                                         
         BE    ALWEEK04                                                         
         MVI   TABNOSPT,0                                                       
         AH    R3,LROW                                                          
         B     ALWEEK02                                                         
ALWEEK04 GOTOR GPRSPT                                                           
         MVI   PSMODE,PSMSPTQ                                                   
         GOTOR PRTSPT              PRINT SPOT TABLE                             
                                                                                
***********************************************************************         
* BRAND SELECTION PHASE                                               *         
***********************************************************************         
                                                                                
         MVI   ALPHASE,ALPBRDQ                                                  
         MVI   ZSPASS,ZSPNOQ       SET NON-ZERO SPOT PASS                       
         L     R1,AWKRSPTS         CALC NON-ZERO SPOT COUNT                     
         MH    R1,AWKAPRDS         X PRODUCTS ACTIVE THIS WEEK                  
         C     R1,FW5000           IF IT EXCEEDS 5000                           
         BH    ALWEEK36            SKIP NON-ZERO SPOT BRAND SEL PHASE           
ALWEEK16 LA    RF,VARCTLS          SET OFF VARIABLE NO-OPS                      
         LHI   R0,VARWGTSN                                                      
         NI    0(RF),FF-VNOPQ      SET OFF 80                                   
         AHI   RF,4                                                             
         BCT   R0,*-8                                                           
         NI    VARCTLS,FF-VNOPQ    NO-OP GOAL FILL VAR IF ZERO SPT PASS         
         CLI   ZSPASS,ZSPYESQ                                                   
         BNE   *+8                                                              
         OI    VARCTLS,VNOPQ       NO-OP VARIABLE                               
         L     R5,ASPTTAB                                                       
         ICM   R6,15,SPTTABN                                                    
         BZ    ALWEEK36                                                         
ALWEEK18 ST    R5,THISSPT                                                       
         USING SBUFFRD,R5                                                       
         TM    SBSTAT2,SBSPRALQ    DON'T DO PRE-ALLOCS                          
         BNZ   ALWEEK34                                                         
         LA    RF,SBCOST                                                        
         CLI   GOALOPT,GOALDOLS                                                 
         BE    *+8                                                              
         LA    RF,SBCDEM                                                        
         CLI   ZSPASS,ZSPYESQ      IF ZERO SPOT PASS                            
         BNE   ALWEEK20                                                         
         OC    0(4,RF),0(RF)                                                    
         BNZ   ALWEEK34            SKIP NON-ZERO SPOTS                          
         B     ALWEEK22                                                         
ALWEEK20 OC    0(4,RF),0(RF)       IF NON-ZERO SPOT PASS                        
         BZ    ALWEEK34            SKIP ZERO SPOTS                              
ALWEEK22 MVI   PVMODE1,ALPBRDQ     FOR VARIABLE TRACE                           
         MVI   PVMODE2,PVMODE1Q                                                 
         GOTOR PRTVAR                                                           
         XC    CURPRD,CURPRD       CLEAR CURRENT PRODUCT ADDR                   
         CLI   SBPRD1,0            DON'T SUBTRACT IF UNA ON FIRST PASS          
         BE    ALWEEK28                                                         
         DROP  R3                                                               
                                                                                
         L     R2,AFSTBRD                                                       
         USING TABD,R2                                                          
ALWEEK24 CLI   TABPRD,0                                                         
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLC   SBPRD1,TABPRD                                                    
         BE    *+12                                                             
         AH    R2,LROW                                                          
         B     ALWEEK24                                                         
         ST    R2,CURPRD           SAVE CURRENT PRODUCT ADDR                    
         ST    R2,THISPRD                                                       
         GOTOR ADDSUB,1                                                         
ALWEEK28 MVC   BESTVAL,MAXNEG      SET TO MAXIMUM NEGATIVE VALUE                
         XC    BESTPRD,BESTPRD                                                  
                                                                                
         L     R2,AFSTBRD                                                       
ALWEEK30 CLI   TABPRD,0                                                         
         BE    ALWEEK32                                                         
         ST    R2,THISPRD                                                       
         GOTOR VALROUT,0           VALUE BRAND                                  
         AH    R2,LROW             NEXT PRODUCT                                 
         B     ALWEEK30                                                         
ALWEEK32 ICM   R2,15,BESTPRD                                                    
         BZ    ALWEEK34            NO BRAND ACCEPTABLE                          
         ST    R2,THISPRD                                                       
         GOTOR ADDSUB,0                                                         
         NI    SBSTAT,FF-SBSRJCTQ  CLEAR REJECT BITS                            
         CLC   SBPRD1,TABPRD       IF SAME BRAND DON'T RE-BUFFER                
         BE    ALWEEK34                                                         
         OI    SBSTAT,SBSABRDQ     SET ALLOC'D IN BRAND PHASE                   
         MVC   SBPRD1,TABPRD       SET PRODUCT CODE (FIRST SLOT)                
         MVC   SBLEN1,SBPDLEN      SET LENGTH                                   
         MVI   SBUNLEN,0           CLEAR UNALLOCATED LENGTH                     
         GOTOR PUTALC                                                           
ALWEEK34 A     R5,SPTTABL                                                       
         BCT   R6,ALWEEK18                                                      
                                                                                
ALWEEK36 CLI   ZSPASS,ZSPYESQ      DONE IF THIS WAS ZERO PASS                   
         BE    ALWEEK38                                                         
         OC    AWKZSPTS,AWKZSPTS   TEST HAVE ANY ZERO SPOTS                     
         BZ    ALWEEK38            NO                                           
         MVI   ZSPASS,ZSPYESQ      YES-DO ZERO SPOT PASS NOW                    
         B     ALWEEK16                                                         
ALWEEK38 MVI   PSMODE,PSMSPTQ                                                   
         GOTOR PRTSPT              PRINT SPOT TABLE                             
                                                                                
***********************************************************************         
* BRAND EXCHANGE PHASE                                                *         
***********************************************************************         
                                                                                
ALWEEK40 CLC   SPTTABN,FW100       BYPASS THIS PHASE IF OVER 100 SPOTS          
         BH    ALWEEK78                                                         
ALWEEK42 MVI   ALPHASE,ALPXCHQ                                                  
         MVI   ZSPASS,ZSPTOGQ                                                   
         MVC   SPOTA,ASPTTAB                                                    
         L     R5,SPOTA                                                         
         XC    SPOTB,SPOTB                                                      
         LA    RF,VARCTLS          SET OFF VARIABLE NO-OPS                      
         LHI   R0,VARWGTSN                                                      
         NI    0(RF),FF-VNOPQ      SET OFF 80                                   
         AHI   RF,4                                                             
         BCT   R0,*-8                                                           
         MVI   PVMODE1,ALPXCHQ                                                  
         MVI   PVMODE2,PVMODE1Q                                                 
         GOTOR PRTVAR                                                           
                                                                                
ALWEEK44 CLI   0(R5),FF            END OF SPOTS                                 
         BE    ALWEEK78                                                         
         TM    SBSTAT2,SBSPRALQ    SKIP PRE-ALLOCATED                           
         BNZ   ALWEEK76                                                         
         CLI   SBPRD1,0            SKIP UNALLOCATED                             
         BE    ALWEEK76                                                         
         MVI   ZEROA,NOQ                                                        
         LA    RF,SBCOST           TEST ZERO SPOT                               
         CLI   GOALOPT,GOALDOLS                                                 
         BE    *+8                                                              
         LA    RF,SBCDEM                                                        
         OC    0(4,RF),0(RF)                                                    
         BNZ   *+8                                                              
         MVI   ZEROA,YESQ                                                       
ALWEEK46 ICM   R5,15,SPOTB                                                      
         BNZ   ALWEEK48                                                         
         L     R5,SPOTA                                                         
ALWEEK48 A     R5,SPTTABL          LOOK FOR POTENTIAL SWAP                      
         CLI   0(R5),FF                                                         
         BE    ALWEEK76            DONE WITH THIS SPOT                          
         TM    SBSTAT2,SBSPRALQ    SKIP PRE-ALLOCATED                           
         BNZ   ALWEEK48                                                         
         CLI   SBPRD1,0            SKIP UNALLOCATED                             
         BE    ALWEEK48                                                         
         MVI   ZEROB,NOQ                                                        
         LA    RF,SBCOST           TEST ZERO SPOT                               
         CLI   GOALOPT,GOALDOLS                                                 
         BE    *+8                                                              
         LA    RF,SBCDEM                                                        
         OC    0(4,RF),0(RF)                                                    
         BNZ   *+8                                                              
         MVI   ZEROB,YESQ                                                       
         CLC   ZEROA,ZEROB         DON'T SWAP ZERO WITH NON-ZERO SPOT           
         BNE   ALWEEK48                                                         
         ST    R5,SPOTB                                                         
         NI    VARCTLS,FF-VNOPQ                                                 
         CLI   ZEROA,YESQ          IF ZERO SPOTS                                
         BNE   *+8                                                              
         OI    VARCTLS,VNOPQ       NO-OP GOAL FILL VARIABLE                     
                                                                                
***********************************************************************         
* HAVE SPOTA AND SPOTB GO THRU SPOTA SLOTS                            *         
***********************************************************************         
                                                                                
         L     R5,SPOTA                                                         
         LA    R3,SBPRD1           START WITH SLOT 1                            
ALWEEK50 CLI   0(R3),0             WITH FIRST UNA SLOT                          
         BE    ALWEEK46                                                         
         LA    R0,SBPRD2                                                        
         CR    R3,R0               OR AT END OF SLOT A'S                        
         BH    ALWEEK46            GET ANOTHER SPOTB                            
         L     R5,SPOTB            NOW FIND POTENTIAL SWAP IN SPOTB             
         LA    R4,SBPRD1           R4 FOR SPOTB SLOTS                           
ALWEEK52 CLI   0(R4),0             WITH FIRST UNA SLOT                          
         BE    ALWEEK56                                                         
         LA    R0,SBPRD2                                                        
         CR    R4,R0               OR IF AT END OF SPOTB SLOTS                  
         BH    ALWEEK56            TRY NEXT SPOT A SLOT                         
         CLC   0(1,R3),0(R4)       SKIP IF SAME PRODUCT                         
         BE    ALWEEK54                                                         
         CLC   1(1,R3),1(R4)       OR IF NOT SAME LENGTH                        
         BE    ALWEEK58            ELSE TRY SWAP                                
ALWEEK54 AHI   R4,SBPRDL           NEXT SPOTB SLOT                              
         B     ALWEEK52                                                         
*                                  CONE WITH SPOTB SLOTS                        
ALWEEK56 AHI   R3,SBPRDL           TRY NEXT SPOTA SLOT                          
         B     ALWEEK50                                                         
                                                                                
***********************************************************************         
* HAVE PAIR OF SLOTS TO TEST                                          *         
***********************************************************************         
                                                                                
ALWEEK58 SR    RE,RE               PRDBUFF ADDRESS FOR PRDA                     
         SR    RF,RF               PRDBUFF ADDRESS FOR PRDB                     
         L     R2,AFSTBRD                                                       
ALWEEK60 CLI   TABPRD,0                                                         
         BE    ALWEEK64                                                         
         CLC   TABPRD,0(R3)        TEST = PRODUCT A                             
         BNE   ALWEEK62                                                         
         TM    REQFLAG2,REQFSSLN   IF ALL SLNS TOGETHER                         
         BZ    *+14                SKIP SLN TEST                                
         CLC   TABSLN,1(R3)                                                     
         BNE   ALWEEK62                                                         
         LR    RE,R2               A(PRODUCT ENTRY)                             
         LTR   RF,RF               TEST ALREADY HAVE PRDB ALSO                  
         BNZ   ALWEEK66            YES- DONE                                    
ALWEEK62 CLC   TABPRD,0(R4)        TEST = PRODUCT B                             
         BNE   ALWEEK64                                                         
         TM    REQFLAG2,REQFSSLN   IF ALL SLNS TOGETHER                         
         BZ    *+14                SKIP SLN TEST                                
         CLC   TABSLN,1(R4)                                                     
         BNE   ALWEEK64                                                         
         LR    RF,R2               A(PRODUCT B ENTRY)                           
         LTR   RE,RE               TEST ALREADY HAVE PRDA ALSO                  
         BNZ   ALWEEK66            YES-DONE                                     
ALWEEK64 AH    R2,LROW             NEXT PRODUCT                                 
         B     ALWEEK60                                                         
ALWEEK66 LTR   RE,RE                                                            
         BNZ   *+6                                                              
         DC    H'0'                PRODUCT A MISSING                            
         LTR   RF,RF                                                            
         BNZ   *+6                                                              
         DC    H'0'                PRODUCT B MISSING                            
         ST    RE,PRDAR                                                         
         ST    RF,PRDBR                                                         
ALWEEK68 MVI   EXCHSW,EXCHCURQ     SET DOING CURRENT VALUATION                  
         MVC   THISSPT,SPOTA                                                    
         MVC   THISPRD,PRDAR                                                    
         GOTOR VALROUT,0           CURRENT A'S                                  
         MVC   SWAPAA(VARWGTSL),VARVALS   SAVE VALUES                           
         MVC   SWAPAA+VARWGTSL(L'BRDVAL),BRDVAL                                 
         L     R6,BRDVAL                                                        
         MVC   THISSPT,SPOTB                                                    
         MVC   THISPRD,PRDBR                                                    
         GOTOR VALROUT,0           CURRENT B'S                                  
         MVC   SWAPBB(VARWGTSL),VARVALS   SAVE VALUES                           
         MVC   SWAPBB+VARWGTSL(L'BRDVAL),BRDVAL                                 
         A     R6,BRDVAL                                                        
         ST    R6,CURVAL           SAVE CURRENT TOTAL                           
                                                                                
***********************************************************************         
* SUBTRACT CURRENT ASSIGNS                                            *         
* NOTE-ADDSUB AND VALUE ROUTINES DON'T RELY ON THE PRD CODE BEING SET *         
* IN THE SBUFFRD SLOT, ONLY THE LENGTH                                *         
***********************************************************************         
                                                                                
         MVC   THISSPT,SPOTA                                                    
         MVC   THISPRD,PRDAR                                                    
         ST    R3,ASLOT            SPOTA SLOT                                   
         GOTOR ADDSUB,1                                                         
         MVC   THISSPT,SPOTB                                                    
         MVC   THISPRD,PRDBR                                                    
         ST    R4,ASLOT            SPOTB SLOT                                   
         GOTOR ADDSUB,1                                                         
*                                  NOW ADD REVERSE ASSIGNS                      
         MVI   EXCHSW,EXCHREVQ     SET DOING REVERSES                           
         MVC   THISSPT,SPOTA                                                    
         MVC   THISPRD,PRDBR                                                    
         ST    R3,ASLOT            SPOTA SLOT                                   
         GOTOR ADDSUB,0                                                         
         MVC   THISSPT,SPOTB                                                    
         MVC   THISPRD,PRDAR                                                    
         ST    R4,ASLOT            SPOTB SLOT                                   
         GOTOR ADDSUB,0                                                         
         MVC   NEWVAL,MAXNEG       NOW EVALUATE REVERSED ASSIGNS                
         GOTOR VALROUT,0           SPOTB + PRDA                                 
         MVC   SWAPBA(VARWGTSL),VARVALS   SAVE VALUES                           
         MVC   SWAPBA+VARWGTSL(L'BRDVAL),BRDVAL                                 
         CLC   BRDVAL,MAXNEG       IF REJECT- NO SWAP                           
         BE    ALWEEK70                                                         
         L     R6,BRDVAL                                                        
         MVC   THISSPT,SPOTA       SPOTA + PRDB                                 
         MVC   THISPRD,PRDBR                                                    
         GOTOR VALROUT,0                                                        
         MVC   SWAPAB(VARWGTSL),VARVALS   SAVE VALUES                           
         MVC   SWAPAB+VARWGTSL(L'BRDVAL),BRDVAL                                 
         CLC   BRDVAL,MAXNEG       IF REJECT - NO SWAP                          
         BE    ALWEEK70                                                         
         A     R6,BRDVAL                                                        
         ST    R6,NEWVAL                                                        
ALWEEK70 MVI   EXCHSW,EXCHNULQ     CLEAR EXCHANGE MODE SWITCH                   
         ST    R3,SLOTA            FOR TRACE                                    
         ST    R4,SLOTB                                                         
         MVI   PVMODE2,PVMODE2Q                                                 
         GOTOR PRTVAR                                                           
         CLC   BRDVAL,MAXNEG       IF ANY REJECT                                
         BE    ALWEEK72            NO SWAP                                      
         C     R6,CURVAL           IF NEW IS WORSE, NO SWAP(ON TIE,             
         BL    ALWEEK72            PRESERVE SWAP RATHER THAN RESET)             
*                                  SWAP ALLOCATIONS                             
         L     R5,THISSPT          SPOTA                                        
         OI    SBSTAT,SBSAEXCQ     SET ALLOC'D IN EXCHANGE PHASE                
         ST    R3,ASLOT            SPOTA SLOT                                   
         GOTOR PUTALC                                                           
         MVC   THISSPT,SPOTB                                                    
         MVC   THISPRD,PRDAR                                                    
         L     R5,SPOTB                                                         
         OI    SBSTAT,SBSAEXCQ                                                  
         ST    R4,ASLOT            SPOTB SLOT                                   
         GOTOR PUTALC                                                           
         B     ALWEEK54                                                         
ALWEEK72 MVC   THISSPT,SPOTA       NO SWAP - RESTORE ORIGINAL ASSIGNS           
         MVC   THISPRD,PRDBR       FIRST SUBTRACT REVERSE ASSIGNS               
         GOTOR ADDSUB,1                                                         
         MVC   THISSPT,SPOTB                                                    
         MVC   THISPRD,PRDAR                                                    
         ST    R4,ASLOT            SPOTB SLOT                                   
         GOTOR ADDSUB,1                                                         
         MVC   THISSPT,SPOTA       NO SWAP - RESTORE ORIGINALS                  
         MVC   THISPRD,PRDAR                                                    
         ST    R3,ASLOT            SPOTA SLOT                                   
         GOTOR ADDSUB,0                                                         
         MVC   THISSPT,SPOTB                                                    
         MVC   THISPRD,PRDBR                                                    
         ST    R4,ASLOT            SPOTB SLOT                                   
         GOTOR ADDSUB,0                                                         
         L     R5,SPOTA                                                         
         NI    SBSTAT,FF-SBSRJCTQ  CLEAR REJECT BITS                            
         L     R5,SPOTB                                                         
         NI    SBSTAT,FF-SBSRJCTQ  CLEAR REJECT BITS                            
         B     ALWEEK54            NEXT SPOTB SLOT                              
ALWEEK76 L     R5,SPOTA            NEXT SPOTA                                   
         A     R5,SPTTABL                                                       
         ST    R5,SPOTA                                                         
         XC    SPOTB,SPOTB                                                      
         B     ALWEEK44                                                         
                                                                                
********************************************************************            
* HANDLE SPLIT 30'S                                                *            
********************************************************************            
                                                                                
ALWEEK78 CLI   SPLTOPT,SECS15      IF DOING 15 SPLITS                           
         BNE   ALWEEK94                                                         
         MVI   ALPHASE,ALPS30Q     30'S PHASE (FOR PUTALC)                      
*                                  GET RID OF 'PARTIAL UNALLOCATEDS'            
         L     R5,ASPTTAB          FIRST SPOT                                   
ALWEEK80 CLI   0(R5),FF            EOL                                          
         BE    ALWEEK94                                                         
         CLI   SBPRD1,0            IF THIS ONE UNALL                            
         BE    ALWEEK92            IGNORE FOR NOW                               
         TM    SBSEQ,X'01'         IS IT 1ST OF A PAIR                          
         BNZ   ALWEEK86                                                         
         LR    RF,R5               YES, POINT TO 2ND                            
         A     RF,SPTTABL                                                       
         CLI   SBPRD1-SBUFFRD(RF),0 IF 2ND UNALL                                
         BNE   ALWEEK92                                                         
*                                  THEN UNALLOCATE 1ST                          
         L     R2,AFSTBRD          FIRST FIND PRODUCT TABLE ENTRY               
ALWEEK82 CLI   TABPRD,0                                                         
         BNE   *+6                                                              
         DC    H'0'                PRODUCT MISSING                              
         CLC   SBPRD1,TABPRD                                                    
         BNE   ALWEEK84                                                         
         ST    R2,THISPRD                                                       
         ST    R5,THISSPT                                                       
         LA    RE,SBPRD1                                                        
         ST    RE,ASLOT                                                         
         GOTOR ADDSUB,1            SUBTRACT SPOT/PRODUCT FROM ACH TBLS          
         MVI   SBPRD1,0                                                         
         MVI   SBLEN1,0                                                         
         MVI   SBUNLEN,SECS15                                                   
         GOTOR PUTALC              WRITE BACK TO BUFFER                         
         B     ALWEEK92                                                         
ALWEEK84 AH    R2,LROW             NEXT PRODUCT                                 
         B     ALWEEK82                                                         
*                                  HERE IF HAVE 2ND OF A PAIR                   
ALWEEK86 LR    RF,R5               POINT TO 1ST                                 
         S     RF,SPTTABL                                                       
         CLI   SBPRD1-SBUFFRD(RF),0   IF 1ST UNALL                              
         BNE   ALWEEK92                                                         
*                                  THEN UNALLOCATE 2ND                          
         L     R2,AFSTBRD          FIRST FIND PRODUCT TABLE ENTRY               
ALWEEK88 CLI   TABPRD,0                                                         
         BNE   *+6                                                              
         DC    H'0'                PRODUCT MISSING                              
         CLC   SBPRD1,TABPRD                                                    
         BNE   ALWEEK90                                                         
         ST    R2,THISPRD                                                       
         ST    R5,THISSPT                                                       
         LA    RE,SBPRD1                                                        
         ST    RE,ASLOT                                                         
         GOTOR ADDSUB,1            SUBTRACT SPOT/PRODUCT FROM ACH TBLS          
         MVI   SBPRD1,0                                                         
         MVI   SBLEN1,0                                                         
         MVI   SBUNLEN,SECS15                                                   
         GOTOR PUTALC              WRITE BACK TO BUFFER                         
         B     ALWEEK92                                                         
ALWEEK90 AH    R2,LROW             NEXT PRODUCT                                 
         B     ALWEEK88                                                         
ALWEEK92 A     R5,SPTTABL                                                       
         B     ALWEEK80                                                         
ALWEEK94 MVI   PVMODE2,PVMODE1Q    PRINT FINAL PRODUCT STATUS                   
         GOTOR PRTVAR                                                           
         MVI   PSMODE,PSMSPTQ                                                   
         GOTOR PRTSPT              PRINT SPOT TABLE                             
         MVI   PVMODE1,SPACE                                                    
         MVI   PVMODE2,SPACE                                                    
*                                  DETAIL REPORT                                
ALWEEK96 CLC   NTARGETS,=Y(2)      IF 3+ TARGETS                                
         BNH   *+12                                                             
         GOTOR DETRPT                                                           
         B     *+8                                                              
         GOTOR DT2RPT              ELSE MODE 2                                  
ALWEEKX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* ROUTINE TO GET PRODUCT/SPOT                                         *         
***********************************************************************         
                                                                                
GPRSPT   NTR1  ,                                                                
GPRSPT02 OC    WSECS,WSECS         SET OFF PRODUCT LEVEL NO-OPS                 
         BZ    GPRSPTX                                                          
         LA    RF,VARCTLS                                                       
         LHI   R0,VARWGTSN                                                      
         NI    0(RF),FF-VNOPQ      SET OFF 80                                   
         AHI   RF,4                                                             
         BCT   R0,*-8                                                           
                                                                                
         XC    BESTPRD,BESTPRD     GET MOST DESERVING PRODUCT                   
         L     R2,AFSTBRD                                                       
LOC      USING TABD,R2                                                          
         LR    R4,R2                                                            
         AH    R4,WKDISP                                                        
         MVC   FULL,MAXNEG                                                      
         MVC   DUB(L'FULL),MAXNEG                                               
GPRSPT04 CLI   LOC.TABPRD,0                                                     
         BE    GPRSPT14                                                         
         CLI   LOC.TABNOSPT,0      SKIP IF NO USABLE SPOTS FOR PRODUCT          
         BNE   GPRSPT12                                                         
         ICM   R0,15,TRSCGOL-TABDATA(R4) MUST BE ACTIVE IN WEEK                 
         BNP   GPRSPT12                                                         
*                                  SET PCT UNACH                                
         L     R1,TSAVDEM-TABDATA(R4) REMAINDER                                 
         LTR   R1,R1               IF OVERACHIEVED                              
         BP    GPRSPT06                                                         
         CLI   LOC.TABPRI,YESQ     DON'T GIVE PRIORITY BRAND ANOTHER            
         BE    GPRSPT12                                                         
GPRSPT06 C     R1,DUB              SAVE NUMERICALY GREATEST REMAINDER           
         BL    GPRSPT08                                                         
         ST    R2,HIPRD            SAVE PRODUCT                                 
         ST    R1,DUB                                                           
GPRSPT08 M     R0,FW100                                                         
         L     RF,LOC.TABGOAL      GOAL                                         
         L     RE,WAVGOAL                                                       
         SRL   RE,3                PLUS 1/8 OF AVERAGE GOAL                     
         AR    RF,RE               NOTE-USING ADJUSTED DENOMINATOR              
         GOTOR DIVIDE              YIELDS BETTER VARIABLE - ESPECIALLY          
*                                  WHEN ACH IS ZERO                             
GPRSPT10 C     R1,FULL             SAVE HIGH VALUE                              
         BNH   GPRSPT12                                                         
         ST    R2,BESTPRD                                                       
         ST    R1,FULL                                                          
                                                                                
GPRSPT12 AH    R2,LROW                                                          
         AH    R4,LROW                                                          
         B     GPRSPT04                                                         
                                                                                
GPRSPT14 ICM   R2,15,BESTPRD                                                    
         BZ    GPRSPTX                                                          
         CLI   CPMSOPTN,CPMSDLNQ                                                
         BE    *+12                                                             
         AH    R2,WKDISP           USE WEEKLY                                   
         B     *+8                                                              
         AHI   R2,TABDATA-TABD     OR SCHEDULE                                  
         OC    4(8,R2),4(R2)       IF BRAND HAS NO ACH                          
         BNZ   *+8                                                              
         OI    CPMVAR+VARCTLD,VNOPQ NO-OP CPM VARIABLE                          
                                                                                
         MVC   THISPRD,BESTPRD                                                  
         MVI   PVMODE1,ALPSPTQ                                                  
         MVI   PVMODE2,PVMODE1Q                                                 
         GOTOR PRTVAR                                                           
         GOTOR VALROUT,1           EVALUATE SPOTS AND SET BEST                  
         ICM   R5,15,BESTSPT       TEST ANY SPOT SELECTED                       
         BZ    GPRSPT02            NO-TRY ANOTHER BRAND                         
         ST    R5,THISSPT                                                       
         GOTOR PUTALC              RECORD ALLOCATION                            
         GOTOR ADDSUB,0            POST TO TOTALS                               
         B     GPRSPT02                                                         
GPRSPTX  J     EXIT                                                             
         DROP  LOC                                                              
         EJECT                                                                  
***********************************************************************         
* POST ALLOCATION BACK TO BUFFER                                      *         
***********************************************************************         
                                                                                
PUTALC   NTR1  ,                                                                
         L     R5,THISSPT                                                       
         L     R2,THISPRD                                                       
         USING TABD,R2                                                          
         CLI   ALPHASE,ALPSPTQ     SPOT PHASE                                   
         BE    PUTALC02                                                         
         CLI   ALPHASE,ALPBRDQ     BRAND PHASE                                  
         BE    PUTALC12                                                         
         CLI   ALPHASE,ALPXCHQ     EXCH PHASE                                   
         BE    PUTALC16                                                         
         CLI   ALPHASE,ALPS30Q     SPLIT 30'S PHASE                             
         BE    PUTALC14                                                         
*                                  SPOT PHASE                                   
PUTALC02 LA    R3,SBPRD1           FIND SLOT FOR ALLOCATION                     
         LHI   R0,SBMAXALC                                                      
PUTALC04 CLI   0(R3),0                                                          
         BE    *+14                                                             
         AHI   R3,2                2 BYTES PER ALLOC                            
         BCT   R0,PUTALC04                                                      
         DC    H'0'                NO SLOTS AVAILABLE                           
         MVC   0(1,R3),TABPRD      SET PRODUCT CODE                             
         MVC   1(1,R3),TABSLN      SET LENGTH                                   
         TM    REQFLAG2,REQFSSLN   TEST IF ALL SLNS TOGETHER                    
         BNZ   PUTALC08                                                         
         MVC   1(1,R3),SBPDLEN     YES- USE TRUE LENGTH                         
         MVI   SBUNLEN,0                                                        
         B     PUTALC10                                                         
PUTALC08 SR    R0,R0                                                            
         IC    R0,SBUNLEN          DECREMENT UNALL LENGTH                       
         SR    R1,R1                                                            
         IC    R1,1(R3)                                                         
         SR    R0,R1                                                            
         BNM   *+6                                                              
         DC    H'0'                LENGTH CANNOT GO NEGATIVE                    
         STC   R0,SBUNLEN                                                       
PUTALC10 ST    R3,ASLOT            SET SLOT POSITION                            
         B     PUTALC18                                                         
*                                  'B' PHASE                                    
PUTALC12 B     PUTALC18            PRODUCT/LEN ALREADY SET                      
*                                  '3' PHASE                                    
PUTALC14 B     PUTALC18            PRODUCT/LEN ALREADY SET                      
PUTALC16 L     RF,ASLOT            'X' PHASE                                    
         MVC   0(1,RF),TABPRD      SET PRODUCT CODE                             
         MVC   1(1,RF),TABSLN      SET SLN                                      
         TM    REQFLAG2,REQFSSLN   TEST IF ALL SLNS TOGETHER                    
         BNZ   *+10                                                             
         MVC   1(1,RF),SBPDLEN     YES- USE TRUE LENGTH                         
PUTALC18 NI    SBSTAT,FF-SBSRJCTQ  RESET REJECTS                                
         MVC   W(SBTOTLN),SBUFFRD                                               
         LR    R0,R5               SAVE A(SPOT TABLE ENTRY)                     
         LA    R5,W                READ INTO W                                  
         GOTOR BU2RDH                                                           
         LR    R5,R0               RESTORE A(SPOT TABLE ENTRY)                  
         CLC   SBUFFK(SBUFFKL),W                                                
         BE    *+6                                                              
         DC    H'0'                                                             
         GOTOR BU2PUT                                                           
PUTALCX  J     EXIT                                                             
         DROP  R2,R8,RB                                                         
                                                                                
PRDAR    DS    A                                                                
PRDBR    DS    A                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* POST ALLOCATION RESULT TO PRODUCT TABLE                             *         
***********************************************************************         
                                                                                
ADDSUB   NTR1  BASE=*,LABEL=*                                                   
         L     R5,THISSPT                                                       
         USING SBUFFRD,R5                                                       
                                                                                
         MVI   ACHSW,ACHSADDQ      SET ADD MODE                                 
         LTR   R1,R1                                                            
         BZ    ADDSUB04                                                         
         MVI   ACHSW,ACHSSUBQ      SET SUBTRACT MODE                            
                                                                                
         ICM   R0,15,SBCOST                                                     
         LCR   R0,R0                                                            
         STCM  R0,15,SBCOST                                                     
         ICM   R0,15,SBCDEM                                                     
         LCR   R0,R0                                                            
         STCM  R0,15,SBCDEM                                                     
                                                                                
         LA    RE,SBTARGS                                                       
         SR    R0,R0                                                            
         ICM   R0,3,NTARGETS                                                    
         BZ    ADDSUB04                                                         
ADDSUB02 L     RF,0(RE)                                                         
         LCR   RF,RF                                                            
         ST    RF,0(RE)                                                         
         AHI   RE,L'SBTARGS                                                     
         BCT   R0,ADDSUB02                                                      
                                                                                
ADDSUB04 ICM   R2,15,ASLOT                                                      
         BNZ   *+8                 ASLOT MAY NOT BE SET ON                      
         LA    R2,SBPRD1                                                        
         MVC   X,SBCOST            SAVE UNIT COST, BASE, AND TARGS              
                                                                                
         L     R3,THISPRD                                                       
         USING TABD,R3                                                          
         LA    R4,TABD                                                          
         AH    R4,WKDISP           POINT TO WEEK FOR PRODUCT                    
         TM    REQFLAG1,REQFTRGS   TARGETS                                      
         BZ    ADDSUB14                                                         
         LA    R1,TABTA1-TABDATA   STARTING CELLD                               
         LA    RE,X+8              TARGS AT X+8                                 
         LH    R0,NTARGETS                                                      
ADDSUB12 L     RF,0(R4,R1)         WEEK                                         
         A     RF,0(RE)                                                         
         ST    RF,0(R4,R1)                                                      
         L     RF,TRSCGOL(R1)      TOTAL                                        
         A     RF,0(RE)                                                         
         ST    RF,TRSCGOL(R1)                                                   
         AHI   R1,L'TABTA1         NEXT TARGET                                  
         AHI   RE,4                                                             
         BCT   R0,ADDSUB12                                                      
                                                                                
ADDSUB14 L     RF,X+4              BASE DEM AT X+4                              
         A     RF,4(R4)                                                         
         ST    RF,4(R4)                                                         
         L     RF,X+0              COST AT X+0                                  
         A     RF,8(R4)                                                         
         ST    RF,8(R4)                                                         
         LH    RF,HW10             1.0 UNITS                                    
         CLI   ACHSW,ACHSADDQ      ADD IF ADDING                                
         BE    *+6                                                              
         LCR   RF,RF               ELSE SUBTRACT                                
         A     RF,12(R4)                                                        
         ST    RF,12(R4)                                                        
         L     RF,16(R4)           REMAINDER                                    
         L     R0,X+0              SUBTRACT COST                                
         CLI   GOALOPT,GOALDOLS                                                 
         BE    ADDSUB16                                                         
         L     R0,X+4              OR DEMO VALUE                                
         TM    REQFLAG1,REQFMIXB   IF MIXED DEMO GOALS                          
         BZ    ADDSUB16                                                         
         SR    RE,RE                                                            
         ICM   RE,1,TABGLDEM                                                    
         BZ    ADDSUB16            AND BRAND DEMO NOT = CORP                    
         BCTR  RE,0                                                             
         SLL   RE,2                                                             
         LA    RE,X+8(RE)          TARGS AT X+8                                 
         L     R0,0(RE)            USE BRAND DEMO                               
ADDSUB16 SR    RF,R0                                                            
         ST    RF,16(R4)                                                        
*                                  ** TOTALS **                                 
         L     RF,X+4              DEMO AT X+4                                  
         A     RF,TPREDEM                                                       
         ST    RF,TPREDEM                                                       
         L     RF,X+0              COST AT X+0                                  
         A     RF,TPREDOL                                                       
         ST    RF,TPREDOL                                                       
         LH    RF,HW10             1.0 UNITS                                    
         CLI   ACHSW,ACHSADDQ      ADD IF ADDING                                
         BE    *+6                                                              
         LCR   RF,RF               ELSE SUBTRACT                                
         A     RF,TPREUNT                                                       
         ST    RF,TPREUNT                                                       
         L     RF,TSAVDEM          REMAINDER                                    
         L     R0,X+0              SUBTRACT COST                                
         CLI   GOALOPT,GOALDOLS                                                 
         BE    ADDSUB18                                                         
         L     R0,X+4              OR DEMO VALUE                                
         TM    REQFLAG1,REQFMIXB   IF MIXED DEMO GOALS                          
         BZ    ADDSUB18                                                         
         SR    RE,RE                                                            
         ICM   RE,1,TABGLDEM                                                    
         BZ    ADDSUB18            AND BRAND DEMO NOT = CORP                    
         BCTR  RE,0                                                             
         SLL   RE,2                                                             
         L     R0,TABTA1-TABDATA(R4,RE) USE BRAND DEMO                          
ADDSUB18 SR    RF,R0                                                            
         ST    RF,TSAVDEM                                                       
*                                  POST TO ALL ENV COUNTER TABLES               
ADDSUB20 MVI   ENVNO,0             START WITH ENV1                              
ADDSUB22 SR    R7,R7                                                            
         IC    R7,ENVNO            BUMP ENVIRONMENT NUMBER                      
         AHI   R7,1                                                             
         STC   R7,ENVNO                                                         
         CLI   ENVNO,NENVS         TEST ALL DONE                                
         BH    ADDSUB32                                                         
         SLL   R7,2                                                             
         L     R7,AENV1SET-L'AENV1SET(R7)                                       
         USING ENVSETD,R7                                                       
         OC    ENVSVAR,ENVSVAR     IS VARIABLE ACTIVE                           
         BNZ   ADDSUB24            YES                                          
         CLI   ENVNO,ENVNPGMQ      OR IF ENV1                                   
         BNE   ADDSUB22                                                         
         CLI   PINTRVL,0           AND INTERVAL CHECK ACTIVE                    
         BNE   ADDSUB24                                                         
         CLI   CINTRVL,0                                                        
         BE    ADDSUB22                                                         
                                                                                
ADDSUB24 SR    R1,R1               POST TO ENVIRONMENT TABLES                   
         IC    R1,TABPRD           PRODUCT CODE                                 
         A     R1,APRDTRT                                                       
         SR    RE,RE                                                            
         IC    RE,0(R1)            DISPLACEMENT CODE                            
         MH    RE,ENVPRDD                                                       
         SR    R1,R1                                                            
         IC    R1,ENVNO                                                         
         SLL   R1,1                                                             
         LH    R1,SBENV1-L'SBENV1(R1)                                           
         SLL   R1,1                                                             
         LH    R1,ENVSTTAB(R1)                                                  
         MH    R1,ENVENVD                                                       
         AR    R1,RE                                                            
         ST    R1,DUB              SAVE TOTAL DISP                              
         A     R1,ENVSACNT         R1 POINTS TO RIGHT COUNTER SET               
         GOTOR ADDTOT              BUMP TOTAL COUNTER                           
         SR    RE,RE                                                            
         IC    RE,SBWK             DO FOR THIS WEEK                             
         SLL   RE,1                2 BYTES PER WEEK                             
         AR    R1,RE                                                            
         GOTOR ADDTOT                                                           
         CLI   CINTRVL,0           TEST NEED CLASSES                            
         BE    ADDSUB22                                                         
         CLI   ENVNO,ENVNPGMQ      CLASSES ONLY FOR ENV 1                       
         BNE   ADDSUB22                                                         
         GOTOR SETCLS,TABPRDC                                                   
         BE    ADDSUB22            SKIP IF NO CLASS                             
ADDSUB28 SR    R1,R1                                                            
         ICM   R1,1,CLASS1         CLASS CODE                                   
         BZ    ADDSUB30                                                         
         A     R1,ACLSTRT                                                       
         SR    RE,RE                                                            
         IC    RE,0(R1)            DISPLACEMENT CODE                            
         MH    RE,ENVPRDD                                                       
         SR    R1,R1                                                            
         IC    R1,ENVNO                                                         
         SLL   R1,1                                                             
         LH    R1,SBENV1-L'SBENV1(R1)                                           
         SLL   R1,1                                                             
         LH    R1,ENVSTTAB(R1)                                                  
         MH    R1,ENVENVD                                                       
         AR    R1,RE                                                            
         ST    R1,DUB              SAVE TOTAL DISP                              
         A     R1,ENVSACNT         R1 POINTS TO RIGHT COUNTER SET               
         GOTOR ADDTOT              BUMP TOTAL COUNTER                           
         SR    RE,RE                                                            
         IC    RE,SBWK             DO FOR THIS WEEK                             
         SLL   RE,1                2 BYTES PER WEEK                             
         AR    R1,RE                                                            
         GOTOR ADDTOT                                                           
                                                                                
ADDSUB30 CLI   CLASS2,0            TEST NEED TO DO 2ND OF 2 PART CLASS          
         BE    ADDSUB22            NO                                           
         MVC   CLASS1,CLASS2                                                    
         MVI   CLASS2,0                                                         
         B     ADDSUB28                                                         
                                                                                
ADDSUB32 CLI   ACHSW,ACHSSUBQ      IF SUBTRACT MODE                             
         BNE   ADDSUBX                                                          
         ICM   R0,15,SBCOST        RE-COMPLEMENT VALUES                         
         LCR   R0,R0                                                            
         STCM  R0,15,SBCOST                                                     
         ICM   R0,15,SBCDEM                                                     
         LCR   R0,R0                                                            
         STCM  R0,15,SBCDEM                                                     
                                                                                
         LA    RE,SBTARGS                                                       
         SR    R0,R0                                                            
         ICM   R0,3,NTARGETS                                                    
         BZ    ADDSUBX                                                          
ADDSUB34 L     R1,0(RE)                                                         
         LCR   R1,R1                                                            
         ST    R1,0(RE)                                                         
         AHI   RE,L'SBTARGS                                                     
         BCT   R0,ADDSUB34                                                      
                                                                                
ADDSUBX  J     EXIT                                                             
         DROP  R3,R7                                                            
                                                                                
ADDTOT   LH    RF,0(R1)            BUMP ENV COUNTER                             
         LHI   R0,10               EQUIVALENT UNITS                             
         CLI   ACHSW,ACHSADDQ                                                   
         BE    *+6                                                              
         LCR   R0,R0               OR SUBTRACT                                  
         AR    RF,R0                                                            
         BNM   *+6                 SHOULD NEVER GO -VE                          
         SR    RF,RF               SET TO ZERO IF IT DOES                       
         STH   RF,0(R1)                                                         
         BR    RE                                                               
         DROP  RB                                                               
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* CLASS CHECK FOR TWO BRANDS IN PSEUDO-PIG                            *         
*                                                                     *         
* NTRY - P1 B0   - PRODUCT 1 NUMBER (IF P1 B1-3 ZERO) OR              *         
*           B1-3 - A(PRODUCT 1 ENTRY)                                 *         
*        P2 B0   - PRODUCT 2 NUMBER (IF P2 B1-3 ZERO) OR              *         
*           B1-3 - A(PRODUCT 2 ENTRY)                                 *         
***********************************************************************         
                                                                                
CHKCLS   NTR1  BASE=*,LABEL=*                                                   
PR1      USING TABD,R2                                                          
         ICM   R2,7,1(R1)          TEST A(PRODUCT 1) SUPPLIED                   
         BNZ   CHKCLS04                                                         
         L     R2,AFSTBRD          PRODUCT TABLE ENTRY FOR 1ST                  
CHKCLS02 CLI   PR1.TABPRD,0                                                     
         BNE   *+6                                                              
         DC    H'0'                PRODUCT MISSING                              
         CLC   PR1.TABPRD,0(R1)                                                 
         BE    CHKCLS04                                                         
         AH    R2,LROW             NEXT ROW                                     
         B     CHKCLS02                                                         
PR2      USING TABD,R3                                                          
CHKCLS04 ICM   R3,7,5(R1)          TEST A(PRODUCT 2) SUPPLIED                   
         BNZ   CHKCLS08                                                         
         L     R3,AFSTBRD          PRODUCT TABLE ENTRY FOR 2ND                  
CHKCLS06 CLI   PR2.TABPRD,0                                                     
         BNE   *+6                                                              
         DC    H'0'                PRODUCT MISSING                              
         CLC   PR2.TABPRD,4(R1)                                                 
         BE    CHKCLS08                                                         
         AH    R3,LROW             NEXT ROW                                     
         B     CHKCLS06                                                         
CHKCLS08 CLI   SPCLOPTN,0          'SPECIAL CLASS' CODE                         
         BE    CHKCLS10                                                         
         CLI   PR1.TABPRDC,TWOPTCLS                                             
         BNH   CHKCLS10            SINGLE CLASSES                               
         CLI   PR2.TABPRDC,TWOPTCLS                                             
         BNH   CHKCLS10                                                         
         CLC   PR1.TABPRDC,PR2.TABPRDC                                          
         BNE   CHKCLS10                                                         
         CLC   PR1.TABPRDC,SPCLOPTN AND ITS THE 'SPECIAL' CLASS                 
         BE    CHKCLSX                                                          
CHKCLS10 XC    DUB,DUB             SET VARIOUS CLASSES IN DUB                   
         GOTOR SETCLS,PR1.TABPRDC                                               
         BE    CHKCLSX             NO CLASS - OK                                
         MVC   DUB+0(2),CLASS1                                                  
         GOTOR SETCLS,PR2.TABPRDC                                               
         BE    CHKCLSX             NO CLASS - OK                                
         MVC   DUB+2(2),CLASS1                                                  
         LA    R1,DUB+0            NOW TRY ALL COMBOS                           
         LA    RF,DUB+2                                                         
         GOTOR CLSCMP                                                           
         BE    CHKCLSN                                                          
         LA    RF,DUB+3                                                         
         GOTOR CLSCMP                                                           
         BE    CHKCLSN                                                          
         LA    R1,DUB+1                                                         
         LA    RF,DUB+2                                                         
         GOTOR CLSCMP                                                           
         BE    CHKCLSN                                                          
         LA    RF,DUB+3                                                         
         GOTOR CLSCMP                                                           
         BE    CHKCLSN                                                          
CHKCLSY  CR    RE,RE               OK, SET CC EQUAL                             
         B     CHKCLSX                                                          
                                                                                
CHKCLSN  LTR   RE,RE               NOT OK, SET CC NOT EQUAL                     
CHKCLSX  J     EXIT                                                             
         DROP  PR1,PR2                                                          
                                                                                
CLSCMP   CLC   0(1,R1),0(RF)       CLASSES EQUAL                                
         BNER  RE                  NO, RETURN CC NOT EQU                        
         CLI   0(R1),0             IF EQUAL BUT 0, THATS OK TOO                 
         BE    *+8                                                              
         CR    RE,RE               SET CC EQUAL                                 
         BR    RE                                                               
         LTR   RE,RE               SET CC NOT EQUAL                             
         BR    RE                                                               
         DROP  RB                                                               
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* VALUATION ROUTINES                                                  *         
***********************************************************************         
                                                                                
VALROUT  NTR1  BASE=*,LABEL=*                                                   
         LTR   R1,R1                                                            
         BNZ   VALSPT                                                           
                                                                                
***********************************************************************         
* VALUE BRAND FOR SPOT                                                *         
***********************************************************************         
                                                                                
VALBRD   L     R5,THISSPT                                                       
         USING SBUFFRD,R5                                                       
         NI    SBSTAT,FF-SBSRJCTQ  CLEAR REJECT BITS                            
         MVC   BRDVAL,MAXNEG       SET TO MAXIMUM NEGATIVE                      
         XC    VARVALS(VARWGTSL),VARVALS                                        
         L     R2,THISPRD          TEST BRAND ACTIVE IN WEEK                    
         AH    R2,WKDISP                                                        
         OC    0(4,R2),0(R2)                                                    
         BZ    VALBRDX                                                          
         GOTOR SPTUSE              TEST SPOT USABLE FOR BRAND                   
         BNZ   VALBRD10            NO                                           
         XC    BRDVAL,BRDVAL                                                    
         L     R2,THISPRD                                                       
         ICM   R1,15,SBCOST        SET COST SHARE                               
         ST    R1,COSTSHR          RETURNED IN R1                               
         LA    RF,VSBRTAB                                                       
         LA    R3,VARWGTS                                                       
         LA    R4,VARVALS                                                       
         LHI   R0,VARWGTSN                                                      
VALBRD02 OC    0(L'VARWGTS,R3),0(R3) TEST VAR ACTIVE                            
         BZ    VALBRD06                                                         
         CLI   VARCTLD(R3),0       TEST NO-OP'D                                 
         BNE   VALBRD06                                                         
                                                                                
         XC    HLDVAR,HLDVAR                                                    
         LA    RE,VALBRD04                                                      
         NTR1  ,                                                                
         BR    RF                                                               
                                                                                
VALBRD04 TM    SBSTAT,SBSRJCTQ     TEST REJECT                                  
         BNZ   VALBRD10                                                         
         MVC   0(L'VARVALS,R4),HLDVAR                                           
         L     R1,0(R4)            SUM VALUES - VALUE                           
         MH    R1,2(R3)            X WEIGHT                                     
         A     R1,BRDVAL                                                        
         ST    R1,BRDVAL                                                        
                                                                                
VALBRD06 AHI   RF,L'VSBRTAB        NEXT VAR                                     
         AHI   R3,L'VARWGTS                                                     
         AHI   R4,L'VARVALS                                                     
         BCT   R0,VALBRD02                                                      
                                                                                
         L     R0,BRDVAL           TEST VS CURRENT BEST                         
         C     R0,BESTVAL                                                       
         BL    VALBRD10            NOT AS GOOD                                  
         BH    VALBRD08            BETTER                                       
         CLC   THISPRD,CURPRD      IF = SELECT ONLY IF CURRENT ASSIGN           
         BNE   VALBRD10                                                         
VALBRD08 ST    R0,BESTVAL                                                       
         ST    R2,BESTPRD                                                       
VALBRD10 CLI   ALPHASE,ALPXCHQ     ON EXCHANGE PHASE SKIP TRACE                 
         BE    VALBRDX                                                          
VALBRD12 MVI   PVMODE2,PVMODE2Q    FOR VARIABLE TRACE                           
         GOTOR PRTVAR                                                           
VALBRDX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* SET VARIABLES FOR SPOT                                              *         
***********************************************************************         
                                                                                
VALSPT   L     R2,THISPRD                                                       
         USING TABD,R2                                                          
         MVC   BESTVAL,MAXNEG                                                   
         XC    BESTSPT,BESTSPT                                                  
         ICM   R6,15,SPTTABN                                                    
         BZ    VALSPT20                                                         
         L     R5,ASPTTAB                                                       
VALSPT02 NI    SBSTAT,FF-SBSRJCTQ  CLEAR REJECT BITS                            
         CLI   SBUNLEN,0           TEST ANY UNALLOCATED LENGTH                  
         BE    VALSPT18            NO-REJECT                                    
         CLC   SBUNLEN,TABSLN      NO- LENGTH MUST FIT EXACTLY                  
         BE    VALSPT06                                                         
         TM    REQFLAG2,REQFSSLN   OK IF ALL SLNS TOGETHER                      
         BZ    VALSPT06                                                         
         B     VALSPT18                                                         
VALSPT04 CLC   SBUNLEN,TABSLN      SKIP IF NOT ENOUGH                           
         BL    VALSPT18            ROOM FOR THIS LENGTH                         
VALSPT06 CLI   SBPRD2,0            SKIP IF NO ALLOC SLOTS LEFT                  
         BNE   VALSPT18                                                         
         ST    R5,THISSPT                                                       
         ICM   R1,15,SBCOST        SET COST SHARE                               
         ST    R1,COSTSHR          RETURNED IN R1                               
         XC    SPTVAL,SPTVAL                                                    
         GOTOR SPTUSE              TEST SPOT USABLE FOR BRAND                   
         BNZ   VALSPT16            NO                                           
VALSPT08 XC    VARVALS(VARWGTSL),VARVALS                                        
         LA    RF,VSBRTAB                                                       
         LA    R3,VARWGTS                                                       
         LA    R4,VARVALS                                                       
         LHI   R0,VARWGTSN                                                      
VALSPT10 OC    0(L'VARWGTS,R3),0(R3) TEST VARIABLE ACTIVE                       
         BZ    VALSPT14            (WEIGHT NOT EQUAL ZERO)                      
         CLI   VARCTLD(R3),0       TEST NO-OP'D                                 
         BNE   VALSPT14                                                         
                                                                                
         XC    HLDVAR,HLDVAR                                                    
         LA    RE,VALSPT12                                                      
         NTR1  ,                                                                
         BR    RF                                                               
                                                                                
VALSPT12 TM    SBSTAT,SBSRJCTQ     TEST REJECT                                  
         BNZ   VALSPT16                                                         
         MVC   0(L'VARVALS,R4),HLDVAR                                           
         L     R1,0(R4)            SUM VALUES - VALUE                           
         MH    R1,2(R3)            X WEIGHT                                     
         A     R1,SPTVAL                                                        
         ST    R1,SPTVAL                                                        
                                                                                
VALSPT14 AHI   RF,L'VSBRTAB        NEXT VARIABLE                                
         AHI   R3,L'VARWGTS                                                     
         AHI   R4,L'VARVALS                                                     
         BCT   R0,VALSPT10                                                      
                                                                                
         L     R0,SPTVAL           TEST VS CURRENT BEST                         
         C     R0,BESTVAL                                                       
         BNH   VALSPT16                                                         
         ST    R0,BESTVAL          SAVE BEST VALUE                              
         ST    R5,BESTSPT          SAVE BEST SPOT                               
VALSPT16 MVI   PVMODE2,PVMODE2Q                                                 
         GOTOR PRTVAR                                                           
VALSPT18 A     R5,SPTTABL          NEXT SPOT                                    
         BCT   R6,VALSPT02                                                      
                                                                                
VALSPT20 OC    BESTSPT,BESTSPT                                                  
         BNZ   VALSPT22                                                         
         MVI   TABNOSPT,FF         SET NO USABLE SPOT FOR PRODUCT               
         B     VALSPTX                                                          
VALSPT22 L     RF,WSECS            DECREMENT REMAINING LENGTH                   
         SR    R0,R0                                                            
         IC    R0,TABSLN           BY LENGTH BEING ALLOCATED                    
         TM    REQFLAG2,REQFSSLN   BUT IF ALL SLNS TOGETHER                     
         BNZ   *+12                                                             
         L     R5,BESTSPT                                                       
         IC    R0,SBPDLEN          DECREMENT BY SPOT LENGTH                     
         SR    RF,R0                                                            
         BNM   *+6                                                              
         DC    H'0'                                                             
         ST    RF,WSECS                                                         
         MVC   THISSPT,BESTSPT                                                  
         L     R5,THISSPT                                                       
         OI    SBSTAT,SBSASPTQ     SET ALLOCATED IN SPOT PHASE                  
VALSPTX  J     EXIT                                                             
                                                                                
VSBRTAB  DS    0XL4                                                             
         B     GOLFUL              GOAL FULFILLMENT                             
         B     CPPDEV              CPP(M) DEVIATION                             
         B     PRDDSP              PRODUCT DISPERSION                           
         B     STADSP              STATION DISPERSION                           
         B     DOWDSP              DAY OF WEEK DISPERSION                       
         B     TARG01              TARGET 1                                     
         B     TARG02              TARGET 2                                     
         J     EXIT                WAS PROGRAM/PRODUCT INDICES                  
         EJECT                                                                  
***********************************************************************         
* VARIABLE 1  - GOAL FULFILLMENT                                      *         
***********************************************************************         
                                                                                
GOLFUL   L     RF,TABGOAL          WORKING GOAL                                 
         LA    R4,TABD                                                          
         AH    R4,WKDISP                                                        
         L     R1,TSAVDEM-TABDATA(,R4) REMAINDER                                
         CLI   ALPHASE,ALPSPTQ     SPECIAL FOR SPOT SELECT PHASE                
         BE    GOLFUL10                                                         
         CLI   ALPHASE,ALPXCHQ     FOR EXCHANGE PHASE                           
         BNE   GOLFUL02                                                         
         LNR   R1,R1               USE (-) ABSOLUTE VALUE                       
         B     GOLFUL08            (CURRENT SPOT IN INCLUDED)                   
*                                  BRAND SELECT PHASE                           
GOLFUL02 LTR   R1,R1               IF OVERACHIEVED                              
         BNM   GOLFUL06                                                         
         CLI   TABPRI,YESQ         REJECT PRIORITY BRANDS                       
         BNE   GOLFUL06                                                         
         CLI   SBPRD1,0            OTHERWISE, UNLESS SPOT NOT                   
         BE    GOLFUL06            ASSIGNED IN FIRST PASS                       
         CLC   SBPRD1,TABPRD       OR IS CURRENTLY ASSIGNED                     
         BE    GOLFUL06            TO THIS BRAND                                
GOLFUL04 OI    SBSTAT,SBSPRRJQ                                                  
         B     GOLFULX                                                          
GOLFUL06 L     RE,WAVGOAL                                                       
         SRL   RE,3                ADD 1/8 OF AVG GOAL (NOT FOR EXCH)           
         AR    RF,RE               NOTE- ADJUSTING DENOMINATOR YIELDS           
*                                  A MORE USEFUL VARIABLE - ESPECIALLY          
*                                  WHEN ACH = 0                                 
GOLFUL08 M     R0,FW100                                                         
         GOTOR DIVIDE                                                           
         CLI   TABPRI,YESQ         FOR PRIORITY BRANDS                          
         BNE   GOLFUL14                                                         
         M     R0,FW150            INCREASE VALUE                               
         LH    RF,HW100                                                         
         GOTOR DIVIDE                                                           
         B     GOLFUL14                                                         
*                                  SPOT SELECT PHASE                            
*                                  PENALIZE A SPOT FOR GOING OVER               
*                                  BRANDS GOAL                                  
*                                  NOTE- PRIORITY BRANDS HANDLED                
*                                  IN LOCPRD                                    
GOLFUL10 C     R2,HIPRD            SKIP IF BRAND HAS                            
         BE    GOLFULX             HIGHEST NUMERICAL REMAINDER                  
         ICM   R4,15,COSTSHR                                                    
         CLI   GOALOPT,GOALDOLS                                                 
         BE    *+8                                                              
         ICM   R4,15,SBCDEM                                                     
         SR    R1,R4               ADD TO ALREADY ACHIEVED                      
         BNM   GOLFULX             NO PENALTY IF NOT OVER                       
         M     R0,FW100                                                         
         GOTOR DIVIDE                                                           
         A     R1,FW10             DON'T PENALIZE FIRST 10 PCT                  
         BNM   GOLFULX                                                          
         CHI   R1,-25              ALSO SET CEILING                             
         BNL   *+8                                                              
         LHI   R1,-25                                                           
GOLFUL14 ST    R1,HLDVAR           PCT UNACHIEVED                               
GOLFULX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* VARIABLE  2  -  CPP/M DEVIATION                                     *         
***********************************************************************         
                                                                                
CPPDEV   CLI   CPMSOPTN,CPMSDLNQ                                                
         BE    *+12                                                             
         AH    R2,WKDISP           USE WEEKLY CPM'S                             
         B     *+8                                                              
         AHI   R2,TRSCGOL-TABD     OR WHOLE SCHEDULE                            
         CLI   ALPHASE,ALPBRDQ     DIFFERENT FOR BRAND SELECT PHASE             
         BE    CPPDEV06                                                         
         L     R1,8(R2)            COST SO FAR                                  
         L     RF,4(R2)            DEMO SO FAR                                  
         CLI   ALPHASE,ALPXCHQ     FOR EXCHANGE PHASE                           
         BE    CPPDEV02            DON'T ADD IN THIS SPOT                       
         ICM   R4,15,COSTSHR       PLUS THIS SPOT COST                          
         AR    R1,R4                                                            
         ICM   R4,15,SBCDEM        PLUS THIS DEMO VALUE                         
         AR    RF,R4                                                            
CPPDEV02 M     R0,CPPROUND         GET RESULTANT CPP/M                          
         GOTOR DIVIDE                                                           
         S     R1,WKCPD            GET DIFFERENCE FROM WEEK'S AVG CPP/M         
         LNR   R1,R1               USE (-)  ABSOLUTE VALUE                      
         M     R0,FW100            SET AS PCT OF AVERAGE                        
         L     RF,WKCPD                                                         
         GOTOR DIVIDE                                                           
         CLI   ALPHASE,ALPSPTQ     FOR SPOT PHASE                               
         BNE   CPPDEV08                                                         
         CHI   R1,-40              SET A CEILING                                
         BNL   *+8                 (PREVENTS EXCESSIVE DELAY OF                 
         LHI   R1,-40              WILDLY DIVERGENT BRANDS)                     
         B     CPPDEV08                                                         
*                                  BRAND SELECT PHASE                           
*                                  VALUE IS -                                   
*                                    ABS (OLD CPM - AVG) -                      
*                                    ABS (NEW CPM - AVG) / AVG                  
*                                  (MAY NOT BE PERFECT BUT AT LEAST             
*                                  GUARANTEES MOTION TOWARD CENTER)             
*                                  GET NEW CPM                                  
CPPDEV06 L     R1,8(R2)            CUURENT DOLLARS                              
         L     RF,4(R2)            CURRENT DEMO                                 
         ICM   R4,15,COSTSHR       PLUS THIS SPOT                               
         AR    R1,R4                                                            
         ICM   R4,15,SBCDEM                                                     
         AR    RF,R4                                                            
         M     R0,CPPROUND                                                      
         GOTOR DIVIDE                                                           
         S     R1,WKCPD            LESS AVERAGE                                 
         LPR   R1,R1               ABS                                          
         ST    R1,FULL                                                          
*                                  GET OLD CPM                                  
         L     R1,8(R2)            CURRENT DOLLARS                              
         L     RF,4(R2)            CURRENT DEMO                                 
         M     R0,CPPROUND                                                      
         GOTOR DIVIDE              CPM                                          
         LTR   R1,R1               IF NO CURRENT CPM IGNORE THIS VAR            
         BZ    CPPDEV08                                                         
         S     R1,WKCPD            LESS AVERAGE                                 
         LPR   R1,R1               ABS                                          
         S     R1,FULL             OLD LESS NEW                                 
         M     R0,FW100                                                         
         L     RF,WKCPD            /AVERAGE                                     
         GOTOR DIVIDE                                                           
         LTR   R1,R1               HALVE IF POSITIVE                            
         BM    *+8                                                              
         SRA   R1,1                                                             
CPPDEV08 ST    R1,HLDVAR                                                        
CPPDEVX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* VARIABLE 3 - DISPERSION OF PRODUCTS THRU ENV 1                      *         
***********************************************************************         
                                                                                
PRDDSP   L     R8,AENV1SET         USE ENV 1 VALUE SET                          
         USING ENVSETD,R8                                                       
         MVI   ENVNO,ENVNPGMQ                                                   
PRDDSP02 CLC   ENVSWCNT,FW1        IF ONLY ONE ENV ENTRY                        
         BNH   PRDDSPX             IGNORE VARIABLE                              
         SR    RE,RE                                                            
         IC    RE,TABPRD                                                        
         A     RE,APRDTRT                                                       
         SR    RF,RF                                                            
         IC    RF,0(RE)                                                         
         MH    RF,ENVPRDD          PRODUCT DISP                                 
         SR    RE,RE                                                            
         IC    RE,ENVNO                                                         
         SLL   RE,1                                                             
         LH    RE,SBENV1-L'SBENV1(RE)                                           
         SLL   RE,1                                                             
         LH    RE,ENVSTTAB(RE)                                                  
         MH    RE,ENVENVD          ENV DISP                                     
         AR    RF,RE                                                            
         ST    RF,TOTDISP          DISP FOR TOTAL                               
         SR    RE,RE                                                            
         IC    RE,WEEKNO                                                        
         SLL   RE,1                2 BYTES PER WEEK                             
         AR    RE,RF                                                            
         LR    R6,RE                                                            
         A     R6,ENVSACNT         DO SCORE FOR WEEK                            
         LH    R6,0(R6)            COUNT FOR WEEK                               
         A     RE,ENVSASHR                                                      
         LH    R1,0(RE)            SHARE                                        
         LR    RF,R1                                                            
         SR    R1,R6               SHARE LESS COUNT                             
         M     R0,FW100                                                         
         AH    RF,HW10             NOTE-PCT ON SHARE +1.0 YIELDS BETTER         
         GOTOR DIVIDE              RESULT - ESPECIALLY WHEN COUNT = 0           
         CLI   ALPHASE,ALPSPTQ     FOR SPOT PHASE                               
         BNE   PRDDSP04                                                         
         LTR   R1,R1                                                            
         BNP   *+8                                                              
         SRA   R1,1                HALVE VALUE IF NOT OVER SHARE                
         B     PRDDSP06                                                         
*                                  FOR ADJUSTMENT PHASES                        
PRDDSP04 CLI   ZSPASS,ZSPYESQ      UNLESS ZERO SPOT                             
         BE    PRDDSP06                                                         
         A     R1,FW10             ONLY COUNT 10PCT+ OVERAGES                   
         BM    *+6                                                              
         SR    R1,R1                                                            
         CLI   ALPHASE,ALPXCHQ     FOR EXCHANGE PHASE                           
         BNE   PRDDSP06                                                         
         SRA   R1,1                HALVE                                        
PRDDSP06 LR    R5,R1               SAVE WEEK SCORE                              
*                                  NOW DO OVERALL SCORE                         
         CLC   NWKS,HW1            SKIP IF ONLY ONE WEEK                        
         BE    PRDDSP16                                                         
*                                  FIRST GET SUM OF SHARES IN FULL              
*                                  (IF THIS APPROACH WORKS THIS                 
*                                   SHOULD BE DONE IN SETENV)                   
         LH    RE,NWKS                                                          
         L     R6,TOTDISP                                                       
         A     R6,ENVSASHR                                                      
         AHI   R6,2                START AT WEEK 1                              
         SR    R7,R7                                                            
PRDDSP08 LH    RF,0(R6)                                                         
         AR    R7,RF                                                            
         AHI   R6,2                                                             
         BCT   RE,PRDDSP08                                                      
         ST    R7,FULL             SAVE TOTAL OF SHARES                         
         XC    WORK(8),WORK        NOW SUM SHARES AND COUNTS SO FAR             
         L     R6,TOTDISP                                                       
         A     R6,ENVSACNT         COUNTS                                       
         AHI   R6,2                START AT WEEK 1                              
         L     R7,TOTDISP                                                       
         A     R7,ENVSASHR         SHARES                                       
         AHI   R7,2                START AT WEEK 1                              
         SR    RE,RE                                                            
         IC    RE,WEEKNO                                                        
PRDDSP10 LH    RF,0(R6)            COUNTS                                       
         A     RF,WORK                                                          
         ST    RF,WORK                                                          
         LH    RF,0(R7)            SHARES                                       
         A     RF,WORK+4                                                        
         ST    RF,WORK+4                                                        
         AHI   R6,2                NEXT WEEK                                    
         AHI   R7,2                                                             
         BCT   RE,PRDDSP10                                                      
         L     R1,WORK+4           CUME OF SHARES                               
         M     R0,FW100                                                         
         L     RE,TOTDISP                                                       
         A     RE,ENVSASHR                                                      
         LH    RF,0(RE)            X 'TOTAL' SHARE                              
         MR    R0,RF                                                            
         L     RF,FULL             / SUM OF SHARES                              
         GOTOR DIVIDE                                                           
         A     R1,FW99             FORCE A ROUND UP                             
         SR    R0,R0                                                            
         D     R0,FW100            SET IN UNITS                                 
         LR    RF,R1               (R1 NOW HAS 'ACTUAL SHARE')                  
         S     R1,WORK             SHARE LESS CUME OF COUNTS                    
         M     R0,FW100                                                         
         AH    RF,HW10             NOTE-PCT ON SHARE +1.0 YIELDS BETTER         
         GOTOR DIVIDE              RESULT - ESPECIALLY WHEN COUNT = 0           
         CLI   ALPHASE,ALPSPTQ     FOR SPOT PHASE                               
         BNE   PRDDSP12                                                         
         LTR   R1,R1                                                            
         BNP   *+8                                                              
         SRA   R1,1                HALVE VALUE IF NOT OVER SHARE                
         B     PRDDSP14                                                         
*                                  FOR ADJUSTMENT PHASES                        
PRDDSP12 CLI   ZSPASS,ZSPYESQ      UNLESS ZERO SPOT                             
         BE    PRDDSP14                                                         
         A     R1,FW10             ONLY COUNT 10PCT+ OVERAGES                   
         BM    *+6                                                              
         SR    R1,R1                                                            
*                                  NOTE - GIVE CUME SCORE AND THIS              
*                                  WEEK SCORE EQUAL WEIGHT                      
PRDDSP14 AR    R1,R5               THIS WEEK PLUS CUME                          
         SRA   R1,1                / 2                                          
PRDDSP16 ST    R1,HLDVAR           =RESULT                                      
PRDDSPX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* VARIABLE 4 - DISPERSION BY STATION                                  *         
***********************************************************************         
                                                                                
STADSP   L     R8,AENV2SET         ENV 2 VALUE SET                              
         MVI   ENVNO,ENVNSTAQ                                                   
         B     PRDDSP02            SAME ROUTINE AS FOR ENV 1                    
                                                                                
***********************************************************************         
* VARIABLE 5 - DISPERSION BY DAY OF WEEK                              *         
***********************************************************************         
                                                                                
DOWDSP   L     R8,AENV3SET         ENV 3 VALUE SET                              
         MVI   ENVNO,ENVNDOWQ                                                   
         B     PRDDSP02            SAME ROUTINE AS FOR ENV 1                    
         EJECT                                                                  
***********************************************************************         
* VARIABLE 6 - TARGET 1                                               *         
***********************************************************************         
                                                                                
TARG01   SR    R4,R4               NO TARGET                                    
         CLI   TABPRD,UNAPRD2      IF 'EXCESS' PRODUCT                          
         BE    TARG0104                                                         
         SR    R6,R6                                                            
         IC    R6,TABPRD           GET TARG NO. FROM PTBUFF                     
         BCTR  R6,0                                                             
         MH    R6,PRDBUFLN                                                      
         A     R6,PRDBUFF                                                       
         SR    R4,R4                                                            
         IC    R4,PTTRGS-PTBUFFD(R6)                                            
*                                  NOTE - THIS VARIABLE EVALUATED               
*                                  DIFFERENTLY FOR EACH PHASE                   
TARG0102 CLI   ALPHASE,ALPSPTQ     SPOT SELECT PHASE                            
         BE    TARG0110                                                         
TARG0104 SR    R1,R1               SET VARIABLE TO 0                            
         LTR   R4,R4               IF THIS TARG NOT USED                        
         BZ    TARG0144                                                         
         CLI   ALPHASE,ALPBRDQ     BRAND SELECT PHASE                           
         BE    TARG0126                                                         
*                                  MUST BE EXCHANGE PHASE                       
*                                  CALC RESULTANT 'CPU'                         
*                                  NOTE-SPOT BEING VALUED IS ALREADY            
*                                  ADDED IN                                     
         SLL   R4,2                                                             
         AH    R2,WKDISP                                                        
         L     RF,TABTA1-L'TABTA1-TABDATA(R2,R4) RF HAS RESULTANT ACH           
         LTR   RF,RF               IF NO RESULTANT ACH                          
         BNZ   *+8                                                              
         L     RF,AWKLOTRG-L'AWKLOTRG(R4) USE LOWEST RATED SPOT VALUE           
         CLI   TRGBASE,TRGBDEMS                                                 
         BE    TARG0106                                                         
         ICM   R1,15,8(R2)         ALREADY ACH COST                             
         BNZ   *+8                                                              
         L     R1,WAVCOST          IF ZERO USE AVERAGE                          
         M     R0,CPPROUND                                                      
         B     TARG0108                                                         
TARG0106 ICM   R1,15,4(R2)         ALREADY ACH CORP DEMO                        
         BNZ   *+8                                                              
         L     R1,WAVBASD          IF ZERO USE AVERAGE                          
         M     R0,FW100                                                         
TARG0108 GOTOR DIVIDE              RESULT 'COST' IN TERMS OF ALLOC BASE         
         M     R0,FW100                                                         
         L     RF,AWKAVGS-L'AWKAVGS(R4) OVER AVERAGE                            
         GOTOR DIVIDE                                                           
         S     R1,FW100            IF INDEX OVER 100                            
         BNP   *+8                                                              
         SLA   R1,1                DOUBLE PENALTY IF OVER AVERAGE               
         LCR   R1,R1               COMPLEMENT                                   
         LHI   RF,133                                                           
         MR    R0,RF               FOR EXCHANGE PHASE FACTOR SCORE UP           
         LH    RF,HW100                                                         
         GOTOR DIVIDE                                                           
         B     TARG0144                                                         
*                                  SPOT SELECT PHASE                            
*                                  USE RELATIVE 'CPU' (-) OF SPOT               
TARG0110 LTR   R4,R4               TEST HAVE TARGET                             
         BNZ   TARG0112            YES                                          
*                                  NO TARGET FOR THIS PRODUCT                   
*                                  (HERE ONLY FOR TARG1)                        
         SR    R1,R1                                                            
         LA    RF,PTTRGS-PTBUFFD(R6) IF NOT ALL TARGS ARE ABSENT                
         OC    0(L'PTTRGS,RF),0(RF)                                             
         BNZ   TARG0144            EXIT WITH VALUE ZERO                         
         SR    R0,R0                                                            
         ICM   R0,3,NTARGETS       SUM VALUES OF ACTIVE TARGETS                 
         BZ    TARG0144                                                         
         SR    RF,RF                                                            
         LA    RE,SBTARGS                                                       
         A     RF,0(RE)                                                         
         AHI   RE,L'SBTARGS                                                     
         BCT   R0,*-8                                                           
         SR    R1,R1               IF NO TARG RATINGS                           
         LTR   RF,RF                                                            
         BZ    TARG0144            EXIT WITH ZERO VALE                          
         B     TARG0114                                                         
                                                                                
TARG0112 SLL   R4,2                TARGET IS PRESENT                            
         LA    RF,SBTARGS-L'SBTARGS(R4) POINT TO TARGET VALUE                   
         ICM   RF,15,0(RF)                                                      
         BNZ   TARG0114            IF ZERO VALUE FOR TARG                       
         L     RF,AWKLOTRG-L'AWKLOTRG(R4) USE LOWEST RATING                     
         SRL   RF,1                /2                                           
                                                                                
TARG0114 LR    R6,RF               SAVE DIVISOR                                 
         CLI   TRGBASE,TRGBDOLS                                                 
         BNE   TARG0120                                                         
         ICM   R1,15,SBCOST                                                     
         BNZ   *+8                 MUST GET EQUIV BASE COST SHARE               
         L     R1,WAVCOST          IF ZERO USE AVERAGE COST                     
         M     R0,CPPROUND                                                      
         B     TARG0122                                                         
TARG0120 ICM   R1,15,SBCDEM        CORP DEMO VALUE                              
         BNZ   *+8                                                              
         L     R1,WAVBASD          IF ZERO USE AVERAGE                          
         M     R0,FW100                                                         
TARG0122 LR    RF,R6               RESTORE DIVISOR                              
         GOTOR DIVIDE              'CPU'                                        
         M     R0,FW100                                                         
         LTR   R4,R4               SPECIAL IF NO TARGET FOR BRAND               
         BZ    TARG0124                                                         
         L     RF,AWKAVGS-L'AWKAVGS(R4) OVER AVERAGE 'CPU'                      
         GOTOR DIVIDE                                                           
         S     R1,FW100                                                         
         LCR   R1,R1               COMPLEMENT                                   
         B     TARG0144                                                         
TARG0124 L     RF,AWKTGAVG         SPECIAL IF NO TARGET FOR BRAND               
         GOTOR DIVIDE              UNCHOOSE GOOD SPOTS FOR TARGS                
         S     R1,FW100                                                         
         B     TARG0144                                                         
                                                                                
***********************************************************************         
* BRAND SELECT PHASE                                                  *         
* USE COMPOSITE OF 2 VALUES                                           *         
* 1 - RELATIVE 'CPU' OF SPOT- AS FOR S PHASE                          *         
* TIMES 2 - CURRENT RELATIVE 'CPU' -AS FOR X PHASE                    *         
*                                                                     *         
* NOTE - HAS EFFECT OF INCREASING IMPORTANCE OF                       *         
*        VARIABLE BY DEGREE TO WHICH BRAND IS                         *         
*        CURRENTLY WORSE THAN AVERAGE                                 *         
***********************************************************************         
                                                                                
TARG0126 SLL   R4,2                                                             
         LA    RF,SBTARGS-L'SBTARGS(R4) POINT TO TARGET VALUE                   
         ICM   RF,15,0(RF)                                                      
         BNZ   TARG0128            IF ZERO VALUE FOR TARG                       
         L     RF,AWKLOTRG-L'AWKLOTRG(R4) USE LOWEST RATING                     
         SRL   RF,1                     /2                                      
TARG0128 LR    R6,RF               SAVE DIVISOR                                 
         CLI   TRGBASE,TRGBDOLS                                                 
         BNE   TARG0134                                                         
         ICM   R1,15,SBCOST                                                     
         BNZ   *+8                                                              
         L     R1,WAVCOST          IF ZERO USE AVERAGE COST                     
         M     R0,CPPROUND                                                      
         B     TARG0136                                                         
TARG0134 ICM   R1,15,SBCDEM        CORP DEMO VALUE                              
         BNZ   *+8                                                              
         L     R1,WAVBASD          IF ZERO USE AVERAGE                          
         M     R0,FW100                                                         
TARG0136 LR    RF,R6               RESTORE DIVISOR                              
         GOTOR DIVIDE              'CPU'                                        
         M     R0,FW100                                                         
         L     RF,AWKAVGS-L'AWKAVGS(R4) OVER AVERAGE 'CPU'                      
         GOTOR DIVIDE                                                           
         S     R1,FW100                                                         
         LCR   R1,R1               COMPLEMENT                                   
         ST    R1,HLDVAR           SAVE THIS COMPONENT                          
*                                  2ND COMPONENT                                
*                                  CALC CURRENT 'CPU'                           
         AH    R2,WKDISP                                                        
         LH    R1,HW100            USE NEUTRAL VALUE IF NO ACH                  
         L     RF,TABTA1-L'TABTA1-TABDATA(R2,R4) RF HAS CURRENT ACH             
         LTR   RF,RF                                                            
         BZ    TARG0142                                                         
         CLI   TRGBASE,TRGBDEMS                                                 
         BE    TARG0138                                                         
         L     R1,8(R2)            ACH COST                                     
         M     R0,CPPROUND                                                      
         B     TARG0140                                                         
TARG0138 L     R1,4(R2)            ACH CORP DEMO                                
         M     R0,FW100                                                         
TARG0140 GOTOR DIVIDE              'COST' IN TERMS OF ALLOC BASIS               
         M     R0,FW100                                                         
         L     RF,AWKAVGS-L'AWKAVGS(R4) OVER AVERAGE                            
         GOTOR DIVIDE                                                           
*                                  COMBINE THE 2 COMPONENTS                     
TARG0142 LTR   R1,R1               IF ZERO                                      
         BNZ   *+8                                                              
         LH    R1,HW100            SET TO 100 (NEUTRAL)                         
         S     R1,FW100            DOUBLE FACTOR VALUE                          
         SLA   R1,1                                                             
         A     R1,FW100                                                         
         M     R0,HLDVAR           X FIRST COMPONENT                            
         LH    RF,HW100                                                         
         GOTOR DIVIDE                                                           
TARG0144 ST    R1,HLDVAR                                                        
TARG01X  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* VARIABLE 7 - TARGET 2                                               *         
***********************************************************************         
                                                                                
TARG02   SR    R4,R4               NO TARGET                                    
         CLI   TABPRD,UNAPRD2      IF 'EXCESS' PRODUCT                          
         BE    TARG0104                                                         
         SR    R6,R6                                                            
         IC    R6,TABPRD           GET TARG NO. FROM PTBUFF                     
         BCTR  R6,0                                                             
         MH    R6,PRDBUFLN                                                      
         A     R6,PRDBUFF                                                       
         SR    R4,R4                                                            
         IC    R4,PTTRGS+1-PTBUFFD(R6)   2ND TARGET                             
         B     TARG0102            BRANCH INTO TARGET 1 ROUTINE                 
         DROP  R8,RB                                                            
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* TEST SPOT USABLE FOR BRAND                                          *         
***********************************************************************         
                                                                                
SPTUSE   NTR1  BASE=*,LABEL=*                                                   
         NI    SBSTAT,FF-SBSRJCTQ  CLEAR ALL REJECT BITS                        
         CLI   ZSPASS,ZSPTOGQ                                                   
         BE    SPTUSE06                                                         
*                                  TEST REJECT BECAUSE ZERO SPOT ON NON         
*                                  ZERO PASS OR VICE-VERSA                      
         LA    RF,SBCOST           USE COST                                     
         CLI   GOALOPT,GOALDOLS                                                 
         BE    *+8                                                              
         LA    RF,SBCDEM           OR DEMO                                      
         OC    0(L'SBCOST,RF),0(RF)                                             
         BNZ   SPTUSE02                                                         
         CLI   ZSPASS,ZSPYESQ                                                   
         BE    SPTUSE06            KEEP                                         
         B     SPTUSE04            REJECT                                       
SPTUSE02 CLI   ZSPASS,ZSPNOQ                                                    
         BE    SPTUSE06            KEEP                                         
SPTUSE04 OI    SBSTAT,SBSZPRJQ     REJECT                                       
         B     SPTUSEX                                                          
                                                                                
SPTUSE06 L     R2,THISPRD          TEST VS PROD EXCLUSION TABLE                 
         USING TABD,R2                                                          
         SR    RF,RF                                                            
         IC    RF,TABPRD           GET PRODUCT INFO                             
         BCTR  RF,0                                                             
         MH    RF,PRDBUFLN                                                      
         A     RF,PRDBUFF                                                       
         MVC   HPRD,PTPRDA-PTBUFFD(RF)                                          
                                                                                
         CLI   TABPRD,UNAPRD2      FOR BRAND 'EXCESS'                           
         BE    SPTUSE58            SKIP EXCL AND INTERVAL TESTS                 
         L     R4,XCTATAB          START OF TABLE                               
         ICM   R3,15,XCTNREC       NO OF ENTRIES                                
         BZ    SPTUSE44            NO EXCLUSIONS PRESENT                        
         USING XCTABD,R4                                                        
         LH    R6,SBENV1           GET PROGRAM FROM ENV1 TABLE                  
         BCTR  R6,0                                                             
         MH    R6,HWENV1LN                                                      
         L     RF,AENV1SET                                                      
         A     R6,ENVSATAB-ENVSETD(RF)                                          
                                                                                
         USING ENVTABD,R6                                                       
SPTUSE14 CLI   XCTSTA,FF           TEST 'ALL' STATIONS ENTRY                    
         BE    SPTUSE26            YES - TEST IT                                
         SR    RE,RE                                                            
         ICM   RE,7,XCTSTA                                                      
         SR    RF,RF                                                            
         ICM   RF,7,SBSTA                                                       
         CLI   COUNTRY,CANLETQ     TEST CANADA                                  
         BNE   SPTUSE24                                                         
         CLI   QMED,COMLETQ        TEST COMBINED MEDIA                          
         BE    SPTUSE16                                                         
         SRL   RE,8                NO - SHIFT OFF NETWORK FOR COMPARE           
         SRL   RF,8                                                             
         B     SPTUSE24                                                         
                                                                                
SPTUSE16 CLI   XCTETYPE,XCTETSTA   TEST STATION ENTRY                           
         BNE   SPTUSE18                                                         
         CLC   XCTSTA(2),SBSTA     YES - MATCH STATION                          
         BE    SPTUSE26                                                         
         B     SPTUSE42                                                         
                                                                                
SPTUSE18 CLI   XCTETYPE,XCTETNET   TEST NETWORK STATION ENTRY                   
         BE    *+6                                                              
         DC    H'0'                                                             
         CLC   XCTSTA,SBNETSTA     MATCH NETWORK STATION                        
         BE    SPTUSE26                                                         
         B     SPTUSE42                                                         
                                                                                
SPTUSE24 CR    RE,RF               COMPARE STATIONS (REGULAR)                   
         BNE   SPTUSE42                                                         
                                                                                
SPTUSE26 CLC   XCTPRD,HPRD         PRODUCT                                      
         BNE   SPTUSE42                                                         
         CLI   XCTEST,0            EST 0 = ALL                                  
         BE    SPTUSE28                                                         
         CLC   XCTEST,SBEST                                                     
         BNE   SPTUSE42                                                         
                                                                                
SPTUSE28 CLC   ALL,XCTPGM          PROGRAM CHECKS                               
         BE    SPTUSE40                                                         
         CLC   XCTPGM,ENVS1PGM                                                  
         BE    SPTUSE40            OK                                           
         CLI   XCTTYPE,XCTTTODQ    TEST TIME - NOT PROG                         
         BE    SPTUSE30            YES                                          
         CLI   XCTTYPE,XCTTADYQ    TEST TIME + DAY                              
         BNE   SPTUSE38            NO - THEN TRY DAY ALONE                      
         MVC   BYTE,XCTDOW         DAY FILTER AFTER TIME                        
         NC    BYTE,ENVS1DAY       TEST ANY OVERLAP                             
         BZ    SPTUSE42            NO, IGNORE TIME TEST                         
                                                                                
***********************************************************************         
* TIME CHECKS                                                         *         
***********************************************************************         
                                                                                
SPTUSE30 CLC   XCTSTIME,XCTETIME   TEST PXC TIMES SPAN 12M                      
         BH    SPTUSE36                                                         
         CLC   ENVS1STR,XCTSTIME   TIMES DO NOT SPAN 12M                        
         BE    SPTUSE40            ES = XS                                      
         BL    SPTUSE32                                                         
         CLC   ENVS1STR,XCTETIME                                                
         BL    SPTUSE40            (ES GT XS) AND (ES LT XE)                    
SPTUSE32 CLC   ENVS1END,XCTETIME                                                
         BE    SPTUSE40            EE = XE                                      
         BH    SPTUSE34                                                         
         CLC   ENVS1END,XCTSTIME                                                
         BH    SPTUSE40            (EE LT XE) AND (EE GT XS)                    
SPTUSE34 CLC   ENVS1STR,XCTSTIME                                                
         BNL   SPTUSE42                                                         
         CLC   ENVS1END,ENVS1STR                                                
         BL    SPTUSE40            (ES LT XS) AND (EE LT ES)                    
         CLC   ENVS1END,XCTSTIME                                                
         BH    SPTUSE40            (ES LT XS) AND (EE GT XS)                    
         B     SPTUSE42                                                         
SPTUSE36 CLC   ENVS1STR,XCTSTIME   PXC TIME DO SPAN 12M                         
         BNL   SPTUSE40            ES GE XS                                     
         CLC   ENVS1STR,XCTETIME                                                
         BL    SPTUSE40            ES LT XE                                     
         CLC   ENVS1END,XCTETIME                                                
         BNH   SPTUSE40            EE LE XE                                     
         CLC   ENVS1END,XCTSTIME                                                
         BH    SPTUSE40            EE GT XS                                     
         CLC   ENVS1END,ENVS1STR                                                
         BL    SPTUSE40            EE LT ES                                     
         B     SPTUSE42                                                         
                                                                                
SPTUSE38 CLI   XCTTYPE,XCTTDOWQ    TRY DAY OF WEEK                              
         BNE   SPTUSE42                                                         
         MVC   BYTE,XCTDAY                                                      
         NC    BYTE,ENVS1DAY       TEST ANY OVERLAP                             
         BZ    SPTUSE42            NO, OK                                       
         CLI   XCTDPT,0            TEST HAVE DPT/SLN (IF FROM GOALS)            
         BE    SPTUSE40                                                         
         CLC   XCTDPT,SBDPT        TEST DAYPART MATCH                           
         BNE   SPTUSE42            NO, NOT APPLICABLE                           
         CLC   TABSLN,XCTSLN       SAME FOR SPOT LENGTH                         
         BNE   SPTUSE42                                                         
                                                                                
SPTUSE40 CLC   XCTSDATE,SBDATE     DATES                                        
         BH    SPTUSE42                                                         
         CLC   XCTEDATE,SBDATE                                                  
         BL    SPTUSE42                                                         
         OI    SBSTAT,SBSEXRJQ     EXCLUDED                                     
         B     SPTUSEX                                                          
                                                                                
SPTUSE42 A     R4,XCTLREC          BUMP TO NEXT TABLE ENTRY                     
         BCT   R3,SPTUSE14         DO FOR NUMBER OF ENTRIES                     
                                                                                
SPTUSE44 L     R2,THISPRD          NOW DO TIME SLOT CHECKS                      
         CLI   PINTRVL,0           PRODUCT INTERVAL                             
         BE    SPTUSE46            SKIP                                         
         MVI   PRDCLSSW,PRDCLSP                                                 
         SR    RE,RE                                                            
         IC    RE,TABPRD                                                        
         A     RE,APRDTRT                                                       
         SR    R1,R1                                                            
         IC    R1,0(RE)            PRODUCT TRANSLATE TABLE                      
         GOTOR TSTENV                                                           
         BNE   SPTUSEX             REJECT                                       
SPTUSE46 CLI   SPLTOPT,SECS15      IF DOING 15 SPLITS                           
         BNE   SPTUSE52            SAME PROD NOT ASSIGNED TO BOTH               
         TM    SBSEQ,X'01'         IS SPOT 1ST OF A PAIR?                       
         BNZ   SPTUSE48                                                         
         LR    RF,R5               YES, POINT TO 2ND                            
         A     RF,SPTTABL                                                       
         CLC   SBUFFK(SBSEQ-SBUFFK),0(RF) 'KEY' SHOULD BE THE SAME              
         BE    *+6                 JUST MAKE SURE                               
         DC    H'0'                                                             
*                                  IS CURRENT PRODUCT THE SAME                  
*                                  AS IN OTHER HALF?                            
         CLC   TABPRD,SBPRD1-SBUFFRD(RF)                                        
         BE    SPTUSE50            YES, REJECT                                  
         B     SPTUSE52            NO, OK                                       
*                                  SPOT MUST BE 2ND OF PAIR                     
SPTUSE48 LR    RF,R5               POINT 1ST OF PAIR                            
         S     RF,SPTTABL                                                       
         CLC   SBUFFK(SBSEQ-SBUFFK),0(RF) 'KEY' SHOULD BE THE SAME              
         BE    *+6                 JUST MAKE SURE                               
         DC    H'0'                                                             
*                                  IS CURRENT PRODUCT THE SAME                  
*                                  AS IN OTHER HALF?                            
         CLC   TABPRD,SBPRD1-SBUFFRD(RF)                                        
         BNE   SPTUSE52            NO, OK                                       
SPTUSE50 OI    SBSTAT,SBSENRJQ     SET ENV REJECT                               
         B     SPTUSEX                                                          
                                                                                
SPTUSE52 CLI   CINTRVL,0           CLASS INTERVAL                               
         BE    SPTUSE58            SKIP                                         
         CLI   TABPRDC,0           IF NO CLASS                                  
         BNH   SPTUSE58            SKIP                                         
         CLI   SPCLOPTN,0          'SPECIAL CLASS' CODE                         
         BE    SPTUSE54                                                         
         CLI   TABPRDC,TWOPTCLS    IF BOTH BRANDS ARE IN                        
         BNH   SPTUSE54            SINGLE CLASSES                               
         CLC   TABPRDC,SPCLOPTN    AND IT'S THE 'SPECIAL' CLASS                 
         BE    SPTUSEX             THEN PAIR IS OK (CC=0)                       
                                                                                
SPTUSE54 MVI   PRDCLSSW,PRDCLSC    CLASS CHECKS                                 
         GOTOR SETCLS,TABPRDC                                                   
         SR    RE,RE                                                            
         ICM   RE,1,CLASS1         ...CLASS 1                                   
         BZ    SPTUSE56                                                         
         A     RE,ACLSTRT                                                       
         SR    R1,R1                                                            
         IC    R1,0(RE)                                                         
         GOTOR TSTENV                                                           
         BNE   SPTUSEX                                                          
SPTUSE56 SR    RE,RE                                                            
         ICM   RE,1,CLASS2         ...CLASS 2                                   
         BZ    SPTUSE58                                                         
         A     RE,ACLSTRT                                                       
         SR    R1,R1                                                            
         IC    R1,0(RE)                                                         
         GOTOR TSTENV                                                           
         BNE   SPTUSEX                                                          
                                                                                
SPTUSE58 CLI   SPLTOPT,SECS15      IF DOING 15 SPLITS MAKE SURE                 
         BNE   SPTUSEX             BOTH PRODUCTS NOT IN SAME CLASS              
         TM    SBSEQ,X'01'         IS SPOT 1ST OF A PAIR?                       
         BNZ   SPTUSE60                                                         
         LR    RF,R5               YES, POINT TO 2ND                            
         A     RF,SPTTABL                                                       
         CLC   SBUFFK(SBSEQ-SBUFFK),0(RF) 'KEY' SHOULD BE THE SAME              
         BE    *+6                 JUST MAKE SURE                               
         DC    H'0'                                                             
         CLI   SBPRD1-SBUFFRD(RF),0 IF NO PRODUCT, OK                           
         BE    SPTUSEX                                                          
         MVC   BYTE,SBPRD1-SBUFFRD(RF)                                          
         GOTOR CHKCLS,DMCB,TABD,(BYTE,0)                                        
         BE    *+8                 NO, OK                                       
         OI    SBSTAT,SBSENRJQ     SET ENV REJECT                               
         B     SPTUSEX                                                          
*                                  SPOT MUST BE 2ND OF PAIR                     
SPTUSE60 LR    RF,R5               POINT TO 1ST OF PAIR                         
         S     RF,SPTTABL                                                       
         CLC   SBUFFK(SBSEQ-SBUFFK),0(RF) 'KEY' SHOULD BE THE SAME              
         BE    *+6                 JUST MAKE SURE                               
         DC    H'0'                                                             
         CLI   SBPRD1-SBUFFRD(RF),0 IF NO PRODUCT, OK                           
         BE    SPTUSEX                                                          
         MVC   BYTE,SBPRD1-SBUFFRD(RF)                                          
         GOTOR CHKCLS,DMCB,TABD,(BYTE,0)                                        
         BE    SPTUSEX             YES, REJECT                                  
         OI    SBSTAT,SBSENRJQ     SET ENV REJECT                               
                                                                                
SPTUSEX  TM    SBSTAT,SBSRJCTQ     SET CONDITION CODE FOR CALLER                
         J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* NTRY - RF=ENV PRODUCT/CLASS ENTRY NUMBER                            *         
***********************************************************************         
                                                                                
TSTENV   STM   RE,R2,12(RD)                                                     
         MH    R1,ENVPRDD          X DISP                                       
         LH    RE,SBENV1                                                        
         SLL   RE,1                                                             
         L     R2,AENV1SET         USE ENV 1 VALUE SET                          
         USING ENVSETD,R2                                                       
         LH    RE,ENVSTTAB(RE)     TRANSLATE TABLE                              
         MH    RE,ENVENVD          X ENV DISP                                   
         AR    R1,RE                                                            
         SR    RE,RE                                                            
         IC    RE,WEEKNO                                                        
         SLL   RE,1                2 BYTES PER WEEK                             
         AR    R1,RE               PLUS WEEK                                    
         A     R1,ENVSACTC         USE ACTUAL UNIT COUNTS                       
         LH    RF,0(R1)            RF HASE COUNT SO FAR                         
         CLI   ALPHASE,ALPXCHQ     UNLESS EXCHANGE PHASE                        
         BE    *+8                                                              
         AH    RF,HW10             BUMP BY 1.0                                  
         LH    R1,SBENV1           NOW GET LIMIT FROM ENV1 TABLE                
         BCTR  R1,0                                                             
         MH    R1,HWENV1LN                                                      
         A     R1,ENVSATAB                                                      
         LA    RE,ENVS1SLP-ENVTABD(R1)                                          
         CLI   PRDCLSSW,PRDCLSP                                                 
         BE    *+8                                                              
         LA    RE,ENVS1SLC-ENVTABD(R1)                                          
         CH    RF,0(RE)                                                         
         BNH   TSTENVY             OK                                           
         OI    SBSTAT,SBSENRJQ     SET ENV REJECT                               
         LTR   RE,RE                                                            
         B     TSTENVX                                                          
TSTENVY  CR    RE,RE                                                            
TSTENVX  LM    RE,R2,12(RD)                                                     
         BR    RE                                                               
         DROP  R2,R4,R5,R6,RB                                                   
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* INITIALIZE FOR WEEK ALLOCATION                                      *         
***********************************************************************         
                                                                                
AWKINI   NTR1  BASE=*,LABEL=*                                                   
         XC    AWKVALS(AWKVALSL),AWKVALS                                        
         XC    AWKAPRDS,AWKAPRDS                                                
         L     RE,AIPRDTRT                                                      
         XC    0(L'IPRDTRT,RE),0(RE)                                            
         L     R4,ASPTTAB                                                       
         MVI   0(R4),FF            CLEAR SPTTAB                                 
         L     R3,ASUPROW                                                       
         AH    R3,WKDISP                                                        
         OC    TPREUNT-TABDATA(,R3),TPREUNT-TABDATA(R3)                         
         BZ    AWKINIX             NONE                                         
         SR    R5,R5               COUNT ACTIVE BRANDS FOR WEEK                 
         SR    R7,R7                                                            
         L     R3,AFSTBRD                                                       
         USING TABD,R3                                                          
         LH    R4,WKDISP                                                        
AWKINI02 CLI   TABPRD,0                                                         
         BE    AWKINI06                                                         
         L     RF,TRSCGOL-TABDATA(R3,R4)                                        
         LTR   RF,RF                                                            
         BZ    AWKINI04                                                         
         AHI   R5,1                BUMP PRODUCT COUNT                           
         SR    RF,RF                                                            
         IC    RF,TABPRD                                                        
         A     RF,AIPRDTRT                                                      
         CLI   0(RF),0             TEST ALREADY USED                            
         BNE   AWKINI04                                                         
         AHI   R7,1                BUMP TRUE PRODUCT COUNT                      
         STC   R7,0(RF)            (UNIQUE PRODUCT CODES IGNORING SLN)          
AWKINI04 AH    R3,LROW             NEXT PRODUCT                                 
         B     AWKINI02                                                         
         DROP  R3                                                               
AWKINI06 STH   R5,AWKAPRDS         COUNT OF ACTIVE BRANDS                       
         STH   R7,AWKTPRDS         'TRUE' ACTIVE BRAND COUNT                    
                                                                                
         L     R4,ATOTROW          SET AVERAGE GOALS FOR WEEK                   
         AH    R4,WKDISP                                                        
         L     R1,0(R4)                                                         
         SR    R0,R0                                                            
         LR    RF,R5                                                            
         GOTOR DIVIDE                                                           
         ST    R1,WAVGOAL          AVERAGE GOAL THIS WEEK                       
         LA    R5,W                BUILD SPOT TABLE                             
         USING SBUFFRD,R5                                                       
         XC    SBUFFK(SBUFFKL),SBUFFK                                           
         MVC   SBDPT(L'SBDPT+L'SBSLN),L.GBDPT                                   
         L     R4,ASPTTAB                                                       
         SR    R6,R6                                                            
         GOTOR BU2RDH                                                           
         B     AWKINI10                                                         
AWKINI08 GOTOR BU2RSQ                                                           
AWKINI10 BNZ   AWKINI30                                                         
         CLC   SBDPT,L.GBDPT                                                    
         BNE   AWKINI30                                                         
         CLC   SBSLN,L.GBSLN                                                    
         BNE   AWKINI30                                                         
         CLI   SBRTYP,SBRTYPQ      TEST RIGHT RECORD TYPE                       
         BNE   AWKINI08                                                         
         CLC   SBWK,WEEKNO         TEST RIGHT WEEK                              
         BNE   AWKINI08                                                         
         CLI   SBPRD1,0            DON'T TOTAL PRE-ALLOC SPOTS                  
         BNE   AWKINI16                                                         
*                                  ZERO SPOT TEST                               
         LA    RF,SBCOST           TEST COST                                    
         CLI   GOALOPT,GOALDOLS                                                 
         BE    *+8                                                              
         LA    RF,SBCDEM           OR DEMO                                      
         OC    0(L'SBCOST,RF),0(RF)                                             
         BNZ   AWKINI14                                                         
         L     R1,AWKZSPTS         ZERO SPOT COUNTER                            
         AHI   R1,1                                                             
         ST    R1,AWKZSPTS                                                      
         SR    R1,R1                                                            
         IC    R1,SBPDLEN                                                       
         A     R1,AWKZSECS         ZERO LENGTH COUNTER                          
         ST    R1,AWKZSECS                                                      
         B     AWKINI16                                                         
                                                                                
AWKINI14 ICM   R1,15,SBCOST        GET TOTAL OF COST                            
         A     R1,AWKNZCST                                                      
         ST    R1,AWKNZCST                                                      
         ICM   R1,15,SBCDEM        AND CORP DEMO                                
         A     R1,AWKNZBAS         FOR NON-ZERO SPOTS                           
         ST    R1,AWKNZBAS                                                      
         L     R1,AWKRSPTS         NON-ZERO SPOT COUNTER                        
         AHI   R1,1                                                             
         ST    R1,AWKRSPTS                                                      
         SR    R1,R1                                                            
         IC    R1,SBPDLEN                                                       
         A     R1,AWKRSECS                                                      
         ST    R1,AWKRSECS                                                      
                                                                                
AWKINI16 SR    R0,R0               SET LOWEST NON-ZERO VAL/TARG                 
         ICM   R0,3,NTARGETS                                                    
         BZ    AWKINI24            NO TARGS                                     
         LA    R1,SBTARGS                                                       
         LA    RE,AWKLOTRG                                                      
AWKINI18 ICM   RF,15,0(R1)         TARG VALUE                                   
         BZ    AWKINI22            SKIP IF ZERO                                 
         C     RF,0(RE)                                                         
         BL    AWKINI20                                                         
         OC    0(L'AWKLOTRG,RE),0(RE) FIRST TIME                                
         BNZ   AWKINI22                                                         
AWKINI20 ST    RF,0(RE)            SAVE LOWEST                                  
AWKINI22 AHI   R1,L'SBTARGS        NEXT TARG                                    
         AHI   RE,L'AWKLOTRG                                                    
         BCT   R0,AWKINI18                                                      
*                                  GET EQUIV UNITS IN R1                        
AWKINI24 LH    R1,HW10             1.0 UNITS                                    
         OC    SBCOST,SBCOST       COUNT NON-ZERO COST SPOTS                    
         BZ    AWKINI26                                                         
         L     RF,AWKNZCSP                                                      
         AR    RF,R1                                                            
         ST    RF,AWKNZCSP                                                      
AWKINI26 OC    SBCDEM,SBCDEM       COUNT NON-ZERO RATED SPOTS                   
         BZ    AWKINI28                                                         
         L     RF,AWKNZDSP                                                      
         AR    RF,R1               BUMP BY EQUIV UNITS                          
         ST    RF,AWKNZDSP                                                      
                                                                                
AWKINI28 L     RF,SPTTABL          LENGTH                                       
         SHI   RF,1                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R4),SBUFFRD                                                  
         A     R4,SPTTABL                                                       
         MVI   0(R4),FF            SET END                                      
         AHI   R6,1                                                             
         B     AWKINI08                                                         
AWKINI30 ST    R6,SPTTABN          TOTAL SPOT COUNT                             
         L     RF,AWKRSPTS                                                      
         A     RF,AWKZSPTS                                                      
         BZ    AWKINIX             DONE IF NO UNAL SPOTS                        
*                                  CPP/M FOR WEEK                               
         CLI   CPMSOPTN,CPMSDLNQ   IF CPM'S BASED ON SCHED                      
         BE    AWKINI32            (NOTE-SUPPLY DEMOS ARE EQUIV'D)              
         L     R4,ASUPROW                                                       
         AH    R4,WKDISP                                                        
         L     R1,8(R4)            DOLLARS                                      
         M     R0,CPPROUND                                                      
         L     RF,4(R4)            DEM                                          
         GOTOR DIVIDE                                                           
         ST    R1,WKCPD                                                         
         B     AWKINI36                                                         
*                                  CPP/M FOR NON-ZERO SPOTS                     
AWKINI32 L     R4,ASUPROW          DO RUNNING CPM IF BASED ON SCHED             
SUP      USING TABD,R4                                                          
         AH    R4,CELLWID          START WITH WEEK 1                            
         SR    R0,R0                                                            
         IC    R0,WEEKNO           FOR BCT                                      
         SR    R1,R1                                                            
         SR    RF,RF                                                            
AWKINI34 A     R1,SUP.TPREDOL      DOLLARS                                      
         A     RF,SUP.TPREDEM      DEM                                          
         AH    R4,CELLWID                                                       
         BCT   R0,AWKINI34                                                      
         M     R0,CPPROUND                                                      
         GOTOR DIVIDE                                                           
         ST    R1,WKCPD                                                         
AWKINI36 L     R1,AWKNZCST                                                      
         M     R0,CPPROUND                                                      
         L     RF,AWKNZBAS                                                      
         GOTOR DIVIDE                                                           
         ST    R1,AWKNZCPD                                                      
*                                  SET AVERAGE VALUE PER BASIS                  
*                                  UNIT FOR TARGETS                             
*                                  (NOTE-SUPPLY DEMOS AREA EQUIV'D)             
         SR    R7,R7                                                            
         ICM   R7,3,NTARGETS                                                    
         BZ    AWKINI44                                                         
         L     R4,ASUPROW                                                       
         AH    R4,WKDISP                                                        
         LA    R5,TABTA1-TABDATA(R4) POINT TO FIRST TARGET                      
         LA    R6,AWKAVGS          VALUES PER                                   
AWKINI38 L     RF,0(R5)            TARG VALUE                                   
         A     RF,AWKTGAVG                                                      
         ST    RF,AWKTGAVG         TOTAL OF VALUES                              
         L     RF,0(R5)            TARG VALUE                                   
         CLI   TRGBASE,TRGBDOLS                                                 
         BNE   AWKINI40                                                         
         L     R1,TPREDOL-TABDATA(R4) ACH DOLLARS                               
         M     R0,CPPROUND                                                      
         B     AWKINI42                                                         
AWKINI40 L     R1,TPREDEM-TABDATA(R4) ACH CORP DEMO                             
         M     R0,FW100                                                         
AWKINI42 GOTOR DIVIDE                                                           
         ST    R1,0(R6)                                                         
         AHI   R5,L'TABTA1         NEXT TARGET                                  
         AHI   R6,L'AWKAVGS                                                     
         BCT   R7,AWKINI38                                                      
                                                                                
AWKINI44 L     RF,AWKTGAVG         SET TARG AVERAGE OF AVERAGE'S                
         CLI   TRGBASE,TRGBDOLS                                                 
         BNE   AWKINI46                                                         
         L     R1,TPREDOL-TABDATA(R4) ACH DOLLARS                               
         M     R0,CPPROUND                                                      
         B     AWKINI48                                                         
AWKINI46 L     R1,TPREDEM-TABDATA(R4) ACH CORP DEMO                             
         M     R0,FW100                                                         
AWKINI48 GOTOR DIVIDE                                                           
         ST    R1,AWKTGAVG                                                      
         L     R4,ASUPROW          SET AVERAGE COST FOR NON-ZERO SPOTS          
         AH    R4,WKDISP                                                        
         L     R1,TPREDOL-TABDATA(R4) COST TOTAL                                
         M     R0,FW10             BECAUSE UNITS ARE 0.0                        
         L     RF,AWKNZCSP         / NO. OF NON-ZERO SPOTS                      
         GOTOR DIVIDE                                                           
         ST    R1,WAVCOST                                                       
*                                  SET AVG BASE RATING PER NON-ZERO SPT         
         L     R1,TPREDEM-TABDATA(R4) TOTAL BASE DEMO                           
         M     R0,FW10             BECAUSE UNITS ARE 0.0                        
         L     RF,AWKNZDSP         / NO. OF NON-ZERO RATED SPOTS                
         GOTOR DIVIDE                                                           
         ST    R1,WAVBASD                                                       
         LA    RF,VARCTLS          SET OFF ALL VARIABLE NO-OPS                  
         LHI   R0,VARWGTSN                                                      
         MVI   0(RF),0                                                          
         AHI   RF,L'VARCTLS                                                     
         BCT   R0,*-8                                                           
         OC    NTARGETS,NTARGETS   IF NO TARGETS                                
         BNZ   AWKINI50                                                         
         OI    TG1VAR+VARCTLD,TOFFQ  SET OFF TARGET VARIABLES                   
         OI    TG2VAR+VARCTLD,TOFFQ                                             
         B     AWKINIX                                                          
*                                  IF ALL BRANDS HAVE SAME TARG 1               
AWKINI50 MVI   WORD,FF             OR TARG 2 NO-OP THAT VARIABLE                
         L     R2,AFSTBRD                                                       
         USING TABD,R2                                                          
         MVI   BYTE,0                                                           
AWKINI52 CLI   TABPRD,0                                                         
         BE    AWKINI58                                                         
         CLI   TABPRD,UNAPRD2      IGNORE UNA                                   
         BE    AWKINI56                                                         
         SR    R1,R1                                                            
         IC    R1,TABPRD           SET TARGS IN HALF                            
         BCTR  R1,0                                                             
         MH    R1,PRDBUFLN                                                      
         A     R1,PRDBUFF                                                       
         MVC   HALF,PTTRGS-PTBUFFD(R1)                                          
AWKINI54 CLI   WORD,FF             IF FIRST TIME                                
         BNE   *+14                                                             
         MVC   WORD(2),HALF        JUST SET TARGS                               
         B     AWKINI56                                                         
         CLC   WORD(1),HALF                                                     
         BE    *+8                                                              
         OI    BYTE,X'80'          MULTIPLE TARG 1'S                            
         CLC   WORD+1(1),HALF+1                                                 
         BE    *+8                                                              
         OI    BYTE,X'40'          MULTIPLE TARG 2'S                            
AWKINI56 AH    R2,LROW                                                          
         B     AWKINI52                                                         
         DROP  R2                                                               
AWKINI58 TM    BYTE,X'80'          TEST MULT TARG 1'S                           
         BNZ   *+8                                                              
         OI    TG1VAR+VARCTLD,TOFFQ   NO - NOOP                                 
         TM    BYTE,X'40'             TEST MULT TARG 2'S                        
         BNZ   *+8                                                              
         OI    TG2VAR+VARCTLD,TOFFQ   NO - NOOP                                 
AWKINIX  J     EXIT                                                             
         DROP  RB                                                               
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* DETAIL SPOT REPORT                                                  *         
***********************************************************************         
                                                                                
DETRPT   NTR1  BASE=*,LABEL=*                                                   
         CLI   RPTOPTN,RPTOALLQ    TEST DOING DETAIL REPORT                     
         BNE   DETRPTX                                                          
         MVI   RCSUBPRG,30                                                      
         CLI   WEEKNO,1            FOR WEEK 1                                   
         BNE   *+8                                                              
         MVI   FORCEHED,YESQ       ALWAYS NEW PAGE                              
         MVC   P1(L'WEEKL),WEEKL                                                
         CLI   DAILYSW,YESQ        DAILY?                                       
         BNE   *+10                                                             
         MVC   P1(4),=C'Day '                                                   
         EDIT  (B1,WEEKNO),(2,P1+5)                                             
         SR    R0,R0                                                            
         IC    R0,WEEKNO                                                        
         BCTR  R0,0                                                             
         MHI   R0,L'MEDQ1WKS                                                    
         A     R0,AWEEKLST                                                      
         GOTOR DATCON,DMCB,(2,(R0)),(5,P1+9)                                    
         AHI   R0,2                                                             
         GOTOR (RF),(R1),(2,(R0)),(5,P1+18)                                     
         MVI   P1+17,DASH                                                       
         MVC   P2(7),DASHES                                                     
         L     R5,ASPTTAB                                                       
         USING SBUFFRD,R5                                                       
         CLI   0(R5),FF                                                         
         BNE   DETRPT02                                                         
         MVC   P1+27(L'NSPTFRWK),NSPTFRWK                                       
         B     DETRPT04                                                         
DETRPT02 MVI   FORCEHED,YESQ       NEW PAGE FOR WEEK                            
         MVI   SPACING,2                                                        
DETRPT04 GOTOR REPORT                                                           
         CLI   SBUFFK,FF           NO SPOTS - DONE                              
         BE    DETRPTX                                                          
         MVC   DRSTA(L'AVALFRWK),AVALFRWK                                       
         L     R4,ASUPROW                                                       
         AH    R4,WKDISP                                                        
         L     R1,TPREDOL-TABDATA(R4)                                           
         LH    R0,HW10             UNITS ARE 0.0                                
         MR    R0,R0                                                            
         L     RF,TPREUNT-TABDATA(R4) SPOTS                                     
         GOTOR DIVIDE                                                           
         CLI   RQMED,NETLETQ       NO CENTS FOR NETWORK                         
         BE    DETRPT06                                                         
         EDIT  (R1),(11,DRCOST),2,FLOAT=$ AVERAGE COST                          
         B     DETRPT08                                                         
DETRPT06 EDIT  (R1),(11,DRCOST),FLOAT=$                                         
DETRPT08 MVC   HDEM,BASEDEM                                                     
         L     R1,TPREDEM-TABDATA(R4) DEM                                       
         LH    R0,HW10             UNITS ARE 0.0                                
         MR    R0,R0                                                            
         L     RF,TPREUNT-TABDATA(R4) SPOTS                                     
         GOTOR DIVIDE              AVERAGE RATING                               
         CLI   RQMED,NETLETQ       NO DECIMAL FOR NETWORK                       
         BNE   DETRPT10            AUDIENCES                                    
         CLI   HDEM+1,RATINGQ                                                   
         BE    DETRPT10                                                         
         EDIT  (R1),(8,DRBASD),ZERO=NOBLANK                                     
         B     DETRPT12                                                         
DETRPT10 EDIT  (R1),(8,DRBASD),1,ZERO=NOBLANK                                   
DETRPT12 L     R1,TPREDOL-TABDATA(R4) DOLLARS                                   
         L     RF,CPPROUND                                                      
         CLI   HDEM+1,RATINGQ                                                   
         BE    *+8                                                              
         L     RF,CPMROUND                                                      
         MR    R0,RF                                                            
         L     RF,TPREDEM-TABDATA(R4) DEM                                       
         GOTOR DIVIDE                                                           
         LA    R5,DRBASD+L'P1                                                   
         EDIT  (R1),(8,0(R5)),2      CORP DEM CPM                               
         LA    R3,TABTA1-TABDATA(R4) TARGETS                                    
         LA    R5,DRTARG1                                                       
         LA    R6,TARGETS          DEMOS                                        
         SR    R7,R7                                                            
         ICM   R7,3,NTARGETS                                                    
         BZ    DETRPT20                                                         
         CHI   R7,8                ONLY 8 TARGS CAN PRINT                       
         BNH   DETRPT14                                                         
         LHI   R7,8                NO ROOM FOR 9+ TARGS                         
DETRPT14 MVC   HDEM,0(R6)          SET DEMO CODE                                
         L     R1,0(R3)            VALUE                                        
         LH    R0,HW10             UNITS ARE 0.0                                
         MR    R0,R0                                                            
         L     RF,TPREUNT-TABDATA(R4) / SPOTS                                   
         GOTOR DIVIDE              AVERAGE VALUE                                
         CLI   RQMED,NETLETQ       NO DECIMAL FOR NETWORK                       
         BNE   DETRPT16            AUDIENCES                                    
         CLI   HDEM+1,RATINGQ                                                   
         BE    DETRPT16                                                         
         EDIT  (R1),(8,0(R5)),ZERO=NOBLANK                                      
         B     DETRPT18                                                         
DETRPT16 EDIT  (R1),(8,0(R5)),1,ZERO=NOBLANK                                    
DETRPT18 L     R1,TPREDOL-TABDATA(R4) /DOLLARS                                  
         L     RF,CPPROUND                                                      
         CLI   HDEM+1,RATINGQ                                                   
         BE    *+8                                                              
         L     RF,CPMROUND                                                      
         MR    R0,RF                                                            
         L     RF,0(R3)            VALUE                                        
         GOTOR DIVIDE                                                           
         EDIT  (R1),(8,L'P1(R5)),2 TARGET CPM                                   
         AHI   R3,4                                                             
         AHI   R5,9                                                             
         AHI   R6,L'TARGETS                                                     
         BCT   R7,DETRPT14                                                      
DETRPT20 MVI   SPACING,2                                                        
         GOTOR REPORT                                                           
                                                                                
***********************************************************************         
* SPOT PROCESSING                                                     *         
***********************************************************************         
                                                                                
         L     R0,SPTTABN          SORT SPOTS IN DATE/TIME ORDER                
         L     RF,SPTTABL                                                       
         GOTOR XSORT,DMCB,ASPTTAB,(R0),(RF),SBDAY-SBDATE,SBDATE-SBUFFK          
         L     R5,ASPTTAB                                                       
DETRPT22 CLI   SBUFFK,FF           DONE                                         
         BE    DETRPTX                                                          
         LA    R8,SBPRD1           START WITH FIRST SLOT                        
         CLI   0(R8),0             SKIP IF COMPLETELY UNALLOCATED               
         BE    DETRPT54                                                         
DETRPT24 GOTOR MSUNPK,DMCB,(X'80',SBSTA-2),WORK,DRSTA                           
         CLI   RQMED,NETLETQ                                                    
         BNE   *+8                                                              
         MVI   DRSTA+4,SPACE                                                    
         LH    R6,SBENV1                                                        
         BCTR  R6,0                                                             
         MH    R6,HWENV1LN                                                      
         L     R1,AENV1SET         ENV 1 VALUE SET                              
         A     R6,ENVSATAB-ENVSETD(R1)                                          
         USING ENVTABD,R6                                                       
         GOTOR CODAY,DMCB,ENVS1DAY,DRDAYS                                       
         GOTOR DATCON,DMCB,(2,SBDATE),(4,DRDATE)                                
         EDIT  (B1,SBEST),(3,DRLIN),FILL=0                                      
         MVC   DREST,DRLIN                                                      
         MVI   DREST+3,DASH                                                     
         EDIT  (B2,SBLIN),(3,DRLIN),FILL=0                                      
         CLC   ENVS1STR,ENVS1END                                                
         BNE   *+10                                                             
         XC    ENVS1END,ENVS1END                                                
         GOTOR UNTIME,DMCB,ENVS1TIM,DRTIME                                      
         MVC   DRPROG,ENVS1PGM                                                  
DETRPT28 MVC   DRCOST+L'P1+6(6),=C'CPP/M-'                                      
         LA    R3,DRBASD                                                        
         LA    R4,SBCDEM                                                        
         LA    R6,BASEDEM                                                       
         LH    R7,NTARGETS                                                      
         CHI   R7,8                ONLY 8 TARGS CAN PRINT                       
         BNH   *+8                                                              
         LHI   R7,8                                                             
         AHI   R7,1                ADD ONE FOR CORPORATE                        
         MVC   FACTOR1,SBCOST      SET COST (SHARE) IN FACTOR1                  
DETRPT30 MVC   HDEM,0(R6)                                                       
         CLI   RQMED,NETLETQ       NO DECIMAL FOR NETWORK                       
         BNE   DETRPT32            AUDIENCES                                    
         CLI   HDEM+1,RATINGQ                                                   
         BE    DETRPT32                                                         
         EDIT  (B4,0(R4)),(8,0(R3)),ZERO=NOBLANK                                
         B     DETRPT34                                                         
DETRPT32 EDIT  (B4,0(R4)),(8,0(R3)),1,ZERO=NOBLANK                              
DETRPT34 ICM   R1,15,FACTOR1       COST                                         
         L     RF,CPPROUND                                                      
         CLI   HDEM+1,RATINGQ                                                   
         BE    *+8                                                              
         L     RF,CPMROUND                                                      
         MR    R0,RF                                                            
         L     RF,0(R4)                                                         
         GOTOR DIVIDE                                                           
         EDIT  (R1),(8,L'P1(R3)),2                                              
         AHI   R3,9                                                             
         AHI   R4,4                                                             
         AHI   R6,4                                                             
         BCT   R7,DETRPT30                                                      
         TM    REQFLAG1,REQFTRGS   INDICATE WHICH DEMOS ARE TARGETS             
         BZ    DETRPT42                                                         
         CLI   0(R8),0             NOT FOR UNA                                  
         BE    DETRPT42                                                         
         CLI   0(R8),UNAPRD2                                                    
         BE    DETRPT42                                                         
         SR    R4,R4                                                            
         IC    R4,0(R8)                                                         
         BCTR  R4,0                                                             
         MH    R4,PRDBUFLN                                                      
         A     R4,PRDBUFF                                                       
         AHI   R4,PTTRGS-PTBUFFD   TARGETS                                      
         LHI   R0,NTGVARS          FOR BCT                                      
         LA    R3,DRTARG1                                                       
DETRPT38 SR    RF,RF               DISPLACE TO RIGHT TARG                       
         ICM   RF,1,0(R4)                                                       
         BZ    DETRPT40            TARGET NOT ACTIVE                            
         BCTR  RF,0                                                             
         MHI   RF,L'DRTARG1        LENGTH OF FIELD ON LINE                      
         AR    RF,R3                                                            
         MVI   L'DRTARG1-1(RF),ASTERISK                                         
DETRPT40 AHI   R4,1                                                             
         BCT   R0,DETRPT38                                                      
DETRPT42 MVC   DRPRD,=C'***'       UNALLOCATED                                  
         CLI   0(R8),UNAPRD2                                                    
         BE    DETRPT44                                                         
         CLI   0(R8),0                                                          
         BE    DETRPT44                                                         
         SR    RF,RF               GET PRODUCT CODE                             
         IC    RF,0(R8)                                                         
         BCTR  RF,0                                                             
         MH    RF,PRDBUFLN                                                      
         A     RF,PRDBUFF                                                       
         MVC   DRPRD,1(RF)                                                      
DETRPT44 TM    SBSTAT2,SBSPRALQ    PRODUCT PRE-ALLOC                            
         BZ    *+8                                                              
         MVI   DRPRD+3,ASTERISK                                                 
         CLI   RQMED,NETLETQ       FOR NETWORK NO CENTS                         
         BE    DETRPT48                                                         
         EDIT  (B4,FACTOR1),(11,DRCOST),2,FLOAT=$                               
         B     DETRPT50                                                         
DETRPT48 EDIT  (B4,FACTOR1),(11,DRCOST),FLOAT=$                                 
DETRPT50 TM    DIAGNOP1,FF-(DENVBEFQ+DNDXPRTQ)                                  
         BZ    DETRPT52                                                         
         GOTOR HEXOUT,HEXP,SBSTAT,DRSTAT,2,NOL                                  
         GOTOR (RF),(R1),0(R8),DRPRDSLN,2                                       
DETRPT52 MVI   SPACING,2                                                        
         GOTOR REPORT                                                           
         LA    R0,WORD             IF POINTING TO SPECIAL                       
         CR    R8,R0               UNALLOCATED 'SLOT'                           
         BE    DETRPT56            THEN DEFINITELY DONE                         
         AHI   R8,2                NEXT SLOT                                    
         LA    R0,SBPRD2                                                        
         CR    R8,R0                                                            
         BH    DETRPT54                                                         
         CLI   0(R8),0             TEST ALLOCATED                               
         BNE   DETRPT24                                                         
*                                  DONE WITH ALLOC SLOTS                        
DETRPT54 CLI   SBUNLEN,0           TEST ANY UNALLOCATED LENGTH                  
         BE    DETRPT56            NO- DONE                                     
         MVC   WORD+1(1),SBUNLEN   YES- USE WORD AS SPECIAL UNA SLOT            
         MVI   WORD,UNAPRD2        PRODUCT UNA                                  
         LA    R8,WORD                                                          
         B     DETRPT24                                                         
DETRPT56 A     R5,SPTTABL          NEXT SPOT                                    
         B     DETRPT22                                                         
DETRPTX  J     EXIT                                                             
         DROP  R5,R6,RB                                                         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* DETAIL SPOT REPORT - MODE 2 (2 TARGETS OR LESS)                     *         
***********************************************************************         
                                                                                
DT2RPT   NTR1  BASE=*,LABEL=*                                                   
         CLI   RPTOPTN,RPTOALLQ    TEST DOING DETAIL REPORT                     
         BNE   DT2RPTX                                                          
         MVI   RCSUBPRG,35                                                      
         CLI   WEEKNO,1            FOR WEEK 1                                   
         BNE   *+12                                                             
         MVI   FORCEHED,YESQ       ALWAYS NEW PAGE                              
         B     DT2RPT02                                                         
         GOTOR REPORT              ELSE SKIP A LINE                             
DT2RPT02 MVC   P1(L'WEEKL),WEEKL                                                
         CLI   DAILYSW,YESQ        DAILY?                                       
         BNE   *+10                                                             
         MVC   P1(4),=C'Day '                                                   
         EDIT  (B1,WEEKNO),(2,P1+5)                                             
         L     R8,MEDBUFF                                                       
         USING MEDBLOCK,R8                                                      
         SR    R4,R4                                                            
         IC    R4,WEEKNO                                                        
         BCTR  R4,0                                                             
         MHI   R4,L'MEDQ1WKS                                                    
         A     R4,AWEEKLST                                                      
         GOTOR DATCON,DMCB,(2,0(R4)),(5,P1+9)                                   
         GOTOR (RF),(R1),(2,2(R4)),(5,P1+18)                                    
         MVI   P1+17,DASH                                                       
         DROP  R8                                                               
         L     R5,ASPTTAB                                                       
         USING SBUFFRD,R5                                                       
         CLI   0(R5),FF                                                         
         BNE   DT2RPT04                                                         
         MVC   P1+27(L'NSPTFRWK),NSPTFRWK                                       
         GOTOR REPORT                                                           
         B     DT2RPTX                                                          
DT2RPT04 MVI   SPACING,2                                                        
         CLI   SBUFFK,FF           NO SPOTS - DONE                              
         BE    DT2RPTX                                                          
         MVC   P1+30(L'AVALFRWK),AVALFRWK                                       
         L     R4,ASUPROW                                                       
         AH    R4,WKDISP                                                        
         L     R1,TPREDOL-TABDATA(R4)                                           
         LH    R0,HW10             UNITS ARE 0.0                                
         MR    R0,R0                                                            
         L     RF,12(R4)           SPOTS                                        
         GOTOR DIVIDE                                                           
         CLI   RQMED,NETLETQ       NO CENTS FOR NETWORK                         
         BE    DT2RPT06                                                         
         EDIT  (R1),(11,D2RCOST),2,FLOAT=$   AVERAGE COST                       
         B     DT2RPT08                                                         
DT2RPT06 EDIT  (R1),(11,D2RCOST),FLOAT=$                                        
DT2RPT08 MVC   HDEM,BASEDEM                                                     
         L     R1,4(R4)            DEM                                          
         LH    R0,HW10             UNITS ARE 0.0                                
         MR    R0,R0                                                            
         L     RF,12(R4)           SPOTS                                        
         GOTOR DIVIDE              AVERAGE RATING                               
         CLI   RQMED,NETLETQ       NO DECIMAL FOR NETWORK                       
         BNE   DT2RPT10            AUDIENCES                                    
         CLI   HDEM+1,RATINGQ                                                   
         BE    DT2RPT10                                                         
         EDIT  (R1),(7,D2RBASD),ZERO=NOBLANK                                    
         B     DT2RPT12                                                         
DT2RPT10 EDIT  (R1),(7,D2RBASD),1,ZERO=NOBLANK                                  
DT2RPT12 L     R1,8(R4)            DOLLARS                                      
         L     RF,CPPROUND                                                      
         CLI   HDEM+1,RATINGQ                                                   
         BE    *+8                                                              
         L     RF,CPMROUND                                                      
         MR    R0,RF                                                            
         L     RF,4(R4)            DEM                                          
         GOTOR DIVIDE                                                           
         LA    R5,D2RBASCP                                                      
         EDIT  (R1),(7,0(R5)),2    CORP DEM CPM                                 
         LA    R3,TABTA1-TABDATA(R4) TARGETS                                    
         LA    R5,D2RTARG1                                                      
         LA    R6,TARGETS          DEMOS                                        
         SR    R7,R7                                                            
         ICM   R7,3,NTARGETS                                                    
         BZ    DT2RPT20                                                         
DT2RPT14 MVC   HDEM,0(R6)          SET DEMO CODE                                
         L     R1,0(R3)            VALUE                                        
         LH    R0,HW10             UNITS ARE 0.0                                
         MR    R0,R0                                                            
         L     RF,12(R4)           / SPOTS                                      
         GOTOR DIVIDE              AVERAGE VALUE                                
         CLI   RQMED,NETLETQ       NO DECIMAL FOR NETWORK                       
         BNE   DT2RPT16            AUDIENCES                                    
         CLI   HDEM+1,RATINGQ                                                   
         BE    DT2RPT16                                                         
         EDIT  (R1),(7,0(R5)),ZERO=NOBLANK                                      
         B     DT2RPT18                                                         
DT2RPT16 EDIT  (R1),(7,0(R5)),1,ZERO=NOBLANK                                    
DT2RPT18 L     R1,8(R4)            /DOLLARS                                     
         L     RF,CPPROUND                                                      
         CLI   HDEM+1,RATINGQ                                                   
         BE    *+8                                                              
         L     RF,CPMROUND                                                      
         MR    R0,RF                                                            
         L     RF,0(R3)            VALUE                                        
         GOTOR DIVIDE                                                           
         EDIT  (R1),(7,8(R5)),2  TARGET CPM                                     
         AHI   R3,4                                                             
         AHI   R5,16                                                            
         AHI   R6,L'TARGETS                                                     
         BCT   R7,DT2RPT14                                                      
DT2RPT20 GOTOR REPORT                                                           
                                                                                
***********************************************************************         
* SPOT PROCESSING                                                     *         
***********************************************************************         
                                                                                
         L     R0,SPTTABN          SORT SPOTS IN DATE/TIME ORDER                
         L     RF,SPTTABL                                                       
         GOTOR XSORT,DMCB,ASPTTAB,(R0),(RF),SBDAY-SBDATE,SBDATE-SBUFFK          
         L     R5,ASPTTAB                                                       
DT2RPT22 CLI   SBUFFK,FF           DONE                                         
         BE    DT2RPTX                                                          
         LA    R8,SBPRD1           START WITH FIRST SLOT                        
         CLI   0(R8),0             SKIP IF COMPLETELY UNALLOCATED               
         BE    DT2RPT52                                                         
DT2RPT26 GOTOR MSUNPK,DMCB,(X'80',SBSTA-2),WORK,D2RSTA                          
         CLI   RQMED,NETLETQ                                                    
         BNE   *+8                                                              
         MVI   D2RSTA+4,SPACE                                                   
         LH    R6,SBENV1                                                        
         BCTR  R6,0                                                             
         MH    R6,HWENV1LN                                                      
         L     R1,AENV1SET         ENV1 VALUE SET                               
         A     R6,ENVSATAB-ENVSETD(R1)                                          
         USING ENVTABD,R6                                                       
         GOTOR CODAY,DMCB,ENVS1DAY,D2RDAYS                                      
         GOTOR DATCON,DMCB,(2,SBDATE),(4,D2RDATE)                               
         EDIT  (B1,SBEST),(3,D2REST),FILL=0                                     
DT2RPT28 CLC   ENVS1STR,ENVS1END                                                
         BNE   *+10                                                             
         XC    ENVS1END,ENVS1END                                                
         GOTOR UNTIME,DMCB,ENVS1TIM,D2RTIME                                     
         MVC   D2RPROG,ENVS1PGM                                                 
DT2RPT30 LA    R3,D2RBASD                                                       
         LA    R4,SBCDEM                                                        
         LA    R6,BASEDEM                                                       
         LH    R7,NTARGETS                                                      
         AHI   R7,1                                                             
         MVC   FACTOR1,SBCOST      SET COST (SHARE) IN FACTOR1                  
DT2RPT32 MVC   HDEM,0(R6)                                                       
         CLI   RQMED,NETLETQ       NO DECIMAL FOR NETWORK                       
         BNE   DT2RPT34            AUDIENCES                                    
         CLI   HDEM+1,RATINGQ                                                   
         BE    DT2RPT34                                                         
         EDIT  (B4,0(R4)),(7,0(R3)),ZERO=NOBLANK                                
         B     DT2RPT36                                                         
DT2RPT34 EDIT  (B4,0(R4)),(7,0(R3)),1,ZERO=NOBLANK                              
DT2RPT36 ICM   R1,15,FACTOR1       COST                                         
         L     RF,CPPROUND                                                      
         CLI   HDEM+1,RATINGQ                                                   
         BE    *+8                                                              
         L     RF,CPMROUND                                                      
         MR    R0,RF                                                            
         L     RF,0(R4)                                                         
         GOTOR DIVIDE                                                           
         EDIT  (R1),(7,8(R3)),2                                                 
         AHI   R3,16                                                            
         AHI   R4,4                                                             
         AHI   R6,4                                                             
         BCT   R7,DT2RPT32                                                      
         TM    REQFLAG1,REQFTRGS   INDICATE WHICH DEMOS ARE TARGETS             
         BZ    DT2RPT42                                                         
         CLI   0(R8),0             NOT FOR UNA                                  
         BE    DT2RPT42                                                         
         CLI   0(R8),UNAPRD2                                                    
         BE    DT2RPT42                                                         
         SR    R4,R4                                                            
         IC    R4,0(R8)                                                         
         BCTR  R4,0                                                             
         MH    R4,PRDBUFLN                                                      
         A     R4,PRDBUFF                                                       
         AHI   R4,PTTRGS-PTBUFFD   TARGETS                                      
         LHI   R0,NTGVARS          FOR BCT                                      
         LA    R3,D2RTARG1                                                      
DT2RPT38 SR    RF,RF               DISPLACE TO RIGHT TARG                       
         ICM   RF,1,0(R4)                                                       
         BZ    DT2RPT40            TARGET NOT ACTIVE                            
         BCTR  RF,0                                                             
         MHI   RF,14               LENGTH OF FIELD ON LINE                      
         AR    RF,R3                                                            
         MVI   7(RF),ASTERISK                                                   
DT2RPT40 AHI   R4,1                                                             
         BCT   R0,DT2RPT38                                                      
DT2RPT42 MVC   D2RPRD,=C'***'      UNALLOCATED                                  
         CLI   0(R8),UNAPRD2                                                    
         BE    DT2RPT44                                                         
         CLI   0(R8),0                                                          
         BE    DT2RPT44                                                         
         SR    RF,RF               GET PRODUCT CODE                             
         IC    RF,0(R8)                                                         
         BCTR  RF,0                                                             
         MH    RF,PRDBUFLN                                                      
         A     RF,PRDBUFF                                                       
         MVC   D2RPRD,1(RF)                                                     
DT2RPT44 TM    SBSTAT2,SBSPRALQ    PRODUCT PRE-ALLOC                            
         BZ    *+8                                                              
         MVI   D2RPRD+3,ASTERISK                                                
         EDIT  (B1,1(R8)),(3,D2RSLN)  LENGTH                                    
         TM    SBSTAT2,SBSLPRAQ    LEN PRE-ALLOC                                
         BZ    *+8                                                              
         MVI   D2RSLN+3,ASTERISK                                                
DT2RPT46 CLI   RQMED,NETLETQ       FOR NETWORK NO CENTS                         
         BE    DT2RPT48                                                         
         EDIT  (B4,FACTOR1),(11,D2RCOST),2,FLOAT=$                              
         B     DT2RPT50                                                         
DT2RPT48 EDIT  (B4,FACTOR1),(11,D2RCOST),FLOAT=$                                
DT2RPT50 GOTOR REPORT                                                           
         LA    R0,WORD             IF POINTING TO SPECIAL                       
         CR    R8,R0               UNALLOCATED 'SLOT'                           
         BE    DT2RPT54            THEN DEFINITELY DONE                         
         AHI   R8,2                NEXT SLOT                                    
         LA    R0,SBPRD2                                                        
         CR    R8,R0                                                            
         BH    DT2RPT52                                                         
         CLI   0(R8),0             TEST ALLOCATED                               
         BNE   DT2RPT26                                                         
*                                  DONE WITH ALLOC SLOTS                        
DT2RPT52 CLI   SBUNLEN,0           TEST ANY UNALLOCATED LENGTH                  
         BE    DT2RPT54            NO- DONE                                     
         MVC   WORD+1(1),SBUNLEN   YES- USE WORD AS SPECIAL UNA SLOT            
         MVI   WORD,UNAPRD2        PRODUCT UNA                                  
         LA    R8,WORD                                                          
         B     DT2RPT26                                                         
DT2RPT54 A     R5,SPTTABL          NEXT SPOT                                    
         B     DT2RPT22                                                         
DT2RPTX  J     EXIT                                                             
         DROP  R5,R6,RB                                                         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* SPOT HOOK                                                           *         
***********************************************************************         
                                                                                
SPHOOK   NMOD1 0,**SPHOOK                                                       
         L     RF,=A(SAVER8RA)                                                  
         LM    R8,RA,0(RF)                                                      
         LA    RC,SPACEND                                                       
         LA    R5,W                                                             
         USING SBUFFRD,R5                                                       
         ST    R1,SAVER1           SAVE A(GETRATE AREA)                         
         L     R6,SPOTADDR                                                      
         USING REGELEM,R6                                                       
         L     R7,ADBUY                                                         
         USING BUYREC,R7                                                        
         MVI   SPOTYORN,NOQ        SET TO REJECT SPOT                           
         TM    RSTATUS,RSMINUSQ+RSMINSDQ+RSHIATSQ                               
         BNZ   SPHOOKX                                                          
         CLI   QPGR,SPACE          IF PRODUCT GRP REQ                           
         BE    SPHOOK08                                                         
         CLI   RLEN,RLPOL1LQ       AND SPOT IS ALLOCATED                        
         BL    SPHOOK08                                                         
         BH    SPHOOKX             (NON-PIGGIES ONLY)                           
         L     RE,PRDLIST          ONLY ACCEPT IF PRODUCT IN PGR                
         SR    RF,RF                                                            
         IC    RF,PRDCLCLN         COMPARE LENGTH (-1)                          
SPHOOK04 OC    0(2,RE),0(RE)       EOL                                          
         BZ    SPHOOKX                                                          
         UNPK  DUB(5),0(3,RE)                                                   
         EX    RF,*+12                                                          
         BL    SPHOOK06                                                         
         BH    SPHOOKX             LIST IS IN PGR ORDER                         
         CLC   DUB(0),SVPGRQ                                                    
         CLC   RPPRD,5(RE)         PRODUCT                                      
         BE    SPHOOK08                                                         
SPHOOK06 AHI   RE,6                NEXT LIST ENTRY                              
         B     SPHOOK04                                                         
SPHOOK08 MVI   SPOTYORN,YESQ       SET TO ACCEPT                                
         CLI   PRESW,YESQ                                                       
         BE    SPHOOK32                                                         
         CLC   RDATE,SBDATE        TEST SAME DATE                               
         BE    SPHOOK12                                                         
         MVI   SBSPTNO,0           NO - RESET SPOT NUM                          
         MVC   SBDAY,BDDAY         USE ROTATOR                                  
         CLI   RCODE,RCPOTOQ       UNLESS OTO - THEN USE SINGLE DAY             
         BNE   SPHOOK10                                                         
         GOTOR DATCON,DMCB,(2,RDATE),DUB                                        
         GOTOR GETDAY,DMCB,DUB,FULL                                             
         LHI   RE,1                START WITH SUNDAY                            
         SR    RF,RF                                                            
         IC    RF,DMCB             DAY OF WEEK NUMBER                           
         SHI   RF,DAYWEEK                                                       
         LPR   RF,RF                                                            
         STC   RF,*+7              MODIFY SHIFT INSTRUCTION                     
         SLL   RE,0                                                             
         STC   RE,SBDAY                                                         
SPHOOK10 MVC   SBDATE,RDATE                                                     
SPHOOK12 SR    RF,RF                                                            
         IC    RF,SBSPTNO                                                       
         AHI   RF,1                                                             
         STC   RF,SBSPTNO                                                       
         LH    RF,SPTSEQ           BUMP SPOT SEQUENCE NO.                       
         AHI   RF,1                                                             
         STH   RF,SPTSEQ                                                        
         CLI   SPLTOPT,SECS15      FOR SPLIT 15'S                               
         BNE   SPHOOK14                                                         
         TM    SPTSEQ+1,X'80'      MORE THAT 7 BITS MEANS CAN'T                 
         BZ    *+6                 USE NEEDED LOW ORDER ONE                     
         DC    H'0'                TOO MANY SPOTS IN BUY LINE                   
         SLL   RF,1                FREE UP LOW BIT TO DISTINGUISH               
         CLI   SPLTPASS,2          PASS1 FROM PASS2 BUYS                        
         BNE   *+8                                                              
         AHI   RF,1                PASS 2 GETS LOW BIT ON                       
SPHOOK14 STC   RF,SBSEQ                                                         
         L     RF,SAVER1           A(GETRATE AREA)                              
         L     RF,0(RF)                                                         
         MVC   SBCOST,4(RF)                                                     
         MVC   SBCDEM,HLDDEM       CORP DEMO                                    
         MVC   SBTARGS(MAXTARGS*4),HLDDEM+L'HLDDEM                              
         GOTOR GETWKN,RDATE                                                     
         STC   RF,SBWK                                                          
         MVI   SBPRD1,0                                                         
         MVI   SBSTAT,0                                                         
         MVI   SBSTAT2,0                                                        
         MVC   SBPDLEN,BDSEC       SET LENGTH                                   
         MVC   SBUNLEN,BDSEC       SET UNALL LENGTH                             
         GOTOR TSTSPT                                                           
         BNE   SPHOOK28            NOT OKAY TO RE-ALLOCATE                      
                                                                                
         CLI   SVQSTA,SPACE        IF A 1 STATION REQ                           
         BNH   SPHOOK24                                                         
         TM    REQFLAG2,REQFOSTA   AND COUNTING OTHER STATIONS                  
         BZ    SPHOOK24                                                         
         CLC   SVQSTA(4),STA       AND CURRENT STATION IS NOT                   
         BE    SPHOOK24            REQUESTED ONE, PRESERVE ALLOC                
         CLC   QPROG,QPROGKLL                                                   
         BNE   SPHOOK26                                                         
         LA    R1,BDELEM           TEST BUY FOR REQUESTED NETWORK               
         USING NTWKELEM,R1                                                      
         SR    R0,R0                                                            
SPHOOK16 IC    R0,NTWKLEN                                                       
         AR    R1,R0                                                            
         CLI   NTWKCODE,0                                                       
         BE    SPHOOK24                                                         
         CLI   NTWKCODE,NTWKCODQ                                                
         BNE   SPHOOK16                                                         
         CLC   SVQSTA(4),NTWKMKST                                               
         BNE   SPHOOK26                                                         
         DROP  R1                                                               
*                                  FOR NETWORK BUYS DURING COMBINED             
*                                  AND TV RUN                                   
SPHOOK24 CLC   QPROG,QPROGKLL      FOR KL RUN ONLY TEST SPILL                   
         BE    *+14                                                             
         CLC   BRQAM,BUYKAM                                                     
         BNE   SPHOOK26                                                         
         CLC   BUYKMKTN,SAVMKTN                                                 
         BE    SPHOOK30                                                         
                                                                                
SPHOOK26 OI    SBSTAT2,SBSPRALQ    SET UNALLOCATED SPOTS TO                     
         MVI   SBPRD1,UNAPRD2      PRE-ALLOCATED TO PRODUCT UNALLOCATED         
         MVC   SBLEN1,BDSEC        SET LENGTH                                   
         MVI   SBUNLEN,0           NO UNALLOCATED LENGTH                        
         CLI   RLEN,RLREGLNQ       BUT ONLY IF TRULY UNALL                      
         BNH   SPHOOK30            (CANT REALLOCATE THESE SPOTS)                
                                                                                
SPHOOK28 GOTOR SETPRD              SET PRODUCT                                  
         MVC   SBPRD1,SPHPRD                                                    
         MVC   SBLEN1,BDSEC        SET LENGTH                                   
         OI    SBSTAT2,SBSPRALQ    SET PRE-ALLOCATED                            
         MVI   SBUNLEN,0           NO UNALLOCATED LENGTH                        
                                                                                
SPHOOK30 GOTOR BU2PUT              PUT BUFFER 2 RECORD                          
         B     SPHOOKX                                                          
                                                                                
SPHOOK32 MVI   SPOTYORN,YESQ       PASS TO GET PRE-ALLOCS                       
         CLI   SPHFILT,FF          TEST SUPPLY                                  
         BE    SPHOOKX             YES - ALWAYS COUNT                           
         XC    FULL,FULL           SET PRODUCT/LENS IN FULL                     
         MVI   FULL,UNAPRD1        UNA                                          
         CLI   RLEN,RLPOL1LQ                                                    
         BL    SPHOOK34                                                         
         MVC   FULL+0(2),RPPRD                                                  
         CLI   RLEN,RLPOL2LQ                                                    
         BL    SPHOOK34                                                         
         MVC   FULL+2(2),RPPRD+L'RPALLOC                                        
                                                                                
SPHOOK34 CLC   FULL,SPHFILT        TEST RIGHT PRODUCT/SLN                       
         BNE   SPHOOK40                                                         
         CLI   SPHPRD,0            TEST HAVE SET RETURN PRODUCT                 
         BNE   *+8                                                              
         GOTOR SETPRD                                                           
         GOTOR TSTSPT              TEST CAN RE-ALLOCATE                         
         BNE   SPHOOKX             NO, DONE                                     
         CLI   SVQSTA,SPACE        YES - IF A 1 STATION REQ                     
         BNH   SPHOOK36                                                         
         TM    REQFLAG2,REQFOSTA   AND COUNTING OTHER STATIONS                  
         BZ    SPHOOK36                                                         
         CLC   SVQSTA,STA          AND CURRENT STATION IS NOT                   
         BNE   SPHOOKX             REQUESTED ONE, COUNT SPOT                    
                                                                                
SPHOOK36 CLC   QCODE,QPROGK4L                                                   
         BNE   SPHOOK38                                                         
         CLC   BRQAM,BUYKAM                                                     
         BNE   SPHOOKX                                                          
                                                                                
SPHOOK38 CLC   BUYKMKTN,SAVMKTN    TEST NETWORK LEVEL BUY                       
         BNE   SPHOOKX                                                          
                                                                                
SPHOOK40 MVI   SPOTYORN,NOQ        DO NOT COUNT THIS SPOT                       
                                                                                
SPHOOKX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* TEST SPOT OK TO ALLOCATE                                            *         
***********************************************************************         
                                                                                
TSTSPT   CLI   RLEN,RLREGLNQ       TEST ALLOCATED                               
         BE    TSTSPTY                                                          
         TM    RSTATUS,RSNOALLQ    TEST ALLOC FROZEN                            
         BNZ   TSTSPTN                                                          
         CLI   QOPT4,YESQ          IF TEST RUN SKIP PAY/BILL TEST               
         BE    TSTSPT04                                                         
         CLI   RPAY,0              TEST PAID                                    
         BNE   TSTSPTN                                                          
                                                                                
         LA    RF,REGELEM          SKIP MATCHED SPOTS, AS PER BUY PROG          
         SR    R0,R0                                                            
TSTSPT02 IC    R0,1(RF)                                                         
         AR    RF,R0                                                            
         CLI   0(RF),0                                                          
         BE    TSTSPT04                                                         
         CLI   0(RF),RCPOLOQ                                                    
         BL    TSTSPT02                                                         
         CLI   0(RF),RCPOLFQ                                                    
         BNH   TSTSPT04                                                         
         CLI   0(RF),ACCODEQ                                                    
         BE    TSTSPTN             FOUND AFFID SO SPOT MATCHED - IGNORE         
         B     TSTSPT02                                                         
                                                                                
TSTSPT04 CLC   RDATE,REALLSDT      TEST VS REALLOC START DATE                   
         BL    TSTSPTN                                                          
         CLI   NTPSW,NTPSNTPO      IF NTP ONLY RUN                              
         BE    TSTSPTY             OK                                           
         TM    BDCIND2,BDCCONVQ    BDCIND IS A CHARACTER                        
         BZ    TSTSPT06                                                         
         CLI   BDCIND,BDCNTP       ELSE IF SPOT IS NTP                          
         BE    TSTSPTN             DO NOT RE-ALLOCATE                           
         B     TSTSPTY                                                          
TSTSPT06 TM    BDCIND,OLDNTO       ELSE IF SPOT IS NTP                          
         BZ    TSTSPTN             DO NOT RE-ALLOCATE                           
                                                                                
TSTSPTY  CR    RE,RE               OK TO RE-ALLOCATE                            
         BR    RE                                                               
TSTSPTN  LTR   RE,RE               NOT OK TO RE-ALLOCATE                        
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
* SET PRODUCT CODE FROM SPOT ELEM                                     *         
***********************************************************************         
                                                                                
SETPRD   MVI   SPHPRD,UNAPRD1      UNA                                          
         CLI   RLEN,RLPOL1LQ                                                    
         BLR   RE                                                               
         MVC   SPHPRD,RPPRD        SET SINGLE PRODUCT                           
         BER   RE                  DONE                                         
         MVC   DUB+0(1),RPPRD      ELSE SET ARG FOR PRD TABLE SEARCH            
         MVC   DUB+1(1),RPPRD+L'RPALLOC  2ND PRODUCT                            
         MVC   DUB+2(1),RPTIME     1ST LENGTH                                   
         MVC   DUB+3(1),RPTIME+L'RPALLOC 2ND LENGTH                             
         L     RF,PRDBUFF                                                       
         USING PTBUFFD,RF                                                       
         LHI   R0,UGPIGPRD                                                      
SETPRD02 CLI   0(RF),0                                                          
         BE    SETPRD04                                                         
         CLC   PTPPVALS,DUB        TEST PRODUCTS/SHARES                         
         BE    SETPRD06                                                         
SETPRD04 AH    RF,PRDBUFLN                                                      
         BCT   R0,SETPRD02                                                      
         CLI   UNGPIG,0            NOT FOUND, TEST UNGOALED PIGS OK             
         BNE   *+6                 IF PRODUCT UGPIGPRD IS USED THEN             
         DC    H'0'                UNGOLADED PIGS NOT ALLOWED                   
         MVC   SPHPRD,UNGPIG       SET AS UNGOALED PIG                          
         BR    RE                                                               
SETPRD06 MVC   SPHPRD,PTPRDN                                                    
         BR    RE                                                               
         DROP  R5,R6,R7,RB,RF                                                   
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* HEADLINE ROUTINE                                                    *         
***********************************************************************         
                                                                                
HEDBLD   NMOD1 0,**HEDBLD                                                       
         L     RF,=A(SAVER8RA)                                                  
         LM    R8,RA,0(RF)                                                      
         LA    RC,SPACEND                                                       
         CLI   SKIPSPEC,YESQ                                                    
         BE    HEDBLDX                                                          
         CLI   SVQSTA,SPACE                                                     
         BNH   HEDBLD04                                                         
         CLC   ALL3,SVQSTA                                                      
         BE    HEDBLD04                                                         
         CLI   SVQSTA+4,SLASH      LOCAL CABLE                                  
         BE    *+12                                                             
         CLI   SVQSTA,ZONE         ELSE NUMERIC IS MARKET OR MGR                
         BNL   HEDBLD04                                                         
         MVC   HEAD7(L'STATIONL),STATIONL                                       
         MVC   HEAD7+12(7),SVBIGSTA                                             
HEDBLD04 CLI   RCSUBPRG,40         PARAM REPORT                                 
         BE    HEDBLD38                                                         
         MVC   HEAD5+51(25),=C'Allocation based on costs'                       
         CLI   GOALOPT,GOALDOLS                                                 
         BE    *+10                                                             
         MVC   HEAD5+50+21(DEMNNAML),DEMNMS+(DEMNNADP-DEMNAMD)                  
         CLI   QOPT4,YESQ                                                       
         BNE   *+10                                                             
         MVC   HEAD6+51(L'TRUNFNML),TRUNFNML                                    
         CLI   RCSUBPRG,80         TEST CHILD SPOT RPT                          
         BE    HEDBLD16                                                         
         CLI   RCSUBPRG,20         SUMMARY REP (WEEKLY ANAL)                    
         BE    HEDBLD18                                                         
         CLI   RCSUBPRG,10         RECAP REPORT                                 
         BE    HEDBLD42                                                         
         CLI   RCSUBPRG,30         DETAIL REPORT- MODE 1                        
         BE    HEDBLD06                                                         
         CLI   RCSUBPRG,35         DETAIL REPORT- MODE 2                        
         BE    HEDBLD46                                                         
         CLI   RCSUBPRG,37         PROGRAM/PRODUCT RECAP                        
         BE    HEDBLD56                                                         
         CLI   RCSUBPRG,50         GOAL REPORT                                  
         BE    HEDBLD18                                                         
         B     HEDBLDX                                                          
                                                                                
***********************************************************************         
* DETAIL REPORT HEADLINES - MODE 1                                    *         
***********************************************************************         
                                                                                
HEDBLD06 MVC   HEAD8(L'DPTDESC),DPTDESC                                         
         L     RE,ADETHD1                                                       
         MVC   HEAD10(L'DETHD1),0(RE)                                           
         MVC   HEAD11(L'DETHD2),L'DETHD1(RE)                                    
         MVC   HEAD12(L'DETHD3),L'DETHD1+L'DETHD2(RE)                           
         LA    R2,HEAD10                                                        
         LA    R4,BASEDEM          SET DEMO NAMES                               
         LH    R5,NTARGETS                                                      
         AHI   R5,1                INCLUDE CORP                                 
         CHI   R5,9                NINE MAX ALTOGETHER                          
         BNH   *+8                                                              
         LHI   R5,9                                                             
         LA    R6,HEAD10+51        START OF NAMES                               
HEDBLD12 GOTOR DEMNAM,0(R4)                                                     
         MVC   000+4(L'DEMNNADP,R6),DEMNNADP-DEMNAMD(RF)                        
         MVC   WORK(L'DEMNNAME),SPACES      RIGHT ALIGN DEMO NAME               
         MVC   WORK+L'DEMNNAME(L'DEMNNAME),DEMNNAME-DEMNAMD(RF)                 
         LA    R3,WORK+L'DEMNNAME                                               
HEDBLD14 MVC   L'P1+1(L'DEMNNAME,R6),0(R3)                                      
         CLI   L'P1+L'DEMNNAME(R6),SPACE                                        
         BH    *+10                                                             
         BCTR  R3,0                                                             
         B     HEDBLD14                                                         
         MVC   L'P1*2+1(L'DEMNNAME,R6),DASHES                                   
         AHI   R6,9                                                             
         AHI   R4,4                                                             
         BCT   R5,HEDBLD12                                                      
         B     HEDBLDX                                                          
                                                                                
***********************************************************************         
* CHILD SPOT                                                          *         
***********************************************************************         
                                                                                
HEDBLD16 L     RE,ACHDHD1                                                       
         MVC   HEAD9+29(L'CHDHD1),0(RE)                                         
         MVC   HEAD10+29(L'CHDHD2),L'CHDHD1(RE)                                 
         MVC   HEAD11+29(L'CHDHD3),L'CHDHD1+L'CHDHD2(RE)                        
         B     HEDBLDX                                                          
                                                                                
***********************************************************************         
* SUMMARY REPORT HEADLINES AND GOAL BALANCE REPORT                    *         
***********************************************************************         
                                                                                
HEDBLD18 CLI   RCSUBPRG,50         TEST GOAL REPORT                             
         BNE   HEDBLD22                                                         
         CLI   PBMODE,PBMDPTQ                                                   
         BNE   HEDBLD20                                                         
         MVC   HEAD8(29),=C'**Overall daypart balancing**'                      
         B     HEDBLD24                                                         
HEDBLD20 MVC   HEAD8+25(31),=C'**Week by week goal balancing**'                 
HEDBLD22 MVC   HEAD8(L'DPTDESC),DPTDESC                                         
HEDBLD24 LA    R6,HEAD10                                                        
         AH    R6,ROWDISP                                                       
         MVC   L'P1(5,R6),=C'Brand'                                             
         MVC   L'P1*2(5,R6),DASHES                                              
         LH    R5,RPTNWKS                                                       
         AH    R6,AMTDISP                                                       
         CLI   RPTSWK,0            ARE WE STARTING WITH 'TOTAL WEEK'            
         BNE   HEDBLD26                                                         
         MVC   2(L'TOTALL,R6),TOTALL                                            
         MVC   L'P1(8,R6),=C'Campaign'                                          
         MVC   L'P1*2(8,R6),DASHES                                              
         AH    R6,WEEKWID          POINT TO WEEK 1 COLUMN                       
         BCTR  R5,0                ONE LESS WEEK                                
HEDBLD26 CLI   PBMODE,PBMDPTQ      TEST DOING DAYPART RESCALING                 
         BE    HEDBLD30                                                         
         CLI   DAILYSW,YESQ                                                     
         BE    *+10                                                             
         MVC   1(8,R6),=C'Week of-'                                             
         L     R4,AWEEKLST         ADJUSTED COPY OF MEDWEEKS                    
         SR    RF,RF                                                            
         ICM   RF,1,RPTSWK         POINT TO STARTING WEEK                       
         BZ    HEDBLD28                                                         
         BCTR  RF,0                                                             
         MHI   RF,L'MEDQ1WKS                                                    
         AR    R4,RF                                                            
HEDBLD28 GOTOR DATCON,DMCB,(2,0(R4)),(4,L'P1+3(R6))                             
         MVC   L'P1*2+3(5,R6),DASHES                                            
         AH    R6,WEEKWID                                                       
         AHI   R4,L'MEDQ1WKS                                                    
         BCT   R5,HEDBLD28                                                      
         B     HEDBLD34                                                         
HEDBLD30 LA    R4,DSTAB            TABLE OF DAYPART/SLNS                        
         SR    RF,RF                                                            
         ICM   RF,1,RPTSWK         POINT TO STARTING DAYPART                    
         BZ    HEDBLD32                                                         
         BCTR  RF,0                                                             
         SLL   RF,1                2 BYTE ENTRIES IN TABLE                      
         AR    R4,RF                                                            
HEDBLD32 MVC   L'P1+4(1,R6),0(R4)                                               
         LA    R2,L'P1+5(R6)                                                    
         EDIT  (B1,1(R4)),(3,0(R2)),ALIGN=LEFT                                  
         MVC   L'P1*2+3(5,R6),DASHES                                            
         AHI   R4,L'DSTAB          NEXT DSTAB ENTRY                             
         AH    R6,WEEKWID                                                       
         BCT   R5,HEDBLD32                                                      
HEDBLD34 CLI   NOMID,YESQ                                                       
         BE    HEDBLD36                                                         
         LA    R6,MID1                                                          
         AH    R6,ROWDISP                                                       
         MVC   0(L'SRPNL1,R6),SRPNL1                                            
         MVC   L'P1(L'SRPNL2,R6),SRPNL2                                         
HEDBLD36 B     HEDBLDX                                                          
                                                                                
***********************************************************************         
* PARAMETER REPORT                                                    *         
***********************************************************************         
                                                                                
HEDBLD38 CLI   PMHLSW,PMHLBRDQ                                                  
         BNE   HEDBLD40                                                         
         LA    RE,HEAD9                                                         
         L     RF,APARHD1                                                       
         LHI   R0,PARHDN                                                        
         MVC   0(L'PARHD1,RE),0(RF)                                             
         AHI   RE,L'P1                                                          
         AHI   RF,L'PARHD1                                                      
         BCT   R0,*-14                                                          
HEDBLD40 B     HEDBLDX                                                          
                                                                                
***********************************************************************         
* RECAP REPORT                                                        *         
***********************************************************************         
                                                                                
HEDBLD42 MVC   HEAD8(L'DPTDESC),DPTDESC                                         
         MVC   HEAD10+1(5),=C'Brand'                                            
         MVC   HEAD11+1(5),DASHES                                               
         L     RE,ARECHD1                                                       
         MVC   HEAD10+49(L'RECHD1),0(RE)                                        
         MVC   HEAD11+49(L'RECHD2),L'RECHD1(RE)                                 
         B     HEDBLDX                                                          
                                                                                
***********************************************************************         
* DETAIL REPORT - MODE 2                                              *         
***********************************************************************         
                                                                                
HEDBLD46 MVC   HEAD8(L'DPTDESC),DPTDESC                                         
         L     RE,AD2RHD1                                                       
         MVC   HEAD10(L'D2RHD1),0(RE)                                           
         MVC   HEAD11(L'D2RHD2),L'D2RHD1(RE)                                    
         LA    R2,HEAD10                                                        
         LA    R4,BASEDEM          SET DEMO NAMES                               
         LH    R5,NTARGETS                                                      
         LA    R5,1(R5)            INCLUDE CORP                                 
         CHI   R5,9                NINE TARGS WON'T FIT                         
         BL    *+8                                                              
         LHI   R5,9                NOTE-DROPS TARGS 9+                          
         LA    R6,HEAD9+83         START OF NAMES                               
HEDBLD50 GOTOR DEMNAM,0(R4)                                                     
         MVC   000+3(L'DEMNNADP,R6),DEMNNADP-DEMNAMD(RF)                        
         MVC   L'P1+11(3,R6),=C'CPP' CPP                                        
         CLI   DEMNRVSA-DEMNAMD(RF),DEMNRATQ                                    
         BE    HEDBLD52                                                         
         MVC   L'P1+11(3,R6),=C'CPM' CPM                                        
HEDBLD52 MVC   WORK(L'DEMNNAME),SPACES                                          
         MVC   WORK+L'DEMNNAME(L'DEMNNAME),DEMNNAME-DEMNAMD(RF)                 
         LA    R3,WORK+L'DEMNNAME                                               
HEDBLD54 MVC   L'P1(L'DEMNNAME,R6),0(R3)                                        
         CLI   L'P1+L'DEMNNAME-1(R6),SPACE                                      
         BH    *+10                                                             
         BCTR  R3,0                                                             
         B     HEDBLD54                                                         
         MVC   L'P1*2+00(L'DEMNNAME,R6),DASHES                                  
         MVC   L'P1*2+10(5,R6),DASHES                                           
         AHI   R6,16                                                            
         AHI   R4,4                                                             
         BCT   R5,HEDBLD50                                                      
         B     HEDBLDX                                                          
                                                                                
***********************************************************************         
* PROGRAM/PRODUCT RECAP REPORT                                        *         
***********************************************************************         
                                                                                
HEDBLD56 MVC   HEAD8(L'DPTDESC),DPTDESC                                         
         L     RF,APGMHD1          A(HEADLINES)                                 
         MVC   HEAD10,000(RF)                                                   
         MVC   HEAD11,L'P1(RF)                                                  
         MVC   HEAD12,L'P1*2(RF)                                                
                                                                                
HEDBLDX  J     EXIT                                                             
         DROP  RB,RC                                                            
                                                                                
         LTORG                                                                  
         EJECT                                                                  
SAVER8RA DS    3A                  SAVE AREA FOR R8 THRU RA                     
                                                                                
***********************************************************************         
* THE FOLLOWING FIELDS ARE MOVED TO WORKD DURING INITIALIZAION        *         
***********************************************************************         
                                                                                
                                                                                
LITERAL  DS    0D                                                               
                                                                                
         DC    A(HEDBLD)                                                        
         DC    A(SPHOOK)                                                        
         DC    A(BUFF1)                                                         
         DC    A(BUFF2)                                                         
         DC    V(PRDBLD)                                                        
         DC    V(SCANNER)                                                       
         DC    V(MEDPIGL)                                                       
         DC    V(BUFFERIN)                                                      
         DC    V(COVAIL)                                                        
         DC    V(LOCKET)                                                        
         DC    A(PRDTRT)                                                        
         DC    A(CLSTRT)                                                        
         DC    A(PALLST)                                                        
         DC    A(PCLLST)                                                        
         DC    A(SCELLS)                                                        
         DC    A(RSLTAB)                                                        
         DC    A(SRLTAB)                                                        
         DC    A(PRTHD1)                                                        
         DC    A(CHDHD1)                                                        
         DC    A(TRTTAB)                                                        
         DC    A(PGMHD1)                                                        
         DC    A(PGMHD2)                                                        
         DC    A(IPRDTRT)                                                       
         DC    A(VARHDS)                                                        
         DC    A(VARHSUM)                                                       
         DC    A(VARHD1)                                                        
         DC    A(SPTHD1)                                                        
         DC    A(TYPTAB)                                                        
         DC    A(DGRDOL)                                                        
         DC    A(DGRDEM)                                                        
         DC    A(INTTAB)                                                        
         DC    A(OBJTAB)                                                        
         DC    A(RECHD1)                                                        
         DC    A(DETHD1)                                                        
         DC    A(D2RHD1)                                                        
         DC    A(PIGLST)                                                        
         DC    A(SVPTBUFF)                                                      
         DC    A(PARHD1)                                                        
         DC    A(PXCRCRD)                                                       
         DC    A(XCTABC)                                                        
         DC    A(ENV1SET)                                                       
         DC    A(ENV2SET)                                                       
         DC    A(ENV3SET)                                                       
         DC    A(NETLIST)                                                       
         DC    A(WEEKLST)                                                       
         DC    A(SBUYREC)                                                       
         DC    A(PRDTAB)                                                        
                                                                                
         DC    AL2(QPROGKL)                                                     
         DC    AL2(QPROGK4)                                                     
         DC    C'BU1PUT='                                                       
         DC    C'BU1HIG='                                                       
         DC    C'BU1SEQ='                                                       
         DC    C'BU2PUT='                                                       
         DC    C'BU2HIG='                                                       
         DC    C'BU2SEQ='                                                       
         DC    C'SETRESPUTGETSEQHIGH'                                           
         DC    C'Station'                                                       
         DC    C'Units',C'Total',C'Spots',C'Class=',C'Week',C'N'                
         DC    C'**Request bypassed**'                                          
         DC    C'**No spots for this week**'                                    
         DC    C'Average values for week ='                                     
         DC    C'** Totals **'                                                  
         DC    C'**Test run-file not marked**'                                  
         DC    CL5'ALL'                                                         
         DC    30C'-'                                                           
         DS    0F                                                               
         DC    10AL1(FF)                                                        
         DC    6C'0'                                                            
         DC    AL1(ALLDPT,ALLSLN)                                               
         DS    0F                                                               
         DC    X'80000000'                                                      
         DC    X'7FFFFFFF'                                                      
         DC    F'1,10,50,99,100,150,1000,5000,10000,100000'                     
         DC    H'1,10,20,100,1000,5000,10000'                                   
         DC    X'7FFF'                                                          
         DC    Y(ENVS1LEN)                                                      
         DC    C'**HIGH**'                                                      
         DC    D'2147483647'                                                    
                                                                                
LITERALX EQU   *                                                                
         EJECT                                                                  
BUFF1    BUFFD TYPE=B,KEYLEN=L'GBUFFK,COMLEN=2,COLUMNS=27,FILE=BUFFWK, *        
               BUFFERS=10                                                       
                                                                                
BUFF2    BUFFD TYPE=D,KEYLEN=SBUFFKL,COMLEN=SBDATAL,REPCOM=Y,          *        
               FILE=SORTWK01,BUFFERS=10                                         
                                                                                
***********************************************************************         
* TABLE OF COLUMN SPACING CONTROLS                                    *         
*                                                                     *         
* TABLE IS INDEXED BY WEEK NUMBER                                     *         
* EACH TABLE ENTRY CONTAINS TWO SET OF VALUES                         *         
*                                                                     *         
* BYTE 1 - START OF ROW DESC                                          *         
* BYTE 2 - OVER TO TOTAL COLUMN                                       *         
* BYTE 3 - COLUMN SPACING                                             *         
***********************************************************************         
                                                                                
SRLTAB   DS    0XL3                                                             
         DC    AL1(13,18,12)       1 WEEK                                       
         DC    AL1(13,18,12)       2                                            
         DC    AL1(12,18,12)       3                                            
         DC    AL1(11,18,12)       4                                            
         DC    AL1(10,18,12)       5                                            
         DC    AL1(09,18,12)       6                                            
         DC    AL1(08,18,12)       7                                            
         DC    AL1(07,18,11)       8                                            
         DC    AL1(06,18,11)       9                                            
         DC    AL1(05,15,10)       10                                           
         DC    AL1(04,15,10)       11                                           
         DC    AL1(03,15,09)       12                                           
         DC    AL1(02,15,08)       13                                           
         DC    AL1(01,15,08)       14                                           
         DC    AL1(00,12,08)       15                                           
                                                                                
***********************************************************************         
* TABLE OF COLUMN SPACING CONTROLS (# OF WEEKS IS INDEX)              *         
*                                                                     *         
* BYTE 1 - START OF ROW DESC                                          *         
* BYTE 2 - OVER TO TOTAL COLUMN                                       *         
* BYTE 3 - COLUMN SPACING                                             *         
***********************************************************************         
                                                                                
RSLTAB   DS    0XL3                                                             
         DC    AL1(05,30,12)       1 WEEK                                       
         DC    AL1(05,30,12)       2                                            
         DC    AL1(05,30,12)       3                                            
         DC    AL1(05,30,12)       4                                            
         DC    AL1(05,30,12)       5                                            
         DC    AL1(05,30,12)       6                                            
         DC    AL1(08,18,12)       7                                            
         DC    AL1(07,18,11)       8                                            
         DC    AL1(06,18,11)       9                                            
         DC    AL1(05,15,10)       10                                           
         DC    AL1(04,15,10)       11                                           
         DC    AL1(03,15,09)       12                                           
         DC    AL1(02,15,09)       13                                           
         DC    AL1(01,15,08)       14                                           
         DC    AL1(00,12,08)       15                                           
         EJECT                                                                  
***********************************************************************         
* TRANSLATE TABLE FOR REC TYPES - GBTYP.  POSITION OF CODE IS INDEX   *         
* TO WORD IN ROW                                                      *         
***********************************************************************         
                                                                                
SCELLS   DS    0AL1                                                             
         DC    AL1(TGOLDOLQ)                                                    
         DC    AL1(TGOLDEMQ)                                                    
         DC    AL1(TRSCGOLQ)                                                    
         DC    AL1(TACHUNTQ)                                                    
         DC    AL1(TPREUNTQ)                                                    
         DC    AL1(TACHDOLQ)                                                    
         DC    AL1(TPREDOLQ)                                                    
         DC    AL1(TACHDEMQ)                                                    
         DC    AL1(TPREDEMQ)                                                    
         DC    AL1(TACHT01Q)                                                    
         DC    AL1(TPRET01Q)                                                    
         DC    AL1(TACHT02Q)                                                    
         DC    AL1(TPRET02Q)                                                    
         DC    AL1(TACHT03Q)                                                    
         DC    AL1(TPRET03Q)                                                    
         DC    AL1(TACHT04Q)                                                    
         DC    AL1(TPRET04Q)                                                    
         DC    AL1(TACHT05Q)                                                    
         DC    AL1(TPRET05Q)                                                    
         DC    AL1(TACHT06Q)                                                    
         DC    AL1(TPRET06Q)                                                    
         DC    AL1(TACHT07Q)                                                    
         DC    AL1(TPRET07Q)                                                    
         DC    AL1(TACHT08Q)                                                    
         DC    AL1(TPRET08Q)                                                    
         DC    AL1(TACHT09Q)                                                    
         DC    AL1(TPRET09Q)                                                    
         DC    AL1(TACHT10Q)                                                    
         DC    AL1(TPRET10Q)                                                    
         DC    AL1(TACHT11Q)                                                    
         DC    AL1(TPRET11Q)                                                    
         DC    AL1(TACHT12Q)                                                    
         DC    AL1(TPRET12Q)                                                    
         DC    AL1(TACHT13Q)                                                    
         DC    AL1(TPRET13Q)                                                    
         DC    AL1(TACHT14Q)                                                    
         DC    AL1(TPRET14Q)                                                    
         DC    AL1(TACHT15Q)                                                    
         DC    AL1(TPRET15Q)                                                    
         DC    AL1(TACHT16Q)                                                    
         DC    AL1(TPRET16Q)                                                    
         DC    AL1(TACHT17Q)                                                    
         DC    AL1(TPRET17Q)                                                    
         DC    AL1(TACHT18Q)                                                    
         DC    AL1(TPRET18Q)                                                    
         DC    AL1(TACHT19Q)                                                    
         DC    AL1(TPRET19Q)                                                    
         DC    AL1(TACHT20Q)                                                    
         DC    AL1(TPRET20Q)                                                    
         DC    AL1(TACHT21Q)                                                    
         DC    AL1(TPRET21Q)                                                    
SUMCELLX DC    AL1(FF)                                                          
         EJECT                                                                  
TYPTAB   DS    0XL10                                                            
         DC    AL1(TGOLDEMQ),C'Goal-Demo'                                       
         DC    AL1(TGOLDOLQ),C'Goal-$   '                                       
         DC    AL1(TGOLUNTQ),C'Goal-Unts'                                       
         DC    AL1(TPREDEMQ),C'Pre -Demo'                                       
         DC    AL1(TPREDOLQ),C'Pre -$   '                                       
         DC    AL1(TPREUNTQ),C'Pre -Unts'                                       
         DC    AL1(TACHDEMQ),C'Ach -Demo'                                       
         DC    AL1(TACHDOLQ),C'Ach -$   '                                       
         DC    AL1(TACHUNTQ),C'Ach -Unts'                                       
         DC    AL1(TRSCGOLQ),C'Rescale  '                                       
         DC    AL1(TPRET01Q),C'Pre -T1  '                                       
         DC    AL1(TPRET02Q),C'Pre -T2  '                                       
         DC    AL1(TPRET03Q),C'Pre -T3  '                                       
         DC    AL1(TPRET04Q),C'Pre -T4  '                                       
         DC    AL1(TPRET05Q),C'Pre -T5  '                                       
         DC    AL1(TPRET06Q),C'Pre -T6  '                                       
         DC    AL1(TPRET07Q),C'Pre -T7  '                                       
         DC    AL1(TPRET08Q),C'Pre -T8  '                                       
         DC    AL1(TPRET09Q),C'Pre -T9  '                                       
         DC    AL1(TPRET10Q),C'Pre -T10 '                                       
         DC    AL1(TPRET11Q),C'Pre -T11 '                                       
         DC    AL1(TPRET12Q),C'Pre -T12 '                                       
         DC    AL1(TPRET13Q),C'Pre -T13 '                                       
         DC    AL1(TPRET14Q),C'Pre -T14 '                                       
         DC    AL1(TPRET15Q),C'Pre -T15 '                                       
         DC    AL1(TPRET16Q),C'Pre -T16 '                                       
         DC    AL1(TPRET17Q),C'Pre -T17 '                                       
         DC    AL1(TPRET18Q),C'Pre -T18 '                                       
         DC    AL1(TPRET19Q),C'Pre -T19 '                                       
         DC    AL1(TPRET20Q),C'Pre -T20 '                                       
         DC    AL1(TPRET21Q),C'Pre -T21 '                                       
         DC    AL1(TACHT01Q),C'Ach -T1  '                                       
         DC    AL1(TACHT02Q),C'Ach -T2  '                                       
         DC    AL1(TACHT03Q),C'Ach -T3  '                                       
         DC    AL1(TACHT04Q),C'Ach -T4  '                                       
         DC    AL1(TACHT05Q),C'Ach -T5  '                                       
         DC    AL1(TACHT06Q),C'Ach -T6  '                                       
         DC    AL1(TACHT07Q),C'Ach -T7  '                                       
         DC    AL1(TACHT08Q),C'Ach -T8  '                                       
         DC    AL1(TACHT09Q),C'Ach -T9  '                                       
         DC    AL1(TACHT10Q),C'Ach -T10 '                                       
         DC    AL1(TACHT11Q),C'Ach -T11 '                                       
         DC    AL1(TACHT12Q),C'Ach -T12 '                                       
         DC    AL1(TACHT13Q),C'Ach -T13 '                                       
         DC    AL1(TACHT14Q),C'Ach -T14 '                                       
         DC    AL1(TACHT15Q),C'Ach -T15 '                                       
         DC    AL1(TACHT16Q),C'Ach -T16 '                                       
         DC    AL1(TACHT17Q),C'Ach -T17 '                                       
         DC    AL1(TACHT18Q),C'Ach -T18 '                                       
         DC    AL1(TACHT19Q),C'Ach -T19 '                                       
         DC    AL1(TACHT20Q),C'Ach -T20 '                                       
         DC    AL1(TACHT21Q),C'Ach -T21 '                                       
TYPTABX  DC    AL1(FF),C'*Unknown '                                             
                                                                                
         DC    C'*TRTTAB*'                                                      
PRDTRT   DS    XL256               PRODUCT DISPLACEMENT TRANS TAB               
CLSTRT   DS    XL256               PRODUCT CLASS DISPLACEMENT TRANS TAB         
PALLST   DS    XL256               PRODUCT SEQ TRANSLATION TABLE                
PCLLST   DS    XL256               PRODUCT CLASS TRANS TAB                      
                                                                                
         DC    C'*PIGLST*'                                                      
PIGLSTN  EQU   100                                                              
PIGLST   DS    (PIGLSTN)XL4                                                     
PIGLSTX  DC    X'00'                                                            
PIGLSTL  EQU   *-PIGLST                                                         
                                                                                
IPRDTRT  DS    XL256                                                            
                                                                                
SVPTBUFF DS    XL(PTXBUFFL)        SAVED PRODUCT BUFFER ENTRY                   
                                                                                
DGRMAX   EQU   16                                                               
DGRDOL   DS    XL(DGRMAX*4)        TOTALS FOR 16 DAYPART GROUPS - COST          
DGRDEM   DS    XL(DGRMAX*4)                                     - DEMOS         
                                                                                
INTTAB   DS    0CL60                                                            
         DC    CL30'Brand time interval...........'                             
         DC    CL30'Brand percent leeway..........'                             
         DC    CL30'Class time interval...........'                             
         DC    CL30'Class percent leeway..........'                             
INTTABN  EQU   (*-INTTAB)/L'INTTAB                                              
                                                                                
OBJTAB   DS    0CL30                                                            
         DC    CL30'Brand goal fulfillment........'                             
         DC    CL30'CPM/CPP equalization..........'                             
         DC    CL30'Sched. balance - Program......'                             
         DC    CL30'Sched. balance - Station/Net..'                             
         DC    CL30'Sched. balance - Day of Week..'                             
         DC    CL30'Target 1 maximization.........'                             
         DC    CL30'Target 2 maximization.........'                             
OBJTABX  DC    AL1(FF)                                                          
                                                                                
PRTHD1   DC    C'-Env- -Prd-'                                                   
PRTHD2   DC    C'SQ CD SQ CD   Total '                                          
PRTHD3   DC    C'-- -- -- --  -------'                                          
                                                                                
DETHD1   DC    C'Station/ Day/'                                                 
DETHD2   DC    C'Est-Lin  Time       Date   Brand         Unit cost'            
DETHD3   DC    C'-------  ----       ----   -----         ---------'            
                                                                                
RECHD1   DC    C'   Goal    Pct   Achieved   Pct   Indx'                        
RECHD2   DC    C'  ------   ---   --------   ---   ----'                        
                                                                                
D2RHD1   DC    C'Station  Date  Day      Time        Program          E*        
               st     Brand  Len  Unit Cost'                                    
D2RHD2   DC    C'-------  ----  ---      ----        -------          -*        
               --     -----  ---  ---------'                                    
PARHD1   DS    0CL132                                                           
         DC    CL40'** Active brand list **                 '                   
         DC    CL40'                                        '                   
         DC    CL40'                                        '                   
         DC    CL12'            '                                               
         DC    CL40'                           Pri-         '                   
         DC    CL40'   Goaled    Target    Target         --'                   
         DC    CL40'--------------E X C L U S I O N S-------'                   
         DC    CL12'------------'                                               
         DC    CL40'Brand                     ority class   '                   
         DC    CL40'    Demo      Demo1     Demo2         Es'                   
         DC    CL40't  Station     Program               Eff'                   
         DC    CL12'ective dates'                                               
         DC    CL40'-----                     ----- -----   '                   
         DC    CL40'   -------  --------  --------        --'                   
         DC    CL40'-  -------  -------------            ---'                   
         DC    CL12'------------'                                               
PARHDN   EQU   (*-PARHD1)/L'PARHD1                                              
                                                                                
SPTHD1   DC    CL132'Dpt  Statn Est Lin Seq Stat PDL      UNL Alloc    *        
                    WK  E1  E2  E3 Disk adr DY  Date No    Cost    Base*        
                  Targ1   Targ2   Targ3'                                        
SPTHD2   DC    CL132'---  ----- --- --- --- ---- ---      --- -----    *        
                    --  --  --  -- -------- --  ---- --    ----    ----*        
                  -----   -----   -----'                                        
                                                                                
VARHDS   DS    0CL24                                                            
         DC    CL24'   Goal    Fill    -----'                                   
         DC    CL24'   CPP/M   Divrg   -----'                                   
         DC    CL24'            Env1   -----'                                   
         DC    CL24'            Env2   -----'                                   
         DC    CL24'            Env3   -----'                                   
         DC    CL24'    Targ      1    -----'                                   
         DC    CL24'    Targ      2    -----'                                   
         DC    CL24' Pgm/Prd  Index    -----'                                   
VARHSUM  DC    CL24'    Wgtd    Sum  -------'                                   
                                                                                
VARHD1   DC    CL132'              **Daypart**    Ach      Acg   **Week*        
               **    Ach      Ach      Ach    Re-       Roll      New'          
VARHD2   DC    CL132'Prd C  Ln          Goal     Demo       $      Goal*        
                    Demo       $     Units  mainder      up      Goal  *        
                  CPP/M   Targ 1   Targ 2'                                      
VARHD3   DC    CL132'--- -  --          ----     ----     ----     ----*        
                    ----     ----    -----  -------     ----     ----  *        
                  -----   ------   ------'                                      
                                                                                
PGMHD1   DC    CL132'        Prog                  Total'                       
PGMHD2   DC    CL132'Station type Program          units'                       
PGMHD3   DC    CL132'------- ---- -------          -----'                       
                                                                                
CHDHD1   DC    C'--- Goal ----     ------ N T P1 ------    ------ P1 A *        
               Y ------    --- Total Time ----'                                 
CHDHD2   DC    C'Dollars  Pcnt     Dollars  Pcnt  Indx     Dollars  Pcn*        
               t  Indx     Dollars  Pcnt  Indx'                                 
CHDHD3   DC    C'-------  ----     -------  ----  ----     -------  ---*        
               -  ----     -------  ----  ----'                                 
                                                                                
TRTTAB   DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     00-0F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     10-1F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     20-2F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     30-3F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     40-4F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B5B5C5D4B4B'     50-5F                    
         DC    X'60614B4B4B4B4B4B4B4B4B6B6C6D4B6F'     60-6F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B7B4B7D7E4B'     70-7F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     80-8F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     90-9F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     A0-AF                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     B0-BF                    
         DC    X'4BC1C2C3C4C5C6C7C8C94B4B4B4B4B4B'     C0-CF                    
         DC    X'4BD1D2D3D4D5D6D7D8D94B4B4B4B4B4B'     D0-DF                    
         DC    X'4B4BE2E3E4E5E6E7E8E94B4B4B4B4B4B'     E0-EF                    
         DC    X'F0F1F2F3F4F5F6F7F8F94B4B4B4B4B4B'     F0-FF                    
                                                                                
ENV1SET  DS    0F                  ** VALUE SET FOR ENV 1 **                    
         DC    C'*EN1SET*'                                                      
         DC    A(ENV1TAB,ENV1TOT,ENVS1MAX,ENVS1MAX*((MAXWEEKS+1)*2))            
         ORG   ENV1SET+ENVSETCL                                                 
                                                                                
ENV1TRT  DS    XL(L'ENVS1TRT)                                                   
         DC    X'0000'                                                          
                                                                                
         DS    0F                                                               
         DC    C'*EN1TAB*'                                                      
ENV1TAB  DS    (ENVS1MAX)XL(ENVS1LEN)                                           
         DC    X'0000'                                                          
                                                                                
         DS    0F                                                               
         DC    C'*EN1TOT*'                                                      
ENV1TOT  DS    (ENVS1MAX)XL((MAXWEEKS+1)*2)                                     
         DC    X'0000'                                                          
                                                                                
ENV2SET  DS    0F                  ** VALUE SET FOR ENV 2 **                    
         DC    C'*EN2SET*'                                                      
         DC    A(ENV2TAB,ENV2TOT,ENVS2MAX,ENVS2MAX*((MAXWEEKS+1)*2))            
         ORG   ENV2SET+ENVSETCL                                                 
                                                                                
ENV2TRT  DS    XL(L'ENVS2TRT)                                                   
         DC    X'0000'                                                          
                                                                                
         DS    0F                                                               
         DC    C'*EN2TAB*'                                                      
ENV2TAB  DS    XL(L'ENVS2TAB)                                                   
         DC    X'0000'                                                          
                                                                                
         DS    0F                                                               
         DC    C'*EN2TOT*'                                                      
ENV2TOT  DS    XL(L'ENVS2TOT)                                                   
         DC    X'0000'                                                          
                                                                                
ENV3SET  DS    0F                  ** VALUE SET FOR ENV 3 **                    
         DC    C'*EN3SET*'                                                      
         DC    A(ENV3TAB,ENV3TOT,ENVS3MAX,ENVS3MAX*((MAXWEEKS+1)*2))            
         ORG   ENV3SET+ENVSETCL                                                 
                                                                                
ENV3TRT  DS    XL(L'ENVS3TRT)                                                   
         DC    X'0000'                                                          
                                                                                
         DS    0F                                                               
         DC    C'*EN3TAB*'                                                      
ENV3TAB  DS    XL(L'ENVS3TAB)                                                   
         DC    X'0000'                                                          
                                                                                
         DS    0F                                                               
         DC    C'*EN3TOT*'                                                      
ENV3TOT  DS    XL(L'ENVS3TOT)                                                   
         DC    X'0000'                                                          
                                                                                
NETLIST  DS    XL256                                                            
         DC    X'0000'                                                          
                                                                                
WEEKLST  DS    XL512                                                            
         DC    X'0000'                                                          
                                                                                
PXCRCRD  DS    XL(MAXRECL)         EXCLUSION RECORD BUFFER                      
                                                                                
XCTABC   DS    0F                                                               
         DS    XL(XCTTABL*XCTTMAX)                                              
                                                                                
SBUYREC  DS    XL(MAXRECL)         SAVE BUY RECORD BUFFER                       
                                                                                
PRDTAB   DS    (PRDTMAXN)XL(PRDTABL),X                                          
                                                                                
PRDTABD  DSECT                     ** PRODUCT ALLOCATION TABLE **               
PRDTSEQN DS    XL1                 SEQUENCE NUMBER                              
PRDTDATE DS    XL(L'RDATE)         DATE                                         
PRDTALC1 DS    XL(L'RPALLOC)       PRODUCT 1 ALLOCATION                         
PRDTALC2 DS    XL(L'RPALLOC2)      PRODUCT 2 ALLOCATION                         
PRDTABL  EQU   *-PRDTABD                                                        
PRDTMAXN EQU   200                                                              
         EJECT                                                                  
         PRINT OFF                                                              
       ++INCLUDE SPGENAGY                                                       
       ++INCLUDE SPGENCLT                                                       
       ++INCLUDE SPGENPXC                                                       
       ++INCLUDE SPGENPRD                                                       
         ORG   PKEYPRD+L'PKEYPRD                                                
PKEYREST DS    XL(L'PKEY-(*-PKEY))                                              
         ORG                                                                    
       ++INCLUDE SPGENEST                                                       
         ORG   EKEYEST+L'EKEYEST                                                
EKEYREST DS    XL(L'EKEY-(*-EKEY))                                              
         ORG                                                                    
       ++INCLUDE SPGENGOAL                                                      
       ++INCLUDE SPGENBUY                                                       
       ++INCLUDE SPREPMODES                                                     
       ++INCLUDE SPMEDBLOCK                                                     
       ++INCLUDE DDBUFFD                                                        
       ++INCLUDE DEDBLOCK                                                       
       ++INCLUDE CTGENFILE                                                      
       ++INCLUDE DDMASTD                                                        
       ++INCLUDE DDCOREQUS                                                      
       ++INCLUDE FALOCKETD                                                      
                                                                                
LKKEYD   DSECT                     ** LOCKET KEY LAYOUT **                      
LKBARTYQ EQU   C'BA'               BRAND ALLOCATION LOCK                        
         ORG   LOCKKEY                                                          
LKBAMED  DS    CL1                 MEDIA CODE (C=COMBINED CANADIAN)             
LKBACLT  DS    CL3                 CLIENT CODE                                  
LKBAEST  DS    CL3                 ESTIMATE NUMBER (SPACES=ALL)                 
                                                                                
SSBD     DSECT                                                                  
       ++INCLUDE FASSBOFF                                                       
         PRINT ON                                                               
                                                                                
***********************************************************************         
* GLOBAL EQUATES                                                      *         
***********************************************************************         
                                                                                
QPROGKL  EQU   C'KL',2                                                          
QPROGK4  EQU   C'K4',2                                                          
                                                                                
NENVS    EQU   3                   NUMBER OF ENVIRONMENTS                       
                                                                                
MINHOUR  EQU   60                  # MINUTES IN AN HOUR                         
SECSMIN  EQU   60                  # SECONDS IN A MINUTE                        
HOURDAY  EQU   24                  # OF HOURS IN A DAY                          
DAYWEEK  EQU   7                   # OF DAYS IN A WEEK                          
                                                                                
SECS15   EQU   15                  15 SECONDS                                   
SECS30   EQU   30                  30 SECONDS                                   
                                                                                
YESQ     EQU   C'Y'                                                             
NOQ      EQU   C'N'                                                             
SPACE    EQU   C' '                                                             
SLASH    EQU   C'/'                                                             
EQUAL    EQU   C'='                                                             
OPAREN   EQU   C'('                                                             
CPAREN   EQU   C')'                                                             
ASTERISK EQU   C'*'                                                             
RATINGQ  EQU   C'R'                                                             
EXDRTGQ  EQU   C'E'                                                             
DASH     EQU   C'-'                                                             
COMMA    EQU   C','                                                             
FF       EQU   X'FF'               ALL THE BITS                                 
                                                                                
EOFQ     EQU   X'80'               END OF FILE                                  
NTFQ     EQU   X'10'               NOT FOUND                                    
ZONE     EQU   X'F0'               HIGH ORDER NIBBLE                            
DIGIT    EQU   X'0F'               LOW ORDER NIBBLE                             
                                                                                
VNOPQ    EQU   X'80'               VARIABLE NO-OPED                             
TOFFQ    EQU   X'40'               TARGET VARIABLE NO-OPED                      
ATOIBITS EQU   X'C0'               CONVERT TO ALPHA (A-I FOR CLASSES)           
UNAPRD1  EQU   219                 UNALLOCATED PRODUCT                          
UNAPRD2  EQU   254                 UNALLOCATED PRODUCT                          
UGPIGPRD EQU   218                                                              
SUPPRD   EQU   X'00'               SUPPLY LINE                                  
TOTPRD   EQU   255                 TOTALS LINE                                  
                                                                                
OLDNTO   EQU   FF-BDCMINSQ         BDSTAT MASK FOR OLD NTO TEST                 
TWOPTCLS EQU   X'99'               2-PART CLASS                                 
NETMEDQ  EQU   3                   NETWORK MEDIA NUMBER                         
NETLETQ  EQU   C'N'                NETWORK MEDIA LETTER                         
COMLETQ  EQU   C'C'                COMBINED MEDIA LETTER                        
CANLETQ  EQU   C'C'                CANADIAN COUNTRY CODE                        
                                                                                
USERDEMO EQU   X'21'               USER DEMO NUMBER                             
RCPOLFQ  EQU   X'0D'                                                            
                                                                                
MAXWEEKS EQU   26                  MAXIMUM N'WEEKS IN A RUN                     
MAXWKPP  EQU   15                  MAXIMUM N'WEEKS ON A PAGE                    
MAXWKPP2 EQU   12                  MAXIMUM N'WEEKS ON A PAGE                    
                                                                                
MAXPRDN  EQU   256                 MAXIMUM PRODUCTS                             
MAXPRDM  EQU   200                 MAXIMUM PRODUCTS IN MARKET                   
MAXTARGS EQU   21                  MAXIMUM N'TARGET DEMOS                       
MAXIPGMS EQU   255                 MAXIMUM INDEXED PROGRAMS                     
MAXIPRDS EQU   224                 MAXIMUM INDEXED PRODUCTS                     
MAXRECL  EQU   6*1024              MAXIMUM RECORD LENGTH (6K)                   
                                                                                
NTGVARS  EQU   2                   2 TARGETS PER BRAND                          
                                                                                
BRPPPG   EQU   14                  PRODUCTS PER PAGE                            
INDPPG   EQU   22                  PRODUCTS PER PAGE                            
RCPPPG   EQU   22                  PRODUCTS PER PAGE                            
                                                                                
RLOOPMAX EQU   15                  MAXIMUM N'WKYBAL ITERATIONS                  
         EJECT                                                                  
***********************************************************************         
* WORK DSECT FOR SPK402 - NEW BRAND ALLOCATION                        *         
***********************************************************************         
                                                                                
WORKD    DSECT                                                                  
                                                                                
AHEDBLD  DS    A                   A(HEDBLD)                                    
ASPHOOK  DS    A                   A(SPHOOK)                                    
                                                                                
ABUFF1   DS    A                   A(BUFF1)                                     
ABUFF2   DS    A                   A(BUFF2)                                     
VPRDBLD  DS    V                   V(PRDBLD)                                    
VSCANNER DS    V                   V(SCANNER)                                   
VMEDPIGL DS    V                   V(MEDPIGL)                                   
BUFFERIN DS    V                   V(BUFFERIN)                                  
VCOVAIL  DS    A                   V(COVAIL)                                    
VLOCKET  DS    A                   V(LOCKET)                                    
                                                                                
APRDTRT  DS    A                   A(PRDTRT)                                    
ACLSTRT  DS    A                   A(CLSTRT)                                    
APALLST  DS    A                   A(PALLST)                                    
APCLLST  DS    A                   A(PCLLST)                                    
ASCELLS  DS    A                   A(SCELLS)                                    
ARSLTAB  DS    A                   A(RSLTAB)                                    
ASRLTAB  DS    A                   A(SRLTAB)                                    
APRTHD1  DS    A                   A(PRTHD1)                                    
ACHDHD1  DS    A                   A(CHDHD1)                                    
ATRTTAB  DS    A                   A(TRTTAB)                                    
APGMHD1  DS    A                   A(PGMHD1)                                    
APGMHD2  DS    A                   A(PGMHD2)                                    
AIPRDTRT DS    A                   A(IPRDTRT)                                   
AVARHDS  DS    A                   A(VARHDS)                                    
AVARHSUM DS    A                   A(VARHSUM)                                   
AVARHD1  DS    A                   A(VARHD1)                                    
ASPTHD1  DS    A                   A(SPTHD1)                                    
ATYPTAB  DS    A                   A(TYPTAB)                                    
ADGTDOL  DS    A                   A(DGRDOL)                                    
ADGTDEM  DS    A                   A(DGRDEM)                                    
AINTTAB  DS    A                   A(INTTAB)                                    
AOBJTAB  DS    A                   A(OBJTAB)                                    
ARECHD1  DS    A                   A(RHLB1)                                     
ADETHD1  DS    A                   A(DRHD1)                                     
AD2RHD1  DS    A                   A(D2RHD1)                                    
APIGLST  DS    A                   A(PIGLST)                                    
ASVPTBF  DS    A                   A(SVPTBUFF)                                  
APARHD1  DS    A                   A(PARHD1)                                    
APXCREC  DS    A                   A(PXCRCRD)                                   
AXCTAB   DS    A                   A(XCTABC)                                    
AENV1SET DS    A                   A(ENV1SET)                                   
AENV2SET DS    A                   A(ENV2SET)                                   
AENV3SET DS    A                   A(ENV3SET)                                   
ANETLIST DS    A                   A(NETLIST)                                   
AWEEKLST DS    A                   A(WEEKLST)                                   
ASBUYREC DS    A                   A(SBUYREC)                                   
APRDTAB  DS    A                   A(PRDTAB)                                    
                                                                                
QPROGKLL DS    CL(L'QPROG)         C'KL'                                        
QPROGK4L DS    CL(L'QPROG)         C'K4'                                        
                                                                                
BU1PUTL  DS    CL7                 'BU1PUT='                                    
BU1RDHL  DS    CL7                 'BU1HIG='                                    
BU1RSQL  DS    CL7                 'BU1SEQ='                                    
BU2PUTL  DS    CL7                 'BU2PUT='                                    
BU2RDHL  DS    CL7                 'BU2HIG='                                    
BU2RSQL  DS    CL7                 'BU2SEQ='                                    
                                                                                
BUFSET   DS    CL3                 C'SET'                                       
BUFRST   DS    CL3                 C'RES'                                       
BUFPUT   DS    CL3                 C'PUT'                                       
BUFGET   DS    CL3                 C'GET'                                       
BUFRSQ   DS    CL3                 C'SEQ'                                       
BUFRDH   DS    CL4                 C'HIGH'                                      
                                                                                
STATIONL DS    CL7                 C'Station'                                   
UNITSL   DS    CL5                 C'Units'                                     
TOTALL   DS    CL5                 C'Total'                                     
SPOTSL   DS    CL5                 C'Spots'                                     
CLASSEQL DS    CL6                 C'Class='                                    
WEEKL    DS    CL4                 C'Week'                                      
NOL      DS    CL1                 C'N'                                         
                                                                                
RQBYPSSL DS    CL20                C'**Request bypassed**'                      
NSPTFRWK DS    CL26                C'**No spots for this week**'                
AVALFRWK DS    CL25                C'Average values for week ='                 
TOTALSL  DS    CL12                C'** Totals **'                              
TRUNFNML DS    CL28                C'**Test run-file not marked**'              
                                                                                
ALL3     DS    0CL3                C'ALL'                                       
ALL      DS    CL5                 C'ALL  '                                     
DASHES   DS    CL30                C'--...--'                                   
         DS    0D                                                               
FFS      DS    XL10                X'FF...FF'                                   
ZONES    DS    CL6                 C'000000'                                    
ALLDS    DS    XL2                 AL1(ALLDPT,ALLSLN)                           
ALLDPT   EQU   X'F9'               CONVENTION FOR ALL DPTS                      
ALLSLN   EQU   X'7F'               CONVENTION FOR ALL SLNS                      
                                                                                
         DS    0F                                                               
MAXNEG   DS    XL4                 X'80000000'                                  
MAXPOS   DS    XL4                 X'7FFFFFFF'                                  
FW1      DS    F                   F'1'                                         
FW10     DS    F                   F'10'                                        
FW50     DS    F                   F'50'                                        
FW99     DS    F                   F'99'                                        
FW100    DS    F                   F'100'                                       
FW150    DS    F                   F'150'                                       
FW1000   DS    F                   F'1000'                                      
FW5000   DS    F                   F'5000'                                      
FW10000  DS    F                   F'10000'                                     
FW100000 DS    F                   F'100000'                                    
HW1      DS    H                   H'1'                                         
HW10     DS    H                   H'10'                                        
HW20     DS    H                   H'20'                                        
HW100    DS    H                   H'100'                                       
HW1000   DS    H                   H'1000'                                      
HW5000   DS    H                   H'5000'                                      
HW10000  DS    H                   H'10000'                                     
HWHIVAL  DS    H                   X'7FFF'                                      
HWENV1LN DS    H                   Y(ENVS1LEN)                                  
HIGHVALS DS    CL8                 C'**HIGH**'                                  
MAXBVAL  DS    D                   D'2147483647'                                
                                                                                
LITERALL EQU   *-WORKD             LENGTH OF LITERAL AREA                       
                                                                                
DIVDUB   DS    D                                                                
                                                                                
DEMOVALS DS    0A                  ** DEMO DISPS/LENGTHS **                     
DEMOVDD  DS    A                   DISP. TO DEMO VALUES IN PTBUFFD              
DEMOVDL  DS    F                   LENGTH OF DEMO VALUES                        
DEMOVWD  DS    A                   DISP. TO DEMO WEIGHTS IN PTBUFFD             
DEMOVWL  DS    F                   LENGTH OF DEMO WEIGHTS                       
                                                                                
ABRDTAB  DS    A                   A(BRAND TABLE)                               
BRDTABL  DS    F                   L'BRAND TABLE                                
                                                                                
ASPTTAB  DS    A                   A(SPOT TABLE)                                
SPTTABL  DS    F                   L'SPOT TABLE                                 
SPTTABN  DS    F                   N'ENTRIES IN SPTTAB                          
                                                                                
SAVER1   DS    A                   SAVE AREA FOR R1                             
SAVERE   DS    A                   SAVE AREA FOR RE                             
                                                                                
HEXP     DS    6F                  HEXOUT PARAMETER LIST                        
                                                                                
XCTPARS  DS    0F                  ** XCTAB BINSRCH PARAMETERS **               
XCTAREC  DS    A                   A(RECORD)                                    
XCTATAB  DS    A                   A(TABLE)                                     
XCTNREC  DS    F                   N'RECORDS                                    
XCTLREC  DS    F                   L'RECORD                                     
XCTDSPC  DS    0XL1                DISPLACEMENT OF KEY                          
XCTLKEY  DS    F                   L'KEY                                        
XCTMREC  DS    F                   MAXIMUM N'RECORDS                            
                                                                                
BINPARS  DS    0F                  ** GENERAL BINSRCH PARAMETERS **             
BINAREC  DS    A                   A(RECORD)                                    
BINATAB  DS    A                   A(TABLE)                                     
BINNREC  DS    F                   N'RECORDS                                    
BINLREC  DS    F                   L'RECORD                                     
BINDSPC  DS    0XL1                DISPLACEMENT OF KEY                          
BINLKEY  DS    F                   L'KEY                                        
BINMREC  DS    F                   MAXIMUM N'RECORDS                            
                                                                                
THISPRD  DS    A                   A(CURRENT PRODUCT BUFFER ENTRY)              
THISSPT  DS    A                   A(CURRENT SPTTAB ENTRY)                      
CURPRD   DS    A                                                                
BESTPRD  DS    A                                                                
HIPRD    DS    A                                                                
BESTSPT  DS    A                                                                
SPOTA    DS    A                                                                
SPOTB    DS    A                                                                
SLOTA    DS    A                                                                
SLOTB    DS    A                                                                
ASLOT    DS    A                   A(CURRENT SPOT SLOT)                         
                                                                                
ASUPROW  DS    A                   A(SUPPLY ROW)                                
ATOTROW  DS    A                   A(TOTAL ROW)                                 
AEXCROW  DS    A                   A(EXCESS ROW)                                
                                                                                
AFSTBRD  DS    A                   A(ROW FOR FIRST PRODUCT)                     
ABRDSRT  DS    A                   A(AREA FOR BRAND SORT)                       
APOLPRD  DS    A                   A(POL PRODUCT) PRODUCT BUFFER ENTRY          
                                                                                
NETLOOP  DS    A                   A(CURRENT ENTRY IN NETLIST)                  
                                                                                
CURVAL   DS    F                   CURRENT WEIGHTED BRAND VALUE                 
NEWVAL   DS    F                   NEW WEIGHTED BRAND VALUE                     
BESTVAL  DS    F                   BEST WEIGHTED (SPOT OR BRAND) VALUE          
BRDVAL   DS    F                   WEIGHTED BRAND VALUE                         
SPTVAL   DS    F                   WEIGHTED SPOT VALUE                          
HLDVAR   DS    F                   VARIABLE HOLD AREA                           
                                                                                
FACTOR1  DS    F                                                                
FACTOR2  DS    F                                                                
                                                                                
WKCPD    DS    F                   WEEK'S AVERAGE CPP/CPM                       
WSECS    DS    F                   TOTAL SECONDS LENGTH TO BE ALLOCATED         
                                                                                
AWKVALS  DS    0F                  ** WEEKLY ALLOCATION VALUES **               
AWKNZCST DS    F                                                                
AWKNZBAS DS    F                                                                
AWKNZCSP DS    F                                                                
AWKNZDSP DS    F                                                                
AWKNZCPD DS    F                                                                
AWKRSPTS DS    F                                                                
AWKZSPTS DS    F                                                                
AWKRSECS DS    F                                                                
AWKZSECS DS    F                                                                
AWKTGAVG DS    F                   AVERAGE OF AVERAGES                          
AWKLOTRG DS    (MAXTARGS+1)F                                                    
AWKAVGS  DS    (MAXTARGS+1)F                                                    
AWKAVGSL EQU   *-AWKAVGS                                                        
AWKVALSL EQU   *-AWKVALS                                                        
                                                                                
WAVCOST  DS    F                   AVERAGE COST FOR N-Z SPOTS                   
WAVBASD  DS    F                   AVERAGE BASE RATING FOR N-Z SPOTS            
WAVGOAL  DS    F                   AVERAGE GOAL FOR WEEK                        
COSTSHR  DS    F                   COST SHARE                                   
CPPROUND DS    F                   CPP ROUNDING FACTOR                          
CPMROUND DS    F                   CPM ROUNDING FACTOR                          
                                                                                
ENVPCNT  DS    F                   COUNT OF PRODUCTS                            
ENVCCNT  DS    F                   COUNT OF CLASSES                             
ENVTCNT  DS    F                   PRODUCTS + CLASSES                           
                                                                                
VARWGTS  DS    0F                  ** WEIGHTS **                                
FILVAR   DS    F                   GOAL FULFILLMENT                             
CPMVAR   DS    F                   CPP/M DIVERGENCE                             
ENV1VAR  DS    F                   ENV1  DISPERSION                             
ENV2VAR  DS    F                   ENV2  DISPERSION                             
ENV3VAR  DS    F                   ENV3  DISPERSION                             
ENVNVAR  EQU   (*-ENV1VAR)/L'ENV1VAR                                            
TG1VAR   DS    F                   FIRST TARGET                                 
TG2VAR   DS    F                   SECOND TARGET                                
INDVAR   DS    F                   PROGRAM/PRODUCT INDEX                        
VARWGTSN EQU   (*-VARWGTS)/L'VARWGTS                                            
VARWGTSL EQU   *-VARWGTS                                                        
                                                                                
VARCTLD  EQU   *-VARWGTS                                                        
VARCTLS  DS    (VARWGTSN)F                                                      
                                                                                
VARVALD  EQU   *-VARWGTS                                                        
VARVALS  DS    (VARWGTSN)F                                                      
                                                                                
HLDDEM   DS    (PTDEMMAX)F                                                      
HLDDEML  EQU   *-HLDDEM                                                         
                                                                                
SWAPN    EQU   VARWGTSN+1                                                       
SWAPS    DS    0X                  HOLD AREAS FOR SWAP VARIABLES                
SWAPAA   DS    (SWAPN)F                                                         
SWAPL    EQU   *-SWAPS                                                          
SWAPBB   DS    (SWAPN)F                                                         
SWAPAB   DS    (SWAPN)F                                                         
SWAPBA   DS    (SWAPN)F                                                         
SWAPSN   EQU   (*-SWAPS)/SWAPL                                                  
                                                                                
OBJWGTS  DS    (VARWGTSN)X         OBJECTIVE WEIGHTS (1 PER VARIABLE)           
OBJWGTSL EQU   *-OBJWGTS                                                        
                                                                                
TOTDISP  DS    F                   DIPLACEMENT TO TOTAL                         
AWKTPRDS DS    H                   TRUE ACTIVE BRAND COUNT                      
AWKAPRDS DS    H                   NUMBER OF ACTIVE BRANDS                      
NTARGETS DS    H                   NUMBER OF TARGETS                            
ENVPRDD  DS    H                   ENV TAB PROD DISP                            
ENVENVD  DS    H                   ENV TAB ENV CODE DISP                        
CURDISP  DS    H                   DISPLACEMENT TO CURRENT VALUES               
DPTBALWK DS    H                   DPTBAL S/R WEEK DISPLACEMENT                 
SAVNWKS  DS    H                   SAVED NWKS                                   
NWKS     DS    H                   NUMBER OF WEEKS                              
NWKSP1   DS    H                   NUMBER OF WEEKS+1 (WITH TOTAL)               
NPRDS    DS    H                   NUMBER OF PRODUCTS                           
CELLWID  DS    H                   CELL WIDTH (4 BYTES PER ITEM)                
WEEKWID  DS    H                   SPACE BETWEEN WEEK COLUMNS                   
ROWDISP  DS    H                   DISPLACEMENT TO ROW DESCRIPTION              
AMTDISP  DS    H                   DISPLACEMENT TO TOTAL                        
LROW     DS    H                   LENGTH OF ROW                                
RPTNWKS  DS    H                   NUMBER OF REPORT WEEKS                       
WKDISP   DS    H                   DISPLACEMENT TO CURRENT WEEK                 
SPTSEQ   DS    H                   SPOT SEQUENCE NUMBER                         
                                                                                
LOCKKEYW DS    CL(L'LOCKEY)        LOCKET KEY FOR UPDATIVE SOON RUN             
                                                                                
CSTART   DS    XL2                 COMPRESSED START DATE                        
CEND     DS    XL2                 COMPRESSED END DATE                          
SBUYKEY  DS    XL(L'BUYKEY)        SAVED BUY KEY (UPDNET S/R)                   
                                                                                
RUNFLAG  DS    X                   ** RUN FLAG **                               
RUNFSOON EQU   X'80'               RUNNING SOON REQUEST                         
RUNFLOCK EQU   X'40'               ISSUE UNLOCK AT REQLAST                      
                                                                                
REQFLAG1 DS    X                   ** REQUEST FLAGS 1 **                        
REQFQUIT EQU   X'80'               FORCED END OF REQUEST                        
REQFESTE EQU   X'40'               ESTIMATE CHECKING ERROR                      
REQFMIXG EQU   X'10'               MIXED GOALS                                  
REQFMIXB EQU   X'08'               MIXED BASIS                                  
REQFCHDR EQU   X'04'               PRINT CHILD SPOT REPORT                      
REQFTRGS EQU   X'02'               TARGETS PRESENT                              
                                                                                
REQFLAG2 DS    X                   ** REQUEST FLAGS 2 **                        
REQFSSLN EQU   X'80'               SEPARATE SPOT LENGTHS                        
REQFSDPT EQU   X'40'               SEPARATE DAYPARTS                            
REQFOSTA EQU   X'20'               OTHER STATION OPTION                         
                                                                                
NETSTAV  DS    0X                  CANADIAN NETWORK STATION VALUES              
NETSNET  DS    CL4                 NETWORK STATION CODE                         
NETSSTA  DS    XL3                 NETWORK STATION NUMBER                       
NETSTAVL EQU   *-NETSTAV                                                        
                                                                                
ENVNO    DS    X                   ** CURRENT ENVIRONMENT NUMBER **             
ENVNPGMQ EQU   1                   PROGRAM ENVIRONMENT                          
ENVNSTAQ EQU   2                   STATION/NETWORK ENVIRONMENT                  
ENVNDOWQ EQU   3                   DAY-OF-WEEK ENVIRONMENT                      
                                                                                
PSMODE   DS    X                   ** PRTSPT S/R SWITCH **                      
PSMSPTQ  EQU   C'T'                SPOT TABLE                                   
PSMSINQ  EQU   C'S'                SINGLE BUY                                   
                                                                                
PEMODE   DS    X                   ** PRTENV S/R FLAG **                        
PEMPREQ  EQU   X'80'               PRE-ALLOCATION                               
PEMPSTQ  EQU   X'40'               POST-ALLOCATION                              
                                                                                
PBMODE   DS    X                   ** PRTBUF S/R SWITCH **                      
PBMLSTQ  EQU   C'L'                LAST TIME                                    
PBMDPTQ  EQU   C'D'                OVERALL DAYPART BALANCING                    
PBMDRUQ  EQU   C'S'                DAYPART ROLLUP                               
                                                                                
PVMODE1  DS    X                   PRTVAR S/R SWITCH 1                          
                                                                                
PVMODE2  DS    X                   ** PRTVAR S/R SWITCH 2 **                    
PVMODE1Q EQU   C'1'                                                             
PVMODE2Q EQU   C'2'                                                             
                                                                                
NPRDPRNT DS    X                   PGMRCP S/R N'PRODUCTS TO PRINT               
NPRDSKIP DS    X                   PGMRCP S/R N'PRODUCTS TO SKIP                
                                                                                
WEEKNO   DS    X                   ALLOCATION WEEK NUMBER                       
DAILYSW  DS    C                   SAVED EDAILY VALUE                           
                                                                                
ALPHASE  DS    C                   ** ALLOCATION PHASE **                       
ALPSPTQ  EQU   C'S'                SPOT PHASE                                   
ALPBRDQ  EQU   C'B'                BRAND PHASE                                  
ALPXCHQ  EQU   C'X'                EXCHANGE PHASE                               
ALPS30Q  EQU   C'3'                30'S PHASE                                   
                                                                                
ZSPASS   DS    C                   ** ZERO SPOTS PASS FALG **                   
ZSPYESQ  EQU   C'Y'                ZERO SPOTS ONLY                              
ZSPNOQ   EQU   C'N'                NON-ZERO SPOTS ONLY                          
ZSPTOGQ  EQU   C'X'                ZERO & NON-ZERO TOGETHER                     
                                                                                
ZEROA    DS    C                   VALUES CAN BE YESQ/NOQ                       
ZEROB    DS    C                   VALUES CAN BE YESQ/NOQ                       
                                                                                
LPRDSLN  DS    0XL2                LAST PRODUCT/LENGTH (SEE MKTL)               
LPRD     DS    X                   LAST PRODUCT NUMBER                          
LSLN     DS    X                   LAST SPOT LENGTH                             
                                                                                
CLASS1   DS    C                   PRODUCT 1 CLASS                              
CLASS2   DS    C                   PRODUCT 2 CLASS                              
                                                                                
HPRD     DS    CL3                 HOLD AREA FOR PRODUCT CODE                   
                                                                                
SAVKEY   DS    XL(L'BUYKEY)        SAVED KEY                                    
SAVMKTN  DS    XL(L'BUYKMKTN)      SAVED MARKET NUMBER                          
                                                                                
CELLD    DS    X                   CURRENT CELL DISPLACEMENT                    
                                                                                
TYP      DS    X                   ** BUFFER RECORD TYPE **                     
TGOLDEMQ EQU   X'11'               GOAL DEMO                                    
TGOLDOLQ EQU   X'12'               GOAL DOLLARS                                 
TGOLUNTQ EQU   X'13'               GOAL UNITS                                   
TPREDEMQ EQU   X'21'               PRE-ALLOCATED DEMO                           
TPREDOLQ EQU   X'22'               PRE-ALLOCATED DOLLARS                        
TPREUNTQ EQU   X'23'               PRE-ALLOCATED UNITS                          
TACHDEMQ EQU   X'31'               ACHIEVED DEMO                                
TACHDOLQ EQU   X'32'               ACHIEVED DOLLARS                             
TACHUNTQ EQU   X'33'               ACHIEVED UNITS                               
TRSCGOLQ EQU   X'41'               BALANCED AND ADJUSTED GOALS                  
TPRET00Q EQU   X'50'               BASE FOR PRE-ALLOCATED TARGET                
TPRET01Q EQU   X'51'               PRE-ALLOCATED TARGET DEMO 1                  
TPRET02Q EQU   X'52'               PRE-ALLOCATED TARGET DEMO 2                  
TPRET03Q EQU   X'53'               PRE-ALLOCATED TARGET DEMO 3                  
TPRET04Q EQU   X'54'               PRE-ALLOCATED TARGET DEMO 4                  
TPRET05Q EQU   X'55'               PRE-ALLOCATED TARGET DEMO 5                  
TPRET06Q EQU   X'56'               PRE-ALLOCATED TARGET DEMO 6                  
TPRET07Q EQU   X'57'               PRE-ALLOCATED TARGET DEMO 7                  
TPRET08Q EQU   X'58'               PRE-ALLOCATED TARGET DEMO 8                  
TPRET09Q EQU   X'59'               PRE-ALLOCATED TARGET DEMO 9                  
TPRET10Q EQU   X'5A'               PRE-ALLOCATED TARGET DEMO 10                 
TPRET11Q EQU   X'5B'               PRE-ALLOCATED TARGET DEMO 11                 
TPRET12Q EQU   X'5C'               PRE-ALLOCATED TARGET DEMO 12                 
TPRET13Q EQU   X'5D'               PRE-ALLOCATED TARGET DEMO 13                 
TPRET14Q EQU   X'5E'               PRE-ALLOCATED TARGET DEMO 14                 
TPRET15Q EQU   X'5F'               PRE-ALLOCATED TARGET DEMO 15                 
TPRET16Q EQU   X'60'               PRE-ALLOCATED TARGET DEMO 16                 
TPRET17Q EQU   X'61'               PRE-ALLOCATED TARGET DEMO 17                 
TPRET18Q EQU   X'62'               PRE-ALLOCATED TARGET DEMO 18                 
TPRET19Q EQU   X'63'               PRE-ALLOCATED TARGET DEMO 19                 
TPRET20Q EQU   X'64'               PRE-ALLOCATED TARGET DEMO 20                 
TPRET21Q EQU   X'65'               PRE-ALLOCATED TARGET DEMO 21                 
TACHT00Q EQU   X'70'               BASE FOR ACHIEVED TARGET                     
TACHT01Q EQU   X'71'               ACHIEVED FOR TARGET DEMO 1                   
TACHT02Q EQU   X'72'               ACHIEVED FOR TARGET DEMO 2                   
TACHT03Q EQU   X'73'               ACHIEVED FOR TARGET DEMO 3                   
TACHT04Q EQU   X'74'               ACHIEVED FOR TARGET DEMO 4                   
TACHT05Q EQU   X'75'               ACHIEVED FOR TARGET DEMO 5                   
TACHT06Q EQU   X'76'               ACHIEVED FOR TARGET DEMO 6                   
TACHT07Q EQU   X'77'               ACHIEVED FOR TARGET DEMO 7                   
TACHT08Q EQU   X'78'               ACHIEVED FOR TARGET DEMO 8                   
TACHT09Q EQU   X'79'               ACHIEVED FOR TARGET DEMO 9                   
TACHT10Q EQU   X'7A'               ACHIEVED FOR TARGET DEMO 10                  
TACHT11Q EQU   X'7B'               ACHIEVED FOR TARGET DEMO 11                  
TACHT12Q EQU   X'7C'               ACHIEVED FOR TARGET DEMO 12                  
TACHT13Q EQU   X'7D'               ACHIEVED FOR TARGET DEMO 13                  
TACHT14Q EQU   X'7E'               ACHIEVED FOR TARGET DEMO 14                  
TACHT15Q EQU   X'7F'               ACHIEVED FOR TARGET DEMO 15                  
TACHT16Q EQU   X'80'               ACHIEVED FOR TARGET DEMO 16                  
TACHT17Q EQU   X'81'               ACHIEVED FOR TARGET DEMO 17                  
TACHT18Q EQU   X'82'               ACHIEVED FOR TARGET DEMO 18                  
TACHT19Q EQU   X'83'               ACHIEVED FOR TARGET DEMO 19                  
TACHT20Q EQU   X'84'               ACHIEVED FOR TARGET DEMO 20                  
TACHT21Q EQU   X'85'               ACHIEVED FOR TARGET DEMO 21                  
                                                                                
PROGPROA DS    0CL16               ** SPK4A PROFILE VALUES **                   
OBJ1WGHT DS    C                   GOAL FULFILLMENT                             
OBJ2WGHT DS    C                   CPP/M EQUALIZATION                           
OBJ3WHGT DS    C                   SCHEDULE BALANCING - PROGRAM                 
OBJ4WGHT DS    C                   ''       - STATION/NETWORK                   
OBJ5WGHT DS    C                   ''           - DAY OF WEEK                   
OBJ6WGHT DS    C                   TARGET 1 MAXIMIZATION                        
OBJ7WGHT DS    C                   TARGET 2 MAXIMIZATION                        
         DS    C                   **DO NOT USE**                               
         DS    C                   N/A                                          
         DS    C                   N/A                                          
         DS    C                   N/A                                          
RPRGOPTN DS    C                   PROGRAM RECAP BY PROG TYPE?                  
CPMSOPTN DS    C                   CPP/M EQU. BY WEEK OR SCHED.                 
CPMSWKYQ EQU   C'W'                WEEKLY                                       
CPMSDLNQ EQU   C'S'                DAYPART/SPOTLEN                              
         DS    C                                                                
OFLOOPTN DS    C                   OVERFLOW OPTION (SEE NETUNT)                 
FCGLOPTN DS    C                   **DDS USE ONLY** (MIX)                       
                                                                                
PROGPROB DS    0CL16               ** SPK4B PROFILE OPTIONS **                  
         DS    C                                                                
         DS    C                                                                
DGRPOPTN DS    C                   DAYPART GROUPS                               
GDEMOPTN DS    C                   FORCE GOAL DEMOS TO RATINGS                  
         DS    C                                                                
         DS    C                                                                
         DS    C                                                                
         DS    C                                                                
         DS    C                                                                
OSTAOPTN DS    C                   ONE STATION REALLOCATION                     
         DS    C                   INCLUDE INTEGRATION COSTS?                   
         DS    C                   SKIP BONUS UNITS?                            
         DS    C                   CLEAR BB INFO?                               
         DS    C                   INCLUDE COPY SPLITS                          
SPCLOPTN DS    C                   SPECIAL CLASS CODE (OR BINARY ZERO)          
         DS    C                   N/A                                          
                                                                                
REALLSDT DS    XL2                 RE-ALLOCATION START (WEEK) DATE              
                                                                                
REALLOC  DS    X                   RE-ALLOCATION SWITCH (YESQ/NOQ/WKNO)         
                                                                                
GOALOPT  DS    C                   ** GOALS OPTION **                           
GOALDOLS EQU   C'$'                DOLLAR GOALS                                 
GOALDEMS EQU   C'D'                DEMO GOALS                                   
                                                                                
ZERWKOPT DS    C                   ** ZERO WEEKS OPTION **                      
ZERWIGNQ EQU   C'N'                IGNORE                                       
ZERWERRQ EQU   C'E'                ERROR                                        
ZERWPRVQ EQU   C'P'                USE PREVIOUS WEEK                            
ZERWZERQ EQU   C'Y'                USE AVERAGE WEEK                             
                                                                                
RSWKOPT  DS    C                   ** RESCALE OPTION **                         
RSWKBALQ EQU   C'B'                BALANCING ONLY                               
RSWKREPQ EQU   C'R'                REPORT ONLY                                  
RSWKNOQ  EQU   C'N'                NO GOAL BALANCING                            
RSWKYESQ EQU   C'Y'                GOAL BALANCING ON                            
                                                                                
PATCH    DS    0X                  ** MOVED FROM PATCH AREA **                  
                                                                                
DIAGNOPS DS    0XL2                ** DIAGNOSTIC OPTIONS **                     
                                                                                
DIAGNOP1 DS    X                   ** DIAGNOSTIC OPTION 1 **                    
DPRDSPTQ EQU   X'80'               PRINT PRODUCT BUFFER + SPOT TABLES           
DENVAFTQ EQU   X'40'               ENVIRONMENT TABLES (POST)                    
DPRTUPDQ EQU   X'20'               DUMP WRITE BACK RECORDS                      
DPRTRESQ EQU   X'10'               PRINT RESCALE WORKSHEETS                     
DPRTVARQ EQU   X'08'               PRINT VARIABLE ANAL                          
DPRTCMPQ EQU   X'04'               COMPLETE VARIABLE ANAL                       
DENVBEFQ EQU   X'02'               ENVIRONMENT TABLES (PRE)                     
DNDXPRTQ EQU   X'01'               PRINT INDEX ENTRIES                          
                                                                                
DIAGNOP2 DS    X                   ** DIAGNOSTIC OPTION 2 **                    
DPRTBUFQ EQU   X'80'               PRINT BUFFERIN TRACE                         
DSUPSTRQ EQU   X'08'               SUPPRESS S PHASE TRACE                       
DSUPBTRQ EQU   X'04'               SUPPRESS B PHASE TRACE                       
DSUPXTRQ EQU   X'02'               SUPPRESS X PHASE TRACE                       
DPRTBUYQ EQU   X'01'               PRINT BUY UPDATES                            
                                                                                
DIEKEY   DS    XL9                 GBUFFK TO DIE FOR....                        
                                                                                
PATCHL   EQU   *-PATCH             LENGTH OF PATCH AREA                         
                                                                                
EXCSOPT  DS    C                   VALUES CAN BE YESQ/NOQ                       
PCTOPT   DS    C                   VALUES CAN BE YESQ/NOQ                       
                                                                                
BRQAM    DS    X                   SAVED AGENCY/MEDIA                           
RQMED    DS    C                   SAVED REQUEST MEDIA                          
                                                                                
NTPSW    DS    C                   ** NTP SWITCH **                             
NTPSCASH EQU   C'C'                CASH                                         
NTPSBOTH EQU   C'B'                BOTH                                         
NTPSNTPO EQU   C'N'                NTP ONLY                                     
                                                                                
ACHSW    DS    C                   ** ADDACH S/R SWITCH **                      
ACHSSUBQ EQU   C'S'                SUBTRACT ACHIEVEMENT                         
ACHSADDQ EQU   C'A'                ADD ACHIEVEMENT                              
                                                                                
DPSLFLT  DS    0XL2                ** DAYPART/SPN FILTER **                     
DPTFLT   DS    C                   DAYPART FILTER                               
SLNFLT   DS    X                   SPOT LENGTH FILTER                           
                                                                                
BASEDEM  DS    XL4                 CORP (POL) DEMO                              
                                                                                
TARGETS  DS    (MAXTARGS)XL4       TARGET DEMO LIST                             
TARGETSL EQU   *-TARGETS                                                        
                                                                                
ACTDEMS  DS    0XL(PTDEMMAX)                                                    
ACTDEMSL DS    (PTDEMMAX)XL1                                                    
                                                                                
PESTLST  DS    XL256               POL ESTIMATE LIST                            
                                                                                
PMHLSW   DS    C                   ** PARREP S/R SWITCH **                      
PMHLBRDQ EQU   C'B'                DOING BRAND LIST HEADINGS                    
                                                                                
TRGBASE  DS    C                   ** TARGET VALUE BASE **                      
TRGBDOLS EQU   C'$'                DOLLARS                                      
TRGBDEMS EQU   C'D'                DEMOS                                        
                                                                                
DPTDESC  DS    CL24                                                             
                                                                                
DSTAB    DS    0XL2                ** DAYPART/SPOTLENGTH TABLE **               
DSTABMAX EQU   30                                                               
         DS    (DSTABMAX)XL(L'DSTAB)                                            
DSTABL   EQU   *-DSTAB                                                          
                                                                                
DSSW     DS    C                   ** DAYPART RESCALING SWITCH **               
DSSCURQ  EQU   C'C'                DAYPART RESCALING IN PROGRESS                
DSSYESQ  EQU   C'Y'                DAYPART RESCALED                             
DSSNOQ   EQU   C'N'                DAYPART RESCALING NOT DONE                   
                                                                                
DSCNT    DS    X                   DAYPART/SLN COUNT                            
WKDATB   DS    XL2                 SPOT DATE                                    
SVDMOUTS DS    X                   SAVED DMOUTBTS VALUE                         
ADDLIST  DS    XL64                LIST OF PRODUCTS TO BE ADDED                 
                                                                                
PRESW    DS    C                   PRE-ALLOCATION SWITCH                        
ZERWKSW  DS    X                   ZERO WEEK ERROR SWITCH                       
                                                                                
MKTBUYGL DS    X                   ** MARKET BUY/GOALS FLAG **                  
MKTBHBUY EQU   X'80'               MARKET HAS BUYS                              
MKTBHGOL EQU   X'08'               MARKET HAS GOALS                             
                                                                                
         DS    0F                                                               
X        DS    XL256                                                            
W        DS    XL(SBUFFL)                                                       
                                                                                
RSLCNT   DS    X                   RSLOOP S/R ITERATION COUNTER                 
                                                                                
GOLDEMSW DS    C                   RCFDEM S/R GOAL SWITCH                       
                                                                                
PRDCLSSW DS    C                   ** PRODUCT/CLASS SWITCH **                   
PRDCLSP  EQU   C'P'                PRODUCT                                      
PRDCLSC  EQU   C'C'                CLASS                                        
                                                                                
INTRVLS  DS    0X                                                               
PINTVALS DS    0XL2                                                             
PINTRVL  DS    X                   BRAND TIME INTERVAL (MINUTES)                
PINTPCT  DS    X                   BRAND PERCENT LEEWAY                         
CINTVALS DS    0XL2                                                             
CINTRVL  DS    X                   CLASS TIME INTERVAL (MINUTES)                
CINTPCT  DS    X                   CLASS PERCENT LEEWAY                         
INTRVLSL EQU   *-INTRVLS                                                        
                                                                                
SPTCNT   DS    X                                                                
NOMID    DS    C                                                                
                                                                                
SRPNL1   DS    CL60                                                             
SRPNL2   DS    CL60                                                             
                                                                                
HCLASS   DS    C                                                                
HDEM     DS    XL(L'BASEDEM)                                                    
                                                                                
RSCHGSW  DS    C                                                                
                                                                                
SUMRPTSW DS    X                                                                
                                                                                
UNGPIG   DS    X                                                                
OVFMSW   DS    C                                                                
SPHPRD   DS    X                                                                
SPHFILT  DS    CL4                                                              
RPTSWK   DS    X                                                                
PREPRD1  DS    X                                                                
PREPRD2  DS    X                                                                
PRESLN1  DS    X                                                                
PRESLN2  DS    X                                                                
PREPRD   DS    X                                                                
PRESLN   DS    X                                                                
PUTPASS  DS    X                   PUTBUF S/R PASS NUMBER                       
DPTFLTG  DS    X                                                                
                                                                                
EXCHSW   DS    X                   ** EXCHANGE SWITCH **                        
EXCHCURQ EQU   C'C'                                                             
EXCHREVQ EQU   C'R'                                                             
EXCHNULQ EQU   X'0'                                                             
                                                                                
PRDCLCLN DS    X                   PRODUCT COMPARE LENGTH                       
                                                                                
CGSVBFS  DS    0X                                                               
SVBUF11  DS    XL(L'GBUFFK)                                                     
SVTOT11  DS    XL4                                                              
SVBUF12  DS    XL(L'GBUFFK)                                                     
SVTOT12  DS    XL4                                                              
CGSVBFSL EQU   *-CGSVBFS                                                        
                                                                                
SAVEBKEY DS    XL16                                                             
LASTBKEY DS    XL16                                                             
                                                                                
SVQSTA   DS    CL(L'STA)                                                        
SVBIGSTA DS    CL(L'BIGSTA)                                                     
SVPGRQ   DS    CL(L'QPRD)                                                       
                                                                                
SPLTOPT  DS    X                                                                
SPLTSVPR DS    X                                                                
SPLTPASS DS    X                                                                
                                                                                
HDEMO    DS    CL20                                                             
                                                                                
GBUFFR   DS    0XL119              ** BUFFER RECORD LAYOUT **                   
GBUFFK   DS    0XL9                                                             
GBDPT    DS    X                   DAYPART                                      
GBSLN    DS    X                   SPOT LENGTH                                  
         DS    X                   N/D                                          
GBPALPH  DS    X                   PRODUCT ALPH SEQ CODE                        
GBTYP    DS    X                   SEE TYP EQUATES                              
GBPRD    DS    X                   PRODUCT (00=SUPPLY)                          
GBPCLAS  DS    X                   PRODUCT CLASS                                
         DS    XL2                 N/D                                          
                                                                                
GBUFFC   DS    0XL2                                                             
GBPRI    DS    X                   PRIORITY CODE                                
         DS    X                   N/D                                          
                                                                                
GBROW    DS    0XL4                                                             
GBTOT    DS    XL4                                                              
GBWKS    DS    (MAXWEEKS)XL4                                                    
GBWKSL   EQU   *-GBWKS                                                          
GBROWL   EQU   *-GBROW                                                          
GBROWN   EQU   (*-GBROW)/L'GBROW                                                
                                                                                
GBRECL   EQU   *-GBUFFR                                                         
                                                                                
DEMNMS   DS    XL((PTDEMMAX+6)*DEMNLENQ)                                        
DEMNMSL  EQU   *-DEMNMS                                                         
                                                                                
WORKL    EQU   *-WORKD                                                          
         EJECT                                                                  
***********************************************************************         
* DSECT FOR SPOT BUFFER RECS AND INTERNAL SPOT TABLE                  *         
***********************************************************************         
                                                                                
SBUFFRD  DSECT                     ** SPOT BUFFER RECORD **                     
SBUFFK   DS    0XL9                ** KEY **                                    
SBDPT    DS    X                   DAYPART                                      
SBSLN    DS    X                   SPOT LENGTH                                  
SBRTYP   DS    X                   RECORD TYPE                                  
SBRTYPQ  EQU   X'20'                                                            
SBSTA    DS    XL3                 STATION                                      
SBNETSTA DS    XL3                 NETWORK STATION                              
SBEST    DS    X                   ESTIMATE                                     
SBLIN    DS    XL2                 LINE NUMBER                                  
SBSEQ    DS    X                   SEQUENCE NUMBER                              
SBUFFKL  EQU   *-SBUFFK                                                         
                                                                                
SBDATA   DS    0X                  ** DATA **                                   
SBPDLEN  DS    X                   TOTAL LENGTH                                 
SBUNLEN  DS    X                   LENGTH STILL UNALLOCATED                     
                                                                                
SBSTAT   DS    X                   ** ALLOCATION STATUS **                      
SBSASPTQ EQU   X'40'               ALLOCATED IN SPOT PHASE                      
SBSABRDQ EQU   X'20'               ALLOCATED IN BRAND PHASE                     
SBSAEXCQ EQU   X'10'               ALLOCATED IN EXCHANGE PHASE                  
SBSEXRJQ EQU   X'08'               EXCLUSION REJECT                             
SBSZPRJQ EQU   X'04'               ZERO PASS REJECT                             
SBSENRJQ EQU   X'02'               ENVIRONMENT REJECT                           
SBSPRRJQ EQU   X'01'               PRIORITY REJECT                              
SBSRJCTQ EQU   SBSEXRJQ+SBSZPRJQ+SBSENRJQ+SBSPRRJQ                              
                                                                                
SBSTAT2  DS    X                   ALLOCATION STATUS CONTINUED                  
SBSPRALQ EQU   X'80'               PRE-ALLOCATED                                
SBSLPRAQ EQU   X'40'               LEN PRE-ALLOCATED                            
                                                                                
SBPRDS   DS    0X                  ** ALLOCATION VALUES **                      
SBPRD1   DS    X                   PRODUCT 1                                    
SBLEN1   DS    X                   LENGTH FOR PRODUCT 1                         
SBPRDL   EQU   *-SBPRDS                                                         
SBPRD2   DS    X                   PRODUCT 2                                    
SBLEN2   DS    X                   LENGTH FOR PRODUCT 2                         
SBPRDSL  EQU   *-SBPRDS                                                         
SBMAXALC EQU   (*-SBPRDS)/SBPRDL   MAX ALLOCATION PER SPOT                      
                                                                                
SBWK     DS    X                   WEEK NUMBER                                  
                                                                                
SBENV1   DS    H                   ENVIRONMENT 1                                
SBENV2   DS    H                   ENVIRONMENT 2                                
SBENV3   DS    H                   ENVIRONMENT 3                                
                                                                                
SBDATE   DS    XL2                 SPOT DATE                                    
SBSTIM   DS    XL2                 START TIME                                   
SBDA     DS    XL4                 DISK ADDRESS                                 
SBSPTNO  DS    X                   SPOT NO. (WITHIN DATE)                       
SBDAY    DS    X                   DAY CODE                                     
SBCOST   DS    XL4                 COST                                         
SBCDEM   DS    XL4                 CORP DEMO                                    
SBFIXEND EQU   *                                                                
SBFIXLN  EQU   *-SBUFFRD                                                        
                                                                                
SBTARGS  DS    (MAXTARGS)XL4       START OF TARGETS                             
SBTOTLN  EQU   *-SBUFFRD                                                        
                                                                                
SBDATAL  EQU   *-SBDATA            L'DATA                                       
                                                                                
SBUFFL   EQU   *-SBUFFRD           L'RECORD                                     
                                                                                
XCTABD   DSECT                     ** DSECT TO COVER EXCLUSION TABLE **         
XCTTMAX  EQU   1000                MAXIMUM NUMBER OF TABLE ENTRIES              
                                                                                
XCTKEY   DS    0X                  ** TABLE HEADER **                           
                                                                                
XCTETYPE DS    XL1                 ENTRY TYPE                                   
XCTETSTA EQU   1                   STATION                                      
XCTETNET EQU   2                   NETWORK                                      
XCTETMKT EQU   3                   MARKET                                       
                                                                                
XCTSPE   DS    0X                  ** STATION/PRODUCT/ESTIMATE **               
XCTSTA   DS    XL3                                                              
XCTPRD   DS    CL3                                                              
XCTEST   DS    X                                                                
XCTSPEL  EQU   *-XCTSPE                                                         
                                                                                
XCTKEYL  EQU   *-XCTKEY                                                         
                                                                                
XCTDATA  DS    0X                  ** TABLE DATA **                             
XCTPGM   DS    0XL16               PROGRAM                                      
                                                                                
XCTTYPE  DS    X                   EXCLUSION TYPE                               
XCTTTODQ EQU   X'00'               TIMES OF DAY                                 
XCTTDOWQ EQU   X'01'               DAY OF WEEK - +1(1)                          
XCTTADYQ EQU   X'02'               TIMES + DAY OF WEEK                          
XCTSPCLQ EQU   X'40'               SPECIAL PROGRAM                              
                                                                                
XCTDAY   DS    X                   DAY                                          
XCTDPT   DS    X                   DAYPART                                      
XCTSLN   DS    X                   SPOT LENGTH                                  
                                                                                
         ORG   XCTDAY                                                           
XCTSTIME DS    XL2                 START TIME                                   
XCTETIME DS    XL2                 END TIME                                     
XCTDOW   DS    X                   DAY OF WEEK                                  
         ORG   XCTPGM+L'XCTPGM                                                  
                                                                                
         DS    X                   N/D                                          
XCTDATES DS    0X                                                               
XCTSDATE DS    XL2                 START DATE                                   
XCTEDATE DS    XL2                 END DATE                                     
XCTDATEL EQU   *-XCTDATES                                                       
                                                                                
XCTDATAL EQU   *-XCTDATA                                                        
XCTTABL  EQU   *-XCTABD                                                         
                                                                                
ENVSETD  DSECT                     ** DSECT FOR ENVIRONMENT HEADER **           
ENVSEYEC DS    CL8                 EYE CATCHER                                  
ENVSATAB DS    A                   A(TABLE)                                     
ENVSATOT DS    A                   A(TOTALS)                                    
ENVSMAXN DS    A                   MAXIMUM N'ENTRIES IN TABLE                   
ENVSLTOT DS    A                   L'TABLE                                      
ENVSVAR  DS    F                   VARIABLE                                     
ENVSACNT DS    A                   A(COUNTS)                                    
ENVSACTC DS    A                   A(ACTUAL UNIT COUNTS)                        
ENVSASHR DS    A                   A(SHARES)                                    
ENVSWCNT DS    F                   COUNT OF ENVN'S (FOR WEEK)                   
ENVSTLEN DS    F                   LENGTH OF ENVN TABLE                         
ENVSETCL EQU   *-ENVSETD                                                        
                                                                                
ENVSTTAB EQU   *                   TRANSLATE TABLES START HERE                  
                                                                                
ENVS1TRT DS    XL(ENVS1MAX*2)      TRANSLATE TABLE FOR ENVIRONMENT 1            
         DS    XL2                                                              
                                                                                
         DS    0F                                                               
ENVS1TAB DS    (ENVS1MAX)XL(ENVS1LEN)                                           
         DS    XL2                                                              
                                                                                
         DS    0F                                                               
ENVS1TOT DS    (ENVS1MAX)XL((MAXWEEKS+1)*2)                                     
         DS    XL2                                                              
                                                                                
ENVS1TBL EQU   *-ENVS1TRT                                                       
                                                                                
         ORG   ENVSTTAB                                                         
ENVS2TRT DS    XL(ENVS2MAX*2)      TRANSLATE TABLE FOR ENVIRONMENT 2            
         DS    XL2                                                              
                                                                                
ENVS2TAB DS    XL(ENVS2LEN*ENVS2MAX)                                            
         DS    XL2                                                              
                                                                                
ENVS2TOT DS    XL(ENVS2MAX*((MAXWEEKS+1)*2))                                    
         DS    XL2                                                              
                                                                                
ENVS2TBL EQU   *-ENVS2TRT                                                       
                                                                                
         ORG   ENVSTTAB                                                         
ENVS3TRT DS    XL(ENVS3MAX*2)      TRANSLATE TABLE FOR ENVIRONMENT 3            
         DS    XL2                                                              
                                                                                
ENVS3TAB DS    XL(ENVS3LEN*ENVS3MAX)                                            
         DS    XL2                                                              
                                                                                
ENVS3TOT DS    XL(ENVS3MAX*((MAXWEEKS+1)*2))                                    
         DS    XL2                                                              
                                                                                
ENVS3TBL EQU   *-ENVS3TAB                                                       
                                                                                
ENVTABD  DSECT                     ** DSECT FOR ENV 1 TABLE **                  
ENVSEOTQ EQU   X'FF'               END OF TABLE INDICATOR                       
                                                                                
ENVS1MAX EQU   3000                MAXIMUM FOR ENVIRONMENT1 (PROG/DATE)         
ENVS1KEY DS    0X                  ENVIRONMENT 1 TABLE KEY                      
ENVS1STA DS    XL3                 STATION                                      
ENVS1DAY DS    X                   DAY                                          
ENVS1TIM DS    0XL4                START-END TIMES                              
ENVS1STR DS    XL2                 START TIME                                   
ENVS1END DS    XL2                 END TIME                                     
ENVS1PGC DS    CL6                 PROGRAM CODE                                 
ENVS1PGM DS    CL16                PROGRAM                                      
ENVS1KLN EQU   *-ENVS1KEY                                                       
                                                                                
ENVS1PID DS    X                   PROGRAM INDEX DISPLACEMENT                   
ENVS1SLP DS    XL2                 SLOTS FOR A PRODUCT                          
ENVS1SLC DS    XL2                 SLOTS FOR A CLASS                            
ENVS1LEN EQU   *-ENVTABD                                                        
                                                                                
         ORG   ENVTABD                                                          
ENVS2MAX EQU   100                 MAXIMUM FOR ENVIRONMENT2 (NETWORK)           
ENVS2KEY DS    0X                  ENVIRONMENT 2 TABLE KEY                      
ENVS2STA DS    XL3                 STATION                                      
ENVS2KLN EQU   *-ENVS2KEY                                                       
ENVS2LEN EQU   *-ENVTABD                                                        
                                                                                
         ORG   ENVTABD                                                          
ENVS3MAX EQU   150                 MAXIMUM FOR ENVIRONMENT3 (DAY OF WK)         
ENVS3KEY DS    0X                  ENVIRONMENT 3 TABLE KEY                      
ENVS3DAY DS    X                   DAY-OF-WEEK                                  
ENVS3KLN EQU   *-ENVS3KEY                                                       
ENVS3LEN EQU   *-ENVTABD                                                        
                                                                                
DEMNAMD  DSECT                     ** DSECT TO COVER DEMNMS ENTRY **            
DEMNDEMN DS    XL3                 DEMO NUMBER                                  
DEMNNADP DS    CL4                 NAD PREFIX                                   
DEMNNAME DS    CL7                 DEMO NAME                                    
DEMNNAML EQU   L'DEMNNADP+L'DEMNNAME                                            
DEMNRVSA DS    C                   RATING VS. AUDIENCE INDICATOR                
DEMNRATQ EQU   C'R'                RATING                                       
DEMNAUDQ EQU   C'A'                AUDIENCE                                     
         DS    XL6                 N/D                                          
DEMNLENQ EQU   *-DEMNAMD                                                        
                                                                                
       ++INCLUDE SPREPPTBUF                                                     
PTBEOTQ  EQU   0                   END OF TABLE INDICATOR                       
PTDEMRQ  EQU   C'R'                DEMO TYPE = RATING                           
                                                                                
         ORG   PTPRDA                                                           
PTPRPIGT DS    C                                                                
PTPRPIGQ EQU   C'#',L'PTPRPIGT     'DUMMY' PIGGY-BACK PRODUCT                   
PTPRPCOD DS    CL2                                                              
PTPRPCOQ EQU   C'99',L'PTPRPCOD    'OTHER' PIGGY-BACK PRODUCT                   
                                                                                
         ORG   PTNAME                                                           
PTPPNAME DS    0CL16               ** PIGGY-BACK PAIR VALUES **                 
PTPPNPBE DS    CL3                 'PB='                                        
PTPPNFOR DS    CL13                'AA(A)-NNN,BB(B)-MMM'                        
*                                   PRD1-SHR1,PRD2-SHR2                         
                                                                                
PTPPVALS DS    0XL4                ** PIGGY-BACK PRODUCT VALUES **              
PTPPBRD1 DS    X                   BRAND 1 PRODUCT NUMBER                       
PTPPBRD2 DS    X                   BRAND 2 PRODUCT NUMBER                       
PTPPSHR1 DS    X                   BRAND 1 SHARE (SPOT LENGTH)                  
PTPPSHR2 DS    X                   BRAND 2 SHARE (SPOT LENGTH)                  
         ORG                                                                    
*                                  ** PTSTAT BITS FOR ALLOCATION **             
PTSACTVQ EQU   X'80'               BRAND ACTIVE                                 
PTSPRTYQ EQU   X'40'               PRIORITY                                     
PTSPIGPQ EQU   X'08'               PIGGY PAIR                                   
PTSPIGEQ EQU   X'04'               PIGGY PAIR ERROR                             
PTSPPGEQ EQU   X'02'               PIGGY PAIR GOAL SPOT LENGTH ERROR            
PTSCLSEQ EQU   X'01'               CLASS ERROR                                  
                                                                                
         PRINT OFF                                                              
       ++INCLUDE SPREPWORKD                                                     
         PRINT ON                                                               
                                                                                
         ORG   QGRP                                                             
QOPT6    DS    C                   ZERO WEEK OPTION OVERRIDE                    
QOPT7    DS    C                   SPLIT 30 OPTION                              
                                                                                
         ORG   PROGPROF                                                         
ALOCOPTN DS    C                   ALLOCATION BASIS                             
GOALOPTN DS    C                   GOAL BALANCING OPTION                        
ZEROOPTN DS    C                   WEEKS WITH ZERO GOALS                        
DSEPOPTN DS    C                   DO DAYPARTS SEPARATELY                       
DSECOPTN DS    C                   DO SPOT LENGTHS SEPARATELY                   
INDXOPT  DS    C                   INDEX OPTION                                 
INDXPCTQ EQU   C'P'                INDEXED USING PERCENTS                       
INDXRAWQ EQU   C'R'                INDEXED USING RAW DATA                       
RPTOPTN  DS    C                   REPORT PRINTING OPTION                       
RPTOALLQ EQU   C'D'                ALL REPORTS                                  
RPTORCPQ EQU   C'R'                RECAP ONLY                                   
RPTOWKRQ EQU   C'W'                WEEKLY SUMMARY AND RECAP                     
         DS    C                   N/A                                          
BTVLOPTN DS    C                   BRAND TIME INTERVAL (MINUTES)                
BPCTOPTN DS    C                   BRAND PERCENT LEEWAY                         
CTVLOPTN DS    C                   CLASS TIME INTERVAL (MINUTES)                
CPCTOPTN DS    C                   CLASS PERCENT LEEWAY                         
         DS    C                   N/A                                          
         DS    C                                                                
SPILLOPT DS    C                                                                
SPILLINC EQU   C'Y'                                                             
         DS    C                                                                
         EJECT                                                                  
         ORG   P1                                                               
PMBLD    DS    0C                  LAYOUT FOR BRAND LIST                        
PMBBSTAT DS    C                                                                
PMBBRD   DS    CL3                                                              
         DS    C                                                                
PMBBNM   DS    CL20                                                             
         DS    CL2                                                              
PMBPRI   DS    CL3                                                              
         DS    CL4                                                              
PMBCLAS  DS    C                                                                
         DS    CL3                                                              
PMBGDEM  DS    CL11                                                             
         DS    C                                                                
PMBTRG1  DS    CL11                                                             
         DS    C                                                                
PMBTRG2  DS    CL11                                                             
         DS    CL5                                                              
PMBXEST  DS    CL3                                                              
         DS    CL2                                                              
PMBXSTA  DS    CL8                                                              
         DS    C                                                                
PMBXPGM  DS    CL17                                                             
         DS    CL6                                                              
PMBXDTS  DS    CL17                                                             
                                                                                
         ORG   P1                                                               
PPRLD    DS    0C                  LAYOUT FOR PROGRAM/PRODUCT LINE              
PPRLNET  DS    CL4                 NETWORK                                      
         DS    CL4                                                              
PPRLTYP  DS    CL3                 PROGRAM TYPE                                 
         DS    CL2                                                              
PPRLPGM  DS    CL16                PROGRAM                                      
PPRLTOT  DS    CL6                 TOTALS                                       
PPRLCNTS DS    24CL4               ROOM FOR 24 PRODUCTS                         
                                                                                
         ORG   P1                                                               
D2RLIND  DS    0C                  LAYOUT FOR DETAIL LINE                       
D2RSTA   DS    CL8                                                              
         DS    C                                                                
D2RDATE  DS    CL5                                                              
         DS    C                                                                
D2RDAYS  DS    CL8                                                              
         DS    C                                                                
D2RTIME  DS    CL11                                                             
         DS    C                                                                
D2RPROG  DS    CL16                                                             
         DS    C                                                                
D2REST   DS    CL3                                                              
         DS    CL5                                                              
D2RPRD   DS    CL3                                                              
         DS    CL3                                                              
D2RSLN   DS    CL3                                                              
         DS    C                                                                
D2RCOST  DS    CL11                                                             
         DS    C                                                                
D2RBASD  DS    CL7                                                              
         DS    C                                                                
D2RBASCP DS    CL7                                                              
         DS    C                                                                
D2RTARG1 DS    CL7                                                              
         DS    C                                                                
D2RTG1CP DS    CL7                                                              
         DS    C                                                                
                                                                                
         ORG   P1                                                               
DRLIND   DS    0C                  LAYOUT FOR DETAIL LINE                       
DRSTA    DS    CL8                                                              
         DS    C                                                                
DRDAYS   DS    CL8                                                              
         DS    CL3                                                              
DRDATE   DS    CL5                                                              
         DS    CL3                                                              
DRPRD    DS    CL3                                                              
         DS    CL2                                                              
DRSLN    DS    CL3                                                              
         DS    CL3                                                              
DRCOST   DS    CL11                                                             
         DS    C                                                                
DRBASD   DS    CL9                                                              
DRTARG1  DS    CL9                                                              
                                                                                
         ORG   P2                  LINE 2                                       
DREST    DS    CL3                                                              
         DS    C                                                                
DRLIN    DS    CL3                                                              
         DS    CL2                                                              
DRTIME   DS    CL11                                                             
         DS    CL8                                                              
DRSTAT   DS    CL4                                                              
         DS    C                                                                
DRPRDSLN DS    CL4                                                              
                                                                                
         ORG   P3                  LINE 3                                       
DRPROG   DS    CL17                                                             
                                                                                
         ORG   P1                                                               
CSPLD    DS    0C                  LAYOUT FOR CHILD SPOT RPT LINE               
CSPCOD   DS    CL3                                                              
         DS    C                                                                
CSPNAM   DS    CL20                                                             
         DS    CL5                                                              
CSPGLD   DS    CL7                                                              
         DS    CL3                                                              
CSPGLP   DS    CL3                                                              
         DS    CL5                                                              
CSPNTPD  DS    CL7                                                              
         DS    CL3                                                              
CSPNTPP  DS    CL3                                                              
         DS    CL3                                                              
CSPNTPI  DS    CL3                                                              
         DS    CL5                                                              
CSPPAYD  DS    CL7                                                              
         DS    CL3                                                              
CSPPAYP  DS    CL3                                                              
         DS    CL3                                                              
CSPPAYI  DS    CL3                                                              
         DS    CL5                                                              
CSPTOTD  DS    CL7                                                              
         DS    CL3                                                              
CSPTOTP  DS    CL3                                                              
         DS    CL3                                                              
CSPTOTI  DS    CL3                                                              
                                                                                
SLINED   DSECT                     ** DSECT FOR SPOT TRACE LINE **              
SLDPT    DS    C                                                                
SLSLN    DS    CL3                                                              
         DS    C                                                                
SLSTA    DS    CL5                                                              
         DS    C                                                                
SLEST    DS    CL3                                                              
         DS    C                                                                
SLLIN    DS    CL3                                                              
         DS    C                                                                
SLSEQ    DS    CL3                                                              
         DS    C                                                                
SLSTAT   DS    CL4                                                              
         DS    C                                                                
SLPDLEN  DS    CL3                                                              
         DS    C                                                                
SLEQU    DS    CL4                                                              
         DS    C                                                                
SLUNLEN  DS    CL3                                                              
         DS    C                                                                
SLALLOC  DS    CL13                                                             
         DS    C                                                                
SLWK     DS    CL2                                                              
         DS    C                                                                
SLENV1   DS    CL3                                                              
         DS    C                                                                
SLENV2   DS    CL3                                                              
         DS    C                                                                
SLENV3   DS    CL3                                                              
         DS    C                                                                
SLDA     DS    CL8                                                              
         DS    C                                                                
SLDAY    DS    CL2                                                              
         DS    C                                                                
SLDATE   DS    CL5                                                              
         DS    C                                                                
SLSPTNO  DS    CL2                                                              
SLCOST   DS    CL8                                                              
         DS    C                                                                
SLBASE   DS    CL7                                                              
         DS    C                                                                
SLTARG1  DS    CL7                                                              
         DS    C                                                                
SLTARG2  DS    CL7                                                              
         DS    C                                                                
SLTARG3  DS    CL7                                                              
                                                                                
RRLIND   DSECT                     ** DSECT FOR RECAP REPORT LINE **            
         DS    C                                                                
RRBRD    DS    CL3                                                              
         DS    C                                                                
RRBRDN   DS    CL20                                                             
         DS    CL3                                                              
RRDESC   DS    CL16                                                             
         DS    CL5                                                              
RRGOAL   DS    CL8                                                              
         DS    CL3                                                              
RRGPCT   DS    CL3                                                              
         DS    CL3                                                              
RRACH    DS    CL8                                                              
         DS    CL3                                                              
RRAPCT   DS    CL3                                                              
         DS    CL3                                                              
RRINDX   DS    CL4                                                              
         EJECT                                                                  
PPRD     DSECT                     ** DSECT FOR PROGRAM/PRODUCT TBL **          
PPRNET   DS    XL3                 NETWORK                                      
PPRTYP   DS    CL3                 TYPE                                         
PPRPGM   DS    CL16                PROGRAM NAME                                 
PPRPGMC  DS    CL6                 PROGRAM CODE                                 
PPRKL    EQU   *-PPRD                                                           
                                                                                
PPRTOT   DS    XL4                                                              
PPRCNTS  DS    0XL2                START OF PRODUCT COUNTS                      
                                                                                
CSD      DSECT                     ** CHILD SPOT ACCUMS **                      
CSPRD    DS    X                   PRODUCT CODE                                 
         DS    XL3                                                              
CSACCS   DS    0F                                                               
CSGOAL   DS    F                                                                
CSNTP    DS    F                                                                
CSPAY    DS    F                                                                
CSTOT    DS    F                                                                
CSACCSL  EQU   *-CSACCS                                                         
CSACCSN  EQU   (*-CSACCS)/L'CSACCS                                              
CSDL     EQU   *-CSD                                                            
                                                                                
TABD     DSECT                                                                  
TABKEY   DS    0XL9                                                             
TABDPT   DS    X                   DAYPART                                      
TABSLN   DS    X                   SPOT LENGTH                                  
         DS    X                   N/D                                          
TABPRDA  DS    X                   PRODUCT ALPH SEQ CODE                        
TABTYP   DS    X                   SEE TYP EQUATES                              
TABPRD   DS    X                   PRODUCT (00=SUPPLY)                          
TABPRDC  DS    X                   PRODUCT CLASS                                
         DS    XL2                 N/D                                          
                                                                                
TABCOMM  DS    0XL2                COMMENT                                      
TABPRI   DS    X                   PRIORITY CODE                                
         DS    X                   N/D                                          
                                                                                
TABNOSPT DS    C                   NO SPOTS FOR BRAND                           
TABACTWK DS    X                   ACTIVE WEEKS                                 
TABGLDEM DS    X                   GOAL DEMO                                    
         DS    XL2                 N/D                                          
                                                                                
TABROLL  DS    XL4                 ROLL-UP AMOUNT                               
TABGOAL  DS    XL4                 GOAL                                         
TABVALL  EQU   *-TABD                                                           
                                                                                
TABDATA  DS    0X                  ** ACCUMULATORS **                           
TRSCGOL  DS    XL4                                                              
TPREDEM  DS    XL4                                                              
TPREDOL  DS    XL4                                                              
TPREUNT  DS    XL4                                                              
TSAVDEM  DS    XL4                                                              
TABTA1   DS    0XL4                DISP TO 1ST TARGET                           
TMINRES  DS    XL4                                                              
                                                                                
         ORG   TABDATA                                                          
SUMDATA  DS    0XL4                ** SUMMARY DATA **                           
SUMGLDD  DS    XL4                 GOAL DOLLARS                                 
SUMGLRD  DS    XL4                 GOAL DEMO                                    
SUMRSGD  DS    XL4                 RESCALED GOALS                               
SUMASD   DS    XL4                 ACH SPOTS                                    
SUMPSD   DS    XL4                 PRE SPOTS                                    
SUMADD   DS    XL4                 ACH DOLLARS                                  
SUMPDD   DS    XL4                 PRE DOLLARS                                  
SUMARD   DS    XL4                 ACH DEMOS                                    
SUMPRD   DS    XL4                 PRE DEMOS                                    
SUMDATAL EQU   *-SUMDATA                                                        
                                                                                
SUMAUD   DS    0XL4                ** SUMMARY AUDIENCE DATA **                  
SUMAT1D  DS    XL4                 ACH TARG1                                    
SUMPT1D  DS    XL4                 PRE TARG1                                    
SUMAUDL  EQU   *-SUMAUD                                                         
         EJECT                                                                  
***********************************************************************         
* BUILD PRODUCT BUFFER                                                *         
***********************************************************************         
                                                                                
PRDBLD   CSECT                                                                  
         NMOD1 PBWORKL,**PRDBLD,CLEAR=YES                                       
         LR    R8,R1                                                            
         USING WORKD,R8                                                         
         USING PBWORKD,RC          RC=A(LOCAL W/S)                              
                                                                                
         LA    R0,PBIOA                                                         
         ST    R0,AREC             SET A(I/O AREA FOR READING)                  
         L     R0,PRDBUFF                                                       
         LHI   R1,PTXBUFFL                                                      
         STCM  R1,3,PRDBUFLN       SET PRODUCT BUFFER WIDTH                     
         MHI   R1,TOTPRD                                                        
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE               CLEAR PRODUCT BUFFER                         
         EJECT                                                                  
***********************************************************************         
* IF ESTIMATE=NO OR RANGE OF ESTIMATES READ POL ESTIMATE RECORDS      *         
***********************************************************************         
                                                                                
PRDBLD02 MVC   PBESTLST(L'BEST),BEST                                            
         CLI   QESTEND,C' '        TEST ESTIMATE RANGE OR FILTER                
         BNE   *+14                                                             
         CLC   =C'NO',QEST                                                      
         BNE   PRDBLD20                                                         
         XC    PESTLST,PESTLST     CLEAR POL ESTIMATE LIST                      
                                                                                
         LA    R4,KEY              READ ESTIMATES AND BUILD A LIST              
         USING ESTHDR,R4                                                        
         XC    EKEY,EKEY                                                        
         MVC   EKEYAM,BAGYMD                                                    
         MVC   EKEYCLT,BCLT                                                     
         MVC   EKEYPRD,=C'POL'                                                  
         LA    R2,PBESTLST         R2=A(ESTIMATE LIST)                          
         MVI   0(R2),0                                                          
         CLC   =C'NO',QEST                                                      
         BE    PRDBLD06                                                         
         MVC   EKEYEST,BEST                                                     
         B     PRDBLD08                                                         
                                                                                
PRDBLD06 LA    R4,KEY              BUMP ESTIMATE NUMBER IN KEY                  
         CLI   EKEYEST,FF          TEST HIGHEST ESTIMATE JUST READ              
         BE    PRDBLD10                                                         
         IC    R0,EKEYEST                                                       
         AHI   R0,1                                                             
         STC   R0,EKEYEST                                                       
         XC    EKEYREST,EKEYREST                                                
         CLC   =C'NO',QEST         TEST ESTIMATE FILTERS                        
         BE    PRDBLD08                                                         
         CLC   EKEYEST,BESTEND     TEST RANGE EXCEEDED                          
         BH    PRDBLD10                                                         
                                                                                
PRDBLD08 GOTOR HIGH                                                             
         CLC   EKEY(EKEYEST-ESTHDR),KEYSAVE                                     
         BNE   PRDBLD10                                                         
         OC    EKEYREST,EKEYREST                                                
         BNZ   PRDBLD06                                                         
                                                                                
         GOTOR GET                                                              
         L     R4,AREC                                                          
         CLC   EEND,QSTART         APPLY DATE FILTERS                           
         BL    PRDBLD06                                                         
         CLC   ESTART,QEND                                                      
         BH    PRDBLD06                                                         
         GOTOR FLTEST              APPLY ESTIMATE FILTERS IF REQUIRED           
         BNE   PRDBLD06                                                         
                                                                                
         MVC   0(L'EKEYEST,R2),EKEYEST                                          
         AHI   R2,L'EKEYEST                                                     
         LLC   RF,EKEYEST          ADD TO ESTIMATE LIST TOO                     
         LA    RF,PESTLST-L'EKEYEST(RF)                                         
         MVC   0(1,RF),EKEYEST                                                  
         B     PRDBLD06                                                         
                                                                                
PRDBLD10 CLI   PBESTLST,0          TEST ANY POL ESTIMATES FOUND                 
         BE    PRDBLDX                                                          
         EJECT                                                                  
***********************************************************************         
* BUILD A LIST OF PRODUCTS THAT HAVE ESTIMATES FOR THIS REQUEST       *         
***********************************************************************         
                                                                                
         USING PTBUFFD,PBBUILD                                                  
PRDBLD20 LA    R4,KEY                                                           
         USING PKEY,R4                                                          
         XC    PKEY,PKEY                                                        
         MVC   PKEYAM,BAGYMD                                                    
         MVC   PKEYCLT,BCLT                                                     
                                                                                
PRDBLD24 LA    R4,KEY                                                           
         IC    R0,PKEYPRD+L'PKEYPRD-1                                           
         AHI   R0,1                                                             
         STC   R0,PKEYPRD+L'PKEYPRD-1                                           
         XC    PKEYREST,PKEYREST                                                
         GOTOR HIGH                                                             
         CLC   PKEY(PKEYPRD-PKEY),KEYSAVE                                       
         BNE   PRDBLDX                                                          
         CLI   PKEYREST,0          ENSURE WE HAVE A PRODUCT KEY                 
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         GOTOR GET                 READ PRODUCT RECORD                          
         L     R4,AREC                                                          
         USING PRDHDR,R4                                                        
         MVC   PTPRDA,PKEYPRD                                                   
         MVC   PTPRDN,PCODE+1                                                   
         MVC   PTNAME,PNAME                                                     
         MVC   PTCLASS,PCLASS                                                   
                                                                                
***********************************************************************         
* READ ESTIMATES FOR THIS PRODUCT                                     *         
***********************************************************************         
                                                                                
         LA    R2,PBESTLST                                                      
         LHI   R3,L'PBESTLST                                                    
         MVC   KEYSAVE,KEY                                                      
                                                                                
PRDBLD26 LA    R4,KEY                                                           
         USING EKEY,R4                                                          
         MVC   EKEY,KEYSAVE                                                     
         MVC   EKEYEST,0(R2)       SET ESTIMATE NUMBER                          
         GOTOR HIGH                                                             
         CLC   EKEY,KEYSAVE        TEST ESTIMATE FOUND FOR PRODUCT              
         BNE   PRDBLD38                                                         
                                                                                
         GOTOR GET                 READ THE ESTIMATE RECORD                     
         L     R4,AREC                                                          
         USING ESTHDR,R4                                                        
                                                                                
         MVC   PTDEMO,EDEMLST                                                   
         MVC   PTWGHT,EWGTLST                                                   
         MVC   PTXDEM(60),EDEMLST                                               
         MVC   PTXDEM+60(3),EDEM21                                              
         MVC   PTXWGHT(20),EWGTLST                                              
         MVC   PTXWGHT+20(1),EDEM21WT                                           
                                                                                
         LA    RE,ETRGLST                                                       
         LA    R5,PTTRGS                                                        
         LA    R0,L'PTTRGS                                                      
         XC    PTTRGS,PTTRGS                                                    
                                                                                
PRDBLD28 OC    0(3,RE),0(RE)       THIS TARGET NOT USED                         
         BZ    PRDBLD34                                                         
         LA    RF,PTDEMO                                                        
         LHI   R6,1                                                             
                                                                                
PRDBLD30 CLC   0(L'PTDEMNO,RE),0(RF)                                            
         BE    PRDBLD32                                                         
         AHI   RF,L'PTDEMNO                                                     
         AHI   R6,1                                                             
         B     PRDBLD30                                                         
                                                                                
PRDBLD32 STC   R6,0(R5)            SET  POSITION NUMBER IN PTTRGS               
                                                                                
PRDBLD34 AHI   RE,L'PTDEMNO        NEXT TARGET                                  
         AHI   R5,1                                                             
         BCT   R0,PRDBLD28                                                      
                                                                                
PRDBLD36 SR    RF,RF               FIND TABLE SLOT                              
         IC    RF,PTPRDN                                                        
         BCTR  RF,0                                                             
         MH    RF,PRDBUFLN                                                      
         L     RE,PRDBUFF                                                       
         LA    RF,0(RE,RF)                                                      
         MVC   0(L'PBBUILD,RF),PBBUILD                                          
         DROP  R4                                                               
                                                                                
PRDBLD38 AHI   R2,1                BUMP TO NEXT ESTIMATE                        
         CLI   0(R2),0             TEST END OF ESTIMATE LIST                    
         BE    *+8                                                              
         BCT   R3,PRDBLD26         DO FOR MAXIMUM NUMBER OF ESTIMATES           
                                                                                
         MVC   KEY,KEYSAVE         RESTORE LAST PRODUCT KEY                     
         B     PRDBLD24            DO FOR NEXT PRODUCT                          
         EJECT                                                                  
***********************************************************************         
* FIX POL AND UNALLOCATED ENTRIES IN PRODUCT BUFFER AND EXIT          *         
***********************************************************************         
                                                                                
PRDBLDX  LHI   RF,TOTPRD-1         SAVE CURRENT POL ENTRY                       
         MH    RF,PRDBUFLN                                                      
         A     RF,PRDBUFF                                                       
         MVC   PBBUILD,0(RF)                                                    
                                                                                
         LHI   RF,220-1            COPY INTO PRODUCT 220 ENTRY                  
         MH    RF,PRDBUFLN                                                      
         A     RF,PRDBUFF                                                       
         MVC   0(L'PBBUILD,RF),PBBUILD                                          
                                                                                
         MVI   PTPRDN,UNAPRD1      MAKE AN UNALLOCATED PRODUCT ENTRY            
         MVC   PTPRDA,=C'***'                                                   
         MVC   PTNAME,=CL20'Unallocated'                                        
                                                                                
         LHI   RF,UNAPRD1-1        MOVE UNALLOCATED PRODUCT TO BUFFER           
         MH    RF,PRDBUFLN                                                      
         A     RF,PRDBUFF                                                       
         MVC   0(L'PBBUILD,RF),PBBUILD                                          
         XIT1  ,                                                                
         EJECT                                                                  
***********************************************************************         
* FILTER ESTIMATES ON FILTER VALUES IN QESTEND IF REQUIRED            *         
***********************************************************************         
                                                                                
         USING ESTHDR,R4                                                        
FLTEST   CLC   =C'NO',QEST         INCLUDE IF SINGLE/RANGE OF ESTIMATES         
         BNE   FLTESTY                                                          
         CLC   QESTEND,SPACES      INCLUDE IF NO FILTERS                        
         BE    FLTESTY                                                          
         LA    R1,QESTEND                                                       
         LA    RF,EPROF                                                         
         LHI   R0,L'QESTEND                                                     
                                                                                
FLTEST02 CLI   0(R1),C'*'          TEST WILD CARDS                              
         BE    FLTEST06                                                         
         CLI   0(R1),C' '                                                       
         BE    FLTEST06                                                         
         TM    0(R1),X'40'         TEST NEGATIVE FILTERS                        
         BZ    FLTEST04                                                         
         CLC   0(1,R1),0(RF)       POSITIVE FILTER MUST MATCH                   
         BNE   FLTESTN                                                          
         B     FLTEST06                                                         
                                                                                
FLTEST04 MVC   BYTE,0(R1)          NEGATIVE FILTER MATCH                        
         OI    BYTE,C' '                                                        
         CLC   BYTE,0(RF)          NEGATIVE FILTER MUST NOT MATCH               
         BE    FLTESTN                                                          
                                                                                
FLTEST06 AHI   R1,1                BUMP AND DO FOR NUMBER OF FILTERS            
         AHI   RF,1                                                             
         BCT   R0,FLTEST02                                                      
                                                                                
FLTESTY  CR    RE,RE               CC=EQUAL TO INCLUDE                          
         BR    RE                                                               
                                                                                
FLTESTN  LTR   RE,RE               CC=NOT EQUAL TO EXCLUDE                      
         BR    RE                                                               
         DROP  R4                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
PBWORKD  DSECT                     ** PRDBLD LOCAL W/S **                       
PBBUILD  DS    XL(PTXBUFFL)        PTBUFF ENTRY BUILT HERE                      
PBESTLST DS    XL256               POL ESTIMATE LIST                            
PBIOA    DS    XL2000              I/O AREA FOR ESTIMATE/PRODUCT READS          
PBWORKL  EQU   *-PBWORKD                                                        
                                                                                
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'019SPREPK402 09/29/20'                                      
         END                                                                    
