*          DATA SET ACBRA29    AT LEVEL 089 AS OF 12/16/20                      
*PHASE T62429A                                                                  
*INCLUDE ACPROFLT                                                               
*&&UK                                                                           
*INCLUDE TAXVAL                                                                 
*INCLUDE DATVAL                                                                 
*INCLUDE VATICAN                                                                
*&&                                                                             
                                                                                
ACBRA29  TITLE '- BrandOcean Account/Client/Product/Job Upload Server'          
                                                                                
* Level change comments                                                         
* ---------------------                                                         
* NSHE 001 23JAN09 New application server                                       
* MPEN 001 06JUL09 Make 4A Call when rejecting or submitting a job              
* NSHE 002 06JUL10 Don't allow approval twice                                   
* NSHE     02SEP10 US change to prorata call                                    
* NRAK     24SEP10 Fix GETTEAM for medium-only LIDEL entries                    
* NSHE 003 27JAN11 Add approver type to approver table                          
* NSHE 004 15MAR11 Fix in SETOPT routine to decide if jobs allowed              
* NSHE 005 20MAY11 BR18020D - wrong instruction causing lethal failure          
* SMAN 007 10AUG11 BR18420D - Read AGOBLOCB not AGOBLOCK                        
* NSHE 008 22JUN11 Error message added for missing accounts                     
* NRAK 009 19SEP11 GAP/ISO/IBAN for a/c upload, add media for cli/pro           
*                 Allow adding of debtor/costing if SJ                          
* YNGX 011 28NOV11 <PR002442> Update ESTSJBCL on estimate records               
* MPEN     10DEC12 <PR002501> Media uploads                                     
* JFOS     24JAN11 <BR46929L> fix bug in Job close                              
* SMAN     10FEB12 PR002375 Extend ABLELD to include ABLTXS                     
* NSHE 012 08JUN12 <BR50147L> Estimate lock incorrect table entry               
* NSHE 017 08JUN12 Error if amending deleted account                            
* NSHE     14AUG12 Replace switch system logic                                  
* MPEN     23JUL12 Check product address against client                         
* NRAK     07NOV12 Re-use client SR for SAP products, not SR *mapping*          
* MPEN     11SEP12 <BR20316D> Fix bad branch in AUDPPR                          
* YNGX     09NOV12 <BR52581L> Fix bug when saving user fields                   
* NRAK     15NOV12 <BR52754l> fix previous - ignore max if date and <7          
* MPEN     25FEB13 <BR54230L> Check order fully billed first!                   
* NRAK     06MAR13 Fix media record deletion                                    
* NRAK     10MAR13 Allow approver-comment-only update                           
* MPEN 018 21JUN13 <DSBO-88>Don't upper case address lines                      
*MPEN 019 27JAN14 <DSBO-646> Not enough approvers found while closing           
*NRAK 020 15JAN14 <DSBO-618> Check for outstanding invoices on close            
*NRAK 021 13MAY14 <DSUKVSI-15> Horrible locking code                            
*NRAK 022 28MAY14 <DSRD-2634> tidy up response code                             
*NSHE 023 10JUN14 <DSRD-2732> Add application to audit element                  
*NRAK     20JUN14             Skip Approver response if Acc Upload tool         
*MPEN     20JUN14 <OT79877L>  Always read for client VAT type                   
*NSHE     24JUN14 Set exclude from timesheet and time lock for Aura             
*MPEN 024 11AUG14 <DSBO-675>  Set application type if acc upload                
*MPEN 025 16JUL14 <DSRD-3567> Fix to prevent closure of draft jobs              
*         22JUL14 <DSRD-3606> If type=3 save close date if passed               
*         24JUL14 <DSRD-3670> Fix dump on delete                                
*         31JUL14 <DSRD-3762> Allow deletion of draft jobs                      
*NSHE     30JUL14 <DSRD-3748> Return mult errors within one response            
*YNGX     07AUG14 <DSMHUB-16> Add application MEDIAHUB                          
*MPEN     07AUG14 <DSRD-3737> Set job as master job                             
*MPEN     23APR14 <DSBO-675> Accounting upload tool improvements &              
*TKLU                        fixes for media payment due date (Germany)         
*TKLU     25Aug14 <DSRD-4051> Skip further offcie validation if empty           
*MPEN 026 04Sep14             Merge US changes for aura jobs                    
*                 <DSMHUB-36> Check subel code when deleting txtel              
*                 <DSMHUB-40> Add missing fields to media block                 
*                 <DSMHUB-41> Add last activity date on accounting              
*                 <DSMHUB-42> Fix balance brought forward date                  
*                 <DSMHUB-43> Don't mark as change action if add                
*MPEN 027 05Sep14             Make media commission upper case                  
*                 <DSMHUB-49> Fix bug changing amounts on debtors               
*                 <DSMHUB-46> For medhub set 2 dec places for cred lim          
*                 <DSMHUB-47> Fix to add budget currency on change              
*NRAK     09SEP14             Various fixes for SAP Int Cli/Pro                 
*NRAK 028 19SEP14 <dsbo-1169> fix saving of billgroup/print on bill             
*MPEN 029 22SEP14 <DSMHUB-50> Fix for media formula not updated on chg          
*         23SEP14 <DSMHUB-55> Error message in case no client bud curr          
*MPEN 030 24SEP14 <DSBO-1174> Fix to check user field input required            
*         24SEP14 <DSBO-1176> Validate user field type                          
*MPEN 031 23OCT14 <DSMHUB-37> Fix for corrupted media filters                   
*                 <DSBO-1214> Correct invalid office error message              
*                 <DSBO-1199> Fix incorrect VAT Region message                  
*                 <DSBO-1213> Office check on 1C account                        
*                 <DSBO-1220> Fix for child job not added to master             
*NRAK 032 10NOV14 Fix for inherited offices                                     
*NRAK 033 10NOV14 fix previous                                                  
*MPEN 034 05NOV14 <DSBO-1145> Correct filter error messages                     
*MPEN     20NOV14 <DSRD-5184> Throw error when approving closed/locked          
*MPEN     20NOV14 <DSRD-3748> Fix error message handling for aura               
*NRAK 035 25NOV14 Maintain product level mapping for SAP on add                 
*MPEN     25NOV14 <DSMHUB-69> Fix credit limit issue                            
*NRAK 036 23DEC14 <DSUKVSI-42> migrate pgmsap->pgmsapdm                         
*MPEN 037 17DEC14 <DSBO-1146> Fix incorrect equivalent error message            
*         06JAN15 <DSBO-1294> Check for debtor acc if equivalents pass          
*         06JAN15 <DSBO-1298> Check for close date> open date                   
*         07JAN15 <DSBO-1316> Clear ELEAREA for user fields in USERTABL         
*YNGX     23DEC14 <DSRD-5459> BUG FIX - NOT ABLE TO DELETE CLOSED JOB           
*MPEN 038 08JAN15 <DSMHUB-76> FIX AGAIN FOR MEDIAHUB                            
*TKLU 039 13Jan15 <PCA01302>  Disallow pay method transfer for Germany          
*MPEN 040 09JAN15 <DSMHUB-86> ENSURE BUDGET CURRENCY PASSED                     
*MPEN     09JAN15 <DSBO-1293> ERROR IF EQUIV TYPE PASSED BUT NO CODE            
*MPEN     14JAN15 <DSMHUB-88> FIX MEDIA OPTIONS DUPLICATION                     
*MPEN     29JAN15 <DSRD-5734> ALLOW JOB TO B CLOSED ON SAME DAY AS OPEN         
*NRAK 041 20FEB15 <DSUKVSI-59,DSUKVSI-62> Fix mapping for SAP                   
*NRAK 042 09Mar15 <DSBO-1395> Copy filter values to directory                   
*NRAK     09Mar15 <DSUKVSI-75> for sap tool, allow Add if record exists         
*NRAK 043 11Mar15 <DSUKVSI-75> fix SR element updates                           
*NRAK 044 13Mar15 <DSUKVSI-73> error if media system read-only on updt          
*NRAK 045 17Mar15 <DSUKVSI-82> 1C offpos for 1C off'e val'n, not 2D!            
*NRAK 046 17Mar15 <DSUKVSI-84> fix error message                                
*NSHE 047 24Apr15 <DSBO-1406> Remove SETFAC                                     
*MPEN 048 14Apr15 <DSMHUB-106> Fix bug in office checking on SR                 
*NRAK 049 07May15 <DSUKVSI-94> For SAP, retain address if blanks sent           
*NRAK     08May15 <OT83379L> bugfix AECREC maintenance                          
*NRAK 050 23Jun15 <DSUKVSI-94> retain acc address as well (see prev)            
*NRAK 051 07Jul15 <DSUKVSI-102> retain filters if SAP upload                    
*NRAK                Also block short name updates and fix sr equivs            
*NRAK 052 07Jul15 <DSUKVSI-103> retain vat reg if SAP upload                    
*NRAK 053 08Jul15 <DSUKVSI-104> bad read sequence if equiv recs deleted         
*NRAK 054 08Jul15 <DSUKVSI-104> missing statement checking hello error          
*NRAK 055 10Jul15 <DSUKVSI-105> filter handling on SR updates                   
*NRAK 056 03Aug15 <DSUKVSI-104> force MediaType to u/c                          
*NRAK 057 11Sep15 <DSUKVSI-113> for Sap, can convert change req to add          
*TKLU 051 22Sep15 <PCM02500> German 5th media address line Cli/Prod             
*MPEN 059 21Dec15 <DSUKVSI-127> Fix bad length on NAMELD for SAP upload         
*NSHE 060 23Dec15 <DSHAR-150> Ensure media filters are upper case               
*MPEN 061 07Mar16 <PCM02610> Increase RLEN to fix dumps                         
*MPEN 062 01Apr16 <DSBO-1714> Improve office code validation for non-SJ         
*MPEN 063 13Apr16 <DSBO-1712> Only output maximum 25 error messages             
*MPEN 064 29Apr16 <DSBO-1712> Limit number of recs in 1 request to 200          
*MPEN 065 06May16 <PCA02404> Check for missing product/job on Auto job          
*MPEN 066 24NOV14 <DSRD-5215> If job is deleted delete est aud recs             
*         09MAR15 <DSBO-1382> Fix security level for upload                     
*MPEN     24SEP15 <DSBO-1586> More accounting upload fixes                      
*                 <DSRD-9154> Don't send emails to every approver               
*                 <ITMF-4513> Fix bad d/a problem                               
*                 <DSBO-1706> Ensure if appr accounts ares set appr             
*                 <DSBO-1707> Fix bug on checking for duplicate 13B             
*GHOA     24Mar16 <DSSUP-1732> BIL= in Footer Comments                          
*RGUP     30Mar16 <DSRD-10662> US code to check job link before close           
*NSHE 067 24May16 <DSRD-11237> Don't amend team/person list for Aura            
*NSHE     09Jun16 <DSRD-11814> Ensure client order audit is correct             
*MPEN 068 17Jun16 <DSRD-11914> Don't create unecessary audit entries            
*MPEN     20Jun16 <PCM-03498> Fix media issue where bad txtel added             
*MPEN 069 13Jul16 <PCA-02494> Fix media address issue                           
*GHOA 070 30Jun16 <DSRD-11882> Fix blank Audit lines                            
*GHOA     12Jul16 <DSSUP-7711> Fix footer comment BIL=                          
*NSHE     26Jul16 <DSRD-12429> Don't allow brandocean to use team               
*MPEN 071 13Sep16 <DSRD-13259> Fix for clearing other info fields               
*MPEN 072 06Oct16 <DSUKVSI-179> Fix for INTSAP testing                          
*TKLU 073 07Oct16 <DSRD-13552> Fix 'estimate delte' if 'job delete'             
*MPEN 074 21Nov16 <DSRD-14020> Update cli/pro upload for PO tracker             
*GHOA 075 17Jan17 <DSRD-14443> Include studio code on Upload                    
*         31Jan17 <DSRD-14484> Include studio link on Upload                    
*MPEN 076 24MAR17 <DSRD-14484> Copy US changes for studio                       
*TKLU 077 28JUN17 <RD015679> Add SCITCPAT onto Jobs for PAY2JOB user            
*MPEN 078 08SEP17 <RD016875>   Fix for ADDRAP passive dump                      
*RGUP 079 07Sep17 <DSRD-16856> fix for audit application type - studio          
*MPEN 080 14Nov17 <DSRD-17491> Fix for not able to submit job error             
*                 <DSRD-17540> Additional fix for not able to submit            
*TKLU 081 06Feb18 <DSRD-18178> Apply GOPROD for ADD/AUTO only                   
*MPEN 082 10May18 <DSRD-18847> Lock 1N accounts                                 
*NSHE 083 14Sep18 <DSMU-124> allow email address for more than SJ               
*MPEN 084 11Oct18 <DSMU-125> Fix for cash discount amount                       
*ABID 089 05JUN19 DSPCA-2941 RELINKED FOR ACVATICAN CHANGES                     
*VGUP     21Mar19 <SPEC-33435> Fixed the job element delete issue               
*NMAL     19Jun19 <DSPCA-2956> New ACIBANTAB                                    
*MPEN     23Oct19 <DSRD-24105> Fix for reopen studio job                        
*SGAV     14FEB20 DSPCA-3080 Update RSTLN from RSTLN3Q To RSTLN4Q               
*JSHA     06APR20 DSRD-26028 Dumps reading old Audit recs for new jobs          
*NSHE 090 11JUN20 DSRD-25764 Job/Close returns error Cannot close job           
*DPUR     22Jun20 DSPCA-3155 TO remove references to BrandOcean                 
*YNGX 091 21JuL20 DSRD-24374 Master job is not getting changed                  
*VGUP 089 23NOV20 ITMF-51282 Fix issue with the audit record                    
*NSHE 089 16Dec20 DSRD-27970 Enable mobile application in table                 
                                                                                
         PRINT NOGEN                                                            
SVRDEF   CSECT                                                                  
         LKSVR TYPE=U,CODE=ENTRY,RLEN=2000,REQUEST=*,WORKERKEY=ACBO,   *        
               LINKIO=Y,BLOCKS=(B#SAVED,SAVED),SYSTEM=ACCSYSQ                   
                                                                                
ENTRY    NMOD1 0,**BO29**,RR=RE                                                 
         LR    R5,R1                                                            
         USING LP_D,R5                                                          
         L     R7,LP_ARUNP                                                      
         USING RUNPARMD,R7         R7=A(RUNPARMS)                               
         XR    R6,R6                                                            
         ICM   R6,7,RUNPARUN                                                    
         USING RUNFACSD,R6         R6=A(RUNFACS)                                
         LARL  RA,GLOBALS                                                       
         USING GLOBALS,RA          RA=A(GLOBAL LITERALS)                        
         L     R9,LP_ABLK1                                                      
         USING WORKD,R9            R9=A(GLOBAL W/S)                             
         ICM   R8,15,RSVRSAVE      R8=A(4K SAVE AREA)                           
         ST    R8,LP_ABLK2                                                      
         USING SAVED,R8            R8=A(SAVE W/S)                               
         ST    RE,SRVRRELO         SAVE PROGRAM RELOCATION FACTOR               
         STM   R2,RB,LP_R2RB       SAVE REGISTERS FOR SUB-ROUTINES              
         MVC   RUNMODE,RUNPMODE    Set calling mode                             
         EJECT                                                                  
***********************************************************************         
* Initialise Upload                                                   *         
***********************************************************************         
                                                                                
INITUL   CLI   RUNMODE,RINIREQQ    Test 'Initialise' mode                       
         JE    INIT                                                             
         CLI   RUNMODE,RRUNREQQ    Test 'Run request' mode                      
         JE    INPUT                                                            
         CLI   RUNMODE,RRUNENDQ    Test 'Last for request' mode                 
         JNE   EXITY                                                            
         J     EXITY                                                            
                                                                                
         USING CPXELD,SCPXEL                                                    
         USING CPYELD,SCPYEL                                                    
INIT     L     RF,AACCFACS                                                      
         MVC   VACCEMU,X_AACCEMU-X_ACCFACSD(RF)                                 
         MVI   GIND2,GI2ACCT                                                    
         GOTOR (#CPYINI,ACPYINI)   INITIALISE COMPANY VALUES                    
         GOTO1 VDICTATE,DMCB,C'LU  ',DATI,DATO                                  
*                                                                               
         LA    RE,SWSTAB                                                        
         USING SYSSWTAB,RE                                                      
INIT02   CLI   SYSSWSYS,0                                                       
         JE    INIT10                                                           
         CLI   SYSSWSOV,QSMED                                                   
         JNE   *+16                                                             
         MVC   MEDAGYB,SYSSWAGB                                                 
         MVC   MEDSCNUM,SYSSWACS                                                
         LA    RE,SYSSWLEN(RE)                                                  
         J     INIT02                                                           
         DROP  RE                                                               
*                                                                               
INIT10   L     R1,ALP              RESTORE A(LP_D)                              
         MVC   AALIOB,LP_ALIOB     EXTRACT A(LIOB) FROM LP_D                    
         L     RF,LP_ACOM          EXTRACT A(LINKIO) FROM COMFACS               
         MVC   AALINKIO,CLINKIO-COMFACSD(RF)                                    
*                                                                               
         GOTOR VDATCON,DMCB,(5,0),(1,AC_TODYP)                                  
         GOTOR (RF),(R1),(5,0),(2,AC_TODYC)                                     
         GOTOR (RF),(R1),(5,0),(0,AC_TODYF)                                     
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Process and Upload Record                                           *         
***********************************************************************         
                                                                                
INPUT    LA    RF,RECTAB                                                        
         USING RECTABD,RF                                                       
         LHI   R0,RECTABN                                                       
         BASR  RE,0                                                             
         CLC   RECTMAP#,LP_QMAPN   Look up record map code                      
         JE    INPUT02                                                          
         AHI   RF,RECTABL                                                       
         BCTR  R0,RE                                                            
         DC    H'0'                -> unknown record type                       
                                                                                
INPUT02  MVC   RECTYPE,RECTTYPE    -> set known record type                     
                                                                                
         GOTOR UPDREC              PROCESS THE INPUT RECORD                     
                                                                                
         J     EXITY               EXIT BACK TO DDLINK                          
         DROP  RB                                                               
         EJECT                                                                  
                                                                                
***********************************************************************         
* Go to Upload Record handling routine                                *         
***********************************************************************         
                                                                                
UPDREC   NTR1  BASE=*,LABEL=*                                                   
                                                                                
         LA    R0,DR_VALS          Clear derived values                         
         LHI   R1,DR_VALSL                                                      
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         LA    R0,SAVEVAR          Clear save varialbles                        
         LHI   R1,SAVEVARL                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         LAY   RE,ERRTAB                                                        
         MVI   0(RE),ET_EOTQ       Initialise error table                       
         GOTOR (#SYSCHK,ASYSCHK)                                                
         JE    UPDREC2                                                          
         GOTOR SAVERR,DMCB,=AL2(AE$FLRD),(5,=C'EC092'),0                        
         J     UPDACTX                                                          
                                                                                
UPDREC2  LLC   RF,LINCNT           Check whether we have too many               
         AHI   RF,1                records                                      
         STC   RF,LINCNT                                                        
         CHI   RF,MAXLIN                                                        
         JL    UPDREC4                                                          
         JE    UPDREC3                                                          
         J     UPDACTX             If hit max limit just exit                   
*                                                                               
UPDREC3  OI    TWAMODE,TWAMERP+TWAMUWD                                          
         GOTOR SAVERR,DMCB,=AL2(AE$TMREC),(5,=C'EC124'),0                       
         J     UPDACTX             Error if we have hit max rec limit           
*                                                                               
UPDREC4  XR    RF,RF                                                            
         IC    RF,RECTYPE                                                       
         BCTR  RF,0                                                             
         SLL   RF,2                                                             
         CHI   RF,UPDTABL                                                       
         JL    UPDREC5                                                          
         DC    H'0'                                                             
*                                                                               
UPDREC5  DS    0H                                                               
         B     UPDTAB(RF)                                                       
                                                                                
UPDTAB   DS    0XL4                                                             
         J     UPDACT              Account                                      
UPDTABL  EQU   *-UPDTAB                                                         
                                                                                
UPDRECY  J     EXITY                                                            
                                                                                
UPDRECN  J     EXITN                                                            
         DROP  RB                                                               
         EJECT                                                                  
                                                                                
***********************************************************************         
* Account Upload Module                                               *         
***********************************************************************         
                                                                                
UPDACT   BASE  ,                                                                
         MVI   TWAMODE,0                                                        
                                                                                
         LA    RF,APLTAB                                                        
         USING APLTABD,RF                                                       
         LHI   R0,APLTABN                                                       
         BASR  RE,0                                                             
         CLC   APLTMAP#,CUXPNUM    Look up application code                     
         JE    UACT002                                                          
         AHI   RF,APLTABL                                                       
         BCTR  R0,RE                                                            
         DC    H'0'                -> unknown application type                  
                                                                                
UACT002  MVC   SSTCAPL,APLTSTC     set STC element value                        
         DROP  RF                                                               
                                                                                
         LA    R4,SJEQTAB                                                       
         LR    R0,R4               Clear table of rules for ledger              
         LHI   R1,L'SJEQTAB                                                     
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         MVI   0(R4),X'FF'         Set EOT                                      
                                                                                
         OC    QA_ULA,QA_ULA       Make sure accounts are uppercase             
         JZ    *+10                                                             
         OC    QA_ULA,SPACES                                                    
         OC    QA_DRACT,QA_DRACT                                                
         JZ    *+10                                                             
         OC    QA_DRACT,SPACES                                                  
         OC    QA_CSACT,QA_CSACT                                                
         JZ    *+10                                                             
         OC    QA_CSACT,SPACES                                                  
*&&UK                                                                           
         XR    RF,RF                                                            
         ICM   RF,3,CUXPNUM        Check if mediahub                            
         CHI   RF,XPMEDHUB                                                      
         JNE   UACT002B                                                         
         CLC   QA_DRACT,SPACES     Anything passed?                             
         JNH   UACT002A                                                         
         MVC   WORK(L'SRUL),SRUL   if so put unit/ledger                        
         MVC   WORK+L'SRUL(L'QA_DRACT),QA_DRACT                                 
         MVC   QA_DRACT,WORK                                                    
         LLC   RF,QA_DRACL         increment input length                       
         AHI   RF,L'SRUL                                                        
         STC   RF,QA_DRACL                                                      
*                                                                               
UACT002A OC    QA_CREXT,QA_CREXT   Is there anything passed?                    
         JZ    UACT002B                                                         
         SRP   QA_CREXT,2,0        multiply internal/external by 100            
*&&                                                                             
UACT002B XR    RF,RF                                                            
         ICM   RF,3,CUXPNUM        Check whether accounting upload tool         
*&&UK*&& CHI   RF,XPMEDHUB         Or mediahub                                  
*&&UK*&& JE    UACT003                                                          
         CHI   RF,XPACCUPQ         is connected                                 
         JNE   UACT004                                                          
         MVI   QA_ASTAT,QA_ANEW    Always set new acc for acc upload            
*                                                                               
UACT003  MVI   QA_UPLD,QA_ACCTL    If so set acc upload and update type         
         MVI   QA_TYPE,QA_TUPDT                                                 
*                                                                               
UACT004  CLC   QA_UNIT,SPACES      Test unit given                              
         JH    UACT010                                                          
         GOTOR SAVERR,DMCB,=AL2(AE$INUNT),(5,=C'EC093'),=AL2(FLD001)            
*                                                                               
UACT010  CLC   QA_LDG,SPACES       Test ledger given                            
         JH    UACT015                                                          
         GOTOR SAVERR,DMCB,=AL2(AE$INLDG),(5,=C'EC094'),=AL2(FLD002)            
         J     UPDACTX                                                          
*                                                                               
UACT015  XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,QA_UNIT                                                   
         GOTOR (#SETLDG,ASETLDG)                                                
         JE    UACT020                                                          
         GOTOR SAVERR,DMCB,=AL2(AE$INLDG),(5,=C'EC094'),=AL2(FLD002)            
         J     UPDACTX                                                          
*                                                                               
UACT020  L     R1,AIO1                                                          
         LA    R1,LDGRFST-LDGRECD(R1)                                           
         USING LDGELD,R1                                                        
UACT022  CLI   LDGEL,0                                                          
         JE    UACT031                                                          
         CLI   LDGEL,LDGELQ                                                     
         JE    UACT030                                                          
         CLI   LDGEL,APRELQ        Extract account equivalent rule(s)           
         JE    UACT032                                                          
UACT024  LLC   RE,LDGLN                                                         
         AR    R1,RE                                                            
         J     UACT022                                                          
*                                                                               
UACT030  MVC   LEDGSTA2,LDGSTAT2                                                
         J     UACT024                                                          
*                                                                               
         USING APRELD,R1                                                        
         USING EQRULTBD,R4                                                      
UACT032  MVC   EQRLSEQ,APRSEQ      Sequence number of rule                      
         MVC   EQRLLEN,APRTLEN     Total length of rule                         
         MVC   EQRLNLVS,APRNLEVS # levels                                       
         MVC   EQRLNAME,APRDESC    Account equivalent name                      
         XR    RF,RF                                                            
         IC    RF,APRNLEVS         # levels                                     
         LA    RE,APRMLEN          1st level                                    
UACT033  XR    R0,R0               Look for lowest level                        
         IC    R0,0(RE)                                                         
         CHI   RF,1                                                             
         JE    UACT033A                                                         
         AHI   RE,L'APRMLEN                                                     
         AR    RE,R0                                                            
         SHI   RF,1                                                             
         J     UACT033                                                          
UACT033A XR    RF,RF               Calculate minimum variable length            
         IC    RF,EQRLLEN                                                       
         SR    RF,R0                                                            
         AHI   RF,1                So lowest level has minimum 1 byte           
         STC   RF,EQRMVLN                                                       
         LA    RE,APRDESC+L'APRDESC-1                                           
         CLI   0(RE),C' '          Find last character of name                  
         JH    *+8                                                              
         JCT   RE,*-8                                                           
         LA    RF,APRDESC                                                       
         SR    RE,RF                                                            
         JNM   *+6                                                              
         DC    H'0'                No account equivalent name                   
         LA    RE,1(,RE)                                                        
         STC   RE,EQNMLEN          L'account equivalent name                    
         IC    RE,APRLN                                                         
         SHI   RE,APRLN1Q+1        RE=L'(All rules+lengths)-1                   
         BASR  RF,0                                                             
         MVC   EQRLRULE(0),APRMLEN Save length/rule                             
         EX    RE,0(RF)                                                         
         LA    R4,EQRLLNQ(,R4)     Next table entry                             
         MVI   0(R4),X'FF'         Set EOT                                      
         J     UACT024             Next element                                 
         DROP  R4                                                               
*                                                                               
UACT031  CLC   PRODUL,QA_UNIT                                                   
         JNE   UACT035                                                          
         OC    QA_OPDTE,QA_OPDTE                                                
         JNZ   *+10                                                             
         MVC   QA_OPDTE,AC_TODYP                                                
         MVC   AC_EFDTE,QA_OPDTE                                                
         GOTO1 VDATCON,DMCB,(1,AC_EFDTE),(0,OPEN)                               
*                                                                               
UACT035  GOTOR VALACT              Check account                                
         JNE   UPDACTX                                                          
         CLI   QA_UPLD,C' '        Skip these checks for BO/Aura                
         JNH   UACT036                                                          
         LARL  RF,VALLOP                                                        
         GOTOR (RF)                Check values passed are valid for            
         JNE   UPDACTX             ledger we're updating                        
*&&UK*&& LARL  RF,VALVAT           Call vatican and validate vat codes          
*&&UK*&& GOTOR (RF)                                                             
*&&UK*&& JNE   UPDACTX                                                          
UACT036  LARL  RF,VALAEQV                                                       
         GOTOR (RF)                Check equivalents                            
         CLI   QA_UPLD,QA_SAPTL    Only for SAP tool                            
         JNE   UACT037                                                          
         LARL  RF,BLDDCST                                                       
         GOTOR (RF)                Build debtor and costing accounts            
*                                                                               
UACT037  LAY   R4,GENAEXTN         Point to status element stack                
         MVI   0(R4),0             Set as empty                                 
         MVI   UPDATED,C'N'                                                     
         ST    R4,SVSTCELS                                                      
         CLI   QA_ASTAT,QA_AREJT   If rejecting set job as closed               
         JNE   UACT040                                                          
*        MVI   QA_CSTAT,YESQ                                                    
         MVI   QA_LSTAT,NOQ                                                     
UACT040  CLI   QA_ASTAT,QA_ASUBM   If submitting after rejection                
         JNE   UACT045             clear close status                           
         CLI   QA_TYPE,QA_TAPPR                                                 
         JE    *+12                                                             
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   UACT045                                                          
         CLC   PRODUL,QA_UNIT                                                   
         JNE   UACT045                                                          
         TM    AC_IND1,AC_INEW3+AC_ILVL3  Must be job level                     
         JZ    UACT045             Otherwise exit                               
         USING ACTRECD,R2                                                       
         L     R2,AIO3                                                          
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('JOBELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R1,12(R1)                                                        
         USING JOBELD,R1                                                        
         CLI   JOBLN,JOBLN3Q       Have we got longer jobel with stat2          
         JL    UACT045             No - can't have been rejected                
         TM    JOBSTA2,JOBSREJ     Was the job rejected                         
         JZ    UACT045             No                                           
         DROP  R1                                                               
         MVI   QA_CSTAT,NOQ        Yes - remove close and lock                  
         MVI   QA_LSTAT,NOQ                                                     
UACT045  CLI   QA_ASTAT,QA_ADELT   Are we deleting account                      
         JNE   UACT046             No                                           
         GOTOR CHKACT,CHKDELT      Yes - check we can delete it                 
         JE    UACT060             Yes we can                                   
         GOTOR SAVERR,DMCB,ROUERRV,(5,=C'EC095'),0                              
         J     UPDACTX             No - issue error from routine                
*                                                                               
UACT046  CLI   QA_ASTAT,QA_ANEW    Is this a new account                        
         JE    UACT048             Yes                                          
         CLI   QA_ASTAT,QA_AAUTO                                                
         JNE   UACT050             No                                           
UACT048  GOTOR BLDACT,DMCB,0       Build account record                         
UACT050  GOTOR ADDNAM              Build name element                           
         GOTOR ADDADR              Build address element                        
         GOTOR ADDRST              Build record status element                  
         GOTOR ADDAST              Build account status element                 
         GOTOR ADDJOB              Build job element                            
*&&US*&& GOTOR ADDLNK              Build lnk element                            
         GOTOR ADDRAT              Build rate element                           
         GOTOR ADDBAC              Build BAC payment element                    
         GOTOR ADDPPR              Build prod profile element                   
         GOTOR ADDFFT              Build free form text elements                
         GOTOR ADDGLP              Build general ledger element                 
         GOTOR ADDSNM              Build short name element                     
         GOTOR ADDXNM              Build alternative or foreign name            
         GOTOR ADDJLD              Build job description elements               
         GOTOR ADDSCM              Build job comment elements                   
         GOTOR ADDSPA              Build special posting account ele            
         GOTOR ULKMJB              Unlink master job                            
         GOTOR ADDUFS              Build user field elements                    
*&&UK*&& GOTOR ADDDEX              Build due date element                       
         GOTOR ADDOME              Build online memo element                    
         GOTOR ADDGPN              Build job long name element                  
         GOTOR ADDPID              Build personal id element                    
         GOTOR ADDAPT              Build expense account element                
         GOTOR ADDSCI              Build subsidiary cash info element           
*&&UK*&& GOTOR ADDEBD              Build Euro bank details element              
         GOTOR ADDPAC              Build person activity element                
         GOTOR CLPOLD              Build list client purchase element           
         GOTOR TEAMLD              Build list client team element               
         GOTOR LNKJB               Update jobs where this one is master         
UACT060  GOTOR ADDSTC              Build status/approver element                
         GOTOR ADDPTR              Build activity pointer element               
         GOTOR ADDSJQV             Add equivalent type code pointer             
*                                                                               
*  BUILD SUPPLEMENTARY RECORDS TO UPDATE IN TSAR                                
         L     R7,AIO8                                                          
         LARL  RF,GOTSAR                                                        
         GOTOR (RF),DMCB,('TSAINI',0)                                           
         GOTOR VDEBCOST            VALIDATE DEBTOR/COSTING FIELDS               
*&&UK*&& GOTOR VMEDFLDS            VALIDATE MEDIA FIELDS                        
* ANY CHANGES TO ACCOUNT REC?                                                   
         LAY   R4,GENAEXTN         Point to status element stack                
         CLI   0(R4),0             Is it empty                                  
         JNE   UACT067             No - something to write back                 
         CLI   UPDATED,C'Y'                                                     
         JE    UACT067                                                          
* any tsar recs (media/debtor/costing update)                                   
         USING T_D,R7                                                           
         XC    T_KEY(T_KEYL),T_KEY                                              
         LARL  RF,GOTSAR                                                        
         GOTOR (RF),DMCB,('TSARDH',0)                                           
         TM    DMCB,TSEEOF                                                      
         JZ    UACT067                                                          
         TM    TWAMODE,TWAMERP     If errors don't bother showing this          
         JNZ   UPDACTX             one                                          
*                                                                               
         XR    RF,RF                                                            
         ICM   RF,3,OA_INDEX       Remove increment from index number           
         SHI   RF,1                                                             
         STCM  RF,3,OA_INDEX                                                    
         ICM   RF,3,CUXPNUM        Check whether BrandOcean or Aura             
         CHI   RF,XPRODIKQ          is connected                                
         JE    UPDACTX             If Aura allow no change update               
         GOTOR SAVERR,DMCB,=AL2(AE$NTGUP),(5,=C'EC096'),0 nothing to do         
         J     UPDACTX                                                          
* NO UPDATES IF ERRORS FOUND                                                    
UACT067  TM    TWAMODE,TWAMERP                                                  
         JNZ   UPDACTX                                                          
*                                                                               
UACT070  DS    0H                                                               
         CLI   UPDATED,C'Y'        Non-stcel update?                            
         JE    UACT072                                                          
         LAY   R4,GENAEXTN         Point to status element stack                
         CLI   0(R4),0             Is it empty                                  
         JE    UACT108             YES, MEDIA/DEBTOR/COST CHANGE ONLY           
*                                                                               
UACT072  OI    IOINDS1,IO1XSWCH    Restore Acc as default                       
         LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA,OA_ULA                                                   
         L     R1,=AL4(IORDUPD+IODIR+IO3)                                       
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    UACT080                                                          
         CLI   IOERR,IOEDEL                                                     
         JE    UACT080                                                          
         GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOMST+IO3'                           
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO3                                                          
         CLC   ACTKEY+ACTKEND(L'ACTKEY-ACTKEND),SPACES                          
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR UPDPASS,DMCB,(C'A',AIO3),AC_OFF                                  
*                                                                               
         TM    AC_IND2,AC_IRMOL    Are we to remove old account code            
         JZ    UACT105             No                                           
         LA    R2,IOKEY            Yes                                          
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA,QA_ULA                                                   
         L     R1,=AL4(IORDUP+IODIR+IO3)                                        
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JNE   UACT105                                                          
*                                                                               
UACT080  MVC   CSVKEY2,IOKEY       copy new record to IO7                       
         L     R0,AIO7                                                          
         LA    R1,IOLENQ                                                        
         L     RE,AIO3                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         L     R1,=AL4(IOGETRUP+IOMST+IO3)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO3                                                          
         CLC   ACTKEY+ACTKEND(L'ACTKEY-ACTKEND),SPACES                          
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR UPDPASS,DMCB,(C'D',AIO3),(C'K',AC_OFF)                           
*                                                                               
         TM    AC_IND2,AC_IRMOL    Are we to remove old account code            
         JNZ   UACT094             Yes - delete old account record              
         L     R0,AIO3             copy new record back to IO3                  
         LA    R1,2000                                                          
         L     RE,AIO7                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         L     R2,AIO3                                                          
UACT090  CLI   QA_ASTAT,QA_ADELT                                                
         JNE   UACT095                                                          
UACT094  OI    ACTRSTAT,ACTSDELT       SET DELETED                              
UACT095  GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO3'                           
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   IOKEY,CSVKEY2                                                    
         LA    RE,IOKEY                                                         
         MVC   ACTKSTAT-ACTRECD(L'ACTKSTA,RE),ACTRSTAT                          
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR+IO3' UPDATE DIR STATUS          
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R2,AIO3                                                          
         TM    ACTRSTAT,ACTSDELT       SET DELETED                              
         JNZ   UACT100                                                          
         CLC   ACTKEY+ACTKEND(L'ACTKEY-ACTKEND),SPACES                          
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR UPDPASS,DMCB,(C'A',AIO3),AC_OFF                                  
UACT100  TM    AC_IND2,AC_IRMOL    Are we to remove old account code            
         JZ    UACT105             No                                           
         L     R0,AIO3             copy new record back to IO3                  
         LA    R1,2000                                                          
         L     RE,AIO7                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         L     R2,AIO3                                                          
                                                                                
UACT105  DS    0H                                                               
*&&UK*&& GOTOR UPDRAP,AIO3         Update record activity pointers              
         GOTOR UPDAEX              Update account extension records             
         GOTOR UPDEST              Update estimate records                      
         GOTOR UPDPOP              Update production option records             
         GOTOR UPDAUD              Uses STCELS held in GENAEXTN                 
         JE    UACT108                                                          
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
         OI    TWAMODE,TWAMUWD                                                  
* Add equivalent records if any                                                 
UACT108  LARL  RF,BLDEQVS                                                       
         GOTOR (RF)                                                             
*                                                                               
* Read first/next tsar                                                          
*                                                                               
         XC    T_KEY(T_KEYL),T_KEY                                              
         MVC   HALF1,SPACES                                                     
         LARL  RF,GOTSAR                                                        
         GOTOR (RF),DMCB,('TSARDH',0)                                           
         TM    DMCB,TSEEOF                                                      
         JNZ   UACT130             NO TSARS                                     
         J     UACT115                                                          
UACT110  LARL  RF,GOTSAR                                                        
         GOTOR (RF),DMCB,('TSANXT',0)                                           
         TM    DMCB,TSEEOF                                                      
         JNZ   UACT130             FINISHED                                     
*                                                                               
* Process account record Tsar                                                   
*                                                                               
UACT115  CLI   T_ACCMED,T_ACCQ                                                  
         JNE   UACT120                                                          
* restore Acc as default, if necessary                                          
         OI    IOINDS1,IO1XSWCH                                                 
*                                                                               
         CLC   HALF1,T_ULA                                                      
         JE    UACT117             ??? DO WE NEED THIS                          
         MVC   HALF1,T_ULA         FIRST TIME FOR LEDGER                        
         MVC   LDGAUL,T_ULA                                                     
         GOTOR (#SETLDG,ASETLDG)                                                
UACT117  GOTOR UDEBCOST                                                         
*                                                                               
* Process media record Tsar                                                     
*                                                                               
UACT120  CLI   T_ACCMED,T_MEDQ                                                  
         JNE   UACT110                                                          
*&&UK*&& LARL  RF,UPMEDSYS                                                      
*&&UK*&& GOTOR (RF)                                                             
         J     UACT110                                                          
         DROP  R7                                                               
*                                                                               
* Check for any records existing for media not passed in update                 
*                                                                               
UACT130  CLC   OA_MLIST,SPACES          Delete client/prod from any             
         JNH   UPDACTX                      media not sent this time            
*&&UK                                                                           
         LA    R3,OA_MLIST              R3 = current media letter               
         LHI   R0,16                                                            
         XR    RF,RF                    RF= current binary media                
*                                                                               
UACT0132 CLI   0(R3),C' '               Haven't updated this media?             
         JNH   UACT0136                 check if on file (delete if so)         
UACT0134 DS    0H                                                               
         AHI   RF,1                                                             
         LA    R3,1(R3)                                                         
         JCT   R0,UACT0132                                                      
* End of media list                                                             
         J     UPDACTX                                                          
* Unprocessed medium, delete any existing client/prod                           
         USING M_CAMKEY,R2                                                      
UACT0136 XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY                                                         
         STC   RF,M_CAMKAM                                                      
         ST    RF,SAVERF                                                        
         OC    M_CAMKAM,MEDAGYB                                                 
         MVI   M_CAMKTYP,M_CLIKTYPQ     Client!                                 
         MVC   M_CAMKCLI,OA_MCLI                                                
         TM    AC_IND1,AC_INEW2+AC_ILVL2                                        
         JZ    UACT0140                                                         
         MVI   M_CAMKTYP,M_PROKTYPQ     Product!                                
         MVC   M_CAMKPRO,OA_MPRO                                                
UACT0140 OI    IOINDS1,IO1XSWCH    Don't switch back                            
         L     R1,=AL4(IORD+IOMEDDIR+IO7)                                       
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JNE   UACT0160            does not exist on this medium                
* Check for lower level records                                                 
         MVC   CSVKEY1,IOKEY                                                    
         MVI   M_CAMKCAM,1                                                      
         MVI   M_CAMKTYP,M_CAMKTYPQ                                             
         TM    AC_IND1,AC_INEW2+AC_ILVL2                                        
         JNZ   UACT0142                                                         
         MVI   M_CAMKCAM,0                                                      
         MVI   M_CAMKPRO,1                                                      
         MVI   M_CAMKTYP,M_PROKTYPQ                                             
UACT0142 L     R1,=AL4(IOHI+IOMEDDIR+IO7)                                       
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JNE   UACT0155            Nothing found                                
         LA    RF,M_CAMKNULL-M_CAMKEY                                           
         TM    AC_IND1,AC_INEW2+AC_ILVL2                                        
         JNZ   UACT0144                 Product                                 
         LA    RF,M_CAMKPRO-M_CAMKEY                                            
UACT0144 SHI   RF,1                                                             
         CLC   IOKEY(0),IOKEYSAV                                                
         EX    RF,*-6                                                           
         JNE   UACT0155                                                         
* Lower level record found, cannot delete                                       
* Get media code, then SAP equiv. append to error                               
         XC    M_CAMKCLI(M_CAMSTAT-M_CAMKCLI),M_CAMKCLI                         
         MVI   M_CAMKTYP,M_MEDKTYPQ                                             
         L     R1,=AL4(IORD+IOMEDDIR+IO7)                                       
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
         LAY   R4,SAPTAB           Media code equivs                            
         USING SAPTABD,R4                                                       
         LAY   RF,SAPTABX                                                       
UACT0146 DS    0H                                                               
         CR    R4,RF                                                            
         JL    UACT0147                                                         
* Missing equivalence                                                           
         MVC   TEMP2,SPACES                                                     
         MVC   TEMP2(12),=C': MO Medium='                                       
         MVC   TEMP2+12(L'M_MEDDCOD),M_CAMKEY+(M_MEDDCOD-M_MEDKEY)              
         LA    RE,13                                                            
         J     UACT0151                                                         
*                                                                               
UACT0147 CLC   SAPTACT(L'M_MEDDCOD),M_CAMKEY+(M_MEDDCOD-M_MEDKEY)               
         JE    UACT0148                                                         
         LA    R4,SAPTABL(R4)                                                   
         J     UACT0146                                                         
UACT0148 DS    0H                  Length of equiv code                         
         MVC   TEMP2,SPACES                                                     
         MVC   TEMP2(12),=C': MediaType='                                       
         MVC   TEMP2+12(L'SAPCODE),SAPCODE                                      
         LA    RF,TEMP2+12+L'SAPCODE-1                                          
         LA    RE,L'SAPCODE+12                                                  
* find length of extra data                                                     
UACT0150 CLI   0(RF),C' '                                                       
         JH    UACT0151                                                         
         SHI   RF,1                                                             
         JCT   RE,UACT0150                                                      
         DC    H'0'                                                             
UACT0151 DS    0H                  Saverr params                                
         XC    DMCB,DMCB                                                        
         LA    R4,TEMP2                                                         
         ST    R4,DMCB+4                                                        
         STC   RE,DMCB+4                                                        
         LA    R4,=AL2(AE$CDACC)   lower level exists, can't delete             
         ST    R4,DMCB                                                          
         LA    R1,DMCB                                                          
         GOTOR SAVERR                                                           
         J     UACT0160            Skip, next                                   
* OK to delete                                                                  
UACT0155 DS    0H                                                               
         MVC   IOKEY,CSVKEY1                                                    
         L     R1,=AL4(IORDUPD+IOMEDDIR+IO7)                                    
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JNE   UACT0160                                                         
         L     R1,=AL4(IOGETRUP+IOMEDFIL+IO7)                                   
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                      Found cli/prod for this med             
         DC    H'0'                     delete it                               
         LAY   RF,SRCHBLK               needs updating                          
         LAY   R4,SRCHLIST                                                      
         MVC   MFILADR,IOADDR           Save disk address                       
         GOTO1 VSRCHPAS,DMCB,(C'B',0(RF)),ACOMFACS,AIO7,0(R4),         +        
               MFILADR,(X'01',=C'MEDIA ')                                       
         L     R2,AIO7                                                          
         OI    M_CAMSTAT,X'80'                                                  
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMEDFIL+IO7'                        
         JE    *+6                                                              
         DC    H'0'                                                             
         LA    R2,IOKEY                                                         
         OI    M_CAMDSTAT,X'80'                                                 
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IOMEDDIR+IO7'                         
         JE    *+6                                                              
         DC    H'0'                                                             
         LAY   RF,SRCHBLK                                                       
         LAY   R4,SRCHLIST                                                      
         GOTO1 VSRCHPAS,DMCB,(C'D',0(RF)),ACOMFACS,AIO7,0(R4)                   
*                                                                               
         USING M_FLTKEY,IOKEY                                                   
         XC    M_FLTKEY,M_FLTKEY   Build filter passive key                     
         L     RF,SAVERF                                                        
         STC   RF,M_FLTKAGY                                                     
         OC    M_FLTKAGY,MEDAGYB                                                
         MVI   M_FLTKTYP,M_FLTKTYPQ                                             
         MVI   M_FLTKSTYP,M_FLTKPASS                                            
         MVC   M_FLTKCLI,OA_MCLI                                                
         TM    AC_IND1,AC_INEW2+AC_ILVL2 Only for product type                  
         JZ    *+10                                                             
         MVC   M_FLTKPRO,OA_MPRO                                                
         STC   RF,M_FLTKAM                                                      
         L     R1,=AL4(IOHID+IOMEDDIR+IO7)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+14                                                             
         CLI   IOERR,IOEDEL        Allow deleted                                
         JE    UACT0160                                                         
         DC    H'0'                                                             
         CLC   M_FLTKEY(M_FLTKFLTS-M_FLTKEY),IOKEYSAV                           
         JNE   UACT0160            No fltr passvs for this agy/med              
*                                                                               
         OI    M_FLTDSTAT,X'80'    Delete old passive                           
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IOMEDDIR+IO7'                         
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
UACT0160 L     RF,SAVERF           Restore media no.                            
         J     UACT0134                                                         
*&&                                                                             
                                                                                
*** Global exists for Account Upload Server ***************************         
                                                                                
         USING LIOBD,R4                                                         
UPDACTX  L     R4,AALIOB           after updates pass return data               
*                                                                               
         USING ACTRECD,R2                                                       
         LA    R2,IOKEY            Dummy read to switch back to acc             
         XC    IOKEY,IOKEY                                                      
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA,OA_ULA                                                   
         MVI   IOINDS1,IO1XSWCH    Don't switch back to media                   
*                                  Set up product key                           
         L     R1,=AL4(IORDD+IODIR+IO7)                                         
         GOTOR (#IOEXEC,AIOEXEC)                                                
*                                                                               
         TM    TWAMODE,TWAMERP+TWAMUWD exit on all errors                       
         JNZ   UPDACX10                                                         
         CLI   QA_UPLD,QA_ACCTL                                                 
         JE    UPDACX20                                                         
*                                                                               
         XR    R0,R0                                                            
         ICM   R0,3,LP_QMAPN       Build download map element                   
         GOTOR AALINKIO,DMCB,('LIOAPUT',LP_ALIOB),('LIOTMAP',(R0))              
         GOTOR VHEXOUT,DMCB,OA_INDEX,WORK,L'OA_INDEX                            
         GOTOR AALINKIO,DMCB,('LIOAPUT',LP_ALIOB),                     +        
               ('LIOTRAW',D#ID#),('LD_CHARQ',WORK),(L'OA_INDEX*2,0)             
         GOTOR AALINKIO,DMCB,('LIOAPUT',LIOBD),('LIOTRAW',D#ACT),      +        
               ('LD_CHARQ',OA_ULA),(L'OA_ULA,0)                                 
         GOTOR AALINKIO,DMCB,('LIOAPUT',LIOBD),('LIOTRAW',D#ACSTA),    +        
               ('LD_CHARQ',OA_STAT),(L'OA_STAT,0)                               
*                                                                               
*  TRIGGER JOB APPROVER DOWNLOAD (4A CALL) for BrO/Aura                         
         CLI   QA_UPLD,QA_SAPTL                                                 
         JE    UPDACX20                                                         
         CLI   QA_ASTAT,QA_ADELT   If deleting don't call 4A will fail          
         JE    UPDACX20                                                         
         CLC   SJUL,QA_UNIT        Only send X'4A' call if this is SJ           
         JNE   UPDACX20            account                                      
*                                                                               
         XR    RF,RF                                                            
         ICM   RF,3,CUXPNUM        Check whether BrandOcean or Aura             
         CHI   RF,XPRODIKQ          is connected                                
         JNE   UPDACX06                                                         
         TM    AC_IND2,AC_IAPPR    Only send email addresses if                 
         JNZ   *+12                draft or approved this time                  
         TM    AC_IND2,AC_IDRFT                                                 
         JZ    UPDACX08                                                         
*                                                                               
UPDACX06 XR    R0,R0                                                            
         ICM   R0,3,LP_QMAPN   Send approver run sequence                       
         GOTOR AALINKIO,DMCB,('LIOAPUT',LP_ALIOB),('LIOTMAP',(R0))              
         GOTOR (RF),(R1),('LIOAPUT',LP_ALIOB),('LIOTRUN',A#JAPP)                
                                                                                
         GOTOR (RF),(R1),('LIOAPUT',LP_ALIOB),('LIOTRAW',D#ACT4A),     +        
               ('LD_CHARQ',OA_ACT),(L'OA_ACT,0)                                 
         GOTOR (RF),(R1),('LIOAPUT',LP_ALIOB),('LIOTRAW',D#OFF4A),     +        
               ('LD_CHARQ',AC_OFF),(L'AC_OFF,0)                                 
         GOTOR (RF),(R1),('LIOAPUT',LP_ALIOB),('LIOTERU',0),0,0                 
                                                                                
UPDACX08 TM    AC_IND2,AC_IAPPR    Approved this time                           
         JZ    UPDACX20            No                                           
         L     R1,AGOXBLCK         Yes                                          
         USING GOXBLKD,R1                                                       
         CLI   GONTJA,YESQ         Notify team when approved                    
         JNE   UPDACX20            No                                           
         DROP  R1                                                               
         GOTOR (#SEMAIL,ASEMAIL),DMCB,AC_OFF,=AL1(SE#JOBS)                      
         JNE   UPDACX20            Emails not allowed for agency/office         
         GOTOR GETTEAM             Get team info for account                    
         SR    R0,R0                                                            
         ICM   R0,3,LP_QMAPN                                                    
         GOTOR AALINKIO,DMCB,('LIOAPUT',LP_ALIOB),('LIOTMAP',(R0))              
                                                                                
         GOTOR (RF),(R1),('LIOAPUT',LP_ALIOB),('LIOTRUN',A#TEAP)                
                                                                                
         MVI   BYTE1,C'7'                                                       
         GOTOR (RF),(R1),('LIOAPUT',LP_ALIOB),('LIOTRAW',D#CAE),       +        
               ('LD_CHARQ',BYTE1),(L'BYTE1,0)                                   
                                                                                
         GOTOR (RF),(R1),('LIOAPUT',LP_ALIOB),('LIOTERU',0),0,0                 
                                                                                
         J     UPDACX20                                                         
*                                                                               
UPDACX10 LAY   R2,ERRTAB           Send errors                                  
         USING ET_D,R2             R2=A(Error table)                            
         SR    RF,RF                                                            
         ICM   RF,3,CUXPNUM        Check whether BrandOcean or Aura             
         CHI   RF,XPRODIKQ          is connected                                
         JNE   UPDACX12                                                         
         SR    R0,R0               Aura - send one 82 response + index          
         ICM   R0,3,LP_QMAPN       Build download map element                   
         GOTOR AALINKIO,DMCB,('LIOAPUT',LP_ALIOB),('LIOTMAP',(R0))              
         GOTOR VHEXOUT,DMCB,QA_INDEX,WORK,L'QA_INDEX                            
         GOTOR AALINKIO,DMCB,('LIOAPUT',LP_ALIOB),                     +        
               ('LIOTRAW',D#ID#),('LD_CHARQ',WORK),(L'QA_INDEX*2,0)             
*                                                                               
UPDACX12 CLI   ET_D,ET_EOTQ        Test end of error table                      
         JE    UPDACX18                                                         
*                                                                               
         LLC   RF,ERRCNT           Check for maximum number of error            
         CHI   RF,ERRMAX           messages                                     
         JNL   UPDACX18                                                         
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,CUXPNUM        Check whether BrandOcean or Aura             
         CHI   RF,XPRODIKQ          is connected                                
         JE    UPDACX14                                                         
         SR    R0,R0                                                            
         ICM   R0,3,LP_QMAPN       Build download map element                   
         GOTOR AALINKIO,DMCB,('LIOAPUT',LP_ALIOB),('LIOTMAP',(R0))              
*                                                                               
UPDACX14 CLI   QA_UPLD,QA_ACCTL    Only for account upload/mediahub             
         JNE   UPDACX15            return index for each error message          
         GOTOR VHEXOUT,DMCB,QA_INDEX,WORK,L'QA_INDEX                            
         GOTOR AALINKIO,DMCB,('LIOAPUT',LP_ALIOB),                     +        
               ('LIOTRAW',D#ID#),('LD_CHARQ',WORK),(L'QA_INDEX*2,0)             
*                                                                               
UPDACX15 LA    R1,DMCB                                                          
         USING GETTXTD,R1          Build error text string in ELEMENT           
         XC    GTBLOCK,GTBLOCK     Resolve error text                           
         MVI   GTMAXL,80                                                        
         MVC   GTMSGNO,ET_ERRNO                                                 
         LA    R0,ELEMENT                                                       
         STCM  R0,7,GTAOUT                                                      
         MVI   GTMTYP,GTMERR                                                    
         MVI   GT1INDS,GT1NOREF+GT1OWRK                                         
         LLC   R0,ET_LN                                                         
         SHI   R0,ET_LN1Q                                                       
         LTR   R0,R0                                                            
         JZ    UPDACX16                                                         
         STC   R0,GTLTXT           Set length of extra text                     
         LA    R0,ET_EXTRA                                                      
         STCM  R0,7,GTATXT         Set A(Extra text)                            
UPDACX16 GOTOR VGETTXT,(R1)                                                     
         LLC   R0,4(R1)            Length of text just added                    
*                                                                               
         CLI   QA_UPLD,0           If not connecting as SAP,mediahub            
         JE    UPDACX1A            etc then don't show error no.                
*                                                                               
         LA    RF,ELEMENT          Put out error number                         
         AR    RF,R0                                                            
         MVI   1(RF),C'('                                                       
         MVI   2(RF),C'#'                                                       
         LLH   RE,ET_FLDNM                                                      
         CVD   RE,DUB                                                           
         UNPK  3(6,RF),DUB+5(3)                                                 
         OI    8(RF),X'F0'                                                      
         MVI   9(RF),C')'                                                       
         AHI   R0,10                                                            
*                                                                               
UPDACX1A GOTOR AALINKIO,DMCB,('LIOAPUT',LIOBD),('LIOTRAW',D#ERR),      +        
               ('LD_CHARQ',ELEMENT),((R0),0)                                    
         OC    ET_FLDNM,ET_FLDNM                                                
         JZ    UPDACX17                                                         
         GOTOR AALINKIO,(R1),('LIOAPUT',LIOBD),('LIOTRAW',D#ERROW),    +        
               ('LD_LBINQ',ET_FLDNM),(L'ET_FLDNM,0)                             
UPDACX17 LLC   R0,ET_LN            Bump to next error table entry               
         AR    R2,R0                                                            
*                                                                               
         LLC   RF,ERRCNT           Error counter                                
         AHI   RF,1                                                             
         STC   RF,ERRCNT                                                        
*                                                                               
         J     UPDACX12                                                         
         DROP  R1,R2                                                            
                                                                                
UPDACX18 TM    TWAMODE,TWAMUWD exit on all errors                               
         JZ    UPDACX20                                                         
         OI    GIND1,GIUNWIND  DDLINK will unwind/abend                         
         MVI   LP_RMODE,LP_RERRR                                                
         MVI   LP_EMSYS,6                                                       
         LA    R0,QA_VALS                                                       
         LA    R1,QA_VALSL                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
         J     UPDRECN                                                          
                                                                                
UPDACX20 LA    R0,QA_VALS                                                       
         LA    R1,QA_VALSL                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
         J     UPDRECY                                                          
         DROP  RB                                                               
         EJECT                                                                  
***********************************************************************         
* REQUEST MAP FOR ACCOUNT WORK UPLOAD                                 *         
***********************************************************************         
                                                                                
ACCUPL   LKREQ H,A#ACTU,NEWREC=Y                                                
Unit     LKREQ F,FLD001,(D,B#SAVED,QA_UNIT),CHAR,TEXT=AC#UNIT                   
Ldgr     LKREQ F,FLD002,(D,B#SAVED,QA_LDG),CHAR,TEXT=AC#LGR                     
Acc      LKREQ F,FLD003,(D,B#SAVED,QA_ACT),CHAR,TEXT=AC#ACC                     
Type     LKREQ F,FLD004,(D,B#SAVED,QA_TYPE),CHAR,TEXT=AC#TYPE                   
AppSt    LKREQ F,FLD005,(D,B#SAVED,QA_ASTAT),CHAR,TEXT=AC#STT                   
AppCmts  LKREQ F,FLD006,(D,B#SAVED,QA_ACMTL),(R,VALTXT),TEXT=AC#CMTS,  +        
               OLEN=L'QA_ACMTL+L'QA_ACMTS,LOWERCASE=Y                           
Name     LKREQ F,FLD007,(D,B#SAVED,QA_NAMEL),(R,VALTXT),TEXT=AC#NAME,  +        
               OLEN=L'QA_NAMEL+L'QA_NAME,LOWERCASE=Y                            
OverNam  LKREQ F,FLD008,(D,B#SAVED,QA_OVRNM),(R,VALTXT),TEXT=AC#OVRNM, +        
               OLEN=L'QA_OVNML+L'QA_OVRNM,LOWERCASE=Y                           
ForNam   LKREQ F,FLD009,(D,B#SAVED,QA_FNAML),(R,VALTXT),               +        
               TEXT=(*,FNAMLIT),OLEN=L'QA_FNAML+L'QA_FNAM,LOWERCASE=Y           
LngNam   LKREQ F,FLD010,(D,B#SAVED,QA_LNAML),(R,VALTXT),TEXT=AC#LGNAM, +        
               OLEN=L'QA_LNAML+L'QA_LNAM,LOWERCASE=Y                            
MShtNam  LKREQ F,FLD011,(D,B#SAVED,QA_SHNAM),CHAR,TEXT=AC#SHNAM,       +        
               LOWERCASE=Y                                                      
ClsDte   LKREQ F,FLD012,(D,B#SAVED,QA_CLDTE),PDAT,TEXT=AC#CLSDD                 
OpnDte   LKREQ F,FLD013,(D,B#SAVED,QA_OPDTE),PDAT,TEXT=AC#OPNDT                 
Master   LKREQ F,FLD014,(D,B#SAVED,QA_MAST),CHAR,TEXT=(*,MASTLIT)               
BOest    LKREQ F,FLD015,(D,B#SAVED,QA_ESTI),CHAR,TEXT=(*,ESTILIT)               
Index    LKREQ F,FLD016,(D,B#SAVED,QA_INDEX),HEXD,TEXT=AC#INDEX                 
Addr     LKREQ F,FLD017,(I,B#SAVED,QA_ADDRI),CHAR,TEXT=AC#ADR,         +        
               LIST=(F,NOSORT),OLEN=L'ADRADD1,LOWERCASE=Y,DELIM=X'FF'           
FiltNm   LKREQ F,FLD018,(I,B#SAVED,QA_FILTI),LBIN,TEXT=AC#FLT,         +        
               LIST=NOSORT,OLEN=1,ARRAY=S                                       
*&&UK                                                                           
FiltVal  LKREQ F,FLD019,,CHAR,TEXT=AC#FVALU,                           +        
               OLEN=1,ARRAY=E                                                   
*&&                                                                             
*&&US                                                                           
FiltVal  LKREQ F,FLD019,,CHAR,TEXT=AC#FVAL,                            +        
               OLEN=1,ARRAY=E                                                   
*&&                                                                             
LckSt    LKREQ F,FLD020,(D,B#SAVED,QA_LSTAT),CHAR,TEXT=AC#STT                   
ClsSt    LKREQ F,FLD021,(D,B#SAVED,QA_CSTAT),CHAR,TEXT=AC#STT                   
DeptAnl  LKREQ F,FLD022,(D,B#SAVED,QA_DANAL),CHAR,TEXT=AC#DPREA                 
MileAnl  LKREQ F,FLD023,(D,B#SAVED,QA_MANAL),CHAR,TEXT=AC#MILES                 
CliAnl   LKREQ F,FLD024,(D,B#SAVED,QA_CANAL),CHAR,TEXT=(*,CANALLIT)             
StafAnl  LKREQ F,FLD025,(D,B#SAVED,QA_SANAL),CHAR,TEXT=AC#PERAN                 
PerExec  LKREQ F,FLD026,(D,B#SAVED,QA_PEXEC),CHAR,TEXT=AC#CPEXC                 
ProjCon  LKREQ F,FLD027,(D,B#SAVED,QA_PROCN),CHAR,TEXT=AC#CPC                   
Balance  LKREQ F,FLD028,(D,B#SAVED,QA_BALNC),CHAR,TEXT=AC#BALSH                 
ProfLss  LKREQ F,FLD029,(D,B#SAVED,QA_PNL),CHAR,TEXT=AC#ATFPL                   
JobAnl   LKREQ F,FLD030,(D,B#SAVED,QA_JANAL),CHAR,TEXT=AC#JANL                  
PrvVndr  LKREQ F,FLD031,(D,B#SAVED,QA_PRVEN),CHAR,TEXT=AC#PROV                  
MergInv  LKREQ F,FLD032,(D,B#SAVED,QA_MRGIN),CHAR,TEXT=AC#MRGIV                 
PayeeLk  LKREQ F,FLD033,(D,B#SAVED,QA_PAYLK),CHAR,TEXT=AC#PLOK                  
PeelCrs  LKREQ F,FLD034,(D,B#SAVED,QA_PEELC),CHAR,TEXT=AC#PRCR                  
PeelDrs  LKREQ F,FLD035,(D,B#SAVED,QA_PEELD),CHAR,TEXT=AC#PRDR                  
Secty    LKREQ F,FLD036,(D,B#SAVED,QA_SEC),LBIN,OLEN=1,TEXT=AC#SEC              
CliCos   LKREQ F,FLD037,(D,B#SAVED,QA_CLCST),CHAR,TEXT=AC#CLICO                 
JLEst    LKREQ F,FLD038,(D,B#SAVED,QA_JLEST),CHAR,TEXT=AC#OP205                 
JLOrd    LKREQ F,FLD039,(D,B#SAVED,QA_JLORD),CHAR,TEXT=AC#OP206                 
JLBil    LKREQ F,FLD040,(D,B#SAVED,QA_JLBIL),CHAR,TEXT=AC#OP207                 
JLTim    LKREQ F,FLD041,(D,B#SAVED,QA_JLTIM),CHAR,TEXT=AC#OP208                 
JLAdj    LKREQ F,FLD042,(D,B#SAVED,QA_JLADJ),CHAR,TEXT=AC#OP209                 
JLExt    LKREQ F,FLD043,(D,B#SAVED,QA_JLEXT),CHAR,TEXT=AC#OP210                 
Excl     LKREQ F,FLD044,(D,B#SAVED,QA_EXCL),CHAR,TEXT=AC#EXCL                   
DskPrir  LKREQ F,FLD045,(D,B#SAVED,QA_DSKPR),CHAR,TEXT=(*,DSKPLIT)              
InputVT  LKREQ F,FLD046,(D,B#SAVED,QA_INVAT),CHAR,TEXT=AC#VATI                  
SndryCr  LKREQ F,FLD047,(D,B#SAVED,QA_SUNCR),CHAR,TEXT=AC#SUNCR                 
InvReg   LKREQ F,FLD048,(D,B#SAVED,QA_INVRG),CHAR,TEXT=AC#INVRG                 
FrcePr   LKREQ F,FLD049,(D,B#SAVED,QA_FRPRO),CHAR,TEXT=AC#OP172                 
FrceJb   LKREQ F,FLD050,(D,B#SAVED,QA_FRJOB),CHAR,TEXT=AC#OP173                 
DfltWC   LKREQ F,FLD051,(D,B#SAVED,QA_DEFWC),CHAR,TEXT=AC#WC                    
GLOff    LKREQ F,FLD052,(D,B#SAVED,QA_GLOFC),CHAR,TEXT=AC#RSGLO                 
GLAcc    LKREQ F,FLD053,(D,B#SAVED,QA_GLACC),CHAR,TEXT=AC#RSGLA                 
VAT      LKREQ F,FLD054,(D,B#SAVED,QA_VATL),(R,VALTXT),TEXT=AC#TAXNO,  +        
               OLEN=L'QA_VAT+L'QA_VATL                                          
NICProf  LKREQ F,FLD055,(D,B#SAVED,QA_NICP),CHAR,TEXT=(*,NICPLIT)               
ForUsr   LKREQ F,FLD056,(D,B#SAVED,QA_FUSR),CHAR,TEXT=(*,FUSRLIT)               
AcCur    LKREQ F,FLD057,(D,B#SAVED,QA_ACCCU),CHAR,TEXT=AC#CURRC                 
LoclCur  LKREQ F,FLD058,(D,B#SAVED,QA_LOCCU),CHAR,TEXT=AC#LCLCU                 
KSVTyp   LKREQ F,FLD059,(D,B#SAVED,QA_KSVTY),CHAR,TEXT=AC#KSVTY                 
VATcod13 LKREQ F,FLD060,(D,B#SAVED,QA_13VTL),(R,VALTXT),TEXT=AC#13VAT, +        
               OLEN=L'QA_13VAT+L'QA_13VTL                                       
VATcod   LKREQ F,FLD061,(D,B#SAVED,QA_VATCL),(R,VALTXT),TEXT=AC#VATC1, +        
               OLEN=L'QA_VATCD+L'QA_VATCL                                       
TAX      LKREQ F,FLD062,(D,B#SAVED,QA_TAXL),(R,VALTXT),TEXT=AC#RSVNA,  +        
               OLEN=L'QA_TAXL+L'QA_TAX,LOWERCASE=Y                              
Email    LKREQ F,FLD063,(D,B#SAVED,QA_EMALL),(R,VALTXT),TEXT=AC#EMAIL, +        
               OLEN=L'QA_EMALL+L'QA_EMAIL,LOWERCASE=Y                           
DskComt  LKREQ F,FLD064,(D,B#SAVED,QA_DSKCL),(R,VALTXT),               +        
               TEXT=(*,DSKCLIT),OLEN=L'QA_DSKCL+L'QA_DSKCM,LOWERCASE=Y,+        
               DELIM=X'FF'                                                      
Telephn  LKREQ F,FLD065,(D,B#SAVED,QA_TELEL),(R,VALTXT),TEXT=AC#TELE,  +        
               OLEN=L'QA_TELEL+L'QA_TELE,LOWERCASE=Y                            
MainCon  LKREQ F,FLD066,(D,B#SAVED,QA_MNCNL),(R,VALTXT),TEXT=AC#MNCON, +        
               OLEN=L'QA_MNCNL+L'QA_MNCON,LOWERCASE=Y,DELIM=X'FF'               
Fax      LKREQ F,FLD067,(D,B#SAVED,QA_FAXL),(R,VALTXT),TEXT=AC#FAX,    +        
               OLEN=L'QA_FAXL+L'QA_FAX,LOWERCASE=Y                              
RefNm    LKREQ F,FLD068,(D,B#SAVED,QA_REFNL),(R,VALTXT),TEXT=AC#REFN,  +        
               OLEN=L'QA_REFNL+L'QA_REFNM,LOWERCASE=Y                           
BkAuth   LKREQ F,FLD069,(D,B#SAVED,QA_BAUTL),(R,VALTXT),TEXT=AC#IBAU,  +        
               OLEN=L'QA_BAUTH+L'QA_BAUTL,LOWERCASE=Y                           
Entity   LKREQ F,FLD070,(D,B#SAVED,QA_ENTYL),(R,VALTXT),TEXT=AC#ENTY,  +        
               OLEN=L'QA_ENTYL+L'QA_ENTTY,LOWERCASE=Y                           
BSroll   LKREQ F,FLD071,(D,B#SAVED,QA_BSRL),(R,VALTXT),TEXT=AC#BSRN,   +        
               OLEN=L'QA_BSRL+L'QA_BSRLL,LOWERCASE=Y                            
CrCard   LKREQ F,FLD072,(D,B#SAVED,QA_CRCRL),(R,VALTXT),TEXT=AC#CRCRD, +        
               OLEN=L'QA_CRCRL+L'QA_CRCRD,LOWERCASE=Y                           
OnMemo   LKREQ F,FLD073,(D,B#SAVED,QA_OMEML),(R,VALTXT),TEXT=AC#ONLM,  +        
               OLEN=L'QA_OMEML+L'QA_OMEMO,LOWERCASE=Y                           
CrLmEx   LKREQ F,FLD074,(D,B#SAVED,QA_CREXT),SPAK,TEXT=AC#CRLIM                 
CrLmIn   LKREQ F,FLD075,(D,B#SAVED,QA_CRINT),SPAK,TEXT=AC#ICRLM                 
Fee      LKREQ F,FLD076,(D,B#SAVED,QA_FEE),SPAK,TEXT=AC#FEE                     
DisRt    LKREQ F,FLD077,(D,B#SAVED,QA_DISRL),(R,VALTXT),TEXT=AC#DSCRT, +        
               OLEN=L'QA_DISRL+L'QA_DISRT                                       
VATRte   LKREQ F,FLD078,(D,B#SAVED,QA_VATRL),(R,VALTXT),TEXT=AC#VATRT, +        
               OLEN=L'QA_VATRL+L'QA_VATRT                                       
DueDte   LKREQ F,FLD079,(D,B#SAVED,QA_DDTEL),(R,VALTXT),TEXT=AC#DUEDT, +        
               OLEN=L'QA_DDTE+L'QA_DDTEL                                        
Descrp   LKREQ F,FLD080,(I,B#SAVED,QA_DESCI),(R,VALTXT),TEXT=AC#DESC,  +        
               LIST=(F,NOSORT),OLEN=L'JLDDESC+1,LOWERCASE=Y,DELIM=X'FF'         
Comment  LKREQ F,FLD081,(I,B#SAVED,QA_COMMI),(R,VALTXT),TEXT=AC#CMTS,  +        
               LIST=(F,NOSORT),OLEN=L'SCMTEXT+1,LOWERCASE=Y,DELIM=X'FF'         
UsrCode  LKREQ F,FLD082,(I,B#SAVED,QA_USRI),CHAR,TEXT=AC#RSUSF,        +        
               LIST=NOSORT,OLEN=2,ARRAY=S                                       
UsrData  LKREQ F,FLD083,,(R,VALTXT),TEXT=AC#RSUSF,                     +        
               OLEN=80,ARRAY=E                                                  
Role     LKREQ F,FLD084,(I,B#SAVED,QA_ROLI),LBIN,TEXT=AC#RLNUM,        +        
               LIST=NOSORT,OLEN=2,ARRAY=S                                       
PIN      LKREQ F,FLD085,,HEXD,TEXT=AC#CPIDN,                           +        
               OLEN=L'PIDNO                                                     
RoleLvl  LKREQ F,FLD086,,CHAR,TEXT=AC#DEBLS,                           +        
               OLEN=1,ARRAY=E                                                   
POrdNum  LKREQ F,FLD087,(I,B#SAVED,QA_PORDI),CHAR,TEXT=AC#CLISQ,       +        
               LIST=NOSORT,OLEN=20,ARRAY=S,DELIM=X'FF'                          
POrdAmt  LKREQ F,FLD088,,SPAK,TEXT=AC#ORDAM,                           +        
               OLEN=L'TRNAMNT,ARRAY=E                                           
LnkCli   LKREQ F,FLD089,(I,B#SAVED,QA_LJBI),CHAR,TEXT=AC#CLIC,         +        
               LIST=NOSORT,OLEN=L'CPJCLI,ARRAY=S                                
LnkPro   LKREQ F,FLD090,,CHAR,TEXT=AC#PROC,                            +        
               OLEN=L'CPJPRO                                                    
LnkJob   LKREQ F,FLD091,,CHAR,TEXT=AC#JOBC,                            +        
               OLEN=L'CPJJOB,ARRAY=E                                            
Other    LKREQ F,FLD092,(I,B#SAVED,QA_OTHRI),CHAR,TEXT=AC#OOTHI,       +        
               LIST=(F,NOSORT),OLEN=L'PPRNARRP/3,LOWERCASE=Y,          +        
               DELIM=X'FF'                                                      
Office   LKREQ F,FLD093,(D,B#SAVED,QA_OFFC),CHAR,TEXT=AC#OFFC                   
BilGrp   LKREQ F,FLD094,(D,B#SAVED,QA_BILGR),CHAR,TEXT=AC#BLGGP                 
PrntBil  LKREQ F,FLD095,(D,B#SAVED,QA_PRTBL),CHAR,TEXT=AC#PROBL                 
DrAcc    LKREQ F,FLD096,(D,B#SAVED,QA_DRACL),(R,VALTXT),TEXT=AC#RCVA,  +        
               OLEN=L'QA_DRACL+L'QA_DRACT                                       
DrAccNm  LKREQ F,FLD097,(D,B#SAVED,QA_DRNML),(R,VALTXT),               +        
               TEXT=(*,DRNMLIT),OLEN=L'QA_DRNAM+L'QA_DRNML                      
DrAccLv  LKREQ F,FLD098,(D,B#SAVED,QA_DRLVL),CHAR,TEXT=(*,DRLVLIT)              
CsAcc    LKREQ F,FLD099,(D,B#SAVED,QA_CSACL),(R,VALTXT),TEXT=AC#CSTA,  +        
               OLEN=L'QA_CSACL+L'QA_CSACT                                       
CsAccNm  LKREQ F,FLD100,(D,B#SAVED,QA_CSNML),(R,VALTXT),               +        
               TEXT=(*,CSNMLIT),OLEN=L'QA_CSNAM+L'QA_CSNML                      
CsAccLv  LKREQ F,FLD101,(D,B#SAVED,QA_CSLVL),CHAR,TEXT=(*,CSLVLIT)              
BkChgAc  LKREQ F,FLD102,(D,B#SAVED,QA_BCHAC),CHAR,TEXT=AC#BNKCH                 
BkChgNm  LKREQ F,FLD103,(D,B#SAVED,QA_BCHNL),(R,VALTXT),               +        
               TEXT=(*,BCHNMLIT),OLEN=L'QA_BCHNM+L'QA_BCHNL                     
ExDifAc  LKREQ F,FLD104,(D,B#SAVED,QA_EXDAC),CHAR,TEXT=AC#EXCAC                 
ExDifNm  LKREQ F,FLD105,(D,B#SAVED,QA_EXDNL),(R,VALTXT),               +        
               TEXT=(*,EXCNMLIT),OLEN=L'QA_EXDNM+L'QA_EXDNL                     
AnaAc    LKREQ F,FLD106,(D,B#SAVED,QA_ANAAC),CHAR,TEXT=AC#ANACC                 
AnaNam   LKREQ F,FLD107,(D,B#SAVED,QA_ANANL),(R,VALTXT),               +        
               TEXT=(*,ANANMLIT),OLEN=L'QA_ANANM+L'QA_ANANL                     
DisAc    LKREQ F,FLD108,(D,B#SAVED,QA_DISAC),CHAR,TEXT=AC#DISAC                 
DisNam   LKREQ F,FLD109,(D,B#SAVED,QA_DISNL),(R,VALTXT),               +        
               TEXT=(*,DISNMLIT),OLEN=L'QA_DISNM+L'QA_DISNL                     
MCli     LKREQ F,FLD110,(D,B#SAVED,QA_MCLI),CHAR,TEXT=(*,MCLILIT)               
MPro     LKREQ F,FLD111,(D,B#SAVED,QA_MPRO),CHAR,TEXT=(*,MPROLIT)               
MJob     LKREQ F,FLD112,(D,B#SAVED,QA_MJOB),CHAR,TEXT=AC#RSMJC                  
Fctor    LKREQ F,FLD113,(D,B#SAVED,QA_FACTR),CHAR,TEXT=AC#FACC                  
FctorNa  LKREQ F,FLD114,(D,B#SAVED,QA_FACNL),(R,VALTXT),TEXT=AC#FACC,  +        
               OLEN=L'QA_FACNM+L'QA_FACNL                                       
2PAcc    LKREQ F,FLD115,(D,B#SAVED,QA_2PACC),CHAR,TEXT=(*,TWOPLIT)              
2PNam    LKREQ F,FLD116,(D,B#SAVED,QA_2PNML),(R,VALTXT),               +        
               TEXT=(*,TWOPNLIT),OLEN=L'QA_2PNAM+L'QA_2PNML                     
2DAcc    LKREQ F,FLD117,(D,B#SAVED,QA_2DACC),CHAR,TEXT=(*,TWODLIT)              
2DNam    LKREQ F,FLD118,(D,B#SAVED,QA_2DNML),(R,VALTXT),               +        
               TEXT=(*,TWODNLIT),OLEN=L'QA_2DNAM+L'QA_2DNML                     
InAcc    LKREQ F,FLD119,(D,B#SAVED,QA_INAC),CHAR,TEXT=(*,INCOLIT)               
InNam    LKREQ F,FLD120,(D,B#SAVED,QA_INNML),(R,VALTXT),               +        
               TEXT=(*,INCONLIT),OLEN=L'QA_INNAM+L'QA_INNML                     
WrAcc    LKREQ F,FLD121,(D,B#SAVED,QA_WRAC),CHAR,TEXT=AC#WRTFA                  
WrNam    LKREQ F,FLD122,(D,B#SAVED,QA_WRNML),(R,VALTXT),               +        
               TEXT=(*,WRITNLIT),OLEN=L'QA_WRNAM+L'QA_WRNML                     
PIDCr    LKREQ F,FLD123,(D,B#SAVED,QA_PIDCR),HEXD,TEXT=AC#CPIDN                 
ExpAcc   LKREQ F,FLD124,(D,B#SAVED,QA_EXPAC),CHAR,TEXT=AC#EXPA                  
ExpNam   LKREQ F,FLD125,(D,B#SAVED,QA_EXPNL),(R,VALTXT),TEXT=AC#EXPA,  +        
               OLEN=L'QA_EXPNM+L'QA_EXPNL                                       
BnkSort  LKREQ F,FLD126,(D,B#SAVED,QA_BSRTL),(R,VALTXT),TEXT=AC#BNKSC, +        
               OLEN=L'QA_BSRTL+L'QA_BSORT                                       
BnkAcc   LKREQ F,FLD127,(D,B#SAVED,QA_BACT),CHAR,TEXT=AC#BNKA                   
BnkAcNm  LKREQ F,FLD128,(D,B#SAVED,QA_BACNL),(R,VALTXT),TEXT=AC#BNKNM, +        
               OLEN=L'QA_BACNL+L'QA_BACNM                                       
BnkNam   LKREQ F,FLD129,(D,B#SAVED,QA_BNAML),(R,VALTXT),TEXT=AC#BNKNA, +        
               OLEN=L'QA_BNAML+L'QA_BNAME                                       
Paymthd  LKREQ F,FLD130,(D,B#SAVED,QA_PYMTH),CHAR,TEXT=AC#PAYME                 
AlAcAds  LKREQ F,FLD131,(D,B#SAVED,QA_ACADD),CHAR,TEXT=AC#ALLAC                 
Xjob     LKREQ F,FLD132,(D,B#SAVED,QA_XJOB),CHAR,TEXT=AC#XJOB                   
NewMed   LKREQ F,FLD133,(D,B#SAVED,QA_NMED),CHAR,TEXT=AC#MED                    
NewPro   LKREQ F,FLD134,(D,B#SAVED,QA_NPRO),CHAR,TEXT=AC#PROC                   
NewJob   LKREQ F,FLD135,(D,B#SAVED,QA_NJOB),CHAR,TEXT=AC#JOBC                   
Upload   LKREQ F,FLD136,(D,B#SAVED,QA_UPLD),CHAR,TEXT=AC#3PRTY                  
ISOCtry  LKREQ F,FLD137,(D,B#SAVED,QA_CTRY),CHAR,TEXT=AC#CTRYC                  
IBAN     LKREQ F,FLD138,(D,B#SAVED,QA_IBANL),(R,VALTXT),TEXT=AC#IBAN,  +        
               OLEN=L'QA_IBANL+L'QA_IBAN                                        
BIC      LKREQ F,FLD139,(D,B#SAVED,QA_BICL),(R,VALTXT),TEXT=AC#BIC,    +        
               OLEN=L'QA_BICL+L'QA_BIC                                          
*&&UK                                                                           
EUSG     LKREQ F,FLD140,(D,B#SAVED,QA_EUSGL),(R,VALTXT),TEXT=AC#EUSGC, +        
               OLEN=L'QA_EUSGL+L'QA_EUSG                                        
NON-EU   LKREQ F,FLD141,(D,B#SAVED,QA_NESGL),(R,VALTXT),TEXT=AC#NESGC, +        
               OLEN=L'QA_NESGL+L'QA_NESG                                        
*&&                                                                             
MEDACCR  LKREQ F,FLD142,(D,B#SAVED,QA_MAACL),(R,VALTXT),TEXT=AC#SGMAA, +        
               OLEN=L'QA_MAACL+L'QA_MAAC                                        
GAPon    LKREQ F,FLD143,(D,B#SAVED,QA_GAPYN),CHAR,TEXT=AC#GAPST                 
AckQue   LKREQ F,FLD144,(D,B#SAVED,QA_GAPAQ),CHAR,TEXT=AC#ACKQ                  
FutuTim  LKREQ F,FLD145,(D,B#SAVED,QA_FUTIM),CHAR,TEXT=AC#FUTA                  
*&&UK                                                                           
VATRegn  LKREQ F,FLD146,(D,B#SAVED,QA_VTRGL),(R,VALTXT),TEXT=AC#VATRE, +        
               OLEN=(L'QA_VTRGL+L'QA_VATRG)                                     
*&&                                                                             
DebtFilt LKREQ F,FLD147,(I,B#SAVED,QA_DRFLI),LBIN,TEXT=AC#FLT,         +        
               LIST=NOSORT,OLEN=1,ARRAY=S                                       
*&&UK                                                                           
FiltVal  LKREQ F,FLD148,,CHAR,TEXT=AC#FVALU,OLEN=1,ARRAY=E                      
*&&                                                                             
*&&US                                                                           
FiltVal  LKREQ F,FLD148,,CHAR,TEXT=AC#FVAL,OLEN=1,ARRAY=E                       
*&&                                                                             
CostFilt LKREQ F,FLD149,(I,B#SAVED,QA_CSFLI),LBIN,TEXT=AC#FLT,         +        
               LIST=NOSORT,OLEN=1,ARRAY=S                                       
*&&UK                                                                           
FiltVal  LKREQ F,FLD150,,CHAR,TEXT=AC#FVALU,OLEN=1,ARRAY=E                      
*&&                                                                             
*&&US                                                                           
FiltVal  LKREQ F,FLD150,,CHAR,TEXT=AC#FVAL,OLEN=1,ARRAY=E                       
*&&                                                                             
CostType LKREQ F,FLD151,(D,B#SAVED,QA_CSTTY),CHAR,TEXT=AC#CSTTP                 
*                                                                               
Clieqty  LKREQ F,FLD152,(I,B#SAVED,QA_SJEQI),CHAR,OLEN=1,              >        
               TEXT=(*,SJEQTLIT),ARRAY=S                                        
Clieqvl  LKREQ F,FLD153,,CHAR,OLEN=L'EQUKCODE,                         >        
               TEXT=(*,SJEQVLIT),ARRAY=E                                        
*                                                                               
SReqty   LKREQ F,FLD154,(I,B#SAVED,QA_SREQI),CHAR,OLEN=1,              >        
               TEXT=(*,SREQTLIT),ARRAY=S                                        
SReqvl   LKREQ F,FLD155,,CHAR,OLEN=L'EQUKCODE,                         >        
               TEXT=(*,SREQVLIT),ARRAY=E                                        
*                                                                               
PAnaly   LKREQ F,FLD156,(D,B#SAVED,QA_PANAL),CHAR,TEXT=AC#PRANA                 
Jbthrd   LKREQ F,FLD200,(D,B#SAVED,QA_THRD),CHAR,TEXT=AC#STHRD                  
*&&US                                                                           
StuCode  LKREQ F,FLD201,(D,B#SAVED,QA_STUC),CHAR,TEXT=AC#STUTY                  
StuCli   LKREQ F,FLD202,(I,B#SAVED,QA_SLJBI),CHAR,TEXT=AC#SLCLI,       +        
               LIST=NOSORT,OLEN=L'CPJCLI,ARRAY=S                                
StuPro   LKREQ F,FLD203,,CHAR,TEXT=AC#SLPRO,                           +        
               OLEN=L'CPJPRO                                                    
StuJob   LKREQ F,FLD204,,CHAR,TEXT=AC#SLJOB,                           +        
               OLEN=L'CPJJOB,ARRAY=E                                            
*&&                                                                             
                                                                                
* MEDIA VALUES                                                                  
*&&UK                                                                           
Media1   LKREQ F,FLD300,(I,B#SAVED,QA_MEDI),CHAR,TEXT=AC#MEDC,         +        
               LIST=NOSORT,OLEN=L'QI_MEDI1,ARRAY=S                              
Media2   LKREQ F,FLD301,,CHAR,OLEN=L'QI_MEDI2,TEXT=AC#MEDC                      
Media3   LKREQ F,FLD302,,CHAR,OLEN=L'QI_MEDI3,TEXT=AC#MEDC                      
Media4   LKREQ F,FLD303,,CHAR,OLEN=L'QI_MEDI4,TEXT=AC#MEDC                      
Media5   LKREQ F,FLD304,,CHAR,OLEN=L'QI_MEDI5,TEXT=AC#MEDC                      
Media6   LKREQ F,FLD305,,CHAR,OLEN=L'QI_MEDI6,TEXT=AC#MEDC                      
Media7   LKREQ F,FLD306,,CHAR,OLEN=L'QI_MEDI7,TEXT=AC#MEDC                      
Media8   LKREQ F,FLD307,,CHAR,OLEN=L'QI_MEDI8,TEXT=AC#MEDC                      
Media9   LKREQ F,FLD308,,CHAR,OLEN=L'QI_MEDI9,TEXT=AC#MEDC                      
Media10  LKREQ F,FLD309,,CHAR,OLEN=L'QI_MED10,TEXT=AC#MEDC                      
Media11  LKREQ F,FLD310,,CHAR,OLEN=L'QI_MED11,TEXT=AC#MEDC                      
Media12  LKREQ F,FLD311,,CHAR,OLEN=L'QI_MED12,TEXT=AC#MEDC                      
Media13  LKREQ F,FLD312,,CHAR,OLEN=L'QI_MED13,TEXT=AC#MEDC                      
Media14  LKREQ F,FLD313,,CHAR,OLEN=L'QI_MED14,TEXT=AC#MEDC                      
Media15  LKREQ F,FLD314,,CHAR,OLEN=L'QI_MED15,TEXT=AC#MEDC                      
Media16  LKREQ F,FLD315,,CHAR,OLEN=L'QI_MED16,TEXT=AC#MEDC                      
MBilGrp  LKREQ F,FLD316,,CHAR,OLEN=L'QI_MBLGR,TEXT=AC#BLGGP                     
MAddr1   LKREQ F,FLD317,,CHAR,OLEN=L'QI_MADD1,TEXT=AC#ORDAD                     
MAddr2   LKREQ F,FLD318,,CHAR,OLEN=L'QI_MADD2,TEXT=AC#ORDAD                     
MAddr3   LKREQ F,FLD319,,CHAR,OLEN=L'QI_MADD3,TEXT=AC#ORDAD                     
MAddr4   LKREQ F,FLD320,,CHAR,OLEN=L'QI_MADD4,TEXT=AC#ORDAD                     
MAddr5   LKREQ F,FLD355,,CHAR,OLEN=L'QI_MADD5,TEXT=AC#ORDAD                     
MComRat  LKREQ F,FLD321,,(R,VALTXT),OLEN=L'QI_MEDCL+L'QI_MEDCM,        +        
               TEXT=AC#CMNRT                                                    
MVATType LKREQ F,FLD322,,CHAR,OLEN=L'QI_MVATY,TEXT=AC#VTTYP                     
MDueDate LKREQ F,FLD323,,CHAR,OLEN=L'QI_MDUED,TEXT=AC#MEDDD                     
MBuyAgy  LKREQ F,FLD324,,LBIN,OLEN=L'QI_BUYAG,TEXT=AC#BUYAG                     
MCreaAgy LKREQ F,FLD325,,LBIN,OLEN=L'QI_CREAG,TEXT=AC#CRTAG                     
MLimAcc1 LKREQ F,FLD326,,LBIN,OLEN=L'QI_LIMA1,TEXT=AC#LAC1                      
MLimAcc2 LKREQ F,FLD327,,LBIN,OLEN=L'QI_LIMA2,TEXT=AC#LAC2                      
MFilts   LKREQ F,FLD328,,CHAR,OLEN=QI_MFLEL,TEXT=AC#MEDFL,             +        
               ENTRIES=9,ECOUNT=Y                                               
MLock    LKREQ F,FLD329,,CHAR,OLEN=L'QI_LOCK,TEXT=AC#LOCK                       
MCamRefR LKREQ F,FLD330,,CHAR,OLEN=L'QI_CMPRF,TEXT=AC#CAMRF                     
MBilComR LKREQ F,FLD331,,CHAR,OLEN=L'QI_BLCOM,TEXT=AC#BITXT                     
MOrdComR LKREQ F,FLD332,,CHAR,OLEN=L'QI_ORCOM,TEXT=AC#ORDCT                     
MGen1B   LKREQ F,FLD333,,CHAR,OLEN=L'QI_GEN1B,TEXT=AC#ME1B                      
MFormula LKREQ F,FLD334,,CHAR,OLEN=L'QI_FRMCD,TEXT=AC#FRMLA                     
MMaxBill LKREQ F,FLD335,,CHAR,OLEN=L'QI_MXAMT,TEXT=AC#MAXBL                     
MSurchge LKREQ F,FLD336,,(R,VALTXT),OLEN=L'QI_SURCL+L'QI_SURCH,        +        
               TEXT=AC#SRCRG                                                    
MCommAcc LKREQ F,FLD337,,CHAR,OLEN=L'QI_COMAC,TEXT=AC#CMNA                      
MBudCurr LKREQ F,FLD338,,CHAR,OLEN=L'QI_BDGCU,TEXT=AC#BGT                       
MBilCur  LKREQ F,FLD339,,(R,VALTXT),OLEN=L'QI_BILCU+L'QI_BILCL,        +        
               TEXT=AC#BILCU                                                    
Outsch   LKREQ F,FLD340,,CHAR,OLEN=L'QI_OUTSC,TEXT=(*,OUTSCLIT)                 
Outsbu1  LKREQ F,FLD341,,CHAR,OLEN=L'QI_OUTB1,TEXT=(*,OUTSILIT)                 
Outsbu2  LKREQ F,FLD342,,CHAR,OLEN=L'QI_OUTB2,TEXT=(*,OUTSILIT)                 
Outsbu3  LKREQ F,FLD343,,CHAR,OLEN=L'QI_OUTB3,TEXT=(*,OUTSILIT)                 
Outsbu4  LKREQ F,FLD344,,CHAR,OLEN=L'QI_OUTB4,TEXT=(*,OUTSILIT)                 
Outsbu5  LKREQ F,FLD345,,CHAR,OLEN=L'QI_OUTB5,TEXT=(*,OUTSILIT)                 
Outsbu6  LKREQ F,FLD346,,CHAR,OLEN=L'QI_OUTB6,TEXT=(*,OUTSILIT)                 
Propc    LKREQ F,FLD347,,CHAR,OLEN=L'QI_PROPC,TEXT=(*,OUTLPRO)                  
MedCom   LKREQ F,FLD348,,(R,VALTXT),OLEN=L'QI_MCOML+L'QI_MCOMM,        +        
               TEXT=(*,OUTLPRO)                                                 
CDiscB   LKREQ F,FLD349,,CHAR,OLEN=L'QI_CDISB,TEXT=AC#CSHDB                     
CDisc%   LKREQ F,FLD350,,(R,VALTXT),OLEN=L'QI_CDISL+L'QI_CDISC,        +        
               TEXT=AC#PCT                                                      
BillCom  LKREQ F,FLD351,,CHAR,OLEN=L'QI_BCOM,TEXT=AC#BILCT                      
MContact LKREQ F,FLD352,,(R,VALTXT),CHAR,OLEN=L'QI_MCONL+L'QI_MCONT,   +        
               TEXT=AC#MNCON                                                    
MTele    LKREQ F,FLD353,,(R,VALTXT),CHAR,OLEN=L'QI_MTELL+L'QI_MTELE,   +        
               TEXT=AC#TELE                                                     
MFax     LKREQ F,FLD354,,(R,VALTXT),CHAR,OLEN=L'QI_MFAXL+L'QI_MFAXN,   +        
               TEXT=AC#FAX                                                      
MTax     LKREQ F,FLD356,,(R,VALTXT),CHAR,OLEN=L'QI_MTAXL+L'QI_MTAXN,   +        
               TEXT=AC#RSVNA                                                    
POTrack  LKREQ F,FLD357,,CHAR,OLEN=L'QI_POTRK,TEXT=AC#POTRK                     
POTraap  LKREQ F,FLD358,,CHAR,OLEN=L'QI_POTRA,TEXT=AC#POTRA,ARRAY=E             
                                                                                
*  Note: Field 355 see MAddr5 above                                             
*&&                                                                             
         LKREQ E                                                                
                                                                                
         EJECT                                                                  
SVRDEF   CSECT                                                                  
***********************************************************************         
* Routines within this server                                         *         
***********************************************************************         
***********************************************************************         
* Validate text fields                                                *         
***********************************************************************         
                                                                                
VALTXT   LM    R2,R4,LP_AINP-LP_D(R5)                                           
         STC   R3,0(R4)            Returns L'Text,Text string                   
         BCTR  R3,0                                                             
         BASR  RE,0                                                             
         MVC   1(0,R4),0(R2)                                                    
         EX    R3,0(RE)                                                         
         J     EXITY                                                            
         SPACE 1                                                                
                                                                                
***********************************************************************         
* Clear work area (RC=A(Work area), R1=L'Work area)                   *         
***********************************************************************         
                                                                                
CLRWRK   STM   RE,R1,12(RD)                                                     
         LR    R0,RC                                                            
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         LM    RE,R1,12(RD)                                                     
                                                                                
***********************************************************************         
* Save error messages in an area so we can send all errors together   *         
***********************************************************************         
                                                                                
SAVERR   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*SAVERR*'                                                      
                                                                                
*                                                                               
         L     RF,ANXTERR          Address of next error in table               
         LTR   RF,RF                                                            
         JZ    SAVERR02                                                         
         LAY   RE,ERRTAB                                                        
         CLI   0(RE),ET_EOTQ      If table is empty                             
         JNE   SAVERR10                                                         
SAVERR02 LAY   RF,ERRTAB           Point to start of table                      
         XC    ALSTERR,ALSTERR                                                  
         USING ET_D,RF                                                          
SAVERR10 LLC   R0,4(R1)                                                         
         AHI   R0,ET_LN1Q          R0=Length of new entry                       
         AR    R0,RF                                                            
         LAY   RE,ERRTAB+L'ERRTAB                                               
         CR    R0,RE                                                            
         JH    SAVERR30            No room left                                 
         SR    R0,RF                                                            
         STC   R0,0(RF)            Set length of new entry                      
         OI    TWAMODE,TWAMERP     Set we have validation error                 
*                                                                               
         CLI   QA_UPLD,QA_ACCTL    If accounting upload tool force              
         JNE   *+8                 unwind and error                             
         OI    TWAMODE,TWAMUWD                                                  
*                                                                               
         LM    R2,R4,0(R1)                                                      
         MVC   ET_ERRNO,0(R2)                                                   
         MVC   ET_FLDNM,0(R4)                                                   
         SHI   R0,ET_LN1Q                                                       
         LTR   R1,R0               Test any extra text to be added              
         JZ    SAVERR20            No                                           
         SHI   R1,1                                                             
         BASR  RE,0                                                             
         MVC   ET_EXTRA(0),0(R3)   Move extra text into entry                   
         EX    R1,0(RE)                                                         
SAVERR20 ST    RF,ALSTERR          REMEMBER PREVIOUS ERROR SLOT                 
         LA    RF,ET_D+ET_LN1Q     Point to next error slot                     
         AR    RF,R0               Add length of extra text                     
         ST    RF,ANXTERR          Set A(Next entry to be added)                
         MVI   ET_D,ET_EOTQ        Set new end of table                         
         J     EXITY                                                            
                                                                                
SAVERR30 DS    0H                  Too many errors for DDLINKIO                 
         L     RF,ALSTERR          Truncate it                                  
         LA    R0,ET_LN1Q                                                       
         AR    R0,RF                                                            
         LAY   RE,ERRTAB+L'ERRTAB                                               
         CR    R0,RE                                                            
         JNH   *+6                 Room left to warn user                       
         DC    H'0'                table still too long                         
         SR    R0,RF                                                            
         STC   R0,0(RF)            Set length of new entry                      
         OI    TWAMODE,TWAMEDP     Give up now                                  
*                                                                               
         CLI   QA_UPLD,QA_ACCTL    If accounting upload tool force              
         JNE   *+8                 unwind and error                             
         OI    TWAMODE,TWAMUWD                                                  
*                                                                               
         MVC   ET_ERRNO,=AL2(AE$TMERR)                                          
         MVI   ET_LN1Q(RF),ET_EOTQ                                              
         J     EXITY                                                            
         DROP  RF                                                               
         EJECT                                                                  
***********************************************************************         
* Get account approver                                                *         
***********************************************************************         
         SPACE 1                                                                
GETAPP   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GETAPP*'                                                      
         LA    R3,0(R1)                                                         
         USING ACTKULA,R3                                                       
         XC    BYTE2,BYTE2                                                      
         MVI   AC_USRAP,NOQ                                                     
         CLC   PRODUL,QA_UNIT      Only jobs have approvals at present          
         JNE   EXITY                                                            
         L     R1,AGOXBLCK                                                      
         USING GOXBLKD,R1                                                       
         CLI   GODRFT,YESQ         Add jobs as draft - old workflow             
         JE    *+12                                                             
         CLI   GODRFT,C'D'         New workflow                                 
         JNE   EXITY               No drafts = no approvers                     
         DROP  R1                                                               
         XC    AC_APPR,AC_APPR     Clear approver and back up                   
         XC    AC_BAPPR,AC_BAPPR                                                
                                                                                
         LA    R2,APRTAB                                                        
         USING APRTABD,R2                                                       
SJ       USING JOBPASD,IOKEY       Find job, product or client approver         
GETAPP02 XC    SJ.JOBPAS,SJ.JOBPAS                                              
         MVI   SJ.JOBPTYP,JOBPTYPQ                                              
         MVI   SJ.JOBPSUB,JOBPSUBQ                                              
         MVC   SJ.JOBPCPY,CUXCPY                                                
         MVI   SJ.JOBPAPPL,JOBPAJOB                                             
         MVI   SJ.JOBPVIEW,JOBPVOFF                                             
         MVC   SJ.JOBPCOFF,SPACES                                               
         MVC   SJ.JOBPCMED,SPACES                                               
         MVC   SJ.JOBPCPJ,SPACES                                                
         OC    APRSTAT,APRSTAT                                                  
         JNZ   GETAPP04                                                         
         MVI   SJ.JOBPCODE,X'FF'                                                
         MVC   SJ.JOBPCODE+1(L'JOBPCODE-1),SJ.JOBPCODE                          
         J     GETAPP12                                                         
*                                                                               
GETAPP04 TM    APRSTAT,APRPRO                                                   
         JZ    GETAPP06                                                         
         LLC   RF,PCLILEN                                                       
         LA    RF,ACTKACT(RF)                                                   
         CLI   0(RF),X'40'         Have we got a product                        
         JNH   GETAPP18            No                                           
         LLC   RF,PPROLEN                                                       
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   SJ.JOBPCPJ(0),ACTKACT                                            
         EX    RF,0(RE)                                                         
         J     GETAPP08                                                         
GETAPP06 TM    APRSTAT,APRCLI                                                   
         JZ    GETAPP08                                                         
         LLC   RF,PCLILEN                                                       
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   SJ.JOBPCPJ(0),ACTKACT                                            
         EX    RF,0(RE)                                                         
                                                                                
GETAPP08 TM    APRSTAT,APRMED                                                   
         JZ    GETAPP10                                                         
         CLC   AC_MEDIA,SPACES                                                  
         JNH   GETAPP18                                                         
         MVC   SJ.JOBPCMED,AC_MEDIA                                             
                                                                                
GETAPP10 TM    APRSTAT,APROFF                                                   
         JZ    GETAPP12                                                         
         CLC   AC_OFF,SPACES                                                    
         JNH   GETAPP18                                                         
         MVC   SJ.JOBPCOFF,AC_OFF                                               
                                                                                
GETAPP12 GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         J     GETAPP16                                                         
                                                                                
GETAPP14 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
                                                                                
GETAPP16 CLC   SJ.JOBPAS(JOBPPIDB-JOBPASD),IOKEYSAV                             
         JE    GETAPP20                                                         
         CLI   BYTE2,1                                                          
         JE    GETAPP26                                                         
GETAPP18 LA    R2,APRTABL(R2)                                                   
         CLI   0(R2),X'FF'                                                      
         JNE   GETAPP02                                                         
         J     GETAPP28                                                         
                                                                                
GETAPP20 MVI   BYTE2,1                                                          
         TM    SJ.JOBPSTAT,JOBPDFLT                                             
         JZ    GETAPP22                                                         
         OC    AC_APPR,AC_APPR        Already found default approver            
         JNZ   GETAPP22               Yes - don't overwrite lower level         
         MVC   AC_APPR,SJ.JOBPPIDB    Default approver found                    
GETAPP22 CLC   CCTPID,SJ.JOBPPIDB     Is the connected user an approver         
         JNE   GETAPP14               No                                        
         MVI   AC_USRAP,YESQ          Yes                                       
         J     GETAPP14                                                         
         DROP  SJ                                                               
                                                                                
GETAPP26 OC    AC_APPR,AC_APPR                                                  
         JNZ   GETAPP30                                                         
                                                                                
GETAPP28 GOTOR SAVERR,DMCB,=AL2(AE$NEAPF),(5,=C'EC096'),0                       
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
AP       USING APPRECD,IOKEY                                                    
GETAPP30 XC    AP.APPKEY,AP.APPKEY                                              
         MVI   AP.APPKTYP,APPKTYPQ                                              
         MVI   AP.APPKSUB,APPKSUBQ                                              
         MVC   AP.APPKCPY,CUXCPY                                                
         MVC   AP.APPKPIDB,AC_APPR                                              
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         J     GETAPP34                                                         
GETAPP32 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
                                                                                
GETAPP34 CLC   AP.APPKEY(APPKSEQ-APPRECD),IOKEYSAV                              
         JNE   EXITY                                                            
GETAPP40 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R1,IOADDR                                                        
         AHI   R1,ACCRFST-ACCRECD                                               
         SR    R0,R0                                                            
         USING LIDELD,R1                                                        
GETAPP42 CLI   LIDEL,0             Test end of record                           
         JE    GETAPP32                                                         
         CLI   LIDEL,LIDELQ        Test end of record                           
         JE    GETAPP46                                                         
GETAPP44 IC    R0,LIDLN                                                         
         AR    R1,R0                                                            
         J     GETAPP42                                                         
                                                                                
GETAPP46 CLI   LIDTYPE,LIDTBACK                                                 
         JNE   GETAPP44                                                         
         LA    R4,LIDDATA                                                       
         USING LIDDATA,R4                                                       
         LLC   R3,LIDLN                                                         
         AR    R3,R1               R3=End of element                            
GETAPP48 TM    LIDLAPPL,LIDLJOBS                                                
         JZ    GETAPP50                                                         
         MVC   AC_BAPPR,LIDLPID    Get back up approver PID                     
         MVI   AC_USRAP,YESQ       Is the user a job approver                   
         J     EXITY                                                            
                                                                                
GETAPP50 LLC   R0,LIDITLN          Increment R4 to look at next entry           
         AR    R4,R0                                                            
         CR    R3,R4               Check we haven't reached end of el           
         JH    GETAPP48            No - check next entry                        
         J     EXITY               Yes - finish                                 
                                                                                
         DROP  R1,R4                                                            
         EJECT                                                                  
***********************************************************************         
* Get team for job record                                             *         
***********************************************************************         
         SPACE 1                                                                
GETTEAM  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GETTEAM'                                                      
         XC    BYTE1,BYTE1                                                      
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO6                                        
         L     R1,AAPPTAB                                                       
         ST    R1,AAPPTN                                                        
SJ       USING TEARECD,IOKEY       Find med, product or client approver         
         XC    SJ.TEAKEY,SJ.TEAKEY                                              
         MVI   SJ.TEAKTYP,TEAKTYPQ                                              
         MVI   SJ.TEAKSUB,TEAKSUBQ                                              
         MVC   SJ.TEAKCPY,CUXCPY                                                
         MVC   SJ.TEAKOFF,SPACES                                                
         TM    CPYSTATC,CPYSROFF                                                
         JZ    GETTM02                                                          
         MVC   SJ.TEAKOFF,AC_OFF                                                
                                                                                
GETTM02  GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         J     GETTM06                                                          
                                                                                
GETTM04  GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
                                                                                
GETTM06  CLC   SJ.TEAKEY(TEAKNUM-TEARECD),IOKEYSAV                              
         JNE   GETTM30                                                          
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
         DROP  SJ                                                               
*                                                                               
         L     R2,IOADDR                                                        
         USING TEARECD,R2          R2=A(team record)                            
         LA    R2,TEARFST                                                       
         USING LIDELD,R2                                                        
GETTM08  CLI   LIDEL,0                                                          
         JE    GETTM04                                                          
         CLI   LIDEL,LIDELQ                                                     
         JE    GETTM12                                                          
GETTM10  LLC   R0,LIDLN                                                         
         AR    R2,R0                                                            
         J     GETTM08                                                          
                                                                                
GETTM12  CLI   LIDTYPE,LIDTCPJ                                                  
         JNE   GETTM10                                                          
         MVI   BYTE1,1                                                          
         LA    R3,LIDDATA                                                       
GETTM14  XR    R1,R1                                                            
         IC    R1,LIDLN                                                         
         AR    R1,R2               R1=end of element                            
         CR    R3,R1               Ensure R3 hasn't overshot                    
         JNL   GETTM10                                                          
         LLC   RE,LDGAL1                                                        
         SHI   RE,1                                                             
         BASR  R1,0                                                             
         CLC   0(0,R3),SPACES                                                   
         EX    RE,0(R1)                                                         
         JNH   GETTM18             No account, medium only?                     
         BASR  R1,0                                                             
         CLC   0(0,R3),OA_ACT                                                   
         EX    RE,0(R1)                                                         
         JE    GETTM16                                                          
         LA    R3,L'ACTKACT(R3)                                                 
         J     GETTM14                                                          
*                                                                               
GETTM16  AHI   RE,1                RE=Length of client code                     
         LR    RF,R3                                                            
         AR    RF,RE               RF=A(product code on LIDDATA)                
         LR    R1,RE               R1=Length of client code                     
         LLC   RE,LDGAL2                                                        
         SR    RE,R1               RE=Length of product code                    
         LA    R4,OA_ACT                                                        
         AR    R4,R1               R4=A(product code on Account)                
         SHI   RE,1                                                             
         BASR  R1,0                                                             
         CLC   0(0,RF),SPACES      Have we got a product code                   
         EX    RE,0(R1)                                                         
         JE    GETTM18             No                                           
         BASR  R1,0                                                             
         CLC   0(0,RF),0(R4)       Yes - does the product match                 
         EX    RE,0(R1)                                                         
         JE    GETTM18             No                                           
         LA    R3,L'ACTKACT(R3)                                                 
         J     GETTM14                                                          
*                                                                               
GETTM18  LLC   RE,LDGAL2           RE=Length of CLI+PRO code                    
         LR    RF,R3                                                            
         AR    RF,RE               RF=A(job code on LIDDATA)                    
         CLC   0(L'AC_MEDIA,RF),SPACES                                          
         JE    GETTM20                                                          
         CLC   0(L'AC_MEDIA,RF),AC_MEDIA                                        
         JE    GETTM20             Medium match, lovely                         
         LA    R3,L'ACTKACT(R3)                                                 
         J     GETTM14                                                          
*                                                                               
GETTM20  L     R2,IOADDR                                                        
         USING TEARECD,R2          R2=A(team record)                            
         LA    R2,TEARFST                                                       
         USING LIDELD,R2                                                        
GETTM22  CLI   LIDEL,0                                                          
         JE    GETTM04                                                          
         CLI   LIDEL,LIDELQ                                                     
         JE    GETTM26                                                          
GETTM24  LLC   R0,LIDLN                                                         
         AR    R2,R0                                                            
         J     GETTM22                                                          
                                                                                
GETTM26  CLI   LIDTYPE,LIDTPID                                                  
         JNE   GETTM24                                                          
         LA    R3,LIDDATA                                                       
         L     R4,AAPPTN                                                        
GETTM28  XR    R1,R1                                                            
         IC    R1,LIDLN                                                         
         AR    R1,R2               R1=A(end of element)                         
         CR    R3,R1               Ensure R3 hasn't overshot                    
         JNL   GETTM24                                                          
         MVC   0(L'PIDKPID,R4),0(R3)                                            
         AHI   R4,3                                                             
         ST    R4,AAPPTN                                                        
         LA    R3,L'APPRPID(R3)                                                 
         J     GETTM28                                                          
                                                                                
GETTM30  J     EXITY                                                            
         EJECT                                                                  
                                                                                
***********************************************************************         
* Build New Account record                                            *         
* BUILDS STCEL STACK IN GENAEXTN (ASSUMES R4 IS INDEX) IF P1B1=0                
* PARM1 B1-3 IS 0, OR OVERRIDE IOAREA  (DEFAULT AIO3)                           
***********************************************************************         
         SPACE 1                                                                
BLDACT   NTR1  LABEL=NO,BASE=*                                                  
         J     *+12                                                             
         DC    C'*BLDACT*'                                                      
         LLC   R6,0(R1)            SAVE STCEL FLAG                              
         L     R3,0(R1)                                                         
         LTR   R3,R3                                                            
         JNZ   BLDACT05            OVERRIDE AIO                                 
         L     R3,AIO3             DEFAULT                                      
BLDACT05 DS    0H                                                               
         ST    R3,FULL1                                                         
         GOTOR (#CLRIO,ACLRIO),DMCB,(R3)                                        
         USING ACTRECD,R3                                                       
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA,OA_ULA                                                   
         MVC   ACTRLEN,=X'0039'    Set default length no elements               
         CLC   PRODUL,OA_UNT                                                    
         JE    BLDACT02                                                         
         TM    LEDGSTA2,LDGSDRFT   Add all accounts as draft                    
         JZ    BLDACT04                                                         
         TM    AC_IND2,AC_IAPPR                                                 
         JNZ   BLDACT04                                                         
         OI    ACTRSTAT,ACTSDRFT   Set account as draft                         
         OI    AC_IND2,AC_IDRFT    Build draft job                              
         J     BLDACT04                                                         
                                                                                
BLDACT02 L     R2,AGOXBLCK                                                      
         USING GOXBLKD,R2                                                       
         CLI   GODRFT,YESQ         Add jobs as draft - old workflow             
         JE    *+12                                                             
         CLI   GODRFT,C'D'         New workflow                                 
         JNE   BLDACT04                                                         
         OI    ACTRSTAT,ACTSDRFT   Set account as draft                         
         TM    AC_IND2,AC_IAPPR                                                 
         JNZ   BLDACT04                                                         
         OI    AC_IND2,AC_IDRFT    Build draft job                              
         DROP  R2                                                               
                                                                                
BLDACT04 LA    R2,ACTRFST                                                       
         TM    AC_IND2,AC_ILOW     Is it a low level account                    
         JZ    BLDACT06                                                         
         OI    ACTRSTAT,ACTSABLP   Set balance element                          
         USING ABLELD,R2                                                        
         MVI   ABLEL,ABLELQ                                                     
*        MVI   ABLLN,ABLLN2Q                                                    
         MVI   ABLLN,ABLLN3Q                                                    
         ZAP   ABLFRWD,PZERO                                                    
         ZAP   ABLDR,PZERO                                                      
         ZAP   ABLCR,PZERO                                                      
         ZAP   ABLURG,PZERO                                                     
         AHI   R2,ABLLN3Q                                                       
         USING APOELD,R2                                                        
         MVI   APOEL,APOELQ                                                     
         MVI   APOLN,APOLN1Q                                                    
         ZAP   APODR,PZERO                                                      
         ZAP   APOCR,PZERO                                                      
         AHI   R2,APOLN1Q                                                       
*                                                                               
         USING RACELD,R2                                                        
BLDACT06 MVI   RACEL,RACELQ                                                     
         MVI   RACLN,RACLNQ                                                     
         MVI   RACTYPE,RACTADD                                                  
         MVC   RACUSER,CUUSER                                                   
         MVC   RACPERS,CCTPID                                                   
         MVC   RACTERM,CUTERM                                                   
         MVC   RACDATE,AC_TODYP                                                 
         MVI   RACAPPL,RACAURAQ                                                 
         SR    RF,RF                                                            
         ICM   RF,3,CUXPNUM        Check whether BrandOcean or Aura             
         CHI   RF,XPACCUPQ         Check whether AccUpload is connected         
         JNE   *+8                                                              
         MVI   RACAPPL,RACAUPLQ                                                 
*&&UK                                                                           
         CHI   RF,XPMEDHUB         Check whether MediaHUB is connected          
         JNE   *+8                                                              
         MVI   RACAPPL,RACMHUBQ                                                 
*&&                                                                             
         MVC   RACTIME,CTIME                                                    
         AHI   R2,RACLNQ                                                        
         SR    R2,R3                                                            
         STH   R2,ACTRLEN                                                       
*                                                                               
         LTR   R6,R6               WANT STCELS?                                 
         JNZ   EXITY                                                            
         USING STCELD,R4                                                        
         XC    STCEL(STCLN13Q),STCEL                                            
         MVI   STCEL,STCELQ                                                     
         MVI   STCLN,STCLN13Q                                                   
         MVI   STCIND,STCIACT                                                   
         MVC   STCUSER,CUUSER                                                   
         MVC   STCPERS,CCTPID                                                   
         MVC   STCTERM,CUTERM                                                   
         MVC   STCDATE,AC_TODYP                                                 
         MVC   STCTIME,CTIME                                                    
         MVI   STCATYP,STCACADD                                                 
         MVI   STCASTAT,STCAADD                                                 
         OC    STCASTAT,SSTCAPL    Set application                              
         MVC   STCAULA,OA_ULA                                                   
         LA    R4,STCLN13Q(R4)                                                  
         ST    R4,SVSTCELS                                                      
         J     EXITY                                                            
         DROP  R2,R3                                                            
         EJECT                                                                  
***********************************************************************         
* Get option maintain settings                                        *         
***********************************************************************         
         SPACE 1                                                                
SETOPT   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*SETOPT*'                                                      
         L     R0,AGOBLOCB                                                      
         LHI   R1,GOBLOCKX-GOBLOCKD                                             
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         L     R0,AGOXBLCK                                                      
         LHI   R1,GOXBLKX-GOXBLOCK                                              
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         L     R0,AGOBBLCK                                                      
         LHI   R1,GOBBLKXX-GOBBLOCK                                             
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         L     R3,AGOBLOCB                                                      
         USING GOBLOCKD,R3                                                      
         MVC   GOADM,VDATAMGR                                                   
         MVC   GOAEXT,AGOXBLCK                                                  
         MVC   GOABEXT,AGOBBLCK                                                 
                                                                                
         MVC   GOSELCUL(L'CUXCPY),CUXCPY                                        
         MVC   GOSELCUL+L'ACTKCPY(L'ACTKUNT+L'ACTKLDG),PRODUL                   
         MVC   GOCTRY,CUCTRY                                                    
                                                                                
         MVC   GOSELCLI,AC_ACTL1                                                
         MVC   GOSELPRO,AC_ACTL2                                                
         OC    AC_MEDIA,AC_MEDIA                                                
         JZ    *+10                                                             
         MVC   GOSELMED,AC_MEDIA                                                
         GOTOR VGETOPT,DMCB,GOBLOCKD                                            
                                                                                
         CLI   GOPROD,YESQ         Can we add production jobs?                  
         JE    SETOPT10                                                         
         CLI   QA_ASTAT,QA_ANEW    Is this adding a job account?                
         JE    SETOPT05                                                         
         CLI   QA_ASTAT,QA_AAUTO                                                
         JNE   SETOPT10                                                         
                                                                                
SETOPT05 GOTOR SAVERR,DMCB,=AL2(AE$PRDJB),(5,=C'EC097'),0                       
         J     SETOPT20                                                         
                                                                                
SETOPT10 CLI   QA_ASTAT,QA_AAUTO                                                
         JNE   SETOPTX                                                          
         CLI   GOAUTNUM,YESQ                                                    
         JE    SETOPTX                                                          
         GOTOR SAVERR,DMCB,=AL2(AE$AUNAC),(5,=C'EC098'),0                       
                                                                                
SETOPT20 OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
                                                                                
SETOPTX  J     EXITY                                                            
         DROP  R3                                                               
***********************************************************************         
* Add namel to account record                                         *         
***********************************************************************         
         SPACE 1                                                                
ADDNAM   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDNAM*'                                                      
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   EXITY                                                            
         L     R3,AIO3                                                          
         USING ACTRECD,R3                                                       
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('NAMELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JNE   ADDNAM10                                                         
         L     R2,12(R1)                                                        
         USING NAMELD,R2                                                        
         LLC   RF,NAMLN                                                         
         SHI   RF,NAMLN1Q+1                                                     
         LLC   R1,QA_NAMEL                                                      
         SHI   R1,1                                                             
         CR    R1,RF                                                            
         JNE   ADDNAM04                                                         
         BASR  RE,0                                                             
         CLC   QA_NAME(0),NAMEREC                                               
         EX    RF,0(RE)                                                         
         JE    EXITY                                                            
ADDNAM04 GOTO1 VHELLO,DMCB,(C'D',ACCMST),('NAMELQ',ACTRECD)                     
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
ADDNAM10 GOTOR AUDNAM                                                           
         LA    R2,ELEMENT                                                       
         USING NAMELD,R2                                                        
         XR    RE,RE                                                            
         IC    RE,QA_NAMEL                                                      
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   NAMEREC(0),QA_NAME                                               
         EX    RE,0(RF)                                                         
*                                                                               
         CLI   QA_UPLD,QA_SAPTL    If we're doing upload tool                   
         JNE   AUDNAM12            make sure it is upper case                   
         BASR  RF,0                                                             
         OC    NAMEREC(0),SPACES                                                
         EX    RE,0(RF)                                                         
*                                                                               
AUDNAM12 MVI   NAMEL,NAMELQ                                                     
         AHI   RE,1+NAMLN1Q                                                     
         STC   RE,NAMLN                                                         
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,NAMELD                         
         CLI   12(R1),0                                                         
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  R2,R3                                                            
         EJECT                                                                  
***********************************************************************         
* Add adrel to account record                                         *         
***********************************************************************         
         SPACE 1                                                                
ADDADR   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDADR*'                                                      
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   EXITY                                                            
         USING ADRELD,R2                                                        
         LA    R2,ELEMENT                                                       
         XC    ELEMENT,ELEMENT                                                  
         XC    AELEMENT,AELEMENT                                                
         L     R4,AIO3                                                          
         USING ACTRECD,R4                                                       
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('ADRELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JNE   ADDADR02                                                         
         L     R3,12(R1)                                                        
         ST    R3,AELEMENT                                                      
         XR    R3,R3                                                            
         ICM   R3,7,QA_AADDR       R3=A(Uploaded address lines)                 
         JZ    ADDADR14            No data just delete                          
                                                                                
ADDADR02 XR    R3,R3                                                            
         ICM   R3,7,QA_AADDR       R3=A(Uploaded address lines)                 
         JZ    EXITY                                                            
         MVI   ADREL,ADRELQ                                                     
         XR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R3)  Number of address lines                   
         STC   R0,ADRNUM                                                        
         LR    R1,R0                                                            
         MHI   R1,L'ADRADD1                                                     
         AHI   R1,ADRLN1Q-L'ADRADD1                                             
         STC   R1,ADRLN            Work out length of element                   
         AHI   R3,LW_LN2Q          R3=A(first address line data)                
         LA    R1,ADRADD1          R1=A(first address line element)             
*                                                                               
ADDADR06 MVC   0(L'ADRADD1,R1),0(R3)                                            
         CLI   CUCTRY,CTRYGER      Germany?                                     
         JE    ADDADR07                                                         
         SR    RF,RF                                                            
         ICM   RF,3,CUXPNUM        Check whether BrandOcean or Aura             
         CHI   RF,XPRODIKQ          is connected                                
         JE    ADDADR07                                                         
         OC    0(L'ADRADD1,R1),SPACES  Allow mixed case for Aura                
ADDADR07 LA    R3,L'ADRADD1(R3)                                                 
         LA    R1,L'ADRADD1(R1)                                                 
         JCT   R0,ADDADR06         Decrement number of address lines            
*                                                                               
         CLI   QA_UPLD,QA_SAPTL    Are we running SAP tool?                     
         JNE   ADDADR10                                                         
         TM    AC_IND1,AC_INEW2+AC_INEW3 Is it product level                    
         JZ    ADDADR10                                                         
*                                                                               
         LA    R3,ADRELEMT                                                      
CLI      USING ADRELD,R3                                                        
         CLC   CLI.ADRLN,ADRLN     Check data is the same as client             
         JNE   ADDADR14                                                         
         LLC   RF,ADRNUM                                                        
ADDADR08 CLC   CLI.ADRADD1,ADRADD1 Is the address info the same?                
         JNE   ADDADR14                                                         
         LA    R3,L'ADRADD1(R3)                                                 
         LA    R2,L'ADRADD1(R2)                                                 
         JCT   RF,ADDADR08                                                      
         XC    ELEMENT,ELEMENT     Address is same as client so don't           
         OC    AELEMENT,AELEMENT   add product level address                    
         JZ    ADDADR16            No address previously                        
         J     ADDADR14            Previous address - audit this                
*                                                                               
ADDADR10 L     R3,AELEMENT                                                      
OLD      USING ADRELD,R3                                                        
         CLC   ADRLN,OLD.ADRLN     Is the length different                      
         JNE   ADDADR14            Yes - audit change                           
         LLC   RF,ADRNUM                                                        
ADDADR12 CLC   OLD.ADRADD1,ADRADD1 Is the address info the same                 
         JNE   ADDADR14                                                         
         LA    R3,L'ADRADD1(R3)                                                 
         LA    R2,L'ADRADD1(R2)                                                 
         JCT   RF,ADDADR12                                                      
         J     EXITY                                                            
         DROP  OLD                                                              
*                                                                               
ADDADR14 GOTOR AUDADR                                                           
*                                                                               
ADDADR16 OC    AELEMENT,AELEMENT                                                
         JZ    ADDADR18                                                         
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),('ADRELQ',ACTRECD)                     
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
ADDADR18 OC    ELEMENT,ELEMENT                                                  
         JZ    EXITY                                                            
         LA    R2,ELEMENT                                                       
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,ADRELD                         
         CLI   12(R1),0                                                         
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  R2,R4                                                            
         EJECT                                                                  
***********************************************************************         
* Add rstel to account record                                         *         
***********************************************************************         
         SPACE 1                                                                
ADDRST   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDRST*'                                                      
         SR    RF,RF                                                            
         ICM   RF,3,CUXPNUM        Check whether BrandOcean or Aura             
         CHI   RF,XPRODIKQ          is connected                                
         JNE   ADDRST02                                                         
         MVC   QA_EXCL,QA_JLTIM    Exclude from time is same as lock            
*                                                  in Aura                      
         USING ACTRECD,R3                                                       
         USING RSTELD,R2                                                        
ADDRST02 LA    R2,ELEMENT                                                       
         L     R3,AIO3                                                          
*&&UK*&& XC    RSTEL(RSTLN4Q),RSTEL                                             
*&&US*&& XC    RSTEL(RSTLN3Q),RSTEL                                             
         MVI   RSTEL,RSTELQ                                                     
         MVC   RSTBDATE,AC_TODYP                                                
         MVC   RSTTDATE,AC_TODYP                                                
         XC    AELEMENT,AELEMENT                                                
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('RSTELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JNE   ADDRST05                                                         
         L     R2,12(R1)                                                        
         LLC   RF,RSTLN                                                         
         BASR  RE,0                                                             
         MVC   ELEMENT(0),RSTEL                                                 
         EX    RF,0(RE)                                                         
         ST    R2,AELEMENT                                                      
*                                                                               
ADDRST05 LA    R2,ELEMENT                                                       
         CLI   QA_TYPE,QA_TSTAT   Update lock/close status                      
         JE    ADDRST10                                                         
         CLI   QA_TYPE,QA_TLOKS   Update lock bits                              
         JE    ADDRST10                                                         
         CLI   QA_TYPE,QA_TAPPR                                                 
         JE    ADDRST10                                                         
*&&UK*&& MVI   RSTLN,RSTLN4Q                                                    
*&&US*&& MVI   RSTLN,RSTLN3Q                                                    
         XC    RSTSTAT1,RSTSTAT1   Clear bit settings                           
         XC    RSTSTAT2,RSTSTAT2                                                
         XC    RSTSTAT3,RSTSTAT3                                                
         XC    RSTSTAT4,RSTSTAT4                                                
         XC    RSTSTAT5,RSTSTAT5                                                
         XC    RSTSTAT7,RSTSTAT7                                                
*                                                                               
* RSTSTAT1                                                                      
ADDRST10 NI    RSTSTAT1,X'FF'-RSTSACIL                                          
         NI    ACTRSTAT,X'FF'-ACTSLOCK                                          
*                                                                               
         CLI   QA_UPLD,QA_SAPTL    If SAP tool always add locked                
         JNE   ADDRST12                (users to complete in flist)             
         TM    AC_IND1,AC_INEW1+AC_INEW2                                        
         JNZ   ADDRST14            Doesn't need to be checked                   
*                                                                               
ADDRST12 CLI   QA_LSTAT,YESQ       Is account locked                            
         JNE   ADDRST16                                                         
         GOTOR CHKACT,CHKLOCK                                                   
         JE    ADDRST14                                                         
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
         OI    TWAMODE,TWAMUWD                                                  
         J     ADDRST16                                                         
*                                                                               
ADDRST14 OI    RSTSTAT1,RSTSACIL   Set locked status                            
         OI    ACTRSTAT,ACTSLOCK                                                
*                                                                               
ADDRST16 DS    0H                                                               
         NI    RSTSTAT1,X'FF'-RSTSACIC                                          
         NI    ACTRSTAT,X'FF'-ACTSCLOS                                          
         CLI   QA_CSTAT,YESQ       Is account closed                            
         JE    ADDRST18                                                         
*&&UK*&& GOTOR JOBEST                                                           
         J     ADDRST22                                                         
*                                                                               
ADDRST18 GOTOR CHKACT,CHKCLOS                                                   
         JE    ADDRST20                                                         
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
         OI    TWAMODE,TWAMUWD                                                  
                                                                                
ADDRST20 OI    RSTSTAT1,RSTSACIC   Set closed status                            
         OI    ACTRSTAT,ACTSCLOS                                                
*&&UK*&& GOTOR JOBEST                                                           
                                                                                
ADDRST22 CLI   QA_TYPE,QA_TSTAT   Update lock/close status                      
         JE    ADDRST50                                                         
         CLI   QA_TYPE,QA_TAPPR   Approval?                                     
         JE    ADDRST50                                                         
         CLI   QA_TYPE,QA_TLOKS   Update lock status bits                       
         JE    ADDRST40                                                         
                                                                                
         CLI   QA_DANAL,YESQ       Is account analysed for department           
         JNE   *+8                                                              
         OI    RSTSTAT1,RSTSEADD   Set analysed for dept                        
                                                                                
         CLI   QA_SANAL,YESQ       Is account analysed for staff                
         JNE   *+8                                                              
         OI    RSTSTAT1,RSTSGPEI   Set analysed for staff                       
                                                                                
         CLI   QA_PEXEC,YESQ       Is person executive                          
         JNE   *+8                                                              
         OI    RSTSTAT1,RSTSPIAE   Set person is executive                      
                                                                                
         CLI   QA_INVAT,YESQ       Is input VAT                                 
         JNE   *+8                                                              
         OI    RSTSTAT1,RSTSIVAT   Set input VAT account                        
                                                                                
         LARL  RF,VALCSG                                                        
         GOTOR (RF)                Validate costing group                       
         JNE   EXITN                                                            
                                                                                
         MVC   RSTCOSTG,QA_CANAL   Set client analysis code                     
                                                                                
         LLC   RE,QA_SEC                                                        
         STCM  RE,3,RSTSECY        Set security level                           
         CLI   CUCTRY,CTRYGER      Germany?                                     
         JE    *+10                                                             
         MVC   RSTOFFC,QA_GLOFC    Set general ledger office                    
         MVC   RSTDFTSK,QA_DEFWC   Set default workcode 1R                      
*                                                                               
* RSTFILT1/5                                                                    
         CLI   QA_UPLD,QA_SAPTL    sap skips most of this                       
         JE    ADDRST30                                                         
         MVC   RSTFILT1,SPACES     Clear filters                                
         MVC   RSTFILT2,SPACES                                                  
         MVC   RSTFILT3,SPACES                                                  
         MVC   RSTFILT4,SPACES                                                  
         MVC   RSTFILT5,SPACES                                                  
         MVC   ACTRSAF1(5*L'ACTRSAF1),SPACES                                    
                                                                                
         L     R5,AIO3             R5=A(Account record)                         
         XR    R3,R3                                                            
         ICM   R3,7,QA_AFILT       R3=A(Uploaded filters)                       
         JZ    ADDRST30            No data just delete                          
         SR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R3)  Number of filters lines                   
         AHI   R3,LW_LN2Q          R3=A(first address line data)                
ADDRST24 LA    R4,FILTTAB                                                       
         USING FILTTABD,R4                                                      
ADDRST26 CLI   FILTNUM,X'FF'                                                    
         JNE   *+6                                                              
         DC    H'0'                                                             
         CLC   FILTNUM,0(R3)                                                    
         JE    ADDRST28                                                         
         LA    R4,FILTTABL(R4)                                                  
         J     ADDRST26                                                         
*                                                                               
ADDRST28 LLC   RF,FILTDISP                                                      
         AR    RF,R2                                                            
         MVC   0(L'RSTFILT1,RF),1(R3)                                           
         LLC   RF,FILTACDI                                                      
         AR    RF,R5                                                            
         MVC   0(L'ACTRSAF1,RF),1(R3)                                           
         LA    R3,L'RSTFILT1+1(R3)                                              
         JCT   R0,ADDRST24                                                      
*                                                                               
* RSTSTAT2                                                                      
ADDRST30 CLI   QA_PAYLK,YESQ       Is payee locked                              
*&&UK*&& JNE   ADDRST32                                                         
*&&US*&& JNE   ADDRST34                                                         
         OI    RSTSTAT2,RSTSPLOK   Set payee locked                             
*&&UK                                                                           
         OC    RSTPLDAT,RSTPLDAT   Was it locked before                         
         JNZ   ADDRST34            Yes                                          
         MVC   RSTPLDAT,AC_TODYP   No - set todays date                         
         J     ADDRST34                                                         
                                                                                
ADDRST32 XC    RSTPLDAT,RSTPLDAT   Clear date if not set                        
*&&                                                                             
ADDRST34 CLI   QA_MANAL,YESQ       Is miles analysed                            
         JNE   *+8                                                              
         OI    RSTSTAT2,RSTSMILE   Set miles analysed                           
*                                                                               
* RSTSTAT3                                                                      
         CLI   QA_PEELC,YESQ       Peel/close reconciled credits                
         JNE   *+8                                                              
         OI    RSTSTAT3,RSTSPRCR                                                
                                                                                
         CLI   QA_PEELD,YESQ       Peel/close reconciled debits                 
         JNE   *+8                                                              
         OI    RSTSTAT3,RSTSPRDR                                                
                                                                                
         CLI   QA_PROCN,YESQ       Project control                              
         JNE   *+8                                                              
         OI    RSTSTAT3,RSTSPRTS   Set project control is on                    
                                                                                
         CLI   QA_BALNC,YESQ       Balance sheet account                        
         JNE   *+8                                                              
         OI    RSTSTAT3,RSTSLABS                                                
                                                                                
         CLI   QA_PNL,YESQ         Profit and loss account                      
         JNE   *+8                                                              
         OI    RSTSTAT3,RSTSLAPL                                                
*                                                                               
* RSTSTAT4                                                                      
         CLI   QA_CLCST,QA_HOUSE   House client                                 
         JNE   *+8                                                              
         OI    RSTSTAT4,RSTSCSTH                                                
                                                                                
         CLI   QA_CLCST,QA_NEWBS   New business                                 
         JNE   *+8                                                              
         OI    RSTSTAT4,RSTSCSTN                                                
                                                                                
         CLI   QA_CLCST,QA_CLINT   Regular client                               
         JNE   *+8                                                              
         OI    RSTSTAT4,RSTSCSTC                                                
                                                                                
         CLI   QA_JANAL,YESQ       Job analysis                                 
         JNE   *+8                                                              
         OI    RSTSTAT4,RSTSJREA                                                
                                                                                
         CLI   QA_MRGIN,YESQ       Merge invoices with same date/ref            
         JNE   *+8                                                              
         OI    RSTSTAT4,RSTSMSDR                                                
*                                                                               
* RSTSTAT5                                                                      
         CLI   QA_FRPRO,YESQ       Force product on timesheets 1R/1C            
         JNE   *+8                                                              
         OI    RSTSTAT5,RSTSPROD                                                
                                                                                
         CLI   QA_PANAL,YESQ       Product analysis                             
         JNE   *+8                                                              
         OI    RSTSTAT5,RSTSPREA                                                
                                                                                
         CLI   QA_FRJOB,YESQ       Force job on timesheets 1R/1C                
         JNE   *+8                                                              
         OI    RSTSTAT5,RSTSPRJB                                                
                                                                                
         CLI   QA_EXCL,YESQ        Exclude from timesheets                      
         JNE   *+8                                                              
         OI    RSTSTAT5,RSTSNOTS                                                
                                                                                
*&&UK                                                                           
         CLI   QA_SUNCR,YESQ       Sundry creditor                              
         JNE   *+8                                                              
         OI    RSTSTAT5,RSTSSUND                                                
                                                                                
         CLI   QA_PRVEN,YESQ       Provisional vendor                           
         JNE   *+8                                                              
         OI    RSTSTAT5,RSTSPROV                                                
*                                                                               
*&&                                                                             
         L     R1,AGOBLOCB         Use defaults from opt maint                  
         USING GOBLOCKD,R1                                                      
         CLI   QA_UPLD,QA_SAPTL    If SAP tool check defaults                   
         JNE   ADDRST36                                                         
         TM    AC_IND1,AC_INEW1+AC_INEW2 Is it a new account?                   
         JZ    ADDRST36                                                         
         CLI   GOTMSDEF,C'N'       Check option to see if default is            
         JNE   *+8                 not to use timesheets                        
         OI    RSTSTAT5,RSTSNOTS                                                
*                                                                               
* RSTSTAT6                                                                      
*                                                                               
ADDRST36 NI    RSTSTAT6,X'FF'-(RSTSNINV+RSTSDTOP)                               
         CLI   QA_INVRG,NOQ        Invoice register                             
         JNE   *+8                                                              
         OI    RSTSTAT6,RSTSNINV                                                
                                                                                
         CLI   QA_DSKPR,YESQ       Desktop priority                             
         JNE   *+8                                                              
         OI    RSTSTAT6,RSTSDTOP                                                
                                                                                
*&&UK                                                                           
         CLI   QA_UPLD,QA_SAPTL    If SAP tool always add locked                
         JNE   ADDRST38                                                         
         TM    AC_IND1,AC_INEW1+AC_INEW2 Is it a new account?                   
         JZ    ADDRST38                                                         
         CLI   GOATRDEF,C'N'       EXCLUDE FROM @TRACKER DEFAULT?               
         JE    *+8                                                              
         OI    RSTSTAT6,RSTSXFNP   ECXLUDE FROM @TRACKER=Y                      
*&&                                                                             
*                                                                               
* RSTSTAT7                                                                      
*                                                                               
ADDRST38 GOTOR VALSTAT7                                                         
*                                                                               
* RSTLSTAT                                                                      
*                                                                               
*&&UK                                                                           
         CLI   QA_FUSR,C' '                                                     
         JH    *+10                                                             
         MVC   QA_FUSR,GOJULDEF                                                 
*&&                                                                             
*&&US*&& MVI   QA_FUSR,C'N'        Set as default                               
         L     R1,AGOBBLCK         Use defaults from opt maint                  
         USING GOBBLKD,R1                                                       
         CLI   QA_JLEST,C' '                                                    
         JH    *+10                                                             
         MVC   QA_JLEST,GOJLDEST                                                
         CLI   QA_JLORD,C' '                                                    
         JH    *+10                                                             
         MVC   QA_JLORD,GOJLDORD                                                
         CLI   QA_JLBIL,C' '                                                    
         JH    *+10                                                             
         MVC   QA_JLBIL,GOJLDBIL                                                
         CLI   QA_JLTIM,C' '                                                    
         JH    *+10                                                             
         MVC   QA_JLTIM,GOJLDTSI                                                
         CLI   QA_JLADJ,C' '                                                    
         JH    *+10                                                             
         MVC   QA_JLADJ,GOJLDADJ                                                
         CLI   QA_JLEXT,C' '                                                    
         JH    *+10                                                             
         MVC   QA_JLEXT,GOJLDEXT                                                
         DROP  R1                                                               
                                                                                
ADDRST40 CLI   QA_JLEST,C' '                                                    
         JNH   *+20                                                             
         NI    RSTLSTAT,X'FF'-RSTLSESQ                                          
         CLI   QA_JLEST,YESQ       Locked from estimates                        
         JNE   *+8                                                              
         OI    RSTLSTAT,RSTLSESQ                                                
                                                                                
         CLI   QA_JLORD,C' '                                                    
         JNH   *+20                                                             
         NI    RSTLSTAT,X'FF'-RSTLSORQ                                          
         CLI   QA_JLORD,YESQ       Locked from orders                           
         JNE   *+8                                                              
         OI    RSTLSTAT,RSTLSORQ                                                
                                                                                
         CLI   QA_JLBIL,C' '                                                    
         JNH   *+20                                                             
         NI    RSTLSTAT,X'FF'-RSTLSBIQ                                          
         CLI   QA_JLBIL,YESQ       Locked from billing                          
         JNE   *+8                                                              
         OI    RSTLSTAT,RSTLSBIQ                                                
                                                                                
         CLI   QA_JLTIM,C' '                                                    
         JNH   *+20                                                             
         NI    RSTLSTAT,X'FF'-RSTLSTIQ                                          
         CLI   QA_JLTIM,YESQ       Locked from time                             
         JNE   *+8                                                              
         OI    RSTLSTAT,RSTLSTIQ                                                
                                                                                
         CLI   QA_JLADJ,C' '                                                    
         JNH   *+20                                                             
         NI    RSTLSTAT,X'FF'-RSTLSADQ                                          
         CLI   QA_JLADJ,YESQ       Locked from adjustments                      
         JNE   *+8                                                              
         OI    RSTLSTAT,RSTLSADQ                                                
                                                                                
         CLI   QA_JLEXT,C' '                                                    
         JNH   *+20                                                             
         NI    RSTLSTAT,X'FF'-RSTLSEXQ                                          
         CLI   QA_JLEXT,YESQ       Locked from external postings                
         JNE   *+8                                                              
         OI    RSTLSTAT,RSTLSEXQ                                                
*                                                                               
* UPDATE RECORD                                                                 
ADDRST50 L     R3,AELEMENT         R3=A(old rstel)                              
OLD      USING RSTELD,R3                                                        
         CLC   RSTEL(RSTLN3Q),OLD.RSTELD                                        
         JE    ADDRSTX                                                          
         GOTOR AUDRST,DMCB,RSTELD,OLD.RSTELD                                    
         DROP  OLD                                                              
         USING ACTRECD,R3                                                       
ADDRST55 OC    AELEMENT,AELEMENT                                                
         JZ    ADDRST60                                                         
         L     R3,AIO3                                                          
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),('RSTELQ',ACTRECD)                     
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
ADDRST60 L     R3,AIO3                                                          
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,RSTELD                         
         CLI   12(R1),0                                                         
         JE    ADDRSTX                                                          
         DC    H'0'                                                             
         DROP  R2,R3                                                            
*                                                                               
ADDRSTX  J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Maintain GAP status/RSTSTAT7                                        *         
* return set cc                                                       *         
***********************************************************************         
         SPACE 1                                                                
VALSTAT7 NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*VALST7*'                                                      
*                                                                               
         USING RSTELD,R2                                                        
         LA    R2,ELEMENT                                                       
*&&UK                                                                           
         NI    RSTSTAT7,X'FF'-(RSTGAPQY+RSTGAPQN+RSTGAPAY+RSTGAPAN+RSTS+        
               FUTM+RSTSTHRP)                                                   
*&&                                                                             
*&&US*&& NI    RSTSTAT7,X'FF'-(RSTGAPYN+RSTGAPAQ+RSTSFUTM+RSTSTHRP)             
         CLI   QA_THRD,YESQ                                                     
         JNE   *+8                                                              
         OI    RSTSTAT7,RSTSTHRP                                                
         CLI   QA_GAPYN,C' '                                                    
         JH    VSTAT705                                                         
         CLI   QA_GAPAQ,C' '                                                    
         JNH   VSTAT730            GO TO FUTURE TIME VAL                        
*                                                                               
VSTAT705 LA    RE,=C'FTXV'         ONLY CREDITORS HAVE GAP SETTINGS             
         LA    RF,4                                                             
VSTAT710 CLC   QA_LDG,0(RE)                                                     
         JE    VSTAT715                                                         
         LA    RE,1(,RE)                                                        
         JCT   RF,VSTAT710                                                      
         GOTOR SAVERR,DMCB,=AL2(AE$GAPWL),(5,=C'EC001'),0                       
         J     VSTAT720                                                         
*                                                                               
*  GAP IN USE?                                                                  
VSTAT715 DS    0H                                                               
*&&UK                                                                           
         CLI   QA_GAPYN,C' '    NO ENTRY TREAT AS NONE                          
         JNH   VSTAT720                                                         
         CLI   QA_GAPYN,NOQ                                                     
         JNE   VSTAT717                                                         
         OI    RSTSTAT7,RSTGAPQN                                                
         J     VSTAT720                                                         
VSTAT717 DS    0H                                                               
         OI    RSTSTAT7,RSTGAPQY                                                
         CLI   QA_GAPYN,YESQ                                                    
         JE    VSTAT720                                                         
         NI    RSTSTAT7,FF-(RSTGAPQY+RSTGAPQN)                                  
*&&                                                                             
*&&US                                                                           
VSTAT717 DS    0H                                                               
         OI    RSTSTAT7,RSTGAPYN                                                
         CLI   QA_GAPYN,YESQ                                                    
         JE    VSTAT720                                                         
         NI    RSTSTAT7,FF-RSTGAPYN                                             
*&&                                                                             
         GOTOR SAVERR,DMCB,=AL2(AE$GAPIU),(5,=C'EC002'),=AL2(FLD143)            
* ACNOWLEDGE/QUERY GAP?                                                         
VSTAT720 DS    0H                                                               
*&&UK                                                                           
         CLI   QA_GAPYN,C' '    NO ENTRY TREAT AS NONE                          
         JNH   VSTAT730                                                         
         CLI   QA_GAPAQ,NOQ                                                     
         JNE   VSTAT722                                                         
         OI    RSTSTAT7,RSTGAPAN                                                
         J     VSTAT730                                                         
VSTAT722 DS    0H                                                               
         OI    RSTSTAT7,RSTGAPAY                                                
         CLI   QA_GAPAQ,YESQ                                                    
         JE    VSTAT730                                                         
         NI    RSTSTAT7,FF-(RSTGAPAY+RSTGAPAN)                                  
*&&                                                                             
*&&US                                                                           
VSTAT722 DS    0H                                                               
         OI    RSTSTAT7,RSTGAPAQ                                                
         CLI   QA_GAPAQ,YESQ                                                    
         JE    VSTAT730                                                         
         NI    RSTSTAT7,FF-RSTGAPAQ                                             
*&&                                                                             
         GOTOR SAVERR,DMCB,=AL2(AE$GAPAQ),(5,=C'EC003'),=AL2(FLD144)            
* FUTURE TIME ACCOUNT?                                                          
VSTAT730 DS    0H                                                               
         NI    RSTSTAT7,X'FF'-RSTSFUTM                                          
         CLI   QA_FUTIM,C' '                                                    
         JNH   EXITY                                                            
         CLC   =C'1N',QA_UNIT                                                   
         JE    VSTAT735                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$IVFUT),(5,=C'EC004'),=AL2(FLD145)            
*                                                                               
VSTAT735 DS    0H                                                               
         CLI   QA_FUTIM,NOQ                                                     
         JE    EXITY                                                            
         OI    RSTSTAT7,RSTSFUTM                                                
         CLI   QA_FUTIM,YESQ                                                    
         JE    EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$IVBVA),(5,=C'EC005'),=AL2(FLD145)            
         J     EXITY                                                            
         DROP  R2                                                               
*                                                                               
         EJECT                                                                  
***********************************************************************         
* Check you can close/delete a Job/Account                            *         
* return set cc                                                       *         
***********************************************************************         
         SPACE 1                                                                
CHKACT   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*CHKACT*'                                                      
         CLI   QA_ASTAT,QA_ANEW    Is this a new account                        
         JE    EXITY               Yes                                          
         CLI   QA_ASTAT,QA_AAUTO                                                
         JE    EXITY               Yes                                          
         STC   R1,CHKIND                                                        
         L     R4,AIO3                                                          
         USING ACTRECD,R4                                                       
*                                                                               
         CLI   CHKIND,CHKLOCK                                                   
         JE    CHKACT46                                                         
*&&US                                                                           
         GOTOR CHKLINK            Check to see if job linked to studio          
         JNE   EXITN                                                            
*&&                                                                             
         GOTOR CHKTIM                                                           
         JNE   EXITN                                                            
*                                                                               
CHKACT08 CLI   CHKIND,CHKEXTY                                                   
         JE    CHKACT16                                                         
         GOTOR CHKUOR                                                           
         JNE   EXITN                                                            
*                                                                               
CHKACT16 GOTOR CHKUXP              Read for unapproved expense claims           
         JNE   EXITN                                                            
*                                                                               
CHKACT35 TM    AC_IND2,AC_ILOW     If not low level don't have balance          
         JZ    CHKACT46                                                         
         GOTOR CHKBAL                                                           
         JNE   EXITN                                                            
*                                                                               
CHKACT46 GOTOR CHKDTX              CHECK DRAFT TRANSACTIONS                     
         JNE   EXITN                                                            
*                                                                               
         CLC   PRODUL,ACTKUNT                                                   
         JNE   CHKACT56                                                         
         CLI   CHKIND,CHKLOCK                                                   
         JE    CHKACT50                                                         
         CLI   CHKIND,CHKCLOS                                                   
         JNE   CHKACT56                                                         
CHKACT50 GOTOR CHKINV              check pending invoices                       
         JNE   EXITN                                                            
*                                                                               
CHKACT56 CLI   CHKIND,CHKEXTY                                                   
         JE    EXITY                                                            
         CLI   CHKIND,CHKLOCK      Skip if locked                               
         JE    CHKACT58                                                         
*          NOT SURE WHAT CODE BELOW WAS MEANT TO DO                             
*        GOTO1 VHELLO,DMCB,(C'G',ACCMST),('JOBELQ',ACTRECD),0                   
*        CLI   12(R1),0                                                         
*        JE    *+6                                                              
*        DC    H'0'                                                             
*        L     R2,12(R1)                                                        
*        USING JOBELD,R2                                                        
*        MVC   JOBCDATE,AC_TODYP                                                
*                                                                               
         GOTOR CHKUBO              CHECK UNBILLED ORDERS                        
         JNE   EXITN                                                            
*                                  For lock/closed check if unapproved          
CHKACT58 CLI   CHKIND,CHKDELT      Ok to delete submitted jobs                  
         JE    EXITY                                                            
         CLC   PRODUL,ACTKUNT                                                   
         JNE   EXITY                                                            
         TM    AC_IND2,AC_ILOW     If not low level don't have balance          
         JZ    EXITY                                                            
*                                  IF CLOSING JOB CHECK IF SUBMITTED            
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('JOBELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
         L     RF,12(R1)                                                        
         USING JOBELD,RF                                                        
         TM    JOBSTA2,JOBSREJ     CHECK IF REJECTED                            
         JNZ   EXITY                                                            
         TM    ACTRSTA,ACTSDRFT    ELSE CHECK DRAFT JOB IF IT IS ERROR          
         JZ    EXITY                                                            
         MVC   ROUERRV,=AL2(AE$ACCNA)                                           
         J     EXITN                                                            
         DROP  R4,RF                                                            
         EJECT                                                                  
***********************************************************************         
* SEE IF JOB IS LINKED TO ANY STUDIO JOBS                             *         
* return set cc                                                       *         
***********************************************************************         
*&&US                                                                           
         SPACE 1                                                                
CHKLINK  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*CHKLNK*'                                                      
*                                                                               
         CLI   CHKIND,CHKDELT                                                   
         JE    CHKLNK02                                                         
         CLI   CHKIND,CHKCLOS                                                   
         JNE   EXITY                                                            
*                                                                               
CHKLNK02 L     R4,AIO3                                                          
         USING ACTRECD,R4                                                       
         USING SACRECD,R2                                                       
         LA    R2,IOKEY            Read for studio agency job code pntr         
         XC    SACKEY,SACKEY                                                    
         MVI   SACKTYP,SACKTYPQ                                                 
         MVI   SACKSUB,SACKSUBQ                                                 
         MVC   SACKCPY,CUXCPY                                                   
         MVC   SACKAJB,ACTKACT                                                  
         MVC   CSVKEY1,IOKEY                                                    
         DROP  R4                                                               
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         J     CHKLNK06                                                         
                                                                                
CHKLNK04 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
                                                                                
CHKLNK06 CLC   SACKEY((SACKAJB-SACKEY)+L'SACKAJB),CSVKEY1                       
         JNE   EXITY                                                            
         CLI   CHKIND,CHKDELT                                                   
         JNE   *+14                                                             
         MVC   ROUERRV,=AL2(AE$JLNKD) can't del job is linked to studio         
         J     EXITN                                                            
*                                                                               
         OC    SACKPO,SACKPO      Is this an order?                             
         JNZ   CHKLNK04           Yes, can't get studio job(Easily)             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R2,IOADDR                                                        
         USING ACTRECD,R2          R2=A(Acct record)                            
         LA    R2,ACTRFST                                                       
         USING RSTELD,R2                                                        
*                                                                               
CHKLNK08 CLI   RSTEL,0                                                          
         JE    CHKLNK04                                                         
         CLI   RSTEL,RSTELQ                                                     
         JE    CHKLNK10                                                         
         LLC   R0,RSTLN                                                         
         AR    R2,R0                                                            
         J     CHKLNK08                                                         
*                                                                               
CHKLNK10 TM    RSTSTAT,RSTSACIC     Is it closed                                
         JO    CHKLNK04             Check next pointer                          
*                                                                               
         MVC   ROUERRV,=AL2(AE$JLNKC) Can't close - is linked to studi          
         J     EXITN                                                            
         DROP  R2                                                               
         EJECT                                                                  
*&&                                                                             
***********************************************************************         
* Check for existing time                                                       
***********************************************************************         
         SPACE 1                                                                
CHKTIM   NTR1  BASE=*,LABEL=*                                                   
         L     R4,AIO3                                                          
         USING ACTRECD,R4                                                       
         USING TSJPASD,R2                                                       
         LA    R2,IOKEY            Read for time records                        
         XC    TSJPAS,TSJPAS                                                    
         MVC   TSJPCPY,CUXCPY                                                   
         MVI   TSJPTYP,TSJPTYPQ                                                 
         MVI   TSJPSUB,TSJPSUBQ                                                 
         MVI   TSJPVIEW,TSJPSJAQ                                                
         MVC   TSJPACT,ACTKACT                                                  
         MVC   TSJPCOFF,AC_OFF                                                  
         MVC   TSJPMED,AC_MEDIA                                                 
         MVC   CSVKEY1,IOKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         J     CHKTIM04                                                         
*                                                                               
CHKTIM02 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
*                                                                               
CHKTIM04 CLC   TSJPAS(TSJPPEDT-TSJPAS),CSVKEY1                                  
         JNE   EXITY                                                            
         TM    TSJPSTAT,TIMSDELT   Is time deleted                              
         JNZ   CHKTIM02            Get next record                              
         CLI   CHKIND,CHKDELT                                                   
         JNE   *+14                                                             
         MVC   ROUERRV,=AL2(AE$CDTIM)                                           
         J     EXITN                                                            
                                                                                
         CLI   CHKIND,CHKEXTY                                                   
         JE    CHKTIM05                                                         
         CLI   CHKIND,CHKOFFC                                                   
         JNE   CHKTIM06                                                         
CHKTIM05 MVC   ROUERRV,=AL2(AE$CTTIM)                                           
         J     EXITN                                                            
CHKTIM06 TM    TSJPSTAT,TIMSFAPP                                                
         JNZ   CHKTIM02                                                         
         MVC   ROUERRV,=AL2(AE$CCUTM)                                           
         J     EXITN                                                            
         DROP  R2,R4                                                            
         EJECT                                                                  
***********************************************************************         
* Check for unapproved orders                                         *         
***********************************************************************         
         SPACE 1                                                                
CHKUOR   NTR1  BASE=*,LABEL=*                                                   
         L     R4,AIO3                                                          
         USING ACTRECD,R4                                                       
         LA    R2,IOKEY            Read for unapproved orders                   
         USING OSJPASD,R2                                                       
         XC    IOKEY,IOKEY                                                      
         MVC   OSJPCPY,CUXCPY                                                   
         MVI   OSJPTYP,OSJPTYPQ                                                 
         MVI   OSJPSUB,OSJPSUBQ                                                 
         MVC   OSJPACT,ACTKACT                                                  
*        MVI   OSJPMEM,OSJPMNOQ                                                 
         MVC   CSVKEY1,IOKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         J     CHKUOR12                                                         
*                                                                               
CHKUOR10 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
*                                                                               
CHKUOR12 CLC   OSJPAS(OSJPMEM-OSJPAS),CSVKEY1                                   
         JNE   EXITY                                                            
         TM    OSJPSTAT,ORDSDEL+ORDSFMCH+ORDSLDEL+ORDCLOSE                      
         JNZ   CHKUOR10            Get next record                              
         CLI   CHKIND,CHKDELT                                                   
         JNE   *+14                                                             
         MVC   ROUERRV,=AL2(AE$CDORD)                                           
         J     EXITN                                                            
                                                                                
CHKUOR14 TM    OSJPSTA2,ORDSAPPR                                                
         JNZ   CHKUOR10                                                         
         MVC   ROUERRV,=AL2(AE$CCUOR)                                           
         J     EXITN                                                            
         EJECT                                                                  
***********************************************************************         
* Check for unbilled orders                                         *           
***********************************************************************         
         SPACE 1                                                                
CHKUBO   NTR1  BASE=*,LABEL=*                                                   
         L     R4,AIO3                                                          
         USING ACTRECD,R4                                                       
         USING TRNRECD,R2                                                       
CHKUBO60 LA    R2,IOKEY                                                         
         MVC   TRNKEY,ACTKEY                                                    
         MVC   CSVKEY1,IOKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         J     CHKUBO63                                                         
*                                                                               
CHKUBO62 LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
*                                                                               
CHKUBO63 CLC   TRNKEY(TRNKWORK-TRNKEY),CSVKEY1                                  
         JNE   EXITY               End of transactions                          
         CLC   TRNKCULC,SPACES                                                  
         JNH   CHKUBO62                                                         
         CLC   TRNKDATE,SPACES                                                  
         JNH   CHKUBO62                                                         
         CLC   TRNKREF,SPACES                                                   
         JNH   CHKUBO62                                                         
         CLI   CHKIND,CHKDELT                                                   
         JNE   CHKUBO65                                                         
         MVC   ROUERRV,=AL2(AE$DRFD)                                            
         J     EXITN                                                            
CHKUBO65 CLI   CHKIND,CHKOFFC                                                   
         JNE   CHKUBO66                                                         
         MVC   ROUERRV,=AL2(AE$DRFT)                                            
         J     EXITN                                                            
*                                                                               
CHKUBO66 CLC   TRNKWORK,=C'99'                                                  
         JE    CHKUBO62                                                         
         LHI   R1,IOGET+IOMST+IO2                                               
         TM    TRNKSTAT,TRNSARCH                                                
         JZ    *+8                                                              
         LHI   R1,IOGET+IOARC+IO2                                               
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R2,AIO2                                                          
         L     R0,AIO1                                                          
         LA    R1,IOLENQ                                                        
         L     RE,AIO2                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
         LA    R2,DMCB                                                          
         GOTO1 VACCEMU,DMCB,=C'NEWO',,AIO1,AIO1                                 
         L     R2,AIO2                                                          
         L     R6,AIO5                                                          
         USING PRORATAD,R6                                                      
         XC    PG$GEN(PA$VALS-PG$GEN),PG$GEN                                    
*&&UK                                                                           
         L     RF,ACOMFACS                                                      
         L     RF,CPRORATA-COMFACSD(RF)                                         
                                                                                
         GOTO1 (RF),DMCB,(X'80',AIO1),0,ACOMFACS,0,PRORATAD,0                   
*&&                                                                             
*&&US*&& GOTO1 VPRORATA,DMCB,(X'80',AIO1),0,ACOMFACS,0,(R6),0                   
         CLC   TRNKWORK,=C'**'                                                  
         JNE   CHKUBO76                                                         
         TM    CPYSTAT7,CPYSNCOB                                                
         JNZ   CHKUBO72                                                         
                                                                                
* Check status first as zero amount could be fully billed                       
                                                                                
         TM    PG$STAT,PG$FULLB    TEST ORDER IS FULLY BILLED                   
         JNZ   CHKUBO62                                                         
         CP    PA$NET,=P'0'        ZERO AMOUNT CAN'T BE FULLY BILLED            
         JE    CHKUBO72                                                         
                                                                                
         LA    RE,TRNRFST                                                       
         USING PTAELD,RE           Test if order is billed - that's ok          
CHKUBO69 LLC   R0,1(RE)                                                         
         AR    RE,R0                                                            
         CLI   0(RE),0                                                          
         JE    CHKUBO72            No billing on this order                     
         CLI   0(RE),PTAELQ                                                     
         JNE   CHKUBO69                                                         
         CLI   PTATYPE,PTATRAL                                                  
         JNE   CHKUBO69                                                         
         TM    PTASTAT1,PTASPEND                                                
         JNZ   CHKUBO62                                                         
                                                                                
CHKUBO72 MVC   CSVKEY2,TRNKEY                                                   
                                                                                
NEW      USING ORDRECD,R3                                                       
         LA    R3,IOKEY                                                         
         XC    NEW.ORDKEY,NEW.ORDKEY                                            
         MVI   NEW.ORDKTYP,ORDKTYPQ                                             
         MVC   NEW.ORDKCPY,CUXCPY                                               
         MVC   NEW.ORDKORD,TRNKREF                                              
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    CHKUBO75                                                         
         MVC   IOKEY,CSVKEY2                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         J     CHKUBO62                                                         
         DROP  NEW                                                              
*                                                                               
CHKUBO75 MVC   ROUERRV,=AL2(AE$CCOOJ)                                           
         J     EXITN                                                            
*                                                                               
CHKUBO76 L     R3,AGOBLOCB                                                      
         USING GOBLOCKD,R3                                                      
         CLI   GOBILTYP,C'C'         Is this client billing?                    
         JE    CHKUBO85              Yes, use different logic                   
                                                                                
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('TRNELQ',TRNRECD),0                   
         CLI   12(R1),0                                                         
         JNE   CHKUBO62                                                         
         L     R3,12(R1)                                                        
         USING TRNELD,R3                                                        
         TM    TRNSTAT,TRNSHOLD                                                 
         JNO   *+14                                                             
         MVC   ROUERRV,=AL2(AE$CCJHI)                                           
         J     EXITN                                                            
*&&US                                                                           
         TM    PG$STAT,PG$FULLB    TEST IS FULLY BILLED                         
         JNZ   CHKUBO62                                                         
*&&                                                                             
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('TRSELQ',TRNRECD),0                   
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R3,12(R1)                                                        
         USING TRSELD,R3                                                        
         OC    TRSUDAT,TRSUDAT       No, is it billed ?                         
         JNZ   CHKUBO62              Yes                                        
                                                                                
         TM    TRNRSTAT,X'20'        Is it a reversal ?                         
         JO    CHKUBO62              Yes - skip transactions                    
                                                                                
         CLC   TRNKULC(2),=C'SK'     Is the contra SK                           
         JNE   CHKUBO81              No                                         
         MVC   ROUERRV,=AL2(AE$CCUSK)  Yes - error                              
         J     EXITN                                                            
CHKUBO81 GOTO1 VHELLO,DMCB,(C'G',ACCMST),('SPDELQ',TRNRECD),0                   
         CLI   12(R1),0                                                         
         JNE   CHKUBO62                                                         
         L     R3,12(R1)                                                        
         USING SPDELD,R3                                                        
         CLC   SPDACCS(2),=C'SK'                                                
         JNE   CHKUBO62                                                         
         MVC   ROUERRV,=AL2(AE$CCUSK)                                           
         J     EXITN                                                            
*                                                                               
CHKUBO85 LA    R3,TRNRFST                                                       
         USING BNDELD,R3                                                        
         ZAP   AC_AMT,=P'0'                                                     
         MVI   BYTE1,0                                                          
         LR    R4,R3                                                            
CHKUBO87 LLC   R0,BNDLN                                                         
         AR    R3,R0                                                            
         CLI   0(R3),0                                                          
         JE    CHKUBO94                                                         
         CLI   0(R3),TRNELQ                                                     
         JNE   CHKUBO90                                                         
         LR    R4,R3                                                            
CHKUBO90 CLI   0(R3),BNDELQ                                                     
         JNE   CHKUBO87                                                         
*                                                                               
         CLC   BNDBNO,SPACES       Is this billed ?                             
         JNH   CHKUBO87            No, get next                                 
         MVI   BYTE1,1             set a bill was found                         
         ICM   RF,15,BNDAMNT                                                    
         CVD   RF,DUB                                                           
         AP    AC_AMT,DUB                                                       
         J     CHKUBO87                                                         
*                                                                               
         USING TRNELD,R4                                                        
CHKUBO94 CLI   BYTE1,0             test any billing found                       
         JE    CHKUBO62            no - skip                                    
         CP    AC_AMT,TRNAMNT      yes                                          
         JNE   CHKUBO97            not fully billed                             
                                                                                
         TM    PG$STAT3,PG$FULUT   FULLY UTILIZED?                              
         JO    CHKUBO62            YES                                          
         TM    TRNSTAT,X'20'         NO, IS IT A REVERSAL ?                     
         JO    CHKUBO62              YES, SKIP IT                               
                                                                                
CHKUBO97 MVC   ROUERRV,=AL2(AE$CCUCH)                                           
         J     EXITN                                                            
         DROP  R2,R3,R4,R6                                                      
         EJECT                                                                  
***********************************************************************         
* Check for unapproved EXPENSE CLAIMS                                 *         
***********************************************************************         
         SPACE 1                                                                
CHKUXP   NTR1  BASE=*,LABEL=*                                                   
         L     R4,AIO3                                                          
         USING ACTRECD,R4                                                       
         USING EXJPASD,R2                                                       
         LA    R2,IOKEY            Read for unapproved expense claims           
         XC    IOKEY,IOKEY                                                      
         MVC   EXJPCPY,CUXCPY                                                   
         MVI   EXJPTYP,EXJPTYPQ                                                 
         MVI   EXJPSUB,EXJPSUBQ                                                 
         MVI   EXJPVIEW,EXJPCLI1                                                
         TM    CPXSTAT6,CPX2LAEI   WPP workflow                                 
         JZ    *+8                 No                                           
         MVI   EXJPVIEW,EXJPCBL1                                                
         MVC   EXJPCOFF,AC_OFF                                                  
         MVC   EXJPCPJ,ACTKACT                                                  
         MVC   CSVKEY1,IOKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         J     CHKUXP20                                                         
*                                                                               
CHKUXP18 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
*                                                                               
CHKUXP20 CLC   EXJPAS(EXJPMED-EXJPAS),CSVKEY1                                   
         JNE   CHKUXP24                                                         
         TM    EXJPSTAT,EXCSDELT+EXCSLOGD Is expense claim deleted              
         JNZ   CHKUXP18            Yes - Get next record                        
         CLI   CHKIND,CHKDELT                                                   
         JNE   *+14                                                             
         MVC   ROUERRV,=AL2(AE$CDEXP)                                           
         J     EXITN                                                            
                                                                                
         CLI   CHKIND,CHKEXTY                                                   
         JE    CHKUXP21                                                         
         CLI   CHKIND,CHKOFFC                                                   
         JNE   CHKUXP22                                                         
CHKUXP21 MVC   ROUERRV,=AL2(AE$CTEXP)                                           
         J     EXITN                                                            
CHKUXP22 TM    EXJPSTAT,EXCSCOMP                                                
         JNZ   CHKUXP18                                                         
         MVC   ROUERRV,=AL2(AE$CCUEX)                                           
         J     EXITN                                                            
                                                                                
CHKUXP24 TM    CPXSTAT6,CPX2LAEI   WPP workflow                                 
         JZ    EXITY               No                                           
         MVC   IOKEY,CSVKEY1                                                    
         MVI   EXJPVIEW,EXJPCNB1                                                
         MVC   CSVKEY1,IOKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         J     CHKUXP26                                                         
*                                                                               
CHKUXP25 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
*                                                                               
CHKUXP26 CLC   EXJPAS(EXJPMED-EXJPAS),CSVKEY1                                   
         JNE   EXITY                                                            
         TM    EXJPSTAT,EXCSDELT+EXCSLOGD Is expense claim deleted              
         JNZ   CHKUXP25            Yes - Get next record                        
         CLI   CHKIND,CHKDELT                                                   
         JNE   *+14                                                             
         MVC   ROUERRV,=AL2(AE$CDEXP)                                           
         J     EXITN                                                            
                                                                                
         CLI   CHKIND,CHKEXTY                                                   
         JE    CHKUXP32                                                         
         CLI   CHKIND,CHKOFFC                                                   
         JNE   CHKUXP33                                                         
CHKUXP32 MVC   ROUERRV,=AL2(AE$CTEXP)                                           
         J     EXITN                                                            
CHKUXP33 TM    EXJPSTAT,EXCSCOMP                                                
         JNZ   CHKUXP25                                                         
         MVC   ROUERRV,=AL2(AE$CCUEX)                                           
         J     EXITN                                                            
         DROP  R2,R4                                                            
         EJECT                                                                  
***********************************************************************         
* Check account is in balance                                         *         
***********************************************************************         
         SPACE 1                                                                
CHKBAL   NTR1  BASE=*,LABEL=*                                                   
         L     R4,AIO3                                                          
         USING ACTRECD,R4                                                       
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('ABLELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,12(R1)                                                        
         USING ABLELD,R2                                                        
         CLI   CHKIND,CHKDELT                                                   
         JE    CHKBAL38                                                         
         CLI   CHKIND,CHKOFFC                                                   
         JE    CHKBAL38                                                         
         CLI   CHKIND,CHKEXTY                                                   
         JNE   CHKBAL44                                                         
CHKBAL38 CP    ABLCR,PZERO                                                      
         JNE   CHKBAL40                                                         
         CP    ABLDR,PZERO                                                      
         JE    EXITY                                                            
*                                                                               
CHKBAL40 CLI   CHKIND,CHKDELT                                                   
         JNE   *+14                                                             
         MVC   ROUERRV,=AL2(AE$CDACB)                                           
         J     EXITN                                                            
         MVC   ROUERRV,=AL2(AE$CTACB)                                           
         J     EXITN                                                            
*                                                                               
CHKBAL44 CP    ABLCR,ABLDR         Does account balance                         
         JE    EXITY               Yes                                          
         MVC   ROUERRV,=AL2(AE$CCNZR)                                           
         J     EXITN                                                            
         DROP  R2,R4                                                            
         EJECT                                                                  
***********************************************************************         
* Check for Draft transactions                                                  
***********************************************************************         
         SPACE 1                                                                
CHKDTX   NTR1  BASE=*,LABEL=*                                                   
         L     R4,AIO3                                                          
         USING ACTRECD,R4                                                       
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('ASTELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JNE   CHKDTX56                                                         
         L     R2,12(R1)                                                        
         USING ASTELD,R2                                                        
         OC    ASTDRAFT,ASTDRAFT                                                
         JZ    CHKDTX56                                                         
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('JCBELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JNE   CHKDTX50                                                         
         L     R3,12(R1)                                                        
         USING JCBELD,R3                                                        
         SR    RF,RF                                                            
         ICM   RF,7,ASTDRAFT       SET RF=#DRAFT TRANSACTIONS                   
         SR    R1,R1               SET R1=#ADVANCE BILLS                        
         ICM   R1,3,JCBADV                                                      
         CR    RF,R1                                                            
         JNH   CHKDTX56            ALL DRAFTS ARE ADVANCES                      
*                                                                               
CHKDTX50 CLI   CHKIND,CHKDELT                                                   
         JNE   CHKDTX53                                                         
         MVC   ROUERRV,=AL2(AE$DRFD)                                            
         J     EXITN                                                            
*                                                                               
CHKDTX53 CLI   CHKIND,CHKCLOS                                                   
         JNE   *+14                                                             
         MVC   ROUERRV,=AL2(AE$DRFC)                                            
         J     EXITN                                                            
         CLI   CHKIND,CHKLOCK                                                   
         JNE   *+14                                                             
         MVC   ROUERRV,=AL2(AE$DRFL)                                            
         J     EXITN                                                            
         MVC   ROUERRV,=AL2(AE$DRFT)                                            
         J     EXITN                                                            
* NO astel                                                                      
CHKDTX56 DS    0H                                                               
         J     EXITY                                                            
         DROP  R2,R4                                                            
         EJECT                                                                  
***********************************************************************         
* Check for outstanding invoices                                      *         
***********************************************************************         
         SPACE 1                                                                
CHKINV   NTR1  LABEL=*,BASE=*                                                   
         L     R4,AIO3                                                          
         USING ACTRECD,R4                                                       
         USING REBPASD,R2                                                       
         XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY                                                         
         MVI   REBPTYP,REBPTYPQ                                                 
         MVI   REBPSUB,REBPSUBQ                                                 
         MVC   REBPCPY,CUXCPY                                                   
         MVI   REBPMOD,REBPMCPJ                                                 
         MVC   REBPCPJ(L'PRODUL),PRODUL                                         
         MVC   REBPCPJ+L'PRODUL(L'ACTKACT),ACTKACT                              
         OC    REBPCPJ,SPACES                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         J     CHKINV56                                                         
CHKINV55 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO1'                               
CHKINV56 CLI   REBPTYP,REBPTYPQ      ARE WE STILL READING INVOICE PASS?         
         JNE   CHKINV65                                                         
         CLI   REBPSUB,REBPSUBQ                                                 
         JNE   CHKINV65                                                         
         CLC   REBPCPY,CUXCPY                                                   
         JNE   CHKINV65                                                         
         CLI   REBPMOD,REBPMCPJ                                                 
         JNE   CHKINV65                                                         
         CLC   PRODUL,REBPCPJ                                                   
         JNE   CHKINV55                                                         
         CLC   ACTKACT,REBPCPJ+L'PRODUL                                         
         JNE   CHKINV55                                                         
         TM    REBPSTA1,REBSACRB     SKIP IF DELETED BY ACRB OR LOGICAL         
         JNZ   CHKINV55              DELETED                                    
         TM    REBPSTA2,REBSBLDE                                                
         JNZ   CHKINV55                                                         
         TM    REBPSTA1,REBSBRAN     BRANDOCEAN?                                
         JZ    CHKINV60                                                         
         TM    REBPSTA2,REBSBREG     ERROR IF INV IS REGISTERED                 
         JNZ   CHKINV62                                                         
         J     CHKINV55                                                         
*                                                                               
CHKINV60 TM    REBPSTA2,REBSMDEL     POSTMAN SKIP MARKED TO BE DELETED          
         JNZ   CHKINV55                                                         
         TM    REBPSTA2,REBSOPEN     ERROR IF INV IS OPEN                       
         JZ    CHKINV55                                                         
*                                                                               
CHKINV62 MVC   ROUERRV,=AL2(AE$DRFC)                                            
         CLI   CHKIND,CHKLOCK      lock action?                                 
         JNE   EXITN                                                            
         MVC   ROUERRV,=AL2(AE$DRFL)                                            
         J     EXITN                                                            
*                                                                               
CHKINV65 J     EXITY                                                            
*                                                                               
         DROP  R2,R4                                                            
         EJECT                                                                  
***********************************************************************         
* Add astel to account record                                         *         
***********************************************************************         
         SPACE 1                                                                
ADDAST   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDAST*'                                                      
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   EXITY                                                            
         USING ACTRECD,R4                                                       
         USING ASTELD,R2                                                        
         LA    R2,ELEMENT                                                       
         L     R4,AIO3                                                          
         XC    ELEMENT,ELEMENT                                                  
         XC    AELEMENT,AELEMENT                                                
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('ASTELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JNE   ADDAST02                                                         
         L     R2,12(R1)                                                        
         LLC   RF,ASTLN                                                         
         BASR  RE,0                                                             
         MVC   ELEMENT(0),ASTEL                                                 
         EX    RF,0(RE)                                                         
         ST    R2,AELEMENT                                                      
ADDAST02 LA    R2,ELEMENT                                                       
         MVI   ASTEL,ASTELQ                                                     
         MVI   ASTLN,ASTLN1Q                                                    
         CLC   QA_ACCCU,=C'***'                                                 
         JNE   ADDAST04                                                         
         MVI   ASTCUR,ASTCANY                                                   
         J     *+10                                                             
ADDAST04 MVC   ASTCUR,QA_ACCCU                                                  
         XC    ASTSTAT1,ASTSTAT1                                                
         CLI   QA_LOCCU,YESQ       Local currency account                       
         JNE   *+8                                                              
         OI    ASTSTAT1,ASTSLOCL                                                
         CLI   QA_FUSR,YESQ        Account is foreign language user             
         JNE   *+8                                                              
         OI    ASTSTAT1,ASTISFOR                                                
*&&UK*&& MVC   AST13VAT,QA_13VAT                                                
*&&UK                                                                           
         CLC   QA_KSVTY,SPACES                                                  
         JNH   ADDAST06                                                         
         LA    R1,WORK                                                          
         USING CONBLKD,R1                                                       
         XC    CONBLK(CONBLKL),CONBLK                                           
         MVI   CONACTN,CONAVALQ    Validate input expression                    
         MVI   CONFLD,CONFKSV      KSV call                                     
         MVI   CONILEN,2                                                        
         LA    RF,QA_KSVTY                                                      
         STCM  RF,15,CONIADD                                                    
         MVI   CONOLEN,L'ASTKSVTY                                               
         LA    RF,ASTKSVTY                                                      
         STCM  RF,15,CONOADD                                                    
         MVC   CONCOMF,ACOMFACS    A(COMFACS)                                   
         GOTO1 VCONVERT                                                         
         JE    ADDAST06                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$NOKSV),0,=AL2(FLD059)                        
         OI    TWAMODE,TWAMUWD                                                  
         DROP  R1                                                               
*&&                                                                             
ADDAST06 OC    AELEMENT,AELEMENT                                                
         JZ    ADDAST10                                                         
         L     R3,AELEMENT         R3=A(old astel)                              
OLD      USING ASTELD,R3                                                        
         CLC   ASTEL(ASTLN1Q),OLD.ASTELD                                        
         JE    ADDAST08                                                         
         GOTOR AUDAST,DMCB,ASTELD,OLD.ASTELD                                    
         DROP  OLD                                                              
ADDAST08 GOTO1 VHELLO,DMCB,(C'D',ACCMST),('ASTELQ',ACTRECD)                     
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
ADDAST10 GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,ASTELD                         
         CLI   12(R1),0                                                         
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  R2,R4                                                            
***********************************************************************         
* Add jobel to account record                                         *         
***********************************************************************         
         SPACE 1                                                                
ADDJOB   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDJOB*'                                                      
         USING ACTRECD,R3                                                       
         L     R3,AIO3                                                          
         CLC   PRODUL,ACTKULA      Only want job el for SJ ledger acs           
         JNE   EXITY                                                            
         TM    AC_IND1,AC_INEW3+AC_ILVL3  Must be job level                     
         JZ    EXITY               Otherwise exit                               
         USING JOBELD,R2                                                        
         LA    R2,ELEMENT                                                       
         XC    ELEMENT,ELEMENT                                                  
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   ADDJOB28                                                         
         XC    AELEMENT,AELEMENT                                                
         MVI   JOBEL,JOBELQ                                                     
         MVC   JOBADATE,AC_TODYP                                                
         OI    JOBSRCES,JOBSDDLQ   DDLINK used                                  
         CLI   QA_ASTAT,QA_ANEW    Is this a new account                        
         JE    ADDJOB02            Yes                                          
         CLI   QA_ASTAT,QA_AAUTO                                                
         JNE   ADDJOB28            No                                           
         OI    JOBSRCES,JOBSAJNQ   Used auto job numbering                      
ADDJOB02 L     R4,AGOBLOCB                                                      
         USING GOBLOCKD,R4                                                      
         OI    JOBSTA1,JOBSUEST    Indicate job has unapproved estimate         
         CLI   GONEWJUN,C'Y'                                                    
         JE    ADDJOB04                                                         
         NI    JOBSTA1,X'FF'-JOBSUEST                                           
ADDJOB04 OI    JOBSTA1,JOBSNEST    No, must be new                              
*&&UK*&& CLI   GOESTTYP,C'M'       Is new BandOcean flag set?                   
*&&US*&& CLI   GOESTTYP,C'B'                                                    
         JNE   ADDJOB06            No                                           
         NI    JOBSTA1,X'FF'-JOBSNEST Yes - set BrandOcean/mcs estimate         
         OI    JOBSTA1,JOBSMCSE                                                 
ADDJOB06 OC    QA_CLDTE,QA_CLDTE                                                
         JNZ   ADDJOB12                                                         
         LH    R4,GOAUTADD                                                      
         LTR   R4,R4                                                            
         JNZ   ADDJOB08                                                         
         ICM   R4,3,CPYDJCDO                                                    
         DROP  R4                                                               
*                                                                               
ADDJOB08 GOTO1 VADDAY,DMCB,OPEN,CLOSED,(R4)                                     
         GOTO1 VDATCON,DMCB,(0,CLOSED),(1,QA_CLDTE)                             
ADDJOB12 DS    0H                                                               
*&&DO                                                                           
         CLI   GOSTUDIO,C'Y'       Is this a studio job?                        
         JNE   ADDJOB30            No                                           
         OC    GOTYPE,GOTYPE       Yes, do we have a default type?              
         JZ    ADDJOB30            No                                           
*                                                                               
         USING STURECD,R1                                                       
         LA    R1,IOKEY                                                         
         XC    STUKEY,STUKEY                                                    
         MVI   STUKTYP,STUKTYPQ                                                 
         MVI   STUKSUB,STUKSUBQ                                                 
         MVC   STUKCPY,CUXCPY                                                   
         MVC   STUKCODE,GOTYPE                                                  
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R1,AIO1                                                          
         LA    R1,STURFST                                                       
         USING STUELD,R1                                                        
ADDJOB14 CLI   STUEL,0                                                          
         JNE   ADDJOB16                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$JMNSM),0,0                                   
         OI    TWAMODE,TWAMUWD                                                  
         J     ADDJOB30                                                         
ADDJOB16 CLI   STUEL,STUELQ                                                     
         JE    ADDJOB18                                                         
         LLC   RF,STULN                                                         
         AR    R1,RF                                                            
         J     ADDJOB14                                                         
                                                                                
ADDJOB18 CLC   STUMED,AC_MEDIA     Find right media                             
         JE    ADDJOB20                                                         
         CLC   STUMED,SPACES                                                    
         JNH   ADDJOB20                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$JMNSM),0,0                                   
         OI    TWAMODE,TWAMUWD                                                  
         J     ADDJOB30                                                         
                                                                                
ADDJOB20 LLC   RF,STULN            GET LENGTH OF ELEMENT                        
         SH    RF,=Y(STUOFF-STUELD)                                             
         JNZ   ADDJOB22                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$NOSCL),0,0                                   
         OI    TWAMODE,TWAMUWD                                                  
         J     ADDJOB30                                                         
ADDJOB22 LA    R5,STUOFF                                                        
*                                                                               
ADDJOB24 CLC   2(3,R5),SPACES                                                   
         JE    ADDJOB26                                                         
         CLC   2(3,R5),OA_ACT                                                   
         JE    ADDJOB26                                                         
         LA    R5,L'STUOCLN(R5)                                                 
         SH    RF,=Y(L'STUOCLN)                                                 
         JNZ   ADDJOB24                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$NOSCL),0,0                                   
         OI    TWAMODE,TWAMUWD                                                  
         J     ADDJOB30                                                         
*                                                                               
ADDJOB26 OI    JOBSTA1,JOBSTUD                                                  
N        USING LNKEL,ELEMENT2                                                   
         XC    ELEMENT2,ELEMENT2                                                
         MVI   N.LNKEL,LNKELQ                                                   
         MVI   N.LNKLN,LNKLNQ                                                   
         MVC   N.LNKSTUD,GOTYPE                                                 
         MVC   N.LNKSTJB,OA_ACT                                                 
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,N.LNKELD                       
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
         DROP  N                                                                
*&&                                                                             
         J     ADDJOB30                                                         
                                                                                
ADDJOB28 GOTOR VHELLO,DMCB,(C'G',ACCMST),('JOBELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,12(R1)                                                        
         LLC   RF,JOBLN                                                         
         BASR  RE,0                                                             
         MVC   ELEMENT(0),JOBEL    Copy existing element                        
         EX    RF,0(RE)                                                         
         ST    R2,AELEMENT                                                      
         CLI   QA_UPLD,QA_ACCTL    Skip concurrent test for upload tool         
         JE    ADDJOB30                                                         
         CLI   QA_UPLD,QA_SAPTL                                                 
         JE    ADDJOB30                                                         
         CLC   QA_INDEX,JOBREVNO   Check for concurrent updating                
         JE    ADDJOB30            No other updates fine                        
         GOTOR SAVERR,DMCB,=AL2(AE$FATAL),0,0 Yes - error                       
         OI    TWAMODE,TWAMUWD                                                  
ADDJOB30 LA    R2,ELEMENT                                                       
         MVI   JOBLN,JOBLN3Q                                                    
*                                                                               
         CLI   QA_TYPE,QA_TUPDT    Update sets open date                        
         JNE   *+10                                                             
         MVC   JOBODATE,QA_OPDTE                                                
*                                                                               
         OC    QA_CLDTE,QA_CLDTE   If closed date passed then set               
         JZ    ADDJOB32                                                         
         CLI   QA_TYPE,QA_TLOKS   Update lock bits                              
         JE    ADDJOB3A                                                         
         CLI   QA_TYPE,QA_TSTAT   Status change?                                
         JE    ADDJOB3A                                                         
         CLI   QA_TYPE,QA_TUPDT   Update sets open date                         
         JNE   ADDJOB32                                                         
ADDJOB3A OC    JOBODATE,JOBODATE   Any open date?                               
         JZ    ADDJOB31                                                         
         CLC   QA_CLDTE,JOBODATE   Close must not be before open                
         JNL   ADDJOB31                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$CLAFO),(5,=C'EC120'),=AL2(FLD012)            
         OI    TWAMODE,TWAMUWD                                                  
*                                                                               
ADDJOB31 MVC   JOBCDATE,QA_CLDTE   Set close date                               
*                                                                               
ADDJOB32 XR    RE,RE                                                            
         ICM   RE,3,JOBREVNO       Increment index number                       
         AHI   RE,1                                                             
         STCM  RE,3,JOBREVNO                                                    
         STCM  RE,3,OA_INDEX                                                    
         MVI   OA_STAT,QA_AAPPR    Set as approved                              
         MVC   AC_JSTA2,JOBSTA2    Save rejected status                         
         TM    ACTRSTAT,ACTSDRFT                                                
         JZ    *+8                                                              
         MVI   OA_STAT,QA_ASUBM    Set awaiting approval/submitted              
         CLI   QA_ASTAT,QA_AREJT                                                
         JNE   *+12                                                             
         OI    JOBSTA2,JOBSREJ                                                  
         MVI   OA_STAT,QA_AREJT    Set as rejected                              
         CLI   QA_ASTAT,QA_ASUBM                                                
         JE    ADDJOB38                                                         
         TM    AC_IND2,AC_IAPPR                                                 
         JZ    ADDJOB39                                                         
                                                                                
ADDJOB36 MVI   OA_STAT,QA_AAPPR    Set as approved                              
                                                                                
ADDJOB38 NI    JOBSTA2,X'FF'-JOBSREJ                                            
                                                                                
ADDJOB39 CLI   QA_ASTAT,QA_ANEW    Is this a new account                        
         JE    ADDJOB40            Yes                                          
         CLI   QA_ASTAT,QA_AAUTO                                                
         JNE   ADDJOB41            No                                           
                                                                                
N        USING SCIELD,ELEMENT2                                                  
ADDJOB40 XC    ELEMENT2,ELEMENT2                                                
         MVI   N.SCIEL,SCIELQ                                                   
         MVI   N.SCILN,SCILN1Q                                                  
         MVI   N.SCITYPE,SCITCPAT                                               
         ZAP   N.SCIAMNT,PZERO                                                  
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,N.SCIELD                       
         CLI   12(R1),0                                                         
         JNE   *+2                                                              
         DROP  N                                                                
                                                                                
ADDJOB41 TM    JOBSTA2,JOBSREJ                                                  
         JZ    *+8                                                              
         MVI   OA_STAT,QA_AREJT    Set as rejected                              
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   ADDJOB50                                                         
         CLI   QA_ESTI,NOQ                                                      
         JNE   ADDJOB42                                                         
         NI    JOBSTA1,X'FF'-JOBSMCSE                                           
ADDJOB42 CLI   QA_ESTI,YESQ                                                     
         JNE   ADDJOB44                                                         
         OI    JOBSTA1,JOBSMCSE                                                 
ADDJOB44 MVC   BYTE1,JOBSTA1                                                    
         NI    BYTE1,JOBSXJOB                                                   
         NI    JOBSTA1,X'FF'-JOBSXJOB                                           
*&&US                                                                           
         L     R4,AGOXBLCK                                                      
         USING GOXBLKD,R4                                                       
         CLI   QA_XJOB,C' '                                                     
         JH    *+10                                                             
         MVC   QA_XJOB,GOAWOO                                                   
*&&                                                                             
         CLI   QA_XJOB,YESQ                                                     
         JNE   ADDJOB45                                                         
         OI    JOBSTA1,JOBSXJOB                                                 
ADDJOB45 MVC   BYTE2,JOBSTA1                                                    
         NI    BYTE2,JOBSXJOB                                                   
         CLC   BYTE1,BYTE2         Has expense status changed                   
         JE    ADDJOB46                                                         
         GOTOR CHKACT,CHKEXTY                                                   
         JE    ADDJOB46                                                         
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
         OI    TWAMODE,TWAMUWD                                                  
                                                                                
ADDJOB46 NI    JOBSTA2,X'FF'-JOBSMST                                            
         CLI   QA_MAST,YESQ                                                     
         JNE   ADDJOB50                                                         
         GOTOR VHELLO,DMCB,(C'G',ACCMST),('SPAELQ',ACTRECD),           +        
               (1,=AL1(SPATMJOB))                                               
         CLI   12(R1),0            Does master job exist                        
         JNE   ADDJOB48            No                                           
         GOTOR SAVERR,DMCB,=AL2(AE$UMSJB),0,0  error as can't be a              
         OI    TWAMODE,TWAMUWD                                                  
*                                                        master job             
ADDJOB48 OI    JOBSTA2,JOBSMST     Job is master job                            
                                                                                
ADDJOB50 L     R3,AELEMENT         R3=A(old jobel)                              
OLD      USING JOBELD,R3                                                        
         GOTOR AUDJOB,DMCB,JOBELD,OLD.JOBELD                                    
         DROP  OLD                                                              
         OC    AELEMENT,AELEMENT                                                
         JZ    ADDJOB54                                                         
*                                                                               
         USING ACTRECD,R3                                                       
ADDJOB52 MVI   0(R3),X'FF'         DELETE OLD JOBELD                            
         L     R3,AIO3                                                          
                                                                                
         GOTOR VHELLO,DMCB,(C'D',ACCMST),('FF',ACTRECD),0                       
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
ADDJOB54 L     R3,AIO3                                                          
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,JOBELD                         
         CLI   12(R1),0                                                         
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  R2,R3                                                            
*&&US                                                                           
***********************************************************************         
* Add lnkel to account record                                         *         
***********************************************************************         
         SPACE 1                                                                
ADDLNK   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDLNK*'                                                      
         USING ACTRECD,R3                                                       
         L     R3,AIO3                                                          
         CLC   PRODUL,ACTKULA      Only want job el for SJ ledger acs           
         JNE   EXITY                                                            
         TM    AC_IND1,AC_INEW3+AC_ILVL3  Must be job level                     
         JZ    EXITY               Otherwise exit                               
                                                                                
         USING GOXBLKD,R4                                                       
         L     R4,AGOXBLCK                                                      
         CLI   GOSTUDIO,C'Y'       STUDIO JOB?                                  
         JNE   ADLNK500            NO, AGENCY JOB PROCESS DIFFERENT             
         DROP  R4                                                               
*---------------------------*                                                   
* STUDIO JOB <-- AGENCY JOB *                                                   
*---------------------------*                                                   
         XC    SVSLACCT,SVSLACCT                                                
         XR    R3,R3                                                            
         ICM   R3,7,QA_ASLJB       R3=A(Uploaded linked jobs)                   
         JZ    ADLNK010            No data just delete                          
         SR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R3)  Number of client/pro/jobs                 
         AHI   R3,LW_LN2Q          R3=A(first address of data)                  
                                                                                
         MVC   SVSLACCT(3),0(R3)                      client                    
         MVC   SVSLACCT+3(3),L'CPJCLI(R3)             product                   
         MVC   SVSLACCT+6(6),L'CPJCLI+L'CPJPRO(R3)    job                       
                                                                                
         CLC   SVSLACCT,OA_ACT     Can't link to itself                         
         JNE   ADLNK005                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$LITSF),0,0      Error                        
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
                                                                                
ADLNK005 GOTOR RDJOBREC            Read job record                              
         JNE   EXITN                                                            
         CLI   BYTE1,C'S'          Can't link to another Studio Job             
         JNE   ADLNK010                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$LSTJB),0,0      Error                        
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
                                                                                
         USING ACTRECD,R3                                                       
ADLNK010 L     R3,AIO3                                                          
         USING LNKELD,R2                                                        
         LA    R2,ELEMENT                                                       
         XC    ELEMENT,ELEMENT                                                  
         CLI   QA_TYPE,QA_TUPDT    Update?                                      
         JNE   ADLNK028                                                         
         XC    AELEMENT,AELEMENT                                                
         CLI   QA_ASTAT,QA_ANEW    Is this a new account                        
         JE    ADLNK030            Yes                                          
         CLI   QA_ASTAT,QA_AAUTO   Is this a new account auto number            
         JE    ADLNK030            Yes                                          
                                                                                
ADLNK028 GOTOR VHELLO,DMCB,(C'G',ACCMST),('LNKELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JE    ADLNK029                                                         
         CLI   12(R1),6            ELEMENT NOT FOUND                            
         JE    *+6                                                              
         DC    H'0'                Other errors, abend                          
         XC    AELEMENT,AELEMENT                                                
         CLC   QA_STUC,SPACES      Any studio type?                             
         JH    ADLNK030                                                         
         CLC   SVSLACCT,SPACES     Any studio link?                             
         JNH   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$INVSJ),0,0                                   
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
                                                                                
ADLNK029 L     R2,12(R1)                                                        
         LLC   RF,LNKLN                                                         
         BASR  RE,0                                                             
         MVC   ELEMENT(0),LNKEL    Copy existing element                        
         EX    RF,0(RE)                                                         
         ST    R2,AELEMENT                                                      
                                                                                
ADLNK030 LA    R2,ELEMENT                                                       
                                                                                
         CLC   QA_STUC,SPACES      See if the studio type                       
         JH    ADLNK050                                                         
         CLI   QA_TYPE,QA_TSTAT    Status change only?                          
         JE    ADLNK900            Then just exit                               
         XC    ELEMENT,ELEMENT     Clear out element                            
         J     ADLNK090            No, skip read                                
                                                                                
         USING STURECD,R1                                                       
ADLNK050 LA    R1,IOKEY                                                         
         XC    STUKEY,STUKEY                                                    
         MVI   STUKTYP,STUKTYPQ                                                 
         MVI   STUKSUB,STUKSUBQ                                                 
         MVC   STUKCPY,CUXCPY                                                   
         MVC   STUKCODE,QA_STUC                                                 
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R1,AIO1                                                          
         LA    R1,STURFST                                                       
         USING STUELD,R1                                                        
ADLNK074 CLI   STUEL,0                                                          
         JNE   ADLNK076                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$JMNSM),0,0                                   
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITY                                                            
ADLNK076 CLI   STUEL,STUELQ                                                     
         JE    ADLNK078                                                         
         LLC   RF,STULN                                                         
         AR    R1,RF                                                            
         J     ADLNK074                                                         
                                                                                
ADLNK078 CLC   STUMED,AC_MEDIA     Find right media (1st char of job)           
         JE    ADLNK080                                                         
         CLC   STUMED,SPACES       No media code for Studio, OK                 
         JNH   ADLNK080                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$JMNSM),0,0                                   
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITY                                                            
                                                                                
ADLNK080 LLC   RF,STULN            GET LENGTH OF ELEMENT                        
         SH    RF,=Y(STUOFF-STUELD)                                             
         JNZ   ADLNK082                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$NOSCL),0,0                                   
         OI    TWAMODE,TWAMUWD                                                  
         J     ADLNK089                                                         
ADLNK082 LA    R5,STUOFF                                                        
*                                                                               
ADLNK084 CLC   2(3,R5),SPACES      CLIENT                                       
         JE    ADLNK089                                                         
         CLC   2(3,R5),OA_ACT                                                   
         JE    ADLNK089                                                         
         LA    R5,L'STUOCLN(R5)                                                 
         SH    RF,=Y(L'STUOCLN)                                                 
         JNZ   ADLNK084                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$NOSCL),0,0                                   
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITY                                                            
                                                                                
ADLNK089 MVI   LNKEL,LNKELQ                                                     
         MVI   LNKLN,LNKLNQ                                                     
         MVC   LNKSTUD,QA_STUC                                                  
         MVC   LNKSTJB,OA_ACT                                                   
         MVC   LNKAGJB,SVSLACCT                                                 
                                                                                
ADLNK090 L     R3,AELEMENT         R3=A(old lnkel)                              
         LTR   R3,R3               NO OLD ELEMENT                               
         JNZ   ADLNK091                                                         
         OC    ELEMENT,ELEMENT     OR NEW ELEMENT, LEAVE                        
         JZ    EXITY                                                            
OLD      USING LNKELD,R3                                                        
ADLNK091 CLC   OLD.LNKSTUD,QA_STUC                                              
         JNE   ADLNK093                                                         
         CLC   OLD.LNKAGJB,SVSLACCT                                             
         JE    ADLNK095                                                         
ADLNK093 GOTOR CHKJBBLD,DMCB,AIO3  CHECK IF JOB BILLED                          
         JNE   ADLNK095                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$STJBA),0,0                                   
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITY                                                            
ADLNK095 GOTOR AUDLNK,DMCB,LNKELD,OLD.LNKELD                                    
         DROP  OLD                                                              
*                                                                               
         LTR   R3,R3               NO                                           
         JZ    ADLNK099                                                         
         MVI   0(R3),X'FF'         DELETE OLD LNKELD                            
                                                                                
         USING ACTRECD,R3                                                       
         L     R3,AIO3                                                          
                                                                                
         GOTOR VHELLO,DMCB,(C'D',ACCMST),('FF',ACTRECD),0                       
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
ADLNK099 L     R3,AIO3                                                          
         OC    ELEMENT,ELEMENT     NO ELEMENT TO ADD, LEAVE                     
         JZ    EXITY                                                            
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,LNKELD                         
         CLI   12(R1),0                                                         
         JE    EXITY                                                            
         DC    H'0'                                                             
                                                                                
*-------------------------------------*                                         
* AGENCY JOB <-- MULTIPLE STUDIO JOBS *                                         
*-------------------------------------*                                         
ADLNK500 DS    0H                  See if we need to delete links               
         GOTOR VHELLO,DMCB,(C'D',ACCMST),('LNKELQ',ACTRECD),0                   
         CLI   12(R1),0            Element was found                            
         JE    ADLNK505                                                         
         CLI   12(R1),6            Element not found, ok too                    
         JE    ADLNK505                                                         
         DC    H'0'                Other errors, abend                          
                                                                                
         USING SACRECD,R4                                                       
ADLNK505 LA    R4,IOKEY                    Look for it                          
         XC    SACKEY,SACKEY                                                    
         MVI   SACKTYP,SACKTYPQ                                                 
         MVI   SACKSUB,SACKSUBQ                                                 
         MVC   SACKCPY,CUXCPY                                                   
         MVC   SACKAJB,OA_ACT                                                   
ADLNK510 L     R1,=AL4(IOHIUP+IODIR+IO2)   Read High                            
         GOTOR (#IOEXEC,AIOEXEC)                                                
         J     ADLNK550                                                         
*                                                                               
ADLNK540 L     R1,=AL4(IOSQUP+IODIR+IO2)   Read Sequential                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
*                                                                               
ADLNK550 CLC   SACKEY(SACKSTY-SACKEY),IOKEYSAV   No more for Agency Job         
         JNE   ADLNK800                          Done, check add links          
         XC    SVSLACCT,SVSLACCT                                                
         XR    R3,R3                                                            
         ICM   R3,7,QA_ASLJB       R3=A(Uploaded linked jobs)                   
         JZ    ADLNK700            No, leave                                    
         SR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R3)  Number of client/pro/jobs                 
         AHI   R3,LW_LN2Q          R3=A(first address of data)                  
                                                                                
ADLNK610 MVC   SVSLACCT(3),0(R3)                      client                    
         MVC   SVSLACCT+3(3),L'CPJCLI(R3)             product                   
         MVC   SVSLACCT+6(6),L'CPJCLI+L'CPJPRO(R3)    job                       
                                                                                
         CLC   SACKSJB,SVSLACCT                                                 
         JE    ADLNK540            Found it, skip to next one                   
         AHI   R3,L'CPJCLI+L'CPJPRO+L'CPJJOB     Bump to next one               
         JCT   R0,ADLNK610                                                      
                                                                                
ADLNK700 MVC   SVSLACCT,SACKSJB                                                 
         GOTOR CHSTLNK,DMCB,(C'D',0)             Delete it                      
         JNE   EXITN                                                            
         MVC   IOKEY,CSVKEY1                                                    
         J     ADLNK510            Read High because that key deleted           
                                                                                
*---------------------------------------------------------------------          
ADLNK800 DS    0H                  See if we need to add links                  
         XC    SVSLACCT,SVSLACCT                                                
         XR    R3,R3                                                            
         ICM   R3,7,QA_ASLJB       R3=A(Uploaded linked jobs)                   
         JZ    ADLNK900            No, leave                                    
         SR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R3)  Number of client/pro/jobs                 
         AHI   R3,LW_LN2Q          R3=A(first address of data)                  
                                                                                
ADLNK810 MVC   SVSLACCT(3),0(R3)                      client                    
         MVC   SVSLACCT+3(3),L'CPJCLI(R3)             product                   
         MVC   SVSLACCT+6(6),L'CPJCLI+L'CPJPRO(R3)    job                       
                                                                                
         USING SACRECD,R4                                                       
         LA    R4,IOKEY                    Look for it                          
         XC    SACKEY,SACKEY                                                    
         MVI   SACKTYP,SACKTYPQ                                                 
         MVI   SACKSUB,SACKSUBQ                                                 
         MVC   SACKCPY,CUXCPY                                                   
         MVC   SACKAJB,OA_ACT                                                   
         L     R1,=AL4(IOHIUP+IODIR+IO2)   Read High                            
         GOTOR (#IOEXEC,AIOEXEC)                                                
         J     ADLNK850                                                         
*                                                                               
ADLNK840 L     R1,=AL4(IOSQUP+IODIR+IO2)   Read Sequential                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
*                                                                               
ADLNK850 CLC   SACKEY(SACKSTY-SACKEY),IOKEYSAV   No more for Agency Job         
         JNE   ADLNK870                                                         
         CLC   SACKSJB,SVSLACCT    Did we find it?                              
         JNE   ADLNK840            No, keep looking                             
         J     ADLNK890                                                         
                                                                                
ADLNK870 DS    0H                                                               
         CLC   SVSLACCT,OA_ACT     Can't link to itself                         
         JNE   ADLNK873                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$LITSF),0,0      Error                        
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
                                                                                
ADLNK873 GOTOR RDJOBREC                                                         
         JNE   EXITN                                                            
         MVC   IOKEY,CSVKEY1                                                    
         CLI   BYTE1,C'A'          Can't link to Agency Job                     
         JNE   ADLNK875                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$LAGJB),0,0      Error                        
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
                                                                                
ADLNK875 GOTOR CHSTLNK,DMCB,(C'A',0)             Add it                         
         JE    ADLNK890                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$INVSJ),0,0                                   
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
                                                                                
ADLNK890 AHI   R3,L'CPJCLI+L'CPJPRO+L'CPJJOB     Bump to next one               
         JCT   R0,ADLNK810                                                      
ADLNK900 J     EXITY                                                            
         DROP  R2,R3                                                            
                                                                                
***********************************************************************         
* Read Job Account into AIO2                                          *         
*    destroys IOKEY but saves it in CSVKEY1                           *         
***********************************************************************         
                                                                                
RDJOBREC NTR1  LABEL=NO                                                         
         USING ACTRECD,R4                                                       
         LA    R4,IOKEY                                                         
         MVC   CSVKEY1,ACTKEY      SAVE BEFORE CHANGING                         
                                                                                
         XC    ACTKEY,ACTKEY                                                    
         MVC   ACTKEY(ACTKSTA-ACTKEY),SPACES                                    
                                                                                
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(2),=C'SJ'                                                
         MVC   ACTKACT,SVSLACCT                                                 
                                                                                
         L     R1,=AL4(IOHIUP+IODIR+IO2)   Read High                            
         GOTOR (#IOEXEC,AIOEXEC)                                                
                                                                                
         CLC   ACTKEY(ACTKSTA-ACTKEY),IOKEYSAV     Can't find it                
         JE    RDJ0100                                                          
         GOTOR SAVERR,DMCB,=AL2(AE$RECNF),0,0      Record not found             
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
                                                                                
RDJ0100  L     R1,=AL4(IOGETRUP+IOMST+IO2) Get record                           
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    RDJ0200                                                          
         DC    H'0'                                                             
                                                                                
RDJ0200  MVI   BYTE1,C' '          Default, not a Studio Job                    
         L     R4,AIO2                                                          
         GOTOR VHELLO,DMCB,(C'G',ACCMST),('LNKELQ',ACTRECD),0                   
         CLI   12(R1),6                                                         
         JE    EXITY                                                            
         CLI   12(R1),0            LNKEL element found                          
         JNE   RDJ0500                                                          
         MVI   BYTE1,C'S'          It's a Studio Job                            
         J     EXITY                                                            
                                                                                
RDJ0500  DS    0H                                                               
         DC    H'0'                Other errors, abend                          
         J     EXITY                                                            
                                                                                
***********************************************************************         
* Change Studio Link                                                  *         
***********************************************************************         
                                                                                
CHSTLNK  NTR1  LABEL=NO                                                         
         USING ACTRECD,R4                                                       
         LA    R4,IOKEY                                                         
         MVC   BYTE2,DMCB          Save action into Byte2                       
                                                                                
         GOTOR RDJOBREC            Read Job Record into AIO2                    
         JNE   EXITN                                                            
                                                                                
         GOTOR UPDPASS,DMCB,(C'D',AIO2),(C'K',AC_OFF)                           
                                                                                
CSLK300  L     R4,AIO2                                                          
         CLI   BYTE2,C'D'          Deleteing?                                   
         JNE   CSLK400                                                          
         GOTOR CHKJBBLD,DMCB,AIO2  CHECK IF JOB BILLED                          
         JNE   CSLK400                                                          
         GOTOR SAVERR,DMCB,=AL2(AE$SLJBA),0,0                                   
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
                                                                                
CSLK400  GOTOR VHELLO,DMCB,(C'G',ACCMST),('LNKELQ',ACTRECD),0                   
         CLI   12(R1),0            Element exists                               
         JE    CSLK500                                                          
         CLI   12(R1),6            Element not found, error out                 
         JE    EXITN                                                            
         DC    H'0'                Other errors, abend                          
                                                                                
         USING LNKELD,R2                                                        
CSLK500  L     R2,12(R1)                                                        
         XC    LNKAGJB,LNKAGJB     Clear out Agency Job link                    
         CLI   BYTE2,C'A'          Adding Agency Job?                           
         JNE   *+10                                                             
         MVC   LNKAGJB,OA_ACT      Put in Agency Job                            
CSLK700  GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO2'                           
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         GOTOR UPDPASS,DMCB,(C'A',AIO2),AC_OFF                                  
         MVI   UPDATED,C'Y'                                                     
         GOTOR AODLNK                                                           
         J     EXITY                                                            
         DROP  R2,R4                                                            
***********************************************************************         
* Check if Job is billed already                                      *         
*    P1  =  Address of I/O area                                       *         
*    cc  =  Yes, Job was billed                                       *         
*           No, no billing on Job                                     *         
***********************************************************************         
         SPACE 1                                                                
CHKJBBLD NTR1  LABEL=NO                                                         
         USING RSTELD,R2                                                        
         USING ACTRECD,R3                                                       
         L     R3,0(R1)                                                         
         GOTOR VHELLO,DMCB,(C'G',ACCMST),('RSTELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JE    CJBB100                                                          
         CLI   12(R1),6            ELEMENT NOT FOUND                            
         JE    EXITN                                                            
         DC    H'0'                Other errors, abend                          
                                                                                
CJBB100  L     R2,12(R1)                                                        
         OC    RSTPBILL,RSTPBILL   Was Job billed?                              
         JNZ   EXITY               Yes                                          
         J     EXITN               No                                           
         DROP  R2,R3                                                            
*&&                                                                             
***********************************************************************         
* Add ratel to account record                                         *         
***********************************************************************         
         SPACE 1                                                                
ADDRAT   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDRAT*'                                                      
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   EXITY                                                            
         USING ACTRECD,R4                                                       
         USING RATELD,R2                                                        
         LA    R2,ELEMENT                                                       
         L     R4,AIO3                                                          
         XC    RATEL(RATLNQ),RATEL                                              
         XC    AELEMENT,AELEMENT                                                
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('RATEDSCQ',ACTRECD),0                 
         CLI   12(R1),0                                                         
         JNE   ADDRAT02                                                         
         L     R2,12(R1)                                                        
         LLC   RF,RATLN                                                         
         BASR  RE,0                                                             
         MVC   ELEMENT(0),RATEL                                                 
         EX    RF,0(RE)                                                         
         ST    R2,AELEMENT                                                      
ADDRAT02 LA    R2,ELEMENT                                                       
         MVI   RATEL,RATEDSCQ                                                   
         MVI   RATLN,RATLNQ                                                     
         OC    QA_DISRT,QA_DISRT   Any rate input                               
         JZ    ADDRAT08            No                                           
         LLC   RF,QA_DISRL         Length of input                              
         GOTO1 VCASHVAL,DMCB,(2,QA_DISRT),(RF)                                  
         CLI   0(R1),0             Valid number                                 
         JE    ADDRAT06            Yes                                          
ADDRAT04 GOTOR SAVERR,DMCB,=AL2(AE$INVRT),0,=AL2(FLD077)                        
         OI    TWAMODE,TWAMUWD                                                  
         J     ADDRAT16                                                         
                                                                                
ADDRAT06 CLC   4(4,R1),=F'10000'   Ensure reasonable discount rate              
         JH    ADDRAT04            No                                           
         MVC   RATRATE,DMCB+6      Yes - save rate to element                   
ADDRAT08 GOTOR AUDDIS                                                           
         OC    AELEMENT,AELEMENT   Any old rate?                                
         JZ    ADDRAT12            No                                           
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),('RATEDSCQ',ACTRECD)                   
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
ADDRAT12 OC    QA_DISRT,QA_DISRT                                                
         JZ    ADDRAT16                                                         
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,RATELD                         
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
ADDRAT16 XC    RATEL(RATLNQ),RATEL                                              
         XC    AELEMENT,AELEMENT                                                
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('RATEVATQ',ACTRECD),0                 
         CLI   12(R1),0                                                         
         JNE   ADDRAT18                                                         
         L     R2,12(R1)                                                        
         LLC   RF,RATLN                                                         
         BASR  RE,0                                                             
         MVC   ELEMENT(0),RATEL                                                 
         EX    RF,0(RE)                                                         
         ST    R2,AELEMENT                                                      
ADDRAT18 LA    R2,ELEMENT                                                       
         MVI   RATEL,RATEVATQ                                                   
         MVI   RATLN,RATLNQ                                                     
         OC    QA_VATRT,QA_VATRT                                                
         JZ    ADDRAT24                                                         
         LLC   RF,QA_VATRL         Length of input                              
         GOTO1 VCASHVAL,DMCB,(2,QA_VATRT),(RF)                                  
         CLI   0(R1),0             Valid number                                 
         JE    ADDRAT22            Yes                                          
ADDRAT20 GOTOR SAVERR,DMCB,=AL2(AE$INVRT),0,=AL2(FLD078)                        
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITY                                                            
                                                                                
ADDRAT22 CLC   4(4,R1),=F'10000'   Ensure reasonable VAT rate                   
         JH    ADDRAT20            No                                           
         MVC   RATRATE,DMCB+6      Yes - save rate to element                   
ADDRAT24 GOTOR AUDVAT                                                           
         OC    AELEMENT,AELEMENT   Any old rate?                                
         JZ    ADDRAT26            No                                           
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),('RATEVATQ',ACTRECD)                   
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
ADDRAT26 OC    QA_VATRT,QA_VATRT                                                
         JZ    EXITY                                                            
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,RATELD                         
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
         J     EXITY                                                            
         DROP  R2,R4                                                            
***********************************************************************         
* Add bacel to account record                                         *         
***********************************************************************         
         SPACE 1                                                                
ADDBAC   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDBAC*'                                                      
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   EXITY                                                            
         USING ACTRECD,R4                                                       
         USING BACELD,R2                                                        
         LA    R2,ELEMENT                                                       
         L     R4,AIO3                                                          
         CLC   =C'SX',ACTKUNT      BACELD only applicable to                    
         JE    ADDBAC01                                                         
         CLC   =C'SV',ACTKUNT      creditors and bank                           
         JE    ADDBAC01                                                         
         CLC   =C'SF',ACTKUNT                                                   
         JE    ADDBAC01                                                         
         CLC   =C'ST',ACTKUNT                                                   
         JE    ADDBAC01                                                         
         CLC   =C'SC',ACTKUNT                                                   
         JNE   EXITY                                                            
ADDBAC01 XC    ELEMENT,ELEMENT                                                  
         XC    AELEMENT,AELEMENT                                                
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('BACELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JNE   ADDBAC02                                                         
         L     R2,12(R1)                                                        
         ST    R2,AELEMENT                                                      
ADDBAC02 LA    R2,ELEMENT                                                       
         MVI   BACEL,BACELQ                                                     
         OC    QA_BSORT,QA_BSORT                                                
         JZ    ADDBAC24            No                                           
*                                                                               
         LLC   RF,QA_BSRTL                                                      
         CLI   CUCTRY,CTRYHOL      Holland                                      
         JNE   ADDBAC10                                                         
*                                                                               
ADDBAC04 LR    RE,RF                                                            
         LA    RF,QA_BSORT                                                      
ADDBAC06 CLI   0(RF),C'0'          Check if numeric                             
         JL    ADDBAC08                                                         
         LA    RF,1(RF)                                                         
         JCT   RE,ADDBAC06                                                      
         J     ADDBAC22                                                         
                                                                                
ADDBAC08 GOTOR SAVERR,DMCB,=AL2(AE$NONIF),(L'QA_BSORT,QA_BSORT),       +        
               =AL2(FLD126)                                                     
         OI    TWAMODE,TWAMUWD                                                  
         J     ADDBAC22                                                         
*                                                                               
ADDBAC10 LA    RF,QA_BSORT         Validate XX-XX-XX                            
         CLI   2(RF),C'-'                                                       
         JE    ADDBAC12                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$BSRIV),(L'QA_BSORT,QA_BSORT),       +        
               =AL2(FLD126)                                                     
         OI    TWAMODE,TWAMUWD                                                  
         J     ADDBAC22                                                         
*                                                                               
ADDBAC12 CLI   5(RF),C'-'                                                       
         JE    ADDBAC14                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$BSRIV),(L'QA_BSORT,QA_BSORT),       +        
               =AL2(FLD126)                                                     
         OI    TWAMODE,TWAMUWD                                                  
         J     ADDBAC22                                                         
*                                                                               
ADDBAC14 LA    R0,3                3 groups of 2                                
         XR    RE,RE               Displacement into field                      
ADDBAC16 LA    R1,2                A group of 2                                 
                                                                                
ADDBAC18 CLI   0(RF),C'0'          Check if numeric                             
         JNL   ADDBAC20                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$NONIF),(L'QA_BSORT,QA_BSORT),       +        
               =AL2(FLD126)                                                     
         OI    TWAMODE,TWAMUWD                                                  
         J     ADDBAC22                                                         
*                                                                               
ADDBAC20 LA    RF,1(,RF)           Next number in group of 2                    
         LA    RE,1(,RE)                                                        
         JCT   R1,ADDBAC18         Check it                                     
*                                                                               
         LA    RF,1(,RF)           Go past the `-`                              
         LA    RE,1(,RE)                                                        
         JCT   R0,ADDBAC16         Next group                                   
*                                                                               
ADDBAC22 MVC   BACSORT,QA_BSORT                                                 
         J     *+12                                                             
ADDBAC24 CLI   QA_PYMTH,QA_BACQ                                                 
         JE    ADDBAC30                                                         
         MVC   BACCOUNT,QA_BACT                                                 
         MVI   BACLN,BACLNQ                                                     
         MVC   BACBNAME,SPACES                                                  
         OC    QA_BNAME,QA_BNAME   Any bank name                                
         JZ    ADDBAC26            No                                           
         LLC   RF,QA_BNAML         Yes - extract it to element                  
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   BACBNAME(0),QA_BNAME                                             
         EX    RF,0(RE)                                                         
         MVI   BACLN,BACLNQ2                                                    
         J     *+12                                                             
ADDBAC26 CLI   QA_PYMTH,QA_BACQ    If no bank name and BACS error               
         JE    ADDBAC30                                                         
         OC    QA_BACNM,QA_BACNM   Any account name                             
         JZ    ADDBAC28            No                                           
         LLC   RF,QA_BACNL         Yes - extract it to element                  
         BASR  RE,0                                                             
         SHI   RF,1                                                             
         MVC   BACACNAM(0),QA_BACNM                                             
         EX    RF,0(RE)                                                         
         AHI   RF,BACLNQ2+1        Set length of element                        
         STC   RF,BACLN                                                         
         J     ADDBAC32                                                         
ADDBAC28 CLI   QA_PYMTH,QA_BACQ    If no account name and BACS error            
         JNE   ADDBAC32                                                         
ADDBAC30 GOTOR SAVERR,DMCB,=AL2(AE$BNKBC),0,=AL2(FLD128)                        
         OI    TWAMODE,TWAMUWD                                                  
                                                                                
ADDBAC32 CLI   CUCTRY,CTRYGER      Germany?                                     
         JE    ADDBAC33                                                         
         CLI   QA_PYMTH,QA_BACQ    BACS payments                                
         JNE   *+8                                                              
         OI    BACSTAT,BACSTBAC                                                 
         CLI   QA_PYMTH,QA_CHQQ    System cheques                               
         JNE   *+8                                                              
         OI    BACSTAT,BACSTCHQ                                                 
         CLI   QA_PYMTH,QA_MCHQ    Manual cheques                               
         JNE   *+8                                                              
         OI    BACSTAT,BACSTMCH                                                 
         CLI   QA_PYMTH,QA_PAYQ    Payments                                     
         JNE   *+8                                                              
         OI    BACSTAT,BACSTPAY                                                 
         CLI   QA_PYMTH,QA_INTQ    Foreign currency cheques                     
         JNE   *+8                                                              
         OI    BACSTAT,BACSTCUR                                                 
         CLI   QA_PYMTH,QA_TRFQ    Transfers                                    
         JNE   *+8                                                              
         OI    BACSTAT,BACSTTRF                                                 
         CLI   QA_PYMTH,QA_AFPQ    Auto foriegn payments                        
         JNE   *+8                                                              
         OI    BACSTAT,BACSTAFP                                                 
         CLI   QA_PYMTH,QA_SEPQ    SEPA payments                                
         JNE   *+8                                                              
         OI    BACSTAT,BACSSEPA                                                 
         J     ADDBAC34                                                         
                                                                                
ADDBAC33 CLI   QA_PYMTH,QA_CHQQ    System cheques                               
         JNE   *+8                                                              
         OI    BACSTAT,BACSTCHQ                                                 
         CLI   QA_PYMTH,QA_MCHQ    Manual cheques                               
         JNE   *+8                                                              
         OI    BACSTAT,BACSTMCH                                                 
         CLI   QA_PYMTH,QA_INTQ    Foreign currency cheques                     
         JNE   *+8                                                              
         OI    BACSTAT,BACSTCUR                                                 
         CLI   QA_PYMTH,QA_SEPQ    SEPA payments                                
         JNE   *+8                                                              
         OI    BACSTAT,BACSSEPA                                                 
                                                                                
ADDBAC34 GOTOR AUDBAC              Create audit info                            
         OC    AELEMENT,AELEMENT   Any old BACELD?                              
         JZ    ADDBAC36            No                                           
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),('BACELQ',ACTRECD)                     
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
ADDBAC36 OC    BACSTAT,BACSTAT                                                  
         JZ    EXITY                                                            
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,BACELD                         
         CLI   12(R1),0                                                         
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  R2,R4                                                            
***********************************************************************         
* Add pprel to account record                                         *         
***********************************************************************         
         SPACE 1                                                                
ADDPPR   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDPPR*'                                                      
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   EXITY                                                            
         USING ACTRECD,R4                                                       
         USING PPRELD,R2                                                        
         L     R4,AIO3                                                          
*                                                                               
         XC    ELEMENT,ELEMENT                                                  
         LA    R2,ELEMENT          Establish element                            
         MVI   PPREL,PPRELQ                                                     
         MVC   PPRGAOFF,SPACES                                                  
         MVC   PPRUWRK,SPACES                                                   
         MVI   PPRLN,PPRLN1Q       Default length                               
*                                                                               
         CLC   PRODUL,ACTKUNT                                                   
         JNE   EXITY                                                            
         XC    AELEMENT,AELEMENT                                                
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('PPRELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JNE   ADDPPR02                                                         
*                                                                               
         L     R2,12(R1)                                                        
         ST    R2,AELEMENT                                                      
*                                                                               
         LLC   RF,PPRLN            Copy from old to new                         
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   ELEMENT(0),0(R2)                                                 
         EX    RF,0(RE)                                                         
*                                                                               
ADDPPR02 LA    R2,ELEMENT                                                       
         SR    R3,R3                                                            
         ICM   R3,7,QA_AOTHR       R3=A(Uploaded other info lines)              
         JNZ   ADDPPR03                                                         
         MVI   PPRLN,PPRLN1Q                                                    
         MVC   PPRNARRP,SPACES                                                  
         J     ADDPPR06            No data just delete                          
*                                                                               
ADDPPR03 SR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R3)  Number of other info lines                
         LR    R1,R0                                                            
         MHI   R1,L'PPRNARRP/3                                                  
         AHI   R1,PPRLN1Q                                                       
         STC   R1,PPRLN            Work out length of element                   
         AHI   R3,LW_LN2Q          R3=A(first other info data)                  
         LA    R1,PPRNARRP         R1=A(first other info on element)            
                                                                                
ADDPPR04 MVC   0(L'PPRNARRP/3,R1),0(R3)                                         
         LA    R3,L'PPRNARRP/3(R3)                                              
         LA    R1,L'PPRNARRP/3(R1)                                              
         JCT   R0,ADDPPR04         Decrement number of address lines            
                                                                                
ADDPPR06 MVC   PPRGRUP,QA_BILGR    Office maintenance                           
         MVC   PPRBILLP,QA_PRTBL                                                
         MVC   PPRGAOFF,SPACES                                                  
         OC    QA_OFFC,QA_OFFC     Do we have an office                         
         JZ    ADDPPR08            No                                           
         CLC   AC_PROFF,QA_OFFC    Is the office the same as higher lev         
         JE    ADDPPR08            Yes                                          
         MVC   PPRGAOFF,QA_OFFC    save new office                              
*                                                                               
ADDPPR08 DS    0H                                                               
         CLI   QA_UPLD,QA_SAPTL    SAP tool only works on current level         
         JE    ADDPPR20                                                         
         LA    R3,RECVTAB                                                       
         USING RECVTABD,R3                                                      
         MVC   AC_CPY,CUXCPY                                                    
         OC    QA_DRACT,QA_DRACT                                                
         JZ    ADDPPR20                                                         
         MVC   AC_ULA,QA_DRACT                                                  
ADDPPR10 XC    BYTE1,BYTE1                                                      
         OC    BYTE1,AC_IND1                                                    
         NC    BYTE1,RECVACLV      Account at what level                        
         JZ    ADDPPR16            No match - get next entry                    
         CLI   AC_UNIT,C'1'        Costing or debtors?                          
         JE    ADDPPR12            Costing                                      
         CLI   QA_UPLD,QA_ACCTL    If accounting upload tool then don't         
         JE    ADDPPR14            check debtor level                           
         CLC   QA_DRLVL,RECVLVL    Does level of debtors change match           
         JNE   ADDPPR16                                                         
         J     ADDPPR14                                                         
*                                                                               
ADDPPR12 CLC   QA_CSLVL,RECVLVL    Does level of costing change match           
         JNE   ADDPPR16                                                         
ADDPPR14 LH    RF,RECVRADR                                                      
         AR    RF,RB                                                            
         BASR  RE,RF               SET PPRRECV                                  
         J     ADDPPR20                                                         
ADDPPR16 LA    R3,RECVTABL(R3)                                                  
         CLI   0(R3),X'FF'                                                      
         JNE   ADDPPR10                                                         
         DC    H'0'                                                             
* SET PPRRECV USING RECVTAB - THIS IS UPDATIVE, SHOULD BE MOVED                 
ADDPPR20 DS    0H                                                               
*&&UK                                                                           
         OC    QA_DRACT,QA_DRACT   Upload works only at current level           
         JZ    ADDPPR55                                                         
         MVC   AC_CPY,CUXCPY                                                    
         CLI   QA_UPLD,QA_SAPTL    Is this a sap upload?                        
         JNE   ADDPPR22                                                         
         TM    AC_IND1,AC_INEW2+AC_INEW3                                        
         JZ    ADDPPR22            Are we adding a new product/job?             
         CLC   QA_DRACT,AC_CLISR   Yes - is the client level the same           
         JE    ADDPPR55            Yes - don't save at product level            
*                                                                               
ADDPPR22 MVC   AC_ULA,QA_DRACT                                                  
         BRAS  RE,DRCSCUR                                                       
*                                                                               
         OC    QA_CSACT,QA_CSACT                                                
         JZ    ADDPPR55                                                         
         MVC   AC_CPY,CUXCPY                                                    
         MVI   AC_UNIT,C'1'                                                     
         MVI   AC_LDG,C'C'                                                      
         MVC   AC_ACT,QA_CSACT                                                  
         OC    AC_ULA,SPACES                                                    
         BRAS  RE,DRCSCUR                                                       
         J     ADDPPR55                                                         
*&&                                                                             
*                                                                               
ADDPPR55 GOTOR AUDPPR                                                           
         OC    AELEMENT,AELEMENT   Any old profile element                      
         JZ    ADDPPR60            No                                           
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),('PPRELQ',ACTRECD)                     
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
ADDPPR60 GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,PPRELD                         
         CLI   12(R1),0                                                         
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  R2,R4                                                            
         USING PPRELD,R2                                                        
DRCSCUR  ST    RE,SAVERE                                                        
         LA    R3,PPRCOST                                                       
         CLI   AC_UNIT,C'1'                                                     
         JE    *+8                                                              
         LA    R3,PPRRECV                                                       
         MVC   0(L'PPRRECV,R3),AC_CULA                                          
         BR    RE                                                               
         DROP  R2                                                               
* ROUTINES FOR SETTING PPRRECV                                                  
DRCSPRO  ST    RE,SAVERE                                                        
         LA    R1,IOKEY                                                         
         USING ACTRECD,R1                                                       
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         XR    RF,RF                                                            
         IC    RF,LDGAL2                                                        
         AHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   ACTKULA(0),OA_ULA                                                
         EX    RF,0(RE)                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R1,=AL4(IOGETRUP+IOMST+IO1)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R1,AIO1                                                          
         LA    R3,ACTRFST                                                       
         USING PPRELD,R3                                                        
DRCSPRO2 CLI   PPREL,0                                                          
         JNE   *+6                                                              
         DC    H'0'                                                             
         CLI   PPREL,PPRELQ                                                     
         JE    DRCSPRO6                                                         
DRCSPRO4 LLC   R1,PPRLN                                                         
         AR    R3,R1                                                            
         J     DRCSPRO2                                                         
*                                                                               
DRCSPRO6 CLI   AC_UNIT,C'1'                                                     
         JNE   *+8                                                              
         LA    R3,PPRCOST                                                       
         CLI   AC_UNIT,C'S'                                                     
         JNE   *+8                                                              
         LA    R3,PPRRECV                                                       
         CLC   0(L'PPRRECV,R3),AC_CULA                                          
         JE    DRCSPRO8                                                         
         MVC   0(L'PPRRECV,R3),AC_CULA                                          
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO1'                           
         JE    *+6                                                              
         DC    H'0'                                                             
DRCSPRO8 L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
DRCSCLI  ST    RE,SAVERE                                                        
         LA    R1,IOKEY                                                         
         USING ACTRECD,R1                                                       
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         XR    RF,RF                                                            
         IC    RF,LDGAL1                                                        
         AHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   ACTKULA(0),OA_ULA                                                
         EX    RF,0(RE)                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R1,=AL4(IOGETRUP+IOMST+IO1)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R1,AIO1                                                          
         LA    R3,ACTRFST                                                       
         USING PPRELD,R3                                                        
DRCSCLI2 CLI   PPREL,0                                                          
         JNE   *+6                                                              
         DC    H'0'                                                             
         CLI   PPREL,PPRELQ                                                     
         JE    DRCSCLI6                                                         
DRCSCLI4 LLC   R1,PPRLN                                                         
         AR    R3,R1                                                            
         J     DRCSCLI2                                                         
*                                                                               
DRCSCLI6 CLI   AC_UNIT,C'1'                                                     
         JNE   *+8                                                              
         LA    R3,PPRCOST                                                       
         CLI   AC_UNIT,C'S'                                                     
         JNE   *+8                                                              
         LA    R3,PPRRECV                                                       
         CLC   0(L'PPRRECV,R3),AC_CULA                                          
         JE    DRCSCLI8                                                         
         MVC   0(L'PPRRECV,R3),AC_CULA                                          
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO1'                           
         JE    *+6                                                              
         DC    H'0'                                                             
DRCSCLI8 L     RE,SAVERE                                                        
         BR    RE                                                               
         DROP  R1,R3                                                            
                                                                                
         EJECT                                                                  
***********************************************************************         
* Update account name                                                 *         
* AC_CULA contains account code to be updated                         *         
***********************************************************************         
                                                                                
UPDACN   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*UPDACN*'                                                      
         XC    ELEMENT2,ELEMENT2                                                
         LA    R4,IOKEY                                                         
         USING ACTRECD,R4                                                       
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY(L'AC_CULA),AC_CULA                                       
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JNE   EXITN                                                            
         L     R1,=AL4(IOGETRUP+IOMST+IO1)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R4,AIO1                                                          
         MVC   AC_ACSTA,ACTRSTAT                                                
         LA    R2,ACTRFST                                                       
         USING NAMELD,R2                                                        
UPDACN02 CLI   NAMEL,0                                                          
         JNE   *+18                                                             
         OC    AC_NAME,AC_NAME                                                  
         JZ    EXITY               No name before or now - exit                 
         J     UPDACN08                                                         
         CLI   NAMEL,NAMELQ        Name element                                 
         JE    UPDACN06                                                         
UPDACN04 LLC   RF,NAMLN                                                         
         AR    R2,RF                                                            
         J     UPDACN02                                                         
*                                                                               
UPDACN06 OC    AC_NAME,AC_NAME                                                  
         JZ    UPDACN10            No name uploaded                             
         LLC   RF,NAMLN                                                         
         SHI   RF,NAMLN1Q+1                                                     
         LLC   RE,AC_NAMEL                                                      
         SHI   RE,1                                                             
         CR    RF,RE               Compare length of names                      
         JNE   UPDACN08            Length is different                          
         BASR  RE,0                                                             
         CLC   NAMEREC(0),AC_NAME  Check if name still the same                 
         EX    RF,0(RE)                                                         
         JE    EXITY                                                            
                                                                                
UPDACN08 LA    R3,ELEMENT2                                                      
NEW      USING NAMELD,R3                                                        
         LLC   RF,AC_NAMEL                                                      
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   NEW.NAMEREC(0),AC_NAME  Check if name still the same             
         EX    RF,0(RE)                                                         
         AHI   RF,NAMLN1Q+1                                                     
         STC   RF,NEW.NAMLN                                                     
         MVI   NEW.NAMEL,NAMELQ                                                 
*PDACN10 GOTOR AUDACNM,DMCB,NAMEL,NEW.NAMELD                                    
UPDACN10 GOTO1 VHELLO,DMCB,(C'D',ACCMST),('NAMELQ',ACTRECD)                     
         CLI   12(R1),0                                                         
         JE    UPDACN12                                                         
         DC    H'0'                                                             
UPDACN12 OC    AC_NAME,AC_NAME                                                  
         JZ    UPDACN14                                                         
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,NEW.NAMELD                     
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
UPDACN14 GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO1'                           
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  NEW,R2,R4                                                        
         EJECT                                                                  
***********************************************************************         
* Add fftel to account record                                         *         
***********************************************************************         
         SPACE 1                                                                
ADDFFT   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDFFT*'                                                      
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   EXITY                                                            
         USING ACTRECD,R4                                                       
         L     R4,AIO3                                                          
         USING FFTTABD,R6                                                       
         LA    R6,FFTTAB                                                        
         XC    BYTE1,BYTE1                                                      
         MVI   BYTE2,0                                                          
ADDFFT02 XC    ELEMENT,ELEMENT                                                  
         XC    AELEMENT,AELEMENT                                                
*                                                                               
ADDFFT2C CLI   QA_UPLD,QA_SAPTL    SAP doesn't handle tax num/region            
         JNE   ADDFFT03                                                         
         CLI   FFTTYP,FFTTAXNO                                                  
         JE    ADDFFT20                                                         
*&&UK*&& CLI   FFTTYP,FFTTAXLO                                                  
*&&UK*&& JE    ADDFFT20                                                         
*                                                                               
ADDFFT03 DS    0H                                                               
         MVC   BYTE1,FFTTYP                                                     
         XR    R7,R7                                                            
         LH    R7,FFTTADRT                                                      
         AR    R7,R8               a(request data for this ele)                 
         L     R3,AELEMENT                                                      
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('FFTELQ',ACTRECD),           +        
               (1,BYTE1)                                                        
         CLI   12(R1),0                                                         
         JNE   ADDFFT04                                                         
         L     R3,12(R1)                                                        
OLD      USING FFTELD,R3                                                        
         ST    R3,AELEMENT                                                      
         USING FFTELD,R2                                                        
ADDFFT04 LA    R2,ELEMENT                                                       
         OC    0(1,R7),0(R7)                                                    
         JZ    ADDFFT15                                                         
*                                                                               
*&&UK                                                                           
         CLI   FFTTYP,FFTTG13B                                                  
         JNE   ADDFFT11                                                         
         LLC   RF,0(R7)                                                         
         SHI   RF,1                                                             
         LTR   RF,RF                                                            
         JZ    ADDFFT15                                                         
*&&                                                                             
ADDFFT11 MVI   FFTEL,FFTELQ                                                     
         MVC   FFTTYPE,BYTE1                                                    
         MVC   FFTDLEN,0(R7)                                                    
         LLC   RF,0(R7)                                                         
         SHI   RF,1                                                             
*&&UK                                                                           
         CLI   FFTTYP,FFTTG13B                                                  
         JNE   ADDFFT13                                                         
         STC   RF,FFTDLEN                                                       
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   FFTDATA(0),2(R7)                                                 
         EX    RF,0(RE)                                                         
         AHI   RF,FFTLN1Q+2                                                     
         STC   RF,FFTLN                                                         
         J     ADDFFT15                                                         
*&&                                                                             
                                                                                
ADDFFT13 BASR  RE,0                                                             
         MVC   FFTDATA(0),1(R7)                                                 
         EX    RF,0(RE)                                                         
         AHI   RF,FFTLN1Q+2                                                     
         STC   RF,FFTLN                                                         
                                                                                
ADDFFT15 GOTOR AUDFFT,DMCB,OLD.FFTELD,FFTELD                                    
         OC    AELEMENT,AELEMENT   Do we have an existing element               
         JZ    ADDFFT17                                                         
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),('FFTELQ',ACTRECD),           +        
               (1,BYTE1)                                                        
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
ADDFFT17 CLI   FFTEL,FFTELQ        Do we have any data                          
         JNE   ADDFFT20            No                                           
         GOTO1 VHELLO,DMCB,(C'P',ACCMST),ACTRECD,FFTELD                         
         CLI   12(R1),0                                                         
         JE    ADDFFT20                                                         
         DC    H'0'                                                             
ADDFFT20 LA    R6,FFTTABL(R6)                                                   
         CLI   FFTTIND1,X'FF'                                                   
         JNE   ADDFFT02                                                         
*&&US*&& J     EXITY                                                            
*&&UK                                                                           
         CLI   QA_VATRG,C' '                                                    
         JNH   ADDFFT42                                                         
*                                                                               
         CLI   CUCTRY,CTRYGER      GERMANY?                                     
         JNE   *+14                                                             
         CLC   =C'2D',ACTKUNT      2D LEDGER PLUS                               
         JE    ADDFFT30                                                         
         CLC   =C'SJ',ACTKUNT      SJ CLIENT/PRODUCT                            
         JNE   ADDFFT27                                                         
         TM    ACTRSTAT,ACTSABLP   CHECK NOT LOW LEVEL                          
         JZ    ADDFFT35                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$NOHLV),(5,=C'EC089'),=AL2(FLD146)            
         J     ADDFFT42            NOT A HIGH LEVEL ACCOUNT                     
*                                                                               
ADDFFT27 CLC   =C'SG',ACTKUNT      VAT LEDGER                                   
         JE    ADDFFT30                                                         
         CLC   =C'SR',ACTKUNT      DEBTOR LEDGER                                
         JE    ADDFFT30                                                         
         CLC   =C'SX',ACTKUNT                                                   
         JE    ADDFFT30                                                         
         CLC   =C'SF',ACTKUNT                                                   
         JE    ADDFFT30                                                         
         CLC   =C'SV',ACTKUNT                                                   
         JE    ADDFFT30                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$ILVAT),(5,=C'EC006'),=AL2(FLD146)            
         J     ADDFFT42            OPTION NOT VALID FOR THIS LEDGER             
*                                                                               
ADDFFT30 DS    0H                                                               
         TM    ACTRSTAT,ACTSABLP                                                
         JO    ADDFFT35                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$VATLL),(5,=C'EC007'),=AL2(FLD146)            
         J     ADDFFT42            NOT A LOWER LEVEL ACCOUNT                    
*                                                                               
ADDFFT35 DS    0H                                                               
         CLI   QA_VATRG,DDTAXLEQ   EUROPEAN                                     
         JE    ADDFFT42                                                         
         CLI   QA_VATRG,DDTAXLXQ   NON EUROPEAN                                 
         JE    ADDFFT42                                                         
         CLC   =C'SG',ACTKUNT      VAT LEDGER                                   
         JE    ADDFFT40            YES - ONLY ALLOW E OR X                      
         CLI   QA_VATRG,DDTAXLNQ   NATIONAL                                     
         JE    ADDFFT42                                                         
         J     ADDFFT41                                                         
*                                                                               
ADDFFT40 GOTOR SAVERR,DMCB,=AL2(AE$VINVI),(5,=C'EC008'),=AL2(FLD146)            
         J     EXITY               VAT REGION NO VALID FOR LEDGER               
*                                                                               
ADDFFT41 GOTOR SAVERR,DMCB,=AL2(AE$INVTR),(5,=C'EC008'),=AL2(FLD146)            
         J     EXITY               VAT REGION NOT VALID                         
*                                                                               
ADDFFT42 OC    QA_TAX,QA_TAX       ANY TAX REGISTRATION NUMBER?                 
         JNZ   ADDFFT44                                                         
         CLI   QA_VATRG,DDTAXLEQ   EUROPEAN                                     
         JE    *+12                                                             
         CLI   QA_VATRG,DDTAXLNQ   NATIONAL                                     
         JNE   EXITY                                                            
         LHI   RF,AE$MISIF         MUST HAVE TAX REG. IF EUROPEAN OR            
         J     ADDFFT46            NATIONAL                                     
*                                                                               
ADDFFT44 L     RF,=V(DDTAXVAL)                                                  
         A     RF,SRVRRELO                                                      
         GOTOR (RF),DMCB,(QA_VATRG,QA_TAX),(CUCTRY,CPXSTAT8)                    
         JE    EXITY                                                            
         CLI   7(R1),DDTERICQ      INVALID COUNTRY                              
         JNE   *+8                                                              
         LHI   RF,AE$INVCO                                                      
         CLI   7(R1),DDTERILQ     INVALID LOCATION                              
         JNE   *+8                                                              
         LHI   RF,AE$INVTR                                                      
         CLI   7(R1),DDTERITQ     INVALID TAX CODE                              
         JNE   *+8                                                              
         LHI   RF,AE$INVRN                                                      
         CLI   7(R1),DDTERNTQ     NO TAX CODE ALLOWED                           
         JNE   *+8                                                              
         LHI   RF,AE$NOVRN                                                      
         CLI   7(R1),DDTERMTQ     MISSING TAX NUMBER                            
         JNE   *+8                                                              
         LHI   RF,AE$MISIF                                                      
         CLI   7(R1),DDTERMRQ     MISSING VAT REGION                            
         JNE   *+8                                                              
         LHI   RF,AE$MVREG                                                      
*                                                                               
         LTR   RF,RF              SET DEFAULT ERROR MESSAGE TO BE SAFE          
         JNZ   *+8                                                              
         LHI   RF,AE$INVTR                                                      
*                                                                               
ADDFFT46 STH   RF,HALF1                                                         
         GOTOR SAVERR,DMCB,HALF1,(5,=C'EC101'),=AL2(FLD062)                     
         J     EXITY                                                            
*                                                                               
*&&                                                                             
         DROP  OLD,R2,R4,R6                                                     
                                                                                
***********************************************************************         
* Add glpel to account record                                         *         
***********************************************************************         
         SPACE 1                                                                
ADDGLP   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDGLP*'                                                      
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   EXITY                                                            
         USING ACTRECD,R4                                                       
         L     R4,AIO3                                                          
* Add further code here to process general ledger information                   
         J     EXITY                                                            
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* Add snmel to account record                                         *         
***********************************************************************         
         SPACE 1                                                                
ADDSNM   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDSNM*'                                                      
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   EXITY                                                            
         XC    ELEMENT,ELEMENT                                                  
         XC    AELEMENT,AELEMENT                                                
         L     R3,AIO3                                                          
         USING ACTRECD,R3                                                       
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('SNMELQ',ACTRECD),0                   
         CLI   12(R1),0            Does short name exist                        
         JNE   ADDSNM02            No                                           
         L     R2,12(R1)           Yes                                          
         ST    R2,AELEMENT         Save address of element                      
         USING SNMELD,R2                                                        
         CLC   SNMNAME,QA_SHNAM    Is it the same as new name                   
         JE    EXITY               Yes - nothing else to do                     
         OC    QA_SHNAM,QA_SHNAM   Have we got a new name                       
         JZ    ADDSNM04            No - just delete elemtn                      
* for SAP migration, do not update short name                                   
         CLI   QA_UPLD,QA_SAPTL                                                 
         JNE   ADDSNM01                                                         
         MVC   QA_SHNAM,SNMNAME                                                 
*                                                                               
ADDSNM01 CLC   SNMNAME,QA_SHNAM    Is it the same as new name                   
         JE    EXITY               Yes - nothing else to do                     
         OC    QA_SHNAM,QA_SHNAM   Have we got a new name                       
         JZ    ADDSNM04            No - just delete elemtn                      
ADDSNM02 OC    QA_SHNAM,QA_SHNAM   Have we got a new name                       
         JZ    EXITY               No - exit nothing to do                      
         LA    R2,ELEMENT                                                       
         USING SNMELD,R2                                                        
         MVC   SNMNAME,QA_SHNAM                                                 
*                                                                               
         CLI   QA_UPLD,QA_SAPTL    If we're doing upload tool                   
         JNE   *+10                make sure it is upper case                   
         OC    SNMNAME,SPACES                                                   
*                                                                               
         MVI   SNMEL,SNMELQ                                                     
         MVI   SNMLN,SNMLNQ                                                     
ADDSNM04 GOTOR AUDSNM                                                           
         OC    AELEMENT,AELEMENT   Does element exist of record                 
         JZ    ADDSNM06            No                                           
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),('SNMELQ',ACTRECD)                     
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
ADDSNM06 OC    QA_SHNAM,QA_SHNAM   Do we have a new name                        
         JZ    EXITY               No                                           
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,SNMELD                         
         CLI   12(R1),0                                                         
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  R2,R3                                                            
         EJECT                                                                  
***********************************************************************         
* Add xnmel to account record                                         *         
***********************************************************************         
         SPACE 1                                                                
ADDXNM   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDXNM*'                                                      
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   EXITY                                                            
         XC    ELEMENT,ELEMENT                                                  
         XC    AELEMENT,AELEMENT                                                
*                                                                               
         L     R3,AELEMENT                                                      
         L     R4,AIO3                                                          
         USING ACTRECD,R4                                                       
         MVC   AC_NAMLL,QA_OVNML                                                
         CLC   PRODUL,ACTKUNT                                                   
         JE    *+10                                                             
         MVC   AC_NAMLL,QA_FNAML                                                
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('XNMELQ',ACTRECD),0                   
         CLI   12(R1),0            Does extra name exist                        
         JNE   ADDXNM02            No                                           
         L     R3,12(R1)           Yes                                          
         ST    R3,AELEMENT         Save address of element                      
OLD      USING XNMELD,R3                                                        
         LLC   RE,OLD.XNMSUBL      RE=Existing name length                      
         SHI   RE,1                                                             
         LLC   RF,AC_NAMEL         RF=New name length                           
         SHI   RF,1                                                             
         CR    RF,RE               Is the length the same                       
         JNE   ADDXNM02            No - must be a different name                
         BASR  RE,0                                                             
         CLC   OLD.XNMSUBN(0),AC_NAME Is it the same as new name                
         EX    RF,0(RE)                                                         
         JE    EXITY               Yes - nothing else to do                     
ADDXNM02 OC    AC_NAME,AC_NAME     Have we got a new name                       
         JZ    ADDXNM04            No - just delete element                     
         LLC   RF,AC_NAMEL         RF=New name length                           
         SHI   RF,1                                                             
         LA    R2,ELEMENT                                                       
         USING XNMELD,R2                                                        
         MVI   XNMEL,XNMELQ                                                     
         MVI   XNMLN,XNMLN1Q                                                    
         BASR  RE,0                                                             
         MVC   XNMSUBN(0),AC_NAME                                               
         EX    RF,0(RE)                                                         
         AHI   RF,2                +2 to include element length                 
         STC   RF,XNMSUBL                                                       
         AHI   RF,XNMLN1Q+L'XNMSUBL-1                                           
         STC   RF,XNMLN                                                         
ADDXNM04 GOTOR AUDXNM,DMCB,OLD.XNMELD,XNMELD                                    
         OC    AELEMENT,AELEMENT   Does element exist of record                 
         JZ    ADDXNM06            No                                           
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),('XNMELQ',ACTRECD)                     
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
ADDXNM06 OC    AC_NAME,AC_NAME     Do we have a new name                        
         JZ    EXITY               No                                           
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,XNMELD                         
         CLI   12(R1),0                                                         
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  R2,R4                                                            
         EJECT                                                                  
***********************************************************************         
* Add jldeld to account record                                        *         
***********************************************************************         
                                                                                
ADDJLD   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDJLD*'                                                      
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   EXITY                                                            
         XC    ELEMENT,ELEMENT                                                  
         XC    BYTE1,BYTE1                                                      
         XC    BYTE2,BYTE2                                                      
         XC    HALF1,HALF1                                                      
         XC    HALF2,HALF2                                                      
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO5                                        
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO6                                        
         L     R2,AIO5                                                          
         L     R4,AIO3                                                          
         USING ACTRECD,R4                                                       
         LA    R3,ACTRFST                                                       
OLD      USING JLDELD,R3                                                        
ADDJLD02 CLI   OLD.JLDEL,0         End of record?                               
         JE    ADDJLD4A            Yes                                          
         CLI   OLD.JLDEL,JLDELQ    Description element                          
         JE    ADDJLD04            Yes                                          
         LLC   RE,OLD.JLDLN                                                     
         AR    R3,RE                                                            
         J     ADDJLD02                                                         
*                                                                               
ADDJLD04 LLC   RF,BYTE1            Yes - Increment sequence number              
         AHI   RF,1                                                             
         STC   RF,BYTE1            Save seq for next element read               
         LLC   RF,OLD.JLDLN        RF=Existing name length                      
         SHI   RF,JLDLNQ+1                                                      
         BASR  RE,0                                                             
         MVC   0(0,R2),OLD.JLDDESC Copy existing elements to AIO5               
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         AR    R2,RF                                                            
         LH    RE,HALF1                                                         
         AR    RE,RF                                                            
         STH   RE,HALF1                                                         
         AHI   RF,JLDLNQ                                                        
         AR    R3,RF                                                            
         J     ADDJLD02                                                         
                                                                                
ADDJLD4A GOTO1 VHELLO,DMCB,(C'D',ACCMST),('JLDELQ',ACTRECD)                     
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R4,AIO4                                                          
         USING AEXRECD,R4                                                       
         OC    HALF1,HALF1                                                      
         JNZ   ADDJLD05                                                         
         LA    R3,AEXRFST                                                       
OLD      USING JLDELD,R3                                                        
ADDJLD4B CLI   OLD.JLDEL,0         End of record?                               
         JE    ADDJLD4D            Yes                                          
         CLI   OLD.JLDEL,JLDELQ    Description element                          
         JE    ADDJLD4C            Yes                                          
         LLC   RE,OLD.JLDLN                                                     
         AR    R3,RE                                                            
         J     ADDJLD4B                                                         
*                                                                               
ADDJLD4C LLC   RF,BYTE1            Yes - Increment sequence number              
         AHI   RF,1                                                             
         STC   RF,BYTE1            Save seq for next element read               
         LLC   RF,OLD.JLDLN        RF=Existing name length                      
         SHI   RF,JLDLNQ+1                                                      
         BASR  RE,0                                                             
         MVC   0(0,R2),OLD.JLDDESC Copy existing elements to AIO5               
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         AR    R2,RF                                                            
         LH    RE,HALF1                                                         
         AR    RE,RF                                                            
         STH   RE,HALF1                                                         
         AHI   RF,JLDLNQ                                                        
         AR    R3,RF                                                            
         J     ADDJLD4B                                                         
         DROP  OLD                                                              
                                                                                
ADDJLD4D OC    HALF1,HALF1                                                      
         JZ    ADDJLD05                                                         
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),('JLDELQ',AEXRECD)                     
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
ADDJLD05 L     R2,AIO6                                                          
         XR    R3,R3                                                            
         ICM   R3,7,QA_ADESC       R3=A(Uploaded long description)              
         JZ    ADDJLD08            No data just delete                          
         SR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R3)  Number of long descriptions               
         AHI   R3,LW_LN2Q          R3=A(first address line data)                
ADDJLD06 LLC   RF,0(R3)                                                         
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,R2),1(R3)       Set description                              
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         AR    R2,RF                                                            
         LH    RE,HALF2                                                         
         AR    RE,RF                                                            
         STH   RE,HALF2            Save total length of all elements            
         LLC   RF,BYTE2            Increment sequence number                    
         AHI   RF,1                                                             
         STC   RF,BYTE2                                                         
         LA    R3,L'JLDDESC+1(R3)                                               
         JCT   R0,ADDJLD06         Get next                                     
*                                                                               
ADDJLD08 LLC   R0,BYTE1            Set R0 with the highest number               
         CLC   BYTE1,BYTE2         More description before                      
         JNL   *+10                Yes                                          
         LLC   R0,BYTE2            No - more now                                
         LTR   R0,R0               Have we got any description                  
         JZ    EXITY               No - exit                                    
                                                                                
ADDJLD10 SR    RE,RE                                                            
         ICM   RE,3,HALF1          Has old element got any length               
         JZ    ADDJLD12            No - element must have been added            
         SR    RF,RF                                                            
         ICM   RF,3,HALF2          Has new element got any length               
         JZ    ADDJLD12            No - element deleted                         
         CR    RE,RF               Is the length the same                       
         JNE   ADDJLD12            No - data must be different                  
         LR    R1,RF               Yes - compare data                           
         L     R0,AIO5                                                          
         L     RE,AIO6                                                          
         CLCL  R0,RE               Compare old and new elements                 
         JNE   ADDJLD12            Not the same - create audit                  
         J     ADDJLD14            Must have matched                            
                                                                                
ADDJLD12 GOTOR AUDJLD,DMCB,AIO5,AIO6                                            
ADDJLD14 OC    HALF2,HALF2         Do we have a new description                 
         JZ    ADDJLD20            No                                           
         L     R2,AIO6                                                          
         XC    BYTE2,BYTE2                                                      
         USING JLDELD,R2                                                        
         XR    R3,R3                                                            
         ICM   R3,7,QA_ADESC       R3=A(Uploaded long description)              
         JZ    ADDJLD20            No data just delete                          
         SR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R3)  Number of long descriptions               
         AHI   R3,LW_LN2Q          R3=A(first address line data)                
ADDJLD16 LLC   RF,0(R3)                                                         
         MVI   JLDEL,JLDELQ        Build new elements into AIO5                 
         MVC   JLDSEQ,BYTE2        Set sequence number                          
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   JLDDESC(0),1(R3)    Set description                              
         EX    RF,0(RE)                                                         
         AHI   RF,1+JLDLNQ                                                      
         STC   RF,JLDLN            Set length of element                        
         AR    R2,RF                                                            
         LLC   RF,BYTE2            Increment sequence number                    
         AHI   RF,1                                                             
         STC   RF,BYTE2                                                         
         LA    R3,L'JLDDESC+1(R3)                                               
         JCT   R0,ADDJLD16         Get next                                     
         L     R2,AIO6                                                          
         LLC   R0,BYTE2                                                         
ADDJLD18 GOTOR VHELLO,DMCB,(C'P',ACCMST),AEXRECD,JLDELD                         
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
         LLC   RF,JLDLN            RF=length of new element                     
         AR    R2,RF               Bump to next new element                     
         JCT   R0,ADDJLD18         Look at next set of elements                 
ADDJLD20 J     EXITY               All done                                     
         DROP  R2,R4                                                            
         EJECT                                                                  
***********************************************************************         
* Add scmeld to account record                                        *         
***********************************************************************         
         SPACE 1                                                                
ADDSCM   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDSCM*'                                                      
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   EXITY                                                            
         XC    ELEMENT,ELEMENT                                                  
         XC    BYTE1,BYTE1                                                      
         XC    BYTE2,BYTE2                                                      
         XC    HALF1,HALF1                                                      
         XC    HALF2,HALF2                                                      
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO5                                        
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO6                                        
         L     R2,AIO5                                                          
         L     R4,AIO3                                                          
         USING ACTRECD,R4                                                       
         LA    R3,ACTRFST                                                       
OLD      USING SCMELD,R3                                                        
ADDSCM02 CLI   OLD.SCMEL,0         End of record?                               
         JE    ADDSCM05            Yes                                          
         CLI   OLD.SCMEL,SCMELQ    Comment element                              
         JE    ADDSCM04            Yes                                          
         LLC   RE,OLD.SCMLN                                                     
         AR    R3,RE                                                            
         J     ADDSCM02                                                         
*                                                                               
ADDSCM04 LLC   RF,BYTE1            Yes - Increment sequence number              
         AHI   RF,1                                                             
         STC   RF,BYTE1                                                         
         LA    R7,OLD.SCMNARR                                                   
         LLC   RF,OLD.SCMLN                                                     
         SHI   RF,1+SCMLN1Q                                                     
         TM    OLD.SCMTYPE,SCMTPRBI                                             
         JZ    ADDSCM4B                                                         
         MVC   0(4,R2),=C'BIL='                                                 
         AHI   R2,4                                                             
ADDSCM4A CLI   0(R7),C' '                                                       
         JH    ADDSCM4B                                                         
         SHI   RF,1                                                             
         AHI   R7,1                                                             
         J     ADDSCM4A                                                         
ADDSCM4B BASR  RE,0                                                             
         MVC   0(0,R2),0(R7)       Copy existing elements to AIO5               
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         AR    R2,RF                                                            
         MVI   0(R2),C' '                                                       
         AHI   R2,1                                                             
         TM    OLD.SCMTYPE,SCMTPRBI                                             
         JZ    ADDSCM4H                                                         
         AHI   RF,5                                                             
ADDSCM4H LH    RE,HALF1                                                         
         AR    RE,RF                                                            
         STH   RE,HALF1                                                         
         LLC   RE,1(R3)                                                         
         AR    R3,RE                                                            
         J     ADDSCM02                                                         
         DROP  OLD                                                              
*                                                                               
ADDSCM05 L     R2,AIO6                                                          
         USING SCMELD,R2                                                        
         XR    R3,R3                                                            
         ICM   R3,7,QA_ACOMM       R3=A(Uploaded comments)                      
         JZ    ADDSCM08            No data just delete                          
         SR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R3)  Number of comments                        
         AHI   R3,LW_LN2Q          R3=A(first comment data)                     
ADDSCM06 LLC   RF,0(R3)                                                         
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,R2),1(R3)       Set description                              
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         AR    R2,RF                                                            
         MVI   0(R2),C' '                                                       
         AHI   R2,1                                                             
         AHI   RF,1                                                             
         LH    RE,HALF2                                                         
         AR    RE,RF                                                            
         STH   RE,HALF2            Save total length of all elements            
         LLC   RF,BYTE2            Increment sequence number                    
         AHI   RF,1                                                             
         STC   RF,BYTE2                                                         
         LA    R3,L'SCMTEXT+1(R3)                                               
         JCT   R0,ADDSCM06         Get next                                     
*                                                                               
ADDSCM08 CLI   QA_UPLD,QA_ACCTL    If upload tool don't check lengths           
         JE    ADDSCM09                                                         
         LLC   R0,BYTE1            Set R0 with the highest number               
         CLC   BYTE1,BYTE2         More description before                      
         JNL   *+10                Yes                                          
         LLC   R0,BYTE2            No - more now                                
         LTR   R0,R0               Have we got any description                  
         JZ    EXITY               No - exit                                    
                                                                                
ADDSCM09 L     R2,AIO6             R2=A(new scmels)                             
         L     R3,AIO5             R3=A(old scmels)                             
ADDSCM10 SR    RE,RE                                                            
         ICM   RE,3,HALF1          Has old element got any length               
         JZ    ADDSCM14            No - element must have been added            
         SR    RF,RF                                                            
         ICM   RF,3,HALF2          Has new element got any length               
         JZ    ADDSCM12            No - element deleted                         
         CR    RE,RF               Is the length the same                       
         JNE   ADDSCM12            No - data must be different                  
         LR    R1,RF                                                            
         L     RE,AIO5                                                          
         L     R0,AIO6                                                          
         CLCL  RE,R0               Compare old and new elements                 
         JE    ADDSCM22            All elements must have matched               
                                                                                
ADDSCM12 GOTO1 VHELLO,DMCB,(C'D',ACCMST),('SCMELQ',ACTRECD)                     
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
ADDSCM14 GOTOR AUDSCM,DMCB,AIO5,AIO6                                            
         OC    HALF2,HALF2         Do we have a new name                        
         JZ    ADDSCM22            No                                           
         XC    BYTE2,BYTE2                                                      
         L     R2,AIO6                                                          
         USING SCMELD,R2                                                        
         XR    R3,R3                                                            
         ICM   R3,7,QA_ACOMM       R3=A(Uploaded comments)                      
         JZ    ADDSCM22            No data just delete                          
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO6                                        
         SR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R3) Number of comments                         
         AHI   R3,LW_LN2Q          R3=A(first comment data)                     
*&&US                                                                           
ADDSCM16 BRAS  RE,SCMSCAN                                                       
         JNE   EXITN                                                            
*&&                                                                             
*&&UK                                                                           
ADDSCM16 LLC   RF,0(R3)                                                         
         MVI   SCMEL,SCMELQ        Build new elements into AIO5                 
         MVI   SCMTYPE,SCMTPRBI+SCMTPRAD                                        
         MVC   SCMSEQ,BYTE2        Set sequence number                          
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   SCMNARR(0),1(R3)    Set description                              
         EX    RF,0(RE)                                                         
         AHI   RF,1+SCMLN1Q                                                     
         STC   RF,SCMLN            Set length of element                        
         AR    R2,RF                                                            
         LLC   RF,BYTE2            Increment sequence number                    
         AHI   RF,1                                                             
         STC   RF,BYTE2                                                         
*&&                                                                             
         LA    R3,L'SCMTEXT+1(R3)                                               
         JCT   R0,ADDSCM16         Get next                                     
         L     R2,AIO6                                                          
         LLC   R0,BYTE2                                                         
ADDSCM18 GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,SCMELD                         
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
         LLC   RF,SCMLN            RF=length of new element                     
         AR    R2,RF               Bump to next new element                     
         JCT   R0,ADDSCM18         Look at next set of elements                 
                                                                                
ADDSCM22 J     EXITY               All done                                     
         EJECT                                                                  
*&&US                                                                           
*----------------------------------------------------------------------         
* Scanner the comment line and parse from there                                 
*----------------------------------------------------------------------         
SCMSCAN  NTR1                                                                   
                                                                                
         MVI   DMCB,0                                                           
                                                                                
         MVC   TEMP,SPACES         move whole comment to TEMP                   
         MVC   BYTE3,0(R3)                                                      
         LLC   RF,BYTE3                                                         
         AHI   RF,-1                                                            
         BASR  RE,0                                                             
         MVC   TEMP(0),1(R3)       move data over                               
         EX    RF,0(RE)                                                         
                                                                                
SCMSC010 CLI   BYTE3,0             nothing left to process                      
         JE    SCMSC990                                                         
                                                                                
         MVI   SCMNARR,C' '        clear out SCMNARR                            
         MVC   SCMNARR+1(L'SCMNARR-1),SCMNARR                                   
         MVI   SCMEL,SCMELQ        Build new elements into AIO5                 
         MVC   SCMSEQ,BYTE2        Set sequence number                          
         MVI   SCMTYPE,0                                                        
                                                                                
         LLC   RF,BYTE3                                                         
         CLC   =C'BIL=',TEMP       BIL=?                                        
         JNE   SCMSC700            no, save as normal comment                   
         MVI   DMCB,1              processed at least 1 BIL=                    
         AHI   RF,-4                                                            
         LA    R3,TEMP+4                                                        
         MVC   WORK2,SPACES                                                     
         LA    RE,WORK2                                                         
         XR    R1,R1                                                            
SCMSC020 CLI   0(R3),C','          break on comma                               
         JE    SCMSC030                                                         
         MVC   0(1,RE),0(R3)       copy the 2nd half to WORK2                   
         AHI   R1,1                                                             
         AHI   R3,1                                                             
         AHI   RE,1                                                             
         JCT   RF,SCMSC020                                                      
                                                                                
SCMSC030 STC   R1,BYTE4            save length                                  
         MVC   TEMP2,SPACES                                                     
         LTR   RF,RF               anything left?                               
         JZ    SCMSC040                                                         
         AHI   RF,-1                                                            
         LR    R1,RF               copy RF for move                             
         AHI   R1,-1                                                            
         BASR  RE,0                                                             
         MVC   TEMP2(0),1(R3)      copy what is left                            
         EX    R1,0(RE)                                                         
                                                                                
SCMSC040 STC   RF,BYTE3            new length                                   
         MVC   TEMP,TEMP2                                                       
         MVI   SCMTYPE,SCMTPRBI+SCMTPRAD                                        
                                                                                
         LLC   RF,BYTE4            2nd field length                             
         CLI   BYTE4,6             Don't take more than 6 chars                 
         JNH   *+8                                                              
         LHI   RF,6                                                             
                                                                                
         LHI   R4,6                                                             
         SR    R4,RF                                                            
         LA    R4,SCMNARR(R4)      Right justify data                           
                                                                                
         AHI   RF,-1                                                            
                                                                                
         BASR  RE,0                move comment into element                    
         MVC   0(0,R4),WORK2                                                    
         EX    RF,0(RE)                                                         
                                                                                
         LHI   RF,L'SCMCODE+SCMLN1Q    calculate new element length             
         J     SCMSC900            bump next sequence number                    
                                                                                
SCMSC700 CLI   DMCB,0              move comment into element                    
         JE    SCMSC710                                                         
         MVC   ROUERRV,=AL2(AE$INVIF)                                           
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
         J     EXITN                                                            
SCMSC710 BASR  RE,0                move comment into element                    
         MVC   SCMNARR(0),TEMP                                                  
         EX    RF,0(RE)                                                         
         AHI   RF,1+SCMLN1Q        calculate new element length                 
         MVI   BYTE3,0                                                          
                                                                                
SCMSC900 STC   RF,SCMLN                                                         
         AR    R2,RF               bump to build next element                   
         LLC   RF,BYTE2            bump next sequence number                    
         AHI   RF,1                                                             
         STC   RF,BYTE2                                                         
         J     SCMSC010            look for more                                
                                                                                
SCMSC990 J     EXITYR2             R2 holds A(next element)                     
                                                                                
*&&                                                                             
         DROP  R2,R4                                                            
         EJECT                                                                  
***********************************************************************         
* Add spaeld(s) to account record (Driven by SPATAB)                            
***********************************************************************         
         SPACE 1                                                                
ADDSPA   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDSPA*'                                                      
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   EXITY                                                            
         XC    SVMSTJOB,SVMSTJOB   CLEAR OLD MASTER JOB                         
         USING ACTRECD,R4                                                       
         L     R4,AIO3                                                          
         USING SPATABD,R6                                                       
         LA    R6,SPATAB                                                        
ADDSPA10 XC    ELEMENT,ELEMENT                                                  
         XC    AELEMENT,AELEMENT                                                
         XC    BYTE1,BYTE1                                                      
         LH    R7,SPAADRAC                                                      
         AR    R7,R8                                                            
         L     R3,AELEMENT                                                      
         CLI   SPATTYPE,SPATMJOB                                                
         JNE   ADDSPA15                                                         
         CLI   QA_MAST,YESQ         IGNORE MASTER JOB INF IF MASTER JOB         
         JE    ADDSPA80                                                         
         CLC   PRODUL,QA_UNIT                                                   
         JNE   ADDSPA15                                                         
*                                                                               
         CLC   LDGAUL,QA_UNIT      MAKE SURE WE HAVE RIGHT LDG VALUES           
         JE    ADDSPA12                                                         
         MVC   LDGAUL,QA_UNIT                                                   
         GOTOR (#SETLDG,ASETLDG)                                                
*                                                                               
ADDSPA12 MVC   AC_CULA,SPACES      Clear account area                           
         MVC   AC_UNIT(L'PRODUL),PRODUL  Unit ledger                            
         LLC   RF,LDGAL1           Length of client                             
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   AC_ACT(0),QA_MCLI   Extract client code to account area          
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         LA    R1,AC_ACT                                                        
         AR    R1,RF                                                            
         LLC   RE,LDGAL2                                                        
         SR    RE,RF                                                            
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   0(0,R1),QA_MPRO     Extract product code to ac area              
         EX    RE,0(RF)                                                         
         AHI   RE,1                                                             
         AR    R1,RE                                                            
         LLC   RF,LDGAL3                                                        
         LLC   RE,LDGAL2                                                        
         SR    RF,RE                                                            
         CHI   RF,7                                                             
         JNE   *+8                                                              
         LA    RF,6                                                             
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,R1),QA_MJOB     Extract job code to ac area                  
         EX    RF,0(RE)                                                         
ADDSPA15 MVC   BYTE1,SPATTYPE                                                   
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('SPAELQ',ACTRECD),           +        
               (1,BYTE1)                                                        
         CLI   12(R1),0            Existing elem for spattype?                  
         JNE   ADDSPA30            No                                           
         L     R3,12(R1)           Yes                                          
         ST    R3,AELEMENT         Save address of element                      
OLD      USING SPAELD,R3                                                        
         TM    SPASTAT,SPASCPJ     client product job type                      
         JNZ   ADDSPA25            Yes                                          
         TM    SPASTAT,SPASUL      Is the unit ledger included                  
         JNZ   ADDSPA20            Yes                                          
         CLC   OLD.SPAAACT,0(R7)   Is it the same as before                     
         JE    ADDSPA70            Yes - nothing else to do                     
         J     ADDSPA30                                                         
                                                                                
ADDSPA20 CLC   OLD.SPAAULA,0(R7)   Is it the same as before                     
         JE    ADDSPA70            Yes - nothing else to do                     
         J     ADDSPA30                                                         
                                                                                
ADDSPA25 CLC   OLD.SPAAULA,AC_ULA  Is it the same as before                     
         JE    ADDSPA70            Yes - nothing else to do                     
         MVC   SVMSTJOB,OLD.SPAAACT  Save old master job                        
*                                                                               
* Something's changed, validate and update                                      
ADDSPA30 DS    0H                                                               
         LA    R2,ELEMENT                                                       
         OC    0(L'ACTKACT,R7),0(R7)  Have we got a new name                    
         JZ    ADDSPA55            No - just delete element                     
         USING SPAELD,R2                                                        
         MVI   SPAEL,SPAELQ                                                     
         MVI   SPALN,SPALNQ                                                     
         MVC   SPATYPE,SPATTYPE                                                 
         TM    SPASTAT,SPASCPJ     Client prod job has ledger                   
         JNZ   ADDSPA53                                                         
         TM    SPASTAT,SPASUL      Is the unit ledger included                  
         JNZ   ADDSPA50            Yes                                          
         MVC   SPAAUNT(L'SPATUL),SPATUL                                         
         MVC   SPAAACT,0(R7)                                                    
         J     *+10                                                             
ADDSPA50 MVC   SPAAULA,0(R7)                                                    
         J     *+10                                                             
ADDSPA53 MVC   SPAAULA,AC_ULA                                                   
                                                                                
ADDSPA55 GOTOR AUDSPA,DMCB,OLD.SPAELD,SPAELD                                    
         DROP  OLD                                                              
         OC    AELEMENT,AELEMENT   Does element exist of record                 
         JZ    ADDSPA60            No                                           
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),('SPAELQ',ACTRECD),           +        
               (1,BYTE1)                                                        
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
ADDSPA60 OC    0(L'ACTKACT,R7),0(R7) Do we have a Bank charges account          
         JZ    ADDSPA80            No                                           
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,SPAELD                         
         CLI   12(R1),0                                                         
         JE    ADDSPA70                                                         
*        JE    EXITY                                                            
         DC    H'0'                                                             
ADDSPA70 TM    SPASTAT,SPASNAM     Can name be changed                          
         JZ    ADDSPA80            No                                           
         MVC   AC_CPY,CUXCPY                                                    
         TM    SPASTAT,SPASUL      Is the unit ledger included                  
         JNZ   ADDSPA75            Yes                                          
         MVC   AC_UNIT(L'SPATUL),SPATUL  No - need to build them in             
         MVC   AC_ACT,0(R7)                                                     
         J     *+10                                                             
ADDSPA75 MVC   AC_ULA,0(R7)                                                     
         LH    R7,SPAADRNM                                                      
         AR    R7,R8                                                            
         MVC   AC_NAMLL,0(R7)                                                   
         GOTOR UPDACN                                                           
         JE    ADDSPA80                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$MIACC),(L'AC_ULA,AC_ULA),SPADFLDN            
         OI    TWAMODE,TWAMUWD                                                  
*                                                                               
ADDSPA80 LA    R6,SPATABL(R6)                                                   
         CLI   SPASTAT,X'FF'                                                    
         JNE   ADDSPA10                                                         
         DROP  R2                                                               
*                                                                               
*&&UK                                                                           
         CLI   QA_UPLD,QA_SAPTL    EXTRA VALIDATION FOR UPLOAD TOOL(S)          
         JE    *+12                                                             
         CLI   QA_UPLD,QA_ACCTL                                                 
         JNE   ADDSPA82                                                         
         GOTOR VALSPA               Validate SPAELD                             
*&&                                                                             
         USING ACTRECD,R4                                                       
ADDSPA82 CLC   QA_MCLI,SPACES       Any client code?                            
         JNH   EXITY                                                            
         CLI   QA_MAST,YESQ         Master job then ignore master job           
         JE    EXITY                info                                        
*                                   Check that master job exists                
         LA    R4,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(L'PRODUL),PRODUL                                         
         LLC   RF,LDGAL1            Length of client                            
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   ACTKACT(0),QA_MCLI   Extract client code to account area         
         EX    RF,0(RE)                                                         
         LA    R2,ACTKACT                                                       
         AHI   RF,1                                                             
         AR    R2,RF                                                            
         LLC   RE,LDGAL2                                                        
         SR    RE,RF                                                            
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   0(0,R2),QA_MPRO                                                  
         EX    RE,0(RF)                                                         
         AHI   RE,1                                                             
         AR    R2,RE                                                            
         LLC   RF,LDGAL3                                                        
         LLC   RE,LDGAL2                                                        
         SR    RF,RE                                                            
         CHI   RF,7                                                             
         JNE   *+8                                                              
         LA    RF,6                                                             
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,R2),QA_MJOB     Extract job code to ac area                  
         EX    RF,0(RE)                                                         
*                                                                               
         CLI   QA_UPLD,QA_ACCTL    Only for accounting tool/SAP tool            
         JE    *+12                                                             
         CLI   QA_UPLD,QA_SAPTL    Validated on front end in BO/Aura            
         JNE   ADDSPA84                                                         
         L     R1,=AL4(IORDD+IODIR+IO2)                                         
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    ADDSPA84                                                         
         CLI   IOERR,IOEDEL                                                     
         JE    ADDSPA84            Master job doesn't exist!                    
         GOTOR SAVERR,DMCB,=AL2(AE$MJOBM),(5,=C'EC102'),=AL2(FLD110)            
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITY                                                            
*                                                                               
ADDSPA84 L     R1,=AL4(IORDUPD+IODIR+IO2)                                       
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+8                                                              
         CLI   IOERR,IOEDEL                                                     
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R1,=AL4(IOGETRUP+IOMST+IO2)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R4,AIO2                                                          
         LA    R3,ACTRFST                                                       
*                                                                               
         USING SPAELD,R3                                                        
ADDSPA86 CLI   SPAEL,0                                                          
         JE    ADDSPA92                                                         
         CLI   SPAEL,SPAELQ        Check if subjob                              
         JE    ADDSPA88                                                         
         CLI   SPAEL,JOBELQ                                                     
         JE    ADDSPA90                                                         
ADDSPA87 LLC   R0,SPALN                                                         
         AR    R3,R0                                                            
         J     ADDSPA86                                                         
*                                                                               
ADDSPA88 CLI   SPATYPE,SPATMJOB    Is this a subjob? Then can't make            
         JNE   ADDSPA87            master job                                   
         GOTOR SAVERR,DMCB,=AL2(AE$UMSJB),(5,=C'EC110'),=AL2(FLD110)            
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
*                                                                               
         USING JOBELD,R3                                                        
ADDSPA90 OI    JOBSTA2,JOBSMST     Set this as a master job                     
         J     ADDSPA87                                                         
*                                                                               
ADDSPA92 NI    ACTRSTA,X'FF'-ACTSDELT                                           
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO2'                           
         JE    *+6                Undelete if necessary                         
         DC    H'0'                                                             
         LA    R2,IOKEY                                                         
         NI    ACTRSTA,X'FF'-ACTSDELT                                           
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR+IO2'                            
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  R3                                                               
         EJECT                                                                  
***********************************************************************         
* Extra validation for SPAELS(only if upload via tool, not BrO)      *          
***********************************************************************         
         SPACE 1                                                                
*&&UK                                                                           
VALSPA   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*VALSPA*'                                                      
*   MUST HAVE NON-EU IF EU, AND VICE VERSA                                      
         CLC   QA_EUSG,SPACES                                                   
         JH    VALSPA05                                                         
         CLC   QA_NESG,SPACES                                                   
         JNH   VALSPA10                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$NEUEU),(5,=C'EC009'),=AL2(FLD140)            
         J     VALSPA10                                                         
*                                                                               
VALSPA05 DS    0H                                                               
         CLC   QA_VATRG,SPACES      (IF HAVE EU, CANNOT HAVE VAT REG)           
         JNH   VALSPA06                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$ICVEU),(5,=C'EC010'),=AL2(FLD146)            
VALSPA06 CLC   QA_NESG,SPACES                                                   
         JH    VALSPA10                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$EUNEU),(5,=C'EC011'),=AL2(FLD141)            
*                                                                               
VALSPA10 DS    0H                                                               
         CLC   QA_EUSG,SPACES                                                   
         JNH   VALSPA15                                                         
         GOTOR VATSPA,DMCB,('SPATSGEU',QA_EUSG),=AL2(FLD140)                    
VALSPA15 DS    0H                                                               
         CLC   QA_NESG,SPACES                                                   
         JNH   VALSPA20                                                         
         GOTOR VATSPA,DMCB,('SPATSGNE',QA_NESG),=AL2(FLD141)                    
VALSPA20 DS    0H                                                               
         CLC   QA_MAAC,SPACES                                                   
         JNH   EXITY                                                            
         GOTOR VATSPA,DMCB,('SPATMAAC',QA_MAAC)                                 
*                                                                               
         J     EXITY                                                            
*&&                                                                             
         EJECT                                                                  
***********************************************************************         
* COMMON VALIDATION FOR VAT ACCOUNTS FOR SPAELS                       *         
* ENTRY: DMCB= SPATYPE+A(SPAEL A/C TO VALIDATE)                                 
* ENTRY: PRIMARY ACCOUNT IN AIO3                                                
* ENTRY: FIELD NUMBER                                                           
* EXIT: SAVERR RUN FOR ANY PROBLEMS.                                            
***********************************************************************         
         SPACE 1                                                                
*&&UK                                                                           
VATSPA   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*VATSPA*'                                                      
*  MUST BE DIFFERENT FROM PRIMARY ACCOUNT                                       
         MVC   FULL1,DMCB                                                       
         L     R1,FULL1                                                         
         OC    0(L'QA_ACT,R1),SPACES                                            
         MVC   HALF1,8(R1)                                                      
         CLC   QA_ACT,0(R1)                                                     
         JNE   VATSPA10                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$IVASM),(5,=C'EC012'),HALF1                   
*                                                                               
VATSPA10 DS    0H                                                               
         L     R3,AIO3             PRIMARY ACCOUNT                              
MAIN     USING ACTRECD,R3                                                       
SUB      USING ACTRECD,R2          THIS ACCOUNT                                 
         TM    MAIN.ACTRSTAT,ACTSABLP   LOW LEVEL A/C?                          
         JNZ   VATSPA13                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$ACNLL),(5,=C'EC013'),HALF1                   
*                                                                               
VATSPA13 DS    0H                                                               
         CLC   =C'SG',MAIN.ACTKUNT                                              
         JE    VATSPA14                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$IVEUL),(5,=C'EC014'),HALF1                   
*                                                                               
VATSPA14 DS    0H                                                               
         LA    RE,MAIN.ACTRFST     SAVE PRIMARY REC VAT RATE                    
         SR    RF,RF                                                            
         XC    HALF1,HALF1                                                      
         USING RATEL,RE                                                         
VATSPA15 CLI   RATEL,0                                                          
         JE    VATSPA25                                                         
         CLI   RATEL,RATEVATQ                                                   
         JE    VATSPA20                                                         
         IC    RF,RATLN                                                         
         AR    RE,RF                                                            
         J     VATSPA15                                                         
*                                                                               
VATSPA20 DS    0H                                                               
         MVC   HALF1,RATRATE                                                    
         DROP  RE                                                               
*                                                                               
VATSPA25 DS    0H                                                               
         MVC   IOKEY,MAIN.ACTKEY                                                
         LA    R2,IOKEY                                                         
         L     R1,FULL1                                                         
         MVC   SUB.ACTKACT,0(R1)                                                
         OC    SUB.ACTKACT,SPACES                                               
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    VATSPA30                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$ACNFE),(5,=C'EC015'),HALF1                   
         J     EXITY                                                            
*                                                                               
VATSPA30 DS    0H                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO1                                                          
*                                                                               
         TM    MAIN.ACTRSTAT,ACTSABLP   LOW LEVEL A/C?                          
         JNZ   VATSPA33                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$NLLEU),(5,=C'EC016'),HALF1                   
VATSPA33 LA    R4,SUB.ACTRFST                                                   
         USING RSTEL,R4                                                         
VATSPA34 CLI   RSTEL,0                                                          
         JE    VATSPA50                                                         
         CLI   RSTEL,RSTELQ                                                     
         JE    VATSPA40                                                         
         CLI   RSTEL,RATEVATQ                                                   
         JE    VATSPA42                                                         
         CLI   RSTEL,FFTELQ                                                     
         JE    VATSPA44                                                         
VATSPA35 LLC   RF,RSTLN                                                         
         AR    R4,RF                                                            
         J     VATSPA34                                                         
* VAT TYPES MUST MATCH (INPUT/OUTPUT), CHECK OFFICE                             
VATSPA40 DS    0H                                                               
         MVC   BYTE1,RSTSTAT1                                                   
         NI    BYTE1,RSTSIVAT                                                   
         MVI   BYTE2,0                                                          
         CLI   QA_INVAT,YESQ                                                    
         JNE   *+8                                                              
         OI    BYTE2,RSTSIVAT                                                   
         CLC   BYTE1,BYTE2                                                      
         JE    VATSPA35                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$VTNEU),(5,=C'EC017'),HALF1                   
*                                                                               
VATSPA41 DS    0H                                                               
         GOTOR GETOFF,SUB.ACTKACT                                               
*                                                                               
         CLI   QA_OFFC+1,C' '                                                   
         JNE   *+8                                                              
         MVI   HALF1+1,C' '                                                     
         CLC   QA_OFFC,HALF1                                                    
         JE    VATSPA35                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$MIXEU),(5,=C'EC018'),HALF1                   
         J     VATSPA35                                                         
* VAT RATES MUST MATCH                                                          
         USING RATELD,R4                                                        
VATSPA42 DS    0H                                                               
         CLC   HALF1,RATRATE                                                    
         JE    VATSPA35                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$VRNEQ),(5,=C'EC019'),HALF1                   
         J     VATSPA35                                                         
* FOR EU/NON-EU, CHECK TAX LOCATION                                             
         USING FFTELD,R4                                                        
VATSPA44 DS    0H                                                               
         CLI   FFTTYPE,FFTTAXLO                                                 
         JNE   VATSPA35                                                         
         CLI   FULL1,SPATSGEU                                                   
         JE    VATSPA45                                                         
         CLI   FULL1,SPATSGNE                                                   
         JNE   VATSPA35                                                         
VATSPA45 CLI   FFTAXLOC,DDTAXLEQ                                                
         JE    VATSPA35                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$ICRGC),(5,=C'EC020'),HALF1                   
         J     VATSPA35                                                         
         DROP  R4                                                               
* check office                                                                  
VATSPA50 DS    0H                                                               
         J     EXITY                                                            
         DROP  MAIN,SUB                                                         
*&&                                                                             
                                                                                
         EJECT                                                                  
***********************************************************************         
* Unlink master job after unlinking all subs on non-master job                  
***********************************************************************         
         SPACE 1                                                                
ULKMJB   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ULKMJB*'                                                      
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   EXITY                                                            
         CLC   PRODUL,QA_UNIT      INCLUDE SJ LEDGER ONLY                       
         JNE   EXITY                                                            
         CLI   QA_MAST,YESQ        IGNORE MASTER JOB                            
         JE    EXITY                                                            
         CLC   SVMSTJOB,SPACES     ANY OLD MASTER JOB LINKED?                   
         JNH   EXITY                                                            
*                                                                               
         USING MJBPASD,R4          Check mster job not link to sub-job          
         LA    R4,IOKEY                                                         
         XC    MJBPAS,MJBPAS                                                    
         MVI   MJBPTYP,MJBPTYPQ                                                 
         MVI   MJBPSUB,MJBPSUBQ                                                 
         MVC   MJBPCPY,CUXCPY                                                   
         MVC   MJBPACT,SVMSTJOB                                                 
         MVC   CSVKEY1,MJBPAS                                                   
         L     R1,=AL4(IOHIUP+IODIR+IO2)                                        
         GOTOR (#IOEXEC,AIOEXEC)                                                
         J     ULKMJB04                                                         
*                                                                               
ULKMJB02 L     R1,=AL4(IOSQUP+IODIR+IO2)                                        
         GOTOR (#IOEXEC,AIOEXEC)                                                
*                                                                               
ULKMJB04 CLC   MJBPAS(MJBPSUBJ-MJBPAS),CSVKEY1                                  
         JNE   ULKMJB10                                                         
         CLC   MJBPSUBJ,QA_ACT     Ignore master job link to QA_ACT             
         JE    ULKMJB02                                                         
         J     EXITY               Master link to other sub-jobs                
*                                                                               
         USING ACTRECD,R4                                                       
ULKMJB10 MVC   ACTKEY,SPACES       Check that old master job exists             
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(L'PRODUL),PRODUL                                         
         MVC   ACTKACT,SVMSTJOB                                                 
         L     R1,=AL4(IORD+IODIR+IO2)                                          
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JNE   EXITY               Old master job doesn't exist!                
*                                                                               
         L     R1,=AL4(IORDUP+IODIR+IO2)                                        
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JNE   *+2                                                              
         L     R1,=AL4(IOGETRUP+IOMST+IO2)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JNE   *+2                                                              
*                                                                               
         USING ACTRECD,R4                                                       
         L     R4,AIO2                                                          
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('JOBELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JNE   *+2                 No JOBELQ!                                   
*                                                                               
         L     R3,12(R1)                                                        
         USING JOBELD,R3                                                        
         CLI   JOBLN,JOBLN3Q                                                    
         JL    EXITY                                                            
         TM    JOBSTA2,JOBSMST    Ignore if it's not master job                 
         JZ    EXITY                                                            
*                                 Remove master job flag                        
         NI    JOBSTA2,X'FF'-JOBSMST                                            
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO2'                           
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  R3,R4                                                            
         EJECT                                                                  
***********************************************************************         
* GENERAL EXITS HERE                                                  *         
***********************************************************************         
EXITH    LHI   RE,2                                                             
         J     EXITCC                                                           
EXITN    LHI   RE,0                                                             
         J     EXITCC                                                           
EXITY    LHI   RE,1                                                             
EXITCC   CHI   RE,1                                                             
EXIT     XIT1  ,                                                                
EXITYR1  CR    RB,RB                                                            
         XIT1  REGS=(R1)                                                        
EXITYR2  CR    RB,RB                                                            
         XIT1  REGS=(R2)                                                        
EXITYR3  CR    RB,RB                                                            
         XIT1  REGS=(R3)                                                        
         EJECT                                                                  
***********************************************************************         
* Add ufseld to account record                                        *         
***********************************************************************         
         SPACE 1                                                                
ADDUFS   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDUFS*'                                                      
         CLI   QA_TYPE,QA_TUPDT    Only want to go through this                 
         JNE   EXITY               if update mode and ledger is SJ              
         CLC   PRODUL,OA_UNT                                                    
         JNE   EXITY                                                            
         TM    AC_IND1,AC_INEW3+AC_ILVL3                                        
         JZ    EXITY               Must be job level                            
         XC    ELEMENT,ELEMENT                                                  
         ZAP   AC_AMT,PZERO                                                     
         LA    R3,SRCHTBL2                                                      
         USING SRCTABD,R3                                                       
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO5                                        
                                                                                
         LAY   R0,ELEAREA          Yes - initialise storage for user            
         LHI   R1,3*IOLENQ         fields                                       
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE               Clear elearea to store user fields           
                                                                                
         USING UFSRECD,R2                                                       
         LA    R2,IOKEY                                                         
ADDUFS02 XC    UFSKEY,UFSKEY                                                    
         MVI   UFSKTYP,UFSKTYPQ                                                 
         MVI   UFSKSUB,UFSKSUBQ                                                 
         MVC   UFSKCPY,CUXCPY                                                   
         MVC   UFSKUNT(L'PRODUL),PRODUL                                         
         TM    SRCSTAT,SRCCLI                                                   
         JZ    ADDUFS04                                                         
         MVC   UFSKCLI,AC_ACTL1    Client                                       
ADDUFS04 TM    SRCSTAT,SRCPRO                                                   
         JZ    ADDUFS06                                                         
         MVC   UFSKPRO,AC_ACTL2    Product                                      
ADDUFS06 TM    SRCSTAT,SRCJOB                                                   
         JZ    ADDUFS08                                                         
         MVC   UFSKJOB,AC_ACTL3    Job                                          
ADDUFS08 TM    SRCSTAT,SRCMED                                                   
         JZ    ADDUFS10                                                         
         OC    AC_MEDIA,AC_MEDIA   Have we got a media code                     
         JZ    ADDUFS20            No - bump to next table entry                
         MVC   UFSKMED,AC_MEDIA    Yes - Use media code                         
*                                                                               
ADDUFS10 TM    SRCSTAT,SRCMEDGR                                                 
         JZ    ADDUFS12                                                         
         OC    AC_MEDGR,AC_MEDGR   Have we got a media group                    
         JZ    ADDUFS20            No  - bump to next table entry               
         MVC   UFSKMGR,AC_MEDGR    Yes - use it                                 
ADDUFS12 TM    SRCSTAT,SRCOFF                                                   
         JZ    ADDUFS14                                                         
         OC    AC_OFF,AC_OFF       Have we got a office code                    
         JZ    ADDUFS20            No                                           
         MVC   UFSKOFC,AC_OFF      Yes - Use office code                        
*                                                                               
ADDUFS14 TM    SRCSTAT,SRCOFFGR                                                 
         JZ    ADDUFS16                                                         
         OC    AC_OFFGR,AC_OFFGR   Have we got a office group code              
         JZ    ADDUFS20            No                                           
         MVC   UFSKOFG,AC_OFFGR    Yes - Use office group code                  
*                                                                               
ADDUFS16 MVC   CSVKEY1,UFSKEY                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    ADDUFS22                                                         
ADDUFS20 AHI   R3,1                                                             
         CLI   SRCSTAT,X'FF'                                                    
         JNE   ADDUFS02                                                         
         J     ADDUFS24                                                         
                                                                                
ADDUFS22 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR USERTABL                                                         
         J     ADDUFS20                                                         
                                                                                
ADDUFS24 CP    AC_AMT,PZERO        Any user field elements found                
         JE    ADDUFS36            No - just delete existing elements           
*                                                                               
         USING ELMTABD,R4                                                       
         LAY   R4,ELEAREA                                                       
*                                                                               
         ZAP   DUB,AC_AMT                                                       
         CVB   R1,DUB                                                           
         CHI   R1,10               No. of required user defined fields          
         JNH   *+8                                                              
         LHI   R1,10               Max 10                                       
*                                                                               
         L     R2,AIO5                                                          
         USING UFSELD,R2                                                        
ADDUFS26 MVC   UFSEL(UFSLN1Q),0(R4)                                             
         MVI   UFSSEQ,0                                                         
         XR    R3,R3                                                            
         ICM   R3,7,QA_AUSR        R3=A(Uploaded user field lines)              
         JNZ   ADDUFS28                                                         
         CLI   QA_UPLD,QA_ACCTL                                                 
         JE    ADDUFRR1            Missing UDF fields                           
         J     ADDUFS32            No data just add with no data                
*                                                                               
ADDUFS28 SR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R3)  Number of other info lines                
         AHI   R3,LW_LN2Q          R3=A(first other info data)                  
*                                                                               
ADDUFS30 CLC   0(L'UFSCODE,R3),SPACES                                           
         JNH   ADDUFS31           Blank entry move to next field                
         CLC   UFSCODE,0(R3)                                                    
         JE    ADDUFS34                                                         
ADDUFS31 LA    R3,L'UFSCODE+80(R3)                                              
         JCT   R0,ADDUFS30                                                      
         CLI   QA_UPLD,QA_ACCTL                                                 
         JE    ADDUFRR2            No match on UDF field                        
*                                                                               
ADDUFS32 LA    R4,ELMLNG(R4)                                                    
         LA    R2,UFSLN1Q(R2)                                                   
         JCT   R1,ADDUFS26                                                      
         J     ADDUFS36                                                         
                                                                                
ADDUFS34 ST    R1,SAVER1           Save off destroyed by DATVAL                 
         OC    L'UFSCODE(1,R3),L'UFSCODE(R3)  Any data                          
         JNZ   ADDUFS3A                                                         
         TM    UFSSTAT,UFSSREQD    Required field?                              
         JNZ   ADDUFRR3            No - build short element                     
         J     ADDUFS32                                                         
*                               ** Check data is valid for edit rule **         
ADDUFS3A CLI   UFSEDIT,C' '        Anything ok                                  
         JNH   ADDUFS3F                                                         
         CLI   QA_UPLD,QA_ACCTL    If acc tool need to validate date            
         JNE   ADDUFS3F                                                         
         CLI   UFSEDIT,C'D'        Date validation                              
         JNE   ADDUFS3B                                                         
         L     RF,=V(DATVAL)                                                    
         A     RF,SRVRRELO                                                      
         GOTOR (RF),DMCB,(0,L'UFSCODE+1(R3)),WORK                               
         OC    DMCB(4),DMCB        Any error?                                   
         JZ    ADDUFRR4                                                         
         GOTOR VDATCON,DMCB,(0,WORK),(17,L'UFSCODE+1(R3))                       
         J     ADDUFS3F                                                         
*                                                                               
ADDUFS3B CLI   UFSEDIT,C'N'        Numbers only                                 
         JNE   ADDUFS3D                                                         
*                                                                               
         LA    RE,L'UFSCODE+1(R3)                                               
         LLC   RF,UFSMXLN                                                       
*                                                                               
ADDUFS3C CLI   0(RE),C' '          End of data?                                 
         JNH   ADDUFS3F                                                         
         CLI   0(RE),C'0'                                                       
         JL    ADDUFRR4                                                         
         CLI   0(RE),C'9'                                                       
         JH    ADDUFRR4                                                         
         AHI   RE,1                                                             
         JCT   RF,ADDUFS3C                                                      
         J     ADDUFS3F                                                         
*                                                                               
ADDUFS3D CLI   UFSEDIT,C'C'        Characters only                              
         JNE   ADDUFS3F                                                         
*                                                                               
         LA    RE,L'UFSCODE+1(R3)                                               
         LLC   RF,UFSMXLN                                                       
*                                                                               
ADDUFS3E CLI   0(RE),C' '          End of data?                                 
         JNH   ADDUFS3F                                                         
         CLI   0(RE),C'0'          Numbers invalid                              
         JL    *+12                                                             
         CLI   0(RE),C'9'                                                       
         JNH   ADDUFRR4                                                         
         AHI   RE,1                                                             
         JCT   RF,ADDUFS3E                                                      
         J     ADDUFS3F                                                         
*                                                                               
ADDUFS3F LLC   RE,L'UFSCODE(R3)    Extract length of data                       
         LLC   RF,UFSMXLN          Max length of this user field                
         CLI   UFSEDIT,C'D'        BrO sends 7char dates, override max          
         JNE   ADDUFS35                                                         
         CLI   UFSMXLN,7                                                        
         JNL   ADDUFS35                                                         
         LA    RF,7                                                             
ADDUFS35 CR    RE,RF               Input field too long                         
         JNH   *+6                                                              
         LR    RE,RF               Yes - use max length instead                 
         SHI   RE,1                                                             
*                                                                               
         BASR  RF,0                                                             
         MVC   UFSDATA(0),L'UFSCODE+1(R3)  Add to element                       
         EX    RE,0(RF)                                                         
         AHI   RE,UFSLN1Q+1                                                     
         STC   RE,UFSLN                                                         
         AR    R2,RE               Bump R2 to where next element is             
         LA    R4,ELMLNG(R4)                                                    
         L     R1,SAVER1                                                        
         JCT   R1,ADDUFS26                                                      
         DROP  R2                                                               
*                                                                               
ADDUFS36 L     R2,AIO5                                                          
         LA    R1,10                                                            
NEW      USING UFSELD,R2                                                        
ADDUFS37 L     R4,AIO3                                                          
         USING ACTRECD,R4                                                       
         LA    R3,ACTRFST                                                       
         USING UFSELD,R3                                                        
         CLI   NEW.UFSEL,UFSELQ                                                 
         JNE   ADDUFS48                                                         
                                                                                
ADDUFS38 CLI   UFSEL,0             End of record                                
         JE    ADDUFS46                                                         
         CLI   UFSEL,UFSELQ                                                     
         JNE   ADDUFS40                                                         
         CLC   UFSCODE,NEW.UFSCODE                                              
         JE    ADDUFS42                                                         
ADDUFS40 LLC   RE,UFSLN                                                         
         AR    R3,RE                                                            
         J     ADDUFS38                                                         
*                                                                               
ADDUFS42 LLC   RE,UFSLN                                                         
         LLC   RF,NEW.UFSLN                                                     
         CR    RE,RF               Are element lengths the same                 
         JNE   ADDUFS44            No - must be different                       
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         CLC   0(0,R2),UFSEL       Compare old and new elements                 
         EX    RE,0(RF)                                                         
         JNE   ADDUFS44                                                         
*        MVI   NEW.UFSEL,X'FF'     Mark new element so it doesn't get           
         LLC   RF,NEW.UFSLN                                                     
         AR    R2,RF                                                            
         MVI   UFSEL,X'FF'         Mark existing element to delete              
         JCT   R1,ADDUFS37                                                      
         J     ADDUFS48                                                         
*                                                                               
ADDUFS44 MVI   UFSEL,X'FF'         Mark existing element to delete              
         ST    R1,SAVERE           Audit changes or deletes                     
         GOTOR AUDUFS,DMCB,UFSELD,NEW.UFSELD                                    
         L     R1,SAVERE                                                        
         LLC   RF,NEW.UFSLN                                                     
         AR    R2,RF                                                            
         JCT   R1,ADDUFS37                                                      
         J     ADDUFS48                                                         
*                                                                               
ADDUFS46 ST    R1,SAVERE                                                        
         GOTOR AUDUFS,DMCB,UFSELD,NEW.UFSELD                                    
         L     R1,SAVERE                                                        
         LLC   RF,NEW.UFSLN        Yes - audit these additions                  
         AR    R2,RF                                                            
         JCT   R1,ADDUFS37                                                      
                                                                                
ADDUFS48 L     R4,AIO3                                                          
         USING ACTRECD,R4                                                       
         LA    R3,ACTRFST                                                       
         USING UFSELD,R3                                                        
                                                                                
ADDUFS50 CLI   UFSEL,0             End of record                                
         JE    ADDUFS52                                                         
         CLI   UFSEL,UFSELQ                                                     
         JNE   ADDUFS51                                                         
                                                                                
         MVI   UFSEL,X'FF'         Mark existing element to delete              
         GOTOR AUDUFS,DMCB,UFSELD,NEW.UFSELD                                    
                                                                                
ADDUFS51 LLC   RE,UFSLN                                                         
         AR    R3,RE                                                            
         J     ADDUFS50                                                         
                                                                                
ADDUFS52 GOTO1 VHELLO,DMCB,(C'D',ACCMST),(X'FF',ACTRECD),0                      
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO5                                                          
ADDUFS54 CLI   NEW.UFSEL,0                                                      
         JE    EXITY                                                            
         CLI   NEW.UFSEL,UFSELQ                                                 
         JE    ADDUFS58                                                         
ADDUFS56 LLC   RE,NEW.UFSLN                                                     
         AR    R2,RE                                                            
         J     ADDUFS54                                                         
                                                                                
ADDUFS58 GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,NEW.UFSELD                     
         CLI   12(R1),0                                                         
         JE    ADDUFS56                                                         
         DC    H'0'                                                             
*                                  UDF field missing                            
ADDUFRR1 GOTOR SAVERR,DMCB,=AL2(AE$MISIF),(5,=C'EC108'),=AL2(82)                
         J     EXITN                                                            
*                                  Udf field invalid                            
ADDUFRR2 GOTOR SAVERR,DMCB,=AL2(AE$IVUFD),(5,=C'EC109'),=AL2(82)                
         J     EXITN                                                            
*                                  Udf field missing                            
ADDUFRR3 GOTOR SAVERR,DMCB,=AL2(AE$MISIF),(5,=C'EC114'),=AL2(83)                
         J     EXITN                                                            
*                                  Invalid input field                          
ADDUFRR4 GOTOR SAVERR,DMCB,=AL2(AE$INVIF),(5,=C'EC115'),=AL2(83)                
         J     EXITN                                                            
         EJECT                                                                  
***********************************************************************         
* Get user select elements into table                                 *         
***********************************************************************         
         SPACE 1                                                                
USERTABL NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*USERTBL'                                                      
         L     R2,AIO1                                                          
         USING UFSRECD,R2                                                       
         USING ELMTABD,R3                                                       
         LA    R2,UFSRFST                                                       
         USING UFSELD,R2                                                        
USET02   CLI   UFSEL,0                                                          
         JE    EXITY                                                            
         CLI   UFSEL,UFSELQ                                                     
         JE    USET06                                                           
USET04   LLC   RE,UFSLN                                                         
         AR    R2,RE                                                            
         J     USET02                                                           
*                                                                               
USET06   CLC   UFSDESC,SPACES                                                   
         JE    USET04                                                           
         LAY   R3,ELEAREA                                                       
         LA    R0,10                                                            
                                                                                
USET08   OC    ELMDATA,ELMDATA     IS THIS SPOT FILLED?                         
         JZ    USET12              NO, KEEP LOOKING                             
         CLC   UFSCODE,ELMCODE     YES, DO THE CODES MATCH ?                    
         JNE   USET12              NO                                           
         OC    UFSCUT,UFSCUT       YES, DO WE HAVE A CUTOFF DATE ?              
         JZ    USET10              NO, REPLACE ELEMENT                          
         CLC   UFSCUT,QA_OPDTE     YES, CAN WE TAKE IT ?                        
         JH    USET10              YES                                          
*                                                                               
         BCTR  R0,0                                                             
         MVC   ELMDATA,ELMLNG(R3)                                               
         LA    R3,ELMLNG(R3)                                                    
         JCT   R0,*-10                                                          
         XC    ELMDATA,ELMDATA     CLEAR LAST SPOT                              
         SP    AC_AMT,=P'1'        DECREASE THE COUNT BY 1                      
         J     USET04              GET NEXT ELEMENT                             
*                                                                               
USET10   MVC   ELMDATA,0(R2)       REPLACE ELEMENT                              
         J     USET04              NEXT NEXT ONE                                
                                                                                
USET12   LA    R3,ELMLNG(R3)       GET NEXT                                     
         JCT   R0,USET08                                                        
                                                                                
         LAY   R3,ELEAREA                                                       
         LA    R0,10                                                            
                                                                                
USET14   OC    ELMDATA,ELMDATA     IS THIS SPOT FILLED ?                        
         JNZ   USET18              YES, KEEP LOOKING                            
         OC    UFSCUT,UFSCUT       NO, DO WE HAVE A CUTOFF DATE ?               
         JZ    USET16              NO, ADD ELEMENT                              
         CLC   UFSCUT,QA_OPDTE     YES, CAN WE TAKE IT ?                        
         JNH   USET04              NO                                           
                                                                                
USET16   MVC   ELMDATA,0(R2)       ADD ELEMENT                                  
         AP    AC_AMT,=P'1'        KEEP A COUNT                                 
         J     USET04              GET NEXT ELEMENT                             
                                                                                
USET18   LA    R3,ELMLNG(R3)       GET NEXT                                     
         JCT   R0,USET14                                                        
         J     EXITY                                                            
         DROP  R2,R3                                                            
         EJECT                                                                  
***********************************************************************         
* Add dexeld to account record                                        *         
***********************************************************************         
         SPACE 1                                                                
*&&UK                                                                           
ADDDEX   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDDEX*'                                                      
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   EXITY                                                            
         XC    ELEMENT,ELEMENT                                                  
         XC    AELEMENT,AELEMENT                                                
         USING ACTRECD,R4                                                       
         L     R4,AIO3                                                          
         L     R3,AELEMENT                                                      
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('DEXELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JNE   ADDDEX02            No                                           
         L     R3,12(R1)           Yes                                          
         ST    R3,AELEMENT         Save address of element                      
OLD      USING DEXELD,R3                                                        
         USING DEXELD,R2                                                        
ADDDEX02 OC    QA_DDTEL,QA_DDTEL                                                
         JZ    ADDDEX06                                                         
         LA    R2,ELEMENT                                                       
         MVI   DEXEL,DEXELQ                                                     
         MVI   DEXLN,DEXLNQ                                                     
         LA    R1,WORK                                                          
         USING CONBLKD,R1                                                       
         XC    CONBLK(CONBLKL),CONBLK                                           
         MVI   CONACTN,CONAVALQ    Validate input expression                    
         MVI   CONFLD,CONFIDUE     Due data expression                          
         MVC   CONILEN,QA_DDTEL    Length of input                              
         LA    RF,DEXVAL                                                        
         STCM  RF,15,CONOADD                                                    
         LA    RF,QA_DDTE                                                       
         STCM  RF,15,CONIADD                                                    
         MVC   CONCOMF,ACOMFACS                                                 
         GOTO1 VCONVERT            Translated by convert                        
         CLI   CONERR,0                                                         
         JNE   ADDDEX04                                                         
         CLI   DEXVAL,1                                                         
         JNE   ADDDEX06            DATE (RATHER THAN FORMULA)                   
ADDDEX04 GOTOR SAVERR,DMCB,=AL2(AE$INDAT),(L'QA_DDTE,QA_DDTE),         +        
               =AL2(FLD079)                                                     
         OI    TWAMODE,TWAMUWD                                                  
ADDDEX06 GOTOR AUDDEX,DMCB,OLD.DEXELD,DEXELD                                    
         OC    AELEMENT,AELEMENT                                                
         JZ    ADDDEX08                                                         
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),('DEXELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
ADDDEX08 OC    QA_DDTEL,QA_DDTEL   Do we have a new due date                    
         JZ    EXITY               No                                           
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,DEXELD                         
         CLI   12(R1),0                                                         
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  OLD,R2,R4                                                        
*&&                                                                             
         EJECT                                                                  
***********************************************************************         
* Add omeeld to account record                                        *         
***********************************************************************         
         SPACE 1                                                                
ADDOME   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDOME*'                                                      
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   EXITY                                                            
         XC    ELEMENT,ELEMENT                                                  
         XC    AELEMENT,AELEMENT                                                
         USING ACTRECD,R4                                                       
         L     R4,AIO3                                                          
         L     R3,AELEMENT                                                      
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('OMEELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JNE   ADDOME02            No                                           
         L     R3,12(R1)           Yes                                          
         ST    R3,AELEMENT         Save address of element                      
OLD      USING OMEELD,R3                                                        
         LLC   RF,OLD.OMELN                                                     
         SHI   RF,OMELN1Q                                                       
         LLC   RE,QA_OMEML                                                      
         CR    RE,RF               Is length of data different                  
         JNE   ADDOME02            Yes                                          
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         CLC   QA_OMEMO(0),OLD.OMEMO  No - is data different                    
         EX    RF,0(RE)                                                         
         JE    EXITY               No - exit nothing to do                      
                                                                                
         USING OMEELD,R2                                                        
ADDOME02 OC    QA_OMEML,QA_OMEML                                                
         JZ    ADDOME04                                                         
         LA    R2,ELEMENT                                                       
         MVI   OMEEL,OMEELQ                                                     
         LLC   RF,QA_OMEML                                                      
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   OMEMO(0),QA_OMEMO                                                
         EX    RF,0(RE)                                                         
         AHI   RF,OMELN1Q+1                                                     
         STC   RF,OMELN                                                         
*                                                                               
ADDOME04 GOTOR AUDOME,DMCB,OLD.OMEELD,OMEELD                                    
         OC    AELEMENT,AELEMENT                                                
         JZ    ADDOME06                                                         
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),('OMEELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
ADDOME06 OC    QA_OMEML,QA_OMEML   Do we have a online memo                     
         JZ    EXITY               No                                           
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,OMEELD                         
         CLI   12(R1),0                                                         
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  OLD,R2,R4                                                        
         EJECT                                                                  
***********************************************************************         
* Add gpneld to account record                                        *         
***********************************************************************         
         SPACE 1                                                                
ADDGPN   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDGPN*'                                                      
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   EXITY                                                            
         XC    ELEMENT,ELEMENT                                                  
         XC    AELEMENT,AELEMENT                                                
         USING ACTRECD,R4                                                       
         L     R4,AIO3                                                          
         L     R3,AELEMENT                                                      
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('GPNELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JNE   ADDGPN02            No                                           
         L     R3,12(R1)           Yes                                          
         ST    R3,AELEMENT         Save address of element                      
OLD      USING GPNELD,R3                                                        
         LLC   RF,OLD.GPNLN                                                     
         SHI   RF,GPNLNQ                                                        
         LLC   RE,QA_LNAML                                                      
         CR    RE,RF               Is length of data different                  
         JNE   ADDGPN02            Yes                                          
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         CLC   QA_LNAM(0),OLD.GPNLNAM No - is data different                    
         EX    RF,0(RE)                                                         
         JE    EXITY               No - exit nothing to do                      
                                                                                
         USING GPNELD,R2                                                        
ADDGPN02 OC    QA_LNAML,QA_LNAML                                                
         JZ    ADDGPN04                                                         
         LA    R2,ELEMENT                                                       
         MVI   GPNEL,GPNELQ                                                     
         XC    GPNTYP,GPNTYP                                                    
         LLC   RF,QA_LNAML                                                      
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   GPNLNAM(0),QA_LNAML                                              
         EX    RF,0(RE)                                                         
         AHI   RF,GPNLNQ+1                                                      
         STC   RF,GPNLN                                                         
*                                                                               
ADDGPN04 GOTOR AUDGPN,DMCB,OLD.GPNELD,GPNELD                                    
         OC    AELEMENT,AELEMENT                                                
         JZ    ADDGPN06                                                         
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),('GPNELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
ADDGPN06 OC    QA_LNAML,QA_LNAML   Do we have a long name                       
         JZ    EXITY               No                                           
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,GPNELD                         
         CLI   12(R1),0                                                         
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  OLD,R2,R4                                                        
         EJECT                                                                  
***********************************************************************         
* Add pideld to account record                                        *         
***********************************************************************         
         SPACE 1                                                                
ADDPID   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDPID*'                                                      
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   EXITY                                                            
         XC    ELEMENT,ELEMENT                                                  
         XC    AELEMENT,AELEMENT                                                
         USING ACTRECD,R4                                                       
         L     R4,AIO3                                                          
         L     R3,AELEMENT                                                      
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('PIDELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JNE   ADDPID02            No                                           
         L     R3,12(R1)           Yes                                          
         ST    R3,AELEMENT         Save address of element                      
OLD      USING PIDELD,R3                                                        
         CLC   QA_PIDCR,OLD.PIDNO  Is data different                            
         JE    EXITY               No - exit nothing to do                      
                                                                                
         USING PIDELD,R2                                                        
ADDPID02 OC    QA_PIDCR,QA_PIDCR                                                
         JZ    ADDPID04                                                         
         LA    R2,ELEMENT                                                       
         MVI   PIDEL,PIDELQ                                                     
         MVI   PIDLN,PIDLNQ                                                     
         MVC   PIDNO,QA_PIDCR                                                   
*                                                                               
ADDPID04 GOTOR AUDPID,DMCB,OLD.PIDELD,PIDELD                                    
         OC    AELEMENT,AELEMENT                                                
         JZ    ADDPID06                                                         
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),('PIDELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
ADDPID06 OC    QA_PIDCR,QA_PIDCR   Do we have a personal id                     
         JZ    EXITY               No                                           
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,PIDELD                         
         CLI   12(R1),0                                                         
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  OLD,R2,R4                                                        
         EJECT                                                                  
***********************************************************************         
* Add apteld to account record                                        *         
***********************************************************************         
         SPACE 1                                                                
ADDAPT   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDAPT*'                                                      
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   EXITY                                                            
         XC    ELEMENT,ELEMENT                                                  
         XC    AELEMENT,AELEMENT                                                
         USING ACTRECD,R4                                                       
         L     R4,AIO3                                                          
         L     R3,AELEMENT                                                      
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('APTELQ',ACTRECD),           +        
               (1,=AL1(APTSXPNS))                                               
         CLI   12(R1),0                                                         
         JNE   ADDAPT02            No                                           
         L     R3,12(R1)           Yes                                          
         ST    R3,AELEMENT         Save address of element                      
OLD      USING APTELD,R3                                                        
         CLC   OLD.APTACCA,QA_EXPAC  Is the expense account the same            
         JE    ADDAPT08            Yes                                          
         USING APTELD,R2                                                        
ADDAPT02 OC    QA_EXPAC,QA_EXPAC   Have we got an expense account               
         JZ    ADDAPT04            No                                           
         LA    R2,ELEMENT          Yes - rebuild new element                    
         MVI   APTEL,APTELQ                                                     
         MVI   APTLN,APTLNQ                                                     
         MVI   APTSTAT,APTSXPNS                                                 
         MVC   APTACCC,CUXCPY                                                   
         MVC   APTACCU(L'ACTKUNT+L'ACTKLDG),=C'SE'                              
         MVC   APTACCA,QA_EXPAC                                                 
*                                                                               
ADDAPT04 GOTOR AUDAPT,DMCB,OLD.APTELD,APTELD                                    
         OC    AELEMENT,AELEMENT                                                
         JZ    ADDAPT06                                                         
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),('APTELQ',ACTRECD),           +        
               (1,=AL1(APTSXPNS))                                               
                                                                                
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
ADDAPT06 OC    QA_EXPAC,QA_EXPAC   Do we have an expense account                
         JZ    EXITY               No                                           
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,APTELD                         
         CLI   12(R1),0                                                         
         JE    ADDAPT08                                                         
         DC    H'0'                                                             
ADDAPT08 MVC   AC_CULA,APTACC                                                   
         MVC   AC_NAMLL,QA_EXPNL                                                
         GOTOR UPDACN                                                           
         JE    EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$MIACC),(L'APTACC,APTACC),           +        
               =AL2(FLD124)                                                     
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITY                                                            
         DROP  OLD,R2,R4                                                        
         EJECT                                                                  
***********************************************************************         
* Add sciel to account record                                         *         
***********************************************************************         
         SPACE 1                                                                
ADDSCI   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDSCI*'                                                      
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   EXITY                                                            
         USING ACTRECD,R4                                                       
         L     R4,AIO3                                                          
         USING SCITABD,R6                                                       
         LA    R6,SCITAB                                                        
         XC    BYTE1,BYTE1                                                      
ADDSCI02 XC    ELEMENT,ELEMENT                                                  
         XC    AELEMENT,AELEMENT                                                
         MVC   BYTE1,SCITYP                                                     
         LH    R7,SCIADRAM                                                      
         AR    R7,R8                                                            
         L     R3,AELEMENT                                                      
         LA    R2,ELEMENT                                                       
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('SCIELQ',ACTRECD),           +        
               (1,BYTE1)                                                        
         CLI   12(R1),0            Does element exist                           
         JNE   ADDSCI04            No                                           
         L     R3,12(R1)           Yes - store address                          
OLD      USING SCIELD,R3                                                        
         ST    R3,AELEMENT                                                      
         OC    0(L'SCIAMNT,R7),0(R7) Do we have a value                         
         JZ    ADDSCI06            No - audit delete                            
         CP    OLD.SCIAMNT,0(L'SCIAMNT,R7) Yes - is value the same              
         JE    ADDSCI10            Yes - nothing to do                          
                                                                                
         USING SCIELD,R2                                                        
ADDSCI04 OC    0(L'SCIAMNT,R7),0(R7)                                            
         JZ    ADDSCI10                                                         
         MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN1Q                                                    
         MVC   SCITYPE,BYTE1                                                    
         ZAP   SCIAMNT,0(L'SCIAMNT,R7)                                          
                                                                                
ADDSCI06 GOTOR AUDSCI,DMCB,OLD.SCIELD,SCIELD                                    
         OC    AELEMENT,AELEMENT   Do we have an existing element               
         JZ    ADDSCI08                                                         
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),('SCIELQ',ACTRECD),           +        
               (1,BYTE1)                                                        
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
ADDSCI08 OC    0(L'SCIAMNT,R7),0(R7)  Do we have any data                       
         JZ    ADDSCI10            No                                           
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,SCIELD                         
         CLI   12(R1),0                                                         
         JE    ADDSCI10                                                         
         DC    H'0'                                                             
ADDSCI10 LA    R6,SCITABL(R6)                                                   
         CLI   SCITIND1,X'FF'                                                   
         JNE   ADDSCI02                                                         
         J     EXITY                                                            
         DROP  OLD,R2,R4,R6                                                     
                                                                                
         EJECT                                                                  
***********************************************************************         
* Add EBDEL to account record                                         *         
***********************************************************************         
         SPACE 1                                                                
*&&UK                                                                           
ADDEBD   NTR1  LABEL=NO,BASE=*                                                  
         J     *+12                                                             
         DC    C'*ADDEBD*'                                                      
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   EXITY                                                            
* GET ANY EXISTING ELEMENT                                                      
         XC    ELEMENT,ELEMENT                                                  
         XC    AELEMENT,AELEMENT                                                
         USING ACTRECD,R4                                                       
         L     R4,AIO3                                                          
         L     R3,AELEMENT                                                      
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('EBDELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JNE   ADDEBD05            No                                           
         L     R3,12(R1)           Yes                                          
         ST    R3,AELEMENT         Save address of element                      
OLD      USING EBDELD,R3                                                        
* BUILD NEW ELEMENT                                                             
ADDEBD05 DS    0H                                                               
         USING EBDELD,R2                                                        
         LA    R2,ELEMENT                                                       
         MVI   EBDEL,EBDELQ                                                     
         MVI   EBDLN,EBDLNQ                                                     
*  ISO CODE                                                                     
         XC    EBDCTRY,EBDCTRY                                                  
         MVC   EBDIBAN,SPACES                                                   
         CLC   QA_CTRY,SPACES                                                   
         JNH   ADDEBD50            NO ISO, NO IBAN                              
         USING ISOCTRYD,RF                                                      
         LA    RF,ISOCTAB          ISO COUNTRY CODES TABLE                      
ADDEBD07 CLI   ISOCODE1,FF                                                      
         BE    ADDEBD10            INVALID ISO CODE                             
         CLC   ISOCODE1,QA_CTRY                                                 
         BE    ADDEBD12                                                         
         AHI   RF,ISOCTRYL         GET NEXT ISO CODE                            
         J     ADDEBD07                                                         
*                                                                               
ADDEBD10 GOTOR SAVERR,DMCB,=AL2(AE$INISO),(5,=C'EC021'),=AL2(FLD137)            
         OI    TWAMODE,TWAMUWD                                                  
         J     ADDEBD15                                                         
*                                                                               
ADDEBD12 DS    0H                                                               
         MVC   EBDCTRY,QA_CTRY                                                  
* IBAN code                                                                     
ADDEBD15 DS    0H                                                               
         CLC   QA_IBAN,SPACES                                                   
         JNH   ADDEBD50                                                         
         GOTOR VALIBAN             CHECK IBAN IS VALID                          
         JE    ADDEBD17                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(5,=C'EC022'),=AL2(FLD138)                   
         OI    TWAMODE,TWAMUWD                                                  
         J     ADDEBD50                                                         
*                                                                               
ADDEBD17 DS    0H                                                               
         MVC   EBDIBAN,QA_IBAN                                                  
         OC    EBDIBAN,SPACES                                                   
* BIC code                                                                      
ADDEBD50 DS    0H                                                               
         MVC   EBDBIC,QA_BIC                                                    
         OC    EBDBIC,SPACES                                                    
* ADD/REPLACE/DELETE EBDEL                                                      
ADDEBD90 DS    0H                                                               
*                                                                               
         CLC   EBDIBAN,SPACES                                                   
         JH    ADDEBD95                                                         
         CLC   EBDBIC,SPACES                                                    
         JH    ADDEBD95                                                         
         OC    EBDCTRY,EBDCTRY                                                  
         JNZ   ADDEBD95                                                         
         MVI   EBDLN,0             NO NEW DATA                                  
         OC    AELEMENT,AELEMENT                                                
         JZ    EXITY               NO ELEMENT BEFORE, NO CHANGE                 
*                                                                               
         GOTOR AUDISO                                                           
         GOTOR AUDIBAN                                                          
         GOTOR AUDBIC                                                           
*                                                                               
ADDEBD95 DS    0H                                                               
         OC    AELEMENT,AELEMENT                                                
         JZ    ADDEBD98            NOTHING OLD TO DELETE                        
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),('EBDELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JE    ADDEBD98                                                         
         DC    H'0'                                                             
*                                                                               
ADDEBD98 DS    0H                                                               
         CLI   EBDLN,0                                                          
         JE    EXITY                                                            
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,EBDELD                         
         CLI   12(R1),0                                                         
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  OLD,R2,R4                                                        
                                                                                
         EJECT                                                                  
***********************************************************************         
* CHECK WHETHER FIELD IS CHARACTER STRING AND VALIDATE IBAN           *         
* USES TABLE IBANTABD TO CHECK LENGTH OF IBAN AND VALID COUNTRY CODE  *         
* ALSO CHECKS VALID CHARACTERS AND NUMBERS ENTERED.                   *         
* USES FULL2                                                                    
***********************************************************************         
         SPACE 1                                                                
         USING IBANTABD,R3                                                      
VALIBAN  NTR1  BASE=*,LABEL=*      R2=END OF IBAN TABLE                         
         LA    R4,QA_IBAN          SAVE A(START) OF IBAN                        
         LA    R3,IBANTAB          R3=BEGINNING OF IBAN TABLE                   
         XR    R0,R0               R4=A(IBAN)                                   
         XR    R2,R2                                                            
         LHI   R2,IBANTABL                                                      
         AR    R2,R3                                                            
*                                                                               
VALIB02  CLI   0(R3),X'FF'         END OF TABLE?                                
         JE    VALIB04                                                          
         CR    R3,R2                                                            
         JNL   VALIB04                                                          
         CLC   0(L'IBANCC,R4),IBANCC CHECK COUNTRY CODE IS VALID                
         JNE   VALIB06                                                          
         CLI   IBANL,X'00'         NO LENGTH CHECK                              
         JE    EXITY                                                            
         CLC   QA_IBANL,IBANL       CHECK LENGTH IS GOOD                        
         JE    VALIB08                                                          
         CLC   QA_IBANL,IBANL                                                   
         JNL   VALIB08                                                          
VALIB04  MVC   ROUERRV,=AL2(AE$IBAN) TOO LONG                                   
         J     EXITN                                                            
*                                                                               
VALIB06  IC    R0,IBANEL                                                        
         AR    R3,R0               BUMP TO NEXT ENTRY                           
         J     VALIB02                                                          
*                                  LENGTH IS GOOD CHECK STRUCTURE               
VALIB08  LLC   RE,QA_IBANL                                                      
         LA    RE,QA_IBAN(RE)                                                   
         ST    RE,FULL2            END OF IBAN CODE                             
         AHI   R4,L'IBANCC         SHUNT PAST COUNTRY CODE                      
         LLC   R6,IBANEL                                                        
         AR    R6,R3               R6=BEGINNING OF NEXT COUNTRY ENTRY           
*                                                                               
VALIB10  CLI   IBANTYP,IBANNUM                                                  
         JNE   VALIB12                                                          
         MVC   BYTE1,IBANLEN                                                    
         BAS   RE,CHKNUM           NUMBER                                       
         JNE   EXITN                                                            
         J     VALIB16                                                          
*                                                                               
VALIB12  CLI   IBANTYP,IBANCHA                                                  
         JNE   VALIB14                                                          
         BAS   RE,CHKCHA           CHARACTER                                    
         JNE   EXITN                                                            
         J     VALIB16                                                          
*                                                                               
VALIB14  CLI   IBANTYP,IBANMIX                                                  
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   BYTE1,IBANLEN                                                    
         BAS   RE,CHKMIX           MIXED CHAR                                   
         JNE   EXITN                                                            
         J     VALIB16                                                          
*                                                                               
VALIB16  LLC   R0,IBANLEN                                                       
         AR    R4,R0                                                            
         AHI   R3,IBANSEL                                                       
         LR    RE,R3                                                            
         AHI   RE,IBANHL                                                        
         CR    RE,R6               HIT END OF ENTRY?                            
         JNL   EXITY                                                            
         L     RE,FULL2                                                         
         CR    R4,RE                                                            
         JL    VALIB10                                                          
         J     EXITY                                                            
*                                                                               
VALIBERR DS    0H                                                               
         MVC   ROUERRV,=AL2(AE$IBAN) INVALID COUNTRY CODE                       
         LTR   RB,RB                 CC NEQ                                     
         BR    RE                                                               
*                                                                               
*          DATA SET ACFIL00    AT LEVEL 043 AS OF 10/02/11                      
***********************************************************************         
* CHECK WHETHER ITEM IS NUMERICAL                                     *         
***********************************************************************         
CHKNUM   LR    RF,R4                                                            
         LLC   R0,BYTE1                                                         
*                                                                               
CHKNUM00 CLI   0(RF),C'0'          CHECK NUMBER IS BETWEEN 0-9                  
         JL    CHKNUMX                                                          
         CLI   0(RF),C'9'                                                       
         JNH   CHKNUM2                                                          
*                                                                               
CHKNUMX  J     VALIBERR                                                         
*                                                                               
CHKNUM2  AHI   RF,1                                                             
         JCT   R0,CHKNUM00         LOOP                                         
         CR    RE,RE               CC EQUAL                                     
         BR    RE                                                               
***********************************************************************         
* CHECK ITEM IS A CHARACTER AND VALID                                 *         
***********************************************************************         
CHKCHA   LR    RF,R4                                                            
         LLC   R0,IBANLEN                                                       
*                                                                               
CHKCH00  CLI   0(RF),C'A'          CHECK CHARACTER IS IN VALID RANGE            
         JL    VALIBERR                                                         
         CLI   0(RF),C'Z'                                                       
         JH    VALIBERR                                                         
         CLI   0(RF),C'\'                                                       
         JE    VALIBERR                                                         
         CLI   0(RF),C'}'                                                       
         JE    VALIBERR                                                         
*                                                                               
CHKCH2   AHI   RF,1                                                             
         JCT   R0,CHKCH00          LOOP                                         
         CR    RE,RE               CC EQUAL                                     
         BR    RE                                                               
***********************************************************************         
* CHECK ITEM IS A ALPHANUMERIC CHARACTER                              *         
***********************************************************************         
CHKMIX   LR    RF,R4                                                            
         LLC   R0,BYTE1                                                         
*                                                                               
CHKMX00  CLI   0(RF),C'0'          CHECK IT'S A NUMBER                          
         JL    CHKMX02                                                          
         CLI   0(RF),C'9'                                                       
         JH    CHKMX02                                                          
         J     CHKMX04             VALID NUMBER                                 
*                                                                               
CHKMX02  CLI   0(RF),C'A'          CHECK CHARACTER IS IN VALID RANGE            
         JL    VALIBERR                                                         
         CLI   0(RF),C'Z'                                                       
         JH    VALIBERR                                                         
         CLI   0(RF),C'}'                                                       
         JE    VALIBERR                                                         
         CLI   0(RF),C'\'                                                       
         JE    VALIBERR                                                         
         J     CHKMX04                                                          
*                                                                               
CHKMX04  AHI   RF,1                                                             
         JCT   R0,CHKMX00          LOOP                                         
         CR    RE,RE               CC EQUAL                                     
         BR    RE                                                               
*                                                                               
         DROP  R3                                                               
*&&                                                                             
***********************************************************************         
* Add pacel to account record                                         *         
***********************************************************************         
         SPACE 1                                                                
ADDPAC   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDPAC*'                                                      
                                                                                
         MVC   TEMP2(2),CCTPID                                                  
         GOTOR (#GETPID,AGETPID)                                                
         JNE   EXITY                                                            
                                                                                
         XC    ELEMENT,ELEMENT                                                  
         XC    AELEMENT,AELEMENT                                                
         USING ACTRECD,R4                                                       
         L     R4,AIO3                                                          
         L     R3,AELEMENT                                                      
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('PACELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JNE   ADDPAC02            No                                           
         L     R3,12(R1)           Yes                                          
         ST    R3,AELEMENT         Save address of element                      
OLD      USING PACELD,R3                                                        
                                                                                
         USING PACELD,R2                                                        
ADDPAC02 LA    R2,ELEMENT                                                       
         MVI   PACEL,PACELQ                                                     
         MVI   PACLN,PACLNQ                                                     
         OC    AELEMENT,AELEMENT                                                
         JZ    *+10                                                             
         MVC   PACLN,OLD.PACLN                                                  
         MVC   PACPERS,TEMP2                                                    
         MVC   PACDATE,AC_TODYP                                                 
*&&US                                                                           
         CLI   PACLN,PACLNQ        Do we have extra infor?                      
         JNH   ADDPAC04                                                         
         MVC   PACPERS2,OLD.PACPERS2                                            
         MVC   PACDATE2,OLD.PACDATE2                                            
*&&                                                                             
ADDPAC04 OC    AELEMENT,AELEMENT                                                
         JZ    ADDPAC06                                                         
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),('PACELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
ADDPAC06 GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,PACELD                         
         CLI   12(R1),0                                                         
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  OLD,R2,R4                                                        
         EJECT                                                                  
                                                                                
***********************************************************************         
* Add client purchase order lideld to the account extension record    *         
***********************************************************************         
         SPACE 1                                                                
CLPOLD   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*CLPOLD*'                                                      
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   EXITY                                                            
         USING AEXRECD,R4                                                       
         L     R4,AIO4                                                          
         L     R3,AIO3                                                          
         USING ACTRECD,R3                                                       
         CLC   PRODUL,ACTKULA                                                   
         JNE   EXITY                                                            
         XC    BYTE1,BYTE1                                                      
         XC    HALF1,HALF1                                                      
         XC    HALF2,HALF2                                                      
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO5                                        
         CLI   AEXIOERR,IOERNF                                                  
         JE    CLPOLD02                                                         
         CLI   AEXIOERR,IOEDEL                                                  
         JNE   CLPOLD04                                                         
CLPOLD02 SR    R3,R3                                                            
         ICM   R3,7,QA_APORD       R3=A(Uploaded client purchse orders)         
         JZ    EXITY               No data just delete                          
CLPOLD04 L     R2,AIO5             Use AIO5 to store old elements               
         MVI   BYTE1,L'LIDCPO+L'LIDCPOAM                                        
         MVI   BYTE2,LIDTCPO                                                    
         XC    BYTE3,BYTE3                                                      
CLPOLD08 GOTO1 VHELLO,DMCB,(C'G',ACCMST),('LIDELQ',AEXRECD),           +        
               (3,BYTE1)                                                        
         CLI   12(R1),0            Does client purchase order exist             
         JE    CLPOLD10            Yes                                          
         OC    HALF1,HALF1         Did we find anything                         
         JNZ   CLPOLD12            Yes                                          
         SR    R2,R2               No                                           
         ICM   R2,7,QA_APORD       R3=A(Uploaded client purchse orders)         
         JZ    EXITY               No data now either so nothing to do          
         J     CLPOLD12                                                         
*                                                                               
CLPOLD10 L     R3,12(R1)                                                        
         ST    R3,AELEMENT                                                      
OLD      USING LIDELD,R3                                                        
         LLC   RF,OLD.LIDLN        RF=Existing el length                        
         SHI   RF,LIDLNDQ                                                       
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,R2),OLD.LIDDATA Extract data to AIO5                         
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         AR    R2,RF                                                            
         LH    RE,HALF1                                                         
         AR    RE,RF                                                            
         STH   RE,HALF1            Save total length of all elements            
         LLC   RF,BYTE3                                                         
         AHI   RF,1                                                             
         STC   RF,BYTE3                                                         
         J     CLPOLD08                                                         
         DROP  OLD                                                              
                                                                                
CLPOLD12 SR    R2,R2                                                            
         ICM   R2,7,QA_APORD       R2=A(Uploaded client purchse orders)         
         JZ    CLPOLD14            No data just delete                          
         SR    R3,R3                                                            
         ICM   R3,3,LW_NUMN-LW_D(R2)  Number of client orders                   
         STH   R3,HALF2                                                         
         AHI   R2,LW_LN2Q          R2=A(first address line data)                
         GOTO1 VXSORT,DMCB,(X'00',(R2)),(R3),LIDLLN7Q,L'LIDCPO,0                
         MHI   R3,LIDLLN7Q                                                      
         XR    RF,RF                                                            
         ICM   RF,3,HALF1                                                       
         JZ    CLPOLD16                                                         
         XR    RE,RE                                                            
         LHI   R1,L'LIDCPO+L'LIDCPOAM                                           
         DR    RE,R1                                                            
         GOTO1 VXSORT,DMCB,(X'00',AIO5),(RF),LIDLLN7Q,L'LIDCPO,0                
         LH    RF,HALF1                                                         
         CR    RF,R3               Do we have same total length                 
         JNE   CLPOLD14            No                                           
         L     RE,AIO5                                                          
         CLCL  R2,RE               Yes - are client po the same                 
         JE    CLPOLD24            Yes                                          
         ICM   R2,7,QA_APORD       R2=A(Uploaded client purchse orders)         
         AHI   R2,LW_LN2Q          R2=A(first address line data)                
                                                                                
CLPOLD14 L     R4,AIO4                                                          
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),('LIDELQ',AEXRECD),           +        
               (2,BYTE1)                                                        
         CLI   12(R1),0            Delete elements                              
         JE    *+6                                                              
         DC    H'0'                                                             
CLPOLD16 GOTOR AUDCPO,DMCB,AIO5,(R2)                                            
         SR    R2,R2                                                            
         ICM   R2,7,QA_APORD       Any data to upload                           
         JZ    CLPOLD24            No - delete done now update rec              
         SR    R6,R6                                                            
         ICM   R6,3,LW_NUMN-LW_D(R2)  Number of client orders                   
         AHI   R2,LW_LN2Q          R2=A(first client order data)                
         XC    BYTE1,BYTE1                                                      
CLPOLD18 XC    ELEMENT,ELEMENT     Clear element                                
         LA    R3,ELEMENT          R3=A(new lideld element)                     
         LA    R0,9                Max number of entries on element             
         USING LIDELD,R3                                                        
         MVI   LIDEL,LIDELQ        Build element                                
         MVI   LIDITLN,LIDLLN7Q                                                 
         MVI   LIDTYPE,LIDTCPO                                                  
         MVC   LIDSEQ,BYTE1                                                     
         LA    R5,LIDDATA                                                       
CLPOLD20 MVC   0(LIDLLN7Q,R5),0(R2) Extract client order and amount             
         LA    R5,LIDLLN7Q(R5)                                                  
         LA    R2,LIDLLN7Q(R2)                                                  
         BCTR  R6,0                                                             
         LTR   R6,R6               Have we added all client orders              
         JZ    CLPOLD22            Yes - add element to record                  
         JCT   R0,CLPOLD20         Have we reached max allowed                  
         LLC   RF,BYTE1            Increment byte 1 for sequence on             
         AHI   RF,1                                          Lideld             
         STC   RF,BYTE1                                                         
CLPOLD22 SR    R5,R3               Work out length of element                   
         STC   R5,LIDLN            and add element to record                    
         GOTOR VHELLO,DMCB,(C'P',ACCMST),AEXRECD,LIDELD                         
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
         LTR   R6,R6                                                            
         JNZ   CLPOLD18                                                         
CLPOLD24 J     EXITY                                                            
         DROP  R3,R4                                                            
         EJECT                                                                  
***********************************************************************         
* Add team lideld to account record                                   *         
***********************************************************************         
         SPACE 1                                                                
TEAMLD   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*TEAMLD*'                                                      
         XR    RF,RF                                                            
         ICM   RF,3,CUXPNUM        Check whether BrandOcean or Aura             
         CHI   RF,XPRODIKQ          is connected                                
         J     EXITY               If anyone don't change team/persons          
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   EXITY                                                            
         USING ACTRECD,R4                                                       
         L     R4,AIO3                                                          
         CLC   PRODUL,ACTKULA                                                   
         JNE   EXITY                                                            
         XC    AELEMENT,AELEMENT                                                
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO5                                        
*                                                                               
         L     R2,AIO5             IOAREA5 to contain new team                  
         USING LIDELD,R2                                                        
         MVI   LIDEL,LIDELQ        Build new elements into AIO5                 
         MVI   LIDITLN,L'LIDROLN+L'LIDBPID                                      
         MVI   LIDTYPE,LIDTTEAJ                                                 
         ST    R2,AJOBLVL                                                       
         LA    R2,L'ELEMENT(R2)                                                 
         MVI   LIDEL,LIDELQ                                                     
         MVI   LIDITLN,L'LIDROLN+L'LIDBPID                                      
         MVI   LIDTYPE,LIDTTEAJ                                                 
         ST    R2,APROLVL                                                       
         LA    R2,L'ELEMENT(R2)                                                 
         MVI   LIDEL,LIDELQ                                                     
         MVI   LIDITLN,L'LIDROLN+L'LIDBPID                                      
         MVI   LIDTYPE,LIDTTEAJ                                                 
         ST    R2,ACLILVL                                                       
         SR    R3,R3                                                            
         ICM   R3,7,QA_AROL        R3=A(Uploaded team)                          
         JZ    TEAMLD06            No data just delete                          
         SR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R3)  Number of roles/people                    
         AHI   R3,LW_LN2Q          R3=A(first address line data)                
TEAMLD02 CLI   L'LIDROLN+L'LIDBPID(R3),QA_LVL1                                  
         JNE   *+8                                                              
         L     R2,ACLILVL                                                       
         CLI   L'LIDROLN+L'LIDBPID(R3),QA_LVL2                                  
         JNE   *+8                                                              
         L     R2,APROLVL                                                       
         CLI   L'LIDROLN+L'LIDBPID(R3),QA_LVL3                                  
         JNE   *+8                                                              
         L     R2,AJOBLVL                                                       
         MVC   LIDROLN(L'LIDROLN+L'LIDBPID),0(R3)                               
         LA    R2,L'LIDROLN+L'LIDBPID(R2)                                       
         CLI   L'LIDROLN+L'LIDBPID(R3),QA_LVL1                                  
         JNE   *+8                                                              
         ST    R2,ACLILVL                                                       
         CLI   L'LIDROLN+L'LIDBPID(R3),QA_LVL2                                  
         JNE   *+8                                                              
         ST    R2,APROLVL                                                       
         CLI   L'LIDROLN+L'LIDBPID(R3),QA_LVL3                                  
         JNE   *+8                                                              
         ST    R2,AJOBLVL                                                       
         LA    R3,L'LIDROLN+L'LIDBPID+1(R3)                                     
         JCT   R0,TEAMLD02         Get next                                     
         LA    R1,AJOBLVL                                                       
         L     R3,AIO5                                                          
         LHI   R0,3                                                             
TEAMLD04 L     R2,0(R1)                                                         
         LA    R2,LIDDATA          R2=A(end of lideld)                          
         SR    R2,R3               R3=length of element                         
         STC   R2,1(R3)            Store at element length                      
         LA    R3,L'ELEMENT(R3)    Bump to next level                           
         LA    R1,L'APROLVL(R1)    Bump to next end                             
         JCT   R0,TEAMLD04                                                      
TEAMLD06 L     R2,AIO5                                                          
*                                                                               
TEAMLD08 LHI   R7,3                                                             
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('LIDELQ',ACTRECD),           +        
               (2,=AL1(L'LIDROLN+L'LIDBPID,LIDTTEAJ))                           
         CLI   12(R1),0            Does client team exist                       
         JNE   TEAMLD10            No                                           
         L     R3,12(R1)                                                        
         ST    R3,AELEMENT                                                      
OLD      USING LIDELD,R3                                                        
         LLC   RF,OLD.LIDLN        RF=Existing el length                        
         LLC   RE,LIDLN            RE=New el length                             
         CR    RE,RF                                                            
         JNE   TEAMLD10                                                         
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         CLC   LIDEL(0),OLD.LIDEL  Check if element the same                    
         EX    RF,0(RE)                                                         
         JE    TEAMLD14            Yes - nothing to do                          
                                                                                
TEAMLD10 GOTOR AUDTEAM,DMCB,OLD.LIDELD,LIDELD  No - audit change                
         OC    AELEMENT,AELEMENT                                                
         JZ    TEAMLD12                                                         
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),('LIDELQ',ACTRECD),           +        
               (2,=AL1(L'LIDROLN+L'LIDBPID,LIDTTEAJ))                           
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
TEAMLD12 CLI   LIDLN,LIDLNDQ                                                    
         JNH   TEAMLD14                                                         
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,LIDELD,ADDEND                  
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
TEAMLD14 TM    AC_IND1,AC_INEW1    Client level                                 
         JNZ   EXITY                                                            
         LA    R6,LDGAL2                                                        
         LHI   R7,2                                                             
         TM    AC_IND1,AC_INEW3    Job level                                    
         JNZ   TEAMLD16                                                         
         LA    R6,LDGAL1                                                        
         LHI   R7,1                                                             
                                                                                
TEAMLD16 CLI   QA_ASTAT,QA_ANEW    Is this a new account                        
         JE    EXITY               Yes - Temporary code so client level         
         CLI   QA_ASTAT,QA_AAUTO   isn't trashed                                
         JE    EXITY                                                            
TEAMLD18 LA    R2,L'ELEMENT(R2)    Bump to next new element                     
         XC    AELEMENT,AELEMENT                                                
         LA    R4,IOKEY                                                         
         MVC   ACTKEY,SPACES       Read account record at higher level          
         MVC   ACTKCPY,CUXCPY                                                   
         XR    RF,RF                                                            
         IC    RF,0(R6)                                                         
         AHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   ACTKULA(0),OA_ULA                                                
         EX    RF,0(RE)                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R1,=AL4(IOGETRUP+IOMST+IO1)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R4,AIO1                                                          
         XR    R3,R3                                                            
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('LIDELQ',ACTRECD),           +        
               (2,=AL1(L'LIDROLN+L'LIDBPID,LIDTTEAJ))                           
         CLI   12(R1),0            Does client team exist                       
         JNE   TEAMLD20            No                                           
         L     R3,12(R1)                                                        
         ST    R3,AELEMENT                                                      
OLD      USING LIDELD,R3                                                        
         LLC   RF,OLD.LIDLN        RF=Existing el length                        
         LLC   RE,LIDLN            RE=New el length                             
         CR    RE,RF                                                            
         JNE   TEAMLD20                                                         
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         CLC   LIDEL(0),OLD.LIDEL  Check if element the same                    
         EX    RF,0(RE)                                                         
         JE    TEAMLD26            Yes - nothing to do                          
                                                                                
TEAMLD20 GOTOR AUDTEAM,DMCB,OLD.LIDELD,LIDELD                                   
         OC    AELEMENT,AELEMENT                                                
         JZ    TEAMLD22                                                         
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),('LIDELQ',ACTRECD),           +        
               (2,=AL1(L'LIDROLN+L'LIDBPID,LIDTTEAJ))                           
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
         CLI   LIDLN,LIDLNDQ       Anything to add                              
         JNH   TEAMLD24            No - update record now                       
TEAMLD22 CLI   LIDLN,LIDLNDQ       Anything to update                           
         JNH   TEAMLD26            No - update record now                       
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,LIDELD,ADDEND                  
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
TEAMLD24 GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO1'                           
         JE    *+6                                                              
         DC    H'0'                                                             
TEAMLD26 SHI   R6,1                                                             
         JCT   R7,TEAMLD18                                                      
         J     EXITY                                                            
         DROP  OLD,R2,R4                                                        
         EJECT                                                                  
***********************************************************************         
* Add master job passives and amend spaeld on account records         *         
***********************************************************************         
         SPACE 1                                                                
LNKJB    NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*LNKJB**'                                                      
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   EXITY                                                            
         XC    BYTE1,BYTE1                                                      
         USING MJBPASD,R4                                                       
         LA    R4,IOKEY                                                         
         XC    MJBPAS,MJBPAS                                                    
         MVI   MJBPTYP,MJBPTYPQ                                                 
         MVI   MJBPSUB,MJBPSUBQ                                                 
         MVC   MJBPCPY,CUXCPY                                                   
         MVC   MJBPACT,OA_ACT                                                   
         MVC   CSVKEY1,MJBPAS                                                   
         L     R1,=AL4(IOHIUP+IODIR+IO2)                                        
         GOTOR (#IOEXEC,AIOEXEC)                                                
         J     LNKJB06                                                          
*                                                                               
LNKJB04  L     R1,=AL4(IOSQUP+IODIR+IO2)                                        
         GOTOR (#IOEXEC,AIOEXEC)                                                
*                                                                               
LNKJB06  CLC   MJBPAS(MJBPSUBJ-MJBPAS),CSVKEY1                                  
         JNE   LNKJB14                                                          
         XR    R3,R3                                                            
         ICM   R3,7,QA_ALJB        R3=A(Uploaded linked jobs)                   
         JZ    LNKJB12             No data just delete                          
         SR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R3)  Number of client/pro/jobs                 
         AHI   R3,LW_LN2Q          R3=A(first address of data)                  
*                                                                               
LNKJB08  OC    0(L'CPJCLI,R3),0(R3)     Any data in this entry                  
         JZ    LNKJB10             No - go to next entry in WMP                 
         LLC   RF,LDGAL1                                                        
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         CLC   MJBPSUBJ(0),0(R3)   Does the client match                        
         EX    RF,0(RE)                                                         
         JNE   LNKJB10             No - get next entry in table                 
         LA    R2,MJBPSUBJ                                                      
         AHI   RF,1                                                             
         AR    R2,RF                                                            
         LLC   RE,LDGAL2                                                        
         SR    RE,RF                                                            
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         CLC   0(0,R2),L'CPJCLI(R3) Does the product match                      
         EX    RE,0(RF)                                                         
         JNE   LNKJB10             No - get next entry in table                 
         AHI   RE,1                                                             
         AR    R2,RE                                                            
         LLC   RF,LDGAL3                                                        
         LLC   RE,LDGAL2                                                        
         SR    RF,RE                                                            
         CHI   RF,7                                                             
         JNE   *+8                                                              
         LA    RF,6                                                             
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         CLC   0(0,R2),L'CPJCLI+L'CPJPRO(R3) Does job match                     
         EX    RF,0(RE)                                                         
         JNE   LNKJB10             No - get next entry in table                 
         XC    0(L'CPJCLI+L'CPJPRO+L'CPJJOB,R3),0(R3) Exists                    
         J     LNKJB04             Clear entry and get next passive             
                                                                                
LNKJB10  LA    R3,L'CPJCLI+L'CPJPRO+L'CPJJOB(R3)                                
         JCT   R0,LNKJB08          Get next                                     
LNKJB12  OI    MJBPSTAT,MJBSDELT                                                
         GOTOR AUDJBDL,1           Audit sub jobs deleted                       
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR+IO2'                            
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R1,=AL4(IOGETRUP+IOMST+IO2)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R4,AIO2                                                          
         USING ACTRECD,R4                                                       
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),('SPAELQ',ACTRECD),           +        
               (1,=AL1(SPATMJOB))                                               
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
         LA    R4,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO2'                           
         JE    LNKJB04                                                          
         DC    H'0'                                                             
*                                                                               
LNKJB14  GOTOR AUDJBDL,2           Audit sub jobs deleted                       
         XC    BYTE1,BYTE1                                                      
         XR    R3,R3                                                            
         ICM   R3,7,QA_ALJB        R3=A(Uploaded linked jobs)                   
         JZ    EXITY               No data just delete                          
         SR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R3)  Number of linked jobs                     
         AHI   R3,LW_LN2Q          R3=A(first address of data)                  
LNKJB16  OC    0(L'CPJCLI,R3),0(R3)     Any data in this entry                  
         JZ    LNKJB40             No - go to next entry in WMP                 
         USING ACTRECD,R4                                                       
         LA    R4,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(L'PRODUL),PRODUL                                         
         LLC   RF,LDGAL1           Build up sub job code                        
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   ACTKACT(0),0(R3)                                                 
         EX    RF,0(RE)                                                         
         LA    R2,ACTKACT                                                       
         AHI   RF,1                                                             
         AR    R2,RF                                                            
         LLC   RE,LDGAL2                                                        
         SR    RE,RF                                                            
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   0(0,R2),L'CPJCLI(R3)                                             
         EX    RE,0(RF)                                                         
         AHI   RE,1                                                             
         AR    R2,RE                                                            
         LLC   RF,LDGAL3                                                        
         LLC   RE,LDGAL2                                                        
         SR    RF,RE                                                            
         CHI   RF,7                                                             
         JNE   *+8                                                              
         LA    RF,6                                                             
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,R2),L'CPJCLI+L'CPJPRO(R3)                                    
         EX    RF,0(RE)                                                         
         MVC   AC_ULA,ACTKULA                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    LNKJB17                                                          
         CLI   QA_UPLD,QA_ACCTL    If accounting tool throw error               
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR SAVERR,DMCB,=AL2(AE$RMSTJ),(5,=C'EC100'),=AL2(FLD089)            
         J     EXITY                                                            
*                                                                               
LNKJB17  MVC   AC_DA,ACTKDA                                                     
         MVC   AC_KSTA,ACTKSTA                                                  
         L     R1,=AL4(IOGETRUP+IOMST+IO2)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R4,AIO2                                                          
         LA    R2,ACTRFST                                                       
         XC    AC_OLACT,AC_OLACT                                                
         USING SPAELD,R2                                                        
LNKJB18  CLI   SPAEL,0                                                          
         JE    LNKJB24                                                          
         CLI   SPAEL,SPAELQ                                                     
         JE    LNKJB22                                                          
LNKJB20  LLC   RE,SPALN                                                         
         AR    R2,RE                                                            
         J     LNKJB18                                                          
*                                                                               
LNKJB22  CLI   SPATYPE,SPATMJOB                                                 
         JNE   LNKJB20                                                          
         MVC   AC_OLACT,SPAAACT                                                 
         MVC   SPAAACT,OA_ACT                                                   
         J     LNKJB26                                                          
*                                                                               
LNKJB24  LA    R2,ELEMENT                                                       
         XC    SPAEL(SPALNQ),SPAEL                                              
         MVI   SPAEL,SPAELQ                                                     
         MVI   SPALN,SPALNQ                                                     
         MVI   SPATYPE,SPATMJOB                                                 
         MVC   SPAAUNT(L'PRODUL),PRODUL                                         
         MVC   SPAAACT,OA_ACT                                                   
         GOTO1 VHELLO,DMCB,(C'P',ACCMST),ACTRECD,SPAELD                         
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
         DROP  R2                                                               
*                                                                               
LNKJB26  GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO2'                           
         JE    *+6                                                              
         DC    H'0'                                                             
         USING MJBPASD,R4                                                       
         LA    R4,IOKEY                                                         
         OC    AC_OLACT,AC_OLACT   Have we changed from one master              
         JZ    LNKJB28             job to another                               
         XC    MJBPAS,MJBPAS       Yes - we must deleted old passive            
         MVI   MJBPTYP,MJBPTYPQ                                                 
         MVI   MJBPSUB,MJBPSUBQ                                                 
         MVC   MJBPCPY,CUXCPY                                                   
         MVC   MJBPACT,AC_OLACT                                                 
         MVC   MJBPSUBJ,AC_ACT                                                  
         MVC   CSVKEY1,MJBPAS                                                   
         L     R1,=AL4(IORDUPD+IODIR+IO2)                                       
         GOTOR (#IOEXEC,AIOEXEC)                                                
         CLI   IOERR,IOEDEL                                                     
         JE    LNKJB28                                                          
         OI    MJBPSTAT,MJBSDELT                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR+IO2'                            
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
LNKJB28  XC    MJBPAS,MJBPAS       Build new passive for new master job         
         MVI   MJBPTYP,MJBPTYPQ                                                 
         MVI   MJBPSUB,MJBPSUBQ                                                 
         MVC   MJBPCPY,CUXCPY                                                   
         MVC   MJBPACT,OA_ACT      Master job                                   
         MVC   MJBPSUBJ,AC_ACT     Sub job code                                 
         MVC   CSVKEY1,MJBPAS                                                   
         L     R1,=AL4(IORDUPD+IODIR+IO2)                                       
         GOTOR (#IOEXEC,AIOEXEC)                                                
         CLI   IOERR,IOEDEL                                                     
         JNE   LNKJB32                                                          
         MVC   MJBPSTA,AC_KSTA                                                  
         MVC   MJBPDA,AC_DA                                                     
         GOTOR AUDJBAD,1           Audit sub jobs added                         
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR+IO2'                            
         JE    LNKJB40                                                          
         DC    H'0'                                                             
                                                                                
LNKJB32  CLI   IOERR,IOERNF                                                     
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   MJBPAS,CSVKEY1                                                   
         MVC   MJBPSTA,AC_KSTA                                                  
         MVC   MJBPDA,AC_DA                                                     
         GOTOR AUDJBAD,1           Audit sub jobs added                         
         GOTOR (#IOEXEC,AIOEXEC),'IOADD+IODIR+IO2'                              
         JE    LNKJB40                                                          
         DC    H'0'                                                             
LNKJB40  LA    R3,L'CPJCLI+L'CPJPRO+L'CPJJOB(R3)                                
         JCT   R0,LNKJB16          Get next                                     
         GOTOR AUDJBAD,2           Audit sub jobs added                         
         J     EXITY                                                            
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* Create status change element for approval/rejection                 *         
***********************************************************************         
         SPACE 1                                                                
ADDSTC   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDSTC*'                                                      
         L     R3,AIO3                                                          
         USING ACTRECD,R3                                                       
         L     R4,SVSTCELS                                                      
                                                                                
         CLI   QA_ASTAT,QA_ANEW    Is this a new account                        
         JE    ADDSTC10            Yes                                          
         CLI   QA_ASTAT,QA_AAUTO                                                
         JE    ADDSTC10            No                                           
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('RACELQ',ACTRECD),           +        
               (1,=AL1(RACTCHA))                                                
         CLI   12(R1),0                                                         
         JNE   ADDSTC02                                                         
         L     R2,12(R1)                                                        
         USING RACELD,R2                                                        
         MVC   RACUSER,CUUSER                                                   
         MVC   RACPERS,CCTPID                                                   
         MVC   RACTERM,CUTERM                                                   
         MVC   RACDATE,AC_TODYP                                                 
         MVC   RACTIME,CTIME                                                    
         MVI   RACAPPL,RACAURAQ                                                 
         SR    RF,RF                                                            
         ICM   RF,3,CUXPNUM        Check whether BrandOcean or Aura             
         CHI   RF,XPACCUPQ         Check whether AccUpload is connected         
         JNE   *+8                                                              
         MVI   RACAPPL,RACAUPLQ                                                 
*&&UK                                                                           
         CHI   RF,XPMEDHUB         Check whether MediaHUB is connected          
         JNE   *+8                                                              
         MVI   RACAPPL,RACMHUBQ                                                 
*&&                                                                             
         J     ADDSTC04                                                         
                                                                                
ADDSTC02 LA    R2,ELEMENT                                                       
         USING RACELD,R2                                                        
         MVI   RACEL,RACELQ                                                     
         MVI   RACLN,RACLNQ                                                     
         MVI   RACTYPE,RACTCHA                                                  
         MVC   RACUSER,CUUSER                                                   
         MVC   RACPERS,CCTPID                                                   
         MVC   RACTERM,CUTERM                                                   
         MVC   RACDATE,AC_TODYP                                                 
         MVC   RACTIME,CTIME                                                    
         MVI   RACAPPL,RACAURAQ                                                 
         SR    RF,RF                                                            
         ICM   RF,3,CUXPNUM        Check whether BrandOcean or Aura             
         CHI   RF,XPACCUPQ         Check whether AccUpload is connected         
         JNE   *+8                                                              
         MVI   RACAPPL,RACAUPLQ                                                 
*&&UK                                                                           
         CHI   RF,XPMEDHUB         Check whether MediaHUB is connected          
         JNE   *+8                                                              
         MVI   RACAPPL,RACMHUBQ                                                 
*&&                                                                             
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,RACELD                         
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         USING STCELD,R4                                                        
ADDSTC04 OC    QA_NMED,QA_NMED                                                  
         JZ    ADDSTC06                                                         
         XC    STCEL(STCLN18Q),STCEL                                            
         MVI   STCEL,STCELQ                                                     
         MVI   STCLN,STCLN18Q                                                   
         MVI   STCIND,STCIACT                                                   
         MVI   STCATYP,STCAMEDC                                                 
         MVC   STCUSER,CUUSER                                                   
         MVC   STCPERS,CCTPID                                                   
         MVC   STCTERM,CUTERM                                                   
         MVC   STCDATE,AC_TODYP                                                 
         MVC   STCTIME,CTIME                                                    
         MVI   STCASTAT,STCACHG                                                 
         OC    STCASTAT,SSTCAPL                                                 
         MVC   STCAMED,QA_NMED                                                  
         AHI   R4,STCLN18Q                                                      
ADDSTC06 OC    QA_NPRO,QA_NPRO                                                  
         JZ    ADDSTC08                                                         
         XC    STCEL(STCLN19Q),STCEL                                            
         MVI   STCEL,STCELQ                                                     
         MVI   STCLN,STCLN19Q                                                   
         MVI   STCIND,STCIACT                                                   
         MVI   STCATYP,STCAPROC                                                 
         MVC   STCUSER,CUUSER                                                   
         MVC   STCPERS,CCTPID                                                   
         MVC   STCTERM,CUTERM                                                   
         MVC   STCDATE,AC_TODYP                                                 
         MVC   STCTIME,CTIME                                                    
         MVI   STCASTAT,STCACHG                                                 
         OC    STCASTAT,SSTCAPL                                                 
         MVC   STCAPRO,QA_NPRO                                                  
         AHI   R4,STCLN19Q                                                      
ADDSTC08 CLC   QA_ULA,OA_ULA       Has overall account changed                  
         JE    ADDSTC10            No                                           
         LLC   R1,LDGAL2           Check job level                              
         LHI   RF,L'ACTKACT                                                     
         SR    RF,R1               RF=Length of remaining account code          
         LA    R2,QA_ACT                                                        
         AR    R2,R1                                                            
         LA    RE,OA_ACT                                                        
         AR    RE,R1                                                            
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         CLC   0(0,R2),0(RE)       Has the job code changed                     
         EX    RF,0(R1)                                                         
         JE    ADDSTC10            No                                           
         XC    STCEL(STCLN19Q),STCEL   Yes - capture in the audit               
         MVI   STCEL,STCELQ                                                     
         MVI   STCLN,STCLN19Q                                                   
         MVI   STCIND,STCIACT                                                   
         MVI   STCATYP,STCAJOBC                                                 
         MVC   STCUSER,CUUSER                                                   
         MVC   STCPERS,CCTPID                                                   
         MVC   STCTERM,CUTERM                                                   
         MVC   STCDATE,AC_TODYP                                                 
         MVC   STCTIME,CTIME                                                    
         MVI   STCASTAT,STCACHG                                                 
         OC    STCASTAT,SSTCAPL                                                 
         MVC   STCAJBC,0(RE)                                                    
         AHI   R4,STCLN20Q                                                      
                                                                                
ADDSTC10 TM    AC_IND2,AC_IAPPR                                                 
         JZ    ADDSTC12                                                         
         LA    R2,ELEMENT          Build approver element                       
         USING RACELD,R2                                                        
         MVI   RACEL,RACELQ                                                     
         MVI   RACLN,RACLNQ                                                     
         MVI   RACTYPE,RACTAPP                                                  
         MVI   RACVRVN,RACTAPP                                                  
         MVC   RACUSER,CUUSER                                                   
         MVC   RACPERS,CCTPID                                                   
         MVC   RACTERM,CUTERM                                                   
         MVC   RACDATE,AC_TODYP                                                 
         MVC   RACTIME,CTIME                                                    
         MVI   RACAPPL,RACAURAQ                                                 
         SR    RF,RF                                                            
         ICM   RF,3,CUXPNUM        Check whether BrandOcean or Aura             
         CHI   RF,XPACCUPQ         Check whether AccUpload is connected         
         JNE   *+8                                                              
         MVI   RACAPPL,RACAUPLQ                                                 
*&&UK                                                                           
         CHI   RF,XPMEDHUB         Check whether MediaHUB is connected          
         JNE   *+8                                                              
         MVI   RACAPPL,RACMHUBQ                                                 
*&&                                                                             
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,RACELD                         
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
ADDSTC12 MVC   OA_ACSTA,ACTRSTAT                                                
         CLI   QA_ASTAT,QA_ADELT   Are we deleting an account                   
         JE    ADDSTC22            Yes                                          
         CLC   PRODUL,ACTKULA                                                   
         JE    ADDSTC16                                                         
         TM    LEDGSTA2,LDGSDRFT   Add all accounts as draft                    
         JZ    EXITY               No                                           
         J     ADDSTC16                                                         
ADDSTC14 L     R1,AGOXBLCK                                                      
         USING GOXBLKD,R1                                                       
         CLI   GODRFT,YESQ         Add jobs as draft - old workflow             
         JE    *+12                                                             
         CLI   GODRFT,C'D'         New workflow                                 
         JNE   EXITY               No drafts = no approvers                     
         DROP  R1                                                               
                                                                                
ADDSTC16 TM    ACTRSTAT,ACTSDRFT   Is account approved                          
         JZ    EXITY               Yes - nothing to do                          
         TM    AC_IND2,AC_IDRFT    Is account to remain draft                   
         JNZ   *+14                Yes                                          
         NI    ACTRSTAT,X'FF'-ACTSDRFT  No - remove draft                       
         MVC   OA_ACSTA,ACTRSTAT                                                
         TM    AC_JSTA2,JOBSREJ    Is the account rejected                      
         JNZ   ADDSTC20            Yes - can be approved or submitted           
         CLI   QA_ASTAT,QA_AREJT                                                
         JE    ADDSTC22                                                         
         CLI   QA_ASTAT,QA_ASUBM   Are we resubmitting                          
         JE    ADDSTC19                                                         
         CLI   QA_ASTAT,QA_ANEW    If a newly added no status needed            
         JE    ADDSTC18                                                         
         CLI   QA_ASTAT,QA_AAUTO                                                
         JNE   ADDSTC22                                                         
ADDSTC18 CLI   AC_USRAP,YESQ                                                    
         JNE   EXITY                                                            
         MVI   OA_STAT,QA_AAPPR    Set as approved                              
         USING STCELD,R4                                                        
         XC    STCEL(STCLN8Q),STCEL                                             
         MVI   STCEL,STCELQ                                                     
         MVI   STCLN,STCLN8Q                                                    
         MVI   STCIND,STCIACT                                                   
         MVI   STCATYP,STCAAPST                                                 
         MVC   STCUSER,CUUSER                                                   
         MVC   STCPERS,CCTPID                                                   
         MVC   STCTERM,CUTERM                                                   
         MVC   STCDATE,AC_TODYP                                                 
         MVC   STCTIME,CTIME                                                    
         MVI   STCASTA,QA_AAPPR                                                 
         MVI   STCASTAT,STCAADD                                                 
         OC    STCASTAT,SSTCAPL                                                 
         J     ADDSTC26                                                         
*                                                                               
         USING STCELD,R4                                                        
ADDSTC19 DS    0H                  New status is submit-save appr cmt?          
         OC    QA_ACMTL,QA_ACMTL                                                
         JZ    EXITY               No                                           
         XC    STCEL(STCLN8Q),STCEL                                             
         MVI   STCEL,STCELQ                                                     
         MVI   STCLN,STCLN8Q                                                    
         MVI   STCIND,STCIACT                                                   
         MVC   STCUSER,CUUSER                                                   
         MVC   STCPERS,CCTPID                                                   
         MVC   STCTERM,CUTERM                                                   
         MVC   STCDATE,AC_TODYP                                                 
         MVC   STCTIME,CTIME                                                    
         MVI   STCATYP,STCACOMT                                                 
         J     ADDSTC25                                                         
*                                                                               
ADDSTC20 CLI   QA_TYPE,QA_TSTAT    If only lock/close don't need                
         JE    ADDSTC26            to check status                              
         CLI   QA_TYPE,QA_TLOKS    Also for lock status bits                    
         JE    ADDSTC26                                                         
         CLI   QA_ASTAT,QA_AREJT                                                
         JNE   ADDSTC22                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$INFST),0,=AL2(FLD005)                        
         OI    TWAMODE,TWAMUWD                                                  
*                                                                               
         USING STCELD,R4                                                        
ADDSTC22 XC    STCEL(STCLN8Q),STCEL                                             
         MVI   STCEL,STCELQ                                                     
         MVI   STCLN,STCLN8Q                                                    
         MVI   STCIND,STCIACT                                                   
         MVC   STCUSER,CUUSER                                                   
         MVC   STCPERS,CCTPID                                                   
         MVC   STCTERM,CUTERM                                                   
         MVC   STCDATE,AC_TODYP                                                 
         MVC   STCTIME,CTIME                                                    
         CLI   QA_ASTAT,QA_ADELT                                                
         JNE   ADDSTC24                                                         
         MVI   STCATYP,STCACDEL                                                 
         MVI   STCASTAT,STCADEL                                                 
         OC    STCASTAT,SSTCAPL                                                 
         J     EXITY                                                            
                                                                                
ADDSTC24 MVI   STCATYP,STCAAPST                                                 
ADDSTC25 MVI   STCASTAT,STCACHG                                                 
         OC    STCASTAT,SSTCAPL                                                 
         CLI   QA_ASTAT,QA_AREJT                                                
         JNE   *+8                                                              
         MVI   STCASTA,QA_AREJT                                                 
         CLI   QA_ASTAT,QA_AAPPR                                                
         JNE   *+8                                                              
         MVI   STCASTA,QA_AAPPR                                                 
         CLI   QA_ASTAT,QA_ASUBM                                                
         JNE   *+8                                                              
         MVI   STCASTA,QA_ASUBM                                                 
         OC    QA_ACMTL,QA_ACMTL   Have we got any comments                     
         JZ    ADDSTC26            No                                           
         LLC   RF,QA_ACMTL         Yes                                          
         STC   RF,STCADATL                                                      
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   STCADATA(0),QA_ACMTS Add comments to data part of stcel          
         EX    RF,0(RE)                                                         
         AHI   RF,STCLN8Q+L'STCADATL+1                                          
         STC   RF,STCLN                                                         
         AR    R4,RF                                                            
ADDSTC26 J     EXITY                                                            
         DROP  R3,R4                                                            
         EJECT                                                                  
***********************************************************************         
* Add equivalent type code elements (SJ)                              *         
***********************************************************************         
         SPACE 1                                                                
         USING ACTRECD,R4                                                       
         USING FFTELD,R3                                                        
ADDSJQV  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDSJQ*'                                                      
         L     R4,AIO3                                                          
         LA    R3,ACTRFST                                                       
*        CLI   QA_UPLD,QA_SAPTL    Is it SAP upload tool?                       
*        JNE   *+12                                                             
*        TM    AC_IND1,AC_INEW2    Then don't add SJ equivalents for            
*        JNZ   ADDSJQX             products                                     
*                                                                               
         XR    R1,R1                                                            
         ICM   R1,7,QA_SJEQU       List of type/code pairs                      
         JZ    ADDSJQX                                                          
         XR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R1)                                            
         JZ    ADDSJQX             Anything to update?                          
*                                                                               
ADDSJQ02 CLI   FFTEL,0             Find existing elements                       
         JE    ADDSJQ06                                                         
         CLI   FFTEL,FFTELQ                                                     
         JNE   ADDSJQ04                                                         
         CLI   FFTTYPE,FFTTEPTR                                                 
         JNE   ADDSJQ04                                                         
         MVI   FFTEL,X'FF'                                                      
*                                                                               
ADDSJQ04 LLC   R0,FFTLN                                                         
         AR    R3,R0                                                            
         J     ADDSJQ02                                                         
*                                                                               
ADDSJQ06 GOTOR VHELLO,DMCB,(C'D',ACCMST),(X'FF',ACTRECD),0                      
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                Delete all existing element                  
*                                                                               
         MVI   BYTE1,0             Byte1 keeps track of sequence                
         XR    R1,R1               Check we have anything to update             
         ICM   R1,7,QA_SJEQU       List of type/code pairs                      
         JZ    ADDSJQ10                                                         
         XR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R1)                                            
         JZ    ADDSJQ10                                                         
         LA    R6,LW_LN2Q(R1)                                                   
*                                                                               
ADDSJQ08 LA    R3,ELEMENT          Build new elements                           
         XC    ELEMENT,ELEMENT                                                  
         MVI   FFTEL,FFTELQ                                                     
         MVI   FFTTYPE,FFTTEPTR                                                 
         MVC   FFTSEQ,BYTE1                                                     
         GOTOR SETXLN,DMCB,1(R6),L'EQUKCODE                                     
         L     RF,4(R1)                                                         
         BASR  RE,0                                                             
         MVC   FFTDATA(0),1(R6)                                                 
         EX    RF,0(RE)                                                         
         LA    RF,1(RF)                                                         
         STC   RF,FFTDLEN                                                       
         LA    RF,FFTDATA-FFTEL(RF)                                             
         STC   RF,FFTLN                                                         
         GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,FFTELD                         
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
         MVI   UPDATED,C'Y'                                                     
         LA    R6,1+L'EQUKCODE(R6)                                              
         LLC   RF,BYTE1            Bump sequence                                
         AHI   RF,1                                                             
         STC   RF,BYTE1                                                         
         JCT   R0,ADDSJQ08                                                      
*                                                                               
ADDSJQ10 DS    0H                                                               
*                                                                               
ADDSJQX  J     EXITY                                                            
         EJECT                                                                  
         DROP  R3,R4                                                            
***********************************************************************         
* Create activity pointer element                                     *         
***********************************************************************         
         SPACE 1                                                                
ADDPTR   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDPTR*'                                                      
         TM    CPYSTAT6,CPYSRAPP                                                
         JZ    EXITY                                                            
         XC    ELEMENT,ELEMENT                                                  
         XC    AELEMENT,AELEMENT                                                
         USING ACTRECD,R4                                                       
         L     R4,AIO3                                                          
         L     R3,AELEMENT                                                      
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('PTRELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JNE   ADDPTR02            No                                           
         L     R3,12(R1)           Yes                                          
         ST    R3,AELEMENT         Save address of element                      
OLD      USING PTRELD,R3                                                        
                                                                                
         USING PTRELD,R2                                                        
ADDPTR02 LA    R2,ELEMENT                                                       
         MVI   PTREL,PTRELQ                                                     
         MVI   PTRLN,PTRLN1Q+L'ACCKEY                                           
         MVI   PTRTYPE,PTRTRAP                                                  
         LA    R6,PTRCODE          ADD POINTER TO POINTER ELEMENT               
         USING RAPRECD,R6                                                       
         MVI   RAPKTYP,RAPKTYPQ                                                 
         MVC   RAPKCPY,CUXCPY                                                   
         MVC   RAPKDATE,AC_TODYC                                                
         GOTO1 VGETFACT,DMCB,(1,0)                                              
         L     R1,0(R1)                                                         
         USING FACTSD,R1                                                        
         MVC   RAPKTIME,FATIME+1   TIME IN BINARY SECONDS                       
         MVC   AC_TIME,FATIME+1                                                 
         DROP  R1                                                               
         MVI   RAPKRTYP,RAPKRJOB                                                
         MVC   RAPKKEY(L'RAPKACT),ACTKEY                                        
         DROP  R6                                                               
*                                                                               
ADDPTR04 OC    AELEMENT,AELEMENT                                                
         JZ    ADDPTR06                                                         
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),('PTRELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
ADDPTR06 GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,PTRELD                         
         CLI   12(R1),0                                                         
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  OLD,R2,R4                                                        
***********************************************************************         
* Create status change element for name change                        *         
***********************************************************************         
         SPACE 1                                                                
AUDNAM   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDNAM*'                                                      
         L     R4,SVSTCELS                                                      
         USING STCELD,R4                                                        
         XC    STCEL(STCLN14Q),STCEL                                            
         MVI   STCEL,STCELQ                                                     
         MVI   STCLN,STCLN7Q                                                    
         MVI   STCIND,STCIACT                                                   
         MVC   STCUSER,CUUSER                                                   
         MVC   STCPERS,CCTPID                                                   
         MVC   STCTERM,CUTERM                                                   
         MVC   STCDATE,AC_TODYP                                                 
         MVC   STCTIME,CTIME                                                    
         MVI   STCATYP,STCANAME                                                 
         MVI   STCASTAT,STCAADD                                                 
         CLI   QA_ASTAT,QA_ANEW    Is this a new account                        
         JE    AUDNAM02            Yes                                          
         CLI   QA_ASTAT,QA_AAUTO                                                
         JE    AUDNAM02            No                                           
         MVI   STCASTAT,STCACHG                                                 
AUDNAM02 OC    STCASTAT,SSTCAPL                                                 
         LLC   RE,QA_NAMEL                                                      
         STC   RE,STCADATL                                                      
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   STCADATA(0),QA_NAME                                              
         EX    RE,0(RF)                                                         
*                                                                               
         CLI   QA_UPLD,QA_SAPTL    If we're doing upload tool                   
         JNE   AUDNAM04            make sure it is upper case                   
         BASR  RF,0                                                             
         OC    STCADATA(0),SPACES                                               
         EX    RE,0(RF)                                                         
*                                                                               
AUDNAM04 AHI   RE,STCLN14Q+1                                                    
         STC   RE,STCLN                                                         
         AR    R4,RE                                                            
         ST    R4,SVSTCELS                                                      
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Create status change element for name change on other accounts      *         
***********************************************************************         
         SPACE 1                                                                
AUDACNM  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDACNM'                                                      
         LM    R2,R3,0(R1)         R2=A(old name) R3=A(new name)                
OLD      USING NAMELD,R2                                                        
         USING NAMELD,R3                                                        
         LA    R4,STCELEMT                                                      
         USING STCELD,R4                                                        
         XC    STCEL(STCLN14Q),STCEL                                            
         MVI   STCEL,STCELQ                                                     
         MVI   STCLN,STCLN7Q                                                    
         MVI   STCIND,STCIACT                                                   
         MVC   STCUSER,CUUSER                                                   
         MVC   STCPERS,CCTPID                                                   
         MVC   STCTERM,CUTERM                                                   
         MVC   STCDATE,AC_TODYP                                                 
         MVC   STCTIME,CTIME                                                    
         MVI   STCATYP,STCANAME                                                 
         MVI   STCASTAT,STCAADD                                                 
         CLI   OLD.NAMEL,0                                                      
         JE    AUDACNM2                                                         
         MVI   STCASTAT,STCACHG                                                 
         CLI   NAMEL,0                                                          
         JNE   AUDACNM2                                                         
         MVI   STCASTAT,STCADEL                                                 
         J     AUDACNM4                                                         
AUDACNM2 LLC   RE,QA_NAMEL                                                      
         STC   RE,STCADATL                                                      
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   STCADATA(0),QA_NAME                                              
         EX    RE,0(RF)                                                         
*                                                                               
         CLI   QA_UPLD,QA_SAPTL    If we're doing upload tool                   
         JNE   AUDACNM3            make sure it is upper case                   
         BASR  RF,0                                                             
         OC    STCADATA(0),SPACES                                               
         EX    RE,0(RF)                                                         
*                                                                               
AUDACNM3 AHI   RE,STCLN14Q+1                                                    
         STC   RE,STCLN                                                         
AUDACNM4 OC    STCASTAT,SSTCAPL    Set connected application                    
                                                                                
AUDACNM6 GOTOR UPDACAU             Update audit for this account                
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Create status change element for address change on other accounts   *         
***********************************************************************         
         SPACE 1                                                                
AUDACAD  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDACAD'                                                      
         LM    R2,R3,0(R1)         R2=A(old address) R3=A(new address)          
OLD      USING ADRELD,R2                                                        
         USING ADRELD,R3                                                        
         LA    R4,STCELEMT                                                      
         USING STCELD,R4                                                        
         XC    STCEL(STCLN14Q),STCEL                                            
         MVI   STCEL,STCELQ                                                     
         MVI   STCLN,STCLN7Q                                                    
         MVI   STCIND,STCIACT                                                   
         MVC   STCUSER,CUUSER                                                   
         MVC   STCPERS,CCTPID                                                   
         MVC   STCTERM,CUTERM                                                   
         MVC   STCDATE,AC_TODYP                                                 
         MVC   STCTIME,CTIME                                                    
         MVI   STCATYP,STCAADR                                                  
         MVI   STCASTAT,STCAADD                                                 
         CLI   OLD.ADREL,0                                                      
         JE    AUDACAD2                                                         
         MVI   STCASTAT,STCACHG                                                 
         CLI   ADREL,0                                                          
         JNE   AUDACAD2                                                         
         MVI   STCASTAT,STCADEL                                                 
         OC    STCASTAT,SSTCAPL    Set connected application                    
         J     AUDACAD8                                                         
AUDACAD2 OC    STCASTAT,SSTCAPL    Set connected application                    
         LLC   RF,ADRNUM                                                        
         LA    R5,STCADATA                                                      
AUDACAD4 MVC   0(L'ADRADD1,R5),ADRADD1 Is the address info the same             
         LA    R5,L'ADRADD1(R5)                                                 
         LA    R2,L'ADRADD1(R2)                                                 
         JCT   RF,AUDACAD4                                                      
*                                                                               
         SR    R5,R4                                                            
         STC   R5,STCLN                                                         
         SHI   R5,STCLN14Q                                                      
         STC   R5,STCADATL                                                      
AUDACAD8 GOTOR UPDACAU             Update audit for this account                
         J     EXITY                                                            
         DROP  OLD,R3,R4                                                        
         EJECT                                                                  
***********************************************************************         
* Create status change element for name change on other accounts      *         
***********************************************************************         
         SPACE 1                                                                
UPDACAU  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*UPDACAU'                                                      
         LA    R4,STCELEMT                                                      
         XC    BYTE1,BYTE1                                                      
NEW      USING STCELD,R4                                                        
         LA    R2,IOKEY                                                         
         USING AUDRECD,R2                                                       
         XC    AUDKEY,AUDKEY                                                    
         MVI   AUDKTYP,AUDKTYPQ                                                 
         MVI   AUDKSUB,AUDKSUBQ                                                 
         MVC   AUDKCPY,CUXCPY                                                   
         MVI   AUDKAUDT,AUDKACC                                                 
         MVC   AUDKULA,AC_ULA                                                   
         MVI   AUDKSEQ,0                                                        
         MVC   CSVKEY1,AUDKEY                                                   
         L     R1,=AL4(IORDUP+IODIR+IO2)                                        
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JNE   UPACA56                                                          
UPACA10  MVC   BYTE1,AUDKSEQ                                                    
                                                                                
         MVC   CSVKEY2,AUDKEY                                                   
         L     R1,=AL4(IOGETRUP+IOMST+IO2)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    UPACA20                                                          
         DC    H'0'                                                             
                                                                                
UPACA20  L     R2,AIO2                                                          
         XR    RF,RF                                                            
         ICM   RF,3,AUDRINDX                                                    
         AHI   RF,1                                                             
         STCM  RF,3,AUDRINDX                                                    
         MVC   AC_INDEX,AUDRINDX                                                
*                                                                               
         CLI   NEW.STCEL,0                                                      
         JE    UPACA40                                                          
         SR    RE,RE                                                            
         ICM   RE,3,AUDRLEN                                                     
         SR    RF,RF                                                            
         IC    RF,NEW.STCLN                                                     
         AR    RE,RF                                                            
         CH    RE,=H'2000'                                                      
         JH    UPACA40                                                          
         GOTO1 VHELLO,DMCB,(C'P',ACCMST),AUDRECD,NEW.STCELD,=C'ADD=END'         
         CLI   12(R1),0                                                         
         JE    UPACA30                                                          
         CLI   12(R1),5                                                         
         JE    UPACA40                                                          
         DC    H'0'                                                             
UPACA30  SR    RE,RE                                                            
         IC    RE,NEW.STCLN                                                     
         AR    R4,RE                                                            
*                                                                               
UPACA40  GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO2'                           
         JE    UPACA42                                                          
         DC    H'0'                                                             
UPACA42  LA    R2,IOKEY                                                         
         MVC   AUDKINDX,AC_INDEX                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR+IO2'                            
         JE    UPACA44                                                          
         DC    H'0'                                                             
UPACA44  MVC   IOKEY,CSVKEY2                                                    
         L     R1,=AL4(IORDUPD+IODIR+IO2)                                       
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    UPACA46                                                          
         DC    H'0'                                                             
UPACA46  L     R1,=AL4(IOSQUP+IODIR+IO2)                                        
         GOTOR (#IOEXEC,AIOEXEC)                                                
         CLC   CSVKEY1(AUDKSEQ-AUDKEY),AUDKEY DO ANY RECORDS EXIST              
         JE    UPACA10             YES                                          
UPACA54  SR    RE,RE               NO - BUILD NEW RECORD                        
         IC    RE,BYTE1                                                         
         AHI   RE,1                                                             
         STC   RE,BYTE1                                                         
UPACA56  CLI   NEW.STCEL,0                                                      
         JE    EXITY                                                            
         L     R2,AIO2                                                          
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO2                                        
         XC    AUDKEY,AUDKEY                                                    
         MVI   AUDKTYP,AUDKTYPQ                                                 
         MVI   AUDKSUB,AUDKSUBQ                                                 
         MVC   AUDKCPY,CUXCPY                                                   
         MVI   AUDKAUDT,AUDKACC                                                 
         MVC   AUDKULA,AC_ULA                                                   
         MVC   AUDKSEQ,BYTE1                                                    
         MVC   AUDRLEN,=Y(RAURFST-RAUKEY)                                       
         XC    AUDRSTA,AUDRSTA                                                  
         MVC   AUDRSTAT,AC_ACSTA                                                
         MVC   AUDRINDX,AC_INDEX                                                
UPACA58  CLI   NEW.STCEL,0                                                      
         JE    UPACA62                                                          
         SR    RE,RE                                                            
         ICM   RE,3,AUDRLEN                                                     
         SR    RF,RF                                                            
         IC    RF,NEW.STCLN                                                     
         AR    RE,RF                                                            
         CH    RE,=H'2000'                                                      
         JH    UPACA62                                                          
         GOTO1 VHELLO,DMCB,(C'P',ACCMST),AUDRECD,NEW.STCELD,=C'ADD=END'         
         CLI   12(R1),0                                                         
         JE    UPACA60                                                          
         CLI   12(R1),5                                                         
         JE    UPACA62                                                          
         DC    H'0'                                                             
*                                                                               
UPACA60  SR    RE,RE                                                            
         IC    RE,NEW.STCLN                                                     
         AR    R4,RE                                                            
         J     UPACA58                                                          
*                                                                               
UPACA62  MVC   IOKEY,AUDKEY                                                     
         L     R1,=AL4(IORDUPD+IODIR+IO2)                                       
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    UPACA64                                                          
         CLI   IOERR,IOEDEL                                                     
         JE    UPACA64                                                          
         GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOMST+IO2'                           
         JE    UPACA54                                                          
         DC    H'0'                                                             
*                                                                               
UPACA64  DS    0H                  update existing records                      
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO7                                        
         L     R0,AIO7             copy new record to IO7                       
         LA    R1,IOLENQ                                                        
         L     RE,AIO2                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         L     R1,=AL4(IOGETRUP+IOMST+IO2)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    UPACA66                                                          
         DC    H'0'                                                             
*                                                                               
UPACA66  L     R0,AIO2             copy new record to IO2                       
         LA    R1,2000                                                          
         L     RE,AIO7                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO2'                           
         JE    UPACA68                                                          
         DC    H'0'                                                             
UPACA68  LA    RE,IOKEY            pass new status                              
         MVC   AUDKSTA-AUDRECD(8,RE),AUDRSTA                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR+IO2'                            
         JE    UPACA54                                                          
         DC    H'0'                                                             
         DROP  NEW,R2                                                           
         EJECT ,                                                                
***********************************************************************         
* Update Estimate - update status on all estimate records for job     *         
***********************************************************************         
*&&UK                                                                           
JOBEST   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*JOBEST*'                                                      
                                                                                
         CLI   QA_ASTAT,QA_ANEW    Is this a new account                        
         JE    EXITY               Yes                                          
         USING ACTRECD,R2                                                       
         L     R2,AIO3             point to job record                          
                                                                                
         MVC   SJACLIC,SPACES                                                   
         MVC   SJAPROC,SPACES                                                   
         MVC   SJAJOBC,SPACES                                                   
         XR    RF,RF                                                            
         IC    RF,PCLILEN                                                       
         LR    R1,RF                                                            
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   SJACLIC(0),ACTKACT  MOVE IN CLIENT CODE                          
         EX    RF,0(RE)                                                         
         LA    R3,ACTKACT(R1)                                                   
         MVC   SJAPROC,0(R3)       MOVE IN PRODUCT CODE                         
         IC    R1,PPROLEN                                                       
         LA    R3,ACTKACT(R1)                                                   
         IC    RF,PJOBLEN                                                       
         SR    RF,R1                                                            
         CHI   RF,L'SJAJOBC                                                     
         JNH   *+8                                                              
         LHI   RF,L'SJAJOBC                                                     
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   SJAJOBC(0),0(R3)    MOVE IN JOB CODE                             
         EX    RF,0(RE)                                                         
         DROP  R2                                                               
*                                                                               
         CLC   SJAJOBC,SPACES     ANY JOB CODE?                                 
         JNH   JOBESTY            NO - !!!!                                     
         MVI   SESTLNO,0          SET ESTIMATE LOCAL NUMBER TO 0                
*                                                                               
         USING ESTRECD,R2         READING ALL ESTRECS FOR THIS JOB              
JOBEST02 LA    R2,IOKEY                                                         
         XC    ESTKEY,ESTKEY                                                    
         MVI   ESTKTYP,ESTKTYPQ                                                 
         MVI   ESTKSUB,ESTKSUBQ                                                 
         MVC   ESTKCPY,CUXCPY                                                   
         MVC   ESTKCLI,SJACLIC                                                  
         MVC   ESTKPRO,SJAPROC                                                  
         MVC   ESTKJOB,SJAJOBC                                                  
         MVC   ESTKLNO,SESTLNO    SAVED ESTIMATE LOCAL NUMBER                   
         MVC   CSVKEY1,IOKEY                                                    
*                                                                               
         LHI   R1,IOHI+IODIR+IO1                                                
         J     *+8                                                              
JOBEST04 LHI   R1,IOSQ+IODIR+IO1                                                
         GOTOR (#IOEXEC,AIOEXEC)                                                
         CLC   IOKEY(ESTKLNO-ESTRECD),CSVKEY1                                   
         JNE   JOBESTY             END - DIFFERENT JOB CODE                     
         CLI   ESTKSEQ,ESTKSMQ                                                  
         JNE   JOBEST04            UPDATE STATUS ON MAIN RECORD ONLY            
*                                                                               
         CLI   QA_CSTAT,YESQ       Is account closed                            
         JE    JOBEST06            Yes                                          
         TM    ESTKSTA3,ESTSJBCL                                                
         JZ    JOBESTY             Already open                                 
         J     *+12                                                             
JOBEST06 TM    ESTKSTA3,ESTSJBCL                                                
         JNZ   JOBESTY             Already close                                
                                                                                
         MVC   SESTLNO,ESTKLNO                                                  
         L     R1,=AL4(IORDUP+IODIR+IO1)                                        
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R1,=AL4(IOGETRUP+IOMST+IO1)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R3,AIO1                                                          
         OI    ESTKSTA3,ESTSJBCL   SET STATUS ON                                
         OI    ESTRSTA3-ESTRECD(R3),ESTSJBCL                                    
         CLI   QA_CSTAT,YESQ       Is account closed                            
         JE    *+12                Yes                                          
         NI    ESTKSTA3,FF-ESTSJBCL                                             
         NI    ESTRSTA3-ESTRECD(R3),FF-ESTSJBCL                                 
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO1'                           
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR+IO1'                            
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R3,ESTRFST-ESTRECD(R3)                                           
         USING EMDELD,R3                                                        
         SR    R0,R0                                                            
JOBEST08 CLI   EMDEL,0                                                          
         JNE   *+6                                                              
         DC    H'0'                EMDELQ IS MISSING                            
         CLI   EMDEL,EMDELQ        ESTIMATE MAIN DATA ELEMENT                   
         JE    *+14                                                             
         IC    R0,EMDLN                                                         
         AR    R3,R0                                                            
         J     JOBEST08                                                         
*                                                                               
         USING EGNPASD,R2                                                       
         XC    EGNPAS,EGNPAS       UPDATE STATUS ON ESTIMATE PASSIVE            
         MVI   EGNPTYP,EGNPTYPQ                                                 
         MVI   EGNPSUB,EGNPSUBQ                                                 
         MVC   EGNPCPY,CUXCPY                                                   
         MVC   EGNPNUM,EMDGNO                                                   
         MVC   EGNPCLI,SJACLIC                                                  
         MVC   EGNPPRO,SJAPROC                                                  
         MVC   EGNPJOB,SJAJOBC                                                  
         MVC   EGNPLNO,SESTLNO                                                  
         DROP  R3                                                               
*                                                                               
         L     R1,=AL4(IORDUP+IODIR+IO1)                                        
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JNE   JOBEST10            CAN'T FIND ESTIMATE PASSIVE!!!               
         OI    EGNPSTA3,EGNSJBCL   SET STATUS ON                                
         CLI   QA_CSTAT,YESQ       Is account closed                            
         JE    *+8                 Yes                                          
         NI    EGNPSTA3,FF-EGNSJBCL                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR+IO1'                            
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
JOBEST10 LLC   RF,SESTLNO                                                       
         LA    RF,1(,RF)                                                        
         STC   RF,SESTLNO          NEXT ESTIMATE LOCAL NUMBER                   
         J     JOBEST02            GET NEXT ESTIMATE RECORD                     
         DROP  R2                                                               
                                                                                
JOBESTY  J     EXITY                                                            
         EJECT ,                                                                
*&&                                                                             
                                                                                
***********************************************************************         
* Create status change element for address change                     *         
***********************************************************************         
         SPACE 1                                                                
AUDADR   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDADR*'                                                      
         L     R4,SVSTCELS                                                      
         USING STCELD,R4                                                        
         XC    STCEL(STCLN14Q),STCEL                                            
         MVI   STCEL,STCELQ                                                     
         MVI   STCLN,STCLN7Q                                                    
         MVI   STCIND,STCIACT                                                   
         MVC   STCUSER,CUUSER                                                   
         MVC   STCPERS,CCTPID                                                   
         MVC   STCTERM,CUTERM                                                   
         MVC   STCDATE,AC_TODYP                                                 
         MVC   STCTIME,CTIME                                                    
         MVI   STCATYP,STCAADR                                                  
         MVI   STCASTAT,STCAADD                                                 
         OC    AELEMENT,AELEMENT   Did address exist previously                 
         JZ    AUDADR02            No                                           
         MVI   STCASTAT,STCACHG    Yes - must be a change                       
         OC    ELEMENT,ELEMENT     Has address been deleted                     
         JNZ   AUDADR02            No                                           
         MVI   STCASTAT,STCADEL    Yes                                          
         OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN7Q                                                       
         ST    R4,SVSTCELS                                                      
         J     EXITY                                                            
*                                                                               
AUDADR02 OC    STCASTAT,SSTCAPL    Set connected application                    
         LA    R2,ELEMENT                                                       
         USING ADRELD,R2                                                        
         LLC   RF,ADRNUM                                                        
         LA    R5,STCADATA                                                      
AUDADR04 MVC   0(L'ADRADD1,R5),ADRADD1 Is the address info the same             
         LA    R5,L'ADRADD1+1(R5)                                               
         LA    R2,L'ADRADD1(R2)                                                 
         JCT   RF,AUDADR04                                                      
*                                                                               
         SR    R5,R4                                                            
         STC   R5,STCLN                                                         
         SHI   R5,STCLN14Q                                                      
         STC   R5,STCADATL                                                      
         AHI   R5,STCLN14Q                                                      
         AR    R4,R5                                                            
         ST    R4,SVSTCELS                                                      
         J     EXITY                                                            
         DROP  R2,R4                                                            
         EJECT                                                                  
***********************************************************************         
* Create status change element for record status changes              *         
***********************************************************************         
         SPACE 1                                                                
AUDRST   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDRST*'                                                      
         LM    R2,R3,0(R1)                                                      
         L     R4,SVSTCELS                                                      
         USING RSTELD,R2                                                        
OLD      USING RSTELD,R3                                                        
         OC    AELEMENT,AELEMENT   Did rst el exist previously                  
         JZ    AUDRST08            No - skip status bits                        
         USING RSTTABD,R6                                                       
         LA    R6,RSTTAB                                                        
AUDRST02 SR    R1,R1                                                            
         ICM   R1,3,CUXPNUM        Check whether BrandOcean or Aura             
         CHI   R1,XPRODIKQ          is connected                                
         JNE   AUDRST03                                                         
         CLI   RSTBIT,RSTSNOTS     If Aura ignore exclude from time             
         JE    AUDRST06            as this is handled by lock                   
AUDRST03 LH    RE,RSTDISP                                                       
         LR    RF,RE                                                            
         AR    RE,R2               RE=A(Status byte on new element)             
         AR    RF,R3               RF=A(Status byte on old element)             
         CLC   0(L'RSTSTAT1,RF),0(RE)                                           
         JE    AUDRST06                                                         
         MVC   BYTE1,0(RE)                                                      
         NC    BYTE1,RSTBIT                                                     
         MVC   BYTE2,0(RF)                                                      
         NC    BYTE2,RSTBIT                                                     
         CLC   BYTE1,BYTE2         Has this bit changed                         
         JE    AUDRST06            No                                           
         USING STCELD,R4                                                        
         LLC   R1,RSTSTC                                                        
         GOTOR BLDSTC                                                           
         MVI   STCASTAT,STCACHG    Yes - must be a change                       
         OC    STCASTAT,SSTCAPL    Set connected application                    
         MVI   STCASTA,STCANOQ                                                  
         OC    BYTE1,BYTE1         On or off                                    
         JZ    AUDRST04            Off                                          
         MVI   STCASTA,STCAYESQ    On - has changed to bit being on             
AUDRST04 AHI   R4,STCLN8Q                                                       
                                                                                
AUDRST06 LA    R6,RSTTABL(R6)                                                   
         CLI   RSTBIT,RSTEOT                                                    
         JNE   AUDRST02                                                         
                                                                                
AUDRST08 OC    AELEMENT,AELEMENT   Did rst el exist previously                  
         JZ    *+14                No - always add original details             
         CLC   RSTCOSTG,OLD.RSTCOSTG                                            
         JE    AUDRST14                                                         
         CLC   RSTCOSTG,SPACES                                                  
         JNH   AUDRST14                                                         
         GOTOR BLDSTC,STCACLIA                                                  
         MVC   STCASTA,RSTCOSTG                                                 
         MVI   STCASTAT,STCAADD                                                 
         OC    AELEMENT,AELEMENT   Did rst el exist previously                  
         JZ    AUDRST12            No                                           
         MVI   STCASTAT,STCACHG    Yes - must be a change                       
AUDRST12 OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN8Q                                                       
                                                                                
AUDRST14 OC    AELEMENT,AELEMENT   Did rst el exist previously                  
         JZ    *+14                No - always add original details             
         CLC   RSTSECY,OLD.RSTSECY                                              
         JE    AUDRST18                                                         
         OC    RSTSECY,RSTSECY                                                  
         JZ    AUDRST18                                                         
         GOTOR BLDSTC,STCASEC                                                   
         MVI   STCLN,STCLN15Q                                                   
         MVC   STCASECY,RSTSECY                                                 
         MVI   STCASTAT,STCAADD                                                 
         OC    AELEMENT,AELEMENT   Did rst el exist previously                  
         JZ    AUDRST16            No                                           
         MVI   STCASTAT,STCACHG    Yes - must be a change                       
AUDRST16 OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN15Q                                                      
                                                                                
AUDRST18 OC    AELEMENT,AELEMENT   Did rst el exist previously                  
         JZ    *+14                No - always add original details             
         CLC   RSTOFFC,OLD.RSTOFFC                                              
         JE    AUDRST22                                                         
         CLC   RSTOFFC,SPACES                                                   
         JNH   AUDRST22                                                         
         GOTOR BLDSTC,STCAGLOF                                                  
         MVI   STCLN,STCLN15Q                                                   
         MVC   STCAOFF,RSTOFFC                                                  
         MVI   STCASTAT,STCAADD                                                 
         OC    AELEMENT,AELEMENT   Did rst el exist previously                  
         JZ    AUDRST20            No                                           
         MVI   STCASTAT,STCACHG    Yes - must be a change                       
AUDRST20 OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN15Q                                                      
                                                                                
AUDRST22 OC    AELEMENT,AELEMENT   Did rst el exist previously                  
         JZ    *+14                No - always add original details             
         CLC   RSTDFTSK,OLD.RSTDFTSK                                            
         JE    AUDRST26                                                         
         CLC   RSTDFTSK,SPACES                                                  
         JNH   AUDRST26                                                         
         GOTOR BLDSTC,STCADFWC                                                  
         MVI   STCLN,STCLN15Q                                                   
         MVC   STCADWC,RSTDFTSK                                                 
         MVI   STCASTAT,STCAADD                                                 
         OC    AELEMENT,AELEMENT   Did rst el exist previously                  
         JZ    AUDRST24            No                                           
         MVI   STCASTAT,STCACHG    Yes - must be a change                       
AUDRST24 OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN15Q                                                      
                                                                                
AUDRST26 OC    AELEMENT,AELEMENT   Did rst el exist previously                  
         JNZ   AUDRST28            Yes                                          
         CLC   RSTFILT1,SPACES     No - do we have one now                      
         JNH   AUDRST38            No                                           
         MVI   BYTE1,STCAADD       Yes - audit as addition                      
         J     AUDRST34                                                         
                                                                                
AUDRST28 CLC   RSTFILT1,OLD.RSTFILT1                                            
         JE    AUDRST38                                                         
         CLC   RSTFILT1,SPACES     No - do we have one now                      
         JH    AUDRST30            Yes                                          
         MVI   BYTE1,STCADEL       Must be a deletion                           
         J     AUDRST34                                                         
                                                                                
AUDRST30 CLC   OLD.RSTFILT1,SPACES Did we have a filter before                  
         JH    AUDRST32            Yes                                          
         MVI   BYTE1,STCAADD       Must be an addition                          
         J     AUDRST34                                                         
                                                                                
AUDRST32 MVI   BYTE1,STCACHG       Otherwise must be a change                   
                                                                                
AUDRST34 GOTOR BLDSTC,STCAFLT1                                                  
         MVC   STCASTA,RSTFILT1                                                 
         MVC   STCASTAT,BYTE1                                                   
         CLI   BYTE1,STCADEL                                                    
         JNE   AUDRST36                                                         
         MVC   STCASTA,OLD.RSTFILT1                                             
AUDRST36 OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN8Q                                                       
                                                                                
AUDRST38 OC    AELEMENT,AELEMENT   Did rst el exist previously                  
         JNZ   AUDRST40            Yes                                          
         CLC   RSTFILT2,SPACES     No - do we have one now                      
         JNH   AUDRST50            No                                           
         MVI   BYTE1,STCAADD       Yes - audit as addition                      
         J     AUDRST46                                                         
                                                                                
AUDRST40 CLC   RSTFILT2,OLD.RSTFILT2                                            
         JE    AUDRST50                                                         
         CLC   RSTFILT2,SPACES     No - do we have one now                      
         JH    AUDRST42            Yes                                          
         MVI   BYTE1,STCADEL       Must be a deletion                           
         J     AUDRST46                                                         
                                                                                
AUDRST42 CLC   OLD.RSTFILT2,SPACES Did we have a filter before                  
         JH    AUDRST44            Yes                                          
         MVI   BYTE1,STCAADD       Must be an addition                          
         J     AUDRST46                                                         
                                                                                
AUDRST44 MVI   BYTE1,STCACHG       Otherwise must be a change                   
                                                                                
AUDRST46 GOTOR BLDSTC,STCAFLT2                                                  
         MVC   STCASTA,RSTFILT2                                                 
         MVC   STCASTAT,BYTE1                                                   
         CLI   BYTE1,STCADEL                                                    
         JNE   AUDRST48                                                         
         MVC   STCASTA,OLD.RSTFILT2                                             
AUDRST48 OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN8Q                                                       
                                                                                
AUDRST50 OC    AELEMENT,AELEMENT   Did rst el exist previously                  
         JNZ   AUDRST52            Yes                                          
         CLC   RSTFILT3,SPACES     No - do we have one now                      
         JNH   AUDRST62            No                                           
         MVI   BYTE1,STCAADD       Yes - audit as addition                      
         J     AUDRST58                                                         
                                                                                
AUDRST52 CLC   RSTFILT3,OLD.RSTFILT3                                            
         JE    AUDRST62                                                         
         CLC   RSTFILT3,SPACES     No - do we have one now                      
         JH    AUDRST54            Yes                                          
         MVI   BYTE1,STCADEL       Must be a deletion                           
         J     AUDRST58                                                         
                                                                                
AUDRST54 CLC   OLD.RSTFILT3,SPACES Did we have a filter before                  
         JH    AUDRST56            Yes                                          
         MVI   BYTE1,STCAADD       Must be an addition                          
         J     AUDRST58                                                         
                                                                                
AUDRST56 MVI   BYTE1,STCACHG       Otherwise must be a change                   
                                                                                
AUDRST58 GOTOR BLDSTC,STCAFLT3                                                  
         MVC   STCASTA,RSTFILT3                                                 
         MVC   STCASTAT,BYTE1                                                   
         CLI   BYTE1,STCADEL                                                    
         JNE   AUDRST60                                                         
         MVC   STCASTA,OLD.RSTFILT3                                             
AUDRST60 OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN8Q                                                       
                                                                                
AUDRST62 OC    AELEMENT,AELEMENT   Did rst el exist previously                  
         JNZ   AUDRST64            Yes                                          
         CLC   RSTFILT4,SPACES     No - do we have one now                      
         JNH   AUDRST74            No                                           
         MVI   BYTE1,STCAADD       Yes - audit as addition                      
         J     AUDRST70                                                         
                                                                                
AUDRST64 CLC   RSTFILT4,OLD.RSTFILT4                                            
         JE    AUDRST74                                                         
         CLC   RSTFILT4,SPACES     No - do we have one now                      
         JH    AUDRST66            Yes                                          
         MVI   BYTE1,STCADEL       Must be a deletion                           
         J     AUDRST70                                                         
                                                                                
AUDRST66 CLC   OLD.RSTFILT4,SPACES Did we have a filter before                  
         JH    AUDRST68            Yes                                          
         MVI   BYTE1,STCAADD       Must be an addition                          
         J     AUDRST70                                                         
                                                                                
AUDRST68 MVI   BYTE1,STCACHG       Otherwise must be a change                   
                                                                                
AUDRST70 GOTOR BLDSTC,STCAFLT4                                                  
         MVC   STCASTA,RSTFILT4                                                 
         MVC   STCASTAT,BYTE1                                                   
         CLI   BYTE1,STCADEL                                                    
         JNE   AUDRST72                                                         
         MVC   STCASTA,OLD.RSTFILT4                                             
AUDRST72 OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN8Q                                                       
                                                                                
AUDRST74 OC    AELEMENT,AELEMENT   Did rst el exist previously                  
         JNZ   AUDRST76            Yes                                          
         CLC   RSTFILT5,SPACES     No - do we have one now                      
         JNH   AUDRST86            No                                           
         MVI   BYTE1,STCAADD       Yes - audit as addition                      
         J     AUDRST82                                                         
                                                                                
AUDRST76 CLC   RSTFILT5,OLD.RSTFILT5                                            
         JE    AUDRST86                                                         
         CLC   RSTFILT5,SPACES     No - do we have one now                      
         JH    AUDRST78            Yes                                          
         MVI   BYTE1,STCADEL       Must be a deletion                           
         J     AUDRST82                                                         
                                                                                
AUDRST78 CLC   OLD.RSTFILT5,SPACES Did we have a filter before                  
         JH    AUDRST80            Yes                                          
         MVI   BYTE1,STCAADD       Must be an addition                          
         J     AUDRST82                                                         
                                                                                
AUDRST80 MVI   BYTE1,STCACHG       Otherwise must be a change                   
                                                                                
AUDRST82 GOTOR BLDSTC,STCAFLT5                                                  
         MVC   STCASTA,RSTFILT5                                                 
         MVC   STCASTAT,BYTE1                                                   
         CLI   BYTE1,STCADEL                                                    
         JNE   AUDRST84                                                         
         MVC   STCASTA,OLD.RSTFILT5                                             
AUDRST84 OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN8Q                                                       
                                                                                
AUDRST86 ST    R4,SVSTCELS                                                      
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Create status change element for account status element change      *         
***********************************************************************         
         SPACE 1                                                                
AUDAST   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDAST*'                                                      
         LM    R2,R3,0(R1)                                                      
         L     R4,SVSTCELS                                                      
         USING ASTELD,R2                                                        
OLD      USING ASTELD,R3                                                        
         L     R4,SVSTCELS                                                      
         OC    AELEMENT,AELEMENT   Did account status el prev exist             
         JZ    AUDAST08            No - skip status bits                        
                                                                                
         USING RSTTABD,R6                                                       
         LA    R6,ASTTAB                                                        
AUDAST02 LH    RE,RSTDISP                                                       
         LR    RF,RE                                                            
         AR    RE,R2               RE=A(Status byte on new element)             
         AR    RF,R3               RF=A(Status byte on old element)             
         CLC   0(L'RSTSTAT1,RF),0(RE)                                           
         JE    AUDAST06                                                         
         MVC   BYTE1,0(RE)                                                      
         NC    BYTE1,RSTBIT                                                     
         MVC   BYTE2,0(RF)                                                      
         NC    BYTE2,RSTBIT                                                     
         CLC   BYTE1,BYTE2         Has this bit changed                         
         JE    AUDAST06            No                                           
*                                                                               
         USING STCELD,R4                                                        
         LLC   R1,RSTSTC                                                        
         GOTOR BLDSTC                                                           
         MVI   STCASTAT,STCACHG    Yes - must be a change                       
         MVI   STCASTA,STCANOQ                                                  
         OC    BYTE1,BYTE1         On or off                                    
         JZ    AUDAST04            Off                                          
         MVI   STCASTA,STCAYESQ    On - has changed to bit being on             
AUDAST04 OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN8Q                                                       
*                                                                               
AUDAST06 LA    R6,RSTTABL(R6)                                                   
         CLI   RSTBIT,RSTEOT                                                    
         JNE   AUDAST02                                                         
*                                                                               
AUDAST08 ST    R4,SVSTCELS                                                      
         CLC   OLD.ASTCUR,ASTCUR                                                
         JNE   EXITY                                                            
         GOTOR BLDSTC,STCACURR     Change of currenct code                      
         MVI   STCASTAT,STCAADD                                                 
         OC    AELEMENT,AELEMENT   Did ast el exist previously                  
         JZ    AUDAST10            No                                           
         MVI   STCASTAT,STCACHG    Yes - must be a change                       
AUDAST10 MVC   STCACUR,ASTCUR                                                   
         OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN16Q                                                      
         ST    R4,SVSTCELS                                                      
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Create status change element for job element changes                *         
***********************************************************************         
         SPACE 1                                                                
AUDJOB   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDJOB*'                                                      
         LM    R2,R3,0(R1)                                                      
         L     R4,SVSTCELS                                                      
         USING JOBELD,R2                                                        
OLD      USING JOBELD,R3                                                        
         L     R4,SVSTCELS                                                      
         OC    AELEMENT,AELEMENT   Did account status el prev exist             
         JZ    AUDJOB08            No - skip status bits                        
         USING RSTTABD,R6                                                       
         LA    R6,JOBTAB                                                        
AUDJOB02 LH    RE,RSTDISP                                                       
         LR    RF,RE                                                            
         AR    RE,R2               RE=A(Status byte on new element)             
         AR    RF,R3               RF=A(Status byte on old element)             
         CLC   0(L'RSTSTAT1,RF),0(RE)                                           
         JE    AUDJOB06                                                         
         MVC   BYTE1,0(RE)                                                      
         NC    BYTE1,RSTBIT                                                     
         MVC   BYTE2,0(RF)                                                      
         NC    BYTE2,RSTBIT                                                     
         CLC   BYTE1,BYTE2         Has this bit changed                         
         JE    AUDJOB06            No                                           
*                                                                               
         USING STCELD,R4                                                        
         LLC   R1,RSTSTC                                                        
         GOTOR BLDSTC                                                           
         MVI   STCASTAT,STCACHG    Yes - must be a change                       
         MVI   STCASTA,STCANOQ                                                  
         OC    BYTE1,BYTE1         On or off                                    
         JZ    AUDJOB04            Off                                          
         MVI   STCASTA,STCAYESQ    On - has changed to bit being on             
AUDJOB04 OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN8Q                                                       
*                                                                               
AUDJOB06 LA    R6,RSTTABL(R6)                                                   
         CLI   RSTBIT,RSTEOT                                                    
         JNE   AUDJOB02                                                         
AUDJOB08 ST    R4,SVSTCELS                                                      
         OC    AELEMENT,AELEMENT   Did job el prev exist                        
         JZ    AUDJOB14            No treat as new                              
         OC    OLD.JOBODATE,OLD.JOBODATE  Any open date before                  
         JNZ   AUDJOB10            Yes - must be change or delete               
         OC    JOBODATE,JOBODATE   No - Any open date now                       
         JZ    AUDJOB18            No - nothing has changed                     
         J     AUDJOB14            Yes - treat as new                           
                                                                                
AUDJOB10 OC    JOBODATE,JOBODATE   Any open date now                            
         JZ    AUDJOB12            No - date has been deleted                   
         CLC   OLD.JOBODATE,JOBODATE Is the date the same                       
         JE    AUDJOB18            Yes                                          
         GOTOR BLDSTC,STCAOPDT     No bulid change element                      
         MVI   STCASTAT,STCACHG                                                 
         MVC   STCACUR,JOBODATE                                                 
         J     AUDJOB16                                                         
                                                                                
AUDJOB12 GOTOR BLDSTC,STCAOPDT     No bulid delete element                      
         MVI   STCASTAT,STCADEL                                                 
         MVC   STCACUR,OLD.JOBODATE                                             
         J     AUDJOB16                                                         
                                                                                
AUDJOB14 OC    JOBODATE,JOBODATE   Any open date now                            
         JZ    AUDJOB18            No - date has been deleted                   
         GOTOR BLDSTC,STCAOPDT     No bulid change element                      
         MVI   STCASTAT,STCAADD                                                 
         MVC   STCACUR,JOBODATE                                                 
AUDJOB16 MVI   STCLN,STCLN16Q                                                   
         OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN16Q                                                      
AUDJOB18 ST    R4,SVSTCELS                                                      
         OC    AELEMENT,AELEMENT   Did job el prev exist                        
         JZ    AUDJOB24            No treat as new                              
         OC    OLD.JOBCDATE,OLD.JOBCDATE  Any open date before                  
         JNZ   AUDJOB20            Yes - must be change or delete               
         OC    JOBCDATE,JOBCDATE   No - Any open date now                       
         JZ    AUDJOB28            No - nothing has changed                     
         J     AUDJOB24            Yes - treat as new                           
                                                                                
AUDJOB20 OC    JOBCDATE,JOBCDATE   Any open date now                            
         JZ    AUDJOB22            No - date has been deleted                   
         CLC   OLD.JOBCDATE,JOBCDATE Is the date the same                       
         JE    AUDJOB28            Yes                                          
         GOTOR BLDSTC,STCACLDT     No bulid change element                      
         MVI   STCASTAT,STCACHG                                                 
         MVC   STCACUR,JOBCDATE                                                 
         J     AUDJOB26                                                         
                                                                                
AUDJOB22 GOTOR BLDSTC,STCACLDT     No bulid delete element                      
         MVI   STCASTAT,STCADEL                                                 
         MVC   STCACUR,OLD.JOBCDATE                                             
         J     AUDJOB26                                                         
                                                                                
AUDJOB24 OC    JOBCDATE,JOBCDATE   Any open date now                            
         JZ    AUDJOB28            No - date has been deleted                   
         GOTOR BLDSTC,STCACLDT     No bulid change element                      
         MVI   STCASTAT,STCAADD                                                 
         MVC   STCACUR,JOBCDATE                                                 
AUDJOB26 MVI   STCLN,STCLN16Q                                                   
         OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN16Q                                                      
                                                                                
AUDJOB28 ST    R4,SVSTCELS                                                      
         J     EXITY                                                            
         EJECT                                                                  
*&&US                                                                           
***********************************************************************         
* Create status change element for lnk element changes                *         
***********************************************************************         
         SPACE 1                                                                
AUDLNK   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDLNK*'                                                      
         LM    R2,R3,0(R1)                                                      
         L     R4,SVSTCELS                                                      
         USING LNKELD,R2                                                        
OLD      USING LNKELD,R3                                                        
         L     R4,SVSTCELS                                                      
         USING STCELD,R4                                                        
                                                                                
         GOTOR BLDSTC,STCASTUT     Bulid add element                            
         OC    0(LNKLNQ,R2),0(R2)  No new element                               
         JZ    AUDLNK20            Assume delete                                
         LTR   R3,R3               We have old and new                          
         JNZ   AUDLNK10            Assume change                                
                                                                                
         MVI   STCASTAT,STCAADD                                                 
         MVC   STCASTUC,LNKSTUD                                                 
         OC    STCASTAT,SSTCAPL    Set connected application                    
         J     AUDLNK30                                                         
                                                                                
AUDLNK10 CLC   LNKSTUD,OLD.LNKSTUD   If the same, no need for audit             
         JE    AUDLNK40                                                         
         MVI   STCASTAT,STCACHG    Bulid change element                         
         MVC   STCASTUC,LNKSTUD                                                 
         OC    STCASTAT,SSTCAPL    Set connected application                    
         J     AUDLNK30                                                         
                                                                                
AUDLNK20 MVI   STCASTAT,STCADEL    Bulid delete element                         
         MVC   STCASTUC,OLD.LNKSTUD                                             
         OC    STCASTAT,SSTCAPL    Set connected application                    
                                                                                
AUDLNK30 LHI   RE,STCLN28Q                                                      
         STC   RE,STCLN                                                         
         AR    R4,RE                                                            
         ST    R4,SVSTCELS                                                      
                                                                                
AUDLNK40 GOTOR BLDSTC,STCASTUK     Bulid add element                            
         OC    0(LNKLNQ,R2),0(R2)  No new element                               
         JZ    AUDLNK60            Assume delete                                
         LTR   R3,R3               We have old and new                          
         JNZ   AUDLNK50            Assume change                                
                                                                                
AUDLNK45 OC    LNKAGJB,LNKAGJB     If no link, no need for audit                
         JZ    EXITY                                                            
         MVI   STCASTAT,STCAADD    Build add element                            
         MVC   STCASTUL,LNKAGJB                                                 
         OC    STCASTAT,SSTCAPL    Set connected application                    
         J     AUDLNK90                                                         
                                                                                
AUDLNK50 CLC   LNKAGJB,OLD.LNKAGJB   If the same, no need for audit             
         JE    EXITY                                                            
         OC    OLD.LNKAGJB,OLD.LNKAGJB    No old one, it's an add               
         JZ    AUDLNK45                                                         
         OC    LNKAGJB,LNKAGJB            No new one, it's a delete             
         JZ    AUDLNK60                                                         
AUDLNK55 MVI   STCASTAT,STCACHG    Bulid change element                         
         MVC   STCASTUL,LNKAGJB                                                 
         OC    STCASTAT,SSTCAPL    Set connected application                    
         J     AUDLNK90                                                         
                                                                                
AUDLNK60 CLC   OLD.LNKAGJB,SPACES  Is there anything to delete?                 
         JNH   EXITY               No, leave                                    
         MVI   STCASTAT,STCADEL    Bulid delete element                         
         MVC   STCASTUL,OLD.LNKAGJB                                             
         OC    STCASTAT,SSTCAPL    Set connected application                    
                                                                                
AUDLNK90 LHI   RE,STCLN29Q                                                      
         STC   RE,STCLN                                                         
         AR    R4,RE                                                            
         ST    R4,SVSTCELS                                                      
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Audit add or delete lnkel from Agency job                           *         
***********************************************************************         
         SPACE 1                                                                
AODLNK   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDLNK*'                                                      
         L     R4,SVSTCELS                                                      
         USING STCELD,R4                                                        
                                                                                
         GOTOR BLDSTC,STCASTUK     Bulid add element                            
         MVI   STCASTAT,STCAADD    Assume add                                   
         CLI   BYTE2,C'D'          Are we deleting?                             
         JNE   AODLNK10            No                                           
         MVI   STCASTAT,STCADEL    Bulid delete element                         
AODLNK10 MVC   STCASTUL,SVSLACCT                                                
                                                                                
         LHI   RE,STCLN29Q                                                      
         STC   RE,STCLN                                                         
         AR    R4,RE                                                            
         ST    R4,SVSTCELS                                                      
         J     EXITY                                                            
         EJECT                                                                  
*&&                                                                             
***********************************************************************         
* Create status change element for discount rate change               *         
***********************************************************************         
         SPACE 1                                                                
AUDDIS   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDDIS*'                                                      
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Create status change element for vat rate change                    *         
***********************************************************************         
         SPACE 1                                                                
AUDVAT   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDVAT*'                                                      
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Create status change element for bank details change                *         
***********************************************************************         
         SPACE 1                                                                
AUDBAC   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDBAC*'                                                      
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Create status change element for production profile changes         *         
***********************************************************************         
         SPACE 1                                                                
AUDPPR   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDPPR*'                                                      
         L     R4,SVSTCELS                                                      
         USING STCELD,R4                                                        
         USING PPRELD,R3                                                        
         LA    R3,ELEMENT                                                       
* PPRGRUP - DELETE                                                              
         OC    AELEMENT,AELEMENT   Do we have an old element                    
         JZ    AUDPPR05                                                         
OLD      USING PPRELD,R2                                                        
         L     R2,AELEMENT                                                      
         CLC   OLD.PPRGRUP,PPRGRUP                                              
         JE    AUDPPR10                                                         
         CLC   OLD.PPRGRUP,SPACES                                               
         JNH   AUDPPR05                                                         
         CLC   PPRGRUP,SPACES                                                   
         JH    AUDPPR05                                                         
         GOTOR BLDSTC,STCABLGP                                                  
         MVI   STCASTAT,STCADEL                                                 
         MVI   STCLN,STCLN7Q                                                    
         OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN7Q                                                       
         J     AUDPPR10                                                         
* PPRGRUP - ADD/CHANGE                                                          
AUDPPR05 CLC   PPRGRUP,SPACES                                                   
         JNH   AUDPPR10                                                         
         GOTOR BLDSTC,STCABLGP                                                  
         MVI   STCASTAT,STCAADD                                                 
         OC    AELEMENT,AELEMENT   Do we have an old element                    
         JZ    *+18                No                                           
         CLC   OLD.PPRGRUP,SPACES                                               
         JNH   *+8                                                              
         MVI   STCASTAT,STCACHG    Yes - must be a change                       
         MVC   STCAGRP,PPRGRUP                                                  
         MVI   STCLN,STCLN16Q                                                   
         OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN16Q                                                      
* PPRBILLP - DELETE                                                             
AUDPPR10 OC    AELEMENT,AELEMENT   Do we have an old element                    
         JZ    AUDPPR15                                                         
         CLC   OLD.PPRBILLP,PPRBILLP                                            
         JE    AUDPPR20                                                         
         CLC   OLD.PPRBILLP,SPACES                                              
         JNH   AUDPPR15                                                         
         CLC   PPRBILLP,SPACES                                                  
         JH    AUDPPR15                                                         
         GOTOR BLDSTC,STCAPRTB                                                  
         MVI   STCASTAT,STCADEL                                                 
         MVI   STCLN,STCLN7Q                                                    
         OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN7Q                                                       
         J     AUDPPR20                                                         
* PPRBILLP - ADD/CHANGE                                                         
AUDPPR15 CLC   PPRBILLP,SPACES                                                  
         JNH   AUDPPR20                                                         
         GOTOR BLDSTC,STCAPRTB                                                  
         MVI   STCASTAT,STCAADD                                                 
         OC    AELEMENT,AELEMENT   Do we have an old element                    
         JZ    *+18                No                                           
         CLC   OLD.PPRBILLP,SPACES                                              
         JNH   *+8                                                              
         MVI   STCASTAT,STCACHG    Yes - must be a change                       
         MVC   STCAPRB,PPRBILLP                                                 
         MVI   STCLN,STCLN17Q                                                   
         OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN17Q                                                      
* PPRRECV - DELETE                                                              
AUDPPR20 OC    AELEMENT,AELEMENT   Do we have an old element                    
         JZ    AUDPPR25                                                         
         CLC   OLD.PPRRECV,PPRRECV                                              
         JE    AUDPPR30                                                         
         CLC   OLD.PPRRECV,SPACES                                               
         JNH   AUDPPR25                                                         
         CLC   PPRRECV,SPACES                                                   
         JH    AUDPPR25                                                         
         GOTOR BLDSTC,STCARECV                                                  
         MVI   STCASTAT,STCADEL                                                 
         MVI   STCLN,STCLN7Q                                                    
         OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN7Q                                                       
         J     AUDPPR30                                                         
* PPRRECV - ADD/CHANGE                                                          
AUDPPR25 CLC   PPRRECV,SPACES                                                   
         JNH   AUDPPR30                                                         
         GOTOR BLDSTC,STCARECV                                                  
         MVI   STCASTAT,STCAADD                                                 
         OC    AELEMENT,AELEMENT   Do we have an old element                    
         JZ    *+18                No                                           
         CLC   OLD.PPRRECV,SPACES                                               
         JNH   *+8                                                              
         MVI   STCASTAT,STCACHG    Yes - must be a change                       
         MVC   STCAULA,PPRRECVC                                                 
         MVI   STCLN,STCLN13Q                                                   
         OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN13Q                                                      
* PPRCOST - DELETE                                                              
AUDPPR30 OC    AELEMENT,AELEMENT   Do we have an old element                    
         JZ    AUDPPR35                                                         
         CLC   OLD.PPRCOST,PPRCOST                                              
         JE    AUDPPR40                                                         
         CLC   OLD.PPRCOST,SPACES                                               
         JNH   AUDPPR35                                                         
         CLC   PPRCOST,SPACES                                                   
         JH    AUDPPR35                                                         
         GOTOR BLDSTC,STCAPRTB                                                  
         MVI   STCASTAT,STCADEL                                                 
         MVI   STCLN,STCLN7Q                                                    
         OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN7Q                                                       
         J     AUDPPR40                                                         
* PPRCOST - ADD/CHANGE                                                          
AUDPPR35 CLC   PPRCOST,SPACES                                                   
         JNH   AUDPPR40                                                         
         GOTOR BLDSTC,STCAPRTB                                                  
         MVI   STCASTAT,STCAADD                                                 
         OC    AELEMENT,AELEMENT   Do we have an old element                    
         JZ    *+18                No                                           
         CLC   OLD.PPRCOST,SPACES                                               
         JNH   *+8                                                              
         MVI   STCASTAT,STCACHG    Yes - must be a change                       
         MVC   STCAULA,PPRCOSTC                                                 
         MVI   STCLN,STCLN13Q                                                   
         OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN13Q                                                      
* PPRNARRP - delete                                                             
AUDPPR40 OC    AELEMENT,AELEMENT   Do we have an old element                    
         JZ    AUDPPR50                                                         
         CLI   OLD.PPRLN,PPRLN1Q   Any other info previously                    
         JE    AUDPPR50            No                                           
         CLI   PPRLN,PPRLN1Q       Yes - have we any now                        
         JNE   AUDPPR45            Yes                                          
         GOTOR BLDSTC,STCAOTHR     No - so data deleted                         
         MVI   STCASTAT,STCADEL                                                 
         MVI   STCLN,STCLN7Q                                                    
         OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN7Q                                                       
         J     AUDPPR60                                                         
* PPRNARRP - CHANGE                                                             
AUDPPR45 CLC   OLD.PPRLN,PPRLN     Is length the same                           
         JNE   AUDPPR50            No - must be a change                        
         LLC   RF,PPRLN                                                         
         SHI   RF,1+PPRLN1Q                                                     
         BASR  RE,0                                                             
         CLC   OLD.PPRNARRP(0),PPRNARRP                                         
         EX    RF,0(RE)                                                         
         JE    AUDPPR60                                                         
* PPRNARRP - ADD                                                                
AUDPPR50 CLI   PPRLN,PPRLN1Q       Have we any other info                       
         JE    AUDPPR60            No - nothing to do                           
         GOTOR BLDSTC,STCAOTHR                                                  
         MVI   STCASTAT,STCAADD                                                 
         OC    AELEMENT,AELEMENT   Do we have an old element                    
         JZ    AUDPPR52            No                                           
         CLI   OLD.PPRLN,PPRLN1Q   Any other info previously                    
         JE    *+8                                                              
         MVI   STCASTAT,STCACHG    Yes - must be a change                       
AUDPPR52 LLC   RF,PPRLN                                                         
         SHI   RF,PPRLN1Q                                                       
         LA    R5,STCADATA                                                      
AUDPPR55 LHI   R1,50                                                            
         CHI   RF,50               other info length                            
         JNL   *+6                                                              
         LR    R1,RF                                                            
         SHI   R1,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,R5),PPRNARRP                                                 
         EX    R1,0(RE)                                                         
         AHI   R1,1                                                             
         SR    RF,R1                                                            
         AR    R3,R1                                                            
         AR    R5,R1                                                            
         MVI   0(R5),C' '                                                       
         AHI   R5,1                                                             
         CHI   RF,0                                                             
         JNE   AUDPPR55                                                         
                                                                                
         OC    STCASTAT,SSTCAPL    Set connected application                    
         SR    R5,R4                                                            
         STC   R5,STCLN                                                         
         SHI   R5,STCLN14Q                                                      
         STC   R5,STCADATL                                                      
         AHI   R5,STCLN14Q                                                      
         AR    R4,R5                                                            
                                                                                
AUDPPR60 DS    0H                                                               
AUDPPRX  ST    R4,SVSTCELS                                                      
         J     EXITY                                                            
         DROP  OLD,R2,R3                                                        
         EJECT                                                                  
***********************************************************************         
* Create status change element for free form text element             *         
***********************************************************************         
         SPACE 1                                                                
AUDFFT   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDFFT*'                                                      
         LM    R2,R3,0(R1)                                                      
         USING FFTELD,R2                                                        
         USING FFTTABD,R6                                                       
NEW      USING FFTELD,R3                                                        
         L     R4,SVSTCELS                                                      
         USING STCELD,R4                                                        
         LLC   R1,FFTAUDT                                                       
         GOTOR BLDSTC                                                           
                                                                                
         LTR   R2,R2               Any old element                              
         JZ    *+12                No                                           
         CLI   FFTEL,FFTELQ        Have we an addition                          
         JE    AUDFFT02            No - delete or change                        
         CLI   NEW.FFTEL,0                                                      
         JE    EXITY               No - exit                                    
         MVI   STCASTAT,STCAADD    Yes - set audit as add                       
         J     AUDFFT06                                                         
                                                                                
AUDFFT02 CLI   NEW.FFTEL,FFTELQ    Has the sub amount been deleted              
         JE    AUDFFT04            No - set audit as change                     
         MVI   STCASTAT,STCADEL    Yes - as we don't have a new one             
         LR    R3,R2                                                            
         J     AUDFFT06                                                         
                                                                                
AUDFFT04 MVI   STCASTAT,STCACHG                                                 
         LLC   RF,FFTDLEN                                                       
         LLC   RE,NEW.FFTDLEN                                                   
         CR    RF,RE                                                            
         JNE   AUDFFT06                                                         
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         CLC   FFTDATA(0),NEW.FFTDATA                                           
         EX    RF,0(RE)                                                         
         JNE   AUDFFT06                                                         
         XC    STCEL(STCLN8Q),STCEL                                             
         J     EXITY                                                            
                                                                                
AUDFFT06 LLC   RF,NEW.FFTDLEN                                                   
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   STCADATA(0),NEW.FFTDATA                                          
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         STC   RF,STCADATL                                                      
         AHI   RF,STCLN14Q                                                      
         STC   RF,STCLN                                                         
         OC    STCASTAT,SSTCAPL    Set connected application                    
         AR    R4,RF                                                            
         ST    R4,SVSTCELS                                                      
         J     EXITY                                                            
         DROP  NEW,R2,R6                                                        
         EJECT                                                                  
***********************************************************************         
* Create status change element for general ledger account changes     *         
***********************************************************************         
         SPACE 1                                                                
AUDGLP   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDGLP*'                                                      
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Create status change element for short media name change            *         
***********************************************************************         
         SPACE 1                                                                
AUDSNM   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDSNM*'                                                      
         L     R4,SVSTCELS                                                      
         USING STCELD,R4                                                        
         GOTOR BLDSTC,STCAMSHN                                                  
         MVI   STCASTAT,STCACHG                                                 
         OC    AELEMENT,AELEMENT                                                
         JNZ   AUDSNM02                                                         
         MVI   STCASTAT,STCAADD                                                 
AUDSNM02 OC    QA_SHNAM,QA_SHNAM                                                
         JNZ   AUDSNM04                                                         
         MVI   STCASTAT,STCADEL                                                 
         OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN8Q                                                       
         ST    R4,SVSTCELS                                                      
         J     EXITY                                                            
AUDSNM04 MVI   STCADATL,L'QA_SHNAM                                              
         MVI   STCLN,STCLN14Q+L'QA_SHNAM                                        
         MVC   STCADATA(L'QA_SHNAM),QA_SHNAM                                    
         OC    STCASTAT,SSTCAPL    Set connected application                    
*                                                                               
         CLI   QA_UPLD,QA_SAPTL    If doing upload tool                         
         JNE   *+10                make sure upper case                         
         OC    STCADATA,SPACES                                                  
*                                                                               
         AHI   R4,STCLN14Q+L'QA_SHNAM                                           
         ST    R4,SVSTCELS                                                      
         J     EXITY                                                            
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* Create status change element for alternative/foreign name change    *         
***********************************************************************         
         SPACE 1                                                                
AUDXNM   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDXNM*'                                                      
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Create status change element for long description change            *         
***********************************************************************         
         SPACE 1                                                                
AUDJLD   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDJLD*'                                                      
         LM    R2,R3,0(R1)                                                      
         L     R4,SVSTCELS                                                      
         USING STCELD,R4                                                        
         XC    BYTE2,BYTE2                                                      
                                                                                
         LH    R6,HALF2            R6=Total length of description data          
         OC    HALF1,HALF1         Have we an addition                          
         JNZ   AUDJLD02            No - delete or change                        
         MVI   BYTE1,STCAADD       Yes - set audit as add                       
         J     AUDJLD06                                                         
                                                                                
AUDJLD02 OC    HALF2,HALF2         Has the description been deleted             
         JNZ   AUDJLD04            No - set audit as change                     
         MVI   BYTE1,STCADEL       Yes - as we don't have a new one             
         LR    R3,R2                                                            
         LH    R6,HALF1                                                         
         J     AUDJLD06                                                         
AUDJLD04 MVI   BYTE1,STCACHG                                                    
                                                                                
AUDJLD06 GOTOR BLDSTC,STCADESC                                                  
         MVC   STCADATS,BYTE2                                                   
         MVC   STCASTAT,BYTE1                                                   
         OC    STCASTAT,SSTCAPL    Set connected application                    
         LHI   RF,L'STCADATA       RF=Max length of data to extract             
         CHI   R6,L'STCADATA       Do we have more than max length              
         JNL   AUDJLD08            Yes                                          
         LR    RF,R6               No - extract what we have left               
AUDJLD08 SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   STCADATA(0),0(R3)                                                
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         STC   RF,STCADATL         Set data length                              
         SR    R6,RF               Subtract length extracted                    
         AR    R3,RF               Bump to next data                            
         AHI   RF,STCLN14Q                                                      
         STC   RF,STCLN            Set audit element length                     
         AR    R4,RF                                                            
         ST    R4,SVSTCELS                                                      
         LLC   RF,BYTE2                                                         
         AHI   RF,1                                                             
         STC   RF,BYTE2                                                         
         CHI   R6,0                Have we extracted all data                   
         JNE   AUDJLD06            No                                           
         J     EXITY               Yes                                          
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* Create status change element for comment change                     *         
***********************************************************************         
         SPACE 1                                                                
AUDSCM   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDSCM*'                                                      
         LM    R2,R3,0(R1)                                                      
         L     R4,SVSTCELS                                                      
         USING STCELD,R4                                                        
                                                                                
         LH    R6,HALF2            R6=Total length of comment data              
         OC    HALF1,HALF1         Have we an addition                          
         JNZ   AUDSCM02            No - delete or change                        
         MVI   BYTE1,STCAADD       Yes - set audit as add                       
         J     AUDSCM06                                                         
                                                                                
AUDSCM02 OC    HALF2,HALF2         Has the user field been deleted              
         JNZ   AUDSCM04            No - set audit as change                     
         MVI   BYTE1,STCADEL       Yes - as we don't have a new one             
         LR    R3,R2                                                            
         LH    R6,HALF1                                                         
         J     AUDSCM06                                                         
AUDSCM04 MVI   BYTE1,STCACHG                                                    
                                                                                
AUDSCM06 GOTOR BLDSTC,STCACOMT                                                  
         MVC   STCADATS,BYTE2                                                   
         MVC   STCASTAT,BYTE1                                                   
         OC    STCASTAT,SSTCAPL    Set connected application                    
         LHI   RF,L'STCADATA       Max length that can be extracted             
         CHI   R6,L'STCADATA       Do we have max length of data left           
         JNL   AUDSCM08            Yes                                          
         LR    RF,R6               No - extract what is left                    
AUDSCM08 SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   STCADATA(0),0(R3)                                                
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         STC   RF,STCADATL                                                      
         SR    R6,RF                                                            
         AR    R3,RF                                                            
         AHI   RF,STCLN14Q                                                      
         STC   RF,STCLN                                                         
         AR    R4,RF                                                            
         ST    R4,SVSTCELS                                                      
         LLC   RF,BYTE2                                                         
         AHI   RF,1                                                             
         STC   RF,BYTE2                                                         
         CHI   R6,0                                                             
         JNE   AUDSCM06                                                         
         J     EXITY                                                            
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* Create status change element for special account posting change     *         
***********************************************************************         
         SPACE 1                                                                
AUDSPA   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDSPA*'                                                      
         LM    R2,R3,0(R1)                                                      
         USING SPAELD,R2                                                        
         USING SPATABD,R6                                                       
NEW      USING SPAELD,R3                                                        
         L     R4,SVSTCELS                                                      
         USING STCELD,R4                                                        
         LLC   R1,SPAAUDTY         STCATYP                                      
         GOTOR BLDSTC                                                           
                                                                                
         LTR   R2,R2               Any old element                              
         JZ    *+12                No                                           
         CLI   SPAEL,SPAELQ        Have we an addition                          
         JE    AUDSPA02            No - delete or change                        
         CLI   NEW.SPAEL,0                                                      
         JE    AUDSPA05            No - exit and clear element                  
         MVI   STCASTAT,STCAADD    Yes - set audit as add                       
         J     AUDSPA08                                                         
                                                                                
AUDSPA02 CLI   NEW.SPAEL,SPAELQ    Has the account been deleted                 
         JE    AUDSPA04            No - set audit as change                     
         MVI   STCASTAT,STCADEL    Yes - as we don't have a new one             
         MVC   STCAULA,SPAAULA                                                  
         MVI   STCLN,STCLN13Q                                                   
         OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN13Q                                                      
         ST    R4,SVSTCELS                                                      
         GOTOR AUMSTJB,1           Create audit deleting master job             
         J     EXITY                                                            
                                                                                
AUDSPA04 MVI   STCASTAT,STCACHG                                                 
         CLC   NEW.SPAAULA,SPAAULA                                              
         JNE   AUDSPA06                                                         
AUDSPA05 XC    STCEL(STCLN8Q),STCEL                                             
         J     EXITY                                                            
                                                                                
AUDSPA06 GOTOR AUMSTJB,1           Create audit deleting master job             
AUDSPA08 GOTOR AUMSTJB,2           Create audit adding master job               
         MVC   STCAULA,NEW.SPAAULA                                              
         MVI   STCLN,STCLN13Q                                                   
         OC    STCASTAT,SSTCAPL    Set connected application                    
         AHI   R4,STCLN13Q                                                      
         ST    R4,SVSTCELS                                                      
         J     EXITY                                                            
         DROP  NEW,R2,R6                                                        
         EJECT                                                                  
***********************************************************************         
* Update audit record for master job if removing/changing master job  *         
***********************************************************************         
         SPACE 1                                                                
AUMSTJB  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUMSTJB'                                                      
         STC   R1,BYTE2                                                         
         USING SPAELD,R2                                                        
NEW      USING SPAELD,R3                                                        
         LA    R1,SPATYPE                                                       
         CLI   BYTE2,1             Are we deleting                              
         JE    *+8                 Yes                                          
         LA    R1,NEW.SPATYPE      No - we are adding                           
         CLI   0(R1),SPATMJOB      Are we dealing with master job               
         JNE   EXITY               No - not interested                          
         LA    R4,ELEMENT2                                                      
         USING STCELD,R4                                                        
         GOTOR BLDSTC,STCALKJB                                                  
         MVI   STCASTAT,STCADEL                                                 
         CLI   BYTE2,1             Are we adding or deleting master             
         JE    *+8                 We are deleting                              
         MVI   STCASTAT,STCAADD    We are adding                                
         OC    STCASTAT,SSTCAPL    Set connected application                    
         MVI   STCANUM,1                                                        
         MVC   STCAJOB,OA_ACT                                                   
         MVI   STCLN,STCLN10Q                                                   
K        USING AUDRECD,IOKEY                                                    
         XC    K.AUDKEY,K.AUDKEY                                                
         MVI   K.AUDKTYP,AUDKTYPQ                                               
         MVI   K.AUDKSUB,AUDKSUBQ                                               
         MVI   K.AUDKAUDT,AUDKACC                                               
         MVC   K.AUDKCPY,CUXCPY                                                 
         MVC   K.AUDKULA(L'PRODUL),PRODUL                                       
         MVC   K.AUDKACT,SPAAACT                                                
         CLI   BYTE2,1             Are we adding or deleting master             
         JE    *+10                We are deleting                              
         MVC   K.AUDKACT,NEW.SPAAACT We are adding                              
         MVC   CSVKEY1,K.AUDKEY                                                 
         XC    AC_KSTA,AC_KSTA                                                  
         L     R2,AIO2                                                          
         L     R1,=AL4(IOHIUP+IODIR+IO2)                                        
         GOTOR (#IOEXEC,AIOEXEC)                                                
         J     AUMSTJ04                                                         
*                                                                               
AUMSTJ02 L     R1,=AL4(IOSQUP+IODIR+IO2)                                        
         GOTOR (#IOEXEC,AIOEXEC)                                                
*                                                                               
AUMSTJ04 CLC   K.AUDKEY(AUDKSEQ-AUDKEY),CSVKEY1                                 
         JNE   AUMSTJ06            No record found - add one                    
         MVC   AC_KSTA,K.AUDKSTA                                                
         L     R1,=AL4(IOGETRUP+IOMST+IO2)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
         USING AUDRECD,R2                                                       
         SR    R0,R0                                                            
         ICM   R0,3,AUDRLEN        Get current record length                    
         LLC   RF,STCLN                                                         
         AR    R0,RF                                                            
         CHI   R0,2000                                                          
         JH    AUMSTJ02                                                         
         GOTO1 VHELLO,DMCB,(C'P',ACCMST),AUDRECD,STCELD,=C'ADD=END'             
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO2'                           
         JE    EXITY                                                            
         DC    H'0'                                                             
                                                                                
AUMSTJ06 MVC   AUDKEY,CSVKEY1                                                   
         MVC   AUDRSTA,AC_KSTA                                                  
         LA    RF,AUDRFST-AUDRECD                                               
         AHI   RF,STCLN10Q                                                      
         STH   RF,AUDRLEN          Set record length                            
         MVC   AUDRFST(STCLN10Q),STCELD  Add element                            
         MVI   AUDRFST+STCLN10Q,0  Set end of record                            
         GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOMST+IO2'                           
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  K,R2,R4                                                          
         EJECT                                                                  
***********************************************************************         
* Create status change element for user field change                  *         
***********************************************************************         
         SPACE 1                                                                
AUDUFS   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDUFS*'                                                      
         LM    R2,R3,0(R1)                                                      
         USING UFSELD,R2                                                        
NEW      USING UFSELD,R3                                                        
         L     R4,SVSTCELS                                                      
         USING STCELD,R4                                                        
         GOTOR BLDSTC,STCAUFS                                                   
                                                                                
         CLI   UFSEL,0             Have we an addition                          
         JNE   AUDUFS02            No - delete or change                        
         MVI   STCASTAT,STCAADD    Yes - set audit as add                       
         J     AUDUFS06                                                         
                                                                                
AUDUFS02 CLI   NEW.UFSEL,UFSELQ    Has the user field been deleted              
         JE    AUDUFS04            No - set audit as change                     
         MVI   STCASTAT,STCADEL    Yes - as we don't have a new one             
         LR    R3,R2                                                            
         J     AUDUFS06                                                         
AUDUFS04 MVI   STCASTAT,STCACHG                                                 
AUDUFS06 MVC   STCADATA(L'UFSDESC),NEW.UFSDESC Get description                  
         MVI   STCADATA+L'UFSDESC,C':'                                          
         XR    RF,RF                                                            
         CLI   NEW.UFSLN,UFSLN1Q   Has user field got any data                  
         JNH   AUDUFS08            No                                           
         LLC   RF,NEW.UFSLN        Yes  - extract this for audit                
         SHI   RF,UFSLN1Q+1                                                     
         BASR  RE,0                                                             
         MVC   STCADATA+L'UFSDESC+1(0),NEW.UFSDATA                              
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
AUDUFS08 AHI   RF,L'UFSDESC+1                                                   
         STC   RF,STCADATL                                                      
         AHI   RF,STCLN14Q                                                      
         STC   RF,STCLN                                                         
         OC    STCASTAT,SSTCAPL    Set connected application                    
         AR    R4,RF                                                            
         ST    R4,SVSTCELS                                                      
         J     EXITY                                                            
         DROP  NEW,R2                                                           
         EJECT                                                                  
***********************************************************************         
* Create status change element for due date change                    *         
***********************************************************************         
         SPACE 1                                                                
AUDDEX   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDDEX*'                                                      
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Create status change element for online memo change                 *         
***********************************************************************         
         SPACE 1                                                                
AUDOME   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDOME*'                                                      
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Create status change element for long name change                   *         
***********************************************************************         
         SPACE 1                                                                
AUDGPN   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDGPN*'                                                      
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Create status change element for creditor pid change                *         
***********************************************************************         
         SPACE 1                                                                
AUDPID   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDPID*'                                                      
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Create status change element for expense account change             *         
***********************************************************************         
         SPACE 1                                                                
AUDAPT   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDAPT*'                                                      
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Create status change element for sub cash info change               *         
***********************************************************************         
         SPACE 1                                                                
AUDSCI   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDSCI*'                                                      
         LM    R2,R3,0(R1)                                                      
         USING SCIELD,R2                                                        
         USING SCITABD,R6                                                       
NEW      USING SCIELD,R3                                                        
         L     R4,SVSTCELS                                                      
         USING STCELD,R4                                                        
         LLC   R1,SCIAUDT                                                       
         GOTOR BLDSTC                                                           
                                                                                
         LTR   R2,R2               Any old element                              
         JZ    *+12                No                                           
         CLI   SCIEL,SCIELQ        Have we an addition                          
         JE    AUDSCI02            No - delete or change                        
         CLI   NEW.SCIEL,0                                                      
         JE    EXITY               No - exit                                    
         MVI   STCASTAT,STCAADD    Yes - set audit as add                       
         J     AUDSCI06                                                         
                                                                                
AUDSCI02 CLI   NEW.SCIEL,SCIELQ    Has the sub amount been deleted              
         JE    AUDSCI04            No - set audit as change                     
         MVI   STCASTAT,STCADEL    Yes - as we don't have a new one             
         LR    R3,R2                                                            
         J     AUDSCI06                                                         
                                                                                
AUDSCI04 MVI   STCASTAT,STCACHG                                                 
         CLC   NEW.SCIAMNT,SCIAMNT                                              
         JNE   AUDSCI06                                                         
         XC    STCEL(STCLN8Q),STCEL                                             
         J     EXITY                                                            
                                                                                
AUDSCI06 MVC   STCAAMNT,NEW.SCIAMNT                                             
         MVI   STCLN,STCLN9Q                                                    
         OC    STCASTAT,SSTCAPL   Set connected application                     
         AHI   R4,STCLN9Q                                                       
         ST    R4,SVSTCELS                                                      
         J     EXITY                                                            
         DROP  NEW,R2,R6                                                        
                                                                                
***********************************************************************         
* Create status change element for ISO CTRY CODE                                
* ENTRY R2/R3 POINT TO OLD/NEW EBDEL (NULL IF NONE)                             
***********************************************************************         
         SPACE 1                                                                
*&&UK                                                                           
AUDISO   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDISO*'                                                      
*        LM    R2,R3,0(R1)                                                      
NEW      USING EBDELD,R2                                                        
         USING EBDELD,R3                                                        
         L     R4,SVSTCELS                                                      
         USING STCELD,R4                                                        
*                                                                               
         LTR   R3,R3               Any old element                              
         JZ    *+12                No                                           
         CLI   EBDEL,EBDELQ                                                     
         JE    AUDISO10            Yes - delete or change                       
         CLI   NEW.EBDEL,0         adding new elem?                             
         JE    EXITY               No - exit                                    
         LA    R0,STCAADD                                                       
         J     AUDISO20                                                         
*  have old elem - delete or change?                                            
AUDISO10 CLI   NEW.EBDEL,EBDELQ                                                 
         JE    AUDISO15            change                                       
         LA    R0,STCADEL          delete                                       
         LR    R2,R3                                                            
         J     AUDISO20                                                         
*  old and new element - any changes?                                           
AUDISO15 LA    R0,STCACHG                                                       
         CLC   NEW.EBDCTRY,EBDCTRY                                              
         JNE   AUDISO20                                                         
         JE    EXITY                   NO CHANGE, LET'S FORGET ABOUT            
*                                          THIS, AY?                            
AUDISO20 DS    0H                                                               
         GOTOR BLDSTC,STCIACT                                                   
         STC   R0,STCASTAT                                                      
         OC    STCASTAT,SSTCAPL                                                 
         MVI   STCATYP,STCACTRY                                                 
*                                                                               
         MVC   STCAISO,NEW.EBDCTRY                                              
         MVI   STCLN,STCLN23Q                                                   
         AHI   R4,STCLN23Q                                                      
         ST    R4,SVSTCELS                                                      
         J     EXITY                                                            
         DROP  NEW,R3                                                           
         EJECT                                                                  
                                                                                
***********************************************************************         
* Create status change element for IBAN                                         
* ENTRY R2/R3 POINT TO OLD/NEW EBDEL (NULL IF NONE)                             
***********************************************************************         
         SPACE 1                                                                
AUDIBAN  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDIBAN'                                                      
*        LM    R2,R3,0(R1)                                                      
         USING EBDELD,R3                                                        
NEW      USING EBDELD,R2                                                        
         L     R4,SVSTCELS                                                      
         USING STCELD,R4                                                        
*                                                                               
         LTR   R3,R3               Any old element                              
         JZ    *+12                No                                           
         CLI   EBDEL,EBDELQ                                                     
         JE    AUDIBN10            Yes - delete or change                       
         CLI   NEW.EBDEL,0         adding new elem?                             
         JE    EXITY               No - exit                                    
         LA    R0,STCAADD                                                       
         J     AUDIBN20                                                         
*  have old elem - delete or change?                                            
AUDIBN10 CLI   NEW.EBDEL,EBDELQ                                                 
         JE    AUDIBN15            change                                       
         LA    R0,STCADEL          delete                                       
         LR    R2,R3                                                            
         J     AUDIBN20                                                         
*  old and new element - any changes?                                           
AUDIBN15 LA    R0,STCACHG                                                       
         CLC   NEW.EBDIBAN,EBDIBAN                                              
         JNE   AUDIBN20                                                         
         JE    EXITY                   NO CHANGE, LET'S FORGET ABOUT            
*                                          THIS, AY?                            
AUDIBN20 DS    0H                                                               
         GOTOR BLDSTC,STCIACT                                                   
         STC   R0,STCASTAT                                                      
         OC    STCASTAT,SSTCAPL                                                 
         MVI   STCATYP,STCAIBAN                                                 
*                                                                               
         MVC   STCAIBN,NEW.EBDIBAN                                              
         MVI   STCLN,STCLN21Q                                                   
         AHI   R4,STCLN21Q                                                      
         ST    R4,SVSTCELS                                                      
         J     EXITY                                                            
         DROP  NEW,R3                                                           
         EJECT                                                                  
                                                                                
***********************************************************************         
* Create status change element for BIC code                                     
* ENTRY R2/R3 POINT TO OLD/NEW EBDEL (NULL IF NONE)                             
***********************************************************************         
         SPACE 1                                                                
AUDBIC   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDBIC*'                                                      
*        LM    R2,R3,0(R1)                                                      
NEW      USING EBDELD,R2                                                        
         USING EBDELD,R3                                                        
         L     R4,SVSTCELS                                                      
         USING STCELD,R4                                                        
*                                                                               
         LTR   R3,R3               Any old element                              
         JZ    *+12                No                                           
         CLI   EBDEL,EBDELQ                                                     
         JE    AUDBIC10            Yes - delete or change                       
         CLI   NEW.EBDEL,0         adding new elem?                             
         JE    EXITY               No - exit                                    
         LA    R0,STCAADD                                                       
         J     AUDBIC20                                                         
*  have old elem - delete or change?                                            
AUDBIC10 CLI   NEW.EBDEL,EBDELQ                                                 
         JE    AUDBIC15            change                                       
         LA    R0,STCADEL          delete                                       
         LR    R3,R2                                                            
         J     AUDBIC20                                                         
*  old and new element - any changes?                                           
AUDBIC15 LA    R0,STCACHG                                                       
         CLC   NEW.EBDBIC,EBDBIC                                                
         JNE   AUDBIC20                                                         
         JE    EXITY                   NO CHANGE, LET'S FORGET ABOUT            
*                                          THIS, AY?                            
AUDBIC20 DS    0H                                                               
         GOTOR BLDSTC,STCIACT                                                   
         STC   R0,STCASTAT                                                      
         OC    STCASTAT,SSTCAPL                                                 
         MVI   STCATYP,STCABIC                                                  
*                                                                               
         MVC   STCABICC,NEW.EBDBIC                                              
         MVI   STCLN,STCLN22Q                                                   
         AHI   R4,STCLN22Q                                                      
         ST    R4,SVSTCELS                                                      
         J     EXITY                                                            
         DROP  NEW,R3                                                           
*&&                                                                             
         EJECT                                                                  
***********************************************************************         
* Create status change element for client purchase order change       *         
***********************************************************************         
         SPACE 1                                                                
AUDCPO   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDCPO*'                                                      
         LM    R2,R3,0(R1)                                                      
         USING LIDDATA,R2                                                       
         LR    R6,R2                                                            
NEW      USING LIDDATA,R3                                                       
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO6   For change elements                  
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO7   For delete elements                  
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO8   For add elements                     
         MVC   ASAVCHG,AIO6                                                     
         MVC   ASAVDEL,AIO7                                                     
         MVC   ASAVADD,AIO8                                                     
         LH    RF,HALF2                RF=number of entries                     
AUDCPO02 LTR   R3,R3                   Any client orders new                    
         JZ    AUDCPO14                No                                       
         LTR   RF,RF                   Any client orders new                    
         JZ    AUDCPO14                No                                       
         OC    NEW.LIDCPO,NEW.LIDCPO   Any client orders new                    
         JZ    AUDCPO14                No                                       
         OC    LIDCPO,LIDCPO           Any client orders old                    
         JZ    AUDCPO12                No                                       
         CLC   NEW.LIDCPO,LIDCPO       Do they match                            
         JE    AUDCPO08                Yes                                      
AUDCPO04 LA    R2,LIDLLN7Q(R2)          Look at the next old one                
         J     AUDCPO02                                                         
                                                                                
AUDCPO08 CLC   NEW.LIDCPOAM,LIDCPOAM                                            
         JE    AUDCPO10                                                         
         L     R4,ASAVCHG                                                       
         MVC   0(LIDLLN7Q,R4),NEW.LIDCPO                                        
         LA    R4,LIDLLN7Q(R4)                                                  
         ST    R4,ASAVCHG                                                       
                                                                                
AUDCPO10 MVI   LIDCPO,X'FF'                                                     
         LA    R3,LIDLLN7Q(R3)                                                  
         LR    R2,R6                                                            
         JCT   RF,AUDCPO02                                                      
         J     AUDCPO14                                                         
                                                                                
AUDCPO12 L     R4,ASAVADD                                                       
         MVC   0(LIDLLN7Q,R4),NEW.LIDCPO                                        
         LA    R4,LIDLLN7Q(R4)                                                  
         ST    R4,ASAVADD                                                       
         LA    R3,LIDLLN7Q(R3)                                                  
         LR    R2,R6                                                            
         JCT   RF,AUDCPO02                                                      
                                                                                
AUDCPO14 OC    LIDCPO,LIDCPO           Any client orders old                    
         JZ    AUDCPO18                No                                       
         CLI   LIDCPO,X'FF'                                                     
         JE    AUDCPO16                                                         
         L     R4,ASAVDEL                                                       
         MVC   0(LIDLLN7Q,R4),LIDCPO                                            
         LA    R4,LIDLLN7Q(R4)                                                  
         ST    R4,ASAVDEL                                                       
                                                                                
AUDCPO16 LA    R2,LIDLLN7Q(R2)                                                  
         J     AUDCPO02                                                         
                                                                                
AUDCPO18 L     R4,SVSTCELS                                                      
         USING STCELD,R4                                                        
         LA    R5,AIO6             R2=A(Deleted client orders)                  
         L     R2,0(R5)                                                         
         LA    R3,3                                                             
AUDCPO20 OC    0(LIDLLN7Q,R2),0(R2)                                             
         JZ    AUDCPO26                                                         
         GOTOR BLDSTC,STCACLPO                                                  
         STC   R3,STCASTAT                                                      
         OC    STCASTAT,SSTCAPL                                                 
         LA    R6,STCACPO                                                       
STC      USING LIDDATA,R6                                                       
         XR    R1,R1                                                            
AUDCPO22 OC    0(LIDLLN7Q,R2),0(R2)                                             
         JZ    AUDCPO24                                                         
         MVC   STC.LIDCPO(LIDLLN7Q),0(R2)                                       
         AHI   R1,1                                                             
         LA    R2,LIDLLN7Q(R2)                                                  
         CHI   R1,9                                                             
         JE    AUDCPO24                                                         
         LA    R6,LIDLLN7Q(R6)                                                  
         J     AUDCPO22                                                         
                                                                                
AUDCPO24 STC   R1,STCANUM                                                       
         MHI   R1,LIDLLN7Q                                                      
         AHI   R1,STCLN8Q                                                       
         STC   R1,STCLN                                                         
         AR    R4,R1                                                            
         J     AUDCPO20                                                         
                                                                                
AUDCPO26 LA    R5,L'AIO6(R5)             R2=A(Changed client orders)            
         L     R2,0(R5)                                                         
         JCT   R3,AUDCPO20                                                      
         ST    R4,SVSTCELS                                                      
         J     EXITY                                                            
                                                                                
         DROP  NEW,STC,R2                                                       
         EJECT                                                                  
***********************************************************************         
* Create status change element for client team change                 *         
***********************************************************************         
         SPACE 1                                                                
AUDTEAM  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDTEAM'                                                      
         LM    R2,R3,0(R1)                                                      
         L     R4,SVSTCELS                                                      
         USING STCELD,R4                                                        
         USING LIDELD,R2                                                        
NEW      USING LIDELD,R3                                                        
         LHI   R1,STCAJOBT                                                      
         CHI   R7,2                Is team from product level                   
         JNE   *+8                 No                                           
         LHI   R1,STCAPROT                                                      
         CHI   R7,1                Is team from client level                    
         JNE   *+8                 No                                           
         LHI   R1,STCACLIT                                                      
         GOTOR BLDSTC                                                           
                                                                                
         LTR   R2,R2                                                            
         JZ    *+12                                                             
         CLI   LIDEL,LIDELQ        Have we an addition                          
         JE    AUDTEA02            No - delete or change                        
         MVI   STCASTAT,STCAADD    Yes - set audit as add                       
         J     AUDTEA04                                                         
                                                                                
AUDTEA02 CLI   NEW.LIDEL,LIDELQ    Has the team been deleted                    
         JNE   AUDTEA03            Yes                                          
         LLC   RF,NEW.LIDLN        Is there a real element with data            
         LTR   RF,RF                                                            
         JZ    AUDTEA03            No                                           
         SHI   RF,LIDLNDQ                                                       
         LTR   RF,RF                                                            
         JZ    AUDTEA03            No                                           
         J     AUDTEA08            Yes - must be a change                       
                                                                                
AUDTEA03 MVI   STCASTAT,STCADEL    Yes - as we don't have a new one             
         LR    R3,R2                                                            
AUDTEA04 LLC   RF,NEW.LIDLN                                                     
         LTR   RF,RF                                                            
         JZ    AUDTEA38                                                         
         SHI   RF,LIDLNDQ                                                       
         LTR   RF,RF                                                            
         JZ    AUDTEA38                                                         
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   STCAROL(0),NEW.LIDDATA                                           
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         LR    RE,RF                                                            
         SRL   RE,2                                                             
         STC   RE,STCANUM                                                       
         AHI   RF,STCLN8Q                                                       
         STC   RF,STCLN                                                         
         OC    STCASTAT,SSTCAPL                                                 
         AR    R4,RF                                                            
         ST    R4,SVSTCELS                                                      
         J     EXITY                                                            
                                                                                
AUDTEA08 LLC   RF,NEW.LIDLN                                                     
         SHI   RF,LIDLNDQ+1                                                     
         LLC   RE,LIDLN                                                         
         SHI   RE,LIDLNDQ+1                                                     
         CR    RF,RE               Is data a different length                   
         JNE   AUDTEA10            Yes                                          
         BASR  RE,0                                                             
         CLC   LIDDATA(0),NEW.LIDDATA  Is the data the same                     
         EX    RF,0(RE)                                                         
         JE    EXITY               Yes - exit                                   
         AHI   RF,1                                                             
         LR    RE,RF                                                            
         J     *+12                                                             
AUDTEA10 AHI   RE,1                RE=Total length of old data                  
         AHI   RF,1                RF=Total length of new data                  
         XC    ELEMENT2,ELEMENT2   For change elements                          
         XC    ELEMENT3,ELEMENT3   For delete elements                          
         XC    ELEMENT4,ELEMENT4   For add elements                             
         LA    R1,ELEMENT2                                                      
         ST    R1,ASAVCHG                                                       
         LA    R1,ELEMENT3                                                      
         ST    R1,ASAVDEL                                                       
         LA    R1,ELEMENT4                                                      
         ST    R1,ASAVADD                                                       
         LA    R2,LIDDATA                                                       
         USING LIDDATA,R2                                                       
         LR    R6,R2                                                            
         LA    R3,NEW.LIDDATA                                                   
NEW      USING LIDDATA,R3                                                       
         STC   RE,BYTE1                                                         
         STC   RF,BYTE2                                                         
AUDTEA12 LTR   RF,RF                   Any new team                             
         JZ    AUDTEA24                No                                       
         LTR   RE,RE                   Any old team                             
         JZ    AUDTEA22                No                                       
         CLC   NEW.LIDBPID,LIDBPID     Do they match                            
         JE    AUDTEA16                Yes                                      
AUDTEA14 LA    R2,LIDTMLNQ(R2)         Look at the next old one                 
         SHI   RE,LIDTMLNQ                                                      
         J     AUDTEA12                                                         
                                                                                
AUDTEA16 CLC   NEW.LIDROLN,LIDROLN                                              
         JE    AUDTEA20                                                         
         L     R4,ASAVCHG                                                       
         MVC   0(LIDTMLNQ,R4),NEW.LIDROLN                                       
         LA    R4,LIDTMLNQ(R4)                                                  
         ST    R4,ASAVCHG                                                       
                                                                                
AUDTEA20 MVI   LIDROLN,X'FF'                                                    
         LA    R3,LIDTMLNQ(R3)                                                  
         SHI   RF,LIDTMLNQ             Subtract data length                     
         LR    R2,R6                   Reset R2 to point to old data            
         LLC   RE,BYTE1                RE=Total length of old data              
         J     AUDTEA12                                                         
                                                                                
AUDTEA22 L     R4,ASAVADD                                                       
         MVC   0(LIDTMLNQ,R4),NEW.LIDROLN                                       
         LA    R4,LIDTMLNQ(R4)                                                  
         ST    R4,ASAVADD                                                       
         LA    R3,LIDTMLNQ(R3)     Move to next data entry in new data          
         SHI   RF,LIDTMLNQ         Subtract length of new data                  
         LR    R2,R6               Reset R2 to point to old data                
         LLC   RE,BYTE1            Reset total length of old data               
         J     AUDTEA12                                                         
                                                                                
AUDTEA24 LTR   RE,RE                   Any old team                             
         JZ    AUDTEA28                No                                       
         CLI   LIDROLN,X'FF'                                                    
         JE    AUDTEA26                                                         
         L     R4,ASAVDEL                                                       
         MVC   0(LIDTMLNQ,R4),LIDROLN                                           
         LA    R4,LIDTMLNQ(R4)                                                  
         ST    R4,ASAVDEL                                                       
                                                                                
AUDTEA26 LA    R2,LIDTMLNQ(R2)                                                  
         SHI   RE,LIDTMLNQ                                                      
         J     AUDTEA12                                                         
                                                                                
AUDTEA28 L     R4,SVSTCELS                                                      
         USING STCELD,R4                                                        
         LA    R2,ELEMENT2         R2=A(Deleted team)                           
         LR    R5,R2                                                            
         LA    R3,3                                                             
AUDTEA30 OC    0(LIDTMLNQ,R2),0(R2)                                             
         JZ    AUDTEA36                                                         
         GOTOR BLDSTC,STCACLIT                                                  
         STC   R3,STCASTAT                                                      
         OC    STCASTAT,SSTCAPL                                                 
         LA    R6,STCAROL                                                       
STC      USING LIDDATA,R6                                                       
         XR    R0,R0                                                            
AUDTEA32 OC    0(LIDLLN7Q,R2),0(R2)                                             
         JZ    AUDTEA34                                                         
         MVC   STC.LIDROLN(LIDTMLNQ),0(R2)                                      
         AHI   R0,1                                                             
         LA    R2,LIDTMLNQ(R2)                                                  
         CHI   R0,59               Have we reached max entries                  
         JE    AUDTEA34            Yes - end element and build next one         
         LA    R6,LIDTMLNQ(R6)                                                  
         J     AUDTEA32                                                         
                                                                                
AUDTEA34 STC   R0,STCANUM                                                       
         MHI   R0,LIDTMLNQ                                                      
         AHI   R0,STCLN8Q                                                       
         STC   R0,STCLN                                                         
         AR    R4,R0                                                            
         J     AUDTEA30                                                         
                                                                                
AUDTEA36 LA    R5,L'ELEMENT2(R5)          Move to next team changes             
         LR    R2,R5                                                            
         JCT   R3,AUDTEA30                                                      
         XR    R3,R3                                                            
AUDTEA38 XC    STCEL(STCLN7Q),STCEL                                             
         ST    R4,SVSTCELS                                                      
         J     EXITY                                                            
         DROP  STC,NEW,R2                                                       
         EJECT                                                                  
***********************************************************************         
* Create status change element for sub jobs deleted                   *         
***********************************************************************         
         SPACE 1                                                                
AUDJBDL  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDJBDL'                                                      
         CHI   R1,2                Are we processing last time call             
         JE    AUDJDL04            Yes - build element from table               
         CLI   BYTE1,0             First time                                   
         JNE   AUDJDL02            No                                           
         LAY   R0,ELEAREA          Yes - initialise storage for job             
         LHI   R1,3*IOLENQ                                       codes          
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE               Clear elearea to store job codes             
         LAY   R3,ELEAREA                                                       
         ST    R3,SVJOBELS         Save address of deleted jobs                 
         MVI   BYTE1,1             Set we have initialised                      
         XC    HALF1,HALF1         Clear count                                  
*                                                                               
AUDJDL02 L     R3,SVJOBELS                                                      
DEL      USING MJBPASD,IOKEY                                                    
         MVC   0(L'MJBPSUBJ,R3),DEL.MJBPSUBJ  Extract sub job deleted           
         LA    R3,L'MJBPSUBJ(R3)                                                
         LH    R1,HALF1                                                         
         AHI   R1,1                                                             
         STH   R1,HALF1                                                         
         ST    R3,SVJOBELS                                                      
         J     EXITY                                                            
         DROP  DEL                                                              
*                                                                               
AUDJDL04 CLI   BYTE1,0             Did we ever initialise                       
         JE    EXITY               No                                           
         LAY   R3,ELEAREA                                                       
         L     R4,SVSTCELS                                                      
         USING STCELD,R4                                                        
AUDJDL06 GOTOR BLDSTC,STCALKJB                                                  
         MVI   STCASTAT,STCADEL                                                 
         OC    STCASTAT,SSTCAPL                                                 
         MVC   HALF2,HALF1         Save number of job entries                   
         LH    R2,HALF1            R2=Number of job entries                     
         LR    R1,R2                                                            
         CHI   R2,19               Have we got max number per element           
         JNH   AUDJDL08            No                                           
         LHI   R1,19               Yes - set max number                         
AUDJDL08 STC   R1,STCANUM                                                       
         SR    R2,R1                                                            
         STH   R2,HALF1            Save count with what is left                 
         MHI   R1,L'ACTKACT        Work out length of data to move              
         SHI   R1,1                                                             
         BASR  RF,0                                                             
         MVC   STCAJOB(0),0(R3)                                                 
         EX    R1,0(RF)                                                         
         AHI   R1,1                                                             
         AR    R3,R1               Move R3 to start of next jobs                
         AHI   R1,STCLN8Q          Work out total element length                
         STC   R1,STCLN                                                         
         AR    R4,R1               Move R4 to next free STCEL                   
         LH    R1,HALF1                                                         
         CHI   R1,0                Have we got any more job entries             
         JH    AUDJDL06            Yes                                          
         ST    R4,SVSTCELS         No - Save address of next free STCEL         
*                                                                               
* Update sub jobs audit to record master job is removed                         
*                                                                               
         LAY   R3,ELEAREA                                                       
         LA    R4,ELEMENT                                                       
         USING STCELD,R4                                                        
         GOTOR BLDSTC,STCAMSTR                                                  
         MVI   STCASTAT,STCADEL                                                 
         OC    STCASTAT,SSTCAPL                                                 
         MVC   STCAULA,OA_ULA                                                   
         MVI   STCLN,STCLN13Q                                                   
K        USING AUDRECD,IOKEY                                                    
AUDJDL10 XC    K.AUDKEY,K.AUDKEY                                                
         MVI   K.AUDKTYP,AUDKTYPQ                                               
         MVI   K.AUDKSUB,AUDKSUBQ                                               
         MVI   K.AUDKAUDT,AUDKACC                                               
         MVC   K.AUDKCPY,CUXCPY                                                 
         MVC   K.AUDKULA(L'PRODUL),PRODUL                                       
         MVC   K.AUDKACT,0(R3)                                                  
         MVC   CSVKEY1,K.AUDKEY                                                 
         XC    AC_KSTA,AC_KSTA                                                  
         L     R2,AIO2                                                          
         L     R1,=AL4(IOHIUP+IODIR+IO2)                                        
         GOTOR (#IOEXEC,AIOEXEC)                                                
         J     AUDJDL14                                                         
*                                                                               
AUDJDL12 L     R1,=AL4(IOSQUP+IODIR+IO2)                                        
         GOTOR (#IOEXEC,AIOEXEC)                                                
*                                                                               
AUDJDL14 CLC   K.AUDKEY(AUDKSEQ-AUDKEY),CSVKEY1                                 
         JNE   AUDJDL16                                                         
         MVC   AC_KSTA,K.AUDKSTA                                                
         L     R1,=AL4(IOGETRUP+IOMST+IO2)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
         USING AUDRECD,R2                                                       
         SR    R0,R0                                                            
         ICM   R0,3,AUDRLEN        Get current record length                    
         LLC   RF,STCLN                                                         
         AR    R0,RF                                                            
         CHI   R0,2000                                                          
         JH    AUDJDL12                                                         
         GOTO1 VHELLO,DMCB,(C'P',ACCMST),AUDRECD,STCELD,=C'ADD=END'             
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO2'                           
         JE    AUDJDL20                                                         
         DC    H'0'                                                             
                                                                                
AUDJDL16 MVC   AUDKEY,CSVKEY1                                                   
         MVC   AUDRSTA,AC_KSTA                                                  
         LA    RF,AUDRFST-AUDRECD                                               
         AHI   RF,STCLN13Q                                                      
         STH   RF,AUDRLEN          Set record length                            
         MVC   AUDRFST(STCLN13Q),STCELD  Add element                            
         MVI   AUDRFST+STCLN13Q,0  Set end of record                            
         GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOMST+IO2'                           
         JE    AUDJDL20                                                         
         DC    H'0'                                                             
                                                                                
AUDJDL20 LA    R3,L'ACTKACT(R3)                                                 
         LH    RF,HALF2            R2=Number of job entries                     
         SHI   RF,1                                                             
         STH   RF,HALF2                                                         
         CHI   RF,0                                                             
         JNE   AUDJDL10                                                         
         J     EXITY                                                            
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* Create status change element for sub jobs added                     *         
***********************************************************************         
         SPACE 1                                                                
AUDJBAD  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDJBAD'                                                      
         CHI   R1,2                Are we processing last time call             
         JE    AUDJAD04            Yes - build element from table               
         CLI   BYTE1,0             First time                                   
         JNE   AUDJAD02            No                                           
         LAY   R0,ELEAREA          Yes - initialise storage for job             
         LHI   R1,3*IOLENQ                                       codes          
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE               Clear elearea to store job codes             
         LAY   R3,ELEAREA                                                       
         ST    R3,SVJOBELS         Save address of added jobs                   
         MVI   BYTE1,1             Set we have initialised                      
         XC    HALF1,HALF1         Clear count                                  
*                                                                               
AUDJAD02 L     R3,SVJOBELS                                                      
ADD      USING MJBPASD,IOKEY                                                    
         MVC   0(L'MJBPSUBJ,R3),ADD.MJBPSUBJ  Extract sub job added             
         LA    R3,L'MJBPSUBJ(R3)                                                
         LH    R1,HALF1                                                         
         AHI   R1,1                                                             
         STH   R1,HALF1                                                         
         ST    R3,SVJOBELS                                                      
         J     EXITY                                                            
         DROP  ADD                                                              
*                                                                               
AUDJAD04 CLI   BYTE1,0             Did we ever initialise                       
         JE    EXITY               No                                           
         LAY   R3,ELEAREA          R4=A(Area containing Jobs added)             
         OC    HALF1,HALF1                                                      
         L     R4,SVSTCELS         R3=A(Status audit elements)                  
         USING STCELD,R4                                                        
AUDJAD06 GOTOR BLDSTC,STCALKJB     Build status change element                  
         MVI   STCASTAT,STCAADD    Adding linked job entries                    
         OC    STCASTAT,SSTCAPL                                                 
         MVC   HALF2,HALF1         Save number of job entries                   
         LH    R2,HALF1            R2=Number of job entries                     
         LR    R1,R2                                                            
         CHI   R2,19               Have we got max number per element           
         JNH   AUDJAD08            No                                           
         LHI   R1,19               Yes - set max number                         
AUDJAD08 STC   R1,STCANUM                                                       
         SR    R2,R1                                                            
         STH   R2,HALF1            Save count with what is left                 
         MHI   R1,L'ACTKACT        Work out length of data to move              
         SHI   R1,1                                                             
         BASR  RF,0                                                             
         MVC   STCAJOB(0),0(R3)                                                 
         EX    R1,0(RF)                                                         
         AHI   R1,1                                                             
         AR    R3,R1               Move R3 to start of next jobs                
         AHI   R1,STCLN8Q          Work out total element length                
         STC   R1,STCLN                                                         
         AR    R4,R1               Move R4 to next free STCEL                   
         LH    R1,HALF1                                                         
         CHI   R1,0                Have we got any more job entries             
         JH    AUDJAD06            Yes                                          
         ST    R4,SVSTCELS         No - Save address of next free STCEL         
*                                                                               
* Update sub jobs audit to record master job is added                           
*                                                                               
         LAY   R3,ELEAREA                                                       
         LA    R4,ELEMENT                                                       
         USING STCELD,R4                                                        
         GOTOR BLDSTC,STCAMSTR                                                  
         MVI   STCASTAT,STCAADD                                                 
         OC    STCASTAT,SSTCAPL                                                 
         MVC   STCAULA,OA_ULA                                                   
         MVI   STCLN,STCLN13Q                                                   
K        USING AUDRECD,IOKEY                                                    
AUDJAD10 XC    K.AUDKEY,K.AUDKEY                                                
         MVI   K.AUDKTYP,AUDKTYPQ                                               
         MVI   K.AUDKSUB,AUDKSUBQ                                               
         MVI   K.AUDKAUDT,AUDKACC                                               
         MVC   K.AUDKCPY,CUXCPY                                                 
         MVC   K.AUDKULA(L'PRODUL),PRODUL                                       
         MVC   K.AUDKACT,0(R3)                                                  
         MVC   CSVKEY1,K.AUDKEY                                                 
         XC    AC_KSTA,AC_KSTA                                                  
         L     R2,AIO2                                                          
         L     R1,=AL4(IOHIUP+IODIR+IO2)                                        
         GOTOR (#IOEXEC,AIOEXEC)                                                
         J     AUDJAD14                                                         
*                                                                               
AUDJAD12 L     R1,=AL4(IOSQUP+IODIR+IO2)                                        
         GOTOR (#IOEXEC,AIOEXEC)                                                
*                                                                               
AUDJAD14 CLC   K.AUDKEY(AUDKSEQ-AUDKEY),CSVKEY1                                 
         JNE   AUDJAD16                                                         
         MVC   AC_KSTA,K.AUDKSTA                                                
         L     R1,=AL4(IOGETRUP+IOMST+IO2)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
         USING AUDRECD,R2                                                       
         SR    R0,R0                                                            
         ICM   R0,3,AUDRLEN        Get current record length                    
         LLC   RF,STCLN                                                         
         AR    R0,RF                                                            
         CHI   R0,2000                                                          
         JH    AUDJAD12                                                         
         GOTO1 VHELLO,DMCB,(C'P',ACCMST),AUDRECD,STCELD,=C'ADD=END'             
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO2'                           
         JE    AUDJAD20                                                         
         DC    H'0'                                                             
                                                                                
AUDJAD16 MVC   AUDKEY,CSVKEY1                                                   
         MVC   AUDRSTA,AC_KSTA                                                  
         LA    RF,AUDRFST-AUDRECD                                               
         AHI   RF,STCLN13Q                                                      
         STH   RF,AUDRLEN          Set record length                            
         MVC   AUDRFST(STCLN13Q),STCELD  Add element                            
         MVI   AUDRFST+STCLN13Q,0  Set end of record                            
         GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOMST+IO2'                           
         JE    AUDJAD20                                                         
         DC    H'0'                                                             
                                                                                
AUDJAD20 LA    R3,L'ACTKACT(R3)                                                 
         LH    RF,HALF2            R2=Number of job entries                     
         SHI   RF,1                                                             
         STH   RF,HALF2                                                         
         CHI   RF,0                                                             
         JNE   AUDJAD10                                                         
         J     EXITY                                                            
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* Update record activity pointers for account record                  *         
* ENTRY: R1 POINTS TO SOURCE A/C REC                                            
***********************************************************************         
                                                                                
UPDRAP   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*UPDRAP*'                                                      
                                                                                
         TM    CPYSTAT6,CPYSRAPP                                                
         JZ    EXITY                                                            
         USING ACTRECD,R2                                                       
         L     R2,0(R1)                                                         
         MVC   AC_DA,IODA                                                       
         USING RAPRECD,R3                                                       
         LA    R3,IOKEY                                                         
         XC    RAPKEY,RAPKEY                                                    
         MVI   RAPKTYP,RAPKTYPQ                                                 
         MVC   RAPKCPY,CUXCPY                                                   
         MVI   RAPKRTYP,RAPKRJOB                                                
         CLC   ACTKULA(2),ONECUL                                                
         JNE   *+8                                                              
         MVI   RAPKRTYP,RAPKRPAL                                                
         MVC   RAPKACPY,CUXCPY                                                  
         MVC   RAPKAUNT(L'ACTKULA),ACTKULA                                      
*        MVC   RAPKAACT,OA_ACT                                                  
         MVC   CSVKEY1,RAPKEY                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO4'                               
                                                                                
URAP002  CLC   RAPKEY(L'RAPKTYP+L'RAPKCPY),CSVKEY1                              
         JNE   URAP008                                                          
         CLC   RAPKRTYP,CSVKEY1+(RAPKRTYP-RAPRECD)                              
         JNE   URAP004                                                          
         CLC   RAPKKEY,CSVKEY1+(RAPKKEY-RAPRECD)                                
         JE    URAP006                                                          
                                                                                
URAP004  GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO4'                               
         J     URAP002                                                          
                                                                                
URAP006  CLC   AC_TODYC,RAPKDATE   Speedy updates may have same                 
         JNE   URAP004             date/time counter for this                   
         CLC   AC_TIME,RAPKTIME                                                 
         JNE   URAP004                                                          
         MVC   RAPKSTA,ACTRSTA                                                  
         MVC   RAPKDA,AC_DA                                                     
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR+IO4'                            
         JE    EXITY                                                            
         DC    H'0'                                                             
*                                                                               
URAP007  OI    RAPKSTA,ACTSDELT    Delete old activity pointer                  
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR+IO4'                            
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
URAP008  MVC   RAPKEY,CSVKEY1                                                   
         MVC   RAPKDATE,AC_TODYC                                                
         MVC   RAPKTIME,AC_TIME                                                 
         MVC   RAPKSTA,ACTRSTA                                                  
         MVC   RAPKDA,AC_DA                                                     
         GOTOR (#IOEXEC,AIOEXEC),'IOADD+IODIR+IO4'                              
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  R2,R3                                                            
         EJECT                                                                  
***********************************************************************         
* Update account extension records                                    *         
* ENTRY - new record in AIO4                                          *         
***********************************************************************         
                                                                                
UPDAEX   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*UPDAEX*'                                                      
*                                                                               
         USING AEXRECD,R3                                                       
         L     R3,AIO4                                                          
         CLI   AEXKTYP,AEXKTYPQ                                                 
         JNE   EXITY               NOT AN AEXREC                                
         CLI   AEXKSUB,AEXKSUBQ                                                 
         JNE   EXITY                                                            
*                                                                               
         USING ACTRECD,R2                                                       
         L     R2,AIO3                                                          
         LA    R3,IOKEY                                                         
         XC    AEXKEY,AEXKEY                                                    
         MVI   AEXKTYP,AEXKTYPQ                                                 
         MVI   AEXKSUB,AEXKSUBQ                                                 
         MVC   AEXKCPY,CUXCPY                                                   
         MVC   AEXKULA,OA_ULA                                                   
         MVC   CSVKEY1,AEXKEY                                                   
         L     R1,=AL4(IORDUPD+IODIR+IO4)                                       
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    UAEX002                                                          
         CLI   IOERR,IOEDEL                                                     
         JE    UAEX002                                                          
         L     R3,AIO4                                                          
         MVC   AEXKEY,CSVKEY1                                                   
         MVC   AEXRSTA,ACTRSTA                                                  
         LHI   R0,AEXRFST-AEXRECD                                               
         CLM   R0,3,AEXRLEN        Test record is empty                         
         JNL   EXITY               Yes - don't add                              
         GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOMST+IO4'                           
         JE    *+6                                                              
         DC    H'0'                                                             
         TM    AC_IND2,AC_IRMOL    Are we to remove old account code            
         JZ    EXITY               No                                           
         LA    R3,IOKEY            Yes - remove old account extension           
         XC    AEXKEY,AEXKEY                                                    
         MVI   AEXKTYP,AEXKTYPQ                                                 
         MVI   AEXKSUB,AEXKSUBQ                                                 
         MVC   AEXKCPY,CUXCPY                                                   
         MVC   AEXKULA,QA_ULA                                                   
         L     R1,=AL4(IORDUP+IODIR+IO4)                                        
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JNE   EXITY                                                            
                                                                                
UAEX002  MVC   CSVKEY2,IOKEY       copy new record to IO7                       
         L     R0,AIO7                                                          
         LA    R1,IOLENQ                                                        
         L     RE,AIO4                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         L     R1,=AL4(IOGETRUP+IOMST+IO4)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R3,AIO4                                                          
         TM    AC_IND2,AC_IRMOL    Are we to remove old account code            
         JNZ   UAEX004             Yes                                          
         L     R0,AIO4             copy new record back to IO7                  
         LA    R1,2000                                                          
         L     RE,AIO7                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
         MVC   AEXRSTA,ACTRSTA                                                  
         LHI   R0,AEXRFST-AEXRECD                                               
         CLM   R0,3,AEXRLEN        Test record is empty                         
         JL    UAEX006                                                          
         CLI   IOERR,IOEDEL                                                     
         JE    EXITY                                                            
UAEX004  OI    AEXRSTAT,AEXSDELT   Yes - delete it                              
UAEX006  GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO4'                           
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   IOKEY,CSVKEY2                                                    
         LA    RE,IOKEY                                                         
         MVC   AEXKSTA-AEXRECD(L'AEXKSTA,RE),AEXRSTA                            
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR+IO4' UPDATE DIR STATUS          
         J     EXITY                                                            
         DROP  R2,R3                                                            
         EJECT                                                                  
***********************************************************************         
* Update estimate records                                             *         
***********************************************************************         
                                                                                
UPDEST   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*UPDEST*'                                                      
                                                                                
         CLC   PRODUL,QA_ULA       Check it's production                        
         JNE   EXITY               Otherwise exit                               
         TM    AC_IND1,AC_INEW3+AC_ILVL3  Must be job level                     
         JZ    EXITY               Otherwise exit                               
         CLI   QA_ASTAT,QA_ADELT   Are we deleting a job                        
         JE    *+12                Yes - delete estimates                       
         TM    AC_IND2,AC_IRMOL    Are we to remove old account code            
         JZ    EXITY               No                                           
                                                                                
         USING ESTRECD,R3                                                       
         LA    R3,IOKEY                                                         
         XC    ESTKEY,ESTKEY                                                    
         MVI   ESTKTYP,ESTKTYPQ                                                 
         MVI   ESTKSUB,ESTKSUBQ                                                 
         MVC   ESTKCPY,CUXCPY                                                   
         LLC   RF,LDGAL1                                                        
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         MVC   ESTKCLI(0),QA_ACT                                                
         EX    RF,0(R1)                                                         
         LA    R2,QA_ACT                                                        
         AHI   RF,1                                                             
         AR    R2,RF               R2=A(Product)                                
         LLC   RE,LDGAL2                                                        
         SR    RE,RF                                                            
         SHI   RE,1                                                             
         BASR  R1,0                                                             
         MVC   ESTKPRO(0),0(R2)                                                 
         EX    RE,0(R1)                                                         
         AHI   RE,1                                                             
         AR    R2,RE               R2=A(Job)                                    
         AR    RE,RF                                                            
         LLC   RF,LDGAL3                                                        
         SR    RF,RE                                                            
         CHI   RF,6                Max length allowed for job                   
         JNH   *+8                                                              
         LHI   RF,6                                                             
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         MVC   ESTKJOB(0),0(R2)                                                 
         EX    RF,0(R1)                                                         
         OC    ESTKCLI,SPACES                                                   
         OC    ESTKPRO,SPACES                                                   
         OC    ESTKJOB,SPACES                                                   
         MVC   CSVKEY1,ESTKEY                                                   
         L     R1,=AL4(IOHIUPD+IODIR+IO4)                                       
         GOTOR (#IOEXEC,AIOEXEC)                                                
         J     UEST004                                                          
UEST002  LA    R3,IOKEY                                                         
         L     R1,=AL4(IOSQUPD+IODIR+IO4)                                       
         GOTOR (#IOEXEC,AIOEXEC)                                                
UEST004  CLI   IOERR,0                                                          
         JE    UEST006                                                          
         CLI   IOERR,IOEDEL                                                     
         JE    UEST002                                                          
         DC    H'0'                                                             
UEST006  CLC   ESTKEY(ESTKLNO-ESTRECD),CSVKEY1                                  
         JNE   UEST010                                                          
         MVC   CSVKEY1,IOKEY                                                    
         L     R1,=AL4(IOGETRUP+IOMST+IO4)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JNE   *+2                                                              
*                                                                               
         TM    AC_IND2,AC_IRMOL    Are we to estimate to new code               
         JZ    UEST008             No                                           
         L     R0,AIO7             Yes - copy estimate record to IO7            
         LA    R1,2000                                                          
         L     RE,AIO4                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
UEST008  DS    0H                  Do passives first (as for PIDKESTQ)          
         GOTOR UPDPASS,DMCB,(C'D',AIO4),AC_OFF                                  
                                                                                
         LA    R3,IOKEY            Reread current ESTRECD key for               
         MVC   ESTKEY,CSVKEY1      GETREC/PUTREC now                            
         L     R1,=AL4(IORDD+IODIR+IO4)                                         
         GOTOR (#IOEXEC,AIOEXEC)                                                
         CLI   IOERR,0                                                          
         JE    UEST009                                                          
         CLI   IOERR,IOEDEL                                                     
         JNE   *+2                                                              
                                                                                
UEST009  L     R1,=AL4(IOGETRUP+IOMST+IO4)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JNE   *+2                                                              
                                                                                
         L     R3,AIO4             Yes - delete it                              
         OI    ESTRSTA1,ESTKDELT                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO4'                           
         JNE   *+2                                                              
                                                                                
         CLI   QA_ASTAT,QA_ADELT   Are we deleting a job                        
***      JE    UEST010             Yes - delete estimate audit too              
         JE    UEST002             Yes - delete estimate audit too              
         TM    AC_IND2,AC_IRMOL    Are we to remove old account code            
         JZ    UEST002             No                                           
                                                                                
         L     R0,AIO4             Yes - add estimate with new code             
         LA    R1,2000                                                          
         L     RE,AIO7                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
         L     R3,AIO4             Change client product job                    
         XC    ESTKCLI,ESTKCLI                                                  
         XC    ESTKPRO,ESTKPRO                                                  
         XC    ESTKJOB,ESTKJOB                                                  
         LLC   RF,LDGAL1                                                        
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         MVC   ESTKCLI(0),OA_ACT                                                
         EX    RF,0(R1)                                                         
         LA    R2,OA_ACT                                                        
         AHI   RF,1                                                             
         AR    R2,RF               R2=A(Product)                                
         LLC   RE,LDGAL2                                                        
         SR    RE,RF                                                            
         SHI   RE,1                                                             
         BASR  R1,0                                                             
         MVC   ESTKPRO(0),0(R2)                                                 
         EX    RE,0(R1)                                                         
         AHI   RE,1                                                             
         AR    R2,RE               R2=A(Job)                                    
         AR    RE,RF                                                            
         LLC   RF,LDGAL3                                                        
         SR    RF,RE                                                            
         CHI   RF,6                Max length allowed for job                   
         JNH   *+8                                                              
         LHI   RF,6                                                             
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         MVC   ESTKJOB(0),0(R2)                                                 
         EX    RF,0(R1)                                                         
         OC    ESTKCLI,SPACES                                                   
         OC    ESTKPRO,SPACES                                                   
         OC    ESTKJOB,SPACES                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOMST+IO4'                           
         JNE   *+2                                                              
         GOTOR UPDPASS,DMCB,(C'A',AIO4),AC_OFF                                  
         MVC   IOKEY,CSVKEY1                                                    
         L     R1,=AL4(IOHID+IODIR+IO4) UPDATE DIR STATUS                       
         GOTOR (#IOEXEC,AIOEXEC)                                                
         J     UEST002                                                          
*                               ** Read est audit records for del **            
UEST010  CLI   QA_ASTAT,QA_ADELT   Are we deleting a job                        
         JE    UEST011             Yes - delete estimate audit too              
         TM    AC_IND2,AC_IRMOL    Are we to remove old account code            
         JZ    EXITY               No                                           
*                                                                               
         USING AUDRECD,R3                                                       
UEST011  LA    R3,IOKEY                                                         
         XC    IOKEY,IOKEY                                                      
         MVI   AUDKTYP,AUDKTYPQ                                                 
         MVI   AUDKSUB,AUDKSUBQ                                                 
         MVC   AUDKCPY,CUXCPY                                                   
         MVI   AUDKAUDT,AUDKEST                                                 
         MVC   AUDKECPJ,QA_ACT                                                  
         MVC   CSVKEY1,AUDKEY                                                   
         L     R1,=AL4(IOHIUPD+IODIR+IO4)                                       
         GOTOR (#IOEXEC,AIOEXEC)                                                
         J     UEST014                                                          
*                                                                               
UEST012  LA    R3,IOKEY                                                         
         L     R1,=AL4(IOSQUPD+IODIR+IO4)                                       
         GOTOR (#IOEXEC,AIOEXEC)                                                
*                                                                               
UEST014  CLI   IOERR,0                                                          
         JE    UEST016                                                          
         CLI   IOERR,IOEDEL                                                     
         JE    UEST012                                                          
         DC    H'0'                                                             
*                                                                               
UEST016  CLC   AUDKEY(AUDKELNO-AUDRECD),CSVKEY1                                 
         JNE   EXITY                                                            
         MVC   CSVKEY1,IOKEY                                                    
         L     R1,=AL4(IOGETRUP+IOMST+IO4)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JNE   *+2                                                              
         L     R3,AIO4                                                          
         OI    AUDRSTAT,ESTKDELT   Yes - delete it                              
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO4'                           
         JNE   *+2                                                              
         LA    R3,IOKEY                                                         
         OI    AUDKSTAT,ESTKDELT                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR+IO4'                            
         JNE   *+2                                                              
*                                                                               
         L     R4,ABLOCK                                                        
         USING CPTRBLK,R4                                                       
         XC    CPTRBLK(CPTRBLKL),CPTRBLK                                        
         MVC   CPYSTA6,CPYSTAT6                                                 
         MVC   CPYSTA7,CPYSTAT7                                                 
         MVC   CPYSTA9,CPYSTAT9                                                 
         MVC   CPYSTAC,CPYSTATC                                                 
         MVC   LDGSTA2,LEDGSTA2                                                 
         MVC   ACCOFFC,AC_OFF                                                   
         MVC   LDGLVALN(L'LDGLVALN*4),LDGAL1                                    
         GOTO1 VPADDLE,DMCB,(C'D',AIO4),CPTRBLK,0,0,ACOMFACS                    
*                                                                               
         LA    R3,IOKEY                                                         
         MVC   AUDKEY,CSVKEY1      reread last AUDRECD key                      
         L     R1,=AL4(IORDD+IODIR+IO4)                                         
         GOTOR (#IOEXEC,AIOEXEC)                                                
         J     UEST012                                                          
         DROP  R3,R4                                                            
         EJECT                                                                  
***********************************************************************         
* Update production option records                                    *         
***********************************************************************         
                                                                                
UPDPOP   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*UPDPOP*'                                                      
                                                                                
         CLC   PRODUL,QA_ULA       Check it's production                        
         JNE   EXITY               Otherwise exit                               
         CLI   QA_ASTAT,QA_ADELT   Are we deleting a job                        
         JE    *+12                Yes - delete prod option recs                
         TM    AC_IND2,AC_IRMOL    Are we to remove old account code            
         JZ    EXITY               No                                           
                                                                                
         USING POPRECD,R3                                                       
         LA    R3,IOKEY                                                         
         XC    POPKEY,POPKEY                                                    
         MVI   POPKTYP,POPKTYPQ                                                 
         MVI   POPKSUB,POPKSUBQ                                                 
         MVC   POPKCPY,CUXCPY                                                   
         LLC   RF,LDGAL1                                                        
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         MVC   POPKCLI(0),QA_ACT                                                
         EX    RF,0(R1)                                                         
         LA    R2,QA_ACT                                                        
         AHI   RF,1                                                             
         AR    R2,RF               R2=A(Product)                                
         LLC   RE,LDGAL2                                                        
         SR    RE,RF                                                            
         SHI   RE,1                                                             
         BASR  R1,0                                                             
         MVC   POPKPRO(0),0(R2)                                                 
         EX    RE,0(R1)                                                         
         AHI   RE,1                                                             
         AR    R2,RE               R2=A(Job)                                    
         AR    RE,RF                                                            
         LLC   RF,LDGAL3                                                        
         SR    RF,RE                                                            
         CHI   RF,6                Max length allowed for job                   
         JNH   *+8                                                              
         LHI   RF,6                                                             
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         MVC   POPKJOB(0),0(R2)                                                 
         EX    RF,0(R1)                                                         
         OC    POPKCLI,SPACES                                                   
         OC    POPKPRO,SPACES                                                   
         OC    POPKJOB,SPACES                                                   
         MVC   CSVKEY1,POPKEY                                                   
         L     R1,=AL4(IOHIUPD+IODIR+IO4)                                       
         GOTOR (#IOEXEC,AIOEXEC)                                                
         J     UPOP004                                                          
UPOP002  LA    R3,IOKEY                                                         
         L     R1,=AL4(IOSQUPD+IODIR+IO4)                                       
         GOTOR (#IOEXEC,AIOEXEC)                                                
UPOP004  CLI   IOERR,0                                                          
         JE    UPOP006                                                          
         CLI   IOERR,IOEDEL                                                     
         JE    UPOP002                                                          
         DC    H'0'                                                             
UPOP006  CLC   POPKEY(POPKMGR-POPRECD),CSVKEY1                                  
         JNE   EXITY                                                            
         MVC   CSVKEY1,IOKEY                                                    
         L     R1,=AL4(IOGETRUP+IOMST+IO4)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         TM    AC_IND2,AC_IRMOL    Are we moving option rec to new code         
         JZ    UPOP008             No                                           
                                                                                
         L     R0,AIO7             Yes - copy option record to IO7              
         LA    R1,2000                                                          
         L     RE,AIO4                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
UPOP008  OI    POPRSSTA,ACTSDELT   Yes - delete it                              
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO4'                           
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   IOKEY,CSVKEY1                                                    
         LA    RE,IOKEY                                                         
         OI    POPKSSTA-POPRECD(RE),ACTSDELT                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR+IO4' UPDATE DIR STATUS          
         TM    AC_IND2,AC_IRMOL    Are we to remove old account code            
         JZ    UPOP002             No                                           
                                                                                
         L     R0,AIO4             Yes - add option rec with new code           
         LA    R1,2000                                                          
         L     RE,AIO7                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
         L     R3,AIO4             Change client product job                    
         XC    POPKCLI,POPKCLI                                                  
         XC    POPKPRO,POPKPRO                                                  
         XC    POPKJOB,POPKJOB                                                  
         LLC   RF,LDGAL1                                                        
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         MVC   POPKCLI(0),OA_ACT                                                
         EX    RF,0(R1)                                                         
         LA    R2,OA_ACT                                                        
         AHI   RF,1                                                             
         AR    R2,RF               R2=A(Product)                                
         LLC   RE,LDGAL2                                                        
         SR    RE,RF                                                            
         SHI   RE,1                                                             
         BASR  R1,0                                                             
         MVC   POPKPRO(0),0(R2)                                                 
         EX    RE,0(R1)                                                         
         AHI   RE,1                                                             
         AR    R2,RE               R2=A(Job)                                    
         AR    RE,RF                                                            
         LLC   RF,LDGAL3                                                        
         SR    RF,RE                                                            
         CHI   RF,6                Max length allowed for job                   
         JNH   *+8                                                              
         LHI   RF,6                                                             
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         MVC   POPKJOB(0),0(R2)                                                 
         EX    RF,0(R1)                                                         
         OC    POPKCLI,SPACES                                                   
         OC    POPKPRO,SPACES                                                   
         OC    POPKJOB,SPACES                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOMST+IO4'                           
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   IOKEY,CSVKEY1                                                    
         L     R1,=AL4(IOHID+IODIR+IO4) UPDATE DIR STATUS                       
         GOTOR (#IOEXEC,AIOEXEC)                                                
         J     UPOP002                                                          
         DROP  R3                                                               
         EJECT                                                                  
***********************************************************************         
* Update or add new audit record for account record                   *         
* entry - STCELS in GENAEXTN                                          *         
***********************************************************************         
                                                                                
UPDAUD   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*UPDAUD*'                                                      
         XR    RE,RE                                                            
         LAY   R4,GENAEXTN                                                      
NEW      USING STCELD,R4                                                        
         XC    IOKEY,IOKEY                                                      
         XC    BYTE1,BYTE1                                                      
         LA    R2,IOKEY                                                         
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO3                                        
         USING AUDRECD,R2                                                       
         MVI   AUDKTYP,AUDKTYPQ                                                 
         MVI   AUDKSUB,AUDKSUBQ                                                 
         MVC   AUDKCPY,CUXCPY                                                   
         MVI   AUDKAUDT,AUDKACC                                                 
         MVC   AUDKULA,QA_ULA                                                   
         CLI   QA_ASTAT,QA_ANEW    If new or auto need output job code          
         JE    *+12                                                             
         CLI   QA_ASTAT,QA_AAUTO                                                
         JNE   *+10                                                             
         MVC   AUDKULA,OA_ULA                                                   
         MVI   AUDKSEQ,0                                                        
         MVC   CSVKEY1,AUDKEY                                                   
         L     R1,=AL4(IORDUP+IODIR+IO2)                                        
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JNE   UPAUD56                                                          
                                                                                
UPAUD10  MVC   BYTE1,AUDKSEQ                                                    
                                                                                
UPAUD20  MVC   CSVKEY2,AUDKEY                                                   
         L     R1,=AL4(IOGETRUP+IOMST+IO2)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    UPAUD22                                                          
         DC    H'0'                                                             
                                                                                
UPAUD22  L     R2,AIO2                                                          
         MVC   AUDRINDX,OA_INDEX                                                
         TM    AC_IND2,AC_IRMOL    Replacing old account code                   
         JZ    UPAUD24             No                                           
         MVC   AUDKULA,OA_ULA      Yes - change account code                    
*                                                                               
UPAUD24  MVC   AUDRSTAT,OA_ACSTA                                                
UPAUD26  CLI   NEW.STCEL,STCELQ                                                 
         JE    UPAUD28                                                          
         CLI   NEW.STCEL,0                                                      
         JE    UPAUD40                                                          
UPAUD28  SR    RE,RE                                                            
         SR    RF,RF                                                            
         ICM   RE,3,AUDRLEN                                                     
         IC    RF,NEW.STCLN                                                     
         ST    R4,SVSTCELS                                                      
UPAUD28A CLI   NEW.STCATYP,STCADESC                                             
         JNE   UPAUD29                                                          
UPAUD28B LLC   R1,NEW.STCLN                                                     
         AR    R4,R1                                                            
         CLI   NEW.STCEL,STCELQ                                                 
         JNE   UPAUD29                                                          
         CLI   NEW.STCATYP,STCADESC                                             
         JNE   UPAUD29                                                          
         AR    RF,R1                                                            
         J     UPAUD28B                                                         
                                                                                
UPAUD29  L     R4,SVSTCELS                                                      
         AR    RE,RF                                                            
         CH    RE,=H'2000'                                                      
         JH    UPAUD40                                                          
         GOTO1 VHELLO,DMCB,(C'P',ACCMST),AUDRECD,NEW.STCELD,=C'ADD=END'         
         CLI   12(R1),0                                                         
         JE    UPAUD30                                                          
         CLI   12(R1),5                                                         
         JE    UPAUD40                                                          
         DC    H'0'                                                             
UPAUD30  SR    RE,RE                                                            
         IC    RE,NEW.STCLN                                                     
         AR    R4,RE                                                            
         J     UPAUD26                                                          
*                                                                               
UPAUD40  TM    AC_IND2,AC_IRMOL    Remove old account code                      
         JZ    UPAUD41                                                          
         MVC   CSVKEY3,IOKEY       STORE EXISTING KEY                           
         L     RE,AIO2                                                          
         MVC   IOKEY,0(RE)         BUILD NEW KEY                                
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO7   CLEAR OUT AIO7                       
         L     R1,=AL4(IORDUPD+IODIR+IO7)                                       
         GOTOR (#IOEXEC,AIOEXEC)   CHECK IF AUDIT REC EXISTS                    
         JNE   UPAUD40A            NOT EXIST?                                   
*        MVC   IOKEY,CSVKEY3                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO2'                           
         JNE   *+2                                                              
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR+IO2'                            
         JE    UPAUD44                                                          
         J     *+2                                                              
*PAUD40A MVC   IOKEY,CSVKEY3       RESTORE EXISITNG KEY                         
UPAUD40A GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOMST+IO2'                           
         JE    UPAUD44                                                          
         DC    H'0'                                                             
UPAUD41  GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO2'                           
         JE    UPAUD42                                                          
         DC    H'0'                                                             
UPAUD42  LA    R2,IOKEY                                                         
         MVC   AUDKSTAT,OA_ACSTA                                                
         MVC   AUDKINDX,OA_INDEX                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR+IO2'                            
         JE    UPAUD44                                                          
         DC    H'0'                                                             
UPAUD44  MVC   IOKEY,CSVKEY2                                                    
         L     R1,=AL4(IORDUPD+IODIR+IO2)                                       
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    UPAUD46                                                          
         DC    H'0'                                                             
UPAUD46  L     R1,=AL4(IOSQUP+IODIR+IO2)                                        
         GOTOR (#IOEXEC,AIOEXEC)                                                
         CLC   CSVKEY1(AUDKSEQ-AUDKEY),AUDKEY DO ANY RECORDS EXIST              
         JE    UPAUD10             YES                                          
UPAUD54  SR    RE,RE               NO - BUILD NEW RECORD                        
         IC    RE,BYTE1                                                         
         AHI   RE,1                                                             
         STC   RE,BYTE1                                                         
UPAUD56  CLI   NEW.STCEL,0                                                      
         JE    UPDAUDY                                                          
         L     R2,AIO2                                                          
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO2                                        
         XC    AUDKEY,AUDKEY                                                    
         MVI   AUDKTYP,AUDKTYPQ                                                 
         MVI   AUDKSUB,AUDKSUBQ                                                 
         MVC   AUDKCPY,CUXCPY                                                   
         MVI   AUDKAUDT,AUDKACC                                                 
         MVC   AUDKULA,OA_ULA                                                   
         MVC   AUDKSEQ,BYTE1                                                    
         MVC   AUDRLEN,=Y(RAURFST-RAUKEY)                                       
         XC    AUDRSTA,AUDRSTA                                                  
         MVC   AUDRSTAT,OA_ACSTA                                                
         MVC   AUDRINDX,OA_INDEX                                                
UPAUD58  CLI   NEW.STCEL,0                                                      
         JE    UPAUD62                                                          
         SR    RE,RE                                                            
         ICM   RE,3,AUDRLEN                                                     
         SR    RF,RF                                                            
         IC    RF,NEW.STCLN                                                     
         ST    R4,SVSTCELS                                                      
         CLI   NEW.STCATYP,STCADESC                                             
         JNE   UPAUD59                                                          
UPAUD58B LLC   R1,NEW.STCLN                                                     
         AR    R4,R1                                                            
         CLI   NEW.STCEL,STCELQ                                                 
         JNE   UPAUD59                                                          
         CLI   NEW.STCATYP,STCADESC                                             
         JNE   UPAUD59                                                          
         AR    RF,R1                                                            
         J     UPAUD58B                                                         
                                                                                
UPAUD59  L     R4,SVSTCELS                                                      
         AR    RE,RF                                                            
         CH    RE,=H'2000'                                                      
         JH    UPAUD62                                                          
         GOTO1 VHELLO,DMCB,(C'P',ACCMST),AUDRECD,NEW.STCELD,=C'ADD=END'         
         CLI   12(R1),0                                                         
         JE    UPAUD60                                                          
         CLI   12(R1),5                                                         
         JE    UPAUD62                                                          
         DC    H'0'                                                             
*                                                                               
UPAUD60  SR    RE,RE                                                            
         IC    RE,NEW.STCLN                                                     
         AR    R4,RE                                                            
         J     UPAUD58                                                          
*                                                                               
UPAUD62  MVC   IOKEY,AUDKEY                                                     
         L     R1,=AL4(IORDUPD+IODIR+IO2)                                       
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    UPAUD64                                                          
         CLI   IOERR,IOEDEL                                                     
         JE    UPAUD64                                                          
         GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOMST+IO2'                           
         JE    UPAUD54                                                          
         DC    H'0'                                                             
*                                                                               
UPAUD64  DS    0H                  update existing records                      
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO7                                        
         L     R0,AIO7             copy new record to IO7                       
         LA    R1,IOLENQ                                                        
         L     RE,AIO2                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         L     R1,=AL4(IOGETRUP+IOMST+IO2)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    UPAUD66                                                          
         DC    H'0'                                                             
*                                                                               
UPAUD66  L     R0,AIO2             copy new record to IO2                       
         LA    R1,2000                                                          
         L     RE,AIO7                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO2'                           
         JE    UPAUD68                                                          
         DC    H'0'                                                             
UPAUD68  LA    RE,IOKEY            pass new status                              
         MVC   AUDKSTA-AUDRECD(8,RE),AUDRSTA                                    
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR+IO2'                            
         JE    UPAUD54                                                          
         DC    H'0'                                                             
         DROP  NEW,R2                                                           
*                                                                               
UPDAUDY  J     EXITY                                                            
                                                                                
UPDAUDN  J     EXITN                                                            
         EJECT                                                                  
***********************************************************************         
* Validation module: account code                                     *         
* - Sets CC                                                           *         
***********************************************************************         
         DS    0H                                                               
VALACT   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    CL8'*VALACT*'                                                    
                                                                                
         MVC   AC_ACTL2,SPACES                                                  
         MVC   AC_ACTL3,SPACES                                                  
         MVC   ANYACCNT,QA_UNIT                                                 
         OC    ANYACCNT,SPACES                                                  
         XC    ADRELEMT,ADRELEMT                                                
         CLC   ANYACCD,SPACES                                                   
         JNH   EXITY                                                            
*                                  Determine length of account code             
         LLC   RF,LDGAL1                                                        
         LA    RE,ANYACCD                                                       
         AR    RF,RE                                                            
         CLI   LDGAL1,L'ACTKACT    Is it level 1?                               
         JE    *+12                                                             
         CLI   0(RF),C' '                                                       
         JH    VALAC0A                                                          
         MVI   AC_ACLVL,AC_LVL1                                                 
         J     VALAC0D                                                          
*                                                                               
VALAC0A  LLC   RF,LDGAL2                                                        
         AR    RF,RE                                                            
         CLI   LDGAL2,L'ACTKACT    Is it level 2?                               
         JE    *+12                                                             
         CLI   0(RF),C' '                                                       
         JH    VALAC0B                                                          
         MVI   AC_ACLVL,AC_LVL2                                                 
         J     VALAC0D                                                          
*                                                                               
VALAC0B  LLC   RF,LDGAL3                                                        
         AR    RF,RE                                                            
         CLI   LDGAL3,L'ACTKACT    Is it level 3?                               
         JE    *+12                                                             
         CLI   0(RF),C' '                                                       
         JH    VALAC0C                                                          
         MVI   AC_ACLVL,AC_LVL3                                                 
         J     VALAC0D                                                          
*                                                                               
VALAC0C  LLC   RF,LDGAL4                                                        
         AR    RF,RE                                                            
         CLI   LDGAL4,L'ACTKACT    Is it level 4?                               
         JE    *+6                                                              
         DC    H'0'                                                             
         MVI   AC_ACLVL,AC_LVL4                                                 
*  test hierarchy 1                                                             
         USING ACTRECD,R2                                                       
VALAC0D  DS    0H                                                               
         GOTOR VRDACT,DMCB,(1,ANYACCNT),AC_ACTL1                                
         JL    EXITN                                                            
         JH    VALAC90                                                          
*                                                                               
         L     R2,AIO3                                                          
         LA    R2,ACTRFST                                                       
         USING PPRELD,R2                                                        
         XR    R0,R0                                                            
VALAC04  CLI   PPREL,0                                                          
         JE    VALAC14                                                          
         CLI   PPREL,RSTELQ                                                     
         JE    VALAC10                                                          
         CLI   PPREL,ADRELQ                                                     
         JE    VALAC09                                                          
         CLI   PPREL,PPRELQ                                                     
         JE    VALAC08                                                          
                                                                                
VALAC06  IC    R0,PPRLN                                                         
         AR    R2,R0                                                            
         J     VALAC04                                                          
                                                                                
VALAC08  MVC   AC_OFF,PPRGAOFF                                                  
         OC    AC_OFF,SPACES                                                    
         MVC   AC_CLISR,PPRRECVU   Save off debtor code                         
*                                                                               
         MVC   AC_PROFF,SPACES     force update on clients                      
         CLI   AC_ACLVL,AC_LVL1    if we're not sending client                  
         JE    VALAC06                                                          
         MVC   AC_PROFF,PPRGAOFF   save client level for product etc            
         J     VALAC06                                                          
*                                                                               
         USING ADRELD,R2                                                        
VALAC09  LLC   RF,ADRLN                                                         
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   CLIADDR(0),ADRELD   Save off client address to populate          
         EX    RF,0(RE)            on product                                   
         J     VALAC06                                                          
                                                                                
         USING RSTELD,R2                                                        
VALAC10  MVC   AC_FLT1,RSTFILT1                                                 
         MVC   AC_FLT2,RSTFILT2                                                 
         MVC   AC_FLT3,RSTFILT3                                                 
         MVC   AC_FLT4,RSTFILT4                                                 
         MVC   AC_FLT5,RSTFILT5                                                 
         CLI   LDGAOP,LDGOFLT1     Test offices in filters                      
         JL    VALAC12                                                          
         PACK  DUB,LDGAOP          Office in filters                            
         CVB   R1,DUB              Value is of form X'F1'-X'F4'                 
         LA    R1,AC_FLTS-1(R1)                                                 
         CLI   0(R1),X'40'                                                      
         JNH   VALAC12                                                          
         MVC   AC_OFF(1),0(R1)                                                  
VALAC12  CLC   RSTSECY+1(1),CUAUTH+1                                            
         JNH   VALAC06                                                          
         GOTOR SAVERR,DMCB,=AL2(AE$SECLK),0,0                                   
         J     EXITN                                                            
* test hiearchy 2                                                               
VALAC14  DS    0H                                                               
         GOTOR VRDACT,DMCB,(2,ANYACCNT),AC_ACTL2                                
         JL    EXITN                                                            
         JNH   VALAC16                                                          
         CLI   QA_ASTAT,QA_AAUTO   For auto job numbering need product          
         JNE   VALAC90             code!                                        
         GOTOR SAVERR,DMCB,=AL2(AE$MSPRD),(5,=C'EC127'),=AL2(FLD003)            
         J     EXITN                                                            
*                                                                               
VALAC16  L     R2,AIO3                                                          
         LA    R2,ACTRFST-ACTRECD(R2)                                           
         USING PPRELD,R2                                                        
         XR    R0,R0                                                            
VALAC18  CLI   PPREL,0                                                          
         JE    VALAC32                                                          
         CLI   PPREL,RSTELQ                                                     
         JE    VALAC24                                                          
         CLI   PPREL,PPRELQ                                                     
         JE    VALAC22                                                          
                                                                                
VALAC20  IC    R0,PPRLN                                                         
         AR    R2,R0                                                            
         J     VALAC18                                                          
                                                                                
VALAC22  CLI   PPRGAOFF,X'40'                                                   
         JNH   VALAC20                                                          
         MVC   AC_OFF,PPRGAOFF                                                  
         OC    AC_OFF,SPACES                                                    
         CLI   AC_ACLVL,AC_LVL2    if we're sending product                     
         JE    VALAC20             AC_PROFF should be Client off                
         MVC   AC_PROFF,AC_OFF                                                  
         J     VALAC20                                                          
*                                                                               
         USING RSTELD,R2                                                        
VALAC24  MVC   AC_FLT1,RSTFILT1                                                 
         MVC   AC_FLT2,RSTFILT2                                                 
         MVC   AC_FLT3,RSTFILT3                                                 
         MVC   AC_FLT4,RSTFILT4                                                 
         MVC   AC_FLT5,RSTFILT5                                                 
         CLI   LDGAOP,LDGOFLT1     Test offices in filters                      
         JL    VALAC26                                                          
         PACK  DUB,LDGAOP          Office in filters                            
         CVB   R1,DUB              Value is of form X'F1'-X'F4'                 
         LA    R1,AC_FLTS-1(R1)                                                 
         CLI   0(R1),X'40'                                                      
         JNH   VALAC26                                                          
         MVC   AC_OFF(1),0(R1)                                                  
VALAC26  CLC   RSTSECY+1(1),CUAUTH+1                                            
         JNH   VALAC20                                                          
         GOTOR SAVERR,DMCB,=AL2(AE$SECLK),0,0                                   
         J     EXITN                                                            
*                                                                               
VALAC32  LLC   RE,LDGAL2                                                        
         LLC   RF,LDGAL3                                                        
         LTR   RF,RF                                                            
         JZ    VALAC90                                                          
         SR    RF,RE                                                            
         SHI   RF,1                                                             
         LA    R1,ANYACCD(RE)                                                   
         BASR  RE,0                                                             
         CLC   0(0,R1),SPACES                                                   
         EX    RF,0(RE)                                                         
         JH    VALAC33                                                          
         CLI   QA_ASTAT,QA_AAUTO   For auto job numbering need job              
         JNE   VALAC90             code!                                        
         GOTOR SAVERR,DMCB,=AL2(AE$MSJOB),(5,=C'EC127'),=AL2(FLD003)            
         J     EXITN                                                            
*                                                                               
VALAC33  BASR  RE,0                                                             
         MVC   AC_ACTL3(0),0(R1)   Save level 3 job/media code                  
         EX    RF,0(RE)                                                         
         CLC   PRODUL,QA_UNIT      Are we dealing with productn ledger          
         JNE   VALAC60             No                                           
         LLC   RE,LDGAL2                                                        
         LA    R1,ANYACCD(RE)                                                   
         GOTOR VALMED              Validate media                               
         JNE   EXITN                                                            
         OC    QA_NMED,QA_NMED     Have we got a new media                      
         JNZ   *+14                Yes                                          
         OC    QA_NPRO,QA_NPRO     Have we got a new product                    
         JZ    VALAC52             No                                           
* new product/media                                                             
         USING ACTRECD,R2                                                       
         LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         LLC   RF,LDGAL1                                                        
         OC    QA_NPRO,QA_NPRO     Have we got a new product                    
         JNZ   *+10                No                                           
         LLC   RF,LDGAL2                                                        
         AHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   ACTKULA(0),ANYACCNT                                              
         EX    RF,0(RE)                                                         
                                                                                
         OC    QA_NPRO,QA_NPRO     Change to product                            
         JZ    VALAC34             No                                           
         MVC   AC_ACTL2,SPACES     Yes - clear existing prod extracted          
         OC    QA_NJOB,QA_NJOB     Change to job                                
         JNZ   *+14                Yes                                          
         OC    QA_NMED,QA_NMED     Change to media                              
         JZ    *+10                No                                           
         MVC   AC_ACTL3,SPACES     Yes - clear existing level 3                 
                                                                                
         SHI   RF,1                                                             
         LA    R3,ACTKACT                                                       
         AR    R3,RF                                                            
         LLC   RE,LDGAL2                                                        
         SR    RE,RF                                                            
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   0(0,R3),QA_NPRO                                                  
         EX    RE,0(RF)                                                         
         BASR  RF,0                                                             
         MVC   AC_ACTL2(0),QA_NPRO                                              
         EX    RE,0(RF)                                                         
                                                                                
VALAC34  MVC   DR_ULA,ACTKULA                                                   
         LA    R3,DR_ACT                                                        
         LLC   RE,LDGAL2                                                        
         AR    R3,RE                                                            
         LA    R1,QA_NMED                                                       
         OC    QA_NMED,QA_NMED                                                  
         JNZ   VALAC36                                                          
         LA    R1,ANYACCD                                                       
         AR    R1,RE                                                            
VALAC36  MVC   0(L'QA_NMED,R3),0(R1)                                            
         MVC   AC_ACTL3(L'QA_NMED),0(R1)                                        
* new job                                                                       
         OC    QA_NJOB,QA_NJOB                                                  
         JZ    VALAC38                                                          
         LLC   RF,LDGAL2                                                        
         LLC   R1,LDGAL3                                                        
         SR    R1,RF                                                            
         SHI   R1,1                                                             
         BASR  RF,0                                                             
         MVC   0(0,R3),QA_NJOB                                                  
         EX    R1,0(RF)                                                         
         MVC   AC_ACTL3(L'QA_NJOB),QA_NJOB                                      
                                                                                
VALAC38  GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    VALAC40                                                          
         DC    H'0'                                                             
                                                                                
VALAC40  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO3                                                          
         OI    AC_IND1,AC_ILVL2    Set level 2 account found                    
         LA    R2,ACTRFST                                                       
         USING PPRELD,R2                                                        
         XR    R0,R0                                                            
VALAC42  CLI   PPREL,0                                                          
         JE    VALAC50                                                          
         CLI   PPREL,RSTELQ                                                     
         JE    VALAC48                                                          
         CLI   PPREL,PPRELQ                                                     
         JE    VALAC46                                                          
                                                                                
VALAC44  IC    R0,PPRLN                                                         
         AR    R2,R0                                                            
         J     VALAC42                                                          
                                                                                
VALAC46  CLI   PPRGAOFF,X'40'                                                   
         JNH   VALAC44                                                          
         MVC   AC_OFF,PPRGAOFF                                                  
         OC    AC_OFF,SPACES                                                    
         CLI   AC_ACLVL,AC_LVL2    if we're sending product                     
         JE    VALAC44             AC_PROFF should be Client off                
         MVC   AC_PROFF,AC_OFF                                                  
         J     VALAC44                                                          
*                                                                               
         USING RSTELD,R2                                                        
VALAC48  CLC   RSTSECY+1(1),CUAUTH+1                                            
         JNH   VALAC44                                                          
         GOTOR SAVERR,DMCB,=AL2(AE$SECLK),0,0                                   
         J     EXITN                                                            
                                                                                
VALAC50  GOTOR VALMED,QA_NMED      validate media and office                    
         JNE   EXITN                                                            
*                                                                               
VALAC52  DS    0H                                                               
         XC    AC_OFFGR,AC_OFFGR                                                
         GOTOR GETOGR,AC_OFF       Office on file?                              
         MVC   AC_OFFGR,0(R1)      Returned by GETOGR                           
         GOTOR SETOPT              Set and get opt maint block                  
         JNE   EXITN                                                            
                                                                                
         CLI   QA_ASTAT,QA_AAUTO   Are we assigning job num automat'ly          
         JNE   VALAC60             No - validate input as normal                
         GOTOR GETAPP,QA_UNIT      Get if user is also the approver             
         JNE   EXITN                                                            
         CLI   AC_USRAP,YESQ                                                    
         JE    VALAC54             If approver then need live job no            
         L     R1,AGOXBLCK                                                      
         USING GOXBLKD,R1                                                       
         CLI   GODRFT,C'D'         Are we using draft numbers                   
         JNE   VALAC56             No - get live job number                     
         GOTOR FINDJOB,DRFTQ       Yes - find draft job number                  
         JE    VALAC58                                                          
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
         DROP  R1                                                               
                                                                                
VALAC54  OI    AC_IND2,AC_IAPPR                                                 
VALAC56  GOTOR FINDJOB,LIVEQ       Yes - find job number                        
         JE    VALAC58                                                          
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
VALAC58  OI    AC_IND1,AC_INEW3    Set new level 3 account                      
         NI    AC_IND1,X'FF'-(AC_INEW1+AC_INEW2)                                
         OI    AC_IND2,AC_ILOW     Set low level account                        
         J     VALAC90                                                          
* test hierarchy 3                                                              
VALAC60 DS     0H                                                               
         GOTOR VRDACT,DMCB,(3,ANYACCNT),0                                       
         JL    EXITN                                                            
         JH    VALAC90                                                          
         USING ACTRECD,R2                                                       
         L     R2,AIO3                                                          
*                                                                               
         CLI   QA_ASTAT,QA_AAPPR   Are we approving                             
         JNE   VALAC66                                                          
         TM    ACTRSTAT,ACTSDELT                                                
         JZ    VALAC62                                                          
         GOTOR SAVERR,DMCB,=AL2(AE$APAPA),0,=AL2(FLD005)                        
         J     EXITN               Yes - error already approved ???             
*                                                                               
VALAC62  TM    ACTRSTAT,ACTSDRFT   Is it draft                                  
         JNZ   VALAC66             Yes                                          
         GOTOR SAVERR,DMCB,=AL2(AE$APAPA),0,=AL2(FLD005)                        
         J     EXITN               Yes - error already live                     
*                                                                               
VALAC66  LA    R2,ACTRFST                                                       
         USING PPRELD,R2                                                        
         XR    R0,R0                                                            
VALAC68  CLI   PPREL,0                                                          
         JE    VALAC78                                                          
         CLI   PPREL,RSTELQ                                                     
         JE    VALAC74                                                          
         CLI   PPREL,PPRELQ                                                     
         JE    VALAC72                                                          
                                                                                
VALAC70  IC    R0,PPRLN                                                         
         AR    R2,R0                                                            
         J     VALAC68                                                          
                                                                                
VALAC72  CLI   PPRGAOFF,X'40'                                                   
         JNH   VALAC70                                                          
         MVC   AC_OFF,PPRGAOFF                                                  
         OC    AC_OFF,SPACES                                                    
         CLI   AC_ACLVL,AC_LVL3    if we're sending lvl 3                       
         JE    VALAC70             AC_PROFF should be lvl 2                     
         MVC   AC_PROFF,AC_OFF                                                  
         J     VALAC70                                                          
*                                                                               
         USING RSTELD,R2                                                        
VALAC74  MVC   AC_FLT1,RSTFILT1                                                 
         MVC   AC_FLT2,RSTFILT2                                                 
         MVC   AC_FLT3,RSTFILT3                                                 
         MVC   AC_FLT4,RSTFILT4                                                 
         MVC   AC_FLT5,RSTFILT5                                                 
         CLI   LDGAOP,LDGOFLT1     Test offices in filters                      
         JL    VALAC76                                                          
         PACK  DUB,LDGAOP          Office in filters                            
         CVB   R1,DUB              Value is of form X'F1'-X'F4'                 
         LA    R1,AC_FLTS-1(R1)                                                 
         CLI   0(R1),X'40'                                                      
         JNH   VALAC76                                                          
         MVC   AC_OFF(1),0(R1)                                                  
VALAC76  CLC   RSTSECY+1(1),CUAUTH+1                                            
         JNH   VALAC77                                                          
         GOTOR SAVERR,DMCB,=AL2(AE$SECLK),0,0                                   
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
*                                                                               
VALAC77  CLI   QA_ASTAT,QA_ADELT   Are we deleting?                             
         JE    VALAC70             Yes,don't check locked/closed status         
         CLI   QA_TYPE,QA_TAPPR    Check for locked/closed status and           
         JE    VALAC7A             throw error if approving                     
         CLI   QA_TYPE,QA_TUPDT                                                 
         JNE   VALAC70                                                          
         CLI   QA_ASTAT,QA_AAPPR   Are we approving or rejecting?               
         JE    *+12                                                             
         CLI   QA_ASTAT,QA_AREJT                                                
         JNE   VALAC70                                                          
*                                                                               
VALAC7A  TM    RSTSTAT1,RSTSACIL   Is job locked?                               
         JZ    VALAC7B                                                          
         GOTOR SAVERR,DMCB,=AL2(AE$ACLOK),(5,=C'EC118'),=AL2(FLD003)            
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
*                                                                               
VALAC7B  TM    RSTSTAT1,RSTSACIC   Is job closed?                               
         JZ    VALAC70                                                          
         GOTOR SAVERR,DMCB,=AL2(AE$JBCLO),(5,=C'EC118'),=AL2(FLD003)            
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
* test hierarchy 4                                                              
VALAC78  DS    0H                                                               
         GOTOR VRDACT,DMCB,(4,ANYACCNT),0                                       
         JL    EXITN                                                            
         JH    VALAC90                                                          
*                                                                               
VALAC80  DS    0H                                                               
         L     R2,AIO3                                                          
         LA    R2,ACTRFST-ACTRECD(R2)                                           
         USING PPRELD,R2                                                        
         XR    R0,R0                                                            
VALAC82  CLI   PPREL,0                                                          
         JE    VALAC90                                                          
         CLI   PPREL,RSTELQ                                                     
         JE    VALAC86                                                          
                                                                                
VALAC84  IC    R0,PPRLN                                                         
         AR    R2,R0                                                            
         J     VALAC82                                                          
*                                                                               
         USING RSTELD,R2                                                        
VALAC86  MVC   AC_FLT1,RSTFILT1                                                 
         MVC   AC_FLT2,RSTFILT2                                                 
         MVC   AC_FLT3,RSTFILT3                                                 
         MVC   AC_FLT4,RSTFILT4                                                 
         MVC   AC_FLT5,RSTFILT5                                                 
         CLI   LDGAOP,LDGOFLT1     Test offices in filters                      
         JL    VALAC88                                                          
         PACK  DUB,LDGAOP          Office in filters                            
         CVB   R1,DUB              Value is of form X'F1'-X'F4'                 
         LA    R1,AC_FLTS-1(R1)                                                 
         CLI   0(R1),X'40'                                                      
         JNH   VALAC88                                                          
         MVC   AC_OFF(1),0(R1)                                                  
VALAC88  CLC   RSTSECY+1(1),CUAUTH+1                                            
         JNH   VALAC84                                                          
         GOTOR SAVERR,DMCB,=AL2(AE$SECLK),0,0                                   
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
*  OFFPOS validation. 'Add Account' jumps here, ac_off blank or set             
*   from higher levels.                                                         
VALAC90  CLI   QA_ASTAT,QA_ANEW    ADDING ACCOUNT?                              
         JNE   VALAC95                                                          
         TM    AC_IND1,AC_INEW1+AC_INEW2+AC_INEW3+AC_INEW4                      
         JNZ   VALAC95             did we find it?                              
         CLI   QA_UPLD,QA_SAPTL                                                 
         JE    VALAC94                                                          
         GOTOR SAVERR,DMCB,=AL2(AE$RECAE),0,0                                   
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
VALAC94  MVI   QA_ASTAT,0          treat add as change if sap tool              
*                                                                               
VALAC95  CLI   OFFIND,FULLYQ       Office based agency                          
         JNE   VALAC110                                                         
         CLI   LDGAOP,LDGONONE     Test any office in ledger                    
         JE    VALAC110                                                         
         CLI   LDGAOP,LDGOTRAN     Test offices in transactions                 
         JE    VALAC110                                                         
         CLI   LDGAOP,LDGOOFLS     Test office list in key                      
         JE    VALAC105                                                         
         CLI   LDGAOP,LDGOPROF     Test offices in profile element              
         JE    VALAC110                                                         
         CLI   LDGAOP,LDGOFLT1     Test offices in filters                      
         JNL   VALAC100                                                         
* office from account -> AC_OFF                                                 
         MVC   WORK(1),LDGAOP                                                   
         NI    WORK,FF-LDGOKEY2                                                 
         CLI   WORK,LDGOKEY                                                     
         JH    VALAC100                                                         
         XR    R1,R1                                                            
         IC    R1,WORK                                                          
         LA    R1,ANYACCNT+(ACTKACT-ACTRECD-2)(R1)                              
         MVC   AC_OFF+0(1),0(R1)                                                
         TM    LDGAOP,LDGOKEY2     Test 2 character office in key               
         JZ    VALAC100                                                         
         MVC   AC_OFF+1(1),1(R1)                                                
VALAC100 CLC   AC_OFF,SPACES                                                    
         JNE   VALAC105                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$INVPO),0,0                                   
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
*                                                                               
         USING OFFALD,R1                                                        
VALAC105 L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,AC_OFF                                                  
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL              Validate office code                         
         JE    VALAC110                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$SECLK),0,0                                   
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
         DROP  R1,R2                                                            
* IF UPLOAD TOOL, VALIDATE QA_OFFC NOW                                          
VALAC110 DS    0H                                                               
*&&UK                                                                           
         CLI   QA_UPLD,QA_SAPTL    If not SAP upload tool make sure off         
         JE    VALAC112            entered is not too long                      
         CLI   QA_OFFC+L'TRNKOFF,C' '                                           
         JNH   VALAC112                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$IVOFF),0,=AL2(FLD093)                        
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
*                                                                               
VALAC112 CLI   QA_UPLD,0           If BrandOcean/Aura skip                      
         JE    VALAC115                                                         
         GOTOR VALOFF              Validate office                              
         JNE   EXITN                                                            
*&&                                                                             
*                                                                               
VALAC115 MVC   OA_ULA,QA_UNIT                                                   
         L     R2,AIO3                                                          
         USING ACTRECD,R2                                                       
         CLC   PRODUL,OA_ULA       Production ledger                            
         JE    VALAC118                                                         
         OI    AC_IND2,AC_IDRFT    Set account is draft                         
         CLI   QA_ASTAT,QA_AAPPR   Are we approving?                            
         JNE   VALAC176                                                         
         OI    AC_IND2,AC_IAPPR    Set as approved                              
         J     VALAC176                                                         
*                                                                               
VALAC118 CLI   QA_ASTAT,QA_AAUTO   Is it auto job add                           
         JNE   *+10                No - use code passed in request              
         MVC   OA_ACT,AC_LTCPJ     Yes - Use code from FINDJOB                  
         TM    AC_IND1,AC_ILVL3    Was job level found                          
         JZ    VALAC176            No - not an existing job                     
         TM    ACTRSTAT,ACTSDRFT   Is the job draft                             
         JZ    VALAC176            No                                           
         OI    AC_IND2,AC_IDRFT    Set account is draft                         
         OC    DR_ULA,DR_ULA       Change to media or product                   
         JNZ   VALAC135                                                         
                                                                                
         GOTOR GETAPP,QA_ULA       Get approver for account                     
         JNE   EXITN                                                            
         CLI   QA_ASTAT,QA_AAPPR                                                
         JNE   VALAC176                                                         
         CLI   AC_USRAP,YESQ       Is the connected user the approver           
         JE    VALAC120            No                                           
         GOTOR SAVERR,DMCB,=AL2(AE$RNLAP),0,0 Resubmit as no longer             
         J     EXITN                      the approver                          
VALAC120 L     R1,AGOXBLCK         Yes                                          
         USING GOXBLKD,R1                                                       
         CLI   GODRFT,C'N'         Has the draft setting changed                
         JNE   VALAC125            No                                           
         GOTOR SAVERR,DMCB,=AL2(AE$CAPDR),0,0 Must submit as no longer          
         J     EXITN                      drafts for this client/media          
                                                                                
VALAC125 NI    AC_IND2,X'FF'-AC_IDRFT                                           
         OI    AC_IND2,AC_IAPPR                                                 
         CLI   GODRFT,C'D'         Are we using draft numbers                   
         JNE   VALAC176            No - number remains the same                 
         L     R1,AGOBLOCB         Yes - get live number if auto number         
         USING GOBLOCKD,R1                             in use                   
         CLI   GOAUTNUM,YESQ       Otherwise error as should be a               
         JE    VALAC130              change in job number passed                
         GOTOR SAVERR,DMCB,=AL2(AE$JNORQ),0,0  New job number required          
         J     EXITN                                                            
         DROP  R1                                                               
                                                                                
VALAC130 OI    AC_IND2,AC_IRMOL    Remove old account code                      
         GOTOR FINDJOB,LIVEQ       Yes - find job number                        
         JE    VALAC175                                                         
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
                                                                                
* Media product or job code has changed                                         
                                                                                
VALAC135 MVC   OA_ULA,DR_ULA       Use code derived from this change            
         OI    AC_IND2,AC_IRMOL    Remove old account code                      
         L     R1,AGOBLOCB                                                      
         USING GOBLOCKD,R1                                                      
         CLI   GOAUTNUM,YESQ       Are we using auto numbering                  
         JE    VALAC155            Yes                                          
         OC    QA_NJOB,QA_NJOB     No - check we have be give new job           
         JNZ   VALAC140                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$JNORQ),0,0 New job number required           
         J     EXITN                        as no auto numbering                
                                                                                
         USING ACTRECD,R2                                                       
VALAC140 LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA,DR_ULA                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JNE   VALAC145                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$IJBNO),0,0 Job already exists - must         
         J     EXITN                                   be new                   
                                                                                
VALAC145 GOTOR GETAPP,DR_ULA       Get approver for account                     
         JNE   EXITN                                                            
         L     R1,AGOXBLCK                                                      
         USING GOXBLKD,R1                                                       
         CLI   QA_ASTAT,QA_AAPPR   Are we approving                             
         JNE   VALAC150            No                                           
         CLI   AC_USRAP,YESQ       And are we the approver                      
         JNE   VALAC150            No                                           
         OI    AC_IND2,AC_IAPPR                                                 
         NI    AC_IND2,X'FF'-AC_IDRFT  Build live job                           
         CLI   GODRFT,C'N'         Does new prod media have draft jobs          
         JNE   VALAC176            Yes                                          
         GOTOR SAVERR,DMCB,=AL2(AE$CAPDR),0,0 Can't approve as job not          
         J     EXITN               not on client/media with draft jobs          
                                                                                
VALAC150 CLI   GODRFT,C'N'         Does new prod media have draft jobs          
         JNE   VALAC176            Yes                                          
         NI    AC_IND2,X'FF'-AC_IDRFT  Build live job                           
         J     VALAC176                                                         
                                                                                
* Change to product media job and using auto numbering                          
                                                                                
VALAC155 GOTOR GETAPP,DR_ULA       Get approver for account                     
         JNE   EXITN                                                            
         NI    AC_IND2,X'FF'-AC_IDRFT  Build live job                           
         L     R1,AGOXBLCK                                                      
         USING GOXBLKD,R1                                                       
         CLI   QA_ASTAT,QA_AAPPR   Are we approving                             
         JNE   VALAC165            No                                           
         CLI   AC_USRAP,YESQ       And are we the approver                      
         JE    VALAC160            Yes                                          
         GOTOR SAVERR,DMCB,=AL2(AE$RNLAP),0,0 Resubmit as no longer             
         J     EXITN                      the approver                          
VALAC160 OI    AC_IND2,AC_IAPPR                                                 
         CLI   GODRFT,C'N'         Does new prod media have draft jobs          
         JNE   VALAC170            Yes                                          
         GOTOR SAVERR,DMCB,=AL2(AE$CAPDR),0,0 Can't approve as job not          
         J     EXITN               not on client/media with draft jobs          
                                                                                
VALAC165 CLI   GODRFT,C'N'         Does new prod media have draft jobs          
         JE    VALAC170            No - just add live jobs                      
         OI    AC_IND2,AC_IDRFT    Build draft job                              
         CLI   GODRFT,C'Y'         Draft jobs                                   
         JE    VALAC170            Yes - add draft job with live number         
         GOTOR FINDJOB,DRFTQ       Yes - find draft job number                  
         JE    VALAC175                                                         
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
                                                                                
VALAC170 GOTOR FINDJOB,LIVEQ       Find live job number                         
         JE    VALAC175                                                         
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
                                                                                
VALAC175 MVC   OA_ACT,AC_LTCPJ     Yes - Use code from FINDJOB                  
                                                                                
VALAC176 L     R2,AIO3                                                          
         MVC   ACTKEY,SPACES       RE-INIT IN CASE WE'RE HERE ON                
         MVC   ACTKCPY,CUXCPY                   LOW-LEVEL ADD                   
         MVC   ACTKULA,OA_ULA                                                   
         CLC   PRODUL,OA_ULA       Production ledger                            
         JNE   VALAC180            No                                           
         L     R1,AGOXBLCK                                                      
         USING GOXBLKD,R1                                                       
         TM    ACTRSTA,ACTSDRFT    Ignore if already approved                   
         JZ    VALAC180                                                         
         CLI   GODRFT,C'N'         Do we have draft jobs                        
         JE    VALAC180            No - no need to check for approvers          
         GOTOR GETAPP,OA_ULA       Get approver for account                     
         JNE   EXITN                                                            
VALAC180 DS    0H                                                               
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO4                                        
         LLC   RE,LDGAL2                                                        
         LLC   RF,LDGAL3                                                        
         LTR   RF,RF                                                            
         JZ    VALAC200                                                         
         SR    RF,RE                                                            
         SHI   RF,1                                                             
         LA    R1,ANYACCD(RE)                                                   
         BASR  RE,0                                                             
         CLC   0(0,R1),SPACES                                                   
         EX    RF,0(RE)                                                         
         JNH   VALAC200                                                         
         USING AEXRECD,R4                                                       
         LA    R4,IOKEY                                                         
         XC    AEXKEY,AEXKEY                                                    
         MVI   AEXKTYP,AEXKTYPQ                                                 
         MVI   AEXKSUB,AEXKSUBQ                                                 
         MVC   AEXKCPY,CUXCPY                                                   
         MVC   AEXKULA,OA_ULA                                                   
         TM    AC_IND1,AC_ILVL3    Was job level found                          
         JZ    *+10                No - not an existing job                     
         MVC   AEXKULA,QA_ULA                                                   
         MVC   CSVKEY1,AEXKEY                                                   
         L     R1,=AL4(IORDD+IODIR+IO4)                                         
         GOTOR (#IOEXEC,AIOEXEC)                                                
         MVC   AEXIOERR,IOERR                                                   
         JE    VALAC190                                                         
         CLI   IOERR,IOERNF                                                     
         JE    VALAC195                                                         
         CLI   IOERR,IOEDEL                                                     
         JE    *+6                                                              
         DC    H'0'                                                             
VALAC190 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO4'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R4,AIO4             R4=A(account extension rec)                  
         MVC   AEXKULA,OA_ULA                                                   
         CLI   AEXIOERR,IOEDEL     If it was deleted clear record               
         JNE   VALAC200                                                         
                                                                                
VALAC195 L     R4,AIO4             R4=A(account extension rec)                  
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO4                                        
         MVC   AEXKEY,CSVKEY1                                                   
         MVC   AEXKULA,OA_ULA                                                   
         LA    R0,AEXRFST-AEXRECD                                               
         STCM  R0,3,AEXRLEN                                                     
*                                  Check no. of address lines                   
VALAC200 XR    R3,R3                                                            
         ICM   R3,7,QA_AADDR       R3=A(Uploaded address lines)                 
         JZ    VALAC205                                                         
         XR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R3)  Number of address lines                   
         CHI   R0,5                Check no more than 5!                        
         JNH   VALAC205            if more then error                           
         GOTOR SAVERR,DMCB,=AL2(AE$TMINF),(5,=C'EC111'),=AL2(FLD017)            
         J     EXITN                                                            
*                                                                               
VALAC205 DS    0H                                                               
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Read hierarchy level using LDGAREA                                  *         
* ENTRY: P1 B0   - # LEVEL TO PROCESS (1-4)                                     
*           B1-3 - A(ULA LOWER LEVEL ACCOUNT)                                   
*        P2      - A(SAVE ARE FOR ACCOUNT COMPONENT FOR LEVEL) OR ZERO          
* RETURN: CC=LOW IF ERROR, HIGH IF NEW FILE/NOTHING AT THIS LEVEL               
***********************************************************************         
*                                                                               
         USING ACTRECD,R2                                                       
VRDACT   NTR1  LABEL=*,BASE=*                                                   
         LLC   R3,0(R1)                                                         
         SHI   R3,1                                                             
         LA    R3,LDGAL1(R3)    A(LDGALn)                                       
         SR    R5,R5                                                            
         ICM   R5,7,1(R1)       A(input a/c)                                    
         L     R4,4(R1)         A(save area)                                    
*                                                                               
         CLI   0(R3),L'ACTKACT  Lowest level account                            
         JNE   *+8              No                                              
         OI    AC_IND2,AC_ILOW  Yes - Set low level account                     
*                                                                               
         LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT,QA_UNIT                                                  
         MVC   ACTKLDG,QA_LDG                                                   
*                                                                               
         LLC   RE,0(R3)            L'key up to this level                       
         LA    R1,L'ACTKUNT+L'ACTKLDG(R5)                                       
         LA    RF,LDGAL1                                                        
         CR    RF,R3                                                            
         JE    VRDACT10            LVL1                                         
         LR    RF,R3                                                            
         SHI   RF,1                A(LDGAL(n-1))                                
         LLC   R1,0(RF)                                                         
         SR    RE,R1               L'this level                                 
         LA    R1,L'ACTKUNT+L'ACTKLDG(R1)                                       
         AR    R1,R5               A(component for level)                       
*                                                                               
VRDACT10 DS    0H                                                               
         SHI   RE,1                                                             
         BASR  RF,0                Check A/C code extends to this level         
         CLC   0(0,R1),SPACES                                                   
         EX    RE,0(RF)                                                         
         JNH   EXITH                                                            
         LTR   R4,R4               Save A/C component for level                 
         JZ    VRDACT15                   if pointer provided                   
         MVC   0(L'AC_ACTL1,R4),SPACES                                          
         BASR  RF,0                                                             
         MVC   0(0,R4),0(R1)                                                    
         EX    RE,0(RF)                                                         
*                                                                               
VRDACT15 LLC   RF,0(R3)            Finish building key for level                
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   ACTKACT(0),L'ACTKUNT+L'ACTKLDG(R5)                               
         EX    RF,0(RE)                                                         
*                                                                               
         LR    R4,R3                                                            
         LA    RF,LDGAL1                                                        
         SR    R4,RF                                                            
         SLL   R4,1                                                             
         LA    R4,ACLVLTAB(R4)     A(AC_INDn flags for level)                   
*                                                                               
         L     R1,=AL4(IORDD+IODIR+IO3)                                         
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    VRDACT50                                                         
         TM    IOERR,IOEDEL        Is account deleted                           
         JNZ   VRDACT20                                                         
         CLI   QA_UPLD,QA_SAPTL    If SAP, convert to New                       
         JNE   VRDACT30                                                         
         MVI   QA_ASTAT,QA_ANEW                                                 
         J     VRDACT30                                                         
* a/c on file, deleted.                                                         
VRDACT20 DS    0H                                                               
*&&UK                                                                           
         XR    RF,RF               If mediahub force to be new account          
         ICM   RF,3,CUXPNUM                                                     
         CHI   RF,XPMEDHUB                                                      
         JNE   VRDACT25                                                         
         CHI   R3,3                                                             
         JNL   VRDACT25                                                         
         MVI   QA_ASTAT,QA_ANEW                                                 
*&&                                                                             
VRDACT25 DS    0H                                                               
         CLI   QA_ASTAT,QA_ANEW    Yes - only allow new and auto                
         JE    VRDACT30               through for reuse of code                 
         CLI   QA_ASTAT,QA_AAUTO                                                
         JE    VRDACT30                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$RECID),(5,=C'EC090'),=AL2(FLD005)            
         J     VRDACTN                                                          
*                                                                               
VRDACT30 OC    AC_IND1,0(R4)       Set new account                              
         LLC   RE,AC_ACLVL    provided this is the level of the req a/c         
         SLL   RE,28                                                            
         SRL   RE,28                                                            
         SHI   RE,1                                                             
         LA    RE,LDGAL1(RE)                                                    
         CR    RE,R3                                                            
         JE    EXITH                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$HLACM),(5,=C'EC091'),=AL2(FLD003)            
         J     VRDACTN             No then error!                               
* a/c on file.                                                                  
VRDACT50 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         OC    AC_IND1,1(R4)       Level found                                  
*                                                                               
VRDACTX  J     EXITY                                                            
VRDACTN  J     EXITN                                                            
*                                                                               
ACLVLTAB DS    0H                                                               
         DC    AL1(AC_INEW1),AL1(AC_ILVL1)                                      
         DC    AL1(AC_INEW2),AL1(AC_ILVL2)                                      
         DC    AL1(AC_INEW3),AL1(AC_ILVL3)                                      
         DC    AL1(AC_INEW4),AL1(AC_ILVL4)                                      
ACLVLTBX DS    0H                                                               
         EJECT                                                                  
***********************************************************************         
* Build basic status element - R1=STCATYP value, R4=A(Element)        *         
***********************************************************************         
                                                                                
         USING STCELD,R4                                                        
BLDSTC   NTR1  LABEL=NO                                                         
         XC    STCEL(256),STCEL                                                 
         MVI   STCEL,STCELQ                                                     
         MVI   STCLN,STCLN8Q                                                    
         MVI   STCIND,STCIACT                                                   
         MVC   STCUSER,CUUSER                                                   
         MVC   STCPERS,CCTPID                                                   
         MVC   STCTERM,CUTERM                                                   
         MVC   STCDATE,AC_TODYP                                                 
         MVC   STCTIME,CTIME                                                    
         STC   R1,STCATYP                                                       
         J     EXITY                                                            
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* Auto job number routine                                             *         
***********************************************************************         
         SPACE 1                                                                
FINDJOB  NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*FINDJB*'                                                      
         STC   R1,BYTE1                                                         
                                                                                
         XC    ELEMENT,ELEMENT     Read production profile                      
         MVI   ELEMENT+00,C'A'-X'40'                                            
         MVC   ELEMENT+01(3),=C'PRO'                                            
         MVC   ELEMENT+12(2),CUAALF                                             
         GOTO1 VGETPROF,DMCB,ELEMENT,PRODPROF,VDATAMGR                          
                                                                                
         LA    R3,SRCHTBL                                                       
         USING SRCTABD,R3                                                       
         XC    AC_EFDTE,FFS8                                                    
*                                                                               
         USING AJNRECD,R2                                                       
         LA    R2,IOKEY                                                         
FJOB002  XC    AJNKEY,AJNKEY                                                    
         MVI   AJNKTYP,AJNKTYPQ                                                 
         MVI   AJNKSUB,AJNKSUBQ                                                 
         MVC   AJNKCPY,CUXCPY                                                   
         MVC   AJNKUNT(L'PRODUL),PRODUL                                         
         TM    SRCSTAT,SRCCLI                                                   
         JZ    FJOB004                                                          
         MVC   AJNKCLI,AC_ACTL1    Client                                       
FJOB004  TM    SRCSTAT,SRCPRO                                                   
         JZ    FJOB006                                                          
         MVC   AJNKPRO,AC_ACTL2    Product                                      
FJOB006  TM    SRCSTAT,SRCMED                                                   
         JZ    FJOB008                                                          
         OC    AC_MEDIA,AC_MEDIA   Have we got a media code                     
         JZ    FJOB018             No - bump to next table entry                
         MVC   AJNKMED,AC_MEDIA    Yes - Use media code                         
*                                                                               
FJOB008  TM    SRCSTAT,SRCMEDGR                                                 
         JZ    FJOB010                                                          
         OC    AC_MEDGR,AC_MEDGR   Have we got a media group                    
         JZ    FJOB018             No  - bump to next table entry               
         MVC   AJNKMG,AC_MEDGR     Yes - use it                                 
FJOB010  TM    SRCSTAT,SRCOFF                                                   
         JZ    FJOB012                                                          
         OC    AC_OFF,AC_OFF       Have we got a office code                    
         JZ    FJOB018             No                                           
         MVC   AJNKOFC,AC_OFF      Yes - Use office code                        
*                                                                               
FJOB012  TM    SRCSTAT,SRCOFFGR                                                 
         JZ    FJOB014                                                          
         OC    AC_OFFGR,AC_OFFGR   Have we got a office group code              
         JZ    FJOB018             No                                           
         MVC   AJNKOG,AC_OFFGR     Yes - Use office group code                  
*                                                                               
FJOB014  MVC   CSVKEY1,AJNKEY                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
FJOB015  CLC   AJNKEY(AJNKEFF-AJNKEY),CSVKEY1  Same record key                  
         JNE   FJOB018                                                          
FJOB016  CLC   AJNKTYPE,BYTE1      Have we got the right type                   
         JNE   *+12                                                             
         TM    AJNKSTA,AJNNDACT    Is the record deactivated                    
         JZ    FJOB020             No                                           
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO1'    yes - read seq             
         JE    *+6                                                              
         DC    H'0'                                                             
         CLC   AJNKEY(AJNKEFF-AJNKEY),CSVKEY1  Same record key                  
         JE    FJOB016             Yes - check if deactivated                   
FJOB018  AHI   R3,1                                                             
         LA    R2,IOKEY                                                         
         CLI   SRCSTAT,X'FF'                                                    
         JNE   FJOB002                                                          
         MVC   ROUERRV,=AL2(AE$NVJBN)                                           
         J     EXITN                                                            
*                                                                               
FJOB020  CLC   AJNKEFF,AC_EFDTE    Is date ok?                                  
         JNL   FJOB022             Yes                                          
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO1'    yes - read seq             
         JE    FJOB015                                                          
         DC    H'0'                                                             
*                                                                               
FJOB022  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    FJOB024                                                          
         DC    H'0'                                                             
*                                                                               
FJOB024  L     R2,AIO1                                                          
         LA    R4,AJNRFST                                                       
         USING JNAELD,R4                                                        
FJOB026  CLI   JNAEL,0             EOR                                          
         JE    FJOB018                                                          
         CLI   JNAEL,JNAELQ        Job number element                           
         JE    FJOB030                                                          
FJOB028  LLC   RE,JNALN                                                         
         AR    R4,RE                                                            
         J     FJOB026                                                          
*                                                                               
FJOB030  L     R1,=AL4(IORDUP+IODIR+IO7)                                        
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R1,=AL4(IOGETRUP+IOMST+IO7)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
FJOB032  L     R2,AIO7                                                          
         LA    R4,AJNRFST                                                       
         USING JNAELD,R4                                                        
FJOB034  CLI   JNAEL,0             EOR                                          
         JNE   *+6                                                              
         DC    H'0'                                                             
         CLI   JNAEL,JNAELQ        Job number element                           
         JE    FJOB038                                                          
FJOB036  LLC   RE,JNALN                                                         
         AR    R4,RE                                                            
         J     FJOB034                                                          
*                                                                               
FJOB038  ST    R4,SAVER4                                                        
         LA    R3,AC_ACTL3+1       Get second position of job                   
         LA    R0,5                Only 5 positions left                        
         XC    ASEQNUM,ASEQNUM     Clear starting sequence #                    
         XC    SAVEPY,SAVEPY       Set to not in use                            
         MVI   FJBIND,0            Set to first time                            
*                                                                               
         USING NUMTABD,R6                                                       
FIND30   LA    R6,NUMTAB                                                        
*                                                                               
FIND32   CLI   NUMVAL,X'FF'        END OF TABLE ?                               
         BE    FIND34              MUST BE CONSTANT                             
         CLC   JNAP2,NUMVAL        DO VALUES MATCH ?                            
         BE    FIND34              YES                                          
         LA    R6,NUMLEN(R6)       NO, KEEP LOOKING                             
         J     FIND32                                                           
*                                                                               
FIND34   OC    NUMADDR,NUMADDR     DO WE HAVE A SPECIAL ROUTINE ?               
         JNZ   FIND36              YES                                          
         CLI   QA_ASTAT,QA_AAUTO                                                
         JNE   FIND35                                                           
         CLI   0(R3),C' '          NO, FIELD MUST BE BLANK TO START             
         JNH   FIND35                                                           
         MVC   ROUERRV,=AL2(AE$JIVAU)                                           
         J     EXITN                                                            
                                                                                
FIND35   MVC   *+10(2),NUMMOVE     MOVE IN REQUIRED DATA                        
         MVC   0(1,R3),SPACES                                                   
*&&UK                                                                           
         CLI   PRODPROF+2,C'R'     RESETTING OF YEAR/SEQ NUM IN USE?            
         JNE   FIND38                                                           
         CLC   NUMVAL,NUMOYQ       CURRENT YEAR CHOSEN?                         
         BNE   FIND38                                                           
         ST    R3,SAVEPY           SAVE ADDRESS AND SET TO  IN USE              
*&&                                                                             
         J     FIND38                                                           
*                                                                               
FIND36   MVC   *+8(2),NUMADDR      GET ADDRESS OF SPECIAL ROUTINE               
         BAS   RE,FIND36           AND BRANCH TO IT                             
*                                                                               
FIND38   LA    R4,L'JNAP2+L'JNAP2N(R4)   GET NEXT POSITION IN ELEM              
         LA    R3,1(R3)            GET NEXT POSITION IN JOB                     
         BCT   R0,FIND30                                                        
*                                                                               
FIND40   L     R4,SAVER4           GET BACK TO CORRECT SPOT                     
         BAS   RE,GETSEQ                                                        
         JE    FJOB041                                                          
         CLC   ROUERRV,=AL2(AE$AUTCM)                                           
         JE    EXITN               TO EXIT WITH ERROR HERE                      
*                                                                               
FJOB041  MVC   AC_LTCPJ(L'AC_ACTL1),AC_ACTL1                                    
         LLC   RE,LDGAL1                                                        
         LA    RF,AC_LTCPJ(RE)                                                  
         LLC   R1,LDGAL2                                                        
         SR    R1,RE                                                            
         SHI   R1,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,RF),AC_ACTL2                                                 
         EX    R1,0(RE)                                                         
         LLC   RE,LDGAL2                                                        
         LA    RF,AC_LTCPJ(RE)                                                  
         LLC   R1,LDGAL3                                                        
         SR    R1,RE                                                            
         SHI   R1,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,RF),AC_ACTL3                                                 
         EX    R1,0(RE)                                                         
         MVC   JNALNUM,AC_LTCPJ    Getseq needs JANNLNUM TO BE UPDATED          
         OC    SAVE1ST,SAVE1ST     DID WE SAVE THE FIRST JOB # ?                
         JZ    FIND42              NO                                           
         CLC   SAVE1ST,AC_ACTL3                                                 
         JNE   FIND44                                                           
         MVC   ROUERRV,=AL2(AE$AUTUS)                                           
         J     EXITN                                                            
*                                                                               
FIND42   MVC   SAVE1ST,AC_ACTL3                                                 
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO7'                           
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   IOKEY+AJNKSTA-AJNRECD(L'AJNKSTA),AJNRSTA                         
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR+IO7'                            
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
NEW      USING ACTRECD,IOKEY                                                    
FIND44   MVC   NEW.ACTKEY,SPACES                                                
         MVC   NEW.ACTKCPY,CUXCPY                                               
         MVC   NEW.ACTKUNT(L'ACTKUNT+L'ACTKLDG),PRODUL                          
         MVC   NEW.ACTKACT,AC_LTCPJ                                             
         L     R1,=AL4(IORDD+IODIR+IO1)                                         
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    FIND40              Found job get next number                    
         CLI   IOERR,IOEDEL        Is this job deleted                          
         JE    FIND40              Yes - get next number                        
         J     EXITY               No - take this job number                    
*                                                                               
GETOFG   MVC   ROUERRV,=AL2(AE$OFGRP)                                           
         OC    AC_OFFGR,AC_OFFGR   Do we have an office group                   
         JZ    EXITN               No                                           
         MVC   0(1,R3),AC_OFFGR    Yes, use it                                  
         BR    RE                                                               
*                                                                               
GETOF2   MVC   ROUERRV,=AL2(AE$2NOFN)                                           
         CLI   AC_OFF+1,C' '       DO WE HAVE A SECOND CHARACTER ?              
         JNH   EXITN               NO                                           
         MVC   0(1,R3),AC_OFF+1   YES, USE IT                                   
         BR    RE                                                               
*                                                                               
USERSUP  CLI   0(R3),C' '          USER SUPPLIED FIELD, MUST HAVE DATA          
         BHR   RE                                                               
         MVC   ROUERRV,=AL2(AE$USJNM)                                           
         J     EXITN                                                            
*                                                                               
NEXTNUM  CLI   QA_ASTAT,QA_AAUTO                                                
         JNE   NEXTNUM2                                                         
         CLI   0(R3),C' '          SEQUENTIAL FIELD, MUST NOT HAVE DATA         
         JNH   NEXTNUM2                                                         
         MVC   ROUERRV,=AL2(AE$JIVAU)                                           
         J     EXITN                                                            
                                                                                
NEXTNUM2 OC    ASEQNUM,ASEQNUM     IS THIS THE FIRST TIME ?                     
         BNZR  RE                  NO                                           
         ST    R3,ASEQNUM          YES, SAVE THIS STOP                          
         BR    RE                                                               
         DROP  R6                                                               
*                                                                               
SETXLN   ST    RE,SAVERE                                                        
         LM    RE,RF,0(R1)                                                      
         AR    RF,RE                                                            
SETXLN10 BCTR  RF,0                                                             
         CR    RE,RF               Must be >= one byte of data                  
         JH    SETXLNN                                                          
         CLI   0(RF),C' '                                                       
         JNH   SETXLN10                                                         
         SR    RF,RE                                                            
         ST    RF,4(R1)                                                         
         L     RE,SAVERE                                                        
         CR    RE,RE                                                            
         BR    RE                                                               
*                                                                               
SETXLNN  ST    RF,4(R1)                                                         
         L     RE,SAVERE                                                        
         LTR   RE,RE                                                            
         BR    RE                                                               
                                                                                
         DS    0D                                                               
NUMTAB   DC    C'US',S(0),S(USERSUP)                                            
         DC    C'SN',S(0),S(NEXTNUM)                                            
         DC    C'OC',S(AC_OFF),S(0)                                             
         DC    C'OF',S(AC_OFF),S(0)                                             
         DC    C'O2',S(0),S(GETOF2)                                             
         DC    C'OG',S(0),S(GETOFG)                                             
         DC    C'CY',S(AC_TODYF+1),S(0)                                         
NUMOYQ   DC    C'OY',S(OPEN+1),S(0)                                             
         DC    C'NA',S(SPACES),S(0)                                             
         DC    X'FF',S(20(R4)),S(0)                                             
*                                                                               
SRCHTBL  DS    0XL1                                                             
         DC    B'11100000'         Client/product/media                         
         DC    B'11010000'         Client/product/media group                   
         DC    B'11000000'         Client/product                               
         DC    B'10100000'         Client/media                                 
         DC    B'10010000'         Client/media group                           
         DC    B'10000000'         Client                                       
         DC    B'00101000'         Media/office                                 
         DC    B'00011000'         Media group/office                           
         DC    B'00001000'         Office                                       
         DC    B'00100100'         Office group/media                           
         DC    B'00010100'         Office group/media group                     
         DC    B'00000100'         Office group                                 
         DC    B'00100000'         Media                                        
         DC    B'00010000'         Media group                                  
         DC    B'00000000'         Company level                                
         DC    X'FF'                                                            
         EJECT                                                                  
***********************************************************************         
*              GET NEXT SEQUENTIAL NUMBER FOR JOB                     *         
***********************************************************************         
         SPACE 1                                                                
         USING JNAELD,R4                                                        
GETSEQ   NTR1                                                                   
         L     R3,ASEQNUM          GET STARTING POSTION IN JOB KEY              
         OC    SAVEPY,SAVEPY       RESETTING IN USE?                            
         JZ    GETS02                                                           
         L     RE,SAVEPY           ENSURE CURR YEAR BEFORE SEQ NUMBER           
         LR    RF,R3                                                            
         SR    RF,RE                                                            
         CHI   RF,1                                                             
         BE    GETS02              OK                                           
         XC    SAVEPY,SAVEPY       NOT OK (SET TO   NOT IN USE)                 
*                                                                               
GETS02   MVC   START#,JNASTRT      NEED START TO DETERMINE LENGTH               
         GOTO1 VSQUASH,DMCB,START#,L'START#                                     
         XR    R2,R2                                                            
         IC    R2,DMCB+7           LENGTH OF SEQUENTIAL PORTION                 
         BCTR  R2,0                                                             
*                                                                               
         CLC   JNALNUM,SPACES      IS THIS OUR FIRST TIME ?                     
         JH    GETS06              NO, NEXT LAST # USED                         
*                                                                               
GETS04   MVC   0(0,R3),START#      YES, USE  STARTING #                         
         EX    R2,*-6                                                           
         J     GETS18                                                           
*                                                                               
GETS06   XR    R1,R1                                                            
         IC    R1,LDGAL2                                                        
         AR    R1,R3                                                            
         LA    RF,AC_ACTL3                                                      
         SR    R1,RF                                                            
         LA    R1,JNALNUM(R1)                                                   
         MVC   NEXT#,SPACES                                                     
         MVC   NEXT#(0),0(R1)                                                   
         EX    R2,*-6                                                           
*                                                                               
         OC    SAVEPY,SAVEPY       RESETTING  IN USE?                           
         BZ    GETS10                                                           
         TM    FJBIND,FJBIREP      FIRST TIME?                                  
         BNZ   GETS10                                                           
         OI    FJBIND,FJBIREP                                                   
         LR    RE,R1                                                            
         BCTR  RE,0                POINT TO YEAR                                
         CLC   0(1,RE),OPEN+1      AND TEST CURRENT YEAR                        
         BE    GETS10              (IF CURRENT GO ON)                           
         J     GETS04              THEN USE START NUMBER                        
*                                  CHECK FOR OVERFLOW                           
GETS10   EX    R2,*+8                                                           
         J     *+10                                                             
         CLC   NEXT#(0),=CL5'99999'  THIS IS ALWAYS OVERFLOW                    
         BE    GETS12                                                           
         OC    JNAEND,JNAEND                                                    
         BZ    GETS14              NO END TO SEQUENCE                           
         EX    R2,*+8              IF NEXT WILL BE OVERFLOW - ERROR             
         J     *+10                                                             
         CLC   NEXT#(0),JNAEND                                                  
         BNE   GETS14                                                           
GETS12   MVC   ROUERRV,=AL2(AE$AUTCM)                                           
         J     EXITN                                                            
*                                                                               
GETS14   EX    R2,*+8               ADD ONE TO SEQUENTIAL                       
         J     *+10                                                             
         PACK  DUB,NEXT#(0)                                                     
         AP    DUB,=P'1'                                                        
*                                                                               
         UNPK  WORK5,DUB           SHIFT OUTPUT TO LEFT                         
         LA    R1,WORK5+L'WORK5-1                                               
         SR    R1,R2                                                            
         EX    R2,*+8                                                           
         J     *+10                                                             
         MVC   NEXT#(0),0(R1)                                                   
*                                                                               
         LA    R1,NEXT#(R2)        FIX THE SIGN                                 
         OI    0(R1),X'F0'                                                      
*                                                                               
         EX    R2,*+8              MUST NOT BE IN MANUAL RANGE                  
         J     *+10                                                             
         CLC   NEXT#(0),JNAMANS                                                 
         BL    GETS16                                                           
         BE    GETS10                                                           
*                                                                               
         EX    R2,*+8                                                           
         J     *+10                                                             
         CLC   NEXT#(0),JNAMANE                                                 
         BNH   GETS10                                                           
*                                                                               
GETS16   EX    R2,*+8                                                           
         J     *+10                                                             
         MVC   0(0,R3),NEXT#       VALID NUMBER, UPDATE JNUM RECORD             
         EX    R2,*+8              IF NEXT WILL BE OVERFLOW - ERROR             
         J     *+10                                                             
         CLC   NEXT#(0),JNAEND     IF USING THE LAST ONE                        
         BNE   GETS18                                                           
         L     RE,AIO7             SET RECORD AS INACTIVE                       
         OI    AJNRSTA-AJNKEY(RE),AJNNDACT                                      
         J     EXITN                                                            
*                                                                               
GETS18   J     EXITY                                                            
         DROP  R4                                                               
*                                                                               
***********************************************************************         
* Validate Media code - ANYACCNT has media code at job pos            *         
***********************************************************************         
         SPACE 1                                                                
VALMED   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*VALMED*'                                                      
         LA    R2,IOKEY                                                         
         XC    AC_MEDGR,AC_MEDGR                                                
         USING PMDRECD,R2                                                       
         MVC   PMDKEY,SPACES                                                    
         MVI   PMDKTYP,PMDKTYPQ                                                 
         MVC   PMDKCPY,CUXCPY                                                   
         LLC   RE,LDGAL2                                                        
         LA    R1,ANYACCD(RE)                                                   
         MVC   PMDKMED,0(R1)                                                    
         MVC   AC_MEDIA,0(R1)                                                   
         OC    QA_NMED,QA_NMED     Have we got a new media code                 
         JZ    VMED002             No                                           
         MVC   PMDKMED,QA_NMED                                                  
         MVC   AC_MEDIA,QA_NMED                                                 
VMED002  GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    VMED004                                                          
         GOTOR SAVERR,DMCB,=AL2(AE$MMR),0,=AL2(FLD003)                          
         J     VMEDN                                                            
*                                                                               
VMED004  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    VMED006                                                          
         DC    H'0'                                                             
VMED006  L     R2,AIO1                                                          
         LA    R3,PMDRFST                                                       
         USING PMDELD,R3                                                        
VMED008  CLI   PMDEL,0                                                          
         JE    VMEDY                                                            
         CLI   PMDEL,PMDELQ                                                     
         JE    VMED010                                                          
         LLC   RE,PMDLN                                                         
         AR    R3,RE                                                            
         J     VMED008                                                          
*                                                                               
VMED010  MVC   AC_MEDGR,PMDGRP     Save media group code                        
*                                                                               
VMEDY    J     EXITY                                                            
                                                                                
VMEDN    J     EXITN                                                            
         EJECT                                                                  
***********************************************************************         
* Validate Office code - AC_OFF has office code from client or prod   *         
***********************************************************************         
         SPACE 1                                                                
GETOGR   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GETOGR*'                                                      
         LA    R2,IOKEY                                                         
         USING OGRRECD,R2                                                       
         XC    OGRKEY,OGRKEY                                                    
         MVI   OGRKTYP,OGRKTYPQ                                                 
         MVI   OGRKSUB,OGRKOFFQ                                                 
         MVC   OGRKCPY,CUXCPY                                                   
         MVC   OGRKUNT(L'PRODUL),PRODUL                                         
         MVC   OGRKOFC,0(R1)                                                    
GOGR002  GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    GOGR004                                                          
         MVC   ROUERRV,=AL2(AE$INVPO)                                           
         J     GOGRN                                                            
*                                                                               
GOGR004  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    GOGR006                                                          
         DC    H'0'                                                             
GOGR006  L     R2,AIO1                                                          
         LA    R3,OGRRFST                                                       
         USING PGRELD,R3                                                        
         LA    R1,SPACES           Return spaces if no PGREL                    
GOGR008  CLI   PGREL,0                                                          
         JE    GOGRY                                                            
         CLI   PGREL,PGRELQ                                                     
         JE    GOGR010                                                          
         LLC   RE,PGRLN                                                         
         AR    R3,RE                                                            
         J     GOGR008                                                          
*                                                                               
GOGR010  LA    R1,PGRCODE          Return office group code                     
*                                                                               
GOGRY    J     EXITYR1                                                          
                                                                                
GOGRN    J     EXITN                                                            
         EJECT                                                                  
         DROP  R2                                                               
***********************************************************************         
* Validate QA_OFFC, for upload tool                                             
***********************************************************************         
         SPACE 1                                                                
         USING ACTRECD,R2                                                       
VALOFF   NTR1  LABEL=*,BASE=*                                                   
         CLI   QA_UPLD,QA_SAPTL    If not SAP upload tool just call             
         JNE   VOFF045             offal                                        
         CLC   QA_OFFC,SPACES                                                   
         JNH   VOFF055                                                          
*                                  Convert SAP equivalent to DDS                
         XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,TWODUL                                                    
         GOTOR (#SETLDG,ASETLDG)                                                
         LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(L'TWODUL),TWODUL                                         
*                                                                               
VOFF005  GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         JE    VOFF015                                                          
         DC    H'0'                                                             
*                                                                               
VOFF010  GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO1'                               
         JE    *+6                 Read all 2D records                          
         DC    H'0'                                                             
*                                                                               
VOFF015  LA    R2,IOKEY                                                         
         CLC   ACTKUNT(L'ACTKUNT+L'ACTKLDG),TWODUL                              
         JE    VOFF020                                                          
         GOTOR SAVERR,DMCB,=AL2(AE$OFEQV),(5,=C'EC023'),0                       
         OI    TWAMODE,TWAMUWD     Invalid office equivalent                    
         J     EXITN                                                            
*                                                                               
VOFF020  LLC   RF,LDGAL1                                                        
         LA    RF,ACTKACT(RF)                                                   
         CLI   0(RF),C' '          Is this a low level account                  
         JNH   VOFF025                                                          
         MVI   0(RF),X'FF'         Force to read next                           
         J     VOFF005                                                          
*                                                                               
VOFF025  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO1                                                          
         LA    RF,ACTRFST                                                       
*                                                                               
         USING FFTELD,RF                                                        
VOFF030  CLI   FFTEL,0                                                          
         JE    VOFF010                                                          
         CLI   FFTEL,FFTELQ                                                     
         JE    VOFF040                                                          
VOFF035  LLC   R0,FFTLN                                                         
         AR    RF,R0                                                            
         J     VOFF030                                                          
*                                                                               
VOFF040  CLI   FFTTYPE,FFTTEPTR    Equivalent type pointer                      
         JNE   VOFF035                                                          
         CLI   FFTSEQ,1                                                         
         JNE   VOFF035                                                          
         CLC   FFTDATA(L'QA_OFFC),QA_OFFC  Found correct equivalent?            
         JNE   VOFF035                                                          
*                                                                               
         MVC   QA_OFFC,SPACES      Replace input office with DDS office         
         MVC   QA_OFFC(L'TRNKOFF),ACTKACT  code                                 
         GOTOR GETOGR,QA_OFFC      OFFICE ON FILE?                              
         JE    VOFF045                                                          
         GOTOR SAVERR,DMCB,=AL2(AE$INVPO),(5,=C'EC023'),=AL2(FLD093)            
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
         DROP  RF                                                               
* back to validating office                                                     
VOFF045  CLC   LDGAUL,ANYACCNT                                                  
         JE    VOFF046                                                          
         MVC   LDGAUL,ANYACCNT      RESET LEDGER VALUES                         
         GOTOR (#SETLDG,ASETLDG)                                                
VOFF046  CLI   LDGAOP,LDGOTRAN                                                  
         JE    VALOFFY                                                          
         CLI   LDGAOP,LDGONKHI      IF OFFICE IN KEY, CHECK MATCHES             
         JH    VOFF055                                                          
         MVC   WORK(1),LDGAOP                                                   
         NI    WORK,FF-LDGOKEY2                                                 
         XR    R1,R1                                                            
         IC    R1,WORK                                                          
         LA    R1,ANYACCNT+(ACTKACT-ACTRECD-2)(R1)                              
         MVC   WORK(2),0(R1)                                                    
         MVC   WORK+2(2),QA_OFFC                                                
         OC    WORK(4),SPACES                                                   
         TM    LDGAOP,LDGOKEY2                                                  
         JNZ   VOFF050                                                          
         MVI   WORK+1,C' '                                                      
VOFF050  CLC   WORK(L'TRNOFFC),WORK+L'TRNOFFC  QA_OFFC IS NOW 4CHAR             
         JE    VOFF055                                                          
         GOTOR SAVERR,DMCB,=AL2(AE$IVPOL),(5,=C'EC024'),=AL2(FLD093)            
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
*  OFFAL                                                                        
         USING OFFALD,R1                                                        
VOFF055  CLC   QA_OFFC,SPACES      Do we have an office                         
         JH    VOFF056                                                          
         CLC   PRODUL,QA_UNIT      Is it SJ new cli level?                      
         JNE   VOFF056                                                          
         TM    AC_IND1,AC_INEW1                                                 
***      JZ    VOFF056             *** DSRD-4051                                
         JZ    VALOFFY                                                          
         TM    CPYSTAT1,CPYSOROE   Do we use offices?                           
         JNZ   *+12                                                             
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    VALOFFY             Then no input is ok                          
         GOTOR SAVERR,DMCB,=AL2(AE$IOFCQ),(5,=C'EC112'),=AL2(FLD093)            
         J     VALOFFN                                                          
*                                                                               
VOFF056  CLI   QA_UPLD,QA_SAPTL    If not SAP upload tool just call             
         JE    VOFF060             offal                                        
*                                                                               
         TM    CPYSTAT4,CPYSOFF2   Is it 2 char office?                         
         JNZ   *+12                                                             
         CLI   QA_OFFC+1,C' '      Office too long?                             
         JH    VOFFIN2O                                                         
*                                  Check 2D account exists                      
         LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(L'TWODUL),TWODUL                                         
         MVC   ACTKACT(L'QA_OFFC),QA_OFFC                                       
         OC    ACTKACT,SPACES                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JNE   VOFFINVO            Must exist                                   
*                                                                               
VOFF060  L     R1,AOFFAREA         Call offal to check office valid             
         MVC   OFFAOFFC,QA_OFFC    for logon                                    
         OC    OFFAOFFC,SPACES                                                  
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL              Validate office code                         
         JE    VOFF070                                                          
         TM    OFFAERR,OFFAESEC    Security lockout?                            
         JZ    VOFF065                                                          
         GOTOR SAVERR,DMCB,=AL2(AE$SECLK),(5,=C'EC025'),=AL2(FLD093)            
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
*                                                                               
VOFF065  TM    OFFAERR,OFFAEOFF    Invalid office                               
         JNZ   VOFFINVO                                                         
         DC    H'0'                die on other errors EOF/disk error           
*                                                                               
VOFF070  CLI   QA_UPLD,QA_SAPTL    If not SAP upload tool just call             
         JE    VOFF075             offal                                        
         CLI   QA_ASTAT,QA_ANEW    ON CHANGE CHECK FOR POSTINGS/TIME            
         JE    VOFF075                                                          
         CLC   AC_OFF,QA_OFFC                                                   
         JE    VOFF075                                                          
         GOTOR CHKACT,CHKOFFC                                                   
         JE    VOFF075                                                          
         GOTOR SAVERR,DMCB,ROUERRV,(5,=C'EC026'),=AL2(FLD093)                   
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
*                                                                               
* ??? SECRET CALL                                                               
VOFF075  DS    0H                                                               
*                                                                               
VALOFFY  J     EXITY                                                            
                                                                                
VALOFFN  J     EXITN                                                            
*                                  Agency not on 2 char offices                 
VOFFIN2O GOTOR SAVERR,DMCB,=AL2(AE$N2OFF),(5,=C'EC025'),=AL2(FLD093)            
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
*                                  Invalid office                               
VOFFINVO GOTOR SAVERR,DMCB,=AL2(AE$IVOFF),(5,=C'EC116'),=AL2(FLD093)            
         OI    TWAMODE,TWAMUWD                                                  
         J     EXITN                                                            
         DROP  R1,R2                                                            
         EJECT                                                                  
***********************************************************************         
* Validate DEBTOR/COSTING fields - build tsar if changes needed                 
***********************************************************************         
         SPACE 1                                                                
VDEBCOST NTR1  LABEL=*,BASE=*                                                   
*                                                                               
* ANY DEBTOR TO VALIDATE?                                                       
         CLC   QA_DRACT,SPACES                                                  
         JH    VDCST002                                                         
*NO DEBTOR - OK?                                                                
         CLI   QA_UPLD,QA_SAPTL    SAP tool or account upload                   
         JE    *+12                                                             
         CLI   QA_UPLD,QA_ACCTL                                                 
         JNE   VDCST060            OK if BrO - go check costing                 
         CLC   QA_UNIT(2),SCPYEL+(CPYPROD-CPYEL)                                
         JNE   VDCST000            MISSING OK IF NOT SJ                         
         TM    AC_IND1,AC_INEW1                                                 
         JZ    VDCST000            OR PRODUCT/JOB                               
         GOTOR SAVERR,DMCB,=AL2(AE$MDEBA),(5,=C'EC027'),=AL2(FLD096)            
         J     VDCST060                                                         
*                                                                               
VDCST000 CLI   QA_UPLD,QA_SAPTL    SAP tool auto builds debtor acc              
         JE    VDCST060                                                         
         ICM   R1,7,QA_SREQU       List of type/code pairs                      
         JZ    VDCST060                                                         
         XR    R0,R0               Any equivalents passed?                      
         ICM   R0,3,LW_NUMN-LW_D(R1)                                            
         JZ    VDCST060                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$DCNBP),(5,=C'EC119'),=AL2(FLD096)            
         J     VDCST060            Can't pass debtor equiv if no debtor         
*                                                                               
VDCST002 MVC   DR_DRACL(DR_DRFLI-DR_DRACL),QA_DRACL                             
         MVC   DR_DRNML(L'DR_DRNML+L'DR_DRNAM),QA_DRNML                         
         MVC   DR_DRFLI(L'DR_DRFLI+L'DR_ADRFL),QA_DRFLI                         
         CLI   QA_UPLD,QA_SAPTL                                                 
         JNE   VDCST005            BrO has validated account                    
         CLC   QA_UNIT(2),SCPYEL+(CPYPROD-CPYEL)                                
         JE    VDCST004                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$ILGSJ),(5,=C'EC028'),0                       
         J     VDCST060                                                         
*                                                                               
VDCST004 DS    0H                                                               
         CLC   DR_DRACT(2),SCPYEL+(CPYRECV-CPYEL)                               
         JE    VDCST005                                                         
         CLC   DR_DRACT(2),=C'SQ'                                               
         JE    VDCST005                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$ILGSR),(5,=C'EC029'),=AL2(FLD096)            
         J     VDCST060            ??? DO REST OF VAL?                          
*                                                                               
VDCST005 DS    0H                                                               
         GOTOR CODECHK,DR_DRACT+2                                               
         JNE   VDCST060                                                         
         MVC   LDGAUL,DR_DRACT                                                  
         MVI   BYTE4,0                                                          
         GOTOR (#SETLDG,ASETLDG)                                                
* SR EQUIVALENTS                                                                
         CLC   DR_DRACT(2),ONECUL  Skip for costing                             
         JE    VDCST08F                                                         
*                                                                               
         LA    R4,SREQTAB                                                       
         LR    R0,R4               Clear table of rules for ledger              
         LHI   R1,L'SREQTAB                                                     
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         MVI   0(R4),X'FF'                                                      
*                                                                               
         L     R1,AIO1                                                          
         LA    R1,LDGRFST-LDGRECD(R1)                                           
         USING LDGELD,R1                                                        
VDCST08A CLI   LDGEL,0                                                          
         JE    VDCST08F                                                         
         CLI   LDGEL,APRELQ        Extract account equivalent rule(s)           
         JE    VDCST08C                                                         
VDCST08B LLC   RE,LDGLN                                                         
         AR    R1,RE                                                            
         J     VDCST08A                                                         
*                                                                               
* BUILD EQUIVALENTS                                                             
*                                                                               
         USING APRELD,R1                                                        
         USING EQRULTBD,R4                                                      
VDCST08C MVC   EQRLSEQ,APRSEQ      Sequence number of rule                      
         MVC   EQRLLEN,APRTLEN     Total length of rule                         
         MVC   EQRLNLVS,APRNLEVS # levels                                       
         MVC   EQRLNAME,APRDESC    Account equivalent name                      
         XR    RF,RF                                                            
         IC    RF,APRNLEVS         # levels                                     
         LA    RE,APRMLEN          1st level                                    
VDCST08D XR    R0,R0               Look for lowest level                        
         IC    R0,0(RE)                                                         
         CHI   RF,1                                                             
         JE    VDCST08E                                                         
         AHI   RE,L'APRMLEN                                                     
         AR    RE,R0                                                            
         SHI   RF,1                                                             
         J     VDCST08D                                                         
VDCST08E XR    RF,RF               Calculate minimum variable length            
         IC    RF,EQRLLEN                                                       
         SR    RF,R0                                                            
         AHI   RF,1                So lowest level has minimum 1 byte           
         STC   RF,EQRMVLN                                                       
         LA    RE,APRDESC+L'APRDESC-1                                           
         CLI   0(RE),C' '          Find last character of name                  
         JH    *+8                                                              
         JCT   RE,*-8                                                           
         LA    RF,APRDESC                                                       
         SR    RE,RF                                                            
         JNM   *+6                                                              
         DC    H'0'                No account equivalent name                   
         LA    RE,1(,RE)                                                        
         STC   RE,EQNMLEN          L'account equivalent name                    
         IC    RE,APRLN                                                         
         SHI   RE,APRLN1Q+1        RE=L'(All rules+lengths)-1                   
         BASR  RF,0                                                             
         MVC   EQRLRULE(0),APRMLEN Save length/rule                             
         EX    RE,0(RF)                                                         
         LA    R4,EQRLLNQ(,R4)     Next table entry                             
         MVI   0(R4),X'FF'         Set EOT                                      
         J     VDCST08B            Next element                                 
         DROP  R1,R4                                                            
*                                                                               
* CHECK LOW LEVEL ACC                                                           
VDCST08F LA    R6,LDGAL1           R6=A(LEVEL LENGTHS)                          
         LA    R0,1                R0=(LEVEL OF CODE INPUT ON SCREEN)           
         LLC   R7,DR_DRACL         L'ULA                                        
         SHI   R7,2                                                             
         SPACE 1                                                                
VDCST010 CLM   R7,1,0(R6)          FIND HIERARCHY LEVEL FOR ACCT CODE.          
         JNH   VDCST013                                                         
         LA    R6,1(R6)            BUMP TO LENGTH OF NEXT LEDGER LEVEL          
         AHI   R0,1                BUMP UP LEV OF CODE                          
         CHI   R0,4                MAX LEVEL ON LEDGER                          
         JNH   VDCST010                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$ALONG),(5,=C'EC030'),=AL2(FLD096)            
         J     VDCST015                                                         
         SPACE 1                                                                
VDCST013 CHI   R0,4                IF MAX LV THEN MUST BE LOWEST OF LOW         
         JE    VDCST015                                                         
         CLI   1(R6),0             OTHERWISE CHECK IF ITS THE LOWEST            
         JE    VDCST015                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$WLDCR),(5,=C'EC031'),=AL2(FLD096)            
* IF OFFPOS=/=T, MUST HAVE OFFICE LEVEL A/C ON FILE (MUST NOT ADD)              
VDCST015 DS    0H                                                               
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO1                                        
         CLC   DR_DRACT(2),=C'SQ'                                               
         JE    VDCST025            CANNOT ADD SQ ANYWAY                         
         CLI   LDGAOP,0                                                         
         JE    VDCST025            OFFICE NOT IN KEY                            
         XR    RE,RE               RE=LENGTH OF OFFICE                          
         LLC   RF,LDGAOP           RF=OFFICE POSITION                           
         CLI   LDGAOP,LDGOKEY                                                   
         JNH   VDCST020            L'1CO OFFPOS                                 
         CLI   LDGAOP,LDGONKHI                                                  
         JH    VDCST025            OFFICE NOT IN KEY                            
         MVC   WORK(1),LDGAOP      L'2CO OFFPOS                                 
         NI    WORK,X'FF'-LDGOKEY2                                              
         LLC   RF,WORK                                                          
         LHI   RE,1                                                             
*                                                                               
VDCST020 SHI   RF,1                                                             
*                                                                               
         LA    RF,DR_DRACT(RF)                                                  
         LA    R2,IOKEY            BUILD IT                                     
         USING ACTRECD,R2                                                       
         MVC   IOKEY,SPACES                                                     
         MVC   ACTKCPY,CUXCPY                                                   
         BASR  R1,0                                                             
         MVC   ACTKULA(0),0(RF)                                                 
         EX    RE,0(R1)                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    VDCST025                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$NOOFP),(5,=C'EC032'),=AL2(FLD096)            
*                                                                               
VDCST025 CLI   LDGAOP,1            OFFPOS=1?                                    
         JNE   VDCST028                                                         
         LA    R1,QA_OFFC                                                       
         TM    AC_IND1,AC_INEW1    Level 1 account?                             
         JNZ   VDCST02A                                                         
         CLC   QA_OFFC,SPACES      Any office passed?                           
         JH    VDCST02A                                                         
         CLC   AC_OFF,SPACES       Check for higher level office                
         JNH   VDCST028                                                         
         LA    R1,AC_OFF                                                        
*                                                                               
VDCST02A XR    RF,RF                                                            
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    *+8                                                              
         AHI   RF,1                                                             
*                                                                               
         BASR  RE,0                                                             
         CLC   0(0,R1),DR_DRACT+L'ACTKUNT+L'ACTKLDG                             
         EX    RF,0(RE)            Check 1C office matches client off           
         JE    VDCST028                                                         
*                                                                               
         CLC   ONECUL,DR_DRACT     Debtor or costing?                           
         JE    VDCST02B                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$WROFF),(5,=C'EC117'),=AL2(FLD096)            
         J     VDCST065                                                         
*                                                                               
VDCST02B GOTOR SAVERR,DMCB,=AL2(AE$WROFF),(5,=C'EC117'),=AL2(FLD099)            
         J     VDCST065            Costing                                      
*                                                                               
VDCST028 L     R7,AIO8                                                          
         USING T_D,R7                                                           
         XC    T_KEY(T_KEYL),T_KEY                                              
         MVI   T_ELEMS,0            TERMINATOR                                  
         MVI   T_ACCMED,T_ACCQ                                                  
         MVC   T_ULA,DR_DRACT                                                   
         OC    T_ULA,SPACES                                                     
         LHI   RF,T_RECLQ                                                       
         STH   RF,T_RECLEN                                                      
         OI    T_INDS,T_ILOWAC                                                  
*        CLI   QA_UPLD,QA_SAPTL    added lvl 25, but makes no sense             
*        JE    VDCST035            BrO has validated account                    
*                                                                               
         MVC   IOKEY,SPACES                                                     
         LA    R2,IOKEY                                                         
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA,T_ULA                                                    
         L     R1,=AL4(IORDD+IODIR+IO1)                                         
         GOTOR (#IOEXEC,AIOEXEC)                                                
         CLI   IOERR,IOERNF                                                     
         JNE   VDCST030                                                         
         MVI   T_ACTION,C'A'       NOT FOUND, ADD                               
         CLC   T_ULA(2),=C'SQ'     IF SQ, MUST EXIST                            
         JNE   VDCST035                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$ANFSQ),(5,=C'EC033'),=AL2(FLD096)            
         J     VDCST035                                                         
VDCST030 DS    0H                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    VDCST035                                                         
         DC    H'0'                                                             
*                                                                               
VDCST035 DS    0H                                                               
         GOTOR VALNAME             VALIDATE NAME AND UDPATE                     
         GOTOR VALRFILT            VALIDATE FILTERS AND UPDATE                  
         CLC   DR_DRACT(L'SRUL),SRUL                                            
         JNE   VDCST038                                                         
         GOTOR VALDEQV             VALIDATE DEBTOR EQUIVALENTS                  
         GOTOR ADDSRQV             ADD EQUIVALENTS TO TSAR                      
VDCST038 L     R2,AIO3             MAIN REC (NEW) ADDR                          
         GOTOR VHELLO,DMCB,(C'G',ACCMST),('ADRELQ',(R2)),0                      
         JNE   VDCST041            NOTHING TO DO                                
         L     R4,12(R1)                                                        
         CLI   T_ACTION,C'A'                                                    
         JE    VDCST040                                                         
         L     R2,AIO1             OLD DEBTOR                                   
         GOTOR VHELLO,DMCB,(C'G',ACCMST),('ADRELQ',(R2)),0                      
         JNE   VDCST040                                                         
         L     R1,12(R1)                                                        
         USING ADRELD,R4                                                        
         CLC   ADRLN,1(R1)                                                      
         JNE   VDCST040                                                         
         LLC   RF,ADRLN                                                         
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         CLC   ADREL(0),0(R1)                                                   
         EX    RF,0(RE)                                                         
         JE    VDCST041            NO CHANGE                                    
*                                                                               
VDCST040 DS    0H                                                               
         SR    R1,R1                                                            
         LH    R1,T_RECLEN                                                      
         SHI   R1,1                                                             
         AR    R1,R7                                                            
         LLC   RE,ADRLN                                                         
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   0(0,R1),ADREL                                                    
         EX    RE,0(RF)                                                         
         LA    RE,1(RE)                                                         
         AR    R1,RE                                                            
         MVI   0(R1),0             NEW TERMINATOR                               
         LH    R1,T_RECLEN                                                      
         AR    R1,RE                                                            
         STH   R1,T_RECLEN                                                      
         DROP  R4                                                               
*                                                                               
         USING SCITABD,R6                                                       
VDCST041 CLC   DR_DRACT(2),ONECUL  Only for debtor accounts                     
         JE    VDCST044                                                         
         LA    R6,SCITAB                                                        
*                                                                               
VDCST04A TM    SCITIND1,SCITDEB    Want to add this for debtor accs?            
         JZ    VDCST04D                                                         
         XC    BYTE1,BYTE1                                                      
         XC    ELEMENT,ELEMENT                                                  
         XC    AELEMENT,AELEMENT                                                
         MVC   BYTE1,SCITYP                                                     
         XR    R5,R5                                                            
         LH    R5,SCIADRAM                                                      
         AR    R5,R8                                                            
*                                                                               
         CLI   T_ACTION,C'A'       If adding don't compare                      
         JE    VDCST04B                                                         
         L     R2,AIO1             OLD DEBTOR                                   
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('SCIELQ',(R2)),(1,BYTE1)              
         CLI   12(R1),0            Does element exist                           
         JNE   VDCST04B            No                                           
         L     R3,12(R1)           Yes - store address                          
OLD      USING SCIELD,R3                                                        
*                                                                               
         OC    0(L'SCIAMNT,R5),0(R5) Do we have a value                         
         JZ    VDCST04B            No - audit delete                            
         CP    OLD.SCIAMNT,0(L'SCIAMNT,R5) Yes - is value the same              
         JE    VDCST04D            Yes - nothing to do                          
                                                                                
         USING SCIELD,R3                                                        
VDCST04B OC    0(L'SCIAMNT,R5),0(R5)                                            
         JZ    VDCST04D            Any value passed?                            
         LA    R3,ELEMENT                                                       
         MVI   SCIEL,SCIELQ                                                     
         MVI   SCILN,SCILN1Q                                                    
         MVC   SCITYPE,BYTE1                                                    
         ZAP   SCIAMNT,0(L'SCIAMNT,R5)                                          
         LLH   R1,T_RECLEN                                                      
         SHI   R1,1                                                             
         AR    R1,R7                                                            
         LLC   RE,SCILN                                                         
         BCTR  RE,0                                                             
         BASR  RF,0                                                             
         MVC   0(0,R1),SCIELD                                                   
         EX    RE,0(RF)                                                         
         LA    RE,1(RE)                                                         
         AR    R1,RE                                                            
         MVI   0(R1),0             NEW TERMINATOR                               
         LH    R1,T_RECLEN                                                      
         AR    R1,RE                                                            
         STH   R1,T_RECLEN                                                      
*                                                                               
VDCST04D LA    R6,SCITABL(R6)                                                   
         CLI   SCITIND1,X'FF'                                                   
         JNE   VDCST04A                                                         
*                                                                               
         USING FFTTABD,R6                                                       
         LA    R6,FFTTAB                                                        
         XC    BYTE1,BYTE1                                                      
*                                                                               
VDCST04E TM    FFTTIND1,FFTTDEB    Want to add this for debtor accs?            
         JZ    VDCST04I                                                         
         XC    ELEMENT,ELEMENT                                                  
         MVC   BYTE1,FFTTYP                                                     
         XR    R5,R5                                                            
         LH    R5,FFTTADRT                                                      
         AR    R5,R8                                                            
*                                                                               
         USING FFTELD,R3                                                        
VDCST04F LA    R3,ELEMENT                                                       
         OC    0(1,R5),0(R5)                                                    
         JZ    VDCST04I                                                         
         MVI   FFTEL,FFTELQ                                                     
         MVC   FFTTYPE,BYTE1                                                    
         MVC   FFTDLEN,0(R5)                                                    
         LLC   RF,0(R5)                                                         
         SHI   RF,1                                                             
*&&UK                                                                           
         CLI   FFTTYP,FFTTG13B                                                  
         JNE   VDCST04G                                                         
         STC   RF,FFTDLEN                                                       
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   FFTDATA(0),2(R5)                                                 
         EX    RF,0(RE)                                                         
         AHI   RF,FFTLN1Q+2                                                     
         STC   RF,FFTLN                                                         
         J     VDCST04H                                                         
*&&                                                                             
VDCST04G BASR  RE,0                                                             
         MVC   FFTDATA(0),1(R5)                                                 
         EX    RF,0(RE)                                                         
         AHI   RF,FFTLN1Q+2                                                     
         STC   RF,FFTLN                                                         
*                                                                               
VDCST04H LLH   R1,T_RECLEN                                                      
         SHI   R1,1                                                             
         AR    R1,R7                                                            
         LLC   RE,FFTLN                                                         
         BCTR  RE,0                                                             
         BASR  RF,0                                                             
         MVC   0(0,R1),FFTELD                                                   
         EX    RE,0(RF)                                                         
         LA    RE,1(RE)                                                         
         AR    R1,RE                                                            
         MVI   0(R1),0             NEW TERMINATOR                               
         LH    R1,T_RECLEN                                                      
         AR    R1,RE                                                            
         STH   R1,T_RECLEN                                                      
*                                                                               
VDCST04I LA    R6,FFTTABL(R6)                                                   
         CLI   FFTTIND1,X'FF'                                                   
         JNE   VDCST04E                                                         
*                                                                               
VDCST044 CLI   T_ACTION,C'A'                                                    
         JE    VDCST046            ADD, MUST PROCESS                            
         MVI   T_ACTION,C'C'                                                    
         LA    R2,AIO1             A(OLD REC)                                   
         TM    ACTRSTAT,ACTSDELT                                                
         JNZ   VDCST046            Deleted, must process to undelete            
         LH    RF,T_RECLEN                                                      
         CHI   RF,T_RECLQ                                                       
         JE    VDCST060            No changes, go do costing                    
*                                                                               
VDCST046 DS    0H                                                               
*  add to tsar if changed/new rec                                               
VDCST050 DS    0H                                                               
         GOTOR GOTSAR,DMCB,('TSAADD',0)                                         
         JE    *+6                                                              
         DC    H'0'                                                             
*                              **  For 1C add 29 account as well **             
         CLC   DR_DRACT(2),ONECUL  Only do for costing                          
         JNE   VDCST060                                                         
*                                                                               
         MVC   LDGAUL,DR_DRACT                                                  
*        MVC   LDGAUL(L'TWODUL),TWODUL                                          
         MVI   BYTE4,0                                                          
*                                                                               
         GOTOR (#SETLDG,ASETLDG)                                                
         CLI   LDGAOP,0                                                         
         JE    VDCST051            OFFICE NOT IN KEY                            
         XR    RE,RE               EX LENGTH FOR 1CO IN RE                      
         LLC   RF,LDGAOP           POSITION IN KEY (1CO)  IN RF                 
         CLI   LDGAOP,LDGOKEY                                                   
         JNH   VDCST05A            L'1CO OFFPOS                                 
         CLI   LDGAOP,LDGONKHI                                                  
         JH    VDCST051            OFFICE NOT IN KEY                            
         MVC   WORK(1),LDGAOP      L'2CO OFFPOS                                 
         NI    WORK,X'FF'-LDGOKEY2                                              
         LA    RE,1                EX LENGTH FOR 2CO                            
         LLC   RF,WORK             POSITION IN KEY (2CO)                        
*                                                                               
VDCST05A SHI   RF,1                                                             
*                                                                               
         LA    RF,DR_DRACT(RF)     A(OFFICE IN KEY) (R1 IS EX LENGTH)           
         LA    R2,IOKEY            BUILD 2D ACCOUNT                             
         USING ACTRECD,R2                                                       
         MVC   IOKEY,SPACES                                                     
         MVC   ACTKCPY,CUXCPY                                                   
         BASR  R1,0                                                             
         MVC   ACTKULA(0),0(RF)                                                 
         EX    RE,0(R1)                                                         
         MVC   ACTKULA(L'TWODUL),TWODUL                                         
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    VDCST051                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$NOOFP),(5,=C'EC032'),=AL2(FLD096)            
*                                                                               
         USING T_D,R7                                                           
VDCST051 L     R7,AIO8                                                          
         XC    T_KEY(T_KEYL),T_KEY                                              
         MVI   T_ELEMS,0           Terminator                                   
         MVI   T_ACCMED,T_ACCQ                                                  
         MVC   T_ULA,DR_DRACT                                                   
         MVC   T_ULA(L'TWONUL),TWONUL                                           
         OC    T_ULA,SPACES                                                     
         LHI   RF,T_RECLQ                                                       
         STH   RF,T_RECLEN                                                      
         OI    T_INDS,T_ILOWAC                                                  
*        CLI   QA_UPLD,QA_SAPTL    Added for lvl25, but makes no sense          
*        JE    VDCST052            BrO has validated account                    
*                                                                               
         MVC   IOKEY,SPACES                                                     
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO1                                        
         LA    R2,IOKEY                                                         
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA,T_ULA                                                    
         L     R1,=AL4(IORDD+IODIR+IO1)                                         
         GOTOR (#IOEXEC,AIOEXEC)                                                
         CLI   IOERR,IOERNF                                                     
         JNE   *+12                                                             
         MVI   T_ACTION,C'A'       NOT FOUND, ADD                               
         J     VDCST052                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    VDCST052                                                         
         DC    H'0'                                                             
*                                                                               
VDCST052 GOTOR VALNAME             VALIDATE NAME AND UDPATE                     
         GOTOR VALRFILT            VALIDATE FILTERS AND UPDATE                  
         L     R2,AIO3             MAIN REC (NEW) ADDR                          
         GOTOR VHELLO,DMCB,(C'G',ACCMST),('ADRELQ',(R2)),0                      
         JNE   VDCST058            NOTHING TO DO                                
         L     R4,12(R1)                                                        
         CLI   T_ACTION,C'A'                                                    
         JE    VDCST056                                                         
         L     R2,AIO1             OLD DEBTOR                                   
         GOTOR VHELLO,DMCB,(C'G',ACCMST),('ADRELQ',(R2)),0                      
         JNE   VDCST056                                                         
         L     R1,12(R1)                                                        
         USING ADRELD,R4                                                        
         CLC   ADRLN,1(R1)                                                      
         JNE   VDCST056                                                         
         LLC   RF,ADRLN                                                         
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         CLC   ADREL(0),0(R1)                                                   
         EX    RF,0(RE)                                                         
         JE    VDCST058            NO CHANGE                                    
*                                                                               
VDCST056 DS    0H                                                               
         SR    R1,R1                                                            
         LH    R1,T_RECLEN                                                      
         SHI   R1,1                                                             
         AR    R1,R7                                                            
         LLC   RE,ADRLN                                                         
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   0(0,R1),ADREL                                                    
         EX    RE,0(RF)                                                         
         LA    RE,1(RE)                                                         
         AR    R1,RE                                                            
         MVI   0(R1),0             NEW TERMINATOR                               
         LH    R1,T_RECLEN                                                      
         AR    R1,RE                                                            
         STH   R1,T_RECLEN                                                      
         DROP  R4                                                               
*                                                                               
VDCST058 CLI   T_ACTION,C'A'                                                    
         JE    VDCST059            ADD, MUST PROCESS                            
         MVI   T_ACTION,C'C'                                                    
         LA    R2,AIO1             A(OLD REC)                                   
         TM    ACTRSTAT,ACTSDELT                                                
         JNZ   VDCST059            DELETED, MUST PROCESS TO UNDELETE            
         LH    RF,T_RECLEN                                                      
         CHI   RF,T_RECLQ                                                       
         JE    VDCST060            NO CHANGES, GO DO COSTING                    
*  add to tsar if changed/new rec                                               
VDCST059 DS    0H                                                               
         GOTOR GOTSAR,DMCB,('TSAADD',0)                                         
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
* validate costing acc/name/filt                                                
VDCST060 DS    0H                                                               
* HAVE COSTING?                                                                 
         CLC   QA_CSACT,SPACES                                                  
         JH    VDCST063                                                         
         CLI   QA_UPLD,QA_SAPTL    SAP tool or account upload                   
         JE    *+12                                                             
         CLI   QA_UPLD,QA_ACCTL                                                 
         JNE   VDCST065            OK IF BrO                                    
         CLC   QA_UNIT(2),SCPYEL+(CPYPROD-CPYEL)                                
         JNE   VDCST065            MISSING OK IF NOT SJ                         
         TM    AC_IND1,AC_INEW1    ONLY COMPULSORY IF NEW CLIENT                
         JZ    VDCST065                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$MIACC),(5,=C'EC034'),=AL2(FLD099)            
         J     VDCST065                                                         
*                                                                               
* YES, DONE ALREADY?                                                            
VDCST063 CLC   DR_DRACT(2),ONECUL                                               
         JE    VDCST065                                                         
         CLC   QA_CSACT,SPACES     Any costing account passed?                  
         JNH   VDCST065                                                         
         LLC   RF,QA_CSACL                                                      
         LA    RF,2(RF)                                                         
         STC   RF,DR_DRACL                                                      
         MVC   DR_DRACT(2),ONECUL  SENT AS ACC, MAKE ULA TO MATCH DR            
         MVC   DR_DRACT+2(L'QA_CSACT),QA_CSACT                                  
         MVC   DR_DRNML(L'DR_DRNML+L'DR_DRNAM),QA_CSNML                         
         MVC   DR_DRFLI(L'DR_DRFLI+L'DR_ADRFL),QA_CSFLI                         
         CLI   QA_UPLD,QA_SAPTL    If SAP tool or accounting upload             
         JE    *+12                tool                                         
         CLI   QA_UPLD,QA_ACCTL                                                 
         JNE   VDCST005            BrO has validated account                    
         CLC   QA_UNIT(2),SCPYEL+(CPYPROD-CPYEL)                                
         JE    VDCST064            OK IF SJ                                     
         GOTOR SAVERR,DMCB,=AL2(AE$INLDG),(5,=C'EC035'),=AL2(FLD099)            
         J     VDCST065                                                         
*                                                                               
VDCST064 TM    AC_IND1,AC_INEW3    Is it new job record?                        
         JZ    VDCST005                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$INVIF),(5,=C'EC099'),=AL2(FLD099)            
         J     VDCST065            Not allowed at job level                     
*                                                                               
* CLEAR UP AND EXIT                                                             
VDCST065 CLC   LDGAUL,QA_UNIT      RESET LEDGER VALUES IF NECC                  
         JE    EXITY                                                            
         MVC   LDGAUL,QA_UNIT                                                   
         MVI   BYTE4,0                                                          
         GOTOR (#SETLDG,ASETLDG)                                                
         J     EXITY                                                            
         DROP  R2,R7                                                            
         EJECT                                                                  
***********************************************************************         
* update DEBTOR/COSTING record from a tsar rec                                  
***********************************************************************         
         SPACE 1                                                                
UDEBCOST NTR1  LABEL=*,BASE=*                                                   
*                                                                               
         L     RE,AIO1                                                          
         LA    RF,1000                                                          
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
         L     R7,AIO8                                                          
         USING T_D,R7                                                           
*                                                                               
         MVI   AC_IND2,0                                                        
         TM    T_INDS,T_ILOWAC                                                  
         JZ    *+8                                                              
         OI    AC_IND2,AC_ILOW                                                  
         MVI   IOINDS1,IO1XSWCH    Don't switch back to media                   
*                                                                               
         CLI   T_ACTION,C'A'                                                    
         JNE   UDCST020                                                         
*                                                                               
* ADD IF NOT ON FILE - BUILD NEW REC                                            
         MVC   OA_ULA,T_ULA                                                     
         GOTOR BLDACT,DMCB,(X'FF',AIO1)                                         
         L     R2,AIO1                                                          
         USING ACTRECD,R2                                                       
         MVC   ACTRSAF1(ACTRSOFF-ACTRSAF1),SPACES                               
*        MVC   ACTRSOFF,SPACES                                                  
         LHI   RF,(ACTRFST-ACTKEY)                                              
         STH   RF,ACTRLEN                                                       
*                                                                               
         LA    R4,T_ELEMS          ADD ELEMS TO RECORD                          
         USING RSTELD,R4                                                        
UDCST010 DS    0H                                                               
         CLI   RSTEL,0                                                          
         JE    UDCST016                                                         
         CLI   RSTEL,FFTELQ        IF BUILDING HIGH LEVEL DEBTOR                
         JNE   UDCST012                                                         
         CLI   FFTTYPE-FFTELD(R4),FFTTEPTR                                      
         JNE   UDCST012                                                         
         TM    AC_IND2,AC_ILOW     ONLY ADD EQUIVALENT TO LOW LEVEL             
         JZ    UDCST014            ACCOUNT                                      
UDCST012 GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,RSTEL,0                        
         CLI   RSTEL,RSTELQ        IF RSTELD ADD FILTERS TO KEY                 
         JNE   UDCST014                                                         
         MVC   ACTRSAF1,RSTFILT1                                                
         MVC   ACTRSAF2,RSTFILT2                                                
         MVC   ACTRSAF3,RSTFILT3                                                
         MVC   ACTRSAF4,RSTFILT4                                                
         MVC   ACTRSAF5,RSTFILT5                                                
*                                                                               
UDCST014 LLC   RF,RSTLN                                                         
         AR    R4,RF                                                            
         J     UDCST010                                                         
         DROP  R4                                                               
UDCST016 DS    0H                                                               
* ADDREC, PASSIVES                                                              
         GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOMST+IO1'                           
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO1                                                          
         CLC   ACTKEY+ACTKEND(L'ACTKEY-ACTKEND),SPACES                          
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR UPDPASS,DMCB,(C'A',AIO1),QA_OFFC                                 
         TM    SCPYEL+(CPYSTATA-CPYELD),CPYSPLBR                                
         JZ    UDCST018                                                         
         CLC   ACTKULA(2),ONECUL                                                
         JNE   UDCST018                                                         
         GOTOR UPDRAP,AIO1                                                      
UDCST018 GOTOR CHKNAME             ANCRECD PASSIVE                              
         GOTOR BLDHIER             ADD MISSING HIGHER LEVELS                    
         J     EXITY                                                            
*                                                                               
* CHANGE - READ EXISTING REC FOR UPDATE                                         
UDCST020 DS    0H                                                               
         MVC   IOKEY,SPACES                                                     
         LA    R2,IOKEY                                                         
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA,T_ULA                                                    
         L     R1,=AL4(IORDUPD+IODIR+IO1)                                       
         GOTOR (#IOEXEC,AIOEXEC)                                                
         L     R1,=AL4(IOGETRUP+IOMST+IO1)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
* UNDELETE DIRECTORY                                                            
         NI    ACTKSTAT,FF-ACTSDELT                                             
* 'BEFORE' PADDLE                                                               
         L     R2,AIO1                                                          
         CLC   ACTKEY+ACTKEND(L'ACTKEY-ACTKEND),SPACES                          
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR UPDPASS,DMCB,(C'D',AIO1),(C'K',QA_OFFC)                          
* ??? acrapper call?                                                            
*                                                                               
* UPDATE DIRECTORY                                                              
         LA    R2,IOKEY                                                         
         CLI   QA_UPLD,QA_SAPTL    If SAP tool or accounting upload             
         JE    UDCST030            preserve filters                             
         MVC   ACTKSAF1(ACTKSOFF-ACTKSAF1),SPACES                               
*        MVC   ACTKSOFF,SPACES                                                  
         LA    RE,T_ELEMS                                                       
         USING RSTELD,RE                                                        
UDCST025 DS    0H                                                               
         CLI   RSTEL,0                                                          
         JE    UDCST030                                                         
         CLI   RSTEL,RSTELQ                                                     
         JE    UDCST026                                                         
         LLC   RF,RSTLN                                                         
         AR    RE,RF                                                            
         J     UDCST025                                                         
*                                                                               
UDCST026 MVC   ACTKSAF1,RSTFILT1                                                
         MVC   ACTKSAF2,RSTFILT2                                                
         MVC   ACTKSAF3,RSTFILT3                                                
         MVC   ACTKSAF4,RSTFILT4                                                
         MVC   ACTKSAF5,RSTFILT5                                                
         DROP  RE                                                               
* ??? LOCKED SETTING                                                            
UDCST030 DS    0H                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR+IO1'                            
         L     R2,AIO1                                                          
         NI    ACTRSTAT,FF-ACTSDELT                                             
*                                                                               
* ??? UPDATE ELEMS ON OLD REC (RE-LOCK?)                                        
         USING RSTELD,R4                                                        
UDCST040 DS    0H                                                               
         LA    R4,T_ELEMS                                                       
*                                                                               
UDCST042 CLI   RSTEL,0             SEARCH FOR ALL EXISTING FFTTEPTR             
         JE    UDCST04A            TO DELETE                                    
         CLI   RSTEL,FFTELQ                                                     
         JNE   *+12                                                             
         CLI   FFTTYPE-FFTELD(R4),FFTTEPTR                                      
         JE    UDCST044            ONLY DELETE IF WE HAVE SOME TO ADD!          
         LLC   R0,RSTLN                                                         
         AR    R4,R0                                                            
         J     UDCST042                                                         
*                                                                               
UDCST044 MVI   BYTE1,FFTTEPTR                                                   
         TM    AC_IND2,AC_ILOW     ONLY ADD EQUIVALENT TO LOW LEVEL             
         JZ    UDCST04A            ACCOUNT                                      
         GOTOR VHELLO,DMCB,(C'D',ACCMST),('FFTELQ',ACTRECD),(1,BYTE1)           
*                                                                               
UDCST04A LA    R4,T_ELEMS                                                       
*                                                                               
         XC    ELEMENT,ELEMENT                                                  
UDCST045 DS    0H                                                               
         CLI   RSTEL,0                                                          
         JE    UDCST060                                                         
         CLI   RSTEL,RSTELQ                                                     
         JE    UDCST047                                                         
         CLI   RSTEL,NAMELQ                                                     
         JE    UDCST050                                                         
         CLI   RSTEL,FFTELQ                                                     
         JE    UDCST052                                                         
         CLI   RSTEL,ADRELQ                                                     
         JE    UDCST051                                                         
         CLI   RSTEL,SCIELQ                                                     
         JE    UDCST05A                                                         
UDCST046 LLC   RF,RSTLN                                                         
         AR    R4,RF                                                            
         J     UDCST045                                                         
UDCST047 DS    0H                                                               
         GOTOR VHELLO,DMCB,(C'G',ACCMST),('RSTELQ',(R2)),0                      
         L     R1,12(R1)                                                        
         CLI   QA_UPLD,QA_SAPTL    sap skips filters                            
         JE    UDCST048                                                         
         MVC   ACTRSAF1,RSTFILT1                                                
         MVC   ACTRSAF2,RSTFILT2                                                
         MVC   ACTRSAF3,RSTFILT3                                                
         MVC   ACTRSAF4,RSTFILT4                                                
         MVC   ACTRSAF5,RSTFILT5                                                
         GOTOR VHELLO,DMCB,(C'G',ACCMST),('RSTELQ',(R2)),0                      
         L     R1,12(R1)                                                        
         MVC   RSTFILT1-RSTELD(L'RSTFILT1,R1),RSTFILT1                          
         MVC   RSTFILT2-RSTELD(L'RSTFILT2,R1),RSTFILT2                          
         MVC   RSTFILT3-RSTELD(L'RSTFILT3,R1),RSTFILT3                          
         MVC   RSTFILT4-RSTELD(L'RSTFILT4,R1),RSTFILT4                          
         MVC   RSTFILT5-RSTELD(L'RSTFILT5,R1),RSTFILT5                          
UDCST048 DS    0H                                                               
         MVC   RSTTDATE-RSTELD(L'RSTTDATE,R1),RSTTDATE                          
         MVC   RSTBDATE-RSTELD(L'RSTBDATE,R1),RSTBDATE                          
         NI    RSTSTAT4-RSTELD(R1),FF-RSTSCSTC  COSTING TYPE                    
         OC    RSTSTAT4-RSTELD(L'RSTSTAT4,R1),RSTSTAT4                          
         J     UDCST046                                                         
*                                                                               
UDCST050 DS    0H                                                               
         GOTOR VHELLO,DMCB,(C'G',ACCMST),('NAMELQ',ACTRECD)                     
         L     R1,12(R1)           SAVE OLD NAMEL FOR SRCHPASS                  
         LLC   RE,1(R1)                                                         
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   ELEMENT(0),0(R1)                                                 
         EX    RE,0(RF)                                                         
         GOTOR VHELLO,DMCB,(C'D',ACCMST),('NAMELQ',ACTRECD)                     
         J     UDCST054                                                         
UDCST051 DS    0H                                                               
         GOTOR VHELLO,DMCB,(C'D',ACCMST),('ADRELQ',ACTRECD)                     
         J     UDCST054                                                         
UDCST05A DS    0H                                                               
         GOTOR VHELLO,DMCB,(C'D',ACCMST),('SCIELQ',ACTRECD),           x        
               (1,SCITYPE-SCIELD+RSTEL)                                         
         J     UDCST054                                                         
UDCST052 DS    0H                                                               
         GOTOR VHELLO,DMCB,(C'D',ACCMST),('FFTELQ',ACTRECD),           x        
               (1,FFTTYPE-FFTELD+RSTEL)                                         
         CLI   FFTTYPE-FFTELD(R4),FFTTEPTR                                      
         JNE   UDCST054                                                         
         TM    AC_IND2,AC_ILOW     ONLY ADD EQUIVALENT TO LOW LEVEL             
         JZ    UDCST046            ACCOUNT                                      
UDCST054 GOTOR VHELLO,DMCB,(C'P',ACCMST),ACTRECD,RSTEL,0                        
         J     UDCST046                                                         
         DROP  R4                                                               
* putrec, paddle                                                                
UDCST060 DS    0H                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO1'                           
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R2,AIO1                                                          
         CLC   ACTKEY+ACTKEND(L'ACTKEY-ACTKEND),SPACES                          
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR UPDPASS,DMCB,(C'A',AIO1),QA_OFFC                                 
         TM    SCPYEL+(CPYSTATA-CPYELD),CPYSPLBR                                
         JZ    UDCST065                                                         
         CLC   ACTKULA(2),ONECUL                                                
         JNE   UDCST065                                                         
         GOTOR UPDRAP,AIO1                                                      
UDCST065 DS    0H                                                               
         GOTOR CHKNAME             ANCRECD PASSIVE                              
         GOTOR BLDHIER             ADD MISSING HIGHER LEVELS                    
*                                                                               
*                                                                               
UDCSTX   DS    0H                                                               
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* update passives for the given record                                          
* NRTY: P1 B0   = action applied to record (A(dd), C(hange), D(elete))          
*       P1 B1-3 = ioarea holding record                                         
*       P2 b0   = On delete, 'K' keeps prime pointer                            
*                 On add, 'A' adds prime pointer                                
*       P2 B1-3 = a(office code)                                                
***********************************************************************         
UPDPASS  NTR1  LABEL=*,BASE=*                                                   
         L     R3,0(R1)                                                         
         L     R4,ABLOCK                                                        
         USING CPTRBLK,R4                                                       
         XC    CPTRBLK(CPTRBLKL),CPTRBLK                                        
         MVC   CPYSTA6,CPYSTAT6                                                 
         MVC   CPYSTA7,CPYSTAT7                                                 
         MVC   CPYSTA9,CPYSTAT9                                                 
         MVC   CPYSTAC,CPYSTATC                                                 
         MVC   LDGLVALN(L'LDGLVALN*4),LDGAL1                                    
         MVC   LDGSTA2,LEDGSTA2                                                 
         L     RF,DMCB+4          A(OFFICE CODE)                                
         MVC   ACCOFFC,0(RF)                                                    
         STCM  R4,7,DMCB+5                                                      
         GOTOR VPADDLE,DMCB,,,IODA,0,ACOMFACS                                   
*                                                                               
         J     EXITY                                                            
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* Validate media field array - build Tsar records of cli/prod to                
* add/change                                                                    
***********************************************************************         
         SPACE 1                                                                
*&&UK                                                                           
VMEDFLDS NTR1  LABEL=*,BASE=*                                                   
*  ANY DATA?                                                                    
         ICM   R4,7,QA_AMEDF                                                    
         JZ    EXITY               NO MEDIA DATA                                
*                                                                               
         USING QI_MFLDD,RF                                                      
         XR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R4)  Number of Media data blocks               
         LTR   R0,R0                                                            
         JZ    EXITY                                                            
         LA    RF,LW_LN2Q(R4)      R4=A(first media block)                      
         CLC   QI_MEDI1(QI_MBLGR-QI_MEDI1),SPACES                               
         JNH   EXITY               Definitely no media data!                    
         DROP  RF                                                               
*                                                                               
         CLI   QA_TYPE,QA_TUPDT    CHECK WE ARE UPDATING                        
         JE    VMFLD000                                                         
         CLI   QA_ASTAT,QA_ANEW    or adding                                    
         JE    VMFLD000                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$MUPDT),(5,=C'EC059'),=AL2(FLD005)            
         J     EXITN                                                            
VMFLD000 CLC   QA_UNIT(2),SCPYEL+CPYPROD-CPYELD                                 
         JZ    VMFLD002                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$MEDNA),(5,=C'EC036'),=AL2(FLD001)            
         J     EXITN                                                            
VMFLD002 TM    AC_IND1,AC_INEW3+AC_INEW4+AC_ILVL3+AC_ILVL4                      
         JZ    VMFLD011                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$MEDLV),(5,=C'EC037'),0                       
         J     EXITN                                                            
*                                                                               
* INITIALISE FOR BUILDING TSARS                                                 
*                                                                               
VMFLD011 LA    R2,IOKEY            Read agency record                           
         USING M_AGYKEY,R2                                                      
         XC    M_AGYKEY,M_AGYKEY                                                
         MVI   M_AGYKTYP,M_AGYKTYPQ                                             
         MVC   M_AGYKAGY,MEDAGYB                                                
* Media system as default for IO. We'll have to remember to restore             
* Acc as default afterwards, for efficiency.                                    
         OI    IOINDS1,IO1XSWCH                                                 
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IOMEDDIR+IO1'                            
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   OA_MAGYI,M_AGYIND   Save agency indicator                        
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMEDFIL+IO1'                           
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO1                                                          
         LA    RF,M_AGYELDQ(R2)                                                 
         MVC   OA_CCURC,M_AGYDCURR                                              
         MVC   OA_CCUR2,M_AGYDCUR2                                              
         MVC   OA_MAGY2,M_AGYIND2-M_AGYEL(RF)                                   
         MVI   OA_AISC,0                                                        
         GOTO1 VHELLO,DMCB,(C'G',MEDFIL),('M_CAGELQ',M_AGYKEY),0                
         CLI   12(R1),6                                                         
         JE    *+8                                                              
         MVI   OA_AISC,M_CAGELQ    Indicate found (so sq a/c exists)            
*                                                                               
         XR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R4)  Number of Media data blocks               
         AHI   R4,LW_LN2Q          R4=A(first media block)                      
         USING QI_MFLDD,R4                                                      
         L     R7,AIO8                                                          
         USING T_D,R7                                                           
         MVC   OA_MLIST,SPACES                                                  
*                                                                               
VMFLD015 DS    0H                                                               
         STCM  R0,3,OA_MBLK#                                                    
*        Convert SAP media codes if necessary                                   
         GOTOR SAPMED              Convert SAP codes to DDS codes               
         JNE   VMFLD085                                                         
* initialise media limacc                                                       
         L     RF,ALACCBLK                                                      
         USING LIMACCD,RF                                                       
         XC    LABLOCK(LAINITLN),LABLOCK                                        
         MVI   LASYS,4             MEDIA SYSTEM                                 
         MVC   LAAGYSEC,CUAALF     AGENCY ALPHA                                 
         MVC   LALIMACC,MEDSCNUM   USER LIMACC FROM SWITCH INIT                 
         GOTO1 VLIMACC,DMCB,(C'I',(RF)),ACOMFACS                                
         JE    VMFLD019                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$LIMVA),(5,=C'EC049'),0                       
         J     EXITN                                                            
         DROP  RF                                                               
VMFLD019 DS    0H                                                               
         MVC   LIACTST,0(R1)       R3 = CURRENT MEDIA LETTER                    
* Initialise key of record                                                      
         XC    T_KEY(T_RECLQ),T_KEY                                             
         MVI   T_ACCMED,T_MEDQ                                                  
         LHI   RF,T_RECLQ                                                       
         STH   RF,T_RECLEN                                                      
         LA    R3,QI_MEDI1                                                      
         CLI   QA_UPLD,QA_SAPTL    SAP TOOL?                                    
         JNE   VMFLD01A                                                         
         LAY   R3,SAPMBLOC         POINT TO CORRECT BLOCK                       
*                                                                               
VMFLD01A MVI   OA_MFLAG,0                                                       
*                                                                               
* loop over media                                                               
VMFLD020 DS    0H                                                               
         MVC   OA_MEDL,0(R3)       CURRENT MEDIA LETTER                         
         CLI   QA_UPLD,QA_SAPTL    IF NOT SAP TOOL VALIDATE INPUT               
         JNE   VMFLD022            LENGTH                                       
         CLI   0(R3),C' '                                                       
         JNH   VMFLD085            EMPTY ENTRY                                  
*                                                                               
VMFLD022 NI    T_INDS,X'FF'-T_IUPDAT TURN OFF UPDATE FLAG                       
         CLI   0(R3),C' '                                                       
         JNH   VMFLD090            NEXT BLOCK                                   
         GOTOR MVALMED             MEDIA CODE                                   
         JNE   VMFLD085                                                         
         GOTOR MBLDTSR             tsar from existing cli, if any               
         JNE   VMFLD085                                                         
*                                                                               
* VALIDATION ROUTINES WORKING WITH ELEMENTS SHOULD CHECK NEW DATA VS            
* EXISTING (IN AIO7), LEAVE NO ELEMENT ON TSAR IF NO CHANGE.                    
* ROUTINES FINDING CHANGES TO DATA SAVED IN T_DATA MUST SET T_IUPDAT            
         MVI   ERRFLAG,0                                                        
         TM    OA_MFLAG,OA_MNFST   IF NOT FIRST DON'T REPORT ANY MORE           
         JZ    *+8                 ERRORS                                       
         OI    ERRFLAG,SKIPERR                                                  
*                                                                               
         GOTOR MELIMACC            CHECK ACCESS TO CLI/PRO                      
         GOTOR MVALBUY             VALIDATE BUYING AGENCY                       
         GOTOR MVALCRE             VALIDATE CREATIVE AGENCY                     
*                                  **keep before MVALCLI/MVALPRO                
         GOTOR MVALCLI             CLISTAT/CLIEL (IF CLIENT)                    
         GOTOR MVALPRO             PROSTAT/PROEL (IF PROD)                      
         GOTOR MVALCEX             CLXELD (IF CLIENT)                           
         GOTOR MVALADDR            ADDRESS (ADDEL)                              
         GOTOR MVALFLT             FILTERS (FLTELD)                             
         GOTOR MVALFRM             FORMULA CODE (FMLELD)                        
         GOTOR MVALDUE             DUE DATE /CASH DISCOUNT (DDRELD)             
         GOTOR MVALFOR             BILL/BUDGET CURRENCIES (CLI/PRO)             
         GOTOR MVALCAC             COMMISSION ACCOUNT (ULAELD)                  
         GOTOR MVALTXT             UPDATE DTXT ELEMENT                          
         GOTOR MVALFNM             COMMISSION TEXT RULE                         
                                                                                
         MVI   ERRFLAG,0           Clear flag to skip errors                    
                                                                                
         CLI   T_ACTION,C'A'       Adding new client?                           
         JE    *+14                                                             
         CLC   T_CPSTAT(L'T_CPSTAT),M_CLISTAT Any change to stat byte?          
         JE    *+8                                                              
         OI    T_INDS,T_IUPDAT     Mark as updated                              
*                                                                               
*                                                                               
* CHECK ANY CHANGES TO MAKE                                                     
         TM    T_INDS,T_IUPDAT                                                  
         JNZ   VMFLD060                                                         
         LA    RF,T_RECLQ                                                       
         CH    RF,T_RECLEN                                                      
         JE    VMFLD085            NO                                           
*                                                                               
VMFLD060 DS    0H                  yes, system available?                       
         GOTOR (#SYSCHK,ASYSCHK)                                                
         JE    VMFLD084                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$SWITN),(5,=C'EC092'),0                       
         J     EXITN                                                            
* ADD TO TSAR                                                                   
VMFLD084 DS    0H                                                               
         GOTOR GOTSAR,DMCB,('TSAADD',0)                                         
         JE    *+6                 Add to tsar                                  
         DC    H'0'                                                             
*                                                                               
* ??? check for more media codes in this block                                  
VMFLD085 DS    0H                                                               
         OI    OA_MFLAG,OA_MNFST                                                
         LA    RF,QI_MBLGR                                                      
         LHI   R0,L'QI_MEDI1       4 chars or                                   
         CLI   QA_UPLD,QA_SAPTL                                                 
         JNE   VMFLD086                                                         
         LHI   R0,1                if SAP 1 char                                
         LAY   RF,SAPMBLOC                                                      
         LA    RF,L'SAPMBLOC(RF)                                                
*                                                                               
VMFLD086 AR    R3,R0                                                            
         CR    R3,RF                                                            
         JL    VMFLD020                                                         
*                                                                               
* NEXT MEDIA VALUE BLOCK                                                        
VMFLD090 DS    0H                                                               
         NI    AC_IND2,X'FF'-AC_IMEDF Turn off new filt processed               
         LA    R4,QI_MFLDL(R4)                                                  
         SR    R0,R0                                                            
         ICM   R0,3,OA_MBLK#          #BLOCKS LEFT?                             
         JCT   R0,VMFLD015                                                      
         J     EXITY                                                            
         DROP  R3,R7                                                            
         EJECT                                                                  
***********************************************************************         
* Update media client/product records from TSAR                                 
***********************************************************************         
         SPACE 1                                                                
MVALMED  NTR1  LABEL=*,BASE=*                                                   
*                                                                               
         LA    R2,IOKEY                                                         
         USING M_MEDKEY,R2                                                      
         XC    IOKEY,IOKEY                                                      
         MVI   M_MEDKTYP,M_MEDKPASQ                                             
         MVC   M_MEDKAM,MEDAGYB                                                 
         MVC   M_MEDKCODE,OA_MEDL                                               
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IOMEDDIR+IO1'                            
         JE    MVMED005                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$MCINV),(5,=C'EC045'),0                       
         J     EXITN                                                            
MVMED005 MVC   OA_KAM,M_MEDDNUM                                                 
         OC    OA_KAM,MEDAGYB                                                   
         MVC   OA_MIND1,M_MEDDIND1                                              
         MVC   OA_MIND2,M_MEDDIND2                                              
         MVC   OA_MIND3,M_MEDDIND3                                              
         MVC   OA_MIND5,M_MEDDIND5                                              
                                                                                
         NI    OA_MFLAG,X'FF'-OA_MCACL                                          
         TM    M_MEDDSTAT,M_MEDCACCQ CHECK FOR CLIENT LIMIT ACCESS              
         BZ    *+8                                                              
         OI    OA_MFLAG,OA_MCACL                                                
                                                                                
         NI    OA_MFLAG,X'FF'-OA_MFOFF                                          
         TM    M_MEDDSTAT,M_MEDOFFCQ                                            
         JNO   *+8                                                              
         OI    OA_MFLAG,OA_MFOFF                                                
                                                                                
         NI    OA_MFLAG,X'FF'-OA_MCLBU                                          
         TM    M_MEDDSTAT,M_MEDBACCQ                                            
         JNO   *+8                                                              
         OI    OA_MFLAG,OA_MCLBU                                                
* CHECK FOR DUPES                                                               
MVMED010 DS    0H                                                               
         LLC   R1,M_MEDDNUM                                                     
         LA    R1,OA_MLIST(R1)                                                  
         CLI   0(R1),C' '                                                       
         JNH   MVMED020                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$DUPME),(5,=C'EC041'),0                       
         J     EXITN                                                            
MVMED020 DS    0H                                                               
         MVC   0(1,R1),OA_MEDL       MARK AS SEEN BEFORE                        
         J     EXITY                                                            
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* check for existing client/product rec, build (skeleton) TSAR        *         
***********************************************************************         
         SPACE 1                                                                
MBLDTSR  NTR1  LABEL=*,BASE=*                                                   
                                                                                
         L     R0,AIO7                                                          
         LHI   R1,IOLENQ                                                        
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         XC    OLDSTAT,OLDSTAT       OLD RECORD STATUS                          
                                                                                
         L     R7,AIO8                                                          
         USING T_D,R7                                                           
         XC    T_KEY(T_RECLQ),T_KEY                                             
         MVI   T_ACCMED,T_MEDQ                                                  
         MVC   T_KAM,OA_KAM                                                     
         LHI   RF,T_RECLQ                                                       
         STH   RF,T_RECLEN                                                      
* 2/3 CHAR CLIENT                                                               
         CLI   LDGAL1,3                                                         
         JH    MBTSR005                                                         
         MVC   BYTE1,LDGAL1                                                     
         LA    R4,QA_ACT                                                        
         GOTOR CHKMIX                                                           
         JNE   MBTSR009                                                         
         MVC   T_CLI,QA_ACT                                                     
         CLI   LDGAL1,3                                                         
         JE    MBTSR010                                                         
         MVI   T_CLI+2,C' '                                                     
         CLI   LDGAL1,2                                                         
         JE    MBTSR010                                                         
         J     MBTSR009                                                         
* 5-CHAR CLIENT                                                                 
MBTSR005 DS    0H                                                               
         CLI   LDGAL1,5                                                         
         JNE   MBTSR009                                                         
         MVI   BYTE1,1                                                          
         LA    R4,QA_ACT                                                        
         GOTOR CHKMIX                                                           
         JNE   MBTSR009                                                         
         MVI   BYTE1,4                                                          
         LA    R4,QA_ACT+1                                                      
         GOTOR CHKNUM                                                           
         JNE   MBTSR009                                                         
         MVC   T_CLI(1),QA_ACT                                                  
         PACK  DUB,QA_ACT+1(4)     4 LAST CHARS PACKED INTO 2 BYTES             
         CVB   R1,DUB                                                           
         STCM  R1,3,T_CLI+1                                                     
         J     MBTSR010            OK                                           
*                                                                               
MBTSR009 GOTOR SAVERR,DMCB,=AL2(AE$INCLI),(5,=C'EC046'),=AL2(FLD003)            
         J     EXITN                                                            
* PRODUCT                                                                       
MBTSR010 DS    0H                                                               
         TM    AC_IND1,AC_INEW2+AC_ILVL2     ADDING/CHANGING PRODUCT?           
         JZ    MBTSR015            NO                                           
         MVI   BYTE1,2                                                          
         LLC   RF,LDGAL1                                                        
         LA    R4,QA_ACT                                                        
         AR    R4,RF                                                            
         GOTOR CHKNUM                                                           
         JNE   MBTSR014                                                         
         PACK  DUB,0(2,R4)         2 CHARS PACKED INTO 1 BYTE                   
         CVB   R1,DUB                                                           
         STCM  R1,1,T_PRO                                                       
         J     MBTSR015                                                         
*                                                                               
MBTSR014 GOTOR SAVERR,DMCB,=AL2(AE$INPRO),(5,=C'EC047'),=AL2(FLD003)            
         J     EXITN                                                            
*    build media cli/pro rec                                                    
MBTSR015 DS    0H                                                               
         USING M_PROKEY,R2                                                      
         LA    R2,IOKEY                                                         
         XC    IOKEY,IOKEY                                                      
         MVC   M_PROKAM,OA_KAM                                                  
         MVI   M_PROKTYP,M_PROKTYPQ                                             
         TM    AC_IND1,AC_INEW2+AC_ILVL2                                        
         JNZ   *+8                                                              
         MVI   M_PROKTYP,M_CLIKTYPQ                                             
         TM    AC_IND1,AC_INEW2+AC_ILVL2                                        
         JZ    *+10                                                             
         MVC   M_PROKPRO,T_PRO                                                  
         MVC   M_PROKCLI,T_CLI                                                  
         CLI   LDGAL1,3                                                         
         JNH   MBTSR020                                                         
* READ RECORD INTO AIO7 SO WE CAN CHECK FOR CHANGES IN MVAL ROUTINES            
MBTSR020 DS    0H                                                               
         MVI   T_ACTION,C'A'                                                    
         L     R1,=AL4(IORDD+IOMEDDIR+IO7)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         CLI   IOERR,IOERNF        CHECK WHETHER CLIENT EXISTS                  
         JE    MBTSR026                                                         
         CLI   IOERR,IOEDEL                                                     
         JE    MBTSR025                                                         
         CLI   IOERR,0                                                          
         JE    MBTSR025                                                         
         DC    H'0'                IO ERROR                                     
*  SAVE CURRENT VALUES TO TSAR                                                  
MBTSR025 DS    0H                                                               
         MVI   T_ACTION,C'C'                                                    
         MVC   OA_MCLI,T_CLI                                                    
         TM    AC_IND1,AC_INEW2+AC_ILVL2                                        
         JZ    *+10                                                             
         MVC   OA_MPRO,T_PRO                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMEDFIL+IO7'                           
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO7                                                          
         MVC   T_CPSTAT,M_PROSTAT  Store current status                         
         GOTO1 VHELLO,DMCB,(C'G',MEDFIL),('M_FLTELQ',M_PROKEY),0                
         CLI   12(R1),0                                                         
         JNE   MBTSR026                                                         
         L     R3,12(R1)                                                        
         LLC   RE,M_FLTLEN-M_FLTEL(R3)                                          
         BCTR  RE,0                                                             
         BASR  R1,0                                                             
         MVC   T_FLTS(0),M_FLTFLTS-M_FLTEL(R3)                                  
         EX    RE,0(R1)            Establish filter values                      
         XC    T_FLTI,T_FLTI                                                    
*                                                                               
         USING M_CLIKEY,R3                                                      
MBTSR026 TM    AC_IND1,AC_ILVL2+AC_INEW2    Only for product                    
         JZ    EXITY                                                            
         TM    AC_IND1,AC_ILVL3+AC_INEW3                                        
         JNZ   EXITY                                                            
         XC    IOKEY,IOKEY              Read for client                         
         LA    R3,IOKEY                                                         
         MVI   M_CLIKTYP,M_CLIKTYPQ                                             
         MVC   M_CLIKAM,OA_KAM                                                  
         MVC   M_CLIKCLI,T_CLI                                                  
         L     R1,=AL4(IORDD+IOMEDDIR+IO1)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JNE   MBTSR028                                                         
         MVC   OA_MCLST,M_CLISTAT       save off client status area             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMEDFIL+IO1'                           
         JE    *+6                                                              
         DC    H'0'                                                             
         L     RF,AIO1                                                          
         LA    RF,M_CLIELDQ(RF)                                                 
*                                                                               
         USING M_CLIEL,RF                                                       
MBTSR027 CLI   M_CLIEL,0                Find client vat type                    
         JE    EXITY                                                            
         CLI   M_CLIEL,M_CLIELQ                                                 
         JE    MBTSR27B                                                         
         CLI   M_CLIEL,M_FORELQ                                                 
         JE    MBTSR27C                                                         
MBTSR27A LLC   R0,M_CLILEN                                                      
         AR    RF,R0                                                            
         J     MBTSR027                                                         
*                                                                               
MBTSR27B MVC   OA_CVAT,M_CLIVATTY       Store client vat type                   
         J     MBTSR27A                                                         
*                                                                               
MBTSR27C MVC   OA_CBST,M_FORSTAT-M_FOREL(RF)                                    
         J     MBTSR27A                 Save client billing status              
*                                                                               
MBTSR028 GOTOR SAVERR,DMCB,=AL2(AE$CLINF),(5,=C'EC074'),=AL2(FLD003)            
         J     EXITN                    missing client                          
         DROP  R2,R3,R7,RF                                                      
         EJECT                                                                  
***********************************************************************         
* MEDIA CLIEL/CLISTAT VALIDATION                                      *         
* On ntry R4=A(Media field array)                                     *         
* Uses DUB to temporarily store status area                           *         
***********************************************************************         
         SPACE 1                                                                
         USING QI_MFLDD,R4                                                      
MVALCLI  NTR1  LABEL=*,BASE=*                                                   
*                                                                               
         L     R7,AIO8                                                          
         USING T_D,R7                                                           
         USING M_CLIKEY,R2                                                      
         L     R2,AIO7                                                          
         TM    AC_IND1,AC_INEW2+AC_ILVL2 Only for client type                   
         JNZ   MVALCLX                                                          
         MVI   BYTE1,0                                                          
*                                                                               
         NI    T_CPSTAT,X'FF'-X'80'     Make sure undeleted                     
*                                                                               
         CLI   QA_UPLD,QA_SAPTL        If upload tool more restrictive          
         JNE   MVALCL02                                                         
         CLI   T_ACTION,C'A'            Must lock if new client                 
         JE    MVALCL04                                                         
*        TM    T_CPSTAT,M_CLILOCKQ      If already locked keep it lock          
*        JNZ   MVALCL04                                                         
MVALCL02 CLI   QI_LOCK,YESQ             else user can choose                    
         JE    MVALCL04                                                         
         NI    T_CPSTAT,X'FF'-M_CLILOCKQ client lock                            
         J     *+8                                                              
MVALCL04 OI    T_CPSTAT,M_CLILOCKQ                                              
*                                                                               
         CLI   QA_UPLD,QA_SAPTL         Maintained in SAP?                      
         JE    MVALCL05                                                         
         NI    T_CPSTAT,X'FF'-M_CLIBDRQ Booking detail report M1B               
         CLI   QI_GEN1B,YESQ                                                    
         JNE   *+8                                                              
         OI    T_CPSTAT,M_CLIBDRQ                                               
*                                                                               
MVALCL05 GOTO1 VHELLO,DMCB,(C'G',MEDFIL),('M_CLIELQ',M_CLIKEY),0                
         CLI   12(R1),0                                                         
         JE    MVALCL06                                                         
*                                                                               
         USING M_CLIEL,R3                                                       
EL       USING M_CLIEL,ELEMENT                                                  
         XC    ELEMENT,ELEMENT          Build element                           
         MVI   EL.M_CLIEL,M_CLIELQ                                              
         MVI   EL.M_CLILEN,M_CLILENQ                                            
         OI    BYTE1,X'80'                                                      
         J     MVALCL08                                                         
*                                                                               
MVALCL06 L     R3,12(R1)                                                        
         XC    ELEMENT,ELEMENT                                                  
         LLC   RF,M_CLILEN              Copy element                            
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   ELEMENT(0),M_CLIEL                                               
         EX    RF,0(RE)                                                         
*                                                                               
MVALCL08 MVC   EL.M_CLINAME,SPACES                                              
         LLC   RF,QA_NAMEL                                                      
         CHI   RF,L'M_CLINAME           MEDIA NAME IS SHORTER, TRUNC            
         JNH   *+8                                                              
         LHI   RF,L'M_CLINAME                                                   
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   EL.M_CLINAME(0),QA_NAME  Store name                              
         EX    RF,0(RE)                                                         
         OC    EL.M_CLINAME,SPACES                                              
*                                                                               
         USING TRAVBLK,TRAVWRK                                                  
         MVC   WORK,SPACES                                                      
         OC    QI_MVATY,SPACES                                                  
         CLI   QI_MVATY,C' '            Default to standard                     
         JH    *+12                     if none passed                          
         MVI   WORK,C'S'                                                        
         J     MVALCL10                                                         
*                                                                               
         XC    TRAVBLK(TRAVBLKL),TRAVBLK                                        
         MVI   TRAACT,TRAAVALQ+TRAAFLDQ                                         
         MVI   TRAFLD,TRAFVATY                                                  
         MVI   TRAILEN,L'QI_MVATY-1                                             
         MVC   BYTE2,QI_MVATY           Save off vat type                       
         LA    R0,BYTE2                                                         
         STCM  R0,7,TRAIADD                                                     
         LA    R0,WORK                                                          
         STCM  R0,7,TRAOADD                                                     
         L     R0,ACOMFACS                                                      
         STCM  R0,7,TRACOMF                                                     
         MVC   TRAVAGYO,CUCBIT          Agency country option                   
         MVC   TRAVAGYC,CUCTRY          Agency country                          
         MVC   TRAVLANG,CULANG          Agency language                         
         GOTO1 VTRVAIL,TRAVBLK                                                  
         JNE   MVALCRR4                                                         
*                                                                               
MVALCL10 MVC   EL.M_CLIVATTY,WORK       Set vat type in client record           
         CLI   QA_UPLD,QA_SAPTL         Not maintained in SAP                   
         JE    MVALCL14                                                         
         CLC   QI_MEDCM,SPACES          Any commission rate entered?            
         JNH   MVALCL14                                                         
         OC    QI_MEDCM,SPACES          Make upper case                         
*                                                                               
         XC    TRAVBLK(TRAVBLKL),TRAVBLK                                        
*                                                                               
         LLC   RE,QI_MEDCL                                                      
         STC   RE,TRAILEN               Set total input length                  
*                                                                               
         LA    RF,QI_MEDCM                                                      
         CLI   0(RF),C' '               Locate first blank character            
         JNH   *+12                                                             
         LA    RF,1(RF)                                                         
         JCT   RE,*-12                                                          
*                                                                               
         LA    RE,QI_MEDCM                                                      
         SR    RF,RE                                                            
         STC   RF,TRAILEN                                                       
*                                                                               
         MVI   TRAACT,TRAAVALQ+TRAAFLDQ                                         
         MVI   TRAFLD,TRAFAGYC                                                  
         MVC   SVMEDCM,QI_MEDCM                                                 
         LA    RF,SVMEDCM                                                       
         STCM  RF,7,TRAIADD             Save address and length                 
*                                                                               
         XC    WORK,WORK                                                        
         LA    RF,WORK                                                          
         STCM  RF,7,TRAOADD                                                     
         L     RF,ACOMFACS                                                      
         STCM  RF,7,TRACOMF                                                     
         MVC   TRAVAGYO,CUCBIT          Agency country option                   
         MVC   TRAVAGYC,CUCTRY          Agency country                          
         MVC   TRAVLANG,CULANG          Agency language                         
         GOTO1 VTRVAIL,TRAVBLK                                                  
         JNE   MVALCRR1                                                         
         MVC   EL.M_CLICOMTY,WORK       Set client record                       
         MVC   EL.M_CLICOMRT,WORK+1     with commission                         
         MVC   EL.M_CLICOMT2,WORK+3                                             
         MVC   EL.M_CLICOMR2,WORK+4                                             
         CLI   EL.M_CLICOMT2,0          Any commission                          
         JE    MVALCL14                                                         
         CLI   EL.M_CLIAGY,0            Creative agency found?                  
         JNE   MVALCL12                                                         
         CLI   T_ACTION,C'A'            If adding new client invalid            
         JNE   MVALCL14                                                         
         OC    QI_CREAG,QI_CREAG        Check creative agency passed            
         JNZ   MVALCL14                                                         
         J     MVALCRR5                                                         
*                                                                               
MVALCL12 CLI   QA_UPLD,QA_SAPTL         Not maintained in SAP                   
         JE    MVALCL18                                                         
         TM    EL.M_CLICOMT2,X'C0'      If split required posting to            
         JZ    MVALCL14                 CAGY check that SQ a/c exists           
         CLI   OA_CISC,M_CAGELQ         Make sure we have SQ account            
         JE    MVALCRR6                                                         
*                                                                               
MVALCL14 CLC   QI_MXAMT,SPACES          Any max bill amount passed?             
         JNH   MVALCL18                                                         
         LHI   RF,L'QI_MXAMT            RF=(LENGTH OF MAXBILL INPUT)            
         LA    RE,QI_MXAMT+L'QI_MXAMT-1 Find actual length                      
MVALCL16 CLI   0(RE),C' '                                                       
         JH    *+10                                                             
         BCTR  RE,0                                                             
         JCT   RF,MVALCL16                                                      
*                                                                               
         GOTO1 VCASHVAL,DMCB,(2,QI_MXAMT),(RF)                                  
         CLI   0(R1),0                                                          
         JNE   MVALCRR2                 Invalid rate                            
         L     RE,4(R1)                                                         
         LTR   RE,RE                                                            
         JNP   MVALCRR2                 Invalid rate                            
         SRDL  RE,32                                                            
         D     RE,=F'100'               Into POUNDS                             
         LTR   RF,RF                                                            
         JNP   MVALCRR2                                                         
         CLM   RF,15,=X'00400000'       RANGE 1 TO X'3FFFFF'                    
         JNL   MVALCRR2             (X'40' BIT ON MEANS OLD VAL OF FLD)         
         STCM  RF,7,EL.M_CLIMAXBL                                               
*                                                                               
MVALCL18 CLI   T_ACTION,C'A'            Adding a new record?                    
         JNE   *+14                                                             
         CLC   QA_SHNAM,SPACES          Anything passed?                        
         JNH   MVALCRR7                 Must have short name                    
         CLC   QA_SHNAM,SPACES          Anything passed?                        
         JNH   *+10                                                             
         MVC   EL.M_CLISH,QA_SHNAM      Short name                              
         OC    EL.M_CLISH,SPACES                                                
*                                                                               
         CLI   QA_UPLD,QA_SAPTL         Not maintained in SAP                   
         JE    MVALCL20                                                         
         CLC   QI_SURCH,SPACES          Any surcharge?                          
         JNH   MVALCL20                                                         
         LLC   RF,QI_SURCL              RF=(LENGTH OF SURCHARGE NUMBER)         
         GOTO1 VCASHVAL,DMCB,(3,QI_SURCH),(RF)                                  
         CLI   0(R1),0                                                          
         JNE   MVALCRR3                                                         
         L     RF,4(R1)                                                         
         LTR   RF,RF                    Is the number negative?                 
         JM    MVALCRR3                                                         
         STCM  RF,3,EL.M_CLISURCH       put in client record                    
*                                                                               
MVALCL20 TM    BYTE1,X'80'              Creating new element?                   
         JNZ   MVALCL22                                                         
         LLC   RF,M_CLILEN                                                      
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         CLC   M_CLIEL(0),ELEMENT       has the data changed?                   
         EX    RF,0(RE)                                                         
         JE    MVALCLX                                                          
*                                                                               
MVALCL22 GOTOR ADDELT                                                           
*                                                                               
MVALCLX  J     EXITY                                                            
*                                                                               
MVALCRR1 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$ICRAT),(5,=C'EC053'),=AL2(FLD321)            
         J     EXITN                    Invalid commission rate                 
*                                                                               
MVALCRR2 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$IMXBL),(5,=C'EC057'),=AL2(FLD335)            
         J     EXITN                    Invalid maximum bill amount             
*                                                                               
MVALCRR3 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$IVSUR),(5,=C'EC058'),=AL2(FLD336)            
         J     EXITN                    Invalid surcharge %                     
*                                                                               
MVALCRR4 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$INVVI),(5,=C'EC056'),=AL2(FLD322)            
         J     EXITN                    Invalid vat type                        
*                                                                               
MVALCRR5 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$INCAG),(5,=C'EC071'),=AL2(FLD325)            
         J     EXITN                    Missing creative agency                 
*                                                                               
MVALCRR6 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$HLACM),(5,=C'EC072'),=AL2(FLD321)            
         J     EXITN                    Missing SQ account                      
*                                                                               
MVALCRR7 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$CLSNM),(5,=C'EC077'),=AL2(FLD011)            
         J     EXITN                    Missing short name                      
         DROP  R2,R3,R4,R7,EL                                                   
         EJECT                                                                  
***********************************************************************         
* Validate media extra client info element                            *         
***********************************************************************         
         SPACE 1                                                                
         USING QI_MFLDD,R4                                                      
MVALCEX  NTR1  LABEL=*,BASE=*                                                   
*                                                                               
         L     R7,AIO8                                                          
         USING T_D,R7                                                           
         USING M_CLIKEY,R2                                                      
         L     R2,AIO7                                                          
         TM    AC_IND1,AC_INEW2+AC_ILVL2                                        
         JNZ   MVALCEIX                 Only for client type                    
         MVI   BYTE1,0                                                          
         GOTO1 VHELLO,DMCB,(C'G',MEDFIL),('M_CLXELQ',M_CLIKEY),0                
         CLI   12(R1),0                                                         
         JE    MVALCE06                                                         
*                                                                               
EL       USING M_CLXEL,ELEMENT                                                  
         XC    ELEMENT,ELEMENT          Build element                           
         MVI   EL.M_CLXEL,M_CLXELQ                                              
         MVI   EL.M_CLXLEN,M_CLXLENQ                                            
         OI    BYTE1,X'80'                                                      
         J     MVALCE08                                                         
*                                                                               
         USING M_CLXEL,R3                                                       
EL       USING M_CLXEL,ELEMENT                                                  
MVALCE06 L     R3,12(R1)                                                        
         LLC   RF,M_CLXLEN              copy element                            
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   ELEMENT(0),M_CLXEL                                               
         EX    RF,0(RE)                                                         
*                                                                               
MVALCE08 CLI   QA_UPLD,QA_SAPTL         Not maintained in SAP                   
         JE    MVALCE09                                                         
         NI    EL.M_CLXIND,X'FF'-(M_CINDBCCQ+M_CINDOCCQ+M_CINDCRFQ)             
         CLI   QI_BLCOM,YESQ            Billing comments compulsory             
         JNE   *+8                                                              
         OI    EL.M_CLXIND,M_CINDBCCQ                                           
*                                                                               
         CLI   QI_ORCOM,YESQ            ORDER COMMENTS COMPULSORY               
         JNE   *+8                                                              
         OI    EL.M_CLXIND,M_CINDOCCQ                                           
*                                                                               
         CLI   QI_CMPRF,YESQ            CAMPIAIGN REF?                          
         JNE   *+8                                                              
         OI    EL.M_CLXIND,M_CINDCRFQ                                           
*                                                                               
         NI    EL.M_CLXIND2,X'FF'-(M_CIN2POIQ+M_CIN2POEQ+M_CIN2POAQ)            
         CLI   QI_POTRA,YESQ            PO TRACKER APPROVAL?                    
         JNE   *+8                                                              
         OI    EL.M_CLXIND2,M_CIN2POAQ                                          
         CLI   QI_POTRK,QI_POTIN        INCLUDE?                                
         JNE   *+12                                                             
         OI    EL.M_CLXIND2,M_CIN2POIQ                                          
         J     MVALCE09                                                         
         CLI   QI_POTRK,QI_POTEX        EXCLUDE?                                
         JNE   MVALCER3                                                         
         OI    EL.M_CLXIND2,M_CIN2POEQ                                          
         J     MVALCE09                                                         
*                                                                               
MVALCE09 XC    EL.M_CLXOSCHM,EL.M_CLXOSCHM                                      
         CLI   QA_UPLD,QA_SAPTL    If SAP tool we don't maintain                
         JE    MVALCE12                                                         
         CLC   QI_OUTSC,SPACES     Any outlet scheme code?                      
         JNH   MVALCE12                                                         
*                                                                               
         XC    IOKEY,IOKEY                                                      
         USING DOSC,RF                                                          
         LA    RF,IOKEY                                                         
         MVC   OSCKAM,MEDAGYB                                                   
         NI    OSCKAM,X'F0'             Remove media nibble                     
         MVI   OSCKTYP,OSCKTYPQ                                                 
         MVC   OSCKSCHM,QI_OUTSC                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IOMEDDIR+IO1'                            
         CLI   IOERR,0                                                          
         JNE   *+12                                                             
         CLI   OSCSMED,C' '                                                     
         JNH   MVALCE10                                                         
         GOTOR SAVERR,DMCB,=AL2(AE$OUTSI),(5,=C'EC050'),=AL2(FLD340)            
         J     EXITN                                                            
*                                                                               
MVALCE10 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMEDFIL+IO1'                           
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   EL.M_CLXOSCHM,QI_OUTSC   Outlet scheme code                      
*                                                                               
MVALCE12 CLI   QA_UPLD,QA_SAPTL         Not maintained in SAP                   
         JNE   MVALCE13                 hard code to default                    
         CLI   T_ACTION,C'A'            On add set to XX                        
         JNE   MVALCE14                 else just ignore any data               
         MVC   EL.M_CLXBGRP,DFTBGRP                                             
         J     MVALCE14                                                         
MVALCE13 MVC   EL.M_CLXBGRP,QI_MBLGR    Billing group                           
*                                                                               
MVALCE14 DS    0H                                                               
         MVI   EL.M_CLXOSIND,0                                                  
         CLI   QA_UPLD,QA_SAPTL         Not maintained in SAP                   
         JE    MVALCE22                                                         
         CLC   QI_OUTB1,SPACES          R2=A(Budget codes)                      
         JNH   MVALCE22                 No data delete what we have             
         OC    EL.M_CLXOSCHM,EL.M_CLXOSCHM                                      
         JZ    MVALCER1                 Error no outlet code                    
         MVI   EL.M_CLXOSIND,M_CLXOSOPQ Set non-outlet style books              
*                                                                               
         LA    R2,QI_OUTB1              R2=A(first address line data)           
         LHI   R6,6                     R6=Number of budgets                    
*                                                                               
MVALCE15 L     RF,AIO1                                                          
         USING DOBD,RF                                                          
         LA    RF,OSCELDQ(RF)                                                   
MVALCE16 CLI   0(RF),0                                                          
         JE    MVALCER2                 Error budget code not defined           
         CLI   0(RF),OBDELQ                                                     
         JE    MVALCE20                                                         
MVALCE18 LLC   R0,1(RF)                                                         
         AR    RF,R0                                                            
         J     MVALCE16                                                         
*                                                                               
MVALCE20 CLC   OBDCODE,0(R2)            Match on code                           
         JNE   MVALCE18                                                         
         MVC   WORK(1),OBDNUM                                                   
         TR    WORK(1),=X'00804020100804'                                       
         OC    EL.M_CLXOSIND,WORK                                               
         LA    R2,8(R2)                                                         
         JCT   R6,MVALCE15                                                      
*                                                                               
MVALCE22 TM    BYTE1,X'80'              Adding new element                      
         JNZ   MVALCE24                                                         
         LLC   RF,M_CLXLEN                                                      
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         CLC   ELEMENT,M_CLXEL          Check whether data changed              
         EX    RF,0(RE)                                                         
         JE    MVALCEIX                                                         
*                                                                               
MVALCE24 GOTOR ADDELT                                                           
*                                                                               
MVALCEIX J     EXITY                                                            
*                                                                               
MVALCER1 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$BUDGS),(5,=C'EC051'),=AL2(FLD340)            
         J     EXITN                    missing outlet scheme                   
*                                                                               
MVALCER2 LLH   RF,=AL2(0347)            Get correct budget code                 
         SR    RF,R6                                                            
         STH   RF,HALF1                                                         
         TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$BUDNF),(5,=C'EC052'),HALF1                   
         J     EXITN                    invalid budget code                     
*                                                                               
MVALCER3 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$INVIF),(5,=C'EC052'),=AL2(FLD357)            
         J     EXITN                                                            
         EJECT                                                                  
         DROP  R2,R3,R4,R7,RF,EL                                                
***********************************************************************         
* Validate buying agency                                              *         
***********************************************************************         
         SPACE 1                                                                
         USING QI_MFLDD,R4                                                      
         USING LIMACCD,R3                                                       
MVALBUY  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R7,AIO8                                                          
         USING T_D,R7                                                           
         USING M_CLIKEY,R2                                                      
         L     R2,AIO7                                                          
         L     R3,ALACCBLK                                                      
*                               ** Client level validation **                   
         TM    AC_IND1,AC_INEW2+AC_ILVL2 Product type record?                   
         JNZ   MVALB01                                                          
         OC    QI_BUYAG,QI_BUYAG   Any buying agency passed?                    
         JNZ   MVALB02                                                          
         TM    OA_MFLAG,OA_MFOFF   Office based media?  Then mandatory          
         JNZ   MVALBRR2                                                         
         TM    LIACTST,LIACTBAG    Test buying agency limit access              
         JZ    MVALBX                                                           
         J     MVALBRR1                                                         
*                              **  Product level validation **                  
MVALB01  TM    OA_MFLAG,OA_MCLBU   Client level buying agency?                  
         JNZ   MVALBX                                                           
         TM    OA_MFLAG,OA_MCACL   Not allowed client level limit acc           
         JNZ   MVALBRR8                                                         
         J     MVALB02                                                          
*                                                                               
MVALB02  LLC   RE,QI_BUYAG                                                      
         CHI   RE,255              Ensure not greater than 255                  
         JH    MVALBRR3                                                         
*                                                                               
         XC    DUB,DUB                                                          
         STC   RE,DUB+(MEDSCBUY-MEDSCNUM)                                       
         XC    WORK,WORK                                                        
         TM    AC_IND1,AC_INEW2+AC_ILVL2                                        
         JNZ   *+12                Skip if product                              
         TM    LIACTST,LIACTBAG    Test buying agency limit access              
         JZ    MVALB04                                                          
         TM    LAINDS,LAIINIT      Test initialised                             
         JNZ   *+6                                                              
         DC    H'0'                                                             
         MVI   WORK,LIACXCAG+LIACXLA1+LIACXLA2                                  
         GOTO1 VLIMACC,DMCB,(C'T',(R3)),(WORK,DUB)                              
         JNE   MVALBRR1                                                         
*                                                                               
MVALB04  LLC   RE,DUB+(MEDSCBUY-MEDSCNUM) Restore buying agency val             
         STC   RE,T_CPSTAT+(M_CLIBUYAG-M_CLISTAT) Store buy agency              
         OI    T_INDS,T_IUPDAT                                                  
*                                                                               
         USING M_AGYKEY,R2                                                      
         LA    R2,IOKEY                                                         
         XC    M_AGYKEY,M_AGYKEY   Set to read buying agy rec                   
         MVI   M_AGYKTYP,M_AGYKTYPQ                                             
         MVI   M_AGYKSTYP,M_AGYKSBAG                                            
         MVC   M_AGYKAGY,MEDAGYB                                                
         NI    M_AGYKAGY,X'F0'                                                  
         STC   RE,M_AGYKBAG                                                     
         L     R1,=AL4(IORDD+IOMEDDIR+IO1)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JNE   MVALBRR9                                                         
         TM    AC_IND1,AC_INEW2+AC_ILVL2 Only cli level from here on            
         JZ    MVALBX                                                           
*                                                                               
         TM    OA_MAGYI,M_AGYICCIQ Check for BA cli ind set                     
         JNO   MVALB06                                                          
         CLC   M_AGYBACIN,SPACES   Check BA client code                         
         JNH   MVALB06                                                          
         CLC   M_AGYBACIN,QA_ACT   FIRST 2 CHARS OF CLI CODE MUST BE            
         JNE   MVALBRR4            SAME AS BA CLI CODE - ELSE ERROR             
         CLI   LDGAL1,5            & MUST HAVE 5 CHARACTER CODE                 
         JNE   MVALBRR5                                                         
         TM    OA_MFLAG,OA_MFOFF   Office based media?                          
         JZ    MVALBX                                                           
         TM    OA_MAGY2,M_AGY2COQ  2CO?                                         
         JNZ   MVALB06                                                          
         CLC   QA_OFFC,SPACES      Any office passed?                           
         JNH   MVALBRR6                                                         
         J     MVALBX                                                           
*                                                                               
MVALB06  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMEDFIL+IO1'                           
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO1                                                          
         LA    RE,M_AGYELDQ(R2)                                                 
*                                                                               
         USING M_DBAG,RE                                                        
MVALB08  CLI   M_BAGEL,0                                                        
         JE    MVALBX                                                           
         CLI   M_BAGEL,M_BAGELQ                                                 
         JE    MVALB10                                                          
         LLC   R0,M_BAGLEN                                                      
         AR    RE,R0                                                            
         J     MVALB08                                                          
*                                                                               
MVALB10  CLC   M_BAGOFFIC,SPACES                                                
         JNH   MVALBRR6                                                         
         LA    RF,AC_OFF                                                        
         CLC   QA_OFFC,SPACES                                                   
         JNH   *+8                                                              
         LA    RF,QA_OFFC                                                       
         CLC   M_BAGOFFIC,0(RF)                                                 
         JNE   MVALBRR7                                                         
*                                                                               
MVALBX   J     EXITY                                                            
*                                                                               
MVALBRR1 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$SECLK),(5,=C'EC048'),=AL2(FLD324)            
         J     EXITN               Security lockout for limit access            
*                                                                               
MVALBRR2 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$BAGMN),(5,=C'EC063'),=AL2(FLD324)            
         J     EXITN               Office based so need buy agency              
*                                                                               
MVALBRR3 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$B1255),(5,=C'EC062'),=AL2(FLD324)            
         J     EXITN               Must be 1-255                                
*                                                                               
MVALBRR4 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$BCLIC),(5,=C'EC064'),=AL2(FLD324)            
         J     EXITN               First 2 chars of client code BA              
*                                                                               
MVALBRR5 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$CLIC5),(5,=C'EC065'),=AL2(FLD324)            
         J     EXITN               Client code too short                        
*                                                                               
MVALBRR6 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$IOFCQ),(5,=C'EC066'),=AL2(FLD093)            
         J     EXITN               Input to office required                     
*                                                                               
MVALBRR7 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$BMIXO),(5,=C'EC067'),=AL2(FLD093)            
         J     EXITN               Mixed offices                                
*                                                                               
MVALBRR8 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$PCLIM),(5,=C'EC068'),=AL2(FLD324)            
         J     EXITN               Client level limit access                    
*                                                                               
MVALBRR9 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$INBAG),(5,=C'EC069'),=AL2(FLD324)            
         J     EXITN               Invalid buying agency                        
         EJECT                                                                  
         DROP  R2,R3,R4,R7,RE                                                   
***********************************************************************         
* Validate media creative agency                                      *         
* **Note must be before VALCLI/VALPRO as sets OA_CISC profile         *         
***********************************************************************         
         SPACE 1                                                                
         USING LIMACCD,R3                                                       
         USING QI_MFLDD,R4                                                      
MVALCRE  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R7,AIO8                                                          
         USING T_D,R7                                                           
         USING M_CLIKEY,R2                                                      
         L     R2,AIO7                                                          
         L     R3,ALACCBLK                                                      
         XC    OA_OCAG,OA_OCAG                                                  
         CLI   QA_UPLD,QA_SAPTL    Not maintained in SAP                        
         JE    MVALCX                                                           
*                               ** Client level validation **                   
         TM    AC_IND1,AC_INEW2+AC_ILVL2 Product validation                     
         JNZ   MVALC02                                                          
         MVC   OA_OCAG,M_CLIAGY    Save client creative agency byte             
         OC    QI_CREAG,QI_CREAG   Any creative agency input?                   
         JNZ   MVALC06                                                          
         TM    LIACTST,LIACTCAG    Test creative agency limit access            
         JNZ   MVCRERR1                                                         
         MVC   OA_CISC,OA_AISC     Get profile from agency record               
         J     MVALCX                                                           
*                               ** Product level validation **                  
MVALC02  MVC   OA_OCAG,OA_MCLST+(M_CLIAGY-M_CLISTAT) client creat agy           
         OC    QI_CREAG,QI_CREAG   Any creative agency input?                   
         JZ    MVALC04                                                          
         TM    OA_MFLAG,OA_MCACL   Client level creative agency?                
         JNZ   MVCRERR1            Can't enter product one!                     
         J     MVALC06                                                          
*                                                                               
MVALC04  OC    OA_OCAG,OA_OCAG     Any client creative agency?                  
         JNZ   MVALC08             Read client creative agency                  
         MVC   OA_CISC,OA_AISC     Get profile from agency record               
         J     MVALCX                                                           
*                                                                               
MVALC06  LLC   RE,QI_CREAG                                                      
         CHI   RE,255              Ensure not greater than 255                  
         JH    MVCRERR2                                                         
*                                                                               
         XC    DUB,DUB                                                          
         STC   RE,DUB+(MEDSCCRE-MEDSCNUM)                                       
         OI    T_INDS,T_IUPDAT                                                  
         STC   RE,T_CPSTAT+(M_CLIAGY-M_CLISTAT)                                 
         STC   RE,OA_OCAG                                                       
*                                                                               
         TM    AC_IND1,AC_INEW2+AC_ILVL2 If product no lim access check         
         JNZ   *+12                                                             
         TM    LIACTST,LIACTCAG    Test creative agency limit access            
         JZ    MVALC08                                                          
         TM    LAINDS,LAIINIT      TEST INITIALISED                             
         JNZ   *+6                                                              
         DC    H'0'                                                             
         XC    WORK,WORK                                                        
         MVI   WORK,LIACXBAG+LIACXLA1+LIACXLA2                                  
         GOTO1 VLIMACC,DMCB,(C'T',(R3)),(WORK,DUB)                              
         JNE   MVCRERR1                                                         
*                                                                               
         USING M_AGYKEY,R2                                                      
MVALC08  LA    R2,IOKEY            Restore creative agency value                
         XC    M_AGYKEY,M_AGYKEY   Set to read creative agy rec                 
         MVI   M_AGYKTYP,M_AGYKTYPQ                                             
         MVC   M_AGYKAGY,MEDAGYB                                                
         NI    M_AGYKAGY,X'F0'                                                  
         MVC   M_AGYKCAG,OA_OCAG                                                
         MVI   M_AGYKSTYP,M_AGYKSCAG                                            
         L     R1,=AL4(IORDD+IOMEDDIR+IO1)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JNE   MVCRERR3                                                         
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMEDFIL+IO1'                           
         JE    *+6                                                              
         DC    H'0'                                                             
         MVI   OA_CISC,0           Set to cagelq if sq a/c exists               
         L     R2,AIO1                                                          
         GOTO1 VHELLO,DMCB,(C'G',MEDFIL),('M_CAGELQ',M_AGYKEY),0,0              
         CLI   12(R1),6            MISSING                                      
         JE    MVALCX                                                           
         MVI   OA_CISC,M_CAGELQ    INDICATE FOUND (SO SQ A/C EXISTS             
*                                                                               
MVALCX   J     EXITY                                                            
*                                                                               
MVCRERR1 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$SECLK),(5,=C'EC048'),=AL2(FLD325)            
         J     EXITN               Security lockout for limit access            
*                                                                               
MVCRERR2 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$CNOOF),(5,=C'EC062'),=AL2(FLD325)            
         J     EXITN               Must be 1-255                                
*                                                                               
MVCRERR3 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$INCAG),(5,=C'EC070'),=AL2(FLD325)            
         J     EXITN               Invalid creative agency                      
         DROP  R2,R3,R4,R7                                                      
         EJECT                                                                  
***********************************************************************         
* PRODUCT PROSTAT/PROEL                                                         
* ON NTRY R4=A(MEDIA FIELD ARRAY)                                               
***********************************************************************         
         SPACE 1                                                                
         USING QI_MFLDD,R4                                                      
         USING M_PROKEY,R2                                                      
         USING T_D,R7                                                           
MVALPRO  NTR1  LABEL=*,BASE=*                                                   
*                                                                               
         L     R2,AIO7                  Ensure we have a product                
         L     R7,AIO8                                                          
*                                                                               
         TM    AC_IND1,AC_INEW2+AC_ILVL2 Only for product type                  
         JZ    MVALCLX                                                          
         MVI   BYTE1,0                                                          
*                                                                               
         NI    T_CPSTAT,X'FF'-X'80'     Switch off delete marker                
*                                                                               
         CLI   QA_UPLD,QA_SAPTL        If upload tool can't add filter          
         JNE   MVALPR02                                                         
         CLI   T_ACTION,C'A'            If adding always set locked             
         JE    MVALPR04                                                         
         TM    T_CPSTAT,M_PROLOCKQ      If already locked keep locked           
         JNZ   MVALPR04                                                         
MVALPR02 CLI   QI_LOCK,YESQ             Or else let the user choose             
         JE    MVALPR04                                                         
         NI    T_CPSTAT,X'FF'-M_PROLOCKQ Product lock                           
         J     *+8                                                              
MVALPR04 OI    T_CPSTAT,M_PROLOCKQ                                              
*                                                                               
         GOTO1 VHELLO,DMCB,(C'G',MEDFIL),('M_PROELQ',M_PROKEY),0                
         CLI   12(R1),0                                                         
         JE    MVALPR06                                                         
*                                                                               
EL       USING M_PROEL,ELEMENT                                                  
         XC    ELEMENT,ELEMENT          Build element                           
         MVI   EL.M_PROEL,M_PROELQ                                              
         MVI   EL.M_PROLEN,M_PROLENQ                                            
         OI    BYTE1,X'80'                                                      
         J     MVALPR08                                                         
*                                                                               
         USING M_PROEL,R3                                                       
EL       USING M_PROEL,ELEMENT                                                  
MVALPR06 L     R3,12(R1)                                                        
         LLC   RF,M_PROLEN                                                      
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   ELEMENT(0),M_PROEL                                               
         EX    RF,0(RE)                                                         
*                                                                               
         USING TRAVD,TRAVWRK                                                    
MVALPR08 LLC   RE,QI_CREAG                                                      
         CHI   RE,255              Ensure not greater than 255                  
         JH    MVALPRRA                                                         
*                                                                               
         STC   RE,EL.M_PROAGY                                                   
         STC   RE,OA_OCAG                                                       
*                                                                               
         MVC   EL.M_PRONAME,QA_NAME     Write back new name                     
         OC    EL.M_PRONAME,SPACES                                              
         CLI   QA_UPLD,QA_SAPTL         Not maintained in SAP tool              
         JE    MVALPR10                                                         
         CLC   QI_MEDCM,SPACES          Any media commisson rate?               
         JNH   MVALPR10                                                         
         OC    QI_MEDCM,SPACES          Make upper case                         
*                                                                               
         XC    TRAVBLK(TRAVBLKL),TRAVBLK                                        
*                                                                               
         LLC   RE,QI_MEDCL                                                      
         STC   RE,TRAILEN               Set total input length                  
*                                                                               
         LA    RF,QI_MEDCM                                                      
         CLI   0(RF),C' '               Locate first blank character            
         JNH   *+12                                                             
         LA    RF,1(RF)                                                         
         JCT   RE,*-12                                                          
*                                                                               
         LA    RE,QI_MEDCM                                                      
         SR    RF,RE                                                            
         STC   RF,TRAILEN                                                       
*                                                                               
         MVI   TRAACT,TRAAVALQ+TRAAFLDQ                                         
         MVI   TRAFLD,TRAFAGYC                                                  
         MVC   SVMEDCM,QI_MEDCM                                                 
         LA    RF,SVMEDCM                                                       
         STCM  RF,7,TRAIADD             Save address and length                 
*                                                                               
         XC    WORK,WORK                                                        
         LA    RF,WORK                                                          
         STCM  RF,7,TRAOADD                                                     
         L     RF,ACOMFACS                                                      
         STCM  RF,7,TRACOMF                                                     
         MVC   TRAVAGYO,CUCBIT          Agency country option                   
         MVC   TRAVAGYC,CUCTRY          Agency country                          
         MVC   TRAVLANG,CULANG          Agency language                         
         GOTO1 VTRVAIL,TRAVBLK                                                  
         JNE   MVALPRR1                                                         
         MVC   EL.M_PROCOMTY,WORK       Set client record                       
         MVC   EL.M_PROCOMRT,WORK+1     With commission                         
         MVC   EL.M_PROCOMT2,WORK+3                                             
         MVC   EL.M_PROCOMR2,WORK+4                                             
         CLI   EL.M_PROCOMT2,0                                                  
         JE    MVALPR10                                                         
         CLI   EL.M_PROAGY,0       Split comm required creative agency          
         JNE   *+12                check if set at client level                 
         CLI   OA_MCLST+M_CLIAGY-M_CLISTAT,0                                    
         JE    MVALPRR7                                                         
         TM    EL.M_PROCOMT2,X'C0' If split requires posting to creat           
         JZ    MVALPR10            agency check we have SQ                      
         CLI   OA_CISC,M_CAGELQ                                                 
         JNE   MVALPRR8                                                         
*                                                                               
MVALPR10 CLI   QA_UPLD,QA_SAPTL    Not maintained in SAP                        
         JE    *+10                                                             
         MVC   EL.M_PROCHAR,QI_PROPC                                            
         CLI   T_ACTION,C'A'       If adding new record must have               
         JNE   *+14                short name                                   
         CLC   QA_SHNAM,SPACES                                                  
         JNH   MVALPRR9                                                         
         CLC   QA_SHNAM,SPACES                                                  
         JNH   *+10                                                             
         MVC   EL.M_PROSH,QA_SHNAM      Short name                              
         OC    EL.M_PROSH,SPACES                                                
*                                                                               
         USING TRAVD,TRAVWRK                                                    
         MVC   WORK,SPACES                                                      
         MVC   EL.M_PROVATTY,SPACES     default to inherit-from-client          
         CLC   QI_MVATY,SPACES          Any vat type passed?                    
         JNH   MVALPR16                                                         
* Explicit value passed                                                         
         OC    QI_MVATY,SPACES          Ensure u/c                              
         XC    TRAVBLK(TRAVBLKL),TRAVBLK                                        
         MVI   TRAACT,TRAAVALQ+TRAAFLDQ                                         
         MVI   TRAFLD,TRAFVATY                                                  
         MVI   TRAILEN,L'QI_MVATY-1                                             
         MVC   BYTE2,QI_MVATY                                                   
         LA    R0,BYTE2                                                         
         STCM  R0,7,TRAIADD                                                     
         LA    R0,WORK                                                          
         STCM  R0,7,TRAOADD                                                     
         L     R0,ACOMFACS                                                      
         STCM  R0,7,TRACOMF                                                     
         MVC   TRAVAGYO,CUCBIT          Agency country option                   
         MVC   TRAVAGYC,CUCTRY          Agency country                          
         MVC   TRAVLANG,CULANG          Agency language                         
         GOTO1 VTRVAIL,TRAVBLK                                                  
         JNE   MVALPRR6                                                         
         CLC   OA_CVAT,WORK             Same vat type as client?                
         JE    MVALPR16                 inherit-from-client                     
         MVC   EL.M_PROVATTY,WORK       Set vat type                            
*                                                                               
         CLC   EL.M_PROVATTY,SPACES       if product is 'standard'              
         JNE   MVALPR16                                                         
         CLC   OA_CVAT,SPACES           and client not 'standard'               
         JE    MVALPR16                                                         
         MVC   EL.M_PROVATTY,AC@STD       Set 'Override to standard'            
*                                                                               
MVALPR16 TM    BYTE1,X'80'                                                      
         JNZ   MVALPR18                                                         
         LLC   RF,M_PROLEN                                                      
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         CLC   M_PROEL(0),ELEMENT       Has the data changed?                   
         EX    RF,0(RE)                                                         
         JE    MVALPROX                                                         
*                                                                               
MVALPR18 GOTOR ADDELT                                                           
*                                                                               
MVALPROX J     EXITY                                                            
*                                                                               
MVALPRR1 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$IVRAT),(5,=C'EC053'),=AL2(FLD321)            
         J     EXITN                    Invalid commission rate                 
*                                                                               
MVALPRR5 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$INVPC),(5,=C'EC058'),=AL2(FLD336)            
         J     EXITN                    INVALID SURCHARGE %                     
*                                                                               
MVALPRR6 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$INVVI),(5,=C'EC056'),=AL2(FLD322)            
         J     EXITN                    Invalid vat type                        
*                                                                               
MVALPRR7 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$INCAG),(5,=C'EC071'),=AL2(FLD325)            
         J     EXITN                    Missing creative agency                 
*                                                                               
MVALPRR8 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$MISSQ),(5,=C'EC072'),=AL2(FLD321)            
         J     EXITN                    Missing SQ account                      
*                                                                               
MVALPRR9 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$CLSNM),(5,=C'EC078'),=AL2(FLD011)            
         J     EXITN                    Missing short name                      
*                                                                               
MVALPRRA TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$CNOOF),(5,=C'EC062'),=AL2(FLD325)            
         J     EXITN               Must be 1-255                                
         DROP  R2,R3,R4,R7,EL                                                   
         EJECT                                                                  
***********************************************************************         
* CLIENT/PRODUCT FORELQ                                               *         
***********************************************************************         
         SPACE 1                                                                
         USING QI_MFLDD,R4                                                      
MVALFOR  NTR1  LABEL=*,BASE=*                                                   
         CLI   QA_UPLD,QA_SAPTL         Not maintained in SAP                   
         JE    MVALFOX                                                          
*                                                                               
         L     R7,AIO8                                                          
         USING T_D,R7                                                           
         USING M_CLIKEY,R2                                                      
         CLI   QI_BILCU,C' '            Any currency type passed?               
         JNH   MVALFOX                                                          
*                                                                               
         OC    QI_BILCU,SPACES          Ensure upper case                       
         L     R2,AIO7                                                          
         MVI   BYTE1,0                                                          
         XC    ELEMENT,ELEMENT                                                  
         GOTO1 VHELLO,DMCB,(C'G',MEDFIL),('M_FORELQ',M_CLIKEY),0                
         CLI   12(R1),0                                                         
         JE    MVALFO04                                                         
*                                                                               
EL       USING M_FOREL,ELEMENT                                                  
         USING M_FOREL,R3                                                       
         OI    BYTE1,X'80'              Establish new element                   
         MVI   EL.M_FOREL,M_FORELQ                                              
         MVI   EL.M_FORLEN,M_FORLENQ                                            
         J     MVALFO05                                                         
*                                                                               
MVALFO04 L     R3,12(R1)                                                        
         LLC   RF,M_FORLEN              Copy element                            
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   ELEMENT(0),M_FOREL                                               
         EX    RF,0(RE)                                                         
*                                                                               
MVALFO05 MVI   EL.M_FORSTAT,0                                                   
         CLC   OA_CCURC,QI_BILCU        Agency currency 1?                      
         JNE   *+12                                                             
         LA    RF,OA_CCURC                                                      
         J     MVALFO07                                                         
         CLC   OA_CCUR2,QI_BILCU        Agency currency 2?                      
         JNE   MVALFO10                                                         
         LA    RF,OA_CCUR2                                                      
*                                                                               
MVALFO07 TM    OA_MIND3,M_MEDEUROQ      Euro bit set for media?                 
         JNO   MVALFOX                                                          
         CLI   QI_BILCL,L'OA_CCURC      Check entry is too long                 
         JH    MVALFRR1                                                         
         MVI   BYTE1,M_FOREBILQ         Move correct bit setting into           
         CLC   0(L'OA_CCURC,RF),=C'EUR' byte                                    
         JE    *+8                                                              
         MVI   BYTE1,M_FORMBILQ                                                 
         OC    EL.M_FORSTAT,BYTE1                                               
         J     MVALFO14                                                         
*                                                                               
MVALFO10 LLC   RE,QI_BILCL                                                      
         BCTR  RE,0                                                             
         TM    OA_MIND1,M_MEDLOCLQ      Other values only valid for             
         JNO   MVALFRR2                 international media                     
         CLI   CUCTRY,CTRYGER                                                   
         JE    MVALFO12                                                         
         BASR  RF,0                                                             
         CLC   QI_BILCU(0),AC@LOCAL     Local (UK only)                         
         EX    RE,0(RF)                                                         
         JNE   MVALFO12                                                         
         OI    EL.M_FORSTAT,M_FORLBILQ                                          
         J     MVALFO14                                                         
*                                                                               
MVALFO12 BASR  RF,0                                                             
         CLC   QI_BILCU(0),AC@BGT       Budget currency?                        
         EX    RE,0(RF)                                                         
         JNE   MVALFRR3                                                         
         CLI   AC_ACLVL,AC_LVL2         Product level?                          
         JNE   *+12                                                             
         TM    OA_CBST,M_FORBBILQ       Must have budget specified              
         JZ    MVALFRR4                 at client level as well                 
         OI    EL.M_FORSTAT,M_FORBBILQ                                          
         CLI   AC_ACLVL,AC_LVL1         Only for client                         
         JH    MVALFO14                                                         
         CLC   QI_BDGCU,SPACES          Must be passed                          
         JNH   MVALFRR5                                                         
         MVC   EL.M_FORCURR,QI_BDGCU                                            
*                                                                               
MVALFO14 TM    BYTE1,X'80'              New element?                            
         JNZ   MVALFO06                                                         
         LLC   RF,M_FORLEN                                                      
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         CLC   ELEMENT(0),M_FOREL       ANY CHANGE TO THE DATA?                 
         EX    RF,0(RE)                                                         
         JE    MVALFOX                                                          
*                                                                               
MVALFO06 GOTOR ADDELT                                                           
*                                                                               
MVALFOX  J     EXITY                                                            
*                                                                               
MVALFRR1 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$FLDTL),(5,=C'EC103'),=AL2(FLD339)            
         J     EXITN               Billing currency too long                    
*                                                                               
MVALFRR2 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$CNOTI),(5,=C'EC104'),=AL2(FLD339)            
         J     EXITN               Not international media                      
*                                                                               
MVALFRR3 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$INCTY),(5,=C'EC084'),=AL2(FLD339)            
         J     EXITN               Invalid billing currency                     
*                                                                               
MVALFRR4 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$NBDCC),(5,=C'EC113'),=AL2(FLD339)            
         J     EXITN               Invalid billing currency                     
*                                                                               
MVALFRR5 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$BDCMI),(5,=C'EC121'),=AL2(FLD338)            
         J     EXITN                                                            
         DROP  R2,R3,R4,R7,EL                                                   
         EJECT                                                                  
***********************************************************************         
* Validate commission account                                         *         
***********************************************************************         
         USING QI_MFLDD,R4                                                      
MVALCAC  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R7,AIO8                                                          
         USING T_D,R7                                                           
         USING M_CLIKEY,R2                                                      
         L     R2,AIO7                                                          
         TM    AC_IND1,AC_INEW2+AC_ILVL2 Only for client                        
         JNZ   MVALCACX                                                         
         CLI   QA_UPLD,QA_SAPTL         Not maintained in SAP                   
         JE    MVALCACX                                                         
         CLC   QI_COMAC,SPACES          Any commission account passed?          
         JNH   MVALCACX                                                         
         GOTO1 VHELLO,DMCB,(C'G',MEDFIL),('M_ULAELQ',M_CLIKEY),0                
         CLI   12(R1),0                 Find any existing element               
         JE    MVALA02                                                          
*                                                                               
         USING M_DULA,R3                                                        
EL       USING M_DULA,ELEMENT           Build new element                       
MVALA00  XC    EL.M_ULAEL(M_ULALENQ),EL.M_ULAEL                                 
         MVI   EL.M_ULAEL,M_ULAELQ                                              
         MVI   EL.M_ULALEN,M_ULALENQ                                            
         MVI   EL.M_ULATYPE,M_ULATINCQ                                          
         J     MVALA04                                                          
*                                                                               
MVALA02  L     R3,12(R1)                                                        
         LLC   RF,M_ULALEN              Extract old element                     
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   EL.M_ULAEL(0),M_ULAEL                                            
         EX    RF,0(RE)                                                         
*                                                                               
         USING ACTRECD,R2                                                       
MVALA04  MVC   IOKEY,SPACES             Read account to check that              
         LA    R2,IOKEY                 it exists                               
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(2),=C'SI'                                                
         MVC   ACTKACT,QI_COMAC                                                 
         OC    ACTKACT,SPACES                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    MVALA06                  error invalid account                   
         TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$ICOMC),(5,=C'EC073'),=AL2(FLD337)            
         J     EXITN                    Commission account does not             
*                                                                               
MVALA06  MVC   EL.M_ULAUNIT(L'M_ULAUNIT+L'M_ULALEDG),=C'SI'                     
         MVC   EL.M_ULAACC,QI_COMAC                                             
         GOTOR ADDELT                                                           
MVALCACX J     EXITY                                                            
*                                                                               
         DROP  R2,R4,R7,EL              exist                                   
         EJECT                                                                  
***********************************************************************         
* Update media copy of accounting data on DTXT                        *         
***********************************************************************         
         SPACE 1                                                                
         USING M_CLIKEY,R2                                                      
         USING QI_MFLDD,R4                                                      
         USING TXTTABD,R5                                                       
         USING T_D,R7                                                           
MVALTXT  NTR1  BASE=*,LABEL=*                                                   
         L     R7,AIO8                                                          
         L     R3,AIO3                                                          
         LA    R3,ACTRFST-ACTRECD(R3)                                           
         L     R2,AIO7                                                          
*                               ** Elements to do a straight copy **            
         USING FFTELD,R3                                                        
MVALT02  CLI   FFTEL,0             E-O-RECORD                                   
         JE    MVALT18             REG NUMBER MUST HAVE BEEN REMOVED            
         CLI   FFTEL,FFTELQ        FIND VAT REG ELEMENT                         
         JE    MVALT06                                                          
MVALT04  LLC   R0,FFTLN                                                         
         AR    R3,R0                                                            
         J     MVALT02                                                          
*                                                                               
MVALT06  LA    R5,TXTCOPY          Table of media text elements                 
*                                                                               
MVALT08  CLI   0(R5),X'FF'         End of table?                                
         JE    MVALT04                                                          
         CLC   FFTTYPE,TXTACCC     Match on type?                               
         JE    MVALT10                                                          
         AHI   R5,TXTTABL                                                       
         J     MVALT08                                                          
*                                                                               
OLD      USING DTXT,ELEMENT2                                                    
NEW      USING DTXT,ELEMENT                                                     
MVALT10  XC    ELEMENT2,ELEMENT2   See if element exists already                
         GOTO1 VHELLO,DMCB,(C'G',MEDFIL),('TXTELQ',M_CLIKEY),          +        
               (1,TXTMEDC)                                                      
         CLI   12(R1),0                                                         
         JNE   MVALT12                                                          
         L     RF,12(R1)                                                        
         LLC   RE,TXTLEN-TXTEL(RF)                                              
         BCTR  RE,0                                                             
         BASR  R1,0                                                             
         MVC   ELEMENT2(0),0(RF)   Store off element if found                   
         EX    RE,0(R1)                                                         
*                                                                               
MVALT12  LA    RF,FFTDATA                                                       
         LLC   RE,FFTDLEN                                                       
         BCTR  RE,0                                                             
*                                                                               
         XC    ELEMENT,ELEMENT                                                  
         MVI   NEW.TXTEL,TXTELQ    If not add it!                               
         MVC   NEW.TXTTYPE,BYTE1                                                
         BASR  R1,0                                                             
         MVC   NEW.TXTTEXT(0),0(RF)                                             
         EX    RE,0(R1)                                                         
         LA    RE,TXTTEXT-DTXT+1(RE)                                            
         STC   RE,NEW.TXTLEN                                                    
*                                                                               
         OC    ELEMENT2,ELEMENT2   Any previous element                         
         JZ    MVALT16                                                          
         CLC   OLD.TXTLEN,NEW.TXTLEN                                            
         JNE   MVALT16             Check same length                            
         LLC   RF,OLD.TXTLEN                                                    
         BCTR  RF,0                                                             
         BASR  R1,0                                                             
         CLC   OLD.TXTEL(0),NEW.TXTEL                                           
         EX    RF,0(R1)                                                         
         JE    MVALT04             Check same element                           
*                                                                               
MVALT16  GOTOR ADDELT                                                           
         J     MVALT04                                                          
         DROP  OLD,NEW                                                          
*                              **  Elements from media or accounting **         
MVALT18  CLI   CUCTRY,CTRYGER      Ignore these for Germany                     
         JE    MVALT34             See if element exists already                
         LA    R5,TXTTAB           Table of media text elements                 
*                                                                               
MVALT20  CLI   0(R5),X'FF'         Hit end of element                           
         JE    MVALT34                                                          
         L     R3,AIO3                                                          
         XC    ELEMENT2,ELEMENT2                                                
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('FFTELQ',0(R3)),             +        
               (1,TXTACCC)                                                      
         CLI   12(R1),0                                                         
         JNE   MVALT22                                                          
         L     RF,12(R1)                                                        
         LLC   RE,FFTLN                                                         
         BCTR  RE,0                                                             
         BASR  R1,0                                                             
         MVC   ELEMENT2(0),0(RF)   Store off from accounting                    
         EX    RE,0(R1)                                                         
*                                                                               
MVALT22  XC    ELEMENT3,ELEMENT3                                                
         GOTO1 VHELLO,DMCB,(C'G',MEDFIL),('TXTELQ',M_CLIKEY),          +        
               (1,TXTMEDC)                                                      
         CLI   12(R1),0                                                         
         JNE   MVALT24                                                          
         L     RF,12(R1)                                                        
         LLC   RE,TXTLEN-TXTEL(RF)                                              
         BCTR  RE,0                                                             
         BASR  R1,0                                                             
         MVC   ELEMENT3(0),0(RF)   Store for later                              
         EX    RE,0(R1)                                                         
*                                                                               
MVALT24  LA    R3,ELEMENT2                                                      
         LLH   RF,TXTDISP                                                       
         AR    RF,R4                                                            
         LLC   RE,0(RF)            Any field passed?                            
         LTR   RE,RE                                                            
         JZ    MVALT26                                                          
         LA    RF,1(RF)                                                         
         J     MVALT28                                                          
*                                                                               
NEW      USING DTXT,ELEMENT                                                     
OLD      USING DTXT,ELEMENT3                                                    
MVALT26  OC    ELEMENT2,ELEMENT2   Any accounting element?                      
         JZ    MVALT32                                                          
         LA    R3,ELEMENT2                                                      
         LLC   RE,FFTDLEN          Take from accounting                         
         LA    RF,FFTDATA                                                       
*                                                                               
MVALT28  XC    ELEMENT,ELEMENT                                                  
         MVI   NEW.TXTEL,TXTELQ    If not add it!                               
         MVC   NEW.TXTTYPE,TXTMEDC                                              
         BCTR  RE,0                                                             
         BASR  R1,0                                                             
         MVC   NEW.TXTTEXT(0),0(RF)                                             
         EX    RE,0(R1)                                                         
         LA    RE,TXTTEXT-DTXT+1(RE)                                            
         STC   RE,NEW.TXTLEN                                                    
*                                                                               
         OC    ELEMENT3,ELEMENT3  Any previous txtel element?                   
         JZ    MVALT30                                                          
         CLC   OLD.TXTLEN,NEW.TXTLEN                                            
         JNE   MVALT30            Check same length                             
         LLC   RF,OLD.TXTLEN                                                    
         BCTR  RF,0                                                             
         BASR  R1,0                                                             
         CLC   OLD.TXTEL(0),NEW.TXTEL                                           
         EX    RF,0(R1)                                                         
         JE    MVALT32            Check same data                               
*                                                                               
MVALT30  GOTOR ADDELT                                                           
*                                                                               
MVALT32  AHI   R5,TXTTABL                                                       
         J     MVALT20                                                          
         DROP  OLD,NEW                                                          
*                                  ** Media comments (Ger only) **              
MVALT34  LLC   RF,QI_MCOML            Anything input?                           
         LTR   RF,RF                                                            
         JZ    MVALT38                                                          
         GOTO1 VHELLO,DMCB,(C'G',MEDFIL),('TXTELQ',M_CLIKEY),          +        
               (1,=AL1(TXTITXTQ))                                               
         CLI   12(R1),0                                                         
         JNE   MVALT36                                                          
*                                                                               
         L     RF,12(R1)                                                        
         USING DTXT,RF                                                          
         LLC   RE,QI_MCOML            Check same length of input                
         CLM   RE,1,TXTLEN                                                      
         JNE   MVALT36                                                          
         BCTR  RE,0                                                             
         BASR  R1,0                                                             
         CLC   QI_MCOMM(0),TXTTEXT    Media comments                            
         EX    RE,0(R1)                                                         
         JE    MVALT38                                                          
         DROP  RF                                                               
*                                                                               
EL       USING DTXT,ELEMENT                                                     
MVALT36  XC    ELEMENT,ELEMENT                                                  
         MVI   EL.TXTEL,TXTELQ                                                  
         MVI   EL.TXTTYPE,TXTITXTQ                                              
         LLC   RE,QI_MCOML                                                      
         BCTR  RE,0                                                             
         BASR  RF,0                                                             
         MVC   EL.TXTTEXT(0),QI_MCOMM                                           
         EX    RE,0(RF)                                                         
         LA    RE,TXTTEXT-DTXT+1(RE)                                            
         STC   RE,EL.TXTLEN                                                     
         GOTOR ADDELT                                                           
*                                                                               
MVALT38  CLI   CUCTRY,CTRYGER         Only for Germany                          
         JNE   MVALTX                                                           
         GOTO1 VHELLO,DMCB,(C'G',MEDFIL),('TXTELQ',M_CLIKEY),          +        
               (1,=AL1(TXTTAXQ))                                                
         CLI   12(R1),0                                                         
         JNE   MVALT40                                                          
*                                                                               
         L     RF,12(R1)                                                        
         USING DTXT,RF                                                          
         LLC   RE,QA_VATL             Check same length of input                
         CLM   RE,1,TXTLEN                                                      
         JNE   MVALT40                                                          
         BCTR  RE,0                                                             
         BASR  R1,0                                                             
         CLC   QA_VAT(0),TXTTEXT      Media comments                            
         EX    RE,0(R1)                                                         
         JE    MVALTX                                                           
*                                                                               
EL       USING DTXT,ELEMENT                                                     
MVALT40  XC    ELEMENT,ELEMENT                                                  
         MVI   EL.TXTEL,TXTELQ                                                  
         MVI   EL.TXTTYPE,TXTTAXQ                                               
         LLC   RE,QA_VATL                                                       
         BCTR  RE,0                                                             
         BASR  RF,0                                                             
         MVC   EL.TXTTEXT(0),QA_VAT                                             
         EX    RE,0(RF)                                                         
         LA    RE,TXTTEXT-DTXT+1(RE)                                            
         STC   RE,EL.TXTLEN                                                     
         GOTOR ADDELT                                                           
*                                                                               
MVALTX   J     EXITY                                                            
         EJECT                                                                  
         DROP  R2,R3,R4,R5,RF,EL                                                
***********************************************************************         
* ADD COMMISSION TEXT ELEMENT                                         *         
***********************************************************************         
         SPACE 1                                                                
         USING QI_MFLDD,R4                                                      
         USING T_D,R7                                                           
         USING M_CLIKEY,R2                                                      
MVALFNM  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R7,AIO8                                                          
         L     R2,AIO7                                                          
         MVI   BYTE1,0                                                          
         CLI   CUCTRY,CTRYGER         Only Germans have free form text          
         JNE   EXITY                                                            
*                                                                               
         CLI   QA_ASTAT,QA_ANEW       Is this a new account                     
         JNE   *+14                   Yes                                       
         CLC   QI_MEDCM,SPACES        If no entry ignore                        
         JNH   EXITY                                                            
*                                                                               
         GOTO1 VHELLO,DMCB,(C'G',MEDFIL),('M_FNMELQ',M_CLIKEY),0                
         CLI   12(R1),0               Find any existing element                 
         JNE   MVALFN00                                                         
*                                                                               
         L     R3,12(R1)              Delete old element                        
         MVI   0(R3),X'FF'                                                      
         GOTO1 VHELLO,DMCB,(C'D',MEDFIL),('M_FNMELQ',M_CLIKEY),0                
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
*                                     Check for any commission free             
MVALFN00 LLC   R1,QI_MEDCL                                                      
         LA    RF,QI_MEDCM            form text element                         
*                                                                               
         CLI   0(RF),C' '             locate 1st blank/non character            
         JNH   MVALFN01                                                         
         LA    RF,1(RF)                                                         
         JCT   R1,*-12                                                          
         J     EXITY                  No commission rule so exit                
*                                                                               
MVALFN01 AHI   R1,1                                                             
         LLC   R0,QI_MEDCL                                                      
         SR    RE,R0                                                            
         JZ    EXITY                                                            
         JP    *+6                                                              
         DC    H'0'                                                             
         LR    R1,RE                                                            
         BCTR  R1,0                                                             
         CHI   R1,MAXCTXTQ                                                      
         JNH   MVALFN01                                                         
*                                                                               
         AHI   RE,L'M_FNMEL+L'M_FNMLEN  RE=L'FNMEL element                      
*                                                                               
EL       USING M_FNMEL,ELEMENT                                                  
         XC    ELEMENT,ELEMENT          Build element                           
         MVI   EL.M_FNMEL,M_FNMELQ                                              
         STC   RE,EL.M_FNMLEN                                                   
*                                                                               
         BASR  RE,0                                                             
         MVC   EL.M_FNMNAME(0),0(RF)                                            
         EX    R1,0(RE)                                                         
*                                                                               
         GOTOR ADDELT                                                           
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* VALIDATE CLIENT/PRODUCT ADDRESS ON MEDIA                            *         
***********************************************************************         
         SPACE 1                                                                
         USING QI_MFLDD,R4                                                      
MVALADDR NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R7,AIO8                                                          
         USING T_D,R7                                                           
         USING M_CLIKEY,R2                                                      
         L     R2,AIO7                                                          
         MVI   BYTE1,0                                                          
         NI    AC_IND2,FF-AC_IADR5                                              
         XC    ELEMENT,ELEMENT          Establish new element                   
         GOTO1 VHELLO,DMCB,(C'G',MEDFIL),('M_ADDELQ',M_CLIKEY),0                
         CLI   12(R1),0                 Find any existing element               
         JNE   MVALAD00                                                         
         USING M_ADDEL,R3                                                       
         L     R3,12(R1)                (added this missing instr.)             
         CLI   CUCTRY,CTRYGER           Germany: client or product?             
         JNE   MVALAD02                                                         
         TM    AC_IND1,AC_ILVL1+AC_ILVL2+AC_INEW1+AC_INEW2                      
         JZ    MVALAD02                                                         
         OI    AC_IND2,AC_IADR5                                                 
         CLI   M_ADDLEN,M_ADDLEN5Q      If short element enlarge it             
         JE    MVALAD02                                                         
         LLC   RF,M_ADDLEN                                                      
         SHI   RF,1                                                             
         BASR  R1,0                                                             
         MVC   ELEMENT(0),M_ADDEL                                               
         EX    RF,0(R1)                                                         
         MVI   M_ADDEL,FF                                                       
         GOTO1 VHELLO,DMCB,(C'D',MEDFIL),('FF',M_CLIKEY),0                      
         MVI   ELEMENT+M_ADDLEN-M_ADDEL,M_ADDLEN5Q                              
         GOTO1 VHELLO,DMCB,(C'P',MEDFIL),M_CLIKEY,M_ADDEL                       
         CLI   12(R1),0                                                         
         JNE   *+2                                                              
         L     R3,16(R1)           R1=A(ADDRESS ELEMENT IN I/O BLOCK)           
         XC    ELEMENT,ELEMENT                                                  
         J     MVALAD02                                                         
*                                                                               
         USING M_ADDEL,R3                                                       
EL       USING M_ADDEL,ELEMENT                                                  
MVALAD00 OI    BYTE1,X'80'              Set adding brand new element            
         CLI   CUCTRY,CTRYGER           Germany: client or product?             
         JNE   MVALAD01                                                         
         TM    AC_IND1,AC_ILVL1+AC_ILVL2+AC_INEW1+AC_INEW2                      
         JZ    MVALAD01                                                         
         OI    AC_IND2,AC_IADR5                                                 
MVALAD01 TM    AC_IND1,AC_INEW2+AC_ILVL2 Only for client type                   
         JNZ   MVALAD02                                                         
         CLC   QI_MADD1,SPACES          Any media address?                      
         JH    MVALAD02                                                         
         XR    RF,RF                                                            
         ICM   RF,7,QA_AADDR            Must have at least 1st line!            
         JZ    MVALADRR                                                         
         AHI   RF,LW_LN2Q               RF=A(first address line data)           
*                                                                               
MVALAD02 MVI   EL.M_ADDEL,M_ADDELQ                                              
         XR    RF,RF                    (RF)=list of addresses                  
         LA    R2,EL.M_ADD1             (R0)=no. of address                     
*                                                                               
         TM    AC_IND2,AC_IADR5                                                 
         JNZ   MVALAD03                                                         
         MVI   EL.M_ADDLEN,M_ADDLEN1Q                                           
         MVC   0(L'M_ADD1+L'M_ADD2+L'M_ADD3+L'M_ADD4,R2),SPACES                 
         J     MVALAD04                                                         
*                                                                               
MVALAD03 MVI   EL.M_ADDLEN,M_ADDLEN5Q   Set length=5 + init 5 lines             
         MVC   0(M_ADD6-M_ADD1,R2),SPACES                                       
*                                       (RE)=length of address entry            
*                                       (R1)=location to move to                
*                                                                               
MVALAD04 CLC   QI_MADD1,SPACES          Any media address?                      
         JNH   MVALAD05                 If not use bill address                 
         LHI   R0,4                                                             
         TM    AC_IND2,AC_IADR5                                                 
         JZ    *+8                                                              
         LHI   R0,5                                                             
         LHI   RE,L'M_ADD1                                                      
         LA    RF,QI_MADD1                                                      
         J     MVALAD07                                                         
*                                                                               
MVALAD05 ICM   RF,7,QA_AADDR            Any acc address?                        
*        JNZ   MVALAD06                                                         
*        CLI   QA_UPLD,QA_SAPTL         no, retain if sap tool                  
*        JE    MVALADX                  (was 'J' only ...)                      
*        MVI   M_ADDEL,FF                                                       
*        GOTO1 VHELLO,DMCB,(C'D',MEDFIL),('FF',M_CLIKEY),0                      
         JZ    MVALADX                                                          
*                                                                               
MVALAD06 XR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(RF)    Number of address lines                 
         LHI   RE,L'ADRADD1                                                     
         AHI   RF,LW_LN2Q          RF=A(first address line data)                
*                                                                               
MVALAD07 BCTR  RE,0                                                             
         BASR  R1,0                                                             
         MVC   0(0,R2),0(RF)            Move in address                         
         EX    RE,0(R1)                                                         
         BASR  R1,0                                                             
         OC    0(0,R2),SPACES           Make sure upper case                    
         EX    RE,0(R1)                                                         
         AHI   RE,1                                                             
         AR    RF,RE                    Bump to next address to move            
         LA    R2,L'M_ADD1(R2)          Bump to next entry on element           
         JCT   R0,MVALAD07                                                      
*                                                                               
MVALAD08 TM    BYTE1,X'80'              Are we adding new element?              
         JNZ   MVALAD10                                                         
         LLC   RF,M_ADDLEN                                                      
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         CLC   M_ADDEL(0),ELEMENT       Has the element changed                 
         EX    RF,0(RE)                                                         
         JE    MVALADX                                                          
*                                                                               
MVALAD10 GOTOR ADDELT                                                           
*                                                                               
MVALADX  J     EXITY                                                            
*                                                                               
MVALADRR TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$NFADL),(5,=C'EC079'),=AL2(FLD017)            
         J     EXITN                    Need one address line                   
         DROP  R2,R4,R7,EL                                                      
         EJECT                                                                  
***********************************************************************         
* VALIDATE FILTERS                                                    *         
***********************************************************************         
         SPACE 1                                                                
         USING QI_MFLDD,R4                                                      
MVALFLT  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R7,AIO8                                                          
         USING T_D,R7                                                           
         USING M_CLIKEY,R2                                                      
*                                                                               
         TM    ERRFLAG,SKIPERR     Don't need to validate filters more          
         JNZ   MVALFI08            than once                                    
         XC    SAVFINDS,SAVFINDS                                                
         MVC   SAVFLTS,SPACES                                                   
         CLI   QA_UPLD,QA_SAPTL    Not maintained in SAP                        
         JNE   MVALFI00            but build dummy element                      
         CLI   T_ACTION,C'A'       if adding new record                         
         JNE   MVALFX                                                           
         MVC   QI_MFLTS(QI_MFLTL),SPACES  Set all to spaces                     
         J     MVALFI10                                                         
*                                                                               
MVALFI00 CLI   T_ACTION,C'A'       Adding new record?                           
         JNE   MVALFI02                                                         
         CLC   QI_MFLTS(QI_MFLTL),SPACES  Any filters passed?                   
         JH    MVALFI02                                                         
         MVC   QI_MFLTS(QI_MFLTL),SPACES  Set all to spaces                     
         J     MVALFI10                                                         
*                                                                               
         USING QI_MFLTD,R3                                                      
MVALFI02 CLI   T_ACTION,C'C'       Action change                                
         JE    *+14                allow filters to be removed                  
         CLC   QI_MFLTS(QI_MFLTL),SPACES  Any filters passed?                   
         JNH   MVALFX                                                           
         OC    QI_MFLTS(QI_MFLTL),SPACES                                        
*                                                                               
         LA    R3,QI_MFLTS                                                      
         LLC   R0,QI_NMFLT                                                      
*                                                                               
         USING M_FLTKEY,IOKEY                                                   
MVALFI04 ST    R0,SAVER0                                                        
         CLI   0(R3),C' '          Any filter?                                  
         JNH   MVALFI06                                                         
         LA    RE,QI_MFLTS+QI_MFLTL                                             
         CR    R3,RE               Hit the end?                                 
         JH    MVALFI08                                                         
*                                                                               
         XC    IOKEY,IOKEY                                                      
         MVC   M_FLTKAGY,T_KAM                                                  
         NI    M_FLTKAGY,X'F0'                                                  
         MVI   M_FLTKTYP,M_FLTKTYPQ                                             
         MVI   M_FLTKSTYP,M_FLTKSVAL                                            
         MVC   BYTE1,QI_MFLTN                                                   
         NI    BYTE1,X'FF'-X'F0'   Filter no.                                   
         LLC   R0,BYTE1                                                         
         STC   R0,M_FLTKNUM                                                     
         LA    RE,SAVFLTS                                                       
         BCTR  R0,0                                                             
         AR    RE,R0                                                            
         MVC   0(L'QI_MFLTV,RE),QI_MFLTV                                        
         MVC   M_FLTKVAL,QI_MFLTV                                               
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IOMEDDIR+IO1'                            
         JE    MVALFI06                                                         
         CLI   QA_UPLD,QA_SAPTL    If upload tool can't add filter              
         JE    MVALFRR                                                          
         LLC   R0,BYTE1                                                         
         BCTR  R0,0                -1 because start at 1                        
         LA    RE,SAVFINDS                                                      
         AR    RE,R0                                                            
         OI    0(RE),SAVFIADD      Set new filter added                         
*                                                                               
MVALFI06 L     R0,SAVER0                                                        
         AHI   R3,QI_MFLEL                                                      
         JCT   R0,MVALFI04                                                      
*                                                                               
         USING M_FLTEL,R3                                                       
EL       USING M_FLTEL,ELEMENT                                                  
MVALFI08 MVI   BYTE1,0                                                          
         XC    ELEMENT,ELEMENT                                                  
         L     R2,AIO7                                                          
         GOTO1 VHELLO,DMCB,(C'G',MEDFIL),('M_FLTELQ',M_CLIKEY),0                
         CLI   12(R1),0                                                         
         JE    MVALFI12                                                         
*                                                                               
MVALFI10 OI    BYTE1,X'80'              Add new element                         
         MVI   EL.M_FLTEL,M_FLTELQ                                              
         J     MVALFI14                                                         
*                                                                               
MVALFI12 L     R3,12(R1)                Copt existing element                   
         LLC   RF,M_FLTLEN                                                      
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   ELEMENT(0),M_FLTEL                                               
         EX    RF,0(RE)                                                         
*                                                                               
MVALFI14 MVC   EL.M_FLTFLTS(L'SAVFLTS),SAVFLTS                                  
         MVI   EL.M_FLTLEN,M_FLTLENQ    Set length                              
*                                                                               
         TM    BYTE1,X'80'              Adding new element?                     
         JNZ   MVALFI16                                                         
         LLC   RF,M_FLTLEN                                                      
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         CLC   ELEMENT(0),M_FLTEL       HAS ELEMENT CHANGED?                    
         EX    RF,0(RE)                                                         
         JE    MVALFX                                                           
*                                                                               
MVALFI16 MVC   T_FLTS,SAVFLTS           Save off filters and indicators         
         MVC   T_FLTI,SAVFINDS                                                  
         GOTOR ADDELT                                                           
*                                                                               
MVALFX   J     EXITY                                                            
*                                                                               
MVALFRR  TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$INFLT),(5,=C'EC061'),=AL2(FLD328)            
         J     EXITN                                                            
         EJECT                                                                  
         DROP  R2,R3,R4,R7,EL                                                   
***********************************************************************         
* VALIDATE FORMULA CODE ELEMENT                                       *         
***********************************************************************         
         SPACE 1                                                                
         USING QI_MFLDD,R4                                                      
MVALFRM  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLI   QA_UPLD,QA_SAPTL    Not maintained in SAP                        
         JE    MVALFRX                                                          
*                                                                               
         L     R7,AIO8                                                          
         USING T_D,R7                                                           
         USING M_CLIKEY,R2                                                      
         L     R2,AIO7                                                          
         MVI   BYTE1,0                                                          
         XC    ELEMENT,ELEMENT                                                  
         GOTO1 VHELLO,DMCB,(C'G',MEDFIL),('M_FMLELQ',M_CLIKEY),0                
         CLI   12(R1),0                                                         
         JE    MVALFR02                                                         
*                                                                               
         USING M_FMLEL,R3                                                       
EL       USING M_FMLEL,ELEMENT                                                  
         CLC   QI_FRMCD,SPACES     ANY FORMULA CODE PASSED                      
         JNH   MVALFRX                                                          
         OI    BYTE1,X'80'         NOT FOUND SO BUILD NEW ONE                   
         MVI   EL.M_FMLEL,M_FMLELQ                                              
         MVI   EL.M_FMLLEN,M_FMLLENQ                                            
         MVC   EL.M_FMLAGY,MEDAGYB                                              
         NI    EL.M_FMLAGY,X'F0'   ERASE MEDIA NIBBLE                           
         J     MVALFR04                                                         
*                                                                               
MVALFR02 L     R3,12(R1)                                                        
         LLC   RF,M_FMLLEN                                                      
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   ELEMENT(0),M_FMLEL                                               
         EX    RF,0(RE)                                                         
*                                                                               
         USING M_DFRM,IOKEY                                                     
MVALFR04 CLC   QI_FRMCD,SPACES     ANY FORMULA CODE PASSED                      
         JNH   MVALFR06                                                         
*                                                                               
         MVC   EL.M_FMLFORM,QI_FRMCD                                            
         XC    IOKEY,IOKEY                                                      
         MVC   M_FRMKAM,MEDAGYB                                                 
         NI    M_FRMKAM,X'F0'      ERASE MEDIA NIBBLE                           
         MVI   M_FRMKTYP,M_FRMKTYPQ                                             
         MVC   M_FRMKCODE,QI_FRMCD                                              
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IOMEDDIR+IO1'                            
         CLC   IOKEYSAV(M_FRMKRAT-M_FRMKEY),IOKEY                               
         JNE   MVALFERR                                                         
*                                                                               
MVALFR06 TM    BYTE1,X'80'         ARE WE ADDING NEW RECORD                     
         JNZ   MVALFR08                                                         
         LLC   RF,M_FMLLEN                                                      
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         CLC   ELEMENT(0),M_FMLEL                                               
         EX    RF,0(RE)                                                         
         JE    MVALFRX                                                          
*                                                                               
MVALFR08 GOTOR ADDELT              Add element to record                        
*                                                                               
MVALFRX  J     EXITY                                                            
*                                                                               
MVALFERR TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$IVFOC),(5,=C'EC076'),=AL2(FLD334)            
         J     EXITN               Formula code is invalid                      
         EJECT                                                                  
         DROP  R2,R3,R4,R7,EL                                                   
***********************************************************************         
* Validate due data /cash discount                                    *         
***********************************************************************         
         SPACE 1                                                                
         USING QI_MFLDD,R4                                                      
MVALDUE  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLI   QA_UPLD,QA_SAPTL                                                 
         JE    MVALDX                                                           
         L     R7,AIO8                                                          
         USING T_D,R7                                                           
         USING M_CLIKEY,R2                                                      
         L     R2,AIO7                                                          
         MVI   BYTE1,0                                                          
         XC    ELEMENT,ELEMENT                                                  
         LHI   RF,M_DDRELQ                                                      
         CLI   CUCTRY,CTRYGER                                                   
         JNE   MVALD02                                                          
         LHI   RF,M_ACDELQ                                                      
*                                                                               
MVALD02  GOTO1 VHELLO,DMCB,(C'G',MEDFIL),((RF),M_CLIKEY),0                      
         CLI   12(R1),0                                                         
         JE    MVALD04                                                          
*                                                                               
MVALD03  OI    BYTE1,X'80'         Set adding new element                       
         J     MVALD06                                                          
                                                                                
EL       USING M_DDREL,ELEMENT                                                  
         USING M_DDREL,R3                                                       
MVALD04  L     R3,12(R1)                                                        
                                                                                
MVALD06  CLI   CUCTRY,CTRYGER      Germany?                                     
         JE    MVALDGER                                                         
                                                                                
         CLC   QI_MDUED,SPACES     Any due date?                                
         JNH   MVALDX                                                           
                                                                                
         MVI   EL.M_DDREL,M_DDRELQ                                              
         MVI   EL.M_DDRLEN,M_DDRLENQ                                            
         XC    WORK(CONBLKL),WORK                                               
         LA    RE,WORK             Convert due date to formula                  
         USING CONBLKD,RE                                                       
         MVI   CONACTN,CONAVALQ                                                 
         MVI   CONFLD,CONFIDUE                                                  
         MVC   DUB(L'QI_MDUED),QI_MDUED                                         
         LA    RF,DUB                                                           
         LR    R1,RF                                                            
         STCM  RF,15,CONIADD                                                    
         LA    RF,L'QI_MDUED-1(RF) Find actual length of input                  
         CLI   0(RF),C' '                                                       
         JH    *+8                                                              
         JCT   RF,*-8                                                           
         AHI   RF,1                                                             
         SR    RF,R1                                                            
         STC   RF,CONILEN                                                       
         LA    RF,WORK+30                                                       
         STCM  RF,15,CONOADD                                                    
         MVC   CONCOMF,ACOMFACS                                                 
         DROP  RE                                                               
         GOTO1 VCONVERT,WORK                                                    
         CLI   WORK+(CONERR-CONBLK),0                                           
         JNE   MVALDERR                                                         
*                                                                               
         TM    BYTE1,X'80'         Are we adding a new element?                 
         JNZ   MVALD08                                                          
         CLC   M_DDRRUL,WORK+30    Anything changed?                            
         JE    MVALDX                                                           
MVALD08  MVC   EL.M_DDRRUL,WORK+30                                              
         GOTOR ADDELT                                                           
         J     MVALDX                                                           
         DROP  EL,R3                                                            
*                              **  German only validation **                    
EL       USING M_DACD,ELEMENT                                                   
         USING M_DACD,R3                                                        
MVALDGER MVI   EL.M_ACDEL,M_ACDELQ (see ACPRO56.VALCD800)                       
         MVI   EL.M_ACDLEN,M_ACDCLENQ                                           
         TM    BYTE1,X'80'         Are we adding                                
         JZ    MVALDG02                                                         
         MVC   EL.M_ACDBANK,SPACES                                              
*                                                                               
MVALDG02 CLC   QI_MDUED,SPACES     Any due date?                                
         JNH   MVALDG10                                                         
         LA    RF,QI_MDUED+L'QI_MDUED-1                                         
         LHI   RE,L'QI_MDUED                                                    
*                                                                               
MVALDG04 CLI   0(RF),X'40'                                                      
         JH    MVALDG06                                                         
         SHI   RF,1                                                             
         JCT   RE,MVALDG04                                                      
         J     MVALDERR            ?Die instead?                                
*                                                                               
X        USING TRAVD,WORK                                                       
MVALDG06 XC    X.TRAVBLK(TRAVBLKL),X.TRAVBLK                                    
         L     R0,ACOMFACS                                                      
         STCM  R0,B'0111',X.TRACOMF                                             
         MVC   X.TRAVAGYO,CUCTRY   agency country option                        
         MVC   X.TRAVAGYC,CUCTRY   agency country code                          
         MVC   X.TRAVLANG,CULANG   agency language code                         
         MVI   X.TRAFLD,TRAFPAYD                                                
         STC   RE,X.TRAILEN                                                     
         MVI   X.TRAACT,TRAAVALQ                                                
         LA    R0,QI_MDUED                                                      
         STCM  R0,B'0111',X.TRAIADD                                             
         LA    R0,EL.M_ACDPDAYS                                                 
         STCM  R0,B'0111',X.TRAOADD                                             
         GOTO1 VTRVAIL,X.TRAVBLK                                                
         JNE   MVALDERR                                                         
*                                  Set default if nothing passed                
MVALDG10 CLC   QI_CDISB,SPACES     Any cash discount basis?                     
         JNH   MVALDG12                                                         
         XC    X.TRAVBLK(TRAVBLKL),X.TRAVBLK                                    
         L     R0,ACOMFACS                                                      
         STCM  R0,B'0111',X.TRACOMF                                             
         MVI   X.TRAACT,TRAAVALQ+TRAAFLDQ                                       
         MVI   X.TRAFLD,TRAFCDBA                                                
         LA    RF,QI_CDISB                                                      
         STCM  RF,7,X.TRAIADD                                                   
         LA    RF,EL.M_ACDIND                                                   
         STCM  RF,7,X.TRAOADD                                                   
         MVI   X.TRAILEN,1                                                      
         MVC   X.TRAVAGYO,CUCBIT   agency country option                        
         MVC   X.TRAVAGYC,CUCTRY   agency country code                          
         MVC   X.TRAVCTRY,CUCTRY   agency country                               
         MVC   X.TRAVLANG,CULANG   agency language code                         
         GOTO1 VTRVAIL,X.TRAVBLK                                                
         JNE   MVALDECD                                                         
*                                  Save cash discount percentage option         
MVALDG12 OC    QI_CDISL,QI_CDISL   Any cash discount percentage                 
         JZ    MVALDG14                                                         
         XC    X.TRAVBLK(TRAVBLKL),X.TRAVBLK                                    
         L     R0,ACOMFACS                                                      
         STCM  R0,7,X.TRACOMF                                                   
         MVC   X.TRAVAGYO,CUCBIT   agency country option                        
         MVC   X.TRAVAGYC,CUCTRY   agency country                               
         MVC   X.TRAVLANG,CULANG   agency language                              
         MVI   X.TRAFLD,TRAFCDRE                                                
         MVC   X.TRAILEN,QI_CDISL                                               
         MVI   X.TRAACT,TRAAVALQ+TRAAFLDQ                                       
         LA    R0,QI_CDISC                                                      
         STCM  R0,7,X.TRAIADD                                                   
         LA    R0,EL.M_ACDCDPCT                                                 
         STCM  R0,7,X.TRAOADD                                                   
         GOTO1 VTRVAIL,X.TRAVBLK                                                
         JNE   MVALDCDP                                                         
*                                                                               
MVALDG14 CLI   QI_BCOM,C' '                                                     
         JNH   MVALDG16                                                         
         NI    EL.M_ACDIND,X'FF'-M_ACDBCOMQ                                     
         CLI   QI_BCOM,YESQ        Billing commission option                    
         JNE   *+12                                                             
         OI    EL.M_ACDIND,M_ACDBCOMQ                                           
         J     MVALDG16                                                         
         CLI   QI_BCOM,NOQ         Only Y/N valid                               
         JNE   MVALBCRR                                                         
*                                                                               
MVALDG16 GOTOR ADDELT                                                           
*                                                                               
MVALDX   J     EXITY                                                            
*                                                                               
MVALDERR TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$IDUED),(5,=C'EC075'),=AL2(FLD323)            
         J     EXITN               Due date is invalid                          
*                                                                               
MVALDECD TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$CDISB),(5,=C'EC105'),=AL2(FLD349)            
         J     EXITN               Cash discount basis invalid                  
*                                                                               
MVALDCDP TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$CDISP),(5,=C'EC106'),=AL2(FLD350)            
         J     EXITN               Cash discount % invalid                      
*                                                                               
MVALBCRR TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$INVIF),(5,=C'EC107'),=AL2(FLD351)            
         J     EXITN               Billing=commission not Y/N                   
         EJECT                                                                  
         DROP  R2,R3,R4,R7,EL,X                                                 
***********************************************************************         
* Call LIMACC to check values in request and client/product           *         
* codes                                                               *         
***********************************************************************         
         SPACE 1                                                                
         USING LIMACCD,R3                                                       
         USING M_CLIKEY,R2                                                      
         USING QI_MFLDD,R4                                                      
MELIMACC NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R7,AIO8                                                          
         USING T_D,R7                                                           
*                                                                               
         CLI   QA_UPLD,QA_SAPTL    Not maintained in SAP                        
         JE    MELIMX                                                           
*                                                                               
         CLI   CUCTRY,CTRYGER      Skip for Germany                             
         JE    MELIMX                                                           
*                                                                               
         L     R2,AIO7                                                          
         L     R3,ALACCBLK                                                      
         TM    AC_IND1,AC_INEW2+AC_ILVL2 Client type record?                    
         JNZ   MELIMX              Can't pass limit access                      
         TM    LAINDS,LAIINIT      Test initialised                             
         JO    *+6                                                              
         DC    H'0'                                                             
         OC    QI_LIMA1,QI_LIMA1   Any limit access 1 set?                      
         JNZ   MELIM02                                                          
         TM    LIACTST,LIACTLA1    Test limit access 1                          
         JZ    MELIM04                                                          
         J     MELIMRR1                                                         
*                                                                               
MELIM02  LLC   RE,QI_LIMA1                                                      
         CHI   RE,255              Limit access is too big?                     
         JH    MELIMRR3                                                         
*                                                                               
         XC    DUB,DUB                                                          
         STC   RE,DUB+(MEDSCAC1-MEDSCNUM)                                       
         STC   RE,T_CPSTAT+(M_CLIACC1-M_CLISTAT) save to tsar                   
         OI    T_INDS,T_IUPDAT                                                  
         TM    LIACTST,LIACTLA1    Test limit access 1                          
         JZ    MELIM04                                                          
         TM    LAINDS,LAIINIT      TEST INITIALISED                             
         JNZ   *+6                                                              
         DC    H'0'                                                             
         MVI   WORK,LIACXBAG+LIACXCAG+LIACXLA2                                  
         GOTO1 VLIMACC,DMCB,(C'T',(R3)),(WORK,DUB)                              
         JNE   MELIMRR1                                                         
*                                                                               
MELIM04  OC    QI_LIMA2,QI_LIMA2   Any limit access 2 set?                      
         JNZ   MELIM06                                                          
         TM    LIACTST,LIACTLA2    Test limit access 2                          
         JZ    MELIM08                                                          
         J     MELIMRR2                                                         
*                                                                               
MELIM06  LLC   RE,QI_LIMA2                                                      
         CHI   RE,255              Limit access is too big                      
         JH    MELIMRR4                                                         
*                                                                               
         XC    DUB,DUB                                                          
         STC   RE,DUB+(MEDSCAC2-MEDSCNUM)                                       
         STC   RE,T_CPSTAT+(M_CLIACC2-M_CLISTAT) save to tsar                   
         OI    T_INDS,T_IUPDAT                                                  
         TM    LIACTST,LIACTLA2    Test limit access 1                          
         JZ    MELIM08                                                          
         MVI   WORK,LIACXBAG+LIACXCAG+LIACXLA1                                  
         TM    LAINDS,LAIINIT      TEST INITIALISED                             
         JNZ   *+6                                                              
         DC    H'0'                                                             
         GOTO1 VLIMACC,DMCB,(C'T',(R3)),(WORK,DUB)                              
         JNE   MELIMRR2                                                         
*                                                                               
MELIM08  DS    0H                                                               
         MVC   DUB(4),T_CPSTAT+(M_CLIAGY-M_CLISTAT)                             
         MVC   DUB+4(L'T_CLI),T_CLI                                             
         TM    LAINDS,LAIINIT      TEST INITIALISED                             
         JNZ   *+6                                                              
         DC    H'0'                                                             
         LA    RF,DUB                                                           
         CLI   CUCTRY,CTRYGER      Temporary bypass for testing                 
         JNE   *+8                                                              
         LA    RF,T_CPSTAT+(M_CLIAGY-M_CLISTAT)                                 
         GOTO1 VLIMACC,DMCB,(C'T',(R3)),(0,0(RF)) LIMACC CLIENT CHECK           
         JNE   MELIMRR1                                                         
         J     MELIMX                                                           
*                                  Product record validation                    
MELIM10  CLI   T_ACTION,C'A'       If adding use client values                  
         JE    *+10                                                             
         MVC   WORK(4),T_CPSTAT+(M_PROAGY-M_PROSTAT)                            
         LA    RF,WORK                                                          
         LA    R0,4                                                             
         LA    RE,OA_MCLST+(M_CLIAGY-M_CLISTAT)                                 
MELIM12  CLI   0(RF),0              If no product values substitute             
         JNE   *+10                 with client ones                            
         MVC   0(1,RF),0(RE)                                                    
         LA    RE,1(RE)                                                         
         LA    RF,1(RF)                                                         
         JCT   R0,MELIM12                                                       
         TM    LAINDS,LAIINIT      TEST INITIALISED                             
         JNZ   *+6                                                              
         DC    H'0'                                                             
         GOTO1 VLIMACC,DMCB,(C'T',(R3)),(0,WORK)                                
         JNE   MELIMRR1                                                         
*                                                                               
MELIMX   J     EXITY                                                            
*                                                                               
MELIMRR1 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$SECLK),(5,=C'EC048'),=AL2(FLD326)            
         J     EXITN               Security lockout for limit access 1          
*                                                                               
MELIMRR2 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$SECLK),(5,=C'EC048'),=AL2(FLD327)            
         J     EXITN               Security lockout for limit access 2          
*                                                                               
MELIMRR3 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$L1255),(5,=C'EC061'),=AL2(FLD326)            
         J     EXITN               Invalid limit access passed                  
*                                                                               
MELIMRR4 TM    ERRFLAG,SKIPERR     Skipping any further errors?                 
         JNZ   EXITY                                                            
         GOTOR SAVERR,DMCB,=AL2(AE$L1255),(5,=C'EC061'),=AL2(FLD327)            
         J     EXITN               Invalid limit access passed                  
         EJECT                                                                  
         DROP  R2,R3,R4,R7                                                      
***********************************************************************         
* Update media client/product records from TSAR                                 
***********************************************************************         
         SPACE 1                                                                
         USING T_D,R7                                                           
UPMEDSYS NTR1  LABEL=*,BASE=*                                                   
*                                                                               
         L     R7,AIO8                                                          
         USING M_CLIKEY,R2                                                      
         LA    R2,IOKEY                                                         
         XC    IOKEY,IOKEY                                                      
         MVC   M_CLIKAM,T_KAM      Set up client key                            
         MVI   M_CLIKTYP,M_CLIKTYPQ                                             
         MVC   M_CLIKCLI,T_CLI                                                  
         OI    IOINDS1,IO1XSWCH    Don't switch back                            
         TM    AC_IND1,AC_INEW2+AC_ILVL2 Adding a product?                      
         JZ    UPMEDS02                                                         
         MVI   M_PROKTYP-M_PROKEY(R2),M_PROKTYPQ                                
         MVC   M_PROKPRO-M_PROKEY(L'M_PROKPRO,R2),T_PRO                         
*                                  Set up product key                           
UPMEDS02 L     R1,=AL4(IORDUPD+IOMEDDIR+IO7)                                    
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    UPMEDS04            Found ok?                                    
         CLI   IOERR,IOEDEL        deleted?                                     
         JE    UPMEDS04                                                         
         J     UPMEDS14                                                         
*                                                                               
UPMEDS04 L     R1,=AL4(IOGETRUP+IOMEDFIL+IO7)                                   
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO7                                                          
         MVC   OLDSTAT,M_CLISTAT                                                
         MVC   OLDFLTS,SPACES                                                   
         GOTO1 VHELLO,DMCB,(C'G',MEDFIL),('M_FLTELQ',M_CLIKEY),0                
         CLI   12(R1),0                                                         
         JNE   UPMEDS06                                                         
         L     R3,12(R1)                                                        
         LLC   RE,M_FLTLEN-M_FLTEL(R3)                                          
         BCTR  RE,0                                                             
         BASR  R1,0                                                             
         MVC   OLDFLTS(0),M_FLTFLTS-M_FLTEL(R3)                                 
         EX    RE,0(R1)                                                         
*                                                                               
UPMEDS06 MVC   M_CLISTAT(L'T_CPSTAT),T_CPSTAT Update status if                  
         LAY   RF,SRCHBLK          needs updating                               
         LAY   R3,SRCHLIST                                                      
         MVC   MFILADR,IOADDR      Save disk address                            
         GOTO1 VSRCHPAS,DMCB,(C'B',0(RF)),ACOMFACS,AIO7,0(R3),         X        
               MFILADR,(X'01',=C'MEDIA ')                                       
         LA    R3,T_ELEMS                                                       
*                                                                               
* ??? UPDATE ELEMS IF FOUND                                                     
UPMEDS08 CLI   0(R3),X'00'                                                      
         JE    UPMEDS10                                                         
         MVC   BYTE1,0(R3)                                                      
*                                                                               
         LA    RF,SUBETAB                                                       
*                                                                               
UPMEDS09 CLI   0(RF),X'FF'         End of table?                                
         JE    UPMEDS9B                                                         
         CLC   0(1,RF),BYTE1       Match on type                                
         JE    UPMEDS9A                                                         
         LA    RF,SUBETABL(RF)                                                  
         J     UPMEDS09                                                         
*                                                                               
         USING TXTEL,R3                                                         
UPMEDS9A GOTO1 VHELLO,DMCB,(C'D',MEDFIL),(BYTE1,(R2)),                 +        
               (1,TXTTYPE)                                                      
         J     UPMEDS9C                                                         
*                                                                               
UPMEDS9B GOTO1 VHELLO,DMCB,(C'D',MEDFIL),(BYTE1,(R2)),0                         
*                                                                               
UPMEDS9C CLI   12(R1),0                                                         
         JE    *+14                                                             
         CLI   12(R1),X'06'        Element not found?                           
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR VHELLO,DMCB,(C'P',MEDFIL),M_CLIKEY,0(R3),0                       
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                Put element                                  
         LLC   R0,1(R3)                                                         
         AR    R3,R0                                                            
         J     UPMEDS08                                                         
*                                                                               
* ??? putrec                                                                    
NEW      USING RACELD,ELEMENT                                                   
         USING RACELD,R3                                                        
UPMEDS10 XC    ELEMENT,ELEMENT     Add rsteld for change                        
         MVI   NEW.RACEL,RACELQ                                                 
         MVI   NEW.RACLN,RACLNQ                                                 
         MVC   NEW.RACUSER,CUUSER                                               
         MVC   NEW.RACPERS,CCTPID                                               
         MVC   NEW.RACTERM,CUTERM                                               
         MVC   NEW.RACDATE,AC_TODYP                                             
         MVC   NEW.RACTIME,CTIME                                                
         MVI   NEW.RACTYPE,RACTCHA                                              
*                                                                               
         LA    R3,M_CLIELDQ(R2)                                                 
         XR    RE,RE                                                            
         MVC   DUB,FFS8                                                         
*                                                                               
UPMEDS1A LLC   R0,RACLN            Find existing raceld to update               
         AR    R3,R0                                                            
         CLI   RACEL,0                                                          
         JE    UPMEDS1B                                                         
         CLI   RACEL,RACELQ                                                     
         JNE   UPMEDS1A                                                         
         CLI   RACTYPE,RACTCHA                                                  
         JNE   UPMEDS1A                                                         
         AHI   RE,1                                                             
         CLC   RACDATE(L'RACDATE+L'RACTIME),DUB                                 
         JH    UPMEDS1A                                                         
         LR    RF,R3                                                            
         MVC   DUB(L'RACDATE+L'RACTIME),RACDATE                                 
         J     UPMEDS1A                                                         
*                                                                               
UPMEDS1B CHI   RE,RACMAXQ          Max number of racelds reached?               
         JL    UPMEDS1E                                                         
         LR    R3,RF               If so update existing one                    
         MVC   RACEL(RACLNQ),NEW.RACEL                                          
         J     UPMEDS1G                                                         
*                                                                               
UPMEDS1D GOTOR VHELLO,DMCB,(C'G',MEDFIL),('RACELQ',(R2)),              X        
               (L'RACTYPE,RACTYPE)                                              
         CLI   12(R1),0                                                         
         JNE   UPMEDS1F                                                         
         L     R3,12(R1)                                                        
         MVC   0(RACLNQ,R3),NEW.RACEL Update existing                           
         J     UPMEDS1G                                                         
*                                                                               
UPMEDS1E XR    RE,RE                                                            
         ICM   RE,B'0011',M_CLIRLEN-M_CLIKEY(R2)                                
         CHI   RE,1800             Ensure enough space on record                
         JH    UPMEDS1H                                                         
*                                                                               
UPMEDS1F GOTOR VHELLO,DMCB,(C'P',MEDFIL),M_CLIKEY,ELEMENT,0                     
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                Put element                                  
*                                                                               
UPMEDS1G CLI   RACTYPE,RACTADD                                                  
         JNE   UPMEDS1H                                                         
         MVI   NEW.RACTYPE,RACTCHA If add, also do change elem                  
         J     UPMEDS1D                                                         
*                                                                               
UPMEDS1H GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMEDFIL+IO7'                        
         JE    *+6                                                              
         DC    H'0'                                                             
         LA    R2,IOKEY                                                         
         MVC   M_CLIDSTAT(L'T_CPSTAT),T_CPSTAT Update dir stat                  
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IOMEDDIR+IO7'                         
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
* ??? ADD FLTPASS                                                               
* ??? SEARCHPASS FOR ADD                                                        
* ??? FLTPASS IF FILTERS CHANGED                                                
* ??? SRCHPASS IF NAME CHANGED                                                  
*                                                                               
UPMEDS12 LAY   RF,SRCHBLK                                                       
         LAY   R3,SRCHLIST                                                      
         GOTO1 VSRCHPAS,DMCB,(C'A',0(RF)),ACOMFACS,AIO7,0(R3)                   
         GOTOR FLTPASS                                                          
         J     UPMEDSX                                                          
*                              **  Adding new client/product record **          
UPMEDS14 L     R2,AIO7                                                          
*                                                                               
         L     R0,AIO7                                                          
         LHI   R1,IOLENQ                                                        
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         LA    R3,T_ELEMS                                                       
         MVC   M_CLIKAM,T_KAM            Set up client key                      
         MVC   M_CLISTAT(L'T_CPSTAT),T_CPSTAT  Update status if                 
         MVI   M_CLIKTYP,M_CLIKTYPQ                                             
         TM    AC_IND1,AC_INEW2+AC_ILVL2 Adding a product?                      
         JZ    *+8                                                              
         MVI   M_CLIKTYP,M_PROKTYPQ                                             
         MVC   M_CLIKCLI,T_CLI                                                  
         TM    AC_IND1,AC_INEW2+AC_ILVL2                                        
         JZ    *+10                                                             
         MVC   M_PROKPRO-M_PROKEY(L'M_PROKPRO,R2),T_PRO                         
         MVI   M_CLIRLEN,M_CLIELDQ                                              
         MVI   M_CLIDUMEL,X'02'                                                 
         MVI   M_CLIDUMLN,X'02'                                                 
         J     UPMEDS18                                                         
*                                                                               
* Add any elements if any                                                       
UPMEDS18 CLI   0(R3),X'00'                                                      
         JE    UPMEDS20                                                         
         GOTOR VHELLO,DMCB,(C'P',MEDFIL),M_CLIKEY,0(R3),0                       
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                Put element                                  
         LLC   R0,1(R3)                                                         
         AR    R3,R0                                                            
         J     UPMEDS18                                                         
*                                                                               
* Addrec                                                                        
         USING RACELD,R3                                                        
UPMEDS20 XC    ELEMENT,ELEMENT     Add rsteld for change                        
         LA    R3,ELEMENT                                                       
         MVI   RACEL,RACELQ                                                     
         MVI   RACLN,RACLNQ                                                     
         MVI   RACTYPE,RACTADD                                                  
         MVC   RACUSER,CUUSER                                                   
         MVC   RACPERS,CCTPID                                                   
         MVC   RACTERM,CUTERM                                                   
         MVC   RACDATE,AC_TODYP                                                 
         MVC   RACTIME,CTIME                                                    
         GOTOR VHELLO,DMCB,(C'P',MEDFIL),M_CLIKEY,0(R3),0                       
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                Put element                                  
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOMEDFIL+IO7'                        
         JE    *+6                                                              
         DC    H'0'                Add new record                               
         L     RF,AIO7                                                          
         MVC   IOKEY,0(RF)                                                      
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IOMEDDIR+IO7'                            
         JE    *+6                                                              
         DC    H'0'                                                             
         LA    R2,IOKEY            Re-read to get disk address                  
         MVC   MFILADR,M_CLIDDA                                                 
         LAY   RF,SRCHBLK                                                       
         LAY   R3,SRCHLIST                                                      
         GOTO1 VSRCHPAS,DMCB,(C'N',0(RF)),ACOMFACS,AIO7,,MFILADR,      X        
               (X'01',=C'MEDIA ')                                               
         GOTOR FLTPASS             Add filter passives                          
*                                                                               
UPMEDSX  L     R7,AIO8             Switch back to accounting                    
         J     EXITY                                                            
         EJECT                                                                  
         DROP  R3,R7,NEW                                                        
***********************************************************************         
* Build filter passives for media system                              *         
***********************************************************************         
         SPACE 1                                                                
         USING T_D,R7                                                           
         USING M_DFLT,R3                                                        
FLTPASS  NTR1  BASE=*,LABEL=*                                                   
         L     R7,AIO8                                                          
         LA    R3,IOKEY                                                         
*                                                                               
         CLI   T_ACTION,C'A'       Are we adding new record?                    
         JNE   FLTPAS02                                                         
*                                                                               
         XC    M_FLTKEY,M_FLTKEY   Build filter passive key                     
         MVC   M_FLTKAGY,T_KAM                                                  
         NI    M_FLTKAGY,X'F0'                                                  
         MVI   M_FLTKTYP,M_FLTKTYPQ                                             
         MVI   M_FLTKSTYP,M_FLTKPASS                                            
         MVC   M_FLTKCLI,T_CLI                                                  
         TM    AC_IND1,AC_INEW2+AC_ILVL2 Only for product type                  
         JZ    *+10                                                             
         MVC   M_FLTKPRO,T_PRO                                                  
         MVC   M_FLTKAM,T_KAM                                                   
         MVC   M_FLTKFLTS,T_FLTS                                                
         MVC   M_FLTDSTAT(8),T_CPSTAT                                           
         MVC   M_FLTDDA,MFILADR                                                 
         GOTOR (#IOEXEC,AIOEXEC),'IOADD+IOMEDDIR+IO7'                           
         JE    FLTPAS05                                                         
         DC    H'0'                                                             
*                                                                               
FLTPAS02 XC    M_FLTKEY,M_FLTKEY   Build filter passive key                     
         MVC   M_FLTKAGY,T_KAM                                                  
         NI    M_FLTKAGY,X'F0'                                                  
         MVI   M_FLTKTYP,M_FLTKTYPQ                                             
         MVI   M_FLTKSTYP,M_FLTKPASS                                            
         MVC   M_FLTKCLI,T_CLI                                                  
         TM    AC_IND1,AC_INEW2+AC_ILVL2 Only for product type                  
         JZ    *+10                                                             
         MVC   M_FLTKPRO,T_PRO                                                  
         MVC   M_FLTKAM,T_KAM                                                   
         L     R1,=AL4(IOHID+IOMEDDIR+IO7)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+14                                                             
         CLI   IOERR,IOEDEL        Allow deleted                                
         JE    *+6                                                              
         DC    H'0'                                                             
         CLC   M_FLTKEY(M_FLTKFLTS-M_FLTKEY),IOKEYSAV                           
         JNE   FLTPAS05            No fltr passvs for this agy/med              
*                                                                               
         CLC   T_FLTS,OLDFLTS      Have filters changes?                        
         JNE   FLTPAS04                                                         
         CLC   OLDSTAT(8),T_CPSTAT Any status change?                           
         JE    FLTPAS05                                                         
         MVC   M_FLTDSTAT(8),T_CPSTAT   Write back status change                
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IOMEDDIR+IO7'                         
         JE    FLTPASX                                                          
         DC    H'0'                                                             
*                                                                               
FLTPAS04 OI    M_FLTDSTAT,X'80'    Delete old passive and add new               
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IOMEDDIR+IO7'                         
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   M_FLTKFLTS,T_FLTS   Put in new filters and add                   
         MVC   M_FLTDSTAT(8),T_CPSTAT                                           
         GOTOR (#IOEXEC,AIOEXEC),'IOADD+IOMEDDIR+IO7'                           
         JE    FLTPAS05                                                         
         CLI   IOERR,X'20'         If duplicate key on add then restore         
         JE    *+6                                                              
         DC    H'0'                Else die on other error                      
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IOMEDDIR+IO7'                         
         JE    FLTPAS05                                                         
         DC    H'0'                Error restoring                              
*                                                                               
* ADD MEDIA FILTER VALUE RECORDS AND THEIR NAME SEARCH PASSIVES *               
* Done ONCE per update of client/product!!!                                     
*                                                                               
FLTPAS05 CLI   QA_UPLD,QA_SAPTL    If upload tool we exit here!                 
         JE    FLTPASX                                                          
*                                                                               
         TM    AC_IND2,AC_IMEDF    Already processed filters?                   
         JNZ   FLTPASX                                                          
*                                                                               
         LHI   R0,9                                                             
         LA    R2,T_FLTI           R2 = A(SAVED VALIDATION INDICATORS)          
*                                                                               
FLTPAS10 ST    R2,SAVER2                                                        
         ST    R0,SAVER0                                                        
                                                                                
         TM    0(R2),SAVFIADD      Adding new filter?                           
         JNO   FLTPAS20                                                         
                                                                                
         L     R3,AIO7             BUILD FILTER VALUE RECORD IN IO7             
                                                                                
         L     R0,AIO7                                                          
         LHI   R1,IOLENQ           Check if filter exists already               
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         MVC   M_FLTKAGY,T_KAM                                                  
         NI    M_FLTKAGY,X'F0'                                                  
         MVI   M_FLTKTYP,M_FLTKTYPQ                                             
         MVI   M_FLTKSTYP,M_FLTKSVAL Subtype=value                              
         L     R0,SAVER0                                                        
         LHI   RE,10               Filter no.                                   
         SR    RE,R0                                                            
         STC   RE,M_FLTKNUM        Set filter number                            
         LA    RF,T_FLTS+L'T_FLTS                                               
         SR    RF,R0                                                            
         MVC   M_FLTKVAL,0(RF)                                                  
*                                                                               
         MVI   M_FLTDUMEL,2        Build dummy element                          
         MVI   M_FLTDUMLN,2                                                     
         LA    RF,M_FLTELDQ                                                     
         LA    RF,1(RF)                                                         
         STCM  RF,3,M_FLTRLEN                                                   
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOMEDFIL+IO7'                        
         JE    *+6                                                              
         DC    H'0'                                                             
         LAY   RF,SRCHBLK                                                       
         GOTO1 VSRCHPAS,DMCB,(C'N',0(RF)),ACOMFACS,AIO7,,IOADDR,       X        
               (1,=C'MEDIA ')                                                   
*                                                                               
FLTPAS20 L     R0,SAVER0                                                        
         L     R2,SAVER2           Bump filter counter                          
         LA    R2,1(R2)            Bump indicator pointer                       
         JCT   R0,FLTPAS10         Repeart for all 9 values                     
         OI    AC_IND2,AC_IMEDF                                                 
*                                                                               
FLTPASX  J     EXITY                                                            
         DROP  R2,R3,R7                                                         
***********************************************************************         
* EXTRACT OFFICE FROM ACCOUNT REC, BASED ON OFFPOS                              
*  R1 = A(ACCOUNT), SETLDG HAS BEEN CALLED                                      
*  R4 = A(RSTEL) (IN CASE OFFICE IN FILTERS)                                    
* RETURNS OFFICE IN HALF1, SPACES IF NO OFFPOS                                  
***********************************************************************         
GETOFF   NTR1  LABEL=*,BASE=*                                                   
         LR    R2,R1                                                            
         MVC   HALF1,SPACES                                                     
         TM    SCPYEL+(CPYSTAT1-CPYELD),CPYSOROE  Is agency on offices          
         JZ    EXITY                                                            
         CLI   LDGAOP,LDGONONE   TEST ANY OFFICE IN THIS LEDGER                 
         JE    EXITY                                                            
         CLI   LDGAOP,LDGOTRAN   TEST OFFICE IN TRANSACTIONS                    
         JE    EXITY                                                            
         CLI   LDGAOP,LDGOOFLS   TEST OFFICE LIST IN KEY                        
         JE    GETOFF35                                                         
         CLI   LDGAOP,LDGOFLT1   TEST OFFICE IN FILTERS                         
         JNL   GETOFF20                                                         
         MVC   BYTE1(1),LDGAOP                                                  
         NI    BYTE1,FF-LDGOKEY2                                                
         CLI   BYTE1,LDGOKEY                                                    
         JH    EXITY             SOME OTHER SETTING THAN OFFPOS                 
         LR    R1,R2             A(ACCOUNT CODE)                                
         XR    R0,R0                                                            
         IC    R0,BYTE1          OFFPOS                                         
         SHI   R0,1                                                             
         AR    R1,R0             A(OFFICE IN ACCOUNT)                           
         MVC   HALF1+0(1),0(R1)                                                 
         TM    LDGAOP,LDGOKEY2   TEST 2 CHARACTER OFFICE IN KEY                 
         JZ    GETOFFX                                                          
         MVC   HALF1+1(1),1(R1)                                                 
         J     GETOFFX                                                          
*                                                                               
GETOFF20 PACK  DUB1,LDGAOP         OFFICE IN FILTERS                            
         CVB   RF,DUB1             VALUE IS OF FORM X'F1'-X'F4'                 
         SHI   RF,1                                                             
         SLL   RF,3                                                             
         LAY   RE,GETOFF23                                                      
         AR    RE,RF                                                            
         B     0(RF)                                                            
*                                                                               
GETOFF23 LA    RE,RSTFILT1-RSTEL(R4)                                            
         J     GETOFF30                                                         
         LA    RE,RSTFILT2-RSTEL(R4)                                            
         J     GETOFF30                                                         
         LA    RE,RSTFILT3-RSTEL(R4)                                            
         J     GETOFF30                                                         
         LA    RE,RSTFILT4-RSTEL(R4)                                            
*                                                                               
GETOFF30 MVC   HALF1(1),0(RE)                                                   
         J     GETOFFX                                                          
*                                                                               
GETOFF35 MVC   HALF1,0(R2)          OFFICE LIST AT START OF A/C CODE            
*                                                                               
GETOFFX  J     EXITY                                                            
         EJECT                                                                  
*&&                                                                             
***********************************************************************         
* CHECK HIGHER LEVEL RECORDS, ADD TO TSAR IF MISSING/DELETED                    
* ASSUMES SETLDG HAS ALREADY BEEN CALLED                                        
***********************************************************************         
VALNAME  NTR1  LABEL=*,BASE=*                                                   
*                                                                               
         USING T_D,R7                                                           
         L     R7,AIO8                                                          
         CLC   DR_DRNAM,SPACES                                                  
         JH    VNAME010                                                         
* NO NAME GIVEN                                                                 
         CLI   T_ACTION,C'A'                                                    
         JNE   EXITY               USE EXISTING                                 
* COPY SJ NAME                                                                  
VNAME005 MVC   DR_DRNML(L'DR_DRNML+L'DR_DRNAM),QA_NAMEL                         
         CLI   QA_UPLD,QA_SAPTL    If we're doing upload tool                   
         JNE   VNAME017            make sure it is upper case                   
         OC    DR_DRNAM,SPACES                                                  
         J     VNAME017            use SJ                                       
*                                                                               
VNAME010 DS    0H                                                               
         L     R2,AIO1             EXISTING NAME?                               
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('NAMELQ',(R2)),0                      
         JE    VNAME015                                                         
*        MVI   T_ACTION,C'C'       NO, COPY SJ NAME                             
         MVC   DR_DRNML(L'DR_DRNML+L'DR_DRNAM),QA_NAMEL                         
         CLI   QA_UPLD,QA_SAPTL    If we're doing upload tool                   
         JNE   VNAME017            make sure it is upper case                   
         OC    DR_DRNAM,SPACES                                                  
         J     VNAME017                                                         
*                                                                               
VNAME015 DS    0H                                                               
         L     R4,12(R1)                                                        
         USING NAMELD,R4                                                        
         LLC   RF,DR_DRNML         COMPARE LENGTHS                              
         AHI   RF,NAMLN1Q                                                       
         CLM   RF,1,NAMLN                                                       
         JNE   VNAME017                                                         
         SHI   RF,NAMLN1Q+1                                                     
         BASR  RE,0                                                             
         CLC   DR_DRNAM(0),NAMEREC                                              
         EX    RF,0(RE)                                                         
         JE    EXITY               NO CHANGE                                    
*                                                                               
VNAME017 DS    0H                                                               
         SR    R4,R4                                                            
         LH    R4,T_RECLEN                                                      
         SHI   R4,1                                                             
         AR    R4,R7               A(TERMINATOR)                                
*                                                                               
VNAME020 DS    0H                                                               
         MVI   NAMEL,NAMELQ                                                     
         MVC   NAMEREC,DR_DRNAM                                                 
         LLC   RF,DR_DRNML                                                      
         AHI   RF,NAMLN1Q                                                       
         STC   RF,NAMLN                                                         
         AR    R4,RF                                                            
         MVI   NAMEL,0                                                          
         LH    R1,T_RECLEN                                                      
         AR    R1,RF                                                            
         STH   R1,T_RECLEN                                                      
*                                                                               
VALNAMEX J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* VALIDATE RSTFILT1-5 WHEN ADDING DEBTOR/COSTING FOR AN SJ ACC                  
* AIO8 HOLDS TSAR REC TO UPDATE, IF ANY CHANGES                                 
***********************************************************************         
VALRFILT NTR1  LABEL=*,BASE=*                                                   
*                                                                               
         L     R2,AIO1             EXISTING NAME?                               
*&&UK*&& XC    ELEMENT(RSTLN4Q),ELEMENT                                         
*&&US*&& XC    ELEMENT(RSTLN3Q),ELEMENT                                         
         MVI   BYTE1,0                                                          
         GOTOR VHELLO,DMCB,(C'G',ACCMST),('RSTELQ',(R2)),0                      
         CLI   12(R1),0                                                         
         JNE   VRFLT005                                                         
* OLD ELEM FOUND                                                                
         L     R4,12(R1)                                                        
         USING RSTEL,R4                                                         
         SR    RF,RF                                                            
         ICM   RF,1,RSTLN                                                       
         JNZ   *+6                                                              
         DC    H'0'                                                             
         BCTR  RF,0                                                             
         EXMVC RF,ELEMENT,0(R4)    COPY OLD VALUES                              
         CLI   QA_UPLD,QA_SAPTL                                                 
         JE    VRFLT040                                                         
*  NO OLD ELEM  - BUILD NEW 'ELEM'                                              
VRFLT005 LA    R4,ELEMENT                                                       
         MVC   RSTFILT1,SPACES                                                  
         MVC   RSTFILT2,SPACES                                                  
         MVC   RSTFILT3,SPACES                                                  
         MVC   RSTFILT4,SPACES                                                  
         MVC   RSTFILT5,SPACES                                                  
*                                                                               
VRFLT010 DS    0H                                                               
         ICM   R3,7,DR_ADRFL       R3=A(Uploaded filters)                       
         JZ    VRFLT040            No data                                      
         SR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R3)  Number of filters lines                   
         AHI   R3,LW_LN2Q          R3=A(first address line data)                
VRFLT015 LA    R2,FILTTAB                                                       
         USING FILTTABD,R2                                                      
VRFLT017 CLI   FILTNUM,X'FF'                                                    
         JNE   *+6                                                              
         DC    H'0'                                                             
         CLC   FILTNUM,0(R3)                                                    
         JE    VRFLT020                                                         
         LA    R2,FILTTABL(R2)                                                  
         J     VRFLT017                                                         
*                                                                               
VRFLT020 DS    0H                                                               
         CLI   1(R3),C'.'          PERIOD IS INVALID                            
         JNE   VRFLT022                                                         
         LARL  RF,SAVERR                                                        
         GOTOR (RF),DMCB,=AL2(AE$IFLTN),(1,0(R3)),=AL2(FLD018) EC042            
         J     VRFLT032                                                         
VRFLT022 DS    0H                                                               
         TM    SCPYEL+CPYSTAT8-CPYELD,CPYSFNAM   COMPANY USES NAMES?            
         JZ    VRFLT030                                                         
         MVC   FULL1(L'CUXCPY),CUXCPY                                           
         MVC   FULL1+L'CUXCPY(2),DR_DRACT   U/L                                 
         GOTOR ,DMCB,FULL1,ACOMFACS    CHECK NAME EXISTS                        
         MVC   4(1,R1),0(R3)       PASS FILTER NUM       |                      
         MVC   0(1,R1),1(R3)       AND FILTER VALUE      |                      
         L     RF,=V(ACPROFLT)                           |                      
         A     RF,SRVRRELO                             <-|                      
         GOTOR (RF)                                                             
         JE    VRFLT030                                                         
*                                                                               
         MVC   FLDNO1,=AL2(FLD018) SJ FILTER?                                   
         CLC   DR_DRACT(L'SJUL),SJUL                                            
         JE    VRFLT029                                                         
         MVC   FLDNO1,=AL2(FLD148) SR FILTER?                                   
         CLC   DR_DRACT(L'SRUL),SRUL                                            
         JE    VRFLT029                                                         
         MVC   FLDNO1,=AL2(FLD149)                                              
         CLC   DR_DRACT(L'ONECUL),ONECUL                                        
         JE    VRFLT029            1C FILTER?                                   
*                                                                               
VRFLT029 LARL  RF,SAVERR                                                        
         GOTOR (RF),DMCB,=AL2(AE$INFLT),(1,0(R3)),FLDNO1 EC043                  
         J     VRFLT032                                                         
VRFLT030 LLC   RF,FILTDISP                                                      
         AR    RF,R4                                                            
         MVC   0(L'RSTFILT1,RF),1(R3)                                           
VRFLT032 LA    R3,L'RSTFILT1+1(R3)     NEXT ARRAY ENTRY                         
         JCT   R0,VRFLT015                                                      
*                                                                               
* FINISH BUILDING ELEM                                                          
         SPACE 1                                                                
VRFLT040 MVI   RSTEL,RSTELQ      NEW ELEMENT                                    
*&&UK*&& MVI   RSTLN,RSTLN4Q                                                    
*&&US*&& MVI   RSTLN,RSTLN3Q                                                    
         OC    RSTTDATE,RSTTDATE   ACTIVITY DATE(S)                             
         JNZ   VRFLT045                                                         
         MVC   RSTTDATE,AC_TODYP         CREATION DATE AS LAST TX AND           
         MVC   RSTBDATE,RSTTDATE         BAL BFORWARD DATES                     
* IF COSTING, VALIDATE COSTING TYPE                                             
VRFLT045 DS    0H                                                               
         CLC   DR_DRACT(2),ONECUL                                               
         JNE   VRFLT065                                                         
         NI    RSTSTAT4,X'FF'-RSTSCSTC                                          
         SR    RE,RE               SET COSTING TYPE FOR 1C ACCOUNT              
         CLC   QA_CSTTY,SPACES                                                  
         JNH   VRFLT065            NO DATA                                      
         LA    RF,CSTTYTAB                                                      
VRFLT050 CLI   0(RF),FF                                                         
         JE    VRFLT055                                                         
         CLC   QA_CSTTY,0(RF)                                                   
         JE    VRFLT060                                                         
         LA    RF,L'QA_CSTTY+1(RF)                                              
         J     VRFLT050                                                         
*                                                                               
VRFLT055 LARL  RF,SAVERR                                                        
         GOTOR (RF),DMCB,=AL2(AE$CTYPN),(L'QA_CSTTY,QA_CSTTY),         +        
               =AL2(FLD151)                                                     
         J     VRFLT065                           EC044                         
VRFLT060 OC    RSTSTAT4,1(RF)                                                   
*                                                                               
*                                                                               
VRFLT065 CLI   T_ACTION,C'A'                                                    
         JE    VRFLT070                                                         
         L     R2,AIO1             EXISTING NAME?                               
         GOTOR VHELLO,DMCB,(C'G',ACCMST),('RSTELQ',(R2)),0                      
         CLI   12(R1),0                                                         
         JNE   VRFLT070                                                         
         L     R1,12(R1)                                                        
         CLC   RSTLN,1(R1)                                                      
         JNE   VRFLT070                                                         
         LLC   RF,RSTLN                                                         
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         CLC   RSTEL(0),0(R1)                                                   
         EX    RF,0(RE)                                                         
         JE    VRFLTX              NO CHANGES                                   
VRFLT070 DS    0H                                                               
         XR    R1,R1                                                            
         LH    R1,T_RECLEN                                                      
         SHI   R1,1                                                             
         AR    R1,R7                                                            
         LLC   RE,RSTLN                                                         
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   0(0,R1),RSTEL                                                    
         EX    RE,0(RF)                                                         
         LA    RE,1(RE)                                                         
         AR    R1,RE                                                            
         MVI   0(R1),0             NEW TERMINATOR                               
         LH    R1,T_RECLEN                                                      
         AR    R1,RE                                                            
         STH   R1,T_RECLEN                                                      
VRFLTX   J     EXITY                                                            
         DROP  R2,R4                                                            
         EJECT                                                                  
***********************************************************************         
* Add SR equivalent codes                                             *         
***********************************************************************         
         SPACE 1                                                                
         USING FFTELD,R3                                                        
         USING T_D,R7                                                           
ADDSRQV  NTR1  LABEL=NO        **  Add SR equivalents **                        
         J     *+12                                                             
         DC    C'*ADDSRQ*'                                                      
         L     R7,AIO8                                                          
         MVI   BYTE1,0             Byte1 keeps track of sequence                
         CLI   QA_UPLD,QA_SAPTL    If doing SAP tool and new product            
         JNE   ADDSRQ00                                                         
         TM    AC_IND1,AC_INEW2                                                 
         JZ    ADDSRQ00                                                         
         CLI   DR_DRACL,0          SR overridden?                               
         JE    ADDSRQX             no, so no equiv to add                       
*                                                                               
ADDSRQ00 XR    R1,R1               Check we have anything to update             
         ICM   R1,7,QA_SREQU       List of type/code pairs                      
         JZ    ADDSRQX                                                          
         XR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R1)                                            
         JZ    ADDSRQX                                                          
         LA    R6,LW_LN2Q(R1)                                                   
*                                                                               
ADDSRQ02 LA    R3,ELEMENT          Build new elements                           
         XC    ELEMENT,ELEMENT                                                  
         MVI   FFTEL,FFTELQ                                                     
         MVI   FFTTYPE,FFTTEPTR                                                 
         MVC   FFTSEQ,BYTE1                                                     
         GOTOR SETXLN,DMCB,1(R6),L'EQUKCODE                                     
         L     RF,4(R1)                                                         
         BASR  RE,0                                                             
         MVC   FFTDATA(0),1(R6)                                                 
         EX    RF,0(RE)                                                         
         LA    RF,1(RF)                                                         
         STC   RF,FFTDLEN                                                       
         LA    RF,FFTDATA-FFTEL(RF)                                             
         STC   RF,FFTLN                                                         
         XR    R1,R1                                                            
         LH    R1,T_RECLEN                                                      
         SHI   R1,1                                                             
         AR    R1,R7                                                            
         LLC   RE,FFTLN                                                         
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   0(0,R1),FFTEL                                                    
         EX    RE,0(RF)                                                         
         LA    RE,1(RE)                                                         
         AR    R1,RE                                                            
         MVI   0(R1),0             NEW TERMINATOR                               
         LH    R1,T_RECLEN                                                      
         AR    R1,RE                                                            
         STH   R1,T_RECLEN                                                      
         LA    R6,1+L'EQUKCODE(R6)                                              
         LLC   RF,BYTE1                                                         
         AHI   RF,1                                                             
         STC   RF,BYTE1                                                         
         JCT   R0,ADDSRQ02                                                      
ADDSRQX  J     EXITY                                                            
         EJECT                                                                  
         DROP  R3,R7                                                            
***********************************************************************         
* given record in aio1, build higher levels. add if missing,                    
* undelete if required.                                                         
***********************************************************************         
BLDHIER  NTR1  LABEL=*,BASE=*                                                   
         L     R2,AIO1                                                          
         USING ACTRECD,R2                                                       
         LA    RF,ACTKACT+L'ACTKACT                                             
         LA    RE,L'ACTKACT                                                     
BHIER005 DS    0H                  GET LENGTH OF ACCOUNT IN AIO1                
         SHI   RF,1                                                             
         CLI   0(RF),C' '                                                       
         JH    BHIER008                                                         
         JCT   RE,BHIER005                                                      
         DC    H'0'                                                             
*                                                                               
BHIER008 DS    0H                  MATCH TO LEDGER LEVEL                        
         LA    R4,LDGAL1                                                        
         LA    R0,4                                                             
BHIER010 DS    0H                                                               
         CLM   RE,1,0(R4)                                                       
         JNH   BHIER015                                                         
         AHI   R4,1                                                             
         JCT   R0,BHIER010                                                      
         DC    H'0'                                                             
* BUILD NEXT LEVEL UP, CHECK EXISTS                                             
BHIER015 DS    0H                                                               
         LA    RF,LDGAL1                                                        
         CR    RF,R4                                                            
         JNL   BLDHIERX            ALL DONE                                     
*                                                                               
         SHI   R4,1                                                             
         L     R2,AIO1                                                          
         MVC   IOKEY,ACTKEY                                                     
         LA    R2,IOKEY                                                         
         LLC   RF,0(R4)                                                         
         LA    RE,ACTKACT                                                       
         AR    RE,RF                                                            
         MVC   0(L'ACTKACT,RE),SPACES                                           
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO4'                               
         JE    BHIER025            ON FILE, UNDELETED                           
         CLI   IOERR,IOEDEL                                                     
         JE    BHIER060            MARKED FOR DELETION                          
         CLI   IOERR,IOERNF                                                     
         JE    BHIER050            NOT FOUND                                    
         DC    H'0'                                                             
* ON FILE, CHECK MAPPING                                                        
BHIER025 DS    0H                                                               
         L     R1,=AL4(IOGETRUP+IOMST+IO4)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO4                                                          
         SR    RE,RE                                                            
         LA    R3,ACTRFST                                                       
         USING FFTELD,R3                                                        
BHIER030 DS    0H                                                               
         CLI   FFTEL,0                                                          
         JE    BHIER035            ON FILE, NO MAPPING                          
         CLI   FFTEL,FFTELQ                                                     
         JNE   BHIER033                                                         
         CLI   FFTTYPE,FFTTEPTR                                                 
         JE    BLDHIERX            ON FILE, HAVE MAPPING                        
BHIER033 DS    0H                                                               
         LLC   RE,FFTLN                                                         
         AR    R3,RE                                                            
         J     BHIER030                                                         
* Copy mapping FFTELs from low level to high.                                   
BHIER035 DS    0H                                                               
         GOTOR UPDPASS,DMCB,(C'D',AIO4),(C'K',QA_OFFC)                          
         L     R2,AIO1                                                          
         SR    RE,RE                                                            
         LA    R3,ACTRFST                                                       
         USING FFTELD,R3                                                        
BHIER040 DS    0H                                                               
         CLI   FFTEL,0                                                          
         JE    BHIER070            DONE, UPDATE FILE                            
         CLI   FFTEL,FFTELQ                                                     
         JNE   BHIER043                                                         
         CLI   FFTTYPE,FFTTEPTR                                                 
         JNE   BHIER043                                                         
         GOTOR VHELLO,DMCB,(C'P',ACCMST),AIO4,FFTELD                            
         CLI   12(R1),0                                                         
         JE    BHIER043                                                         
         DC    H'0'                                                             
*                                                                               
BHIER043 DS    0H                                                               
         LLC   RE,FFTLN                                                         
         AR    R3,RE                                                            
         J     BHIER040                                                         
* NOT ON FILE, ADD                                                              
BHIER050 DS    0H                                                               
         L     R2,AIO1                                                          
         MVC   ACTKEY,IOKEYSAV                                                  
         NI    ACTRSTAT,FF-ACTSABLP                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOMST+IO1'                           
         JE    *+6                                                              
         DC    H'0'                                                             
         CLC   ACTKEY+ACTKEND(L'ACTKEY-ACTKEND),SPACES                          
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR UPDPASS,DMCB,(C'A',AIO1),QA_OFFC                                 
         J     BHIER015                                                         
*  DELETED, RESTORE                                                             
BHIER060 DS    0H                                                               
         MVC   IOKEY,IOKEYSAV                                                   
         L     R1,=AL4(IORDUPD+IODIR+IO4)                                       
         GOTOR (#IOEXEC,AIOEXEC)                                                
         L     R1,=AL4(IOGETRUP+IOMST+IO4)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
*                                                                               
* Undelete directory                                                            
*                                                                               
         NI    ACTKSTAT,FF-ACTSDELT                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR+IO4'                            
*                                                                               
         L     R2,AIO4                                                          
         NI    ACTRSTAT,FF-ACTSDELT                                             
BHIER070 DS    0H                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO4'                           
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         CLC   ACTKEY+ACTKEND(L'ACTKEY-ACTKEND),SPACES                          
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR UPDPASS,DMCB,(C'A',AIO4),QA_OFFC                                 
         J     BHIER015                NEXT ONE                                 
*                                                                               
BLDHIERX J     EXITY                                                            
         DROP  R3,R2                                                            
         EJECT                                                                  
***********************************************************************         
*             CHECK ACCOUNT CODE ROUTINE                              *         
***********************************************************************         
         SPACE 1                                                                
CODECHK  NTR1  LABEL=*,BASE=*                                                   
         LA    RE,L'ACTKACT                                                     
CODECHK2 CLI   0(R1),C','                                                       
         JE    EXITN                                                            
         CLI   0(R1),C'*'                                                       
         JE    EXITN                                                            
         CLI   0(R1),C';'                                                       
         JE    EXITN                                                            
         AHI   R1,1                                                             
         JCT   RE,CODECHK2                                                      
         CR    RB,RB                                                            
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* CHECK WHETHER ACCOUNT NAME HAS CHANGED AND IF SO ADD POINTER        *         
* FOR REFRESH OF CONTRA-ACCOUNT NAMES                                 *         
*              TSAR IN AIO8                                                     
***********************************************************************         
         SPACE 1                                                                
CHKNAME  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*CHKNAM*'                                                      
         L     R7,AIO8                                                          
         USING T_D,R7                                                           
         LA    R4,T_ELEMS                                                       
         USING NAMELD,R4                                                        
CHKN10   DS    0H                                                               
         CLI   NAMEL,0                                                          
         JE    CHKNX               NO CHANGE                                    
         CLI   NAMEL,NAMELQ                                                     
         JE    CHKN20              CHANGE                                       
         LLC   RF,NAMLN                                                         
         AR    R4,RF                                                            
         J     CHKN10                                                           
*                                                                               
CHKN20   DS    0H                                                               
         LA    R3,IOKEY                                                         
         USING ANCRECD,R3                                                       
         MVC   ANCKEY,SPACES                                                    
         MVI   ANCKTYP,ANCKTYPQ                                                 
         MVC   ANCKCULA(1),CUXCPY                                               
         MVC   ANCKCULA+1(L'T_ULA),T_ULA                                        
         L     R1,=AL4(IORDD+IODIR+IO1)                                         
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    CHKNX               POINTER ALREADY THERE                        
         CLI   IOERR,IOEDEL                                                     
         JE    CHKNX                                                            
         MVC   IOKEY,SPACES        GET SOURCE REC POINTER FOR DA                
         MVC   IOKEY(1),CUXCPY                                                  
         MVC   IOKEY+1(L'T_ULA),T_ULA                                           
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   ANCKEY,SPACES                                                    
         MVI   ANCKTYP,ANCKTYPQ                                                 
         MVC   ANCKCULA(1),CUXCPY                                               
         MVC   ANCKCULA+1(L'T_ULA),T_ULA                                        
         XC    ANCKSTA,ANCKSTA                                                  
         OI    ANCKSTA,ACTSDELT    ALWAYS ADDED AS DELETED                      
         GOTOR (#IOEXEC,AIOEXEC),'IOADD+IODIR+IO1'                              
CHKNX    J     EXITY                                                            
         DROP  R7                                                               
         EJECT                                                                  
***********************************************************************         
* Add an element to TSAR block for update                             *         
* On ntry R7=A(TSAR)                                                  *         
* ELEMENT contains element to be added                                *         
***********************************************************************         
         SPACE 1                                                                
         USING T_D,R7                                                           
         USING M_CLIEL,RF                                                       
ADDELT   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDELT*'                                                      
*                                                                               
         L     R7,AIO8                                                          
         LA    RF,ELEMENT                                                       
*                                  Find end of record                           
         XR    R1,R1                                                            
         LH    R1,T_RECLEN         R1=end of tsar record                        
         SHI   R1,L'T_TERM         subtract terminator byte                     
         AR    R1,R7                                                            
         LLC   RE,M_CLILEN                                                      
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   0(0,R1),ELEMENT                                                  
         EX    RE,0(RF)                                                         
         LA    RE,1(RE)                                                         
         AR    R1,RE                                                            
         MVI   0(R1),0             New terminator                               
         LH    R1,T_RECLEN                                                      
         AR    R1,RE                                                            
         STH   R1,T_RECLEN                                                      
         OI    T_INDS,T_IUPDAT                                                  
         J     EXITY                                                            
         EJECT                                                                  
         DROP  R7,RF                                                            
***********************************************************************         
* Interface to TSAR                                                   *         
*                                                                     *         
* Note that when running off-line the TSAR buffers are acquired only  *         
* once - the XC(TSPNEWL) below is intentional as the first time       *         
* through the code TSAR will issue the GETMAIN for the buffer         *         
* ENTRY : R1 P0=TSAR ACTION                                                     
* EXIT :  CCODE NEQ IF ERROR, ERROR BITS IN DMCB P1 B1 (TSERRS)                 
***********************************************************************         
                                                                                
         USING T_D,R7                                                           
GOTSAR   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GOTSAR*'                                                      
                                                                                
         LR    R2,R1               R2=A(Caller's parameter list)                
         LA    R3,TSARABUF         Point to correct TSAR block                  
                                                                                
         USING TSARD,R3            R3=A(TSAR block)                             
         L     R7,AIO8                                                          
         ST    R7,TSAREC           Set A(Record)                                
         CLI   0(R2),TSAINI        Test initialisation call                     
         JNE   GOTSAR02                                                         
         XC    TSARD(TSPNEWL),TSARD                                             
         MVC   TSACTN,0(R2)                                                     
         MVC   TSACOM,ACOMFACS                                                  
         LHI   R0,ONEK                                                          
         STCM  R0,3,TSBUFFL        Set require 1MB off-line                     
         MVI   TSRECI,TSRTSAB1+TSRVAR     VARIABLE LENGTH                       
         OI    TSRECI,TSRXTN                                                    
         MVI   TSKEYL,T_KEYL       Set key length                               
         LHI   R0,2000                                                          
         STCM  R0,3,TSRECL         Set MAXrecord length                         
         MVI   TSINDS,TSINODSK     Set no disk writes (save/restore)            
         GOTOR VTSAR,TSARD                                                      
         TM    TSINDS,TSIINIOK                                                  
         JNZ   EXITY                                                            
         DC    H'0'                Initialisation failure                       
                                                                                
GOTSAR02 TM    TSINDS,TSIINIOK     Test initialised                             
         JZ    GOTSAR04                                                         
                                                                                
         MVC   TSACTN,0(R2)        Set action                                   
         GOTOR VTSAR,TSARD         Call TSAR                                    
         J     GOTSARX                                                          
                                                                                
GOTSAR04 MVI   TSERRS,TSEEOF       Set EOF if not initialised                   
*                                                                               
GOTSARX  MVC   DMCB(L'TSERRS),TSERRS    PASS BACK ERRORS                        
         CLI   TSERRS,0            Set condition code for caller                
         J     EXIT                                                             
         DROP  R3,R7                                                            
         EJECT                                                                  
***********************************************************************         
* Check equivalent rule table from ledger SJ                          *         
* Ntry - Length/Code in TEMP                                          *         
*        P1=A(Rule type/UL/Code)                                      *         
*        P2=A(Rule table)                                             *         
*        FLDNO1/FLDNO2 stores the field nos.                          *         
* Exit - CC=EQU if OK                                                 *         
*        CC=LOW if Not OK (with error set)                            *         
* Regs   R2,R3,R4,R5,RE,RF                                            *         
***********************************************************************         
         USING EQRULTBD,RF                                                      
CHKRULE  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'**CHKR**'                                                      
         L     RF,4(R1)            A(Rule table)                                
         L     R1,0(R1)            A(Rule type)                                 
*                                                                               
CHKRU10  CLI   EQRLSEQ,X'FF'       EOT?                                         
         JNE   CHKRU12                                                          
         LARL  RF,SAVERR                                                        
         GOTOR (RF),DMCB,=AL2(AE$NORUL),(5,=C'EC060'),FLDNO1                    
         J     EXITN               NO INPUT ALLOWED                             
CHKRU12  CLC   EQRLSEQ,0(R1)       SAME SEQUENCE NUMBER?                        
         JE    CHKRU20                                                          
         LA    RF,EQRLLNQ(,RF)                                                  
         J     CHKRU10                                                          
                                                                                
CHKRU20  CLC   TEMP(1),EQRMVLN                                                  
         JNL   CHKRU22                                                          
         LARL  RF,SAVERR                                                        
         GOTOR (RF),DMCB,=AL2(AE$EQVSH),(5,=C'EC082'),FLDNO1                    
         J     EXITN               SJ/SR EQV INPUT LENGTH TOO SHORT             
*                                                                               
CHKRU22  CLC   TEMP(1),EQRLLEN                                                  
         JNH   CHKRU24                                                          
         LARL  RF,SAVERR                                                        
         GOTOR (RF),DMCB,=AL2(AE$EQVLN),(5,=C'EC083'),FLDNO1                    
         J     EXITN               SJ EQV INPUT LENGTH TOO LONG                 
*                                                                               
CHKRU24  LA    R2,TEMP+1           R2 POINTS TO CODE ENTERED                    
         LA    R4,EQRLRULE         R4 POINTS TO LENGTH OF FIRST LEVEL           
         ZIC   RE,EQRLNLVS         RE=TOTAL NUMBER OF LEVEL                     
         DROP  RF                                                               
CHKRU30  LLC   RF,0(R4)            DON'T SCREW UP RF IT IS A LOOP CNTR          
         CHI   RE,1                FOR LOWEST LEVEL                             
         JNE   CHKRU32                                                          
         LLC   RF,TEMP                                                          
         LA    RF,TEMP+1(RF)                                                    
         SR    RF,R2                                                            
*                                                                               
CHKRU32  LA    R3,1(R4)            POINT TO FIRST CHARACTER OF RULE             
*                                                                               
CHKRU40  CLI   0(R3),X'83'         IS IT LOWER CASE 'C'                         
         JE    CHKRU50             SKIP CHECKNG FOR LOWER 'A' AND '#'           
         CLI   0(R3),X'81'         IS IT LOWER CASE 'A'                         
         JNE   CHKRU60             IF NO THEN CHECK FOR NUMBER SIGN             
         CLI   0(R2),C'.'          C'.' IS A 'ALPHANUMERIC' CHARACTER           
         JE    CHKRU90                                                          
*                                                                               
CHKRU50  STM   R1,R2,SVR1R2        SAVE R1 AND R2 AS TRT CHANGES IT             
         LA    R5,OTRTAB                                                        
         TRT   0(1,R2),0(R5)       CHECK FOR ALPHANUMERIC CHAR                  
         JNZ   CHKRUER2                                                         
         CLI   0(R3),X'83'         IS IT LOWER CASE 'C'                         
         JNE   CHKRU90             NO - OK                                      
         CLI   0(R2),X'F0'         IS IT BETWEEN 0 AND 9                        
         JNL   CHKRUERR            YES - ERROR                                  
         J     CHKRU90                                                          
*                                                                               
CHKRU60  CLI   0(R3),C'#'                                                       
         JNE   CHKRU80                                                          
CHKRU70  CLI   0(R2),X'F0'         IS IT BETWEEN 0 AND 9                        
         JL    CHKRUERR                                                         
         J     CHKRU90                                                          
CHKRU80  CLC   0(1,R3),0(R2)       HAS TO BE A CONSTANT                         
         JNE   CHKRUERR                                                         
CHKRU90  LA    R2,1(,R2)           BUMP ACCOUNT BY 1 CHARACTER                  
         LA    R3,1(,R3)           BUMP RULE BY 1 CHARACTER                     
         JCT   RF,CHKRU40                                                       
                                                                                
         ZIC   R3,0(R4)                                                         
         LA    R3,1(,R3)           ADD OVERHEAD                                 
         AR    R4,R3                                                            
         JCT   RE,CHKRU30          GET NEXT RULE ELEMENT                        
         J     EXITY                                                            
                                                                                
CHKRUER2 LM    R1,R2,SVR1R2        ERROR BUT REINSTATE REGS FIRST               
                                                                                
CHKRUERR CLI   0(R3),X'81'         NOT ALPHANUMERIC ERROR                       
         JNE   CHKRUE02                                                         
         LARL  RF,SAVERR                                                        
         GOTOR (RF),DMCB,=AL2(AE$INALN),(5,=C'EC085'),FLDNO2                    
         J     CHKRULEX                                                         
CHKRUE02 CLI   0(R3),X'83'         NOT AN ALPHABET ERROR                        
         JNE   CHKRUE04                                                         
         LARL  RF,SAVERR                                                        
         GOTOR (RF),DMCB,=AL2(AE$INALP),(5,=C'EC086'),FLDNO2                    
         J     CHKRULEX                                                         
CHKRUE04 CLI   0(R3),C'#'          NOT NUMERIC ERROR                            
         JNE   CHKRUE06                                                         
         LARL  RF,SAVERR                                                        
         GOTOR (RF),DMCB,=AL2(AE$INNUM),(5,=C'EC087'),FLDNO2                    
         J     CHKRULEX                                                         
CHKRUE06 LARL  RF,SAVERR                                                        
         GOTOR (RF),DMCB,=AL2(AE$ICNST),(5,=C'EC088'),FLDNO2                    
*                                                                               
CHKRULEX J     EXITN                                                            
         EJECT                                                                  
***********************************************************************         
* Validate  account equivalent types/codes                            *         
* Uses FLDNO1 and FLDNO2 for field nos.                               *         
***********************************************************************         
         USING QI_EQFLD,R2                                                      
         USING EQRULTBD,RF                                                      
VALAEQV  NTR1  LABEL=NO           ** SJ account equivalent **                   
         J     *+12                                                             
         DC    C'**VAQV**'                                                      
         XR    R2,R2                                                            
         ICM   R2,7,QA_SJEQU                                                    
         JZ    VALAQVX                                                          
         XR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R2)  Number of equivalents                     
         JZ    VALAQVX                                                          
         AHI   R2,LW_LN2Q             R2=A(first block)                         
         LA    RE,SJYQTAB             RE=A(equivalents passed this req)         
         ST    RE,ACURETB                                                       
         LA    R4,SJEQTAB             R4=A(equivalent rules)                    
         MVC   FLDNO1,=AL2(FLD152)                                              
         MVC   FLDNO2,=AL2(FLD153)                                              
         J     VALAQV02                                                         
*                                                                               
VALDEQV  NTR1  LABEL=NO            **  SR account equivalent **                 
         J     *+12                                                             
         DC    C'**VDQV**'                                                      
         XR    R2,R2                                                            
         ICM   R2,7,QA_SREQU                                                    
         JZ    VALAQVX                                                          
         XR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R2)  Number of equivalents                     
         JZ    VALAQVX                                                          
         AHI   R2,LW_LN2Q             R2=A(first block)                         
         LA    RE,SRYQTAB             RE=A(equivalents passed this req)         
         ST    RE,ACURETB                                                       
         LA    R4,SREQTAB             RE=A(equivalent rules)                    
         MVC   FLDNO1,=AL2(FLD154)                                              
         MVC   FLDNO2,=AL2(FLD155)                                              
*                                                                               
VALAQV02 LA    R1,EQTYTAB                                                       
         L     RE,ACURETB                                                       
         LHI   RF,EQTYTABN                                                      
*                                                                               
VALAQV04 CLC   QI_EQTYP,0(R1)         Check we are allowed this                 
         JE    VALAQV06               equivalent type                           
         LA    R1,L'EQTYTAB(R1)                                                 
         LA    RE,1(RE)                                                         
         JCT   RF,VALAQV04                                                      
*                                                                               
VALAQV05 LARL  RF,SAVERR                                                        
         GOTOR (RF),DMCB,=AL2(AE$NOEQU),(5,=C'EC080'),FLDNO1                    
         J     VALAQV10            Unknown equivalent account type              
*                                                                               
VALAQV06 LR    RF,R4                                                            
*                                                                               
VALAQV6A CLI   EQRLSEQ,X'FF'       EOT?                                         
         JE    VALAQV05            no match on equivalent                       
         CLC   EQRLSEQ,1(R1)                                                    
         JE    VALAQV07                                                         
         LA    RF,EQRLLNQ(RF)                                                   
         J     VALAQV6A                                                         
*                                                                               
VALAQV07 CLI   0(RE),0                                                          
         JE    VALAQV08            Only one of each type allowed                
         LARL  RF,SAVERR                                                        
         GOTOR (RF),DMCB,=AL2(AE$DUPEQ),(5,=C'EC081'),FLDNO1                    
         J     VALAQV10                                                         
*                                                                               
VALAQV08 CLC   QI_EQCOD,SPACES     Any code passed?                             
         JH    VALAQV09                                                         
         LARL  RF,SAVERR                                                        
         GOTOR (RF),DMCB,=AL2(AE$MISIF),(5,=C'EC122'),FLDNO2                    
         J     VALAQV10            Code required if type passed                 
*                                                                               
VALAQV09 XC    TEMP,TEMP                                                        
         MVC   0(1,RE),0(R1)                                                    
         MVC   TEMP(1),1(R1)       Need to validate with code                   
*                                                                               
OIO      USING EQURECD,IOKEY                                                    
         XC    IOKEY,IOKEY                                                      
         MVI   OIO.EQUKTYP,EQUKTYPQ                                             
         MVC   OIO.EQUKCPY,CUXCPY                                               
         MVC   OIO.EQUKREM,SPACES                                               
         MVC   OIO.EQUKRULE,TEMP       Rule from VALAEQV                        
         MVC   OIO.EQUKCODE,SPACES                                              
         GOTOR SETXLN,DMCB,QI_EQCOD,L'EQUKCODE                                  
         L     RF,4(R1)                                                         
         BASR  RE,0                                                             
         MVC   OIO.EQUKCODE(0),QI_EQCOD                                         
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         STC   RF,TEMP                                                          
         MVC   TEMP+1(L'EQUKCODE),OIO.EQUKCODE                                  
         GOTOR CHKRULE,DMCB,OIO.EQUKRULE,0(R4)                                  
*                                                                               
VALAQV10 LA    R2,QI_EQLEN(R2)     Bump to next code                            
         JCT   R0,VALAQV02                                                      
*                                                                               
VALAQVX  J     EXITY                                                            
         EJECT                                                                  
         DROP  R2,OIO                                                           
***********************************************************************         
* Validate costing group exists                                       *         
***********************************************************************         
         USING ACTRECD,R2                                                       
VALCSG   NTR1  LABEL=NO           ** Validate costing group **                  
         J     *+12                                                             
         DC    C'*VALCSG*'                                                      
         CLI   CUCTRY,CTRYGER     GERMANY?                                      
         JNE   EXITY                                                            
         LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(2),=C'13'                                                
         CLC   SEUL,QA_UNIT                                                     
         JE    VCSG02                                                           
         MVC   ACTKUNT(2),=C'12'                                                
         CLC   SIUL,QA_UNIT                                                     
         JE    VCSG02                                                           
         MVC   ACTKUNT(2),=C'14'                                                
         CLC   ONERUL,QA_UNIT                                                   
         JNE   VCSGX                                                            
*                                                                               
VCSG02   MVC   ACTKACT(L'QA_CANAL),QA_CANAL                                     
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    VCSGX                                                            
         LARL  RF,SAVERR                                                        
         GOTOR (RF),DMCB,=AL2(AE$COSTG),(5,=C'EC124'),=AL2(FLD024)              
         J     EXITN                                                            
*                                                                               
VCSGX    J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Validate values passed are valid for ledgers                        *         
***********************************************************************         
         USING LDGLVBD,R2                                                       
VALLOP   NTR1  LABEL=NO           ** Validate costing group **                  
         J     *+12                                                             
         DC    C'*VALCSG*'                                                      
         LA    R2,LDGLVB                                                        
*                                  Check option is valid for ledger             
VALLOP02 MVC   FLDNO1,LDGFLDN      Store field no. for error message            
*                                                                               
         XR    R7,R7                                                            
         LH    R7,LDGDISP                                                       
         AR    R7,R8               Check anything passed                        
         TM    LDGINDS,LDGIARR     Dealing with an array?                       
         JNZ   VALLOP04                                                         
         OC    0(1,R7),0(R7)                                                    
         JZ    VALLOP08                                                         
         J     VALLOP06                                                         
*                                                                               
VALLOP04 XR    RF,RF                                                            
         ICM   RF,7,0(R7)          R7=A(array)                                  
         JZ    VALLOP08                                                         
         XR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R7)                                            
         LTR   R0,R0                                                            
         JZ    VALLOP08            Check any array entries                      
*                                  If data passed ensured valid for             
VALLOP06 TM    LDGLEDG,LDGSJUL     ledger                                       
         JZ    *+14                                                             
         CLC   PRODUL,QA_UNIT      Valid for SJ?                                
         JE    VALLOP08                                                         
         TM    LDGLEDG,LDGSRUL                                                  
         JZ    *+14                                                             
         CLC   SRUL,QA_UNIT        Valid for SR?                                
         JE    VALLOP08                                                         
         TM    LDGLEDG,LDGSEUL                                                  
         JZ    *+14                                                             
         CLC   SEUL,QA_UNIT        Valid for SE?                                
         JE    VALLOP08                                                         
         TM    LDGLEDG,LDGSIUL                                                  
         JZ    *+14                                                             
         CLC   SIUL,QA_UNIT        Valid for SI?                                
         JE    VALLOP08                                                         
         TM    LDGLEDG,LDGSQUL                                                  
         JZ    *+14                                                             
         CLC   SQUL,QA_UNIT        Valid for SQ?                                
         JE    VALLOP08                                                         
         TM    LDGLEDG,LDGSVUL                                                  
         JZ    *+14                                                             
         CLC   SVUL,QA_UNIT        Valid for SV?                                
         JE    VALLOP08                                                         
         TM    LDGLEDG,LDGSXUL                                                  
         JZ    *+14                                                             
         CLC   SVUL,QA_UNIT        Valid for SX?                                
         JE    VALLOP08                                                         
         LARL  RF,SAVERR                                                        
         GOTOR (RF),DMCB,=AL2(AE$OPTNV),(5,=C'EC125'),FLDNO1                    
         J     EXITN               Option not valid                             
*                                                                               
VALLOP08 LA    R2,LDGLVBL(R2)                                                   
         CLI   0(R2),X'FF'                                                      
         JNE   VALLOP02                                                         
         J     EXITY                                                            
         EJECT                                                                  
*&&UK                                                                           
***********************************************************************         
* Validate vat codes (QA_VATCD and QA_13VAT)                          *         
***********************************************************************         
         SPACE 1                                                                
VALVAT   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*VALVAT*'                                                      
         CLC   QA_VATCD,SPACES     Any vat code?                                
         JNH   VALVAT02                                                         
         MVC   FLDNO1,=AL2(FLD061)                                              
         CLC   QA_13VAT,SPACES     Can't have both 13B and vat                  
         JH    VALVATBT                                                         
         GOTOR CALLVAT,DMCB,(L'QA_VATCD,QA_VATCD)                               
         JNE   VALVATN1            Call vatican to check vat code               
*                                                                               
VALVAT02 CLC   QA_13VAT,SPACES     Any 13B vat code?                            
         JNH   EXITY                                                            
         TM    CPYSTAT5,CPYSNVAT   TEST NEW VAT RECORD IN USED?                 
         BZ    VALVATN2                                                         
         OC    QA_VTRGL,QA_VTRGL   Vat region length not set?                   
         JZ    VALVATRG                                                         
         CLI   QA_VATRG,DDTAXLEQ   Vat region must be E                         
         JNE   VALVATRG                                                         
         MVC   FLDNO1,=AL2(FLD060)                                              
         LA    R2,QA_13VAT                                                      
         LLC   R0,QA_13VTL                                                      
*                                                                               
VALVAT04 LA    RF,QA_13VAT         Check for duplicate entries                  
         LLC   RE,QA_13VTL                                                      
*                                                                               
VALVAT06 CLI   0(RF),C' '          Check for no input                           
         JNH   VALVAT07                                                         
         CR    RF,R2               Don't check current vat code against         
         JE    *+14                itself                                       
         CLC   0(1,RF),0(R2)                                                    
         JE    VALVATDP                                                         
VALVAT07 AHI   RF,1                                                             
         JCT   RE,VALVAT06                                                      
         GOTOR CALLVAT,DMCB,(1,0(R2))                                           
         JNE   VALVATN3            Call vatican to check vat codes              
*                                                                               
VALVAT08 AHI   R2,1                Loop over 13B vat codes                      
         JCT   R0,VALVAT10                                                      
         J     EXITY                                                            
*                                                                               
VALVAT10 CLI   0(R2),C' '          Any entry                                    
         JH    VALVAT04                                                         
         J     VALVAT08                                                         
*                                                                               
VALVATN1 LARL  RF,SAVERR                                                        
         GOTOR (RF),DMCB,=AL2(AE$INVIF),(5,=C'EC126'),FLDNO1                    
         J     EXITN               Invalid vat code                             
*                                                                               
VALVATN2 LARL  RF,SAVERR                                                        
         GOTOR (RF),DMCB,=AL2(AE$CPYNV),(5,=C'EC127'),FLDNO1                    
         J     EXITN               Company not on new VAT                       
*                                                                               
VALVATN3 LARL  RF,SAVERR                                                        
         GOTOR (RF),DMCB,=AL2(AE$IV13B),(5,=C'EC128'),FLDNO1                    
         J     EXITN               Invalid 13B vat code                         
*                                                                               
VALVATRG LARL  RF,SAVERR                                                        
         GOTOR (RF),DMCB,=AL2(AE$INVTR),(5,=C'EC129'),FLDNO1                    
         J     EXITN               Invalid vat region for 13b                   
*                                                                               
VALVATBT LARL  RF,SAVERR                                                        
         GOTOR (RF),DMCB,=AL2(AE$VOVRN),(5,=C'EC130'),FLDNO1                    
         J     EXITN               Can't have 13b and vat                       
*                                                                               
VALVATDP LARL  RF,SAVERR                                                        
         GOTOR (RF),DMCB,=AL2(AE$DUPIF),(5,=C'EC131'),FLDNO1                    
         J     EXITN               Can't have duplicate 13B vat                 
         EJECT                                                                  
***********************************************************************         
* Call VATICAN to check 13B vat code                                  *         
***********************************************************************         
         SPACE 1                                                                
         USING VTCD,R2                                                          
CALLVAT  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*CALLVT*'                                                      
         L     R3,0(R1)                                                         
         LA    R2,TEMP             DO A VATICAN CALL - INPUT                    
         XC    VTCD(VTCLNQ),VTCD                                                
         MVI   VTCACTN,VTCAIVAL                                                 
         MVC   VTCCPY,CUXCPY                                                    
         MVC   VTCOFFC,FFS8        (NO OFFICE VALIDATION)                       
         MVC   VTCCOMF,ACOMFACS                                                 
         GOTO1 VDATCON,DMCB,(5,0),(1,VTCINVD)                                   
         MVC   VTCCPYS1,CPYSTAT1                                                
         OI    VTININDS,VTINFLDV                                                
         ST    R3,VTCAFLDV         A(FIELD)                                     
         L     RF,=V(VATICAN)                                                   
         A     RF,SRVRRELO                                                      
         GOTOR (RF),VTCD                                                        
         JNZ   EXITN                                                            
*                                                                               
         LA    R2,TEMP             DO A VATICAN CALL - OUTPUT                   
         XC    VTCD(VTCLNQ),VTCD                                                
         MVI   VTCACTN,VTCAOVAL                                                 
         MVC   VTCCPY,CUXCPY                                                    
         MVC   VTCOFFC,FFS8                                                     
         MVC   VTCCOMF,ACOMFACS                                                 
         GOTO1 VDATCON,DMCB,(5,0),(1,VTCINVD)                                   
         MVC   VTCCPYS1,CPYSTAT1                                                
         OI    VTININDS,VTINFLDV                                                
         ST    R3,VTCAFLDV         A(FIELD)                                     
         L     RF,=V(VATICAN)                                                   
         A     RF,SRVRRELO                                                      
         GOTOR (RF),VTCD                                                        
         JNZ   EXITN                                                            
         J     EXITY                                                            
         EJECT                                                                  
         DROP  R2                                                               
*&&                                                                             
***********************************************************************         
* Build debtor and costing accounts for SAP upload                    *         
***********************************************************************         
BLDDCST  NTR1  LABEL=NO           ** SJ account equivalent **                   
         J     *+12                                                             
         DC    C'**BLLD**'                                                      
*                                                                               
         CLI   QA_UPLD,QA_SAPTL    Only for SAP tool                            
         JE    *+6                                                              
         DC    H'0'                                                             
         CLC   QA_DRACT,SPACES     Any debtor passed?                           
         JH    BLDDCS50            yes, keep it                                 
         CLI   QA_SREQI,0          if not, have debtor equiv?                   
         JE    BLDDCS50                                                         
         TM    AC_IND1,AC_INEW2+AC_ILVL2                                        
         JZ    BLDDCS35            Client always autobuilds.                    
         CLI   QA_SJEQI,0                                                       
         JE    BLDDCS35            Product builds if sap sr neq sj              
         XR    R6,R6                                                            
         ICM   R6,7,QA_SJEQU                                                    
         XR    R0,R0                                                            
         IC    R0,LW_NUMN-LW_D(R6)                                              
         LA    R6,LW_LN2Q(R6)                                                   
         USING QI_EQFLD,R6                                                      
BLDDCS10 CLI   QI_EQTYP,QI_EQTY0   find SJ account equivalent                   
         JE    BLDDCS15                                                         
         LA    R6,QI_EQLEN(R6)                                                  
         JCT   R0,BLDDCS10                                                      
         DC    H'0'                Missing equiv                                
         DROP  R6                                                               
*                                                                               
BLDDCS15 DS    0H                                                               
         XR    R1,R1                                                            
         ICM   R1,7,QA_SREQU                                                    
         XR    R0,R0                                                            
         IC    R0,LW_NUMN-LW_D(R1)                                              
         LA    R1,LW_LN2Q(R1)                                                   
         USING QI_EQFLD,R1                                                      
BLDDCS20 CLI   QI_EQTYP,QI_EQTY0   find SR account equivalent                   
         JE    BLDDCS25                                                         
         LA    R1,QI_EQLEN(R1)                                                  
         JCT   R0,BLDDCS20                                                      
         DC    H'0'                Missing equiv                                
*                                                                               
BLDDCS25 DS    0H                                                               
         CLC   QI_EQCOD,QI_EQCOD-QI_EQFLD(R6)                                   
         JE    BLDDCSX             same SR/Payer, so no override SR/1C          
         DROP  R1                                                               
*                                                                               
* Auto-build debtor                                                             
BLDDCS35 MVC   LDGAUL,SRUL                                                      
         MVI   BYTE4,0                                                          
         GOTOR (#SETLDG,ASETLDG)                                                
*                                                                               
         MVC   QA_DRACT,SPACES     Build debtor account for SAP                 
         MVC   QA_DRACT(L'SRUL),SRUL                                            
         LLC   R0,LDGAL1                                                        
         AHI   R0,L'ACTKUNT+L'ACTKLDG+2                                         
         STC   R0,QA_DRACL                                                      
         LLC   RE,LDGAL1           Take level 1 length +2                       
         AHI   RE,1                i.e. client + '00'                           
         BASR  RF,0                                                             
         MVC   QA_DRACT+L'SRUL(0),CHARZERO                                      
         EX    RE,0(RF)                                                         
         LLC   RE,LDGAL1                                                        
         TM    AC_IND1,AC_INEW2+AC_ILVL2                                        
         JZ    *+10                                                             
         LLC   RE,LDGAL2                                                        
         BCTR  RE,0                                                             
         BASR  RF,0                                                             
         MVC   QA_DRACT+L'SRUL(0),OA_ACT                                        
         EX    RE,0(RF)                                                         
*                                                                               
BLDDCS50 CLC   QA_CSACT,SPACES     Any costing account passed?                  
         JH    BLDDCSX             yes, keep it                                 
         CLI   QA_SREQI,0          if not, have debtor equiv?                   
         JE    BLDDCSX                                                          
         MVC   LDGAUL,ONECUL                                                    
         MVI   BYTE4,0                                                          
         GOTOR (#SETLDG,ASETLDG)                                                
         MVC   QA_CSACT,SPACES                                                  
         LLC   R0,LDGAL1                                                        
         AHI   R0,L'ACTKUNT+L'ACTKLDG+2                                         
         STC   R0,QA_CSACL                                                      
         LLC   RE,LDGAL1           Build it for SAP                             
         AHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   QA_CSACT(0),CHARZERO                                             
         EX    RE,0(RF)                                                         
         LLC   RE,LDGAL1                                                        
         TM    AC_IND1,AC_INEW2+AC_ILVL2 Cli or pro?                            
         JZ    *+10                                                             
         LLC   RE,LDGAL2                                                        
         BCTR  RE,0                                                             
         BASR  RF,0                                                             
         MVC   QA_CSACT(0),OA_ACT                                               
         EX    RE,0(RF)                                                         
*                                                                               
BLDDCSX  J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Build all equivalent records                                        *         
***********************************************************************         
         SPACE 1                                                                
         USING EQURECD,R4                                                       
BLDEQVS  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'**BLDE**'                                                      
         MVI   BYTE1,0                                                          
         XR    R2,R2                                                            
         ICM   R2,7,QA_SJEQU          Any SJ equivalents passed?                
         JZ    BLDEQV20                                                         
         XR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R2)  Number of equivalents                     
         JZ    BLDEQV20                                                         
         AHI   R2,LW_LN2Q             R2=A(first block)                         
*                                                                               
BLDEQV02 ST    R0,SAVER0                                                        
         LA    RE,EQTYTAB          Lookup to get sequence                       
*                                                                               
BLDEQV04 CLI   0(RE),0                                                          
         JNE   *+6                 Something wrong here previous                
         DC    H'0'                validation didn't work                       
         CLC   0(1,RE),0(R2)                                                    
         JE    BLDEQV06                                                         
         LA    RE,2(RE)                                                         
         J     BLDEQV04                                                         
*                                                                               
BLDEQV06 LA    R4,IOKEY                                                         
         XC    IOKEY,IOKEY                                                      
         MVI   EQUKTYP,EQUKTYPQ                                                 
         MVC   EQUKCPY,CUXCPY                                                   
         MVC   EQUKREM,SPACES                                                   
         MVC   EQUKRULE,1(RE)                                                   
         MVC   EQUKUL,SJUL         SJ or SR?                                    
         TM    BYTE1,X'80'                                                      
         JZ    *+10                                                             
         MVC   EQUKUL,SRUL                                                      
         MVC   EQUKCODE,SPACES                                                  
         MVC   EQUKCODE,1(R2)                                                   
         MVC   CSVKEY1,IOKEY                                                    
* restore Acc as default, if necessary                                          
         OI    IOINDS1,IO1XSWCH                                                 
*                                                                               
         L     R1,=AL4(IORDD+IODIR+IO1)                                         
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    BLDEQV15            Exists already?                              
         TM    IOERR,IOERNF        Not found?                                   
         JO    BLDEQV10                                                         
         TM    IOERR,IOEDEL        Deleted?                                     
         JO    *+6                                                              
         DC    H'0'                                                             
         NI    EQUKSTA1,X'FF'-EQUSDEL Undelete it                               
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR+IO1'                            
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R1,=AL4(IOGETRUP+IOMST+IO1)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
         NI    EQURSTA,X'FF'-EQUSDEL Undelete it                                
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO1'                           
         JE    BLDEQV15                                                         
         DC    H'0'                                                             
*                                                                               
BLDEQV10 L     R4,AIO1               Add new equivalent record                  
         MVC   0(L'ACCKEY,R4),CSVKEY1                                           
         XC    EQURLNK,EQURLNK                                                  
         XC    EQURSTA,EQURSTA                                                  
         OI    EQURSTA,EQUSLOW                                                  
         GOTOR SETXLN,DMCB,EQUKCODE,L'EQUKCODE                                  
         L     R1,4(R1)                                                         
         LA    RF,EQURFST                                                       
         USING NAMELD,RF                                                        
         XC    NAMELD(NAMLN1Q),NAMELD                                           
         MVI   NAMEL,NAMELQ        Add name element                             
         BASR  RE,0                                                             
         MVC   NAMEREC(0),EQUKCODE                                              
         EX    R1,0(RE)                                                         
         AHI   R1,NAMLN1Q+1                                                     
         STC   R1,NAMLN                                                         
         AR    RF,R1                                                            
         USING RSTELD,RF                                                        
*&&UK*&& XC    RSTELD(RSTLN4Q),RSTELD                                           
*&&US*&& XC    RSTELD(RSTLN3Q),RSTELD                                           
         MVI   RSTEL,RSTELQ        Add status change                            
*&&UK*&& MVI   RSTLN,RSTLN4Q                                                    
*&&US*&& MVI   RSTLN,RSTLN3Q                                                    
         MVC   RSTBDATE,AC_TODYP                                                
         MVC   RSTTDATE,AC_TODYP                                                
         MVI   RSTCOSTG,C' '                                                    
         MVI   RSTFILT1,C' '                                                    
         MVI   RSTFILT2,C' '                                                    
         MVI   RSTFILT3,C' '                                                    
         MVI   RSTFILT4,C' '                                                    
         MVI   RSTFILT5,C' '                                                    
         LLC   R0,RSTLN                                                         
         AR    RF,R0                                                            
         USING RACELD,RF                                                        
         XC    RACELD(RACLNQ),RACELD                                            
         MVI   RACEL,RACELQ                                                     
         MVI   RACLN,RACLNQ                                                     
         MVI   RACTYPE,RACTADD                                                  
         MVC   RACUSER,CUUSER      Logon                                        
         MVC   RACPERS,CUPASS      PID                                          
         MVC   RACTERM,CUTERM                                                   
         L     RE,ATWA                                                          
         MVC   RACDATE,TODAYP-TWAD(RE)                                          
         ST    RF,FULL1                                                         
         THMS                                                                   
         L     RF,FULL1                                                         
         ST    R1,RACTIME          Time 0HHMMSSC                                
         LR    RE,RF               Need to take a copy for the change           
         AHI   RF,RACLNQ                                                        
         MVC   RACEL(RACLNQ),0(RE)                                              
         MVI   RACTYPE,RACTCHA                                                  
         AHI   RF,RACLNQ                                                        
         MVI   0(RF),0                                                          
         LA    RF,1(RF)                                                         
         SR    RF,R4                                                            
         STH   RF,EQURLEN                                                       
         GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOMST+IO1'                           
         JE    BLDEQV15                                                         
         DC    H'0'                                                             
*                                                                               
BLDEQV15 LA    R2,1+L'EQUKCODE(R2)                                              
         L     R0,SAVER0                                                        
         JCT   R0,BLDEQV02                                                      
*                                                                               
BLDEQV20 TM    BYTE1,X'80'            Already done SR?                          
         JNZ   BLDEQVX                                                          
         XR    R2,R2                  Now do SR                                 
         ICM   R2,7,QA_SREQU                                                    
         JZ    BLDEQVX                                                          
         XR    R0,R0                                                            
         ICM   R0,3,LW_NUMN-LW_D(R2)  Number of equivalents                     
         JZ    BLDEQVX                                                          
         ST    R0,SAVER0                                                        
         AHI   R2,LW_LN2Q             R2=A(first block)                         
         OI    BYTE1,X'80'                                                      
         J     BLDEQV02                                                         
*                                                                               
BLDEQVX  J     EXITY                                                            
         EJECT                                                                  
         DROP  R4,RF                                                            
***********************************************************************         
* Convert SAP media codes for SAP upload                              *         
* On ntry pointing to Media block                                     *         
* Errors thrown if no SAP equivalent found                            *         
* EXITL if no equivalent or no SF ledger                              *         
***********************************************************************         
         SPACE 1                                                                
         USING SAPTABD,R2                                                       
         USING QI_MFLDD,R4                                                      
SAPMED   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'**SAPM**'                                                      
         CLI   QA_UPLD,QA_SAPTL    Only for SAP upload tool                     
         JNE   EXITY                                                            
         OC    QI_MEDI1(QI_MBLGR-QI_MEDI1),SPACES    ensure u/c                 
         LAY   R2,SAPTAB                                                        
         LAY   RF,SAPMBLOC                                                      
         XC    0(L'SAPMBLOC,RF),0(RF)  Clear media block                        
         CLC   0(L'SAPTULA,R2),SPACES Already populated media block?            
         JH    SAPME16                                                          
*                                                                               
         USING ACTRECD,R3                                                       
SAPME02  LA    R3,IOKEY            Read for SAP equivalent                      
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(L'ACTKUNT+L'ACTKLDG),=C'SF'                              
         LAY   R6,MEDLETS-1                                                     
*                                                                               
SAPME04  LA    R6,1(R6)            Get (next) high level SF record              
         CLI   0(R6),X'FF'                                                      
         JE    SAPME16                                                          
         LA    R3,IOKEY                                                         
         MVC   ACTKACT,SPACES                                                   
         MVC   ACTKACT(L'M_MEDDCOD),0(R6)                                       
         MVC   CSVKEY2,IOKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         CLC   IOKEY(L'ACTKEY),CSVKEY2       Is this 'media' set up?            
         JE    SAPME08             Yes                                          
         CLC   IOKEY(ACTKLDG-ACTRECD),CSVKEY2                                   
         JE    SAPME04             No, if still on SF, try another              
         J     SAPME16             No, that's all                               
*                                                                               
SAPME08  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R3,AIO2                                                          
         LA    RF,ACTRFST                                                       
*                                                                               
         USING FFTELD,RF                                                        
SAPME10  CLI   FFTEL,0                                                          
         JE    SAPME04                                                          
         CLI   FFTEL,FFTELQ                                                     
         JE    SAPME14                                                          
SAPME12  LLC   R0,FFTLN                                                         
         AR    RF,R0                                                            
         J     SAPME10                                                          
*                                                                               
SAPME14  CLI   FFTTYPE,FFTTEPTR    Find equivalent type B                       
         JNE   SAPME12                                                          
         CLC   CUAALF,=C'V9'       PGMSAP - ACC0                                
         JE    SAPME15                                                          
         CLC   CUAALF,=C'2J'       PGMSAPDM - ACC4                              
         JE    SAPME15                                                          
         CLC   CUAALF,=C'9B'       PGM - ACCA                                   
         JE    SAPME15                                                          
         CLC   CUAALF,=C'AB'       INTSAP - ACCXC                               
         JE    SAPME15                                                          
         CLI   FFTSEQ,2            All other ids use equivalent C               
         JNE   SAPME12                                                          
         J     SAPME15A                                                         
                                                                                
SAPME15  CLI   FFTSEQ,1            Use equivalent B                             
         JNE   SAPME12                                                          
SAPME15A LLC   R1,FFTDLEN                                                       
         SHI   R1,1                                                             
         MVC   SAPTULA,ACTKULA                                                  
         MVC   SAPCODE,SPACES      Spacefill like DDLINK does with data         
         BASR  R7,0                                                             
         MVC   SAPCODE(0),FFTDATA                                               
         EX    R1,0(R7)                                                         
         LA    R2,SAPTABL(R2)      move to next entry                           
         LAY   RF,SAPTABX                                                       
         CR    R2,RF                                                            
         JNH   SAPME04                                                          
         DC    H'0'                SAPTAB overflow                              
*                                  Convert SAP media codes                      
SAPME16  LA    R3,QI_MEDI1         Input SAP media code                         
         LAY   R6,SAPMBLOC         Output DDS code                              
         LAY   R2,SAPTAB                                                        
         LHI   R0,SAPTABMX                                                      
*                                                                               
SAPME18  CLC   0(L'QI_MEDI1,R3),SAPCODE Match input code with SAP               
         JE    SAPME20             code on file                                 
         LA    R2,SAPTABL(R2)                                                   
         JCT   R0,SAPME18                                                       
         LARL  RF,SAVERR                                                        
         GOTOR (RF),DMCB,=AL2(AE$MCINV),(5,=C'EC123'),0                         
         J     SAPME26             No SAP match mark as error                   
*                                                                               
SAPME20  MVC   0(1,R6),SAPTACT                                                  
         LA    R6,1(R6)                                                         
SAPME22  LA    R2,SAPTABL(R2)                                                   
         JCT   R0,SAPME24                                                       
         J     SAPME26             Loop we may have more than                   
*                                  one media for SAP media                      
SAPME24  CLC   0(L'QI_MEDI1,R3),SAPCODE Match input code with SAP               
         JE    SAPME20             code on file                                 
         J     SAPME22                                                          
*                                                                               
SAPME26  LA    R3,L'QI_MEDI1(R3)   Bump to next media in entry                  
         LAY   R2,SAPTAB                                                        
         LHI   R0,SAPTABMX                                                      
         LA    RE,QI_MBLGR                                                      
         CR    R3,RE                                                            
         JNL   SAPMEDX             Done all entries                             
         CLC   0(L'QI_MEDI1,R3),SPACES  this entry has data?                    
         JH    SAPME18             yes go translate                             
         J     SAPME26             no any others?                               
*                                                                               
SAPMEDX  J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Convert SAP due date to DDS one                                     *         
***********************************************************************         
         SPACE 1                                                                
         USING QI_MFLDD,R4                                                      
CNVDUE   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*CNVDUE*'                                                      
         CLI   QA_UPLD,QA_SAPTL    Check if SAP tool if not don't               
         JNE   CNVDXY              convert                                      
         LA    RF,QI_MDUED                                                      
         CLI   4(RF),C' '          Must be 4 chars long if from SAP!            
         JH    CNVDXN                                                           
         CLI   QI_MDUED,C'0'       Simple date?                                 
         JNE   CNVDXY                                                           
         CLC   QI_MDUED,=C'0001'   IF PAY IMMEDIATELY OUT MTH 0                 
         JNE   *+14                                                             
         MVC   WORK,ID_MTH                                                      
         J     CNVDXY                                                           
         CLC   QI_MDUED,=C'0120'                                                
         JH    CNVDXY                                                           
         MVC   WORK(L'ID_DAY),ID_DAY ELSE DAY PLUS NO. OF DAYS                  
         MVC   WORK+L'ID_DAY(L'QI_MDUED-1),QI_MDUED+1                           
         J     CNVDXY                                                           
*                                                                               
CNVDXY   J     EXITY                                                            
CNVDXN   J     EXITN                                                            
         EJECT                                                                  
***********************************************************************         
SVRDEF   CSECT                                                                  
         EJECT                                                                  
***********************************************************************         
* Literal equates for request map                                     *         
***********************************************************************         
         SPACE 1                                                                
CANALLIT DC    C'Client analysis'                                               
FUSRLIT  DC    C'Foreign User'                                                  
FNAMLIT  DC    C'Foreign name'                                                  
NICPLIT  DC    C'National Insurance profile'                                    
MASTLIT  DC    C'Is master job'                                                 
ESTILIT  DC    C'Is brandocean estimate'                                        
MCLILIT  DC    C'Master client'                                                 
MPROLIT  DC    C'Master product'                                                
DSKCLIT  DC    C'Desktop comments'                                              
DSKPLIT  DC    C'Desktop priority'                                              
TWOPLIT  DC    C'2P account code'                                               
TWODLIT  DC    C'2D account code'                                               
MADRLIT  DC    C'Media address'                                                 
NEWBLIT  DC    C'Prevent new bookings'                                          
BLCOMLIT DC    C'Billing comments compulsory'                                   
ORCOMLIT DC    C'Order comments compulsory'                                     
GEN1BLIT DC    C'Generate ME1B for booking'                                     
FRMCDLIT DC    C'Formula record code'                                           
MXAMTLIT DC    C'Max amount for media bill'                                     
BDGCULIT DC    C'Budget currency'                                               
DRNMLIT  DC    C'Debtors account name'                                          
DRLVLIT  DC    C'Debtors level'                                                 
CSNMLIT  DC    C'Costing account name'                                          
CSLVLIT  DC    C'Costing level'                                                 
BCHNMLIT DC    C'Bank charges name'                                             
EXCNMLIT DC    C'Exchange differences name'                                     
ANANMLIT DC    C'Analysis name'                                                 
DISNMLIT DC    C'Discount name'                                                 
TWOPNLIT DC    C'2P Account name'                                               
TWODNLIT DC    C'2D Account name'                                               
INCOLIT  DC    C'Income account code'                                           
INCONLIT DC    C'Income name'                                                   
WRITNLIT DC    C'Write off name'                                                
EMPTLIT  DC    C'Empty - available for future use'                              
OUTSCLIT DC    C'Outlet scheme code'                                            
OUTSILIT DC    C'Outlet scheme code indicator'                                  
OUTLPRO  DC    C'Product printable character'                                   
SJEQTLIT DC    C'SJ  equivalent type'                                           
SJEQVLIT DC    C'SJ  equivalent code'                                           
SREQTLIT DC    C'SR  equivalent type'                                           
SREQVLIT DC    C'SR  equivalent code'                                           
VIVAKLIT DC    C'Vivaki upload tool'                                            
         EJECT                                                                  
***********************************************************************         
* END OF REQUEST MAP TABLES                                          *          
***********************************************************************         
                                                                                
         LKMAP X                                                                
         EJECT                                                                  
GLOBALS  DS    0D                  ** GLOBAL LITERALS **                        
         LTORG                                                                  
ACCMST   DC    C'ACCMST  '                                                      
MEDFIL   DC    C'MEDFIL  '                                                      
PZERO    DC    P'0'                                                             
FFS8     DC    X'FFFFFFFFFFFFFFFF'                                              
CHARZERO DC    C'000000000000'                                                  
MEDLETS  DC    C'ABCDEFGHIJKLMNOPQRSTUVWXZY'                                    
         DC    X'FF'                                                            
ADDEND   DC    C'ADD=END '                                                      
SEUL     DC    C'SE'                                                            
SIUL     DC    C'SI'                                                            
SJUL     DC    C'SJ'                                                            
SQUL     DC    C'SQ'                                                            
SVUL     DC    C'SV'                                                            
SXUL     DC    C'SX'                                                            
TWODUL   DC    C'2D'                                                            
SRUL     DC    C'SR'                                                            
ONECUL   DC    C'1C'                                                            
ONERUL   DC    C'1R'                                                            
TWONUL   DC    C'29'                                                            
ID_DAY   DC    C'ID+'                                                           
ID_MTH   DC    C'IM0'                                                           
DFTBGRP  DC    C'XX'               Default billing group for SAP tool           
                                                                                
DATI     DS    0X                                                               
         DCDDL AC#BGT,6            Budget                                       
         DCDDL AC#LCLCU,6          Local                                        
         DCDDL AC#STD,8            Standard                                     
DATIX    DC    X'FF'                                                            
                                                                                
MAXRECLN EQU   IOLENQ-(L'IODA+L'IOWORK)                                         
MAXCTXTQ EQU   42                  MAX LENGTH OF COMMISSION TEXT                
                                                                                
D#ID#    EQU   1                   ID number                                    
D#ACT    EQU   2                   Account code                                 
D#ACSTA  EQU   3                   Account approval status                      
D#ERR    EQU   4                   Error                                        
D#CEMAIL EQU   5                   Creator's email address                      
D#ERROW  EQU   10                  Error row number                             
* embedded 4A call                                                              
D#ACT4A  EQU   1                   Account code                                 
D#OFF4A  EQU   2                   Office code                                  
* embedded 2E call                                                              
D#CAE    EQU   1                   Type field in TEAP call                      
                                                                                
* find job routine                                                              
DRFTQ    EQU   1                                                                
LIVEQ    EQU   0                                                                
ERRMAX   EQU   25                  Maximum no. of error messages                
MAXLIN   EQU   201                 Maximum no. of records +1                    
                                                                                
AAPPTAB  EQU   AIO6,,C'A'          A(APPTAB) - uses IO7 also                    
*                                                                               
* Field equates                                                                 
*                                                                               
FLD001   EQU   1                                                                
FLD002   EQU   2                                                                
FLD003   EQU   3                                                                
FLD004   EQU   4                                                                
FLD005   EQU   5                                                                
FLD006   EQU   6                                                                
FLD007   EQU   7                                                                
FLD008   EQU   8                                                                
FLD009   EQU   9                                                                
FLD010   EQU   10                                                               
FLD011   EQU   11                                                               
FLD012   EQU   12                                                               
FLD013   EQU   13                                                               
FLD014   EQU   14                                                               
FLD015   EQU   15                                                               
FLD016   EQU   16                                                               
FLD017   EQU   17                                                               
FLD018   EQU   18                                                               
FLD019   EQU   19                                                               
FLD020   EQU   20                                                               
FLD021   EQU   21                                                               
FLD022   EQU   22                                                               
FLD023   EQU   23                                                               
FLD024   EQU   24                                                               
FLD025   EQU   25                                                               
FLD026   EQU   26                                                               
FLD027   EQU   27                                                               
FLD028   EQU   28                                                               
FLD029   EQU   29                                                               
FLD030   EQU   30                                                               
FLD031   EQU   31                                                               
FLD032   EQU   32                                                               
FLD033   EQU   33                                                               
FLD034   EQU   34                                                               
FLD035   EQU   35                                                               
FLD036   EQU   36                                                               
FLD037   EQU   37                                                               
FLD038   EQU   38                                                               
FLD039   EQU   39                                                               
FLD040   EQU   40                                                               
FLD041   EQU   41                                                               
FLD042   EQU   42                                                               
FLD043   EQU   43                                                               
FLD044   EQU   44                                                               
FLD045   EQU   45                                                               
FLD046   EQU   46                                                               
FLD047   EQU   47                                                               
FLD048   EQU   48                                                               
FLD049   EQU   49                                                               
FLD050   EQU   50                                                               
FLD051   EQU   51                                                               
FLD052   EQU   52                                                               
FLD053   EQU   53                                                               
FLD054   EQU   54                                                               
FLD055   EQU   55                                                               
FLD056   EQU   56                                                               
FLD057   EQU   57                                                               
FLD058   EQU   58                                                               
FLD059   EQU   59                                                               
FLD060   EQU   60                                                               
FLD061   EQU   61                                                               
FLD062   EQU   62                                                               
FLD063   EQU   63                                                               
FLD064   EQU   64                                                               
FLD065   EQU   65                                                               
FLD066   EQU   66                                                               
FLD067   EQU   67                                                               
FLD068   EQU   68                                                               
FLD069   EQU   69                                                               
FLD070   EQU   70                                                               
FLD071   EQU   71                                                               
FLD072   EQU   72                                                               
FLD073   EQU   73                                                               
FLD074   EQU   74                                                               
FLD075   EQU   75                                                               
FLD076   EQU   76                                                               
FLD077   EQU   77                                                               
FLD078   EQU   78                                                               
FLD079   EQU   79                                                               
FLD080   EQU   80                                                               
FLD081   EQU   81                                                               
FLD082   EQU   82                                                               
FLD083   EQU   83                                                               
FLD084   EQU   84                                                               
FLD085   EQU   85                                                               
FLD086   EQU   86                                                               
FLD087   EQU   87                                                               
FLD088   EQU   88                                                               
FLD089   EQU   89                                                               
FLD090   EQU   90                                                               
FLD091   EQU   91                                                               
FLD092   EQU   92                                                               
FLD093   EQU   93                                                               
FLD094   EQU   94                                                               
FLD095   EQU   95                                                               
FLD096   EQU   96                                                               
FLD097   EQU   97                                                               
FLD098   EQU   98                                                               
FLD099   EQU   99                                                               
FLD100   EQU   100                                                              
FLD101   EQU   101                                                              
FLD102   EQU   102                                                              
FLD103   EQU   103                                                              
FLD104   EQU   104                                                              
FLD105   EQU   105                                                              
FLD106   EQU   106                                                              
FLD107   EQU   107                                                              
FLD108   EQU   108                                                              
FLD109   EQU   109                                                              
FLD110   EQU   110                                                              
FLD111   EQU   111                                                              
FLD112   EQU   112                                                              
FLD113   EQU   113                                                              
FLD114   EQU   114                                                              
FLD115   EQU   115                                                              
FLD116   EQU   116                                                              
FLD117   EQU   117                                                              
FLD118   EQU   118                                                              
FLD119   EQU   119                                                              
FLD120   EQU   120                                                              
FLD121   EQU   121                                                              
FLD122   EQU   122                                                              
FLD123   EQU   123                                                              
FLD124   EQU   124                                                              
FLD125   EQU   125                                                              
FLD126   EQU   126                                                              
FLD127   EQU   127                                                              
FLD128   EQU   128                                                              
FLD129   EQU   129                                                              
FLD130   EQU   130                                                              
FLD131   EQU   131                                                              
FLD132   EQU   132                                                              
FLD133   EQU   133                                                              
FLD134   EQU   134                                                              
FLD135   EQU   135                                                              
FLD136   EQU   136                                                              
FLD137   EQU   137                                                              
FLD138   EQU   138                                                              
FLD139   EQU   139                                                              
FLD140   EQU   140                                                              
FLD141   EQU   141                                                              
FLD142   EQU   142                                                              
FLD143   EQU   143                                                              
FLD144   EQU   144                                                              
FLD145   EQU   145                                                              
FLD146   EQU   146                                                              
FLD147   EQU   147                                                              
FLD148   EQU   148                                                              
FLD149   EQU   149                                                              
FLD150   EQU   150                                                              
FLD151   EQU   151                                                              
FLD152   EQU   152                                                              
FLD153   EQU   153                                                              
FLD154   EQU   154                                                              
FLD155   EQU   155                                                              
FLD156   EQU   156                                                              
FLD157   EQU   157                                                              
FLD158   EQU   158                                                              
FLD159   EQU   159                                                              
FLD160   EQU   160                                                              
FLD161   EQU   161                                                              
FLD162   EQU   162                                                              
FLD163   EQU   163                                                              
FLD164   EQU   164                                                              
FLD165   EQU   165                                                              
FLD166   EQU   166                                                              
FLD167   EQU   167                                                              
FLD168   EQU   168                                                              
FLD169   EQU   169                                                              
FLD170   EQU   170                                                              
FLD171   EQU   171                                                              
FLD172   EQU   172                                                              
FLD173   EQU   173                                                              
FLD174   EQU   174                                                              
FLD175   EQU   175                                                              
FLD176   EQU   176                                                              
FLD177   EQU   177                                                              
FLD178   EQU   178                                                              
FLD179   EQU   179                                                              
FLD180   EQU   180                                                              
FLD181   EQU   181                                                              
FLD182   EQU   182                                                              
FLD183   EQU   183                                                              
FLD184   EQU   184                                                              
FLD185   EQU   185                                                              
FLD186   EQU   186                                                              
FLD187   EQU   187                                                              
FLD188   EQU   188                                                              
FLD189   EQU   189                                                              
FLD190   EQU   190                                                              
FLD191   EQU   191                                                              
FLD192   EQU   192                                                              
FLD193   EQU   193                                                              
FLD194   EQU   194                                                              
FLD195   EQU   195                                                              
FLD196   EQU   196                                                              
FLD197   EQU   197                                                              
FLD198   EQU   198                                                              
FLD199   EQU   199                                                              
FLD200   EQU   200                                                              
FLD201   EQU   201                                                              
FLD202   EQU   202                                                              
FLD203   EQU   203                                                              
FLD204   EQU   204                                                              
FLD205   EQU   205                                                              
FLD206   EQU   206                                                              
FLD207   EQU   207                                                              
FLD208   EQU   208                                                              
FLD209   EQU   209                                                              
FLD210   EQU   210                                                              
FLD211   EQU   211                                                              
FLD212   EQU   212                                                              
FLD213   EQU   213                                                              
FLD214   EQU   214                                                              
FLD215   EQU   215                                                              
FLD216   EQU   216                                                              
FLD217   EQU   217                                                              
FLD218   EQU   218                                                              
FLD219   EQU   219                                                              
FLD220   EQU   220                                                              
FLD221   EQU   221                                                              
FLD222   EQU   222                                                              
FLD223   EQU   223                                                              
FLD224   EQU   224                                                              
FLD225   EQU   225                                                              
FLD226   EQU   226                                                              
FLD227   EQU   227                                                              
FLD228   EQU   228                                                              
FLD229   EQU   229                                                              
FLD230   EQU   230                                                              
FLD231   EQU   231                                                              
FLD232   EQU   232                                                              
FLD233   EQU   233                                                              
FLD234   EQU   234                                                              
FLD235   EQU   235                                                              
FLD236   EQU   236                                                              
FLD237   EQU   237                                                              
FLD238   EQU   238                                                              
FLD239   EQU   239                                                              
FLD240   EQU   240                                                              
FLD241   EQU   241                                                              
FLD242   EQU   242                                                              
FLD243   EQU   243                                                              
FLD244   EQU   244                                                              
FLD245   EQU   245                                                              
FLD246   EQU   246                                                              
FLD247   EQU   247                                                              
FLD248   EQU   248                                                              
FLD249   EQU   249                                                              
FLD250   EQU   250                                                              
FLD251   EQU   251                                                              
FLD252   EQU   252                                                              
FLD253   EQU   253                                                              
FLD254   EQU   254                                                              
FLD255   EQU   255                                                              
FLD256   EQU   256                                                              
FLD257   EQU   257                                                              
FLD258   EQU   258                                                              
FLD259   EQU   259                                                              
FLD260   EQU   260                                                              
FLD261   EQU   261                                                              
FLD262   EQU   262                                                              
FLD263   EQU   263                                                              
FLD264   EQU   264                                                              
FLD265   EQU   265                                                              
FLD266   EQU   266                                                              
FLD267   EQU   267                                                              
FLD268   EQU   268                                                              
FLD269   EQU   269                                                              
FLD270   EQU   270                                                              
FLD271   EQU   271                                                              
FLD272   EQU   272                                                              
FLD273   EQU   273                                                              
FLD274   EQU   274                                                              
FLD275   EQU   275                                                              
FLD276   EQU   276                                                              
FLD277   EQU   277                                                              
FLD278   EQU   278                                                              
FLD279   EQU   279                                                              
FLD280   EQU   280                                                              
FLD281   EQU   281                                                              
FLD282   EQU   282                                                              
FLD283   EQU   283                                                              
FLD284   EQU   284                                                              
FLD285   EQU   285                                                              
FLD286   EQU   286                                                              
FLD287   EQU   287                                                              
FLD288   EQU   288                                                              
FLD289   EQU   289                                                              
FLD290   EQU   290                                                              
FLD291   EQU   291                                                              
FLD292   EQU   292                                                              
FLD293   EQU   293                                                              
FLD294   EQU   294                                                              
FLD295   EQU   295                                                              
FLD296   EQU   296                                                              
FLD297   EQU   297                                                              
FLD298   EQU   298                                                              
FLD299   EQU   299                                                              
FLD300   EQU   300                                                              
FLD301   EQU   301                                                              
FLD302   EQU   302                                                              
FLD303   EQU   303                                                              
FLD304   EQU   304                                                              
FLD305   EQU   305                                                              
FLD306   EQU   306                                                              
FLD307   EQU   307                                                              
FLD308   EQU   308                                                              
FLD309   EQU   309                                                              
FLD310   EQU   310                                                              
FLD311   EQU   311                                                              
FLD312   EQU   312                                                              
FLD313   EQU   313                                                              
FLD314   EQU   314                                                              
FLD315   EQU   315                                                              
FLD316   EQU   316                                                              
FLD317   EQU   317                                                              
FLD318   EQU   318                                                              
FLD319   EQU   319                                                              
FLD320   EQU   320                                                              
FLD321   EQU   321                                                              
FLD322   EQU   322                                                              
FLD323   EQU   323                                                              
FLD324   EQU   324                                                              
FLD325   EQU   325                                                              
FLD326   EQU   326                                                              
FLD327   EQU   327                                                              
FLD328   EQU   328                                                              
FLD329   EQU   329                                                              
FLD330   EQU   330                                                              
FLD331   EQU   331                                                              
FLD332   EQU   332                                                              
FLD333   EQU   333                                                              
FLD334   EQU   334                                                              
FLD335   EQU   335                                                              
FLD336   EQU   336                                                              
FLD337   EQU   337                                                              
FLD338   EQU   338                                                              
FLD339   EQU   339                                                              
FLD340   EQU   340                                                              
FLD341   EQU   341                                                              
FLD342   EQU   342                                                              
FLD343   EQU   343                                                              
FLD344   EQU   344                                                              
FLD345   EQU   345                                                              
FLD346   EQU   346                                                              
FLD347   EQU   347                                                              
FLD348   EQU   348                                                              
FLD349   EQU   349                                                              
FLD350   EQU   350                                                              
FLD351   EQU   351                                                              
FLD352   EQU   352                                                              
FLD353   EQU   353                                                              
FLD354   EQU   354                                                              
FLD355   EQU   355                                                              
FLD356   EQU   356                                                              
FLD357   EQU   357                                                              
FLD358   EQU   358                                                              
         SPACE 1                                                                
*                                  Translate table for Equivalents              
*                 0 1 2 3 4 5 6 7 8 9 A B C D E F                               
OTRTAB   DC    X'FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF' 00                           
         DC    X'FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF' 10                           
         DC    X'FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF' 20 L                         
         DC    X'FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF' 30 H                         
         DC    X'FFFFFFFFFFFFFFFFFFFFFF00FFFFFFFF' 40 S                         
         DC    X'FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF' 50                           
         DC    X'00FFFFFFFFFFFFFFFFFFFFFFFFFFFFFF' 60 H                         
         DC    X'FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF' 70 A                         
         DC    X'FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF' 80 L                         
         DC    X'FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF' 90 F                         
         DC    X'FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF' A0                           
         DC    X'FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF' B0 B                         
         DC    X'FF000000000000000000FFFFFFFFFFFF' C0 Y                         
         DC    X'FF000000000000000000FFFFFFFFFFFF' D0 T                         
         DC    X'FFFF0000000000000000FFFFFFFFFFFF' E0 E                         
         DC    X'00000000000000000000FFFFFFFFFFFF' F0                           
*                                                                               
RECTAB   DS    0XL(RECTABL)        ** RECORD TABLE **                           
         DC    AL2(A#ACTU),AL1(RECTACUP)                                        
RECTABN  EQU   (*-RECTAB)/L'RECTAB                                              
                                                                                
APLTAB   DS    0XL(APLTABL)        ** APPLICATION TABLE **                      
*&&UK*&& DC    AL2(XPMEDHUB),AL1(STCAMHUB)                                      
         DC    AL2(XPACCUPQ),AL1(STCAACUP)                                      
         DC    AL2(XPRODIKQ),AL1(STCAAURA)                                      
         DC    AL2(XPMOBILQ),AL1(STCAMOBL)                                      
         DC    AL2(0),AL1(STCAAPI)                                              
APLTABN  EQU   (*-APLTAB)/L'APLTAB                                              
                                                                                
FILTTAB  DS    0X                                                               
         DC    AL1(1,RSTFILT1-RSTELD,ACTRSAF1-ACTRECD)                          
         DC    AL1(2,RSTFILT2-RSTELD,ACTRSAF2-ACTRECD)                          
         DC    AL1(3,RSTFILT3-RSTELD,ACTRSAF3-ACTRECD)                          
         DC    AL1(4,RSTFILT4-RSTELD,ACTRSAF4-ACTRECD)                          
         DC    AL1(5,RSTFILT5-RSTELD,ACTRSAF5-ACTRECD)                          
FILTTABX DC    X'FF'                                                            
                                                                                
CSTTYTAB DS    0X                                                               
         DC    CL1'1',AL1(RSTSCSTC)                                             
         DC    CL1'2',AL1(RSTSCSTH)                                             
         DC    CL1'3',AL1(RSTSCSTN)                                             
CSTTYTBX DC    X'FF'                                                            
                                                                                
RECVTAB  DS    0F                                                               
         DC    AL1(AC_INEW3+AC_ILVL3,QA_LVL3,0,0)                               
         DC    AL2(DRCSCUR-UPDACT)                                              
         DC    AL1(AC_INEW3+AC_ILVL3,QA_LVL2,0,0)                               
         DC    AL2(DRCSPRO-UPDACT)                                              
         DC    AL1(AC_INEW3+AC_ILVL3,QA_LVL1,0,0)                               
         DC    AL2(DRCSCLI-UPDACT)                                              
         DC    AL1(AC_INEW2+AC_ILVL2,QA_LVL2,0,0)                               
         DC    AL2(DRCSCUR-UPDACT)                                              
         DC    AL1(AC_INEW2+AC_ILVL2,QA_LVL1,0,0)                               
         DC    AL2(DRCSCLI-UPDACT)                                              
         DC    AL1(AC_INEW1+AC_ILVL1,QA_LVL1,0,0)                               
         DC    AL2(DRCSCUR-UPDACT)                                              
RECVTABX DC    X'FF'                                                            
                                                                                
FFTTAB   DS    0F                                                               
         DC    AL1(FFTTDEB,FFTTVATC,STCAVATC,0)                                 
         DC    AL2(QA_VATCL-SAVED)                                              
*                                                                               
*&&UK*&& DC    AL1(FFTTDEB,FFTTG13B,STCA13VT,0)                                 
*&&UK*&& DC    AL2(QA_13VTL-SAVED)                                              
*                                                                               
         DC    AL1(FFTTDEB,FFTTAXNO,STCATAX,0)                                  
         DC    AL2(QA_TAXL-SAVED)                                               
*                                                                               
*&&UK*&& DC    AL1(FFTTDEB,FFTTPEML,STCAPEML,0)                                 
*&&US*&& DC    AL1(0,FFTTEML,STCAPEML,0)                                        
         DC    AL2(QA_EMALL-SAVED)                                              
*                                                                               
         DC    AL1(0,FFTTPCOM,STCAEXCM,0)                                       
         DC    AL2(QA_DSKCL-SAVED)                                              
*                                                                               
         DC    AL1(0,FFTTPTEL,STCAPTEL,0)                                       
         DC    AL2(QA_TELEL-SAVED)                                              
*                                                                               
         DC    AL1(0,FFTTPCON,STCAPCON,0)                                       
         DC    AL2(QA_MNCNL-SAVED)                                              
*                                                                               
         DC    AL1(0,FFTTPFAX,STCAPFAX,0)                                       
         DC    AL2(QA_FAXL-SAVED)                                               
*                                                                               
         DC    AL1(0,FFTTREFN,STCAREFN,0)                                       
         DC    AL2(QA_REFNL-SAVED)                                              
*                                                                               
         DC    AL1(0,FFTTAUTH,STCAAUTH,0)                                       
         DC    AL2(QA_BAUTL-SAVED)                                              
*                                                                               
         DC    AL1(0,FFTTBENT,STCAENTY,0)                                       
         DC    AL2(QA_ENTYL-SAVED)                                              
*                                                                               
         DC    AL1(0,FFTTBSRN,STCABSRL,0)                                       
         DC    AL2(QA_BSRLL-SAVED)                                              
*                                                                               
         DC    AL1(0,FFTTCRCN,STCACRCD,0)                                       
         DC    AL2(QA_CRCRL-SAVED)                                              
*                                                                               
*&&UK*&& DC    AL1(FFTTDEB,FFTTAXLO,STCAVTRG,0)                                 
*&&UK*&& DC    AL2(QA_VTRGL-SAVED)                                              
*                                                                               
*&&UK*&& DC    AL1(FFTTDEB,FFTTTXRN,STCATAX,0)                                  
*&&UK*&& DC    AL2(QA_VATL-SAVED)                                               
FFTTABX  DC    X'FF'                                                            
*                                                                               
LDGLVB   DS    0F                                                               
         DC    AL2(QA_DANAL-SAVED,FLD022)                                       
         DC    AL1(LDGSEUL,0)                                                   
*                                                                               
         DC    AL2(QA_CANAL-SAVED,FLD024)                                       
         DC    AL1(LDGSEUL+LDGSIUL,0)                                           
*                                                                               
         DC    AL2(QA_SANAL-SAVED,FLD025)                                       
         DC    AL1(LDGSEUL,0)                                                   
*                                                                               
         DC    AL2(QA_JANAL-SAVED,FLD030)                                       
         DC    AL1(LDGSEUL+LDGSIUL,0)                                           
*                                                                               
         DC    AL2(QA_PANAL-SAVED,FLD156)                                       
         DC    AL1(LDGSEUL+LDGSIUL,0)                                           
*                                                                               
         DC    AL2(QA_KSVTY-SAVED,FLD059)                                       
         DC    AL1(LDGSVUL+LDGSXUL+LDGSQUL,0)                                   
*                                                                               
         DC    AL2(QA_13VTL-SAVED,FLD060)                                       
         DC    AL1(LDGSEUL+LDGSIUL+LDGSQUL+LDGSVUL+LDGSXUL,0)                   
*                                                                               
         DC    AL2(QA_EMALL-SAVED,FLD063)                                       
         DC    AL1(LDGSJUL+LDGSVUL+LDGSXUL,0)                                   
*                                                                               
         DC    AL2(QA_VATL-SAVED,FLD054)                                        
         DC    AL1(LDGSJUL+LDGSRUL,0)                                           
*                                                                               
LDGLVBX  DC    X'FF'                                                            
*                                                                               
RSTTAB   DS    0F                                                               
         DC    AL1(RSTSACIL,STCALOCK)                                           
         DC    AL2(RSTSTAT1-RSTELD)                                             
         DC    AL1(RSTSACIC,STCACLOS)                                           
         DC    AL2(RSTSTAT1-RSTELD)                                             
         DC    AL1(RSTSGPEI,STCASTAF)                                           
         DC    AL2(RSTSTAT1-RSTELD)                                             
         DC    AL1(RSTSEADD,STCADEPT)                                           
         DC    AL2(RSTSTAT1-RSTELD)                                             
         DC    AL1(RSTSPIAE,STCAPERX)                                           
         DC    AL2(RSTSTAT1-RSTELD)                                             
         DC    AL1(RSTSIVAT,STCAINVT)                                           
         DC    AL2(RSTSTAT1-RSTELD)                                             
         DC    AL1(RSTSPLOK,STCAPAYL)                                           
         DC    AL2(RSTSTAT2-RSTELD)                                             
         DC    AL1(RSTSMILE,STCAMILE)                                           
         DC    AL2(RSTSTAT2-RSTELD)                                             
         DC    AL1(RSTSPRCR,STCAPCRS)                                           
         DC    AL2(RSTSTAT3-RSTELD)                                             
         DC    AL1(RSTSPRDR,STCAPDRS)                                           
         DC    AL2(RSTSTAT3-RSTELD)                                             
         DC    AL1(RSTSPRTS,STCAPRJC)                                           
         DC    AL2(RSTSTAT3-RSTELD)                                             
         DC    AL1(RSTSLABS,STCABAL)                                            
         DC    AL2(RSTSTAT3-RSTELD)                                             
         DC    AL1(RSTSLAPL,STCAPNL)                                            
         DC    AL2(RSTSTAT3-RSTELD)                                             
         DC    AL1(RSTSCSTH,STCACLIH)                                           
         DC    AL2(RSTSTAT4-RSTELD)                                             
         DC    AL1(RSTSCSTN,STCACLIN)                                           
         DC    AL2(RSTSTAT4-RSTELD)                                             
         DC    AL1(RSTSCSTC,STCACLIC)                                           
         DC    AL2(RSTSTAT4-RSTELD)                                             
         DC    AL1(RSTSJREA,STCAJOBA)                                           
         DC    AL2(RSTSTAT4-RSTELD)                                             
         DC    AL1(RSTSMSDR,STCAMRGI)                                           
         DC    AL2(RSTSTAT4-RSTELD)                                             
         DC    AL1(RSTSPROD,STCAFPRO)                                           
         DC    AL2(RSTSTAT5-RSTELD)                                             
         DC    AL1(RSTSPRJB,STCAFJOB)                                           
         DC    AL2(RSTSTAT5-RSTELD)                                             
         DC    AL1(RSTSNOTS,STCAEXCL)                                           
         DC    AL2(RSTSTAT5-RSTELD)                                             
*&&UK*&& DC    AL1(RSTSSUND,STCASUND)                                           
*&&UK*&& DC    AL2(RSTSTAT5-RSTELD)                                             
         DC    AL1(RSTSPROV,STCAPROV)                                           
         DC    AL2(RSTSTAT5-RSTELD)                                             
         DC    AL1(RSTSNINV,STCAINVR)                                           
         DC    AL2(RSTSTAT6-RSTELD)                                             
         DC    AL1(RSTSDTOP,STCADSKP)                                           
         DC    AL2(RSTSTAT6-RSTELD)                                             
*&&US                                                                           
         DC    AL1(RSTGAPYN,STCAGAPY)                                           
         DC    AL2(RSTSTAT7-RSTELD)                                             
         DC    AL1(RSTGAPAQ,STCAGAPQ)                                           
         DC    AL2(RSTSTAT7-RSTELD)                                             
*&&                                                                             
*&&UK                                                                           
         DC    AL1(RSTGAPQY,STCAGAPY)                                           
         DC    AL2(RSTSTAT7-RSTELD)                                             
         DC    AL1(RSTGAPQN,STCAGAPY)                                           
         DC    AL2(RSTSTAT7-RSTELD)                                             
         DC    AL1(RSTGAPAY,STCAGAPQ)                                           
         DC    AL2(RSTSTAT7-RSTELD)                                             
         DC    AL1(RSTGAPAN,STCAGAPQ)                                           
         DC    AL2(RSTSTAT7-RSTELD)                                             
*&&                                                                             
         DC    AL1(RSTSFUTM,STCAFUTM)                                           
         DC    AL2(RSTSTAT7-RSTELD)                                             
         DC    AL1(RSTSTHRP,STCATHRP)                                           
         DC    AL2(RSTSTAT7-RSTELD)                                             
         DC    AL1(RSTLSORQ,STCAJLOR)                                           
         DC    AL2(RSTLSTAT-RSTELD)                                             
         DC    AL1(RSTLSBIQ,STCAJLBL)                                           
         DC    AL2(RSTLSTAT-RSTELD)                                             
         DC    AL1(RSTLSTIQ,STCAJLTM)                                           
         DC    AL2(RSTLSTAT-RSTELD)                                             
         DC    AL1(RSTLSADQ,STCAJLAD)                                           
         DC    AL2(RSTLSTAT-RSTELD)                                             
         DC    AL1(RSTLSEXQ,STCAJLEX)                                           
         DC    AL2(RSTLSTAT-RSTELD)                                             
         DC    AL1(RSTLSESQ,STCAJLES)                                           
         DC    AL2(RSTLSTAT-RSTELD)                                             
RSTTABX  DC    X'FF'                                                            
*                                                                               
ASTTAB   DS    0F                                                               
         DC    AL1(ASTSLOCL,STCALOCL)                                           
         DC    AL2(ASTSTAT1-ASTELD)                                             
         DC    AL2(ASTISFOR,STCAFUSR)                                           
         DC    AL2(ASTSTAT1-ASTELD)                                             
ASTTABX  DC    X'FF'                                                            
*                                                                               
JOBTAB   DS    0F                                                               
         DC    AL1(JOBSMST,STCAMAST)                                            
         DC    AL2(JOBSTA2-JOBELD)                                              
         DC    AL1(JOBSMCSE,STCABOES)                                           
         DC    AL2(JOBSTA1-JOBELD)                                              
         DC    AL1(JOBSXJOB,STCAXJOB)                                           
         DC    AL2(JOBSTA1-JOBELD)                                              
JOBTABX  DC    X'FF'                                                            
*                                                                               
SPATAB   DS    0F                                                               
         DC    AL1(SPASNAM+SPASUL,SPATBCHA,STCABCHG,102,0,0)                    
         DC    AL2(QA_BCHAC-SAVED)                                              
         DC    AL2(QA_BCHNL-SAVED)                                              
*                                                                               
         DC    AL1(SPASNAM+SPASUL,SPATEXDF,STCAEXDF,104,0,0)                    
         DC    AL2(QA_EXDAC-SAVED)                                              
         DC    AL2(QA_EXDNL-SAVED)                                              
*                                                                               
         DC    AL1(SPASNAM+SPASUL,SPATABNK,STCAANA,106,0,0)                     
         DC    AL2(QA_ANAAC-SAVED)                                              
         DC    AL2(QA_ANANL-SAVED)                                              
*                                                                               
         DC    AL1(SPASNAM+SPASUL,SPATCSHD,STCADISC,108,0,0)                    
         DC    AL2(QA_DISAC-SAVED)                                              
         DC    AL2(QA_DISNL-SAVED)                                              
*                                                                               
         DC    AL1(SPASCPJ+SPASUL,SPATMJOB,STCAMSTR,110)                        
         DC    C'SJ'                                                            
         DC    AL2(QA_MCLI-SAVED)                                               
         DC    AL2(0)                                                           
*                                                                               
         DC    AL1(SPASNAM+SPASUL,SPATFACC,STCAFACC,113,0,0)                    
         DC    AL2(QA_FACTR-SAVED)                                              
         DC    AL2(QA_FACNM-SAVED)                                              
*                                                                               
         DC    AL1(SPASNAM,SPATPERS,STCA2PAC,115)                               
         DC    C'2P'                                                            
         DC    AL2(QA_2PACC-SAVED)                                              
         DC    AL2(QA_2PNML-SAVED)                                              
*                                                                               
         DC    AL1(SPASNAM,SPATDEPT,STCA2DAC,117)                               
         DC    C'2D'                                                            
         DC    AL2(QA_2DACC-SAVED)                                              
         DC    AL2(QA_2DNML-SAVED)                                              
*                                                                               
         DC    AL1(SPASNAM+SPASUL,SPATINCO,STCAOINC,119,0,0)                    
         DC    AL2(QA_INAC-SAVED)                                               
         DC    AL2(QA_INNML-SAVED)                                              
*                                                                               
         DC    AL1(SPASNAM+SPASUL,SPATWOFF,STCAOWRT,121,0,0)                    
         DC    AL2(QA_WRAC-SAVED)                                               
         DC    AL2(QA_WRNML-SAVED)                                              
*                                                                               
*&&UK                                                                           
         DC    AL1(0,SPATSGEU,STCAEUSG,140)                                     
         DC    C'SG'                                                            
         DC    AL2(QA_EUSG-SAVED)                                               
         DC    AL2(0)                                                           
*                                                                               
         DC    AL1(0,SPATSGNE,STCANESG,141)                                     
         DC    C'SG'                                                            
         DC    AL2(QA_NESG-SAVED)                                               
         DC    AL2(0)                                                           
*                                                                               
         DC    AL1(0,SPATMAAC,STCAMAAC,142)                                     
         DC    C'SG'                                                            
         DC    AL2(QA_MAAC-SAVED)                                               
         DC    AL2(0)                                                           
*&&                                                                             
SPATABX  DC    X'FF'                                                            
                                                                                
SCITAB   DS    0F                                                               
         DC    AL1(X'80',SCITICLM,STCAICRL,0)                                   
         DC    AL2(QA_CRINT-SAVED)                                              
         DC    AL1(X'80',SCITCLIM,STCACRLM,0)                                   
         DC    AL2(QA_CREXT-SAVED)                                              
         DC    AL1(0,SCITFEEB,STCAJFEE,0)                                       
         DC    AL2(QA_FEE-SAVED)                                                
SCITABX  DC    X'FF'                                                            
                                                                                
SRCHTBL2 DS    0XL1                                                             
         DC    B'00000000'         Company level                                
         DC    B'00010000'         Media group                                  
         DC    B'00100000'         Media                                        
         DC    B'00000100'         Office group                                 
         DC    B'00010100'         Office group/media group                     
         DC    B'00100100'         Office group/media                           
         DC    B'00001000'         Office                                       
         DC    B'00011000'         Media group/office                           
         DC    B'00101000'         Media/office                                 
         DC    B'10000000'         Client                                       
         DC    B'10010000'         Client/media group                           
         DC    B'10100000'         Client/media                                 
         DC    B'11000000'         Client/product                               
         DC    B'11010000'         Client/product/media group                   
         DC    B'11100000'         Client/product/media group                   
         DC    B'11000010'         Client/product/job                           
         DC    X'FF'                                                            
                                                                                
APRTAB   DS    0XL1                                                             
         DC    B'11011000'         Office/client/product/media                  
         DC    B'10011000'         Office/client/media                          
         DC    B'10010000'         Client/media                                 
         DC    B'00011000'         Office/media                                 
         DC    B'00010000'         Media                                        
         DC    B'11001000'         Office/client/product                        
         DC    B'10001000'         Office/client                                
         DC    B'10000000'         Client                                       
         DC    B'00001000'         Office                                       
         DC    B'00000000'         Agency                                       
         DC    X'FF'                                                            
*                                  Equivalent type table                        
EQTYTAB  DS    0XL2                                                             
         DC    AL1(QI_EQTY0),AL1(0)                                             
         DC    AL1(QI_EQTY1),AL1(1)                                             
         DC    AL1(QI_EQTY2),AL1(2)                                             
         DC    AL1(QI_EQTY3),AL1(3)                                             
         DC    AL1(QI_EQTY4),AL1(4)                                             
EQTYTABN EQU   (*-EQTYTAB)/L'EQTYTAB                                            
*                                                                               
SUBETAB  DS    0XL2                                                             
         DC    AL1(TXTELQ)                                                      
SUBETABL EQU   *-SUBETAB                                                        
SUBETABX DC    X'FF'                                                            
*                                  Media txtel straight copy                    
TXTCOPY  DS    0H                                                               
*&&UK*&& DC    AL1(FFTTAXLO),AL1(TXTAXLOQ),AL2(0)            Tax loc            
         DC    AL1(FFTTAXNO),AL1(TXTVATQ),AL2(0)             Tax number         
TXTCOPYX DC    X'FF'                                                            
*                                  Media txtel copy or add                      
TXTTAB   DS    0H                                                               
         DC    AL1(FFTTPCON,TXTCNTCQ),AL2(QI_MCONL-QI_MFLDD) Contact            
         DC    AL1(FFTTPTEL,TXTPHONQ),AL2(QI_MTELL-QI_MFLDD) Phone              
         DC    AL1(FFTTPFAX,TXTTFAXQ),AL2(QI_MFAXL-QI_MFLDD) Fax                
         DC    AL1(FFTTAXNO,TXTVATQ),AL2(QI_MTAXL-QI_MFLDD)  Tax no.            
TXTTABX  DC    X'FF'                                                            
         PRINT OFF                                                              
       ++INCLUDE ACIBANTAB                                                      
         PRINT ON                                                               
                                                                                
         PRINT OFF                                                              
       ++INCLUDE ACISOCTRY                                                      
         PRINT ON                                                               
                                                                                
         PRINT OFF                                                              
       ++INCLUDE ACVATICAND                                                     
         PRINT ON                                                               
                                                                                
         PRINT OFF                                                              
       ++INCLUDE ACEQUTABD                                                      
EQRTMAXN EQU   5                   Max # of acc equivalencly rules              
EQRTLEN  EQU   (EQRTMAXN*EQRLLNQ)+1                                             
         PRINT ON                                                               
                                                                                
* ACISOCTRYD                                                                    
         PRINT OFF                                                              
       ++INCLUDE ACISOCTRYD                                                     
         PRINT ON                                                               
* MEDIA RECORDS                                                                 
*PREFIX=M_                                                                      
         PRINT OFF                                                              
       ++INCLUDE MEFILAGY                                                       
       ++INCLUDE MEFILMED                                                       
       ++INCLUDE MEFILCLI                                                       
       ++INCLUDE MEFILCLXEL                                                     
       ++INCLUDE MEFILPRO                                                       
       ++INCLUDE MEFILCAM                                                       
       ++INCLUDE MEFILFOREL                                                     
       ++INCLUDE MEFILADDEL                                                     
       ++INCLUDE MEFILULAEL                                                     
       ++INCLUDE MEFILCAGEL                                                     
       ++INCLUDE MEFILBAGEL                                                     
       ++INCLUDE MEFILFLTEL                                                     
       ++INCLUDE MEFILFMLEL                                                     
       ++INCLUDE MEFILDDREL                                                     
*&&UK                                                                           
       ++INCLUDE MEFILACDEL                                                     
*&&                                                                             
       ++INCLUDE MEFILFRMD                                                      
       ++INCLUDE MEFILFLTD                                                      
       ++INCLUDE MEFILFNMEL                                                     
*PREFIX=                                                                        
         PRINT ON                                                               
       ++INCLUDE MEFILTXTEL                                                     
                                                                                
T_D      DSECT                                                                  
T_KEY    DS    0X                                                               
T_RECLEN DS    CL2                 TSAR REC LEN                                 
T_ACCMED DS    CL1                 ACC/MED REC INDICATOR                        
T_ACCQ   EQU   C'A'                                                             
T_MEDQ   EQU   C'M'                                                             
T_KAM    DS    XL(L'M_CLIKAM)      MEDIA KEY - MEDIA CODE IN HEX                
T_CLI    DS    CL(L'M_CLIKCLI)                 - CLI                            
T_PRO    DS    CL(L'M_PROKPRO)                 - PRO                            
T_FLTS   DS    CL9                 9 FILTER VALUES                              
T_FLTI   DS    XL9                 FILTER INDICATORS                            
         ORG   T_KAM                                                            
T_ULA    DS    0CL(L'ACTKULA)      ACC KEY - U/L/A                              
T_UNT    DS    CL(L'ACTKUNT)               -                                    
T_LDG    DS    CL(L'ACTKLDG)               -                                    
T_ACCT   DS    CL(L'ACTKACT)               -                                    
         ORG                                                                    
T_ACTION DS    CL1                 ADD/CHANGE/UNDELETE                          
T_KEYL   EQU   *-T_KEY                                                          
T_DATA   DS    0X                                                               
T_INDS   DS    XL1                                                              
T_IUPDAT EQU   X'80'               T_DATA REQUIRES UPDATE                       
T_ILOWAC EQU   X'40'               ACCOUNT IS LOW LEVEL                         
T_CPSTAT DS    CL8                 NEW DATA FOR CLI/PRO STATUS AREA             
T_ELEMS  DS    0X                  START OF ELEMENTS TO BE UPDATED              
T_TERM   DS    XL1                 TERMINATOR BYTE X'00'                        
T_RECLQ  EQU   *-T_D               L' FIXED REC                                 
*                                                                               
RECTABD  DSECT                     ** DSECT TO COVER RECORD TABLE **            
RECTMAP# DS    AL2                 RECORD MAP NUMBER                            
RECTTYPE DS    AL1                 ** RECORD TYPE **                            
RECTACUP EQU   1                   Account upload                               
RECTPHDR EQU   2                   Person header                                
RECTPCLI EQU   3                   Client access                                
RECTPMED EQU   4                   Media access                                 
RECTPEXP EQU   5                   Expenditure types access                     
RECTPNCL EQU   6                   Non-client access                            
RECTPSTF EQU   7                   Staff access                                 
RECTPWC  EQU   8                   Workcode access                              
RECTPREP EQU   9                   Report format access                         
RECTPGRP EQU   10                  Group list access                            
RECTCLAP EQU   11                  Client approver                              
RECTNCAP EQU   12                  Non client approver                          
RECTSTAP EQU   13                  Staff approver                               
RECTIOAP EQU   14                  Invoice and orders approver                  
RECTBUAP EQU   15                  Back up approver                             
RECTROL  EQU   16                  Client team roles                            
RECTPTRL EQU   17                  Person trailer                               
RECTABL  EQU   *-RECTABD                                                        
         EJECT                                                                  
APLTABD  DSECT                     ** DSECT TO COVER APPL TABLE **              
APLTMAP# DS    AL2                 APPLICATION NUMBER                           
APLTSTC  DS    AL1                 STCELD EQUIVALENT                            
APLTABL  EQU   *-APLTABD                                                        
         EJECT                                                                  
SAPTABD  DSECT                     ** SAP CODE TABLE DSECT **                   
SAPTULA  DS    0CL14               UNIT/LEDGER/ACCOUNT DDS                      
SAPTUNT  DS    CL1                 UNIT DDS                                     
SAPTLDG  DS    CL1                 LEDGER DDS                                   
SAPTACT  DS    CL12                ACCOUNT CODE DDS                             
SAPCODE  DS    CL17                ACCOUNT CODE FOR SAP 1-2-1 RELATION          
SAPTABL  EQU   *-SAPTABD                                                        
SAPTABMX EQU   16                  MAXIMUM NUMBER OF ACCOUNTS                   
         EJECT                                                                  
TXTTABD  DSECT                     ** MEDIA TEXT ELEMENT DSECT **               
TXTACCC  DS    XL1                 ACCOUNTING ELEMENT CODE                      
TXTMEDC  DS    XL1                 MEDIA ELEMENT CODE                           
TXTDISP  DS    XL2                 DISPLACEMENT TO REQUEST FIELD                
TXTTABL  EQU   *-TXTTABD                                                        
         SPACE 1                                                                
SAVED    DSECT                                                                  
VACCEMU  DS    A                   Emulator converter                           
SVSTCELS DS    A                   Current address of stc elements              
SVJOBELS DS    A                   Current address of deleted/add jobs          
XANXTER  DS    A                   Address of errors                            
SAVER0   DS    A                   Save R0                                      
SVR1R2   DS    0XL8                Saved r1+r2                                  
SAVER1   DS    A                   Save R1                                      
SAVER2   DS    A                   Save R2                                      
SAVER4   DS    A                   Save R4                                      
SAVER6   DS    A                   Save R6                                      
SAVERF   DS    A                   Save RF                                      
SAVEPY   DS    A                   Save address of year position in job         
ASEQNUM  DS    A                   A(starting sequence number)                  
AELEMENT DS    A                   A(old element)                               
AJOBLVL  DS    A                   A(Job record)                                
APROLVL  DS    A                   A(Prod record)                               
ACLILVL  DS    A                   A(Client record)                             
ASAVCHG  DS    A                   A(Changed client orders)                     
ASAVDEL  DS    A                   A(Deleted client orders)                     
ASAVADD  DS    A                   A(Added client orders)                       
AAPPTN   DS    A                   A(Next APPTAB entry)                         
ANXTERR  DS    A                   A(Next error entry)                          
ALSTERR  DS    A                   A(Previous error entry in errtab)            
MFILADR  DS    XL4                 Saved disk address                           
ACURETB  DS    XL4                 A(Current equivalent type table)             
RUNMODE  DS    XL(L'RUNPMODE)      DDLINK/RUNNER mode                           
UPDATED  DS    CL1                 Account was updated, but no STCELs           
*                                      were added                               
FLDNO1   DS    XL2                 Error field #1                               
FLDNO2   DS    XL2                 Error field #2                               
*                                                                               
DATO     DS    0H                  Dictionary equates                           
AC@BGT   DS    CL6                                                              
AC@LOCAL DS    CL6                                                              
AC@STD   DS    CL8                                                              
*                                                                               
ELEMENT2 DS    XL255               2nd element                                  
ADRELEMT DS    XL255               Address element                              
ELEMENT3 EQU   ADRELEMT                                                         
CLIADDR  EQU   ADRELEMT            Client address                               
STCELEMT DS    XL255               Audit element                                
ELEMENT4 EQU   STCELEMT                                                         
*                                                                               
SSTCAPL  DS    XL1                 Saved application for audit                  
NEWSTAT  DS    XL1                 Status of new/current record                 
PREVSTAT DS    XL1                 Status of previous record                    
AGENCY   DS    XL1                                                              
USRID    DS    XL2                 User ID to be used                           
GLOBID   DS    XL2                 Global ID according to company rec           
PRODPROF DS    XL16                Production profiles                          
FLTXTRA  DS    XL32                Extra area for mefilt routine                
SAVFINDS DS    XL9                 Saved filter indicators                      
SAVFIADD EQU   X'80'               Add this filter                              
SAVFLTS  DS    CL9                 Saved filter values                          
NEWREC   DS    CL1                 New record                                   
START#   DS    CL5                 Job number                                   
NEXT#    DS    CL5                 Job number                                   
WORK5    DS    CL5                 Job number                                   
OPEN     DS    CL6                 Open data in character                       
CLOSED   DS    CL6                 Closed data in character                     
SAVE1ST  DS    CL6                 Save area for 1st Job number                 
FJBIND   DS    XL1                 Find job indicator                           
FJBIREP  EQU   X'80'                                                            
CHKIND   DS    XL1                 Check close indicator                        
CHKDELT  EQU   C'1'                Delete check                                 
CHKEXTY  EQU   C'2'                Expense job check                            
CHKCLOS  EQU   C'3'                Close check                                  
CHKLOCK  EQU   C'4'                LOCK  check                                  
CHKOFFC  EQU   C'5'                Office change check                          
LIACTST  DS    XL1                 Limit access indicator                       
LIACTCAG EQU   X'80'               Creative agency limit access                 
LIACTBAG EQU   X'40'               Buying agency limit access                   
LIACTLA1 EQU   X'20'               Limit access 1                               
LIACTLA2 EQU   X'10'               Limit access 2                               
LIACXCAG EQU   X'80'               Don't test creative agency limit acc         
LIACXBAG EQU   X'40'               Don't test buying agency limit acc           
LIACXLA1 EQU   X'20'               Don't test limit access 1                    
LIACXLA2 EQU   X'10'               Don't test limit access 2                    
OLDSTAT  DS    XL8                 Saved old record status                      
OLDFLTS  DS    XL9                 Saved old filter values                      
LEDGSTA2 DS    XL(L'LDGSTAT2)      Ledger status byte 2                         
SVIOERR  DS    XL(L'IOERR)         Saved IO error                               
AEXIOERR DS    XL(L'IOERR)         Saved IO error for account extension         
TSARABUF DS    XL(TSPXTNL)         TSAR block for record buffer                 
*&&UK                                                                           
SESTLNO  DS    XL(L'ESTKLNO)       Saved local estimate number                  
*&&                                                                             
TRAVWRK  DS    XL(TRAVBFLQ)        Travblk area                                 
*                                                                               
MEDAGYB  DS    XL1                 Agency byte                                  
MEDSCNUM DS    0CL4                Security access num                          
MEDSCCRE DS    CL1                 Creative agy number                          
MEDSCBUY DS    CL1                 Buying agy number                            
MEDSCAC1 DS    CL1                 Limit access 1                               
MEDSCAC2 DS    CL1                 Limit access 2                               
MEDSCNM2 DS    0CL4                Extended security access num                 
MEDSCAC3 DS    CL1                 Limit access 3                               
MEDSCAC4 DS    CL1                 Limit access 4                               
MEDSCAC5 DS    CL1                 Limit access 5                               
MEDSCAC6 DS    CL1                 Limit access 6                               
*                                                                               
AC_TODYP DS    PL3                 Today packed                                 
AC_TODYC DS    XL2                 Today compressed                             
AC_TODYF DS    CL6                 Today                                        
ERRCNT   DS    XL1                 Error counter                                
LINCNT   DS    XL1                 Record counter                               
RECTYPE  DS    AL(L'RECTTYPE)      Record type                                  
*                                                                               
SAVEVAR  DS    0F                  ** Variables **                              
AC_IND1  DS    XL1                 Account indicator 1                          
AC_ILVL1 EQU   X'80'               Account at level 1 found                     
AC_ILVL2 EQU   X'40'               Account at level 2 found                     
AC_ILVL3 EQU   X'20'               Account at level 3 found                     
AC_ILVL4 EQU   X'10'               Account at level 4 found                     
AC_INEW1 EQU   X'08'               New level 1 account                          
AC_INEW2 EQU   X'04'               New level 2 account                          
AC_INEW3 EQU   X'02'               New level 3 account                          
AC_INEW4 EQU   X'01'               New level 4 account                          
AC_IND2  DS    XL1                 Account indicator 2                          
AC_ILOW  EQU   X'80'               Low level account                            
AC_IDRFT EQU   X'40'               Draft account                                
AC_IRMOL EQU   X'20'               Remove old account                           
AC_IAPPR EQU   X'10'               Approved this time                           
AC_IMEDF EQU   X'08'               Processed new media filters                  
AC_IADR5 EQU   X'04'               5th address line scenario                    
ERRFLAG  DS    XL1                 Error flag                                   
SKIPERR  EQU   X'80'               Skip reporting errors                        
AC_OFF   DS    CL(L'TRNOFFC)       Account office                               
AC_PROFF DS    CL(L'TRNOFFC)       Previous level Account office                
AC_FLTS  DS    0CL5                Account filters                              
AC_FLT1  DS    CL1                 Filter 1                                     
AC_FLT2  DS    CL1                 Filter 2                                     
AC_FLT3  DS    CL1                 Filter 3                                     
AC_FLT4  DS    CL1                 Filter 4                                     
AC_FLT5  DS    CL1                 Filter 5                                     
AC_MEDGR DS    CL1                 Media group                                  
AC_MEDIA DS    CL1                 Media                                        
AC_OFFGR DS    CL1                 Office group                                 
AC_ACLVL DS    XL1                 Level of account passed                      
AC_LVL1  EQU   C'1'                                                             
AC_LVL2  EQU   C'2'                                                             
AC_LVL3  EQU   C'3'                                                             
AC_LVL4  EQU   C'4'                                                             
AC_LVL5  EQU   C'5'                                                             
AC_CULA  DS    0CL15               Company unit ledger account                  
AC_CPY   DS    XL1                 Company code                                 
AC_ULA   DS    0CL14               Unit ledger account                          
AC_UNIT  DS    CL1                 Unit                                         
AC_LDG   DS    CL1                 Ledger                                       
AC_ACT   DS    CL12                Account                                      
AC_NAMLL DS    0CL(L'QA_DRNML+L'QA_DRNAM)  Account name work area               
AC_NAMEL DS    XL(L'QA_DRNML)                                                   
AC_NAME  DS    CL(L'QA_DRNAM)                                                   
AC_APPR  DS    XL(L'PIDNO)         Default approver for account                 
AC_BAPPR DS    XL(L'PIDNO)         Back up approver for account                 
AC_USRAP DS    CL1                 Is user an approver for account              
AC_OLACT DS    CL(L'ACTKACT)       Saved old master account                     
AC_AMT   DS    PL6                 Billed amount                                
AC_EFDTE DS    PL3                 Effective date                               
AC_JSTA2 DS    XL1                 Copy of JOBSTA2                              
AC_KSTA  DS    XL(L'ACTKSTA)       Status area                                  
AC_ACSTA DS    XL(L'ACTKSTA)       Status area of other accounts                
AC_INDEX DS    XL2                 index                                        
AC_TIME  DS    XL(L'RAPKTIME)      Time in binary secs                          
AC_DA    DS    XL(L'ACTKDA)        Disk address                                 
AC_ACTL1 DS    CL12                Level 1 account or client                    
AC_ACTL2 DS    CL12                Level 2 account or product                   
AC_ACTL3 DS    CL12                Level 3 account or job                       
AC_LTCPJ DS    CL12                Latest client/product/job                    
AC_CLISR DS    CL14                Client debtor code                           
SVMEDCM  DS    CL62                Media commission expression                  
SVSLTYPE DS    CL4                 Studio Type                                  
SVSLACCT DS    CL12                Studio/Agency Link account                   
SVMSTJOB DS    CL12                Save old master job                          
SJEQTAB  DS    (EQRTLEN)X          SJ ledger equivalent data table              
SJYQTAB  DS    (EQTYTABN)X         SJ equivalent types for this request         
SREQTAB  DS    (EQRTLEN)X          SR ledger equivalent data table              
SRYQTAB  DS    (EQTYTABN)X         SR equivalent types for this request         
*                                                                               
SAVEVARL EQU   *-SAVEVAR                                                        
***********************************************************************         
* Request values                                                      *         
***********************************************************************         
*                                                                               
QA_VALS  DS    0F                                                               
QA_ULA   DS    0CL(L'ACTKULA)                                                   
QA_UNIT  DS    CL(L'ACTKUNT)       Unit                                         
QA_LDG   DS    CL(L'ACTKLDG)       Ledger                                       
QA_ACT   DS    CL(L'ACTKACT)       Account                                      
QA_TYPE  DS    CL1                 Request type                                 
QA_TAPPR EQU   C'1'                Approval only change                         
QA_TUPDT EQU   C'2'                Update change                                
QA_TSTAT EQU   C'3'                Status change lock/close                     
QA_TLOKS EQU   C'4'                Update lock bits                             
QA_ASTAT DS    CL1                 Approval status                              
QA_ASUBM EQU   C'1'                Submitted                                    
QA_AREJT EQU   C'2'                Rejected                                     
QA_AAPPR EQU   C'3'                Approved                                     
QA_ADELT EQU   C'4'                Deleted                                      
QA_ANEW  EQU   C'5'                New                                          
QA_AAUTO EQU   C'6'                New auto                                     
QA_ACMTL DS    CL1                 Length of approver comments                  
QA_ACMTS DS    CL50                Approver comments                            
QA_NAMEL DS    CL1                 Length of name                               
QA_NAME  DS    CL(L'NAMEREC)       Name                                         
QA_OVNML DS    CL1                 Length of override name                      
QA_OVRNM DS    CL36                Override name for timesheets                 
QA_FNAML DS    CL1                 Length of foreign name                       
QA_FNAM  DS    CL(L'NAMEREC)       Foreign name                                 
QA_LNAML DS    CL1                 Length of long name                          
QA_LNAM  DS    CL100               Long Name                                    
QA_SHNAM DS    CL12                Media short name                             
QA_CLDTE DS    PL3                 Closed date                                  
QA_OPDTE DS    PL3                 Open date                                    
QA_ESTI  DS    CL1                 Job is Brandocean estimate                   
QA_MAST  DS    CL1                 Job is master                                
QA_INDEX DS    XL2                 Unique id to stop concurrent update          
QA_ADDRI DS    XL1                 Address indicator                            
QA_AADDR DS    AL3                 Address of account address list              
QA_FILTI DS    XL1                 Account Filter indicator                     
QA_AFILT DS    AL3                 Address of account filters list              
QA_LSTAT DS    CL1                 Locked status                                
QA_CSTAT DS    CL1                 Closed status                                
QA_DANAL DS    CL1                 Account dept analysis                        
QA_MANAL DS    CL1                 Miles analysis                               
QA_CANAL DS    CL1                 Client analysis code                         
QA_SANAL DS    CL1                 Staff Analysis                               
QA_PEXEC DS    CL1                 Person is executive                          
QA_PROCN DS    CL1                 Project control                              
QA_BALNC DS    CL1                 Balanace sheet                               
QA_PNL   DS    CL1                 Profit and loss                              
QA_JANAL DS    CL1                 Job analysis                                 
QA_PRVEN DS    CL1                 Provisional vendor                           
QA_MRGIN DS    CL1                 Merge invoices                               
QA_PAYLK DS    CL1                 Payee lock                                   
QA_PEELC DS    CL1                 Peel/close rec crs                           
QA_PEELD DS    CL1                 Peel/close rec drs                           
QA_SEC   DS    XL1                 Security level                               
QA_CLCST DS    CL1                 Client Cost                                  
QA_NONE  EQU   C'4'                None                                         
QA_NEWBS EQU   C'3'                New business                                 
QA_HOUSE EQU   C'2'                House                                        
QA_CLINT EQU   C'1'                Regular client                               
QA_JLEST DS    CL1                 Job locks estimate                           
QA_JLORD DS    CL1                 Job locks orders                             
QA_JLBIL DS    CL1                 Job locks billing                            
QA_JLTIM DS    CL1                 Job locks timesheets                         
QA_JLADJ DS    CL1                 Job locks adjustments                        
QA_JLEXT DS    CL1                 Job locks externals                          
QA_EXCL  DS    CL1                 Exclude from timesheets                      
QA_DSKPR DS    CL1                 Desktop priority                             
QA_INVAT DS    CL1                 Input VAT code                               
QA_SUNCR DS    CL1                 Sundry creditor - Creditors only             
QA_INVRG DS    CL1                 Invoice reg                                  
QA_FRPRO DS    CL1                 Force product on timesheet                   
QA_FRJOB DS    CL1                 Force job on timesheet                       
QA_DEFWC DS    CL(L'WCOKWRK)       Default workcode                             
QA_GLOFC DS    CL(L'TRNOFFC)       General Ledger office                        
QA_GLACC DS    CL(L'ACTKULA)       General Ledger account                       
QA_VATL  DS    XL1                 Tax number length                            
QA_VAT   DS    CL15                Tax Number (Germany) ST ledger UK            
QA_NICP  DS    CL1                 NIC status profile ST ledger only            
QA_FUSR  DS    CL1                 Foreign language user                        
QA_ACCCU DS    CL3                 Account currency                             
QA_LOCCU DS    CL1                 Local currency - Bank only                   
QA_KSVTY DS    CL2                 KSV Type                                     
QA_VATCL DS    XL1                 VAT code length                              
QA_VATCD DS    CL1                 VAT code (FFTTVATC)                          
QA_13VTL DS    XL1                 VAT code 13B length                          
QA_13VAT DS    CL5                 VAT code 13B (FFTTG13B or AST13VAT)          
QA_TAXL  DS    XL1                 VAT registration number length               
QA_TAX   DS    CL18                VAT registration number Creditors            
QA_EMALL DS    CL1                 Length of email address                      
QA_EMAIL DS    CL50                Email address (FFTTPEML)                     
QA_DSKCL DS    CL1                 Length of desktop extra comments             
QA_DSKCM DS    CL60                Desktop extra comments                       
QA_TELEL DS    CL1                 Length of telephone number                   
QA_TELE  DS    CL26                Telephone number                             
QA_MNCNL DS    CL1                 Length of main contact                       
QA_MNCON DS    CL50                Main contact                                 
QA_FAXL  DS    CL1                 Length of fax number                         
QA_FAX   DS    CL26                Fax number                                   
QA_REFNL DS    CL1                 Length of reference number                   
QA_REFNM DS    CL14                Reference number                             
QA_BAUTL DS    CL1                 Length of bank authorisation id              
QA_BAUTH DS    CL6                 Bank authorisation id                        
QA_ENTYL DS    CL1                 Length of entity                             
QA_ENTTY DS    CL36                Entity                                       
QA_BSRL  DS    CL1                 Length building soc roll number              
QA_BSRLL DS    CL18                Building society roll number                 
QA_CRCRL DS    CL1                 Length of credit card                        
QA_CRCRD DS    CL16                Credit card                                  
QA_OMEML DS    XL1                 Online memo length                           
QA_OMEMO DS    CL(L'OMEMO)         Online memo                                  
QA_CREXT DS    PL(L'SCIAMNT)       External credit limit                        
QA_CRINT DS    PL(L'SCIAMNT)       Internal credit limit                        
QA_FEE   DS    PL(L'SCIAMNT)       Fee budget amount                            
QA_DISRL DS    XL1                 Discount rate length                         
QA_DISRT DS    CL5                 Discount rate (RATEDSCQ)                     
QA_VATRL DS    XL1                 VAT rate length                              
QA_VATRT DS    CL5                 VAT rate (RATEVATQ)                          
QA_DDTEL DS    XL1                 Due date rule length                         
QA_DDTE  DS    CL8                 Due date rule                                
QA_DESCI DS    XL1                 Job description indicator                    
QA_ADESC DS    AL3                 Address of job description list              
QA_COMMI DS    XL1                 Job comment indicator                        
QA_ACOMM DS    AL3                 Address of Job comment list                  
QA_USRI  DS    XL1                 User field indicator                         
QA_AUSR  DS    AL3                 Address of user field list                   
QA_ROLI  DS    XL1                 Role indicator                               
QA_AROL  DS    AL3                 Address of role list                         
QA_PORDI DS    XL1                 Client order indicator                       
QA_APORD DS    AL3                 Address of client order list                 
QA_LJBI  DS    XL1                 Linked job indicator                         
QA_ALJB  DS    AL3                 Address of linked job list                   
QA_OTHRI DS    XL1                 Job other text indicator                     
QA_AOTHR DS    AL3                 Address of job other text list               
QA_OFFC  DS    CL4                 Office code                                  
QA_BILGR DS    CL3                 Billing group                                
QA_PRTBL DS    CL50                Print on bill text                           
QA_DRACL DS    XL1                 Debtor account LENGTH                        
QA_DRACT DS    CL(L'ACTKULA)       Debtor account                               
QA_DRNML DS    XL1                 Debtor account name length                   
QA_DRNAM DS    CL(L'NAMEREC)       Debtor account name                          
QA_DRLVL DS    CL1                 Debtor account at level                      
QA_LVL1  EQU   C'1'                Client or 1st level                          
QA_LVL2  EQU   C'2'                Product or 2nd level                         
QA_LVL3  EQU   C'3'                Job or 3rd level                             
QA_LVL4  EQU   C'4'                4th level                                    
QA_CSACL DS    XL1                 Costing account LENGTH                       
QA_CSACT DS    CL(L'ACTKACT)       Costing account                              
QA_CSNML DS    XL1                 Costing account name length                  
QA_CSNAM DS    CL(L'NAMEREC)       Costing account name                         
QA_CSLVL DS    CL1                 Costing account at level                     
QA_BCHAC DS    CL(L'ACTKULA)       Bank charge account                          
QA_BCHNL DS    XL1                 Bank charge account name length              
QA_BCHNM DS    CL(L'NAMEREC)       Bank charge account name                     
QA_EXDAC DS    CL(L'ACTKULA)       Exchange difference account                  
QA_EXDNL DS    XL1                 Exchange diff account name length            
QA_EXDNM DS    CL(L'NAMEREC)       Exchange difference account name             
QA_ANAAC DS    CL(L'ACTKULA)       Analysis bank account                        
QA_ANANL DS    XL1                 Analysis bank account name length            
QA_ANANM DS    CL(L'NAMEREC)       Analysis bank account name                   
QA_DISAC DS    CL(L'ACTKULA)       Discount account                             
QA_DISNL DS    XL1                 Discount account name length                 
QA_DISNM DS    CL(L'NAMEREC)       Discount account name                        
QA_MCLI  DS    CL6                 Master client                                
QA_MPRO  DS    CL6                 Master product                               
QA_MJOB  DS    CL6                 Master job                                   
QA_FACTR DS    CL(L'ACTKULA)       Factoring company                            
QA_FACNL DS    XL1                 Factoring company name length                
QA_FACNM DS    CL(L'NAMEREC)       Factoring company name                       
QA_2PACC DS    CL(L'ACTKACT)       2P account - Creditors only                  
QA_2PNML DS    XL1                 2P account name length                       
QA_2PNAM DS    CL(L'NAMEREC)       2P account name                              
QA_2DACC DS    CL(L'ACTKACT)       2D account - Creditors only                  
QA_2DNML DS    XL1                 2D account name length                       
QA_2DNAM DS    CL(L'NAMEREC)       2D account name                              
QA_INAC  DS    CL(L'ACTKULA)       Override income account - 1R only            
QA_INNML DS    XL1                 Override income ac name length               
QA_INNAM DS    CL(L'NAMEREC)       Override income account name                 
QA_WRAC  DS    CL(L'ACTKULA)       Override write off account - 1R              
QA_WRNML DS    XL1                 Override write off ac name length            
QA_WRNAM DS    CL(L'NAMEREC)       Override write off name                      
QA_PIDCR DS    XL2                 Binary pid for person creditor               
QA_EXPAC DS    CL(L'ACTKACT)       Expense account - Creditors only             
QA_EXPNL DS    XL1                 Expense account name length                  
QA_EXPNM DS    CL(L'NAMEREC)       Expense account name                         
QA_BSRTL DS    XL1                 Bank sort code length                        
QA_BSORT DS    CL(L'BACSORT)       Bank sort code - Bank and creditors          
QA_BACT  DS    CL(L'BACCOUNT)      Bank account code                            
QA_BACNL DS    XL1                 Bank account name length                     
QA_BACNM DS    CL(L'NAMEREC)       Bank account name                            
QA_BNAML DS    XL1                 Bank name length                             
QA_BNAME DS    CL(L'NAMEREC)       Bank name                                    
QA_PYMTH DS    CL1                 Payment method                               
QA_CHQQ  EQU   C'1'                Cheques                                      
QA_PAYQ  EQU   C'2'                Payments                                     
QA_BACQ  EQU   C'3'                BACS Payments                                
QA_MCHQ  EQU   C'4'                Manual Cheques                               
QA_INTQ  EQU   C'5'                International                                
QA_TRFQ  EQU   C'6'                Transfers                                    
QA_AFPQ  EQU   C'7'                Auto foreign payments                        
QA_SEPQ  EQU   C'8'                SEPA payments <xml>                          
QA_ACADD DS    CL1                 All account addresses                        
QA_XJOB  DS    CL1                 Expense job                                  
QA_NMED  DS    CL1                 New media code                               
QA_NPRO  DS    CL6                 New product code                             
QA_NJOB  DS    CL6                 New job code                                 
QA_UPLD  DS    CL1                 Upload tool in use                           
QA_ACCTL EQU   C'1'                Accounting third party upload tool           
QA_SAPTL EQU   C'2'                Sap upload tool                              
QA_CTRY  DS    CL2                 ISO country code                             
QA_IBANL DS    XL1                 IBAN length                                  
QA_IBAN  DS    CL(L'EBDIBAN)       IBAN                                         
QA_BICL  DS    XL1                 BIC code length                              
QA_BIC   DS    CL(L'EBDBIC)        BIC code                                     
QA_EUSGL DS    XL1                 EU SG account lenght                         
QA_EUSG  DS    CL(L'SPAAACT)       EU SG account                                
QA_NESGL DS    XL1                 non-EU SG account length                     
QA_NESG  DS    CL(L'SPAAACT)       non-EU SG account                            
QA_MAACL DS    XL1                 Media Accrual account length                 
QA_MAAC  DS    CL(L'SPAAACT)       Media Accrual account                        
QA_GAPYN DS    CL1                 GAP IN USE?                                  
QA_GAPAQ DS    CL1                 ACKNOWLEDGE/QUERY?                           
QA_FUTIM DS    CL1                 FUTURE TIME?                                 
QA_VTRGL DS    CL1                 VAT region LENGTH                            
QA_VATRG DS    CL1                 VAT region                                   
*                                                                               
QA_DRFLI DS    XL1                 DEBTOR FILTER ARRAY INDICATOR                
QA_ADRFL DS    AL3                 DEBTOR FILTER ARRAY                          
QA_CSFLI DS    XL1                 COSTING FILTER ARRAY INDICATOR               
QA_ACSFL DS    AL3                 COSTING FILTER ARRAY                         
QA_CSTTY DS    CL1                 Costing type                                 
QA_SJEQI DS    XL1                 SJ equivalent type/code(s)                   
QA_SJEQU DS    AL3                                                              
QA_SREQI DS    XL1                 SR equivalent type/code(s)                   
QA_SREQU DS    AL3                                                              
QA_PANAL DS    CL1                 Product analysis                             
*                                                                               
QA_THRD  DS    CL1                 Available in thrid party system              
*                                                                               
QA_STUC  DS    CL4                 Studio Code                                  
QA_SLJBI DS    XL1                 Linked job indicator                         
QA_ASLJB DS    AL3                 Address of linked job list                   
QA_STUL  DS    CL12                Studio Link                                  
*                                                                               
QA_MEDI  DS    XL1                 MEDIA FIELD ARRAY INDICATOR                  
QA_AMEDF DS    AL3                 MEDIA FIELD ARRAY                            
QA_VALSL EQU   *-QA_VALS                                                        
                                                                                
OA_VALS  DS    0F                                                               
OA_INDEX DS    H                   ID number                                    
OA_ULA   DS    0CL14               Returned unit ledger account                 
OA_UNT   DS    CL1                 Returned unit                                
OA_LDG   DS    CL1                 Returned ledger                              
OA_ACT   DS    CL12                Returned account code                        
OA_STAT  DS    XL1                 Returned account approval status             
OA_ACSTA DS    XL1                 Returned account status                      
OA_DA    DS    XL(L'ANCKDA)                                                     
OA_MEDL  DS    CL1                 CURRENT MEDIA LETTER                         
OA_KAM   DS    XL1                 AGY/MED FOR MEDIA IO (FROM OA_MEDL)          
OA_MIND1 DS    XL1                 COPY OF MEDDIND1                             
OA_MIND2 DS    XL1                 COPY OF MEDDIND2                             
OA_MIND3 DS    XL1                 COPY OF MEDDIND3                             
OA_MIND5 DS    XL1                 COPY OF MEDDIND5                             
OA_MFLAG DS    XL1                 MEDIA FLAGS                                  
OA_MNFST EQU   X'80'               NOT FIRST FOR MEDIA BLOCK                    
OA_MFOFF EQU   X'40'               OFFICES REQUIRED                             
OA_MCACL EQU   X'20'               PROD LEVEL CLI LIMIT ACCESS                  
OA_MCLBU EQU   X'10'               CLIENT LEVEL BUYING AGENCY                   
OA_MLIST DS    CL16                LIST OF PROCESSED MEDIA                      
OA_MCLST DS    CL8                 CLIENT STATUS AREA                           
OA_MAGYI DS    CL1                 AGENCY INDICATOR                             
OA_MAGY2 DS    CL1                 AGENCY INDICATOR 2                           
OA_CCURC DS    CL3                 AGENCY CURRENCY CODE                         
OA_CCUR2 DS    CL3                 AGENCY CURRENCY CODE 2                       
OA_MCLI  DS    CL3                 SAVED CLIENT                                 
OA_MPRO  DS    CL1                 SAVED PRODUCT                                
OA_OCAG  DS    CL1                 OLD CATEGORY GROUP                           
OA_NCAG  DS    CL1                 NEW CATEGORY GROUP                           
OA_AISC  DS    CL1                 CAGELQ found at agency level                 
OA_CISC  DS    CL1                 CAGELQ found at cli/pro level                
OA_CVAT  DS    CL1                 Client VAT type                              
OA_CBST  DS    XL1                 Client billing status                        
OA_MBLK# DS    XL2                 COUNT OF (REMAINING) MEDIA BLOCKS            
OA_VALSL EQU   *-OA_VALS                                                        
                                                                                
DR_VALS  DS    0F                  Derived variables                            
DR_ULA   DS    0CL14               Unit ledger account                          
DR_UNIT  DS    CL1                 Unit                                         
DR_LDG   DS    CL1                 Ledger                                       
DR_ACT   DS    CL12                Account                                      
* DEBTOR/COSTING WORK AREA                                                      
DR_DRACL DS    XL1                 Debtor account LENGTH                        
DR_DRACT DS    CL(L'ACTKULA)       Debtor account                               
DR_DRNML DS    XL1                 Debtor account name length                   
DR_DRNAM DS    CL(L'NAMEREC)       Debtor account name                          
DR_DRLVL DS    CL1                 Debtor account at level                      
DR_DRFLI DS    XL1                 DEBTOR FILTER ARRAY INDICATOR                
DR_ADRFL DS    AL3                 DEBTOR FILTER ARRAY                          
                                                                                
SRCHBLK  DS    XL512               search block for SRCHACC                     
SRCHLIST DS    CL(8+M_CLIDLENQ*2*8+1)                                           
*                                                                               
SAPTAB   DS    (SAPTABMX)XL(SAPTABL) saved SF equivalents                       
SAPTABX  DS    0X                                                               
SAPMBLOC DS    XL16                List of medias to update for SAP             
* ERRTAB is currently limited by the record size you've asked DDLINKIO          
* to use (LIOBRECL or 14K default).                                             
ERRTAB   DS    XL500               Saved error messages and data                
DR_VALSL EQU   *-DR_VALS                                                        
SAVEL    EQU   *-SAVED                                                          
         ORG   SAVED+(L'SVSERVER-(*-SAVED))  Online SAVED overflow trap         
***********************************************************************         
* Error table                                                         *         
***********************************************************************         
                                                                                
ET_D     DSECT                                                                  
ET_EOTQ  EQU   FF                  End of table indiciator                      
ET_LN    DS    X                   Length of this entry                         
ET_ERRNO DS    XL(L'ROUERRV)       Error number                                 
ET_FLDNM DS    XL2                 Field number error applies                   
ET_LN1Q  EQU   *-ET_D                                                           
ET_EXTRA DS    0C                  Extra error text                             
                                                                                
***********************************************************************         
* media field array DSECT                                             *         
***********************************************************************         
        SPACE  1                                                                
QI_MFLDD DSECT                                                                  
QI_MEDI1 DS    CL4                 Media 1                                      
QI_MEDI2 DS    CL4                 Media 2                                      
QI_MEDI3 DS    CL4                 Media 3                                      
QI_MEDI4 DS    CL4                 Media 4                                      
QI_MEDI5 DS    CL4                 Media 5                                      
QI_MEDI6 DS    CL4                 Media 6                                      
QI_MEDI7 DS    CL4                 Media 7                                      
QI_MEDI8 DS    CL4                 Media 8                                      
QI_MEDI9 DS    CL4                 Media 9                                      
QI_MED10 DS    CL4                 Media 10                                     
QI_MED11 DS    CL4                 Media 11                                     
QI_MED12 DS    CL4                 Media 12                                     
QI_MED13 DS    CL4                 Media 13                                     
QI_MED14 DS    CL4                 Media 14                                     
QI_MED15 DS    CL4                 Media 15                                     
QI_MED16 DS    CL4                 Media 16                                     
QI_MBLGR DS    CL2                 Media billing group                          
QI_MADD1 DS    CL30                Media address 1                              
QI_MADD2 DS    CL30                Media address 2                              
QI_MADD3 DS    CL30                Media address 3                              
QI_MADD4 DS    CL30                Media address 4                              
QI_MADD5 DS    CL30                Media address 5 (Germany)                    
QI_MEDCL DS    CL1                 Media commission length                      
QI_MEDCM DS    CL62                Media commission expression                  
QI_MVATY DS    CL2                 Media VAT type                               
QI_MDUED DS    CL15                Media due date                               
QI_BUYAG DS    XL1                 Buying agency                                
QI_CREAG DS    XL1                 Creative agency                              
QI_LIMA1 DS    XL1                 Limit access 1                               
QI_LIMA2 DS    XL1                 Limit access 2                               
QI_NMFLT DS    XL1                 Number of media filters                      
QI_MFLTS DS    9CL(QI_MFLEL)       Media filters                                
QI_MFLTL EQU   *-QI_MFLTS          length of filters                            
QI_LOCK  DS    CL1                 Lock from making bookings                    
QI_CMPRF DS    CL1                 Add campaign ref media system                
QI_BLCOM DS    CL1                 Billing comments compulsory                  
QI_ORCOM DS    CL1                 Order comments compulsory                    
QI_GEN1B DS    CL1                 Generate ME1B when booking                   
QI_FRMCD DS    CL10                Formula record code                          
QI_MXAMT DS    CL7                 Max amount for a single media bill           
QI_SURCL DS    XL1                 Surcharge length                             
QI_SURCH DS    CL6                 Surcharge % to add to media bill             
QI_COMAC DS    CL(L'ACTKACT)       Commission account                           
QI_BDGCU DS    CL3                 Budget currency                              
QI_BILCL DS    CL1                 Billing currency length                      
QI_BILCU DS    CL8                 Billing currency indicator                   
QI_OUTSC DS    CL4                 Outlet scheme code                           
QI_OUTB1 DS    CL8                 Outlet scheme budget 1                       
QI_OUTB2 DS    CL8                 Outlet scheme budget 2                       
QI_OUTB3 DS    CL8                 Outlet scheme budget 3                       
QI_OUTB4 DS    CL8                 Outlet scheme budget 4                       
QI_OUTB5 DS    CL8                 Outlet scheme budget 5                       
QI_OUTB6 DS    CL8                 Outlet scheme budget 6                       
QI_PROPC DS    CL1                 Product printable character                  
QI_MCOML DS    XL1                 Length of comments                           
QI_MCOMM DS    CL50                Media comments                               
QI_CDISB DS    CL1                 Cash discount basis                          
QI_CDISL DS    CL1                 Cash discount entry length                   
QI_CDISC DS    CL8                 Cash discount % /special option              
QI_BCOM  DS    CL1                 Billing = commission option                  
QI_MCONL DS    XL1                 Length of contact name                       
QI_MCONT DS    CL30                Contact name                                 
QI_MTELL DS    XL1                 Length of telephone no.                      
QI_MTELE DS    CL20                Tel. no.                                     
QI_MFAXL DS    XL1                 Length of fax no.                            
QI_MFAXN DS    CL20                Fax no.                                      
QI_MTAXL DS    XL1                 Tax/vat reg no. length                       
QI_MTAXN DS    CL20                Tax/vat reg no.                              
QI_POTRK DS    CL1                 PO Tracker (I or E)                          
QI_POTIN EQU   C'I'                Include                                      
QI_POTEX EQU   C'E'                Exclude                                      
QI_POTRA DS    CL1                 PO Tracker approval                          
QI_MFLDL EQU   *-QI_MFLDD                                                       
                                                                                
***********************************************************************         
* Account and Media filter list area DSECT                            *         
***********************************************************************         
        SPACE  1                                                                
FLTRTBD  DSECT                                                                  
FLTRNUM  DS    XL1                 Filter number                                
FLTRVAL  DS    CL1                 Filter value                                 
FLTRTBL  EQU   *-FLTRTBD           Length                                       
                                                                                
***********************************************************************         
* Equivalent code DSECT                                               *         
***********************************************************************         
QI_EQFLD DSECT                                                                  
QI_EQTYP DS    CL1                 Equivalent type                              
QI_EQTY0 EQU   C'A'                                                             
QI_EQTY1 EQU   C'B'                                                             
QI_EQTY2 EQU   C'C'                                                             
QI_EQTY3 EQU   C'D'                                                             
QI_EQTY4 EQU   C'E'                                                             
QI_EQCOD DS    CL(L'EQUKCODE)      Equivalent code length CL20                  
QI_EQLEN EQU   *-QI_EQFLD                                                       
                                                                                
***********************************************************************         
* User field list area DSECT                                          *         
***********************************************************************         
USRTABD  DSECT                                                                  
USRCODE  DS    CL2                 User field code                              
USRDATA  DS    CL10                User field data                              
USRTABL  EQU   *-USRTABD           Length                                       
                                                                                
***********************************************************************         
* Team role list area DSECT                                           *         
***********************************************************************         
ROLTABD  DSECT                                                                  
ROLNUMB  DS    XL2                 Role number                                  
ROLBPID  DS    XL2                 Binary Pid of team member                    
ROLLVL   DS    CL1                 Level where assigned                         
ROLTABL  EQU   *-ROLTABD           Length                                       
                                                                                
***********************************************************************         
* Client purchase order list area DSECT                               *         
***********************************************************************         
CLPOTBD  DSECT                                                                  
CLPONUM  DS    CL20                Client purchase order number                 
CLPOAMT  DS    PL6                 Client purchase order amount                 
CLPLTBL  EQU   *-CLPOTBD           Length                                       
                                                                                
***********************************************************************         
* Approval hierarchy search table DSECT                               *         
***********************************************************************         
APRTABD  DSECT                                                                  
APRSTAT  DS    XL1                 Levels to include                            
APRCLI   EQU   X'80'               Client                                       
APRPRO   EQU   X'40'               Product                                      
APRJOB   EQU   X'20'               Job                                          
APRMED   EQU   X'10'               Media                                        
APROFF   EQU   X'08'               Office                                       
APRTABL  EQU   *-APRTABD                                                        
                                                                                
***********************************************************************         
* Auto job numbers search table DSECT                                 *         
***********************************************************************         
SRCTABD  DSECT                                                                  
SRCSTAT  DS    XL1                 Levels to include                            
SRCCLI   EQU   X'80'               Client                                       
SRCPRO   EQU   X'40'               Product                                      
SRCMED   EQU   X'20'               Media                                        
SRCMEDGR EQU   X'10'               Media group                                  
SRCOFF   EQU   X'08'               Office                                       
SRCOFFGR EQU   X'04'               Office group                                 
SRCJOB   EQU   X'02'               Job                                          
SRCTABL  EQU   *-SRCTABD                                                        
                                                                                
FILTTABD DSECT                                                                  
FILTNUM  DS    XL1                 Filter number                                
FILTDISP DS    XL1                 Displacement in ele to filter pos            
FILTACDI DS    XL1                 Displacement in accout to filter             
FILTTABL EQU   *-FILTTABD                                                       
*                                                                               
RECVTABD DSECT                                                                  
RECVACLV DS    XL1                 Account level                                
RECVLVL  DS    XL1                 Level of change for debtor/cost              
         DS    XL2                 n/d                                          
RECVRADR DS    H                   Routine displacement                         
RECVTABL EQU   *-RECVTABD                                                       
*                                                                               
SPATABD  DSECT                                                                  
SPASTAT  DS    XL1                 Account level                                
SPASUL   EQU   X'80'               Unit and ledger included in code             
SPASNAM  EQU   X'40'               Name can be changed                          
SPASCPJ  EQU   X'20'               Client product job style code                
SPATTYPE DS    XL1                 SPATYPE                                      
SPAAUDTY DS    XL1                 Audit type for STCELD                        
SPADFLDN DS    XL1                 Field number                                 
SPATUL   DS    CL2                 Unit ledger if SPASUL not on                 
SPAADRAC DS    H                   Displacement to account code                 
SPAADRNM DS    H                   Disp to l'name + name address                
SPATABL  EQU   *-SPATABD                                                        
*                                                                               
FFTTABD  DSECT                                                                  
FFTTIND1 DS    XL1                 Indicator                                    
FFTTDEB  EQU   X'80'               Add for debtor acc                           
FFTTEOT  EQU   X'FF'               End of table                                 
FFTTYP   DS    XL1                 Type of free form text element               
FFTAUDT  DS    XL1                 Free form audit type                         
         DS    XL1                 N/D                                          
FFTTADRT DS    H                   displacement to l'text + text                
FFTTABL  EQU   *-FFTTABD                                                        
*                                                                               
SCITABD  DSECT                                                                  
SCITIND1 DS    XL1                 Indicator                                    
SCITEOT  EQU   X'FF'               End of table                                 
SCITDEB  EQU   X'80'               Add to debtor account                        
SCITYP   DS    XL1                 Type of subsidiary amount element            
SCIAUDT  DS    XL1                 Sciel audit type                             
         DS    XL1                 N/D                                          
SCIADRAM DS    H                   Displacment to amount                        
SCITABL  EQU   *-SCITABD                                                        
*                                                                               
RSTTABD  DSECT                                                                  
RSTBIT   DS    XL1                 Bit we are looking at                        
RSTEOT   EQU   X'FF'               End of table                                 
RSTSTC   DS    XL1                 Type of audit stcel                          
RSTDISP  DS    H                   Displacment to status byte on ele            
RSTTABL  EQU   *-RSTTABD                                                        
*                                                                               
LDGLVBD  DSECT                                                                  
LDGDISP  DS    H                   Displacement to field in storage             
LDGFLDN  DS    XL2                 Field no.                                    
LDGLEDG  DS    XL1                 Ledgers valid for                            
LDGSJUL  EQU   X'80'               SJ ledger                                    
LDGSRUL  EQU   X'40'               SR ledger                                    
LDGSEUL  EQU   X'20'               SE ledger                                    
LDGSIUL  EQU   X'10'               SI ledger                                    
LDGSQUL  EQU   X'08'               SQ ledger                                    
LDGSVUL  EQU   X'04'               SV ledger                                    
LDGSXUL  EQU   X'02'               SX ledger                                    
LDGINDS  DS    XL1                 Indicator                                    
LDGIARR  EQU   X'80'               Input is an array                            
LDGLVBL  EQU   *-LDGLVBD                                                        
*                                                                               
NUMTABD  DSECT                                                                  
NUMVAL   DS    CL2                 VALUE FIELD                                  
NUMMOVE  DS    S                   A(MOVE FIELD)                                
NUMADDR  DS    S                   A(ROUTINE)                                   
NUMLEN   EQU   *-NUMTABD                                                        
*                                                                               
ELMTABD  DSECT                                                                  
ELMDATA  DS    0CL32                                                            
         DS    CL4                                                              
ELMCODE  DS    CL2                                                              
ELMDESC  DS    CL12                                                             
ELMEDIT  DS    CL8                                                              
         DS    CL1                                                              
ELMSTAT  DS    XL1                                                              
         DS    CL4                                                              
ELMLNG   EQU   *-ELMDATA                                                        
*                                                                               
QI_MFLTD DSECT                 **  Media filter array **                        
QI_MFLTN DS    CL1                 Media filter 1 entry                         
QI_MFLTV DS    CL1                 Media filter 1 value                         
QI_MFLEL EQU   *-QI_MFLTD                                                       
         EJECT                                                                  
*                                                                               
* INCLUDED DSECTS                                                               
         PRINT OFF                                                              
       ++INCLUDE ACBRAWRKD                                                      
       ++INCLUDE ACIBANTABD                                                     
       ++INCLUDE DDTAXVALD                                                      
       ++INCLUDE MEFILOSCD                                                      
*      ++INCLUDE FAFACTS                                                        
*&&UK                                                                           
       ++INCLUDE MEMSGEQUS                                                      
*&&                                                                             
         PRINT ON                                                               
         PRINT OFF                                                              
CONBLKD  DSECT                                                                  
       ++INCLUDE DDCONBLK                                                       
         PRINT ON                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'089ACBRA29   12/16/20'                                      
         END                                                                    
