*          DATA SET TAGEN50    AT LEVEL 105 AS OF 11/02/16                      
*PHASE T70250C,*                                                                
         TITLE 'T70250 - PAY COMMON ROUTINES'                                   
T70250   CSECT                                                                  
         PRINT NOGEN                                                            
         REQUS                                                                  
         USING *,RF                                                             
V50      NTR1                                                                   
         DROP  RF                                                               
         LR    RB,RF                                                            
         USING T70250,RB,R7,R6,R5                                               
         B     *+10                                                             
         DC    CL6'T70250'                                                      
         LA    R7,2048(RB)                                                      
         LA    R7,2048(R7)                                                      
         LA    R6,2048(R7)                                                      
         LA    R6,2048(R6)                                                      
         LA    R5,2048(R6)                                                      
         LA    R5,2048(R5)                                                      
         USING GEND,RC             RC=A(GENCON AREAS)                           
         L     RA,ATWA                                                          
         USING T702FFD,RA          RA=A(TWA)                                    
         L     R9,ASYSD                                                         
         USING SYSD,R9             R9=A(GLOBAL SAVED VALUES)                    
         LA    R8,TWAHOLE                                                       
         USING PAYD,R8             R8=A(PAY SAVED STORAGE)                      
         SPACE 1                                                                
         ST    RC,SAVRC            SAVE RC FOR V502 NMOD                        
         SRL   RF,24                                                            
         LA    RF,BRANCH(RF)       TEST IF ROUTINE IS IN V502 NMOD              
         LA    RE,BR2                                                           
         CR    RF,RE                                                            
         BLR   RF                  IF NOT, JUST BRANCH TO IT                    
         LR    RC,RF                                                            
         SR    RC,RE               ELSE, FIND DISPLACEMENT INTO NMOD            
         SLL   RC,24               ** RC IS CREAMED, MUST RESTORE **            
         OR    RF,RC                                                            
HK0GC    BASR  RE,RF                                                            
         B     XIT                                                              
         SPACE 1                                                                
BRANCH   B     PAYINIT             X'00'                                        
         B     VVALPFK             X'04'                                        
         B     VVALAGY             X'08'                                        
         B     VVALINV             X'0C'                                        
         B     VVALCOM             X'10'                                        
         B     VVALMID             X'14'                                        
         B     VGETCAST            X'18'                                        
         B     VVALRHS             X'1C'                                        
         SPACE                                                                  
BR2      EQU   *                   ROUTINES AFTER THIS ARE IN V502 NMOD         
         SPACE                                                                  
         J     V502                X'20' - VCHECK                               
         J     V502                X'24' - VINVOICE                             
         J     V502                X'28' - VPUTSCRN                             
         J     V502                X'2C' - VGETSCRN                             
         J     V502                X'30' - VMYADD                               
         J     V502                X'34' - VMYWRITE                             
         J     V502                X'38' - VPAYDONE                             
         J     V502                X'3C' - VMYADDRC                             
         J     V502                X'40' - VMYPUTRC                             
         J     V502                X'44' - VDISRHS                              
         J     V502                X'48' - VPVAL                                
         J     V502                X'4C' - VCASTDET                             
         J     V502                X'50' - VGETDUE                              
         J     V502                X'54' - VW4DET                               
         J     V502                X'58' - VLCLCHCK                             
         J     V502                X'5C' - VGRNTEE                              
         J     V502                X'60' - VADDREQ                              
         J     V502                X'64' - VDELSCRS                             
         J     V502                X'68' - VADJTBCS                             
         J     V502                X'6C' - VLCBUHFX                             
         J     V502                X'70' - VLCB2CBL                             
         J     V502                X'74' - VSTLCBTY                             
         J     V502                X'78' - VSTLCBSB                             
         J     V502                X'7C' - TPRELCB                              
         J     V502                X'80' - TRYOCEL                              
         J     V502                X'84' - LCBTYPE                              
         J     V502                X'88' - GETCAUH                              
         SPACE 1                                                                
         LTORG                                                                  
         SPACE 3                                                                
         GETEL R4,DATADISP,ELCODE                                               
         EJECT                                                                  
*              INITIALIZATION ROUTINES                                          
         SPACE 1                                                                
*                                  P1, X'80'=CALLED FROM CONTROLLER             
PAYINIT  DS    0H                                                               
         ZIC   R3,0(R1)            SAVE HOB OF PLIST                            
         SPACE 1                                                                
         XC    DMCB,DMCB                                                        
         MVI   DMCB,X'40'          ASSUME FORCE SAME W/S                        
         TM    PRGSTAT,PAYINITD    IF NOT INITIALIZED YET                       
         BO    *+8                                                              
         MVI   DMCB,X'80'          FORCE NEW WORKING STORAGE                    
         SPACE 1                                                                
         GOTO1 INITIAL,DMCB        SYSTEM INITIALIZE                            
         SPACE 1                                                                
         CLC   TGUSCDE,CONREC      IF USE TYPE CHANGED                          
         BE    INIT1                                                            
         TM    SCRSTAT,SCRCHG      AND SCREEN DIDN'T                            
         BO    INIT1                                                            
         MVI   TWASCR,0            FORCE SCREEN TO BE RE-LOADED                 
         MVI   GOAGAIN,C'Y'        SET TO GO TO GENCON AGAIN                    
         MVI   ERROR,X'FE'         SET DUMMY ERROR                              
         MVI   SVSCR,0             SO WE DON'T COME THROUGH HERE AGAIN          
         B     RECEND              GET OUT                                      
         SPACE 1                                                                
INIT1    TM    PRGSTAT,PAYINITD    IF NOT INITIALIZED YET                       
         BO    INIT2                                                            
         MVI   SPACES,C' '         INITIALIZE LOCAL SPACES                      
         MVC   SPACES+1(L'SPACES-1),SPACES                                      
         MVI   FPAGE,X'FF'         INITIALIZE FIRST PAY SCREEN PAGE NO.         
         MVI   LPAGE,X'FF'         AND LAST OVERALL PAGE NUMBER                 
         NI    PAYAGYH+4,X'DF'     INVAL. AGY FLD (==> ALL FLDS INVAL)          
         OI    PRGSTAT,PAYINITD    SET WE'VE INITIALIZED                        
         XC    AGYSCDE,AGYSCDE                                                  
         SPACE 1                                                                
INIT2    LA    R1,4                PICK UP A(REMAINING COMMON ROUTINES)         
         LA    RF,PAYCOMM                                                       
         LA    R0,NPAYCOMM                                                      
INIT4    ST    RB,0(RF)                                                         
         STC   R1,0(RF)                                                         
         LA    R1,4(R1)                                                         
         LA    RF,4(RF)                                                         
         BCT   R0,INIT4                                                         
         SPACE 1                                                                
         CHI   R3,X'40'                                                         
         BE    *+10                                                             
         LTR   R3,R3               CONTROLLER CALL (MENU/CAST SELECT)           
         BZ    INIT6                                                            
         BAS   RE,MENUINIT         SPECIAL HANDLING                             
         B     INITX               THAT'S ALL                                   
         SPACE 1                                                                
INIT6    TM    SCRSTAT,SCRCHG      IF SCREEN CHANGED                            
         BZ    *+8                                                              
         BRAS  RE,FILLSCRN         FILL IN SOME SCREEN VALUES                   
         SPACE 1                                                                
         MVI   OVERLAY,X'51'       LOAD PAY CONTROLLER                          
         GOTO1 LOADSOPH,DMCB,0                                                  
         ST    R3,APAYCNTL         RETURNS A(PHASE) IN R3                       
         SPACE 1                                                                
*&&UK                                                                           
         MVI   OVERLAY,X'60'       LOAD RATE CALCULATION MODULE                 
         GOTO1 LOADSOPH,DMCB,0                                                  
         ST    R3,ARATECLC         RETURNS A(PHASE) IN R3                       
*&&                                                                             
         SPACE 1                                                                
         XC    TCARATES,TCARATES   CLEAR A(RATE TABLE)                          
         MVC   ARATECLC,TASYSCLC   SAVE A(CORE RESIDENT RATE CALC RTN)          
INITX    B     XIT                                                              
         EJECT                                                                  
*              MENU (AND CAST/SELECT) SPECIAL ROUTINES                          
         SPACE 1                                                                
MENUINIT NTR1                                                                   
         TM    AGYSTAT,TAAYSCOD    IF COD AGENCY                                
         BZ    *+10                                                             
         MVC   CONHED2(12),CODMSG  DISPLAY IN CONHED2                           
         SPACE                                                                  
         CHI   R3,X'40'                                                         
         BE    *+12                                                             
         CLI   TWASCR,SCR96        IF CAST SELECT SCREEN LOADED                 
         BNE   *+12                                                             
         BAS   RE,PFKCAST          GO PROCESS SCREEN                            
         B     MENUX               FINISHED - RETURN TO LOAD USE SCREEN         
         SPACE 1                                                                
         GOTO1 VALPFK,DMCB,0       CHECK WHETHER ANOTHER MENU REQUESTED         
         SPACE 1                                                                
         GOTO1 USEVAL,DMCB,(X'40',CONREC)  VALIDATE USE CODE                    
         BE    MENU2                       CONTINUE IF VALID                    
         CLI   CONACT,C'P'                 ELSE IF ACTION IS NOT PAY            
         BE    *+8                                                              
         NI    PRGSTAT,ALL-PAYINITD  SET TO START ALL OVER NEXT TIME            
         B     MENUX                 MISSING/INVALID USE - RETURN               
         SPACE 1                                                                
MENU2    GOTO1 FLDVAL,DMCB,(X'80',PAYAGYH),PAYLFTH  TEST KEY FLDS EMPTY         
         BNE   *+12                                                             
         CLI   PFAID,13            TEST FOR CAST SELECT REQUEST                 
         BNE   MENUX                                                            
         SPACE 1                                                                
         NI    LCLSTAT,ALL-TOPOK                                                
         MVI   KFLDCHA,0           CLEAR KEY FIELD CHANGED STATUS               
         SPACE 1                                                                
         GOTO1 VALAGY              VALIDATE AGENCY                              
         SPACE 1                                                                
         CLI   TGUSEQU,UEVE        UNLESS MAKING EVENT PAYMENT                  
         BE    MENU4                                                            
         CLI   PAYCIDH+5,0         IF COMMERCIAL INPUT                          
         BNE   *+14                                                             
         OC    TGCID,TGCID         OR THERE'S A GLOBAL COMMERCIAL               
         BZ    MENU4                                                            
         GOTO1 VALCOM              VALIDATE COMMERCIAL FIRST                    
         GOTO1 VALINV              VALIDATE INVOICE NUMBER                      
         B     MENU6                                                            
         SPACE 1                                                                
MENU4    GOTO1 VALINV              VALIDATE INVOICE NUMBER FIRST                
         GOTO1 VALCOM              VALIDATE COMMERCIAL                          
         SPACE 1                                                                
MENU6    OI    LCLSTAT,TOPOK       WE'VE VALIDATED TOP KEY FIELDS               
         SPACE 1                                                                
         GOTO1 VALPFK,DMCB,(1,0)   PROCESS CAST SELECT REQUEST IF NEC.          
         SPACE 1                                                                
MENUX    B     XIT                                                              
         EJECT                                                                  
*              ROUTINE TO HANDLE PFKEY VALIDATION                               
         SPACE 1                                                                
*                                  P1 BYTE 0 = BYTE TO MATCH                    
VVALPFK  DS    0H                                                               
         CLI   PFAID,0             USER PRESSED ENTER                           
         BE    NO                                                               
         SPACE 1                                                                
         CLI   PFAID,20            IF PF KEY IS 20                              
         BNE   VALPF1                                                           
         TM    LCLSTAT3,COMRELER   IGNORE IT IF COMM'L RELEASE ERROR            
         BO    NO                  PENDING                                      
         TM    LCLSTAT2,JOBERR     IGNORE IT IF JOB INVALID ERROR               
         BO    NO                  PENDING                                      
         TM    LCLSTAT4,POERR      IGNORE IT IF PO INVALID ERROR                
         BO    NO                  PENDING                                      
         TM    LCLSTAT3,CLADUEER   IGNORE IT IF CLA DUE DATE WARNING            
         BO    NO                  PENDING                                      
         TM    LCLSTAT8,DVDELPND   IGNORE IF ADVICE/INVOICE DELETE              
         BO    NO                  PENDING                                      
         TM    LCLSTAT8,NOGCPEND   IGNORE IF NO GCON SPECIFIED                  
         BO    NO                  PENDING                                      
         SPACE 1                                                                
VALPF1   CLI   PFAID,21            IF PF KEY IS 21                              
         BNE   VALPF1Z                                                          
         TM    SEQSTAT,SSLATCHK    IGNORE IT IF INVOICES OUT OF SEQ             
         BO    NO                                                               
         TM    CYCSTAT,CYSTEOVR    OR CYCLE OVERLAP ERROR PENDING               
         BO    NO                                                               
         TM    CYCSTAT2,CYSTMUPD+CYSTMUPC                                       
         BNZ   NO                  OR MUSIC PAID/OVERLAP ERROR PENDING          
         SPACE 1                                                                
VALPF1Z  LA    R2,PFTABLE          VALIDATE PFKEY                               
         USING PFKD,R2                                                          
VALPF2   CLI   0(R2),X'FF'                                                      
         BE    NO                                                               
         CLC   PFAID,PFKAID        MATCH ON PFKEY NUMBER                        
         BNE   *+14                                                             
         CLC   PFKARG,0(R1)        ALSO MATCH ON PARAMETER 1                    
         BE    *+12                                                             
         LA    R2,PFKNEXT                                                       
         B     VALPF2                                                           
         SPACE 1                                                                
         CLI   PFKARG,0            IF ARGUMENT NOT ZERO                         
         BE    VALPF4                                                           
         TM    PAYMODE,DRAFT       DON'T ALLOW FOR DRAFT PAYMENTS               
         BO    NOTIFDFT                                                         
         CLI   PFAID,13            IF PFKEY FOR CAST SELECT                     
         BNE   VALPF4                                                           
         TM    LCLSTAT3,SOAPRES                                                 
         BO    NOCSTSEL            DON'T ALLOW FOR SOAP RESIDUALS               
         CLI   TGUSEQU,UEVE                                                     
         BE    NOCSTSEL            DON'T ALLOW FOR EVENT PAYMENTS               
         SPACE 1                                                                
VALPF4   LR    RF,RB               GET A(PFKEY HANDLING ROUTINE)                
         AH    RF,PFKRTN                                                        
         BASR  RE,RF               ** HANDLE PFKEY INPUT **                     
         B     YES                                                              
         EJECT                                                                  
*              ROUTINE HANDLES LOADING CAST SELECT MODULES                      
         SPACE 1                                                                
PFKCAST  NTR1                                                                   
         CLI   SVSCR,SCR96         IF MENU SCREEN LOADED                        
         BE    *+10                                                             
         MVC   SVMENU,SVSCR        SAVE IT IN CASE ABORT LATER                  
         SPACE                                                                  
         MVI   OVERLAY,X'56'       SET TO LOAD CAST SELECT VAL. MODULE          
         GOTO1 LOADSOPH,DMCB,0                                                  
         ST    R3,ACASTSEL         RETURNS R3=A(PHASE)                          
         SPACE 1                                                                
         MVI   OVERLAY,SCR96       SET TO LOAD CAST SELECT SCREEN               
         MVI   ALTPROG,X'F3'       SET ALT. PROGRAM FOR PAY SCREENS             
         BRAS  RE,LOADSCRN         LOAD SCREEN IF NECESSARY                     
         SPACE 1                                                                
         GOTO1 ACASTSEL,DMCB,(RC)  PROCESS CAST SELECT SCREEN                   
         BE    XIT                 FINISHED - RETURN & LOAD USE SCREEN          
         SPACE 1                                                                
         MVC   OVERLAY,SVMENU      CAST SELECT NOT SUCCESSFUL                   
         BRAS  RE,LOADSCRN         LOAD PREV. MENU SCREEN                       
         SPACE 1                                                                
         NI    CONRECH+1,X'DF'     UNPROTECT REC/ACT                            
         OI    CONRECH+6,X'80'                                                  
         NI    CONACTH+1,X'DF'                                                  
         OI    CONACTH+6,X'80'                                                  
         SPACE 1                                                                
         TM    LCLSTAT2,ABORT      TEST ABORT PFKEY PRESSED                     
         BO    ABORTPFK                                                         
         B     NONEELIG            ELSE NO ONE ELIGIBLE FOR PAYMENT             
         EJECT                                                                  
*              ROUTINES TO CONTROL LOADING OF ALT. PAY MENUS                    
         SPACE 2                                                                
PFK2ND   MVI   OVERLAY,SCR91       SET SECONDARY PAY MENU                       
         B     PFKALL                                                           
         SPACE 1                                                                
PFKCAN   MVI   OVERLAY,SCR92       SET CANADIAN PAY MENU                        
         B     PFKALL                                                           
         SPACE 1                                                                
PFKSPAN  MVI   OVERLAY,SCR93       SET SPANISH PAY MENU                         
         B     PFKALL                                                           
         SPACE 1                                                                
PFKADDND MVI   OVERLAY,SCR94       SET ADDENDUM PAY MENU                        
         B     PFKALL                                                           
         SPACE 1                                                                
PFKSOAP  MVI   OVERLAY,SCR97       SET SOAP PAY MENU                            
         B     PFKALL                                                           
         SPACE 1                                                                
PFKINDST MVI   OVERLAY,SCR98       SET INDUSTRIAL PAY MENU                      
         B     PFKALL                                                           
         SPACE 1                                                                
PFKMUSIC MVI   OVERLAY,SCR99       SET MUSIC PAY MENU                           
         B     PFKALL                                                           
         SPACE 1                                                                
PFKALL   NTR1                                                                   
         MVI   ALTPROG,X'F3'       SET ALT. PROGRAMS FOR PAY SCREENS            
         BRAS  RE,LOADSCRN                                                      
         MVI   ALTPROG,X'F2'       RESET                                        
         XC    CONHED2(12),CONHED2  CLEAR COD AGENCY MSG                        
         B     PYLOADED                                                         
         EJECT                                                                  
*              ROUTINES TO HANDLE PFKEY PAGE CONTROL                            
         SPACE 1                                                                
PFKPREV  DS    0H                                                               
         CLC   PPAGE,DPAGE         IF WE'RE ALREADY AT 1ST DETAIL PAGE          
         BNH   PFERR               ERROR                                        
         ZIC   R1,PPAGE            PAGE WE JUST WROTE                           
         BCTR  R1,0                LESS 1                                       
         STC   R1,GPAGE            IS PREVIOUS PAGE                             
         CLC   GPAGE,DPAGE         TEST WE'RE NOW AT FIRST DETAIL PAGE          
         BE    PFKF2                                                            
         MVI   MYMSGNO1,18         PREVIOUS PAGE RE-DISPLAYED                   
         B     PFKPGALL                                                         
         SPACE 1                                                                
PFKFRST  DS    0H                                                               
         CLC   PPAGE,DPAGE         IF WE'RE ALREADY AT 1ST DETAIL PAGE          
         BNH   PFERR               ERROR                                        
         MVC   GPAGE,DPAGE         SET FIRST PAGE                               
PFKF2    MVI   MYMSGNO1,19         FIRST PAGE RE-DISPLAYED                      
         B     PFKPGALL                                                         
         SPACE 1                                                                
PFKLAST  DS    0H                                                               
         CLC   PPAGE,LPAGE         IF WE'RE ALREADY AT LAST PAGE                
         BNL   PFERR               ERROR                                        
         MVC   GPAGE,LPAGE         SET LAST PAGE                                
         MVI   MYMSGNO1,20         LAST PAGE - HIT ENTER FOR NEXT               
         TM    LCLSTAT,FINISHED    TEST WE'VE FINISHED                          
         BZ    *+8                                                              
         MVI   MYMSGNO1,22         LAST PAGE - HIT ENTER TO COMPLETE            
         B     PFKPGALL                                                         
         SPACE 1                                                                
PFKPGALL NTR1                                                                   
         GOTO1 GETSCRN,DMCB,(X'80',GPAGE),(RA) RETRIEVE APPROP. SCREEN          
         BE    XIT                 CALLING ROUTINE WILL GO TO EXIT RTN.         
         DC    H'0'                                                             
         EJECT                                                                  
*              ROUTINE FORMATS CLIENT AND PRODUCT CODES TO PAYCLPR              
         SPACE                                                                  
DISPCLPR DS    0H                                                               
         MVC   PAYCLPR(L'TGCLI),TGCLI  FIRST MOVE CLIENT                        
         OC    TGPRD,TGPRD             IF THERE'S A PRODUCT                     
         BZ    DISCPX                                                           
         LA    R1,PAYCLPR+L'TGCLI-1    FIND END OF CLIENT                       
         SPACE                                                                  
DISCP5   CLI   0(R1),X'40'                                                      
         BH    DISCP10                                                          
         BCT   R1,DISCP5            KEEP BACKING UP TILL FIND NON-SPACE         
         SPACE                                                                  
DISCP10  MVI   1(R1),C'/'           MOVE A '/' IN BETWEEN CLIENT                
         MVC   2(L'TGPRD,R1),TGPRD  AND PRODUCT                                 
         SPACE                                                                  
DISCPX   BR    RE                                                               
         EJECT                                                                  
*              ROUTINE TO VALIDATE AGENCY                                       
         SPACE 1                                                                
VVALAGY  DS    0H                                                               
         LA    R2,PAYAGYH                                                       
         TM    4(R2),X'20'         TEST PREVIOUSLY VALIDATED                    
         BO    XIT                                                              
         GOTO1 FLDVAL,DMCB,(X'10',PAYINVH),999  INVALIDATE REM. FIELDS          
         SPACE 1                                                                
         XC    CONHED2(12),CONHED2 CLEAR COD CLIENT MESSAGE                     
*                                                                               
         GOTO1 RECVAL,DMCB,TLAYCDQ,(X'2A',(R2)),PAYAGYNH  GET RECORD            
         MVC   AGYNAME,PAYAGYN                                                  
         XC    ELTANUSA,ELTANUSA   CLEAR AGENY SIGNATORY                        
         XC    LENGTHS,LENGTHS     CLEAR ESTIMATE SETUP LENGTHS                 
         XC    DEFJOB,DEFJOB       CLEAR DEFAULT JOB                            
         MVI   INTER,C'N'          TURN OFF INTERFACE SWITCH                    
*                                                                               
***********************************************************************         
*        CODE TO BLOCK PAYMENTS TO DEFUNCT BILLING TYPES              *         
*        MAYBE IT WILL GO LIVE SOMEDAY                                *         
***********************************************************************         
*&&DO                                                                           
         L     R4,AIO                                                           
         MVI   ELCODE,TABRELQ      SEE IF BILLING TYPE IS DEFUNCT               
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING TABRD,R4                                                         
         GOTO1 BTYPVAL,DMCB,TABRTYPE   BETTER BE VALID BILLING TYPE             
         BE    *+6                     ASSUMING AGENCY PROGRAM IS               
         DC    H'0'                    CORRECTLY VALIDATING BTYPE               
         TM    TGBTSTAT,BTYPSDFT       IS THIS A DEFUNCT BILLING TYPE?          
         BO    BTDISERR                                                         
*&&                                                                             
***********************************************************************         
                                                                                
         MVI   ELCODE,TAAYELQ      GET AGENCY ELEMENT                           
         L     R4,AIO                                                           
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING TAAYD,R4                                                         
         TM    TAAYSTA7,TAAYSPPL   IF THIS IS A PAYROLL PLUS AGENCY             
         JZ    VAGY0                                                            
         CLI   TGUSEQU,UEVE        EVE IS THE ONLY VALID USE TYPE               
         JNE   ERPPLSI                                                          
                                                                                
VAGY0    MVC   TGJWBUNT,TAAYBUNT                                                
         TM    TAAYSTA3,TAAYSLCK   PAYMENT NOT ALLOWED IF AGENCY LOCKED         
         BNO   VAGY1                                                            
         BRAS  RE,LCKAGY                                                        
         BNE   XIT                                                              
*                                                                               
VAGY1    TM    TGUSSTA3,SOAPUSE    IF SOAP USE TYPE                             
         BZ    VAGY10                                                           
         TM    TAAYSTA3,TAAYS30M   IF AGENCY FOR 30 MIN SOAP SERIALS            
         BZ    VAGY5                                                            
         CLI   TGUSEQU,USOR        ERROR IF USE IS NOT FOR 30 MIN               
         BE    AGYUSERR                                                         
         CLI   TGUSEQU,USDR                                                     
         BE    AGYUSERR                                                         
         CLI   TGUSEQU,USWR                                                     
         BE    AGYUSERR                                                         
         B     VAGY10                                                           
VAGY5    CLI   TGUSEQU,USRH        ELSE ERROR IF USE IS FOR 30 MIN              
         BE    AGYUSERR                                                         
         CLI   TGUSEQU,USDH                                                     
         BE    AGYUSERR                                                         
         CLI   TGUSEQU,USWH                                                     
         BE    AGYUSERR                                                         
VAGY10   MVC   AGYSTAT,TAAYSTAT    SAVE AGENCY STATUS BYTES                     
         MVC   TCAYSTAT,TAAYSTAT                                                
         MVC   AGYSTAT2,TAAYSTA2                                                
         MVC   AGYSTAT3,TAAYSTA3                                                
         MVC   AGYSTAT4,TAAYSTA4                                                
         MVI   AGYSTAT7,0                                                       
         CLI   TAAYLEN,TAAYLNQ                                                  
         BL    *+10                                                             
         MVC   AGYSTAT7,TAAYSTA7                                                
         MVC   TGOFF,TAAYTPOF      SAVE TP OFFICE                               
         TM    AGYSTAT,TAAYSCOD    IF COD AGENCY                                
         BZ    *+10                                                             
         MVC   CONHED2(12),CODMSG  DISPLAY IN CONHED2                           
         TM    TAAYSTA6,TAAYST10   IF TYPE 10 JOB VALIDATION                    
         BZ    *+8                                                              
         MVI   INTER,C'Y'          SET LOCAL SWITCH                             
*                                                                               
         USING TANUD,R4                                                         
         MVI   ELCODE,TANUELQ                                                   
         GOTO1 GETL,DMCB,(1,=AL1(TANUTSIG))                                     
         BNE   *+14                                                             
         L     R4,TGELEM           R4=A(TGELEM)                                 
         MVC   ELTANUSA,0(R4)                                                   
*                                                                               
         MVI   ELCODE,TANUELQ                                                   
         GOTO1 GETL,DMCB,(1,=AL1(TANUTJOB))                                     
         BNE   VAGY20                                                           
         L     R4,TGELEM                                                        
         MVC   LENGTHS,TANUMBER    SAVE ESTIMATE SETUP LENGTHS                  
         NI    LENGTHS,X'0F'                                                    
         NI    LENGTHS+1,X'0F'                                                  
         NI    LENGTHS+2,X'0F'                                                  
*                                                                               
VAGY20   GOTO1 GETL,DMCB,(1,=AL1(TANUTDJB))                                     
         BNE   VAGY25                                                           
         L     R4,TGELEM                                                        
         MVC   DEFJOB,TANUMBER     SAVE DEFAULT JOB                             
         DROP  R4                                                               
*                                                                               
VAGY25   MVC   EOR,TGTPEMP         SET DEFAULT EMPLOYER OF RECORD               
         MVI   NWKREQ,C'N'         TURN OFF NETWORK REQ'D (CLA USES)            
         BRAS  RE,GETRULES         SET BILLING RULES                            
         MVC   AGYEOR,EOR          SAVE AGENCY EMPLOYER OF RECORD               
         MVC   AGYINTER,INTER      SAVE AGENCY INTERFACE STATUS                 
         MVC   AGYNWKRQ,NWKREQ     SAVE AGENCY NETWORK REQ'D (CLA USES)         
         SPACE 1                                                                
         NI    LCLSTAT9,X'FF'-AGYBRATE                                          
         TM    TGSYSTAT,TASYSBRT                                                
         BZ    VAGY30                                                           
         L     R4,AIO                                                           
         MVI   ELCODE,TARAELQ      IF AGENCY HAS BRATE ATTACHED                 
         BRAS  RE,GETEL                                                         
         JNE   *+8                                                              
         OI    LCLSTAT9,AGYBRATE   SET STATUS                                   
         SPACE 1                                                                
VAGY30   OI    KFLDCHA,KAY         SET AGENCY CHANGED                           
         OI    4(R2),X'20'         SET PREVIOUSLY VALIDATED                     
         B     XIT                                                              
         SPACE 3                                                                
*              ROUTINE TO VALIDATE COMMERCIAL ID                                
         SPACE 1                                                                
VVALCOM  DS    0H                                                               
         CLI   TGUSEQU,UEVE                                                     
         BNE   VCOM00A                                                          
         CLI   TWASCR,SCR90                                                     
         BL    VCOM00A                                                          
         CLI   TWASCR,SCR99                                                     
         BNH   XIT                                                              
         SPACE 1                                                                
VCOM00A  LA    R2,PAYCIDH          ALWAYS READ COMMERCIAL                       
         MVC   AIO,AIO2            USE I/O AREA 2 - OK THROUGH XVALMID          
         MVC   ACOML,AIO           SAVE SOME ADDRESSES                          
         LA    R1,ELTACO                                                        
         ST    R1,TCATACO                                                       
         LA    R1,EPISAIR                                                       
         ST    R1,TCAEPISA                                                      
         MVI   BYTE,0                                                           
         TM    TGUSSTA3,VERSONLY   TEST VERSIONS ALLOWED                        
         BZ    *+8                                                              
         OI    BYTE,X'20'                                                       
         GOTO1 RECVAL,DMCB,(BYTE,TLCOICDQ),(X'0A',(R2)),PAYCOMNH                
         MVC   COMNAME,TGNAME                                                   
         NI    LCLSTAT8,ALL-VGCONCHG                                            
         SPACE 1                                                                
         BRAS  RE,SVMEDTAB         SAVE INTERNET/NEW MEDIA CODES                
         SPACE 1                                                                
         TM    4(R2),X'20'         IF COMMERCIAL                                
         BZ    VCOM00B                                                          
         TM    PAYLFTH+4,X'20'     OR LIFT HAS NOT CHANGED                      
         BZ    VCOM00B                                                          
         BRAS  RE,CHKGCON          CHECK GCON RECORDS ARE UNCHANGED             
         B     VCOMX                                                            
         SPACE 1                                                                
VCOM00B  NI    PAYLFTH+4,X'DF'     INVALIDATE LFT FIELD                         
         NI    PAYSTAT2,X'FF'-PCYCCOML-FROMWEB                                  
         LH    R1,DSPEST                                                        
         LTR   R1,R1               GET A(EST# FLD)                              
         BZ    *+10                                                             
         AR    R1,RA               AND SET NOT VALID SO WILL REVALIDATE         
         NI    4(R1),X'DF'         EVEN AFTER MORE THAN 1 HIT OF ENTER          
         SPACE 1                                                                
         LA    R3,KEY              USING DIRECTORY RECORD                       
         USING TLCOPD,R3                                                        
         MVC   TGCOM,TLCOICOM      SAVE INTERNAL COMMERCIAL NUMBER              
         MVC   SVTGCOM,TLCOICOM    SAVE HERE - SOAP CABLE CREAMS TGCOM          
         CLI   TLCOIVER,0          SEE IF CID INPUT IS FOR A VERSION            
         BNE   VCOM00C             BRANCH IF YES                                
         TM    TGUSSTA3,VERSONLY   IF NOT, TEST VERSIONS ALLOWED                
         BZ    VCOM0A                                                           
         GOTO1 SEQ                 DO SEQ                                       
         CLC   SVTGCOM,TLCOICOM    IF SAME INTERNAL COMMERCIAL NUMBER           
         BNE   VCOM0A                                                           
         CLC   TGCID,TLCOICID      AND SAME CID                                 
         BNE   VCOM0A                                                           
         CLI   PAYLFTH+5,0         AND THERE'S NO INPUT IN LFT FIELD            
         BNE   VCOM0A                                                           
VCOM00C  EDIT  TLCOIVER,PAYLFT,ALIGN=LEFT                                       
         STC   R0,PAYLFTH+5                                                     
         OI    PAYLFTH+6,X'80'     AND TRANSMIT                                 
         OI    PAYLFTH+4,X'20'     SET VALIDATED                                
         SPACE 1                                                                
         USING TLCOD,R3                                                         
VCOM0A   L     R3,AIO              USING FILE RECORD                            
         SPACE 1                                                                
         CLI   TLCOVER,TLCOV026    IF VERSION WAS NOT ON MAIN                   
         BE    VCOM0A1             COMMERCIAL RECORD                            
         GOTO1 RECVAL,DMCB,TLCOCCDQ,(X'8E',0),PAYCOMNH                          
         BE    *+6                                                              
         DC    H'00'                                                            
         MVC   COMNAME,TGNAME                                                   
         SPACE 1                                                                
VCOM0A1  MVI   COMCMNTH,L'COMCMNTH+L'COMCMNT                                    
         GOTO1 CHAROUT,DMCB,TACMELQ,COMCMNTH,TACMTYPG SAVE COMML COMMNT         
         SPACE 1                                                                
         TM    TLCOSTAT,TLCOSDEL   IF MARKED FOR PURGE, DON'T ALLOW             
         BO    PURGED                                                           
         MVC   TGCLI,TLCOCLI       SAVE CLIENT                                  
         MVC   TGPRD,TLCOPRD       AND PRODUCT                                  
         DROP  R3                                                               
         SPACE 1                                                                
         MVI   ELCODE,TACOELQ      GET COMMERCIAL DETAILS EL.                   
         LR    R4,R3                                                            
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING TACOD,R4                                                         
         CLC   TACOCID,TGCID       IF INPUT CID DOESN'T MATCH RECORD            
         BE    VCOM0B                                                           
         MVC   PAYCID,TACOCID      REPLACE VERSION CID W/MAIN COMM'L'S          
         MVC   TGCID,TACOCID       SET TGCID                                    
         OI    PAYCIDH+6,X'80'                                                  
VCOM0B   TM    TACOSTAT,TACOSTLO   IF LOCKED, DON'T ALLOW PAYMENT               
         BNO   VCOM0C                                                           
         CLI   TACOMED,TACOMEDE                                                 
         BE    EVTLCK                                                           
         BRAS  RE,CIDLCK                                                        
         BNE   XIT                                                              
VCOM0C   TM    TACOSTAT,TACOSTRL   IF RELEASED ...                              
         BZ    VCOM0D                                                           
         TM    TGUSSTA2,HLDTYPE    ... AND MAKING HOLDING FEE PAYMENT           
         BNO   VCOM0C1                                                          
         BRAS  RE,CIDREL           RETURN ERROR                                 
         BNE   XIT                                                              
VCOM0C1  TM    TGFASTAT,TGFROMFA   ... OR MAKING NON-HOLDING FEE PYMT           
         JO    VCOM0D                                                           
         TM    LCLSTAT3,COMRELER   AND COMM'L RELEASE ERROR PENDING             
         BZ    COMRLSED            ELSE SET PENDING AND GIVE MESSAGE            
         SPACE                                                                  
         CLI   PFAID,20               TEST PF20 PRESSED                         
         BNE   COMRLSED               IF NOT, REGIVE MESSAGE                    
         SPACE 1                                                                
VCOM0D   CLI   TWASCR,SCR90        IF NOT ON MENU SCREEN                        
         BL    VCOM0D4                                                          
         CLI   TWASCR,SCR99                                                     
         BNH   VCOM0D5                                                          
VCOM0D4  NI    LCLSTAT3,ALL-COMRELER  TURN OFF ERROR PENDING                    
         SPACE 1                                                                
VCOM0D5  CLI   TACOTYPE,CTYIND      OLD INDUSTRIAL COMMERCIAL TYPE              
         BE    VCOM0D1              IS NO LONGER ALLOWED                        
         SPACE 1                                                                
         BRAS  RE,HASVER            IF COMMERCIAL DOES NOT HAVE                 
         BE    VCOM0D2              VERSIONS                                    
         GOTO1 VALTYP,DMCB,TACOTYPE VALIDATE USE TYPE FOR COMM'L TYPE           
         BE    VCOM0D2                                                          
VCOM0D1  BRAS  RE,INVCTY                                                        
         BNE   XIT                                                              
         SPACE 1                                                                
VCOM0D2  TM    TACOSTA2,TACOPCYC      IF PER CYCLE COMMERCIAL                   
         BZ    VCOM0D3                                                          
         OI    PAYSTAT2,PCYCCOML                                                
         TM    TGUSSTA2,HLDTYPE       ONLY HOLDING FEE PAYMENTS                 
         BO    VCOM0D3                ARE ALLOWED                               
         BRAS  RE,INVCTY                                                        
         BNE   XIT                                                              
         SPACE 1                                                                
VCOM0D3  TM    TGUSSTA2,HLDTYPE       IF MAKING HOLDING FEE PAYMENT             
         BZ    VCOM0E                                                           
         CLI   TACOTYPE,CTYSEAS2      TO SEASONAL COMMERCIAL                    
         BNE   VCOM0E                                                           
         OC    TACOAIR,TACOAIR        AT LEAST 1 AIR DATE MUST BE               
         BNZ   VCOM0E                 DEFINED                                   
         BRAS  RE,MS1AIR                                                        
         BNE   XIT                                                              
         SPACE 1                                                                
VCOM0E   CLI   TACOSEC,0                                                        
         BE    VCOM0F                                                           
         EDIT  TACOSEC,(3,COMLEN+1),ALIGN=LEFT                                  
         MVI   COMLEN,C':'                                                      
         MVC   PAYSEC,COMLEN       MOVE COMMERCIAL LENGTH TO SCREEN             
         OI    PAYSECH+6,X'80'                                                  
         SPACE 1                                                                
VCOM0F   TM    TGUSSTA2,HLDTYPE    IF HOLD TYPE                                 
         BZ    VCOM2                                                            
         CLI   TACOLEN,TACOLNQ2                                                 
         BL    VCOM0FA                                                          
         TM    TACOSTA3,TACOSSMW   AND IF SOCIAL MEDIA WAIVER ON,               
         BZ    VCOM0FA                                                          
         BRAS  RE,INVCTY           INVALID USE TYPE FOR COMMERCIAL              
         BNE   XIT                                                              
VCOM0FA  CLI   TACOTYPE,0          AND IF NO COMMERCIAL TYPE                    
         BE    VCOM0G                                                           
         CLI   TACOTYPE,CTYASIAN   OR TYPE ASIAN                                
         BE    VCOM0G                                                           
         CLI   TACOTYPE,CTYADD     OR TYPE ADDENDUM                             
         BE    VCOM0G                                                           
         CLI   TACOTYPE,CTYSEAS    OR TYPE SEASONAL                             
         BE    VCOM0G                                                           
         CLI   TACOTYPE,CTYSEAS2                                                
         BE    VCOM0G                                                           
         CLI   TACOTYPE,CTYSPAN    OR TYPE SPANISH                              
         BNE   VCOM2                                                            
VCOM0G   CLI   TACOMED,TACOMEDT    AND MEDIA IS TELEVISION                      
         BE    VCOM0H                                                           
         CLI   TACOMED,TACOMEDC    OR CABLE                                     
         BE    VCOM0H                                                           
         CLI   TACOMED,TACOMEDI    OR INTERNET                                  
         BE    VCOM0H                                                           
         CLI   TACOMED,TACOMEDN    OR NEW MEDIA                                 
         BNE   VCOM2                                                            
VCOM0H   CLI   TACOSPCY,0          SPLIT CYCLE INDICATOR MUST BE SET            
         BNE   VCOM2                                                            
         BRAS  RE,SPINST                                                        
         BNE   XIT                                                              
         SPACE 1                                                                
VCOM2    CLI   TGUSEQU,USOM        IF SOCIAL MEDIA PAYMENT,                     
         BNE   VCOM2A                                                           
         BRAS  RE,VALSOM           VALIDATE COMMERCIAL                          
         SPACE 1                                                                
VCOM2A   XC    TGMENAME,TGMENAME                                                
         GOTO1 MEDVAL,DMCB,TACOMED SET MEDIA EQUATE / NAME                      
         MVC   PAYMEDN,TGMENAME    MOVE EXPANDED NAME TO SCREEN                 
         OI    PAYMEDNH+6,X'80'                                                 
         SPACE 1                                                                
         CLI   TGUSMEDS,ALL                                                     
         BE    VCOM2C                                                           
         MVC   BYTE,TGUSMEDS       VALID MEDIAS FOR THIS USE                    
         NC    BYTE,TGMEEQU        CURRENT MEDIA EQUATE                         
         BNZ   VCOM2C                                                           
         BRAS  RE,MEDERR           USE TYPE INVALID FOR THIS MEDIA              
         BNE   XIT                                                              
         SPACE 1                                                                
VCOM2C   TM    TGFASTAT,TGCRNOPY   IF PAYMENT COMING FROM CERNO                 
         BO    VCOM3               CAST VERIFICATION ALWAYS REQUIRED            
         SPACE 1                                                                
         TM    PRGSTAT,TESTSYS     IF NOT TEST SYSTEM                           
         BO    VCOM4                                                            
         TM    TGUSSTA2,NOVERIF    UNLESS OTHERWISE SPECIFIED                   
         BO    VCOM4                                                            
         ZIC   R1,PAYINVH+5                                                     
         LTR   R1,R1                                                            
         BZ    VCOM3                                                            
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         CLC   PAYINV(0),=CL6'DRAFT' OR IF 'DRAFT' PAYMENT                      
         BE    VCOM4                                                            
VCOM3    OC    TACOVDTE,TACOVDTE   CAST VERIFICATION REQUIRED                   
         BNZ   VCOM4                                                            
         BRAS  RE,NOTVFY                                                        
         BNE   XIT                                                              
         SPACE 1                                                                
VCOM4    BAS   RE,VALLFT           VALIDATE LIFT                                
         SPACE 1                                                                
         CLI   VERSION,0           IF PAYING A VERSION                          
         BE    VCOM6                                                            
         CLI   TCVERSEC,0          AND DON'T HAVE LENGTH (OLD STYLE)            
         BNZ   VCOM6                                                            
         MVC   TCVERSEC,TACOSEC    USE LENGTH OF MAIN COMM'L                    
         SPACE 1                                                                
VCOM6    BRAS  RE,SVELS            SAVE SOME ELS. FROM COMMERCL REC.            
         SPACE 1                                                                
         BRAS  RE,HASVER           IF COMMERCIAL HAS VERSIONS                   
         BNE   VCOM7               VERSIONS                                     
         MVC   COMNAME2,COMNAME                                                 
         CLI   VERSION,1                                                        
         BE    VCOM6A                                                           
         MVC   AIO,AIO3                                                         
         MVC   COMNAME2,SPACES                                                  
         GOTO1 RECVAL,DMCB,TLVRCDQ,(X'A4',VERSION)                              
         BE    *+6                 VALIDATE COMMERCIAL TYPE NOW                 
         DC    H'00'                                                            
         L     R4,AIO                                                           
         MVI   ELCODE,TANAELQ                                                   
         USING TANAD,R4                                                         
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'00'                                                            
         ZIC   RE,1(R4)                                                         
         SHI   RE,3               SUBTRACT 2 BYTES FOR ELEMENT                  
         EX    RE,*+8             LENGTH AND ELCODE                             
         B     *+10                                                             
         MVC   COMNAME2(0),TANANAME                                             
         DROP  R4                                                               
         USING TACOD,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TACOELQ                                                   
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'00'                                                            
VCOM6A   GOTO1 VALTYP,DMCB,TACOTYPE VALIDATE USE TYPE FOR COMM'L TYPE           
         BE    VCOM6B                                                           
         BRAS  RE,INVCTY                                                        
         BNE   XIT                                                              
         SPACE 1                                                                
VCOM6B   MVC   ELTACO+TACOTYPE-TACOD(L'TACOTYPE),TACOTYPE                       
         DROP  R4                                                               
         SPACE 1                                                                
VCOM7    MVC   AIO,AIO1            (RESTORE I/O AREA)                           
         SPACE 1                                                                
         BAS   RE,VALCLPR          VALIDATE CLIENT/PRODUCT                      
         CLC   EOR,=C'DM '         DM PAYMENTS NOT ALLOWED AS OF 1/1/97         
         BE    EMPERR                                                           
* NO-OP  CLI   TGUSMEDS,PRINT      IF PRINT PAYMENT                             
* 10/28  BNE   VCOM8                                                            
*        CLC   EOR,=C'PP '         EMPLOYER MUST BE PP                          
*        BE    VCOM8                                                            
*        LA    R2,CONRECH                                                       
*        B     EMPERR                                                           
         SPACE 1                                                                
VCOM8    BRAS  RE,GCNTCHK                                                       
         BRAS  RE,DUPACHK                                                       
         SPACE 1                                                                
         OI    4(R2),X'20'         SET PREVIOUSLY VALIDATED                     
         OI    KFLDCHA,KCO         SET COMMERCIAL CHANGED                       
         B     VCOMX2                                                           
         SPACE 1                                                                
VCOMX    MVC   AIO,AIO1            INSURE WE HAVE DEFAULT I/O AREA              
         SPACE 1                                                                
         TM    PAYMODE,DTLDSPLD    TEST DETAIL NOT DISPLAYED YET                
         BO    *+12                                                             
         TM    TGUSTYST,UPGRADE    IF USE TYPE WAS UPGRADE PREVIOUSLY           
         BO    VCOMX2              MUST GETUH IN CASE NOT UPGRADE NOW           
         SPACE                                                                  
         LH    R2,DSPCYC           R2=DISP. TO CYCLE FIELD                      
         LTR   R2,R2                                                            
         BZ    XIT                                                              
         AR    R2,RA               R2=A(CYCLE FIELD)                            
         TM    4(R2),X'20'                                                      
         BO    XIT                 DON'T BOTHER IF UNCHANGED                    
         SPACE                                                                  
VCOMX2   BRAS  RE,VALTMCO          VALIDATE COMM IF TIMESHEETS EXIST            
         SPACE 1                                                                
         CLI   TGUSEQU,UDLR        IF MAKING A DEALER PAYMENT                   
         BNE   VCOMX3                                                           
         BRAS  RE,GETLSTHF         SAVE LATEST HOLDING FEE DATE                 
         SPACE 1                                                                
VCOMX3   NI    LCLSTAT,ALL-FIRSTHLD                                             
         BAS   RE,GETUH            GET USAGE HISTORY                            
         BNE   VCOMX3A                                                          
         TM    TGFASTAT,TGFROMFA   IGNORE ERROR IF PAYING FROM WEB              
         BO    XIT                                                              
         CLI   TGUSEQU,UEDS        EDS                                          
         BNE   XIT                                                              
         CLI   PFAID,22            IF PF21 HAS BEEN HIT TO SAY                  
         BE    XIT                 IT'S OK THEN IT'S OK                         
         BRAS  RE,CIDEDS           RETURN ERROR                                 
         BNE   XIT                                                              
VCOMX3A  TM    TGUSSTA2,HLDTYPE    DIDN'T FIND ANY - IF THIS IS HLDTYPE         
         BZ    XIT                                                              
         OI    LCLSTAT,FIRSTHLD    SET THIS IS FIRST HLD FOR COMMERCIAL         
         MVC   WORK2(L'TGUSCDE),TGUSCDE  SAVE CORRECT USE CODE                  
         SPACE                                                                  
         USING TACOD,R4                                                         
         LA    R4,ELTACO                                                        
         MVC   TGUSCDE,=C'BSS'     LOOK FOR SESSION USAGE HISTORY               
         CLI   TACOTYPE,CTYSPAN    IF SPANISH COMMERCIAL                        
         BNE   *+14                                                             
         MVC   TGUSCDE,=C'SSS'     LOOK FOR SPANISH SESSN USAGE HISTORY         
         B     VCOMX4                                                           
         TM    TGUSSTA3,ADDENUSE   IF ADDENDUM USE TYPE                         
         BZ    *+10                                                             
         MVC   TGUSCDE,=C'ADT'     LOOK FOR ADDENDUM SESSION USAGE HIST         
VCOMX4   BAS   RE,GETUH            GET USAGE HISTORY                            
         MVC   TGUSCDE,WORK2       RESTORE CORRECT USE CODE                     
         B     XIT                                                              
         EJECT                                                                  
*              ROUTINE TO VALIDATE LIFT OR VERSION IN LFT FIELD                 
         SPACE 1                                                                
VALLFT   NTR1                                                                   
         LA    R2,PAYLFTH                                                       
         CLI   TGUSEQU,UITN        MUST BE EMPTY FOR ITN PAYMENTS               
         BNE   VLFT0                                                            
         CLI   5(R2),0                                                          
         BNE   FLDINV                                                           
         SPACE                                                                  
VLFT0    XC    ELTALF,ELTALF                                                    
         XC    ELTAVR,ELTAVR                                                    
         MVI   HASLIFT,C'N'                                                     
         XC    LIFT,LIFT                                                        
         XC    VERSION,VERSION                                                  
         XC    TCVERSEC,TCVERSEC                                                
         MVI   ELCODE,TAVRELQ      SET ELCODE TO VERSIONS                       
         TM    4(R2),X'20'         SKIP TO GETL IF PREV. VALIDATED              
         BO    VLFT1               MEANS VERSION ID INPUT                       
         SPACE                                                                  
         USING TAVRD,R4                                                         
         TM    TGUSSTA3,VERSONLY   IF VERSION ONLY USE                          
         BZ    VLFT1N                                                           
         L     R4,AIO                                                           
         BAS   RE,GETEL            TEST COMM'L HAS VERSIONS                     
         BNE   VLFT1N                                                           
         CLI   5(R2),0             VERSION INPUT REQUIRED                       
         BE    FLDMISS                                                          
VLFT1    GOTO1 VALINUM             SAVE VERSION                                 
         MVC   VERSION,ACTUAL                                                   
         SPACE                                                                  
         CLI   VERSION,26          IF VERSION CODE IS GREATER THAN              
         BNH   VLFT1D              26                                           
         SPACE                                                                  
         USING VINDEXD,RE                                                       
         LA    RE,VERINDEX         FIND RECORD EQUATE FOR THIS                  
VLFT1A   CLI   0(RE),X'FF'         VERSION NUMBER                               
         BNE   *+6                                                              
         DC    H'00'                                                            
         CLC   VERSION,VINDUPLM                                                 
         BNH   VLFT1B                                                           
         LA    RE,VINDLNQ(RE)                                                   
         B     VLFT1A                                                           
         SPACE 1                                                                
VLFT1B   L     R4,AIO               GET COMMERCIAL RECORD FOR                   
         XC    KEY,KEY              THAT VERSION                                
         MVC   KEY(L'TLCOKEY),0(R4)                                             
         MVC   KEY+TLCOVER-TLCOD(L'TLCOVER),VINDEQUT                            
         GOTO1 HIGH                                                             
         CLC   KEY(L'TLCOKEY),KEYSAVE                                           
         BNE   FLDINV                                                           
         GOTO1 GETREC                                                           
         BAS   RE,GETEL                                                         
         BE    VLFT1D                                                           
         B     FLDINV                                                           
         DROP  RE                                                               
         SPACE                                                                  
VLFT1C   BAS   RE,NEXTEL                                                        
         BNE   FLDINV                                                           
VLFT1D   CLC   TAVRVERS,VERSION                                                 
         BNE   VLFT1C                                                           
         MVC   PAYLID,TAVRCID      DISPLAY VERSION ID                           
         MVC   ELTAVR,TAVREL       SAVE VERSION ELEMENT                         
         MVC   TCVERSEC,TAVRSEC    SAVE N'SECONDS IN VERSION                    
         DROP  R4                                                               
         SPACE                                                                  
         USING TLCOD,R4                                                         
         L     R4,AIO              IF VERSION WAS NOT ON MAIN                   
         CLI   TLCOVER,TLCOV026    COMMERCIAL RECORD, RESTORE                   
         BE    VLFTX               MAIN COMMERCIAL IN AIO                       
         GOTO1 RECVAL,DMCB,(X'20',TLCOICDQ),(X'26',PAYCIDH)                     
         BE    VLFTX                                                            
         DC    H'00'                                                            
         DROP  R4                                                               
         SPACE                                                                  
         USING TALFD,R4                                                         
VLFT1N   XC    PAYLID,PAYLID       PRE-CLEAR LIFT ID FIELD                      
         XC    LIFTID,LIFTID                                                    
         MVI   ELCODE,TALFELQ      LOOK FOR LIFT DETAILS EL.                    
         L     R4,AIO                                                           
         BAS   RE,GETEL                                                         
         BNE   VLFT2                                                            
         MVI   HASLIFT,C'Y'        IF FOUND, SET HAVE LIFT                      
         MVC   TCLFTSEC,TALFSEC    SAVE N'SECONDS IN LIFT                       
         SPACE                                                                  
VLFT2    CLI   5(R2),0                                                          
         BE    VLFT4                                                            
         CLI   5(R2),1                                                          
         BNE   FLDINV                                                           
         CLI   8(R2),C'N'                                                       
         BE    VLFT4                                                            
         CLI   8(R2),C'A'          IF INPUT LFT=A                               
         BNE   VLFT3                                                            
         TM    TGUSSTA3,NWKUSE     INVALID IF NETWORK USE                       
         BO    FLDINV                                                           
         CLI   HASLIFT,C'Y'        IF THERE'S A LIFT, SAVE ITS INFO             
         BNE   VLFT4                                                            
         B     VLFT3C                                                           
VLFT3    CLI   8(R2),C'Y'          IF INPUT LFT=Y                               
         BNE   FLDINV                                                           
         CLI   HASLIFT,C'Y'                                                     
         BNE   LIFTERR             MUST HAVE LIFT                               
VLFT3C   MVC   ELTALF,0(R4)        SAVE ENTIRE ELEMENT                          
         MVC   PAYLID,TALFLID      DISPLAY LIFT ID                              
         SPACE 1                                                                
VLFT4    MVC   LIFT,8(R2)          SAVE LIFT STATUS                             
VLFTX    OI    4(R2),X'20'         SET PREV. VALIDATED                          
         OI    PAYLIDH+6,X'80'     TRANSMIT ID FIELD                            
         MVC   LIFTID,PAYLID       SAVE LIFT ID                                 
         SPACE 1                                                                
         L     R4,AIO                                                           
         MVI   ELCODE,TAVRELQ      IF COMMERCIAL HAS VERSIONS                   
         BAS   RE,GETEL            SET STATUS FOR SYSCALC                       
         BNE   XIT                                                              
         OI    TCPAYST2,TCHASVER                                                
         B     XIT                                                              
         EJECT                                                                  
*              ROUTINE GETS USAGE HISTORY FOR CURRENT USE                       
         SPACE 1                                                                
GETUH    NTR1                                                                   
         XC    LASTINV,LASTINV     CLEAR LAST INVOICE NUMBER                    
         XC    TCTAUHEL,TCTAUHEL   AND USAGE HISTORY EL.                        
         SPACE 1                                                                
         MVI   TGBYTE,UHCUR        SET TRIED THIS USE FOR CURR AGY/COM          
         SPACE 1                                                                
         LA    R3,KEY              BUILD PARTIAL KEY FOR RECORD                 
         USING TLUHD,R3                                                         
         XC    TLUHKEY,TLUHKEY                                                  
         MVI   TLUHCD,TLUHCDQ      RECORD CODE                                  
         MVC   TLUHCOM,TGCOM       INTERNAL COMMERCIAL NUMBER                   
         MVC   TLUHUSE,TGUSCDE     USE CODE                                     
         GOTO1 HIGH                GET DIRECTORY RECORD                         
         SPACE 1                                                                
         CLC   TLUHKEY(TLUHINV-TLUHD),KEYSAVE  DID WE FIND REC FOR USE          
         BE    GETU10                                                           
         SPACE 1                                                                
         GOTO1 TPRELCB             CHECK USAGE HISTORY FOR PREVIOUS             
         BNE   NO                  AGY/COMM'L AND (POSSIBLY) LCB                
         SPACE 1                                                                
GETU10   GOTO1 GETREC              GET THE RECORD                               
         SPACE 1                                                                
GETU20   MVC   WORK(6),TLUHINV                                                  
         XC    WORK(6),HEXFFS      UN-COMPLEMENT INVOICE NUMBER                 
         GOTO1 TINVCON,DMCB,WORK,LASTINV,DATCON  SAVE DISPLAYABLE NO.           
         SPACE 1                                                                
         USING TAVRD,R4                                                         
         MVI   ELCODE,TAVRELQ      GET VERSIONS ELEMENT                         
         L     R4,AIO                                                           
         BAS   RE,GETEL                                                         
         BNE   *+10                                                             
         MVC   UHVERS,TAVRVERS     SAVE VERSION CODE                            
         SPACE 1                                                                
         USING TAUHD,R4                                                         
         MVI   ELCODE,TAUHELQ      GET USAGE HISTORY ELEMENT                    
         L     R4,AIO                                                           
         BAS   RE,GETEL                                                         
         BNE   YES                                                              
         XC    TCTAUHEL,TCTAUHEL                                                
         ZIC   RE,TAUHLEN                                                       
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   TCTAUHEL(0),TAUHEL  SAVE IT IN LOCAL BUFFER                      
         SPACE 1                                                                
         GOTO1 LCBUHFX             OLD FORMAT LCB UH REQUIRES FIX               
         GOTO1 LCB2CBL             CBL/SCB UPGRADE TO LCB REQUIRES FIX          
         SPACE 1                                                                
         TM    TGUSSTA3,CBLUSE     IF CABLE OR SPANISH CABLE                    
         BZ    GETU50                                                           
         LA    R3,KEYSAVE          AND WE HAVEN'T CHECKED FOR LCB YET           
         CLC   TLUHUSE,=C'LCB'                                                  
         BE    YES                                                              
         LA    R3,KEY                                                           
         BRAS  RE,TRYLCB           TRY LCB FOR CURRENT AGY/COMM'L               
         BE    GETU40                                                           
         GOTO1 TRYOCEL             IF NOT FOUND, TRY PREV AGY/COMM'L            
         BNE   YES                                                              
GETU40   GOTO1 GETREC              IF LCB USAGE HISTORY IS FOUND                
         L     R4,AIO              AND CYCLE START IS LATER                     
         MVI   ELCODE,TAUHELQ      THAN CYCLE START FOR CBL                     
         BAS   RE,GETEL            DISPLAY AND SAVE LCB INSTEAD                 
         BNE   YES                                                              
         CLC   TAUHSTRT,TCTAUHEL+TAUHSTRT-TAUHD                                 
         BH    GETU20                                                           
         B     YES                                                              
         DROP  R4                                                               
         SPACE 1                                                                
GETU50   TM    TGUSSTA2,HLDTYPE    IF HOLDING FEE PAYMENT                       
         BZ    YES                                                              
         SPACE 1                                                                
         USING TLCAPD,R3                                                        
         LA    R3,KEY                                                           
         XC    KEY,KEY                                                          
         MVI   TLCAPCD,TLCAHCDQ                                                 
         MVC   TLCAHCOM,TGCOM                                                   
         GOTO1 HIGH                                                             
         B     GETU70                                                           
GETU60   GOTO1 SEQ                                                              
GETU70   CLC   KEY(TLCAHSRT-TLCAPCD),KEYSAVE                                    
         BNE   YES                                                              
         CLC   TLCAHDTE,TCTAUHEL+TAUHSTRT-TAUHD                                 
         BNH   GETU60                                                           
         GOTO1 GETREC                                                           
         SPACE 1                                                                
         USING TACRD,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TACRELQ                                                   
         BAS   RE,GETEL                                                         
         B     GETU90                                                           
GETU80   BAS   RE,NEXTEL                                                        
GETU90   BNE   GETU60                                                           
         TM    TACRSTAT,TACRHDLR                                                
         BZ    GETU80                                                           
         CLC   TACRSTRT,TCTAUHEL+TAUHSTRT-TAUHD                                 
         BNH   GETU80                                                           
         MVC   TCTAUHEL+TAUHSTRT-TAUHD(6),TACRSTRT                              
         GOTO1 TINVCON,DMCB,TACRINV,LASTINV,DATCON                              
         NI    LCLSTAT,ALL-FIRSTHLD                                             
         B     GETU80                                                           
         DROP  R3,R4                                                            
         EJECT                                                                  
*              ROUTINE TO VALIDATE CLIENT/PRODUCT                               
         SPACE 1                                                                
VALCLPR  NTR1                                                                   
         GOTO1 RECVAL,DMCB,TLCLCDQ,(X'88',0),PAYCLINH GET CLIENT NAME           
         MVC   CLINAME,PAYCLIN                                                  
         SPACE 1                                                                
         TM    AGYSTAT,TAAYSCOD    IF THIS IS A COD AGENCY                      
         BO    *+10                                                             
         XC    CONHED2(12),CONHED2                                              
                                                                                
***********************************************************************         
*        CODE TO BLOCK PAYMENTS TO DEFUNCT BILLING TYPES              *         
*        MAYBE IT WILL GO LIVE SOMEDAY                                *         
***********************************************************************         
*&&DO                                                                           
         L     R4,AIO                                                           
         MVI   ELCODE,TABRELQ      SEE IF BILLING TYPE IS DEFUNCT               
         BRAS  RE,GETEL                                                         
         BNE   VCP00                                                            
         USING TABRD,R4                                                         
         CLI   TABRTYPE,0                                                       
         BE    VCP00                                                            
         GOTO1 BTYPVAL,DMCB,TABRTYPE   BETTER BE VALID BILLING TYPE             
         BE    *+6                     ASSUMING AGENCY PROGRAM IS               
         DC    H'0'                    CORRECTLY VALIDATING BTYPE               
         TM    TGBTSTAT,BTYPSDFT       IS THIS A DEFUNCT BILLING TYPE?          
         BO    BTDISERR                                                         
*&&                                                                             
VCP00    MVI   CLTSTAT,0                                                        
         MVI   ELCODE,TACIELQ     GET CLIENT INFO ELEMENT                       
         L     R4,AIO                                                           
         BAS   RE,GETEL                                                         
         BNE   VCP01                                                            
         USING TACID,R4                                                         
         MVC   CLTSTAT,TACISTAT                                                 
         DROP  R4                                                               
         TM    CLTSTAT,TACISCOD                                                 
         BZ    *+10                                                             
         MVC   CONHED2(12),CODMSG2                                              
         SPACE 1                                                                
                                                                                
VCP01    NI    LCLSTAT2,ALL-GLOBCLI                                             
         L     R3,AIO                                                           
         USING TLCLD,R3                                                         
         OC    TLCLAGY,TLCLAGY     TEST IF GLOBAL CLIENT                        
         BNZ   *+8                                                              
         OI    LCLSTAT2,GLOBCLI    SET LCLSTAT2 BIT                             
         SPACE 1                                                                
         MVC   EOR,AGYEOR          SET AGENCY EMPLOYER OF RECORD                
         MVC   INTER,AGYINTER      SET AGENCY INTERFACE STATUS                  
         CLI   AGYINTER,C'C'       IF CLIENT LEVEL INTERFACE                    
         BNE   *+8                                                              
         MVI   INTER,C'N'          INIT INTERFACE STATUS TO N                   
         MVC   NWKREQ,AGYNWKRQ     SET AGENCY NETWORK REQ'D (CLA USES)          
         BRAS  RE,GETRULES         SET BILLING RULES                            
*                                                                               
         CLI   AGYINTER,C'N'       IF AGENCY NOT ON INTERFACE                   
         BNE   *+8                                                              
         MVI   INTER,C'N'          ALWAYS SET INTERFACE STATUS TO N             
         SPACE 1                                                                
         MVC   PRODCLI,TGCLI       INIT PROD. CLIENT TO BE TAL CLIENT           
         MVC   ELTANUSC,ELTANUSA   INIT CLIENT SIGNATORY FROM AGENCY            
         SPACE 1                                                                
         USING TAISD,R4                                                         
         MVI   ELCODE,TAISELQ      GET INTERFACE SUBSIDIARY ELEMENT             
         GOTO1 GETL,DMCB,(1,=AL1(TAISTYPC))                                     
         BNE   *+14                                                             
         L     R4,TGELEM                                                        
         MVC   PRODCLI,TAISCDE     SAVE PRODUCTION CLIENT                       
*                                                                               
         USING TANUD,R4                                                         
         MVI   ELCODE,TANUELQ      GET CLIENT SIGNATORY                         
         GOTO1 GETL,DMCB,(1,=AL1(TANUTSIG))                                     
         BNE   VCP02                                                            
         L     R4,TGELEM           R4=A(TGELEM)                                 
         MVC   ELTANUSC,0(R4)                                                   
*                                                                               
VCP02    MVC   PRODPRD,TGPRD       INIT PROD. PRODUCT TO BE TAL PRODUCT         
*                                                                               
         NI    LCLSTAT9,X'FF'-CLIBRATE                                          
         TM    TGSYSTAT,TASYSBRT                                                
         BZ    VCP03                                                            
         L     R4,AIO                                                           
         MVI   ELCODE,TARAELQ      IF CLIENT HAS BRATE ATTACHED                 
         BRAS  RE,GETEL                                                         
         JNE   *+8                                                              
         OI    LCLSTAT9,CLIBRATE   SET STATUS                                   
*                                                                               
         USING TANUD,R4                                                         
VCP03    XC    PPACPCT,PPACPCT     IF CLIENT HAS PRODUCTIONS PLUS               
         MVI   ELCODE,TANUELQ      AGENCY COMMISSION                            
         GOTO1 GETL,DMCB,(1,=AL1(TANUTPAC))                                     
         BNE   VCP04                                                            
         L     R4,TGELEM                                                        
         MVC   PPACPCT,TANUOVAM    SAVE PERCENTAGE                              
         DROP  R4                                                               
*                                                                               
VCP04    OC    TGPRD,TGPRD                    IF WE HAVE PRODUCT                
         BZ    VCPX                                                             
         GOTO1 RECVAL,DMCB,TLPRCDQ,(X'A0',0)  GET RECORD                        
         SPACE 1                                                                
         USING TAISD,R4                                                         
         MVI   ELCODE,TAISELQ      GET INTERFACE SUBSIDIARY ELEMENT             
         GOTO1 GETL,DMCB,(1,=AL1(TAISTYPP))                                     
         BNE   *+14                                                             
         L     R4,TGELEM                                                        
         MVC   PRODPRD,TAISCDE     SAVE PRODUCTION PRODUCT                      
         SPACE 1                                                                
VCPX     BAS   RE,DISPCLPR         DISPLAY CLIENT/PRODUCT CODE                  
         OI    PAYCLPRH+6,X'80'                                                 
         B     XIT                                                              
         EJECT                                                                  
*              ROUTINE TO VALIDATE INVOICE NUMBER                               
         SPACE 1                                                                
VVALINV  DS    0H                                                               
         NI    LCLSTAT8,ALL-VINVNFND-VINVPAID                                   
         LA    R2,PAYINVH                                                       
         TM    4(R2),X'20'         TEST PREVIOUSLY VALIDATED                    
         BO    VINV100                                                          
         SPACE                                                                  
         XC    DSPLYINV,DSPLYINV   CLEAR IN CASE NO INPUT                       
         NI    LCLSTAT3,ALL-SPLIT                                               
*                                                                               
         LH    RE,DSPOPTS                                                       
         LTR   RE,RE               IF OPTIONS FIELD EXISTS                      
         BZ    VINV00              CLEAR BOVER INDICATOR                        
         AR    RE,RA                                                            
         ZIC   RF,0(RE)                                                         
         AR    RE,RF                                                            
         XC    8(7,RE),8(RE)                                                    
         OI    6(RE),X'80'                                                      
*                                                                               
VINV00   CLI   KFLDCHA,0                                                        
         BE    *+8                                                              
         MVI   SEQSTAT,0                                                        
         SPACE                                                                  
         USING WEBREQD,RE                                                       
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         BZ    VINV0                                                            
         L     RE,TGAFAREQ                                                      
         OC    WBPYSI1,WBPYSI1     AND INVOICE WILL BE SPLIT                    
         BZ    *+8                                                              
         OI    LCLSTAT3,SPLIT      SET FOR SPLIT BILL                           
         SPACE                                                                  
         TM    PAYMODE,DRAFT       IF IN NON-DRAFT MODE                         
         BO    VINV31                                                           
         OC    WBPYINV,WBPYINV     AND INVOICE IS PROVIDED                      
         BZ    VINV31                                                           
         B     VINV4               GO READ INVOICE RECORD                       
         DROP  RE                                                               
         SPACE 1                                                                
VINV0    CLI   TGUSEQU,UEVE        IF USE IS EVENT                              
         JE    VINV4               INVOICE IS REQUIRED                          
         SPACE 1                                                                
         CLI   TGCTSTTY,TASTTYPC   OR IF CONNECT STAFF TYPE IS CLIENT           
         BE    VINV1                                                            
         CLI   TGCTSTTY,TASTTYPF                                                
         BNE   VINV2                                                            
VINV1    CLI   5(R2),0             TEST FOR INPUT                               
         BE    VINV31                                                           
         SPACE                                                                  
VINV2    CLI   TGCTSTTY,TASTTYPD   IF STAFF TYPE IS CLIENT - DRAFT ONLY         
         BNE   VINV3                                                            
         CLI   5(R2),0             IF NO INPUT                                  
         BNE   VINV3                                                            
         MVC   8(6,R2),=CL6'DRAFT' DEFAULT TO DRAFT                             
         OI    6(R2),X'80'                                                      
         MVC   DSPLYINV,8(R2)                                                   
         B     VINV5                                                            
         SPACE                                                                  
VINV3    BAS   RE,PROADVI          PROCESS ADVICE'S INVOICE INFO                
         SPACE                                                                  
VINV4    GOTO1 ANY                 FIELD IS REQUIRED FOR ALL OTHERS             
         MVC   DSPLYINV,WORK       (SAVE IT)                                    
         SPACE 1                                                                
         NI    PAYMODE,ALL-DRAFT                                                
         ZIC   R1,5(R2)                                                         
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         CLC   WORK(0),=CL6'DRAFT' ALLOW 'DRAFT' PAYMENTS                       
         BNE   VINV6                                                            
         CLI   TGUSEQU,UEVE        UNLESS USE IS EVENT                          
         JE    NODRFT                                                           
VINV5    OI    PAYMODE,DRAFT                                                    
         B     VINVX               XIT IF DRAFT                                 
         SPACE 1                                                                
VINV6    TM    TGCTSTST,TGCTSCLI   IF CLIENT, ONLY DRAFT INPUT ALLOWED          
         BO    FLDINV                                                           
         SPACE 1                                                                
         GOTO1 TINVCON,DMCB,8(R2),INVNO,DATCON  CVT TO INTERNAL FORMAT          
         CLI   0(R1),X'FF'                                                      
         BE    FLDINV                                                           
         MVC   TGINV,INVNO         MOVE TO GLOBAL STORAGE                       
         XC    TGINV,HEXFFS        AND COMPLEMENT IT                            
         MVC   SCRINVNO,INVNO      SAVE FOR SCREEN RECORDS                      
         SPACE 1                                                                
         BRAS  RE,CHKEVETS         ENSURE ALL EVE TIMESHEETS COMPLETE           
         SPACE 1                                                                
         GOTO1 RECVAL,DMCB,TLINCDQ,(X'A2',0)  RECORD SHOULD EXIST               
         BNE   RECNTFND                                                         
         SPACE 1                                                                
         L     R4,AIO                                                           
         MVI   ELCODE,TARAELQ      IF INVOICE HAS BOVER ELEMENT                 
         BAS   RE,GETEL            DISPLAY BOVER INDICATOR                      
         BNE   VINV10                                                           
         LH    RE,DSPOPTS                                                       
         LTR   RE,RE                                                            
         BZ    VINV10                                                           
         AR    RE,RA                                                            
         ZIC   RF,0(RE)                                                         
         AR    RE,RF                                                            
         MVC   8(5,RE),=C'BOVER'                                                
         SPACE 1                                                                
VINV10   TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         BO    VINV30              SKIP AHEAD                                   
         SPACE 1                                                                
         MVI   ELCODE,TAINELQ      GET INVOICE STATUS EL.                       
         L     R4,AIO                                                           
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING TAIND,R4                                                         
         TM    TAINSTAT,TAINSPAY   INSURE INVOICE HASN'T BEEN PAID              
         BO    INVERR                                                           
         TM    TAINSTA2,TAINSPRM   IF PRIMARY INVOICE                           
         BZ    *+8                                                              
         OI    LCLSTAT3,SPLIT      SET BIT FOR SPLIT BILL                       
         DROP  R4                                                               
         SPACE 1                                                                
         BAS   RE,PROINVA          PROCESS INVOICE'S ADVICE INFO                
         SPACE 1                                                                
         TM    TGFASTAT,TGFROMFA   IF PAYMENT IS NOT COMING FROM WEB            
         BO    VINV30                                                           
         CLI   TGUSEQU,UEVE        AND IS NOT AN EVENT PAYMENT                  
         BE    VINV30                                                           
         OC    LASTINV,LASTINV                                                  
         BZ    VINV30                                                           
         GOTO1 TINVCON,DMCB,LASTINV,TGDUB,DATCON                                
         CLI   0(R1),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'00'                                                            
         XC    TGDUB(6),HEXFFS                                                  
         CLC   TGINV,TGDUB         INVOICE NUMBER BEING PAID                    
         BL    VINV30              SHOULD BE HIGHEST FOR THIS CYCLE             
         TM    SEQSTAT,SSLATOK     IF NOT, BUT OK PFKEY PREVIOUSLY              
         BO    VINV30              HIT THEN IT'S OK                             
         TM    SEQSTAT,SSLATCHK    IF MESSAGE NOT GIVEN YET,                    
         BZ    OUTOFSEQ            GIVE IT NOW                                  
         CLI   PFAID,21            IF PF21 HAS BEEN HIT TO SAY                  
         BNE   OUTOFSEQ            IT'S OK THEN IT'S OK                         
         MVI   PFAID,0                                                          
         SPACE 1                                                                
VINV30   MVI   SEQSTAT,SSLATOK                                                  
         GOTO1 DELSCRS             DELETE ANY EXISTING SCREEN RECORDS           
         B     VINVX                                                            
         SPACE 1                                                                
VINV31   MVC   SCRINVNO(3),TGTODAY1  BUILD DUMMY INV NUM FOR SCRN RECS          
         TIME  DEC                                                              
         STCM  R0,14,SCRINVNO+3                                                 
         SPACE 1                                                                
VINVX    OI    4(R2),X'20'                                                      
         OI    KFLDCHA,KIN         SET INVOICE CHANGED                          
         SPACE 1                                                                
         BRAS  RE,PROINVE          PROCESS INVOICE'S EVENT INFO                 
         B     XIT                                                              
         SPACE 1                                                                
VINV100  TM    PAYMODE,DRAFT       IF FIELD IS ALREADY VALIDATED                
         JO    XIT                 AND THIS IS NOT A DRAFT PAYMENT              
         TM    TGFASTAT,TGFROMFA   AND NOT A WEB PAYMENT                        
         JO    XIT                                                              
         CLI   5(R2),0             AND FIELD IS POPULATED                       
         JE    XIT                                                              
         GOTO1 RECVAL,DMCB,TLINCDQ,(X'A2',0)  RECORD SHOULD EXIST               
         BE    VINV110                                                          
         OI    LCLSTAT8,VINVNFND                                                
         B     XIT                                                              
                                                                                
         USING TAIND,R4                                                         
VINV110  L     R4,AIO                                                           
         MVI   ELCODE,TAINELQ      GET INVOICE STATUS EL.                       
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         TM    TAINSTAT,TAINSPAY   ENSURE INVOICE STILL HASN'T                  
         BZ    XIT                 BEEN PAID                                    
         OI    LCLSTAT8,VINVPAID                                                
         B     XIT                                                              
         DROP  R4                                                               
         EJECT                                                                  
*              PROCESS INVOICE'S ADVICE INFORMATION                             
PROINVA  NTR1                                                                   
         USING TAAID,R4                                                         
         MVI   ELCODE,TAAIELQ       GET ADVICE/INVOICE ASSIGN EL.               
         L     R4,AIO                                                           
         BAS   RE,GETEL                                                         
         BNE   PIAX                                                             
         SPACE 1                                                                
         XR    R3,R3                                                            
         SPACE 1                                                                
         LA    R2,PAYCIDH           IF FOUND                                    
         CLI   5(R2),0              AND IF COMMERCIAL NOT INPUTTED              
         BNE   PIA10                FILL IN COMMERCIAL FIELD                    
         MVC   8(L'TAAIACID,R2),TAAIACID                                        
         MVI   5(R2),L'TAAIACID                                                 
         OI    6(R2),X'80'                                                      
         AHI   R3,1                                                             
         SPACE 1                                                                
PIA10    LH    R2,DSPAUTH           AND IF NO INPUT IN AUTH/PO FIELD            
         LTR   R2,R2                INPUT THE ADVICE NUMBER                     
         BZ    PIAX                                                             
         AR    R2,RA                                                            
         CLI   5(R2),0                                                          
         BNE   PIA20                                                            
         MVC   8(2,R2),=C'A='                                                   
         MVC   10(L'TAAIAADV,R2),TAAIAADV                                       
         MVI   5(R2),L'TAAIAADV+2                                               
         OI    6(R2),X'80'                                                      
         AHI   R3,1                                                             
         SPACE 1                                                                
PIA20    OC    PAYCID,SPACES        IF ADVICE/INVOICE ASSIGN EL. FOUND          
         CLC   PAYCID,TAAIACID      INPUTTED COMM'L MUST MATCH ADVICE           
         BE    PIA25                                                            
         LH    RE,DSPEST            UNLESS OVERRIDE COMMERCIAL                  
         LTR   RE,RE                SPECIFIED IN ESTIMATE FIELD                 
         BZ    AICOMERR                                                         
         A     RE,ATWA                                                          
         CLC   =C'C=',8(RE)                                                     
         BNE   AICOMERR                                                         
         SPACE 1                                                                
PIA25    CLC   8(2,R2),=C'A='           AND AUTH/PO INPUT MUST START            
         BNE   FLDINV                     WITH A= AND BE FOLLOWED BY            
         OC    10(L'TAAIAADV,R2),SPACES        CORRECT ADVICE NUMBER            
         CLC   10(L'TAAIAADV,R2),TAAIAADV                                       
         BNE   AIADVERR                                                         
         SPACE 1                                                                
         GOTO1 UNITEST,DMCB,TGUSXUNS,AFM,0,0,0                                  
         BZ    PIA30                                                            
         CLI   TAAIAPTY,TAAIAREU    ENSURE THAT USE TYPE (REUSE/                
         BE    PIA40                MUSIC) IS SAME FOR INVOICE                  
         B     AIUSEERR             AND CURRENT PAYMENT TYPE                    
PIA30    CLI   TAAIAPTY,TAAIAMUS                                                
         BNE   AIUSEERR                                                         
         DROP  R4                                                               
         SPACE 1                                                                
PIA40    LTR   R3,R3                IF ADV OR COM'L WAS INSERTED                
         BNZ   ADVPAUSE             PAUSE FOR USER TO SEE IT                    
         SPACE 1                                                                
PIAX     B     XIT                                                              
         EJECT                                                                  
*              PROCESS INVOICE'S ADVICE INFORMATION                             
PROADVI  NTR1                                                                   
         CLI   5(R2),0             IF INVOICE NOT INPUTTED                      
         BNE   PAIX                                                             
         SPACE 1                                                                
         LH    R2,DSPAUTH          AND ADVICE# IS INPUTTED                      
         LTR   R2,R2                                                            
         BZ    PAIX                                                             
         AR    R2,RA                                                            
         CLI   5(R2),0                                                          
         BE    PAIX                                                             
         SPACE 1                                                                
         LA    R3,BLOCK            SET TO SCAN THE FIELD                        
         USING SCAND,R3                                                         
         GOTO1 SCANNER,DMCB,(R2),(X'80',(R3)),C',=,-'                           
         CLI   4(R1),0                                                          
         BE    PAIX                                                             
         CLI   SCLEN2,0                                                         
         BNE   PAIX                                                             
         MVC   TGADV,SCDATA1+2     SAVE ADVICE RECORD CODE                      
         MVC   ERRDISP,SCDISP2                                                  
         DROP  R3                                                               
         SPACE 1                                                                
         GOTO1 VALCOM              VALIDATE COMMERCIAL                          
         SPACE 1                                                                
         GOTO1 RECVAL,DMCB,TLDVCDQ,(X'24',0)                                    
         BNE   FLDINV              GET ADVICE RECORD                            
         SPACE 1                                                                
         USING TAAID,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TAAIELQ       GET ADVICE/INVOICE ASSIGN EL.               
         BAS   RE,GETEL                                                         
         BNE   PAIX                                                             
         SPACE 1                                                                
         MVI   PAYINVH+5,L'TAAIINUM                                             
         OI    PAYINVH+6,X'80'                                                  
         SPACE 1                                                                
         MVC   PAYINV,TAAIINUM                                                  
         GOTO1 UNITEST,DMCB,TGUSXUNS,AFM,0,0,0                                  
         BNZ   ADVPAUSE                                                         
         MVC   PAYINV,SPACES                                                    
         MVC   PAYINV,TAAIINU2                                                  
         B     ADVPAUSE                                                         
         SPACE 1                                                                
PAIX     B     XIT                                                              
         EJECT                                                                  
*              ROUTINES TO VALIDATE MIDDLE FIELDS                               
         SPACE 1                                                                
VVALMID  DS    0H                                                               
         MVI   MFLDCHA,0           CLEAR MIDDLE FIELD CHANGE STATUS             
         TM    PAYMODE,DTLDSPLD    DONE IF DETAIL DISPLAYED                     
         BO    XIT                                                              
         SPACE 1                                                                
         BAS   RE,VALAUTH          VALIDATE AUTH/PO                             
         BRAS  RE,WEBERRS          IF THERE ARE ERRORS THAT TERMINATE           
         BE    XIT                 A WEB TRANSACTION, ABORT NOW                 
         SPACE 1                                                                
         BAS   RE,VALPO            VALIDATE PURCHASE ORDER                      
         BRAS  RE,WEBERRS          IF THERE ARE ERRORS THAT TERMINATE           
         BE    XIT                 A WEB TRANSACTION, ABORT NOW                 
         SPACE 1                                                                
         BAS   RE,VALPD            VALIDATE ESTIMATE PERIOD                     
         SPACE 1                                                                
         BAS   RE,VALCYC           VALIDATE CYCLE DATES                         
         BRAS  RE,WEBERRS          IF THERE ARE ERRORS THAT TERMINATE           
         BE    XIT                 A WEB TRANSACTION, ABORT NOW                 
         SPACE 1                                                                
         BRAS  RE,VALCED           SET/VALIDATE CANADIAN CYCLE DATES            
         BRAS  RE,WEBERRS          IF THERE ARE ERRORS THAT TERMINATE           
         BE    XIT                 A WEB TRANSACTION, ABORT NOW                 
         SPACE 1                                                                
         BAS   RE,VALDTL           VALIDATE DISPLAY CAST DETAILS OPTION         
         BRAS  RE,VALBNP                    BILL-NO-PAYROLL OPTION              
         BRAS  RE,VALCR                     CREDIT OPTION                       
         SPACE 1                                                                
         BAS   RE,VALOPTS          VALIDATE OPTIONS                             
         BRAS  RE,WEBERRS          IF THERE ARE ERRORS THAT TERMINATE           
         BE    XIT                 A WEB TRANSACTION, ABORT NOW                 
         SPACE 1                                                                
         TM    PAYOPTS4,OPNOINT                                                 
         BO    XIT                                                              
         BAS   RE,VALEST           VALIDATE ESTIMATE NUMBER/JOB                 
         B     XIT                                                              
         EJECT                                                                  
*              ROUTINE TO VALIDATE AUTH/PO NUMBER                               
         SPACE 1                                                                
VALAUTH  NTR1                                                                   
         LH    R2,DSPAUTH          R2=DISP. TO FIELD                            
         LTR   R2,R2                                                            
         BZ    XIT                                                              
         AR    R2,RA               R2=A(FIELD)                                  
*                                                                               
         TM    LCLSTAT4,POERR      TEST ERROR PENDING                           
         BZ    VAUTH2                                                           
         NI    1(R2),X'F7'         RETURN FIELD TO NORM INTENSITY               
         OI    6(R2),X'80'                                                      
         TM    4(R2),X'20'         REVALIDATE IF NOT VALID                      
         BZ    VAUTH2                                                           
         CLI   PFAID,20                                                         
         BE    VAUTH1                                                           
         BRAS  RE,INVPO                                                         
******** DC    H'00'                                                            
VAUTH1   NI    LCLSTAT4,ALL-POERR  CLEAR PO ERROR BIT                           
         OI    LCLSTAT4,POOVERR    SET OVERRIDE PO ERROR BIT                    
         B     XIT                                                              
*                                                                               
VAUTH2   TM    4(R2),X'20'                                                      
         BO    XIT                                                              
         NI    LCLSTAT4,ALL-POERR-POOVERR      CLEAR PO VALIDATION BITS         
         CLI   5(R2),0             TEST FOR INPUT                               
         BNE   VAUTH4                                                           
         TM    PAYMODE,DRAFT       NEVER REQUIRED IF DRAFT                      
         BZ    VAUTH3                                                           
         TM    TGFASTAT,TGFROMFA   UNLESS PAYMENT COMING FROM WEB               
         BZ    XIT                                                              
VAUTH3   TM    AGYSTAT4,TAAYPOV    TEST PO VALIDATION FOR AGENCY                
         BNO   VAUTH3A                                                          
         BRAS  RE,AUTHRQ                                                        
         B     XIT                                                              
VAUTH3A  TM    AGYSTAT,TAAYSAPO    TEST AUTH/PO REQUIRED FOR AGENCY             
         BNO   VAUTH4                                                           
         BRAS  RE,AUTHRQ                                                        
         B     XIT                                                              
*                                                                               
VAUTH4   TM    AGYSTAT4,TAAYPOV    TEST PO VALIDATION FOR AGENCY                
         BZ    VAUTH9                                                           
         MVC   AIO,AIO3                                                         
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING TLPUD,R4                                                         
         MVI   TLPUCD,TLPUCDQ                                                   
         MVI   TLPUSCD,TLPUSCDQ                                                 
         MVC   TLPUAGY,=CL6'OMNY  '                                             
         MVC   TLPUPO,=CL15'000000000000000'                                    
         SR    R1,R1                                                            
         IC    R1,5(R2)                                                         
         LA    RF,10                                                            
         SR    RF,R1                                                            
         BCTR  R1,0                                                             
         LA    RF,TLPUPO(RF)                                                    
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RF),8(R2)                                                    
*                                                                               
         MVC   8(L'TLPUPO,R2),TLPUPO                                            
         MVI   5(R2),L'TLPUPO                                                   
         OI    6(R2),X'80'                                                      
         GOTO1 HIGH                                                             
         CLC   KEY(L'TLPUKEY),KEYSAVE                                           
         BE    VAUTH8                                                           
         BRAS  RE,INVPO                                                         
         BNE   XIT                                                              
         OI    LCLSTAT4,POOVERR    SET OVERRIDE PO ERROR BIT                    
VAUTH8   MVC   AIO,AIO1            RESTORE AIO                                  
*                                                                               
VAUTH9   OI    4(R2),X'20'         SET PREVIOUSLY VALIDATED                     
         OI    MFLDCHA,MAUTH       SET AUTH/PO CHANGED                          
         B     XIT                                                              
         EJECT                                                                  
*              ROUTINE TO VALIDATE ESTIMATE NUMBER/PRODUCTION JOB               
*                                                                               
VALEST   NTR1                                                                   
         LH    R2,DSPEST           R2=DISP. TO FIELD                            
         LTR   R2,R2                                                            
         BZ    XIT                                                              
         AR    R2,RA               R2=A(FIELD)                                  
*                                                                               
         TM    LCLSTAT3,SPLIT      TEST THIS INV WILL BE SPLIT BILL             
         BZ    VEST050                                                          
         NI    1(R2),X'F7'         RETURN FIELD TO NORMAL INTENSITY             
         OI    6(R2),X'80'                                                      
         CLI   5(R2),0             IT THERE'S INPUT                             
         BE    VEST010                                                          
         CLC   8(5,R2),=C'SPLIT'   ONLY "SPLIT" ALLOWED                         
         BE    VEST030                                                          
         MVC   8(16,R2),=CL16'SPLIT'   DISPLAY "SPLIT" IN THIS FIELD            
         B     NOINPUT                 GIVE ERROR                               
*                                                                               
VEST010  MVC   8(5,R2),=C'SPLIT'   DISPLAY "SPLIT" IN THIS FIELD                
VEST030  NI    4(R2),ALL-X'20'     SET NOT VALIDATED                            
         B     VESTX2              SKIP VALIDATION                              
*                                                                               
VEST050  OC    DEFJOB,DEFJOB       IF AGENCY SET UP WITH DEFAULT JOB            
         BZ    VEST055                                                          
         CLI   5(R2),0                                                          
         BNE   VEST051                                                          
         BRAS  RE,JOBREQ                                                        
         B     VESTX                                                            
VEST051  OC    8(16,R2),SPACES                                                  
         CLC   =CL16'DEFAULT',8(R2)                                             
         BE    VESTX                                                            
         GOTOR VALPJOB,DMCB,8(R2)                                               
         BNE   VEST052                                                          
         CLI   23(R2),C' '                                                      
         BE    VESTX                                                            
VEST052  BRAS  RE,ERPUBJOB                                                      
         B     VESTX                                                            
*                                                                               
VEST055  OC    TGJWBUNT,TGJWBUNT   IF AGENCY USING JWT PROJECT IDS              
         BNZ   VEST065             YES, FORCE ENTRY IN JOB FIELD                
         TM    TGAYSTA7,TAAYSBBD   IF AGENCY IS BBDO JOB AGENCY                 
         BO    VEST065             YES, FORCE ENTRY IN JOB FIELD                
         OC    LENGTHS,LENGTHS     IF ESTIMATE SETUP LENGTHS                    
         BZ    VEST080                                                          
VEST060  TM    AGYSTAT,TAAYSEST    AND AGENCY WANTS VALIDATION                  
         BZ    VESTX                                                            
VEST065  BRAS  RE,VALJOB           VALIDATE ESTIMATE BY JOB RECORDS             
         B     VESTX                                                            
*                                                                               
VEST080  TM    AGYSTAT2,TAAYSNDF   TEST NO DEFAULT JOBS ALLOWED FOR AGY         
         BO    VEST100                                                          
*                                                                               
         TM    LCLSTAT2,JOBERR     TEST ERROR PENDING                           
         BZ    VEST100                                                          
         NI    1(R2),X'F7'         RETURN FIELD TO NORMAL INTENSITY             
         OI    6(R2),X'80'                                                      
         TM    4(R2),X'20'         RE-VALIDATE IF NOT VALID                     
         BZ    VEST130                                                          
*                                                                               
         CLI   PFAID,20            PF20 REQUIRED                                
         BNE   JOBINV                                                           
         NI    LCLSTAT2,ALL-JOBERR CLEAR JOB ERROR BIT                          
         OI    LCLSTAT2,JOBOVRER   SET OVERRODE JOB ERROR BIT                   
         B     VESTX                                                            
*                                                                               
VEST100  TM    4(R2),X'20'         DON'T BOTHER IF PREV. VALIDATED              
         BO    XIT                                                              
VEST130  NI    LCLSTAT2,ALL-JOBERR-JOBOVRER  CLEAR JOB VALIDATION BITS          
*                                                                               
         CLI   5(R2),0             TEST FOR INPUT                               
         BNE   VEST200                                                          
         TM    TGFASTAT,TGFROMFA   ALWAYS REQUIRED IF PAYMENT COMING            
         BO    VEST150             FROM WEB                                     
         TM    PAYMODE,DRAFT       NEVER REQUIRED IF DRAFT                      
         BO    VESTX                                                            
VEST150  CLI   INTER,C'Y'          REQUIRED IF ON INTERFACE                     
         BNE   VEST180                                                          
         BRAS  RE,JOBRQ                                                         
         B     VESTX                                                            
VEST180  TM    AGYSTAT,TAAYSEST    OR IF REQUIRED FOR AGENCY                    
         BNO   VESTX                                                            
         BRAS  RE,JOBRQ                                                         
         B     VESTX                                                            
*                                                                               
VEST200  CLI   INTER,C'Y'          IF ON INTERFACE, MUST VALIDATE JOB           
         BNE   VESTX                                                            
         CLI   5(R2),12            MAXIMUM OF 12 CHARS (CLI/PRD/JOB)            
         BNH   VEST300                                                          
         TM    AGYSTAT2,TAAYSNDF   TEST NO DEFAULT JOBS ALLOWED FOR AGY         
         BNO   VEST250                                                          
         BRAS  RE,JOB12                                                         
         B     XIT                                                              
VEST250  BRAS  RE,JOB12O                                                        
         BNE   XIT                                                              
         OI    LCLSTAT2,JOBOVRER                                                
         B     XIT                                                              
VEST300  MVC   KEY,SPACES          BUILD JOB KEY FOR ACCOUNT FILE               
         MVC   KEY+1(2),=C'SJ'     UNIT/LEDGER                                  
         MVC   KEY+3(12),8(R2)     ASSUME I/P ENTIRE JOB CODE                   
*                                                                               
         CLI   5(R2),6             IF FIELD IS LE 6 CHARS. (JOB ONLY)           
         BH    VEST400                                                          
         MVC   KEY+3(3),PRODCLI    RE-BUILD JOB - PRODUCTION CLIENT             
         MVC   KEY+6(3),PRODPRD                              PRODUCT            
         MVC   KEY+9(6),8(R2)                                JOB                
         MVC   8(12,R2),KEY+3      MOVE TO SCREEN AS WELL                       
         MVI   5(R2),12            SET LENGTH FOR NAMIN                         
         OI    6(R2),X'80'                                                      
*                                                                               
VEST400  OC    KEY+3(12),SPACES    INSURE KEY PADDED WITH SPACES                
*                                                                               
         GOTO1 READACC,DMCB,(X'80',0) READ ACCOUNT FILE                         
         BE    VEST600                                                          
*                                                                               
         CLI   ERROR,NOTFOUND      IF ERROR IS RECORD NOT FOUND                 
         BNE   VEST550                                                          
         TM    AGYSTAT2,TAAYSNDF   AND DEFAULT JOBS ALLOWED FOR AGY             
         BO    VEST500                                                          
         BRAS  RE,JBACCO           GIVE USER A CHANCE TO OVERRIDE               
         BNE   XIT                                                              
         OI    LCLSTAT2,JOBOVRER                                                
         B     XIT                                                              
VEST500  BRAS  RE,JBACC            ELSE, JUST GIVE ERROR                        
         B     XIT                                                              
*                                                                               
VEST550  CLI   ERROR,ERINTER       HANDLE "INTERFACE RECORD NOT                 
         BNE   VEST580             FOUND ERROR"                                 
         BRAS  RE,INTACC                                                        
         B     XIT                                                              
*                                                                               
VEST580  CLI   ERROR,ERSWACC       HANDLE "CAN'T SWITCH TO ACC                  
         BE    *+6                 SYSTEM" ERROR                                
         DC    H'00'                                                            
         BRAS  RE,SWTACC                                                        
         B     XIT                                                              
*                                                                               
VEST600  L     R4,AIO                                                           
         USING ACKEYD,R4                                                        
         TM    ACSTATUS,X'60'      TEST FOR CLOSED/LOCKED                       
         BZ    VEST610                                                          
         BRAS  RE,LCKCLS                                                        
VEST610  TM    TGSYSTA2,TASYSPDJ   IF PROHIBITING DRAFT JOBS                    
         BZ    VESTX                                                            
         L     R4,AIO                                                           
         TM    ACSTATUS,X'08'      TEST FOR DRAFT                               
         BZ    VESTX                                                            
         BRAS  RE,DFTJOB                                                        
         B     XIT                                                              
*                                                                               
VESTX    OI    4(R2),X'20'         SET PREVIOUSLY VALIDATED                     
VESTX2   OI    MFLDCHA,MEST        SET ESTIMATE CHANGED                         
         B     XIT                                                              
         EJECT                                                                  
*              ROUTINE TO VALIDATE PO AGAINST ESTIMATE/JOB                      
         SPACE 1                                                                
VALPO    NTR1                                                                   
         LH    R2,DSPAUTH          R2=DISP. TO FIELD                            
         LTR   R2,R2                                                            
         BZ    XIT                                                              
         AR    R2,RA               R2=A(FIELD)                                  
*                                                                               
         USING ERRENTD,RE                                                       
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         BZ    VPO05                                                            
         L     RE,TGAERTAB                                                      
VPO01    CLI   0(RE),X'FF'                                                      
         BE    VPO05                                                            
         CLI   EEFIELD,D#PYAPO     AND PO ERROR ALREADY                         
         BE    XIT                 ENCOUNTERED, DON'T BOTHER                    
         ZIC   R0,EELEN            LOOKING FOR ANOTHER ONE                      
         AR    RE,R0                                                            
         B     VPO01                                                            
         DROP  RE                                                               
*                                                                               
VPO05    TM    AGYSTAT4,TAAYSCPO   CLOSE THE PO?                                
         BZ    VPOX                NO                                           
*                                                                               
         NI    LCLSTAT4,ALL-POOKAY CLEAR OK BIT                                 
*                                                                               
         XC    KEY,KEY                                                          
         MVI   KEY,ACOKCODQ                                                     
         MVC   KEY+4(6),8(R2)      MOVE IN THE PO NUMBER                        
         GOTO1 READACC,DMCB,(X'80',0) READ ACCOUNT FILE                         
         BE    VPO10                                                            
         BRAS  RE,ACNTFD           NOT THERE, ERROR                             
         B     XIT                                                              
*                                                                               
VPO10    L     R4,AIO                                                           
         USING ACKEYD,R4                                                        
         TM    ACSTATUS,ACORDDEL+ACORDMCH+ACORDPHS                              
         BZ    VPO20                                                            
         BRAS  RE,POCLOS           ORDER MATCHED OR DELETED ALREADY             
         BNE   XIT                                                              
*                                                                               
VPO20    LA    R4,ACRECORD                                                      
         MVI   ELCODE,X'67'        GET ORDER ELEMENT                            
         BAS   RE,FIRSTEL                                                       
         BE    *+6                                                              
         DC    H'0'                                                             
         USING ACORDRD,R4                                                       
         LH    R2,DSPEST           GET THE JOB                                  
         LTR   R2,R2                                                            
         BNZ   VPO30                                                            
         BRAS  RE,POMJOB           JOB MUST BE THERE                            
         B     XIT                                                              
VPO30    AR    R2,RA                                                            
         CLI   5(R2),0                                                          
         BNZ   VPO40                                                            
         BRAS  RE,POMJOB                                                        
         B     XIT                                                              
*                                                                               
VPO40    MVC   WORK(12),SPACES                                                  
         SR    R1,R1                                                            
         ICM   R1,1,5(R2)                                                       
         BZ    VPOX                                                             
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   WORK(0),8(R2)                                                    
         OC    WORK(12),SPACES                                                  
         CLC   ACORJOB+3(12),WORK  IS THIS THE RIGHT JOB?                       
         BE    VPO50                                                            
         BRAS  RE,POJOB            NO                                           
         B     XIT                                                              
VPO50    OI    LCLSTAT4,POOKAY     OKAY TO CLOSE PO                             
*                                                                               
VPOX     B     XIT                                                              
         DROP  R4                                                               
         EJECT                                                                  
*              ROUTINE TO VALIDATE ESTIMATE PERIOD                              
         SPACE 1                                                                
VALPD    NTR1                                                                   
         LH    R2,DSPPD            R2=DISP. TO FIELD                            
         LTR   R2,R2                                                            
         BZ    XIT                                                              
         AR    R2,RA               R2=A(FIELD)                                  
         TM    4(R2),X'20'                                                      
         BO    XIT                                                              
         MVI   ESTPD,0             INITIALIZE                                   
         CLI   5(R2),0                                                          
         BE    XIT                                                              
         GOTO1 VALINUM                                                          
         CLI   ACTUAL,13           MAXIMUM IS 13                                
         BH    FLDINV                                                           
         MVC   ESTPD,ACTUAL                                                     
         OI    4(R2),X'20'         SET PREVIOUSLY VALIDATED                     
         OI    MFLDCHA,MPD         SET ESTIMATE PERIOD CHANGED                  
         B     XIT                                                              
         EJECT                                                                  
*              ROUTINE TO VALIDATE CYCLE DATES                                  
         SPACE 1                                                                
VALCYC   NTR1                                                                   
         LH    R2,DSPCYC           R2=DISP. TO FIELD                            
         LTR   R2,R2                                                            
         BZ    XIT                                                              
         AR    R2,RA               R2=A(FIELD)                                  
         SPACE 1                                                                
         MVI   ERMAPCOD,D#PYCYC                                                 
         BRAS  RE,SETLCYC          SET L'CYCLE (RETS. STRING IN LCYCLE)         
         SPACE 1                                                                
         NI    1(R2),X'F7'         RETURN FIELD TO NORMAL INTENSITY             
         OI    6(R2),X'80'                                                      
         TM    KFLDCHA,KCO         RE-VALIDATE IF COMMERCIAL CHANGED            
         BO    VCYC1A                                                           
         TM    4(R2),X'20'         OR IF IT CHANGED                             
         BZ    VCYC1A                                                           
         TM    LCLSTAT3,WSPTYPCH   OR IF USE TYPE CHANGED                       
         BO    VCYC1A                                                           
         TM    CYCSTAT,CYSTERRS    OR ERROR PENDING                             
         BNZ   VCYC0A                                                           
         TM    CYCSTAT2,CYSTMUPD+CYSTMUPC                                       
         BZ    XIT                 ELSE DON'T BOTHER                            
         SPACE 1                                                                
VCYC0A   TM    CYCSTAT,CYSTEOVR    OVERLAP ERROR PENDING                        
         BZ    VCYC0B                                                           
         CLI   PFAID,21            PFKEY REQUIRED                               
         BNE   OVERLAP                                                          
         NI    CYCSTAT,ALL-CYSTEOVR                                             
         B     VCYC0C                                                           
         SPACE 1                                                                
VCYC0B   TM    CYCSTAT,CYSTECTG    NOT CONTIGUOUS ERROR PENDING                 
         BZ    VCYC0D                                                           
         TM    TGFASTAT,TGFROMFA   DO NOT CHECK IF PAYMENT COMING               
         BO    VCYC0D              FROM WEB                                     
         CLI   PFAID,22            PFKEY REQUIRED                               
         BNE   NOTCONTG                                                         
         NI    CYCSTAT,ALL-CYSTECTG                                             
VCYC0C   OI    CYCSTAT,CYSTOVRE    SET OVERRODE ERROR                           
         B     VCYC9                                                            
         SPACE 1                                                                
VCYC0D   TM    CYCSTAT,CYSTEEND    END DATE WARNING PENDING                     
         BZ    VCYC0E                                                           
         CLI   PFAID,23            PFKEY REQUIRED                               
         BE    VCYC9                                                            
         BRAS  RE,ENDWRN                                                        
         DC    H'00'                                                            
         SPACE 1                                                                
VCYC0E   TM    CYCSTAT2,CYSTMUPD   MUSIC PAYMENT MADE ERROR PENDING             
         BZ    VCYC0F                                                           
         CLI   PFAID,21            PFKEY REQUIRED                               
         BNE   ERMUPAID                                                         
         B     VCYC0C                                                           
         SPACE 1                                                                
VCYC0F   TM    CYCSTAT2,CYSTMUPC   MUSIC OVERLAP ERROR PENDING                  
         BZ    VCYC0G                                                           
         CLI   PFAID,21            PFKEY REQUIRED                               
         BNE   ERMUOVLP                                                         
         B     VCYC0C                                                           
         SPACE 1                                                                
VCYC0G   TM    CYCSTAT,CYSTDHLD    DEALER EARLIER THAN LATEST HF                
         BO    *+6                 PENDING?                                     
         DC    H'00'                                                            
         CLI   PFAID,23            PFKEY REQUIRED                               
         BNE   LATERHF                                                          
         NI    CYCSTAT,ALL-CYSTDHLD                                             
         OI    CYCSTAT,CYSTOVRE    SET OVERRODE ERROR                           
         B     VCYCX0                                                           
         SPACE 1                                                                
VCYC1A   MVI   CYCSTAT,0           CLEAR CYCLE VALIDATION STATUS                
         MVI   CYCSTAT2,0                                                       
         MVI   PAYBYTE,0           AND LOCAL FLAG                               
         SPACE 1                                                                
         TM    TGUSCYCK,OKAUTO     SOME USES ALLOW PGM TO GENERATE CYC          
         BZ    VCYC2                                                            
         CLC   =C'AUT',8(R2)       IF EXPLICITLY INPUT                          
         BE    *+12                                                             
         CLI   5(R2),0             OR IF NO INPUT TO FIELD                      
         BNE   VCYC2                                                            
         BRAS  RE,GENCYC           GENERATE CYCLE DATES                         
         SPACE 1                                                                
VCYC2    TM    TGUSCYCK,OPTCYC     IF CYCLE DATES ARE OPTIONAL                  
         BZ    VCYC2A                                                           
         CLI   5(R2),0                                                          
         BE    VCYCX               SKIP VALIDATION IF NO INPUT                  
         SPACE                                                                  
VCYC2A   CLC   =C'AUT',8(R2)       PERVAL WON'T CATCH BAD 'AUTO'                
         BE    FLDINV                                                           
*                                                                               
         CLI   8(R2),C'*'          IF * INPUT                                   
         BNE   VCYC2C                                                           
         TM    TGUSSTA3,NWKUSE     MUST BE NETWORK USE                          
         BO    *+12                                                             
         TM    TGUSTYST,UPGRADE    OR UPGRADE                                   
         BZ    FLDINV                                                           
         BAS   RE,COPYCYC          COPY CYCLE FROM LAST                         
         BNE   FLDINV                                                           
         SPACE 1                                                                
VCYC2C   GOTO1 ANY                                                              
         XC    TCPCYC,TCPCYC       CLEAR SAVED DATES                            
         XC    ORIGCYCE,ORIGCYCE                                                
         ZIC   R4,5(R2)            R4=L'INPUT FIELD                             
*                                                                               
         USING PERVALD,R3                                                       
VCYC3    LA    R3,BLOCK            R3=A(OUTPUT BLOCK FROM PERVAL)               
         STC   R4,BYTE             PASS INPUT LENGTH                            
         OI    BYTE,X'40'          AND VALIDATE FOR DD/MM                       
         LA    R0,PVINSGLS+PVIN1DYL  SINGLE RETURNED AS SINGLE                  
*                                    AND ADJUSTED END DATE 1 DAY LESS           
*                                                                               
         CLI   TGUSEQU,USTR        IF USE=USTR                                  
         BNE   *+8                                                              
         CLI   TGUSWKS,0           AND CYCLE IS ZERO WEEKS                      
         BNE   *+8                                                              
         LA    R0,PVINSGLO+PVIN1DYL   SINGLE DATE ONLY                          
*                                     AND ADJUSTED END DATE 1 DAY LESS          
*                                                                               
         GOTO1 PERVAL,DMCB,(BYTE,WORK),((R0),(R3))  VALIDATE PERIOD             
*                                                                               
         TM    4(R1),PVRCINV1      TEST START DATE INVALID                      
         BO    EXTDINV                                                          
         TM    4(R1),PVRCINV2      TEST END DATE INVALID                        
         BO    ENDINV                                                           
*                                                                               
         BRAS  RE,VALCYS           VALIDATE CYCLE START DATE                    
         MVC   ORIGCYCE,PVALPEND   SAVE ORIGINALLY CALCULATED CYCLE END         
*                                                                               
         TM    4(R1),PVRCONE       IF BOTH DATES INPUT                          
         BO    VCYC4                                                            
*                                                                               
         CLI   4(R1),PVRCOK           THEN TEST GOOD RETURN CODE                
         BNE   FLDINV                                                           
*                                                                               
         B     VCYC7                                                            
*                                                                               
VCYC4    OC    PVALCSTA,PVALCSTA   ONE DATE INPUT - TEST IT WAS START           
         BZ    VCYC5                                                            
*                                                                               
         USING TACOD,RE                                                         
*                                                                               
         CLI   TGUSEQU,ULFT        IF USE IS NOT LIFT                           
         BNE   VCYC4A              AND COMMERCIAL TYPE IS FOREIGN               
*                                                                               
         LA    RE,ELTACO           CYCLE END DATE IS EXPIRY                     
         CLI   TACOTYPE,CTYFGN                                                  
         BE    VCYC4B                                                           
         DROP  RE                                                               
*                                                                               
VCYC4A   CLI   TGUSWKS,0                         IF L'CYCLE = 0                 
         BNE   VCYC4E                                                           
*                                                                               
         TM    PVALASSM,PVALAED+PVALAEM+PVALAEY  & ASSUME ALL ABOUT END         
         BNO   STRTINV                           IF NOT, INVALID START          
*                                                                               
         CLI   TGUSEQU,UFGR        TEST FGR                                     
         BE    VCYC4B                                                           
         CLI   TGUSEQU,UFGS        OR FGS                                       
         BE    VCYC4B                                                           
         CLI   TGUSEQU,USFR        OR SFR                                       
         BE    VCYC4B                                                           
         CLI   TGUSEQU,USIN        OR SIN                                       
         BE    VCYC4B                                                           
         CLI   TGUSEQU,UINR        OR INR                                       
         BE    VCYC4B                                                           
*                                                                               
         CLI   TGUSEQU,UINS        OR INS                                       
         BE    VCYC4C                                                           
         CLI   TGUSEQU,UIDS        OR IDS                                       
         BE    VCYC4C                                                           
         CLI   TGUSEQU,UDIO        OR DIO                                       
         BE    VCYC4C                                                           
*                                                                               
         CLI   TGUSEQU,UIHM        OR IHM                                       
         BE    VCYC4D                                                           
*                                                                               
         CLI   TGUSEQU,UIVR        OR IVR                                       
         BE    VCYC7                  NO END DATE FOR BUYOUT                    
         CLI   TGUSEQU,USTR        OR STR                                       
         BE    VCYC7                  NO END DATE FOR BUYOUT                    
         CLI   TGUSEQU,URTK        OR RTK                                       
         BE    VCYC7                  NO END DATE NEEDED                        
         CLI   TGUSEQU,UISU        OR ISU                                       
         BE    VCYC7                  NO END DATE NEEDED                        
                                                                                
         B     ENDMISS                                                          
*                                                                               
VCYC4B   BRAS  RE,FGRDATE          SET END DATE FOR FGR, FGS, INR, SIN          
         B     VCYC4D                                                           
*                                                                               
VCYC4C   BRAS  RE,INDDATE          SET END DATE FOR INDUSTRIALS                 
*                                                                               
VCYC4D   OI    CYCSTAT,CYSTAUTO    SET AUTO-COMPUTE SWITCH                      
         B     VCYC7                                                            
*                                                                               
VCYC4E   LA    R1,WORK(R4)         BUMP PAST START                              
         MVI   0(R1),C'-'          SET HYPEN                                    
         MVC   1(5,R1),LCYCLE      SET L'CYCLE IN END DATE                      
         CLI   TGUSEQU,UDOR                                                     
         BNE   VCYC6                                                            
         MVC   5(2,R1),=C'D)'                                                   
         LA    R4,1(R4)                                                         
         B     VCYC6               GO BACK TO PERVAL                            
*                                                                               
VCYC5    CLI   TGUSWKS,0           IF L'CYCLE = 0                               
         BE    STRTMISS            START DATE REQUIRED                          
*                                                                               
         MVC   WORK+20(20),WORK    INPUT END DATE ONLY - SAVE IT                
         MVC   WORK(2),=C'(-'      SET TO SUBTRACT L'CYCLE                      
         MVC   WORK+2(4),LCYCLE+1  MOVE IN L'CYCLE                              
         MVC   WORK+6(20),WORK+20  RESTORE USER'S INPUT                         
*                                                                               
VCYC6    LA    R4,6(R4)            INCREMENT L'INPUT                            
         OI    CYCSTAT,CYSTAUTO    SET AUTO-COMPUTE SWITCH                      
         B     VCYC3               GO BACK TO PERVAL                            
*                                                                               
VCYC7    BRAS  RE,INDATE           SET END DATE FOR INTERNET/NEW MEDIA          
*                                                                               
         CLI   PAYBYTE,C'C'        TEST RETURNING FROM END DATE CHECK           
         BE    VCYC10                                                           
         TM    PVALASSM,X'77'      NO - IF ANY ASSUMPTIONS MADE                 
         BZ    VCYC8                                                            
         MVC   8(17,R2),PVALCPER   RE-DISPLAY GENERATED DATES                   
         OI    6(R2),X'80'                                                      
         MVI   5(R2),17            SIMULATE L'INPUT                             
         SPACE 1                                                                
VCYC8    MVC   TCPCYC,PVALPSTA     SAVE PWOS CYCLE DATES                        
         MVC   DCYCS,PVALCPER      SAVE DISPLAYABLE START DATE                  
         SPACE 1                                                                
         CLI   TGUSEQU,UFGR        TEST FGR USE                                 
         BNE   VCYC8B                                                           
         CLI   TGUSTYP,UFGREXT     IF USETYPE = UFGREXT                         
         BNE   VCYC8B                                                           
         USING TACOD,R4                                                         
         LA    R4,ELTACO                                                        
         CLC   PVALPSTA,TACOEXP    CHK START AFTER EXPIRATION                   
         BNH   EXTDINV             START DATE INVALID FOR EXTENSION             
         SPACE 1                                                                
VCYC8B   BAS   RE,CHKCYC           CHECK DATES BASED ON USAGE HISTORY           
         SPACE 1                                                                
         BRAS  RE,WEBERRS          IF THERE ARE ERRORS THAT TERMINATE           
         BE    VCYCX               A WEB TRANSACTION, ABORT NOW                 
         SPACE 1                                                                
VCYC9    BRAS  RE,CHKMBO           DO SOME SPECIAL MBO CHECKING                 
         SPACE                                                                  
         TM    CYCSTAT,CYSTAUTO    IF AUTO-COMPUTE OFF (USER I/P END)           
         BO    VCYCX                                                            
         CLI   TGUSWKS,0           IF L'CYCLE = 0                               
         BNE   VCYC9B                                                           
         CLI   TGUSEQU,UFGR                                                     
         BE    VCYC9A              SKIP IF NOT FGR                              
         CLI   TGUSEQU,USFR                                                     
         BE    VCYC9A              OF SFR                                       
         CLI   TGUSEQU,UFGS                                                     
         BE    VCYC9A              OR FGS                                       
         CLI   TGUSEQU,USIN                                                     
         BE    VCYC9A              OR SIN                                       
         CLI   TGUSEQU,UINR                                                     
         BNE   VCYCX               OR INR                                       
         SPACE 1                                                                
         USING TACOD,R4                                                         
VCYC9A   LA    R4,ELTACO                                                        
         LA    R3,BLOCK                                                         
         MVC   PVALPEND,TACOEXP    ELSE SET CORRECT END DATE = EXPIRY           
         B     VCYC10              AND CHECK USER INPUT                         
         SPACE 1                                                                
VCYC9B   MVC   WORK,SPACES         GO BACK TO PERVAL TO VERIFY END DATE         
         MVC   WORK(8),DCYCS       SUPPLY START DATE                            
         MVI   WORK+8,C'-'         SET HYPEN (REQUIRED NOW)                     
         MVC   WORK+9(5),LCYCLE    AND L'CYCLE                                  
         LA    R4,14               SET L'INPUT                                  
         MVI   PAYBYTE,C'C'        SET CHECKING DATES                           
         B     VCYC3               GO BACK TO PERVAL                            
         SPACE 1                                                                
VCYC10   TM    CYCSTAT,CYSTEEND                                                 
         BO    VCYC10A                                                          
         CLC   TCPCYCE,PVALPEND    TEST USER END = CALCULATED END               
         BE    VCYCX               WARN USER OF WRONG END DATE                  
         BRAS  RE,ENDWRN                                                        
         B     XIT                                                              
VCYC10A  NI    CYCSTAT,ALL-CYSTEEND                                             
         OI    CYCSTAT,CYSTOVRE    SET OVERRODE ERROR                           
         SPACE                                                                  
VCYCX    CLI   TGUSEQU,UDLR        IF MAKING DEALER PAYMENT                     
         BNE   VCYCX0                                                           
         CLC   TCPCYCS,LSTHFSTD    CYCLE START SHOULD NOT BE EARLIER            
         BL    LATERHF             THAN LATEST HF'S CYCLE START DATE            
         SPACE 1                                                                
VCYCX0   MVC   TGPCYC,TCPCYC       SAVE CYCLE                                   
         SPACE                                                                  
         OI    4(R2),X'20'         SET PREVIOUSLY VALIDATED                     
         OI    MFLDCHA,MCYC        SET CYCLE DATES CHANGED                      
         XC    DUEDATE,DUEDATE     CLEAR DUE DATE (CAUSES RE-CALC)              
         XC    DUEDATE2,DUEDATE2                                                
         XC    SVTAUHEL,SVTAUHEL   CLEAR SVTAUHEL SO WILL RESAVE LATER          
         SPACE                                                                  
         TM    TGUSTYST,UPGRADE    TEST UPGRADE USE TYPE                        
         BZ    VCYCX3                                                           
         CLI   TGUSEQU,ULCB        EXCEPT FOR LCB (DON'T CARE YET)              
         BE    VCYCX1                                                           
         CLI   TGUSEQU,UACB        AND ACB (ALREADY DID IN XVCOM)               
         BE    XIT                                                              
         GOTO1 UPGRVAL,DMCB,TGUSCDE,TGUSTYP LOOK UP UPGRADE TABLE ENTRY         
VCYCX1   XC    HALF,HALF           CLEAR HALF (USED FOR CAST UH)                
         BRAS  RE,GETWUPUH         GET AND SAVE USAGE HIST FOR UPGRADES         
         B     XIT                                                              
         SPACE 1                                                                
VCYCX3   TM    TGUSSTA3,NWKUSE     IF NETWORK USE                               
         BZ    XIT                                                              
         XC    PREVDUE,PREVDUE     CLEAR DUE DATE FOR PREV USES                 
         XC    HALF,HALF           CLEAR HALF (USED FOR CAST UH)                
         BRAS  RE,GETCLAUH         GET USAGE HISTORY FOR CLA                    
         BNE   XIT                                                              
         MVI   ELCODE,TADDELQ      GET DUE DATE ELEMENT                         
         L     R4,AIO                                                           
         BAS   RE,GETEL                                                         
         BNE   XIT                                                              
         USING TADDD,R4                                                         
         MVC   PREVDUE,TADDDATE    SAVE DUE DATE FOR PREV USES                  
         B     XIT                                                              
         EJECT                                                                  
*              ROUTINE COPIES CYCLE DATES FROM USAGE HISTORY ELEMENT            
*              RETURNS CC NOT EQ IF NO ELEMENT, ELSE RETURNS CC EQ              
         SPACE 1                                                                
*                                  R2=A(CYCLE DATES FIELD HEADER)               
         USING TAUHD,R4                                                         
COPYCYC  NTR1                                                                   
         OC    TCTAUHEL,TCTAUHEL   TEST FOR USAGE HISTORY ELEMENT               
         BZ    NO                                                               
         LA    R4,TCTAUHEL                                                      
         OC    TAUHSTRT,TAUHSTRT   TEST FOR START DATE                          
         BZ    NO                                                               
         GOTO1 DATCON,DMCB,(1,TAUHSTRT),(8,8(R2)) DISPLAY IN FIELD              
         MVI   5(R2),8                            SIMULATE L'INPUT              
         OI    6(R2),X'80'                        AND TRANSMIT                  
         B     YES                                                              
         EJECT                                                                  
*              ROUTINE CHECKS CYCLE DATES BASED ON USAGE HISTORY                
         SPACE 1                                                                
CHKCYC   NTR1                                                                   
         TM    TGUSSTAT,SESSION    NO CHECKING FOR SESSIONS                     
         BO    XIT                                                              
         CLI   VERSION,0           OR IF PAYING A VERSION                       
         BE    CCYC1                                                            
         CLI   TGUSEQU,UMUS        AND PAYING MUS USE                           
         BNE   CCYC1                                                            
         CLC   VERSION,UHVERS      AND NOT PAYING SAME VERSION                  
         BNE   XIT                                                              
CCYC1    OC    TCTAUHEL,TCTAUHEL   IF NO PREVIOUS CYCLE                         
         BNZ   CCYC2                                                            
         TM    TGUSSTA2,HLDTYPE                                                 
         BZ    XIT                 SKIP IF NOT HOLDING FEE TYPE                 
         B     CCYC4                                                            
CCYC2    LA    R4,TCTAUHEL         USE PREV CYCLE TO CHECK FOR OVERLAPS         
         USING TAUHD,R4                                                         
         TM    TGUSSTA2,HLDTYPE    SPECIAL TESTS FOR HOLDING FEE TYPES          
         BO    CCYC4                                                            
         CLC   TCPCYCS,TAUHEND                                                  
         BH    CCYCX               STARTS AFTER PREVIOUS END - OK               
         CLC   TCPCYCS,TAUHSTRT                                                 
         BE    CCYC3               DOESN'T START ON SAME DAY - ERROR            
         BRAS  RE,EROVLAP                                                       
         B     CCYCX                                                            
         SPACE 1                                                                
CCYC3    TM    TGUSSTA3,NWKUSE     SAME START - OK FOR NETWORK USE              
         BO    CCYCX                                                            
         TM    TGUSTYST,UPGRADE    AND UPGRADES                                 
         BO    CCYCX                                                            
         BRAS  RE,EROVLAP          ELSE ERROR                                   
         SPACE 1                                                                
CCYC4    TM    TGFASTAT,TGFROMFA   IF PAYMENT IS COMING FROM WEB                
         BO    CCYCX               DON'T CHECK FOR NON-CONTIGUOUS               
         SPACE 1                                                                
         TM    LCLSTAT,FIRSTHLD    IF THIS IS FIRST HLD FOR COMMERCIAL          
         BZ    CCYC6                                                            
         GOTO1 PVAL,DMCB,(1,FSTFXCYC),(C'N',WORK)  START DATE BASED ON          
         CLC   TCPCYCS,WORK+3                      FIRST FIXED CYCLE            
         BNE   NOTCONTG                                                         
         B     CCYCX                                                            
         SPACE 1                                                                
CCYC6    GOTO1 DATCON,DMCB,(1,TAUHEND),WORK  PREVIOUS END DATE                  
         GOTO1 ADDAY,DMCB,WORK,WORK+6,1      PLUS 1 DAY                         
         GOTO1 DATCON,DMCB,WORK+6,(1,WORK)   CONVERT BACK TO PWOS               
         CLC   TCPCYCS,WORK                  SHOULD BE NEW START                
         BNE   NOTCONTG                                                         
         SPACE 1                                                                
CCYCX    B     XIT                                                              
         EJECT                                                                  
*              ROUTINE TO VALIDATE DISPLAY CAST DETAILS OPTION                  
         SPACE 1                                                                
VALDTL   NTR1                                                                   
         LH    R2,DSPDTL           R2=DISP. TO FIELD                            
         LTR   R2,R2                                                            
         BZ    XIT                                                              
         AR    R2,RA               R2=A(FIELD)                                  
         TM    4(R2),X'20'                                                      
         BO    XIT                                                              
         NI    PAYSTAT1,ALL-DETAIL                                              
         SPACE                                                                  
         CLI   5(R2),0             IF NO INPUT                                  
         BE    VDTL3                                                            
         TM    TGUSSTA2,NORATES    OR IF USE TYPE HAS NO RATES                  
         BZ    VDTL5                                                            
VDTL3    MVI   8(R2),C'Y'          MOVE IN Y FOR CAST DETAILS OPTION            
         OI    6(R2),X'80'         TRANSMIT                                     
         B     VDTL7                                                            
         SPACE                                                                  
VDTL5    CLI   8(R2),C'Y'                                                       
         BE    VDTL7                                                            
         CLI   8(R2),C'N'                                                       
         BNE   FLDINV                                                           
         SPACE                                                                  
         USING TACOD,RE                                                         
         LA    RE,ELTACO                                                        
         CLI   TACOCTYP,CCTY04A    IF PAYING ACTRA TYPE 2404A COMM'L            
         BNE   VDTLX                                                            
         TM    TGUSSTAT,SESSION    AND NOT PAYING A SESSION                     
         BO    VDTLX                                                            
         TM    TGUSSTA2,HLDTYPE    OR HOLDING FEE                               
         BO    VDTLX                                                            
         B     FLDINV              MUST PAY WITH DETAIL                         
         DROP  RE                                                               
         SPACE                                                                  
VDTL7    OI    PAYSTAT1,DETAIL                                                  
         SPACE                                                                  
VDTLX    OI    4(R2),X'20'         SET PREVIOUSLY VALIDATED                     
         OI    MFLDCHA,MDTL        SET DETAIL OPTION CHANGED                    
         B     XIT                                                              
         SPACE 3                                                                
*              ROUTINE TO VALIDATE OPTIONS FIELD                                
         SPACE 1                                                                
VALOPTS  NTR1                                                                   
         LH    R2,DSPOPTS          R2=DISP. TO FIELD                            
         LTR   R2,R2                                                            
         BZ    XIT                                                              
         AR    R2,RA               R2=A(FIELD)                                  
         MVI   ERMAPCOD,D#PYOPT                                                 
         TM    MFLDCHA,MCYC        UNLESS CYCLE DATES CHANGED                   
         BO    *+12                                                             
         TM    4(R2),X'20'         DON'T BOTHER IF PREVIOUSLY VALIDATED         
         BO    XIT                                                              
         XC    AGYSCDE,AGYSCDE     CLEAR OUT AGENCY STUDIO CODE                 
         TM    TGUSSTA3,NWKUSE                                                  
         BZ    VOPT1                                                            
         XC    SVTAUHEL,SVTAUHEL   CLEAR SVTAUHEL SO WILL RESAVE LATER          
         XC    HALF,HALF           CLEAR HALF (USED FOR CAST UH)                
         BRAS  RE,GETCLAUH         DO IN CASE ERASED TU,LU OR US OPTION         
         SPACE 1                                                                
VOPT1    XC    PAYOPTS,PAYOPTS                                                  
         MVI   PAYOPTS4,0                                                       
         MVI   PAYOPTS5,0                                                       
         XC    TCOPTS,TCOPTS                                                    
         CLI   5(R2),0                                                          
         BE    VOPTX                                                            
         SPACE 1                                                                
         LA    R3,BLOCK            R3=A(SCAN BLOCK)                             
         USING SCAND,R3                                                         
         GOTO1 SCANNER,DMCB,(R2),(X'80',(R3))                                   
         ZIC   R0,4(R1)                                                         
         LTR   R0,R0               R0=N'OPTIONS INPUT                           
         BZ    FLDINV                                                           
         SPACE 1                                                                
VOPT2    MVC   ERRDISP,SCDISP1     SET DISP. INTO FLD OF LHS FOR ERRORS         
         NI    LCLSTAT5,X'FF'-OPTINERR-OPTRHERR                                 
         SPACE 1                                                                
         LA    R4,OPTTAB           R4=A(OPTION TABLE)                           
         USING OPTD,R4                                                          
VOPT4    CLI   0(R4),X'FF'                                                      
         BE    VOPT9                                                            
         CLC   OPTLHS,SCDATA1      MATCH ON LHS                                 
         BE    *+12                                                             
         LA    R4,OPTNEXT          BUMP TO NEXT TABLE ENTRY                     
         B     VOPT4                                                            
         SPACE 1                                                                
         TM    TGCTSTST,TGCTSCLI   IF CONNECT STAFF TYPE IS CLIENT              
         BZ    *+12                                                             
         TM    OPTSTAT,OPTSCLI     CHECK THAT OPTION VALID FOR CLIENT           
         BZ    VOPT9                                                            
         SPACE                                                                  
         MVC   ERRDISP,SCDISP2     SET DISP. INTO FLD OF RHS FOR ERRORS         
         SPACE 1                                                                
         LH    RF,OPTVAL           RF=DISP. TO VALIDATION ROUTINE               
         AR    RF,RB                                                            
         LA    RE,VOPT8            SET RE FOR COMMON NTR1                       
VOPT6    NTR1                                                                   
         BR    RF                  ** OFF TO VALIDATION ROUTINE **              
         SPACE 1                                                                
VOPT8    BRAS  RE,WEBERRS          IF THERE ARE ERRORS THAT TERMINATE           
         BE    XIT                 A WEB TRANSACTION, ABORT NOW                 
         SPACE 1                                                                
         TM    LCLSTAT5,OPTINERR+OPTRHERR                                       
         BZ    VOPT10                                                           
         B     VOPT9A                                                           
         SPACE                                                                  
VOPT9    OI    LCLSTAT5,OPTINERR                                                
VOPT9A   BRAS  RE,INVOPT                                                        
         SPACE 1                                                                
VOPT10   LA    R3,SCANNEXT         BUMP TO NEXT OPTION INPUT                    
         BCT   R0,VOPT2                                                         
         SPACE 1                                                                
         MVI   ERRDISP,0           CLEAR DISP. INTO FIELD IND.                  
         SPACE 1                                                                
VOPTX    TM    PAYOPTS1,OTAXAMT    IF INPUT T= OPTION                           
         BZ    *+8                                                              
         BAS   RE,VALTXTRA         NEED EXTRA VALIDATION                        
         SPACE 1                                                                
         BRAS  RE,WEBERRS          IF THERE ARE ERRORS THAT TERMINATE           
         BE    XIT                 A WEB TRANSACTION, ABORT NOW                 
         SPACE 1                                                                
         TM    PAYOPTS2,OPRVTUS+OPRVLUS  IF INPUT TU OR LU OPTIONS              
         BZ    *+8                                                              
         BRAS  RE,VALPUS                 NEED EXTRA VALIDATION                  
         SPACE 1                                                                
         BRAS  RE,WEBERRS          IF THERE ARE ERRORS THAT TERMINATE           
         BE    XIT                 A WEB TRANSACTION, ABORT NOW                 
         SPACE 1                                                                
*                                                                               
*        TM    AGYSTAT,TAAYSATX    IF AUTOMATIC CHARGE OF CAN TAXES             
*        BZ    *+8                                                              
*        OI    PAYOPTS1,OCANTAX    SIMULATE C=Y OPTIONS INPUT                   
*                                                                               
         OI    4(R2),X'20'         SET PREVIOUSLY VALIDATED                     
         OI    MFLDCHA,MOPTS       SET OPTIONS FIELD CHANGED                    
         SPACE 1                                                                
         TM    PAYSTAT1,CREDIT     TEST THIS IS A CREDIT PAYMENT                
         BZ    XIT                                                              
         LA    R1,OPTAMTS          R1=A(OPTION AMOUNT OVERRIDES)                
         LA    R0,NOPTAMTS         R0=N'ACCUMS                                  
         BAS   RE,REVSIGN          REVERSE SIGN ON AMOUNTS                      
         B     XIT                                                              
         SPACE 2                                                                
*              ROUTINE REVERSES SIGN OF R0 NUMBER OF AMOUNTS AT R1              
         SPACE 1                                                                
REVSIGN  DS    0H                                                               
REV2     L     RF,0(R1)            CURRENT AMOUNT                               
         LCR   RF,RF               COMPLEMENTED                                 
         ST    RF,0(R1)            IS NEW AMOUNT                                
         SPACE 1                                                                
         LA    R1,4(R1)            BUMP TO NEXT CHECK TOTAL                     
         BCT   R0,REV2                                                          
         BR    RE                                                               
         EJECT                                                                  
*              OPTION VALIDATION ROUTINES                                       
         SPACE 1                                                                
         USING SCAND,R3            R3=A(SCAN BLOCK ENTRY)                       
VALAPP   DS    0H                                                               
         MVC   ERRDISP,SCDISP1     SET DISP. INTO FLD OF LHS                    
*        TM    TGUSXUNI,AFM        IF MUSIC PAYMENT                             
         GOTO1 UNITEST,DMCB,TGUSXUNS,AFM,0,0,0                                  
         BO    VAPP2                                                            
         CLI   TGUSEQU,UMUS                                                     
         BNE   INVOPTUS            INVALID OPTION IF NOT MUS USE                
         SPACE 1                                                                
VAPP2    CLI   TGUSMEDS,PRINT      INVALID OPTION IF PRINT PAYMENT              
         BE    INVOPTUS                                                         
         SPACE 1                                                                
         MVC   ERRDISP,SCDISP2     SET DISP. INTO FLD OF RHS FOR ERRORS         
         CLI   SCDATA2,C'H'        TAKE APPLIED CREDITS (CODE=APPLHLD)          
         BNE   VAPP10                                                           
         CLI   TGMEEQU,RADIO                                                    
         BE    OPTRHINV                                                         
*        TM    TGUSXUNI,AFM                                                     
         GOTO1 UNITEST,DMCB,TGUSXUNS,AFM,0,0,0                                  
         BZ    OPTINV              INVALID IF MUSIC PAYMENT                     
         OI    PAYOPTS1,OAPPLYH                                                 
         OI    TCOPTS,TCOAPPLH                                                  
         B     XIT                                                              
VAPP10   CLI   SCDATA2,C'S'        TAKE APPLIED CREDITS (CODE=APPLSESS)         
         BNE   *+16                                                             
         OI    PAYOPTS2,OAPPLYS                                                 
         OI    TCOPTS,TCOAPPLS                                                  
         B     XIT                                                              
         CLI   SCDATA2,C'N'        DON'T TAKE APPLIED CREDITS                   
         BNE   OPTRHINV                                                         
         OI    PAYOPTS1,ONOAPPLY                                                
         OI    TCOPTS,TCONOAPP                                                  
         B     XIT                                                              
         SPACE 1                                                                
*&&DO                                                                           
VALCAN   DS    0H                                                               
         CLI   SCDATA2,C'Y'        TAKE CANADIAN TAXES                          
         BNE   OPTRHINV                                                         
         TM    AGYSTAT,TAAYSCTX    ONLY IF VALID FOR AGENCY                     
         BNO   OPTINV                                                           
         OI    PAYOPTS1,OCANTAX                                                 
         B     XIT                                                              
*&&                                                                             
VALFIC   DS    0H                                                               
         MVC   ERRDISP,SCDISP1     SET DISP. INTO FLD OF LHS FOR ERRORS         
         CLI   BILLTYPE,TABRTY2    ONLY VALID FOR BILLING TYPE 2                
         BNE   OPTINV                                                           
         MVC   ERRDISP,SCDISP2     SET DISP. INTO FLD OF RHS FOR ERRORS         
         BAS   RE,OPAMTVAL         VALIDATE FICA CREDITS                        
         MVC   OPTFICR,FULL        AND SAVE IN W/S                              
         OI    PAYOPTS2,OFICR                                                   
         B     XIT                                                              
         EJECT                                                                  
*              OPTION VALIDATION ROUTINES  (CONT'D)                             
         SPACE 1                                                                
         USING SCAND,R3            R3=A(SCAN BLOCK ENTRY)                       
         SPACE 1                                                                
VALPNH   DS    0H                                                               
         MVC   ERRDISP,SCDISP1     SET DISP. INTO FLD OF LHS FOR ERRORS         
         CLI   TGUSEQU,USDR                                                     
         BL    *+12                NOT ALLOWED FOR SDR,SDH,SWR,SWH USES         
         CLI   TGUSEQU,USWH                                                     
         BNH   INVOPTUS                                                         
         MVC   ERRDISP,SCDISP2     SET DISP. INTO FLD OF RHS FOR ERRORS         
         BAS   RE,OPAMTVAL         VALIDATE P&H RATE                            
         OC    FULL(2),FULL        INSURE NOT MORE THAN HALFWORD                
         BNZ   OPTAMINV                                                         
         MVC   TCPNHR,FULL+2       AND SAVE IN W/S                              
         OI    TCOPTS,TCOPNHR                                                   
         OI    PAYOPTS1,OPNHR                                                   
         B     XIT                                                              
         SPACE 2                                                                
VALTAX   DS    0H                                                               
         MVC   ERRDISP,SCDISP1     SET DISP. INTO FLD OF LHS FOR ERRORS         
         CLI   BILLTYPE,TABRTY11   NOT ALLOWED IF BILLING TYPE 11               
         BE    OPTTYINV                                                         
*                                                                               
         LA    R4,ELTACO           R4=A(COMM'L DETAILS ELEMENT)                 
         USING TACOD,R4                                                         
         TM    TACOSTAT,TACOSCAN   IF CANADIAN DOLLAR PAYMENT                   
         BO    OPTINV              TAX IS INVALID                               
*                                                                               
*        CLC   EOR,=C'PG '         TAX NOT VALID FOR P&G                        
*        BE    OPTINV                                                           
*                                                                               
         TM    LCLSTAT9,AGYBRATE+CLIBRATE                                       
         BNZ   OPTINV              INVALID IF AGY OR CLI HAS BRATE              
*                                                                               
         MVC   ERRDISP,SCDISP2     SET DISP. INTO FLD OF RHS FOR ERRORS         
         BAS   RE,OPAMTVAL         VALIDATE PAYROLL TAX AMOUNT                  
         MVC   OPTTAX,FULL         AND SAVE IN W/S                              
         OI    PAYOPTS1,OTAXAMT                                                 
         B     XIT                                                              
         SPACE 2                                                                
VALGST   DS    0H                  USED FOR CAN$ PYMTS  **DOESN'T WORK          
         LA    R4,ELTACO           R4=A(COMM'L DETAILS) ** ON CHKS **           
         USING TACOD,R4                                                         
         MVC   ERRDISP,SCDISP1                                                  
**NO-OP  CLI   TACOCTYP,0          COMMERCIAL MUST HAVE AN ACTRA                
**03/08  BE    OPTINV              TYPE                                         
**NO-OP  TM    TACOSTAT,TACOSCAN                                                
**08/01  BZ    OPTINV                                                           
**NO-OP  CLI   TGUNEQU,ACT         UNION MUST BE ACTRA OR UDA                   
**10/02  BE    *+12                                                             
**       CLI   TGUNEQU,UDA                                                      
**       BNE   OPTINV                                                           
         MVC   ERRDISP,SCDISP2     SET DISP. INTO FLD OF RHS FOR ERRORS         
         BAS   RE,OPAMTVAL         VALIDATE GST AMOUNT                          
         MVC   OPTGST,FULL         AND SAVE IN W/S                              
         OI    PAYOPTS1,OGSTAMT                                                 
         B     XIT                                                              
         SPACE 2                                                                
VALURG   DS    0H                                                               
         CLI   SCDATA2,C'Y'        URGENT INVOICE                               
         BNE   OPTRHINV                                                         
         OI    PAYOPTS2,OPURGENT                                                
         B     XIT                                                              
*                                                                               
VALNOI   DS    0H                                                               
         CLI   SCDATA2,C'Y'        NO INTERFACE                                 
         BNE   OPTRHINV                                                         
         OI    PAYOPTS4,OPNOINT                                                 
         B     XIT                                                              
         EJECT                                                                  
*              OPTION VALIDATION ROUTINES  (CONT'D)                             
         SPACE 1                                                                
         USING SCAND,R3            R3=A(SCAN BLOCK ENTRY)                       
         SPACE 1                                                                
VALPTU   DS    0H                  PREVIOUS TOTAL USES PAID                     
         BAS   RE,VALUSEN          VALIDATE USE NUMBER                          
         MVC   OPTPRVTU,SCBIN2+2   AND SAVE IN W/S                              
         OI    PAYOPTS2,OPRVTUS                                                 
         MVC   TGBYTE,SCDISP2      TGBYTE =  DISPL. INTO FLD OF RHS             
         B     XIT                                                              
         SPACE 3                                                                
VALPLU   DS    0H                  PREVIOUS LIFT USES PAID                      
         MVC   ERRDISP,SCDISP1     SET DISP. INTO FLD OF LHS                    
         CLI   HASLIFT,C'Y'                                                     
         BE    VALPL5              ERROR IF COMM'L HAS NO LIFT                  
         CLI   VERSION,0                                                        
         BE    OPTLFTER            OR IF NOT PAYING A VERSION                   
         SPACE                                                                  
VALPL5   BAS   RE,VALUSEN          VALIDATE USE NUMBER                          
         MVC   OPTPRVLU,SCBIN2+2   AND SAVE IN W/S                              
         OI    PAYOPTS2,OPRVLUS                                                 
         MVC   TGBYTE2,SCDISP2     TGBYTE2 =  DISPL. INTO FLD OF RHS            
         B     XIT                                                              
         SPACE 3                                                                
VALNUS   DS    0H                  NUMBER OF USES                               
         BAS   RE,VALUSEN          VALIDATE USE NUMBER                          
         OC    SCBIN2+1(3),SCBIN2+1  DON'T ALLOW ZERO                           
         BZ    OPTAMINV                                                         
         MVC   OPTNUMUS,SCBIN2+2   SAVE IN W/S                                  
         OI    PAYOPTS3,ONUMUSE                                                 
         OI    TCOPTS,TCONUMUS                                                  
         XC    TCTXUSCR,TCTXUSCR                                                
         XC    TCTXULCR,TCTXULCR                                                
         B     XIT                                                              
         SPACE 3                                                                
VALHNW   DS    0H                  H&W ADJUSTMENT AMOUNT                        
         MVC   ERRDISP,SCDISP1     SET DISP. INTO FLD OF LHS                    
         GOTO1 UNITEST,DMCB,TGUSXUNS,AFM,0,0,0                                  
         BO    OPTUSINV            INVALID OPTION IF USE EXCLUDES AFM           
         TM    TGUSSTAT,TAKEHNW                                                 
         BZ    OPTUSINV            OR IF USE DOESN'T TAKE H&W                   
         SPACE                                                                  
         MVC   ERRDISP,SCDISP2     SET DISP. INTO FLD OF RHS                    
         CLI   SCDATA2,C'-'                                                     
         BE    *+12                                                             
         CLI   SCDATA2,C'+'                                                     
         BNE   OPTRHINV                                                         
         BAS   RE,OPAMTVAL         VALIDATE AMOUNT                              
         OC    FULL,FULL                                                        
         BZ    OPTAMINV            DON'T ALLOW 0                                
         MVC   OPTHNW,FULL         SAVE IN W/S                                  
         OI    PAYOPTS3,OHNWADJ                                                 
         B     XIT                                                              
         EJECT                                                                  
*              OPTION VALIDATION ROUTINES  (CONT'D)                             
         SPACE 1                                                                
         USING SCAND,R3            R3=A(SCAN BLOCK ENTRY)                       
         SPACE 1                                                                
VALCCR   DS    0H                                                               
         BAS   RE,OPAMTVAL         VALIDATE CANADIAN CONVERSION RATE            
         OC    FULL(2),FULL        INSURE NOT MORE THAN HALFWORD                
         BNZ   OPTAMINV                                                         
         L     RE,FULL                                                          
         CVD   RE,DUB                                                           
         ZAP   OPTCCR,DUB          SAVE IN W/S                                  
         OI    PAYOPTS3,OCCR                                                    
         B     XIT                                                              
         SPACE 2                                                                
VALGUA   DS    0H                                                               
         CLI   SCDATA2,C'N'        DON'T TAKE GUARANTEE CREDITS                 
         BNE   VALGUA10                                                         
         OI    PAYOPTS1,ONOGUARC                                                
         B     XIT                                                              
*                                                                               
VALGUA10 CLI   SCDATA2,C'E'        OK TO APPLY BASED ON CYCLE END DATE          
         BNE   OPTRHINV                                                         
         OI    PAYOPTS4,OAGRTEND                                                
         B     XIT                                                              
         SPACE 2                                                                
VALHND   DS    0H                                                               
         MVC   ERRDISP,SCDISP1     SET DISP. INTO FLD OF LHS FOR ERRORS         
         TM    LCLSTAT9,AGYBRATE+CLIBRATE                                       
         BNZ   OPTINV              INVALID IF AGY OR CLI HAS BRATE              
*                                                                               
         MVC   ERRDISP,SCDISP2     SET DISP. INTO FLD OF RHS FOR ERRORS         
         BAS   RE,OPAMTVAL         VALIDATE HANDLING AMOUNT                     
******** CLI   BILLTYPE,TABRTY10   IF BILLING TYPE INCLUDES INDIVIDUAL          
******** BNE   VALHND5             HANDLING W/PAYROLL TAXES                     
******** MVC   OPTHANDC,FULL       SAVE IN CORP HANDLING W/S                    
******** OI    PAYOPTS3,OHNDCAMT                                                
******** B     *+10                                                             
VALHND5  MVC   OPTHAND,FULL        ELSE SAVE IN INDIV. HANDLING  W/S            
         OI    PAYOPTS1,OHANDAMT   ALWAYS SET THERE'S HAND AMT OVERRIDE         
         B     XIT                                                              
         SPACE 2                                                                
VALDUM   DS    0H                                                               
         CLI   SCDATA2,C'Y'        DUMMY PAYMENT                                
         BNE   OPTRHINV                                                         
         OI    PAYOPTS3,ODUMMY                                                  
         B     XIT                                                              
         SPACE 2                                                                
VALRET   DS    0H                                                               
         XC    RET4INV,RET4INV                                                  
         CLI   SCLEN2,6            RETROACTIVE, RHS MUST BE 6 CHARS             
         BNE   OPTRHINV                                                         
         MVC   BLOCK(L'SCDATA2),SCDATA2                                         
         BRAS  RE,VRET4INV                                                      
         BNE   OPTRHINV                                                         
*                                                                               
         MVC   RET4INV,BLOCK+10                                                 
         OI    PAYOPTS3,ORETRO                                                  
         TM    TGUSSTA2,APPREUSE                                                
         BZ    XIT                                                              
         OI    TCPAYST2,TCRETRO                                                 
         B     XIT                                                              
         SPACE 2                                                                
VALCOD   DS    0H                                                               
         CLI   SCDATA2,C'Y'        COD INVOICE                                  
         BNE   OPTRHINV                                                         
         OI    PAYOPTS3,OCOD                                                    
         B     XIT                                                              
         EJECT                                                                  
*&&DO                                                                           
*              OPTION VALIDATION ROUTINES  (CONT'D)                             
         SPACE 1                                                                
         USING SCAND,R3            R3=A(SCAN BLOCK ENTRY)                       
         SPACE 1                                                                
VALCSF   DS    0H                                                               
         MVC   ERRDISP,SCDISP1     SET DISP. INTO FLD OF LHS                    
         CLI   TGUSEQU,UBSC        INVALID IF NOT BSC/BSS/OTC                   
         BE    VALCSF5                                                          
         CLI   TGUSEQU,UBSS                                                     
         BE    VALCSF5                                                          
         CLI   TGUSEQU,UOTC                                                     
         BE    VALCSF5                                                          
*                                                                               
         BRAS  RE,VALCSFUS         VALIDATE CSF FOR US INVOICES                 
         BNE   OPTUSINV                                                         
         MVC   ERRDISP,SCDISP2     SET DISP. INTO FLD OF RHS                    
         CLI   SCDATA2,C'Y'        MUST BE Y                                    
         BNE   OPTUSINV                                                         
         OI    PAYOPTS4,TAPDOJPC   SET JPC COMMERCL SERVICE OPTION USED         
         B     XIT                                                              
*                                                                               
VALCSF5  BRAS  RE,CSFMAX           GET MAXIMUM CSF PYMT FROM TABLE              
         BNE   INVOPTUS                                                         
         MVC   ERRDISP,SCDISP2     SET DISP. INTO FLD OF RHS                    
****     TM    SCVAL2,X'80'        IF NOT NUMERIC INPUT                         
****     BO    VALCSF10                                                         
         CLI   SCDATA2,C'Y'        CAN ALSO BE Y                                
         BE    VALCSFX                                                          
VALCSF10 BAS   RE,OPAMTVAL         VALIDATE CSF AMOUNT OVERRIDE                 
         OC    FULL,FULL                                                        
         BZ    AMTINV              DON'T ALLOW ZERO                             
         MVC   OPTCSF$,FULL        SET OPTION AMT OVERRIDE FOR TAPAD            
         TM    LCLSTAT4,MAXOVER    IF CSF MAX WARNING PENDING                   
         BZ    VALCSF11                                                         
         CLI   PFAID,14            IF PF14 WAS PRESSED                          
         BE    VALCSFX             ACCEPT AMOUNT                                
VALCSF11 CLC   SVCSFMAX,OPTCSF$    IF CSF MAX NOT LESS THAN INPUT               
         BNL   *+8                 ACCEPT INPUT                                 
         B     OVERMAX             ELSE GO TO ERROR ROUTINE                     
         SPACE 1                                                                
VALCSFX  NI    LCLSTAT4,ALL-MAXOVER   TURN OFF CSF MAX WARNING BIT              
         OI    PAYOPTS4,OGENCSF    SET CONTRACT SERVICE FEE OPTION USED         
         B     XIT                                                              
*&&                                                                             
         SPACE 2                                                                
VALCRR   DS    0H                                                               
         MVC   ERRDISP,SCDISP1     SET DISP. INTO FLD OF LHS                    
         TM    TGUSSTA3,SOAPUSE                                                 
         BZ    OPTUSINV                                                         
         CLI   TGUSEQU,USOC        INVALID OPTION IF NOT SOC, SDC               
         BL    INVOPTUS            SWC, SPP, SDP OR SWR USE                     
         CLI   TGUSEQU,USWR                                                     
         BH    INVOPTUS                                                         
         SPACE 1                                                                
         MVC   ERRDISP,SCDISP2     SET DISP. INTO FLD OF RHS                    
         CLI   SCDATA2,C'Y'        IF NEW SOC RATE                              
         BNE   VALCRR5                                                          
         CLI   TGUSEQU,USON        INVALID OPTION IF NOT SON USE                
         BE    *+8                                                              
         CLI   TGUSEQU,USOC        INVALID OPTION IF NOT SOC USE                
         BE    *+12                                                             
         CLI   TGUSEQU,USPP        OR SPP USE                                   
         BNE   INVOPTUS                                                         
         MVC   TCSOCR,=H'360'      THEN SET 3.6%                                
         B     VALCRRX             AND EXIT                                     
         SPACE 1                                                                
VALCRR5  BAS   RE,OPAMTVAL         ELSE, CHK VALID USER RR RATE                 
         L     R0,FULL                                                          
         CHI   R0,100              ENSURE NOT LESS THAN 1%                      
         BL    AMTINV                                                           
         CHI   R0,500              NOR GREATER THAN 5%                          
         BH    AMTINV                                                           
         STH   R0,TCSOCR           AND SAVE IN W/S                              
         SPACE 1                                                                
VALCRRX  OI    PAYOPTS4,ONEWSOC                                                 
         OI    TCOPTS,TCNEWSOC                                                  
         B     XIT                                                              
         SPACE 2                                                                
VALFEE   DS    0H                                                               
         MVC   ERRDISP,SCDISP2     SET DISP. INTO FLD OF RHS FOR ERRORS         
         BAS   RE,OPAMTVAL         VALIDATE FEE AMOUNT                          
         MVC   OPTFEE,FULL         AND SAVE IN W/S                              
         B     XIT                                                              
         SPACE 2                                                                
VALEUR   DS    0H                                                               
         CLI   SCDATA2,C'Y'        EURO-BASED PAYMENT                           
         BNE   OPTRHINV                                                         
         OI    PAYOPTS4,OPAYEURO                                                
         OI    PAYOPTS3,OCOD       EUR=Y FORCES PUR=Y                           
         B     XIT                                                              
                                                                                
VALCHA   DS    0H                  VALIDATE CHLOE HANDLING AMOUNT               
         CLI   TGOFF,C'O'          HAS TO BE OFFICE O                           
         BE    *+12                                                             
         CLI   TGOFF,C'Q'          OR Q                                         
         BNE   OPTINV                                                           
         TM    PAYOPTS4,OCHLOEHP   CHECK IF USER ENTERED RATE ALREADY           
         BO    OPTINV              CAN'T HAVE BOTH                              
         BAS   RE,OPAMTVAL         VALIDATE AMOUNT SAVED IN FULL                
         MVC   OPTCHAND,FULL                                                    
         OI    PAYOPTS4,OCHLOEHA                                                
         B     XIT                                                              
                                                                                
VALCPR   DS    0H                  VALIDATE CHLOE HANDLING RATE                 
         CLI   TGOFF,C'O'          HAS TO BE OFFICE O                           
         BE    *+12                                                             
         CLI   TGOFF,C'Q'          OR Q                                         
         BNE   OPTINV                                                           
         TM    PAYOPTS4,OCHLOEHA   CHECK IF USER ENTERED AMOUNT ALREADY         
         BO    OPTINV              CAN'T HAVE BOTH                              
         BAS   RE,OPAMTVAL         VALIDATE RATE SAVED IN FULL                  
         MVC   OPTCHAND,FULL                                                    
         OI    PAYOPTS4,OCHLOEHP                                                
         B     XIT                                                              
                                                                                
VALRG2   DS    0H                                                               
         CLI   SCDATA2,C'Y'        PROCESS IN SECOND REGRESSION RUN             
         BNE   OPTRHINV                                                         
         CLC   TWAAGY,=C'D2'                                                    
         BNE   FLDINV                                                           
         OI    PAYOPTS5,OREG2                                                   
         B     XIT                                                              
                                                                                
VALNHW   DS    0H                                                               
         CLI   SCDATA2,C'Y'        DO NOT PRINT H&W COLUMN                      
         BNE   OPTRHINV                                                         
         OI    PAYOPTS5,TAPDONHW                                                
         B     XIT                                                              
                                                                                
VALASC   DS    0H                                                               
         BRAS  RE,VALXASC                                                       
         BE    XIT                                                              
ERRAGY   MVC   MYMSGNO,=Y(ERAGYNFD)   AGENCY NOT FOUND                          
         B     NTHEEND                                                          
         EJECT                                                                  
*              ROUTINE TO VALIDATE OPTION AMOUNT OVERRIDES                      
         SPACE 1                                                                
         USING SCAND,R3            R3=A(SCAN BLOCK ENTRY)                       
OPAMTVAL NTR1                                                                   
         ZIC   R4,SCLEN2                                                        
         GOTO1 CASHVAL,DMCB,SCDATA2,(R4)                                        
         CLI   0(R1),X'FF'                                                      
         BE    OPTAMINV                                                         
         MVC   FULL,4(R1)          SAVE AMOUNT                                  
         B     XIT                                                              
         SPACE 3                                                                
*              ROUTINE VALIDATES USE NUMBER OPTIONS                             
         SPACE 1                                                                
VALUSEN  DS    0H                                                               
         MVC   ERRDISP,SCDISP1     SET DISP. INTO FLD OF LHS                    
         TM    TGUSSTA3,NWKUSE                                                  
         BZ    OPTUSIN2            INVALID OPTION IF NOT NWK PAYMENT            
         MVC   ERRDISP,SCDISP2     SET DISP. INTO FLD OF RHS FOR ERRORS         
         SPACE 1                                                                
         TM    SCVAL2,X'80'        TEST NUMERIC INPUT                           
         BZ    OPTAMINV                                                         
         CLC   SCBIN2+1(3),=AL3(800)  MAX. INPUT IS 800                         
         BH    OPTAMINV                                                         
         BR    RE                                                               
         SPACE 3                                                                
VALTXTRA DS    0H                  T= OPTION USED                               
         CLI   BILLTYPE,TABRTY1    IF BILLING TYPE 1 OR 20                      
         BE    VALTXT2             SET HAVE OVERRIDE FICA CREDITS               
         CLI   BILLTYPE,TABRTY20                                                
         BE    VALTXT2                                                          
         CLI   BILLTYPE,TABRTY6    IF BILLING TYPE 6,7, OR 8                    
         BE    VALTXT1                                                          
         CLI   BILLTYPE,TABRTY7                                                 
         BE    VALTXT1                                                          
         CLI   BILLTYPE,TABRTY8                                                 
         BE    VALTXT1                                                          
         CLI   BILLTYPE,TABRTY21   OR BILLING TYPE 21                           
         BNE   VALTXT5                                                          
VALTXT1  TM    PAYOPTS1,OHANDAMT   NEED OVERRIDE HANDLING ALSO                  
         BZ    OPTNOHND                                                         
VALTXT2  OI    PAYOPTS2,OFICR      SET HAVE OVERRIDE FICA CREDITS               
         BR    RE                  CAUSE NOT ALLOWED TO INPUT F=                
         SPACE                                                                  
VALTXT5  CLI   BILLTYPE,TABRTY2    IF BILLING TYPE 2                            
         BNER  RE                                                               
         TM    PAYOPTS2,OFICR      NEED OVERRIDE FICA CREDITS ALSO              
         BZ    OPTNOFIC                                                         
         BR    RE                                                               
         EJECT                                                                  
*              ERROR EXITS FOR OPTION VALIDATION ROUTINES                       
         SPACE 1                                                                
OPTINV   TM    TGFASTAT,TGFROMFA                                                
         BZ    FLDINV                                                           
         OI    LCLSTAT5,OPTINERR                                                
         B     XIT                                                              
OPTRHINV TM    TGFASTAT,TGFROMFA                                                
         BZ    FLDINV                                                           
         OI    LCLSTAT5,OPTRHERR                                                
         B     XIT                                                              
OPTAMINV TM    TGFASTAT,TGFROMFA                                                
         BZ    AMTINV                                                           
         OI    LCLSTAT5,OPTRHERR                                                
         B     XIT                                                              
OPTUSINV TM    TGFASTAT,TGFROMFA                                                
         BZ    INVOPTUS                                                         
         OI    LCLSTAT5,OPTINERR                                                
         B     XIT                                                              
OPTUSIN2 TM    TGFASTAT,TGFROMFA                                                
         BZ    INVOPTUS                                                         
         OI    LCLSTAT5,OPTINERR                                                
         B     XIT                                                              
OPTTYINV TM    TGFASTAT,TGFROMFA                                                
         BZ    INVOPTTY                                                         
         OI    LCLSTAT5,OPTINERR                                                
         B     XIT                                                              
OPTLFTER TM    TGFASTAT,TGFROMFA                                                
         BZ    LIFTERR                                                          
         DC    H'00'                                                            
******** OI    LCLSTAT5,OPTINERR                                                
******** B     XIT                                                              
OPTNOHND TM    TGFASTAT,TGFROMFA                                                
         BZ    ERNOHAND                                                         
         OI    LCLSTAT5,OPTINERR                                                
         BR    RE                                                               
OPTNOFIC TM    TGFASTAT,TGFROMFA                                                
         BZ    ERNOFICA                                                         
         OI    LCLSTAT5,OPTINERR                                                
         BR    RE                                                               
         EJECT                                                                  
*              ROUTINE TO GET A CAST MEMBER                                     
         SPACE 1                                                                
*                                  P1, BYTE 0 X'80'=1ST TIME IN                 
VGETCAST DS    0H                                                               
         MVC   PAYBYTE,0(R1)       SAVE PARAMETER BYTE                          
         TM    LCLSTAT3,SOAPRES    IF SOAP RESIDUAL                             
         BZ    GETC0                                                            
         BAS   RE,GETECAST         GET ECAST RECORD USING TSAR BUFFER           
         BE    YES                 RETURN CONDITION CODE                        
         B     NO                                                               
         SPACE 1                                                                
GETC0    TM    PAYSTAT1,CASTSELD   HAS CAST BEEN SELECTED                       
         BZ    GETC2                                                            
         OC    SVCASTKY,SVCASTKY   IF THIS IS VERY FIRST TIME IN                
         BZ    *+12                                                             
         TM    PAYBYTE,X'80'       OR IF CALLER REQUESTING RE-READ              
         BZ    GETC1                                                            
         GOTO1 GETSCRN,DMCB,(X'80',SPAGE),ATIA  RE-READ CURRENT OR 1ST          
         BNE   *+12                                                             
         CLI   GSCRN,SCR96         INSURE IT'S CAST SELECT SCREEN               
         BE    *+6                                                              
         DC    H'0'                MISSING CAST SELECT SCREEN RECORD            
GETC1    B     GETC4                                                            
         SPACE 1                                                                
GETC2    LA    R3,KEY              R3=A(KEY)                                    
         OC    SVCASTKY,SVCASTKY   TEST IF WE STARTED CAST LIST YET             
         BNZ   GETC6                                                            
         NI    LCLSTAT,ALL-MUSONCOM                                             
         NI    LCLSTAT4,ALL-NONACTON-ACTON                                      
         SPACE 1                                                                
         USING TLCAPD,R3                                                        
         CLI   TGUSEQU,UEVE        NO - INITIALIZE CAST KEY                     
         BNE   GETC3                                                            
         TM    TGSYSTA2,TASYSEEN                                                
         BZ    GETC3                                                            
         XC    TLCAPKEY,TLCAPKEY                                                
         MVI   TLCAPCD,TLCANCDQ    CAST RECORD CODE                             
         MVC   TLCANCOM,TGCOM      INTERNAL COMMERCIAL NUMBER                   
         B     GETC3A                                                           
         DROP  R3                                                               
         SPACE 1                                                                
         USING TLCAD,R3                                                         
GETC3    XC    TLCAKEY,TLCAKEY                                                  
         MVI   TLCACD,TLCACDQ      CAST RECORD CODE                             
         MVC   TLCACOM,TGCOM       INTERNAL COMMERCIAL NUMBER                   
GETC3A   GOTO1 HIGH                GET FIRST CAST RECORD                        
         B     GETC10                                                           
         SPACE 1                                                                
GETC4    LA    R3,KEY              R3=A(KEY)                                    
         SPACE 1                                                                
         TM    PAYSTAT1,CASTSELD   IF CAST HAS BEEN SELECTED                    
         BZ    GETC8                                                            
         BAS   RE,GETSEL           GET (FIRST/)NEXT SELECTED KEY                
         BNE   GETC12              NO MORE - RETURN CC NOT EQUAL                
         SPACE                                                                  
         NI    PAYBYTE,ALL-X'80'   TURN OFF FIRST TIME IN INDICATOR             
         B     GETC140                                                          
         SPACE 1                                                                
GETC6    MVC   KEY,SVCASTKY        RE-READ SAVED KEY                            
         GOTO1 HIGH                                                             
         TM    PAYBYTE,X'80'       TEST THIS IS THE ONE WE WANT                 
         BO    GETC10                                                           
         SPACE 1                                                                
GETC8    GOTO1 SEQ                 GET NEXT CAST RECORD                         
         SPACE 1                                                                
GETC10   LHI   RE,TLCASORT-TLCAD-1                                              
         CLI   TGUSEQU,UEVE        NO - INITIALIZE CAST KEY                     
         BNE   GETC11                                                           
         TM    TGSYSTA2,TASYSEEN                                                
         BZ    GETC11                                                           
         LHI   RE,TLCANNAM-TLCAPD-1                                             
GETC11   EX    RE,*+8                                                           
         B     *+10                                                             
         CLC   KEY(0),KEYSAVE      STILL HAVE CAST                              
         BE    GETC140                                                          
GETC12   OI    LCLSTAT,FINISHED    SET FINISHED LIST                            
         B     NO                  RETURN CC NE                                 
         SPACE 1                                                                
GETC140  MVC   SVCASTKY,TLCAKEY    SAVE THIS KEY                                
         SPACE 1                                                                
         TM    PAYOPTS3,ORETRO     IF MANUAL RETRO PAYMENT                      
         JO    GETC145                                                          
         TM    PAYSTAT2,TAPDPCIB   IF CREDIT PAYMENT FOR A PAYMENT              
         JZ    GETC148             WITH SAVED BILLING RATES                     
GETC145  BRAS  RE,CRDCAST          DO SPECIAL CAST SELECT                       
         BE    GETC160                                                          
         B     GETC4                                                            
         SPACE 1                                                                
GETC148  XC    TGCAT,TGCAT                                                      
         CLI   TGUSEQU,UEVE                                                     
         BE    GETC158                                                          
         SPACE 1                                                                
         GOTO1 CATVAL,DMCB,TLCACAT LOOK-UP CATEGORY CODE                        
         BNE   GETC4                                                            
GETC149  TM    TGUSSTAT,SESSION    IF THIS IS A SESSION                         
         BZ    GETC150                                                          
         TM    TGUSXCAT,EXTRA      AND EXTRAS NOT EXCLUDED                      
         BO    GETC150                                                          
         TM    TGCATYPE,EXTRA      ALWAYS ALLOW EXTRAS (FOR PPF & CNL)          
         BO    GETC153                                                          
GETC150  MVC   BYTE,TGUSXCAT       TEST THIS CATEGORY EXCLUDED FROM USE         
         NC    BYTE,TGCATYPE                                                    
         BNZ   GETC4               YES - GET NEXT                               
*                                                                               
GETC153  CLI   TGUSEQU,UINS        INS ONLY TAKES ON-CAMERA PERFORMERS          
         BNE   GETC155                                                          
         TM    TLCASORT,X'08'      OFF CAMERA?                                  
         BO    GETC4               SKIP IT                                      
*                                                                               
GETC155  CLI   TGUSEQU,UIDS        IDS ONLY TAKES OFF CAMERA PERFORMERS         
         BE    *+8                                                              
         CLI   TGUSEQU,UIVR        SAME FOR UIVR                                
         BNE   GETC158                                                          
         TM    TLCASORT,X'08'      OFF CAMERA?                                  
         BZ    GETC4               TAKE ONLY THOSE                              
*                                                                               
GETC158  BRAS  RE,INDCAST          IF PAYMENT IS INDUSTRIAL                     
         BNE   GETC4               DO SPECIAL CAST SELECT                       
*                                                                               
         TM    PAYSTAT1,CASTSELD   IF CAST SELECTED WE ALREADY HAVE REC         
         BO    GETC160                                                          
         GOTO1 GETREC              GET THE RECORD                               
         SPACE 1                                                                
         BRAS  RE,WEBCAST          IF PAYMENT IS COMING FROM NON-CERNO          
         BNE   GETC4               WEB, DO SPECIAL CAST SELECT                  
         SPACE 1                                                                
         BRAS  RE,CRNOCAST         IF PAYMENT IS COMING FROM CERNO              
         BNE   GETC4               DO SPECIAL CAST SELECT                       
         SPACE 1                                                                
         BRAS  RE,GRRCAST          IF PAYMENT IS RADIO GUARANTEE                
         BNE   GETC4               DO SPECIAL CAST SELECT                       
         SPACE 1                                                                
         BRAS  RE,CRNOCAST         IF PAYMENT IS COMING FROM CERNO              
GETC160  BAS   RE,GETCDET          GET DETAILS FROM REC                         
         BNE   GETC200                                                          
         SPACE 1                                                                
         BRAS  RE,EVECAST          IF PAYMENT IS EVENT                          
         BNE   GETC4               DO SPECIAL CAST SELECT                       
         SPACE 1                                                                
         BRAS  RE,BLDWBRES         IF PAYMENT IS COMING FROM NON-CERNO          
         B     YES                 WEB, BUILD WEB RESPONSE AREA                 
         SPACE 1                                                                
GETC200  TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB APP               
         JZ    GETC300                                                          
         TM    TGFASTAT,TGCRNOPY   (BUT NOT CERNO)                              
         JZ    GETC4               GO READ NEXT CAST RECORD                     
         SPACE 1                                                                
GETC300  CLI   TGUNEQU,AFM         ELSE IF UNION IS AFM                         
         BNE   GETC4                                                            
*        TM    TGUSXUNI,AFM        AND AFM EXCLUDED FROM USE                    
         GOTO1 UNITEST,DMCB,TGUSXUNS,AFM,0,0,0                                  
         BO    GETC12              ALL DONE (REMAINING CAST ARE AFM)            
         B     GETC4               ELSE GET NEXT CAST MEMBER                    
         EJECT                                                                  
*              ROUTINE TO GET ECAST RECORD                                      
         SPACE                                                                  
GETECAST NTR1                                                                   
         OC    SVCASTKY(2),SVCASTKY IF WE HAVEN'T STARTED CAST LIST YET         
         BNZ   GETEC6                                                           
         NI    LCLSTAT,ALL-MUSONCOM                                             
         MVC   MYTSRNUM,=H'2'      START WITH 2ND RECORD, 1ST IS DUMMY          
         MVI   MYTSACTN,TSAGET     RECORD WITH ALL EPISODES INPUT               
         NI    LCLSTAT4,ALL-NONACTON-ACTON                                      
         B     GETEC9                                                           
         SPACE 1                                                                
GETEC6   MVC   MYTSRNUM,SVCASTKY   RE-READ SAVED RECORD NUMBER                  
         MVI   MYTSACTN,TSAGET                                                  
         TM    PAYBYTE,X'80'       TEST THIS IS THE ONE WE WANT                 
         BO    *+8                                                              
GETEC8   MVI   MYTSACTN,TSANXT                                                  
         SPACE                                                                  
GETEC9   BRAS  RE,CALLTSAR         GET REC, MYTSRNUM GETS SET TO REC #          
         BE    GETEC14             TEST IF FOUND RECORD                         
GETEC12  OI    LCLSTAT,FINISHED    IF NOT, SET FINISHED LIST                    
         B     NO                  RETURN CC NE                                 
         SPACE 1                                                                
GETEC14  MVC   SVCASTKY(2),MYTSRNUM  ELSE SAVE THE RECORD NUMBER READ           
         SPACE 1                                                                
         USING ECASTABD,R3                                                      
         L     R3,TCATSAR          R3=A(TSAR RECORD)                            
         GOTO1 CATVAL,DMCB,ECSTCAT LOOK-UP CATEGORY CODE                        
         BNE   GETEC8                                                           
         SPACE 1                                                                
         MVC   TGSSN,ECSTSSN       SET TG INFO FOR RECVAL                       
         TM    ECSTSTAT,ECSTS2ND   IF CAST FROM 2ND COMM'L                      
         BZ    *+10                                                             
         MVC   TGCOM,COM2          SET TGCOM OF 2ND COMM'L                      
         XC    TGCSORT,TGCSORT                                                  
         MVC   TGCSORT(1),TGCASORT   SET SORT KEY, USE TSAR REC NUM AS          
         MVC   TGCSORT+4(2),MYTSRNUM CAST INPUT SEQ NUM FOR CHKS                
         ZIC   RF,ECSTNEPI           NUMBER OF EPISODES - 1                     
         BCTR  RF,0                                                             
         MHI   RF,EPINUMLN       * L'EACH ENTRY=DISP. TO LAST ENTRY             
         LA    R3,ECSTEPIS(RF)       ADD DISPLACEMENT TO FIRST ENTRY            
         USING EPISD,R3                                                         
         LH    R1,EPINUM           GET LAST EPISODE NUM                         
         CVD   R1,DUB                                                           
         UNPK  TGEPI,DUB+5(3)      SET TGEPI FOR RECVAL                         
         OI    TGEPI+4,X'F0'                                                    
         XC    TGINV,TGINV         CLEAR TGINV FOR RECVAL                       
         SPACE                                                                  
         GOTO1 RECVAL,DMCB,TLECCCDQ,0  READ PASSIVE ECAST KEY                   
         BE    GETEC20                                                          
         LA    R3,KEY              R3=A(KEY)                                    
         USING TLECPD,R3                                                        
         CLC   TGCAT,=C'W  '       IF KEY NOT FOUND, AND IF W CATEGORY          
         BNE   GETEC18                                                          
         CLI   TLECCCAT,C'W'       TAKE ANY CATEGORY THAT STARTS WITH W         
         BNE   GETECDIE                                                         
         CLC   TLECCCAT(2),=C'W2'  BUT NOT W2                                   
         BE    GETECDIE                                                         
         B     GETEC20                                                          
GETEC18  CLC   TGCAT,=C'W2 '       IF W2 CATEGORY                               
         BNE   GETECDIE                                                         
         CLC   TLECCCAT(2),=C'W2'  TAKE ANY CAT THAT STARTS WITH W2             
         BNE   GETECDIE                                                         
GETEC20  GOTO1 GETREC              GET ECAST RECORD                             
         SPACE                                                                  
         MVC   TGINV,INVNO         MOVE INVOICE BACK TO GLOBAL STORAGE          
         XC    TGINV,HEXFFS        AND COMPLEMENT IT                            
         MVC   TGCOM,SVTGCOM       RESET TGCOM                                  
         SPACE                                                                  
         BAS   RE,GETCDET          GET DETAILS FROM REC                         
         BE    YES                 SET CC EQUAL IF NO PROBLEM                   
         CLI   TGUNEQU,AFM         ELSE IF UNION IS AFM                         
         BNE   GETEC8                                                           
*        TM    TGUSXUNI,AFM        AND AFM EXCLUDED FROM USE                    
         GOTO1 UNITEST,DMCB,TGUSXUNS,AFM,0,0,0                                  
         BO    GETEC12             ALL DONE (REMAINING CAST ARE AFM)            
         B     GETEC8              ELSE GET NEXT CAST MEMBER                    
         SPACE 2                                                                
GETECDIE DC    H'0'                DIE IF ECAST REC GOT DELETED                 
         EJECT                                                                  
*              ROUTINE GETS DETAILS FROM CAST OR ECAST RECORD AT AIO            
*              SETS CC NOT EQUAL IF THERE'S A PROBLEM, ELSE SETS CC EQ          
         SPACE                                                                  
GETCDET  NTR1                                                                   
         XC    TCCAST(TCCSTLNQ),TCCAST  INITIALIZE INDIV. CAST AREAS            
         XC    TCCSTBRK,TCCSTBRK                                                
         XC    PYCAST(PYCSTLNQ),PYCAST                                          
         XC    TGUNEQU,TGUNEQU     CLEAR IN CASE PROBLEM WITH UNIVAL            
         XC    TGUNEQUS,TGUNEQUS                                                
         NI    LCLSTAT7,X'FF'-CKPERCYC                                          
         SPACE 1                                                                
         USING ECASTABD,R3                                                      
         TM    LCLSTAT3,SOAPRES    IF USE IS A SOAP RESIDUAL                    
         BZ    GETCD5                                                           
         L     R3,TCATSAR          AFTER INIT INDIV. CAST AREAS ABOVE,          
         MVC   TCNEPIS,ECSTNEPI    SET NUMBER OF EPISODES FOR RATECALC          
         SPACE                                                                  
GETCD5   GOTO1 CASTDET             EXTRACT DETAILS                              
         BNE   NO                  PROBLEM - REJECT                             
         SPACE 1                                                                
         BAS   RE,FILTER           DO SOME FILTERING ON CAST RECORD             
         BE    GETCD10             IF OK, CONTINUE                              
         CLI   TGUNEQU,AFM         ELSE IF UNION IS AFM                         
         BNE   *+8                                                              
         OI    LCLSTAT,MUSONCOM    SET MUSICIANS ON COMMERCIAL                  
         B     NO                  SET CC TO GET NEXT CAST MEMBER               
         SPACE 1                                                                
GETCD10  OC    TGGUA,TGGUA         IF PERFORMER IS ON GUARANTEE                 
         BZ    GETCD19             READ GUARANTEE RECORD INTO AIO2              
         MVC   AIO,AIO2                                                         
         GOTO1 RECVAL,DMCB,TLGUCDQ,(X'24',0)                                    
         BE    *+6                                                              
         DC    H'00'                                                            
         MVC   AIO,AIO1                                                         
                                                                                
         USING TAGUD,R4                                                         
         L     R4,AIO2              GET GUARANTEE DETAILS ELEMENT               
         MVI   ELCODE,TAGUELQ                                                   
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'00'                                                            
                                                                                
         OC    TAGUCOM,TAGUCOM     IF THIS IS LARGE OVERSCALE GUARANTEE         
         JNZ   GETCD11                                                          
         BRAS  RE,EXPGRTCK         CHECK FOR EXPIRING GUARANTEE                 
         BRAS  RE,CHKLGRT          ENSURE GUARANTEE COVERS THIS PAYMENT         
         BRAS  RE,VGRTPAY          AND VALIDATE FOR GRT/PAY                     
         J     GETCD19                                                          
         DROP  R4                                                               
                                                                                
GETCD11  TM    TCINPUT,TCINPRI     IF THIS IS PER CYCLE GUARANTEE               
         BO    GETCD19             BUT NOT A PER CYCLE PAYMENT                  
         XR    R3,R3                                                            
         MVC   TGTHREE,GQSTRT      SAVE PAYMENT CYCLE START                     
                                                                                
         USING TAGCD,R4                                                         
         L     R4,AIO2                                                          
         MVI   ELCODE,TAGCELQ      GET GUARANTEE CYCLE ELEMENTS                 
         BRAS  RE,GETEL                                                         
         J     *+8                                                              
GETCD13  BRAS  RE,NEXTEL                                                        
         JNE   GETCD14                                                          
         CLC   TGTHREE,TAGCEND     MUST BEGIN ON OR BEFORE GUAR END             
         JH    GETCD13                                                          
         CLC   TGTHREE,TAGCSTRT    AND ON OR AFTER GUAR START                   
         JL    GETCD13                                                          
         MVC   GQSTRT,TAGCSTRT     SAVE LAST VALID GUAR CYCLE START             
         AHI   R3,1                                                             
         J     GETCD13                                                          
         DROP  R4                                                               
                                                                                
GETCD14  LTR   R3,R3               IF GUARANTEE CYCLE ELEMENT IS NOT            
         JNZ   GETCD19             FOUND, SET TO CHECK FOR PER CYCLE            
         OI    LCLSTAT7,CKPERCYC   COVERAGE LATER                               
*                                                                               
GETCD19  CLI   TWASCR,SCR96        TEST NOT CALLED FROM CAST SELECT             
         BE    GETCD22                                                          
         TM    PAYMODE,DTLONSCR    IF DETAIL NOT ON SCREEN                      
         BO    GETCD21                                                          
         TM    CASTSTAT,CSTNPAY    AND WE'RE NOT PAYING THIS CAST               
         BZ    GETCD21                                                          
         CLC   TCCAONOF(2),=C'ON'  AND HE'S ON CAMERA                           
         BE    NO                  REJECT AND GET NEXT                          
         SPACE                                                                  
         XC    TCPAY,TCPAY         ELSE GIVE ZERO CHECK                         
         OI    TCINPUT,TCINPAY                                                  
GETCD21  TM    CASTSTAT,CSTGERR    IF BAD GUARANTEE                             
         BZ    GETCD22                                                          
         OI    LCLSTAT2,GUARERR    SET GUARANTEE IN ERROR                       
         OC    GRTERSSN,GRTERSSN                                                
         BNZ   *+10                                                             
         MVC   GRTERSSN,TGSSN      SAVE SS# FOR 1ST ERROR                       
         SPACE 1                                                                
         USING TACAD,R4                                                         
GETCD22  LA    R4,ELTACA                                                        
         TM    TACASTA2,TACASEUR   IF PERFORMER IS BEING PAID                   
         BZ    GETCD22A            IN EUROS                                     
         OI    PAYSTAT2,EURO       SET EURO PAYMENT STATUS                      
         DROP  R4                                                               
         SPACE 1                                                                
GETCD22A GOTO1 W4DET               GET W4 DETAILS                               
         SPACE 1                                                                
         XC    BLOCK(8+16+8),BLOCK SET UP DUMMY FIELD HEADER                    
         MVI   BLOCK,8+16                                                       
         MVC   AIO,AIO3            W4 RECORD IN IO3                             
         GOTO1 CHAROUT,DMCB,(X'80',TASNELQ),BLOCK  GET SHORT NAME               
         MVC   AIO,AIO1            RESTORE DEFAULT I/O AREA                     
         MVC   CASTNAME,BLOCK+8    SAVE NAME IN LOCAL STORAGE                   
         SPACE 1                                                                
         BRAS  RE,SETNTACW         SET N'CHECK WITHHOLDING ELS REQ'D            
         SPACE 1                                                                
         BRAS  RE,CHKDLR           ENSURE DEALER COVERED BY FTRACK/FFC          
         BRAS  RE,CHKPCYC          ENSURE PER CYCLE COVERAGE                    
         BRAS  RE,CHKGRR           ENSURE OVERSCALE GRR HAS BEEN PAID           
         SPACE 1                                                                
         CLI   TGUNEQU,AFT                                                      
         BNE   GETCD23                                                          
         OI    LCLSTAT6,AFTRPAID                                                
         SPACE 1                                                                
GETCD23  GOTO1 GETCAUH             GET CAST UH IF PAYING A VERSION              
*                                                                               
         CLI   HASTIME,C'Y'                                                     
         BNE   *+8                                                              
         BRAS  RE,GETTIME          GET TIMESHEET RECORD IF IT EXISTS            
         B     YES                 ALWAYS RETURN CC EQUAL                       
***IF EVER RETURN CC NOT EQ, MUST REREAD KEY(SVCASTKY) SO CAN DO SEQ***         
         EJECT                                                                  
*              ROUTINE RETURNS NEXT SELECTED CAST KEY                           
         SPACE 1                                                                
         USING MYSELD,R2                                                        
GETSEL   NTR1                                                                   
         L     R2,ATIA             R2=A(CAST SELECT SCREEN)                     
GTSL2    OC    DSPLSEL,DSPLSEL     TEST WE HAVE LAST SELECTION                  
         BZ    GTSL3                                                            
         LH    R4,DSPLSEL          POINT TO IT                                  
         AR    R4,R2                                                            
         TM    PAYBYTE,X'80'       IF THIS IS FIRST TIME IN                     
         BO    GTSL4               START HERE                                   
         B     GTSL6               ELSE BUMP TO NEXT                            
         SPACE 1                                                                
GTSL3    LA    R4,SELFRSTH         R4=A(1ST LINE)                               
         USING SELD,R4                                                          
GTSL4    OC    SELSSN,SELSSN       TEST REACHED END OF LIST                     
         BZ    GTSL8                                                            
         CLI   SELCODEH+5,0        TEST CAST MEMBER SELECTED                    
         BNE   GTSL10                                                           
GTSL6    LA    R4,SELNEXT          BUMP TO NEXT LINE                            
         LA    RF,SELCMNTH                                                      
         CR    R4,RF               TEST PASSED E-O-S                            
         BL    GTSL4                                                            
         SPACE 1                                                                
         XC    DSPLSEL,DSPLSEL                                                  
         GOTO1 GETSCRN,DMCB,(X'40',SPAGE),ATIA  YES-GET NEXT SCREEN REC         
         BNE   GTSL8                                                            
         CLI   GSCRN,SCR96         INSURE IT'S CAST SELECT SCREEN               
         BE    GTSL2                                                            
GTSL8    B     NO                  NO MORE - RETURN CC NOT EQUAL                
         SPACE 1                                                                
GTSL10   LR    R1,R4               FOUND SELECTION - SAVE DISP. TO LINE         
         SR    R1,R2                                                            
         STH   R1,DSPLSEL                                                       
         LA    R3,KEY              R3=A(KEY)                                    
         USING TLCAPD,R3                                                        
         XC    TLCAPKEY,TLCAPKEY   BUILD PASSIVE KEY TO GET RECORD              
         MVI   TLCAPCD,TLCACCDQ    USING COMMERCIALS KEY                        
         MVC   TLCACSSN(3),SELSSN  CRUNCH SELECTED S/S NO. INTO KEY             
         MVC   TLCACSSN+3(2),SELSSN+4                                           
         MVC   TLCACSSN+5(4),SELSSN+7                                           
         GOTO1 SSNUNPK,DMCB,SELSSN,TLCACSSN                                     
GTSL12   MVC   TLCACCOM,TGCOM      INTERNAL COMMERCIAL NUMBER                   
         MVC   TLCACCAT,SELCAT     CATEGORY                                     
         OC    TLCACCAT,SPACES                                                  
         GOTO1 HEXIN,DMCB,SELSEQ,TLCACSEQ,4  SEQUENCE NUMBER                    
         SPACE 1                                                                
         GOTO1 HIGH                GET THE RECORD                               
         CLC   TLCAPKEY,KEYSAVE                                                 
         BE    *+6                                                              
         DC    H'0'                PERFORMER VANISHED                           
         GOTO1 GETREC                                                           
         L     R3,AIO                                                           
         USING TLCAD,R3                                                         
         MVC   KEY(L'TLCAKEY),TLCAKEY  MOVE ACTIVE KEY TO 'KEY'                 
         B     YES                 RETURN CC EQUAL                              
         DROP  R3                                                               
         EJECT                                                                  
*              ROUTINE TO FILTER CAST RECORDS                                   
         SPACE 1                                                                
FILTER   NTR1                                                                   
         CLI   TGUSEQU,UEVE        ANY EMPLOYEE ON AN EVENT THAT                
         BE    YES                 HAS MADE IT THIS FAR IS OK                   
         CLI   TGUSEQU,UBSS        IF MAKING BSS PAYMENT TO                     
         BNE   FILT00                                                           
         TM    TGMEEQU,INTERNET+NEWMEDIA                                        
         BZ    FILT00              INTERNET OR NEW MEDIA COMMERCIAL             
         TM    TGCATYPE,EXTRA      AND PAYING AN EXTRA                          
         BZ    FILT00                                                           
         CLC   TGCAT,=C'EXB'       EXLCUDE ALL EXCEPT EXB                       
         BE    FILT00                                                           
         CLC   TGCAT,=C'HMB'       AND HMB                                      
         BE    FILT00                                                           
         CLC   TGCAT,=C'EXD'       AND EXD                                      
         BNE   NO                                                               
*                                                                               
FILT00   CLI   TGUNEQU,NON         IF UNION NON                                 
         BNE   FILT10                                                           
         MVC   DUB(4),TGCAUNIS                                                  
         XI    DUB,NON                                                          
         MVC   DUB+4(4),TGUSXUNS                                                
         XC    DUB+4(4),=X'FFFFFFFF'                                            
         GOTO1 UNITEST,DMCB,(X'80',DUB),DUB+4                                   
         BZ    NO                                                               
         B     FILT20                                                           
*                                                                               
FILT10   BRAS  RE,FILTDIO          FILTER FOR AUDIO RECORDING SESSION           
         BNE   NO                                                               
*                                                                               
         BRAS  RE,FILTIVR          FILTER FOR INTERACTIVE VOICE                 
         BNE   NO                                                               
*                                                                               
         CLI   TGUSEQU,ULFT        IF USE IS LIFT                               
         BNE   FILT20                                                           
         USING TACOD,R4                                                         
         LA    R4,ELTACO                                                        
         TM    TACOSTAT,TACOSCRT   AND CRATE NOT ON COMMERCIAL                  
         BO    FILT20                                                           
         NI    TGUSXUNI,X'FF'-ACT  MAKE ACTRA A VALID UNION                     
         NI    TGUSXUN1,X'FF'-ACT                                               
         DROP  R4                                                               
         SPACE 1                                                                
         USING TACOD,R4                                                         
FILT20   LA    R4,ELTACO           R4=A(COMM'L DETAILS ELEMENT)                 
         SPACE 1                                                                
         GOTO1 UNITEST,DMCB,(X'80',TGUNEQUS),TGUSXUNS                           
         BNZ   NO                                                               
         SPACE 1                                                                
         CLI   TACOCTYP,CCTY2404   IF ACTRA TYPE IS 2404                        
         BNE   FILT30                                                           
         CLI   TGUNEQU,NON         REJECT NON-UNION PERFORMERS                  
         BE    NO                                                               
         SPACE 1                                                                
FILT30   TM    TACOSTAT,TACOSCAN   IF CANADIAN DOLLAR PAYMENT                   
         BZ    FILT40                                                           
*        TM    TGUNEQU,SAG+AFT+DGA+WGA                                          
         GOTO1 UNITEST,DMCB,TGUNEQUS,SAG+AFT+DGA+WGA,0,0,0                      
         BNZ   NO                  EXCLUDE SAG, AFT, DGA, AND WGA               
         SPACE 1                                                                
FILT40   TM    TGUSSTA2,HLDTYPE    IF PAYING HOLDING FEE                        
         BZ    FILT50                                                           
         CLI   TACOCTYP,CCTY04A    AND COMMERCIAL IS ACTRA TYPE                 
         BE    FILT45              2404A                                        
         CLI   TACOCTYP,CCTY2404   OR 2404                                      
         BNE   FILT50                                                           
FILT45   GOTOR ONCAINV,DMCB,ELTACA REJECT CANADIAN PERFORMERS                   
         BE    NO                                                               
         SPACE 1                                                                
FILT50   CLI   VERSION,0           IF PAYING A VERSION                          
         BE    FILT80                                                           
         CLI   TGUSEQU,UITN                                                     
         BE    FILT80                                                           
         SPACE 1                                                                
         BRAS  RE,TRNTATR                                                       
         BNE   FILT60                                                           
         MVC   KEY,SVCASTKY                                                     
         GOTO1 HIGH                                                             
         SPACE 1                                                                
FILT60   MVI   ELCODE,TAFNELQ      CHECK CAST IS ON THIS VERSION                
         GOTO1 GETL,DMCB,(1,=AL1(TAFNTVER))                                     
         BNE   NO                                                               
         L     R4,TGELEM                                                        
         USING TAFND,R4                                                         
         CLI   TAFNNAME,251        IF ON ALL VERSIONS, OK                       
         BE    FILT80                                                           
         ZIC   R0,TAFNLEN          LENGTH OF ELEM                               
         AHI   R0,-3               - 3 = N'VERS = R0                            
         LA    R1,TAFNNAME         SET R1=A(VERSION FOR CAST)                   
FILT70   CLC   VERSION,0(R1)       SEE IF MATCHES VERSION BEING PAID            
         BE    FILT80                                                           
         LA    R1,1(R1)            BUMP TO NEXT CAST VERSION                    
         BCT   R0,FILT70                                                        
         B     NO                  EXCLUDE IF CAST NOT ON VERSION               
         SPACE                                                                  
FILT80   LA    R4,ELTACA           R4=A(CAST DETAILS ELEMENT)                   
         USING TACAD,R4                                                         
         SPACE 1                                                                
         CLI   TGUSEQU,UVRE        IF PAYING VRE                                
         BE    FILT80A                                                          
         CLI   TGUSEQU,UVNR        OR VRN                                       
         BNE   FILT84                                                           
FILT80A  CLC   TACAYEAR,=C'13 '    EXCLUDE CONTRACT YEARS PRIOR TO 13           
         BL    NO                                                               
*                                                                               
*  ATLEAST ONE VERSION BEING PAID HAS TO BE IN THE CAST VERSION                 
         MVI   ELCODE,TAFNELQ      CHECK CAST IS ON THIS VERSION                
         GOTO1 GETL,DMCB,(1,=AL1(TAFNTVER))                                     
         BNE   NO                                                               
         L     RE,APAYVERS                                                      
         L     R4,TGELEM                                                        
         USING TAFND,R4                                                         
         CLI   TAFNNAME,251        IF ON ALL VERSIONS, OK                       
         BE    FILT84                                                           
FILT81   ZIC   R0,TAFNLEN          LENGTH OF ELEM                               
         AHI   R0,-3               - 3 = N'VERS = R0                            
         LA    R1,TAFNNAME         SET R1=A(VERSION FOR CAST)                   
FILT82   CLC   0(1,RE),0(R1)       SEE IF MATCHES VERSION BEING PAID            
         BE    FILT84                                                           
         LA    R1,1(R1)            BUMP TO NEXT CAST VERSION                    
         BCT   R0,FILT82                                                        
         AHI   RE,1                                                             
         CLI   0(RE),X'FF'                                                      
         BNE   FILT81                                                           
         B     NO                  EXCLUDE IF CAST NOT ON VERSION               
********************                                                            
*                                                                               
*                                                                               
         SPACE 1                                                                
FILT84   LA    R4,ELTACA           R4=A(CAST DETAILS ELEMENT)                   
         USING TACAD,R4                                                         
*                                                                               
*        CLI   TGUSEQU,ULNF        IF MAKING LNF (LATE NIGHT FOX) PYMT          
*        BE    FILT84AB                                                         
         CLI   TGUSEQU,USOM        IF MAKING SOM (SOCIAL MEDIA) PYMT            
         BNE   FILT84AA                                                         
FILT84AB CLI   TGYREQU,CN16        SKIP PERFORMERS FROM EARLIER THAN            
         BL    NO                  CONTRACT YEAR 16                             
*                                                                               
FILT84AA CLI   TGUSEQU,UINU        IF MAKING INU                                
         BE    FILT84A                                                          
         CLI   TGUSEQU,UNMU        OR NMU                                       
         BE    FILT84A                                                          
         CLI   TGUSEQU,USIU        OR SIU                                       
         BE    FILT84A                                                          
         CLI   TGUSEQU,USNU        OR SNU                                       
         BNE   FILT84B                                                          
FILT84A  CLI   TGUSTYP,UINUI4W     4 WEEK PAYMENT                               
         BL    FILT84D                                                          
         CLI   TGYREQU,CN09        SKIP PERFORMERS FROM EARLIER THAN            
         BL    NO                  CONTRACT YEAR 09                             
*                                                                               
FILT84B  CLI   TGUSEQU,UMVI        IF MAKING MVI                                
         BE    FILT84C                                                          
         CLI   TGUSEQU,USMI        OR SMI                                       
         BE    FILT84C                                                          
         CLI   TGUSEQU,UMVN        OR MVN                                       
         BE    FILT84C                                                          
         CLI   TGUSEQU,USMN        OR SMN                                       
         BNE   FILT84D                                                          
FILT84C  CLI   TGUSTYP,UMVII4W     4 WEEK PAYMENT                               
         BL    FILT84D                                                          
         CLI   TGYREQU,CN09        SKIP PERFORMERS FROM EARLIER THAN            
         BL    NO                  CONTRACT YEAR 09                             
*                                                                               
FILT84D  TM    TACASTA3,TACASEQY   IF EQUITY PERFORMER                          
         BZ    FILT85                                                           
         TM    TGUSSTAT,SESSION    INCLUDE IF USE IS A SESSION                  
         BO    FILT85A                                                          
         CLI   TGUSEQU,UALF        OR ADDENDUM LIFT                             
         BE    FILT85A                                                          
         CLI   TGUSEQU,ULFT        OR LIFT                                      
         BE    FILT85A                                                          
         CLI   TGUSEQU,USLF        OR SPANISH LIFT                              
         BE    FILT85A                                                          
         CLI   TGUSEQU,UEQY        OR EQUITY PAYMENT                            
         BNE   NO                                                               
         CLI   TGUNEQU,NON         AND USE IS NOT NON                           
         BE    NO                                                               
         CLI   TGYREQU,CN09        AND CONTRACT YEAR IS 09 OR LATER             
         BNL   FILT85A                                                          
         B     NO                                                               
*                                                                               
FILT85   CLI   TGUSEQU,UEQY        IF USE IS EQUITY                             
         BE    NO                  ONLY EQUITY PERFORMERS ARE ELIGIBLE          
                                                                                
FILT85A  OC    TACALAST,TACALAST   IF THERE'S A LAST SERVICED DATE              
         BZ    FILT86                                                           
         CLC   TCPCYCS,TACALAST    DON'T PAY THE GUY IF CYCLE START             
         BNH   FILT86              IS LATER                                     
         TM    TGFASTAT,TGVITCMP   UNLESS PAYMENT IS A LIFT COMING              
         BZ    NO                  FROM A VITA COMPLETION                       
         CLI   TGUSEQU,ULFT                                                     
         BE    FILT86                                                           
         CLI   TGUSEQU,UALF                                                     
         BE    FILT86                                                           
         CLI   TGUSEQU,USLF                                                     
         BNE   NO                                                               
         SPACE 1                                                                
FILT86   TM    PAYOPTS4,OPAYEURO   IF MAKING PAYMENT IN EUROS                   
         BZ    FILT90                                                           
         TM    TACASTA2,TACASEUR   REJECT ANY US$ AND CAN$ PAID                 
         BO    FILT100             PERFORMERS                                   
         BZ    NO                                                               
         SPACE 1                                                                
FILT90   TM    TACASTA2,TACASEUR   IF NOT MAKING PAYMENT IN EUROS               
         BO    NO                  REJECT ANY EURO-PAID PERFORMERS              
         SPACE 1                                                                
FILT100  CLI   VERSION,0                                                        
         BNE   FILT120                                                          
         SPACE 1                                                                
         CLI   LIFT,C'A'           TEST PAYING ALL ON COMMERCIAL                
         BE    FILT120                                                          
         CLI   LIFT,C'Y'           TEST ENTIRE PAYMENT TO LIFT                  
         BNE   *+16                                                             
         TM    TACASTAT,TACASTLF   MUST BE ON LIFT                              
         BZ    NO                                                               
         B     FILT120                                                          
         SPACE                                                                  
         TM    TGUSSTA2,HLDTYPE    FOR HLD TYPE - PAY ALL                       
         BO    FILT120                                                          
         TM    TGUSSTA3,NWKUSE     ENTIRE PAYMENT TO MAIN                       
         BZ    FILT110                                                          
         CLI   LIFTPAID,C'N'       FOR NWK - TEST NO USES PAID TO LIFT          
         BNE   *+12                                                             
FILT110  TM    TACASTAT,TACASTLO   REJECT IF LFT ONLY                           
         BO    NO                                                               
         SPACE 1                                                                
FILT120  CLI   TGUSEQU,UPPF        IF PPF USE, PAY IT                           
         BE    FILT160                                                          
*                                                                               
         CLC   TACAONOF,=C'OFF'    SKIP IF OFF-CAMERA PERF                      
         BE    FILT130                                                          
*                                                                               
*        ON-CAMERA                                                              
*                                                                               
         CLI   TGUSEQU,USTR        IF STORE CAST USE                            
         BE    NO                     DON'T PAY                                 
         CLI   TGUSEQU,UIVR        IF INTERACTIVE VOICE SESSION USE             
         BE    NO                     DON'T PAY                                 
         CLI   TGUSEQU,UDIO        IF AUDIO RECORDING SESSION USE               
         BE    NO                     DON'T PAY                                 
         B     FILT150                                                          
*                                                                               
*        OFF-CAMERA                                                             
*                                                                               
FILT130  DS    0H                                                               
         CLI   TGUSEQU,UDWN        REJECT IF DWN USE                            
         BE    NO                                                               
         TM    TGUSSTA2,HLDTYPE    FOR HOLDING FEE TYPES                        
         BO    FILT140                                                          
* AS PER TOM, 7/11/2001                                                         
*        CLI   TGUSEQU,UCNL        AND CNL USE                                  
*        BE    FILT140                                                          
         CLI   TGUSEQU,USCN        AND SCN USE                                  
         BE    FILT140                                                          
         CLI   TGUSEQU,UREN        AND REN USE                                  
         BE    FILT140                                                          
         CLI   TGUSEQU,UARN        AND ARN USE                                  
         BE    FILT140                                                          
         CLI   TGUSEQU,USRE        AND SRE USE                                  
         BNE   FILT150                                                          
***      BE    FILT140                                                          
***6/20/96LI   TGUSEQU,UPPF        AND PPF USE                                  
***      BNE   FILT150                                                          
FILT140  TM    TGCATYPE,NOHLDOFF   NO HOLDS IF OFF-CAMERA                       
         BO    NO                                                               
         CLI   TGYREQU,CN88        AS/OF '88 CONTRACT                           
         BL    FILT150                                                          
         TM    TGCATYPE,NHLDOF88   THERE ARE SOME MORE                          
         BO    NO                                                               
         SPACE 1                                                                
FILT150  TM    TGUSSTAT,SESSION    IF THIS ISN'T A SESSION                      
         BO    FILT160                                                          
         TM    TGUSSTA2,HLDTYPE    OR A HOLDING FEE TYPE                        
         BO    *+12                                                             
         TM    TGCATYPE,NOREUSE    EXCLUDE SOME CATEGORIES                      
         BO    NO                                                               
         SPACE 1                                                                
FILT160  TM    TGUSSTAT,SESSION    IF THIS IS NOT A SESSION                     
         BO    FILTX                                                            
         CLI   TGUSEQU,UDWN        AND NOT A DOWNGRADE USE                      
         BE    FILTX                                                            
         L     R4,AIO                                                           
         USING TARLD,R4                                                         
         MVI   ELCODE,TARLELQ      GET CAST RELEASE STATUS ELEMENT              
         BAS   RE,GETEL                                                         
         BNE   FILTX                                                            
         CLI   TARLSTAT,C'A'       SKIP CAST IF RELEASED                        
         BNL   NO                                                               
         DROP  R4                                                               
         SPACE 1                                                                
FILTX    B     YES                                                              
         EJECT                                                                  
*              ROUTINE TO VALIDATE RHS OF DETAIL SCREENS                        
         SPACE 1                                                                
VVALRHS  DS    0H                                                               
         GOTOR AMTVAL,DMCB,DSPAPPL,TCAPPLCR   APPLIED AMOUNT                    
         BNE   VRHS5                                                            
         OI    TCINPUT,TCINAPPL                                                 
* NO-OP  OC    TCAPPLCR,TCAPPLCR   IF AMOUNT=0,                                 
* 1/13/92BZ    VRHS10              DON'T BOTHER WITH APPLIED CODE               
         SPACE 1                                                                
VRHS5    GOTO1 CODEVAL,DMCB,DSPAPPLI,TCAPPLCD  APPLIED CODE                     
         SPACE 1                                                                
         CLI   TGUSEQU,UBSM      IF USE IS MUSIC SESSION                        
         BNE   VRHS10                                                           
         CLI   TCAPPLCD,0                                                       
         BE    VRHS10                                                           
         CLI   TCAPPLCD,C'4'     ONLY VALID APPLIED CODES                       
         BE    VRHS10            ARE 4 AND 5                                    
         LH    R2,DSPAPPLI                                                      
         A     R2,ATHSLINE                                                      
         CLI   TCAPPLCD,C'5'                                                    
         BNE   FLDINV                                                           
         SPACE 1                                                                
VRHS10   CLI   TGUSEQU,UCSS                   IF USE IS CSS                     
         BNE   VRHS11                                                           
         LH    R2,DSPREIMI                                                      
         A     R2,ATHSLINE                                                      
         CLI   5(R2),0                                                          
         BE    VRHS11                                                           
         CLI   8(R2),C'2'                     ONLY 2 AND 4                      
         BE    VRHS11                         ARE VALID REIMB.                  
         CLI   8(R2),C'4'                     EXPENSES CODES                    
         BNE   FLDINV                                                           
         SPACE 1                                                                
VRHS11   CLI   TGUSEQU,URTK                   IF USE IS RTK                     
         BNE   VRHS12                                                           
         LH    R2,DSPREIMI                                                      
         A     R2,ATHSLINE                                                      
         CLI   5(R2),0                                                          
         BE    VRHS12                                                           
         CLI   8(R2),C'1'                     ONLY 1                            
         BE    VRHS12                                                           
         CLI   8(R2),C'2'                     ONLY 2 AND 4                      
         BE    VRHS12                         ARE VALID REIMB.                  
         CLI   8(R2),C'4'                     EXPENSES CODES                    
         BNE   FLDINV                                                           
         SPACE 1                                                                
VRHS12   CLI   TGUSEQU,UDIO                   IF USE IS DIO                     
         BE    *+8                                                              
         CLI   TGUSEQU,UIVR                   IF USE IS IVR                     
         BNE   VRHS13                                                           
         LH    R2,DSPREIMI                                                      
         A     R2,ATHSLINE                                                      
         CLI   5(R2),0                                                          
         BE    VRHS13                                                           
         CLI   8(R2),C'4'                     ONLY 4 VALID CODE                 
         BE    VRHS13                                                           
         BNE   FLDINV                                                           
         SPACE 1                                                                
VRHS13   GOTO1 CODEVAL,DMCB,DSPREIMI,TCEXPICD REIMB. EXPENSES CODE              
         BRAS  RE,RCNCREDS                    RECONCILE CREDITS                 
         SPACE 1                                                                
         GOTOR AMTVAL,DMCB,DSPREIM,TCEXP      REIMBURSED EXPENSES               
         GOTOR CHKCRDAM,DMCB,DSPREIM,TCEXP,TCCRREXP  OK FOR CREDITS?            
         SPACE 1                                                                
         GOTOR AMTVAL,DMCB,DSPPAY,TCPAY       PAYMENT AMOUNT                    
         BNE   VRHS15                                                           
         OI    TCINPUT,TCINPAY     SET HAVE PAYMENT AMOUNT                      
         OI    TCINPUT,TCINHWIN                                                 
         LH    R1,DSPPAY                                                        
         A     R1,ATHSLINE                                                      
         TM    4(R1),X'20'         IF PAYMENT FIELD NOT VALID                   
         BZ    VRHS14                                                           
         TM    1(R1),X'08'         OR IF IT WAS CHANGED PREVIOUSLY              
         BZ    VRHS15                                                           
         TM    1(R1),X'04'                                                      
         BO    VRHS15                                                           
VRHS14   OI    CASTSTAT,CSTINPY    SET INPUT PAYMENT                            
VRHS15   GOTOR CHKCRDAM,DMCB,DSPPAY,TCPAY,TCCRPAY   OK FOR CREDITS?             
         SPACE 1                                                                
         TM    PAYOPTS3,ORETRO     IF MAKING RETRO PAYMENT                      
         JZ    VRHS15B                                                          
         CLI   TGUSEQU,UPNH        (BUT NOT PNH/PAY)                            
         JE    VRHS15B                                                          
         LH    R3,DSPSPNH          CLEAR SUBJECT TO P&H FIELD                   
         A     R3,ATHSLINE                                                      
         GOTO1 FLDVAL,DMCB,(1,0(R3)),1                                          
         MVC   7(1,R3),5(R3)                                                    
         SPACE 1                                                                
VRHS15B  LA    R3,TCSUBPNH         SUBJECT TO P&H                               
         TM    LCLSTAT3,SOAPRES    IF USE IS A SOAP RESIDUAL                    
         BZ    *+8                                                              
         LA    R3,TCPNH            IT'S P&H AMOUNT                              
         GOTOR AMTVAL,DMCB,DSPSPNH,(R3)                                         
         BNE   VRHS15A                                                          
         OI    TCINPUT,TCINPNH                                                  
         CLI   TGUSEQU,UPNH        IF PNH ONLY USE                              
         BNE   VRHS15A                                                          
         OI    TCINPUT,TCINPAY     SET HAVE PYMNT AMT FOR SYSCALC               
VRHS15A  BRAS  RE,GCNTPNH          VALIDATE GUAR. CONTRACT SP&H                 
         GOTOR CHKCRDAM,DMCB,DSPSPNH,(R3),TCCRSPNH   OK FOR CREDITS?            
         SPACE 1                                                                
         GOTOR AMTVAL,DMCB,DSPMDED,(X'80',TCMDED)  MISC. DEDUCTION              
         BNE   VRHS15C                                                          
         OI    TCINPUT2,TCINMDED   SET MISC DED INPUT                           
         L     RE,ATHSLINE                                                      
         SR    RE,RA                                                            
         STH   RE,DSPLMDED         SAVE DISP. TO LAST TIME ENTERED              
         SPACE 1                                                                
VRHS15C  XC    OPTAGNT,OPTAGNT     AGENT OVERRIDE                               
         LH    R2,DSPAGT                                                        
         LTR   R2,R2               TEST IF ON SCREEN                            
         BZ    VRHSX                                                            
         A     R2,ATHSLINE         ADD A(THIS LINE)                             
         CLI   5(R2),0                                                          
         BE    VRHSX                                                            
         TM    4(R2),X'20'         TEST VALIDATED (FOR SOP)                     
         BZ    VRHS16                                                           
         TM    1(R2),X'08'         TEST IF EVER CHANGED                         
         BZ    VRHSX                                                            
         GOTO1 ANY                                                              
         MVC   TGAGT,WORK          SAVE IN GLOBAL                               
         B     VRHS17                                                           
VRHS16   GOTO1 RECVAL,DMCB,TLANCDQ,(X'22',(R2)) GET RECORD                      
         MVI   ELCODE,TAANELQ                                                   
         L     R4,AIO              GET AGENT DETAILS ELEMENT                    
         BAS   RE,GETEL                                                         
         BNE   FLDINV                                                           
         USING TAAND,R4                                                         
         TM    TAANSTAT,TAANSOVR   TEST ALLOWABLE OVERRIDE                      
         BZ    FLDINV                                                           
VRHS17   GOTO1 TRNSAGT,DMCB,(X'80',TGAGT),OPTAGNT                               
         SPACE 1                                                                
VRHSX    B     XIT                                                              
         EJECT                                                                  
*              ROUTINE VALIDATES CODE FIELDS                                    
         SPACE 1                                                                
*                                  P1=A(DISP. TO CODE FIELD)                    
*                                  P2=A(W/S FOR CODE FIELD)                     
CODEVAL  NTR1                                                                   
         LM    R3,R4,0(R1)                                                      
         CLC   0(2,R3),=X'FFFF'    TEST CODE FIELD ON SCREEN                    
         BE    XIT                                                              
         LH    R2,0(R3)                                                         
         A     R2,ATHSLINE         ADD A(THIS LINE)                             
         LR    R3,R2               SAVE ITS ADDRESS                             
         BAS   RE,BUMP             ASSUME CORRESPONDING AMOUNT IS NEXT          
*                                                                               
         TM    1(R3),X'20'         IF CODE FIELD IS PROTECTED                   
         BZ    *+10                                                             
         MVC   5(1,R3),7(R3)       SET INPUT LENGTH WITH OUTPUT LENGTH          
*                                                                               
         TM    1(R2),X'20'         DO THE SAME FOR AMOUNT FIELD                 
         BZ    *+10                                                             
         MVC   5(1,R2),7(R2)                                                    
*                                                                               
         CLI   5(R3),0             TEST INPUT IN CODE FIELD                     
         BNE   CVAL2                                                            
         CLI   5(R2),0             NOTHING IN CODE - IF THERE'S AN AMNT         
         BE    XIT                                                              
         LR    R2,R3               REQUIRE CODE                                 
         B     FLDMISS                                                          
*                                                                               
CVAL2    CLI   5(R2),0             HAVE CODE, SO AMOUNT IS REQ'D                
         BNE   CVAL3                                                            
         TM    1(R3),X'20'         SEE IF REIMB. AMOUNT IS PROTECTED            
         BO    XIT                                                              
         B     FLDMISS                                                          
CVAL3    LR    R2,R3                                                            
         GOTO1 VALINUM             VALIDATE NUMERIC FIELD                       
         MVC   0(1,R4),8(R2)       SAVE EBCDIC CODE                             
         B     XIT                                                              
*                                                                               
BUMP     ZIC   R1,0(R2)            BUMP TO NEXT FIELD                           
         AR    R2,R1                                                            
         BR    RE                                                               
         EJECT                                                                  
*              ERROR/EXIT ROUTINES                                              
         SPACE 1                                                                
PYLOADED MVI   MYMSGNO1,2          ENTER USE CODE OR "?"                        
         B     INFOEND                                                          
PFERR    MVI   ERROR,ERINVPFK      INVALID PFKEY                                
         B     SETCURSR                                                         
NOCSTSEL MVI   ERROR,ERNOCSEL      CAST SELECT NOT ALLOWED FOR THIS USE         
         B     SETCURSR                                                         
ADVPAUSE MVI   MYMSGNO1,90         PLEASE ENTER FIELDS AS REQUIRED              
         OI    GENSTAT2,USGETTXT                                                
         J     THEEND                                                           
NOTIFDFT MVI   ERROR,ERNOTDFT      CAN'T SELECT CAST FOR DRAFT PMTS             
SETCURSR LR    R2,RA                                                            
         AH    R2,TWADISP          RETURN CURSOR TO SAME SPOT                   
         J     THEEND                                                           
                                                                                
***********************************************************************         
                                                                                
FLDINV   TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JO    WFINV               ADD TO ERROR BLOCK                           
         MVI   ERROR,INVALID       INVALID INPUT FIELD                          
         J     THEEND                                                           
WFINV    MVC   BLOCK(EINVX-ERINV),ERINV                                         
         MVC   BLOCK+EEFIELD-ERRENTD(L'EEFIELD),ERMAPCOD                        
         GOTO1 ADDERROR,DMCB,BLOCK                                              
         J     XIT                                                              
                                                                                
ERINV    DC    AL1(EINVX-*),AL2(504),AL1(ERRCATY3),AL1(0)                       
         DC    AL2(0)                                                           
         DC    C'Invalid value'                                                 
EINVX    EQU   *                                                                
                                                                                
***********************************************************************         
                                                                                
FLDMISS  MVI   ERROR,MISSING       MISSING INPUT FIELD                          
         J     THEEND                                                           
NOINPUT  MVI   ERROR,ERNOINP       INPUT NOT ALLOWED IN THIS FIELD              
         J     THEEND                                                           
RECNTFND MVI   ERROR,NOTFOUND      RECORD NOT FOUND                             
         J     THEEND                                                           
INVERR   MVI   ERROR,ERINVPD       INVOICE ALREADY PAID                         
         J     THEEND                                                           
NOTPAID  MVI   ERROR,ERNOTPD       INVOICE NOT PAID YET                         
         J     THEEND                                                           
NOTAPP   MVI   ERROR,ERNOTAPP      INVOICE NOT APPROVED YET                     
         J     THEEND                                                           
PURGED   MVI   ERROR,ERPURGED      COMML MARKED FOR PURGE - CAN'T PAY           
         J     THEEND                                                           
AIADVERR MVC   MYMSGNO,=Y(ERRAIADV) INV HAS DIFF ADVICE ASSIGNED TO IT          
         B     NTHEEND                                                          
AICOMERR LA    R2,PAYCIDH                                                       
         MVC   MYMSGNO,=Y(ERRAICOM) COM HAS DIFF ADVICE ASSIGNED TO IT          
         B     NTHEEND                                                          
AIUSEERR LA    R2,PAYINVH                                                       
         MVC   MYMSGNO,=Y(ERRAIINV) INVOICE NOT FOR USE BEING PAID              
         B     NTHEEND                                                          
NODRFT   MVC   MYMSGNO,=Y(ERNODRFT) DRAFT NOT FOR USE BEING PAID                
         B     NTHEEND                                                          
EMPERR   MVI   ERROR,EREMPUSE      INVALID EMPLOYER FOR THIS USE                
         J     THEEND                                                           
AGYUSERR MVI   ERROR,ERAGYUSE      INVALID USE FOR THIS AGENCY                  
         J     THEEND                                                           
                                                                                
***********************************************************************         
                                                                                
AMTINV   TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JO    WFINV               ADD TO ERROR BLOCK                           
         MVI   ERROR,ERINVAMT      INVALID AMOUNT                               
         J     THEEND                                                           
                                                                                
***********************************************************************         
                                                                                
STRTINV  TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JO    WFINV               ADD TO ERROR BLOCK                           
         MVI   ERROR,ERINVSDT      INVALID START DATE                           
         J     THEEND                                                           
                                                                                
***********************************************************************         
                                                                                
ENDINV   TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JO    WFINV               ADD TO ERROR BLOCK                           
         MVI   ERROR,ERINVEDT      INVALID END DATE                             
         J     THEEND                                                           
                                                                                
***********************************************************************         
                                                                                
STRTMISS TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JO    WFINV               ADD TO ERROR BLOCK                           
         MVI   ERROR,ERMISSDT      MISSING START DATE                           
         J     THEEND                                                           
                                                                                
***********************************************************************         
                                                                                
ENDMISS  TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JO    WFINV               ADD TO ERROR BLOCK                           
         MVI   ERROR,ERMISEDT      MISSING END DATE                             
         J     THEEND                                                           
                                                                                
***********************************************************************         
                                                                                
INVOPTTY MVI   ERROR,EROPTTYP      INVALID OPTION FOR THIS BILLING TYPE         
         J     THEEND                                                           
ERNOFICA MVI   ERROR,ERFICA        F= OPTION REQUIRED WITH T= OPTION            
         J     THEEND                                                           
ERNOHAND MVC   MYMSGNO,=Y(ERHAND)  H= OPTION REQUIRED WITH T= OPTION            
         B     NTHEEND                                                          
INVOPTUS TM    TGFASTAT,TGFROMFA                                                
         BO    OPTINV                                                           
         MVI   ERROR,EROPTUSE      INVALID OPTION FOR THIS USE PAYMENT          
         J     THEEND                                                           
                                                                                
MISSTULU TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JO    WFINV               ADD TO ERROR BLOCK                           
         MVI   ERROR,ERTULU        NEED BOTH TU AND LU OPTIONS                  
         J     THEEND                                                           
OUTOFSEQ MVI   SEQSTAT,SSLATCHK     SET TO CHECK IF OK                          
         MVC   MYMSGNO,=Y(ERROUTSQ) INVOICES BEING PAID OUT OF SEQUENCE         
         B     NTHEEND                                                          
COMRLSED MVI   ERROR,ERCOMREL      COMM'L RELEASED - PFKEY TO ALLOW             
         OI    LCLSTAT3,COMRELER   SET COMM'L RELEASED ERROR PENDING            
         J     THEEND                                                           
EVTLCK   MVC   MYMSGNO,=Y(ERREVLCK) EVENT LOCKED                                
         J     NTHEEND                                                          
ERPPLSI  MVC   MYMSGNO,=Y(ERRIAPPA) RECORD / ACTION INVALID FOR P+              
         J     NTHEEND                                                          
JOBINV   MVI   ERROR,ERINVJOB      INVALID JOB NUMBER - PFKEY TO ALLOW          
         OI    LCLSTAT2,JOBERR     SET JOB NUMBER ERROR PENDING                 
         J     SETHIGH                                                          
POINV    MVI   ERROR,NOTFOUND      INVALID PO - PFKEY TO ALLOW                  
         OI    LCLSTAT4,POERR      SET PO ERROR PENDING                         
         J     SETHIGH                                                          
OVERLAP  MVI   ERROR,EROVRLAP      CYCLE DATE OVERLAP - PFKEY TO ALLOW          
         OI    CYCSTAT,CYSTEOVR    SET CYCLE ERROR STATUS                       
         J     SETHIGH                                                          
ERMUPAID LHI   RE,ERMUSAPD                                                      
         OI    CYCSTAT2,CYSTMUPD   MUS PAYMENT HAS BEEN MADE TO COMML           
         J     ERMUXIT                                                          
ERMUOVLP LHI   RE,ERMUSAPC                                                      
         OI    CYCSTAT2,CYSTMUPC   MUS PAYMENT OVERLAPS THIS CYCLE              
ERMUXIT  STH   RE,MYMSGNO                                                       
         OI    1(R2),X'08'                                                      
         OI    4(R2),X'20'                                                      
         OI    6(R2),X'80'                                                      
         J     NTHEEND                                                          
LATERHF  MVC   MYMSGNO,=Y(ERRLATHF) LATER HF PAID-PFKEY TO ALLOW                
         OI    CYCSTAT,CYSTDHLD     SET CYCLE ERROR STATUS                      
         OI    1(R2),X'08'         SET FIELD TO HIGH INTENSITY                  
         OI    4(R2),X'20'         SET PREVIOUSLY VALIDATED                     
         OI    6(R2),X'80'                                                      
         B     NTHEEND                                                          
OVERMAX  MVC   MYMSGNO,=Y(ERCSFMAX)  AMOUNT GREATER THAN TBL CSF MAX            
         OI    LCLSTAT4,MAXOVER                                                 
         B     NTHEEND                                                          
NOTCONTG MVI   ERROR,ERNTCNTG      CYCLES NOT CONTIG. - PFKEY TO ALLOW          
         OI    CYCSTAT,CYSTECTG    SET CYCLE ERROR STATUS                       
         J     SETHIGH                                                          
ERREXPUP LHI   RE,EREXPUPD         EXPIRY DATE NEEDS UPDATING                   
         STH   RE,MYMSGNO                                                       
         B     NTHEEND                                                          
ERREXSUP LHI   RE,EREXSUPD         EXPIRY DATES NEEDS UPDATING                  
         STH   RE,MYMSGNO                                                       
         B     NTHEEND                                                          
ERRCEXUP LHI   RE,ERCEXUPD         CANADIAN EXPIRY DATE NEEDS UPDATING          
         STH   RE,MYMSGNO                                                       
         B     NTHEEND                                                          
ERRUSCYS LHI   RE,EUSCYCST         INVALID USE FOR CYCLE START DATE             
         STH   RE,MYMSGNO                                                       
         B     NTHEEND                                                          
SETHIGH  OI    1(R2),X'08'         SET FIELD TO HIGH INTENSITY                  
         OI    4(R2),X'20'         SET PREVIOUSLY VALIDATED                     
         OI    6(R2),X'80'                                                      
         J     THEEND                                                           
LIFTERR  MVI   ERROR,ERNOLIFT      NO LIFT ON COMMERCIAL                        
         J     THEEND                                                           
NONEELIG MVI   ERROR,ERNONEEL      NO ONE ELIGIBLE FOR PAYMENT                  
         B     STRTOVER                                                         
ABORTPFK MVI   ERROR,ERPABORT      PAYMENT ABORTED - INV NOT PROCESSED          
         B     STRTOVER                                                         
         SPACE 1                                                                
STRTOVER TM    TRNSTAT,TRNABEND      IF NOT ABENDING                            
         BO    STRTO5                                                           
         GOTO1 DELSCRS               DELETE ANY SCREEN RECORDS WRITTEN          
STRTO5   NI    PRGSTAT,ALL-PAYINITD  SET TO START ALL OVER NEXT TIME            
         NI    TRNSTAT,ALL-PYINPROG  SET PAY UPDATE NOT IN PROGRESS             
         TM    PRGSTAT,INITSARD      IF TSAR INITIALIZED (IN USE)               
         BZ    STRTO7                                                           
         GOTO1 TSARCNTL,DMCB,0       INDICATE NO LONGER USING TSAR              
STRTO7   L     R2,EFHREC                                                        
         J     THEEND                                                           
                                                                                
***********************************************************************         
                                                                                
EXTDINV  TM    TGFASTAT,TGFROMFA                                                
         JO    WFINV                                                            
         MVI   MYMSGNO1,105                                                     
         OI    GENSTAT2,USGETTXT                                                
         J     THEEND                                                           
                                                                                
***********************************************************************         
                                                                                
INVCOTM  MVC   MYMSGNO,=Y(ERINVUSD)  INVOICE HAS TIMESHEET W/ DIFF COMM         
         LA    R2,PAYCIDH                                                       
         B     NTHEEND                                                          
         SPACE 1                                                                
NTHEEND  OI    GENSTAT2,USGETTXT   NEW THEEND FOR TWO BYTE ERROR MSGS           
         MVI   BLOCK,0                                                          
         MVI   MYMTYP,GTMERR                                                    
         J     THEEND                                                           
         SPACE 1                                                                
GRTERR1  LHI   RE,ERMUS515         PAYMENT ABORTED - CHECK CAST                 
         STH   RE,MYMSGNO                                                       
         J     NTHEEND                                                          
         SPACE 1                                                                
GRTERR2  LHI   RE,ERMUS516         GRT DOES NOT HAVE GCON                       
         STH   RE,MYMSGNO                                                       
         J     NTHEEND                                                          
         SPACE 1                                                                
GRTERR3  LHI   RE,ERMUS517         GUARANTEE CONTRACTS DO NOT MATCH             
         STH   RE,MYMSGNO                                                       
         J     NTHEEND                                                          
         SPACE 1                                                                
PNHERR   LHI   RE,ERMUS523         PAYMENT ABORTED - P&H EXCEEDS                
E2THEEND STH   RE,MYMSGNO          CONTRACT YEAR LIMIT                          
         J     NTHEEND                                                          
RTCMDIFF LHI   RE,ERRAICOM         RETRO INV USED W/ DIFF COMML                 
         J     E2THEEND                                                         
RTUSDIFF LHI   RE,ERRAIINV         RETRO INV USED W/ DIFF USE TYPE              
         J     E2THEEND                                                         
         SPACE 1                                                                
***********************************************************************         
*        CODE TO BLOCK PAYMENTS TO DEFUNCT BILLING TYPES              *         
*        MAYBE IT WILL GO LIVE SOMEDAY                                *         
***********************************************************************         
*&&DO                                                                           
BTDISERR LHI   RE,ERRBTDIS         BILLING TYPE IS DISABLED                     
         STH   RE,MYMSGNO                                                       
         J     NTHEEND                                                          
*&&                                                                             
         SPACE 1                                                                
INFOEND  OI    GENSTAT2,USGETTXT   SET GETTXT BLOCK                             
RECEND   L     R2,EFHREC           CURSOR TO RECORD FIELD                       
         SPACE 1                                                                
THEEND   GOTO1 EXIT,DMCB,0                                                      
         SPACE 1                                                                
YES      XR    RC,RC                                                            
NO       LTR   RC,RC                                                            
XIT      XIT1                                                                   
         EJECT                                                                  
*              CONSTANTS, ETC.                                                  
         SPACE 2                                                                
HEXFFS   DC    6X'FF'                                                           
CODMSG   DC    C'(PUR',X'42',C'AGENCY)'                                         
CODMSG2  DC    C'(PUR',X'42',C'CLIENT)'                                         
         SPACE 1                                                                
         LTORG                                                                  
         EJECT                                                                  
*              TABLE TO COVER LOCAL PFKEYS                                      
         SPACE 1                                                                
PFTABLE  DS    0H                                                               
         DC    AL1(15,0),AL2(PFKSOAP-T70250)  SOAP MENU                         
         DC    AL1(16,0),AL2(PFK2ND-T70250)   SECONDARY MENU                    
         DC    AL1(17,0),AL2(PFKCAN-T70250)   CANADIAN MENU                     
         DC    AL1(18,0),AL2(PFKSPAN-T70250)  SPANISH MENU                      
         DC    AL1(19,0),AL2(PFKADDND-T70250) ADDENDUM MENU                     
         DC    AL1(20,0),AL2(PFKINDST-T70250) INDUSTRIAL MENU                   
         DC    AL1(21,0),AL2(PFKMUSIC-T70250) MUSIC MENU                        
*                                                                               
         DC    AL1(13,1),AL2(PFKCAST-T70250)  CAST SELECT                       
*                                                                               
         DC    AL1(7,2),AL2(PFKPREV-T70250)   PREVIOUS PAGE                     
         DC    AL1(8,2),AL2(PFKFRST-T70250)   FIRST PAGE                        
         DC    AL1(14,2),AL2(PFKLAST-T70250)  LAST PAGE                         
         DC    X'FF'                                                            
         EJECT                                                                  
*              TABLE TO DETERMINE WHICH COMMERCIAL RECORD THE                   
*              VERSION CODE IS ON                                               
         SPACE 1                                                                
VERINDEX DC    X'1A',AL1(TLCOV026)                                              
         DC    X'78',AL1(TLCOV120)                                              
         DC    X'D2',AL1(TLCOV210)                                              
         DC    X'FA',AL1(TLCOV250)                                              
         DC    X'FF'                                                            
         EJECT                                                                  
*              TABLE TO COVER VALID OPTIONS                                     
         SPACE 1                                                                
OPTTAB   DS    0H                                                               
         DC    AL2(VALAPP-T70250),C'A  ',AL1(OPTSCLI)  APPLIED CREDITS          
*        DC    AL2(VALCAN-T70250),C'C  ',AL1(OPTSCLI)  CANADIAN TAXES           
         DC    AL2(VALFIC-T70250),C'F  ',AL1(0)        FICA CREDITS AMT         
         DC    AL2(VALGUA-T70250),C'G  ',AL1(OPTSCLI) GUARANTEE CREDITS         
         DC    AL2(VALHND-T70250),C'H  ',AL1(0)        HANDLING AMOUNT          
         DC    AL2(VALPNH-T70250),C'P  ',AL1(0)        P&H RATE                 
         DC    AL2(VALRET-T70250),C'R  ',AL1(0)        RETROACTIVE              
         DC    AL2(VALTAX-T70250),C'T  ',AL1(0)        TAX AMT(INCL. 0)         
         DC    AL2(VALURG-T70250),C'U  ',AL1(0)        URGENT INVOICE           
         DC    AL2(VALNOI-T70250),C'NI ',AL1(0)        NO INTERFACE             
         DC    AL2(VALPTU-T70250),C'TU ',AL1(OPTSCLI)  PREV TOTAL USES          
         DC    AL2(VALPLU-T70250),C'LU ',AL1(OPTSCLI)  PREV LIFT USES           
         DC    AL2(VALNUS-T70250),C'US ',AL1(OPTSCLI)  NUMBER OF USES           
         DC    AL2(VALHNW-T70250),C'HW ',AL1(0)        H&W ADJUST. AMT          
         DC    AL2(VALCCR-T70250),C'RA ',AL1(OPTSCLI)  CAN CONV. RATE           
         DC    AL2(VALDUM-T70250),C'D  ',AL1(0)        DUMMY PAYMENT            
         DC    AL2(VALCOD-T70250),C'PUR',AL1(0)        COD INVOICE              
         DC    AL2(VALGST-T70250),C'GST',AL1(0)        GST AMOUNT               
******** DC    AL2(VALCSF-T70250),C'CSF',AL1(0)        CSF CHECKS               
         DC    AL2(VALCRR-T70250),C'RR ',AL1(OPTSCLI)  NEW SOC RATE             
         DC    AL2(VALFEE-T70250),C'FEE',AL1(0)        FEE AMOUNT               
         DC    AL2(VALEUR-T70250),C'EUR',AL1(0)        EUROS PAYMENT            
         DC    AL2(VALCHA-T70250),C'CH ',AL1(0)        CHLOE HAND AMT           
         DC    AL2(VALCPR-T70250),C'CP ',AL1(0)        CHLOE HAND %             
         DC    AL2(VALRG2-T70250),C'RG2',AL1(0)        2ND REGRESS RUN          
         DC    AL2(VALNHW-T70250),C'NHW',AL1(0)        NO H&W COLUMN            
         DC    AL2(VALASC-T70250),C'ASC',AL1(0)        AGY STUDIO CODE          
         DC    X'FF'                                                            
         EJECT                                                                  
         DROP  R7,R6,R5            DROP SECONDARY BASE REGISTERS                
         EJECT                                                                  
*              ROUTINE CALLED BY COMMON ROUTINE AT START OF PGM TO              
*                               ACCESS ROUTINES LOCATED IN 2ND NMOD.            
         SPACE 2                                                                
V502     DS    0D                                                               
         NMOD1 0,*V502*,R7,R6                                                   
         L     RC,SAVRC            MUST RESTORE RC                              
         SRL   RF,24                                                            
         B     BRANCH2(RF)                                                      
         SPACE 1                                                                
BRANCH2  B     VCHECK              X'00'                                        
         B     VINVOICE            X'04'                                        
         B     VPUTSCRN            X'08'                                        
         B     VGETSCRN            X'0C'                                        
         B     VMYADD              X'10'                                        
         B     VMYWRITE            X'14'                                        
         B     VPAYDONE            X'18'                                        
         B     VMYADDRC            X'1C'                                        
         B     VMYPUTRC            X'20'                                        
         B     VDISRHS             X'24'                                        
         B     VPVAL               X'28'                                        
         B     VCASTDET            X'2C'                                        
         B     VGETDUE             X'30'                                        
         B     VW4DET              X'34'                                        
         B     VLCLCHCK            X'38'                                        
         B     VGRNTEE             X'3C'                                        
         B     VADDREQ             X'40'                                        
         B     VDELSCRS            X'44'                                        
         B     VADJTBCS            X'48'                                        
         B     VLCBUHFX            X'4C'                                        
         B     VLCB2CBL            X'50'                                        
         B     VSTLCBTY            X'54'                                        
         B     VSTLCBSB            X'58'                                        
         B     VTPRELCB            X'5C'                                        
         B     VTRYOCEL            X'60'                                        
         B     VLCBTYPE            X'64'                                        
         B     VGETCAUH            X'68'                                        
         EJECT                                                                  
*              ROUTINE TO BUILD CHECK RECORDS                                   
         SPACE 1                                                                
VCHECK   DS    0H                                                               
         OC    TCAETREC,TCAETREC   IF WE HAVE EVTIME RECORD                     
         BZ    CHK00                                                            
         L     RE,TCAETREC         RE-READ IT TO AVOID PUTREC                   
         XC    KEY,KEY             DRAMA                                        
         MVC   KEY(L'TLTMKEY),0(RE)                                             
         GOTO1 HIGH                                                             
         CLC   KEY(L'TLTMKEY),KEYSAVE                                           
         BE    *+6                                                              
         DC    H'00'                                                            
         MVI   RDUPDATE,C'Y'                                                    
         GOTO1 GETREC                                                           
         L     R0,AIO                                                           
         MVC   AIO,TCAETREC        THEN WRITE IT TO FILE                        
         GOTO1 PUTREC                                                           
         ST    R0,AIO                                                           
         SPACE 1                                                                
CHK00    XC    ELTADU,ELTADU       CLEAR DUE COMP WITHHOLDING ELEMENT           
         SPACE 1                                                                
         TM    PAYSTAT1,CREDIT     TEST THIS IS A CREDIT PAYMENT                
         BZ    CHK0A                                                            
         BRAS  RE,DUECOMP          ADD AUTOMATIC DUE COMPANY RECORD             
         LA    R1,TCTOTS           R1=A(CHECK TOTALS)                           
         LA    R0,NTCTOTS          R0=N'ACCUMS                                  
         BAS   RE,REVSIGN2         REVERSE SIGN ON AMOUNTS                      
         L     R1,TCPENS                                                        
         LCR   R1,R1               REVERSE SIGN ON WGA PENSION                  
         ST    R1,TCPENS                                                        
         L     R1,TCHLTH           AND HEALTH                                   
         LCR   R1,R1                                                            
         ST    R1,TCHLTH                                                        
         ICM   R1,15,SVTCPNH       AND DGA PENSION                              
         LCR   R1,R1                                                            
         STCM  R1,15,SVTCPNH                                                    
         L     R1,TCAGTFEE         AND AGENT FEE FOR PRINT                      
         LCR   R1,R1                                                            
         ST    R1,TCAGTFEE                                                      
         SPACE 1                                                                
CHK0A    NI    LCLSTAT5,X'FF'-CKCANTAX                                          
         SPACE 1                                                                
         LA    RE,NOCANTAX         SOME SOCIAL SECURITY NUMBERS                 
CHK0B    CLI   0(RE),X'FF'         NEVER CHARGED CANADIAN TAX                   
         BE    CHK0C                                                            
         CLC   TGSSN,0(RE)                                                      
         BE    CHK0F                                                            
         LA    RE,L'NOCANTAX(RE)                                                
         B     CHK0B                                                            
         SPACE 1                                                                
         USING TACAD,R4                                                         
CHK0C    LA    R4,ELTACA                                                        
         OC    ELTACA,ELTACA                                                    
         BZ    CHK0F                                                            
*                                                                               
         MVC   TGCTRY,=C'CA'                                                    
         GOTO1 TAXVAL,DMCB,(X'FF',TACAUNIT)                                     
         BE    CHK0C600                                                         
*                                                                               
         USING TACOD,RE                                                         
         LA    RE,ELTACO                                                        
         CLI   TACOMED,TACOMEDP    IF PAYING PRINT PAYROLL                      
         BNE   CHK0C110            FOR CA                                       
         CLC   TACAUNIT,=C'CA '                                                 
         BNE   CHK0C110                                                         
         OI    LCLSTAT9,CASTCALI                                                
         DROP  RE                                                               
*                                                                               
CHK0C110 CLC   TACAUNIT,=C'CN '    CN NO LONGER VALID IF AOS IS ACTIVE          
         BNE   CHK0F                                                            
         TM    TGUSSTAT,SESSION    IF SESSION PAYMENT                           
         BZ    CHK0C600            OK FOR REUSE                                 
         OI    LCLSTAT8,CNNOTCAN   SET TO TAKE CANADIAN TAXES ON CHECK          
         B     CHK0F                                                            
*&&DO                                                                           
CHK0C600 TM    TCW4STA3,TAW4SNTX   DO NOT TAKE CANADIAN TAXES ON                
         BO    CHK0F               NON-TAXABLE FOREIGNER                        
         TM    LCLSTAT9,NOCOTXCN   IF CORP HAS ANY CANADIAN TIES                
         BO    CHK0F               DO NOT TAKE CANADIAN TAXES                   
CHK0E    OI    LCLSTAT5,CKCANTAX   SET TO TAKE CANADIAN TAXES ON CHECK          
         OI    PAYOPTS1,OCANTAX    SET TO TAKE CANADIAN TAXES ON INV            
         DROP  R4                                                               
*&&                                                                             
CHK0C600 CLI   TACACORP,C' '       AND W4 IS LINKED TO A CORPORATION            
         BH    CHK0E                                                            
         TM    TCW4STA3,TAW4SNTX   OR W4 IS NON-TAXABLE FOREIGNER               
         BO    CHK0F                                                            
         CLI   TCW4TYPE,TAW4TYCA   OR W4 TYPE IS NOT CANADIAN                   
         BE    CHK0F                                                            
         CLI   TCW4TYPE,TAW4TYCO   OR CORPORATION                               
         BNE   CHK0E               TAKE CANADIAN TAXES                          
         DROP  R4                                                               
*                                                                               
         USING TLW4PD,RE                                                        
         LA    RE,KEY              OR IF CORPORTATION LINKED TO                 
         XC    KEY,KEY             AN INDIVIDUAL                                
         MVI   TLW4PCD,TLW4CCDQ                                                 
         MVC   TLW4CCRP,TGSSN                                                   
         GOTO1 HIGH                                                             
         CLC   KEY(TLW4CSSN-TLW4PD),KEYSAVE                                     
         BNE   CHK0F                                                            
CHK0E    OI    LCLSTAT5,CKCANTAX   SET TO TAKE CANADIAN TAXES ON CHECK          
         OI    PAYOPTS1,OCANTAX    SET TO TAKE CANADIAN TAXES ON INV            
         DROP  RE                                                               
         SPACE 1                                                                
CHK0F    GOTO1 RECVAL,DMCB,TLCKCDQ,(X'C0',0)  BUILD CHECK REC. KEY              
         SPACE 1                                                                
         L     R3,AIO              BUILD RECORD IN I/O AREA                     
         USING TLCKD,R3                                                         
         MVC   TLCKKEY,KEY                                                      
         MVC   TLCKINV,INVNO       INVOICE NUM. ISN'T COMPLEMENTED HERE         
         SPACE 1                                                                
         OC    INV04A,INV04A       IF GENERATING TWO INVOICES FOR               
         BZ    CHK0G               ACTRA TYPE 2404A COMMERCIAL                  
         GOTOR ONCAINV,DMCB,ELTACA AND PERFORMER BELONGS ON                     
         BNE   CHK0G               CANADIAN INVOICE                             
         MVC   TLCKINV,INV04A      PUT PERFORMER ON CANADIAN INVOICE            
         XC    TLCKINV,HEXFFS2                                                  
         SPACE 1                                                                
CHK0G    MVC   TLCKLEN,DATADISP    INIT. RECORD LENGTH                          
         MVI   TLCKSEQ,X'FF'       SET SEQUENCE NUMBER TO X'FF'                 
         XC    TLCKSTAT(10),TLCKSTAT                                            
         SPACE 1                                                                
***** TASO ELEMENTS MUST BE THE FIRST ELEMENTS ADDED TO RECORD!!! *****         
         TM    LCLSTAT3,SOAPRES    IF USE IS A SOAP RESIDUAL                    
         BZ    *+8                                                              
         BAS   RE,ADDTASO          BUILD TASO ELEMENT FROM TSAR REC             
         SPACE 1                                                                
         USING TANUD,R4                                                         
         OC    TCSUBPNH,TCSUBPNH   IF THERE IS A SUBJECT TO P&H AMOUNT          
         BZ    CHK0GC                                                           
         LA    R4,ELEMENT                                                       
         XC    ELEMENT,ELEMENT     SAVE SUBJECT TO P&H PERCENTAGE               
         MVI   TANUEL,TANUELQ                                                   
         MVI   TANULEN,TANULNQ1                                                 
         MVI   TANUTYPE,TANUTPHR                                                
         MVC   TANUNXTC,TCPNHR                                                  
         GOTO1 ADDELEM                                                          
         DROP  R4                                                               
         SPACE 1                                                                
CHK0GC   BRAS  RE,PDINIT           INIT PAYMENT DETAILS EL (IN ELEMENT)         
         LA    R4,ELEMENT                                                       
         USING TAPDD,R4            SAVE CHECK INFORMATION IN ELEMENT            
         SPACE 1                                                                
* CHECK VRE/VNR                                                                 
*                                                                               
         XC    BYTE,BYTE                                                        
         CLI   TGUSEQU,UVRE                                                     
         BE    *+8                                                              
         CLI   TGUSEQU,UVNR                                                     
         BNE   CHK0GK                                                           
         MVC   TAPDUNIT,TCTUSES    NUMBER OPF QUADS                             
         TM    TCPAYST2,TCVNR1U    STORE NUMBER OF VERSIONS IN TAPDUNIT         
         BNO   CHK0GK                                                           
         OI    TAPDSTA3,TAPDSNR1                                                
*                                                                               
CHK0GK   NI    TAPDOPTS,X'FF'-TAPDOCAN                                          
         TM    LCLSTAT5,CKCANTAX                                                
         BZ    CHK0H                                                            
         OI    TAPDOPTS,TAPDOCAN                                                
         SPACE 1                                                                
CHK0H    MVC   TAPDCYCS,TCIPCYCS   INDIVIDUAL'S CYCLE START DATE                
         MVC   TAPDCYCE,TCIPCYCE                      END DATE                  
         OC    ACTCYCE,ACTCYCE     IF CANADIAN CYCLE END DATE                   
         BZ    CHK0I               DIFFERS FROM US INVOICE                      
         GOTOR ONCAINV,DMCB,ELTACA AND PERFORMER BELONGS ON                     
         BNE   CHK0I               CANADIAN INVOICE                             
         MVC   TAPDCYCE,ACTCYCE    USE CANADIAN CYCLE END DATE                  
         SPACE 1                                                                
CHK0I    MVC   TAPDGRS,TCGROSS     GROSS                                        
         L     R0,TCAPPLCR         APPLIED AMOUNT                               
         LCR   R0,R0               COMPLEMENT IT                                
         CLI   TCAPPLCD,APPLGUAR   IF APPLIED CODE NOT GUARANTEE CREDIT         
         BE    CHK0                                                             
         ST    R0,TAPDAPPL         SAVE IN APPLIED CREDITS                      
         CLI   TCAPPLCD,APPLWSPU   IF APPLIED CODE IS WSP UPGRADE               
         BE    *+12                                                             
         CLI   TCAPPLCD,APPLCAB    OR CABLE                                     
         BNE   *+10                                                             
         XC    TCAPPLCR,TCAPPLCR   CLEAR APPLIED CREDITS                        
         B     CHK1                                                             
         SPACE                                                                  
CHK0     ST    R0,TAPDGUAR         SAVE GUARANTEE CREDITS                       
         MVC   TCGUAR,TCAPPLCR                                                  
         XC    TCAPPLCR,TCAPPLCR   CLEAR APPLIED CREDITS                        
         SPACE                                                                  
CHK1     MVC   TAPDACDE,TCAPPLCD   APPLIED AMOUNT INCLUDE CODE                  
         MVC   TAPDPAYI,TCPAYI     INDIVIDUAL PAYMENT AMOUNT                    
         MVC   TAPDPAYC,TCPAYC     CORPORATE PAYMENT AMOUNT                     
         MVC   TAPDREXP,TCEXP      REIMBURSED EXPENSES                          
         MVC   TAPDICDE,TCEXPICD   REIMBURSED EXPENSES INCLUDE CODE             
         MVC   TAPDSPNH,TCSUBPNH   SUBJECT TO P&H                               
         MVC   TAPDMDED,TCMDED     MISCELLANEOUS DEDUCTION                      
         MVC   TAPDDUES,TCDUES     UNION DUES                                   
         MVC   TAPDPNH,TCPNH       PENSION & HEALTH                             
         MVC   TAPDINR,TCINR       INSURANCE & RETIREMENT                       
         MVC   TAPDHNW,TCHNW       HEALTH & WELFARE                             
         MVC   TAPDOV1,TCOV1       OVERSCALE RATE 1                             
         MVC   TAPDW4TY,TCW4TYPE   W4 TYPE                                      
         MVC   TAPDTXNW,TCTXNW                                                  
                                                                                
         TM    PAYOPTS3,ORETRO                                                  
         BZ    CHK1C                                                            
         USING TACOD,RE                                                         
         LA    RE,ELTACO                                                        
         CLI   TACOCTYP,CCTY04B    IF PAYING ACT TYPE 2404B COMM'L              
         BNE   CHK1A                                                            
         DROP  RE                                                               
         LA    RE,ELTACA                                                        
         USING TACAD,RE                                                         
         CLC   TACAUN,=C'ACT'      IF UNION IS ACTRA                            
         BNE   CHK1A                                                            
         OC    TACAYEAR,TACAYEAR   SKIP IF YR CODE IS BLANK                     
         BZ    CHK1C                                                            
         DROP  RE                                                               
CHK1A    ICM   RE,15,CSTRSPNH                                                   
         L     RF,TAPDSPNH                                                      
         AR    RF,RE                                                            
         ST    RF,TAPDSPNH                                                      
         L     RF,TSUBJPNH                                                      
         AR    RF,RE                                                            
         ST    RF,TSUBJPNH                                                      
         ICM   RF,15,INVRSPNH                                                   
         AR    RF,RE                                                            
         STCM  RF,15,INVRSPNH                                                   
                                                                                
         LCR   RE,RE                                                            
         STCM  RE,15,TAPDAPPL     STORE IN APPLIED AMOUNT                       
         MVI   TAPDACDE,APPLOTH   SET OTHER APPLIED CODE                        
                                                                                
         ICM   RE,15,CSTRPNHD                                                   
         L     RF,TAPDPNH                                                       
         AR    RF,RE                                                            
         ST    RF,TAPDPNH                                                       
         L     RF,TPNH                                                          
         AR    RF,RE                                                            
         ST    RF,TPNH                                                          
         ICM   RF,15,INVRPNHD                                                   
         AR    RF,RE                                                            
         STCM  RF,15,INVRPNHD                                                   
                                                                                
CHK1C    L     RE,TCEXP                                                         
         ICM   RF,15,TCTXNW                                                     
         SR    RE,RF                                                            
         STCM  RE,15,TAPDNTNW                                                   
         BRAS  RE,PDUSE            SET USE INFO                                 
         SPACE 1                                                                
         OC    ELTACA,ELTACA       IF WE HAVE CAST DETAILS ELEMENT              
         BZ    CHK1M                                                            
         TM    CASTSTAT,CSTMAN     TEST MANUAL OVERRIDE                         
         BZ    CHK1K                                                            
         OI    TAPDSTAT,TAPDSMAN                                                
         BRAS  RE,WEBOVERS         SET WEB OVERRIDE BITS                        
         SPACE 1                                                                
CHK1K    TM    TCINPUT,TCINPRI     SET FIXED CYCLE PMT ON PRIMARY COMML         
         BZ    *+12                                                             
         OI    TAPDSTA2,TAPDSPRI                                                
         OI    LCLSTAT2,PRIMCOMM   ALSO SET FOR INVOICE LATER                   
         SPACE 1                                                                
         USING TACOD,RE                                                         
CHK1M    LA    RE,ELTACO                                                        
         CLI   TACOCTYP,CCTY2404   IF PAYING ACTRA TYPE 2404                    
         BE    CHK1N                                                            
         CLI   TACOCTYP,CCTY04A    OR ACTRA TYPE 2404A                          
         BNE   CHK2                                                             
CHK1N    TM    TGUSSTA2,HLDTYPE    AND NOT A HOLDING FEE PAYMENT                
         BO    CHK2                                                             
         GOTOR ONCAINV,DMCB,ELTACA AND 2404A PERFORMER BELONGS ON               
         BNE   CHK2                CANADIAN INVOICE                             
         OI    TAPDSTAT,TAPDSCAN   TURN ON CANADIAN DOLLAR PAYMENT              
         OC    INV04A,INV04A       IF GENERATING TWO INVOICES                   
         BZ    CHK2                                                             
         MVC   TAPDINV,INV04A      SAVE CANADIAN INVOICE NUMBER                 
         XC    TAPDINV,HEXFFS2                                                  
         DROP  RE                                                               
*                                                                               
CHK2     BRAS  RE,SVPLGEOP         SAVE PERFORMER LEVEL G=E OPTION              
*                                                                               
         GOTO1 ADDL                ADD PAYMENT DETAILS EL. TO RECORD            
*                                                                               
         BRAS  RE,SVTABKEL         SAVE PAYMENT BREAKDOWN ELEMENT               
*                                                                               
         OC    ELTATI,ELTATI       IF WE HAVE TAX ID ELEMENT                    
         BZ    CHK3                                                             
         MVC   ELEMENT(L'ELTATI),ELTATI                                         
         GOTO1 ADDL                ADD IT TO RECORD                             
*                                                                               
CHK3     OC    ELTANUM,ELTANUM     IF WE HAVE ACTRA MEMBERSHIP NUM EL.          
         BZ    CHK4                                                             
         MVC   ELEMENT(L'ELTANUM),ELTANUM                                       
         GOTO1 ADDL                ADD IT TO RECORD                             
*                                                                               
CHK4     TM    TGSYSTA2,TASYSNDC   NEW DUE COMPANY?                             
         BO    CHK4A                                                            
         OC    ELTADU,ELTADU       IF WE HAVE DUE COMP WITHHOLDING ELEM         
         BZ    CHK5                                                             
         MVC   ELEMENT(L'ELTADU),ELTADU                                         
         GOTO1 ADDL                ADD IT TO RECORD                             
         B     CHK5                                                             
*                                                                               
CHK4A    OC    ELTADU,ELTADU       IF WE HAVE DUE COMP WITHHOLDING ELEM         
         BZ    CHK5                                                             
         LA    R4,ELTADU                                                        
CHK4B    CLI   0(R4),0                                                          
         JE    CHK5                                                             
         MVC   ELEMENT(L'ELTADU),0(R4)                                          
         GOTO1 ADDL                ADD IT TO RECORD                             
         AHI   R4,TADWLNQ                                                       
         J     CHK4B                                                            
*                                                                               
CHK5     OC    ELTADL,ELTADL       IF WE HAVE DEAL ELEMENT                      
         BZ    CHK5B                                                            
         MVC   ELEMENT(L'ELTADL),ELTADL                                         
         GOTO1 ADDL                ADD IT TO RECORD                             
         SPACE 1                                                                
CHK5B    OC    ELTASO,ELTASO       IF WE HAVE EPISODE NUMS ELEMENT              
         BZ    CHK5D                                                            
         MVC   ELEMENT(L'ELTASO),ELTASO                                         
         GOTO1 ADDL                ADD IT TO RECORD                             
         SPACE 1                                                                
CHK5D    OC    ELTACR,ELTACR       IF WE HAVE TACR EL FOR SOP                   
         BZ    CHK6                                                             
         MVC   ELEMENT(L'ELTACR),ELTACR                                         
         LA    R4,ELEMENT                                                       
         USING TACRD,R4                                                         
         MVC   TACRUSE,TGUSCDE     SET USE CODE                                 
         MVC   TACRTYPE,TGUSTYP    AND TYPE                                     
         MVC   TACRINV,INVNO       AND INVOICE NUMBER                           
         GOTO1 ADDL                ADD IT TO RECORD                             
         SPACE                                                                  
CHK6     LA    R4,ELTACO           R4=A(COMM'L DETAILS ELEMENT)                 
         USING TACOD,R4                                                         
         TM    TACOSTAT,TACOSCAN   IF CANADIAN DOLLAR PAYMENT                   
         BO    *+12                                                             
         CLI   TGUNEQU,ACT         OR US DOLLAR PAYMENT FOR ACTRA               
         BNE   CHK6G                                                            
         XC    ELEMENT,ELEMENT                                                  
         LA    R4,ELEMENT                                                       
         USING TANUD,R4            BUILD DUMMY TANU ELEMENT                     
         MVI   TANUEL,TANUELQ                                                   
         MVI   TANULEN,13                                                       
         MVI   TANUTYPE,TANUTGST   FOR GST NUMBER                               
         GOTO1 ADDL                AND ADD IT TO RECORD                         
         SPACE 1                                                                
CHK6G    TM    PAYOPTS3,ORETRO                                                  
         BZ    CHK7                                                             
         USING TACOD,RE                                                         
         LA    RE,ELTACO                                                        
         CLI   TACOCTYP,CCTY04B    IF PAYING ACT TYPE 2404B COMM'L              
         BNE   CHK6H                                                            
         DROP  RE                                                               
         LA    RE,ELTACA                                                        
         USING TACAD,RE                                                         
         CLC   TACAUN,=C'ACT'      IF UNION IS ACTRA                            
         BNE   CHK6H                                                            
         OC    TACAYEAR,TACAYEAR   SKIP IF YR CODE IS BLANK                     
         BZ    CHK7                                                             
         DROP  RE                                                               
CHK6H    XC    ELEMENT,ELEMENT                                                  
         LA    R4,ELEMENT                                                       
         USING TARPD,R4                                                         
         MVI   TARPEL,TARPELQ                                                   
         MVI   TARPLEN,TARPLNQ                                                  
         MVC   TARPBASE,CSTRSPNH                                                
         MVC   TARPDIFF,CSTRPNHD                                                
         GOTO1 ADDL                AND ADD IT TO RECORD                         
                                                                                
CHK7     XC    ELEMENT,ELEMENT                                                  
         LA    R4,ELEMENT                                                       
         USING TACDD,R4            BUILD DUMMY CHECK DETAILS ELEMENT            
         MVI   TACDEL,TACDELQ                                                   
         MVI   TACDLEN,TACDLNQ                                                  
*                                                                               
         TM    TGGRTSTA,TGGRTMSC   MULTI-SERVICE CONTRACT                       
         BZ    *+8                                                              
         OI    TACDSTA2,TACDSMSC                                                
*                                                                               
         CLI   HASTIME,C'Y'        IF THIS INVOICE HAS TIMESHEETS               
         BNE   CHK7A                                                            
         BRAS  RE,CHKHLDY          CHECK IF CAST HAS HOLIDAY PAY                
         BNE   CHK7A                                                            
         OI    TACDSTAT,TACDHLDY   SET BIT IN TACDSTAT                          
*                                                                               
CHK7A    TM    LCLSTAT3,SOAPRES    IF USE IS A SOAP RESIDUAL                    
         BZ    CHK7B                                                            
         USING ECASTABD,R3                                                      
         L     R3,TCATSAR          GET TSAR RECORD                              
         TM    ECSTSTAT,ECSTS2ND   IF CHECK IS FOR CAST FROM 2ND COMM'L         
         BZ    *+8                                                              
         OI    TACDSTAT,TACDS2ND   SET BIT IN TACDSTAT                          
CHK7B    GOTO1 ADDL                AND ADD IT TO RECORD                         
         SPACE 1                                                                
*                                                                               
         CLI   TGUSEQU,UVRE                                                     
         BE    *+8                                                              
         CLI   TGUSEQU,UVNR                                                     
         BNE   CHK7G                                                            
*                                                                               
         USING TAFND,R4                                                         
         LA    R4,ELEMENT                                                       
         XC    ELEMENT,ELEMENT                                                  
         MVI   TAFNEL,TAFNELQ                                                   
         MVI   TAFNTYPE,TAFNTVNR                                                
         CLI   TGUSEQU,UVRE                                                     
         BE    *+8                                                              
         MVI   TAFNTYPE,TAFNTVRE                                                
         L     RE,ACSTVERS                                                      
         LA    RF,TAFNNAME                                                      
         LA    R0,3                                                             
CHK7C    CLI   0(RE),X'FF'                                                      
         BE    CHK7D                                                            
         MVC   0(1,RF),0(RE)                                                    
         AHI   RE,1                                                             
         AHI   RF,1                                                             
         AHI   R0,1                                                             
         B     CHK7C                                                            
CHK7D    STC   R0,TAFNLEN                                                       
         GOTO1 ADDL                                                             
         SPACE 1                                                                
*                                                                               
CHK7G    XC    ELEMENT,ELEMENT                                                  
         USING TABYD,R4            BUILD DUMMY BILLING YTD ELEMENT              
         MVI   TABYEL,TABYELQ                                                   
         MVI   TABYLEN,TABYLNQ                                                  
         GOTO1 ADDL                AND ADD IT TO RECORD                         
         SPACE 1                                                                
         XC    ELEMENT,ELEMENT                                                  
         USING TAYED,R4            BUILD DUMMY YTD EARNINGS ELEMENT             
         MVI   TAYEEL,TAYEELQ                                                   
         MVI   TAYELEN,TAYELNQ                                                  
         MVI   TAYETYPE,TAYETBIL   FOR BILLING                                  
         GOTO1 ADDL                AND ADD IT TO RECORD                         
         SPACE 1                                                                
         TM    PAYSTAT1,CREDIT     IF THIS ISN'T A CREDIT PAYMENT               
         BO    CHKX                                                             
         MVI   TAYETYPE,TAYETCHK   SET DUMMY YTD EARNINGS EL FOR CHECK          
         GOTO1 ADDL                AND ADD IT TO RECORD                         
         SPACE 1                                                                
         ZIC   R3,NTACWS           R3=N'CHECK WITHHOLDING ELS. TO ADD           
         LTR   R3,R3                                                            
         BZ    CHKX                                                             
         XC    ELEMENT,ELEMENT                                                  
         USING TACWD,R4            BUILD DUMMY CHECK WITHHOLDING EL.            
         MVI   TACWEL,TACWELQ                                                   
         MVI   TACWLEN,TACWLN2Q                                                 
CHK8     GOTO1 ADDL                ADD IT TO RECORD                             
         BCT   R3,CHK8             LOOP FOR N'ELEMENTS TO ADD                   
         SPACE 1                                                                
         IC    R3,NTACWS           ADD SAME # OF YTD WITHHOLDING ELS.           
         USING TACYD,R4            BUILD DUMMY YTD WITHHOLDING EL.              
         MVI   TACYEL,TACYELQ                                                   
         MVI   TACYLEN,TACYLN2Q                                                 
CHK9     GOTO1 ADDL                ADD IT TO RECORD                             
         BCT   R3,CHK9             LOOP FOR N'ELEMENTS TO ADD                   
         SPACE 1                                                                
CHKX     BAS   RE,ADDGREQ          ADD GUARANTEE REQUEST                        
         SPACE 1                                                                
         USING TANUD,R4                                                         
         OC    TCOVAMT,TCOVAMT     IF WE HAVE OVERSCALE AMOUNT                  
         BZ    CHKXA                                                            
         XC    ELEMENT,ELEMENT     ADD OVERSCALE AMOUNT ELEMENT                 
         MVI   TANUEL,TANUELQ                                                   
         MVI   TANULEN,TANULNQ2                                                 
         MVI   TANUTYPE,TAUNTOVA                                                
         MVC   TANUOVAM,TCOVAMT                                                 
         GOTO1 ADDL                                                             
         DROP  R4                                                               
         SPACE                                                                  
CHKXA    TM    PAYSTAT1,CREDIT     IF CREDIT PAYMENT                            
         BZ    CHKXB                                                            
         OC    EINVNO,EINVNO       AND HAVE ERROR INVOICE NUMBER                
         BZ    CHKXB                                                            
         XC    ELEMENT,ELEMENT     INITIALIZE ELEMENT TO BINARY ZEROS           
         LA    R4,ELEMENT                                                       
         USING TANUD,R4                                                         
         MVI   TANUEL,TANUELQ      BUILD FREE FORM NUMBER ELEMENT               
         MVI   TANUTYPE,TANUTINV   WITH ERROR INVOICE TYPE                      
         LA    R1,3                                                             
         LA    R1,L'EINVNO(R1)                                                  
         STC   R1,TANULEN          LENGTH OF ELEMENT IS L'EINVNO+3              
         MVC   TANUMBER(L'EINVNO),EINVNO  ERROR INVOICE NUMBER                  
         GOTO1 ADDL                ADD ELEMENT TO RECORD                        
         SPACE 1                                                                
CHKXB    OC    ELTACA,ELTACA       IF WE HAVE CAST DETAILS ELEMENT              
         BZ    XIT2                                                             
         CLC   TGCSORT,HEXFFS2     AND NOT CHECK RECORD FOR LOCAL               
         BNE   CHKXC                                                            
         CLC   TGCAT,=C'ZZZ'                                                    
         BE    CHKX2                                                            
         CLC   TGCAT,=C'ZZ '                                                    
         BE    CHKX2                                                            
CHKXC    TM    PAYSTAT1,CREDIT     AND NOT CREDIT PAYMENT                       
         BO    CHKX2                                                            
         OC    TGGUA,TGGUA         AND HAVE GUARANTEE CODE                      
         BZ    CHKX2                                                            
         SPACE                                                                  
         USING TACAD,R4                                                         
         LA    R4,ELTACA                 R4=A(CAST DETAILS ELEMENT)             
         MVC   TACAGUA,TGGUA             SAVE CODE OF GRT REC ADDED             
         XC    TACAGUA,HEXFFS2           UNCOMPLEMENT IT                        
         SPACE                                                                  
CHKX2    MVC   ELEMENT(L'ELTACA),ELTACA                                         
         GOTO1 ADDL                      ADD IT TO CHECK RECORD                 
         SPACE                                                                  
         BRAS  RE,ADDTATUS         ADD TAX UNIT ELEMENTS FOR EVENTS             
         BRAS  RE,REVPPLUS         REVERSE FOR PPLUS IF CREDIT                  
         BRAS  RE,ADDPAC           ADD PP AGENCY COMMISSION                     
         SPACE                                                                  
         OC    GUARCONT,GUARCONT   IF WE HAVE A GUARANTEE CONTRACT              
         BZ    XIT2                                                             
         CLC   TACAUN,=C'SAG'      AND UNION IS SAG                             
         BE    CHKX3                                                            
         CLC   TACAUN,=C'AFT'      OR AFTRA ..                                  
         BNE   XIT2                                                             
         DROP  R4                                                               
                                                                                
         USING TAFND,R4                                                         
CHKX3    LA    R4,ELEMENT                                                       
         XC    ELEMENT,ELEMENT                                                  
         MVI   TAFNEL,TAFNELQ      ADD GUARANTEE CONTRACT CODE                  
         MVI   TAFNLEN,TAFNLNQ+6   ELEMENT                                      
         MVI   TAFNTYPE,TAFNTGCO                                                
         MVC   FULL,GUARCONT                                                    
         XC    FULL,HEXFFS2                                                     
         L     R1,FULL                                                          
         AHI   R1,1                                                             
         EDIT  (R1),(6,TAFNNAME),0,ALIGN=RIGHT                                  
         OC    TAFNNAME(6),=C'000000'                                           
         MVC   TAFNNAME(2),=C'GC'                                               
         GOTO1 ADDL                                                             
         B     XIT2                                                             
         DROP  R4                                                               
         SPACE 2                                                                
NOCANTAX DC    0CL12                     TABLE OF SS# THAT SHOULD               
         DC    C'000000055',X'000000'    NEVER HAVE CANADIAN TAX                
         DC    C'000000066',X'000000'    TAKEN                                  
         DC    C'000000202',C'AB '                                              
         DC    C'000001553',C'ON '                                              
         DC    C'000002533',C'BC '                                              
         DC    C'000003755',X'000000'                                           
         DC    C'000003855',X'000000'                                           
         DC    C'000003876',X'000000'                                           
         DC    C'000004137',C'QC '                                              
         DC    C'000006777',C'MB '                                              
         DC    C'000007106',X'000000'                                           
         DC    C'000007108',C'NF '                                              
         DC    C'000008213',C'AB '                                              
         DC    C'000115472',C'NS '                                              
         DC    X'FF'                                                            
         EJECT                                                                  
*              ROUTINE BUILDS TASO ELEMENTS FROM TSAR REC AND                   
*              ADDS IT TO RECORD AT AIO1.  MYTSRNUM ALREADY SET                 
         SPACE                                                                  
ADDTASO  NTR1                                                                   
         CLC   TGCSORT,HEXFFS2     DON'T DO IF CHECK RECORD FOR LOCAL           
         BNE   ADDTASO1                                                         
         CLC   TGCAT,=C'ZZ '                                                    
         BE    XIT2                                                             
         CLC   TGCAT,=C'ZZZ'                                                    
         BE    XIT2                                                             
         SPACE                                                                  
         USING ECASTABD,R3                                                      
         USING TASOD,R4                                                         
ADDTASO1 L     R3,TCATSAR          TSAR RECORD STILL AT TCATSAR                 
         ZIC   R0,ECSTNEPI         R0=TOTAL NUMBER OF EPISODES                  
         LA    R3,ECSTEPIS         R3=A(EPISODE INFO IN TSAR)                   
         USING EPISD,R3                                                         
ADDTASO2 LA    R4,ELEMENT          R4=A(TASO ELEMENT)                           
         XC    ELEMENT,ELEMENT                                                  
         MVI   TASOEL,TASOELQ                                                   
         MVI   TASONUM,1                   INIT N'SUB-ELS TO 1                  
         MVI   TASOLEN,TASOLNQ+L'TASOSEPI  INIT EL. LENGTH FOR 1 SUB-EL         
         LA    R2,TASOSEPI                                                      
         XR    R1,R1                                                            
         B     ADDTASO7                                                         
         SPACE                                                                  
         USING TASOSEPI,R2                                                      
ADDTASO5 IC    R1,TASOLEN                                                       
         LA    R1,L'TASOSEPI(R1)   INCREMENT LENGTH FOR NEXT SUB-EL             
         CHI   R1,255              IF EXCEEDS MAX ELEMENT LENGTH                
         BNH   ADDTASO6                                                         
         GOTO1 ADDL,DMCB,,,,=C'ADD=END' ADD TO END OF CHECK REC IN AIO1         
         B     ADDTASO2            PUT REMAINING EPISODES ON ANOTHER EL         
         SPACE                                                                  
ADDTASO6 STC   R1,TASOLEN          ELSE SAVE NEW EL LENGTH                      
         IC    R1,TASONUM                                                       
         LA    R1,1(R1)            INCREMENT N'SUB-ELS                          
         STC   R1,TASONUM          AND SAVE                                     
         SPACE                                                                  
ADDTASO7 MVC   TASOEPI,EPINUM      EPISODE NUM IN BINARY                        
         TM    EPISTAT,EPISTHW     SET APPROPRIATE WRITER ROLE BITS             
         BZ    *+8                                                              
         OI    TASOSTAT,TASOSH                                                  
         TM    EPISTAT,EPISTSW                                                  
         BZ    *+8                                                              
         OI    TASOSTAT,TASOSS                                                  
         TM    EPISTAT,EPISTBW                                                  
         BZ    *+8                                                              
         OI    TASOSTAT,TASOSB                                                  
         TM    TASOSTAT,TASOSS+TASOSH+TASOSB  IF WRITER                         
         BZ    ADDTASO8                                                         
         LH    RF,EPIPENS            WGA PENSION AMOUNT                         
         AH    RF,EPIHLTH          + HEALTH AMOUNT                              
         STH   RF,TASOPNH          = P&H                                        
         B     ADDTASO9                                                         
         SPACE                                                                  
ADDTASO8 MVC   TASOAPPL,EPIAPPL    APPLIED CREDITS                              
         MVC   TASOPNH,EPIPNH      P&H                                          
ADDTASO9 MVC   TASOPAY,EPIPAY      PAYMENT AMOUNT                               
         SPACE                                                                  
         TM    PAYSTAT1,CREDIT     IF CREDIT PAYMENT                            
         BZ    *+8                                                              
         BAS   RE,REVSTASO         REVERSE SIGN ON TASO AMOUNTS                 
         SPACE                                                                  
         LA    R3,EPINUMLN(R3)     BUMP TO NEXT EPISODE IN TSAR REC             
         LA    R2,L'TASOSEPI(R2)   BUMP TO NEXT EPISODE IN ELEMENT              
         BCT   R0,ADDTASO5                                                      
         SPACE                                                                  
         GOTO1 ADDL,DMCB,,,,=C'ADD=END' ADD TO END OF CHECK REC IN AIO1         
         XC    12(4,R1),12(R1)     CLEAR P4                                     
         B     XIT2                                                             
         SPACE 3                                                                
*              ROUTINE REVERSES SIGN ON TASO AMOUNTS                            
*              R2=A(TASO SUB ELEMENT)                                           
         SPACE                                                                  
         USING TASOSEPI,R2                                                      
REVSTASO DS    0H                                                               
         LH    RF,TASOPNH          COMPLEMEMT P&H AMOUNT                        
         LCR   RF,RF                                                            
         STH   RF,TASOPNH                                                       
         ICM   RF,7,TASOPAY                   PAYMENT AMOUNT                    
         LCR   RF,RF                                                            
         STCM  RF,7,TASOPAY                                                     
         ICM   RF,7,TASOAPPL                  APPLIED AMOUNT                    
         LCR   RF,RF                                                            
         STCM  RF,7,TASOAPPL                                                    
         BR    RE                                                               
         EJECT                                                                  
*              ROUTINE TO GENERATE A GUARANTEE REQUEST                          
         SPACE 1                                                                
ADDGREQ  NTR1                                                                   
         TM    PAYOPTS3,ODUMMY     DON'T DO IF DUMMY PAYMENT                    
         BO    XIT2                                                             
         SPACE                                                                  
         CLC   TGCSORT,HEXFFS2     IF CHECK RECORD FOR LOCAL, SKIP              
         BNE   ADDGR2                                                           
         CLC   TGCAT,=C'ZZ '                                                    
         BE    XIT2                                                             
         CLC   TGCAT,=C'ZZZ'                                                    
         BE    XIT2                                                             
ADDGR2   OC    TGGUA,TGGUA         IF NO GUARANTEE CODE, SKIP                   
         BZ    XIT2                                                             
         TM    AGYSTAT4,TAAYSNGT   IF SUPPRESSED AT AGENCY LEVEL, SKIP          
         BO    XIT2                                                             
         SPACE                                                                  
         USING TAGQSBEL,R4                                                      
         L     R2,ATMPPAYD         USE TABLE IN TEMPORARY STORAGE               
         USING TMPPAYD,R2                                                       
         LA    R4,GQTABLE          R4=A(CURRENT ENTRY IN GQTABLE)               
         LA    R0,NGQTAB           R0=NUMBER OF ENTRIES                         
         SPACE                                                                  
ADDGR5   CLI   0(R4),0             IF ENTRY NOT EMPTY                           
         BE    ADDGR10                                                          
         LA    R4,L'TAGQSBEL(R4)   BUMP TO NEXT ENTRY                           
         BCT   R0,ADDGR5           KEEP LOOPING TILL FIND AVAILABLE ONE         
         SPACE                                                                  
         DC    H'0'                DIE IF NO ROOM IN TABLE                      
         SPACE                                                                  
ADDGR10  MVC   TAGQOFF,TGOFF       TP OFFICE                                    
         OC    TGOFF,TGOFF                                                      
         BNZ   *+6                                                              
         DC    H'0'                TRAP WHEN CREAMED                            
         PACK  DUB,TGSSN                                                        
         CVB   R1,DUB                                                           
         ST    R1,TAGQSSN          SS NUMBER IN BINARY                          
         SPACE                                                                  
         MVC   FULL,TGGUA                                                       
         XC    FULL,HEXFFS2        UNCOMPLEMENT IT                              
         PACK  DUB,FULL                                                         
         CVB   R1,DUB                                                           
         STH   R1,TAGQGUA          GUARANTEE CODE IN BINARY                     
         SPACE                                                                  
         TM    CASTSTAT,CSTGCOM    IF COMM'L SPECIFIED ON GRT                   
         BZ    ADDGRX                                                           
         MVC   TAGQSTRT,GQSTRT     FILL IN CYCLE START DATE                     
         SPACE                                                                  
         OC    TAGQSTRT,TAGQSTRT   IF NONE DEFINED (OPTIONAL CYCLE)             
         BNZ   *+10                                                             
         MVC   TAGQSTRT,TGTODAY1   USE TODAY'S DATE                             
ADDGRX   B     XIT2                                                             
         EJECT                                                                  
*              ROUTINE REVERSES SIGN OF R0 NUMBER OF AMOUNTS AT R1              
         SPACE 1                                                                
REVSIGN2 DS    0H                                                               
REV22    L     RF,0(R1)            CURRENT AMOUNT                               
         LCR   RF,RF               COMPLEMENTED                                 
         ST    RF,0(R1)            IS NEW AMOUNT                                
         SPACE 1                                                                
         LA    R1,4(R1)            BUMP TO NEXT CHECK TOTAL                     
         BCT   R0,REV22                                                         
         BR    RE                                                               
         EJECT                                                                  
*              ROUTINE TO BUILD INVOICE RECORD                                  
         SPACE 1                                                                
VINVOICE DS    0H                                                               
         TM    PAYMODE,DRAFT       IF DRAFT, SKIP                               
         BO    XIT2                (DON'T HAVE INVOICE NUMBER)                  
         SPACE 1                                                                
         BRAS  RE,SVCRTARA         SAVE CREDITED INVOICE BILL RATES             
         SPACE 1                                                                
         USING WEBREQD,RE                                                       
         TM    TGCTSTST,TGCTSCLI   IF PAYMENT BEING MADE BY CLIENT              
         BO    INV0                                                             
         TM    TGFASTAT,TGFROMFA   OR IF PAYMENT COMING FROM WEB                
         BZ    INV0A                                                            
         L     RE,TGAFAREQ                                                      
         OC    WBPYINV,WBPYINV     AND INVOICE NUMBER IS NOT PROVIDED           
         BNZ   INV0A               BUILD INVOICE RECORD                         
         DROP  RE                                                               
         SPACE 1                                                                
         USING TLIND,R3                                                         
INV0     GOTO1 RECVAL,DMCB,TLINCDQ,(X'C0',0)  BUILD THE KEY                     
         L     R3,AIO                                                           
         MVC   TLINKEY,KEY         INITIALIZE RECORD                            
         MVC   TLINLEN,DATADISP                                                 
         XC    TLINSTAT(7),TLINSTAT                                             
         SPACE                                                                  
         USING TAIND,R4                                                         
         LA    R4,ELEMENT                                                       
         XC    ELEMENT,ELEMENT                                                  
         MVI   TAINEL,TAINELQ       BUILD INVOICE STATUS ELEMENT                
         MVI   TAINLEN,TAINLNQ                                                  
         SPACE                                                                  
         USING WEBREQD,RE                                                       
         TM    TGFASTAT,TGFROMFA    IF PAYMENT NOT COMING FROM WEB              
         BZ    INV00                                                            
         TM    TGFASTAT,TGCRNOPY    OR COMING FROM CERNO                        
         BO    INV00                                                            
         L     RE,TGAFAREQ          OR COMING FROM WEB AND INVOICE              
         OC    WBPYINV,WBPYINV      IS NOT PROVIDED                             
         BNZ   INV000                                                           
INV00    OI    TAINSTA2,TAINSSCR    SET INV# FOR SCR RECS IN ASSGN INFO         
         DROP  RE                                                               
         SPACE                                                                  
INV000   MVC   TAINIID,TWAORIG      SAVE CONNECT USER ID NUMBER                 
         MVC   TAINIST,TGCTSTAF     AND STAFF CODE                              
         MVC   TAINIDTE,SCRINVNO    DATE AND TIME INVOICE ASSIGNED FROM         
         MVC   TAINITIM,SCRINVNO+3  SCREEN INVOICE NUMBER                       
         B     INV0B                                                            
         SPACE 1                                                                
INV0A    GOTO1 RECVAL,DMCB,TLINCDQ,(X'B4',0)  GET INVOICE RECORD                
         BNE   NOINVERR            ABEND IF NOT FOUND                           
         SPACE 1                                                                
         MVI   ELCODE,TADYELQ      DELETE DUMMY ELEMENTS                        
         GOTO1 REMELEM                                                          
         SPACE 1                                                                
         GOTO1 SAVPTRS,DMCB,BLOCK  BUILD PASSIVE PTRS                           
         SPACE 1                                                                
         USING FAWSSVRD,R1                                                      
         LA    R1,WORK                                                          
         XC    WORK(FAWSSVRL),WORK                                              
         MVC   FAWSTOKN,=C'SVIP'                                                
         MVI   FAWSACTN,FAWSASVE                                                
         MVC   FAWSLEN,=AL2((7*L'TLDRREC)+1)                                    
         LA    RE,BLOCK                                                         
         ST    RE,FAWSADR          SAVE PASSIVE PTRS INTO WSSVR AREA            
         GOTO1 WSSVR,(R1)                                                       
         CLI   FAWSRTN,0                                                        
         BE    *+6                                                              
         DC    H'00'                                                            
         DROP  R1                                                               
         SPACE 1                                                                
         MVI   ELCODE,TAINELQ      GET INVOICE STATUS EL.                       
         L     R4,AIO                                                           
         BAS   RE,GETEL2                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
         USING TAIND,R4                                                         
         TM    TAINSTAT,TAINSPAY   IF INVOICE GOT PAID WHILE WE WERE IN         
         BO    PDINVERR            THE MIDDLE OF OUR PAYMENT, ABORT             
         SPACE                                                                  
INV0B    OI    TAINSTAT,TAINSPAY   SET INVOICE HAS BEEN PAID                    
         MVC   TAINPID,TWAORIG     USER ID OF PAYER                             
         MVC   TAINPST,TGCTSTAF    SAVE STAFF CODE OF PAYER                     
         MVC   TAINPDTE,TGTODAY1   DATE                                         
         TIME  DEC                                                              
         STCM  R0,14,TAINPTIM      AND TIME                                     
         MVC   TAINFPG,FPAGE       SAVE FIRST NON-SELECT SCREEN PAGE            
         MVC   TAINLPG,LPAGE       AND LAST SCREEN PAGE                         
         SPACE 1                                                                
         TM    CLTSTAT,TACISCOD    IF THIS IS A COD CLIENT                      
         BO    *+20                                                             
         TM    AGYSTAT,TAAYSCOD    IF THIS IS A COD AGENCY                      
         BO    *+12                                                             
         TM    PAYOPTS3,OCOD       OR IF COD OPTION USED                        
         BZ    *+12                                                             
         OI    TAINSTAT,TAINSHLD   SET INVOICE TO HOLD STATUS                   
         B     INV0C               SKIP SETTING RETRO HOLD BIT                  
         SPACE 1                                                                
         TM    PAYOPTS3,ORETRO     IF THIS IS RETROACTIVE                       
         BZ    *+8                                                              
         OI    TAINSTA2,TAINSRTH   SET RETROACTIVE HOLD BIT                     
         SPACE 1                                                                
INV0C    TM    PAYOPTS2,OPURGENT   IF THIS IS AN URGENT PAYMENT                 
         BZ    *+8                                                              
         OI    TAINSTA2,TAINSURG   SET URGENT INVOICE BIT                       
         SPACE 1                                                                
         TM    PAYOPTS4,OPNOINT    IF THIS IS TO NOT INTERFACE                  
         BZ    *+8                                                              
         OI    TAINSTA3,TAINSNI    SET NO INTERFACING                           
         SPACE 1                                                                
         TM    LCLSTAT2,GUARERR    IF THERE'S A GUARANTEE ERROR                 
         BZ    *+14                                                             
         OI    TAINSTAT,TAINSERR   SET INVOICE IN ERROR                         
         MVC   TAINTERR,GRTERROR   SET ERROR TYPE                               
         SPACE 1                                                                
         TM    LCLSTAT2,NOFUND     IF THERE'S NO FUND FOR I&R LOCAL CHK         
         BZ    *+12                                                             
         OI    TAINSTAT,TAINSERR   SET INVOICE IN ERROR                         
         MVI   TAINTERR,TAINEINV   SET ERROR TYPE                               
         SPACE 1                                                                
         USING WEBREQD,RE                                                       
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         BZ    INV0CD                                                           
         L     RE,TGAFAREQ                                                      
         OC    WBPYSI1,WBPYSI1     AND IS BEING SPLIT                           
         BZ    INV0CD                                                           
         OI    TAINSTA2,TAINSPRM   SET THIS INVOICE AS PRIMARY                  
         DROP  RE                                                               
         SPACE 1                                                                
INV0CD   TM    TGFASTAT,TGCRNOPY   IF PAYMENT COMING FROM CERNO                 
         BO    INV0CE                                                           
         TM    TGFASTAT,TGFROMFA                                                
         BO    INV0CF                                                           
         CLI   TGCTSTTY,TASTTYPF                                                
         BE    INV0CF                                                           
         CLI   TGCTSTTY,TASTTYPC   OR IS BEING MADE BY CLIENT                   
         BNE   INV0D                                                            
INV0CE   OI    TAINSTAT,TAINSAPR   SET APPROVED                                 
         MVC   TAINQINF,TAINPINF   AND APPROVAL INFO USING PAYER INFO           
         SPACE 1                                                                
         USING WEBREQD,RE                                                       
INV0CF   TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         BZ    INV0CG                                                           
         L     RE,TGAFAREQ                                                      
         CLI   WBPYAAP,C'Y'        AND AUTO-APPROVE? IS SET TO Y                
         JNE   INV0CFF                                                          
         OI    TAINSTAT,TAINSAPR   SET APPROVED                                 
         MVC   TAINQINF,TAINPINF   AND APPROVAL INFO USING PAYER INFO           
INV0CFF  OC    WBPYINV,WBPYINV     AND INVOICE NUMBER WAS NOT PROVIDED          
         JNZ   INV0D                                                            
INV0CG   GOTO1 ADDL                ADD INVOICE STATUS ELEMENT TO RECORD         
         DROP  RE                                                               
         SPACE 1                                                                
INV0D    DS    0C                                                               
*                                                                               
         XC    BYTE,BYTE                                                        
         CLI   TGUSEQU,UVRE                                                     
         BE    *+8                                                              
         CLI   TGUSEQU,UVNR                                                     
         BNE   INV0E                                                            
*                                                                               
         LA    R4,ELEMENT                                                       
         USING TAFND,R4                                                         
         XC    ELEMENT,ELEMENT                                                  
         MVI   TAFNEL,TAFNELQ                                                   
         MVI   TAFNTYPE,TAFNTVNR                                                
         CLI   TGUSEQU,UVRE                                                     
         BNE   *+8                                                              
         MVI   TAFNTYPE,TAFNTVRE                                                
         L     RE,APAYVERS                                                      
         LA    RF,TAFNNAME                                                      
         LA    R0,3                                                             
INVCI    CLI   0(RE),X'FF'                                                      
         BE    INVCJ                                                            
         MVC   0(1,RF),0(RE)                                                    
         AHI   RE,1                                                             
         AHI   RF,1                                                             
         AHI   R0,1                                                             
         B     INVCI                                                            
INVCJ    STC   R0,TAFNLEN                                                       
         GOTO1 ADDL                                                             
         SPACE 1                                                                
*                                                                               
INV0E    BRAS  RE,PDINIT           INIT PAYMENT DETAILS EL (IN ELEMENT)         
         XC    HALF,HALF                                                        
         TM    TGUSSTA3,NWKUSE                                                  
         BZ    INV1                IF NETWORK USE                               
         LA    R4,TCTAUHEL                                                      
         USING TAUHD,R4                                                         
         LH    R1,TAUHUSN          LAST USE NUMBER                              
         LA    R1,1(R1)            + 1                                          
         STH   R1,HALF             = STARTING USE NUMBER (SAVE IN HALF)         
         SPACE                                                                  
                                                                                
INV1     LA    R4,ELEMENT                                                       
         USING TAPDD,R4            SAVE INVOICE INFORMATION IN ELEMENT          
         SPACE 1                                                                
*                                                                               
         TM    TGSYSTA2,TASYSULA   IF PRINTING URGENT CA CHECKS IN LA           
         BZ    INV1A                                                            
         CLC   =C'PP',EOR          PP WE DONT NEED TO CHECK AGENCY              
         BE    INV1AA              STATUS BIT                                   
         TM    AGYSTAT7,TAATSPLA                                                
         BZ    INV1A                                                            
INV1AA   TM    LCLSTAT9,CASTCALI   IF  CA  FOR P+ OR PRINT PAYROLL              
         BZ    INV1A                                                            
         OI    TAPDPST2,TAPDPCAL                                                
*                                                                               
INV1A    MVC   TAPDCYCS,TCPCYCS    CYCLE START DATE                             
         MVC   TAPDCYCE,TCPCYCE    CYCLE END DATE                               
         SPACE 1                                                                
         BRAS  RE,ADJ04AUS         ADJUST US$ TOTALS FOR 2404A COMM'LS          
         SPACE 1                                                                
         MVC   TAPDGRS,TGROSS      GROSS                                        
         L     R0,TAPPLCR          APPLIED CREDITS                              
         LCR   R0,R0               SAVE COMPLEMENTED AMOUNT                     
         ST    R0,TAPDAPPL                                                      
         L     R0,TGUAR            GUARANTEE CREDITS                            
         LCR   R0,R0               SAVE COMPLEMENTED AMOUNT                     
         ST    R0,TAPDGUAR                                                      
         MVC   TAPDPAYI,TPAYI      INDIVIDUAL PAYMENT AMOUNT                    
         MVC   TAPDPAYC,TPAYC      CORPORATE PAYMENT AMOUNT                     
         MVC   TAPDREXP,TEXPENSE   REIMBURSED EXPENSES                          
         MVC   TAPDSPNH,TSUBJPNH   SUBJECT TO P&H                               
         MVC   TAPDMDED,TMISCDED   MISCELLANEOUS DEDUCTION                      
         MVC   TAPDDUES,TDUES      UNION DUES                                   
         MVC   TAPDPNH,TPNH        PENSION & HEALTH                             
         MVC   TAPDINR,TINR        INSURANCE & RETIREMENT                       
         MVC   TAPDHNW,THNW        HEALTH & WELFARE                             
         MVC   TAPDTXNW,TTXNW                                                   
         L     RE,TEXPENSE                                                      
         ICM   RF,15,TTXNW                                                      
         SR    RE,RF                                                            
         STCM  RE,15,TAPDNTNW                                                   
         SPACE 1                                                                
         BRAS  RE,REA04AUS         READJUST US$ TOTALS FOR 2404A COMS           
         SPACE 1                                                                
         CLI   TGUSEQU,UITN                                                     
         BE    *+10                                                             
         MVC   TAPDSTUS,HALF       STARTING USE NUMBER                          
         MVC   TAPDUSES,TCTUSES    TOTAL N'USES PAID                            
         SPACE 1                                                                
         TM    LCLSTAT,MANOVER     TEST MANUAL OVERRIDE                         
         BZ    *+8                                                              
         OI    TAPDSTAT,TAPDSMAN                                                
         SPACE 1                                                                
         TM    LCLSTAT2,PRIMCOMM   SET FIXED CYCLE PMT ON PRIMARY COMML         
         BZ    *+8                                                              
         OI    TAPDSTA2,TAPDSPRI                                                
         SPACE 1                                                                
         TM    LCLSTAT4,POOKAY     SET OK TO CLOSE PO ON                        
         BZ    *+8                                                              
         OI    TAPDSTA2,TAPDSCPO                                                
*&&DO                                                                           
         TM    LCLSTAT9,CN16INCL   SET PAYMENT INCLUDED 16 YEAR PERFS           
         BZ    *+8                                                              
         OI    TAPDSTA3,TAPDSC16                                                
*&&                                                                             
         TM    PAYOPTS3,ORETRO                                                  
         BZ    INV1B                                                            
         ICM   RE,15,INVRSPNH                                                   
         LCR   RE,RE                                                            
         STCM  RE,15,TAPDAPPL                                                   
         MVI   TAPDACDE,APPLOTH   SET OTHER APPLIED CODE                        
                                                                                
INV1B    GOTO1 ADDL                ADD PAYMENT DETAILS EL. TO RECORD            
         SPACE 1                                                                
         XC    ELEMENT,ELEMENT                                                  
         LA    R4,ELEMENT                                                       
         USING TADDD,R4            BUILD DUE DATE ELEMENT                       
         MVI   TADDEL,TADDELQ                                                   
         MVI   TADDLEN,TADDLNQ                                                  
         MVC   TADDDATE,DUEDATE                                                 
         MVC   TADDOVRD,DUEDATE2                                                
         SPACE 1                                                                
         GOTO1 ADDL                ADD DUE DATE EL. TO RECORD                   
         SPACE 1                                                                
         MVC   ELEMENT(L'ELTACO),ELTACO                                         
         GOTO1 ADDL                ADD COMMERCIAL DETAILS EL. TO RECORD         
         SPACE 1                                                                
         MVI   WORK,L'COMNAME+8    USE WORK TO SIMULATE SCREEN FIELD            
         MVI   WORK+5,L'COMNAME                                                 
         MVC   WORK+8(L'COMNAME),COMNAME                                        
         GOTO1 NAMIN,DMCB,TAFNELQ,(X'80',WORK),TAFNTTTL COMM'L NAME             
         SPACE 1                                                                
         CLI   VERSION,1                                                        
         BL    INV1G                                                            
         MVI   WORK,L'COMNAME2+8   USE WORK TO SIMULATE SCREEN FIELD            
         MVI   WORK+5,L'COMNAME2                                                
         MVC   WORK+8(L'COMNAME2),COMNAME2                                      
         GOTO1 NAMIN,DMCB,TAFNELQ,WORK,TAFNTVTL VERSION NAME                    
         SPACE 1                                                                
INV1G    OC    ELTALF,ELTALF       IF WE HAVE LIFT DETAILS EL.                  
         BZ    INV1H                                                            
         MVC   ELEMENT(L'ELTALF),ELTALF                                         
         GOTO1 ADDL                ADD IT TO RECORD                             
         B     INV2                                                             
         SPACE 1                                                                
INV1H    OC    ELTAVR,ELTAVR       IF WE HAVE VERSIONS EL.                      
         BZ    INV2                                                             
         MVC   ELEMENT(L'ELTAVR),ELTAVR                                         
         GOTO1 ADDL                ADD IT TO RECORD                             
         SPACE                                                                  
INV2     LA    R4,ELTAFNP          FFN FOR PRODUCT                              
         BAS   RE,ADDTAFN          ADD IT IF NECESSARY                          
         SPACE 1                                                                
         BRAS  RE,ADDTAFNW         ADD WEB APPLICATION ID ELEMENT               
         BRAS  RE,ADDTAMD          ADD INTERNET/NEW MEDIA ELEMENTS              
         SPACE 1                                                                
         CLI   TGUSMEDS,PRINT      IF PRINT PAYMENT                             
         BNE   INV2C                                                            
         LA    R4,ELTAFNPH         FFN FOR PHOTOGRAPHER                         
         BAS   RE,ADDTAFN          ADD IT IF NECESSARY                          
         SPACE 1                                                                
         LA    R4,ELTAFNS          FFN SERVICES FOR AGENCY                      
         BAS   RE,ADDTAFN          ADD IT IF NECESSARY                          
         SPACE 1                                                                
         USING TANUD,R4                                                         
         XC    ELEMENT,ELEMENT     INITIALIZE ELEMENT TO BINARY ZEROS           
         LA    R4,ELEMENT          R4=A(ELEMENT)                                
         MVI   TANUEL,TANUELQ      BUILD FREE FORM NUMBER ELEMENT               
         OC    PHOTOSSN,PHOTOSSN   IF HAVE PHOTOGRAPHER'S SSN                   
         BZ    INV2B                                                            
         MVI   TANUTYPE,TANUTPHO     SET PHOTOGRAPHER SSN TYPE                  
         MVI   TANULEN,12            LENGTH OF ELEMENT IS L'SSN+3               
         MVC   TANUMBER(9),PHOTOSSN  PHOTGRAGHER SSN                            
         GOTO1 ADDL                  ADD ELEMENT TO RECORD                      
         SPACE                                                                  
INV2B    OC    SRVCODE,SRVCODE     IF HAVE SERVICES FOR AGENCY CODE             
         BZ    INV2C                                                            
         MVI   TANUTYPE,TANUTSVC   SET SERVICES FOR AGENCY CODE TYPE            
         LA    R1,3                                                             
         LA    R1,L'SRVCODE(R1)                                                 
         STC   R1,TANULEN          LENGTH OF ELEMENT IS L'SRVCODE+3             
         MVC   TANUMBER(L'SRVCODE),SRVCODE  ERROR INVOICE NUMBER                
         GOTO1 ADDL                  ADD ELEMENT TO RECORD                      
*                                                                               
INV2C    LA    R3,ELTANUSC         ADD SIGNATORY, IF PRESENT                    
         CLI   0(R3),0                                                          
         BE    INV3                                                             
         ZIC   R1,1(R3)                                                         
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   ELEMENT(0),ELTANUSC                                              
         GOTO1 ADDL                ADD IT TO RECORD                             
*                                                                               
INV3     LA    R3,ELTACS           ADD COMMERCIAL STUDIO ELS. TO RECORD         
         LA    R0,3                                                             
INV4     CLI   0(R3),0                                                          
         BE    INV6                                                             
         MVC   ELEMENT(TACSLNQ),0(R3)                                           
         GOTO1 ADDL                                                             
         LA    R3,TACSLNQ(R3)      BUMP TO NEXT                                 
         BCT   R0,INV4                                                          
         SPACE 1                                                                
INV6     CLI   ELTACC,0            IF AROUND                                    
         BE    INV7                                                             
         MVC   ELEMENT(L'ELTACC),ELTACC                                         
         GOTO1 ADDL                ADD CONTRACT NUMBERS EL. TO RECORD           
         SPACE 1                                                                
INV7     CLI   ELTAOC,0            IF AROUND                                    
         BE    INV7G                                                            
         MVC   ELEMENT(L'ELTAOC),ELTAOC                                         
         GOTO1 ADDL                ADD OLD AGENCY/CID EL. TO RECORD             
                                                                                
INV7G    TM    PAYOPTS3,ORETRO                                                  
         BZ    INV8                                                             
         XC    ELEMENT,ELEMENT                                                  
         LA    R4,ELEMENT                                                       
         USING TARPD,R4                                                         
         MVI   TARPEL,TARPELQ                                                   
         MVI   TARPLEN,TARPLNQ                                                  
         MVC   TARPBASE,INVRSPNH                                                
         MVC   TARPDIFF,INVRPNHD                                                
         GOTO1 ADDL                AND ADD IT TO RECORD                         
                                                                                
INV8     XC    ELEMENT,ELEMENT                                                  
         LA    R4,ELEMENT                                                       
         USING TABDD,R4            BUILD BILLING DETAILS ELEMENT                
         MVI   TABDEL,TABDELQ                                                   
         MVI   TABDLEN,TABDLN2Q                                                 
         MVC   TABDCCVT,OPTCCR     SET CANDIAN CONVERSION RATE                  
         MVC   TABDCSF,CSFAMT      SET FINAL CSF AMOUNT                         
*                                                                               
         OC    PPACTOT,PPACTOT     IF PRODUCTIONS PLUS AGENCY                   
         BZ    INV8AA              COMMISSION HAS BEEN CALCULATED               
         MVC   TABDACOM,PPACTOT    SAVE IT NOW                                  
*                                                                               
INV8AA   GOTO1 ADDL                AND ADD IT TO RECORD                         
*                                                                               
         CLI   BILLTYPE,TABRTYE    IF BILLING TYPE E (EMS)                      
         BNE   INV8A                                                            
         XC    ELEMENT,ELEMENT                                                  
         LA    R4,ELEMENT                                                       
         USING TABDD,R4            BUILD EMS BILLING DETAILS ELEMENT            
         MVI   TABDEL,TABDELQ2                                                  
         MVI   TABDLEN,TABDLN2Q                                                 
         MVC   TABDCCVT,OPTCCR     SET CANDIAN CONVERSION RATE                  
         MVC   TABDCSF,CSFAMT      SET FINAL CSF AMOUNT                         
         GOTO1 ADDL                                                             
         SPACE 1                                                                
INV8A    OC    TCGRSEPI,TCGRSEPI   IF HAVE GROSS/EPI FOR SOAP CABLE             
         BZ    INV9                                                             
         XC    ELEMENT,ELEMENT                                                  
         LA    R4,ELEMENT                                                       
         USING TASBD,R4            BUILD SOAP CABLE ELEMENT                     
         MVI   TASBEL,TASBELQ                                                   
         MVI   TASBLEN,TASBLNQ                                                  
         MVC   TASBGRSE,TCGRSEPI   SAVE GRS/EPI                                 
         MVC   TASBCID2,CID2       AND 2ND CID FOR SOC                          
         GOTO1 ADDL                AND ADD IT TO RECORD                         
         SPACE 1                                                                
INV9     OC    DSPAUTH,DSPAUTH     ADD AUTH/PO TO RECORD                        
         BZ    INV10                                                            
         LH    R2,DSPAUTH                                                       
         AR    R2,RA                                                            
         GOTO1 NAMIN,DMCB,TANUELQ,(X'80',(R2)),TANUTAUT                         
         SPACE 1                                                                
INV10    OC    DSPEST,DSPEST       ADD ESTIMATE TO RECORD                       
         BZ    INV12                                                            
         TM    LCLSTAT3,SPLIT      UNLESS THIS INV WILL BE SPLIT BILL           
         BO    INV12                                                            
         LH    R2,DSPEST                                                        
         AR    R2,RA                                                            
         OC    DEFJOB,DEFJOB                                                    
         BZ    INV11                                                            
         OC    8(16,R2),SPACES                                                  
         CLC   =CL16'DEFAULT',8(R2)                                             
         BNE   INV11                                                            
         MVI   5(R2),L'DEFJOB                                                   
         MVC   8(L'DEFJOB,R2),DEFJOB                                            
INV11    GOTO1 NAMIN,DMCB,TANUELQ,(X'80',(R2)),TANUTEST                         
         SPACE 1                                                                
INV12    OC    DSPGCOM,DSPGCOM     ADD GENERAL COMMENT TO RECORD                
         BZ    INV14                                                            
         LH    R2,DSPGCOM                                                       
         AR    R2,RA                                                            
         GOTO1 NAMIN,DMCB,TACMELQ,(X'80',(R2)),TACMTYPG                         
         SPACE 1                                                                
INV14    OC    DSPHCOM,DSPHCOM     ADD HISTORY COMMENT TO RECORD                
         BZ    INV16                                                            
         LH    R2,DSPHCOM                                                       
         AR    R2,RA                                                            
         GOTO1 NAMIN,DMCB,TACMELQ,(X'80',(R2)),TACMTYPH                         
         SPACE 1                                                                
INV16    XC    ELEMENT,ELEMENT     BUILD UNION/LOCAL LIST ELEMENT               
         LA    R4,ELEMENT                                                       
         USING TAULD,R4                                                         
         LA    R4,TAULULS          R4=A(NEXT SUB ELEMENT)                       
         L     R2,ATMPPAYD         USE TABLE IN TEMPORARY STORAGE               
         USING TMPPAYD,R2                                                       
         LA    R2,UNLCLLST         R2=A(UNION/LOCAL LIST)                       
         LA    R0,NUNLCL           R0=N'ENTRIES                                 
         XR    R1,R1               R1=N'SUB ELEMENTS                            
         SPACE                                                                  
INV17    OC    0(6,R2),0(R2)       IF NOT END OF ENTRIES                        
         BZ    INV19                                                            
         MVC   0(6,R4),0(R2)       MOVE UNION/LOCAL TO ELEMENT                  
         LA    R1,1(R1)            INCREMENT COUNT OF SUB ELEMENTS              
         LA    R2,6(R2)            BUMP TO NEXT ENTRY                           
         LA    R4,6(R4)            BUMP TO NEXT SUB ELEMENT                     
         BCT   R0,INV17                                                         
         SPACE                                                                  
INV19    OC    ELEMENT,ELEMENT     IF ANYTHING IN ELEMENT                       
         BZ    INV20                                                            
         LA    R4,ELEMENT          R4=A(ELEMENT)                                
         MVI   TAULEL,TAULELQ      ELEMENT CODE                                 
         STC   R1,TAULNULS           N'SUB ELEMENTS                             
         MH    R1,=H'6'            * L'SUB ELEMENTS                             
         AHI   R1,3                + 3                                          
         STC   R1,TAULLEN          = LENGTH OF ELEMENT                          
         SPACE 1                                                                
         GOTO1 ADDL                ADD ELEMENT TO RECORD                        
         SPACE 1                                                                
INV20    TM    PAYSTAT1,CREDIT     IF CREDIT PAYMENT                            
         BZ    INV25                                                            
         OC    EINVNO,EINVNO       AND HAVE ERROR INVOICE NUMBER                
         BZ    INV25                                                            
         XC    ELEMENT,ELEMENT     INITIALIZE ELEMENT TO BINARY ZEROS           
         LA    R4,ELEMENT                                                       
         USING TANUD,R4                                                         
         MVI   TANUEL,TANUELQ      BUILD FREE FORM NUMBER ELEMENT               
         MVI   TANUTYPE,TANUTINV   WITH ERROR INVOICE TYPE                      
         LA    R1,3                                                             
         LA    R1,L'EINVNO(R1)                                                  
         STC   R1,TANULEN          LENGTH OF ELEMENT IS L'EINVNO+3              
         MVC   TANUMBER(L'EINVNO),EINVNO  ERROR INVOICE NUMBER                  
         GOTO1 ADDL                ADD ELEMENT TO RECORD                        
         SPACE 1                                                                
         TM    PAYSTAT2,TAPDPCIB   IF CRED INV HAS SAVED BILL RATES             
         JZ    INV25                                                            
         CLI   ELTARA,0                                                         
         JE    INV25                                                            
         MVI   ELCODE,TARAELQ                                                   
         GOTO1 REMELEM                                                          
         MVC   ELEMENT,ELTARA      ADD ELEMENT TO RECORD                        
         GOTO1 ADDL                                                             
         SPACE 1                                                                
INV25    TM    PAYOPTS1,OPNHR      IF P&H RATE OPTION INPUT                     
         BZ    INV27                                                            
         XC    ELEMENT,ELEMENT     INITIALIZE ELEMENT TO BINARY ZEROS           
         LA    R4,ELEMENT                                                       
         USING TAPAD,R4                                                         
         MVI   TAPAEL,TAPAELQ      BUILD PAY OPTIONS ELEMENT                    
         MVI   TAPATYPE,TAPATPHR   WITH P&H RATE TYPE                           
         MVI   TAPALEN,5           LENGTH OF ELEMENT IS 2(L'RATE)+3             
         MVC   TAPADATA(2),TCPNHR  P&H RATE                                     
         GOTO1 ADDL                ADD ELEMENT TO RECORD                        
         SPACE 1                                                                
INV27    TM    PAYOPTS4,ONEWSOC    IF SOC RATE OPTION INPUT                     
         BZ    INV30                                                            
         XC    ELEMENT,ELEMENT     INITIALIZE ELEMENT TO BINARY ZEROS           
         LA    R4,ELEMENT                                                       
         USING TAPAD,R4                                                         
         MVI   TAPAEL,TAPAELQ      BUILD PAY OPTIONS ELEMENT                    
         MVI   TAPATYPE,TAPATSOC   WITH SOC RATE TYPE                           
         MVI   TAPALEN,5           LENGTH OF ELEMENT IS 2(L'RATE)+3             
         MVC   TAPADATA(2),TCSOCR  SOC RATE                                     
         GOTO1 ADDL                                                             
         SPACE 1                                                                
INV30    OC    OPTFEE,OPTFEE                                                    
         BZ    INV31                                                            
         LA    R4,ELEMENT                                                       
         MVI   TAPAEL,TAPAELQ      BUILD PAY OPTIONS ELEMENT                    
         MVI   TAPATYPE,TAPATFEE   WITH FEE                                     
         MVI   TAPALEN,7           LENGTH OF ELEMENT IS 4(L'AMT)+3              
         MVC   TAPADATA(4),OPTFEE  FEE                                          
         GOTO1 ADDL                                                             
         SPACE 1                                                                
         USING TAPAD,R4            ADD SOME PAY OPTIONS WITH AMOUNTS            
INV31    XC    ELEMENT,ELEMENT     INITIALIZE ELEMENT TO BINARY ZEROS           
         LA    R4,ELEMENT                                                       
         MVI   TAPAEL,TAPAELQ      SET PAY OPTIONS ELEMENT                      
         MVI   TAPALEN,7           LENGTH OF ELEMENT IS 4(L'AMT)+3              
         SPACE 1                                                                
         TM    PAYOPTS3,OHNWADJ    IF H&W ADJUSTMENT OPTION INPUT               
         BZ    INV35                                                            
         MVI   TAPATYPE,TAPATHNW   SET H&W ADJUSTMENT AMOUNT TYPE               
         MVC   TAPADATA(4),OPTHNW  H&W ADJUSTMENT AMOUNT                        
         GOTO1 ADDL                ADD ELEMENT TO RECORD                        
         SPACE 1                                                                
INV35    TM    PAYOPTS1,OHANDAMT   IF HANDLING AMOUNT OVERRIDE                  
         BZ    INV40                                                            
         MVI   TAPATYPE,TAPATHND   SET HANDLING AMOUNT OVERRIDE TYPE            
         MVC   TAPADATA(4),OPTHAND HANDLING AMOUNT OVERRIDE                     
         GOTO1 ADDL                ADD ELEMENT TO RECORD                        
         SPACE 1                                                                
INV40    TM    PAYOPTS1,OTAXAMT    IF TAX AMOUNT OVERRIDE                       
         BZ    INV45                                                            
         MVI   TAPATYPE,TAPATTAX   SET TAX AMOUNT OVERRIDE TYPE                 
         MVC   TAPADATA(4),OPTTAX  TAX AMOUNT OVERRIDE                          
         GOTO1 ADDL                ADD ELEMENT TO RECORD                        
         SPACE 1                                                                
INV45    TM    PAYOPTS1,OGSTAMT    IF GST AMOUNT OVERRIDE                       
         BZ    INV50                                                            
         MVI   TAPATYPE,TAPATGST   SET GST AMOUNT OVERRIDE TYPE                 
         MVC   TAPADATA(4),OPTGST  GST AMOUNT OVERRIDE                          
         GOTO1 ADDL                ADD ELEMENT TO RECORD                        
         SPACE 1                                                                
INV50    TM    PAYOPTS2,OFICR      IF FICA AMOUNT OVERRIDE                      
         BZ    INV55                                                            
         MVI   TAPATYPE,TAPATFIC   SET FICA CREDIT OVERRIDE TYPE                
         MVC   TAPADATA(4),OPTFICR FICA AMOUNT OVERRIDE                         
         GOTO1 ADDL                ADD ELEMENT TO RECORD                        
         SPACE 1                                                                
INV55    TM    PAYOPTS4,OGENCSF    IF CSF=$$$ OPTION USED                       
         BZ    INV60                                                            
         OC    OPTCSF$,OPTCSF$                                                  
         BZ    INV60                                                            
         MVI   TAPATYPE,TAPATCSF   SET CONTRACT SERV. FEE OVERRIDE TYPE         
         MVC   TAPADATA(4),OPTCSF$ CONTRACT SERVICE FEE AMT OVERRIDE            
         GOTO1 ADDL                ADD ELEMENT TO RECORD                        
         SPACE 1                                                                
INV60    TM    PAYOPTS4,OCHLOEHA   IF CHLOE HANDLING AMOUNT OVERRIDE            
         BZ    INV65                                                            
         MVI   TAPATYPE,TAPATCHA   SET HANDLING AMOUNT OVERRIDE TYPE            
         MVC   TAPADATA(4),OPTCHAND HANDLING AMOUNT OVERRIDE                    
         GOTO1 ADDL                ADD ELEMENT TO RECORD                        
         SPACE 1                                                                
INV65    TM    PAYOPTS4,OCHLOEHP   IF CHLOE HANDLING RATE OVERRIDE              
         BZ    INV90                                                            
         MVI   TAPATYPE,TAPATCHO   SET CHLOE HANDLING RATE OVERRIDE             
         MVC   TAPADATA(4),OPTCHAND HANDLING AMOUNT OVERRIDE                    
         TM    PAYSTAT1,CREDIT     TEST THIS IS A CREDIT PAYMENT                
         BZ    INV65A                                                           
         ICM   RF,15,TAPADATA      RATE PERCENTAGE                              
         LCR   RF,RF               KEEP SIGN OF WHAT USER ENTERED               
         STCM  RF,15,TAPADATA                                                   
INV65A   GOTO1 ADDL                ADD ELEMENT TO RECORD                        
         SPACE 1                                                                
         USING TAUCD,R4                                                         
INV90    OC    INV04A,INV04A       IF GENERATING TWO INVOICES FOR               
         BZ    INV95               ACTRA TYPE 2404A COMMERCIAL                  
         LA    R4,ELEMENT                                                       
         XC    ELEMENT,ELEMENT     BUILD US/CANADIAN INVOICE ELEMENT            
         MVI   TAUCEL,TAUCELQ                                                   
         MVI   TAUCLEN,TAUCLNQ                                                  
         MVC   TAUCINU,TGINV                                                    
         MVC   TAUCINC,INV04A                                                   
         GOTO1 ADDL                                                             
*                                                                               
         USING TANUD,R4                                                         
INV95    DS    0H                  IF RETRO FOR INVOICE                         
         OC    RET4INV,RET4INV                                                  
         BZ    VINV70                                                           
         LA    R4,ELEMENT                                                       
         XC    ELEMENT,ELEMENT     BUILD FREE FORM NUMBER ELEMENT               
         MVI   TANUEL,TANUELQ                                                   
         MVI   TANULEN,TANULNQ+L'TGINV                                          
         MVI   TANUTYPE,TANURT4I                                                
         MVC   TANUMBER(L'TGINV),RET4INV  SAVE INVOICE RETRO IS FOR             
         GOTO1 ADDL                                                             
         DROP  R4                                                               
         USING TAFND,R4                                                         
VINV70   OC    GUARCONT,GUARCONT   ANY GUARANTEE CONTRACT?                      
         BZ    VINV73                                                           
         LA    R4,ELEMENT          YES, ADD GUARANTEE CONTRACT NAME             
         XC    ELEMENT,ELEMENT     ELEMENT                                      
         MVI   TAFNEL,TAFNELQ                                                   
         MVI   TAFNLEN,TAFNLNQ+6   6 BYTES FOR GUARANTEE CONTRACT CODE          
         MVI   TAFNTYPE,TAFNTGCO                                                
         MVC   FULL,GUARCONT                                                    
         XC    FULL,HEXFFS2                                                     
         L     R1,FULL                                                          
         AHI   R1,1                                                             
         EDIT  (R1),(6,TAFNNAME),0,ALIGN=RIGHT                                  
         OC    TAFNNAME(6),=C'000000'                                           
         MVC   TAFNNAME(2),=C'GC'                                               
         GOTO1 ADDL                                                             
         SPACE 1                                                                
VINV73   DS    0H                                                               
         MVI   ELCODE,TAFNELQ                                                   
         GOTO1 GETL,DMCB,(1,=AL1(TAFNTASC))                                     
         BNE   VINV73J                                                          
         L     R4,TGELEM           R4=A(TGELEM)                                 
         MVI   0(R4),X'FF'                                                      
         MVI   ELCODE,X'FF'                                                     
         GOTO1 REMELEM                                                          
                                                                                
VINV73J  CLC   AGYSCDE,SPACES      DO WE HAVE AGENCY STUDIO CODE?               
         BNH   VINV75              NO, CONTINUE                                 
         LA    R4,ELEMENT          YES, ADD AGENCY STUDIO CODE                  
         XC    ELEMENT,ELEMENT     ELEMENT                                      
         MVI   TAFNEL,TAFNELQ                                                   
         MVI   TAFNLEN,TAFNLNQ+6   6 BYTES FOR AGENCY STUDIO CODE               
         MVI   TAFNTYPE,TAFNTASC                                                
         MVC   TAFNNAME(6),AGYSCDE                                              
         GOTO1 ADDL                                                             
         SPACE 1                                                                
VINV75   TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         BZ    XIT2                                                             
         SPACE 1                                                                
         USING WEBREQD,RE                                                       
         L     RE,TGAFAREQ         RE=A(WEB REQUEST DETAILS)                    
         SPACE 1                                                                
         USING WBPYSPD,R1                                                       
         LA    R1,WBPYSI1          R1=FIRST SPLIT INVOICE FIELD                 
         LA    R2,WBPYSIA          R2=LAST  SPLIT INVOICE FIELD                 
         DROP  RE                                                               
         SPACE 1                                                                
         USING TASID,R4                                                         
         LA    R4,ELEMENT          INITIALIZE SUBSIDIARY INVOICE                
         XC    ELEMENT,ELEMENT     ELEMENT                                      
         MVI   TASIEL,TASIELQ                                                   
         MVI   TASILEN,TASILNQ+L'WPSPEST                                        
         SPACE 1                                                                
VINV80   OC    WPSPEST,WPSPEST     AND ADD ONE FOR EACH SPLIT                   
         BZ    XIT2                                                             
         MVC   TASIEST(L'WPSPEST),WPSPEST                                       
         MVC   TASIPCT,WPSPPCTX                                                 
         GOTO1 ADDL                                                             
         SPACE 1                                                                
         LA    R1,WBPYSLNQ(R1)     BUMP TO NEXT SPLIT INVOICE                   
         CR    R1,R2                                                            
         BNH   VINV80                                                           
         B     XIT2                                                             
         DROP  R1                                                               
         EJECT                                                                  
         SPACE 3                                                                
*              ROUTINE ADDS ELTAFN AT R4 TO RECORD AT AIO IF NECESSARY          
         SPACE                                                                  
         USING TAFND,R4                                                         
ADDTAFN  NTR1                                                                   
         CLI   TAFNEL,0            IF WE HAVE FFN ELEMENT                       
         BE    XIT2                                                             
         ZIC   R1,TAFNLEN                                                       
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   ELEMENT(0),TAFNEL                                                
         GOTO1 ADDL                ADD IT TO RECORD                             
         B     XIT2                                                             
         EJECT                                                                  
*              ROUTINE TO HANDLE WRITING SCREEN RECORDS                         
         SPACE 1                                                                
* SCREEN RECORDS ARE WRITTEN OUT FOR EACH COMPLETED SCREEN. SUCCESSIVE          
* SCREENS ARE KEYED BY PAGE#, I.E., THE RELATIVE PAGE# (STARTING AT             
* PAGE ZERO) COMPLETED BY THE USER.  RELATED STORAGE AREAS ARE                  
* MAINTAINED AS FOLLOWS:                                                        
* A) FPAGE - INITIALIZED TO X'FF', IT CONTAINS THE PAGE# OF THE FIRST           
*            NON-CAST/SELECT PAYMENT SCREEN SAVED.                              
* B) DPAGE - CONTAINS THE PAGE# OF THE FIRST DETAIL PAYMENT SCREEN              
*            SAVED.  IT'S THE SAME AS FPAGE IF DETAIL IS NOT ON THE             
*            BASE SCREEN FOR THE USE PAID.                                      
* C) LPAGE - INITIALIZED TO X'FF', IT CONTAINS THE VERY LAST PAGE#              
*            WRITTEN TO THE FILE SO FAR.                                        
* D) PPAGE - CONTAINS THE PAGE# MOST RECENTLY WRITTEN TO FILE.  THIS IS         
*            NOT NECESSARILY THE LAST PAGE IF USER HAS PAGED BACKWARDS.         
* THE PAGE# OF THE CURRENT SCREEN TO BE ADDED/WRITTEN TO THE FILE IS            
* EITHER LPAGE+1 (THE DEFAULT) OR IS PASSED AS A PARAMETER (IN THE CASE         
* WHERE WE'VE PAGED BACKWARDS.)                                                 
         SPACE 1                                                                
*                                  P1 = A(OPTIONAL PAGE NUM)                    
*                                  P2 = A(OPTIONAL START ADDRESS)               
*                                  P3 = A(OPTIONAL END ADDRESS)                 
VPUTSCRN DS    0H                                                               
         LM    R2,R4,0(R1)         SAVE PARAMETERS                              
         SPACE 1                                                                
         LTR   R3,R3               IF WE DON'T HAVE START ADDRESS               
         BNZ   *+8                                                              
         LA    R3,CONTAGH          START SAVING SCREEN AT TOP                   
         STM   R3,R4,TGDUB         SAVE START/END ADDRESSES                     
         SPACE 1                                                                
         ZIC   RE,LPAGE            NEXT PAGE NUMBER SHOULD BE LAST PAGE         
         AHI   RE,1                + 1                                          
         LTR   R2,R2               TEST WE HAVE OVERRIDE NUMBER                 
         BZ    *+8                                                              
         IC    RE,0(R2)            YES - USE IT                                 
         STC   RE,PPAGE            SAVE PAGE NUMBER USED                        
         CLI   LPAGE,X'FF'         IF THIS IS FIRST TIME                        
         BE    *+14                                                             
         CLC   LPAGE,PPAGE         OR IF THIS IS NEW LAST PAGE                  
         BNL   *+10                                                             
         MVC   LPAGE,PPAGE         SAVE LAST                                    
         SPACE 1                                                                
         L     R3,AIO              R3=A(SCREEN RECORD)                          
         USING TLSCD,R3                                                         
         XC    TLSCKEY(50),TLSCKEY BUILD NEW RECORD                             
         MVI   TLSCCD,TLSCCDQ      SCREEN RECORD CODE                           
         MVC   TLSCAGY,TGAGY       AGENCY                                       
         MVC   TLSCINV,SCRINVNO    INVOICE NUMBER                               
         MVC   TLSCPG,PPAGE        PAGE NUMBER                                  
         MVC   TLSCSCR,TWASCR      SCREEN NUMBER                                
         MVC   TLSCLEN,DATADISP    INIT. RECORD LENGTH                          
         SPACE 1                                                                
         CLC   FPAGE,PPAGE         TEST WRITING BASE SCREEN                     
         BNE   PTSC5                                                            
         GOTO1 ADDREQEL            ADD GUAR AND FTRACK REQ ELEMENTS             
         SPACE 1                                                                
PTSC5    CLI   NCASTPG,0           TEST THERE'S A PAGE TABLE                    
         BE    PTSC10                                                           
         LA    R4,ELEMENT                                                       
         USING TASPD,R4            R4=A(SCREEN PAGE TABLE ELEMENT)              
         XC    ELEMENT,ELEMENT                                                  
         MVI   TASPEL,TASPELQ      ELEMENT CODE                                 
         ZIC   R1,NCASTPG          N'ENTRIES IN TABLE                           
         STC   R1,TASPNUM                                                       
         MHI   R1,PAGELNQ          * L'ENTRY                                    
         BCTR  R1,0                - 1                                          
         EX    R1,*+8              = L'EXECUTED MOVE                            
         B     *+10                                                             
         MVC   TASPTBL(0),PAGETBL                                               
         LA    R1,1+TASPTBL-TASPD(R1) + 1 + DISP. TO TBL                        
         STC   R1,TASPLEN          = L'ELEMENT                                  
         GOTO1 ADDL                ADD ELEMENT TO RECORD                        
         SPACE 1                                                                
PTSC10   BAS   RE,SCRNELS          ADD SCREEN ELEMENTS                          
         SPACE 1                                                                
         GOTO1 MYADDREC            ADD RECORD                                   
         B     XIT2                                                             
         EJECT                                                                  
*              ROUTINE TO ADD SCREEN ELEMENTS TO SCREEN RECORD                  
         SPACE 1                                                                
*        USING TLSCD,R3            R3=A(SCREEN RECORD)                          
SCRNELS  NTR1                                                                   
         L     R2,TGDUB            R2=START ADDRESS FOR SCREEN SAVING           
         XC    ELEMENT,ELEMENT                                                  
         LA    R4,ELEMENT          R4=A(SCREEN ELEMENT)                         
         USING TASCD,R4                                                         
         MVI   TASCEL,TASCELQ      ELEMENT CODE                                 
         SPACE 1                                                                
SCRN4    LR    RF,R2               RF=A(1ST FIELD TO SAVE), R2=A(NEXT)          
         XR    R0,R0                                                            
         XR    R1,R1               R1=L'ALL FIELDS TO SAVE                      
SCRN6    BAS   RE,SCRNEND          TEST FOR SCREEN END                          
         BE    SCRN8                                                            
         IC    R0,0(R2)            R0=L'FIELD                                   
         AR    R1,R0                                                            
         CHI   R1,210              INSURE ELEMENT DOESN'T GET TOO BIG           
         BH    *+10                                                             
         AR    R2,R0               BUMP TO NEXT FIELD                           
         B     SCRN6                                                            
         SR    R1,R0               REDUCT TOTAL BY L'CURRENT FIELD              
         SPACE 1                                                                
SCRN8    BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   TASCDATA,0(RF)      MOVE BLOCK OF FIELDS TO EL.                  
         SPACE 1                                                                
         SR    RF,RA               SET DISPLACEMENT TO 1ST FIELD IN EL.         
         STH   RF,TASCDISP                                                      
         LA    RE,TASCLNQ+1(R1)    SET L'ELEMENT                                
         STC   RE,TASCLEN                                                       
         AH    RE,TLSCLEN          ADD L'THIS ELEMENT TO L'REC SO FAR           
         LHI   R1,2000             SET R1=MAX LENGTH OF RECORD                  
         CLC   FPAGE,PPAGE         IF WRITING BASE SCREEN                       
         BNE   SCRN9                                                            
         TM    PAYMODE,DTLONBSE    AND DETAIL ON BASE                           
         BZ    SCRN9                                                            
         LHI   R1,1290             RESET R1-LEAVE ROOM FOR FQ + GQ ELS          
*                                  LATER (MAX 40 FQ AND 30 GQ SUB ELS)          
SCRN9    CR    RE,R1                                                            
         BL    SCRN12              TEST OK TO ADD THIS ELEMENT                  
         SPACE 1                                                                
         OI    TLSCSTAT,TLSCSCON   IT'S TOO LONG - SET CONTINUATION BIT         
         GOTO1 MYADDREC            AND ADD WHAT WE HAVE SO FAR                  
         ZIC   RE,TLSCSEQ                                                       
         AHI   RE,1                BUMP SEQUENCE NUMBER                         
         STC   RE,TLSCSEQ                                                       
         MVC   TLSCLEN,DATADISP    RESET RECORD LENGTH                          
         MVI   TLSCSTAT,0          CLEAR STATUS                                 
         MVI   TLSCELEM,0                                                       
         SPACE 1                                                                
SCRN12   GOTO1 ADDL                ADD ELEMENT TO RECORD                        
         SPACE 1                                                                
         BAS   RE,SCRNEND          IF WE HAVEN'T REACHED E-O-S                  
         BNE   SCRN4               BUILD ANOTHER ELEMENT                        
         B     XIT2                                                             
         SPACE 1                                                                
SCRNEND  CLI   0(R2),0             E-O-S TEST                                   
         BE    YESR                                                             
         OC    TGDUB+4(4),TGDUB+4  OR IF WE HAVE END ADDRESS                    
         BZ    *+12                                                             
         CLM   R2,7,TGDUB+5        TEST WE'VE PASSED IT                         
         BH    YESR                                                             
         B     NOR                                                              
         EJECT                                                                  
*              ROUTINE TO HANDLE RETRIEVING SCREEN RECORDS                      
         SPACE 1                                                                
* SCREEN RECORDS ARE RETRIEVED FROM THE FILE USING TWO STORAGE AREAS,           
* (ONE OF WHICH MUST BE A PARAMETER) WHICH ARE MAINTAINED AS FOLLOWS:           
* A) SPAGE - MOST RECENT CAST/SELECT SCREEN PAGE# RETRIEVED. THESE              
*            SCREENS ARE USED DURING GETCAST FOR DETERMINING WHICH CAST         
*            RECORDS ARE PASSED TO PAY CONTROL OVERLAYS FOR PAYMENT.            
*            CAST/SELECT SCREENS ARE READ INTO ATIA FOR USE BY GETCAST.         
* B) GPAGE - MOST RECENT REGULAR PAYMENT SCREEN PAGE# RETRIEVED.                
*            INITIALIZED TO X'FF' EVERY TIME A SCREEN IS DISPLAYED FOR          
*            THE FIRST TIME.  THESE SCREENS ARE USED FOR TWO PURPOSES:          
*            1) BACKWARDS PAGING - USER ELECTS (BY MEANS OF PFKEY) TO           
*                 VIEW & POSSIBLY CHANGE A PREVIOUSLY COMPLETED SCREEN.         
*            2) RECORD WRITING - AT END OF PAYMENT, AFTER USER HITS             
*                 ENTER FOR THE LAST TIME, EACH PAGE IS RETRIEVED AND           
*                 PROCESSED FOR CHECK RECORD WRITES.                            
* THE RETRIEVAL NORMALLY ASSUMES THAT THE PAGE# TO BE DISPLAYED IS ONE          
* MORE THAN THE CURRENT VALUE OF THE PAGE# BEING PASSED (IT ASSUMES A           
* SEQUENTIAL PAGING PROCESS.)  IT ALSO ALLOWS FOR A RE-READ OF THE              
* CURRENT PAGE#.  THIS IS USED BY GETCAST AFTER EACH HIT OF ENTER TO            
* RETRIEVE THE SAME CAST/SELECT PAGE AS LAST TIME (IN CASE IT WASN'T            
* ENTIRELY PROCESSED ON THE PREVIOUS PAYMENT SCREEN) AND BY THE RECORD          
* WRITING LOGIC TO FORCE THE FIRST PAGE TO BE FPAGE.                            
         SPACE 1                                                                
*                                  P1, BYTE 0 X'80'=RE-READ CURRENT PG          
*                                             X'40'=IGNORE PAGE INFO.           
*                                  P1, BYTES 1-3 = A(PAGE NUMBER)               
*                                  P2, BYTES 1-3 = A(OUTPUT AREA)               
VGETSCRN DS    0H                                                               
         MVC   TGBYTE2,0(R1)       SAVE PARAMETER BYTE                          
         L     R4,0(R1)            R4=A(PAGE NUMBER)                            
         L     R2,4(R1)            R2=A(OUTPUT AREA)                            
         MVI   GSCRN,0             PRE-CLEAR SCREEN CODE                        
         SPACE 1                                                                
         USING TLSCD,R3                                                         
         LA    R3,KEY              BUILD KEY                                    
         XC    TLSCKEY,TLSCKEY                                                  
         MVI   TLSCCD,TLSCCDQ      SCREEN RECORD CODE                           
         MVC   TLSCAGY,TGAGY       AGENCY                                       
         MVC   TLSCINV,SCRINVNO    INVOICE NUMBER                               
         SPACE 1                                                                
         ZIC   R1,0(R4)                                                         
         TM    TGBYTE2,X'80'       TEST RE-READ CURRENT PAGE                    
         BO    *+8                                                              
         AHI   R1,1                ELSE BUMP TO NEXT PAGE                       
         STC   R1,0(R4)                                                         
         STC   R1,TLSCPG           PAGE NUMBER TO KEY                           
         SPACE 1                                                                
         GOTO1 HIGH                READ DIRECTORY                               
         CLC   TLSCKEY(TLSCSCR-TLSCKEY),KEYSAVE  INSURE RECORD IS VALID         
         BNE   GTSCX                                                            
         MVC   GSCRN,TLSCSCR       SAVE SCREEN NUMBER                           
         MVC   KEYSAVE,TLSCKEY     SAVE KEY WITH PAGE AND SCREEN                
         MVI   TGFULL,X'FF'        SET TO SAVE A(FIRST FIELD RESTORED)          
         SPACE 1                                                                
GTSC4    GOTO1 GETREC              GET THE RECORD                               
         SPACE 1                                                                
         TM    TGBYTE2,X'40'       TEST DON'T WANT PAGE TABLE DATA              
         BO    GTSC6               (USED WHEN ASKING FOR SELECT SCRNS)          
         L     R4,AIO                                                           
         MVI   ELCODE,TASPELQ      LOOK FOR SCREEN PAGE TABLE ELEMENT           
         BAS   RE,GETEL2                                                        
         BNE   GTSC6                                                            
         USING TASPD,R4                                                         
         MVC   NCASTPG,TASPNUM     RESTORE N'ENTRIES IN TABLE                   
         MVC   PAGETBL,TASPTBL     AND THE TABLE TO LOCAL W/S                   
         SPACE 1                                                                
GTSC6    L     R4,AIO                                                           
         MVI   ELCODE,TASCELQ      GET SCREEN ELEMENTS                          
         BAS   RE,GETEL2                                                        
         B     *+8                                                              
GTSC8    BAS   RE,NEXTEL2                                                       
         BNE   GTSC10                                                           
         SPACE 1                                                                
         USING TASCD,R4                                                         
         LA    RE,TASCDATA         RE=A(DATA IN ELEMENT)                        
         LR    R0,R2                                                            
         AH    R0,TASCDISP         R0=A(LOCATION IN OUTPUT AREA)                
         CLI   TGFULL,X'FF'                                                     
         BNE   *+8                                                              
         ST    R0,TGFULL           SAVE A(FIRST FIELD)                          
         ZIC   RF,TASCLEN                                                       
         SHI   RF,TASCLNQ          RF=L'DATA IN ELEMENT                         
         LR    R1,RF               R1=RF                                        
         MVCL  R0,RE               MOVE ELEMENT DATA TO OUTPUT AREA             
         B     GTSC8               LOOK FOR ANOTHER ELEMENT                     
         SPACE 1                                                                
GTSC10   TM    TLDRSTAT-TLDRD(R3),TLSCSCON  TEST RECORD IS CONTINUED            
         BZ    GTSCX                                                            
         GOTO1 SEQ                                                              
         CLC   TLSCKEY(TLSCSEQ-TLSCKEY),KEYSAVE  INSURE SAME PAGE               
         BE    GTSC4                                                            
         DC    H'0'                MISSING CONTINUATION RECORD                  
         SPACE 1                                                                
GTSCX    CLI   GSCRN,0             DID WE FIND A VALID SCREEN                   
         BE    NO2                                                              
         BAS   RE,TRANSMIT         TRANSMIT RESTORED FIELDS                     
         B     YES2                                                             
         EJECT                                                                  
*              ROUTINE TO TRANSMIT RESTORED FIELDS                              
         SPACE 1                                                                
TRANSMIT DS    0H                                                               
         L     R1,TGFULL           R1=A(FIRST FIELD RESTORED)                   
         XR    R0,R0                                                            
TRANS2   CLI   0(R1),0                                                          
         BER   RE                                                               
         OI    6(R1),X'80'                                                      
         IC    R0,0(R1)                                                         
         AR    R1,R0                                                            
         B     TRANS2                                                           
         EJECT                                                                  
*              FILE RECORD WRITING ROUTINES                                     
         SPACE 1                                                                
VMYADDRC DS    0H                  *** ADD A FILE RECORD                        
         TM    PAYMODE,DRAFT       DON'T BOTHER IF DRAFT PAYMENT                
         BO    XIT2                                                             
         L     R4,AIO              R4=A(RECORD)                                 
         USING TLRCD,R4                                                         
         XC    KEY,KEY                                                          
         LA    R3,KEY              R3=A(KEY)                                    
         USING TLDRD,R3                                                         
         MVC   TLDRKEY,TLRCKEY     SET ACTIVE KEY                               
         MVC   TLDRSTAT,TLRCSTAT   AND STATUS FROM RECORD                       
         OI    DMINBTS,X'08'       READ FOR DELETED                             
         MVI   RDUPDATE,C'Y'       AND FOR UPDATE                               
         GOTO1 HIGH                LOOK FOR RECORD ALREADY ON FILE              
         SPACE 1                                                                
         CLC   TLDRKEY,KEYSAVE     TEST WE FOUND RECORD                         
         BNE   MYADR4                                                           
         TM    TLDRSTAT,X'80'      IT HAD BETTER BE DELETED                     
         BO    *+14                                                             
         CLI   TLDRCD,TLSCCDQ      EXCEPT FOR SCREEN RECORDS                    
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   TLDRKEY,KEYSAVE     RESTORE ORIGINAL KEY                         
         MVC   TLDRSTAT,KEYSAVE+TLDRSTAT-TLDRD  AND STATUS                      
         GOTO1 MYWRITE             AND WRITE IT BACK                            
         SPACE 1                                                                
*        MVC   AIO,AIO3            NOW SET TO GET THE RECORD                    
         MVC   AIO,AIO2            NEW CHECK ALREADY IN AIO3, USE AIO2          
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         GOTO1 GETREC              GET THE RECORD SO THAT WE CAN ...            
         ST    R4,AIO                                                           
         NI    TLRCSTAT,X'7F'      UNDELETE                                     
         GOTO1 MYPUTREC            WRITE NEW ONE BACK OVER DELETED ONE          
         B     MYADRX                                                           
         SPACE 1                                                                
MYADR4   MVC   KEY,KEYSAVE                                                      
         GOTO1 ADDREC              ADD FILE RECORD                              
         SPACE 1                                                                
         CLC   SYSFIL,=CL8'CHKFIL' IF NOT ADDING TO CHECK FILE                  
         BE    MYADR5                                                           
         CLC   DALSTADD,KEY        AND DISK ADDRESS OF LAST ADD IS              
         BL    *+6                 NOT HIGHER THAN THIS ADD ...                 
         DC    H'00'               TRAP IT!                                     
         MVC   DALSTADD,KEY                                                     
         B     MYADRX                                                           
         SPACE 1                                                                
MYADR5   CLC   DALSTCAD,KEY        IF ADDING TO CHECK FILE                      
         BL    *+6                 AND DISK ADDRESS OF LAST ADD IS              
         DC    H'00'               NOT HIGHER THAN THIS ADD ...                 
         MVC   DALSTCAD,KEY        TRAP IT!                                     
         SPACE 1                                                                
MYADRX   NI    DMINBTS,X'F7'                                                    
         B     XIT2                                                             
         SPACE 3                                                                
VMYPUTRC DS    0H                  *** WRITE A FILE RECORD                      
         TM    PAYMODE,DRAFT       DON'T BOTHER IF DRAFT PAYMENT                
         BO    XIT2                                                             
         GOTO1 PUTREC                                                           
         B     XIT2                                                             
         EJECT                                                                  
*              DIRECTORY RECORD WRITING ROUTINES                                
         SPACE 1                                                                
         USING TLDRD,R3                                                         
VMYADD   DS    0H                  *** ADD A DIRECTORY RECORD                   
         TM    PAYMODE,DRAFT       DON'T BOTHER IF DRAFT PAYMENT                
         BO    MYADX                                                            
         LA    R3,KEY              R3=A(RECORD)                                 
         SPACE 1                                                                
         MVC   ELEMENT(L'TLDRREC),TLDRREC  SAVE RECORD TO ADD                   
         SPACE 1                                                                
         OI    DMINBTS,X'08'       SET TO READ FOR DELETED                      
         MVI   RDUPDATE,C'Y'       AND FOR UPDATE                               
         GOTO1 HIGH                                                             
         NI    DMINBTS,X'F7'                                                    
         SPACE 1                                                                
         CLC   TLDRKEY,KEYSAVE     DID WE FIND RECORD                           
         BNE   MYAD4                                                            
         TM    TLDRSTAT,X'80'      YES - IT HAD BETTER BE DELETED               
         BO    *+6                                                              
         DC    H'0'                                                             
         MVC   TLDRREC,ELEMENT     RESTORE RECORD                               
         SPACE 1                                                                
         GOTO1 MYWRITE             WRITE IT BACK OVER DELETED ONE               
         B     MYADX                                                            
         SPACE 1                                                                
MYAD4    MVC   TLDRREC,ELEMENT     RESTORE RECORD                               
         SPACE 1                                                                
         GOTO1 ADD                 ADD DIRECTORY RECORD                         
         SPACE 1                                                                
MYADX    B     XIT2                                                             
         SPACE 3                                                                
VMYWRITE DS    0H                  *** WRITE A DIRECTORY RECORD                 
         TM    PAYMODE,DRAFT       DON'T BOTHER IF DRAFT PAYMENT                
         BO    XIT2                                                             
         GOTO1 WRITE                                                            
         B     XIT2                                                             
         EJECT                                                                  
*              ROUTINE TO HANDLE WRAPPING UP PAYMENT                            
         SPACE 1                                                                
VPAYDONE DS    0H                                                               
         NI    PRGSTAT,ALL-PAYINITD  SET TO RE-INITIALIZE NEXT TIME             
         NI    TRNSTAT,ALL-PYINPROG  SET PAY UPDATE NOT IN PROGRESS             
         TM    PRGSTAT,INITSARD      IF TSAR INITIALIZED (IN USE)               
         BZ    PAYX                                                             
         GOTO1 TSARCNTL,DMCB,0       INDICATE NO LONGER USING TSAR              
         SPACE 1                                                                
PAYX     BRAS  RE,WEBDONE          IF PAYMENT INFO IS COMING FROM WEB           
         BE    XIT2                RETURN TO TAGEN51                            
         SPACE 1                                                                
         L     R2,EFHREC           SET CURSOR TO RECORD FIELD                   
         B     DONE                GIVE PAYMENT COMPLETE MESSAGE                
         EJECT                                                                  
*              ROUTINE TO DISPLAY AMOUNTS ON RHS OF DETAILS SCREENS             
         SPACE 1                                                                
VDISRHS  DS    0H                                                               
         LA    RF,5                RF=N'POSSIBLE AMOUNTS                        
         LA    R3,TCAPPLCR         R3=A(AMOUNTS IN W/S)                         
         LA    R4,DSPAPPL          R4=A(DISPLACEMENTS TO FIELDS)                
         MVI   BYTE,C'N'           SET NOTHING DISPLAYED YET                    
         SPACE 1                                                                
DRHS2    LH    R2,0(R4)                                                         
         LTR   R2,R2               TEST FIELD ON SCREEN                         
         BZ    DRHS8                                                            
         A     R2,ATHSLINE         ADD A(THIS LINE)                             
         MVI   TGBYTE,C'N'         TURN OFF TRANSMIT SWITCH                     
         SPACE 1                                                                
         L     RE,0(R3)            RE=AMOUNT TO DISPLAY                         
         CHI   RF,1                LAST AMOUNT IS PAYMENT                       
         BNE   DRHS4                                                            
         CLI   TCW4TYPE,TAW4TYCA   IF THIS IS A CANADIAN                        
         BE    DRHS3                                                            
         CLI   TCW4TYPE,TAW4TYCO   OR CORPORATION                               
         BE    DRHS3                                                            
         CLI   TCW4TYPE,TAW4TYTR   OR TRUSTEE                                   
         BE    DRHS3                                                            
         CLI   TCW4TYPE,TAW4TYFO   OR A FOREIGNER                               
         BNE   *+12                                                             
DRHS3    LA    R3,4(R3)            BUMP TO NEXT ACCUM                           
         L     RE,0(R3)                                                         
         SPACE 1                                                                
         CLI   TGUSEQU,UEVE        IF MAKING EVENT PAYMENT                      
         BNE   *+8                 ADD REIMBURSED (NON-TAXABLE) AMOUNT          
         A     RE,TCEXP            TO PAYMENT AMOUNT                            
         SPACE 1                                                                
         CLI   BYTE,C'Y'           ALWAYS DISPLAY PAYMENT IF SOMETHING          
         BE    DRHS5               ELSE ON THIS LINE                            
         SPACE                                                                  
         TM    TCINPUT,TCINPAY     IF AMOUNT OVERRIDDEN (OVERSCALE AMT)         
         BZ    DRHS4                                                            
         CLI   DSPNP,X'FF'         ALWAYS DISPLAY IF HAVE NP FIELD              
         BNE   DRHS5               (NOT USES WHICH NEED SP,HR.MN, ETC.)         
         SPACE 1                                                                
DRHS4    CHI   RF,5                TEST DISPLAYING APPLIED AMOUNT               
         BNE   *+12                                                             
         TM    TCINPUT,TCINAPPL    IF APPLIED AMOUNT OVERRIDDEN                 
         BO    DRHS5               DISPLAY EVEN IF ZERO                         
         SPACE 1                                                                
         CHI   RF,2                TEST DISPLAYING MISC DED                     
         BNE   DRHS4A                                                           
         A     RE,TCDUES           ADD IN UNION DUES                            
         B     DRHS4B                                                           
         SPACE 1                                                                
DRHS4A   CHI   RF,3                TEST DISPLAYING SUBJECT TO P&H               
         BNE   DRHS4B                                                           
         TM    LCLSTAT3,SOAPRES    IF USE IS A SOAP RESIDUAL                    
         BZ    *+8                                                              
         L     RE,TCPNH            DISPLAY P&H AMOUNT INSTEAD                   
         SPACE 1                                                                
DRHS4B   LTR   RE,RE               IF AMOUNT IS ZERO                            
         BNZ   DRHS5                                                            
         TM    1(R2),X'20'                                                      
         BO    DRHS4D                                                           
         CLI   5(R2),0             THEN ONLY DISPLAY IF THERE WAS I/P           
         BE    DRHS6                                                            
         B     DRHS5                                                            
DRHS4D   CHI   RF,2                IF PROTECTED, TEST DISPLAYING MDED           
         BNE   DRHS6                                                            
         OC    8(10,R2),8(R2)      TEST FOR SOMETHING IN FLD                    
         BZ    DRHS6                                                            
         SPACE 1                                                                
DRHS5    EDIT  (RE),(13,BLOCK),2,FLOAT=-  FIRST EDIT TO BLOCK                   
         SPACE 1                                                                
         ST    RF,FULL                                                          
         GOTOR ONCAINV,DMCB,ELTACA IF 2404A PERFORMER BELONGS ON                
         L     RF,FULL             CANADIAN INVOICE                             
         BNE   DRHS5A                                                           
         OI    LCLSTAT4,ACTON      SET ACTRA CAST ON PAYMENT                    
         B     DRHS5B                                                           
DRHS5A   OI    LCLSTAT4,NONACTON   ELSE, SET NON-ACTRA CAST ON PAYMENT          
         SPACE 1                                                                
DRHS5B   LA    R1,BLOCK            R1=A(WHERE TO MOVE TO FIELD FROM)            
         LA    R0,3                                                             
         CLI   0(R1),C' '          INSURE MOST SIGNIFICANT DIGITS DISP.         
         BH    *+12                                                             
         LA    R1,1(R1)                                                         
         BCT   R0,*-12                                                          
         MVC   8(10,R2),0(R1)      MOVE TO FIELD                                
         MVI   BYTE,C'Y'           TURN ON TRANSMIT SWITCH                      
         MVI   TGBYTE,C'Y'         SET SOMETHING DISPLAYED ON THIS LINE         
         SPACE 1                                                                
DRHS6    CLI   TGBYTE,C'Y'         TEST WE NEED TO TRANSMIT THIS FIELD          
         BNE   *+12                                                             
         OI    6(R2),X'80'                                                      
         OI    4(R2),X'20'         SET VALIDATED                                
         SPACE 1                                                                
DRHS8    LA    R3,4(R3)            BUMP TO NEXTS                                
         LA    R4,2(R4)                                                         
         BCT   RF,DRHS2                                                         
         SPACE                                                                  
         CLI   TCEXPICD,0          IF HAVE REIMB EXP INDICATOR                  
         BE    DRHS10                                                           
         CLC   DSPREIMI,=X'FFFF'   AND FIELD IS ON SCREEN                       
         BE    DRHS10                                                           
         LH    R2,DSPREIMI         DISPLAY IT                                   
         A     R2,ATHSLINE                                                      
         MVC   8(L'TCEXPICD,R2),TCEXPICD                                        
         OI    6(R2),X'80'                                                      
         SPACE                                                                  
DRHS10   CLC   DSPAPPLI,=X'FFFF'   IF APPLIED CODE FIELD ON SCREEN              
         BE    DRHS20                                                           
         CLI   TCAPPLCD,0          AND HAVE CODE                                
         BE    DRHS20                                                           
         LH    R2,DSPAPPLI         DISPLAY IT                                   
         A     R2,ATHSLINE                                                      
         MVC   8(L'TCAPPLCD,R2),TCAPPLCD                                        
         OI    6(R2),X'80'                                                      
         SPACE                                                                  
DRHS15   CLI   TCAPPLCD,APPLWSPU   TEST APPLIED CODE NOT WSP UPGRADE            
         BE    DRHS20                                                           
         CLI   TCAPPLCD,APPLCAB    AND NOT CABLE                                
         BE    DRHS20                                                           
         L     R1,TCGROSS          IF GROSS                                     
         S     R1,TCAPPLCR         - APPLIED AMOUNT < 0                         
         BNM   DRHS20                                                           
         LH    R2,DSPAPPL          MEANS NEGATIVE PAYMENT                       
         A     R2,ATHSLINE                                                      
         NI    4(R2),ALL-X'20'     TURN OFF VALIDATED                           
         J     AMTINV              ERROR FOR APPLIED AMOUNT                     
         SPACE                                                                  
DRHS20   OC    DSPMDED,DSPMDED     TEST HAVE MISC. DED. FIELD                   
         BZ    XIT2                                                             
         L     R1,TCMDED                                                        
         A     R1,TCDUES                                                        
         C     R1,TCPAY                                                         
         BNH   XIT2                MISC. DED + DUES CAN'T BE > PAY AMT          
         LH    R2,DSPMDED          R2=DISP TO FIELD                             
         A     R2,ATHSLINE         ADD A(THIS LINE)                             
         NI    4(R2),ALL-X'20'     TURN OFF VALIDATED                           
         J     AMTINV                                                           
         EJECT                                                                  
*              ROUTINE CONTROLS PERVAL CALLS                                    
         SPACE 1                                                                
*                                  P1=1ST PARAM. FOR DATCON CALL                
*                                  P2 BYTE 0=Y ==> CALC. END DATE               
*                                  P2 BYTES 1-3=A(W/S FOR PWOS DATES)           
VPVAL    DS    0H                                                               
         L     R2,0(R1)                                                         
         L     R4,4(R1)                                                         
         SPACE 1                                                                
         LA    R0,PVINSGLS         SET SINGLE DATE OK                           
         CLI   4(R1),C'Y'                                                       
         BNE   *+8                                                              
         LA    R0,PVINSGLS+PVIN1DYL ALSO SET RETURN 1 DAY LESS IN END           
         SPACE 1                                                                
         GOTO1 DATCON,DMCB,(R2),(8,WORK)  CONVERT START FOR PERVAL              
         MVC   WORK+9(5),LCYCLE           MOVE IN L'CYCLE                       
         MVI   WORK+8,C'-'                MUST SET HYPEN                        
         SPACE 1                                                                
         LA    R3,BLOCK            R3=A(RETURN BLOCK)                           
         USING PERVALD,R3                                                       
         XC    PVALOUTB,PVALOUTB   PRE-CLEAR IT                                 
         SPACE 1                                                                
         MVI   BYTE,14             SET LENGTH                                   
         OI    BYTE,X'40'          AND VALIDATE AS MM/DD                        
         GOTO1 PERVAL,DMCB,(BYTE,WORK),((R0),(R3))                              
         SPACE 1                                                                
         MVC   0(6,R4),PVALPSTA    RETURN PWOS START/END DATES                  
         B     XIT2                                                             
         EJECT                                                                  
*              ROUTINE TO EXTRACT DETAILS FROM CAST OR ECAST RECORD             
         SPACE 1                                                                
VCASTDET DS    0H                                                               
         CLI   TGUSEQU,UVRE        BUILD VNR/VRE TABLES                         
         BE    *+8                                                              
         CLI   TGUSEQU,UVNR                                                     
         BNE   *+14                                                             
         MVC   HALF,TGCSORT+4      SET HALF WITH CAST INPUT SEQ                 
         BRAS  RE,BLDCVER          BUILD CSTVERS TABLE                          
                                                                                
         L     R3,AIO              R3=A(CAST OR ECAST RECORD)                   
         ST    R3,TCACAST          SAVE ITS ADDRESS                             
         XC    ELTATI,ELTATI       CLEAR CORP. TAX ID ELEMENT                   
         NI    LCLSTAT4,ALL-NOAGT  CLEAR NO AGENT FLAG                          
         TM    LCLSTAT3,SOAPRES    IF USE IS A SOAP RESIDUAL                    
         BO    CASTD5              SKIP - ALREADY SET TG STUFF                  
         SPACE 1                                                                
         TM    PAYSTAT2,TAPDPCIB   IF CREDIT PAYMENT FOR A PAYMENT              
         JZ    CASTD1              WITH SAVED BILLING RATES                     
         BRAS  RE,CRDCAST          SET CAST BACK TO ORIGINAL PAYMENT            
         SPACE 1                                                                
         USING TLCAD,R3                                                         
CASTD1   MVC   TGSSN,TLCASSN       S/S NUMBER                                   
         MVC   TGCSORT,TLCASORT    SORT KEY                                     
         SPACE 1                                                                
         CLI   TGUSEQU,USOP        IF SOP PAYMENT                               
         BNE   CASTD5                                                           
         MVI   ELCODE,TASOELQ      GET EPISODE NUMS ELEMENT                     
         LR    R4,R3                                                            
         BAS   RE,GETEL2                                                        
         BNE   CASTD3                                                           
         USING TASOD,R4            R4=A(EPISODE NUMS ELEMENT)                   
         ZIC   R1,TASOLEN          VARIABLE LENGTH SO GET ACTUAL                
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   ELTASO(0),TASOEL    SAVE ENTIRE TASO ELEMENT                     
         SPACE 1                                                                
CASTD3   MVI   ELCODE,TACRELQ      GET APPLED CREDITS ELEMENT                   
         LR    R4,R3                                                            
         BAS   RE,GETEL2                                                        
         BNE   CASTD5                                                           
         USING TACRD,R4            R4=A(APPLIED CREDITS ELEMENT)                
         MVC   ELTACR,TACREL       SAVE ENTIRE ELEMENT                          
         SPACE 1                                                                
         USING WEBRESD,R1                                                       
CASTD5   TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    CASTD5A                                                          
         TM    TGFASTAT,TGCRNOPY   (BUT NOT CERNO)                              
         JO    CASTD5A                                                          
         L     R1,AWEBRES          R1=A(CAST ENTRY IN WEB RES DET AREA)         
         MVC   TCUFCAT,WRSUFCAT    SET UPGRADED FROM CAST CATEGORY              
         DROP  R1                                                               
         SPACE 1                                                                
CASTD5A  MVI   ELCODE,TACAELQ      GET CAST DETAILS ELEMENT                     
         LR    R4,R3                                                            
         BAS   RE,GETEL2                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
         USING TACAD,R4            R4=A(CAST DETAILS ELEMENT)                   
         MVC   ELTACA,TACAEL       SAVE ENTIRE CAST ELEMENT                     
*                                                                               
         LA    R4,ELTACA                                                        
*                                                                               
         OC    TCUFCAT,TCUFCAT     IF NOT UPGRADING FROM VITA                   
         JNZ   CASTD5B             SET SECOND OVERSCALE PERCENTAGE              
         GOTO1 SETOV2,DMCB,(R4),(R3),TGUSCDE                                    
*                                                                               
CASTD5B  NI    LCLSTAT8,ALL-CNNOTCAN                                            
         TM    TGUSSTAT,SESSION    MUST BE A SESSION PAYMENT                    
         BZ    CASTD5C                                                          
         CLC   TACAUNIT,=C'CN '    CN NO LONGER VALID IF AOS IS ACTIVE          
         BE    CNNOTVAL                                                         
*                                                                               
CASTD5C  BRAS  RE,STEVEPRO         SET TAX UNIT FOR EVE PAYMENTS                
         BRAS  RE,SETICYC          SET INDIV'S CYCLE (IF SPLIT CYCLE)           
*                                                                               
         BRAS  RE,GETGUAR          GET GRT REC AND SET INFO                     
         SPACE 1                                                                
         OC    OPTAGNT,OPTAGNT     IF WE HAVE OVERRIDE AGENT                    
         BZ    CASTD8                                                           
         CLC   TACANCDE,OPTAGNT    AND IT'S DIFFERENT FROM CAST REC             
         BE    CASTD9                                                           
         MVC   TACANCDE,OPTAGNT    MOVE TO LOCAL CAST ELEMENT                   
         OI    TACASTAT,TACASTAO   AND TURN ON OVERRIDE BIT                     
         B     CASTD9              TGAGT ALREADY SET ALONG WITH OPTAGNT         
         SPACE 1                                                                
CASTD8   GOTO1 TRNSAGT,DMCB,(X'40',TACANCDE),TGAGT       SET TGAGT              
         SPACE 1                                                                
CASTD9   CLI   TGUSMEDS,PRINT      FOR PRINT PAYMENTS                           
         BNE   CASTD10                                                          
         OC    TACANCDE,TACANCDE   IF NO AGENT                                  
         BNZ   CASTD10                                                          
         OC    TACARATE,TACARATE   BUT HAVE AGENT FEE RATE                      
         BZ    *+8                                                              
         OI    LCLSTAT4,NOAGT      SET MISSING AGNT FLAG TO ABORT LATER         
         SPACE 1                                                                
CASTD10  MVC   TCCAONOF,TACAONOF   SAVE ON/OFF CAMERA                           
         MVC   TCCADBL,TACADBL          N'DOUBLES                               
         MVC   TCCASTAT,TACASTAT        STATUS BYTE                             
         MVC   TCCASTA2,TACASTA2        2ND STATUS BYTE                         
         MVC   TCCASTA3,TACASTA3        3RD STATUS BYTE                         
         MVC   TGLCL,TACALOCL           LOCAL                                   
         MVC   TCCAFRST,TACAFRST        FIRST SERVICES DATE                     
         MVC   TCCAFCYC,TACAFCYC        FIRST FIXED CYCLE                       
         MVC   TCCARATE,TACARATE        AGENT FEE RATE                          
         SPACE 1                                                                
         CLI   TGUSEQU,UEVE        IF MAKING EVENT PAYMENT                      
         BNE   CASTD11                                                          
         L     R2,ATMPPAYD                                                      
         LA    RF,UHMTPTRS         SET ADDRESS FOR EVTIME RECORD                
         ST    RF,TCAETREC                                                      
         SPACE 1                                                                
CASTD11  OC    TCUFCAT,TCUFCAT     IF UPGRADING FROM VITA                       
         JNZ   CASTD15             SKIP ALL OVERSCALE CODE                      
         SPACE 1                                                                
         MVC   TCOV2,TACAOV2       ELSE SET SECOND OVERSCALE PCT                
         SPACE 1                                                                
         USING TACOD,R4                                                         
         LA    R4,ELTACO                                                        
         CLI   TACOTYPE,CTYSOAP    IF COMMERCIAL TYPE IS SOAP                   
         BNE   *+10                                                             
         XC    TCOV2,TCOV2         NO OV2, TACAOV2 IS ORGED OVER                
         SPACE 1                                                                
         CLI   TGUSEQU,USOP        TEST SOP USE                                 
         BNE   CASTD12                                                          
         SPACE 1                                                                
         GOTO1 GETOV1,DMCB,TGUSCDE,TCOVAMT GET 1ST OVERSCALE                    
         CLI   0(R1),X'FF'         IF IT'S AN AMOUNT                            
         BNE   *+12                                                             
         OI    TCCASTST,TCCAOVAM   SET HAVE OVERSCALE AMOUNT(IN CASE 0)         
         B     *+10                                                             
         XC    TCOVAMT,TCOVAMT     ELSE CLEAR OVERSCALE AMOUNT                  
         SPACE 1                                                                
         GOTO1 GETOV1,DMCB,=C'OTH',TCEXP GET 1ST OVERSCALE FOR OTH              
         CLI   0(R1),X'FF'         IF IT'S AN AMOUNT                            
         BNE   *+12                                                             
         MVI   TCEXPICD,C'1'       SET INCLUDE CODE FOR WARDROBE FEE            
         B     *+10                                                             
         XC    TCEXP,TCEXP         ELSE CLEAR REIMBURSED EXPENSES AMT           
         B     CASTD15                                                          
         SPACE 1                                                                
CASTD12  GOTO1 GETOV1,DMCB,TGUSCDE,TCOV1 GET 1ST OVERSCALE                      
         CLI   0(R1),X'FF'         IF IT'S AN AMOUNT                            
         BNE   CASTD15                                                          
         MVC   TCOVAMT,TCOV1       SAVE IT                                      
         OI    TCCASTST,TCCAOVAM   SET HAVE OVERSCALE AMOUNT(IN CASE 0)         
         SPACE                                                                  
         TM    CASTSTAT,CSTINPY    TEST PAYMENT NOT INPUT                       
         BO    CASTD14                                                          
         MVC   TCPAY,TCOV1               SAVE AS PAYMENT, SET HAVE              
         OI    TCINPUT,TCINPAY+TCINOVSC  PAYMENT AMOUNT (IN CASE 0),            
*                                        SET IT'S FROM OVERSCALE AMOUNT         
CASTD14  XC    TCOV1,TCOV1               CLEAR RATE                             
         SPACE                                                                  
CASTD15  CLI   TGUSEQU,UEVE        IF NOT AN EVENT PAYMENT                      
         BE    YES2                                                             
         GOTO1 CATVAL,DMCB,TGCAT   SET CATEGORY INFO                            
         BNE   NO2                                                              
         CLI   TGUSMEDS,PRINT      IF PRINT PAYMENT                             
         BNE   CASTD20                                                          
         XC    ELTADL,ELTADL                CLEAR DEAL ELEMENT                  
         XC    TGUNI(L'TGUNILCL),TGUNI      CLEAR UNION/LCL STUFF               
         XC    TGUNCDE(L'TGUNDATA),TGUNCDE  CLEAR UNION DATA                    
         XC    TGUNEQUS,TGUNEQUS                                                
         XC    TGYRCDE(L'TGYRDATA),TGYRCDE  CLEAR YEAR DATA                     
         SPACE 1                                                                
         CLI   TWASCR,SCR96        DONE IF CALLED FROM CAST SELECT              
         BE    YES2                                                             
         SPACE 1                                                                
         USING TADLD,R4                                                         
         MVI   ELCODE,TADLELQ      GET DEAL ELEMENT                             
         MVC   TGDUB(3),TGAREA     FOR AREA AND USE BING PAID                   
         MVC   TGDUB+3(3),TGUSE                                                 
         GOTO1 GETL,DMCB,(6,TGDUB) IF NONE, RETURN CC EQUAL TO                  
         BNE   YES2                DISPLAY ON DETAIL SCRN W/NO PAY AMT          
         L     R4,TGELEM                                                        
         MVC   ELTADL,TADLEL       SAVE ENTIRE DEAL ELEMENT                     
         MVC   TCOVAMT,TADLAMT     SAVE DEAL AMT TO USE AS PAYMNT LATER         
         LA    R4,ELTADL                                                        
         OC    OPTEXPD,OPTEXPD     IF WE HAVE OVERRIDE EXPIRATION DATE          
         BZ    YES2                                                             
         CLC   TADLEXP,OPTEXPD     AND IT'S DIFFERENT FROM DEAL ELEMENT         
         BE    *+10                                                             
         MVC   TADLEXP,OPTEXPD     MOVE TO LOCAL DEAL ELEMENT                   
         B     YES2                ELSE DONE - NO UNI/LCL FOR PRINT             
         SPACE                                                                  
         USING TACAD,R4                                                         
CASTD20  LA    R4,ELTACA                                                        
         GOTO1 UNIVAL,DMCB,TACAUN      UNION                                    
         BNE   NO2                                                              
         GOTO1 YRVAL,DMCB,TACAYEAR     YEAR                                     
         BNE   NO2                                                              
         SPACE                                                                  
         OC    TCUFCAT,TCUFCAT     IF UPGRADING FROM VITA                       
         BZ    YES2                SET CONTRACT YEAR TO LATEST                  
         LA    RF,TGUNYR                                                        
CASTD30  CLI   1(RF),0                                                          
         BE    CASTD40                                                          
         LA    RF,1(RF)                                                         
         B     CASTD30                                                          
CASTD40  GOTO1 YRVAL,DMCB,(X'80',0(RF))                                         
         BE    *+6                                                              
         DC    H'00'                                                            
         MVC   TACAYEAR,TGYRCDE                                                 
         B     YES2                                                             
         DROP  R4                                                               
         EJECT                                                                  
*                                                                               
*              ROUTINE SETS DUE DATE FOR INVOICE                                
*          *** WARNING - THIS IS DONE AT INVOICE LEVEL ***                      
*          *** DON'T USE ANYTHING PERTAINING TO CAST   ***                      
VGETDUE  DS    0H                                                               
         BRAS  RE,GTDUE                                                         
         B     XIT2                                                             
         EJECT                                                                  
*              ROUTINE TO EXTRACT DETAILS FROM W4 RECORD                        
         SPACE 1                                                                
VW4DET   DS    0H                                                               
         MVC   AIO,AIO3            USE ALT. I/O AREA                            
         SPACE 1                                                                
         GOTO1 RECVAL,DMCB,TLW4CDQ,(X'20',0)  GET W4 RECORD                     
         SPACE 1                                                                
         USING TAW4D,R4                                                         
         CLI   TWASCR,SCR96        TEST NOT CALLED FROM CAST SELECT             
         BE    W4D5                                                             
         L     R4,AIO                                                           
         MVI   ELCODE,TAW4ELQ      GET W4 DETAILS ELEMENT                       
         BAS   RE,GETEL2                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
         TM    TAW4STA2,TAW4SLCK   IF W4 RECORD LOCKED                          
         BZ    *+8                                                              
         OI    LCLSTAT3,W4LOCKED   SET FLAG                                     
         DROP  R4                                                               
         SPACE                                                                  
         CLI   TGUNEQU,ACT         IF UNION IS ACTRA                            
         BNE   W4D5                                                             
         MVI   ELCODE,TANUELQ                                                   
         GOTO1 GETL,DMCB,(1,=AL1(TANUTMEM))  GET ACTRA MEMBERSHIP NUM           
         BNE   W4D5                                                             
         L     R1,TGELEM                                                        
         MVC   ELTANUM,0(R1)       SAVE TANU EL                                 
         SPACE                                                                  
         BRAS  RE,TSTDUES          TEST AND SET BIT TO WITHHOLD DUES            
         SPACE                                                                  
         USING TAWXD,R4                                                         
W4D5     L     R4,AIO              SET STATUS BIT IF MINOR                      
         MVI   ELCODE,TAWXELQ                                                   
         BRAS  RE,GETEL                                                         
         BNE   W4D10                                                            
         SPACE                                                                  
         OC    TAWXDOB,TAWXDOB                                                  
         BZ    W4D6                                                             
         GOTO1 DATCON,DMCB,(1,TAWXDOB),(0,WORK)                                 
         GOTO1 ADDAY,DMCB,(C'Y',WORK),WORK+8,18                                 
         CLC   TGTODAY0,WORK+8                                                  
         BNL   W4D10                                                            
         OI    TCCASTST,TCCAMINR                                                
         B     W4D10                                                            
         SPACE                                                                  
W4D6     OC    TAWXTSSN,TAWXTSSN                                                
         BZ    W4D10                                                            
         OI    TCCASTST,TCCAMINR                                                
         DROP  R4                                                               
         SPACE 1                                                                
W4D10    LA    R4,ELTACA                                                        
         USING TACAD,R4            R4=A(CAST DETAILS ELEMENT)                   
         SPACE 1                                                                
         CLI   TACACORP,C' '       IF PAYING A CORP.                            
         BNH   W4D20                                                            
         MVI   ELCODE,TATIELQ      SET TO GET TAX ID EL. FOR CORP. ID           
         MVI   HALF,TATITYCO       BUILD SEARCH ARG. FOR GETL                   
         MVC   HALF+1(1),TACACORP                                               
         GOTO1 GETL,DMCB,(2,HALF)  GET TAX ID EL. FOR CORP.                     
         BNE   W4D20               HANDLE ERRORS DURING DISPLAY                 
         SPACE 1                                                                
         L     R1,TGELEM           FOUND IT                                     
         MVC   ELTATI,0(R1)        MOVE ELEMENT TO LOCAL STORAGE                
         SPACE 1                                                                
W4D20    BRAS  RE,STCOTXCN                                                      
         SPACE 1                                                                
         CLI   TWASCR,SCR96        TEST NOT CALLED FROM CAST SELECT             
         BE    W4DX                                                             
         GOTOR W4LCKCRP,DMCB,ELTATI+TATIID-TATID,AIO3,AIO3                      
         BE    W4DX                IF CORP IS LOCKED                            
         OI    LCLSTAT9,CRPLCKED   SET FLAG                                     
         SPACE 1                                                                
W4DX     GOTO1 RECVAL,DMCB,TLW4CDQ,(X'20',0)  RESTORE W4 RECORD                 
         MVC   AIO,AIO1            RESTORE DEFAULT I/O AREA                     
         B     XIT2                                                             
         EJECT                                                                  
*              ROUTINE TO BUILD CHECK RECORDS FOR LOCALS                        
*                                                                               
*                                  P1 = CHECK AMOUNT                            
*                                  P2 = MISC. DED OR UNION DUES AMOUNT          
*                                  P3 BYTE 0  X'80' = P2 IS UNION DUES          
         SPACE 1                                                                
VLCLCHCK DS    0H                                                               
         L     R2,0(R1)            R2=CHECK AMOUNT                              
         L     R3,4(R1)            R3=MISC. DED AMOUNT OR UNION DUES            
         XC    TCTOTS(TCTOTLNQ),TCTOTS CLEAR ALL AMOUNTS                        
         XC    TCOV1,TCOV1                                                      
         XC    TCOV2,TCOV2                                                      
         XC    TCAPPLCD,TCAPPLCD   CLEAR APPLIED AND INCLUDE CODES              
         XC    TCEXPICD,TCEXPICD                                                
         XC    ELTATI,ELTATI       CLEAR TAX ID ELEMENT                         
         XC    ELTADL,ELTADL             DEAL ELEMENT                           
         XC    ELTASO,ELTASO             EPISODE NUMS ELEMENT                   
         XC    ELTANUM,ELTANUM           ACTRA MEMBERSHIP ELEMENT               
         MVI   NTACWS,0            DON'T ADD CHECK WITHHOLDING ELS.             
         SPACE                                                                  
         TM    PAYSTAT1,CREDIT     IF THIS IS A CREDIT PAYMENT                  
         BZ    *+8                                                              
         LCR   R2,R2               UNCOMPLEMENT CHECK AMOUNT                    
         LCR   R3,R3               AND MISC. DED AMOUNT                         
         ST    R2,TCPAY            SAVE CHCK AMT IN TCPAY FOR DUECOMP           
         ST    R2,TCGROSS                           TCGROSS FOR VCHECK          
         ST    R2,TCPAYC                            TCPAYC FOR VCHECK           
         TM    8(R1),X'80'         SEE IF HAVE MDED OR UNION DUES               
         BO    *+12                                                             
         ST    R3,TCMDED           SAVE MISC.DED IN TCMDED FOR VCHECK           
         B     *+8                                                              
         ST    R3,TCDUES           SAVE UNION DUES IN TCDUES FOR VCHECK         
                                                                                
         USING TACAD,R4                                                         
         XC    ELTACA,ELTACA       BUILD DUMMY CAST DETAILS ELEMENT             
         LA    R4,ELTACA                                                        
         MVI   TACAEL,TACAELQ      ELEMENT CODE                                 
         MVI   TACALEN,TACALNQ                                                  
         MVC   TACAUN,TGUNI        UNION                                        
         MVC   TACALOCL,TGLCL      LOCAL                                        
*                                                                               
         LA    RF,NOCANTAX                                                      
LCLCH10  CLI   0(RF),X'FF'         EOT?                                         
         BE    LCLCH90                                                          
         CLC   TGSSN,0(RF)         MATCH ON SSN?                                
         BE    LCLCH50                                                          
         AHI   RF,L'NOCANTAX       BUMP                                         
         B     LCLCH10                                                          
*                                                                               
LCLCH50  MVC   TACAUNIT,9(RF)      MOVE IN PROVINCE IF THERE IS ONE             
*                                                                               
LCLCH90  LH    R2,DSPGCOM          SAVE DSPGCOM IN R2                           
         XC    DSPGCOM,DSPGCOM     CLEAR SO DON'T ADD GENERAL COMMENT           
         GOTO1 CHECK                                                            
                                                                                
         MVI   ELCODE,TABKELQ                                                   
         GOTO1 REMELEM             GET RID OF BREAKOUT DETAILS EL               
*                                                                               
         STH   R2,DSPGCOM          RESTORE DSPGCOM                              
LCLCHX   B     XIT2                                                             
         EJECT                                                                  
*              ROUTINE TO ADD OR UPDATE GUARANTEE RECORDS                       
*                                                                               
         SPACE 1                                                                
VGRNTEE  DS    0H                                                               
         OC    TCPAY,TCPAY         DO NOT CREATE GUARANTEE IF THERE             
         BZ    GRNTXX              IS NO PAYMENT AMOUNT                         
         SPACE 1                                                                
         MVC   AIO,AIO2            DON'T CREAM CAST RECORD IN AIO               
         SPACE 1                                                                
         OC    TGGUA,TGGUA         IF INSTALLMENT PAYMENT                       
         BZ    GRNT2                                                            
         GOTO1 RECVAL,DMCB,TLGUCDQ,(X'34',0) READ GRNTEE REC FOR UPDATE         
         BE    *+6                                                              
         DC    H'0'                MUST BE THERE                                
         SPACE                                                                  
         MVI   ELCODE,TAGUELQ      GET GUARANTEE DETAILS ELEMENT                
         L     R4,AIO                                                           
         BAS   RE,GETEL2                                                        
         BE    *+6                                                              
         DC    H'0'                MUST BE THERE                                
         SPACE                                                                  
         USING TAGUD,R4                                                         
         MVC   CAGUARST,TAGUSTAT   SAVE STATUS FOR INDIV.                       
         OC    TCPAY,TCPAY         DONE IF PAYMENT AMOUNT = 0                   
         BZ    GRNT1X              NO CHANGES TO RECORD                         
         SPACE                                                                  
         OI    TAGUSTAT,TAGUSINS   SET INSTALLMENT PAYMENT PAID                 
         MVC   TAGUPAY,TCPAY       SAVE PAYMENT AMOUNT                          
         SPACE                                                                  
         CLC   TGTODAY1,TGSYITCD   IF STILL UPDATING GUARANTEES                 
         BNL   GRNT1               AT PAY TIME                                  
         L     R1,TAGUAMT                                                       
         A     R1,TCPAY            ADD TO TOTAL GUARANTEE AMOUNT                
         ST    R1,TAGUAMT                                                       
         SPACE                                                                  
         TM    TAGUSTAT,TAGUSDES   IF DESCENDING BALANCE                        
         BZ    GRNT1                                                            
         L     R1,TAGUBAL                                                       
         A     R1,TCPAY            ALSO ADD TO BALANCE                          
         ST    R1,TAGUBAL                                                       
         SPACE                                                                  
GRNT1    GOTO1 ACTVIN,DMCB,0       UPDATE ACTIVITY INFO                         
         SPACE                                                                  
         GOTO1 MYPUTREC            WRITE BACK CHANGES                           
GRNT1X   MVC   AIO,TCACAST         RESTORE AIO OF CAST RECORD                   
         B     GRNTXX                                                           
         SPACE                                                                  
         USING TLGUD,R3                                                         
GRNT2    XC    TGGUA,TGGUA         NOT INSTALLMENT, FIND NEXT GRT CODE          
         GOTO1 RECVAL,DMCB,TLGUCDQ,(X'C0',TGGUA)  BUILD DUMMY KEY               
         OI    DMINBTS,X'08'                                                    
         GOTO1 HIGH                READ FIRST RECORD ON FILE                    
         NI    DMINBTS,X'FF'-X'08'                                              
         LA    R3,KEY              R3=DIRECTORY RECORD WE FOUND                 
         SPACE 1                                                                
         ZAP   DUB,=P'0'                                                        
         CLC   TLGUKEY(TLGUGUA-TLGUD),KEYSAVE  IF WE FOUND A RECORD             
         BNE   GRNT4                                                            
         MVC   TGGUA,TLGUGUA       SAVE ITS CODE AND                            
         XC    TGGUA,HEXFFS2       UNCOMPLEMENT IT                              
         PACK  DUB,TGGUA           PACK IT                                      
         SPACE 1                                                                
GRNT4    AP    DUB,=P'1'           OLD CODE PLUS 1                              
         OI    DUB+7,X'0F'                                                      
         UNPK  TGGUA,DUB+5(3)      IS NEW CODE                                  
         XC    TGGUA,HEXFFS2       COMPLEMENT IT FOR GLOBAL                     
         SPACE 1                                                                
         L     R3,AIO              BUILD RECORD IN I/O AREA                     
         MVC   TLGUKEY,KEYSAVE                                                  
         MVC   TLGULEN,DATADISP    INIT. RECORD LENGTH                          
         MVC   TLGUGUA,TGGUA                                                    
         XC    TLGUSTAT(10),TLGUSTAT                                            
         MVC   KEY,TLGUKEY         SAVE KEY                                     
         SPACE                                                                  
         USING TACAD,R4                                                         
         LA    R4,ELTACA           GET CAST DETAILS ELEMENT                     
         MVC   BYTE,TACACORP       SAVE CORP NUMBER IN BYTE                     
         SPACE                                                                  
         USING TAGUD,R4                                                         
         XC    ELEMENT,ELEMENT                                                  
         LA    R4,ELEMENT                                                       
         MVI   TAGUEL,TAGUELQ      BUILD GUARANTEE DETAILS ELEMENT              
         MVI   TAGULEN,TAGULNQ                                                  
         MVC   TAGUAGY,TGAGY       AGENCY                                       
         MVC   TAGUCLI,TGCLI       CLIENT                                       
         MVC   TAGUCRP,BYTE        CORP NUMBER                                  
         MVC   TAGUSTAT,GUARSTAT   STATUS                                       
         OI    TAGUSTAT,TAGUSNO    DON'T APPLY THIS GRT TILL BILLED             
         OI    TAGUSTAT,TAGUSPAY   SET GRT REC ADDED BY PAY PROGRAM             
         SPACE                                                                  
         MVC   TAGUSTA2,GUARSTA2   STATUS 2                                     
         TM    TAGUSTA2,TAGUSMSC   MULTI-SERVICE CONTRACT?                      
         JZ    *+8                                                              
         OI    TGGRTSTA,TGGRTMSC                                                
         SPACE                                                                  
         MVC   TAGUINV,INVNO       INVOICE                                      
         MVC   TAGUIAY,TGAGY       AGENCY                                       
         MVC   CAGUARST,TAGUSTAT   SAVE STATUS FOR INDIV.                       
         MVC   TAGUPD,TCIPCYC      PERIOD                                       
         SPACE                                                                  
         MVC   TAGUPAY,TCPAY       SAVE PAYMENT AMOUNT                          
         MVC   TAGUAMT,TCPAY       SAVE TOTAL GUARANTEE AMOUNT                  
         MVC   TAGUGCNT,GUARCONT   SAVE GUARANTEE CONTRACT                      
         SPACE 1                                                                
         SPACE                                                                  
         TM    CAGUARST,DESCBAL    IF DESCENDING BALANCE                        
         BZ    *+10                                                             
         MVC   TAGUBAL,TCPAY       SAVE BALANCE                                 
         SPACE                                                                  
         OI    TAGUSTA2,TAGUSNEW   SET ADDED VIA NEW GRT SYSTEM                 
         SPACE                                                                  
         GOTO1 ADDL                ADD ELEMENT TO RECORD                        
         SPACE                                                                  
         OC    DSPHCOM,DSPHCOM     ADD HISTORY COMMENT TO RECORD                
         BZ    GRNT7                                                            
         LH    R2,DSPHCOM                                                       
         AR    R2,RA                                                            
         GOTO1 NAMIN,DMCB,TACMELQ,(X'80',(R2)),TACMTYPG                         
         SPACE                                                                  
GRNT7    GOTO1 ACTVIN,DMCB,0       ADD ACTIVITY ELEMENT TO RECORD               
         SPACE                                                                  
         GOTO1 MYADDREC            ADD GUARANTEE RECORD                         
         SPACE                                                                  
         MVC   AIO,TCACAST         RESTORE AIO OF CAST RECORD                   
         SPACE                                                                  
         USING TACAD,R4            ADD NEW GRT CODE TO CAST DETAILS EL          
         L     R4,TCACAST          GET CAST DETAILS EL FROM CAST REC            
         MVI   ELCODE,TACAELQ                                                   
         BAS   RE,GETEL2                                                        
         BE    *+6                 MUST BE THERE                                
         DC    H'0'                                                             
         CLI   TACALEN,TACAGUA+L'TACAGUA-TACAD IF HAVE ROOM FOR GRT CDE         
         BL    GRNT10                                                           
         MVC   TACAGUA,TGGUA       SAVE GUARNTEE CODE OF REC JUST ADDED         
         XC    TACAGUA,HEXFFS2     UNCOMPLEMENT IT                              
         B     GRNTX                                                            
         SPACE                                                                  
GRNT10   XC    ELEMENT,ELEMENT     BUILD NEW EL LONG ENOUGH FOR GRT CDE         
         ZIC   R1,TACALEN          R1=LENGTH OF CURRENT CAST DET ELEM           
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   ELEMENT(0),TACAEL   COPY TO ELEMENT                              
         SPACE                                                                  
         GOTO1 REMELEM             GET RID OF OLD CAST DETAILS EL               
         LA    R4,ELEMENT                                                       
         MVI   TACALEN,TACALNQ     SET NEW LENGTH                               
         MVC   TACAGUA,TGGUA       SAVE GUARNTEE CODE OF REC JUST ADDED         
         XC    TACAGUA,HEXFFS2     UNCOMPLEMENT IT                              
         SPACE                                                                  
         GOTO1 ADDL                ADD NEW ELEMENT TO CAST RECORD               
         SPACE                                                                  
         USING TLDRD,R3                                                         
GRNTX    OI    TCRTRN,TCRTCAST     SET CAST RECORD CHANGED                      
         SPACE                                                                  
GRNTXX   B     XIT2                                                             
         EJECT                                                                  
*              ROUTINE TO ADD GUAR. AND FTRACK REQUEST ELEMENTS                 
*                                                                               
         SPACE 1                                                                
VADDREQ  DS    0H                                                               
         BAS   RE,ADDGQELS         ADD GUAR. TRACKING REQ. ELEMENT(S)           
         SPACE 1                                                                
         BRAS  RE,ADDFQELS         ADD FTRACK REQ. ELEMENT(S)                   
         B     XIT2                                                             
         EJECT                                                                  
*              ROUTINE TO ADD GUARANTEE TRACKING REQ DETAILS ELEMENT(S)         
*              USING GQTABLE IN TEMPORARY STORAGE                               
         SPACE 1                                                                
ADDGQELS NTR1                                                                   
         L     R2,ATMPPAYD         TABLE IN TEMPORARY STORAGE                   
         USING TMPPAYD,R2                                                       
         LA    R2,GQTABLE          R2=A(ENTRY IN GQTABLE)                       
         LA    R0,NGQTAB           R0=MAX N'ENTRIES                             
         SPACE                                                                  
ADDGQ2   XC    ELEMENT,ELEMENT     BUILD GRT TRACKING REQUEST DET ELEM          
         LA    R4,ELEMENT                                                       
         USING TAGQD,R4                                                         
         LA    R4,TAGQSBEL         R4=A(NEXT SUB ELEMENT)                       
         USING TAGQSBEL,R4                                                      
         XR    R1,R1               R1=N'SUB ELEMENTS                            
         LA    RF,TAGQLNQ          RF=CUMULATIVE L'ELEMENT                      
         SPACE                                                                  
ADDGQ4   CLI   0(R2),0             IF NOT END OF ENTRIES                        
         BE    ADDGQ6                                                           
         LA    RE,L'TAGQSBEL(RF)                                                
         CHI   RE,254                                                           
         BH    ADDGQ6                                                           
         MVC   TAGQSBEL,0(R2)      MOVE INFO TO SUB ELEMENT                     
         LA    R1,1(R1)            INCREMENT COUNT OF SUB ELEMENTS              
         LA    R2,L'TAGQSBEL(R2)   BUMP TO NEXT ENTRY                           
         LA    R4,L'TAGQSBEL(R4)   BUMP TO NEXT SUB ELEMENT                     
         LA    RF,L'TAGQSBEL(RF)                                                
         BCT   R0,ADDGQ4                                                        
         SPACE                                                                  
ADDGQ6   OC    ELEMENT,ELEMENT     IF ANYTHING IN ELEMENT                       
         BZ    ADDGQX                                                           
         LA    R4,ELEMENT          R4=A(ELEMENT)                                
         USING TAGQD,R4                                                         
         MVI   TAGQEL,TAGQELQ      ELEMENT CODE                                 
         STC   RF,TAGQLEN          L'ELEMENT                                    
         STC   R1,TAGQNUM          N'SUB ELEMENTS                               
         GOTO1 ADDL                ADD ELEMENT TO RECORD                        
         SPACE                                                                  
         LTR   R0,R0               IF NOT END OF TABLE                          
         BZ    ADDGQX                                                           
         B     ADDGQ2              LOOK FOR MORE                                
         SPACE                                                                  
ADDGQX   B     XIT2                                                             
         EJECT                                                                  
*              ROUTINE TO INSURE NO SCREEN RECORDS FOR THIS INVOICE             
         SPACE 1                                                                
VDELSCRS DS    0H                                                               
         USING TLIND,R3                                                         
         LA    R3,KEY                                                           
         XC    TLINKEY,TLINKEY     READ FOR INVOICE KEY/RECORD                  
         MVI   TLINCD,TLINCDQ                                                   
         MVC   TLINAGY,TGAGY                                                    
         MVC   TLININV,INVNO                                                    
         XC    TLININV,=6X'FF'                                                  
         GOTO1 HIGH                                                             
         CLC   TLINKEY,KEYSAVE                                                  
         BNE   DSCR1                                                            
         GOTO1 GETREC                                                           
         DROP  R3                                                               
         SPACE 1                                                                
         USING TAIND,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TAINELQ      IF IT IS ALREADY PAID, DO NOT                
         BAS   RE,GETEL2           DELETE THE SCREEN RECORDS                    
         BE    *+6                                                              
         DC    H'00'                                                            
         OC    TAINPINF,TAINPINF                                                
         BNZ   XIT2                                                             
         DROP  R4                                                               
         SPACE 1                                                                
         USING TLSCD,R3                                                         
DSCR1    XC    TLSCKEY,TLSCKEY     LOOK FOR EXISTING SCREEN RECORDS             
         MVI   TLSCCD,TLSCCDQ      SCREEN RECORD CODE                           
         MVC   TLSCAGY,TGAGY       AGENCY                                       
         MVC   TLSCINV,SCRINVNO    INVOICE NUMBER                               
         SPACE 1                                                                
DSCR2    MVI   RDUPDATE,C'Y'                                                    
         GOTO1 HIGH                GET DIRECTORY RECORD                         
         SPACE 1                                                                
         CLC   TLSCKEY(TLSCPG-TLSCD),KEYSAVE STILL SAME INVOICE                 
         BNE   XIT2                                                             
         SPACE 1                                                                
         MVI   RDUPDATE,C'Y'                                                    
         GOTO1 GETREC              GET FILE RECORD                              
         SPACE 1                                                                
         OI    TLDRSTAT-TLDRD(R3),X'80' DELETE DIRECTORY RECORD                 
         GOTO1 MYWRITE                                                          
         SPACE 1                                                                
         L     R3,AIO                                                           
         OI    TLSCSTAT,X'80'      DELETE FILE RECORD                           
         GOTO1 MYPUTREC                                                         
         SPACE 1                                                                
         LA    R3,KEY                                                           
         ZIC   R1,TLSCKEY+L'TLSCKEY-1                                           
         AHI   R1,1                BUMP KEY                                     
         STC   R1,TLSCKEY+L'TLSCKEY-1                                           
         SPACE 1                                                                
         B     DSCR2               AND LOOK FOR ANOTHER                         
         EJECT                                                                  
*              ROUTINE ADJUSTS THE CNET/MKT/CSYS TABLE FOR                      
*              A PARTICULAR PERFORMER ON A VERSION PAYMENT                      
*              ON EXIT ... AIO3=TABLE OF CNET/MKT/CSYS TO ADD TO                
*                               CAST MEMBER'S USAGE HISTORY RECORD              
         SPACE 1                                                                
VADJTBCS DS    0H                                                               
         CLI   VERSION,0           IF PAYING A VERSION                          
         BE    XIT2                                                             
         TM    TGUSSTA3,USEMTAB    ON A WILDSPOT OR CABLE PAYMENT               
         BZ    XIT2                                                             
         SPACE 1                                                                
         USING MKTTABLD,R2                                                      
         L     R2,AIO3                BUILD CNET/MKT/CSYS TABLE IN AIO3         
         MVC   0(L'CASTHEAD,R2),CASTHEAD ADD SPECIAL HEADER TO TABLE TO         
         AHI   R2,L'CASTHEAD               INDICATE IT IS CAST SPECIFIC         
         SPACE 1                                                                
         L     RE,AMKTTABL           COPY INVOICE'S CNET/MKT/CSYS TABLE         
         LHI   R1,(MAXMKT*MKTLNQ)/2                             TO AIO3         
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),0(RE)                                                    
         AHI   RE,(MAXMKT*MKTLNQ)/2                                             
         AHI   R2,(MAXMKT*MKTLNQ)/2                                             
         AHI   R1,1                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),0(RE)                                                    
         SPACE 1                                                                
         L     R2,AIO3           R3=A(CAST SPECIFIC CNET/MKT/CSYS TBL)          
         AHI   R2,L'CASTHEAD                                                    
         SPACE 1                                                                
ATC10    CLI   0(R2),X'FF'       IF NOT AT END OF TABLE                         
         BE    XIT2                                                             
         SPACE 1                                                                
         MVI   TGBYTE,UHCUR      1ST TRY CNET/MKT/CSYS FOR CURR AGY/COM         
         SPACE 1                                                                
         USING TLUHPD,R3                                                        
         LA    R3,KEY                                                           
         XC    TLUHPKEY,TLUHPKEY                                                
         MVI   TLUHPCD,TLUHMTDQ  READ THROUGH ALL USAGE HISTORY                 
         MVC   TLUHMINM,MTINUM   FOR THIS CNET/MKT/CSYS                         
         MVC   TLUHMCOM,TGCOM       FOR THIS COMMERCIAL                         
         MVC   TLUHMSEQ,TGCSORT+4  FOR THIS CAST MEMBER                         
ATC20    GOTO1 HIGH                                                             
         B     ATC40                                                            
ATC30    GOTO1 SEQ                                                              
ATC40    CLC   KEY(TLUHMUSE-TLUHPCD),KEYSAVE                                    
         BE    ATC50                                                            
         SPACE 1                                                                
         USING TAOCD,RE                                                         
         CLI   TGBYTE,UHPRE      IF NONE FOUND, SEARCH PREVIOUS                 
         BE    ATC45             AGENCY/COMM'L                                  
         MVI   TGBYTE,UHPRE                                                     
         OC    ELTAOC,ELTAOC                                                    
         BZ    ATC45                                                            
         LA    RE,ELTAOC                                                        
         TM    TAOCSTAT,TAOCSFRO                                                
         BZ    ATC45                                                            
         XC    KEY,KEY                                                          
         MVI   TLUHPCD,TLUHMTDQ                                                 
         MVC   TLUHMINM,MTINUM     FOR THIS CNET/MKT/CSYS                       
         MVC   TLUHMCOM,TAOCCOM   FOR PREVIOUS COMMERCIAL                       
         MVC   TLUHMSEQ,TGCSORT+4    FOR THIS CAST MEMBER                       
         B     ATC20                                                            
         DROP  RE                                                               
         SPACE 1                                                                
ATC45    TM    PAYSTAT1,CREDIT   IF MAKING A CREDIT PAYMENT                     
         BZ    ATC70                                                            
         OI    MTSTAT,MTNOCALC   AND THE CNET/MKT/CCSYS IN NOT FOUND            
         B     ATC70             ON EARLIER PAYMENT, DON'T CREDIT IT            
         SPACE 1                                                                
ATC50    LA    RE,TLUHMC1D                                                      
         TM    PAYSTAT1,CREDIT                                                  
         BZ    *+8                                                              
         LA    RE,TLUHMCCS                                                      
         CLC   0(3,RE),MT1DATE   IF USE DATE FITS WITHIN A PREVIOUS             
         BH    ATC30             CYCLE FOR THIS CNET/MKT/                       
         CLC   TLUHMCYE,MT1DATE  CSYS ...                                       
         BL    ATC30                                                            
         SPACE 1                                                                
         TM    PAYSTAT1,CREDIT   ... AND MAKING NON-CREDIT PAYMENT              
         BNZ   ATC60                                                            
         TM    TLUHMSTA,TLUHMCRD AND FOUND ON A PREV CREDIT PAYMENT             
         BNZ   ATC70             OK TO PAY AGAIN                                
         OI    MTSTAT,MTNOCALC   IF FOUND ON A PREV NON-CREDIT PAYMENT          
         B     ATC70             NOT OK TO PAY AGAIN                            
         SPACE 1                                                                
ATC60    CLC   TLUHMCCS,TCPCYCS  ... AND MAKING CREDIT PAYMENT                  
         BNE   ATC30             PREV.CYCLE MUST HAVE SAME CYCLE START          
         TM    TLUHMSTA,TLUHMCRD                                                
         BNZ   ATC70             AND FOUND ON A PREV NON-CREDIT PAYMENT         
         MVC   MT1DATE,TLUHMC1D  OK TO PAY AGAIN                                
         MVC   MTCYCEND,TLUHMCYE IF FOUND ON PREVIOUS CREDIT PAYMENT            
         BZ    ATC70             NOT OK TO PAY AGAIN                            
         OI    MTSTAT,MTNOCALC                                                  
*                                                                               
ATC70    LA    R2,MKTLNQ(R2)     GO PROCESS NEXT CNET/MKT/CSYS                  
         B     ATC10                                                            
         B     XIT2                                                             
         DROP  R2                                                               
         SPACE 2                                                                
CASTHEAD DC    C'CASTHEAD'                                                      
         EJECT                                                                  
*              ROUTINE TO CONFORM OLD STYLE USAGE HISTORY ELEMENTS              
*              FOR LOCAL CABLE PAYMENTS TO THE NEW STYLE                        
*              ON ENTRY ... R3=A(USAGE HISTORY KEY)                             
         SPACE 1                                                                
         USING TLUHD,R3                                                         
VLCBUHFX DS    0H                                                               
         CLC   TLUHUSE,=C'LCB'   IF LOCAL CABLE PAYMENT                         
         BNE   XIT2                                                             
         SPACE 1                                                                
         USING TAUHD,R1                                                         
         LA    R1,TCTAUHEL                                                      
         OC    TAUHSUBS,TAUHSUBS AND NUMBER OF SUBSCRIBERS WAS                  
         BNZ   XIT2              NOT SAVED ON PREVIOUS INVOICE                  
         SPACE 1                                                                
         LA    RE,SUBSTAB                                                       
LCBUFX10 CLI   0(RE),X'FF'       FIND PREVIOUS USE TYPE IN TABLE                
         BE    XIT2                                                             
         CLC   TAUHTYPE,11(RE)                                                  
         BE    LCBUFX20                                                         
         LA    RE,L'SUBSTAB(RE)                                                 
         B     LCBUFX10                                                         
         SPACE 1                                                                
LCBUFX20 MVC   TAUHSUBS,0(RE)    AND SAVE NUMBER OF SUBSCRIBERS                 
         MVC   TAUHISUB,0(RE)    BASED ON IT                                    
         B     XIT2                                                             
         DROP  R3                                                               
         EJECT                                                                  
*              ROUTINE TO TRANSLATE LCB USAGE HISTORY INTO CBL/SCB              
*              FORMAT. IF CBL/SCB IS NOT UPGRADING FROM LCB TURN                
*              OFF LCB UPGRADE TYPE.                                            
         SPACE 1                                                                
VLCB2CBL DS    0H                                                               
         TM    TGUSSTA3,CBLUSE   IF PAYING CABLE OR SPANISH CABLE               
         BZ    XIT2                                                             
         SPACE 1                                                                
         USING TAUHD,R1                                                         
         LA    R1,TCTAUHEL       R1=A(USAGE HISTORY ELEMENT)                    
         SPACE 1                                                                
         USING TLUHD,RE                                                         
         L     RE,AIO                                                           
         CLC   TLUHUSE,=C'LCB'   IF NOT USING LOCAL CABLE USAGE HISTORY         
         BE    L2C10                                                            
         MVI   TAUHLCBU,0        CLEAR LOCAL CABLE UPGRADE TYPE                 
         B     XIT2              AND EXIT                                       
         DROP  RE                                                               
         SPACE 1                                                                
L2C10    L     R4,TAUHSUBS       IF USING LOCAL CABLE USAGE HISTORY             
         XR    RE,RE             NUMBER OF SUBSCRIBERS INTO R4                  
         ZICM  RF,TAUHSUBS,4     NUMBER OF PAID SUBSCRIBERS/350,000             
         D     RE,=F'350000'     INTO R2                                        
         LR    R2,RF                                                            
         AH    R2,TAUHCSYS                                                      
         SPACE 1                                                                
         XR    RF,RF                                                            
         XR    R3,R3                                                            
         OC    TAUHASUB,TAUHASUB                                                
         BZ    L2C20                                                            
         XR    RE,RE           NUMBER OF AUTOMATIC SUBSCRIBERS/350,000          
         ZICM  RF,TAUHASUB,4   INTO R3                                          
         D     RE,=F'350000'                                                    
         LR    R3,RF                                                            
         AH    R3,TAUHCSYS                                                      
         SPACE 1                                                                
L2C20    XR    RF,RF                                                            
         OC    TAUHISUB,TAUHISUB                                                
         BZ    L2C30                                                            
         XR    RE,RE           NUMBER OF INITIAL SUSCRIBERS/350,000             
         ZICM  RF,TAUHISUB,4   INTO RF                                          
         D     RE,=F'350000'                                                    
         SPACE 1                                                                
L2C30    LTR   R2,R2           IF INITIAL UNITS HAS BEEN CALCULATED             
         BNE   L2C40           AS ZERO, MAKE IT ONE                             
         LHI   R2,1                                                             
         SPACE 1                                                                
L2C40    XC    TAUHCBUN(16),TAUHCBUN                                            
         STH   R2,TAUHCBUN                                                      
         STH   R3,TAUHCAUT     SAVE THE QUOTIENTS INTO THE USAGE                
         STH   RF,TAUHICBU     HISTORY ELEMENT                                  
         ST    R4,TAUHCSUB                                                      
         MVC   TAUHLCBU,TAUHTYPE                                                
         B     XIT2                                                             
         DROP  R1                                                               
         EJECT                                                                  
*              ROUTINE TO SET LCB TYPE IN USAGE HISTORY ELEMENT                 
*              BASED ON NUMBER OF SUBSCRIBERS                                   
*              ON ENTRY ... R4=A(USAGE HISTORY ELEMENT)                         
         SPACE 1                                                                
         USING TAUHD,R4                                                         
VSTLCBTY DS    0H                                                               
         LA    RE,SUBSTAB        AND, BASED ON SUBSCRIBERS,                     
SLT10    CLI   0(RE),X'FF'       SET THE USE TYPE                               
         BE    XIT2                                                             
         CLC   TAUHSUBS,0(RE)                                                   
         BNH   SLT20                                                            
         LA    RE,L'SUBSTAB(RE)                                                 
         B     SLT10                                                            
SLT20    MVC   TAUHTYPE,11(RE)                                                  
         B     XIT2                                                             
         DROP  R4                                                               
         EJECT                                                                  
*              ROUTINE TO SET INITIAL SUBSCRIBERS BASED ON TYPE                 
*              SAVED IN USAGE HISTORY ELEMENT                                   
*              ON ENTRY ... R4=A(USAGE HISTORY ELEMENT)                         
         SPACE 1                                                                
         USING TAUHD,R4                                                         
VSTLCBSB DS    0H                                                               
         LA    RE,SUBSTAB          IF PAYMENT WAS MADE WITH                     
SLS10    CLI   0(RF),X'FF'         OLD STYLE                                    
         BE    XIT2                SAVE PREVIOUS SUBSCRIBERS                    
         CLC   TAUHTYPE,11(RE)                                                  
         BE    SLS20                                                            
         LA    RE,L'SUBSTAB(RE)                                                 
         B     SLS10                                                            
SLS20    MVC   TCSUBS,0(RE)                                                     
         B     XIT2                                                             
         EJECT                                                                  
*              ROUTINE GETS UH REC FOR CAST WHEN PAYING A VERSION FOR           
*              CLA OR UPGRADE TYPE.                                             
         SPACE                                                                  
VGETCAUH NTR1                                                                   
         BRAS  RE,GETCAU                                                        
         B     XIT2                                                             
         EJECT                                                                  
*              ROUTINE TO SET LCB TYPE                                          
         SPACE 1                                                                
VLCBTYPE DS    0H                                                               
         CLI   TGUSEQU,ULCB      IF LOCAL CABLE PAYMENT                         
         BNE   XIT2                                                             
         SPACE 1                                                                
         USING TAUHD,R4                                                         
         MVC   TGUPFRTY,TAUHTYPE SAVE PREV TYPE AS UPG "FROM" TYPE              
         DROP  R4                                                               
         SPACE 1                                                                
         LA    RE,SUBSTAB        FIND NUMBER OF SUBSCRIBERS IN                  
LT10     CLI   0(RE),X'FF'       TABLE                                          
         BE    XIT2                                                             
         CLC   TCSUBS,0(RE)                                                     
         BNH   LT20                                                             
         LA    RE,L'SUBSTAB(RE)                                                 
         B     LT10                                                             
         SPACE 1                                                                
LT20     MVC   TGUSTYP,11(RE)    AND ASSIGN CURRENT TYPE                        
         MVC   TGUPTOTY,11(RE)   AND UPGRADE "TO" TYPE                          
         SPACE 1                                                                
         CLI   TGUPFRTY,0              IF NO UPGRADE "FROM" TYPE                
         BNE   XIT2                                                             
         MVI   TGUPTOTY,0                        CLEAR "TO" TYPE                
         NI    TGUSTYST,X'FF'-UPGRADE   AND CLEAR UPGRADE STATUS                
         B     XIT2                                                             
         EJECT                                                                  
*              SUBSCRIBER TABLE                                                 
*              FIRST FIELD:  HEXIDECIMAL NUMBER OF SUBSCRIBERS                  
*              SECOND FIELD: FULLWORD NUMBER OF SUBSCRIBERS                     
*              THIRD FIELD:  USE TYPE EQUATE                                    
         SPACE 1                                                                
         DC    0F                                                               
SUBSTAB  DC    0XL12                                                            
         DC    F'50000',C'50000  ',AL1(ULCB50)                                  
         DC    F'50000',C'50000  ',AL1(ULCBU50)                                 
         DC    F'100000',C'100000 ',AL1(ULCB100)                                
         DC    F'100000',C'100000 ',AL1(ULCBU100)                               
         DC    F'100000',C'100000 ',AL1(ULCBU12)                                
         DC    F'150000',C'150000 ',AL1(ULCB150)                                
         DC    F'150000',C'150000 ',AL1(ULCBU150)                               
         DC    F'150000',C'150000 ',AL1(ULCBU13)                                
         DC    F'150000',C'150000 ',AL1(ULCBU23)                                
         DC    F'200000',C'200000 ',AL1(ULCB200)                                
         DC    F'200000',C'200000 ',AL1(ULCBU200)                               
         DC    F'200000',C'200000 ',AL1(ULCBU14)                                
         DC    F'200000',C'200000 ',AL1(ULCBU24)                                
         DC    F'200000',C'200000 ',AL1(ULCBU34)                                
         DC    F'200000',C'250000 ',AL1(ULCB250)                                
         DC    F'200000',C'250000 ',AL1(ULCBU250)                               
         DC    F'200000',C'250000 ',AL1(ULCBU15)                                
         DC    F'250000',C'250000 ',AL1(ULCB250)                                
         DC    F'250000',C'250000 ',AL1(ULCBU25)                                
         DC    F'250000',C'250000 ',AL1(ULCBU35)                                
         DC    F'250000',C'250000 ',AL1(ULCBU45)                                
         DC    F'500000',C'500000 ',AL1(ULCB500)                                
         DC    F'500000',C'500000 ',AL1(ULCBU500)                               
         DC    F'500000',C'500000 ',AL1(ULCBU16)                                
         DC    F'500000',C'500000 ',AL1(ULCBU26)                                
         DC    F'500000',C'500000 ',AL1(ULCBU36)                                
         DC    F'500000',C'500000 ',AL1(ULCBU46)                                
         DC    F'500000',C'500000 ',AL1(ULCBU56)                                
         DC    F'750000',C'750000 ',AL1(ULCB750)                                
         DC    F'750000',C'750000 ',AL1(ULCBU750)                               
         DC    F'750000',C'750000 ',AL1(ULCBU17)                                
         DC    F'750000',C'750000 ',AL1(ULCBU27)                                
         DC    F'750000',C'750000 ',AL1(ULCBU37)                                
         DC    F'750000',C'750000 ',AL1(ULCBU47)                                
         DC    F'750000',C'750000 ',AL1(ULCBU57)                                
         DC    F'750000',C'750000 ',AL1(ULCBU67)                                
         DC    F'1000000',C'1000000',AL1(ULCB1M)                                
         DC    F'1000000',C'1000000',AL1(ULCBU1M)                               
         DC    F'1000000',C'1000000',AL1(ULCBU18)                               
         DC    F'1000000',C'1000000',AL1(ULCBU28)                               
         DC    F'1000000',C'1000000',AL1(ULCBU38)                               
         DC    F'1000000',C'1000000',AL1(ULCBU48)                               
         DC    F'1000000',C'1000000',AL1(ULCBU58)                               
         DC    F'1000000',C'1000000',AL1(ULCBU68)                               
         DC    F'1000000',C'1000000',AL1(ULCBU78)                               
         DC    F'99999999',C'9999999',AL1(ULCBMAX)                              
         DC    F'99999999',C'9999999',AL1(ULCBU19)                              
         DC    F'99999999',C'9999999',AL1(ULCBU29)                              
         DC    F'99999999',C'9999999',AL1(ULCBU39)                              
         DC    F'99999999',C'9999999',AL1(ULCBU49)                              
         DC    F'99999999',C'9999999',AL1(ULCBU59)                              
         DC    F'99999999',C'9999999',AL1(ULCBU69)                              
         DC    F'99999999',C'9999999',AL1(ULCBU79)                              
         DC    F'99999999',C'9999999',AL1(ULCBU89)                              
         DC    X'FF'                                                            
         EJECT                                                                  
*              ROUTINE TO TRY TO FIND USAGE HISTORY FOR PREVIOUS                
*              AGENCY/COMMERCIAL AND (POSSIBLY) LCB                             
         SPACE 1                                                                
VTPRELCB DS    0H                                                               
         CLI   TGBYTE,UHDONE                                                    
         BE    NO2                                                              
         SPACE 1                                                                
         CLI   TGBYTE,UHCUR       IF TRIED THIS USE FOR CURRENT                 
         BNE   TPRE10             AGENCY/COMMERCIAL AND FOUND NOTHING           
         MVI   TGBYTE,UHPRE       NOW TRY THIS USE FOR PREVIOUS                 
         GOTO1 TRYOCEL            AGENCY/COMMERCIAL                             
         BE    YES2                                                             
         SPACE 1                                                                
TPRE10   CLI   TGBYTE,UHPRE       IF TRIED THIS USE FOR PREVIOUS                
         BNE   TPRE30             AGENCY/COMMERCIAL AND FOUND NOTHING           
         MVI   TGBYTE,UHDONE      DONE LOOKING FOR USAGE HISTORY                
         TM    TGUSSTA3,CBLUSE    UNLESS MAKING A CABLE OR                      
         BZ    NO2                SPANISH CABLE PAYMENT                         
         MVI   TGBYTE,UHCURLCB    NOW TRY LCB FOR CURRENT                       
         BRAS  RE,TRYLCB          AGENCY/COMMERCIAL                             
         BE    YES2                                                             
         SPACE 1                                                                
TPRE30   MVI   TGBYTE,UHPRELCB                                                  
         GOTO1 TRYOCEL            NOW TRY LCB FOR PREVIOUS                      
         BNE   NO2                AGENCY/COMMERCIAL                             
         B     YES2                                                             
         EJECT                                                                  
*              ROUTINE TO USE TAOCEL TO GET USAGE HISTORY RECORD                
*              FOR COMML'S COPIED WITH HISTORY                                  
*              SETS CC EQUAL IF FINDS UH, ELSE CC NOT EQ                        
VTRYOCEL DS    0H                                                               
         USING TLUHD,R3                                                         
         OC    ELTAOC,ELTAOC       TEST HAVE TAOCEL                             
         BZ    NO2                                                              
         LA    R4,ELTAOC                                                        
         USING TAOCD,R4                                                         
         TM    TAOCSTAT,TAOCSFRO   TEST IT'S STATUS IS FROM                     
         BZ    NO2                                                              
         MVC   KEY,KEYSAVE                                                      
         MVC   TLUHCOM,TAOCCOM     FROM INTERNAL COMMERCIAL NUMBER              
         GOTO1 HIGH                GET DIRECTORY RECORD                         
         SPACE 1                                                                
         CLC   TLUHKEY(TLUHINV-TLUHD),KEYSAVE  DID WE FIND REC FOR USE          
         BE    YES2                SET CC                                       
         B     NO2                                                              
         DROP  R3                                                               
         EJECT                                                                  
DONE     TM    PAYMODE,DRAFT                                                    
         BO    DONE2                                                            
         MVI   MYMSGNO1,6          PAYMENT COMPLETE                             
         TM    LCLSTAT2,NOFUND                                                  
         BZ    *+12                                                             
         MVI   ERROR,ERNOFUND      NO FUND FOR I&R LOCAL CHECK                  
         J     THEEND                                                           
         TM    LCLSTAT,MUSONCOM                                                 
         BZ    *+8                                                              
         MVI   MYMSGNO1,38         (MUSICIANS ON COMMERCIAL)                    
         TM    LCLSTAT,NOHNWADJ                                                 
         BZ    *+8                                                              
         MVI   MYMSGNO1,40         NO LOCAL FOR H&W ADJUSTMENT                  
         TM    LCLSTAT2,GUARERR                                                 
         BZ    INFOEND2                                                         
         MVI   MYMSGNO1,ERGRTERR   INVOICE IN ERROR - BAD GRNTEE RECORD         
         B     DONEX                                                            
DONE2    MVI   MYMSGNO1,7          DRAFT PAYMENT COMPLETE                       
         TM    LCLSTAT2,NOFUND                                                  
         BZ    *+12                                                             
         MVI   ERROR,ERNOFDFT      NO FUND FOR I&R LOCAL CHECK                  
         J     THEEND                                                           
         TM    LCLSTAT,MUSONCOM                                                 
         BZ    *+8                                                              
         MVI   MYMSGNO1,39         (MUSICIANS ON COMMERCIAL)                    
         TM    LCLSTAT,NOHNWADJ                                                 
         BZ    *+8                                                              
         MVI   MYMSGNO1,41         NO LOCAL FOR H&W ADJUSTMENT                  
         TM    LCLSTAT2,GUARERR                                                 
         BZ    INFOEND2                                                         
         MVI   MYMSGNO1,ERGRTDFT   BAD GUARANTEE RECORD                         
DONEX    MVI   BLOCK,X'A'          BUILD SUBSTITUTION BLOCK FOR GETTXT          
         MVC   BLOCK+1(9),GRTERSSN                                              
         MVI   BLOCK+10,0                                                       
         MVI   MYMTYP,GTMERR       SET ERROR MESSAGE TYPE                       
         B     INFOEND2                                                         
         SPACE 1                                                                
NOINVERR MVI   ERROR,ERABINV       PAYMENT ABORTED-MISSING INVOICE REC          
         OI    TRNSTAT,TRNABEND    SET BIT FOR CONTROLLER TO ABEND              
         B     STRTOVR2                                                         
PDINVERR MVI   ERROR,ERPDINV       PAYMENT ABORTED-INVOICE JUST PAID            
         OI    TRNSTAT,TRNABEND    SET BIT FOR CONTROLLER TO ABEND              
         SPACE 1                                                                
STRTOVR2 TM    TRNSTAT,TRNABEND      IF NOT ABENDING                            
         BO    STRTOV25                                                         
         GOTO1 DELSCRS               DELETE ANY SCREEN RECORDS WRITTEN          
STRTOV25 NI    PRGSTAT,ALL-PAYINITD  SET TO START ALL OVER NEXT TIME            
         NI    TRNSTAT,ALL-PYINPROG  SET PAY UPDATE NOT IN PROGRESS             
         TM    PRGSTAT,INITSARD      IF TSAR INITIALIZED (IN USE)               
         BZ    STRTOV27                                                         
         GOTO1 TSARCNTL,DMCB,0       INDICATE NO LONGER USING TSAR              
STRTOV27 L     R2,EFHREC                                                        
         J     THEEND                                                           
                                                                                
CNNOTVAL MVC   MYMSGNO,=Y(ERRCNNOT)  CN NO LONGER VALID FOR CANADA              
*        OI    LCLSTAT8,CNNOTCAN     TAGEN51 WILL HANDLE IT                     
         OI    LCLSTAT,TOPOK                                                    
         OI    PRGSTAT,INITSARD      IF TSAR INITIALIZED (IN USE)               
         OI    GENSTAT2,USGETTXT                                                
         MVI   BLOCK,0                                                          
         MVI   MYMTYP,GTMERR                                                    
         MVC   OVERLAY,SVMENU      CAST SELECT NOT SUCCESSFUL                   
         BRAS  RE,LOADSCRN         LOAD PREV. MENU SCREEN                       
         GOTO1 FLDVAL,DMCB,(X'04',CONRECH),ADTLLSTH                             
*                                                                               
         B     STRTOVR2                                                         
                                                                                
INFOEND2 OI    GENSTAT2,USGETTXT   SET GETTXT BLOCK                             
RECEND2  L     R2,EFHREC           CURSOR TO RECORD FIELD                       
         J     THEEND                                                           
         SPACE 1                                                                
YES2     XR    RC,RC                                                            
NO2      LTR   RC,RC                                                            
XIT2     XIT1                                                                   
         SPACE 1                                                                
YESR     CR    RE,RE                                                            
         BR    RE                                                               
NOR      LTR   RE,RE                                                            
         BR    RE                                                               
         SPACE 2                                                                
         GETEL2 R4,DATADISP,ELCODE                                              
         SPACE 2                                                                
*              CONSTANTS, ETC.                                                  
         SPACE                                                                  
HEXFFS2  DC    6X'FF'                                                           
         SPACE 2                                                                
         LTORG                                                                  
       ++INCLUDE TAUNIOND                                                       
         EJECT                                                                  
*              ROUTINE TO SAVE SOME COMMERCIAL ELEMENTS                         
         SPACE 1                                                                
SVELS    NTR1  BASE=*,LABEL=*                                                   
         MVI   ELCODE,TACOELQ      SET TO GET COMMERCIAL DETAILS EL.            
         L     R4,AIO                                                           
         BRAS  RE,GETEL                                                         
         USING TACOD,R4                                                         
         MVC   ELTACO,TACOEL       SAVE IT                                      
         MVC   FSTFXCYC,TACOFCYC   SAVE 1ST FIXED CYCLE DATE                    
         NI    LCLSTAT3,ALL-SOAPRES                                             
         TM    TGUSSTA3,SOAPUSE    IF SOAP USE TYPE                             
         BZ    SVEL5                                                            
         CLI   TGUSEQU,USOP        AND IS NOT SOP USE (IS RESIDUAL)             
         BE    SVEL5                                                            
         OI    LCLSTAT3,SOAPRES    SET STATUS BIT                               
         DROP  R4                                                               
         SPACE 1                                                                
SVEL5    XC    ELTACS,ELTACS       SAVE STUDIO ELEMENTS                         
         LA    R1,ELTACS                                                        
         MVI   ELCODE,TACSELQ                                                   
SVEL6    BRAS  RE,NEXTEL                                                        
         BNE   SVEL8                                                            
         USING TACSD,R4                                                         
         MVC   0(TACSLNQ,R1),TACSEL                                             
         CLI   TACSLEN,TACSLNQ                                                  
         BE    *+10                                                             
         MVC   TACSSTAT-TACSD(L'TACSSTAT,R1),SPACES                             
*                                                                               
SVEL7    CLI   TACSTYPE,TACSTYPF   IF FILM STUDIO                               
         BNE   *+16                                                             
         MVC   FLMDATE,TACSDATE    SAVE FILM DATE                               
         MVC   TCFLMDTE,TACSDATE                                                
         CLI   TACSTYPE,TACSTYPR   IF RECORD STUDIO                             
         BNE   *+16                                                             
         MVC   RECDATE,TACSDATE    SAVE RECORD DATE                             
         MVC   TCRECDTE,TACSDATE                                                
         CLI   TACSTYPE,TACSTYPM   IF MUSIC STUDIO                              
         BNE   *+10                                                             
         MVC   MUSDATE,TACSDATE    SAVE MUSIC DATE                              
         LA    R1,TACSLNQ(R1)                                                   
         B     SVEL6                                                            
         SPACE 1                                                                
SVEL8    GOTOR TRN2TACC,DMCB,AIO,AIO                                            
         XC    ELTACC,ELTACC       SAVE CONTRACT NUMBER ELEMENT                 
         MVI   ELCODE,TACCELQ                                                   
         L     R4,AIO                                                           
         BRAS  RE,GETEL                                                         
         BNE   *+10                                                             
         MVC   ELTACC,0(R4)                                                     
         SPACE 1                                                                
SVEL9    XC    ELTAOC,ELTAOC       SAVE OLD AGENCY/CID ELEMENT                  
         MVI   ELCODE,TAOCELQ                                                   
         L     R4,AIO                                                           
         BRAS  RE,GETEL                                                         
         BNE   *+10                                                             
         MVC   ELTAOC,0(R4)                                                     
         SPACE 1                                                                
         USING TAFND,R4                                                         
         XC    ELTAFNP,ELTAFNP     SAVE FREE FORM PRODUCT NAME IF ANY           
         MVI   ELCODE,TAFNELQ                                                   
         GOTO1 GETL,DMCB,(1,=AL1(TAFNTPRD))                                     
         BNE   SVEL10                                                           
         L     R4,TGELEM           R4=A(TGELEM)                                 
         ZIC   R1,TAFNLEN                                                       
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   ELTAFNP(0),TAFNEL                                                
         SPACE 1                                                                
SVEL10   XC    ELTAFNPH,ELTAFNPH                                                
         XC    ELTAFNS,ELTAFNS                                                  
         XC    PHOTOSSN,PHOTOSSN                                                
         XC    SRVCODE,SRVCODE                                                  
         CLI   TGUSMEDS,PRINT      IF PRINT PAYMENT                             
         BNE   SVELX                                                            
         SPACE                                                                  
         USING TANUD,R4                                                         
         MVI   ELCODE,TANUELQ                                                   
         GOTO1 GETL,DMCB,(1,=AL1(TANUTPHO))                                     
         BNE   *+14                                                             
         L     R4,TGELEM           R4=A(TGELEM)                                 
         MVC   PHOTOSSN,TANUMBER                                                
         GOTO1 (RF),(R1),(1,=AL1(TANUTSVC))                                     
         BNE   *+14                                                             
         L     R4,TGELEM           R4=A(TGELEM)                                 
         MVC   SRVCODE,TANUMBER                                                 
         SPACE                                                                  
         USING TAFND,R4                                                         
         MVI   ELCODE,TAFNELQ                                                   
         GOTO1 GETL,DMCB,(1,=AL1(TAFNTPHO))                                     
         BNE   SVEL12                                                           
         L     R4,TGELEM           R4=A(TGELEM)                                 
         ZIC   R1,TAFNLEN                                                       
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   ELTAFNPH(0),TAFNEL                                               
         SPACE                                                                  
SVEL12   GOTO1 GETL,DMCB,(1,=AL1(TAFNTSVC))                                     
         BNE   SVELX                                                            
         L     R4,TGELEM           R4=A(TGELEM)                                 
         ZIC   R1,TAFNLEN                                                       
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   ELTAFNS(0),TAFNEL                                                
SVELX    J     XIT                                                              
         LTORG                                                                  
         EJECT                                                                  
*              ROUTINE VALIDATES COMMERCIAL FOR SOCIAL MEDIA PAYMENT            
         USING TACOD,R4                                                         
VALSOM   NTR1  BASE=*,LABEL=*                                                   
         CLI   TACOLEN,TACOLNQ2                                                 
         BL    VSOM10                                                           
         TM    TACOSTA3,TACOSSMW   SOCIAL MEDIA WAIVER MUST BE ON               
         JO    XIT                                                              
VSOM10   LA    R2,PAYCIDH          ALWAYS READ COMMERCIAL                       
         MVC   MYMSGNO,=Y(ERINVUCO) INVALID USE FOR COMMERCIAL                  
         J     NTHEEND                                                          
         DROP  R4                                                               
         LTORG                                                                  
         EJECT                                                                  
*              ROUTINE TO VALIDATE AGENCY STUDIO CODE                           
VALXASC  NTR1  BASE=*,LABEL=*                                                   
         XC    AGYSCDE,AGYSCDE                                                  
         MVC   WORK2(6),TGAGY                                                   
         MVC   AIO,AIO3                                                         
         USING SCAND,R3                                                         
         GOTO1 RECVAL,DMCB,TLAYCDQ,(X'84',SCDATA2)                              
         BNE   VALXASC3                                                         
         MVC   AGYSCDE,SCDATA2                                                  
VALXASC3 GOTO1 RECVAL,DMCB,TLAYCDQ,(X'84',WORK2)                                
         MVC   AIO,AIO1                                                         
         CLC   AGYSCDE,SPACES      SET CC=NE                                    
         JNH   XIT2                                                             
         CR    RB,RB               SET CC=EQ                                    
         J     XIT2                                                             
         DROP  R3                                                               
         EJECT                                                                  
*              ROUTINE TO ADD DUE COMPANY RECORD FOR CREDIT PAYMENTS            
         SPACE 1                                                                
DUECOMP  NTR1  BASE=*,LABEL=*                                                   
         TM    TGSYSTA2,TASYSNDC   NEW DUE COMPANY?                             
         BO    DDUECOMP                                                         
*                                                                               
         TM    PAYOPTS3,ODUMMY     DON'T DO IF DUMMY PAYMENT                    
         JO    XIT2                                                             
         TM    PAYSTAT1,BNP        DON'T BOTHER IF BILL-NO-PAYROLL              
         JO    XIT2                                                             
         L     R2,TCPAY            DON'T BOTHER IF PAYMENT AMOUNT PLUS          
         A     R2,TCEXP            REIMBURSED EXPENSES IS ZERO                  
         JZ    XIT2                                                             
         XC    KEY,KEY             BUILD KEY                                    
         LA    R3,KEY                                                           
         USING TLDUD,R3                                                         
         MVI   TLDUCD,TLDUCDQ               RECORD CODE                         
         MVC   TLDUSSN,TGSSN                SOCIAL SECURITY NUMBER              
         OC    ELTATI,ELTATI                IF PAYING INDIV. AS A CORP.         
         BZ    *+10                                                             
         MVC   TLDUSSN,ELTATI+TATIID-TATID  USE CORP. ID NUMBER INSTEAD         
         MVC   TLDUDUC(4),TGTODAY0          YEAR/MONTH                          
         ZAP   DUB,=P'1'                    INITIALIZE SEQ                      
         SPACE 1                                                                
DCMP2    OI    DUB+7,X'0F'         SET SEQUENCE NUMBER IN KEY                   
         UNPK  TLDUDUC+4(2),DUB+6(2)                                            
         GOTO1 HIGH                SEE IF KEY ALREADY EXISTS                    
         CLC   TLDUKEY,KEYSAVE                                                  
         BNE   *+14                                                             
         AP    DUB,=P'1'           IT DOES, ADD ONE TO SEQ                      
         B     DCMP2               AND TRY AGAIN                                
         MVC   KEY,KEYSAVE         FOUND UNIQUE KEY - RESTORE IT                
         SPACE 1                                                                
         L     R3,AIO              BUILD RECORD IN I/O AREA                     
         MVC   TLDUKEY,KEY                                                      
         MVC   TLDULEN,DATADISP    INIT. RECORD LENGTH                          
         XC    TLDUSTAT(10),TLDUSTAT                                            
         SPACE 1                                                                
         XC    ELEMENT,ELEMENT     INITIALIZE ELEMENT TO BINARY ZEROS           
         LA    R4,ELEMENT                                                       
         USING TADUD,R4                                                         
         MVI   TADUEL,TADUELQ      BUILD DUE COMPANY DETAILS ELEMENT            
         MVI   TADULEN,TADULNQ                                                  
         MVC   TADUEMP,EOR         EMPLOYER                                     
         MVC   TADUAGY,TGAGY       AGENCY                                       
         MVC   TADUUNI,TGUNI       UNION                                        
         MVC   TADUINV,EINVNO      ERROR INVOICE  (ORIGINAL)                    
         MVC   TADUCINV,INVNO      CREDIT INVOICE (THIS ONE)                    
         MVC   TADUFCLI,TGCLI      CLIENT                                       
         MVI   TADUTYPE,TADUTYDU   ASSUME DUE COMP STATUS (TP FAULT)            
         ST    R2,TADUDUE          SET AMOUNT DUE                               
         OI    TADUSTAT,TADUSAUT+TADUSAGY+TADUSHLD  SET AUTO, COLLECT           
*                                  ONLY FROM THIS AGENCY, PUT ON HOLD           
         TM    TCSTAT2,TCSTCAN$                                                 
         BZ    *+8                                                              
         OI    TADUSTAT,TADUSCAN   CANADIAN DOLLAR PAYMENT                      
         SPACE                                                                  
         TM    TCSTAT2,TCSTEURO                                                 
         BZ    *+8                                                              
         OI    TADUSTAT,TADUSEUR   EURO PAYMENT                                 
         SPACE                                                                  
         TM    LCLSTAT2,GLOBCLI    IF CLIENT IS GLOBAL                          
         BZ    *+8                                                              
         OI    TADUSTAT,TADUSCLI   SET COLLECT ONLY FROM THIS CLIENT            
         SPACE                                                                  
         TM    PAYOPTS2,ORCVCLI    OPTION TO RECOVER FROM CLIENT ONLY           
         BZ    *+8                                                              
         NI    TADUSTAT,ALL-TADUSAGY                                            
         TM    PAYOPTS2,ORCVAGY    OPTION TO RECOVER FROM AGENCY ONLY           
         BZ    *+8                                                              
         NI    TADUSTAT,ALL-TADUSCLI                                            
         TM    PAYOPTS2,ORCVALL    OPTION TO RECOVER FROM ALL                   
         BZ    *+8                                                              
         NI    TADUSTAT,ALL-TADUSAGY-TADUSCLI                                   
         SPACE 1                                                                
         GOTO1 ADDL                ADD ELEMENT TO RECORD                        
         SPACE 1                                                                
         OC    DSPHCOM,DSPHCOM     ADD HISTORY COMMENT TO RECORD                
         BZ    DCMP5                                                            
         LH    RF,DSPHCOM                                                       
         AR    RF,RA                                                            
         GOTO1 NAMIN,DMCB,TACMELQ,(X'80',(RF)),TACMTYPG                         
         SPACE                                                                  
DCMP5    GOTO1 ACTVIN,DMCB,0       ADD ACTIVITY ELEMENT                         
         SPACE 1                                                                
         GOTO1 MYADDREC            ADD RECORD TO FILE                           
         BRAS  RE,ADUEPTRS         ADD PASSIVE POINTERS                         
         SPACE 1                                                                
         USING TADWD,R4                                                         
DCMP6    LA    R4,ELTADU                                                        
         MVI   TADWEL,TADWELQ      BUILD DUE COMP WITHHOLDING ELEMENT           
         MVI   TADWLEN,TADWLNQ     FOR CHECK RECORD                             
         MVC   TADWDUC,TLDUDUC                                                  
         ST    R2,TADWBAL          SET BALANCE                                  
         LCR   R2,R2               COMPLEMENTED                                 
         ST    R2,TADWREC          IS AMOUNT RECOVERED                          
         J     XIT2                                                             
*                                                                               
DDUECOMP TM    PAYOPTS3,ODUMMY     DON'T DO IF DUMMY PAYMENT                    
         JO    XIT2                                                             
         TM    PAYSTAT1,BNP        DON'T BOTHER IF BILL-NO-PAYROLL              
         JO    XIT2                                                             
         L     R2,TCPAY            DON'T BOTHER IF PAYMENT AMOUNT PLUS          
         A     R2,TCEXP            REIMBURSED EXPENSES IS ZERO                  
         JZ    XIT2                                                             
*                                                                               
         LA    RF,ELTADU                                                        
         STCM  RF,15,CSTTADU                                                    
*                                                                               
         L     R2,TCPAY                                                         
         MVI   CSTDUEFL,DUEFWAGE   DO WAGES FIRST                               
         OC    TCPAY,TCPAY                                                      
         JZ    DDCMP10                                                          
*                                                                               
DDCMP1   XC    KEY,KEY             BUILD KEY                                    
         LA    R3,KEY                                                           
         USING TLDUD,R3                                                         
         MVI   TLDUCD,TLDUCDQ               RECORD CODE                         
         MVC   TLDUSSN,TGSSN                SOCIAL SECURITY NUMBER              
         OC    ELTATI,ELTATI                IF PAYING INDIV. AS A CORP.         
         BZ    *+10                                                             
         MVC   TLDUSSN,ELTATI+TATIID-TATID  USE CORP. ID NUMBER INSTEAD         
         MVC   TLDUDUC(4),TGTODAY0          YEAR/MONTH                          
         ZAP   DUB,=P'1'                    INITIALIZE SEQ                      
         SPACE 1                                                                
DDCMP2   OI    DUB+7,X'0F'         SET SEQUENCE NUMBER IN KEY                   
         UNPK  TLDUDUC+4(2),DUB+6(2)                                            
         GOTO1 HIGH                SEE IF KEY ALREADY EXISTS                    
         CLC   TLDUKEY,KEYSAVE                                                  
         BNE   *+14                                                             
         AP    DUB,=P'1'           IT DOES, ADD ONE TO SEQ                      
         B     DDCMP2              AND TRY AGAIN                                
         MVC   KEY,KEYSAVE         FOUND UNIQUE KEY - RESTORE IT                
         SPACE 1                                                                
         L     R3,AIO              BUILD RECORD IN I/O AREA                     
         MVC   TLDUKEY,KEY                                                      
         MVC   TLDULEN,DATADISP    INIT. RECORD LENGTH                          
         XC    TLDUSTAT(10),TLDUSTAT                                            
         SPACE 1                                                                
         XC    ELEMENT,ELEMENT     INITIALIZE ELEMENT TO BINARY ZEROS           
         LA    R4,ELEMENT                                                       
         USING TADUD,R4                                                         
         MVI   TADUEL,TADUELQ      BUILD DUE COMPANY DETAILS ELEMENT            
         MVI   TADULEN,TADULNQ                                                  
         MVC   TADUEMP,EOR         EMPLOYER                                     
         MVC   TADUAGY,TGAGY       AGENCY                                       
         MVC   TADUUNI,TGUNI       UNION                                        
         MVC   TADUINV,EINVNO      ERROR INVOICE  (ORIGINAL)                    
         MVC   TADUCINV,INVNO      CREDIT INVOICE (THIS ONE)                    
         MVC   TADUFCLI,TGCLI      CLIENT                                       
         MVI   TADUTYPE,TADUTYDU   ASSUME DUE COMP STATUS (TP FAULT)            
         ST    R2,TADUDUE          SET AMOUNT DUE                               
         OI    TADUSTAT,TADUSAUT+TADUSAGY+TADUSHLD  SET AUTO, COLLECT           
*                                  ONLY FROM THIS AGENCY, PUT ON HOLD           
*                                                                               
         CLI   CSTDUEFL,DUEFTR     TAXABLE REIM?                                
         JNE   *+8                                                              
         OI    TADUSTA2,TADUSTXR                                                
         CLI   CSTDUEFL,DUEFNR     NON TAX REIM?                                
         JNE   *+8                                                              
         OI    TADUSTAT,TADUSNTR                                                
*                                                                               
         TM    TCSTAT2,TCSTCAN$                                                 
         BZ    *+8                                                              
         OI    TADUSTAT,TADUSCAN   CANADIAN DOLLAR PAYMENT                      
         SPACE                                                                  
         TM    TCSTAT2,TCSTEURO                                                 
         BZ    *+8                                                              
         OI    TADUSTAT,TADUSEUR   EURO PAYMENT                                 
         SPACE                                                                  
         TM    LCLSTAT2,GLOBCLI    IF CLIENT IS GLOBAL                          
         BZ    *+8                                                              
         OI    TADUSTAT,TADUSCLI   SET COLLECT ONLY FROM THIS CLIENT            
         SPACE                                                                  
         TM    PAYOPTS2,ORCVCLI    OPTION TO RECOVER FROM CLIENT ONLY           
         BZ    *+8                                                              
         NI    TADUSTAT,ALL-TADUSAGY                                            
         TM    PAYOPTS2,ORCVAGY    OPTION TO RECOVER FROM AGENCY ONLY           
         BZ    *+8                                                              
         NI    TADUSTAT,ALL-TADUSCLI                                            
         TM    PAYOPTS2,ORCVALL    OPTION TO RECOVER FROM ALL                   
         BZ    *+8                                                              
         NI    TADUSTAT,ALL-TADUSAGY-TADUSCLI                                   
         SPACE 1                                                                
         GOTO1 ADDL                ADD ELEMENT TO RECORD                        
         SPACE 1                                                                
         OC    DSPHCOM,DSPHCOM     ADD HISTORY COMMENT TO RECORD                
         BZ    DDCMP5                                                           
         LH    RF,DSPHCOM                                                       
         AR    RF,RA                                                            
         GOTO1 NAMIN,DMCB,TACMELQ,(X'80',(RF)),TACMTYPG                         
         SPACE                                                                  
DDCMP5   GOTO1 ACTVIN,DMCB,0       ADD ACTIVITY ELEMENT                         
         SPACE 1                                                                
         GOTO1 MYADDREC            ADD RECORD TO FILE                           
         BRAS  RE,ADUEPTRS         ADD PASSIVE POINTERS                         
         SPACE 1                                                                
         USING TADWD,R4                                                         
DDCMP6   ICM   R4,15,CSTTADU                                                    
         MVI   TADWEL,TADWELQ      BUILD DUE COMP WITHHOLDING ELEMENT           
         MVI   TADWLEN,TADWLNQ     FOR CHECK RECORD                             
         MVC   TADWDUC,TLDUDUC                                                  
         ST    R2,TADWBAL          SET BALANCE                                  
         LCR   R2,R2               COMPLEMENTED                                 
         ST    R2,TADWREC          IS AMOUNT RECOVERED                          
*                                                                               
         CLI   CSTDUEFL,DUEFTR     TAXABLE REIM?                                
         JNE   *+8                                                              
         OI    TADWSTAT,TADWSTR                                                 
         CLI   CSTDUEFL,DUEFNR     NON TAX REIM?                                
         JNE   *+8                                                              
         OI    TADWSTAT,TADWSNR                                                 
         AHI   R4,TADWLNQ                                                       
         STCM  R4,15,CSTTADU                                                    
*                                                                               
DDCMP10  CLI   CSTDUEFL,DUEFWAGE   WAGES?                                       
         JNE   DDCMP12                                                          
         MVI   CSTDUEFL,DUEFNR     DO NON TAX REIM NEXT                         
         OC    TCEXP,TCEXP                                                      
         JZ    DDCMP12                                                          
         L     R2,TCEXP                                                         
         CLC   =C'P+',AGYEOR                                                    
         JNE   DDCMP1                                                           
         S     R2,TCTXNW                                                        
         LTR   R2,R2                                                            
         JNZ   DDCMP1                                                           
*                                                                               
DDCMP12  CLC   =C'P+',AGYEOR       DO TAX REIM HERE                             
         JNE   DUECOMPX                                                         
         CLI   CSTDUEFL,DUEFTR     ALL DONE?                                    
         JE    DUECOMPX                                                         
         MVI   CSTDUEFL,DUEFTR                                                  
         OC    TCTXNW,TCTXNW                                                    
         JZ    DUECOMPX                                                         
         L     R2,TCTXNW                                                        
         J     DDCMP1                                                           
*                                                                               
DUECOMPX J     XIT2                                                             
         SPACE 2                                                                
*                                                                               
DUEFWAGE EQU   1                   WAGES                                        
DUEFTR   EQU   2                   TAXABLE REIM                                 
DUEFNR   EQU   3                   NON TAXABLE REIM                             
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
ADUEPTRS NTR1  BASE=*,LABEL=*                                                   
         TM    PAYMODE,DRAFT       ADD PASSIVE POINTERS                         
         JO    XIT2                                                             
         L     R2,ATMPPAYD                                                      
         USING TMPPAYD,R2                                                       
         XC    DUEPTRS,DUEPTRS                                                  
         GOTO1 ADDPTRS,DMCB,DUEPTRS                                             
         J     XIT2                                                             
         LTORG                                                                  
         DROP  R2                                                               
*              ROUTINE SETS INDIVIDUAL'S CYCLE (TCIPCYC) IN THE CASE            
*              OF SPLIT CYCLES.                                                 
         SPACE 1                                                                
         USING TACAD,R4            R4=A(CAST DETAILS EL.)                       
SETICYC  NTR1  BASE=*,LABEL=*                                                   
         OC    TACAFCYC,TACAFCYC   TEST CAST HAS OWN FFC                        
         JZ    XIT2                                                             
         CLC   TACAFCYC,FSTFXCYC   TEST CAST'S FFC NOT SAME AS COMML'S          
         JE    XIT2                                                             
         MVC   WORK(3),TACAFCYC    ASSUME CALC. BASED ON CAST FFC               
         MVC   TGTHREE,TACAFCYC    SAVE IT IN TGTHREE                           
         LA    R3,1                SET DATCON INPUT FORMAT                      
         MVI   BYTE,C'Y'           SET WE'RE CALC. END DATE                     
         SPACE 1                                                                
         TM    TGUSSTAT,SESSION    REQUIRED ONLY FOR SESSIONS                   
         JO    SETI30                                                           
         TM    TGUSSTA2,HLDTYPE    AND HOLDING FEE TYPES                        
         JZ    XIT2                                                             
         MVI   BYTE,C'N'           IF 1ST HLD, 1ST HAVE TO CALC START           
         L     R4,TCACAST                                                       
         MVI   ELCODE,TACRELQ                                                   
         BRAS  RE,GETEL            SCAN APPLIED CREDIT HISTORY ELEMENTS         
         J     *+8                                                              
SETI10   BRAS  RE,NEXTEL           GET NEXT ELEMENT                             
         JNE   SETI20                                                           
         USING TACRD,R4                                                         
         MVC   WORK+3(3),TACREND   SAVE LAST CYCLE END DATE                     
         CLC   TACRUSE,=C'HLD'                                                  
         JE    SETI12                                                           
         CLC   TACRUSE,=C'ADH'                                                  
         JE    SETI12                                                           
         CLC   TACRUSE,=C'SHL'                                                  
         JNE   *+8                                                              
SETI12   MVI   BYTE,C'Y'           SET HLD HAS BEEN PAID                        
         J     SETI10                                                           
         SPACE 1                                                                
SETI20   MVC   TGBYTE2,BYTE        SAVE WHETHER HLD HAS BEEN PAID               
         CLI   BYTE,C'Y'           IF A HLD HAS ALREADY BEEN PAID               
         JNE   SETI30                                                           
         GOTO1 DATCON,DMCB,(1,WORK+3),(0,DUB)  TAKE PREVIOUS END DATE           
         GOTO1 ADDAY,DMCB,DUB,WORK,1           ADD ONE DAY                      
         XR    R3,R3                           SET DATCON I/P FORMAT 0          
         SPACE 1                                                                
SETI30   GOTO1 PVAL,DMCB,((R3),WORK),(BYTE,TCIPCYC)  CALC. DATE                 
         SPACE 1                                                                
         CLI   BYTE,C'N'           IF THIS IS FIRST HLD                         
         JNE   SETIX                                                            
         MVC   WORK(3),TCIPCYCE    WE JUST CALC'ED NEXT START IN END            
         MVI   BYTE,C'Y'           NOW GO CALC. END                             
         J     SETI30                                                           
         SPACE 1                                                                
SETIX    LA    R1,TCIPCYCS         USE INDIV. CYCLE                             
         TM    CYCSTAT,CYSTGENC    IF CYCLE IS INPUT                            
         JO    *+14                                                             
         XC    TCIPCYC,TCIPCYC     CLEAR INDIV. CYCLE                           
         LA    R1,TCPCYCS          USE INPUT CYCLE                              
         TM    TGUSSTA2,HLDTYPE    FOR HOLDING FEE TYPES ONLY                   
         JZ    XIT                                                              
         CLI   TGBYTE2,C'Y'        DON'T BOTHER IF HLD ALREADY PAID             
         JE    XIT                                                              
         CLC   TGTHREE,0(R1)       IF CAST FFC = CYCLE START                    
         JNE   XIT                                                              
         OI    CASTSTAT,CSTNPAY    SET DON'T PAY THIS CAST MEMBER               
         J     XIT                                                              
                                                                                
         LTORG                                                                  
         EJECT                                                                  
*              ROUTINE TO INITIALIZE PAYMENT DETAILS ELEMENT                    
         SPACE 1                                                                
         USING TAPDD,R4                                                         
PDINIT   NTR1  BASE=*,LABEL=*                                                   
         XC    ELEMENT,ELEMENT     INITIALIZE TO BINARY ZEROS                   
         LA    R4,ELEMENT                                                       
         MVI   TAPDEL,TAPDELQ                                                   
         MVI   TAPDLEN,TAPDLNQ                                                  
         SPACE 1                                                                
         CLI   TGUSMEDS,PRINT      IF PRINT PAYMENT                             
         BNE   PDIN3                                                            
         MVC   TAPDAREA,TGAREA     SAVE AREA                                    
         MVC   TAPDPUSE,TGUSE      AND USE                                      
         SPACE 1                                                                
PDIN3    MVC   TAPDCOM,TGCOM       INTERNAL COMMERCIAL NUMBER                   
         MVC   TAPDINV,INVNO       INVOICE NUMBER                               
         MVC   TAPDEOR,EOR         EMPLOYER-OF-RECORD                           
         MVC   TAPDCLI,TGCLI       CLIENT                                       
         MVC   TAPDPRD,TGPRD       PRODUCT                                      
         MVC   TAPDOFF,TGOFF       TP OFFICE CODE                               
         SPACE 1                                                                
         MVC   TAPDUSE,TGUSCDE     USE CODE                                     
         MVC   TAPDTYPE,TGUSTYP    USE TYPE                                     
         MVC   TAPDESPD,ESTPD      ESTIMATE PERIOD                              
         SPACE 1                                                                
         MVC   TAPDUNIT,TCUNITS    N'UNITS                                      
         MVC   TAPDMAJ,TCMAJORS    MAJORS                                       
         MVC   TAPDINS,TCINSRTS    N'INSERTS                                    
         MVC   TAPDTAGS,TCTAGS     N'TAGS                                       
         MVC   TAPDDEMS,TCDEMO     N'DEMOS                                      
         SPACE 1                                                                
         CLI   LIFT,C'A'           TEST PAYMENT MADE TO ALL ON COMM'L           
         BNE   *+12                                                             
         OI    TAPDSTA2,TAPDSLFA   SET BIT                                      
         B     PDIN6                                                            
         CLI   LIFT,C'Y'           IF ENTIRE PAYMENT MADE TO LIFT               
         BE    PDIN5                                                            
         CLI   LIFTPAID,C'Y'       OR USES PAID TO LIFT                         
         BNE   *+8                                                              
PDIN5    OI    TAPDSTAT,TAPDSLFT   SET PAYMENT PAID TO LIFT                     
         SPACE 1                                                                
PDIN6    CLI   VERSION,0           IF HAVE VERSION # PAID                       
         BE    *+8                                                              
         OI    TAPDSTA2,TAPDSVER   MUST HAVE PAID A VERSION, SO SET BIT         
         SPACE 1                                                                
         CLI   TWAOFFC,C'*'        PAYMENT MADE ON DDS TERMINAL                 
         BNE   *+8                                                              
         OI    TAPDSTAT,TAPDSDDS                                                
         SPACE 1                                                                
         TM    TCSTAT2,TCSTCAN$                                                 
         BZ    *+8                                                              
         OI    TAPDSTAT,TAPDSCAN   CANADIAN DOLLAR PAYMENT                      
         SPACE 1                                                                
         TM    LCLSTAT2,JOBOVRER   TEST OVERRODE JOB NUMBER ERROR               
         BZ    *+8                                                              
         OI    TAPDSTAT,TAPDSOVJ                                                
         SPACE 1                                                                
         TM    LCLSTAT3,FORCEUPG   TEST FORCED WILDSPOT UPGRADE                 
         BZ    *+8                                                              
         OI    TAPDSTA2,TAPDSFUP                                                
         SPACE 1                                                                
         TM    LCLSTAT6,AFTRPAID   TEST AFTRA PERFROMER BEING PAID              
         BZ    *+8                                                              
         OI    TAPDSTA2,TAPDAFTR                                                
         SPACE 1                                                                
         MVC   TAPDPSTS,PAYSTATS   PAYMENT STATUS                               
         SPACE 1                                                                
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         BZ    *+8                                                              
         OI    TAPDPST2,TAPDFWEB   SET FROM WEB APPLICATION STATUS              
         SPACE 1                                                                
         CLC   TGTODAY1,TGSYITCD   IF UPDATING GUARANTEES AT BILLING/           
         BL    *+8                 CHECK TIME                                   
         OI    TAPDPST2,TAPDPITC   SET STATUS                                   
         SPACE 1                                                                
         MVC   TAPDOPTS,PAYOPTS    PAYMENT OPTIONS                              
         MVC   TAPDOPT4,PAYOPTS4   PAYMENT OPTION 4                             
         MVC   TAPDOPT5,PAYOPTS5   PAYMENT OPTION 5                             
         J     XIT                                                              
*              ROUTINE TO VALIDATE AMOUNT FIELDS                                
         SPACE 1                                                                
*                                  P1=A(DISP. TO FIELD)                         
*                                  P2=A(W/S AREA FOR AMOUNT)                    
*                                     X'80'=ALLOW NEGATIVE AMOUNTS              
AMTVAL   NTR1  BASE=*,LABEL=*                                                   
         LM    R3,R4,0(R1)                                                      
         MVC   BYTE,4(R1)          SAVE PARAMETER BYTE                          
         LH    R2,0(R3)                                                         
         LTR   R2,R2               TEST FIELD ON SCREEN                         
         JZ    NO                                                               
         A     R2,ATHSLINE         ADD A(THIS LINE)                             
         SPACE                                                                  
         ZIC   R3,5(R2)            R3=INPUT LENGTH                              
         TM    1(R2),X'20'                                                      
         JZ    *+8                                                              
         IC    R3,7(R2)            USE OUTPUT LENGTH IF PROTECTED               
         SPACE                                                                  
         LTR   R3,R3               TEST FOR INPUT                               
         JZ    NO                                                               
         GOTO1 CASHVAL,DMCB,8(R2),(R3)                                          
         CLI   0(R1),X'FF'                                                      
         JE    AMTINV                                                           
         TM    BYTE,X'80'          UNLESS OVERRIDDEN                            
         JO    *+12                                                             
         TM    4(R1),X'80'         DON'T ALLOW NEGATIVE AMOUNTS                 
         JO    AMTINV                                                           
         MVC   0(4,R4),4(R1)       SAVE AMOUNT                                  
         J     YES                                                              
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
**********************************************************************          
* CHECK AMOUNT ENTERED OVER CREDITED INVOICE AMOUNT                             
**********************************************************************          
CHKCRDAM NTR1  BASE=*,LABEL=*                                                   
         TM    PAYSTAT1,CREDIT     IF CREDIT INVOICE                            
         JZ    XIT                                                              
         TM    TGSYSTAT,TASYSCRD   AND NEW CREDITING RULES ARE                  
         JZ    XIT                 ENABLED ...                                  
                                                                                
         LM    R2,R4,0(R1)                                                      
         CLC   0(4,R3),0(R4)       COMPARE AMOUNT TO WHAT IS LEFT               
         JNH   XIT                 NOT MORE, LEAVE                              
                                                                                
         LH    R2,0(R2)            IT'S MORE, ERROR OUT                         
         A     R2,ATHSLINE         ADD A(THIS LINE)                             
         MVC   MYMSGNO,=Y(ERRCRDAM)                                             
         MVI   MYMTYP,GTMERR                                                    
         OI    GENSTAT2,USGETTXT                                                
         MVI   BLOCK,9                                                          
         ICM   R1,15,0(R4)                                                      
         EDIT  (R1),(12,BLOCK+1),2,ALIGN=LEFT                                   
         MVI   BLOCK+9,0                                                        
         J     THEEND                                                           
                                                                                
         LTORG                                                                  
         EJECT                                                                  
**********************************************************************          
* RECONCILE CREDITS                                                             
*   - READS CREDIT INVOICE'S CHECKS AND RECONCILE ANY PRIOR CREDITS             
**********************************************************************          
RCNCREDS NTR1  BASE=*,LABEL=*                                                   
                                                                                
         XC    TCCRREXP,TCCRREXP   CLEAR OUT CREDIT AMOUNTS                     
         XC    TCCRPAY,TCCRPAY                                                  
         XC    TCCRSPNH,TCCRSPNH                                                
                                                                                
         TM    PAYSTAT1,CREDIT     IF CREDIT INVOICE                            
         JZ    XIT                                                              
         TM    TGSYSTAT,TASYSCRD   AND NEW CREDITING RULES ARE                  
         JZ    XIT                 ENABLED ...                                  
                                                                                
         MVC   SVSYSFIL,SYSFIL                                                  
         MVC   SVSYSDIR,SYSDIR                                                  
         MVC   SYSFIL,=CL8'CHKFIL' SET SYSFIL AND SYSDIR FOR CHECKS             
         MVC   SYSDIR,=CL8'CHKDIR'                                              
                                                                                
         XC    KEY,KEY                                                          
         LA    R3,KEY                                                           
         USING TLCKD,R3                                                         
         MVI   TLCKCD,TLCKCDQ      CHECK ACTIVE POINTER                         
         MVC   TLCKAGY,TGAGY       AGENCY                                       
         MVC   TLCKINV,EINVNO      INVOICE BEING CREDITED                       
         MVC   TLCKSORT,TGCSORT    CAST SORT SEQ                                
         GOTO1 HIGH                                                             
                                                                                
         CLC   TLCKKEY(TLCKSSN-TLCKKEY),KEYSAVE   HAS TO FIND ORIG INV          
         BNE   RCNCR900                                                         
         MVC   AIO,AIO3            READ CHECK INTO AIO3                         
         GOTO1 GETREC                                                           
                                                                                
         L     R4,AIO              GET THE CREDITED INVOICE AMOUNTS             
         USING TAPDD,R4                                                         
         MVI   ELCODE,TAPDELQ                                                   
         BRAS  RE,GETEL                                                         
         BNE   RCNCR900                                                         
         L     RF,TAPDPAYI                                                      
         A     RF,TAPDPAYC                                                      
         STCM  RF,15,TCCRPAY                                                    
         MVC   TCCRREXP,TAPDREXP                                                
         MVC   TCCRSPNH,TAPDSPNH                                                
         TM    LCLSTAT3,SOAPRES    IF USE IS A SOAP RESIDUAL                    
         BZ    *+10                                                             
         MVC   TCCRSPNH,TAPDPNH    USE P&H AMOUNT                               
                                                                                
         XC    KEY,KEY             SEE IF WE HAVE PRIOR CREDITS                 
         LA    R3,KEY                                                           
         USING TLCKPD,R3                                                        
         MVI   TLCKPCD,TLCKRCDQ    CHECK CREDIT INVOICE                         
         MVC   TLCKRAGY,TGAGY      AGENCY                                       
         MVC   TLCKRCIN,EINVNO     INVOICE BEING CREDITED                       
         MVC   TLCKRCOM,TGCOM      INTERNAL COMMERCIAL                          
         MVC   TLCKRCSQ,TGCSORT+4  CAST SORT SEQ                                
         GOTO1 HIGH                                                             
                                                                                
RCNCR500 CLC   TLCKPKEY(TLCKRINV-TLCKPKEY),KEYSAVE                              
         BNE   RCNCR900                                                         
         TM    TLCKPKEY+(TLDRSTAT-TLDRD),X'80'    DELETED?                      
         BO    RCNCR800                           SKIP THOSE                    
                                                                                
         GOTO1 GETREC              GET CREDIT INVOICE CHECK                     
                                                                                
         L     R4,AIO              GET THE CREDITED INVOICE AMOUNTS             
         USING TAPDD,R4                                                         
         MVI   ELCODE,TAPDELQ                                                   
         BRAS  RE,GETEL                                                         
         BNE   RCNCR900                                                         
         ICM   RF,15,TCCRPAY                                                    
         A     RF,TAPDPAYI         REMOVE PRIOR PAYMENTS                        
         A     RF,TAPDPAYC                                                      
         STCM  RF,15,TCCRPAY                                                    
                                                                                
         ICM   RF,15,TCCRREXP                                                   
         A     RF,TAPDREXP         REMOVE PRIOR REXP                            
         STCM  RF,15,TCCRREXP                                                   
                                                                                
         ICM   RF,15,TCCRSPNH                                                   
         TM    LCLSTAT3,SOAPRES                                                 
         BO    RCNCR650                                                         
RCNCR600 A     RF,TAPDSPNH         REMOVE PRIOR SUBJ P&H                        
         B     RCNCR680                                                         
RCNCR650 A     RF,TAPDPNH          REMOVE PRIOR P&H FOR SOAP RESIDUAL           
RCNCR680 STCM  RF,15,TCCRSPNH                                                   
         DROP  R4                                                               
                                                                                
RCNCR800 GOTO1 SEQ                                                              
         B     RCNCR500                                                         
                                                                                
RCNCR900 MVC   SYSFIL,SVSYSFIL                                                  
         MVC   SYSDIR,SVSYSDIR                                                  
         MVC   AIO,AIO1                                                         
         J     XIT                                                              
                                                                                
         LTORG                                                                  
         EJECT                                                                  
**********************************************************************          
* VALIDATE SUBJECT TO P&H FOR GUARANTEE CONTRACTS                               
**********************************************************************          
GCNTPNH  NTR1  BASE=*,LABEL=*                                                   
         OC    GUARCONT,GUARCONT   IF GUARANTEE CONTRACT IS BEING               
         JZ    XIT                 APPLIED TO PAYMENT                           
*                                                                               
         L     R2,ATHSLINE         R2=A(NP FIELD OF CAST)                       
         ZIC   RF,0(R2)            BUMP TO EXTENDED FIELD HEADER                
         SHI   RF,8                                                             
         AR    R2,RF                                                            
         CLI   1(R2),0             FIELD IS 0 IF CAST NOT SAG OR AFT            
         JE    XIT                 (THIS WAS SET IN TAGEN51)                    
*                                                                               
         SR    R2,R2                                                            
         LH    R2,DSPSPNH                                                       
         A     R2,ATHSLINE         R2=A(SUBJECT TO P&H FIELD)                   
*                                                                               
**********************************************************************          
*                                                                               
         CLI   TGUSEQU,UGRT        IF THIS IS NON-CREDIT GRT PAYMENT            
         JNE   GCPNH20             AND SUBJ TO P&H ENTERED                      
         TM    PAYSTAT1,CREDIT     SUBJECT TO P&H CANNOT KNOCK                  
         JO    GCPNH10             GUARANTEE CONTRACT YEAR BALANCE              
         TM    TCINPUT,TCINPNH     BELOW ZERO                                   
         JO    GCPNH30                                                          
*                                                                               
         TM    TCINPUT,TCINPAY     IF SUBJECT TO P&H WAS NOT ENTERED            
         JZ    XIT                 AND PAYMENT AMOUNT WAS ENTERED               
         MVC   TCSUBPNH,TCPAY                                                   
         L     RE,GCWRKBAL                                                      
         S     RE,TCPAY            IF PAYMENT AMOUNT DOES NOT KNOCK             
         JNM   GCPNHX              GUARANTEE CONTRACT BALANCE BELOW             
         MVC   TCSUBPNH,GCWRKBAL   ZERO, EQUATE IT WITH SUB TO P&H              
         XC    GCWRKBAL,GCWRKBAL                                                
         OI    TCINPUT,TCINPNH     ELSE, SUBJECT TO P&H EQUALS                  
         J     XIT                 GUARANTEE CONTRACT YEAR BALANCE              
*                                                                               
**********************************************************************          
*                                                                               
GCPNH10  TM    TCINPUT,TCINPNH     IF THIS IS CREDIT GRT PAYMENT                
         JO    GCPNH40             AND SUBJECT TO P&H WAS ENTERED               
*                                  SUBJECT TO P&H CANNOT KNOCK                  
*                                  GUARANTEE CONTREACT YEAR BALANCE             
*                                  OVER LIMIT                                   
*                                                                               
         TM    TCINPUT,TCINPAY     IF SUBJECT TO P&H WAS NOT ENTERED            
         JZ    XIT                 AND PAYMENT AMOUNT WAS ENTERED               
         CLC   TCPAY,GCLIM         PAYMENT AMOUNT > GCON LIMIT?                 
         JH    PNHERR                                                           
         MVC   TCSUBPNH,TCPAY                                                   
         L     RE,TCPAY                                                         
         A     RE,GCWRKBAL         IF PAYMENT AMOUNT DOES NOT PUSH              
         C     RE,GCLIM            GUARANTEE CONTRACT BALANCE ABOVE             
         JNH   GCPNHX              LIMIT, EQUATE IT WITH SUB TO P&H             
         L     RE,GCWRKBAL                                                      
         S     RE,TCPAY                                                         
         ST    RE,TCSUBPNH         ELSE, SUBJECT TO P&H EQUALS                  
         MVC   GCWRKBAL,GCLIM      DIFFERENCE BETWEEN CONTRACT YEAR'S           
         OI    TCINPUT,TCINPNH     LIMIT AND BALANCE                            
         J     XIT                                                              
*                                                                               
**********************************************************************          
*                                                                               
GCPNH20  TM    TCINPUT,TCINPNH     IF P&H WAS ENTERED                           
         JZ    XIT                                                              
         CLI   TGUSEQU,UPNH        AND THIS IS NON-CREDIT PNH PAYMENT           
         JNE   XIT                                                              
         TM    PAYSTAT1,CREDIT                                                  
         JO    GCPNH40                                                          
GCPNH30  L     RE,GCWRKBAL         SUBJECT TO P&H CANNOT KNOCK                  
         S     RE,TCSUBPNH         GUARANTEE CONTRACT YEAR BALANCE              
         JM    FLDINV              BELOW ZERO                                   
         J     GCPNHX                                                           
*                                                                               
GCPNH40  L     RE,GCWRKBAL         IF THIS IS CREDIT PNH PAYMENT                
         A     RE,TCSUBPNH         SUBJECT TO P&H CANNOT KNOCK                  
         C     RE,GCLIM            GUARANTEE CONTREACT YEAR BALANCE             
         JH    FLDINV              OVER LIMIT                                   
GCPNHX   ST    RE,GCWRKBAL                                                      
         J     XIT                                                              
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* CHECK CAST FOR GUARANTEE CONTRACTS                                            
***********************************************************************         
GCNTCHK  NTR1  BASE=*,LABEL=*                                                   
         CLI   TGUSEQU,UGRT        GRT PAYMENT?                                 
         JE    *+12                                                             
         CLI   TGUSEQU,UPNH        PNH PAYMENT?                                 
         JNE   XIT                                                              
*                                                                               
         MVC   AIO,AIO2                                                         
         XC    TGSSN,TGSSN                                                      
         XC    GUARCONT,GUARCONT                                                
*                                                                               
         LA    R3,KEY              READ ALL CAST FOR COMMERCIAL                 
         USING TLCAD,R3                                                         
         XC    TLCAKEY,TLCAKEY                                                  
         MVI   TLCACD,TLCACDQ                                                   
         MVC   TLCACOM,TGCOM       INTERNAL CMML NUMBER                         
         GOTO1 HIGH                                                             
         J     GCNT20                                                           
*                                                                               
GCNT10   GOTO1 SEQ                                                              
GCNT20   CLC   KEY(TLCASORT-TLCAKEY),KEYSAVE                                    
         JNE   GCNT60                                                           
*                                                                               
         OC    TGSSN,TGSSN         FIRST TIME THROUGH IT'S BLANK                
         JNZ   *+10                                                             
         MVC   TGSSN,TLCASSN       SET FIRST CAST MEMBER ON CMML                
*                                                                               
         CLC   TGSSN,TLCASSN                                                    
         JE    *+8                                                              
         OI    LCLSTAT8,MORE1SSN                                                
*                                                                               
         GOTO1 GETREC                                                           
*                                                                               
         L     R4,AIO                                                           
         USING TACAD,R4                                                         
         MVI   ELCODE,TACAELQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   GCNT10                                                           
         CLC   TACAUN,=C'SAG'                                                   
         JE    GCNT30                                                           
         CLC   TACAUN,=C'AFT'                                                   
         JNE   GCNT10                                                           
*                                                                               
GCNT30   TM    TLCASRT,TLCASRGQ    ON A GUARANTEE?                              
         JZ    *+12                                                             
         OI    LCLSTAT8,NOGCCAST                                                
         J     GCNT10                                                           
*                                                                               
         OI    LCLSTAT9,CASTGRT    CAST IS ON A GUARANTEE                       
*                                                                               
         MVC   PARAS(L'TLCAKEY),KEY SAVE CAST KEY                               
*                                                                               
         LA    R3,KEY              READ GUARANTEE RECORD                        
         USING TLGUD,R3                                                         
         XC    TLGUKEY,TLGUKEY                                                  
         MVI   TLGUCD,TLGUCDQ                                                   
         MVC   TLGUSSN,PARAS+18    TLCASSN                                      
         MVC   TLGUGUA,TACAGUA     GUARANTEE CODE                               
         XC    TLGUGUA,=X'FFFFFFFF'                                             
         GOTO1 HIGH                                                             
         CLC   KEY(L'TLGUKEY),KEYSAVE                                           
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         GOTO1 GETREC                                                           
*                                                                               
         L     R4,AIO              GET/SET GUARANTEE CONTRACT CODE              
         USING TAGUD,R4                                                         
         MVI   ELCODE,TAGUELQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   GCNT50                                                           
*                                                                               
         OC    TAGUGCNT,TAGUGCNT   CONTRACT CODE?                               
         JNZ   *+12                                                             
         OI    LCLSTAT8,NOGCCAST                                                
         J     GCNT40                                                           
*                                                                               
         OC    GUARCONT,GUARCONT   FIRST TIME THROUGH IT'S BLANK                
         JNZ   *+14                                                             
         MVC   GUARCONT,TAGUGCNT   SET GUARANTEE CONTRACT CODE                  
         J     GCNT50                                                           
*                                                                               
GCNT40   CLC   GUARCONT,TAGUGCNT   IF NOT THE SAME, THEN ERROR                  
         JNE   GRTERR3             CAN'T HAVE MISMATCHED GRT CONTRACTS          
*                                                                               
GCNT50   XC    KEY,KEY             RESTORE CAST READ SEQUENCE                   
         MVC   KEY(L'TLCAKEY),PARAS                                             
         GOTO1 HIGH                                                             
         J     GCNT10                                                           
*                                                                               
GCNT60   OC    GUARCONT,GUARCONT   ANY GUARANTEE CONTRACTS IN PAYMENT?          
         JZ    GCNTCHKX                                                         
         TM    LCLSTAT8,MORE1SSN   MORE THAN ONE PERFORMER FOR CMML             
         JO    GRTERR1                                                          
         TM    LCLSTAT8,NOGCCAST   GRT DOES NOT HAVE GCON                       
         JO    GRTERR2                                                          
*                                                                               
GCNTCHKX MVC   AIO,AIO1                                                         
         J     XIT                                                              
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*******************************************************************             
*              ROUTINE GENERATES CYCLE START DATE WHEN NECESSARY                
*******************************************************************             
*                                  R2=A(CYCLE DATES FIELD HEADER)               
GENCYC   NTR1  BASE=*,LABEL=*                                                   
         MVC   WORK(3),FSTFXCYC    USE FIRST FIXED CYCLE                        
*                                                                               
         OC    WORK(3),WORK        IF DON'T HAVE IT                             
         BNZ   GCYC2                                                            
         MVC   WORK(3),FLMDATE     TAKE FILM DATE                               
*                                                                               
         OC    RECDATE,RECDATE     IF RECORD DATE EXISTS                        
         BZ    GCYC2                                                            
         OC    WORK(3),WORK        AND NO FILM DATE                             
         BZ    *+14                                                             
         CLC   FLMDATE,RECDATE     OR RECORD DATE EARLIER THAN FILM             
         BNH   *+10                                                             
         MVC   WORK(3),RECDATE     USE RECORD DATE                              
*                                                                               
GCYC2    CLI   TGUSEQU,UBSM        IF MUSIC SESSION                             
         BE    *+12                                                             
         CLI   TGUSEQU,UIMS                                                     
         BNE   *+10                                                             
         MVC   WORK(3),MUSDATE     USE MUSIC DATE                               
*                                                                               
         OC    WORK(3),WORK        GET OUT IF WE DON'T HAVE A DATE              
         BZ    GCYCX                                                            
         LA    R3,1                SET DATE IN WORK IS DATCON FORMAT 1          
         TM    TGUSSTAT,SESSION                                                 
         BO    GCYC10              DONE IF THIS IS A SESSION                    
*                                                                               
         TM    TGUSSTA2,HLDTYPE    FOR HOLDING FEE TYPES                        
         BZ    GCYCX                                                            
         TM    LCLSTAT,FIRSTHLD    IF THIS IS FIRST HLD FOR COMMERCIAL          
         BZ    GCYC8                                                            
         GOTO1 PVAL,DMCB,((R3),WORK),(C'N',WORK)  GET NEXT START BASED          
         LA    R3,BLOCK                           ON FIRST FIXED CYCLE          
         USING PERVALD,R3                                                       
         MVC   8(8,R2),PVALCPER+9  IT'S END DATE RETURNED BY PERVAL             
         B     GCYC12                                                           
*                                                                               
GCYC8    LA    R4,TCTAUHEL         USE PREV. CYCLE TO GET NEXT START            
         USING TAUHD,R4                                                         
         GOTO1 DATCON,DMCB,(1,TAUHEND),(0,DUB)  TAKE PREVIOUS END DATE          
         GOTO1 ADDAY,DMCB,DUB,WORK,1            ADD ONE DAY                     
         XR    R3,R3                            SET DATCON I/P FORMAT 0         
*                                                                               
GCYC10   GOTO1 DATCON,DMCB,((R3),WORK),(8,8(R2)) DISPLAY IN FIELD               
*                                                                               
GCYC12   MVI   5(R2),8                           SIMULATE L'INPUT               
         OI    6(R2),X'80'                       AND TRANSMIT                   
*                                                                               
         OI    CYCSTAT,CYSTGENC    SET CYCLE GENERATED BY PAY                   
*                                                                               
GCYCX    J     XIT                                                              
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*----------------------------------------------------------------------         
*              ROUTINE LOADS A SCREEN AT TAG FIELD                              
*----------------------------------------------------------------------         
LOADSCRN NTR1  BASE=*,LABEL=*                                                   
         CLC   TWASCR,OVERLAY      IS SCREEN ALREADY LOADED                     
         JE    XIT                                                              
         L     R3,EFHTAG           NO, LOAD IT NOW                              
         GOTO1 LOADSOPH,DMCB,1                                                  
         MVC   TWASCR,OVERLAY                                                   
         BRAS  RE,FILLSCRN         FILL IN SOME SCREEN VALUES                   
         J     XIT                                                              
         EJECT                                                                  
*              ROUTINE FILLS PREVIOUSLY SET SCREEN VALUES                       
         SPACE 1                                                                
FILLSCRN NTR1  BASE=*,LABEL=*                                                   
         TM    LCLSTAT,TOPOK       DON'T BOTHER IF NOT AROUND                   
         JZ    XIT                                                              
         MVC   PAYAGY,TGAGY        AGENCY                                       
         MVI   PAYAGYH+5,L'PAYAGY                                               
         OI    PAYAGYH+4,X'20'                                                  
         MVC   PAYINV,DSPLYINV     INVOICE NUMBER                               
         MVI   PAYINVH+5,L'PAYINV                                               
         OC    DSPLYINV,DSPLYINV   IF NO INVOICE                                
         BNZ   *+8                                                              
         MVI   PAYINVH+5,0         SET LENGTH TO 0                              
         OI    PAYINVH+4,X'20'                                                  
         MVC   PAYCID,TGCID        COMML ID                                     
         MVI   PAYCIDH+5,L'PAYCID                                               
         OI    PAYCIDH+4,X'20'                                                  
         MVC   PAYLFT(L'LIFT),LIFT LIFT                                         
***      OI    PAYLFTH+5,L'LIFT                                                 
         MVI   PAYLFTH+5,L'LIFT                                                 
         CLI   VERSION,0                                                        
         BE    FSCRN10                                                          
         EDIT  VERSION,PAYLFT,ALIGN=LEFT                                        
         STC   R0,PAYLFTH+5                                                     
FSCRN10  MVC   PAYLID,LIFTID                                                    
         OI    PAYLFTH+4,X'20'                                                  
         MVC   PAYAGYN,AGYNAME     AGENCY NAME                                  
         MVC   PAYCLIN,CLINAME     CLIENT NAME                                  
         MVC   PAYCOMN,COMNAME     COMMERCIAL NAME                              
         MVC   PAYSEC,COMLEN       COMMERCIAL LENGTH                            
         MVC   PAYMEDN,TGMENAME    MEDIA NAME                                   
         BAS   RE,DISPCLP2         CLIENT/PRODUCT CODE                          
         J     XIT                                                              
*              ROUTINE FORMATS CLIENT AND PRODUCT CODES TO PAYCLPR              
         SPACE                                                                  
DISPCLP2 DS    0H                                                               
         MVC   PAYCLPR(L'TGCLI),TGCLI  FIRST MOVE CLIENT                        
         OC    TGPRD,TGPRD             IF THERE'S A PRODUCT                     
         BZ    DISCP2X                                                          
         LA    R1,PAYCLPR+L'TGCLI-1    FIND END OF CLIENT                       
         SPACE                                                                  
DISCP25  CLI   0(R1),X'40'                                                      
         BH    DISCP210                                                         
         BCT   R1,DISCP25           KEEP BACKING UP TILL FIND NON-SPACE         
         SPACE                                                                  
DISCP210 MVI   1(R1),C'/'           MOVE A '/' IN BETWEEN CLIENT                
         MVC   2(L'TGPRD,R1),TGPRD  AND PRODUCT                                 
         SPACE                                                                  
DISCP2X  BR    RE                                                               
                                                                                
         LTORG                                                                  
         EJECT                                                                  
*----------------------------------------------------------------------         
*              ROUTINE SETS DUE DATE FOR INVOICE                                
*                                                                               
*          *** WARNING - THIS IS DONE AT INVOICE LEVEL ***                      
*          *** DON'T USE ANYTHING PERTAINING TO CAST   ***                      
*----------------------------------------------------------------------         
GTDUE    NTR1  BASE=*,LABEL=*                                                   
*                                  R0=N'BUSINESS DAYS UNTIL DUE                 
         CLI   TGUSEQU,UPRR        IF PROMO USE                                 
         BE    GDUE1AA                                                          
         CLI   TGUSEQU,UPRM        OR PROMO SESSION                             
         BE    GDUE1AA                                                          
         CLI   TGUSEQU,UFGR        OR IF FOREIGN USE                            
         BNE   GDUE1A                                                           
         CLI   TGUSTYP,UFGREXT     AND EXTENSION TYPE                           
         BNE   GDUE1A                                                           
GDUE1AA  MVC   DUB(3),TGTODAY1     USE PAYMENT DATE (TODAY)                     
         LA    R0,1                + 1 DAY                                      
         B     GDUE8                                                            
*                                                                               
GDUE1A   CLI   TGUSMEDS,PRINT      IF PRINT PAYMENT                             
         BNE   GDUE1B                                                           
         MVC   DUB(3),TGTODAY1     USE PAYMENT DATE (TODAY)                     
         LA    R0,7                + 7 DAYS                                     
         B     GDUE8                                                            
*                                                                               
GDUE1B   CLI   TGUSEQU,UEDS                                                     
         BNE   GDUE1BB                                                          
         MVC   DUB(3),TGTODAY1                                                  
         LA    R0,15                                                            
         TM    TGUSSTA4,DUE15DAY                                                
         BO    GDUE8                                                            
         LA    R0,12                                                            
         B     GDUE8                                                            
*                                                                               
GDUE1BB  MVC   DUB(3),TCPCYCS      ELSE USE CYCLE START IF ANY                  
         OC    DUB(3),DUB                                                       
         BNZ   GDUE1D                                                           
         TM    TGUSSTAT,SESSION    ELSE IF SESSION                              
         BZ    GDUE1C                                                           
*                                                                               
         MVC   DUB(3),FLMDATE      USE FILM DATE IF ANY                         
         OC    DUB(3),DUB                                                       
         BNZ   GDUE1D                                                           
*                                                                               
         MVC   DUB(3),RECDATE      ELSE USE RECORD DATE IF ANY                  
         OC    DUB(3),DUB                                                       
         BNZ   GDUE1D                                                           
GDUE1C   MVC   DUB(3),TGTODAY1     ELSE USE PAYMENT DATE (TODAY'S DATE)         
*                                                                               
GDUE1D   CLI   TGUSEQU,UITN        IF USE IS ITN OR                             
         BE    GDUE1E                                                           
         CLI   TGUSEQU,USWU        OR SWU                                       
         BE    GDUE1E                                                           
         CLI   TGUSEQU,UMBO        OR MBO                                       
         BE    GDUE1F                                                           
         CLI   TGUSEQU,UEQY        OR EQY IS 15 DAYS FROM START                 
         BE    GDUE1F                                                           
         TM    TGUSTYST,UPGRADE    OR IF THIS IS AN UPGRADE                     
         BZ    GDUE2                                                            
GDUE1E   MVC   DUB(3),TCPCYCE      USE CYCLE END                                
*                                                                               
GDUE1F   LA    R0,15               + 15 DAYS                                    
*                                                                               
         CLI   TGUSEQU,UEQY        EQUITY                                       
         BE    GDUE8                                                            
         CLI   TGUSEQU,UMBO        EQUITY                                       
         BE    GDUE8                                                            
         CLI   TGUSEQU,UITN        OR ITN                                       
         BE    GDUE8                                                            
         CLI   TGUSEQU,UWSP        OR WILDSPOT UPGRADE                          
         BE    GDUE8                                                            
         CLI   TGUSEQU,USWU        OR SPANISH WILDSPOT UPGRADE                  
         BE    GDUE8                                                            
         CLI   TGUSEQU,USWS        USE CYCLE END + 15 DAYS                      
         BE    GDUE8                                                            
*                                                                               
         CLC   TGTODAY1,DUB        ELSE, IF PAYMENT DATE BEFORE                 
         BNL   *+10                CYCLE END                                    
         MVC   DUB(3),TGTODAY1     USE PAYMENT DATE + 15 DAYS                   
         B     GDUE8                                                            
*                                                                               
GDUE2    CLI   TGUSEQU,UVNR        IF PAYING VNR                                
         BNE   GDUE3                                                            
         LHI   R0,15                                                            
         B     GDUE8                                                            
                                                                                
GDUE3    TM    TGUSSTAT,CANUSE     IF CANADIAN USE                              
         BZ    GDUE4                                                            
         LA    R0,15                                                            
         TM    TGUSSTA4,DUE15DAY   THEN 15                                      
         BO    GDUE3A                                                           
         LA    R0,12               OR 12 DAYS FOR SESSION                       
GDUE3A   TM    TGUSSTAT,SESSION                                                 
         BO    GDUE8                                                            
         LA    R0,5                5 DAYS FOR ALL OTHER USES                    
         B     GDUE8                                                            
*                                                                               
GDUE4    LA    R0,1                1 DAY BEFORE CYCLE START                     
         TM    TGUSSTA2,HLDTYPE    FOR HOLDING FEE TYPE - SET BIT LATER         
         BZ    GDUE6                                                            
         B     GDUE8                                                            
*                                                                               
*&&DO                                                                           
         USING TACOD,RE                                                         
         L     RE,TCATACO          IF MAKING HOLDING FEE PAYMENT                
         CLI   TACOTYPE,CTYSEAS2   TO A SEASONAL COMMERCIAL                     
         BNE   GDUE8                                                            
         LA    RF,TACOAIR          DUE DATE IS 13W/3M FROM FIRST AIR            
         MVI   TGBYTE,1            DATE                                         
         OC    TACOSAIR,TACOSAIR                                                
         BZ    GDUE5                                                            
         CLC   TACOSAIR,TCPCYCS    UNLESS SECOND AIR DATE IS LESS THAN          
         BNL   GDUE5               PAYMENT CYCLE START, THEN DUE DATE           
         LA    RF,TACOSAIR         IS 13WK/3M FROM SECOND AIR DATE              
         MVI   TGBYTE,2                                                         
GDUE5    XC    WORK,WORK                                                        
         GOTO1 DATCON,DMCB,(1,0(RF)),(8,WORK)                                   
         MVC   WORK+8(5),=C'-(3M)'                                              
         TM    AGYSTAT,TAAYS13W                                                 
         BZ    *+10                                                             
         MVC   WORK+8(6),=C'-(13W)'                                             
         GOTO1 PERVAL,DMCB,(14,WORK),('PVINSGLS+PVIN1DYL',BLOCK)                
         CLI   4(R1),PVRCOK                                                     
         BE    *+6                                                              
         DC    H'00'                                                            
         MVC   DUEDATE,BLOCK+PVALPEND-PERVALD                                   
         CLI   TGBYTE,2                                                         
         BE    GDUE15                                                           
         MVC   DUB(3),BLOCK+PVALPEND-PERVALD                                    
         LA    R0,12                                                            
         B     GDUE8                                                            
         DROP  RE                                                               
*&&                                                                             
*                                                                               
GDUE6    CLI   TGUSEQU,ULFT        OR LFT                                       
         BE    GDUE8                                                            
         CLI   TGUSEQU,UALF        OR ALF                                       
         BE    GDUE8                                                            
         CLI   TGUSEQU,UREN        OR REN                                       
         BE    GDUE8                                                            
         CLI   TGUSEQU,UARN        OR ARN                                       
         BE    GDUE8                                                            
         CLI   TGUSEQU,USRE        OR SRE                                       
         BE    GDUE8                                                            
*                                                                               
*        CLI   TGUSEQU,UPRR        1 DAY FOR PRR                                
*        BE    GDUE8                                                            
*        CLI   TGUSEQU,UPRM        OR PRM                                       
*        BE    GDUE8                                                            
*                                                                               
         XR    R0,R0               ELSE 0 DAYS                                  
         TM    TGUSSTA2,ZERODUE    IF SPECIFIED                                 
         BO    GDUE8                                                            
         LA    R0,15               15 OR                                        
         TM    TGUSSTA4,DUE15DAY                                                
         BO    GDUE8                                                            
         LA    R0,12               12 FOR EVERYTHING ELSE                       
*                                                                               
         USING IDBLOCKD,R2                                                      
         CLI   TGUSEQU,UINS        30 DAYS FOR INS                              
         BE    *+8                                                              
         CLI   TGUSEQU,UIDS        OR IDS                                       
         BE    *+8                                                              
         CLI   TGUSEQU,USTR        OR STR                                       
         BE    *+8                                                              
         CLI   TGUSEQU,URTK        OR RTK                                       
         BE    *+8                                                              
         CLI   TGUSEQU,UDIO        OR DIO                                       
         BE    *+8                                                              
         CLI   TGUSEQU,UIVR        OR IVR                                       
         BE    *+8                                                              
         CLI   TGUSEQU,UISU        OR ISU                                       
         BNE   GDUE7                                                            
         LA    R2,BLOCK                                                         
         GOTO1 DATCON,DMCB,(1,DUB),(0,IDBBASE0)                                 
         GOTO1 ADDAY,DMCB,IDBBASE0,IDB30DY0,30                                  
GDUE6A   GOTO1 DATCON,DMCB,IDB30DY0,(1,DUEDATE)                                 
                                                                                
         GOTO1 ADDAY,DMCB,IDB30DY0,IDBMIN10,-1                                  
                                                                                
         USING GETRETD,R3                                                       
         LA    R3,WORK                                                          
         XC    WORK,WORK                                                        
         MVI   GRDITH,0                                                         
         MVI   GRDITM,1                                                         
         MVC   GRDHRS,=H'24'                                                    
***      OI    GRDFLAG,GRDFTAL+GRDFHLOK                                         
         OI    GRDFLAG,X'01'+GRDFHLOK                                           
         GOTO1 DATCON,DMCB,IDBMIN10,(3,GRDIDY)                                  
         GOTO1 GETRET,(R3)                                                      
         BNE   GDUE15                                                           
         GOTOR UNIOND,DMCB,GETRET,(R3),WORK2                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         GOTO1 DATCON,DMCB,(3,GRDODY),(1,IDBPLU11)                              
         DROP  R3                                                               
                                                                                
         CLC   IDBPLU11,DUEDATE                                                 
         BNH   GDUE15                                                           
         MVC   IDB30DY0,IDBMIN10                                                
         B     GDUE6A                                                           
*                                                                               
GDUE7    BRAS  RE,EVEDUE                                                        
         BE    GDUE15                                                           
*                                                                               
GDUE7Z   TM    TGUSSTA3,NWKUSE     FOR NWK USE                                  
         BZ    GDUE8                                                            
         MVC   DUB(3),FRSTUSE      USE FIRST USE DATE                           
         GOTO1 DATCON,DMCB,(1,DUB),(0,WORK)  DUE DATE IS FROM                   
         GOTO1 GETDAY,DMCB,WORK,WORK+6  END-OF-WEEK BASED ON USE DATE           
         ZIC   RF,0(R1)            RF=RELATIVE DAY NUMBER OF USE DATE           
         LA    R3,5                FRIDAY(5) IS END-OF-WEEK                     
         SR    R3,RF                                                            
         BNP   GDUE8               SKIP IF USE DATE ON WEEKEND                  
*                                                                               
         GOTO1 ADDAY,DMCB,WORK,WORK+6,(R3)   ELSE ADD IN ADDITNL N'DAYS         
         GOTO1 DATCON,DMCB,(0,WORK+6),(1,DUB)                                   
*                                                                               
GDUE8    MH    R0,=H'24'           MULTIPLY BY 24 TO GET TOTAL N'HOURS          
*                                                                               
         XC    WORK,WORK           INITIALIZE GETRET BLOCK                      
         LA    R3,WORK                                                          
         USING GETRETD,R3                                                       
         STCM  R0,3,GRDHRS                    SET N'HOURS                       
***      OI    GRDFLAG,GRDFTAL                                                  
         OI    GRDFLAG,X'01'                                                    
GDUE8A   GOTO1 DATCON,DMCB,(1,DUB),(3,GRDIDY) AND START DATE                    
         MVC   DUEDATE,DUB         INIT DUEDATE                                 
*                                                                               
         USING TACOD,RE                                                         
         TM    TGUSSTA2,HLDTYPE    FOR HOLDING FEE TYPES                        
         BZ    GDUE9                                                            
         B     GDUE10                                                           
*&&DO                                                                           
         L     RE,TCATACO                                                       
         CLI   TACOTYPE,CTYSEAS2                                                
         BNE   GDUE10                                                           
         B     GDUE10A                                                          
*&&                                                                             
         DROP  RE                                                               
*                                                                               
GDUE9    CLI   TGUSEQU,ULFT        OR LFT                                       
         BE    GDUE10                                                           
         CLI   TGUSEQU,UALF        OR ALF                                       
         BE    GDUE10                                                           
         CLI   TGUSEQU,UREN        OR REN                                       
         BE    GDUE10                                                           
         CLI   TGUSEQU,UARN        OR ARN                                       
         BE    GDUE10                                                           
         CLI   TGUSEQU,USRE        OR SRE                                       
         BNE   *+8                                                              
GDUE10   OI    GRDFLAG,GRDFBACK    SET TO GO BACKWARDS                          
GDUE10A  OI    GRDFLAG,GRDFHLOK    SET START ON WEEKEND/HOLIDAY OK              
*                                                                               
         MVI   GRDITH,0            00:01                                        
         MVI   GRDITM,1                                                         
         GOTO1 GETRET,(R3)         DETERMINE DUE DATE                           
         BNE   GDUE15              SKIP IF NONE FOUND (NO CALENDAR YET)         
         GOTOR UNIOND,DMCB,GETRET,(R3),WORK2                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         GOTO1 DATCON,DMCB,(3,GRDODY),(1,DUEDATE)  CONVERT TO PWOS              
*                                                                               
         CLI   TGUSEQU,UDLR        IF DLR PAYMENT                               
         BNE   GDUE15                                                           
         CLI   TGUSWKS,8           NON-8 WEEKS                                  
         JE    GDUE15                                                           
         TM    TGMEEQU,LIKETV      FOR TV, INTERNET, OR NEW MEDIA               
         BZ    GDUE15                                                           
         OC    FSTFXCYC,FSTFXCYC   AND FIRST FIXED CYCLE IS ON COMM'L           
         BZ    GDUE15                                                           
         XC    TGFULL,TGFULL                                                    
         MVC   TGFULL(L'FSTFXCYC),FSTFXCYC                                      
*                                                                               
         XC    WORK,WORK           SET TO CALCULATE HOLDING FEE CYCLES          
         MVI   TGBYTE,13           FOR THE COMMERCIAL BASED ON 3 MONTH          
         MVC   WORK+8(5),=C'-(3M)' OR 13 WEEKS                                  
         TM    AGYSTAT,TAAYS13W                                                 
         BZ    GDUE11                                                           
         MVI   TGBYTE,14                                                        
         MVC   WORK+8(6),=C'-(13W)'                                             
*                                                                               
GDUE11   GOTO1 DATCON,DMCB,(1,TGFULL),(8,WORK)                                  
         GOTO1 PERVAL,DMCB,(TGBYTE,WORK),('PVINSGLS+PVIN1DYL',BLOCK)            
         CLI   4(R1),PVRCOK                                                     
         BE    *+6                                                              
         DC    H'00'                                                            
*                                                                               
         CLC   BLOCK+PVALPSTA-PERVALD(L'PVALPEND),TCPCYCS                       
         BH    GDUE12                                                           
         GOTO1 ADDAY,DMCB,BLOCK+PVALEEND-PERVALD,TGDUB,1                        
         GOTO1 DATCON,DMCB,(0,TGDUB),(1,TGFULL)                                 
         B     GDUE11                                                           
*                                                                               
GDUE12   XC    WORK,WORK           INITIALIZE GETRET BLOCK                      
         LA    R3,WORK                                                          
         USING GETRETD,R3                                                       
         MVC   GRDHRS,=H'24'                  SET N'HOURS                       
         OI    GRDFLAG,X'01'                  AND START DATE                    
         GOTO1 DATCON,DMCB,(1,BLOCK+PVALPSTA-PERVALD),(3,GRDIDY)                
         OI    GRDFLAG,GRDFBACK    SET TO GO BACKWARDS                          
         OI    GRDFLAG,GRDFHLOK    SET START ON WEEKEND/HOLIDAY OK              
*                                                                               
         MVI   GRDITH,0            00:01                                        
         MVI   GRDITM,1                                                         
         GOTO1 GETRET,(R3)         DETERMINE DUE DATE                           
         BNE   GDUE15              SKIP IF NONE FOUND (NO CALENDAR YET)         
         GOTOR UNIOND,DMCB,GETRET,(R3),WORK2                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         GOTO1 DATCON,DMCB,(3,GRDODY),(1,TGFULL)  CONVERT TO PWOS               
         CLC   DUEDATE,TGFULL                                                   
         BNH   GDUE15                                                           
         MVC   DUEDATE,TGFULL                                                   
*                                                                               
GDUE15   TM    PAYOPTS2,OPURGENT   IF URGENT OPTION REQUESTED                   
         BO    GDUE20                                                           
         TM    CLTSTAT,TACISCOD    OR THIS IS A COD CLIENT                      
         BO    GDUE20                                                           
         TM    AGYSTAT,TAAYSCOD    OR THIS IS A COD AGENCY                      
         BO    GDUE20                                                           
         TM    PAYOPTS3,OCOD       OR IF COD OPTION USED                        
         BO    GDUE20                                                           
         TM    PAYSTAT1,CREDIT     OR THIS IS A CREDIT PAYMENT                  
         BO    GDUE20                                                           
         CLI   TGUSEQU,USOP        OR THIS IS SOP USE                           
         BE    GDUE20                                                           
         TM    AGYSTAT7,TAAYSCDT   OR ALL CHECKS DUE TODAY                      
         BO    GDUE20                                                           
         CLC   DUEDATE,TGTODAY1    OR IF DUE DATE IS EARLIER THAN               
         BNL   GDUEX               TODAY                                        
GDUE20   MVC   DUEDATE2,DUEDATE    SAVE CALCULATED DUE DATE                     
         MVC   DUEDATE,TGTODAY1    AND SET INV DUE DATE AS TODAY                
GDUEX    MVC   TGPDUEDT,DUEDATE                                                 
         J     XIT                                                              
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*&&DO                                                                           
*---------------------------------------------------------------------          
*              ROUTINE TO VALIDATE CSF OPTION FOR US$ INVOICES                  
*---------------------------------------------------------------------          
VALCSFUS NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LA    R4,ELTACO                                                        
         USING TACOD,R4                                                         
         TM    PAYSTAT1,CREDIT     IF CREDIT PAYMENT,                           
         BZ    VCSF10                                                           
         TM    TACOSTA2,TACOSJPC   CSF FEE MUST BE PAID ALREADY                 
         JZ    NO                                                               
         TM    LCLSTAT7,CRINVCSF   CREDIT INVOICE HAS NO CSF                    
         JNZ   NO                                                               
         B     VCSF15                                                           
*                                                                               
VCSF10   TM    TACOSTA2,TACOSJPC   WAS CSF FEE ALREADY PAID?                    
         JNZ   NO                                                               
VCSF15   TM    TACOSTAT,TACOSCAN   US DOLLAR PAYMENTS ONLY                      
         JNZ   NO                                                               
         CLI   TACOMED,TACOMEDT    MEDIA MUST BE TV                             
         BE    VCSF20                                                           
         CLI   TACOMED,TACOMEDC    OR CABLE                                     
         JNE   NO                                                               
*                                                                               
VCSF20   TM    TGUSSTAT,SESSION+CANUSE  IF THIS IS RE-USE PAYMENT               
         JNZ   NO                       AND NOT CANADIAN                        
         TM    TGUSSTA2,HLDTYPE    BUT NOT A HOLDING FEE TYPE                   
         JO    NO                                                               
*                                                                               
         CLI   TACOTYPE,0          COMMERCIAL TYPE CAN BE BLANK                 
         BE    VCSF30                                                           
         CLI   TACOTYPE,CTYASIAN   ASIAN                                        
         BE    VCSF30                                                           
         CLI   TACOTYPE,CTYADD     ADDENDUM                                     
         BE    VCSF30                                                           
         CLI   TACOTYPE,CTYANIM    ANIMATICS                                    
         BE    VCSF30                                                           
         CLI   TACOTYPE,CTYPUB     PUBLIC SERVICE                               
         BE    VCSF30                                                           
         CLI   TACOTYPE,CTYSEAS2   SEASONAL                                     
         BE    VCSF30                                                           
         CLI   TACOTYPE,CTYSTRM    SHORT TERM                                   
         BE    VCSF30                                                           
         CLI   TACOTYPE,CTYSPAN    OR SPANISH                                   
         JNE   NO                                                               
         DROP  R4                                                               
*                                                                               
VCSF30   LA    R1,NOCSFTAB         AND NOT IN EXCLUDED USE TABLE                
VCSF40   CLI   0(R1),X'FF'              TEST END OF TABLE                       
         JE    YES                                                              
         CLC   TGUSEQU,0(R1)            TEST FOR MATCH                          
         JE    NO                                                               
         LA    R1,1(R1)                 BUMP TO NEXT ENTRY                      
         B     VCSF40                                                           
*                                                                               
         SPACE 2                                                                
*              TABLE OF USES TO EXCLUDE WHEN ADDING CSF FEE                     
*                                                                               
NOCSFTAB DC    AL1(UDWN,UPPF,UPRR,UPNH,UOTH,USOT,USRE,USPN,USLF,UALF)           
         DC    AL1(UARN,UGRT,ULFT,UPEN,UREN,UGRR,UPRT,USCS,USFS)                
         DC    X'FF'                                                            
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*&&                                                                             
*---------------------------------------------------------------------          
*              ROUTINE TO VALIDATE CREDIT OPTION                                
*---------------------------------------------------------------------          
VALCR    NTR1  BASE=*,LABEL=*                                                   
         LH    R2,DSPEINV          R2=DISP. TO FIELD                            
         LTR   R2,R2                                                            
         JZ    XIT                                                              
         AR    R2,RA                                                            
         TM    4(R2),X'20'         TEST CREDIT OPTION FLD PREV VALID            
         JO    XIT                                                              
         NI    PAYSTAT1,ALL-CREDIT                                              
         XC    EINVNO,EINVNO                                                    
         XC    TCTXUSCR,TCTXUSCR                                                
         XC    TCTXULCR,TCTXULCR                                                
         OI    MFLDCHA,MCR         SET CREDIT OPTION CHANGED                    
         NI    LCLSTAT7,X'FF'-CRINVCSF                                          
*                                                                               
         CLI   5(R2),0             TEST FOR INPUT                               
         BE    VCRX                                                             
*                                                                               
         TM    TGCTSTST,TGCTSCLI   IF CONNECT STAFF TYPE IS CLIENT              
         JO    NOINPUT             INPUT NOT ALLOWED                            
*                                                                               
         CLI   5(R2),1             IF INPUT LENGTH IS 1                         
         BH    *+12                                                             
         CLI   8(R2),C'Y'          ALLOW ONLY 'Y'ES                             
         BE    VCR8                                                             
*                                                                               
         GOTO1 TINVCON,DMCB,8(R2),EINVNO,DATCON  CVT TO INTERNAL FORMAT         
         CLI   0(R1),X'FF'                                                      
         JE    FLDINV                                                           
         TM    EINVNO+5,X'80'      CANCELLED INVOICE NUMBER NOT ALLOWED         
         JO    FLDINV                                                           
         MVC   WORK(6),EINVNO      COMPLEMENT IT                                
         XC    WORK(6),=X'FFFFFFFFFFFF'                                         
         MVC   WORK2(L'TGINV),TGINV  SAVE ACTUAL INVOICE NUMBER                 
*                                                                               
         GOTO1 RECVAL,DMCB,TLINCDQ,(X'A0',WORK)  RECORD SHOULD EXIST            
         MVC   TGINV,WORK2         (RESTORE ACTUAL INVOICE NUMBER)              
         JNE   RECNTFND                                                         
*                                                                               
         MVI   ELCODE,TAPDELQ      GET PAYMENT DETAILS EL.                      
         L     R4,AIO                                                           
         BRAS  RE,GETEL                                                         
         JNE   NOTPAID             MUST NOT HAVE BEEN PAID YET                  
         USING TAPDD,R4                                                         
         TM    TAPDPST1,TAPDPCRD   INSURE WASN'T A CREDIT INVOICE               
         JO    FLDINV                                                           
*                                                                               
         USING TABDD,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TABDELQ      GET BILLING DETAILS EL.                      
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                MUST BE THERE                                
         OC    TABDCSF,TABDCSF     ANY CSF?                                     
         BNZ   *+8                                                              
         OI    LCLSTAT7,CRINVCSF   CREDIT INVOICE HAS NO CSF                    
*                                                                               
         USING TAIND,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TAINELQ      GET INVOICE STATUS EL.                       
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                MUST BE THERE                                
         TM    TAINSTAT,TAINSAPR                                                
         JZ    NOTAPP              ERROR IF NOT APPROVED                        
                                                                                
         TM    LCLSTAT9,AGYBRATE+CLIBRATE                                       
         JZ    VCR1                IF AGY OR CLIENT HAS BRATE                   
         TM    TAINSTAT,TAINSBIL   INVOICE MUST BE BILLED                       
         JO    VCR1                                                             
         TM    TAINSTA2,TAINSHLP   OR PUR PRINTED                               
         JZ    FLDINV                                                           
         DROP  R4                                                               
                                                                                
VCR1     TM    TGSYSTAT,TASYSCRD   IF NEW CREDITING RULES ARE                   
         JZ    VCR2                ENABLED ...                                  
                                                                                
         USING TARAD,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TARAELQ      AND INVOICE HAS SAVED BILLING                
         BRAS  RE,GETEL            RATES                                        
         JNE   VCR2                                                             
         DROP  R4                                                               
                                                                                
         USING TAPDD,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TAPDELQ                                                   
         BRAS  RE,GETEL                                                         
         JE    *+6                                                              
         DC    H'00'                                                            
         CLC   TAPDUSE,TGUSCDE     ENSURE USE MATCHES                           
         JNE   FLDINV                                                           
         CLC   TAPDCOM,TGCOM       ENSURE COMMERCIAL MATCHES                    
         JNE   FLDINV                                                           
         DROP  R4                                                               
                                                                                
         OI    PAYSTAT2,TAPDPCIB   SET CRED INV HAS SAVED BILL RATES            
*                                                                               
VCR2     CLI   TGUSEQU,UCLA        IF USE IS CLASS A                            
         BNE   VCR7                                                             
         MVI   BYTE,0                                                           
         USING TAVRD,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TAVRELQ      AND VERSION ELEMENT ON                       
         BRAS  RE,GETEL            CREDITED INVOICE IS 10                       
         BNE   VCR3                OR 15 SECONDS SET BYTE                       
         CLI   TAVRSEC,15          TO C'Y'                                      
         BE    *+12                                                             
         CLI   TAVRSEC,10                                                       
         BNE   VCR4                                                             
         MVI   BYTE,C'Y'                                                        
         B     VCR4                                                             
*                                                                               
         USING TACOD,R4                                                         
VCR3     L     R4,AIO                                                           
         MVI   ELCODE,TACOELQ      OR IF PAYING MAIN COMM                       
         BRAS  RE,GETEL            AND LENGTH IS 15 OR LESS                     
         BNE   VCR4                SET BYTE TO C'Y'                             
         CLI   TACOLEN,15                                                       
         BH    VCR4                                                             
         MVI   BYTE,C'Y'                                                        
*                                                                               
         USING TANPD,R4                                                         
VCR4     L     R4,AIO                                                           
         MVI   ELCODE,TANPELQ      READ ALL PROGRAM ELEMENTS                    
         BRAS  RE,GETEL            FROM CREDITED INVOICE                        
         B     *+8                                                              
VCR5     BRAS  RE,NEXTEL                                                        
         BNE   VCR7                                                             
         CLI   TANPNWK,C'X'        IF PROGRAM IS PAX                            
         BNE   VCR5                                                             
         LH    RE,TCTXUSCR         INCREMENT PAX USES ON CREDITED INV           
         AHI   RE,1                                                             
         STH   RE,TCTXUSCR                                                      
         CLI   TANPLFT,C'Y'        IF PROGRAM IS LIFT                           
         BE    *+12                                                             
         CLI   BYTE,C'Y'           OR TO 10 OR 15 SECOND VERSION                
         BNE   VCR5                                                             
         LH    RE,TCTXULCR         INCREMENT PAX LFT USES ON                    
         AHI   RE,1                CREDITED INVOICE                             
         STH   RE,TCTXULCR                                                      
         B     VCR5                                                             
         DROP  R4                                                               
*                                                                               
VCR7     BRAS  RE,VACRTARA         VALIDATED CRED INVOICE BILL RATES            
*                                                                               
VCR8     OI    PAYSTAT1,CREDIT     TURN ON CREDIT PAYMENT STATUS BIT            
         OI    TCPAYST,TCCREDIT                                                 
*                                                                               
VCRX     OI    4(R2),X'20'         SET PREVIOUSLY VALIDATED                     
         J     XIT                                                              
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*              ROUTINE TO VALIDATE BILL-NO-PAYROLL OPTION                       
         SPACE 1                                                                
VALBNP   NTR1  BASE=*,LABEL=*                                                   
         LH    R2,DSPBNP           R2=DISP. TO FIELD                            
         LTR   R2,R2                                                            
         JZ    XIT                                                              
         AR    R2,RA               R2=A(FIELD)                                  
         TM    4(R2),X'20'                                                      
         JO    XIT                                                              
         NI    PAYSTAT1,ALL-BNP                                                 
         CLI   5(R2),0                                                          
         JE    VBNPX                                                            
         SPACE                                                                  
         TM    TGCTSTST,TGCTSCLI   IF CONNECT STAFF TYPE IS CLIENT              
         JO    NOINPUT             INPUT NOT ALLOWED                            
         SPACE                                                                  
         CLI   8(R2),C'N'                                                       
         JE    VBNPX                                                            
         CLI   8(R2),C'Y'                                                       
         JNE   FLDINV                                                           
         OI    PAYSTAT1,BNP                                                     
VBNPX    OI    4(R2),X'20'         SET PREVIOUSLY VALIDATED                     
         OI    MFLDCHA,MBNP        SET B-N-P OPTION CHANGED                     
         J     XIT                                                              
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*              ROUTINE GETS TIMESHEET FOR RECORD FOR THIS CAST MEMBER           
*              IF IT EXISTS AND SAVES TIMESHEET INFORMATION                     
***********************************************************************         
         SPACE                                                                  
GETTIME  NTR1  BASE=*,LABEL=*                                                   
         XC    TMSHTS,TMSHTS                                                    
         MVC   AIO,AIO3                                                         
         GOTO1 RECVAL,DMCB,TLTMCDQ,(X'A4',0)                                    
         BE    GTIME00                                                          
         OI    TGFASTAT,TGRDWBTS                                                
         GOTO1 RECVAL,DMCB,TLTMCDQ,(X'A4',0)                                    
         BNE   GTIMEX                                                           
GTIME00  L     R4,AIO                                                           
         MVI   ELCODE,TATTELQ                                                   
         BRAS  RE,GETEL                                                         
         B     *+8                                                              
GTIME10  BRAS  RE,NEXTEL                                                        
         BE    *+6                                                              
         DC    H'00'                                                            
         USING TATTD,R4                                                         
         CLC   TATTDATE,=X'FFFFFF' TOTAL OF ALL TIMESHEETS                      
         BNE   GTIME10                                                          
         MVC   TMSHTS,TATTSPOT    SAVE ALL TIMESHEET TOTAL INFO                 
GTIMEX   MVC   AIO,AIO1                                                         
         MVC   KEY,SVCASTKY       REREAD IT SO GETCAST CAN DO SEQ               
         GOTO1 HIGH                                                             
         J     XIT                                                              
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE ENSURES DLR PAYMENT IS COVERED BY FTRACK/FFC         *         
***********************************************************************         
                                                                                
CHKDLR   NTR1  BASE=*,LABEL=*                                                   
         CLI   TGUSEQU,UDLR        IF MAKING A DEALER PAYMENT                   
         JNE   XIT                                                              
         CLI   TGUSWKS,8           NON-8 WEEKS                                  
         JE    XIT                                                              
         TM    PAYSTAT1,CREDIT     NON-CREDIT                                   
         JO    XIT                                                              
         TM    TGMEEQU,LIKETV      FOR TV, INTERNET, OR NEW MEDIA               
         JZ    XIT                                                              
         CLI   TGCAUNI,0           ENSURE THAT CAST IS ELIGIBLE                 
         JE    XIT                 FOR HOLDING FEES ...                         
         TM    TGCAUNI,AFM                                                      
         JO    XIT                                                              
         TM    TGCATYPE,NOHLD                                                   
         JO    XIT                                                              
         TM    TGCATYPE,NHLDOF88                                                
         JO    XIT                                                              
         CLC   TCCAONOF,=C'OFF'                                                 
         JNE   CDLR10                                                           
         TM    TGCATYPE,NOHLDOFF                                                
         JO    XIT                                                              
                                                                                
         USING TACOD,R4                                                         
CDLR10   LA    R4,ELTACO                                                        
         CLI   TACOCTYP,CCTY04A    IF COMMERCIAL IS ACTRA TYPE 2404A            
         JE    CDLR15                                                           
         CLI   TACOCTYP,CCTY2404   OR ACTRA TYPE 2404                           
         JNE   CDLR20                                                           
CDLR15   CLI   TGUNEQU,ACT         AND UNION IS ACTRA                           
         JE    XIT                                                              
         CLC   TGLCL,=C'CAN'       OR LOCAL IS CAN                              
         JE    XIT                 PERFORMER IS NOT ELIGIBLE FOR HF             
         DROP  R4                                                               
                                                                                
         USING TACRD,R4                                                         
CDLR20   L     R4,AIO1             R4=A(CAST RECORD)                            
         MVI   ELCODE,TACRELQ      GET APPLIED CREDIT HISTORY ELEMENT           
         BRAS  RE,GETEL                                                         
         J     *+8                                                              
CDLR30   BRAS  RE,NEXTEL                                                        
         JNE   CDLR40                                                           
         CLC   TCPCYCS,TACREND     IF CURRENT CYCLE START DATE                  
         JH    CDLR30              FITS WITHIN A FIXED CYCLE                    
         J     XIT                 OK TO MAKE DEALER PAYMENT                    
         DROP  R4                                                               
                                                                                
CDLR40   OC    TCCAFCYC,TCCAFCYC   IF FIRST FIXED CYCLE DATE                    
         JZ    CDLR50              IS DEFINED AT CAST LEVEL                     
         MVC   TGDATE,TCCAFCYC     SAVE IT                                      
         J     CDLR60                                                           
                                                                                
         USING TACOD,R4                                                         
CDLR50   LA    R4,ELTACO           ELSE SAVE COMMERCIAL LEVEL                   
         MVC   TGDATE,TACOFCYC     FIRST FIXED CYCLE                            
         DROP  R4                                                               
                                                                                
         USING PERVALD,R2                                                       
CDLR60   GOTO1 DATCON,DMCB,(1,TGDATE),(8,WORK)                                  
         MVC   WORK+8(6),=C'-(13W)'                                             
         TM    AGYSTAT,TAAYS13W    CALCULATE FIRST FIXED CYCLE                  
         JO    CDLR70              END DATE                                     
         MVC   WORK+8(6),=C'-(3M) '                                             
CDLR70   LA    R2,BLOCK                                                         
         GOTO1 PERVAL,DMCB,(14,WORK),('PVIN1DYL',(R2))                          
                                                                                
         CLC   TCPCYCS,PVALPEND    IF CURRENT CYCLE START DATE DOES             
         JNH   XIT                 NOT FIT WITHIN FIRST FIXED CYCLE             
         OI    LCLSTAT7,HLDPENDG   HLD PAYMENT IS PENDING                       
         J     XIT                                                              
         DROP  R2                                                               
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE ENSURES GRR PAYMENT COVERS PAYMENT CYCLE             *         
***********************************************************************         
                                                                                
CHKGRR   NTR1  BASE=*,LABEL=*                                                   
         TM    TGUSSTAT,NOAPPLCR   IF MAKING A PAYMENT THAT APPLIES             
         JO    XIT                 AGAINST FTRACKS                              
         CLI   TGMEEQU,RADIO       TO A RADIO COMMERCIAL                        
         JNE   XIT                 ENSURE PAYMENT IS COVERED BY GRR             
                                                                                
         USING TAOAD,R4                                                         
         L     R4,AIO1             R4=A(CAST RECORD)                            
         MVI   ELCODE,TAOAELQ      GET OVERSCALE AMOUNTS ELEMENT                
         BRAS  RE,GETEL                                                         
         JNE   XIT                                                              
         ZIC   R0,TAOANUM          EXIT IF GRR= OVERSCALE IS NOT SET            
         LA    R1,TAOAUSE                                                       
CGRR10   CLC   0(L'TAOAUSE,R1),=C'GRR'                                          
         JE    CGRR20                                                           
         LA    R1,L'TAOASBEL(R1)                                                
         BCT   R0,CGRR10                                                        
         J     XIT                                                              
         DROP  R4                                                               
                                                                                
         USING TACRD,R4                                                         
CGRR20   L     R4,AIO              R4=A(CAST RECORD)                            
         MVI   ELCODE,TACRELQ      GET APPLIED CREDIT ELEMENTS                  
         BRAS  RE,GETEL                                                         
         J     CGRR40                                                           
CGRR30   BRAS  RE,NEXTEL                                                        
CGRR40   JNE   CGRR50                                                           
         CLC   TCPCYCS,TACRSTRT    IF CURRENT CYCLE START DATE                  
         JL    CGRR30              FITS WITHIN A FIXED CYCLE ...                
         CLC   TCPCYCS,TACREND                                                  
         JH    CGRR30                                                           
         CLC   TACRUSE,=C'GRR'     ALWAYS OK IF FIXED CYCLE IS NOT GRR          
         JNE   XIT                                                              
         CLI   TACRTYPE,0          ELSE IF GRR WAS PAID TO COVER A              
         JE    XIT                 SPECIFIC USE                                 
         CLC   TACRTYPE,TGUSEQU    NEED TO ENSURE THAT THIS IS                  
         JNE   CGRR30              THE USE BEING PAID                           
         J     XIT                                                              
                                                                                
CGRR50   OI    LCLSTAT6,GRRPENDG   GRR PAYMENT IS PENDING                       
         J     XIT                                                              
                                                                                
         EJECT                                                                  
***********************************************************************         
*        ROUTINE ENSURES LARGE SCALE GUARANTEE PAYMENTS WILL BE       *         
*        PROCESSED BEFORE THIS PAYMENT                                *         
*        ON ENTRY ... R4=A(GUARANTEE DETAILS ELEMENT)                 *         
***********************************************************************         
                                                                                
         USING TAGUD,R4                                                         
CHKLGRT  NTR1  BASE=*,LABEL=*                                                   
         CLI   TGUSEQU,UGRT        IF NOT MAKING GUARANTEE PAYMENT              
         JE    XIT                                                              
         OC    TAGUIAY,TAGUIAY     AND THIS IS NEW STYLE GUARANTEE              
         JZ    XIT                                                              
         OC    TAGUINV,TAGUINV     ADDED BY PAY PROGRAM                         
         JZ    XIT                                                              
                                                                                
         MVC   AIO,AIO2                                                         
         MVC   SYSDIR,=CL8'CHKDIR' SET TO READ CHECK FILE                       
         MVC   SYSFIL,=CL8'CHKFIL'                                              
                                                                                
         USING TLCKD,R3                                                         
         LA    R3,KEY              READ ALL CHECK RECORDS FOR THIS              
         XC    KEY,KEY             PERFORMER ON INVOICE THAT ADDED              
         MVI   TLCKCD,TLCKCDQ      GUARANTEE                                    
         MVC   TLCKAGY,TAGUIAY                                                  
         OC    TLCKAGY,TLCKAGY                                                  
         JNZ   *+10                                                             
         MVC   TLCKAGY,TAGUAGY                                                  
         MVC   TLCKINV,TAGUINV                                                  
         GOTO1 HIGH                                                             
         J     CLGRT20                                                          
CLGRT10  GOTO1 SEQ                                                              
CLGRT20  CLC   KEY(TLCKSORT-TLCKD),KEYSAVE                                      
         JNE   CLGRT30                                                          
         MVC   TLCKSSN,TGSSN                                                    
         JNE   CLGRT10                                                          
         GOTO1 GETREC                                                           
         DROP  R3,R4                                                            
                                                                                
         USING TACAD,R4                                                         
         L     R4,AIO              R4=A(CHECK RECORD)                           
         MVI   ELCODE,TACAELQ      GET CAST DETAIL ELEMENT                      
         BRAS  RE,GETEL                                                         
         JE    *+6                 ONLY CONSIDER CHECKS WITH GUARANTEE          
         DC    H'00'               CODE THAT MATCHES CURRENT PAYMENT            
         XC    TACAGUA,GRTFFS                                                   
         CLC   TACAGUA,TGGUA       AND ENSURE GRT IS PROCESSED/SET TO           
         JNE   CLGRT10             PROCESS                                      
         GOTOR CKGRTSTA,DMCB,('GTLRGOVS',0)                                     
         DROP  R4                                                               
                                                                                
CLGRT30  MVC   AIO,AIO1            RESTORE AIO OF CAST RECORD                   
         MVC   SYSFIL,=CL8'TALFIL' AND RESET TO READ TALENT FILE                
         MVC   SYSDIR,=CL8'TALDIR'                                              
         J     XIT                                                              
                                                                                
***********************************************************************         
*        ROUTINE ENSURES THAT IT IS OK TO MAKE A GRT/PAYMENT          *         
*        TO THIS LARGE OVERSCALE GUARANTEE                            *         
*        ON ENTRY ... R4=A(GUARANTEE DETAILS ELEMENT)                 *         
***********************************************************************         
                                                                                
         USING TAGUD,R4                                                         
VGRTPAY  NTR1  BASE=*,LABEL=*                                                   
         CLI   TGUSEQU,UGRT        IF MAKING GUARANTEE PAYMENT                  
         JNE   XIT                                                              
                                                                                
         TM    TAGUSTAT,TAGUSDES   ASCENDING BALANCE GUARANTEES                 
         JO    VGP10               ARE NOT ELIGIBLE                             
         OI    LCLSTAT7,NGRTABAL                                                
         J     XIT                                                              
                                                                                
VGP10    OC    TAGUAGY,TAGUAGY     GUARANTEE AGENCY MUST MATCH                  
         JZ    VGP20               COMMERCIAL AGENCY                            
         CLC   TAGUAGY,TGAGY                                                    
         JE    VGP20                                                            
         OI    LCLSTAT7,GACNMTCH                                                
         J     XIT                                                              
                                                                                
VGP20    OC    TAGUCLI,TAGUCLI     GUARANTEE CLIENT MUST MATCH                  
         JZ    XIT                 COMMERCIAL CLIENT                            
         CLC   TAGUCLI,TGCLI                                                    
         JE    XIT                                                              
         OI    LCLSTAT7,GACNMTCH                                                
         J     XIT                                                              
         EJECT                                                                  
***********************************************************************         
*        ROUTINE ENSURES PER CYCLE PAYMENT COVERS THIS PAYMENT        *         
***********************************************************************         
                                                                                
CHKPCYC  NTR1  BASE=*,LABEL=*                                                   
         TM    LCLSTAT7,CKPERCYC   IF WE NEED TO CHECK FOR                      
         JZ    XIT                 PER CYCLE COVERAGE                           
                                                                                
         MVC   AIO,AIO2                                                         
         MVC   SYSDIR,=CL8'CHKDIR' SET TO READ CHECK FILE                       
         MVC   SYSFIL,=CL8'CHKFIL'                                              
                                                                                
         USING TLCKPD,R3                                                        
         LA    R3,KEY              READ UNPROCESSED CHECK RECORDS               
         XC    KEY,KEY             FOR THIS PERFORMER                           
         MVI   TLCKPCD,TLCKECDQ                                                 
         MVC   TLCKESSN,TGSSN                                                   
         OC    ELTATI,ELTATI                                                    
         BZ    *+10                                                             
         MVC   TLCKESSN,ELTATI+TATIID-TATID                                     
         MVI   TLCKECUR,C'U'                                                    
         MVC   TLCKEEMP,=C'TP '                                                 
         GOTO1 HIGH                                                             
         J     CPCYC20                                                          
CPCYC10  GOTO1 SEQ                                                              
CPCYC20  CLC   KEY(TLCKEDTE+1-TLCKPCD),KEYSAVE                                  
         JNE   CPCYC30                                                          
         GOTO1 GETREC                                                           
         DROP  R3                                                               
                                                                                
         USING TACAD,R4                                                         
         L     R4,AIO              R4=A(CHECK RECORD)                           
         MVI   ELCODE,TACAELQ      GET CAST DETAIL ELEMENT                      
         BRAS  RE,GETEL                                                         
         JE    *+6                                                              
         DC    H'00'                                                            
         XC    TACAGUA,GRTFFS                                                   
         CLC   TACAGUA,TGGUA       ONLY CONSIDER CHECKS WITH GUARANTEE          
         JNE   CPCYC10             CODE THAT MATCHES CURRENT PAYMENT            
         DROP  R4                                                               
                                                                                
         USING TAPDD,R4                                                         
         L     R4,AIO              R4=A(CHECK RECORD)                           
         MVI   ELCODE,TAPDELQ      GET PAYMENT DETAILS ELEMENT                  
         BRAS  RE,GETEL                                                         
         JE    *+6                                                              
         DC    H'00'                                                            
         TM    TAPDSTA2,TAPDSPRI   IF CURRENT CYCLE FITS WITHIN                 
         JZ    CPCYC10             THE CYCLE OF AN ALREADY EXISTING             
         CLC   TGTHREE,TAPDCYCE    PER CYCLE PAYMENT                            
         JH    CPCYC10                                                          
         CLC   TGTHREE,TAPDCYCS    ENSURE PER CYCLE IS PROCESSED/               
         JL    CPCYC10             SET TO PROCESS                               
         GOTOR CKGRTSTA,DMCB,('GTPERCYC',0)                                     
         J     CPCYC50                                                          
         DROP  R4                                                               
                                                                                
CPCYC30  TM    TGFASTAT,TGFROMFA   PER CYCLE PAYMENT IS PENDING                 
         JZ    CPCYC40                                                          
         MVC   WORK,ERPCPEND                                                    
         GOTO1 SSNPACK,DMCB,TGSSN,WORK+PCPNDPID-ERPCPEND                        
         GOTOR ADDEAP,DMCB,WORK,ERPCPEN2,AWEBRES                                
         J     CPCYC50                                                          
CPCYC40  OI    LCLSTAT6,PCYPENDG                                                
                                                                                
CPCYC50  MVC   AIO,AIO1            RESTORE AIO OF CAST RECORD                   
         MVC   SYSFIL,=CL8'TALFIL' AND RESET TO READ TALENT FILE                
         MVC   SYSDIR,=CL8'TALDIR'                                              
         J     XIT                                                              
                                                                                
ERPCPEND DC    AL1(EPCPENDX-*),AL2(ERRPCYPN),AL1(ERRCATY1),AL1(D#PYCST)         
         DC    AL2(0)                                                           
         DC    CL30'Per Cycle Payment pending for '                             
PCPNDPID DC    CL6' '                                                           
EPCPENDX EQU   *                                                                
                                                                                
ERPCPEN2 DC    AL1(EPCPEN2X-*),AL2(ERRPCYPN),AL1(ERRCATY1),AL1(D#PYCST)         
         DC    AL2(0)                                                           
         DC    C'Per Cycle Payment pending'                                     
EPCPEN2X EQU   *                                                                
         EJECT                                                                  
***********************************************************************         
*        ROUTINE ENSURES THAT GUARANTEE/PER CYCLE PAYMENT PROCESSES   *         
*        BEFORE ANY PAYMENTS THAT SHOULD FOLLOW IT                    *         
*        ON ENTRY ... P1 BYTE 1 = 0 (GUARANTEE) OR 1 (PER CYCLE)      *         
*                     AIO=A(CHECK RECORD)                             *         
***********************************************************************         
                                                                                
         USING TAPDD,R4                                                         
CKGRTSTA NTR1  BASE=*,LABEL=*                                                   
         MVC   TGBYTE3,0(R1)       SAVE GUARANTEE TYPE INDICATOR                
                                                                                
         USING TACDD,R4                                                         
         L     R4,AIO              R4=A(CHECK RECORD)                           
         MVI   ELCODE,TACDELQ      GET CHECK DETAILS ELEMENT                    
         BRAS  RE,GETEL                                                         
         JNE   XIT                                                              
         OC    TACDCHK,TACDCHK     IF GRT CHECKS HAVE ALREADY BEEN CUT          
         JNZ   XIT                 OK TO PROCESS THIS PAYMENT                   
         DROP  R4                                                               
                                                                                
         USING TLCKD,R4                                                         
         L     R4,AIO              R4=A(CHECK RECORD)                           
         XC    BLOCK(L'KEY),BLOCK  SAVE CHECK KEY                               
         MVC   BLOCK(L'TLCKKEY),0(R4)                                           
                                                                                
         MVC   SYSFIL,=CL8'TALFIL' AND RESET TO READ TALENT FILE                
         MVC   SYSDIR,=CL8'TALDIR' RESET TO READ TALENT DIRECTORY               
                                                                                
         USING TLINPD,R3                                                        
         XC    KEY,KEY                                                          
         MVI   TLINPCD,TLINBCDQ    IF GRT INVOICE HAS ALREADY BEEN              
         MVC   TLINBAGY,TLCKAGY    BILLED, OK TO PROCESS THIS PAYMENT           
         MVC   TLINBINV,TLCKINV                                                 
         XC    TLINBINV,GRTFFS                                                  
         GOTO1 HIGH                                                             
         CLC   TLINPKEY,KEYSAVE                                                 
         JNE   XIT                                                              
         TM    TLINBST2,TAINSBIL                                                
         JO    XIT                                                              
         DROP  R3,R4                                                            
                                                                                
         GOTO1 GETREC                                                           
                                                                                
         USING TAIND,R4                                                         
         L     R4,AIO              R4=A(INVOICE RECORD)                         
         MVI   ELCODE,TAINELQ      GET INVOICE STATUS ELEMENT                   
         BRAS  RE,GETEL                                                         
         JE    *+6                                                              
         DC    H'00'                                                            
         TM    TAINSTAT,TAINSERR   INVOICE CANNOT BE IN ERROR STATUS            
         JO    GRTINER                                                          
                                                                                
         TM    TGFASTAT,TGCRNOPY   IF PAYMENT COMING FROM CERNO                 
         JO    CGS10                                                            
         CLI   TGCTSTTY,TASTTYPC   OR PAYER IS A CLIENT                         
         JE    CGS10                                                            
         CLI   TGCTSTTY,TASTTYPF   THEN THE INVOICE MUST BE APPROVED            
         JNE   CGS20                                                            
CGS10    TM    TAINSTAT,TAINSAPR   INVOICE MUST BE APPROVED                     
         JNZ   CGS20                                                            
         BAS   RE,GRTNAPP                                                       
         JE    XIT                                                              
         DROP  R4                                                               
                                                                                
         USING TAPDD,R4                                                         
CGS20    L     R4,AIO                                                           
         MVI   ELCODE,TAPDELQ                                                   
         BRAS  RE,GETEL                                                         
         JE    *+6                                                              
         DC    H'00'                                                            
         TM    TAPDOPT2,TAPDOURG   IF GRT PAYMENT WAS MADE URGENT,              
         JO    XIT                 OK TO PROCESS THIS PAYMENT                   
                                                                                
         MVC   BLOCK(1),TAPDSTA2   SAVE PAYMENT STATUS 2                        
         MVC   BLOCK+1(3),TAPDUSE  AND USE CODE                                 
         DROP  R4                                                               
                                                                                
         USING TADDD,R4                                                         
         L     R4,AIO              R4=A(INVOICE RECORD)                         
         MVI   ELCODE,TADDELQ      GET DUE DATE ELEMENT                         
         BRAS  RE,GETEL                                                         
         JE    *+6                                                              
         DC    H'00'                                                            
                                                                                
         CLC   TADDDATE,TGTODAY1   IF DUE DATE IS TODAY OR EARLIER              
         JH    CGS30                                                            
         TM    BLOCK,TAPDAFTR      AND AFTRA WAS ON CAST                        
         JO    XIT                                                              
         CLC   =C'HLD',BLOCK+1     OR PAYMENT WAS FOR HOLDING FEE               
         JE    XIT                                                              
         CLC   =C'SHL',BLOCK+1     THE GUARANTEE PAYMENT WILL                   
         JE    XIT                 PROCESS URGENT                               
         CLC   =C'ADH',BLOCK+1     SO OK TO PROCESS THIS PAYMENT                
         JE    XIT                                                              
                                                                                
CGS30    NI    LCLSTAT7,X'FF'-GTLRGOVS-GTPERCYC                                 
                                                                                
         OC    GRTDUEDT,GRTDUEDT   IF THIS IS THE FIRST GUARANTEE               
         JNZ   CGS40               DUE DATE ENCOUNTERED                         
         MVC   GRTDUEDT,TADDDATE   SAVE IT                                      
         GOTO1 SSNPACK,DMCB,TGSSN,GRTDUPID                                      
         OC    LCLSTAT7,TGBYTE3                                                 
         J     CGS50                                                            
                                                                                
CGS40    CLC   GRTDUEDT,TADDDATE   IF THIS IS EARLIEST GUARANTEE                
         JNH   XIT                 DUE DATE ENCOUNTERED                         
         MVC   GRTDUEDT,TADDDATE   SAVE IT                                      
         GOTO1 SSNPACK,DMCB,TGSSN,GRTDUPID                                      
         OC    LCLSTAT7,TGBYTE3                                                 
         DROP  R4                                                               
                                                                                
         USING TLIND,R4                                                         
CGS50    L     R4,AIO                                                           
         MVC   GRTDUAGY,TLINAGY    SAVE INVOICE AGENCY                          
         MVC   GRTDUINV,TLININV    AND INVOICE NUMBER                           
         XC    GRTDUINV,GRTFFS                                                  
         J     XIT                                                              
         DROP  R4                                                               
                                                                                
***********************************************************************         
*        ROUTINE RETURNS ERROR: GRT/PER CYCLE PAYMENT IN ERROR STATUS *         
***********************************************************************         
                                                                                
         USING SVAID,R3                                                         
         USING TLIND,R4                                                         
GRTINER  LA    R3,WORK2                                                         
         L     R4,AIO                                                           
         MVC   SVAGY,TLINAGY       SAVE INVOICE AGENCY                          
         MVC   SVINV,TLININV       AND INVOICE NUMBER                           
         XC    SVINV,GRTFFS                                                     
         DROP  R4                                                               
                                                                                
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    GIE60               RETURN GUARANTEE/PER CYCLE AGY/INV           
         TM    TGFASTAT,TGCRNOPY   THAT IS IN ERROR STATUS                      
         JZ    GIE40                                                            
         MVC   BLOCK(65),ERGRTIER                                               
         LA    R4,BLOCK+CGGRTIEP-ERGRTIER                                       
         LA    R2,BLOCK+CGRTIEAI-ERGRTIER                                       
         CLI   TGBYTE3,GTLRGOVS                                                 
         JE    GIE10                                                            
         MVC   BLOCK(65),ERPCYIER                                               
         LA    R4,BLOCK+CGPCYIEP-ERPCYIER                                       
         LA    R2,BLOCK+CGPCYIEI-ERPCYIER                                       
GIE10    GOTO1 SSNPACK,DMCB,TGSSN,(R4)                                          
         MVC   0(L'SVAGY,R2),SVAGY                                              
GIE20    CLI   0(R2),C' '                                                       
         JE    GIE30                                                            
         LA    R2,1(R2)                                                         
         J     GIE20                                                            
GIE30    MVI   0(R2),C'/'                                                       
         GOTO1 TINVCON,DMCB,SVINV,1(R2),DATCON                                  
                                                                                
         GOTO1 ADDERROR,DMCB,BLOCK                                              
         J     XIT                                                              
         DROP  R3                                                               
                                                                                
GIE40    LA    R2,ERGRTIE2                                                      
         CLI   TGBYTE3,GTLRGOVS                                                 
         JE    GIE50                                                            
         LA    R2,ERPCYIE2                                                      
GIE50    GOTOR ADDEAP,DMCB,0,0(R2),AWEBRES                                      
         J     XIT                                                              
                                                                                
GIE60    CLI   TGBYTE3,GTLRGOVS    IF PYMT IS BEING MADE ON MAINFRAME           
         JNE   GIE70               RETURN GUARANTEE/PER CYCLE AGY/INV           
         OI    LCLSTAT6,GRTINERI   THAT IS IN ERROR STATUS                      
         J     XIT                                                              
GIE70    OI    LCLSTAT6,PCYINERI                                                
         J     XIT                                                              
                                                                                
ERGRTIER DC    AL1(EGRTIERX-*),AL2(ERRGIEAI),AL1(ERRCATY1),AL1(D#PYCST)         
         DC    AL2(0)                                                           
         DC    CL22'Guarantee payment for '                                     
CGGRTIEP DC    CL6' '                                                           
         DC    CL17' in error status '                                          
CGRTIEAI DC    CL15' '                                                          
EGRTIERX EQU   *                                                                
                                                                                
ERGRTIE2 DC    AL1(EGRTIE2X-*),AL2(ERRGIEAI),AL1(ERRCATY1),AL1(D#PYCST)         
         DC    AL2(0)                                                           
         DC    C'Guarantee payment in error status'                             
EGRTIE2X EQU   *                                                                
                                                                                
ERPCYIER DC    AL1(EPCYIERX-*),AL2(ERRPIEAI),AL1(ERRCATY1),AL1(D#PYCST)         
         DC    AL2(0)                                                           
         DC    CL22'Per Cycle payment for '                                     
CGPCYIEP DC    CL6' '                                                           
         DC    CL17' in error status '                                          
CGPCYIEI DC    CL15' '                                                          
EPCYIERX EQU   *                                                                
                                                                                
ERPCYIE2 DC    AL1(EPCYIE2X-*),AL2(ERRPIEAI),AL1(ERRCATY1),AL1(D#PYCST)         
         DC    AL2(0)                                                           
         DC    C'Per cycle payment in error status'                             
EPCYIE2X EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE RETURNS ERROR: GRT/PER CYCLE PAYMENT NOT APPROVED    *         
***********************************************************************         
                                                                                
         USING SVAID,R3                                                         
         USING TLIND,R4                                                         
GRTNAPP  NTR1                                                                   
         LA    R3,WORK2                                                         
         L     R4,AIO                                                           
         MVC   SVAGY,TLINAGY       SAVE INVOICE AGENCY                          
         MVC   SVINV,TLININV       AND INVOICE NUMBER                           
         XC    SVINV,GRTFFS                                                     
         DROP  R4                                                               
                                                                                
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    GNA50               RETURN GUARANTEE/PER CYCLE AGY/INV           
         MVC   BLOCK(65),ERGRTNAP  THAT MUST BE APPROVED FIRST                  
         LA    R4,BLOCK+CGGRTNAP-ERGRTNAP                                       
         LA    R2,BLOCK+CGRTNAAI-ERGRTNAP                                       
         CLI   TGBYTE3,GTLRGOVS                                                 
         JE    GNA10                                                            
         MVC   BLOCK(65),ERPCYNAP                                               
         LA    R4,BLOCK+CGPCYNAP-ERPCYNAP                                       
         LA    R2,BLOCK+CGPCYNAI-ERPCYNAP                                       
GNA10    GOTO1 SSNPACK,DMCB,TGSSN,(R4)                                          
         MVC   0(L'SVAGY,R2),SVAGY                                              
GNA20    CLI   0(R2),C' '                                                       
         JE    GNA30                                                            
         LA    R2,1(R2)                                                         
         J     GNA20                                                            
GNA30    MVI   0(R2),C'/'                                                       
         GOTO1 TINVCON,DMCB,SVINV,1(R2),DATCON                                  
                                                                                
         GOTO1 ADDERROR,DMCB,BLOCK                                              
         J     NO                                                               
         DROP  R3                                                               
                                                                                
GNA50    CLI   TGBYTE3,GTLRGOVS    IF PYMT IS BEING MADE ON MAINFRAME           
         JNE   GNA60               RETURN GUARANTEE/PER CYCLE AGY/INV           
         OI    LCLSTAT6,GRTNTAPI   THAT MUST BE APPROVED FIRST                  
         J     YES                                                              
GNA60    OI    LCLSTAT6,PCYNTAPI                                                
         J     YES                                                              
                                                                                
ERGRTNAP DC    AL1(EGRTNAPX-*),AL2(ERRGNAAI),AL1(ERRCATY1),AL1(D#PYCST)         
         DC    AL2(0)                                                           
         DC    CL22'Guarantee payment for '                                     
CGGRTNAP DC    CL6' '                                                           
         DC    CL18' must be approved '                                         
CGRTNAAI DC    CL14' '                                                          
EGRTNAPX EQU   *                                                                
                                                                                
ERPCYNAP DC    AL1(EPCYNAPX-*),AL2(ERRPNAAI),AL1(ERRCATY1),AL1(D#PYCST)         
         DC    AL2(0)                                                           
         DC    CL22'Per Cycle payment for '                                     
CGPCYNAP DC    CL6' '                                                           
         DC    CL18' must be approved '                                         
CGPCYNAI DC    CL14' '                                                          
EPCYNAPX EQU   *                                                                
                                                                                
GRTFFS   DC    6X'FF'                                                           
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE TO SAVE COMMERCIAL'S INTERNET/NEW MEDIA CODES        *         
***********************************************************************         
                                                                                
SVMEDTAB NTR1  BASE=*,LABEL=*                                                   
         OC    AMEDTABL,AMEDTABL   IF ADDRESS OF INTERNET/NEW MEDIA             
         JZ    XIT                 TABLE NOT SET YET, EXIT                      
*                                                                               
         CLI   TWASCR,SCR90        EXIT IF ON PAY MENU SCREEN                   
         JL    SMT10                                                            
         CLI   TWASCR,SCR99                                                     
         JNH   XIT                                                              
*                                                                               
SMT10    CLI   TWASCR,SCR11        IF ON INTERNET OR NEW MEDIA                  
         JE    XIT                 SCREEN, BUILD THIS TABLE FROM                
         CLI   TWASCR,SCR1D        SCREEN                                       
         JE    XIT                                                              
         CLI   TWASCR,SCR12                                                     
         JE    XIT                                                              
*                                                                               
         USING MEDTABLD,R3                                                      
         L     R3,AMEDTABL         INITIALIZE INTERNET/NEW MEDIA                
         LHI   RF,L'MEDTABL        TABLE                                        
         XCEFL 0(R3)                                                            
         MVI   0(R3),X'FF'                                                      
*                                                                               
         USING TAMDD,R4                                                         
         L     R4,AIO              GET ALL INTERNET/NEW MEDIA ELEMENTS          
         MVI   ELCODE,TAMDELQ                                                   
         BRAS  RE,GETEL                                                         
         J     *+8                                                              
SMT20    BRAS  RE,NEXTEL                                                        
         JNE   SMT30                                                            
         MVC   MEDTYP,TAMDTYPE     SAVE MEDIA TYPE                              
         MVC   MEDCOD,TAMDCODE     AND CODE                                     
         LA    R3,MEDLNQ(R3)                                                    
         J     SMT20                                                            
         DROP  R4                                                               
*                                                                               
SMT30    MVI   0(R3),X'FF'         MARK END OF TABLE                            
         J     XIT                                                              
         DROP  R3                                                               
         EJECT                                                                  
*              ROUTINE TO SAVE PAYMENT BREAKDOWN INFORMATION ON CHECK           
         SPACE 1                                                                
SVTABKEL NTR1  BASE=*,LABEL=*                                                   
         OC    TCCSTBRK,TCCSTBRK   IF PAYMENT BREAKDOWN BLOCK IS                
         JZ    XIT                 POPULATED                                    
*                                                                               
         USING TABKD,R4                                                         
         LA    R4,ELEMENT          INITIALIZE PAYMENT BREAKDOWN                 
         XC    ELEMENT,ELEMENT     ELEMENT                                      
         MVI   TABKEL,TABKELQ                                                   
         MVI   TABKLEN,TABKLNQ                                                  
*                                                                               
         LA    RF,TABKDATA         RF=A(BREAKDOWN FIELD IN ELEMENT)             
         USING TABKCODE,RF                                                      
*                                                                               
         XR    R2,R2               SET TO ADD ALL NON-OVERSCALES 1ST            
*                                                                               
         USING PAYBRKDD,RE                                                      
SVTABK10 LA    RE,TCCSTBRK         RE=A(FIRST ENTRY IN PAYMENT                  
         LA    RE,PBBRKDAT              BREAKDOWN BLOCK)                        
         DROP  RE                                                               
         USING PBDATAD,RE                                                       
*                                                                               
SVTABK20 OC    PBCODE(PBUNTLNQ),PBCODE   MORE BREAKDOWN IN BLOCK?               
         BZ    SVTABK60                                                         
*                                                                               
         CLI   PBCODE,1            IF ENTRY IS FOR OVERSCALE                    
         BNE   SVTABK30                                                         
         LTR   R2,R2               ONLY ADD TO CHECK IF EXPLICITLY              
         BZ    SVTABK50            ADDING OVERSCALE AT THIS TIME                
*                                                                               
SVTABK30 LTR   R2,R2               IF ONLY CHECKING FOR OVERSCALE               
         BZ    SVTABK40            AT THIS TIME                                 
         CLI   PBCODE,1            ONLY ADD OVERSCALE ENTRY                     
         BNE   SVTABK50                                                         
*                                                                               
SVTABK40 MVC   TABKCODE(PBUNTLNQ),PBCODE SAVE ENTRY INTO ELEMENT                
*                                                                               
         ZIC   R1,TABKNSUB         INCREASE NUMBER OF SUB ELEMENTS              
         AHI   R1,1                                                             
         STC   R1,TABKNSUB                                                      
*                                                                               
         ZIC   R1,TABKLEN          INCREASE ELEMENT LENGTH                      
         AHI   R1,TABKSLNQ                                                      
         STC   R1,TABKLEN                                                       
*                                                                               
         LA    RF,TABKSLNQ(RF)     BUMP TO NEXT SPACE IN ELEMENT                
*                                                                               
SVTABK50 LA    RE,PBUNTLNQ(RE)     BUMP TO NEXT BREAKDOWN IN BLOCK              
         B     SVTABK20                                                         
*                                                                               
SVTABK60 LTR   R2,R2              IF OVERSCALES HAVEN'T BEEN PROCESSED          
         BNZ   SVTABK70           YET                                           
         LA    R2,1               GO PROCESS THEM NOW                           
         B     SVTABK10                                                         
*                                                                               
SVTABK70 GOTO1 ADDL                ADD ELEMENT                                  
         J     XIT                                                              
         DROP  R4,RE,RF                                                         
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*              ROUTINE LOOKS AT TIMESHEET RECORD FOR THIS CAST MEMBER           
*              IF IT HOLIDAY TOTAL ELEMENT EXISTS, RETURNS CCEQ                 
*              TIMESHEET RECORD IS IN AIO3                                      
         SPACE                                                                  
CHKHLDY  NTR1  BASE=*,LABEL=*                                                   
         OC    TCATMTOT,TCATMTOT   ARE WE PAYING A TIMESHEET?                   
         JZ    NO                                                               
*                                                                               
         L     R4,TCATMTOT         SUBTOTAL ELEMENT ON TIMESHEET RECORD         
         USING TATTD,R4                                                         
         J     CHLDY05                                                          
*                                                                               
CHLDY02  ZIC   RE,TATTLEN                                                       
         AR    R4,RE               BUMP TO NET SUBTOTAL ELEMENT                 
         CLI   0(R4),TATTELQ       MORE SUBTOTAL ELEMENTS?                      
         JNE   NO                                                               
*                                                                               
CHLDY05  CLC   TATTDATE,=X'FFFFFD' ANY HOLIDAY TOTALS?                          
         JNE   CHLDY02                                                          
         J     YES                                                              
         DROP  R4                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE TO FILTER CAST FOR RADIO GUARANTEE PAYMENTS          *         
*        ON ENTRY ... AIO=A(CAST RECORD)                              *         
***********************************************************************         
                                                                                
GRRCAST  NTR1  BASE=*,LABEL=*                                                   
         CLI   TGUSEQU,UGRR        IF MAKING GRR PAYMENT                        
         JNE   YES                 FILTER CAST APPROPRIATELY                    
                                                                                
         USING TACAD,R4                                                         
         L     R4,AIO              GET CAST DETAILS ELEMENT                     
         MVI   ELCODE,TACAELQ                                                   
         BRAS  RE,GETEL                                                         
         JE    *+6                                                              
         DC    H'00'                                                            
                                                                                
         CLI   TGUSTYP,0           IF PAYING GRR "ONCE PER CYCLE"               
         JNE   GRRC10                                                           
         GOTO1 GETOV1,DMCB,TGUSCDE,FULL                                         
         CLI   0(R1),X'FF'         ONLY PAY CAST WITH GRR= OVERSCALE            
         JNE   NO                  AMOUNT                                       
         TM    TACASTA2,TACASPUS   THAT RECEIVES GUARANTEED AMOUNT              
         JZ    YES                 ONCE PER CYCLE                               
         J     NO                                                               
                                                                                
GRRC10   TM    TACASTA2,TACASPUS   IF PAYING GRR "ONCE PER USE PER              
         JO    YES                 CYCLE" ONLY PAY CAST THAT RECEIVES           
         J     NO                  GUARANTEE AMOUNT PER USE                     
         DROP  R4                                                               
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE TO SAVE PAYMENT'S INTERNET/NEW MEDIA CODES           *         
***********************************************************************         
                                                                                
ADDTAMD  NTR1  BASE=*,LABEL=*                                                   
         LA    RE,INTNMEDT         IF MAKING ONE OF THE PAYMENTS                
ATAMD10  CLI   0(RE),X'FF'         LISTED IN INTNMEDT TABLE                     
         JE    XIT                                                              
         CLC   TGUSEQU,0(RE)                                                    
         JE    ATAMD20                                                          
         LA    RE,1(RE)                                                         
         JNE   ATAMD10                                                          
*                                                                               
         USING TAMDD,R4                                                         
ATAMD20  LA    R4,ELEMENT          INITIALIZE INTERNET/NEW MEDIA                
         XC    ELEMENT,ELEMENT     ELEMENT                                      
         MVI   TAMDEL,TAMDELQ                                                   
         MVI   TAMDLEN,TAMDLNQ                                                  
*                                                                               
         USING MEDTABLD,R3                                                      
         L     R3,AMEDTABL         READ ALL INTERNET/NEW MEDIA                  
ATAMD30  CLI   0(R3),X'FF'         ENTRIES                                      
         JE    XIT                                                              
*                                                                               
         MVC   TAMDTYPE,MEDTYP     COPY TYPE                                    
         MVC   TAMDCODE,MEDCOD     AND CODE INTO ELEMENT                        
         OC    TAMDCODE,SPACES                                                  
         GOTO1 ADDELEM             ADD ELEMENT                                  
         DROP  R4                                                               
*                                                                               
         LA    R3,MEDLNQ(R3)       BUMP TP NEXT INTERNET/NEW MEDIA              
         J     ATAMD30                                                          
         DROP  R3                                                               
*                                                                               
INTNMEDT DC    AL1(UIRN,UINU,UNMR,UNMU,UMVI,UMVN,USIR,USIU,USNM,USNU)           
         DC    AL1(USMI,USMN,UBSS,USSS,USCS,UBSC,UBSU,UDEM,UADD,USNA)           
         DC    AL1(UCDM,UCAU,URRS,UARS,USRS,UADC,UBSM,UIMS,UCMS,UISS)           
*        DC    AL1(UPRM,UIFS,UTAG,UVAR,UADT,UADO,UAUD,UNBS,UCNL,USCN)           
         DC    AL1(UPRM,UIFS,UTAG,UADT,UADO,UAUD,UNBS,UCNL,USCN)                
         DC    AL1(UINS,UFGS,USFS,UPUB,USOP)                                    
         DC    X'FF'                                                            
         EJECT                                                                  
*&&DO                                                                           
*              ROUTINE TO DETERMINE IF OK TO PAY NON-UNION CAST                 
*              MEMBER ON CSS USE                                                
         SPACE 1                                                                
FILTCSS  NTR1  BASE=*,LABEL=*                                                   
         CLI   TGUSEQU,UCSS        USE MUST BE CSS                              
         JNE   NO                                                               
                                                                                
         LA    RE,CSSCATTB                                                      
FCSS10   CLI   0(RE),X'FF'         AND CAST MEMBERS CATEGORY                    
         JE    NO                  MUST BE IN TABLE                             
         CLC   TGCAEQU,0(RE)                                                    
         JE    YES                                                              
         LA    RE,1(RE)                                                         
         J     FCSS10                                                           
                                                                                
         SPACE 2                                                                
CSSCATTB DC    AL1(CTGAF)                                                       
         DC    AL1(CTGRK)                                                       
         DC    AL1(CTPRM)                                                       
         DC    AL1(CTSCS)                                                       
         DC    AL1(CTGRD)                                                       
         DC    AL1(CTKMU)                                                       
         DC    AL1(CTKHS)                                                       
         DC    AL1(CTCOS)                                                       
         DC    AL1(CTBBE)                                                       
         DC    AL1(CTDO)                                                        
         DC    AL1(CTGO)                                                        
         DC    AL1(CTGRB)                                                       
         DC    AL1(CTEL)                                                        
         DC    AL1(CTPRA)                                                       
         DC    AL1(CTPTR)                                                       
         DC    AL1(CTSPE)                                                       
         DC    AL1(CTGR)                                                        
         DC    AL1(CTLMP)                                                       
         DC    AL1(CTDEC)                                                       
         DC    AL1(CTSDR)                                                       
         DC    AL1(CTCOA)                                                       
         DC    AL1(CTHA)                                                        
         DC    AL1(CTMUA)                                                       
         DC    AL1(CTCPT)                                                       
         DC    AL1(CTOTC)                                                       
         DC    X'FF'                                                            
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*&&                                                                             
*                                                                               
*              ROUTINE TO DETERMINE IF ALLOWABLE DIO CATEGORY                   
*                                                                               
FILTDIO  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLI   TGUSEQU,UDIO        USE MUST BE DIO                              
         JNE   YES                                                              
*                                                                               
         LA    RE,DIOCATTB                                                      
*                                                                               
FDIOLP   CLI   0(RE),X'FF'         AND CAST MEMBERS CATEGORY                    
         JE    NO                  MUST BE IN TABLE                             
         CLC   TGCAEQU,0(RE)                                                    
         JE    YES                                                              
FDIOCN   LA    RE,1(RE)                                                         
         J     FDIOLP                                                           
*                                                                               
DIOCATTB DC    AL1(CTP)            PRINCIPAL PERFORMER                          
         DC    AL1(CTNP)           NON-PRINCIPAL PERFORMER                      
         DC    AL1(CTP3M)          PRINCIPAL PERFORMER 3 MINUTES                
         DC    AL1(CTS16)          SOLO/DUO LESS THAN 16 BARS                   
         DC    AL1(CTG16)          GROUP    LESS THAN 16 BARS                   
         DC    AL1(CTSO)           STEP OUT PERFORMER                           
         DC    AL1(CTS)            SOLO/DUO                                     
         DC    AL1(CTG3)           GROUP                                        
         DC    AL1(CTC3)           CONTRACTOR                                   
         DC    X'FF'                                                            
*                                                                               
         LTORG                                                                  
*                                                                               
         EJECT                                                                  
*                                                                               
*              ROUTINE TO DETERMINE IF ALLOWABLE IVR CATEGORY                   
*                                                                               
FILTIVR  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLI   TGUSEQU,UIVR        USE MUST BE IVR                              
         JNE   YES                                                              
*                                                                               
         LA    RE,IVRCATTB                                                      
*                                                                               
FIVRLP   CLI   0(RE),X'FF'         AND CAST MEMBERS CATEGORY                    
         JE    NO                  MUST BE IN TABLE                             
         CLC   TGCAEQU,0(RE)                                                    
         JE    YES                                                              
FIVRCN   LA    RE,1(RE)                                                         
         J     FIVRLP                                                           
*                                                                               
IVRCATTB DC    AL1(CTP)            PRINCIPAL PERFORMER                          
         DC    X'FF'                                                            
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*              ROUTINE TO ADJUST US$ TOTALS FOR ACTRA TYPE 2404A                
*              COMMERCIALS                                                      
         SPACE 1                                                                
ADJ04AUS NTR1  BASE=*,LABEL=*                                                   
         OC    INV04A,INV04A       IF GENERATING TWO INVOICES FOR               
         JZ    XIT                 ACTRA TYPE 2404A COMMERCIAL                  
         SPACE 1                                                                
         LA    R1,ITOTS            R1=A(INVOICE TOTALS)                         
         LA    RF,CTOTS            RF=A(CANADIAN TOTALS)                        
         LA    R0,NTCTOTS          R0=N'ACCUMS                                  
         SPACE 1                                                                
A04AUS10 L     RE,0(R1)            INVOICE TOTALS                               
         S     RE,0(RF)            MINUS THE CANADIAN TOTALS                    
         ST    RE,0(R1)            IS US$ INVOICE TOTAL                         
         SPACE 1                                                                
         LA    R1,4(R1)            BUMP TO NEXT INVOICE TOTAL                   
         LA    RF,4(RF)            AND TO NEXT CANADIAN TOTAL                   
         BCT   R0,A04AUS10                                                      
         J     XIT                                                              
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*              ROUTINE TO READJUST US$ TOTALS FOR ACTRA TYPE 2404A              
*              COMMERCIALS                                                      
         SPACE 1                                                                
REA04AUS NTR1  BASE=*,LABEL=*                                                   
         OC    INV04A,INV04A       IF GENERATING TWO INVOICES FOR               
         JZ    XIT                 ACTRA TYPE 2404A COMMERCIAL                  
         SPACE 1                                                                
         LA    R1,ITOTS            R1=A(INVOICE TOTALS)                         
         LA    RF,CTOTS            RF=A(CANADIAN TOTALS)                        
         LA    R0,NTCTOTS          R0=N'ACCUMS                                  
         SPACE 1                                                                
R04AUS10 L     RE,0(R1)            US$ TOTALS                                   
         A     RE,0(RF)            PLUS THE CANADIAN TOTALS                     
         ST    RE,0(R1)            IS INVOICE TOTAL                             
         SPACE 1                                                                
         LA    R1,4(R1)            BUMP TO NEXT US$ TOTAL                       
         LA    RF,4(RF)            AND TO NEXT CANADIAN TOTAL                   
         BCT   R0,R04AUS10                                                      
         J     XIT                                                              
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*              ROUTINE TO VALIDATE ESTIMATE BY JOB RECORDS                      
*                                                                               
         USING TLJBD,R4            SEE IF VALID BUSINESS UNIT                   
VALJOB   NTR1  BASE=*,LABEL=*                                                   
         XC    WORK2,WORK2         SAVE CLIENT AND PRODUCT                      
******** OC    TGJWBUNT,TGJWBUNT                                                
******** BNZ   VJOB100                                                          
         MVC   WORK2(L'TGCLI),TGCLI                                             
         MVC   WORK2+L'TGCLI(L'TGPRD),TGPRD                                     
*                                                                               
VJOB100  TM    LCLSTAT2,JOBERR     TEST ERROR PENDING                           
         BZ    VJOB200                                                          
         NI    1(R2),X'F7'         RETURN FIELD TO NORM INTENSITY               
         OI    6(R2),X'80'                                                      
         TM    4(R2),X'20'         RE-VALIDATE IF NOT VALID                     
         BZ    VJOB200                                                          
*                                                                               
         CLI   PFAID,20            PF20 REQUIRED                                
         BNE   VJJINV                                                           
         NI    LCLSTAT2,ALL-JOBERR CLEAR JOB ERROR BIT                          
         OI    LCLSTAT2,JOBOVRER   SET OVERRODE JOB ERROR BIT                   
         B     VJX                                                              
*                                                                               
VJOB200  TM    4(R2),X'20'         DON'T BOTHER IF PREV. VALIDATED              
         BO    VJX                                                              
         NI    LCLSTAT2,ALL-JOBERR-JOBOVRER CLEAR JOB VALIDATION BITS           
*                                                                               
         CLI   5(R2),0             INPUT REQUIRED                               
         BNE   VJOB210                                                          
         BRAS  RE,JOBREQ                                                        
         B     VJX                                                              
*                                                                               
VJOB210  MVC   TGDATE,TGTODAY1     READ JOB RECORDS FOR AGENCY/DATE             
         OC    TGJWBUNT,TGJWBUNT   AGENCY USING JWT PROJECT IDS                 
         BNZ   VJOB215             YES, DON'T CLEAR CLI/PRD                     
         TM    TGAYSTA7,TAAYSBBD                                                
         BO    VJOB215                                                          
         XC    TGCLI,TGCLI                                                      
         XC    TGPRD,TGPRD                                                      
         B     VJOB233                                                          
*                                                                               
VJOB215  OC    8(16,R2),SPACES     JWT PROJECT                                  
                                                                                
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         MVI   TLJBCD,TLJBCDQ                                                   
         MVI   TLJBSPCL,TLJBSPJW                                                
         TM    TGAYSTA7,TAAYSBBD                                                
         BZ    VJOB216                                                          
         MVI   TLJBSPCL,TLJBSPBD                                                
         MVC   TLJBPROJ,8(R2)                                                   
         OC    TLJBPROJ,SPACES                                                  
         B     VJOB219                                                          
*                                                                               
VJOB216  ZIC   R1,5(R2)            R1=LENGTH OF INPUT                           
         CHI   R1,15               15-16 CHARACTERS ONLY                        
         BNL   VJOB218                                                          
         BRAS  RE,JOBNEX                                                        
                                                                                
VJOB218  LA    R1,7                JOB LENGTH                                   
*                                                                               
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   TLJBPRJI(0),8(R2)   LOOKUP JWT PROJECT ONLY FIRST                
         OC    TLJBPRJI,SPACES                                                  
VJOB219  GOTO1 HIGH                SEE IF JWT PROJECT ID EXISTS                 
         TM    TGAYSTA7,TAAYSBBD                                                
         BZ    VJOB219C                                                         
         CLC   KEY(TLJBDAT-TLJBD),KEYSAVE                                       
         BNE   VJOB230                                                          
         J     XIT                                                              
*                                                                               
VJOB219C CLC   KEY(TLJBDATE-TLJBD),KEYSAVE                                      
         BNE   VJOB230             NO, LET USER OVERRIDE                        
*&&DO                                                                           
         CLI   5(R2),7             ONLY JOB ENTERED                             
         BH    VJOB2220            NO, MORE THAN JUST JOB ENTERED               
         MVC   15(L'TLJBCSTI,R2),TLJBCSTI    FILL IN REST IN EST FIELD          
         MVC   21(L'TLJBPRDI,R2),TLJBPRDI                                       
         MVI   5(R2),16            NEW LENGTH OF EST FIELD                      
         OI    6(R2),X'80'         TRANSMIT                                     
         J     XIT                 THAT'S ALL FOR JWT PROJECTS                  
*&&                                                                             
VJOB220  CLC   TLJBCSTI,15(R2)     MUST MATCH WHOLE EST FIELD                   
         BNE   VJOB230                                                          
         CLC   TLJBPRDI,21(R2)                                                  
         JE    XIT                                                              
*                                                                               
VJOB230  CLI   PFAID,20            PF20 CAN OVERRIDE JOB VALIDATION             
         JE    XIT                                                              
         BRAS  RE,JOBJNC                                                        
         J     XIT                                                              
*                                                                               
VJOB233  CLC   TGAGY,=C'2071  '    IF AGENCY IS 2071                            
         BNE   VJOB236                                                          
         MVC   TGAGY,=C'4937  '    LOOK FOR JOB UNDER 4937                      
         GOTO1 RECVAL,DMCB,TLJBCDQ,0                                            
         MVC   TGAGY,=C'2071  '                                                 
         B     VJOB240                                                          
*                                                                               
VJOB236  CLC   TGAGY,=C'1073  '    IF AGENCY IS 1073                            
         BNE   VJOB236A                                                         
         MVC   TGAGY,=C'DWNY  '    LOOK FOR JOB UNDER DWNY                      
         GOTO1 RECVAL,DMCB,TLJBCDQ,0                                            
         MVC   TGAGY,=C'1073  '                                                 
         B     VJOB240                                                          
*                                                                               
VJOB236A CLC   TGAGY,=C'9325  '    IF AGENCY IS 9325                            
         BNE   VJOB237                                                          
         MVC   TGAGY,=C'DWLA  '    LOOK FOR JOB UNDER DWLA                      
         GOTO1 RECVAL,DMCB,TLJBCDQ,0                                            
         MVC   TGAGY,=C'9325  '                                                 
         BE    VJOB240                                                          
                                                                                
         MVC   TGAGY,=C'DWNY  '    IF NOT FOUND, LOOK UNDER DWNY                
         GOTO1 RECVAL,DMCB,TLJBCDQ,0                                            
         MVC   TGAGY,=C'9325  '                                                 
         B     VJOB240                                                          
*                                                                               
VJOB237  CLC   TGAGY,=C'9032  '    IF AGENCY IS 9032                            
         BNE   VJOB238             FIND JOB UNDER 9032 FIRST                    
         GOTO1 RECVAL,DMCB,TLJBCDQ,(X'04',0)  RETURN WITH ERRORS                
         BE    VJOB240                                                          
*                                                                               
         MVC   TGAGY,=C'DWNY  '    IF NOT FOUND, LOOK UNDER DWNY                
         GOTO1 RECVAL,DMCB,TLJBCDQ,0                                            
         MVC   TGAGY,=C'9032  '                                                 
         B     VJOB240                                                          
*                                                                               
VJOB238  CLC   TGAGY,=C'DWLA  '    IF AGENCY IS DWLA                            
         BNE   VJOB239             FIND JOB UNDER DWLA FIRST                    
         GOTO1 RECVAL,DMCB,TLJBCDQ,(X'04',0)  RETURN WITH ERRORS                
         BE    VJOB240                                                          
*                                                                               
         MVC   TGAGY,=C'DWNY  '    IF NOT FOUND, LOOK UNDER DWNY                
         GOTO1 RECVAL,DMCB,TLJBCDQ,0                                            
         MVC   TGAGY,=C'DWLA  '                                                 
         B     VJOB240                                                          
*                                                                               
VJOB239  GOTO1 RECVAL,DMCB,TLJBCDQ,0                                            
VJOB240  CLC   KEY(TLJBCLI-TLJBD),KEYSAVE IF NONE FOR TODAY'S DATE              
         BE    VJOB250                                                          
         CLC   KEY(TLJBDTE-TLJBD),KEYSAVE BUT EARLIER DATE FOR AGENCY           
         BE    VJOB245                                                          
         BRAS  RE,JOBNEX                                                        
         B     VJX                                                              
VJOB245  MVC   TGDATE,KEY+TLJBDTE-TLJBD   USE THAT DATE                         
         XC    TGDATE,=X'FFFFFF'                                                
         SPACE 1                                                                
VJOB250  LA    R3,8(R2)            R3=A(INPUT)                                  
         ZIC   R1,5(R2)            R1=LENGTH OF INPUT                           
*                                                                               
         CLC   5(1,R2),LENGTHS+2   IF INPUT IS JOB ONLY                         
         BH    VJOB300                                                          
         TM    AGYSTAT5,TAAYBUSU   IF BUSINESS UNIT, ASSUME ALL                 
         BO    VJOB300                                                          
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   WORK2+12(0),0(R3)   SAVE IT                                      
         OC    WORK2,SPACES                                                     
         EX    R1,*+8                                                           
         B     *+10                                                             
         XC    0(0,R3),0(R3)       CLEAR FIELD                                  
         MVC   TGCLI,WORK2         RESTORE CLIENT & PRODUCT                     
         MVC   TGPRD,WORK2+L'TGCLI                                              
         CLC   TGPRD,SPACES                                                     
         BNE   *+10                                                             
         XC    TGPRD,TGPRD                                                      
*                                                                               
         ZIC   R1,LENGTHS          AND RE-DISPLAY AS CLIENTPRODJOB              
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),TGCLI                                                    
         LA    R3,1(R1,R3)                                                      
         ZIC   R1,LENGTHS+1                                                     
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),TGPRD                                                    
         LA    R3,1(R1,R3)                                                      
         ZIC   R1,LENGTHS+2                                                     
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),WORK2+12                                                 
         LA    R3,1(R1,R3)                                                      
         LA    R1,8(R2)                                                         
         SR    R3,R1                                                            
         STC   R3,5(R2)            SET INPUT LENGTH                             
         OI    6(R2),X'80'         AND TRANSMIT                                 
         B     VJOB400                                                          
         SPACE 1                   ELSE, ASSUME CLIENTPRODUCTJOB                
VJOB300  ZIC   RE,LENGTHS          CHECK LEN EQUAL TO SETUP LENGTH              
         ZIC   RF,LENGTHS+1                                                     
         AR    RE,RF                                                            
         ZIC   RF,LENGTHS+2                                                     
         AR    RE,RF                                                            
         CR    R1,RE                                                            
         BNH   VJOB350             SAATCHI MAY NOT FILL UP JOB LENGTH           
         BRAS  RE,JOBNEX                                                        
         B     VJX                                                              
*                                                                               
VJOB350  ZIC   R1,LENGTHS                                                       
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   TGCLI(0),0(R3)                                                   
         OC    TGCLI,SPACES                                                     
         LA    R3,1(R1,R3)                                                      
         ZIC   R1,LENGTHS+1                                                     
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   TGPRD(0),0(R3)                                                   
         OC    TGPRD,SPACES                                                     
         LA    R3,1(R1,R3)                                                      
         ZIC   R1,LENGTHS+2                                                     
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   WORK2+12(0),0(R3)                                                
         OC    WORK2,SPACES                                                     
*                                                                               
VJOB400  MVC   WORK(L'TGCLI),TGCLI                                              
         TM    AGYSTAT5,TAAYBUSU   BUSINESS UNIT PART OF CLIENT                 
         BZ    VJOB460             NOT SAATCHI                                  
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         MVI   TLJBCD,TLJBCDQ                                                   
         MVC   TLJBAGY,TGAGY                                                    
*                                                                               
         CLC   TLJBAGY,=C'2071  '  IF AGENCY IS 2071                            
         BNE   VJOB420                                                          
         MVC   TLJBAGY,=C'4937  '  LOOK FOR JOB UNDER 4937                      
         B     VJOB430                                                          
*                                                                               
VJOB420  CLC   TLJBAGY,=C'1073  '  IF AGENCY IS 2071                            
         BNE   VJOB430                                                          
         MVC   TLJBAGY,=C'DWNY  '  LOOK FOR JOB UNDER 4937                      
         B     VJOB430                                                          
*                                                                               
VJOB430  MVC   TLJBDTE,TGDATE                                                   
         XC    TLJBDTE,=X'FFFFFF'                                               
         MVC   TLJBCLI(3),TGCLI                                                 
         GOTO1 HIGH                                                             
         CLC   KEY(TLJBCLI-TLJBD+3),KEYSAVE                                     
         BE    VJOB440             BUSINESS UNIT NOT FOUND                      
         CLC   TLJBAGY,=C'DWLA  '  IF AGENCY IS DWLA                            
         BNE   VJOB435                                                          
         MVC   TLJBAGY,=C'DWNY  '  TRY AGAIN WITH DWNY                          
         B     VJOB430                                                          
*                                                                               
VJOB435  BRAS  RE,JOBNEX                                                        
         B     VJX                                                              
*                                                                               
VJOB440  MVC   TGCLI,SPACES        JUST CLIENT W/O BUS UNIT                     
         MVC   TGCLI(3),WORK+3                                                  
         GOTO1 RECVAL,DMCB,TLCLCDQ,(X'A0',0)                                    
         BNE   VJOB460             NOT FOUND, REGULAR VALIDATION                
*                                                                               
         L     R4,AIO                                                           
         MVI   ELCODE,TABRELQ      BILLING RULES HAS NOINT STATUS               
         BRAS  RE,GETEL                                                         
         BNE   VJOB460                                                          
         USING TABRD,R4                                                         
         TM    TABRSTAT,TABRSNIN   TEST NO INTERFACE                            
         BZ    VJOB460             ON INTERFACE, REGULAR VALIDATION             
*                                                                               
VJOB450  MVC   TGCLI,WORK2         RESTORE CLIENT & PRODUCT                     
         MVC   TGPRD,WORK2+L'TGCLI                                              
         CLC   TGPRD,SPACES                                                     
         BNE   *+10                                                             
         XC    TGPRD,TGPRD                                                      
         B     VJX                                                              
*                                                                               
VJOB460  MVC   TGCLI,WORK                                                       
*                                                                               
         CLC   TGAGY,=C'2071  '    IF AGENCY IS 2071                            
         BNE   VJOB465                                                          
         MVC   TGAGY,=C'4937  '    LOOK FOR JOB UNDER 4937                      
         GOTO1 RECVAL,DMCB,TLJBCDQ,(X'A0',0)                                    
         MVC   TGAGY,=C'2071  '                                                 
         B     VJOB490                                                          
*                                                                               
VJOB465  CLC   TGAGY,=C'1073  '    IF AGENCY IS 1073                            
         BNE   VJOB468                                                          
         MVC   TGAGY,=C'DWNY  '    LOOK FOR JOB UNDER 4937                      
         GOTO1 RECVAL,DMCB,TLJBCDQ,(X'A0',0)                                    
         MVC   TGAGY,=C'1073  '                                                 
         B     VJOB490                                                          
*                                                                               
VJOB468  CLC   TGAGY,=C'9325  '    IF AGENCY IS 9325                            
         BNE   VJOB469                                                          
         MVC   TGAGY,=C'DWLA  '    LOOK FOR JOB UNDER DWLA                      
         GOTO1 RECVAL,DMCB,TLJBCDQ,(X'A4',0)                                    
         MVC   TGAGY,=C'9325  '                                                 
         BE    VJOB490                                                          
                                                                                
         MVC   TGAGY,=C'DWNY  '    IF NOT FOUND, LOOK UNDER DWNY                
         GOTO1 RECVAL,DMCB,TLJBCDQ,(X'A0',0)                                    
         MVC   TGAGY,=C'9325  '                                                 
         B     VJOB490                                                          
                                                                                
VJOB469  CLC   TGAGY,=C'9032  '    IF AGENCY IS 9032                            
         BNE   VJOB470                                                          
         GOTO1 RECVAL,DMCB,TLJBCDQ,(X'A4',0)                                    
         BE    VJOB490                                                          
         MVC   TGAGY,=C'DWNY  '    LOOK FOR JOB UNDER DWNY                      
         GOTO1 RECVAL,DMCB,TLJBCDQ,(X'A0',0)                                    
         MVC   TGAGY,=C'9032  '                                                 
         B     VJOB490                                                          
*                                                                               
VJOB470  CLC   TGAGY,=C'DWLA  '    IF AGENCY IS DWLA                            
         BNE   VJOB480             FIND JOB UNDER DWLA FIRST                    
         GOTO1 RECVAL,DMCB,TLJBCDQ,(X'A4',0)  RETURN WITH ERRORS                
         BE    VJOB490                                                          
*                                                                               
         MVC   TGAGY,=C'DWNY  '    IF NOT FOUND, LOOK UNDER DWNY                
         GOTO1 RECVAL,DMCB,TLJBCDQ,(X'A0',0)                                    
         MVC   TGAGY,=C'DWLA  '                                                 
         B     VJOB490                                                          
*                                                                               
VJOB480  GOTO1 RECVAL,DMCB,TLJBCDQ,(X'A0',0)                                    
VJOB490  BE    VJOB500                                                          
         BRAS  RE,JOBNEX                                                        
         B     VJX                                                              
*                                                                               
VJOB500  XC    WORK,WORK           VALIDATE JOB CODE                            
         MVC   WORK+1(6),WORK2+12                                               
         MVI   ELCODE,TAGLELQ                                                   
         GOTO1 GETL,DMCB,(7,WORK)                                               
         BE    VJOB450                                                          
         GOTO1 SEQ                 CHECK FOR A CONTINUATION REC                 
         CLC   KEY(TLJBSEQ-TLJBKEY),KEYSAVE                                     
         BE    VJOB600                                                          
         BRAS  RE,JOBJNC                                                        
         BNE   VJX                                                              
         OI    LCLSTAT2,JOBOVRER   SET OVERRODE JOB ERROR BIT                   
         B     VJX                                                              
VJOB600  GOTO1 GETREC                                                           
         B     VJOB500                                                          
*                                                                               
VJX      MVC   TGCLI,WORK2         RESTORE CLIENT & PRODUCT                     
         MVC   TGPRD,WORK2+L'TGCLI                                              
         CLC   TGPRD,SPACES                                                     
         JNE   XIT                                                              
         XC    TGPRD,TGPRD                                                      
         J     XIT                                                              
*                                                                               
VJJINV   OI    1(R2),X'08'         SET FIELD TO HIGH INTENSITY                  
         OI    4(R2),X'20'         SET PREVIOUSLY VALIDATED                     
         OI    6(R2),X'80'                                                      
         J     JOBINV                                                           
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*              ROUTINE TO SET N'CHECK WITHHOLDING ELEMENTS REQUIRED             
         SPACE 1                                                                
SETNTACW NTR1  BASE=*,LABEL=*                                                   
         XR    R3,R3               R3=COUNT                                     
         L     R4,AIO3             R4=A(W4 RECORD)                              
         MVI   ELCODE,TAW4ELQ      LOOK FOR W4 DETAILS ELEMENT                  
         BRAS  RE,GETEL                                                         
         BNE   SNCWX                                                            
         USING TAW4D,R4                                                         
         MVC   TCW4TYPE,TAW4TYPE   SAVE TYPE                                    
         MVC   TCW4STA3,TAW4STA3   AND STATUS 3                                 
         SPACE                                                                  
***AS PER TOM 07/03/03                                                          
         CLI   TWASCR,SCR96        IF CAST SELECT SCREEN                        
         BE    SNCW1               DON'T PRINT W4 LOCAL                         
         SPACE                                                                  
*        TM    TGUSXUNI,AFM        TEST MUSIC PAYMENT                           
         GOTO1 UNITEST,DMCB,TGUSXUNS,AFM,0,0,0                                  
         BO    SNCW1                                                            
         CLI   TGYREQU,CN91        IF 91 CONTRACT OR LATER                      
         BL    SNCW1                                                            
         OC    TGLCL,TGLCL         AND THERE'S A GLOBAL LOCAL                   
         BZ    SNCW1                                                            
         OC    TAW4LOCL,TAW4LOCL   AND IF THERE'S LOCAL ON W4                   
         BZ    *+10                                                             
         MVC   TGLCL,TAW4LOCL      SAVE AS GLOBAL LOCAL                         
         SPACE                                                                  
SNCW1    CLI   TCW4TYPE,TAW4TYCA   IF PAYING CANADIAN                           
         BE    *+12                                                             
         CLI   TCW4TYPE,TAW4TYCO   OR CORPORATION                               
         BNE   SNCW1X                                                           
         LA    R4,ELTACO           ON US$ ACTRA PAYMENT                         
         USING TACOD,R4                                                         
         TM    TACOSTAT,TACOSCAN                                                
         BO    SNCW1A                                                           
         CLI   TGUNEQU,ACT                                                      
         BNE   SNCW1A                                                           
         MVI   ELCODE,TANUELQ                                                   
         MVC   AIO,AIO3            AND W4 HAS GST NUMBER                        
         GOTO1 GETL,DMCB,(1,=AL1(TANUTGST))                                     
         MVC   AIO,AIO1                                                         
         BNE   SNCW1A                                                           
         AHI   R3,1                NEED ELEMENT FOR CN                          
SNCW1A   LA    R4,ELTACA           R4=A(CAST DETAILS ELEMENT)                   
         USING TACAD,R4                                                         
         CLI   TACACORP,C' '       TEST PAYING AS CORPORATION                   
         BNH   SNCWX                                                            
         MVI   TCW4TYPE,TAW4TYCO   SET CORPORATION TYPE                         
         B     SNCWX               AND SKIP                                     
         SPACE 1                                                                
SNCW1X   LA    R4,ELTACA           R4=A(CAST DETAILS ELEMENT)                   
         USING TACAD,R4                                                         
         CLI   TACACORP,C' '       TEST PAYING AS CORPORATION                   
         BNH   *+12                                                             
         MVI   TCW4TYPE,TAW4TYCO   SET CORPORATION TYPE                         
         B     SNCWX               AND SKIP                                     
         SPACE 1                                                                
         CLI   TCW4TYPE,TAW4TYFO   GET OUT IF PAYING FOREIGNER                  
         BE    SNCWX                                                            
         SPACE 1                                                                
         MVC   WORK(6),SPACES      CLEAR RESIDENT TAX INFO SAVE AREA            
         L     R4,AIO3                                                          
         MVI   ELCODE,TAWHELQ      LOOK FOR WITHHOLDING ELEMENTS                
         BRAS  RE,GETEL                                                         
         B     *+8                                                              
SNCW2    BRAS  RE,NEXTEL                                                        
         BNE   SNCW6                                                            
         USING TAWHD,R4                                                         
         CLC   TAWHEMP,EOR         FILTER ON EMPLOYER                           
         BNE   SNCW2                                                            
         SPACE                                                                  
         CLC   TAWHUNIT,=C'FD '    IF NOT FEDERAL                               
         BE    SNCW4                                                            
         CLI   TAWHUNIT+2,C' '     TEST FOR STATE                               
         BNE   *+14                                                             
         MVC   WORK(3),TAWHUNIT    SAVE IN WORK(3)                              
         B     SNCW4                                                            
         MVC   WORK+3(3),TAWHUNIT  ELSE MUST BE CITY - SAVE IN WORK+3           
SNCW4    AHI   R3,1                BUMP ONE FOR EACH FOUND                      
         B     SNCW2                                                            
         SPACE 1                                                                
SNCW6    LA    R4,ELTACA           R4=A(CAST DETAILS ELEMENT)                   
         USING TACAD,R4                                                         
         GOTO1 TAXVAL,DMCB,(3,TACAUNIT) LOOK UP WORK TAX UNIT CODE              
         SPACE 1                                                                
         CLC   TGTASTCY,WORK       TEST SOW=SOR                                 
         BE    *+8                                                              
         AHI   R3,1                NO, SO NEED ANOTHER EL.                      
         CLI   TGTACODE+2,C' '     IF WORKING IN A CITY                         
         BE    SNCWX                                                            
         CLC   TGTACODE,WORK+3     TEST COW=COR                                 
         BE    *+8                                                              
         AHI   R3,1                NO, SO NEED ANOTHER EL.                      
         SPACE 1                                                                
SNCWX    STC   R3,NTACWS           SAVE N'CHECK WITHHOLDING ELS REQ'D           
         J     XIT                                                              
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*              ROUTINE TO ADD FIXED CYC TRACKING REQ DETAILS ELEMENT(S)         
*              USING FQTABLE IN TEMPORARY STORAGE                               
         SPACE 1                                                                
ADDFQELS NTR1  BASE=*,LABEL=*                                                   
         L     R2,ATMPPAYD         TABLE IN TEMPORARY STORAGE                   
         USING TMPPAYD,R2                                                       
         LA    R2,FQTABLE          R2=A(ENTRY IN FQTABLE)                       
         LA    R0,NFQTAB           R0=MAX N'ENTRIES                             
         SPACE                                                                  
ADDFQ2   XC    ELEMENT,ELEMENT     BUILD FTRACK REQUEST DET ELEM                
         LA    R4,ELEMENT                                                       
         USING TAFQD,R4                                                         
         LA    R4,TAFQSBEL         R4=A(NEXT SUB ELEMENT)                       
         USING TAFQSBEL,R4                                                      
         XR    R1,R1               R1=N'SUB ELEMENTS                            
         LA    RF,TAFQLNQ          RF=CUMULATIVE L'ELEMENT                      
         SPACE                                                                  
ADDFQ4   CLI   0(R2),0             IF NOT END OF ENTRIES                        
         BE    ADDFQ6                                                           
         LA    RE,L'TAFQSBEL(RF)                                                
         CHI   RE,254                                                           
         BH    ADDFQ6                                                           
         MVC   TAFQSBEL,0(R2)      MOVE INFO TO SUB ELEMENT                     
         LA    R1,1(R1)            INCREMENT COUNT OF SUB ELEMENTS              
         LA    R2,L'TAFQSBEL(R2)   BUMP TO NEXT ENTRY                           
         LA    R4,L'TAFQSBEL(R4)   BUMP TO NEXT SUB ELEMENT                     
         LA    RF,L'TAFQSBEL(RF)                                                
         BCT   R0,ADDFQ4                                                        
         SPACE                                                                  
ADDFQ6   OC    ELEMENT,ELEMENT     IF ANYTHING IN ELEMENT                       
         JZ    XIT                                                              
         LA    R4,ELEMENT          R4=A(ELEMENT)                                
         USING TAFQD,R4                                                         
         MVI   TAFQEL,TAFQELQ      ELEMENT CODE                                 
         STC   RF,TAFQLEN          L'ELEMENT                                    
         STC   R1,TAFQNUM          N'SUB ELEMENTS                               
         GOTO1 ADDL                ADD ELEMENT TO RECORD                        
         SPACE                                                                  
         LTR   R0,R0               IF NOT END OF TABLE                          
         JZ    XIT                                                              
         B     ADDFQ2              LOOK FOR MORE                                
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*              ROUTINE BUILDS A DUMMY UH ELEM IN TCTAUHEL USING R4              
         SPACE                                                                  
         USING TAUHD,R4                                                         
BLDUHEL  NTR1  BASE=*,LABEL=*                                                   
         LA    R4,TCTAUHEL         SET R4=A(TCTAUHEL)                           
         XC    TCTAUHEL,TCTAUHEL   CLEAR USE DETAILS                            
         MVI   TAUHEL,TAUHELQ      ELEMENT CODE                                 
         MVI   TAUHLEN,TAUHLNQ     LENGTH                                       
         MVC   TAUHTYPE,TGUSTYP    USE TYPE                                     
         MVC   TAUHSTRT(6),TCPCYCS CYCLE START/END                              
         J     XIT                                                              
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*              ROUTINE TO GET BILLING RULES                                     
         SPACE 1                                                                
GETRULES NTR1  BASE=*,LABEL=*                                                   
         MVI   ELCODE,TABRELQ      GET BILLING RULES ELEMENT                    
         L     R4,AIO                                                           
         BRAS  RE,GETEL                                                         
         JNE   XIT                                                              
         USING TABRD,R4                                                         
         TM    TABRSTAT,TABRSINT   TEST ON PRODUCTION INTERFACE                 
         BZ    *+8                                                              
         MVI   INTER,C'Y'          SET LOCAL SWITCH                             
         SPACE 1                                                                
         TM    TABRSTAT,TABRSCIN   TEST CLIENT LEVEL INTRFACE (AGENCY)          
         BZ    *+8                                                              
         MVI   INTER,C'C'          SET LOCAL SWITCH                             
         SPACE 1                                                                
         TM    TABRSTAT,TABRSNIN   TEST NOT ON PROD. INTRFACE (CLIENTS)         
         BZ    *+8                                                              
         MVI   INTER,C'N'          SET LOCAL SWITCH                             
         SPACE 1                                                                
         OC    TABROEOR,TABROEOR   IF OVERRIDE EMP-OF-RECORD EXISTS             
         BZ    *+10                                                             
         MVC   EOR,TABROEOR        THEN USE IT                                  
         SPACE 1                                                                
         CLI   TABRTYPE,0          IF THERE'S A BILLING TYPE                    
         BE    *+16                                                             
         MVC   BILLTYPE,TABRTYPE   THEN USE IT                                  
         MVC   TGBTYPE,TABRTYPE                                                 
         SPACE 1                                                                
         CLI   TGUSEQU,UPAX        IF PAX USE, NETWORK NOT REQUIRED             
         JE    XIT                                                              
         TM    TABRSTAT,TABRSNWK   IF NETWORK REQUIRED FOR CLA USES             
         JZ    XIT                                                              
         MVI   NWKREQ,C'Y'         SET LOCAL SWITCH                             
         J     XIT                                                              
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*              ROUTINE TO GET LCB USAGE HISTORY RECORD IF NONE                  
*              FOUND FOR CABLE                                                  
*              SETS CC EQUAL IF FINDS UH, ELSE CC NOT EQ                        
         SPACE 1                                                                
TRYLCB   NTR1  BASE=*,LABEL=*                                                   
         USING TLUHD,R3                                                         
         TM    TGUSSTA3,CBLUSE     TEST USE IS CABLE OR SPANISH CABLE           
         JZ    NO                                                               
         MVC   KEY,KEYSAVE                                                      
         MVC   TLUHUSE,=C'LCB'     LOOK FOR LOCAL CABLE HISTORY                 
         GOTO1 HIGH                GET DIRECTORY RECORD                         
         SPACE 1                                                                
         CLC   TLUHKEY(TLUHINV-TLUHD),KEYSAVE  DID WE FIND REC FOR USE          
         JE    YES                 SET CC                                       
         J     NO                                                               
         DROP  R3                                                               
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*              ROUTINE TO SET UNITS/SUBSCRIBERS TO BE PAID                      
*              FOR A PARTICULAR CAST MEMBER                                     
*              ON ENTRY ... R4=A(CAST'S USAGE HISTORY ELEMENT)                  
         SPACE 1                                                                
         USING TAUHD,R4                                                         
STCSTUNT NTR1  BASE=*,LABEL=*                                                   
         TM    PAYSTAT1,OVERMKTS EXIT IF CNET/MKT/CSYS INPUT                    
         JNZ   NO                IS BEING OVERRIDDEN                            
         CLI   TWASCR,SCR96      OR IF ON CAST SELECT SCREEN                    
         JE    NO                                                               
         SPACE 1                                                                
         XC    TCUNITS,TCUNITS   CLEAR UNITS AND SUBSCRIBERS                    
         XC    TCSUBS,TCSUBS     FOR THIS INDIVIDUAL CAST MEMBER                
         SPACE 1                                                                
         CLI   TGUSEQU,ULCB      IF PAYING LOCAL CABLE                          
         BNE   SCU10                                                            
         MVC   TCSUBS,TAUHSUBS   SET PREVIOUS SUBSCRIBERS PAID                  
         GOTO1 LCBTYPE           AND PREVIOUS TYPE                              
         B     SCU20                                                            
         SPACE 1                                                                
SCU10    STH   R3,TCUNITS        ELSE, SET PREVIOUS UNITS PAID                  
         SPACE 1                                                                
         TM    TGUSSTA3,CBLUSE   IF PAYING CABLE OR SPANISH CABLE               
         BZ    SCU20                                                            
         MVC   TCSUBS,TAUHCSUB   ALSO SET PREVIOUS SUBSCRIBERS PAID             
         DROP  R4                                                               
         SPACE 1                                                                
SCU20    GOTO1 ADJTBCST                                                         
         SPACE 1                                                                
         USING MKTTABLD,R3                                                      
         L     R3,AIO3                                                          
         AHI   R3,L'CASTHEAD                                                    
         SPACE 1                                                                
         MVI   TGMTTYPE,TANPNET  SET TO READ CNET RECORDS                       
         TM    TGUSSTA3,CBLUSE   FOR CABLE AND SPANISH CABLE                    
         BNZ   SCU160                                                           
         MVI   TGMTTYPE,C'S'     READ CSYS RECORDS                              
         CLI   TGUSEQU,ULCB      FOR LOCAL CABLE                                
         BE    SCU160                                                           
         MVI   TGMTTYPE,C'T'     OTHERWISE READ TMKT FOR TELEVISION             
         CLI   TGMEEQU,RADIO                                                    
         BNE   SCU160                                                           
         MVI   TGMTTYPE,C'R'     OR RMKT FOR RADIO                              
         SPACE 1                                                                
SCU160   CLI   MTCODE,X'FF'      READ MKT/CNET/CSYS RECORDS FOR                 
         BE    SCU240            CURRENT INVOICE THAT WERE NOT                  
         TM    MTSTAT,MTNOCALC   ALREADY PAID                                   
         BNZ   SCU230                                                           
         LHI   RF,TLMTCDQ                                                       
         BRAS  RE,USEALPH                                                       
         BNE   *+8                                                              
         LHI   RF,TLMTALDQ                                                      
         GOTO1 RECVAL,DMCB,(RF),(X'A4',MTCODE)                                  
         BE    SCU170                                                           
         SPACE 1                                                                
         CLI   TGMTTYPE,TANPNET  IF PAYING CABLE OR SPANISH CABLE               
         BNE   SCU230            AND CNET NOT FOUND, SEE IF CODE                
         MVI   TGMTTYPE,C'S'                    EXISTS AS A CSYS                
         GOTO1 RECVAL,DMCB,TLMTCDQ,(X'A4',MTCODE)                               
         MVI   TGMTTYPE,TANPNET                                                 
         BNE   SCU230                                                           
         B     SCU220                                                           
         SPACE 1                                                                
         USING TAMSD,R4                                                         
SCU170   L     R4,AIO            ACCUMULATE UNITS/SUBSCRIBERS FROM              
         MVI   ELCODE,TAMSELQ    MKT/CNET/CSYS RECORD IN UNITS/                 
         BRAS  RE,GETEL          SUBSCRIBERS ACCUMULATOR                        
         B     *+8                                                              
SCU180   BRAS  RE,NEXTEL                                                        
         BE    SCU190                                                           
         CLI   TGUSEQU,USWS      IF SPANISH WEIGHT ELEMENT NOT                  
         BNE   SCU230            FOUND AND PAYING SPANISH WILDSPOT              
         LH    RE,TCUNITS        USE DEFAULT WEIGHT OF 1                        
         AHI   RE,1                                                             
         STH   RE,TCUNITS                                                       
         B     SCU230                                                           
SCU190   CLI   TGUSEQU,ULCB                                                     
         BE    SCU210                                                           
         CLI   TGUSEQU,USWS                                                     
         BNE   SCU200                                                           
         CLI   TAMSTYPE,C'S'                                                    
         BNE   SCU180                                                           
SCU200   LH    RE,TCUNITS                                                       
         A     RE,TAMSWGHT                                                      
         STH   RE,TCUNITS                                                       
         B     SCU230                                                           
SCU210   ZICM  RE,TCSUBS,4                                                      
         A     RE,TAMSWGHT                                                      
         STCM  RE,15,TCSUBS                                                     
         B     SCU230                                                           
         SPACE 1                                                                
SCU220   LH    RE,TCUNITS        IF CABLE OR SPANISH CABLE PAYMENT              
         AHI   RE,1              IS PAYING A CSYS                               
         STH   RE,TCUNITS        ADD ONE UNIT                                   
         L     R4,AIO            AND ADD CSYS'S SUBSCRIBERS                     
         MVI   ELCODE,TAMSELQ    TO SUBSCRIBER ACCUMULATOR                      
         BRAS  RE,GETEL                                                         
         BNE   SCU230                                                           
         ZICM  RF,TCSUBS,4                                                      
         A     RF,TAMSWGHT                                                      
         STCM  RF,15,TCSUBS                                                     
         DROP  R4                                                               
         SPACE 1                                                                
SCU230   LA    R3,MKTLNQ(R3)     BUMP TO NEXT MKT/CNET/CSYS ON                  
         B     SCU160            CURRENT INVOICE                                
         DROP  R3                                                               
         SPACE 1                                                                
*                                ALL WEIGHTS FROM THE CNET/MKT/CSYS             
*                                TABLE HAVE BEEN ACCUMULATED                    
         SPACE 1                                                                
         USING TAUHD,R4                                                         
SCU240   TM    TGUSSTA3,CBLUSE   IF PAYING CABLE OR SPANISH CABLE               
         JZ    YES                                                              
         OC    TCSUBS,TCSUBS     AND CSYS'S ARE BEING PAID                      
         JZ    YES                                                              
         XR    RE,RE             DIVIDE NUMBER OF SUBSCRIBERS BY                
         ZICM  RF,TCSUBS,4       350,000 AND ADD QUOTIENT TO                    
         D     RE,=F'350000'     UNIT COUNT                                     
         LR    R1,RF                                                            
         LA    R4,TCTAUHEL                                                      
         XR    RE,RE                                                            
         L     RF,TAUHCSUB                                                      
         D     RE,=F'350000'                                                    
         SR    R1,RF                                                            
         AH    R1,TCUNITS                                                       
         STH   R1,TCUNITS                                                       
         J     YES                                                              
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*              ROUTINE TO DETERMINE IF ALPHA CODE SHOULD BE USED TO             
*              READ FOR TMKT RECORDS                                            
         SPACE 1                                                                
USEALPH  NTR1  BASE=*,LABEL=*                                                   
         TM    TGMEEQU,LIKETV    IF PAYING TV, INTERNET, OR NEW MEDIA           
         JZ    NO                                                               
         TM    TGUSSTA3,CBLUSE   AND USE TYPE IS NOT CABLE                      
         JNZ   NO                OR SPANISH CABLE                               
         CLI   TGUSEQU,ULCB      OR LOCAL CABLE                                 
         JNE   YES                                                              
         J     NO                                                               
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE GET GUARANTEE RECORD AND SETS INFO BASED ON IT       *         
*        ON ENTRY ... R4=A(CAST DETAILS ELEMENT)                                
***********************************************************************         
                                                                                
         USING TACAD,R4            R4=A(CAST DET EL)                            
GETGUAR  NTR1  BASE=*,LABEL=*                                                   
         XC    TGGUA,TGGUA         CLEAR GUARANTEE CODE                         
         NI    TGGRTSTA,X'FF'-(TGGRTEAC+TGGRTEPD+TGGRTECP)                      
*                                                                               
         CLI   TACALEN,TACAGUA+L'TACAGUA-TACAD                                  
         JL    XIT                                                              
         OC    TACAGUA,TACAGUA     TEST IF GUARANTEE CODE PRESENT               
         JZ    XIT                                                              
         MVC   TGGUA,TACAGUA       SAVE GUARANTEE CODE IN GLOBAL                
         XC    TGGUA,HEXFFS2       AND COMPLEMENT IT                            
*                                                                               
         MVC   GQSTRT,TCIPCYCS                                                  
         TM    PAYOPTS4,OAGRTEND                                                
         JZ    GETGU10                                                          
         MVC   GQSTRT,TCIPCYCE                                                  
GETGU10  OC    GQSTRT,GQSTRT       SET PAYMENT APPLY DATE                       
         JNZ   GETGU15                                                          
         MVC   GQSTRT,TCPCYCS                                                   
         TM    PAYOPTS4,OAGRTEND                                                
         JZ    GETGU15                                                          
         MVC   GQSTRT,TCPCYCE                                                   
GETGU15  TM    PAYOPTS4,OAGRTEND                                                
         JZ    GETGU20                                                          
         OC    ACTCYCE,ACTCYCE                                                  
         JZ    GETGU20                                                          
         GOTOR ONCAINV,DMCB,ELTACA                                              
         JNE   GETGU20                                                          
         MVC   GQSTRT,ACTCYCE                                                   
GETGU20  BRAS  RE,STPLGEOP                                                      
*                                                                               
         MVC   AIO,AIO2            READ GUARANTEE RECORD INTO AIO2              
*                                                                               
         GOTO1 GUARVAL,DMCB,TACACORP,GQSTRT                                     
         MVC   AIO,AIO1                                                         
         JNE   GETGUERR                                                         
*                                                                               
         MVC   TGBYTE,TACACORP     SAVE CAST CORP CODE                          
         DROP  R4                                                               
*                                                                               
         USING TAGUD,R4                                                         
         L     R4,0(R1)            R4=A(GUARANTEE DETAILS ELEMENT)              
*                                                                               
         TM    TAGUSTA2,TAGUSMSC   MULTI-SERVICE CONTRACT?                      
         JZ    *+8                                                              
         OI    TGGRTSTA,TGGRTMSC                                                
*                                                                               
         BRAS  RE,EXCLUSE          DOES THIS USE APPLY AGAINST                  
         JE    XIT                 GUARANTEE? IF NO, EXIT                       
*                                                                               
         CLC   TAGUCRP,TGBYTE      TEST SAME CORP CODE                          
         JE    GETGU30                                                          
         OI    TGGRTSTA,TGGRTECP                                                
         J     GETGUERR                                                         
*                                                                               
GETGU30  OC    TAGUCOM,TAGUCOM     IF THIS IS PER CYCLE GUARANTEE               
         JZ    GETGUX                                                           
         OI    CASTSTAT,CSTGCOM    TURN ON PER CYC BIT FOR LATER                
*                                                                               
         TM    TGUSSTA2,APPREUSE   IF USE GETS APPLIED AGAINST REUSE            
         JZ    GETGU40                                                          
         CLC   TGCOM,TAGUCOM       AND WE'RE PAYING PRIMARY COMML               
         JNE   GETGUX                                                           
         OI    TCINPUT,TCINPRI     SET FIXED CYCLE PMT ON PRIMARY COMML         
         J     GETGUX              AND WE'RE DONE                               
*                                                                               
GETGU40  CLI   TGUSEQU,UDLR        IF USE IS DEALER                             
         JNE   GETGUX                                                           
         CLC   TGCOM,TAGUCOM       AND WE'RE PAYING PRIMARY COMML               
         JNE   GETGUX                                                           
         OI    TCCASTST,TCCADGPC   SET DEALER PMT ON PRIMARY COMML              
         J     GETGUX                                                           
         DROP  R4                                                               
*                                                                               
GETGUERR OI    CASTSTAT,CSTGERR                                                 
         MVC   GRTERROR,ERROR                                                   
         MVI   ERROR,0                                                          
*                                                                               
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    GETGUX                                                           
         LA    R2,ERAGCLG                                                       
         LA    R3,WORK+ERAGCLGP-ERAGCLG                                         
         LA    R4,ERAGCLG2                                                      
         TM    TGGRTSTA,TGGRTEAC   RETURN AGENCY/CLIENT ERROR                   
         JO    GETGUER2                                                         
         LA    R2,ERPERDG                                                       
         LA    R3,WORK+ERPERDGP-ERPERDG                                         
         LA    R4,ERPERDG2                                                      
         TM    TGGRTSTA,TGGRTEPD   PERIOD ERROR                                 
         JO    GETGUER2                                                         
         LA    R2,ERCORPG                                                       
         LA    R3,WORK+ERCORPGP-ERCORPG                                         
         LA    R4,ERCORPG2                                                      
         TM    TGGRTSTA,TGGRTECP   CORPORATION ERROR                            
         JO    GETGUER2                                                         
         LA    R2,ERERRGRT         OR GENERAL ERROR                             
         LA    R3,WORK+ERERRGRP-ERERRGRT                                        
GETGUER2 MVC   WORK,0(R2)                                                       
         GOTO1 SSNPACK,DMCB,TGSSN,(R3)                                          
         GOTOR ADDEAP,DMCB,WORK,0(R4),AWEBRES                                   
         MVI   TGGRTSTA,0                                                       
*                                                                               
GETGUX   TM    LCLSTAT3,SOAPRES    IF USE IS NOT A SOAP RESIDUAL                
         JO    XIT                                                              
         OC    SVCASTKY,SVCASTKY   AND IF THERE'S A SAVED CAST KEY              
         JZ    XIT                                                              
         MVC   KEY,SVCASTKY        RE-READ IT SO GETCAST CAN DO SEQ             
         GOTO1 HIGH                                                             
         J     XIT                                                              
*                                                                               
ERPERDG  DC    AL1(EPERDGX-*),AL2(ERRGPERD),AL1(ERRCATY1),AL1(D#PYCST)          
         DC    AL2(0)                                                           
         DC    CL48'Payment does not fit within guarantee cycle for '           
ERPERDGP DC    CL6' '                                                           
EPERDGX  EQU   *                                                                
*                                                                               
ERPERDG2 DC    AL1(EPERDG2X-*),AL2(ERRGPERD),AL1(ERRCATY1),AL1(D#PYCST)         
         DC    AL2(0)                                                           
         DC    C'Payment does not fit within guarantee cycle'                   
EPERDG2X EQU   *                                                                
*                                                                               
ERAGCLG  DC    AL1(EAGCLGX-*),AL2(ERRGAGCL),AL1(ERRCATY1),AL1(D#PYCST)          
         DC    AL2(0)                                                           
         DC    CL39'Commercial''s agency/client invalid for '                   
ERAGCLGP DC    CL6' '                                                           
         DC    CL12'''s guarantee'                                              
EAGCLGX  EQU   *                                                                
*                                                                               
ERAGCLG2 DC    AL1(EAGCLG2X-*),AL2(ERRGAGCL),AL1(ERRCATY1),AL1(D#PYCST)         
         DC    AL2(0)                                                           
         DC    C'Commercial''s agency/client invalid for guarantee'             
EAGCLG2X EQU   *                                                                
*                                                                               
ERCORPG  DC    AL1(ECORPGX-*),AL2(ERRGCORP),AL1(ERRCATY1),AL1(D#PYCST)          
         DC    AL2(0)                                                           
         DC    CL21'Corporation code for '                                      
ERCORPGP DC    CL6' '                                                           
         DC    CL25' does not match guarantee'                                  
ECORPGX  EQU   *                                                                
*                                                                               
ERCORPG2 DC    AL1(ECORPG2X-*),AL2(ERRGCORP),AL1(ERRCATY1),AL1(D#PYCST)         
         DC    AL2(0)                                                           
         DC    C'Corporation code does not match guarantee'                     
ECORPG2X EQU   *                                                                
*                                                                               
ERERRGRT DC    AL1(EERRGRTX-*),AL2(ERGRTERR),AL1(ERRCATY1),AL1(D#PYCST)         
         DC    AL2(0)                                                           
         DC    CL25'Bad guarantee record for '                                  
ERERRGRP DC    CL6' '                                                           
EERRGRTX EQU   *                                                                
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE CHECKS IF CURRENT USE IS EXCLUDED FROM APPLYING      *         
*        AGAINST THE GUARANTEE                                        *         
*        ON ENTRY ... R4=A(GUARANTEE DETAILS ELEMENT)                 *         
***********************************************************************         
                                                                                
         USING TAGUD,R4                                                         
EXCLUSE  NTR1  BASE=*,LABEL=*                                                   
         TM    TGUSSTA2,APPREUSE   NEVER PREVENT FIXED CYCLE PAYMENTS           
         JZ    EXUSE10             FROM SETTING UP THE GTRACK                   
         CLC   TGCOM,TAGUCOM                                                    
         JE    NO                                                               
*                                                                               
         USING TAGXD,R4                                                         
EXUSE10  L     R4,AIO2             IF EXCLUDED USES ELEMENT IS NOT              
         MVI   ELCODE,TAGXELQ      FOUND, APPLY TO GUARANTEE                    
         BRAS  RE,GETEL                                                         
         JNE   NO                                                               
*                                                                               
         ZIC   R3,TAGXLEN                                                       
         SHI   R3,TAGXLNQ          R3=# OF EXCLUDED USES                        
         LA    R4,TAGXUSE          R4=A(LIST OF EXCLUDED USES)                  
*                                                                               
EXUSE20  CLC   TGUSEQU,0(R4)       IF CURRENT USE IS EXCLUDED ...               
         JE    EXUSE30                                                          
         LA    R4,L'TAGXUSE(R4)                                                 
         BCT   R3,EXUSE20                                                       
         J     NO                                                               
         DROP  R4                                                               
*                                                                               
         USING TACAD,R4                                                         
EXUSE30  LA    R4,ELTACA           CLEAR GUARANTEE CODE                         
         XC    TACAGUA,TACAGUA                                                  
         XC    TGGUA,TGGUA                                                      
         J     YES                                                              
         DROP  R4                                                               
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*              ROUTINE GETS UH REC FOR CAST WHEN PAYING A VERSION FOR           
*              CLA OR UPGRADE TYPE.                                             
         SPACE                                                                  
         USING TAUHD,R4                                                         
GETCAU   NTR1  BASE=*,LABEL=*                                                   
         XC    ACAUHREC,ACAUHREC                                                
         SPACE 1                                                                
GETCAU02 CLI   VERSION,0           ONLY EXECUTE ROUTINE                         
         JE    XIT                 IF PAYING A VERSION                          
         TM    TGUSSTA3,NWKUSE     WITH A NETWORK USE TYPE                      
         BO    GETCAU05                                                         
         TM    TGUSSTA3,USEMTAB    OR SPECIAL PAYMENT                           
         BNZ   GETCAU05                                                         
         TM    TGUSTYST,UPGRADE    OR UPGRADE USE TYPE                          
         JZ    XIT                                                              
         SPACE 1                                                                
GETCAU05 MVC   HALF,TGCSORT+4      SET HALF WITH CAST INPUT SEQ                 
*                                                                               
*                                                                               
         MVC   AIO,AIO2            DON'T CREAM CAST REC IN AIO                  
         LA    R4,TCTAUHEL         R4=A(TCTAUHEL)                               
         SPACE                                                                  
         TM    TGUSSTA3,NWKUSE     IF NWK USE                                   
         BZ    GETCAU10                                                         
         BRAS  RE,GETCLAUH         GET USAGE HISTORY FOR NWKUSE                 
         BNE   *+10                                                             
         MVC   ACAUHREC,DMDSKADD   IF FOUND, SAVE A(UH REC FOR CAST)            
         SPACE                                                                  
         TM    PAYOPTS2,OPRVTUS    IF TU OPTION INPUT                           
         BZ    GETCAUX                                                          
         MVC   TAUHUSN,OPTPRVTU    REPLACE LAST TOTAL USE NUMBER                
         XC    TAUHUSNL,TAUHUSNL   INIT LAST LIFT USE NUM TO 0                  
         TM    PAYOPTS2,OPRVLUS    IF LU OPTION INPUT                           
         BZ    GETCAUX                                                          
         MVC   TAUHUSNL,OPTPRVLU   REPLACE LAST LIFT USE NUMBER                 
         B     GETCAUX                                                          
         SPACE 1                                                                
GETCAU10 TM    LCLSTAT3,FORCEUPG   IF FORCING UPGRADES                          
         BZ    GETCAU20                                                         
         MVC   TCTAUHEL,SVTAUHEL   SET CAST UH TO BE SAME AS FORCED             
         TM    TGUSSTA3,CBLUSE     IF CABLE OR SPANISH CABLE                    
         BZ    GETCAU40            DO NOT FORCE SUBSCRIBER COUNT                
         SPACE 1                                                                
GETCAU20 BRAS  RE,GETWUPUH         ELSE GET USAGE HISTORY FOR UPGRADES          
         BE    GETCAU30                                                         
         SPACE 1                                                                
         TM    LCLSTAT3,FORCEUPG   IF FORCING CBL OR SCB, SKIP AHEAD            
         BNZ   GETCAU40                                                         
         SPACE 1                                                                
         CLI   TGUSEQU,ULCB        IF USE IS LOCAL CABLE                        
         BNE   *+8                                                              
         MVI   TGUSTYP,0           CLEAR USE TYPE                               
         BRAS  RE,BLDUHEL          BUILD DUMMY UH ELEM IF NONE (AT R4)          
         B     GETCAU40                                                         
         SPACE 1                                                                
GETCAU30 MVC   ACAUHREC,DMDSKADD   ELSE SAVE A(UH REC FOR CAST)                 
         SPACE                                                                  
GETCAU40 TM    TGUSTYST,UPGRADE    IF UPGRADING                                 
         BNZ   GETCAU45                                                         
         TM    TGUSSTA3,USEMTAB    OR SPECIAL PAYMENT                           
         BZ    GETCAUX                                                          
         SPACE 1                                                                
GETCAU45 MVC   TCMAJORS,SVINPMAJ   MERGE THIS PAYMENT'S MAJORS                  
         OC    TCMAJORS,TAUHMAJ    WITH PREVIOUS MAJORS                         
         SPACE 1                                                                
         TM    LCLSTAT3,FORCEUPG   IF NOT FORCING UPGRADE                       
         BNZ   GETCAU80                                                         
         L     R3,TAUHSUBS                                                      
         CLI   TGUSEQU,ULCB                                                     
         BE    GETCAU60                                                         
         LH    R3,TAUHCBUN                                                      
         TM    TGUSSTA3,CBLUSE     ON CABLE, SPANISH CABLE                      
         BNZ   GETCAU50                                                         
         LH    R3,TAUHUNT                                                       
         TM    TGUSSTA3,USEMTAB    WSP,SWS,WSC,ADW PAYMENTS                     
         BZ    GETCAU80                                                         
GETCAU50 BRAS  RE,STCSTUNT         AND MKT/CNET/CSYS WERE ENTERED               
         BE    GETCAUX             BUILD THIS CAST MEMBER'S UNITS               
         LH    R1,SVINPUNT         ELSE, USE THE OVERRIDE AMOUNT                
         AR    R1,R3                                                            
         STH   R1,TCUNITS                                                       
         B     GETCAU70                                                         
GETCAU60 BRAS  RE,STCSTUNT         IF NOT FORCING UPGRADE ON LCB                
         BE    GETCAU70            AND CSYS WERE ENTERED                        
         ZICM  R1,SVINPSUB,4       BUILD THIS CAST MEMBER'S UNITS               
         AR    R1,R3               ELSE USE THE OVERRIDE AMOUNT                 
         STCM  R1,15,TCSUBS        AND SET THE LCB TYPE                         
GETCAU70 GOTO1 LCBTYPE                                                          
         B     GETCAUX                                                          
         SPACE                                                                  
GETCAU80 CLI   TGUSEQU,ULCB        FOR ALL OTHER USES                           
         BE    GETCAU90            OR IF FORCING CBL/SCB/WSP/SWS/               
         LH    R1,TAUHCBUN         WSC/ADW/LCB                                  
         TM    TGUSSTA3,CBLUSE     ADD INPUT UNITS/SUBSCRIBERS                  
         BO    GETCAU85            TO PREVIOUS UNITS/SUBSCRIBERS                
         LH    R1,TAUHUNT                                                       
GETCAU85 AH    R1,SVINPUNT                                                      
         STH   R1,TCUNITS                                                       
         B     GETCAUX                                                          
GETCAU90 ZICM  R1,SVINPSUB,4                                                    
         A     R1,TAUHSUBS                                                      
         STCM  R1,15,TCSUBS                                                     
         GOTO1 LCBTYPE                                                          
         SPACE                                                                  
GETCAUX  MVC   AIO,AIO1            RESET AIO                                    
         J     XIT                                                              
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
                                                                                
***********************************************************************         
*  BUILD CSTVERS TABLE                                                          
*  ON EXIT-  ACSTVERS = LIST OF VERSIONS TO BE PAID FOR CURRENT CAST            
***********************************************************************         
BLDCVER  NTR1  BASE=*,LABEL=*                                                   
         NI    TCPAYST2,ALL-TCVNR1U TURN OFF PAYING 1ST VNR VERSION             
         ICM   RF,15,ACSTVERS                                                   
         JZ    XIT                                                              
         XC    0(L'CSTVERS,RF),0(RF)                                            
         MVI   0(RF),X'FF'                                                      
                                                                                
         LA    R2,0                                                             
         XC    TCTUSES,TCTUSES                                                  
                                                                                
         L     R4,AIO                                                           
         MVI   ELCODE,TAFNELQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   XIT                                                              
         B     BLDCV15                                                          
BLDCV10  BRAS  RE,NEXTEL                                                        
         JNE   XIT                                                              
         USING TAFND,R4                                                         
BLDCV15  CLI   TAFNTYPE,TAFNTVER                                                
         BNE   BLDCV10                                                          
* GET CAST MEMBER'S TAFNAM ELEMENT TO SEE WHAT VERSION HE/SHE IS ON             
* ONLY INCLUDE THE VERSION NUMBER IN ACSTVER IF :                               
* VERSION NUMBER IS IN APAYVER                                                  
*                                                                               
                                                                                
         L     RF,ACSTVERS                                                      
         USING TAFND,R4                                                         
*                                                                               
         LA    R3,TAFNNAME                      CAST NAME ELEMENT               
         L     R1,APAYVERS                                                      
*                                                                               
*                                                                               
BLDCV24  ZIC   R0,TAFNLEN                                                       
         SHI   R0,3                            `                                
         CHI   RF,21                                                            
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLI   0(R1),X'FF'                      NOT IN APAYVERS LIST -          
         BE    BLDCV80                          PROCESS NEXT VERSION            
                                                                                
BLDCV26  CLC   0(1,R3),0(R1)                                                    
         BE    BLDCV30                                                          
* SEE IF TAFNAM=251 = CAST HAS ALL VERSIONS                                     
         CLI   TAFNNAME,251  CAST HAS ALL VERSIONS                              
         BE    BLDCV30                                                          
         AHI   R3,1                                                             
         BCT   R0,BLDCV26                                                       
         B     BLDCV40        NEXT VERSION IF NOT ON CAST'S VCAST               
* CAST VERSION NUMBER IS IN APAYVERS SO ITS BEING PAID                          
BLDCV30  MVC   BYTE,0(R1)                                                       
*                                                                               
         TM    PAYSTAT1,CREDIT                                                  
         BZ    BLDCV34                                                          
* CREDIT PAYMENT                                                                
         BAS   RE,CHKVPAID                                                      
         BNE   BLDCV40           IF NEVER PAID- PROCESS NEXT VERSION            
         B     BLDCV36           STORE IN CSTVERS-VERSION WAS PAID              
* REGULAR PAYMENT                                                               
BLDCV34  BAS   RE,CHKVPAID                                                      
         BE    BLDCV40           IF ALREADY PAID- PROCESS NEXT VERSION          
         B     BLDCV36           STORE IN CSTVERS-VERSION NEVER PAID            
*                                                                               
BLDCV36  MVC   0(1,RF),0(R1)                                                    
         AHI   R2,1                                                             
         AHI   RF,1                                                             
         BAS   RE,CHKVN1       CHECK IF PAYING/CREDITING 1ST VARIATION          
BLDCV40  DS    0H                                                               
         LA    R3,TAFNNAME                      CAST NAME ELEMENT               
         AHI   R1,1                                                             
         B     BLDCV24                                                          
*  FINISH PROCESSING VERSIONS                                                   
BLDCV80  MVI   0(RF),X'FF'                                                      
         STCM  R2,3,TCTUSES                                                     
                                                                                
* READJUST TCTUSES FOR VNR - WE HAVE TO DEAL WITH 1ST VARIATION                 
* AND "GROUPS OF FOURS"                                                         
* FOR VNR PAYEMENTS SEE HOW SET TCTUSES TO HOW MANY SESSION                     
* PAYEMENTS (GROUPS OF 4) WE ARE PAYING                                         
* 1ST CHECK EXISTING TAFN VNR ELEMENT TO SEE HOW MANY VARIATIONS                
* ARE LEFT FOR THIS LATEST SESSION PAYMENT                                      
         CLI   TGUSEQU,UVNR                                                     
         JNE   BLDCVX                                                           
*                                                                               
*                                                                               
BLDCV90  BAS   RE,CALTUSES                                                      
         ZICM  R0,TCTUSES,(3)      SAVE ORGINAL TCTUSES                         
*  FOR CREDITS CALL CALTUSES AGAIN TO CALCULATE THE TCTUSES FOR NEW             
*  REVISED TAFNTVNR ELEMENT WITH CREDITED VERSIONS BACKED OUT                   
         TM    PAYSTAT1,CREDIT                                                  
         BZ    BLDCVX                                                           
         TM    TCPAYST2,TCVNR1U    IF ONE OF THE VERSION IS A VN1               
         BNO   *+8                 SUBTRACT 1 FROM TOTAL NUMBER OF              
         SHI   R2,1                VERSIONS BEING CREDITED                      
         ZIC   RE,ELEMENT+1                                                     
         SR    RE,R2               SUBTRACT ELEMENT LENGTH BY NUMBER            
         STC   RE,ELEMENT+1        OF CREDIT VERSIONS AND CALL CALTUSES         
         BAS   RE,CALTUSES         TO GET NEW TCTUSES                           
         ZICM  RE,TCTUSES,(3)                                                   
         SR    R0,RE                                                            
         STCM  R0,3,TCTUSES        TCTUSES OF CREDITED VNR VERSIONS             
                                                                                
BLDCVX   J     XIT                                                              
*                                                                               
***************************************************************                 
* CALCULATE TCTUSES FOR VNR GIVEN A TAFNTVNR ELEMENT          *                 
*           ACSTVERS FILLED WITH VERSIONS TO PAY OR CREDIT    *                 
*           AND ELEMENT IS FILLED WITH TAFNTVNR ELEMENT       *                 
* EXIT - TCTUSES SET                                          *                 
***************************************************************                 
CALTUSES NTR1                                                                   
* READ EXISTING TAFNTVNR ELEMENT AND COUNT NUMBER OF "GROUPS OF 4"              
* AND THE REMAINING NUMBER OF VARIATIONS LEFT TO COVERED UNTIL                  
* THE NEXT SESSION PAYMENT KICKS IN                                             
         MVI   BYTE,3                                                           
         L     R4,AIO                   DEFAULT- VN1 TAFN NOT FOUND             
         MVI   ELCODE,TAFNELQ           SET 3 AS DISP TO BUMP TILL              
         BRAS  RE,GETEL                 START OF VERSIONS IN VNR TAFN           
         JNE   CALTU07                                                          
         B     CALTU06                                                          
CALTU05  BRAS  RE,NEXTEL                                                        
         JNE   CALTU07                                                          
         USING TAFND,R4                                                         
CALTU06  CLI   TAFNTYPE,TAFNTVN1                                                
         BNE   CALTU05                                                          
         MVI   BYTE,4                                                           
*                                                                               
CALTU07  LA    RE,0                      RE= COUNT OF GROUPS OF 4               
         LA    R0,4                      INIT VARIATIONS REMAINING              
CALTU08  CLC   ELEMENT+1(1),BYTE         IF NO PAID VNR VARIATIONS              
         BNH   CALTU28                   ASIDE FROM 1ST VERSION PAID            
CALTU10  ZIC   RF,ELEMENT+1              RF= NUMBER OF VERSIONS                 
         ZIC   R1,BYTE                                                          
         SR    RF,R1                                                            
* CORRECT LOGIC IS IF THERE IS A TAFN VN1- SUBTRACT 4 NOT 3                     
* IF THERE ARE NO TAFN VN1 - SUBTRACT LENGTH OF 3 MEANING ALL                   
* VERSIONS IN VNR TAFN ARE VERSIONS - NO 1ST VARIATION IN THERE                 
*                                                                               
*                                        SUBTRACT 3 FROM LEN ELSE 4             
CALTU20  CHI   R0,0                      IF R0 =0 ALREADY                       
         BNE   *+8                       MEANING NO VARIATIONS                  
         LA    R0,4                      LEFT, THEN RESET BACK TO 4             
         SHI   R0,1                                                             
         CHI   R0,3                      IF 3 LEFT MEANS 1ST OF 4               
         BNE   *+8                                                              
         AHI   RE,1                      BUMP COUNT OF GROUPS OF 4              
         BCT   RF,CALTU20                                                       
                                                                                
CALTU28  TM    PAYSTAT1,CREDIT           FOR CREDIT ONLY COUNT NUMBER           
         BZ    CALTU30                   OF GROUPS OF 4 AND EXIT                
         STCM  RE,3,TCTUSES                                                     
         B     CALTUSEX                                                         
                                                                                
* THIS SECTION IS FOR PAYING VERSIONS ONLY                                      
* R0 AT THIS POINT HAS THE NUMBER OF VARIATIONS LEFT                            
* COVERED UNDER THIS SESSION PAYMENT                                            
* NOW GO THOUGH CSTVERS TO SEE HOW MANY SESSION PAYMENTS WE NEED                
* TO PAY - R0 =0  MEANS WE HAVE NO MORE VARIATIONS TO COVER                     
*                                                                               
                                                                                
CALTU30  CHI   R0,4                   ONLY TIME R0 CAN HAVE 4 VARATIONS         
         BNE   *+8                    LEFT IF ITS THE 1ST TIME PAYING           
         LA    R0,0                   VNR FOR CURRENT CAST MEMBER               
*                                                                               
         L     RE,ACSTVERS            BUMP AHEAD IN CSTVERS                     
         AR    RE,R0                  BY NUMBER OF VARIATIONS TO COVER          
         LA    R0,0                                                             
         LA    RF,0                   RF=NUMBER OF GROUPS OF 4                  
         TM    TCPAYST2,TCVNR1U      SKIP 1ST CSTVERS ENTRY IF ITS              
         BNO   *+8                   THE  1ST VNR VERSION PAID                  
         AHI   RE,1                                                             
CALTU50  CLI   0(RE),X'FF'           EXIT OF NO MORE VERSIONS                   
         BE    CALTU80                                                          
         CLI   0(RE),0               PAST X'FF' EOL MEANS WE HAVE               
         BE    CALTU80               MORE VAIRATIONS REMAINING THAN             
         AHI   R0,1                  VERSIONS PAID                              
         CHI   R0,4                                                             
         BNE   *+8                                                              
         LA    R0,0                  UPDATE NUMBER OF SESSION PAYMENTS          
         CHI   R0,1                  ONLY UPDATE TCTUSES IF ARE PAYING          
         BNE   *+8                   1ST VARIATION IN THE GROUP OF 4            
         AHI   RF,1                                                             
         AHI   RE,1                                                             
         B     CALTU50                                                          
CALTU80  STCM  RF,3,TCTUSES                                                     
CALTUSEX J     XIT                                                              
*                                                                               
*****************************************************************               
* CHECK IF VERSION WAS PREVIOUSLY PAID TO CAST MEMBER           *               
* ENTRY- BYTE= VERSION NUMBER TO CHECK                                          
* EXIT - CC=Y IF VERSION PAID ALREADY IN ELEMENTS                               
*        CC=N IF NEVER PAID                                                     
*        ELEMENT HAS VNR CAST TAFN ELEMENT                                      
*****************************************************************               
CHKVPAID NTR1                                                                   
*                                  UNLESS A VN1 TAFN IS FOUND                   
         XC    ELEMENT,ELEMENT                                                  
         L     R4,AIO              GET USAGE HISTORY ELEMENT                    
         LA    R3,0                                                             
         MVI   ELCODE,TAFNELQ                                                   
         BRAS  RE,GETEL                                                         
         JE    CHKPD40                                                          
         J     CHKVPDN                                                          
CHKPD30  BRAS  RE,NEXTEL                                                        
         JE    CHKPD40                                                          
         J     CHKVPDN                                                          
CHKPD40  CLI   TAFNTYPE,TAFNTVRE      RENDERED                                  
         BE    CHKPD46                                                          
*                                                                               
         CLI   TAFNTYPE,TAFNTVNR      NON-RENDERED                              
         BNE   CHKPD30                                                          
         ZIC   RE,TAFNLEN             SAVE OFF TAFN ELEMENT                     
         EX    RE,*+8                 FOR VNR                                   
         B     *+10                                                             
         MVC   ELEMENT(0),0(R4)                                                 
         AHI   R3,1                                                             
         B     CHKPD46                                                          
                                                                                
*                                                                               
* FOUND A TAFN ELEMENT (FOR VRE OR VNR )                                        
CHKPD46  DS    0H                                                               
* FOR CREDIT VNR CREDIT ONLY LOOK AT VNR                                        
*            VRE CREDIT ONLY LOOK AT VRE                                        
         TM    PAYSTAT1,CREDIT                                                  
         BZ    CHKPD50                                                          
         CLI   TGUSEQU,UVNR                                                     
         BNE   CHKPD48                                                          
         CLI   TAFNTYPE,TAFNTVNR                                                
         BNE   CHKPD30                                                          
*                                                                               
CHKPD48  CLI   TGUSEQU,UVRE                                                     
         BNE   *+12                                                             
         CLI   TAFNTYPE,TAFNTVRE                                                
         BNE   CHKPD30                                                          
*                                                                               
CHKPD50  LA    RF,TAFNNAME                                                      
         ZIC   R0,TAFNLEN                                                       
         SHI   R0,3                                                             
CHKPVD60 CLC   BYTE,0(RF)                                                       
         JE    CHKVPDY                                                          
         AHI   RF,1                                                             
         BCT   R0,CHKPVD60                                                      
         J     CHKPD30                                                          
                                                                                
CHKVPDY  CR    RB,RB                                                            
         J     XIT                                                              
CHKVPDN  CHI   RB,0                                                             
         J     XIT                                                              
*****************************************************************               
* CHECK IF TCVNR1U BIT SHOULD BE TURNED ON                                      
*****************************************************************               
*                                                                               
CHKVN1   NTR1                                                                   
         L     R4,AIO              GET USAGE HISTORY ELEMENT                    
         LA    R3,0                                                             
         MVI   ELCODE,TAFNELQ                                                   
         BRAS  RE,GETEL                                                         
         JE    CHKVN140                                                         
         TM    PAYSTAT1,CREDIT         PAY -IF NOT TAFN ELEMENT THEN            
         BO    *+8                     WE MUST BE PAYING 1ST VARIATION          
         OI    TCPAYST2,TCVNR1U                                                 
         J     CHKVN1X                 WE MUST BE PAYING 1ST VARIATION          
CHKVN130 BRAS  RE,NEXTEL                                                        
         JE    CHKVN140                                                         
         TM    PAYSTAT1,CREDIT         PAY -IF NOT TAFN ELEMENT THEN            
         BO    *+8                     WE MUST BE PAYING 1ST VARIATION          
         OI    TCPAYST2,TCVNR1U                                                 
         J     CHKVN1X                                                          
*  VN1 TAFN FOUND                                                               
CHKVN140 CLI   TAFNTYPE,TAFNTVN1      VN1 FOUND ?                               
         BNE   CHKVN130                                                         
         TM    PAYSTAT1,CREDIT        IF CREDITING THE VN1 VERSION              
         BZ    CHKVN142               THEN TURN ON TCVNR1U                      
         CLC   BYTE,TAFNNAME                                                    
         BNE   CHKVN1X                                                          
         OI    TCPAYST2,TCVNR1U        ASSUME PAYING 1ST VARIATION              
         J     CHKVN1X                                                          
CHKVN142 NI    TCPAYST2,ALL-TCVNR1U   TURN OFF PAYING 1ST VARIATION             
*                                     IF PAYING VNR AND VN1 TAFN EXISTS         
*                                                                               
CHKVN1X  J     XIT                                                              
*****************************************************************               
*                                                                               
*              ROUTINE TO GET USAGE HISTORY FOR CURRENT CYCLE OF CLA            
*              SETS CC EQ IF FINDS ONE                                          
         SPACE                                                                  
GETCLAUH NTR1  BASE=*,LABEL=*                                                   
         MVI   TGBYTE2,C'N'        SET HAVEN'T TRIED PREV AGY/COMM'L            
         LA    R3,KEY                                                           
         USING TLUHD,R3            BUILD PARTIAL KEY FOR RECORD                 
         XC    TLUHKEY,TLUHKEY                                                  
         MVI   TLUHCD,TLUHCDQ      RECORD CODE                                  
         MVC   TLUHCOM,TGCOM       INTERNAL COMMERCIAL NUMBER                   
         MVC   TLUHCSEQ,HALF       CAST INPUT SEQ NUMBER                        
         MVC   TLUHUSE,TGUSCDE     USE CODE                                     
         MVI   TGBYTE,C'Y'         SET FIRST UH RECORD (LAST PAYMENT)           
         SPACE 1                                                                
         GOTO1 HIGH                GET DIRECTORY RECORD                         
         B     GETCUH5                                                          
         SPACE 1                                                                
GETCUH4  MVI   TGBYTE,C'N'         SET NOT FIRST UH REC (NOT LAST PYMT)         
         GOTO1 SEQ                 GET NEXT DIRECTORY RECORD                    
         SPACE 1                                                                
GETCUH5  CLC   TLUHKEY(TLUHINV-TLUHD),KEYSAVE  DID WE FIND REC FOR USE          
         BE    GETCUH6                                                          
         SPACE 1                                                                
         CLI   TGBYTE2,C'Y'        IF HAVEN'T TRIED PREV AGY/COMM'L YET         
         BE    GETCUH10                                                         
         MVI   TGBYTE2,C'Y'        SET HAVE TRIED PREV AGY/COMM'L               
         GOTO1 TRYOCEL             AND GO TRY IT                                
         BNE   GETCUH10                                                         
         SPACE 1                                                                
GETCUH6  GOTO1 GETREC              GET THE RECORD                               
         SPACE 1                                                                
         USING TAUHD,R4                                                         
         MVI   ELCODE,TAUHELQ      GET USAGE HISTORY ELEMENT                    
         L     R4,AIO                                                           
         BRAS  RE,GETEL                                                         
         BNE   GETCUH4                                                          
         SPACE                                                                  
         CLI   TGBYTE,C'Y'         IF NOT FIRST UH RECORD                       
         BE    GETCUH7                                                          
         CLC   TCPCYCS,TAUHSTRT    CYCLE MUST MATCH EXACTLY                     
         BNE   GETCUH4                                                          
         CLC   TCPCYCE,TAUHEND                                                  
         BNE   GETCUH4                                                          
         B     GETCUH8                                                          
         SPACE                                                                  
GETCUH7  CLC   TCPCYCE,TAUHSTRT    IF CURRENT CYCLE END IS BETWEEN              
         BL    GETCUH4                                                          
         CLC   TCPCYCE,TAUHEND     ELEMENT'S START AND END DATES                
         BNH   GETCUH8                                                          
         SPACE                                                                  
         CLC   TCPCYCS,TAUHSTRT    OR IF CURRENT CYCLE START IS BETWEEN         
         BL    GETCUH4                                                          
         CLC   TCPCYCS,TAUHEND     ELEMENT'S START AND END DATES                
         BH    GETCUH4                                                          
         SPACE                                                                  
GETCUH8  XC    TCTAUHEL,TCTAUHEL                                                
         ZIC   RE,TAUHLEN                                                       
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   TCTAUHEL(0),TAUHEL  SAVE ELEMENT IN LOCAL BUFFER                 
         J     YES                                                              
         SPACE                                                                  
GETCUH10 BRAS  RE,BLDUHEL          BLD DUMMY USAGE HIST ELEM FOR CYCLE          
         J     NO                                                               
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*              ROUTINE TO GET USAGE HISTORY FOR CURRENT CYCLE                   
*              OF WILDSPOT, CBL, SCB UPGRADE                                    
*              SETS CC EQ IF FINDS ONE                                          
         SPACE                                                                  
GETWUPUH NTR1  BASE=*,LABEL=*                                                   
         CLI   TGUSEQU,UCAB        IF CAB, GET OUT                              
         JE    NO                                                               
         SPACE 1                                                                
         MVI   TGBYTE,UHCUR        SET TRIED THIS USE FOR CURR AGY/COM          
         SPACE 1                                                                
         TM    LCLSTAT3,FORCEUPG   IF NOT FORCING UPGRADE                       
         BNZ   *+10                                                             
         XC    TCTAUHEL,TCTAUHEL   CLEAR USAGE HISTORY EL.                      
         SPACE 1                                                                
         USING TLUHD,R3                                                         
         LA    R3,KEY              BUILD PARTIAL KEY FOR RECORD                 
         XC    TLUHKEY,TLUHKEY                                                  
         MVI   TLUHCD,TLUHCDQ      RECORD CODE                                  
         MVC   TLUHCOM,TGCOM       INTERNAL COMMERCIAL NUMBER                   
         MVC   TLUHCSEQ,HALF       CAST INPUT SEQ NUMBER                        
         MVC   TLUHUSE,TGUPFRCD    "FROM" USE CODE                              
         GOTO1 HIGH                GET DIRECTORY RECORD                         
         B     GETWUH20                                                         
         SPACE 1                                                                
GETWUH10 GOTO1 SEQ                 GET NEXT DIRECTORY RECORD                    
GETWUH20 CLC   TLUHKEY(TLUHINV-TLUHD),KEYSAVE  DID WE FIND REC FOR USE          
         BE    GETWUH50                                                         
         SPACE 1                                                                
         GOTO1 TPRELCB             CHECK USAGE HISTORY FOR PREVIOUS             
         JNE   NO                  AGY/COMM'L AND (POSSIBLY) LCB                
         SPACE 1                                                                
GETWUH50 GOTO1 GETREC              GET THE RECORD                               
         SPACE 1                                                                
         USING TAUHD,R4                                                         
         MVI   ELCODE,TAUHELQ      GET USAGE HISTORY ELEMENT                    
         L     R4,AIO                                                           
         BRAS  RE,GETEL                                                         
         BNE   GETWUH10                                                         
         SPACE                                                                  
         CLC   TCPCYCS,TAUHSTRT    CYCLE STARTS MUST BE SAME                    
         BNE   GETWUH10                                                         
         SPACE 1                                                                
         TM    TGUSSTA3,CBLUSE     IF USE IS NOT CABLE OR SPANISH CABLE         
         BNZ   GETWUH60                                                         
         CLI   TGUSEQU,ULCB        OR LOCAL CABLE                               
         BE    GETWUH65                                                         
         CLC   TAUHTYPE,TGUPFRTY   USE TYPE MUST MATCH                          
         BNE   GETWUH10                                                         
         B     GETWUH70                                                         
         SPACE 1                                                                
GETWUH60 TM    LCLSTAT3,FORCEUPG   IF FORCING UPGRADE TO CBL OR SCB             
         BZ    GETWUH70            DO NOT FORCE OVER SUBSCRIBERS                
         MVC   TCTAUHEL+TAUHCSUB-TAUHD(4),TAUHEL+TAUHCSUB-TAUHD                 
         B     GETWUH80                                                         
         SPACE 1                                                                
GETWUH65 TM    LCLSTAT3,FORCEUPG   IF FORCING UPGRADE TO LCB                    
         BZ    GETWUH70            DO NOT FORCE OVER CSYS COUNT                 
         MVC   TCTAUHEL+TAUHCSYS-TAUHD(2),TAUHEL+TAUHCSYS-TAUHD                 
         B     GETWUH80                                                         
         SPACE 1                                                                
GETWUH70 XC    TCTAUHEL,TCTAUHEL   ELSE, SAVE USAGE HISTORY                     
         ZIC   RE,TAUHLEN          IN LOCAL BUFFER                              
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   TCTAUHEL(0),TAUHEL                                               
         SPACE 1                                                                
GETWUH80 GOTO1 LCBUHFX             OLD FORMAT LCB UH REQUIRES FIX               
         GOTO1 LCB2CBL             CBL/SCB UPGRADE TO LCB REQUIRES FIX          
         J     YES                                                              
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE SAVES LATEST HOLDING FEE CYCLE START DATE            *         
*        FOR COMMERCIAL BEING PAID                                    *         
***********************************************************************         
                                                                                
GETLSTHF NTR1  BASE=*,LABEL=*                                                   
         XC    LSTHFSTD,LSTHFSTD   INITIALIZE LAST HF START DATE                
                                                                                
         USING TLUHD,R3                                                         
         LA    R3,KEY              BUILD USAGE HISTORY KEY                      
         XC    TLUHKEY,TLUHKEY                                                  
         MVI   TLUHCD,TLUHCDQ      RECORD CODE                                  
         MVC   TLUHCOM,TGCOM       INTERNAL COMMERCIAL NUMBER                   
         MVC   TLUHUSE,=C'ADH'     USE CODE                                     
         GOTO1 HIGH                GET DIRECTORY RECORD                         
         J     GLUH20                                                           
GLUH10   GOTO1 SEQ                                                              
GLUH20   CLC   TLUHKEY(TLUHUSE-TLUHD),KEYSAVE                                   
         JNE   XIT                                                              
         CLC   TLUHUSE,=C'ADH'     ONLY CONSIDER HOLDING FEE PAYMENTS           
         JE    GLUH30                                                           
         CLC   TLUHUSE,=C'HLD'                                                  
         JE    GLUH30                                                           
         CLC   TLUHUSE,=C'SHL'                                                  
         JNE   GLUH10                                                           
         DROP  R3                                                               
                                                                                
GLUH30   GOTO1 GETREC              GET THE RECORD                               
                                                                                
         USING TAUHD,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TAUHELQ      GET USAGE HISTORY ELEMENT                    
         BRAS  RE,GETEL                                                         
         JNE   GLUH10                                                           
         OC    LSTHFSTD,LSTHFSTD   IF LAST HF START DATE NOT SET YET            
         JZ    GLUH40                                                           
         CLC   LSTHFSTD,TAUHSTRT   OR IS LATER THAN THIS ONE                    
         JNL   GLUH10                                                           
GLUH40   MVC   LSTHFSTD,TAUHSTRT   SET NEW LAST HF START DATE                   
         J     GLUH10                                                           
         DROP  R4                                                               
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE TO SELECT PAYABLE CAST FOR PAYMENTS COMING           *         
*        FROM CERNO                                                   *         
*        ON ENTRY ... R3=A(CAST RECORD KEY)                           *         
***********************************************************************         
                                                                                
         USING TLCAD,R3                                                         
CRNOCAST NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGCRNOPY   IF PAYMENT COMING FROM CERNO                 
         JZ    YES                                                              
                                                                                
         OI    LCLSTAT4,NONACTON   SET THERE ARE NO NON-ACTRA CAST              
                                                                                
         GOTOR GTHFCDET,DMCB,TLCASEQ                                            
         JNE   CCAST60             IF PERFORMER IS BEING PAID ...               
                                                                                
         USING TAHFD,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TAHFELQ      ... BUT PAYMENT'S CYCLE DATE DOES            
         BRAS  RE,GETEL            NOT MATCH THE NOTICE'S CYCLE                 
         JE    *+6                 SKIP THIS CAST                               
         DC    H'00'                                                            
         LA    RE,TAHFNXTS                                                      
         OC    TAHFHDTE,TAHFHDTE                                                
         JZ    *+8                                                              
         LA    RE,TAHFHDTE                                                      
         CLC   TCPCYCS,0(RE)                                                    
         JNE   NO                                                               
         DROP  R4                                                               
                                                                                
         USING TACRD,R4                                                         
         L     R4,AIO              IF CAST DOES NOT HAVE A HOLDING              
         MVI   ELCODE,TACRELQ      FEE PAYMENT THAT OVERLAPS THIS ONE,          
         BRAS  RE,GETEL            TURN ON "PAYMENT INCLUDES CAST               
         J     *+8                 THAT HAS NOT ALREADY BEEN PAID AN            
CCAST30  BRAS  RE,NEXTEL           OVERLAPPING HOLDING FEE" STATUS              
         JE    CCAST40                                                          
         OI    LCLSTAT5,CSTNPPRE                                                
         J     YES                                                              
                                                                                
CCAST40  CLC   TACRUSE,=C'HLD'     IF CAST HAS A HOLDING FEE                    
         JE    CCAST50             PAYMENT THAT OVERLAPS THIS ONE,              
         CLC   TACRUSE,=C'SHL'     TURN ON "PAYMENT INCLUDES CAST               
         JE    CCAST50             THAT HAS ALREADY BEEN PAID AN                
         CLC   TACRUSE,=C'ADH'     OVERLAPPING HOLDING FEE" STATUS              
         JNE   CCAST30                                                          
CCAST50  CLC   TACREND,TCPCYCS                                                  
         JL    CCAST30                                                          
         CLC   TACRSTRT,TCPCYCE                                                 
         JH    CCAST30                                                          
         OI    LCLSTAT5,CSTPDPRE                                                
         J     YES                                                              
         DROP  R3,R4                                                            
                                                                                
CCAST60  GOTO1 UNITEST,DMCB,(X'80',TGUNEQUS),TGUSXUNS                           
         JNZ   NO                                                               
         TM    TGCATYPE,NOHLD                                                   
         JO    NO                                                               
                                                                                
         USING TAHFD,R4                                                         
         L     R4,AIO              IF THIS CAST IS NOT IN THE LIST              
         MVI   ELCODE,TAHFELQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   NO                                                               
         CLC   TAHFNXTS,TCPCYCS    BUT LAST HOLDING FEE WAS FOR                 
         JNE   NO                  THIS CYCLE                                   
         DROP  R4                                                               
                                                                                
         USING TACAD,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TACAELQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   CCAST70                                                          
         OC    TACALAST,TACALAST   AND CAST HAS NOT BEEN LAST SERVICED          
         JNZ   NO                                                               
         CLC   TACAONOF,=C'OFF'                                                 
         JNE   CCAST70                                                          
         TM    TGCATYPE,NOHLDOFF                                                
         JO    NO                                                               
         GOTO1 YRVAL,DMCB,TACAYEAR                                              
         JNE   NO                                                               
         CLI   TGYREQU,CN88                                                     
         JL    CCAST70                                                          
         TM    TGCATYPE,NHLDOF88                                                
         JO    NO                                                               
         DROP  R4                                                               
                                                                                
         USING TACRD,R4                                                         
CCAST70  L     R4,AIO                                                           
         MVI   ELCODE,TACRELQ                                                   
         BRAS  RE,GETEL                                                         
         J     *+8                                                              
CCAST80  BRAS  RE,NEXTEL                                                        
         JE    CCAST90                                                          
         OI    LCLSTAT5,CSTMSNOT   THEN A REISSUE IS NEEDED                     
         J     NO                                                               
CCAST90  CLC   TACRUSE,=C'HLD'                                                  
         JE    CCAST100                                                         
         CLC   TACRUSE,=C'SHL'                                                  
         JE    CCAST100                                                         
         CLC   TACRUSE,=C'ADH'                                                  
         JNE   CCAST80             IF THE HOLDING FEE HASN'T BEEN               
CCAST100 CLC   TACREND,TCPCYCS     PREVIOUSLY PAID                              
         JNE   CCAST80                                                          
         J     NO                                                               
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE TO SELECT PAYABLE CAST FOR CREDIT PAYMENTS TO        *         
*        INVOICES WITH SAVED BILLING RATES                            *         
*        ON ENTRY ... KEY = CAST RECORD KEY                           *         
***********************************************************************         
                                                                                
CRDCAST  NTR1  BASE=*,LABEL=*                                                   
         XR    R0,R0                                                            
                                                                                
         MVC   SYSDIR,=CL8'CHKDIR'                                              
                                                                                
         MVC   BLOCK(L'KEY),KEY                                                 
                                                                                
         USING TLCKD,R3                                                         
         LA    R3,KEY                                                           
         XC    KEY,KEY                                                          
         MVI   TLCKCD,TLCKCDQ      FILTER OUT ANY CAST THAT WAS NOT             
         MVC   TLCKAGY,TGAGY       ON THE INVOICE BEING CREDITED                
         MVC   TLCKINV,EINVNO                                                   
         TM    PAYOPTS3,ORETRO     IF MANUAL RETRO                              
         JZ    CRDC08                                                           
         MVC   TLCKINV,RET4INV     CHECK AGAINST RETRO INV                      
                                                                                
CRDC08   GOTO1 HIGH                                                             
         J     CRDC20                                                           
CRDC10   GOTO1 SEQ                                                              
CRDC20   CLC   KEY(TLCKSORT-TLCKD),KEYSAVE                                      
         JNE   CRDC30                                                           
         CLC   TLCKSORT+4(L'TLCASEQ),BLOCK+TLCASEQ-TLCAD                        
         JNE   CRDC10                                                           
         LHI   R0,1                                                             
         DROP  R3                                                               
                                                                                
         MVC   SYSFIL,=CL8'CHKFIL'                                              
         GOTO1 GETREC                                                           
         MVC   SYSFIL,=CL8'TALFIL'                                              
                                                                                
CRDC30   MVC   SYSDIR,=CL8'TALDIR'                                              
         MVC   KEY,BLOCK                                                        
         GOTO1 HIGH                                                             
         LTR   R0,R0                                                            
         JZ    NO                                                               
                                                                                
         USING TLCKD,R4                                                         
         L     R4,AIO              SET GLOBAL BASED ON CHECK'S                  
         GOTO1 CATVAL,DMCB,TLCKCAT              CATEGORY VALUE                  
         DROP  R4                                                               
                                                                                
         L     R4,AIO                                                           
         MVI   ELCODE,TACAELQ      COPY CHECK'S CAST DETAILS                    
         BRAS  RE,GETEL            TO ELTACA                                    
         JE    *+6                                                              
         DC    H'00'                                                            
                                                                                
         USING TACAD,R4                                                         
         TM    PAYOPTS3,ORETRO     RETRO CAST?                                  
         JZ    CRDC38                                                           
         CLC   =C'SAG',TACAUN      UNION MUST BE SAG/AFT                        
         JE    CRDC32                                                           
         CLC   =C'AFT',TACAUN                                                   
         JNE   CRDC35                                                           
CRDC32   CLC   =C'16 ',TACAYEAR    FOR YEAR 13                                  
         JNE   NO                                                               
         J     CRDC38                                                           
                                                                                
CRDC35   CLC   =C'ACT',TACAUN      CAN BE ACTRA                                 
         JNE   NO                                                               
         CLC   =C'14 ',TACAYEAR    FOR YEAR 11                                  
         JNE   NO                                                               
                                                                                
CRDC38   MVC   ELTACA,0(R4)                                                     
                                                                                
         USING TANUD,R4                                                         
         XC    BLOCK,BLOCK         COPY CHECK'S OVERSCALE AMOUNT                
         MVI   ELCODE,TANUELQ      TO BLOCK                                     
         GOTO1 GETL,DMCB,(1,=AL1(TAUNTOVA))                                     
         JNE   CRDC40                                                           
         L     R4,TGELEM                                                        
         MVC   BLOCK(TANULNQ2),0(R4)                                            
         DROP  R4                                                               
                                                                                
         USING TAPDD,R4                                                         
CRDC40   L     R4,AIO                                                           
         MVI   ELCODE,TAPDELQ      COPY CHECK'S 1ST OVERSCALE                   
         BRAS  RE,GETEL            PERCENTAGE TO TGFULL                         
         JE    *+6                                                              
         DC    H'00'                                                            
         MVC   TGFULL,TAPDOV1                                                   
         DROP  R4                                                               
                                                                                
         GOTO1 GETREC              GET CAST RECORD                              
                                                                                
         MVI   ELCODE,TACAELQ      DELETE CAST'S CAST DETAILS ELEMENT           
         GOTO1 REMELEM                                                          
         MVI   ELCODE,TAOAELQ      DELETE CAST'S OVERSCALE AMOUNT               
         GOTO1 REMELEM             ELEMENT                                      
         MVI   ELCODE,TAOPELQ      DELETE CAST'S 1ST OVERSCALE PCT              
         GOTO1 REMELEM             ELEMENT                                      
         MVI   ELCODE,TAO2ELQ      DELETE CAST'S 2ND OVERSCALE PCT              
         GOTO1 REMELEM             ELEMENT                                      
                                                                                
         MVC   ELEMENT,ELTACA      ADD CHECK'S CAST DETAILS ELEMENT             
         GOTO1 ADDELEM             TO CAST                                      
                                                                                
         USING TANUD,R1                                                         
         USING TAOAD,R4                                                         
         CLI   BLOCK,0             IF CHECK'S OVERSCALE AMOUNT ELEMENT          
         JE    CRDC50              WAS SAVED                                    
         LA    R1,BLOCK                                                         
         LA    R4,ELEMENT                                                       
         XC    ELEMENT,ELEMENT                                                  
         MVI   TAOAEL,TAOAELQ                                                   
         MVI   TAOALEN,TAOALNQ+L'TAOASBEL                                       
         MVI   TAOANUM,1                                                        
         MVC   TAOAUSE,SPACES                                                   
         MVC   TAOAAMT,TANUOVAM    ADD CHECK'S OVERSCALE AMOUNT ELEMENT         
         GOTO1 ADDELEM             TO CAST                                      
         DROP  R1,R4                                                            
                                                                                
         USING TAOPD,R4                                                         
CRDC50   OC    TGFULL,TGFULL       IF CHECK'S 1ST OVERSCALE PERCENTAGE          
         JZ    YES                 WAS SAVED                                    
         LA    R4,ELEMENT          COPY CHECK'S 1ST OVERSCALE PCT               
         XC    ELEMENT,ELEMENT     ELEMENT TO CAST                              
         MVI   TAOPEL,TAOPELQ                                                   
         MVI   TAOPLEN,TAOPLNQ+L'TAOPSBEL                                       
         MVI   TAOPNUM,1                                                        
         MVC   TAOPUSE,SPACES                                                   
         MVC   TAOPPCT,TGFULL                                                   
         GOTO1 ADDELEM                                                          
         J     YES                                                              
         DROP  R4                                                               
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE TO SELECT PAYABLE CAST FOR NON-CERNO PAYMENTS        *         
*        COMING FROM THE WEB                                          *         
***********************************************************************         
                                                                                
WEBCAST  NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    YES                                                              
         TM    TGFASTAT,TGCRNOPY   (BUT NOT CERNO)                              
         JO    YES                                                              
                                                                                
         USING TLCAD,R4                                                         
         LA    R4,SVCASTKY         R4=A(SAVED CAST KEY)                         
                                                                                
         USING WEBRESD,R2                                                       
         L     R2,TGAFARES                                                      
WCAST10  CLC   TLCASEQ,WRSSEQ      SEARCH WEB RESPONSE DETAILS AREA             
         JE    WCAST20             FOR CAST SEQUENCE NUMBER                     
         CLI   0(R2),X'FF'                                                      
         JE    WCASTNO                                                          
         LA    R2,WRSLNQ(R2)                                                    
         J     WCAST10                                                          
         DROP  R4                                                               
                                                                                
WCAST20  OI    WRSSTAT,WRSSEXST    SET CAST RECORD EXISTS STATUS                
         XC    TCCAST(TCCSTLNQ),TCCAST                                          
         XC    TCCSTBRK,TCCSTBRK                                                
                                                                                
         TM    TGFASTAT,TGVITSES   IF FOUND AND PAYMENT IS COMING               
         JZ    WCAST40             FROM A VITA SESSION ...                      
         MVI   ELCODE,TAFNELQ                                                   
         GOTO1 GETL,DMCB,(1,=AL1(TAFNTWEB))                                     
         JNE   WCAST30                                                          
                                                                                
         USING WEBREQD,RE                                                       
         USING TAFND,R4                                                         
         L     RE,TGAFAREQ                                                      
         L     R4,TGELEM           ... ENSURE THAT PERFORMER WAS LAST           
         ZIC   RF,TAFNLEN                                                       
         SHI   RF,4                                                             
         EX    RF,*+8                                                           
         J     *+10                                                             
         CLC   WBWAPID(0),TAFNNAME UPDATED FROM THIS VITA SESSION               
         JE    WCAST40                                                          
WCAST30  GOTOR ADDEAP,DMCB,0,ERCAVSNP,0(R2)                                     
         JNE   WCASTNO                                                          
         DROP  RE,R4                                                            
                                                                                
WCAST40  ST    R2,AWEBRES          SAVE A(CAST ENT IN WEB RES DET AREA)         
                                                                                
         XC    OPTAGNT,OPTAGNT                                                  
         OC    WRSOVAGT,WRSOVAGT   IF PERFORMER'S AGENT IS BEING                
         JZ    YES                 OVERRIDDEN, SET OVERRIDE AGENT CODE          
         GOTO1 TRNSAGT,DMCB,(X'80',WRSOVAGT),OPTAGNT                            
         J     YES                                                              
         DROP  R2                                                               
                                                                                
WCASTNO  MVC   KEY,SVCASTKY        RESTORE READ SEQUENCE                        
         GOTO1 HIGH                AND SET NEGATIVE CONDITION CODE              
         J     NO                                                               
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
ERCAVSNP DC    AL1(ECAVSNPX-*),AL2(ERCANPVS),AL1(ERRCATY1),AL1(D#PYCST)         
         DC    AL2(0)                                                           
         DC    CL60'Performer not eligible for payment from this Vita S+        
               ession'                                                          
ECAVSNPX EQU   *                                                                
                                                                                
         LTORG                                                                  
         EJECT                                                                  
       ++INCLUDE TAADDEAR                                                       
***********************************************************************         
*        ROUTINE BUILDS WEB RESPONSE DETAILS AREA FOR PERFORMERS      *         
*        ON NON-CERNO PAYMENTS COMING FROM THE WEB                    *         
***********************************************************************         
                                                                                
BLDWBRES NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    XIT                                                              
         TM    TGFASTAT,TGCRNOPY   (BUT NOT CERNO)                              
         JO    XIT                                                              
                                                                                
         USING WEBRESD,R1                                                       
         L     R1,AWEBRES          R1=A(CAST ENTRY IN WEB RES DET AREA)         
         OI    WRSSTAT,WRSSELIG    SET CAST IS ELIGIBLE FOR PAYMENT             
                                                                                
         CLI   WRSAPCOD,0          IF APPLIED CODE PROVIDED                     
         JE    BWRES10                                                          
         MVC   TCAPPLCD,WRSAPCOD   SET APPLIED AMOUNT CODE                      
         MVC   TCAPPLCR,WRSAPAMT   APPLIED CREDIT AMOUNT                        
         OI    TCINPUT,TCINAPPL    AND APPLIED AMOUNT OVERRIDE STATUS           
         OI    LCLSTAT,MANOVER                                                  
         OI    CASTSTAT,CSTMAN                                                  
                                                                                
BWRES10  MVC   TCEXPICD,WRSRECOD   SET REIMBURSED EXPENSE INCLUDE CODE          
         MVC   TCEXP,WRSREAMT      AND REIMBURSED EXPENSE AMOUNT                
                                                                                
         TM    WRSSTAT,WRSAMOVR    IF PAYMENT AMOUNT PROVIDED                   
         JZ    BWRES20                                                          
         MVC   TCPAY,WRSAMAMT      SET PAYMENT AMOUNT                           
         OI    LCLSTAT,MANOVER     AND PAYMENT AMOUNT OVERRIDE STATUS           
         OI    CASTSTAT,CSTMAN+CSTINPY                                          
         OI    TCINPUT,TCINPAY+TCINHWIN                                         
                                                                                
BWRES20  TM    WRSSTAT,WRSPHOVR    IF SUBJECT TO P&H AMOUNT PROVIDED            
         JZ    BWRES30                                                          
         MVC   TCSUBPNH,WRSPHAMT   SET SUBJECT TO P&H AMOUNT                    
         OI    TCINPUT,TCINPNH     AND SUBJECT TO P&H OVERRIDE STATUS           
         OI    LCLSTAT,MANOVER                                                  
         OI    CASTSTAT,CSTMAN                                                  
                                                                                
BWRES30  TM    WRSSTAT,WRSMDOVR    IF MISCELLANEOUS DEDUCTION PROVIDED          
         JZ    BWRES40                                                          
         MVC   TCMDED,WRSMDAMT     SET MISCELLANEOUS DEDUCTION AMOUNT           
         OI    TCINPUT2,TCINMDED   AND MISC DEDUCTION OVERRIDE STATUS           
         OI    LCLSTAT,MANOVER                                                  
         OI    CASTSTAT,CSTMAN                                                  
                                                                                
BWRES40  OC    WRSOVAGT,WRSOVAGT   IF PERFORMER'S AGENT IS BEING                
         JZ    BWRES50             OVERRIDDEN                                   
         OI    LCLSTAT,MANOVER     SET OVERRIDE STATUS                          
         OI    CASTSTAT,CSTMAN                                                  
                                                                                
         USING TACRD,R4                                                         
BWRES50  L     R4,AIO              IF THIS PAYMENT OVERLAPS A                   
         MVI   ELCODE,TACRELQ      PREVIOUS PAYMENT FOR THIS PERFORMER          
         BRAS  RE,GETEL            SET PAYMENT OVERLAP STATUS                   
         J     *+8                                                              
BWRES60  BRAS  RE,NEXTEL                                                        
         JNE   XIT                                                              
         CLC   TACRUSE,TGUSCDE                                                  
         JNE   BWRES60                                                          
         CLC   TCPCYCS,TACREND                                                  
         JH    BWRES60                                                          
         CLC   TCPCYCE,TACRSTRT                                                 
         JL    BWRES60                                                          
         OI    WRSSTAT,WRSSOVLP                                                 
         J     XIT                                                              
         DROP  R1,R4                                                            
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE TO SET APPLY DATE FOR PERFORMER LEVEL G=E OPTION     *         
***********************************************************************         
                                                                                
STPLGEOP NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    XIT                                                              
                                                                                
         USING TLCAD,R4                                                         
         L     R4,TCACAST          R4=A(CAST RECORD)                            
                                                                                
         USING WEBRESD,R1                                                       
         L     R1,TGAFARES                                                      
SVPGO10  CLC   TLCASORT+4(2),WRSSEQ                                             
         JE    SVPGO20             SEARCH WEB RESPONSE DETAILS AREA             
         CLI   0(R1),X'FF'         FOR CAST SEQUENCE NUMBER                     
         JE    SVPGO30                                                          
         LA    R1,WRSLNQ(R1)                                                    
         J     SVPGO10                                                          
                                                                                
         USING WBPLOD,R2                                                        
SVPGO20  LA    R2,WRSOPTNS                                                      
         TM    WBPLOST1,WPPLOEND   IF APPLYING TO THIS GUARANTEE BASED          
         JZ    XIT                 ON END DATE, SET GQSTRT TO CYCLE             
         MVC   GQSTRT,TCPCYCE      END DATE                                     
         J     XIT                                                              
         DROP  R1,R2                                                            
                                                                                
SVPGO30  TM    TGFASTAT,TGCRNOPY   IF PAYMENT COMING FROM CERNO                 
         JZ    XIT                                                              
                                                                                
         GOTOR GTHFCDET,DMCB,TLCASEQ                                            
         JNE   XIT                                                              
         DROP  R4                                                               
                                                                                
         USING WBPYCSD,RF                                                       
         L     RF,TGFULL                                                        
         TM    WPCSSTAT,WPCSGEND   IF APPLYING TO THIS GUARANTEE BASED          
         JZ    XIT                 ON END DATE, SET GQSTRT TO CYCLE             
         MVC   GQSTRT,TCPCYCE      END DATE                                     
         J     XIT                                                              
         DROP  RF                                                               
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE TO SAVE PERFORMER LEVEL G=E OPTION ONTO CHECK        *         
*        ON ENTRY ... R4=A(PAYMENT DETAILS ELEMENT)                   *         
***********************************************************************         
                                                                                
         USING TAPDD,R4                                                         
SVPLGEOP NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    XIT                                                              
                                                                                
         USING TLCKD,R3                                                         
         L     R3,AIO              R3=A(CHECK RECORD)                           
                                                                                
         USING WEBRESD,R1                                                       
         L     R1,TGAFARES                                                      
STPGO10  CLC   TLCKSORT+4(2),WRSSEQ                                             
         JE    STPGO20             SEARCH WEB RESPONSE DETAILS AREA             
         CLI   0(R1),X'FF'         FOR CAST SEQUENCE NUMBER                     
         JE    STPGO30                                                          
         LA    R1,WRSLNQ(R1)                                                    
         J     STPGO10                                                          
                                                                                
         USING WBPLOD,R2                                                        
STPGO20  LA    R2,WRSOPTNS                                                      
         TM    WBPLOST1,WPPLOEND   IF APPLYING TO THIS GUARANTEE BASED          
         JZ    XIT                 ON END DATE, TURN STATUS ON                  
         OI    TAPDOPT4,TAPDGRTE                                                
         J     XIT                                                              
         DROP  R1,R2                                                            
                                                                                
STPGO30  TM    TGFASTAT,TGCRNOPY   IF PAYMENT COMING FROM CERNO                 
         JZ    XIT                                                              
                                                                                
         GOTOR GTHFCDET,DMCB,TLCKSORT+4                                         
         JNE   XIT                                                              
         DROP  R3                                                               
                                                                                
         USING WBPYCSD,RF                                                       
         L     RF,TGFULL                                                        
         TM    WPCSSTAT,WPCSGEND   IF APPLYING TO THIS GUARANTEE BASED          
         JZ    XIT                 ON END DATE, TURN STATUS ON                  
         OI    TAPDOPT4,TAPDGRTE                                                
         J     XIT                                                              
         DROP  R4,RF                                                            
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE TO CHECK FOR EXPIRING GUARANTEE                      *         
*        ON ENTRY ... R4=A(GUARANTEE DETAILS ELEMENT)                 *         
***********************************************************************         
                                                                                
         USING TAGUD,R4                                                         
EXPGRTCK NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGCRNOPY   IF REQUEST COMING FROM CERNO                 
         JZ    XIT                                                              
         OC    TAGUEND,TAGUEND     AND GUARANTEE HAS A CYCLE ATTACHED           
         JZ    XIT                                                              
         CLC   TAGUEND,TCPCYCE     IF GUARANTEE EXPIRING BEFORE CYCLE           
         JNL   XIT                 END, RETURN ERROR                            
         MVC   WORK,ERRGRTEX                                                    
         GOTO1 SSNPACK,DMCB,TGSSN,WORK+ERRGRTEP-ERRGRTEX                        
         GOTO1 ADDERROR,DMCB,WORK                                               
         J     XIT                                                              
         DROP  R4                                                               
                                                                                
ERRGRTEX DC    AL1(ERGRTEXX-*),AL2(ERREXGRT),AL1(ERRCATY2),AL1(D#PYCST)         
         DC    AL2(0)                                                           
         DC    CL31'Current guarantee expiring for '                            
ERRGRTEP DC    CL6' '                                                           
ERGRTEXX EQU   *                                                                
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE SETS WEB OVERRIDE BITS IN CHECK RECORD               *         
*        ON ENTRY ... R4 = A(PAYMENT DETAILS ELEMENT)                 *         
***********************************************************************         
                                                                                
         USING TAPDD,R4                                                         
WEBOVERS NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    XIT                                                              
         TM    TGFASTAT,TGCRNOPY   (BUT NOT CERNO)                              
         JO    XIT                                                              
                                                                                
         USING WEBRESD,R2                                                       
WOVERS00 L     R2,TGAFARES                                                      
WOVERS10 CLC   WRSSEQ,TGCSORT+4    SEARCH WEB RESPONSE DETAILS AREA             
         JE    WOVERS20            FOR CAST SEQUENCE NUMBER                     
         CLI   0(R2),X'FF'                                                      
         JE    XIT                                                              
         LA    R2,WRSLNQ(R2)                                                    
         J     WOVERS10                                                         
                                                                                
WOVERS20 TM    WRSSTAT,WRSAMOVR    IF PAYMENT AMOUNT WAS OVERRIDDEN             
         JZ    WOVERS30                                                         
         OI    TAPDPST2,TAPDPOPA   SET PAYMENT AMOUNT OVERRIDE BIT              
                                                                                
WOVERS30 TM    WRSSTAT,WRSPHOVR    IF SUBJECT TO P&H WAS OVERRIDEN              
         JZ    XIT                                                              
         OI    TAPDPST2,TAPDPOPH   SET SUBJECT TO P&H OVERRIDE BIT              
         J     XIT                                                              
         DROP  R2,R4                                                            
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE SAVES WEB APPLICATION ID ON INVOICE                  *         
***********************************************************************         
                                                                                
ADDTAFNW NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    XIT                                                              
                                                                                
         USING TAFND,R4                                                         
         LA    R4,ELEMENT          INITIALIZE WEB APPLICATION ID                
         MVI   TAFNEL,TAFNELQ      ELEMENT                                      
         MVI   TAFNLEN,21                                                       
         MVI   TAFNTYPE,TAFNTWEB                                                
                                                                                
         TM    TGFASTAT,TGCRNOPY   IF PAYMENT COMING FROM CERNO                 
         JZ    ATW10               SAVE HOLDING FEE ID IN ELEMENT               
         MVC   TAFNNAME(2),=C'HF'                                               
         GOTO1 HEXOUT,DMCB,TGCOM,TAFNNAME+2,8,0                                 
         GOTO1 DATCON,DMCB,(1,TCPCYCS),(20,TAFNNAME+10)                         
         J     ATW20                                                            
                                                                                
         USING WEBREQD,RE                                                       
ATW10    L     RE,TGAFAREQ         OTHERWISE SAVE WEB APPLICATION ID            
         OC    WBWAPID,WBWAPID                            IN ELEMENT            
         JZ    XIT                                                              
         MVC   TAFNNAME(L'WBWAPID),WBWAPID                                      
         DROP  RE                                                               
                                                                                
ATW20    GOTO1 ADDELEM                                                          
         J     XIT                                                              
         DROP  R4                                                               
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE TO LAST FEW CHECKS FOR PAYMENTS COMING FROM WEB      *         
***********************************************************************         
                                                                                
WEBDONE  NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    NO                                                               
                                                                                
         TM    LCLSTAT2,NOFUND     NO FUND FOR I&R LOCAL CHECK?                 
         JZ    WDONE10                                                          
         GOTO1 ADDERROR,DMCB,ERFUNDNO                                           
                                                                                
WDONE10  TM    LCLSTAT,NOHNWADJ    NO LOCAL FOR H&W ADJUSTMENT                  
         JZ    YES                                                              
         GOTO1 ADDERROR,DMCB,ERNLHWAD                                           
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
ERFUNDNO DC    AL1(EFUNDNOX-*),AL2(ERNOFUND),AL1(ERRCATY1),AL1(D#PYCST)         
         DC    AL2(0)                                                           
         DC    C'No fund for I&&R Local check'                                  
EFUNDNOX EQU   *                                                                
                                                                                
ERNLHWAD DC    AL1(ENLHWADX-*),AL2(ERHWADNL),AL1(ERRCATY1),AL1(D#PYCST)         
         DC    AL2(0)                                                           
         DC    C'No local for H&&W adjustment'                                  
ENLHWADX EQU   *                                                                
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE TO HANDLE "INVALID ACTION FOR LOCKED AGENCY' ERROR   *         
***********************************************************************         
                                                                                
LCKAGY   NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    LCKAGY1             ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERLCKAGY                                           
         J     XIT                                                              
                                                                                
LCKAGY1  MVI   ERROR,ERAGYLCK      ELSE, SEND ERROR MESSAGE                     
         J     THEEND              TO SCREEN                                    
                                                                                
ERLCKAGY DC    AL1(ELCKAGYX-*),AL2(ERAGYLCK),AL1(ERRCATY3),AL1(D#PYAGY)         
         DC    AL2(0)                                                           
         DC    C'Invalid action for a locked agency'                            
ELCKAGYX EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "COMMERCIAL IS LOCKED' ERROR               *         
***********************************************************************         
                                                                                
CIDLCK   NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    CIDLCK1             ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERCIDLCK                                           
         J     XIT                                                              
                                                                                
CIDLCK1  MVI   ERROR,ERLOCKED      ELSE, SEND ERROR MESSAGE                     
         J     THEEND              TO SCREEN                                    
                                                                                
ERCIDLCK DC    AL1(ECIDLCKX-*),AL2(ERLOCKED),AL1(ERRCATY3),AL1(D#PYCID)         
         DC    AL2(0)                                                           
         DC    C'Commercial record is locked'                                   
ECIDLCKX EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "COMMERCIAL IS RELEASED' ERROR             *         
***********************************************************************         
                                                                                
CIDREL   NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    CIDREL1             ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERCIDREL                                           
         J     XIT                                                              
                                                                                
CIDREL1  MVI   ERROR,ERLOCKED      ELSE, SEND ERROR MESSAGE                     
         J     THEEND              TO SCREEN                                    
                                                                                
ERCIDREL DC    AL1(ECIDRELX-*),AL2(ERCOMREL),AL1(ERRCATY3),AL1(D#PYCID)         
         DC    AL2(0)                                                           
         DC    C'Commercial record is released'                                 
ECIDRELX EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "EDS ALREADY PAID FOR THIS COMM' ERROR               
***********************************************************************         
                                                                                
CIDEDS   NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    CIDEDS1             ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERCIDEDS                                           
         J     XIT                                                              
                                                                                
CIDEDS1  MVC   MYMSGNO,=Y(ERRPREDS)  ELSE, SEND ERROR MESSAGE                   
         J     NTHEEND               TO SCREEN                                  
                                                                                
ERCIDEDS DC    AL1(ECIDEDSX-*),AL2(ERCOMREL),AL1(ERRCATY3),AL1(D#PYCID)         
         DC    AL2(0)                                                           
         DC    C'EDS payment made previously'                                   
ECIDEDSX EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "INVALID COMMERCIAL TYPE" ERROR            *         
*        ON ENTRY ... R4=A(COMMERCIAL DETAILS ELEMENT)                *         
***********************************************************************         
                                                                                
         USING TACOD,R4                                                         
INVCTY   NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT FROM WEB ...                      
         JZ    INVCTYB                                                          
                                                                                
         LA    RF,ERCTYINV         RETURN "INVALID USE FOR COMM'L               
         TM    TGFASTAT,TGCRNOPY   TYPE" IF NOT COMING FROM CERNO               
         JZ    INVCTYA                                                          
                                                                                
         LA    RF,ERCTYHIN         IF COMING FROM CERNO                         
         CLI   TACOTYPE,0          AND COMMERCIAL TYPE IS NOT BLANK             
         JE    YES                                                              
         CLI   TACOTYPE,CTYADD     ADDENDUM                                     
         JE    YES                                                              
         CLI   TACOTYPE,CTYSEAS    SEASONAL                                     
         JE    YES                                                              
         CLI   TACOTYPE,CTYSEAS2   SEASONAL 2                                   
         JE    YES                                                              
         CLI   TACOTYPE,CTYIND     INDUSTRIAL                                   
         JE    YES                                                              
         CLI   TACOTYPE,CTYANIM    ANIMATICS                                    
         JE    YES                                                              
         CLI   TACOTYPE,CTYSPAN    SPANISH                                      
         JE    YES                                                              
         CLI   TACOTYPE,CTYASIAN   OR ASIAN                                     
         JE    YES                                                              
INVCTYA  GOTO1 ADDERROR,DMCB,(RF)  RETURN ERROR                                 
         J     XIT                                                              
         DROP  R4                                                               
                                                                                
INVCTYB  MVI   ERROR,ERUSECTY      ELSE, SEND ERROR MESSAGE                     
         J     THEEND              TO SCREEN                                    
                                                                                
ERCTYINV DC    AL1(ECTYINVX-*),AL2(ERUSECTY),AL1(ERRCATY3),AL1(D#PYCID)         
         DC    AL2(0)                                                           
         DC    C'Invalid use type for this Commercial Type'                     
ECTYINVX EQU   *                                                                
                                                                                
ERCTYHIN DC    AL1(ECTYHINX-*),AL2(ERUSECTY),AL1(ERRCATY3),AL1(D#PYCID)         
         DC    AL2(0)                                                           
         DC    C'Holding Fees invalid for this Commercial Type'                 
ECTYHINX EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "MISSING FIRST AIR DATE" ERROR             *         
***********************************************************************         
                                                                                
MS1AIR   NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    MS1AIR1             ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERMS1AIR                                           
         J     XIT                                                              
                                                                                
MS1AIR1 MVC    MYMSGNO,=Y(ERMSSFAD)  ELSE, SEND ERROR MESSAGE                   
         J     NTHEEND               TO SCREEN                                  
                                                                                
ERMS1AIR DC    AL1(EMS1AIRX-*),AL2(ERMSSFAD),AL1(ERRCATY3),AL1(D#PYCID)         
         DC    AL2(0)                                                           
         DC    C'Missing first air date'                                        
EMS1AIRX EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "SPLIT CYCLE INDICATOR NOT SET" ERROR      *         
***********************************************************************         
                                                                                
SPINST   NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    SPINST1             ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERSPINST                                           
         J     XIT                                                              
                                                                                
SPINST1  MVC   MYMSGNO,=Y(ERRSPCY) ELSE, SEND ERROR MESSAGE TO                  
         J     NTHEEND             SCREEN                                       
                                                                                
ERSPINST DC    AL1(ESPINSTX-*),AL2(ERRSPCY),AL1(ERRCATY1),AL1(D#PYCID)          
         DC    AL2(0)                                                           
         DC    C'Split cycle indicator not set'                                 
ESPINSTX EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "USE TYPE INVALID FOR THIS MEDIA" ERROR    *         
***********************************************************************         
                                                                                
MEDERR   NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    MEDERR1             ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERMEDERR                                           
         J     XIT                                                              
                                                                                
MEDERR1  MVI   ERROR,ERUSEMED      ELSE, SEND ERROR MESSAGE TO                  
         J     THEEND              SCREEN                                       
                                                                                
ERMEDERR DC    AL1(EMEDERRX-*),AL2(ERUSEMED),AL1(ERRCATY3),AL1(D#PYCID)         
         DC    AL2(0)                                                           
         DC    C'Use type invalid for this media'                               
EMEDERRX EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "CAST NOT VERIFIED" ERROR                  *         
***********************************************************************         
                                                                                
NOTVFY   NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    NOTVFY1             ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERNOTVFY                                           
         J     XIT                                                              
                                                                                
NOTVFY1  MVI   ERROR,ERNOTVER      ELSE, SEND ERROR MESSAGE TO                  
         J     THEEND              SCREEN                                       
                                                                                
ERNOTVFY DC    AL1(ENOTVFYX-*),AL2(ERNOTVER),AL1(ERRCATY1),AL1(D#PYCID)         
         DC    AL2(0)                                                           
         DC    C'Cast not verified'                                             
ENOTVFYX EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "AUTH/PO REQUIRED' ERROR                   *         
***********************************************************************         
                                                                                
AUTHRQ   NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    FLDMISS             ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERAUTHRQ                                           
         J     XIT                                                              
                                                                                
ERAUTHRQ DC    AL1(EAUTHRQX-*),AL2(ERAPOREQ),AL1(ERRCATY1),AL1(D#PYAPO)         
         DC    AL2(0)                                                           
         DC    C'PO# is required'                                               
EAUTHRQX EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "PURCHASE ORDER NOT FOUND' ERROR           *         
***********************************************************************         
                                                                                
INVPO    NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    INVPO1              ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERINVPO                                            
         J     XIT                                                              
                                                                                
INVPO1   MVI   ERROR,NOTFOUND      ELSE, SEND ERROR MESSAGE TO                  
         OI    LCLSTAT4,POERR      SCREEN                                       
         J     SETHIGH                                                          
                                                                                
ERINVPO  DC    AL1(EINVPOX-*),AL2(ERPONTFD),AL1(ERRCATY2),AL1(D#PYAPO)          
         DC    AL2(0)                                                           
         DC    C'PO# not found on Talent System'                                
EINVPOX  EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "PO NOT FOUND ON ACCOUNTING SYSTEM' ERROR  *         
***********************************************************************         
                                                                                
ACNTFD   NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    RECNTFND            ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERACNTFD                                           
         J     XIT                                                              
                                                                                
ERACNTFD DC    AL1(EACNTFDX-*),AL2(ERPONOAC),AL1(ERRCATY1),AL1(D#PYAPO)         
         DC    AL2(0)                                                           
         DC    C'PO# does not exist on the accounting system'                   
EACNTFDX EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "PO ALREADY CLOSED/MATCHED' ERROR          *         
***********************************************************************         
                                                                                
POCLOS   NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    POCLOS1             ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERPOCLOS                                           
         J     XIT                                                              
                                                                                
POCLOS1  MVC   MYMSGNO,=Y(ERPOCLSE)  ELSE, SEND ERROR MESSAGE TO                
         J     NTHEEND               SCREEN                                     
                                                                                
ERPOCLOS DC    AL1(EPOCLOSX-*),AL2(ERPOCLSE),AL1(ERRCATY1),AL1(D#PYAPO)         
         DC    AL2(0)                                                           
         DC    C'PO# already closed/matched'                                    
EPOCLOSX EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "JOB REQUIRED FOR THIS PO" error           *         
***********************************************************************         
                                                                                
POMJOB   NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    POMJOB1             ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERPOMJOB                                           
         J     XIT                                                              
                                                                                
POMJOB1  MVC   MYMSGNO,=Y(ERMISJOB)  ELSE, SEND ERROR MESSAGE TO                
         J     NTHEEND               SCREEN                                     
                                                                                
ERPOMJOB DC    AL1(EPOMJOBX-*),AL2(ERMISJOB),AL1(ERRCATY1),AL1(D#PYEST)         
         DC    AL2(0)                                                           
         DC    C'Job# is required for this PO#'                                 
EPOMJOBX EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "INVALID JOB FOR THIS PO" ERROR            *         
***********************************************************************         
                                                                                
POJOB    NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    POJOB1              ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERPOJOB                                            
         J     XIT                                                              
                                                                                
POJOB1   MVC   MYMSGNO,=Y(ERPOIJOB)  ELSE, SEND ERROR MESSAGE TO                
         J     NTHEEND               SCREEN                                     
                                                                                
ERPOJOB  DC    AL1(EPOJOBX-*),AL2(ERPOIJOB),AL1(ERRCATY1),AL1(D#PYEST)          
         DC    AL2(0)                                                           
         DC    C'Invalid job# for this PO#'                                     
EPOJOBX  EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "END DATE WARNING' ERROR                   *         
***********************************************************************         
                                                                                
ENDWRN   NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    ENDWRN1             APPLICATION                                  
         MVC   TGPCYC,TCPCYC       SAVE CYCLE                                   
         TM    TGFASTAT,TGVITSES+TGVITCMP                                       
         JNZ   XIT                 DO NOT RETURN WARNING TO VITA                
         GOTO1 ADDERROR,DMCB,ERENDWRN                                           
         J     XIT                                                              
                                                                                
ENDWRN1  MVI   ERROR,ERWRNEDT      END DATE WARNING - PFKEY TO ALLOW            
         OI    CYCSTAT,CYSTEEND    SET CYCLE ERROR STATUS                       
         J     SETHIGH                                                          
                                                                                
ERENDWRN DC    AL1(EENDWRNX-*),AL2(ERWRNEDT),AL1(ERRCATY2),AL1(D#PYCYC)         
         DC    AL2(0)                                                           
         DC    C'Invalid end date'                                              
EENDWRNX EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "INVALID OPTION" ERROR                     *         
*        ON ENTRY ... R3=A(SCANNER BLOCK)                                       
***********************************************************************         
                                                                                
         USING SCAND,R3                                                         
INVOPT   NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB ...               
         JZ    FLDINV                                                           
                                                                                
         MVC   WORK,ERINVOPT       COPY ERROR MESSAGE TO WORK                   
                                                                                
         TM    LCLSTAT5,OPTINERR   ... AND OPTION IS INVALID                    
         JZ    IOPT10              ADD TO ERROR BLOCK                           
         MVC   WORK+ERIO-ERINVOPT(L'ERIO1),ERIO1                                
         MVC   WORK+ERIO+L'ERIO1-ERINVOPT(L'ERIO),SPACES                        
         MVC   WORK+ERIO+L'ERIO1-ERINVOPT(L'SCDATA1),SCDATA1                    
         J     IOPT20                                                           
                                                                                
IOPT10   TM    LCLSTAT5,OPTRHERR   ... OR ENTRY FOR OPTION IS INVALID           
         JZ    XIT                 ADD TO ERROR BLOCK                           
         MVC   WORK+ERIO-ERINVOPT(L'ERIO2),ERIO2                                
         MVC   WORK+ERIO+L'ERIO2-ERINVOPT(L'ERIO),SPACES                        
         MVC   WORK+ERIO+L'ERIO2-ERINVOPT(L'SCDATA1),SCDATA1                    
IOPT20   GOTO1 ADDERROR,DMCB,WORK                                               
         J     XIT                                                              
         DROP  R3                                                               
                                                                                
ERINVOPT DC    AL1(EINVOPTX-*),AL2(EROPTINV),AL1(ERRCATY1),AL1(D#PYOPT)         
         DC    AL2(0)                                                           
ERIO     DC    CL60' '                                                          
EINVOPTX EQU   *                                                                
                                                                                
ERIO1    DC    C'Invalid Option: '                                              
ERIO2    DC    C'Invalid input for Option '                                     
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "JOB IS REQUIRED' ERROR                    *         
***********************************************************************         
                                                                                
JOBREQ   NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    JOBREQ5             ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERJOBREQ                                           
         J     XIT                                                              
                                                                                
JOBREQ5  TM    TGAYSTA7,TAAYSBBD   IF AGENCY IS BBDO JOB AGENCY                 
         JZ    FLDINV                                                           
         J     FLDMISS                                                          
                                                                                
ERJOBREQ DC    AL1(EJOBREQX-*),AL2(ERREQJOB),AL1(ERRCATY1),AL1(D#PYEST)         
         DC    AL2(0)                                                           
         DC    C'Job# is required'                                              
EJOBREQX EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "JOB DOES NOT EXIST ON TALENT SYSTEM' ERR  *         
***********************************************************************         
                                                                                
JOBNEX   NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    JOBNEX1             ADD TO ERROR BLOCK                           
         LA    RF,ERJOBNEX                                                      
         TM    TGAYSTA7,TAAYSBBD                                                
         JZ    *+8                                                              
         LA    RF,ERJOBNE1                                                      
         GOTO1 ADDERROR,DMCB,0(RF)                                              
         J     XIT                                                              
                                                                                
JOBNEX1  MVC   TGCLI,WORK2         ELSE, SEND ERROR MESSAGE TO                  
         MVC   TGPRD,WORK2+L'TGCLI SCREEN                                       
         CLC   TGPRD,SPACES                                                     
         BNE   *+10                                                             
         XC    TGPRD,TGPRD                                                      
         J     FLDINV                                                           
                                                                                
ERJOBNE1 DC    AL1(EJOBNE1X-*),AL2(ERNEXJOB),AL1(ERRCATY1),AL1(D#PYSI1)         
         DC    AL2(0)                                                           
         DC    C'Job does not exist on Talent System'                           
EJOBNE1X EQU   *                                                                
                                                                                
ERJOBNEX DC    AL1(EJOBNEXX-*),AL2(ERNEXJOB),AL1(ERRCATY1),AL1(D#PYEST)         
         DC    AL2(0)                                                           
         DC    C'Job does not exist on Talent System'                           
EJOBNEXX EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "JOB DOES NOT EXIST ON JOB RECORD" ERROR   *         
***********************************************************************         
                                                                                
JOBJNC   NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    JOBJNC1             ADD TO ERROR BLOCK                           
         LA    RF,ERJOBJNC                                                      
         TM    TGAYSTA7,TAAYSBBD                                                
         JZ    *+8                                                              
         LA    RF,ERJOBJN1                                                      
         GOTO1 ADDERROR,DMCB,0(RF)                                              
         J     XIT                                                              
                                                                                
JOBJNC1  MVC   TGCLI,WORK2         ELSE, SEND ERROR MESSAGE TO                  
         MVC   TGPRD,WORK2+L'TGCLI SCREEN                                       
         CLC   TGPRD,SPACES                                                     
         BNE   *+10                                                             
         XC    TGPRD,TGPRD                                                      
         MVI   ERROR,ERINVJOB      INV JOB NUMBER - PFKEY TO ALLOW              
         TM    TGAYSTA7,TAAYSBBD   IF AGENCY IS BBDO JOB AGENCY                 
         BZ    JOBJNC5                                                          
         MVC   MYMSGNO,=Y(ERNEXJOB) ELSE, SEND ERROR MESSAGE TO                 
         J     NTHEEND              SCREEN                                      
                                                                                
JOBJNC5  OI    LCLSTAT2,JOBERR     SET JOB NUMBER ERROR PENDING                 
         OI    1(R2),X'08'         SET FIELD TO HIGH INTENSITY                  
         OI    4(R2),X'20'         SET PREVIOUSLY VALIDATED                     
         OI    6(R2),X'80'                                                      
         J     THEEND                                                           
                                                                                
ERJOBJN1 DC    AL1(EJOBJN1X-*),AL2(ERNJCJOB),AL1(ERRCATY1),AL1(D#PYEST)         
         DC    AL2(0)                                                           
         DC    C'Job # does not exist on Job record'                            
EJOBJN1X EQU   *                                                                
                                                                                
ERJOBJNC DC    AL1(EJOBJNCX-*),AL2(ERNJCJOB),AL1(ERRCATY2),AL1(D#PYEST)         
         DC    AL2(0)                                                           
         DC    C'Job # does not exist on Job record'                            
EJOBJNCX EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "JOB IS REQUIRED' ERROR                    *         
***********************************************************************         
                                                                                
JOBRQ    NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    FLDMISS             ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERJOBRQ                                            
         J     XIT                                                              
                                                                                
ERJOBRQ  DC    AL1(EJOBRQX-*),AL2(ERREQJOB),AL1(ERRCATY1),AL1(D#PYEST)          
         DC    AL2(0)                                                           
         DC    C'Job# is required'                                              
EJOBRQX  EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "INTERFACE RECORD NOT FOUND" ERROR         *         
***********************************************************************         
                                                                                
INTACC   NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    THEEND              ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERINTACC                                           
         J     XIT                                                              
                                                                                
ERINTACC DC    AL1(EINTACCX-*),AL2(ERINTER),AL1(ERRCATY1),AL1(D#PYEST)          
         DC    AL2(0)                                                           
         DC    C'Interface record does not exist - contact Talent Partn+        
               ers'                                                             
EINTACCX EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "CAN'T SWITCH TO ACCOUNTING SYSTEM" ERROR  *         
***********************************************************************         
                                                                                
SWTACC   NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    THEEND              ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERSWTACC                                           
         J     XIT                                                              
                                                                                
ERSWTACC DC    AL1(ESWTACCX-*),AL2(ERSWACC),AL1(ERRCATY1),AL1(D#PYEST)          
         DC    AL2(0)                                                           
         DC    C'DDS system is unavailable, can not validate'                   
ESWTACCX EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "JOB IS CLOSED/LOCKED" ERROR               *         
***********************************************************************         
                                                                                
LCKCLS   NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    LCKCLS1             ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERLCKCLS                                           
         J     XIT                                                              
                                                                                
LCKCLS1  MVI   ERROR,ERCLSLCK      ELSE, SEND ERROR MESSAGE TO                  
         J     THEEND              SCREEN                                       
                                                                                
ERLCKCLS DC    AL1(ELCKCLSX-*),AL2(ERCLSLCK),AL1(ERRCATY1),AL1(D#PYEST)         
         DC    AL2(0)                                                           
         DC    C'Job# is closed or locked'                                      
ELCKCLSX EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "JOB IS DRAFT" ERROR                       *         
***********************************************************************         
                                                                                
DFTJOB   NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    DFTJOB1             ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERDFJOB                                            
         J     XIT                                                              
                                                                                
DFTJOB1  MVC   MYMSGNO,=Y(ERDFTJOB) ELSE, SEND ERROR MESSAGE TO                 
         J     NTHEEND              SCREEN                                      
                                                                                
ERDFJOB  DC    AL1(EDFJOBX-*),AL2(ERDFTJOB),AL1(ERRCATY1),AL1(D#PYEST)          
         DC    AL2(0)                                                           
         DC    C'Job is draft'                                                  
EDFJOBX  EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "JOB CANNOT EXCEED 12 CHARACTERS" ERROR    *         
***********************************************************************         
                                                                                
JOB12    NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    FLDINV              ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERJOB12                                            
         J     XIT                                                              
                                                                                
ERJOB12  DC    AL1(EJOB12X-*),AL2(ER12JOB),AL1(ERRCATY1),AL1(D#PYEST)           
         DC    AL2(0)                                                           
         DC    C'Job# cannot exceed 12 characters'                              
EJOB12X  EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "JOB DOES NOT EXIST ON ACC." ERROR         *         
***********************************************************************         
                                                                                
JBACC    NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    THEEND              ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERJBACC                                            
         J     XIT                                                              
                                                                                
ERJBACC  DC    AL1(EJBACCX-*),AL2(ERACCJB),AL1(ERRCATY1),AL1(D#PYEST)           
         DC    AL2(0)                                                           
         DC    C'Job# does not exist on Accounting system'                      
EJBACCX  EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "JOB CANNOT EXCEED 12 CHARACTERS" ERROR    *         
***********************************************************************         
                                                                                
JOB12O   NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    JOBINV              ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERJOB12O                                           
         J     XIT                                                              
                                                                                
ERJOB12O DC    AL1(EJOB12OX-*),AL2(ER12JOBO),AL1(ERRCATY2),AL1(D#PYEST)         
         DC    AL2(0)                                                           
         DC    C'Job# cannot exceed 12 characters'                              
EJOB12OX EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "JOB DOES NOT EXIST ON ACC." ERROR         *         
***********************************************************************         
                                                                                
JBACCO   NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    JOBINV              ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERJBACCO                                           
         J     XIT                                                              
                                                                                
ERJBACCO DC    AL1(EJBACCOX-*),AL2(ERACCJBO),AL1(ERRCATY2),AL1(D#PYEST)         
         DC    AL2(0)                                                           
         DC    C'Job# does not exist on Accounting system'                      
EJBACCOX EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "CYCLE DATE OVERLAP" ERROR                 *         
***********************************************************************         
                                                                                
EROVLAP  NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    OVERLAP             ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,ERCYOVLP                                           
         J     XIT                                                              
                                                                                
ERCYOVLP DC    AL1(ECYOVLPX-*),AL2(EROVRLAP),AL1(ERRCATY2),AL1(D#PYCYC)         
         DC    AL2(0)                                                           
         DC    C'Cycle overlaps last payment'                                   
ECYOVLPX EQU   *                                                                
                                                                                
***********************************************************************         
*        ROUTINE TO HANDLE "INVALID PUBLICIS JOB" ERROR               *         
***********************************************************************         
                                                                                
ERPUBJOB NTR1  BASE=*,LABEL=*                                                   
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    EPJ10               ADD TO ERROR BLOCK                           
         GOTO1 ADDERROR,DMCB,EPJE                                               
         J     XIT                                                              
                                                                                
EPJ10    MVC   MYMSGNO,=Y(EPUBJOB) ELSE, SEND ERROR MESSAGE TO                  
         J     NTHEEND             SCREEN                                       
                                                                                
EPJE     DC    AL1(EPJEX-*),AL2(EPUBJOB),AL1(ERRCATY1),AL1(D#PYEST)             
         DC    AL2(0)                                                           
         DC    C'Invalid input field. Type ''DEFAULT'' to enter '               
         DC    C'default job'                                                   
EPJEX    EQU   *                                                                
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE DETERMINES IF ANY ERRORS HAVE BEEN ENCOUNTERED       *         
*        THAT SHOULD ABORT A WEB TRANSACTION IMMEDIATELY              *         
***********************************************************************         
                                                                                
WEBERRS  NTR1  BASE=*,LABEL=*                                                   
         USING ERRENTD,RE                                                       
         TM    TGFASTAT,TGFROMFA   IF PAYMENT COMING FROM WEB                   
         JZ    NO                                                               
         L     RE,TGAERTAB                                                      
         CLI   EECATY,ERRCATY3     AND A CATEGORY 3 WAS FOUND                   
         J     XIT                 TERMINATE THIS TRANSACTION                   
         DROP  RE                                                               
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE DETERMINES IF COMMERCIAL HAS VERSIONS                *         
***********************************************************************         
                                                                                
HASVER   NTR1  BASE=*,LABEL=*                                                   
         TM    TGUSSTA3,VERSONLY   TEST VERSIONS ALLOWED                        
         JZ    NO                                                               
         L     R4,AIO                                                           
         MVI   ELCODE,TAVRELQ                                                   
         BRAS  RE,GETEL                                                         
         J     XIT                                                              
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE VALIDATES CYCLE START DATE                           *         
*        ON ENTRY ... R3=A(PERVAL BLOCK)                              *         
***********************************************************************         
                                                                                
         USING PERVALD,R3                                                       
VALCYS   NTR1  BASE=*,LABEL=*                                                   
         CLI   TGUSEQU,UINR        IF USE IS INDUSTRIAL REUSE                   
         JE    VCYS10                                                           
         CLI   TGUSEQU,USIN        OR SPANISH INDUSTRIAL REUSE                  
         JE    VCYS10                                                           
         CLI   TGUSEQU,UCNM        IF USE IS CANADIAN NEW MEDIA                 
         JE    VCYS40                                                           
         CLI   TGUSEQU,UNMC        OR NEW MEDIA CANADA                          
         JE    VCYS50                                                           
                                                                                
         CLI   TGUSEQU,UFGR        IF USE IS FOREIGN REUSE                      
         JNE   XIT                                                              
         CLI   TGUSTYP,UFGREXT     (BUT NOT EXTENSION)                          
         JE    XIT                                                              
                                                                                
         USING TACOD,R4                                                         
VCYS10   LA    R4,ELTACO                                                        
         OC    TACOEXP,TACOEXP     AND COMMERCIAL HAS AN EXPIRATION             
         JZ    XIT                 DATE ...                                     
                                                                                
         CLC   PVALPSTA,TACOEXP    IF CYCLE START IS EARLIER                    
         JNH   VCYS20              THAN THE EXPIRATION DATE                     
         CLI   TACOCTYP,CCTY04A    GIVE ERROR MESSAGE                           
         JE    VCYS15                                                           
         CLI   TACOCTYP,CCTY2404                                                
         JNE   ERREXPUP                                                         
VCYS15   CLC   PVALPSTA,TACOAEXP                                                
         JH    ERREXSUP                                                         
         J     ERREXPUP                                                         
VCYS20   CLI   TACOCTYP,CCTY04A    IF COMMERCIAL'S ACTRA TYPE IS 04A            
         JE    VCYS30                                                           
         CLI   TACOCTYP,CCTY2404   OR ACTRA TYPE IS 2404                        
         JNE   XIT                 AND CYCLE START DATE IS EARLIER              
VCYS30   CLC   PVALPSTA,TACOAEXP   THAN THE ACTRA EXPIRATION DATE               
         JH    ERRCEXUP            GIVE ERROR MESSAGE                           
         J     XIT                                                              
VCYS40   CLC   PVALPSTA,=X'B40630' CNM CANNOT BE AFTER 2014JUN30                
         JH    ERRUSCYS            GIVE ERROR MESSAGE                           
         J     XIT                                                              
VCYS50   CLC   PVALPSTA,=X'B40701' NMC CANNOT BE BEFORE 2014JUL01               
         JL    ERRUSCYS            GIVE ERROR MESSAGE                           
         J     XIT                                                              
         DROP  R3,R4                                                            
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE SETS/VALIDATES CANADIAN CYCLE DATES                  *         
***********************************************************************         
                                                                                
VALCED   NTR1  BASE=*,LABEL=*                                                   
         OC    AACTCYCE,AACTCYCE   IF PAYMENT SCREEN HAS                        
         JZ    XIT                 CANADIAN CYCLE END DATE FIELD ...            
                                                                                
         USING PERVALD,R3                                                       
         USING TACOD,R4                                                         
         L     R2,AACTCYCE                                                      
         CLI   5(R2),0             IF NOT POPULATED                             
         JNE   VCED30              AUTOMATICALLY CALCULATE AS                   
         LA    R4,ELTACO           THE EARLIEST OF ACTRA EXPIRATION             
         MVC   ACTCYCE,TACOAEXP    DATE                                         
         TM    TGUSSTAT,SESSION                                                 
         JO    VCED10                                                           
         OC    TACOAIR,TACOAIR     OR 18 MONTHS BEYOND CYCLE START              
         JNZ   VCED10              DATE                                         
         GOTO1 DATCON,DMCB,(1,TCPCYCS),(8,WORK)                                 
         MVC   WORK+8(6),=C'-(18M)'                                             
         LA    R3,BLOCK                                                         
         GOTO1 PERVAL,DMCB,(14,WORK),('PVIN1DYL',BLOCK)                         
         CLC   ACTCYCE,PVALPEND                                                 
         JL    VCED10                                                           
         MVC   ACTCYCE,PVALPEND                                                 
VCED10   OC    ORIGCYCE,ORIGCYCE                                                
         JZ    VCED20                                                           
         CLC   ORIGCYCE,TACOAEXP   OR PAYMENT'S ORIGINAL CYCLE END              
         JH    VCED20              DATE                                         
         MVC   ACTCYCE,ORIGCYCE                                                 
VCED20   GOTO1 DATCON,DMCB,(1,ACTCYCE),(8,8(R2))                                
         MVI   5(R2),8                                                          
         OI    6(R2),X'80'         AND PROMPT USER TO REVIEW                    
         MVC   MYMSGNO,=Y(ERREVCED) CALCULATED DATE                             
         J     NTHEEND                                                          
         DROP  R3,R4                                                            
                                                                                
VCED30   GOTO1 DTVAL,DMCB,ACTCYCE  OTHERWISE, VALIDATE INPUTTED DATE            
         CLC   TCPCYCS,ACTCYCE     AND ENSURE IT IS NOT EARLIER THAN            
         JNL   ERRCEXUP            CYCLE START DATE                             
         J     XIT                                                              
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE CALLS TSAR USING TSARAREA FOR A(TSAR RECORD)         *         
*        MYTSRNUM AND MYTSACTN ARE SE                                 *         
*        MYTSRNUM AND MYTSACTN ARE SE                                 *         
***********************************************************************         
                                                                                
CALLTSAR NTR1  BASE=*,LABEL=*                                                   
         L     R2,ATMPPAYD         USE TEMPORARY STORAGE                        
         USING TMPPAYD,R2                                                       
         LA    R1,TSARAREA                                                      
         ST    R1,TCATSAR          SET A(TSAR RECORD)                           
         LA    R1,ECSTRLNQ                                                      
         STCM  R1,3,MYTSRECL       REC LENGTH                                   
         MVI   MYTSKEYL,ECSTKLNQ   KEY LENGTH                                   
         MVI   MYTSPAGN,6          SET 6 14K PAGES - MAX 192 TSAR RECS          
         MVI   MYTSINDS,TSIRTNAF+TSIALLOC  SET FOR TEMPEST                      
         GOTO1 TSARCNTL,DMCB,TCATSAR                                            
         JE    YES                                                              
         J     NO                                                               
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE TO OBTAIN CSF MAXIMUM                                *         
***********************************************************************         
                                                                                
         USING TACOD,R4                                                         
CSFMAX   NTR1  BASE=*,LABEL=*                                                   
         L     R4,TCATACO           R4=A(COMMERCIAL DETAILS EL.)                
         LA    RE,CSFTBL            RE=A(CSF TABLE WITH MAX PYMTS)              
CSFM10   CLI   0(RE),X'FF'                                                      
         JE    NO                                                               
         CLC   TACOCTYP,0(RE)                                                   
         JE    *+12                                                             
         LA    RE,L'CSFTBL(RE)                                                  
         J     CSFM10                                                           
         ICM   R4,15,1(RE)          R4=TV RATE                                  
         TM    TGMEEQU,RADIO                                                    
         JZ    *+8                                                              
         ICM   R4,15,5(RE)          R4=RADIO RATE                               
         ST    R4,SVCSFMAX          SAVE MAXIMUM PAYMENT                        
         J     YES                                                              
         DROP  R4                                                               
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
       ++INCLUDE TASYSCSF          CSF TABLE                                    
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE SETS THE END DATE FOR INDUSTRIALS                    *         
***********************************************************************         
                                                                                
         USING PERVALD,R3                                                       
         USING TACOD,R4                                                         
INDDATE  NTR1  BASE=*,LABEL=*                                                   
         LA    R4,ELTACO                                                        
                                                                                
*        REVERSE CAT1 AND CAT2 FOR DIO                                          
                                                                                
         CLI   TGUSEQU,UDIO        IF DIO                                       
         JNE   INDDATE1                                                         
                                                                                
         CLI   TACOTYPE,CTYICAT1      IF CAT 1 INDUSTRIAL                       
         JE    INDDATE2                  YES - 5 YEAR END DATE                  
         J     XIT                       NO  - NO END DATE                      
                                                                                
INDDATE1 CLI   TACOTYPE,CTYICAT2   CAT 2 INDUSTRIAL?                            
         JNE   XIT                 NO, CAT 1 HAS NO END DATE                    
                                                                                
INDDATE2 CLC   PVALPSTA,TACOEXP    TEST START NOT AFTER EXPIRY DATE             
         JH    INDDATE5                                                         
         MVC   PVALPEND,TACOEXP    SET END DATE = EXPIRY DATE                   
INDDATE3 LA    R2,PVALCPER                                                      
         MVI   8(R2),C'-'          SET DISPLAYABLE CYCLE DATES                  
         GOTO1 DATCON,DMCB,(1,PVALPEND),(8,9(R2))                               
         MVC   TCPCYCE,PVALPEND                                                 
         J     XIT                                                              
         DROP  R4                                                               
                                                                                
*NDDATE5 GOTO1 ADDAY,DMCB,(C'Y',PVALESTA),PVALEEND,5      ADD 5 YEARS           
INDDATE5 GOTO1 ADDAY,DMCB,(C'Y',PVALESTA),PVALEEND,3      ADD 3 YEARS           
         GOTO1 ADDAY,DMCB,(C'D',PVALEEND),PVALEEND,-1     LESS 1 DAY            
         GOTO1 DATCON,DMCB,(0,PVALEEND),(1,PVALPEND)                            
         J     INDDATE3                                                         
         DROP  R3                                                               
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE ENSURES THAT GUARANTEE CONTRACT IS NOT UPDATED       *         
*        MID-PAYMENT                                                  *         
***********************************************************************         
                                                                                
CHKGCON  NTR1  BASE=*,LABEL=*                                                   
         OC    GCCYEAR,GCCYEAR                                                  
         JZ    XIT                                                              
                                                                                
         USING TLGCD,R3                                                         
         LA    R3,KEY                                                           
         XC    KEY,KEY                                                          
         MVI   TLGCCD,TLGCCDQ                                                   
         MVC   TLGCSSN,TGSSN                                                    
         MVC   TLGCGCNT,GUARCONT                                                
         GOTO1 HIGH                                                             
         CLC   KEY(L'TLGCKEY),KEYSAVE                                           
         JNE   CGC20                                                            
         DROP  R3                                                               
                                                                                
         L     R0,AIO                                                           
         MVC   AIO,AIO3                                                         
         GOTO1 GETREC                                                           
         ST    R0,AIO                                                           
                                                                                
         USING TAGCD,R4                                                         
         L     R4,AIO3                                                          
         MVI   ELCODE,TAGCELQ                                                   
         BRAS  RE,GETEL                                                         
         J     *+8                                                              
CGC10    BRAS  RE,NEXTEL                                                        
         JNE   CGC20                                                            
         CLC   TAGCPD,GCCYEAR                                                   
         JNE   CGC10                                                            
         CLC   GCBAL,TAGCBAL                                                    
         JE    XIT                                                              
         DROP  R4                                                               
                                                                                
CGC20    OI    LCLSTAT8,VGCONCHG                                                
         J     XIT                                                              
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE SAVES CREDIT INVOICE BILLING RATES ELEMENT           *         
***********************************************************************         
                                                                                
SVCRTARA NTR1  BASE=*,LABEL=*                                                   
         TM    PAYSTAT2,TAPDPCIB   IF CRED INV HAS SAVED BILL RATES             
         JZ    XIT                                                              
                                                                                
         XC    ELTARA,ELTARA                                                    
                                                                                
         USING TLIND,R3                                                         
         LA    R3,KEY                                                           
         XC    KEY,KEY                                                          
         MVI   TLINCD,TLINCDQ                                                   
         MVC   TLINAGY,TGAGY                                                    
         MVC   TLININV,EINVNO                                                   
         XC    TLININV,=6X'FF'                                                  
         GOTO1 HIGH                                                             
         CLC   TLINKEY,KEYSAVE                                                  
         JNE   XIT                                                              
         GOTO1 GETREC                                                           
         DROP  R3                                                               
                                                                                
         USING TARAD,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TARAELQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   XIT                                                              
         MVC   ELTARA,0(R4)        SAVE IT                                      
         J     XIT                                                              
         DROP  R4                                                               
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE VALIDATED CREDIT INVOICE BILLING RATES ELEMENT       *         
*        ON ENTRY ... AIO = A(INVOICE TO CREDIT)                      *         
***********************************************************************         
                                                                                
VACRTARA NTR1  BASE=*,LABEL=*                                                   
         TM    PAYMODE,DRAFT       IF THIS IS NOT A DRAFT PAYMENT               
         JO    XIT                                                              
                                                                                
         L     R4,AIO                                                           
         MVI   ELCODE,TARAELQ      AND CREDIT INVOICE HAS SAVED                 
         BRAS  RE,GETEL            BILLING RATES                                
         JNE   XIT                                                              
         MVC   ELTARA,0(R4)                                                     
                                                                                
         GOTO1 RECVAL,DMCB,TLINCDQ,(X'20',0)                                    
         JE    *+6                                                              
         DC    H'00'                                                            
                                                                                
***********************************************************************         
                                                                                
         USING TARAD,R3                                                         
         LA    R3,ELTARA                                                        
         CLI   TARASTA2,0          IF ANY RATES WERE OVERRIDDEN ON              
         JE    VCT10               THE INVOICE BEING CREDITED ...               
                                                                                
         L     R4,AIO                                                           
         MVI   ELCODE,TARAELQ      ... THE SAME RATES NEED TO BE                
         BRAS  RE,GETEL            OVERRIDDEN ON THE CREDIT INVOICE             
         JNE   FLDINV                                                           
                                                                                
         TM    TARASTA2,TARASSHD   IF BASIC HANDLING WAS OVERRIDDEN             
         JZ    *+12                MUST BE OVERRIDEN BY CREDIT TOO              
         TM    TARASTA2-TARAD(R4),TARASSHD                                      
         JZ    FLDINV                                                           
                                                                                
         TM    TARASTA2,TARASSCD   IF CANADIAN HANDLING WAS OVERRIDDEN          
         JZ    *+12                MUST BE OVERRIDEN BY CREDIT TOO              
         TM    TARASTA2-TARAD(R4),TARASSCD                                      
         JZ    FLDINV                                                           
                                                                                
         TM    TARASTA2,TARASSPD   IF PREMIUM HANDLING WAS OVERRIDDEN           
         JZ    *+12                MUST BE OVERRIDEN BY CREDIT TOO              
         TM    TARASTA2-TARAD(R4),TARASSPD                                      
         JZ    FLDINV                                                           
                                                                                
         TM    TARASTA2,TARASFUD   IF FUTA WAS OVERRIDDEN                       
         JZ    *+12                MUST BE OVERRIDEN BY CREDIT TOO              
         TM    TARASTA2-TARAD(R4),TARASFUD                                      
         JZ    FLDINV                                                           
                                                                                
         TM    TARASTA2,TARASSUD   IF SUTA WAS OVERRIDDEN                       
         JZ    *+12                MUST BE OVERRIDEN BY CREDIT TOO              
         TM    TARASTA2-TARAD(R4),TARASSUD                                      
         JZ    FLDINV                                                           
                                                                                
         TM    TARASTA2,TARASFID   IF FICA WAS OVERRIDDEN                       
         JZ    *+12                MUST BE OVERRIDEN BY CREDIT TOO              
         TM    TARASTA2-TARAD(R4),TARASFID                                      
         JZ    FLDINV                                                           
                                                                                
         TM    TARASTA2,TARASMED   IF MEDICARE WAS OVERRIDDEN                   
         JZ    *+12                MUST BE OVERRIDEN BY CREDIT TOO              
         TM    TARASTA2-TARAD(R4),TARASMED                                      
         JZ    FLDINV                                                           
                                                                                
         TM    TARASTA2,TARASWCD   IF WORKERS COMP WAS OVERRIDDEN               
         JZ    *+12                MUST BE OVERRIDEN BY CREDIT TOO              
         TM    TARASTA2-TARAD(R4),TARASWCD                                      
         JZ    FLDINV                                                           
                                                                                
***********************************************************************         
                                                                                
VCT10    L     R4,AIO                                                           
         MVI   ELCODE,TARAELQ      IF THIS INVOICE HAS OVERRIDDEN               
         BRAS  RE,GETEL            RATES                                        
         JNE   XIT                                                              
                                                                                
         TM    TARASTA2-TARAD(R4),TARASSHD                                      
         JZ    *+20                IF BASIC HAND IS BEING OVERRIDDEN            
         OI    TARASTA2,TARASSHD   OVERWRITE INVOICE BEING CREDITED             
         MVC   TARAHFB,TARAHFB-TARAD(R4)                                        
         MVC   TARARFB,TARARFB-TARAD(R4)                                        
                                                                                
         TM    TARASTA2-TARAD(R4),TARASSCD                                      
         JZ    *+20                IF CAN HAND IS BEING OVERRIDDEN              
         OI    TARASTA2,TARASSCD   OVERWRITE INVOICE BEING CREDITED             
         MVC   TARAHFBC,TARAHFBC-TARAD(R4)                                      
         MVC   TARARFBC,TARARFBC-TARAD(R4)                                      
                                                                                
         TM    TARASTA2-TARAD(R4),TARASSPD                                      
         JZ    *+20                IF PREM HAND IS BEING OVERRIDDEN             
         OI    TARASTA2,TARASSPD   OVERWRITE INVOICE BEING CREDITED             
         MVC   TARAHFP,TARAHFP-TARAD(R4)                                        
         MVC   TARARFP,TARARFP-TARAD(R4)                                        
                                                                                
         TM    TARASTA2-TARAD(R4),TARASFUD                                      
         JZ    *+14                IF FUTA IS BEING OVERRIDDEN                  
         OI    TARASTA2,TARASFUD   OVERWRITE INVOICE BEING CREDITED             
         MVC   TARATFU,TARATFU-TARAD(R4)                                        
                                                                                
         TM    TARASTA2-TARAD(R4),TARASSUD                                      
         JZ    *+14                IF SUTA IS BEING OVERRIDDEN                  
         OI    TARASTA2,TARASSUD   OVERWRITE INVOICE BEING CREDITED             
         MVC   TARATSU,TARATSU-TARAD(R4)                                        
                                                                                
         TM    TARASTA2-TARAD(R4),TARASFID                                      
         JZ    *+14                IF FICA IS BEING OVERRIDDEN                  
         OI    TARASTA2,TARASFID   OVERWRITE INVOICE BEING CREDITED             
         MVC   TARATFI,TARATFI-TARAD(R4)                                        
                                                                                
         TM    TARASTA2-TARAD(R4),TARASMED                                      
         JZ    *+14                IF MEDICARE IS BEING OVERRIDDEN              
         OI    TARASTA2,TARASMED   OVERWRITE INVOICE BEING CREDITED             
         MVC   TARATM,TARATM-TARAD(R4)                                          
                                                                                
         TM    TARASTA2-TARAD(R4),TARASWCD                                      
         JZ    XIT                 IF WC IS BEING OVERRIDDEN                    
         OI    TARASTA2,TARASWCD   OVERWRITE INVOICE BEING CREDITED             
         MVC   TARATWC,TARATWC-TARAD(R4)                                        
         J     XIT                                                              
         DROP  R3                                                               
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE PROCESSES INVOICE'S EVENT INFORMATION                *         
***********************************************************************         
                                                                                
PROINVE  NTR1  BASE=*,LABEL=*                                                   
         CLI   TGUSEQU,UEVE                                                     
         JNE   XIT                                                              
         CLI   TWASCR,SCR90                                                     
         JL    PIE10                                                            
         CLI   TWASCR,SCR99                                                     
         JNH   XIT                                                              
                                                                                
PIE10    GOTO1 RECVAL,DMCB,TLINCDQ,(X'A4',0)                                    
         JE    *+6                                                              
         DC    H'00'                                                            
                                                                                
         USING TAIND,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TAINELQ                                                   
         BRAS  RE,GETEL                                                         
         JE    *+6                                                              
         DC    H'00'                                                            
         OC    TAINTMCO,TAINTMCO                                                
         JZ    NOTIME                                                           
                                                                                
         LH    R2,DSPCYC                                                        
         LTR   R2,R2                                                            
         JNZ   *+6                                                              
         DC    H'00'                                                            
         A     R2,ATWA                                                          
         GOTO1 DATCON,DMCB,(X'11',TAINPTPD),(8,8(R2))                           
         NI    4(R2),X'DF'                                                      
         MVI   5(R2),17                                                         
         OI    6(R2),X'80'                                                      
                                                                                
         GOTO1 RECVAL,DMCB,TLCOCCDQ,(X'A4',TAINTMCO)                            
         JE    *+6                                                              
         DC    H'00'                                                            
                                                                                
         USING TACOD,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TACOELQ                                                   
         BRAS  RE,GETEL                                                         
         JE    *+6                                                              
         DC    H'00'                                                            
         MVC   PAYCID,TACOCID                                                   
         NI    PAYCIDH+4,X'DF'                                                  
         MVI   PAYCIDH+5,L'PAYCID                                               
         OI    PAYCIDH+6,X'80'                                                  
         DROP  R4                                                               
                                                                                
         LH    R2,DSPEST                                                        
         LTR   R2,R2                                                            
         JNZ   *+6                                                              
         DC    H'00'                                                            
         A     R2,ATWA                                                          
         MVI   5(R2),0                                                          
         GOTO1 CHAROUT,DMCB,TANUELQ,0(R2),TANUTEST                              
         NI    4(R2),X'DF'                                                      
                                                                                
         LH    R2,DSPAUTH                                                       
         LTR   R2,R2                                                            
         JNZ   *+6                                                              
         DC    H'00'                                                            
         A     R2,ATWA                                                          
         MVI   5(R2),0                                                          
         GOTO1 CHAROUT,DMCB,TANUELQ,0(R2),TANUTAUT                              
         NI    4(R2),X'DF'                                                      
                                                                                
         GOTO1 VALCOM                                                           
         J     ADVPAUSE                                                         
                                                                                
***********************************************************************         
*        ERRORS                                                       *         
***********************************************************************         
                                                                                
NOTIME   MVC   MYMSGNO,=Y(ERNOTIME)                                             
         J     NTHEEND                                                          
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE TO SELECT EMPLOYEES WITH TIMESHEETS FOR EVENT        *         
*        PAYMENTS                                                     *         
***********************************************************************         
                                                                                
EVECAST  NTR1  BASE=*,LABEL=*                                                   
         CLI   TGUSEQU,UEVE        IF MAKING EVE PAYMENT                        
         JNE   YES                                                              
                                                                                
         LHI   R0,1                                                             
                                                                                
         USING TLCAD,R4                                                         
         L     R4,AIO                                                           
                                                                                
         USING TLTMD,R3                                                         
         LA    R3,KEY                                                           
         XC    KEY,KEY                                                          
         MVI   TLTMCD,TLTMCDQ                                                   
         MVI   TLTMSTA,TLTMSPPL                                                 
         MVC   TLTMCOM,TLCACOM                                                  
         MVC   TLTMINV,TGINV                                                    
         MVC   TLTMSSN,TLCASSN                                                  
         MVC   TLTMSORT+4(L'TLCASEQ),TLCASEQ                                    
         GOTO1 HIGH                                                             
         CLC   TLTMKEY,KEYSAVE                                                  
         JNE   ECNO                                                             
         DROP  R3,R4                                                            
                                                                                
         L     R0,AIO                                                           
         MVC   AIO,TCAETREC                                                     
         GOTO1 GETREC                                                           
         ST    R0,AIO                                                           
                                                                                
         GOTO1 HELLO,DMCB,(C'G',=C'TALFIL'),('TATDELQ',TCAETREC),0              
         CLI   12(R1),6                                                         
         JE    ECNO                                                             
                                                                                
         CLI   TCW4TYPE,TAW4TYCA                                                
         JNE   ECYES                                                            
         L     R4,TCAETREC                                                      
         MVI   ELCODE,TAATELQ                                                   
         BRAS  RE,GETEL                                                         
         JE    ECYES                                                            
* IF DO NOT HAVE EVETIME TAATELQ SET UP SEE IF WE HAVE TAD1ELQ ELEM             
         MVC   AIO,AIO3                                                         
         GOTO1 RECVAL,DMCB,TLW4CDQ,(X'24',0)                                    
         JE    *+6                                                              
         DC    H'00'                                                            
         ST    R0,AIO                                                           
         L     R4,AIO3                                                          
         MVI   ELCODE,TAD1ELQ                                                   
         BRAS  RE,GETEL                                                         
         JE    ECYES                                                            
*                                                                               
         OI    LCLSTAT9,EVEMSCAN                                                
         OC    GRTERSSN,GRTERSSN                                                
         JNZ   ECYES                                                            
         MVC   GRTERSSN,TGSSN                                                   
                                                                                
ECYES    XR    R0,R0                                                            
         J     ECXIT                                                            
ECNO     NI    LCLSTAT3,X'FF'-W4LOCKED                                          
         NI    LCLSTAT9,X'FF'-CRPLCKED                                          
ECXIT    MVC   KEY,SVCASTKY                                                     
         GOTO1 HIGH                                                             
         LTR   R0,R0                                                            
         J     XIT                                                              
                                                                                
***********************************************************************         
*        ROUTINE TO SELECT INDUSTRIAL PERFORMERS FOR INDUSTRIAL       *         
*        PAYMENTS                                                     *         
***********************************************************************         
                                                                                
INDCAST  NTR1  BASE=*,LABEL=*                                                   
         CLI   TGUSEQU,UINS        IF MAKING AN INS                             
         JE    IC10                                                             
         CLI   TGUSEQU,UIDS        OR IDS                                       
         JE    IC10                                                             
         TM    TGUSSTA4,INDPHAS2   OR INDUSTRIAL PHASE 2 PAYMENT ...            
         JZ    YES                                                              
                                                                                
         USING TLCAD,R3                                                         
IC10     LA    R3,SVCASTKY                                                      
         TM    TLCASORT,TLCASRFQ   IF PERFORMER IS OFF CAMERA                   
         JZ    IC20                                                             
         TM    TGCATYPE,INDOFF     CHECK ELIGIBILITY FOR OFF CAMERA             
         JO    YES                                                              
         J     NO                                                               
         DROP  R3                                                               
                                                                                
IC20     TM    TGCATYPE,INDON      IF PERFORMER IS ON CAMERA                    
         JO    YES                 CHECK ELIGIBILITY FOR ON CAMERA              
         J     NO                                                               
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE TO SET TAX UNIT FOR EVENT PAYMENTS SO GST/PST IS     *         
*        TAKEN BY BILLING/CHECKS                                      *         
***********************************************************************         
                                                                                
STEVEPRO NTR1  BASE=*,LABEL=*                                                   
         CLI   TGUSEQU,UEVE        IF MAKING EVE PAYMENT                        
         JNE   XIT                                                              
         OC    SVCASTKY,SVCASTKY                                                
         JNZ   XIT                                                              
                                                                                
         USING TLCAD,R4                                                         
         L     R4,AIO                                                           
                                                                                
         USING TLTMD,R3                                                         
         LA    R3,KEY                                                           
         XC    KEY,KEY                                                          
         MVI   TLTMCD,TLTMCDQ                                                   
         MVI   TLTMSTA,TLTMSPPL                                                 
         MVC   TLTMCOM,TLCACOM                                                  
         MVC   TLTMINV,TGINV                                                    
         MVC   TLTMSSN,TLCASSN                                                  
         MVC   TLTMSORT+4(L'TLCASEQ),TLCASEQ                                    
         GOTO1 HIGH                                                             
         CLC   TLTMKEY,KEYSAVE                                                  
         JE    *+6                                                              
         DC    H'00'                                                            
         DROP  R3,R4                                                            
                                                                                
         MVC   AIO,AIO2                                                         
         GOTO1 GETREC                                                           
         MVC   AIO,AIO1                                                         
                                                                                
         USING TATDD,R4                                                         
         L     R4,AIO2                                                          
         MVI   ELCODE,TATDELQ                                                   
         BRAS  RE,GETEL                                                         
         JE    *+6                                                              
         DC    H'00'                                                            
         MVC   TGCTRY,=C'CA'                                                    
         GOTO1 TAXVAL,DMCB,(X'FF',TATDUNIT)                                     
         JNE   XIT                                                              
         DROP  R4                                                               
                                                                                
         USING CTRYSUBD,R1                                                      
         L     R1,TGACTRY                                                       
                                                                                
         USING TACAD,R4                                                         
         LA    R4,ELTACA                                                        
         MVC   TACAUNIT(L'CTRYPROV),CTRYPROV                                    
         OC    TACAUNIT,SPACES                                                  
         J     XIT                                                              
         DROP  R1,R4                                                            
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE ADDS ELEMENTS FOR TAX UNITS FOR EVENT PAYMENTS       *         
***********************************************************************         
                                                                                
ADDTATUS NTR1  BASE=*,LABEL=*                                                   
         CLI   TGUSEQU,UEVE                                                     
         JNE   XIT                                                              
                                                                                
         L     R4,TCAETREC                                                      
         MVI   ELCODE,TATDELQ                                                   
         BRAS  RE,GETEL                                                         
         J     *+8                                                              
ATATU10  BRAS  RE,NEXTEL                                                        
         JNE   ATATU70                                                          
                                                                                
         USING TATDD,R2                                                         
         LR    R2,R4                                                            
                                                                                
         CLC   =C'CA',TATDUNIT           PAYING CA FOR P+                       
         BNE   *+8                                                              
         OI    LCLSTAT9,CASTCALI                                                
                                                                                
         USING TATUD,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TATUELQ                                                   
         BRAS  RE,GETEL                                                         
         J     *+8                                                              
ATATU20  BRAS  RE,NEXTEL                                                        
         JNE   ATATU40                                                          
         CLC   TATUUNIT,TATDUNIT                                                
         JNE   ATATU20                                                          
         LA    RF,TATUWAGE                                                      
         TM    TATDSTAT,TATDSWAG                                                
         JO    ATATU30                                                          
         LA    RF,TATUTNWA                                                      
         TM    TATDSTAT,TATDSTAX                                                
         JO    ATATU30                                                          
         LA    RF,TATUNNWA                                                      
ATATU30  ICM   RE,15,0(RF)                                                      
         ICM   R1,15,TATDAMNT                                                   
         AR    RE,R1                                                            
         STCM  RE,15,0(RF)                                                      
         TM    TATDSTAT,TATDSSTX                                                
         JZ    ATATU60                                                          
         ICM   RE,15,TATUSTRE                                                   
         AR    RE,R1                                                            
         STCM  RE,15,TATUSTRE                                                   
         J     ATATU60                                                          
                                                                                
ATATU40  LA    R4,ELEMENT                                                       
         XC    ELEMENT,ELEMENT                                                  
         MVI   TATUEL,TATUELQ                                                   
         MVI   TATULEN,TATULNQ                                                  
         MVC   TATUUNIT,TATDUNIT                                                
         LA    RF,TATUWAGE                                                      
         TM    TATDSTAT,TATDSWAG                                                
         JO    ATATU50                                                          
         LA    RF,TATUTNWA                                                      
         TM    TATDSTAT,TATDSTAX                                                
         JO    ATATU50                                                          
         LA    RF,TATUNNWA                                                      
ATATU50  MVC   0(L'TATUWAGE,RF),TATDAMNT                                        
         TM    TATDSTAT,TATDSSTX                                                
         JZ    ATATU55                                                          
         MVC   TATUSTRE,TATDAMNT                                                
ATATU55  GOTO1 ADDELEM                                                          
         DROP  R4                                                               
                                                                                
ATATU60  MVI   ELCODE,TATDELQ                                                   
         LR    R4,R2                                                            
         J     ATATU10                                                          
         DROP  R2                                                               
                                                                                
***********************************************************************         
                                                                                
ATATU70  XR    R0,R0                                                            
         XR    R1,R1                                                            
         XR    R2,R2                                                            
         XR    R3,R3                                                            
                                                                                
         USING TATUD,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TATUELQ                                                   
         BRAS  RE,GETEL                                                         
         J     *+8                                                              
ATATU80  BRAS  RE,NEXTEL                                                        
         JNE   ATATU90                                                          
         ICM   RE,15,TATUWAGE                                                   
         AR    R0,RE                                                            
         ICM   RE,15,TATUTNWA                                                   
         AR    R1,RE                                                            
         ICM   RE,15,TATUNNWA                                                   
         AR    R2,RE                                                            
         ICM   RE,15,TATUSTRE                                                   
         AR    R3,RE                                                            
         J     ATATU80                                                          
         DROP  R4                                                               
                                                                                
         USING TATUD,R4                                                         
ATATU90  LA    R4,ELEMENT                                                       
         XC    ELEMENT,ELEMENT                                                  
         MVI   TATUEL,TATUELQ                                                   
         MVI   TATULEN,TATULNQ                                                  
         MVC   TATUUNIT,=CL3'FD'                                                
         STCM  R0,15,TATUWAGE                                                   
         STCM  R1,15,TATUTNWA                                                   
         STCM  R2,15,TATUNNWA                                                   
         STCM  R3,15,TATUSTRE                                                   
         GOTO1 ADDELEM                                                          
         DROP  R4                                                               
                                                                                
         MVC   TGCTRY,=C'CA'                                                    
                                                                                
         USING TATUD,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TATUELQ                                                   
         BRAS  RE,GETEL                                                         
         J     *+8                                                              
ATATU100 BRAS  RE,NEXTEL                                                        
         JNE   ATATU110                                                         
         GOTO1 TAXVAL,DMCB,(X'FF',TATUUNIT)                                     
         JNE   ATATU100                                                         
         OI    TATUSTAT,TATUSCAN                                                
         DROP  R4                                                               
                                                                                
         USING TATUD,R4                                                         
         LA    R4,ELEMENT                                                       
         MVC   TATUUNIT,=CL3'CN'                                                
         GOTO1 ADDELEM                                                          
         DROP  R4                                                               
                                                                                
***********************************************************************         
                                                                                
ATATU110 L     R4,TCAETREC                                                      
         MVI   ELCODE,TAATELQ                                                   
         BRAS  RE,GETEL                                                         
         J     *+8                                                              
ATATU120 BRAS  RE,NEXTEL                                                        
         JNE   ATATU130                                                         
         MVC   ELEMENT,0(R4)                                                    
         GOTO1 ADDELEM                                                          
         J     ATATU120                                                         
                                                                                
***********************************************************************         
                                                                                
ATATU130 XR    R0,R0                                                            
                                                                                
         USING TATDD,R4                                                         
         L     R4,TCAETREC                                                      
         MVI   ELCODE,TATDELQ                                                   
         BRAS  RE,GETEL                                                         
         J     *+8                                                              
ATATU140 BRAS  RE,NEXTEL                                                        
         JNE   ATATU150                                                         
         ICM   RE,15,TATDAMNT                                                   
         JNM   ATATU140                                                         
         AR    R0,RE                                                            
         J     ATATU140                                                         
         DROP  R4                                                               
                                                                                
ATATU150 LTR   R0,R0                                                            
         JZ    XIT                                                              
                                                                                
         TM    PAYSTAT1,CREDIT                                                  
         JZ    *+6                                                              
         LCR   R0,R0                                                            
                                                                                
         USING TANUD,R4                                                         
         LA    R4,ELEMENT                                                       
         XC    ELEMENT,ELEMENT     ADD OVERSCALE AMOUNT ELEMENT                 
         MVI   TANUEL,TANUELQ                                                   
         MVI   TANULEN,TANULNQ2                                                 
         MVI   TANUTYPE,TANUTARE                                                
         STCM  R0,15,TANUOVAM                                                   
         GOTO1 ADDELEM                                                          
         J     XIT                                                              
         DROP  R4                                                               
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE ADDS PRODUCTIONS PLUS AGENCY COMMISSION TO CHECK     *         
***********************************************************************         
                                                                                
ADDPAC   NTR1  BASE=*,LABEL=*                                                   
         USING TATDD,R4                                                         
         L     R4,TCAETREC                                                      
         MVI   ELCODE,TATDELQ                                                   
         BRAS  RE,GETEL                                                         
         J     *+8                                                              
APAC10   BRAS  RE,NEXTEL                                                        
         JNE   APAC20                                                           
         TM    TATDSTAT,TATDSACO                                                
         JZ    APAC10                                                           
         ICM   R1,15,TATDAMNT                                                   
         DROP  R4                                                               
                                                                                
         USING TAPDD,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TAPDELQ                                                   
         BRAS  RE,GETEL                                                         
         JE    *+6                                                              
         DC    H'00'                                                            
         L     RE,TAPDREXP                                                      
         SR    RE,R1                                                            
         ST    RE,TAPDREXP                                                      
         ICM   RE,15,TAPDNTNW                                                   
         SR    RE,R1                                                            
         STCM  RE,15,TAPDNTNW                                                   
         L     RE,TCEXP                                                         
         SR    RE,R1                                                            
         ST    RE,TCEXP                                                         
         J     APAC30                                                           
         DROP  R4                                                               
                                                                                
APAC20   OC    PPACPCT,PPACPCT                                                  
         JZ    XIT                                                              
                                                                                
         USING TAPDD,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TAPDELQ                                                   
         BRAS  RE,GETEL                                                         
         JE    *+6                                                              
         DC    H'00'                                                            
         ICM   R1,15,TAPDGRS                                                    
         DROP  R4                                                               
                                                                                
         ICM   RF,15,PPACPCT                                                    
         XR    R0,R0                                                            
         MR    R0,RF                                                            
         D     R0,=F'10000'                                                     
         CHI   R0,5000                                                          
         JL    *+8                                                              
         AHI   R1,1                                                             
         LCR   R1,R1                                                            
                                                                                
APAC30   ICM   RF,15,PPACTOT                                                    
         AR    RF,R1                                                            
         STCM  RF,15,PPACTOT                                                    
                                                                                
         USING TANUD,R4                                                         
         LA    R4,ELEMENT                                                       
         XC    ELEMENT,ELEMENT                                                  
         MVI   TANUEL,TANUELQ                                                   
         MVI   TANULEN,TANULNQ2                                                 
         MVI   TANUTYPE,TANUTPAC                                                
         STCM  R1,15,TANUOVAM                                                   
         GOTO1 ADDELEM                                                          
         J     XIT                                                              
         DROP  R4                                                               
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE CALCULATES DUE DATE FOR EVENT PAYMENTS               *         
***********************************************************************         
                                                                                
EVEDUE   NTR1  BASE=*,LABEL=*                                                   
         CLI   TGUSEQU,UEVE        IF MAKING EVENT PAYMENT ...                  
         JNE   NO                                                               
                                                                                
***********************************************************************         
                                                                                
******** TM    AGYSTAT7,TAAYSCDT   IF ALL CHECKS ARE DUE TODAY                  
******** JO    ED10                                                             
******** MVC   DUEDATE,TGTODAY1    PAYMENT IS DUE TODAY                         
******** JO    YES                                                              
                                                                                
***********************************************************************         
*        DEFAULT TO 8 CALENDAR DAYS BEYOND CYCLE END DATE             *         
***********************************************************************         
                                                                                
ED10     GOTO1 DATCON,DMCB,(1,TCPCYCE),WORK                                     
         GOTO1 ADDAY,DMCB,WORK,WORK+6,8                                         
         GOTO1 DATCON,DMCB,WORK+6,(1,DUEDATE)                                   
                                                                                
***********************************************************************         
*        IF THE DUE DATE IS AN OFF DAY FOR TALENT PARTNERS            *         
*        MAKE THE DUE DATE A DAY EARLIER                              *         
***********************************************************************         
                                                                                
ED20     GOTO1 DATCON,DMCB,(1,DUEDATE),WORK                                     
         GOTO1 ADDAY,DMCB,WORK,WORK+6,-1                                        
         GOTO1 DATCON,DMCB,WORK+6,(1,TGTHREE)                                   
                                                                                
         USING GETRETD,R3                                                       
         LA    R3,WORK                                                          
         XC    WORK,WORK                                                        
***      OI    GRDFLAG,GRDFHLOK+GRDFTAL                                         
         OI    GRDFLAG,GRDFHLOK+X'01'                                           
         MVI   GRDITH,0                                                         
         MVI   GRDITM,1                                                         
         MVC   GRDHRS,=H'24'                                                    
         GOTO1 DATCON,DMCB,(1,TGTHREE),(3,GRDIDY)                               
         GOTO1 GETRET,(R3)                                                      
         JE    *+6                                                              
         DC    H'00'                                                            
         GOTOR UNIOND,DMCB,GETRET,(R3),WORK2                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         GOTO1 DATCON,DMCB,(3,GRDODY),(1,TGTHREE)                               
         DROP  R3                                                               
                                                                                
         CLC   DUEDATE,TGTHREE                                                  
         JE    YES                                                              
ED30     GOTO1 DATCON,DMCB,(1,DUEDATE),WORK                                     
         GOTO1 ADDAY,DMCB,WORK,WORK+6,-1                                        
         GOTO1 DATCON,DMCB,WORK+6,(1,DUEDATE)                                   
         J     ED20                                                             
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE SETS THE END DATE FOR FGR, FGS AND INR UNLIMITED     *         
***********************************************************************         
                                                                                
         USING PERVALD,R3                                                       
FGRDATE  NTR1  BASE=*,LABEL=*                                                   
         USING TACOD,R4                                                         
         LA    R4,ELTACO                                                        
         CLC   PVALPSTA,TACOEXP    TEST START NOT AFTER EXPIRY DATE             
         JH    STRTINV                                                          
         MVC   PVALPEND,TACOEXP    SET END DATE = EXPIRY DATE                   
         LA    R2,PVALCPER                                                      
         MVI   8(R2),C'-'          SET DISPLAYABLE CYCLE DATES                  
         GOTO1 DATCON,DMCB,(1,PVALPEND),(8,9(R2))                               
         MVC   TCPCYCE,PVALPEND                                                 
         J     XIT                                                              
         LTORG                                                                  
         DROP  R3,R4                                                            
                                                                                
***********************************************************************         
*        ROUTINE REVERSES P+ ELEMENTS FOR CREDITS                     *         
***********************************************************************         
REVPPLUS NTR1  BASE=*,LABEL=*                                                   
         TM    PAYSTAT1,CREDIT     TEST THIS IS A CREDIT PAYMENT                
         JZ    XIT                                                              
*                                                                               
         USING TATUD,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TATUELQ                                                   
         BRAS  RE,GETEL                                                         
         J     *+8                                                              
REVPP10  BRAS  RE,NEXTEL                                                        
         JNE   REVPP20                                                          
*                                                                               
         ICM   RF,15,TATUWAGE                                                   
         LNR   RF,RF                                                            
         STCM  RF,15,TATUWAGE                                                   
         ICM   RF,15,TATUTNWA                                                   
         LNR   RF,RF                                                            
         STCM  RF,15,TATUTNWA                                                   
         ICM   RF,15,TATUNNWA                                                   
         LNR   RF,RF                                                            
         STCM  RF,15,TATUNNWA                                                   
         ICM   RF,15,TATUSTRE                                                   
         LNR   RF,RF                                                            
         STCM  RF,15,TATUSTRE                                                   
         J     REVPP10                                                          
*                                                                               
         USING TAATD,R4                                                         
REVPP20  L     R4,AIO                                                           
         MVI   ELCODE,TAATELQ                                                   
         BRAS  RE,GETEL                                                         
         J     *+8                                                              
REVPP30  BRAS  RE,NEXTEL                                                        
         JNE   REVPPX                                                           
*                                                                               
         ICM   RF,15,TAATTAX                                                    
         LNR   RF,RF                                                            
         STCM  RF,15,TAATTAX                                                    
         ICM   RF,15,TAATPP                                                     
         LNR   RF,RF                                                            
         STCM  RF,15,TAATPP                                                     
         ICM   RF,15,TAATEI                                                     
         LNR   RF,RF                                                            
         STCM  RF,15,TAATEI                                                     
         ICM   RF,15,TAATPIP                                                    
         LNR   RF,RF                                                            
         STCM  RF,15,TAATPIP                                                    
         J     REVPP30                                                          
*                                                                               
REVPPX   J     XIT                                                              
         DROP  R4                                                               
         LTORG                                                                  
*                                                                               
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE SETS NO CORP TAX ON CANADIAN STATUS                  *         
***********************************************************************         
STCOTXCN NTR1  BASE=*,LABEL=*                                                   
         NI    LCLSTAT9,X'FF'-NOCOTXCN                                          
                                                                                
***********************************************************************         
                                                                                
         USING TAW4D,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TAW4ELQ      GET W4 DETAILS ELEMENT                       
         BRAS  RE,GETEL                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
         CLI   TAW4TYPE,TAW4TYCA   IF W4 TYPE IS CANADIAN                       
         JNE   SCTC10                                                           
         OI    LCLSTAT9,NOCOTXCN   DO NOT TAKE CORP TAXES                       
         J     XIT                                                              
                                                                                
***********************************************************************         
                                                                                
SCTC10   CLI   TAW4TYPE,TAW4TYCO   IF CORP BEING PAID                           
         JE    SCTC20                                                           
         OC    ELTATI,ELTATI       AND CORP IS NOT ALREADY IN AIO               
         JZ    XIT                                                              
         USING TLW4D,R4                                                         
         LA    R4,KEY              GET CORP INTO AIO NOW                        
         XC    KEY,KEY                                                          
         MVI   TLW4CD,TLW4CDQ                                                   
         MVC   TLW4SSN,ELTATI+TATIID-TATID                                      
         GOTO1 HIGH                                                             
         CLC   TLW4KEY,KEYSAVE                                                  
         JE    *+6                                                              
         DC    H'00'                                                            
         GOTO1 GETREC                                                           
         DROP  R4                                                               
                                                                                
***********************************************************************         
                                                                                
         USING TAA2D,R4                                                         
SCTC20   L     R4,AIO                                                           
         MVI   ELCODE,TAA2ELQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   SCTC50                                                           
         CLC   =C'CA',TAA2CTRY     IF CORP HAS A CANADIAN ADDRESS               
         JNE   SCTC50                                                           
         DROP  R4                                                               
                                                                                
         USING TLW4PD,R4                                                        
         LA    R4,KEY              AND HAS NO LINKS                             
         XC    KEY,KEY                                                          
         MVI   TLW4PCD,TLW4CCDQ                                                 
         MVC   TLW4CCRP,TGSSN                                                   
         OC    ELTATI,ELTATI                                                    
         JZ    *+10                                                             
         MVC   TLW4CCRP,ELTATI+TATIID-TATID                                     
         GOTO1 HIGH                                                             
         CLC   KEY(TLW4CSSN-TLW4PD),KEYSAVE                                     
         JE    SCTC45                                                           
         OI    LCLSTAT9,NOCOTXCN   DO NOT TAKE CORP TAXES                       
         J     SCTC90                                                           
                                                                                
SCTC30   GOTO1 SEQ                                                              
SCTC40   CLC   KEY(TLW4CSSN-TLW4PD),KEYSAVE                                     
         JNE   SCTC90              OR IS LINKED TO ANY                          
SCTC45   CLI   TLW4CTYP,TAW4TYCA   CANADIANS                                    
         JNE   SCTC30                                                           
         OI    LCLSTAT9,NOCOTXCN   DO NOT TAKE CORP TAXES                       
         J     SCTC90                                                           
         DROP  R4                                                               
                                                                                
***********************************************************************         
                                                                                
         USING TLW4PD,R4                                                        
SCTC50   LA    R4,KEY              IF CORP DOES NOT HAVE A CANADIAN             
         XC    KEY,KEY             ADDRESS                                      
         MVI   TLW4PCD,TLW4CCDQ    AND IS LINKED TO ONLY CANADIANS              
         MVC   TLW4CCRP,TGSSN                                                   
         OC    ELTATI,ELTATI                                                    
         JZ    *+10                                                             
         MVC   TLW4CCRP,ELTATI+TATIID-TATID                                     
         GOTO1 HIGH                                                             
         J     SCTC70                                                           
SCTC60   GOTO1 SEQ                                                              
SCTC70   CLC   KEY(TLW4CSSN-TLW4PD),KEYSAVE                                     
         JNE   SCTC80                                                           
         CLI   TLW4CTYP,TAW4TYCA                                                
         JNE   SCTC90                                                           
         J     SCTC60                                                           
SCTC80   OI    LCLSTAT9,NOCOTXCN   DO NOT TAKE CORP TAXES                       
         DROP  R4                                                               
                                                                                
***********************************************************************         
                                                                                
SCTC90   GOTO1 RECVAL,DMCB,TLW4CDQ,(X'20',0)  RESTORE W4 RECORD                 
         J     XIT                                                              
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
       ++INCLUDE TAW4LCRP                                                       
***********************************************************************         
*        CHECK PRINT CAST FOR DUPLICATE AGENTS WITH SAME SS#          *         
***********************************************************************         
                                                                                
DUPACHK  NTR1  BASE=*,LABEL=*                                                   
         CLI   TGMEEQU,PRINT       IF MEDIA IS PRINT                            
         JNE   XIT                                                              
                                                                                
         L     R2,AIO3             INITIALIZE AGENT-SOCIAL SECURITY             
         MVI   0(R2),X'FF'         NUMBER TABLE                                 
                                                                                
         USING TLCAD,R3                                                         
         LA    R3,KEY                                                           
         XC    KEY,KEY             READ ALL PCAST RECORDS                       
         MVI   TLCACD,TLCACDQ                                                   
         MVC   TLCACOM,TGCOM                                                    
         GOTO1 HIGH                                                             
         J     DAC20                                                            
DAC10    GOTO1 SEQ                                                              
DAC20    CLC   KEY(TLCASORT-TLCAD),KEYSAVE                                      
         JNE   XIT                                                              
         GOTO1 GETREC                                                           
         DROP  R3                                                               
                                                                                
         USING TACAD,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TACAELQ      SKIP THOSE WITHOUT AGENTS                    
         BRAS  RE,GETEL                                                         
         JNE   DAC10                                                            
         OC    TACANCDE,TACANCDE                                                
         JZ    DAC10                                                            
                                                                                
         MVC   PARAS(L'TLCAKEY),KEY                                             
                                                                                
         GOTO1 TRNSAGT,DMCB,(X'40',TACANCDE),TGAGT                              
         GOTO1 RECVAL,DMCB,TLANCDQ,(X'A4',0)                                    
         JNE   DAC60                                                            
         DROP  R4                                                               
                                                                                
         USING TAAND,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TAANELQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   DAC60                                                            
         OC    TAANSSN,TAANSSN                                                  
         JZ    DAC60                                                            
                                                                                
         USING AGTSSND,R2                                                       
         L     R2,AIO3                                                          
DAC30    CLI   0(R2),X'FF'                                                      
         JE    DAC50                                                            
         CLC   ASSSN,TAANSSN       IF WE'VE SEEN THIS SSN BEFORE                
         JNE   DAC40                                                            
         CLC   ASAGT,TGAGT         BUT IT WASN'T FOR THIS AGENT                 
         JE    DAC60                                                            
         LA    R2,PAYCIDH          RETURN ERROR                                 
         LHI   RE,ERRDUASS                                                      
         STH   RE,MYMSGNO                                                       
         MVI   BLOCK,L'TGAGT+1                                                  
         MVC   BLOCK+1(L'TGAGT),TGAGT                                           
         MVI   BLOCK+1+L'TGAGT,0                                                
         MVI   MYMTYP,GTMERR                                                    
         OI    GENSTAT2,USGETTXT                                                
         J     THEEND                                                           
                                                                                
DAC40    LA    R2,ASLNQ(R2)                                                     
         J     DAC30                                                            
                                                                                
DAC50    MVC   ASAGT,TGAGT         IF WE HAVEN'T SEEN THIS SSN                  
         MVC   ASSSN,TAANSSN       BEFORE, ADD IT TO THE AGENT                  
         MVI   ASLNQ(R2),X'FF'     TABLE                                        
         DROP  R2,R4                                                            
                                                                                
DAC60    XC    KEY,KEY             RESTORE CAST READ SEQUENCE                   
         MVC   KEY(L'TLCAKEY),PARAS                                             
         GOTO1 HIGH                                                             
         J     DAC10                                                            
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE TO VALIDATE INV NUMBER IN BLOCK                      *         
***********************************************************************         
                                                                                
VRET4INV NTR1  BASE=*,LABEL=*                                                   
         GOTO1 TINVCON,DMCB,BLOCK,BLOCK+10,DATCON  CVT TO INTERNAL FMT          
         CLI   0(R1),X'FF'                                                      
         JE    NO                                                               
         TM    BLOCK+15,X'80'          CANCELLED INV NOT ALLOWED                
         JO    NO                                                               
         MVC   WORK(6),BLOCK+10                                                 
         XC    WORK(6),=X'FFFFFFFFFFFF'                                         
         MVC   WORK2(L'TGINV),TGINV    SAVE ACTUAL INV NUMBER                   
         GOTO1 RECVAL,DMCB,TLINCDQ,(X'A2',WORK)   INV SHOULD EXIST              
         MVC   TGINV,WORK2                                                      
         JNE   RECNTFND                                                         
                                                                                
         USING TAPDD,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TAPDELQ                                                   
         BRAS  RE,GETEL                                                         
         JNE   NO                                                               
         CLC   TAPDUSE,TGUSCDE         USE HAS TO BE THE SAME                   
         JE    VR4I10                                                           
         CLC   TGUSCDE,=C'PNH'         (UNLESS MAKING A PNH RETRO)              
         JNE   RTUSDIFF                                                         
VR4I10   CLC   TAPDCOM,TGCOM           COMMERCIAL HAS TO BE THE SAME            
         JNE   RTCMDIFF                                                         
         J     YES                                                              
         DROP  R4                                                               
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE SETS THE USE INFO FOR PAYMENT DETAILS ELEM AT R4     *         
***********************************************************************         
                                                                                
PDUSE    NTR1  BASE=*,LABEL=*                                                   
         TM    TGUSSTA3,NWKUSE                                                  
         JZ    XIT                 DON'T BOTHER IF NOT NETWORK USE              
         CLC   TGCSORT,HEXFFS2     OR IF CHECK RECORD FOR LOCAL                 
         JNE   PDUS5                                                            
         CLC   TGCAT,=C'ZZ '                                                    
         JE    XIT                                                              
         CLC   TGCAT,=C'ZZZ'                                                    
         JE    XIT                                                              
PDUS5    CLI   VERSION,0           TEST IF PAYING A VERSION                     
         JNE   PDUS8                                                            
                                                                                
         LR    R3,R4               SAVE A(PAYMENT DETAILS ELEM) IN R3           
         LA    R4,ELTACA           R4=A(CAST DETAILS ELEMENT)                   
         USING TACAD,R4                                                         
         TM    TACASTAT,TACASTLO                                                
         JO    PDUS10              BRANCH TO PDUS10 IF ONLY ON LIFT             
         TM    TACASTAT,TACASTLF                                                
         JZ    PDUS20              BRANCH TO PDUS20 IF NOT ON LIFT              
                                                                                
         USING TAPDD,R4            ON LIFT AND MAIN OR PAYING A VERSION         
         LR    R4,R3                                                            
PDUS8    MVC   TAPDUSES,TCTUSES    TOTAL N'USES PAID                            
         J     PDUSX                                                            
                                                                                
PDUS10   LR    R4,R3               ONLY ON LIFT                                 
         MVC   TAPDUSES,TCTUSESL   N'USES PAID = N'USES PAID TO LIFT            
         J     PDUSX                                                            
                                                                                
PDUS20   LR    R4,R3               NOT ON LIFT                                  
         LH    R1,TCTUSES          TOTAL N'USES PAID                            
         SH    R1,TCTUSESL         - N'USES PAID TO LIFT                        
         STH   R1,TAPDUSES         = N'USES PAID                                
                                                                                
PDUSX    CLI   TGUSEQU,UITN                                                     
         JE    XIT                                                              
         LH    R1,TCNUSES          NUM OF USES PAID PREVIOUSLY                  
         LA    R1,1(R1)            + 1                                          
         STH   R1,TAPDSTUS         = STARTING USE NUMBER                        
         J     XIT                                                              
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE TO VALIDATE COMMERCIAL IF TIMESHEET EXISTS FOR       *         
*        THIS INVOICE                                                 *         
***********************************************************************         
                                                                                
VALTMCO  NTR1  BASE=*,LABEL=*                                                   
         LA    R2,PAYINVH                                                       
         MVI   HASTIME,0                                                        
         CLI   PAYINVH+5,0                                                      
         JE    XIT                                                              
         TM    TGCTSTST,TGCTSCLI   CLIENTS DON'T INPUT INVOICE NUMBERS          
         JO    XIT                                                              
         MVC   AIO,AIO3                                                         
         XC    DUB,DUB                                                          
         GOTO1 TINVCON,DMCB,PAYINV,DUB,DATCON                                   
         CLI   0(R1),X'FF'                                                      
         JE    FLDINV                                                           
         XC    DUB(6),=6X'FF'         COMPLEMENT INVOICE NUMBER                 
         GOTO1 RECVAL,DMCB,TLINCDQ,(X'A6',DUB)                                  
         JNE   VTMCOX                 COULD BE DRAFT PAYMENT                    
         L     R4,AIO                                                           
         MVI   ELCODE,TAINELQ                                                   
         BRAS  RE,GETEL                                                         
         JE    *+6                                                              
         DC    H'00'                                                            
         USING TAIND,R4                                                         
         OC    TAINTMCO,TAINTMCO                                                
         JZ    VTMCOX                                                           
         MVI   HASTIME,C'Y'      THIS INVOICE HAS TIMESHEETS                    
         CLC   TAINTMCO,TGCOM    TIMESHEET COMM. MUST MATCH THIS COMM           
         JNE   INVCOTM                                                          
         TM    TGUSSTAT,SESSION  MUST BE A SESSION PAYMENT                      
         JNO   INVPTYP                                                          
VTMCOX   MVC   AIO,AIO1                                                         
         J     XIT                                                              
                                                                                
INVPTYP  MVC   MYMSGNO,=Y(ERINVPTP)  INVOICE MUST BE SESSION PAYMENT            
         LA    R2,PAYCIDH                                                       
         J     NTHEEND                                                          
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE TESTS WHETHER TO WITHHOLD ACTRA UNION DUES           *         
*        IF YES, SETS BIT FOR SYSCALC                                 *         
***********************************************************************         
                                                                                
TSTDUES  NTR1  BASE=*,LABEL=*                                                   
         USING TANUD,R4                                                         
         LA    R4,ELTANUM                                                       
         CLI   TANUMBER+1,C'1'     2ND POSITION CAN BE 1                        
         JE    TSTD10                                                           
         CLI   TANUMBER+1,C'0'     OR 0                                         
         JE    TSTD10                                                           
         CLI   TANUMBER+1,C'O'     ALLOW O IN CASE MISTYPED                     
         JNE   XIT                                                              
TSTD10   OI    TCCASTST,TCCADUES   SET TO WITHHOLD DUES                         
         J     XIT                                                              
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE DOES EXTRA VALIDATION FOR TU AND LU OPTIONS          *         
***********************************************************************         
                                                                                
VALPUS   NTR1  BASE=*,LABEL=*                                                   
         USING TAUHD,R4                                                         
         LA    R4,TCTAUHEL         R4=A(UH ELEMENT FOR THIS CLA CYCLE)          
         CLI   HASLIFT,C'Y'                                                     
         JE    VALPU5              IF HAVE LIFTS                                
         CLI   VERSION,0                                                        
         JE    VALPU18             OR IF PAYING A VERSION                       
                                                                                
VALPU5   TM    PAYOPTS2,OPRVTUS+OPRVLUS  IF NOT BOTH TU AND LU INPUT            
         JO    VALPU10                                                          
         TM    PAYOPTS2,OPRVTUS          MUST BE TU=0 (IMPLIES LU=0)            
         JZ    MISSTULU                                                         
         OC    OPTPRVTU,OPTPRVTU                                                
         JNZ   MISSTULU                                                         
         XC    TAUHUSNL,TAUHUSNL   CLEAR LAST LIFT USE NUMBER                   
         J     VALPU20                                                          
                                                                                
VALPU10  MVC   ERRDISP,TGBYTE      BOTH TU AND LU INPUT                         
         CLC   TGBYTE,TGBYTE2      SET DISP. INTO FLD OF LATER INPUT            
         JH    *+10                                                             
         MVC   ERRDISP,TGBYTE2                                                  
         LH    RE,OPTPRVTU                                                      
         CH    RE,OPTPRVLU                                                      
         JL    FLDINV              INVALID IF TU < LU                           
         MVI   ERRDISP,0                                                        
VALPU18  MVC   TAUHUSNL,OPTPRVLU   REPLACE LAST LIFT USE NUMBER                 
VALPU20  MVC   TAUHUSN,OPTPRVTU    REPLACE LAST TOTAL USE NUMBER                
         J     XIT                 (USED BY SETNUSES)                           
         DROP  R4                                                               
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE ENSURES ALL EVENT TIMESHEETS ARE COMPLETE            *         
***********************************************************************         
                                                                                
CHKEVETS NTR1  BASE=*,LABEL=*                                                   
         CLI   TGUSEQU,UEVE        EXIT IF NOT MAKING AN EVENT                  
         JNE   XIT                 PAYMENT                                      
                                                                                
         CLI   PFAID,22            EXIT IF ERROR HAS BEEN                       
         JNE   CET10               ACKNOWLEDGED                                 
         MVI   PFAID,0                                                          
         J     XIT                                                              
                                                                                
         USING TLTMD,R3                                                         
CET10    LA    R3,KEY                                                           
         XC    KEY,KEY             READ ALL TIMESHEETS FOR                      
         MVI   TLTMCD,TLTMCDQ      THIS INVOICE                                 
         MVI   TLTMSTA,TLTMSPPL                                                 
         MVC   TLTMCOM,TGCOM                                                    
         MVC   TLTMINV,TGINV                                                    
         GOTO1 HIGH                                                             
         J     CET30                                                            
CET20    GOTO1 SEQ                                                              
CET30    CLC   KEY(TLTMSSN-TLTMD),KEYSAVE                                       
         JNE   XIT                                                              
         DROP  R3                                                               
                                                                                
         GOTO1 GETREC                                                           
                                                                                
         L     R4,AIO                                                           
         MVI   ELCODE,TATDELQ      IF TIMESHEET DOES NOT HAVE ANY               
         BRAS  RE,GETEL            INFO ENTERED, RETURN ERROR                   
         JE    CET20                                                            
         MVC   MYMSGNO,=Y(ERMSWOTM) SELECTED                                    
         J     NTHEEND                                                          
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE TO SET L'CYCLE                                       *         
***********************************************************************         
                                                                                
SETLCYC  NTR1  BASE=*,LABEL=*                                                   
         CLI   TGUSEQU,UISU        IF USE IS ISU ...                            
         JNE   SETLC1                                                           
         NI    TGUSCYCK,X'FF'-OPTCYC                                            
         MVI   TGUSWKS,X'80'+36    SET LENGTH AS 3 YEARS                        
         TM    ISUTYPE1,TAIDTBCA   IF BASIC CABLE OPTION SELECTED               
         JO    SETLC1                                                           
                                                                                
         USING TACOD,RF                                                         
         MVI   TGUSWKS,X'80'+60    SET LENGTH AS 5 YEARS                        
         TM    ISUTYPE1,TAIDTIN5   IF INTERNET OPTION SELECTED                  
         JO    SETLC1                                                           
         TM    ISUTYPE2,TAIDTCT2   OR CATEGORY 2 OPTION SELECTED                
         JO    SETLC1                                                           
         LA    RF,ELTACO                                                        
         CLI   TACOTYPE,CTYICAT2   OR COMMERCIAL TYPE IS INDUSTRIAL             
         JE    SETLC1              CATEGORY 2                                   
         DROP  RF                                                               
                                                                                
         MVI   TGUSWKS,0           ELSE SET NO LENGTH                           
                                                                                
SETLC1   CLI   TGUSWKS,0           IF L'CYCLE = 0                               
         JNE   SETLC2                                                           
         XC    LCYCLE,LCYCLE       CLEAR LCYCLE                                 
         J     SETLC6              AND DISPLAY                                  
                                                                                
SETLC2   MVC   BYTE,TGUSWKS        ELSE,SET L'CYCLE FROM USE TABLE              
                                                                                
         CLI   BYTE,13             IF CYCLE DEFINED AS 13 WEEKS                 
         JNE   *+16                                                             
         TM    AGYSTAT,TAAYS13W    TEST THIS AGENCY USES 13 WEEK CYCLES         
         JO    *+8                                                              
         MVI   BYTE,X'80'+3        ELSE SET TO 3 MONTHS                         
                                                                                
         ZIC   RF,BYTE             ISOLATE NUMBER                               
         CLI   TGUSEQU,UDOR                                                     
         JE    SETLC3                                                           
         SLL   RF,26                                                            
         SRL   RF,26                                                            
                                                                                
SETLC3   MVC   LCYCLE,SPACES                                                    
         MVI   LCYCLE,C'('         BUILD DISPLAY FORMAT                         
                                                                                
         EDIT  (RF),(3,LCYCLE+1),ALIGN=LEFT                                     
         LR    R1,R0                                                            
         LA    R1,LCYCLE+1(R1)     BUMP PAST NUMBER                             
                                                                                
         CLI   TGUSEQU,UDOR                                                     
         JNE   SETLC4                                                           
         SHI   R1,1                                                             
         J     SETLC5                                                           
                                                                                
SETLC4   MVI   0(R1),C'M'          SET WEEKS OR MONTHS OR DAYS                  
         TM    BYTE,X'80'                                                       
         JO    SETLC5                                                           
         MVI   0(R1),C'D'                                                       
         TM    BYTE,X'40'                                                       
         JO    SETLC5                                                           
         MVI   0(R1),C'W'                                                       
                                                                                
SETLC5   MVI   1(R1),C')'          END WITH TRAILING PARENTHESIS                
                                                                                
SETLC6   LH    R2,DSPLCYC          TEST IF THERE IS DISPLAY FIELD               
         LTR   R2,R2                                                            
         JZ    *+16                                                             
         AR    R2,RA                                                            
         MVC   8(L'LCYCLE,R2),LCYCLE   DISPLAY L'CYCLE                          
         OI    6(R2),X'80'                                                      
                                                                                
         CLI   TGUSEQU,UDOR                                                     
         JNE   XIT                                                              
         MVC   9(5,R2),=C'26W1)'                                                
         J     XIT                                                              
*&&DO                                                                           
SETLC7   CLI   TGUSEQU,UMBO                                                     
         JNE   XIT                                                              
         MVC   9(3,R2),=C'52W'                                                  
         J     XIT                                                              
*&&                                                                             
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        IF MAKING AN MBO PAYMENT, CHECK FOR ANY MUS PAYMENTS         *         
***********************************************************************         
                                                                                
CHKMBO   NTR1  BASE=*,LABEL=*                                                   
         CLI   TGUSEQU,UMBO        IF USE IS MBO                                
         JNE   XIT                 AND WE HAVEN'T BYPASSED THESE ERRORS         
         TM    CYCSTAT2,CYSTMUPD+CYSTMUPC                                       
         JNZ   XIT                                                              
                                                                                
         XR    R0,R0               DEFAULT TO NO MUSIC FOUND                    
                                                                                
         USING TLUHD,R3                                                         
         LA    R3,KEY              READ ALL USAGE HISTORY FOR ...               
         XC    TLUHKEY,TLUHKEY                                                  
         MVI   TLUHCD,TLUHCDQ                                                   
         MVC   TLUHCOM,TGCOM                                                    
         GOTO1 HIGH                                                             
         J     CMBO20                                                           
CMBO10   GOTO1 SEQ                                                              
CMBO20   CLC   TLUHKEY(TLUHUSE-TLUHD),KEYSAVE                                   
         JNE   CMBO50                                                           
         CLC   TLUHUSE,=C'FMU'     ... FIRST MUSIC                              
         JE    CMBO30                                                           
         CLC   TLUHUSE,=C'NBM'     NON-BROADCAST MUSIC                          
         JE    CMBO30                                                           
         CLC   TLUHUSE,=C'FGM'     FOREIGN USE                                  
         JE    CMBO30                                                           
         CLC   TLUHUSE,=C'NIM'     INTERNET/NEW MEDIA MUSIC                     
         JE    CMBO30                                                           
         CLC   TLUHUSE,=C'MVM'     MOVE MUSIC AND ...                           
         JE    CMBO30                                                           
         CLC   TLUHUSE,=C'MUS'                                                  
         JNE   CMBO10                                                           
                                                                                
CMBO30   GOTO1 GETREC                                                           
                                                                                
         USING TAUHD,R4                                                         
         L     R4,AIO                                                           
         MVI   ELCODE,TAUHELQ                                                   
         BRAS  RE,GETEL                                                         
         JE    *+6                                                              
         DC    H'00'                                                            
                                                                                
         CLC   TLUHUSE,=C'MUS'     ... MUSIC REUSE                              
         JNE   CMBO40                                                           
         CLI   TAUHTYPE,UMUSDSH    (EXCLUDING THE LONG TO SHORTS)               
         JE    CMBO10                                                           
         CLI   TAUHTYPE,UMUSDSH8                                                
         JE    CMBO10                                                           
         CLI   TAUHTYPE,UMUSDSH6                                                
         JE    CMBO10                                                           
         CLI   TAUHTYPE,UMUSDSH1                                                
         JE    CMBO10                                                           
         CLI   TAUHTYPE,UMUS2DS                                                 
         JE    CMBO10                                                           
         DROP  R3                                                               
                                                                                
CMBO40   AHI   R0,1                SET MUSIC FOUND                              
                                                                                
         CLC   TCPCYCS,TAUHEND     IF CYCLE OVERLAPS                            
         JH    CMBO10              GIVE OVERLAP ERROR                           
         CLC   TCPCYCE,TAUHSTRT                                                 
         JL    CMBO10                                                           
         J     ERMUOVLP                                                         
         DROP  R4                                                               
                                                                                
CMBO50   LTR   R0,R0               WHEN DONE WITH ALL USAGE HISTORY             
         JNZ   ERMUPAID            IF ANY MUSIC WAS FOUND                       
         J     XIT                 GIVE ERROR                                   
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        ROUTINE SETS THE END DATE FOR INTERNET/NEW MEDIA             *         
*        ON ENTRY ... R3=A(PERVAL BLOCK)                              *         
***********************************************************************         
                                                                                
         USING PERVALD,R3                                                       
INDATE   NTR1  BASE=*,LABEL=*                                                   
         CLI   PAYBYTE,C'C'        IF CHECKING END DATE VALIDITY                
         JE    IND10                                                            
         TM    CYCSTAT,CYSTAUTO    OR AUTO-COMPUTING END DATE                   
         JZ    XIT                                                              
IND10    CLI   TGUSEQU,UIRN        AND PAYING INTERNET (OLD)                    
         JE    IND20                                                            
         CLI   TGUSEQU,UINU        INTERNET (NEW)                               
         JE    IND20                                                            
         CLI   TGUSEQU,UMVI        MOVE TO INTERNET                             
         JE    IND20                                                            
         CLI   TGUSEQU,UNMR        NEW MEDIA (OLD)                              
         JE    IND20                                                            
         CLI   TGUSEQU,UNMU        NEW MEDIA (NEW)                              
         JE    IND20                                                            
         CLI   TGUSEQU,UMVN        MOVE TO NEW MEDIA                            
         JE    IND20                                                            
         CLI   TGUSEQU,USIR        SPANISH INTERNET (OLD)                       
         JE    IND20                                                            
         CLI   TGUSEQU,USIU        SPANISH INTERNET (NEW)                       
         JE    IND20                                                            
         CLI   TGUSEQU,USMI        SPANISH MOVE TO INTERNET                     
         JE    IND20                                                            
         CLI   TGUSEQU,USNM        SPANISH NEW MEDIA (OLD)                      
         JE    IND20                                                            
         CLI   TGUSEQU,USNU        SPANISH NEW MEDIA (NEW)                      
         JE    IND20                                                            
         CLI   TGUSEQU,USMN        SPANISH MOVE TO NEW MEDIA USE                
         JE    IND20                                                            
         CLI   TGUSEQU,UINR        INDUSTRIAL REUSE                             
         JE    IND20                                                            
         CLI   TGUSEQU,USIN        OR SPANISH INDUSTRIAL REUSE                  
         JNE   XIT                                                              
         USING TACOD,R4                                                         
IND20    LA    R4,ELTACO                                                        
         OC    TACOEXP,TACOEXP     AND COMMERCIAL HAS AN EXPIRATION             
         JZ    XIT                 DATE                                         
         CLC   PVALPSTA,TACOEXP    AND START DATE <= EXPIRY DATE                
         JH    XIT                                                              
         CLC   PVALPEND,TACOEXP    AND END DATE > EXPIRY DATE                   
         JNH   XIT                                                              
         GOTO1 DATCON,DMCB,(1,PVALPSTA),(8,WORK)                                
         MVI   WORK+8,C'-'                                                      
         GOTO1 DATCON,DMCB,(1,TACOEXP),(8,WORK+9)                               
         GOTO1 PERVAL,DMCB,(17,WORK),('PVINSGLS+PVIN1DYL',BLOCK)                
         MVI   PVALASSM,PVALAED+PVALAEM+PVALAEY                                 
         J     XIT                                                              
         DROP  R3,R4                                                            
                                                                                
***********************************************************************         
*        CONSTANTS AND LITERALS                                       *         
***********************************************************************         
                                                                                
         LTORG                                                                  
         EJECT                                                                  
       ++INCLUDE TATRNTR                                                        
       ++INCLUDE TAT2TACC                                                       
       ++INCLUDE TAONCAIN                                                       
       ++INCLUDE TAGTHFCD                                                       
       ++INCLUDE TAVALPJB                                                       
*              DSECT TO COVER TABLE FOR SAVED ERROR AGENCY/INVOICE              
         SPACE 1                                                                
SVAID    DSECT                                                                  
SVAGY    DS    CL(L'TGAGY)         AGENCY                                       
SVINV    DS    CL(L'TGINV)         INVOICE                                      
         SPACE 3                                                                
*              DSECT TO COVER PFKEY TABLE (PFTABLE)                             
         SPACE 1                                                                
PFKD     DSECT                                                                  
PFKAID   DS    XL1                 PFKEY NUMBER                                 
PFKARG   DS    XL1                 COMPARE ARGUMENT                             
PFKRTN   DS    H                   DISPLACEMENT TO HANDLING ROUTINE             
PFKNEXT  EQU   *                                                                
         SPACE 3                                                                
*              DSECT TO COVER OPTIONS TABLE (OPTTAB)                            
         SPACE 1                                                                
OPTD     DSECT                                                                  
OPTVAL   DS    AL2                 DISPLACEMENT TO VALIDATION ROUTINE           
OPTLHS   DS    CL3                 LHS INPUT                                    
OPTSTAT  DS    XL1                 STATUS BYTE                                  
OPTSCLI  EQU   X'80'               VALID FOR CLIENTS                            
OPTNEXT  EQU   *                                                                
         SPACE 1                                                                
*              DSECT TO COVER AGENT/SS# TABLE                                   
         SPACE 1                                                                
AGTSSND  DSECT                                                                  
ASAGT    DS    CL(L'TLANAGT)       AGENT CODE                                   
ASSSN    DS    CL(L'TAANSSN)       AGENT SOCIAL SECURITY NUMBER                 
ASLNQ    EQU   *-AGTSSND                                                        
         EJECT                                                                  
*              DSECT TO INDUSTRIAL DUE DATE CALCULATION BLOCK                   
         SPACE 1                                                                
IDBLOCKD DSECT                                                                  
IDBBASE0 DS    XL6                 INITIAL BASE DATE (DATCON FORMAT 0)          
IDB30DY0 DS    XL6                 30 DAY DUE DATE (DATCON FORMAT 0)            
IDB30DY1 DS    XL3                 30 DAY DUE DATE (DATCON FORMAT 1)            
IDBMIN10 DS    XL6                 DUE DATE -1 DATE (DATCON FORMAT 0)           
IDBMIN11 DS    XL3                 DUE DATE -1 DATE (DATCON FORMAT 1)           
IDBPLU11 DS    XL3                 DUE DATE +1 DATE (DATCON FORMAT 1)           
         EJECT                                                                  
       ++INCLUDE TAPYS50D                                                       
         EJECT                                                                  
       ++INCLUDE TAPYS69D                                                       
         EJECT                                                                  
       ++INCLUDE TAPYS78D                                                       
         EJECT                                                                  
       ++INCLUDE TASCRE7D                                                       
         EJECT                                                                  
       ++INCLUDE TAGENPAYD                                                      
         EJECT                                                                  
       ++INCLUDE DDPERVALD                                                      
         EJECT                                                                  
*              DUMMY DSECT FOR CAST SELECT FILTERING                            
         SPACE 1                                                                
MYSELD   DSECT                                                                  
         DS    CL(CONTAGH-T702FFD)                                              
       ++INCLUDE TAPYS96D                                                       
         EJECT                                                                  
       ++INCLUDE TAGENFFD                                                       
         EJECT                                                                  
         ORG   CONTAGH                                                          
       ++INCLUDE TAPYS90D                                                       
         EJECT                                                                  
* DDGENTWA     *** MUST FOLLOW LAST SCREEN ***                                  
* TAGENWORKD                                                                    
* TAGENEQUS                                                                     
* TASYSEQUS                                                                     
* TASYSDSECT                                                                    
* TAGENFILE                                                                     
* DDTSARD                                                                       
* DDSPLWORKD                                                                    
* DDGETRETD                                                                     
* FAGETTXTD                                                                     
* ACGENBOTH                                                                     
* TAMAPEQUS                                                                     
* TAWBDSECT                                                                     
* TAWADSECT                                                                     
         PRINT OFF                                                              
       ++INCLUDE DDGENTWA                                                       
       ++INCLUDE TAGENWORKD                                                     
       ++INCLUDE TAGENEQUS                                                      
       ++INCLUDE TASYSEQUS                                                      
       ++INCLUDE TASYSDSECT                                                     
       ++INCLUDE TAGENFILE                                                      
       ++INCLUDE DDTSARD                                                        
       ++INCLUDE DDSPLWORKD                                                     
       ++INCLUDE DDGETRETD                                                      
       ++INCLUDE FAGETTXTD                                                      
       ++INCLUDE ACGENBOTH                                                      
       ++INCLUDE TAMAPEQUS                                                      
       ++INCLUDE TAWBDSECT                                                      
       ++INCLUDE TAWADSECT                                                      
       ++INCLUDE FAWSSVRD                                                       
         PRINT ON                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'105TAGEN50   11/02/16'                                      
         END                                                                    
