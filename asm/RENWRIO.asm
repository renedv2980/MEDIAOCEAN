*          DATA SET RENWRIO    AT LEVEL 120 AS OF 04/30/12                      
*PHASE T00AA8B,*                                                                
*INCLUDE BINSRCH2                                                               
*INCLUDE REPVAL5                                                                
*INCLUDE SORTER                                                                 
*INCLUDE PRINT                                                                  
*INCLUDE PRNTBL                                                                 
*INCLUDE ALTBCMON                                                               
*INCLUDE RECUP                                                                  
*INCLUDE HEXIN                                                                  
*        TITLE 'RENWRIO - REPWRITER IO MODULE'                                  
         TITLE 'RENWRIO - REPWRITER IO MODULE - STDPR MACRO'                    
         LCLC  &C                  WORK                                         
*                                                                               
         MACRO                                                                  
&ID      STDPR &TITLE,&KEY1=,&KEY2=,&SID=,&ELMID=,&REID=,&FLTNM=1,     X        
               &FLT=                                                            
*                                                                               
STDP&ID  DS    0A                                                               
*                                                                               
         DC    AL1(R&ID.KTYQ)       RECORD ID                                   
         DC    AL1(R&ID.KREP-R&ID.KEY)  REP                                     
*                                                                               
*        SET RECORD DATA                                                        
*                                                                               
         AIF   (T'&SID EQ 'O').STDPR05                                          
.*                                                                              
         DC    CL2'&SID'             SET RECORD TYPE                            
         DC    A(RE&ID.SID-RENWRIOD)  A(SET RECORD FILTER)                      
.*                                                                              
         AGO   .STDPR07                                                         
.*                                                                              
.STDPR05 ANOP                                                                   
.*                                                                              
         DC    XL2'00'                                                          
         DC    A(0)                                                             
.*                                                                              
.STDPR07 ANOP                                                                   
*                                                                               
*        KEY COMPONENTS                                                         
*                                                                               
&C       SETC  '&ID'               DEFAULT TO ID                                
         AIF   (T'&KEY1 EQ 'O').STDPR08       IF KEY1 ENTERED                   
         AIF   ('&KEY1'(1,1) EQ '-').STDPR08  AND USABLE                        
&C       SETC  '&KEY1'                           USE ENTERED VALUE              
.*                                                                              
.STDPR08 ANOP                                                                   
.*                                                                              
         DC    AL1(L'R&ID.K&C)     DATA LENGTH                                  
         DC    AL1(R&ID.K&C-R&ID.KEY) DISPLACEMENT INTO KEY                     
         DC    XL2'00'             SPARE                                        
.*                                                                              
         AIF   (T'&KEY1 EQ 'O').STDPR85       IF  KEY1 ENTERED                  
         AIF   ('&KEY1'(1,1) NE '-').STDPR85  AND NO FILTERING ALLOWED          
         DC    A(0)                A(FILTER VALUE) - NOT NEEDED                 
         AGO   .STDPR09                                                         
.*                                                                              
.STDPR85 ANOP                                                                   
.*                                                                              
         DC    A(REF&ID-RENWRIOD)   A(FILTER VALUE)                             
*                                                                               
.STDPR09 ANOP                                                                   
.*                                                                              
         AIF   (T'&KEY2 EQ 'O').STDPR10                                         
.*                                                                              
         DC    AL1(L'R&ID.K&KEY2) DATA LENGTH                                   
         DC    AL1(R&ID.K&KEY2-R&ID.KEY) DISPLACEMENT INTO KEY                  
         DC    XL2'00'             SPARE                                        
         DC    A(REF&KEY2-RENWRIOD) A(FILTER VALUE)                             
*                                                                               
         AGO   .STDPR20                                                         
.*                                                                              
.STDPR10 ANOP                                                                   
.*                                                                              
         DC    AL1(0)              DATA LENGTH - NOT NEEDED                     
         DC    AL1(0)              DISPLACEMENT INTO KEY - NOT NEEDED           
         DC    XL2'00'             SPARE                                        
         DC    A(0)                A(FILTER VALUE) - NOT NEEDED                 
.*                                                                              
.STDPR20 ANOP                                                                   
.*                                                                              
*                                                                               
*        TABLE PARAMETERS                                                       
*                                                                               
         DC    A(RE&ID.TBA-RENWRIOD) A(TABLE IN BUFFER)                         
*                                                                               
         DC    AL2(&ID.TMAXQ)       MAX NUMBER OF ENTRIES IN TABLE              
         DC    AL2(&ID.TENTL)       LENGTH OF ENTRY IN TABLE                    
*                                                                               
         DC    XL1'&ELMID'         ELEMENT TO BE SAVED ID                       
.*                                                                              
         AIF   (T'&FLT EQ 'O').STDPR30                                          
.*                                                                              
         DC    AL1(REFT&ID.Q)      FILTER EQUATE                                
         DC    AL1(&FLTNM)         FILTER NUMBER                                
         DC    XL1'00'             SPARE                                        
.*                                                                              
         AGO   .STDPR35                                                         
.*                                                                              
.STDPR30 ANOP                                                                   
.*                                                                              
         DC    XL3'00'             SPARE                                        
.*                                                                              
.STDPR35 ANOP                                                                   
.*                                                                              
*                                                                               
         AIF   (T'&REID NE 'O').STDPR45                                         
.*                                                                              
         DC    AL1(L'RE&ID)        L'CURRENT VALUE                              
         DC    A(RE&ID-RENWRIOD)   A(CURRENT VALUE)                             
.*                                                                              
         AGO   .STDPR46                                                         
.*                                                                              
.STDPR45 ANOP                                                                   
.*                                                                              
         DC    AL1(L'RE&REID)        L'CURRENT VALUE                            
         DC    A(RE&REID-RENWRIOD)   A(CURRENT VALUE)                           
.*                                                                              
.STDPR46 ANOP                                                                   
.*                                                                              
         DC    A(&ID.GET)          A(GET NEXT ROUTINE)                          
         DC    A(RE&ID.TA-RENWRIOD) A(CURRENT TABLE ENTRY)                      
*                                                                               
STDP&ID.X DS    0A                                                              
*                                                                               
         MEND                                                                   
         TITLE 'RENWRIO - REPWRITER IO MODULE'                                  
***********************************************************************         
*                                                                     *         
*                                                                     *         
* REGISTER USAGE -                                                    *         
*        R0 - WORK REG                                                *         
*        R1 - WORK REG                                                *         
*        R2 - WORK REG                                                *         
*        R3 - WORK REG                                                *         
*        R4 - WORK REG & KEY DSECT POINTER                            *         
*        R5 - WORK REG                                                *         
*        R6 - USED FOR GETEL ELEMENT DSECT POINTER                    *         
*        R7 - POINTER TO RENWRIOD                                     *         
*        R8 - WORK REGISTER                                           *         
*        R9 - WORK REGISTER                                           *         
*        RA - SUBROUTINES BASE REGISTER                               *         
*        RB - BASE REGISTER                                           *         
*        RC - POINTER TO NWRIOWD                                      *         
*        RD - SAVE AREA POINTER                                       *         
*        RE - GOTO1 REG                                               *         
*        RF - GOTO1 REG                                               *         
*                                                                     *         
*                                                                     *         
*                     ***  END TOMBSTONE  ***                         *         
*                                                                     *         
***********************************************************************         
         TITLE 'RENWRIO - REPWRITER IO MODULE -INIT'                            
***********************************************************************         
*                                                                     *         
*        INITIALIZATION                                               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         PRINT NOGEN                                                            
RENWRIO  CSECT                                                                  
         NMOD1 (WRIIOWKX-NWRIOWD),**WRIO*,CLEAR=YES                             
*                                                                               
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         MVC   USERRD,4(RD)        SAVE LINK BACK TO USER                       
*                                                                               
         L     R7,0(R1)            ESTABLISH RENWRIO BLOCK                      
         USING RENWRIOD,R7                                                      
*                                                                               
         L     RA,=A(SUBROUTS)     POINT TO COMMON ROUTINES                     
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
*                                                                               
         ST    RB,RENWRIOA         SAVE BASE REGISTER                           
*                                                                               
         GOTO1 =A(RELINIT)         INITIALIZE PROGRAM                           
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE -WRIIOSTR'                        
***********************************************************************         
*                                                                     *         
*        MAINLINE                                                     *         
*                                                                     *         
*        FIND APPROPRIATE RECORD READ ROUTINE                         *         
*        PERFORM ROUTINE                                              *         
*        EXIT                                                         *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
WRIIOSTR DS    0H                                                               
*                                                                               
*        FIND ADDRESS OF READ ROUTINE ASKED FOR                                 
*                                                                               
         LA    R1,READADDS         POINT TO TABLE OF ADDRESSES                  
*                                  TABLE IS AL1(RECORD ID),AL3(ROUTINE)         
WRIIOALP DS    0H                                                               
*                                                                               
         CLI   0(R1),X'FF'         DONE AT END OF TABLE                         
         BE    WRIIOADN                                                         
*                                                                               
         CLC   REREAD,0(R1)        MATCH RECORD ID TO TABLE                     
         BE    WRIIOAFD                                                         
*                                                                               
WRIIOACN DS    0H                                                               
*                                                                               
         LA    R1,4(R1)            BUMP TABLE POINTER                           
         B     WRIIOALP            CHECK NEXT ENTRY                             
*                                                                               
WRIIOADN DS    0H                  EOT - ERROR                                  
*                                                                               
         MVI   REERROR,RENOROUT    NO READ ROUTINE FOR THIS RECORD              
         B     WRIIOEND                                                         
*                                                                               
*        ROUTINE FOUND                                                          
*                                                                               
WRIIOAFD DS    0H                  MATCH TO TABLE FOUND                         
*                                                                               
*        PERFORM ROUTINE UNTIL RECORD PASSED TO APPLICATION                     
*                                                                               
WRIIORLP DS    0H                                                               
*                                                                               
         NI    STATUS,X'FF'-FOUNDONE    TURN OFF RECORD FOUND IND               
*                                                                               
         LA    R4,KEY              PRESET A SIMPLE STARTING KEY                 
         XC    KEY,KEY                                                          
         MVC   KEY(1),REREAD       SET RECORD ID                                
*                                                                               
         L     RF,0(R1)            PICK UP ROUTINE DISPLACEMENT                 
         AR    RF,RB               ADD A(BEGIN OF WRIIO)                        
         BASR  RE,RF               AND EXECUTE                                  
*                                                                               
WRIIORCN DS    0H                                                               
*                                                                               
         TM    STATUS,FOUNDONE     DONE IF RECORD PASSED TO APPLIC.             
         BO    WRIIORDN                                                         
*                                                                               
         OC    REQSKEY,REQSKEY     DONE IF NO CONTINUE KEY PRESENT              
         BZ    WRIIORDN                                                         
*                                                                               
         XC    REQSKEY,REQSKEY     CLEAR CONTINUE KEY                           
         B     WRIIORLP            AND START OVER                               
*                                                                               
WRIIORDN DS    0H                                                               
*                                                                               
         XC    REKEY,REKEY         RELEASE WRIIO'S KEY                          
*                                  SHOWS THAT WRIIO NO LONGER DOING IO          
*                                                                               
WRIIOEND DS    0H                  END OF MAINLINE                              
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - SUBROUTS'                       
***********************************************************************         
*                                                                     *         
*        COMMON AREA AND SUBROUTINES                                  *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
SUBROUTS DS    0H                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - DATEFLT'                        
***********************************************************************         
*                                                                     *         
*        DATE FILTERING ROUTINE                                       *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
DATEFLT  NTR1  LABEL=*                                                          
*                                                                               
         OC    REQPSTRB(6),REQPSTRB   ANY REQUEST PERIOD DATES                  
         BZ    DFTOK                   NO, ACCEPT ALL                           
*                                                                               
         OC    BSTARTDT,BSTARTDT   ALREADY SET                                  
         BNZ   DFTTEST             YES                                          
*                                                                               
*                                  NO / SET IT                                  
* - TWO YEARS PRIOR AND ONE YEAR FORWARD TO HANDLE PRIO/FORWARD $               
*                                                                               
         GOTO1 DATCON,DMCB,(3,REQPSTRB),(0,WORK)                                
         GOTO1 ADDAY,DMCB,WORK,WORK+6,F'-740'                                   
         GOTO1 DATCON,DMCB,(0,WORK+6),(3,BSTARTDT)                              
*                                                                               
         GOTO1 DATCON,DMCB,(3,REQPENDB),(0,WORK)                                
         GOTO1 ADDAY,DMCB,WORK,WORK+6,F'366'                                    
         GOTO1 DATCON,DMCB,(0,WORK+6),(3,BENDDT)                                
*                                                                               
DFTTEST  DS    0H                                                               
*                                                                               
         CLC   BSTARTDT,RECONEND                                                
         BH    DFTDROP                                                          
*                                                                               
         CLC   BENDDT,RECONSTR                                                  
         BL    DFTDROP                                                          
*                                                                               
         B     DFTOK               ELSE ACCEPT                                  
*                                                                               
DFTDROP  DS    0H                  DROP RECORD                                  
*                                                                               
         LTR   RB,RB               SET NEQ CC                                   
         B     DATEFLTX                                                         
*                                                                               
DFTOK    DS    0H                  RECORD OKAY                                  
*                                                                               
         CR    RB,RB               SETEQ CC                                     
*                                                                               
DATEFLTX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - SETREP'                         
***********************************************************************         
*                                                                     *         
*        SET CORRECT REP IN KEY FOR RECORD TYPE                       *         
*                                                                     *         
*NTRY    PARM0     A(KEY CONTAINING REP)                              *         
*                                                                     *         
*EXIT    REDMREP   REP FOR READING FILE                               *         
*                  REP IN KEY REPLACED BY FILE REP                    *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
SETREP   NTR1  LABEL=*                                                          
*                                                                               
         MVC   REDMREP,REREP       DEFAULT TO CURRENT REP                       
*                                                                               
         OC    REMREP,REMREP       SKIP ID IF THERE IS NO MASTER REP            
         BZ    SETREPX                                                          
*                                                                               
         L     R2,0(R1)            POINT TO KEY CONTAINING REP                  
*                                                                               
*        KATZ HAS A SPECIAL ARRANGEMENT FOR GROUPS                              
*                                                                               
         CLI   0(R2),RGRPKTYQ      IF GROUP SET AND                             
         BNE   STRPK3GN                                                         
         CLC   REMREP,=C'K3'       AND KATZ MASTER REP                          
         BNE   STRPK3N                                                          
*                                                                               
         MVC   REDMREP,REMREP         USE MASTER REP                            
         MVC   RGRPKREP-RGRPKEY(L'RGRPKREP,R2),REDMREP                          
*                                                                               
         B     SETREPX                                                          
*                                                                               
STRPK3GN DS    0H                                                               
*                                                                               
         CLI   0(R2),RCTYKTYQ      IF CONTRACT TYPE SET AND                     
         BNE   STRPK3N                                                          
         CLC   REMREP,=C'K3'       AND KATZ MASTER REP                          
         BNE   STRPK3N                                                          
         CLC   REREP,=C'NU'        AND NOT CLEAR CHANNEL                        
         BE    STRPK4N                                                          
*                                                                               
         MVC   REDMREP,REMREP         USE MASTER REP                            
         MVC   RCTYKREP-RCTYKEY(L'RCTYKREP,R2),REDMREP                          
*                                                                               
         B     SETREPX                                                          
*                                                                               
STRPK3N  DS    0H                                                               
*                                                                               
         CLI   0(R2),RCTYKTYQ      IF CONTRACT TYPE SET AND                     
         BNE   STRPK4N                                                          
*                                                                               
         MVC   REDMREP,REQREP         USE REQUESTING REP                        
         MVC   RCTYKREP-RCTYKEY(L'RCTYKREP,R2),REDMREP                          
*                                                                               
         B     SETREPX                                                          
*                                                                               
STRPK4N  DS    0H                                                               
*                                                                               
         L     R1,=A(INTEREP)      POINT TO REP TRANSLATION TAB                 
*                                                                               
STRPLOOP DS    0H                                                               
*                                                                               
         CLI   RTABID(R1),0        DONE AT END OF TABLE                         
         BE    STRPDONE                                                         
*                                                                               
         CLC   REREP,RTABSUB(R1)   MATCH ON SUBSIDIARY REP                      
         BNE   STRPCONT                                                         
*                                                                               
         CLC   RTABID(1,R1),0(R2)  MATCH ON RECORD TYPE                         
         BE    STRPFND                                                          
*                                                                               
STRPCONT DS    0H                                                               
*                                                                               
         LA    R1,RTABELEN(R1)     BUMP TO NEXT TABLE ENTRY                     
         B     STRPLOOP                                                         
*                                                                               
STRPFND  DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         IC    RF,RTABDISP(R1)     GET DISPLACEMENT OF REP IN KEY               
         LA    RF,0(RF,R2)         POINT TO REP IN KEY                          
*                                                                               
         MVC   REDMREP,RTABMAST(R1)  SAVE REP FOR READING FILE                  
         MVC   0(L'REREP,RF),RTABMAST(R1)   REPLACE SUB REP                     
*                                                                               
STRPDONE DS    0H                                                               
*                                                                               
SETREPX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - TBLREP'                         
***********************************************************************         
*                                                                     *         
*        SET CORRECT REP IN KEY FOR TABLE LOOKUP                      *         
*                                                                     *         
*        IF RECORDS ARE READ AT SUBREP LEVEL THEN THEY ARE            *         
*        STORED IN TABLE AT MASTER REP LEVEL                          *         
*        EXCEPTION OCCURS IF REP KEYWORD IS PART OF THE REPORT        *         
*                                                                     *         
*NTRY    PARM0     A(KEY CONTAINING REP)                              *         
*                                                                     *         
*EXIT    RETBREP   REP FOR SEARCHING TABLES                           *         
*                                                                     *         
*        CANNOT REPLACE REP IN KEY BECAUSE IF KEYTYPE IS NOT          *         
*        IN MASTER/SUB REP TABLE WE DO NOT KNOW WHERE                 *         
*        REP IS IN KEY                                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
TBLREP   NTR1  LABEL=*                                                          
*                                                                               
         MVC   RETBREP,REREP       DEFAULT TO CURRENT REP                       
*                                                                               
         OC    REMREP,REMREP       DONE IF NO MASTER REP                        
         BZ    TBLREPX                                                          
*                                                                               
         CLC   =C'K3',REMREP       SKIP IF KATZ                                 
         BE    *+12                                                             
         TM    REKYWTYP,REKYREPQ   IF REP NOT PART OF REQUEST                   
         BO    TBRPREPX                                                         
*                                                                               
         MVC   RETBREP,REMREP         USE MASTER REP                            
*                                                                               
         B     TBRPDONE                                                         
*                                                                               
TBRPREPX DS    0H                                                               
*                                                                               
         L     R2,0(R1)            POINT TO KEY CONTAINING REP                  
*                                                                               
         L     R1,=A(INTEREP)      POINT TO REP TRANSLATION TAB                 
*                                                                               
TBRPLOOP DS    0H                                                               
*                                                                               
         CLI   RTABID(R1),0        DONE AT END OF TABLE                         
         BE    TBRPDONE                                                         
*                                                                               
         CLC   REREP,RTABSUB(R1)   MATCH ON SUBSIDIARY REP                      
         BNE   TBRPCONT                                                         
*                                                                               
         CLC   RTABID(1,R1),0(R2)  MATCH ON RECORD TYPE                         
         BE    TBRPFND                                                          
*                                                                               
TBRPCONT DS    0H                                                               
*                                                                               
         LA    R1,RTABELEN(R1)     BUMP TO NEXT TABLE ENTRY                     
         B     TBRPLOOP                                                         
*                                                                               
TBRPFND  DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         IC    RF,RTABDISP(R1)     GET DISPLACEMENT OF REP IN KEY               
         LA    RF,0(RF,R2)         POINT TO REP IN KEY                          
*                                                                               
         MVC   RETBREP,RTABMAST(R1)  SAVE MASTER REP                            
*                                                                               
TBRPDONE DS    0H                                                               
*                                                                               
TBLREPX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - DATAMGR'                        
***********************************************************************         
*                                                                     *         
*        DATA MANAGER INTERFACE                                       *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
READ     MVC   COMMAND,=CL8'DMREAD'                                             
         MVC   KEYSAVE,KEY                                                      
         B     RDIR                                                             
*                                                                               
SEQ      MVC   COMMAND,=CL8'DMRSEQ'                                             
         B     RDIR                                                             
*                                                                               
FIRSTHI  OC    REQSKEY,REQSKEY     POSSIBLE OVERRIDING KEY                      
         BZ    HIGH                                                             
         MVC   KEY(27),REQSKEY                                                  
*                                                                               
HIGH     MVC   COMMAND,=CL8'DMRDHI'                                             
         MVC   KEYSAVE,KEY                                                      
*                                                                               
RDIR     NTR1  LABEL=*                                                          
*                                                                               
         LA    R2,KEY+28                                                        
*                                                                               
         ICM   RF,15,REUTLA        IF A(UTL) KNOWN                              
         BZ    *+18                                                             
         CLI   RESE,0              AND SE NUMBER KNOWN                          
         BE    *+10                                                             
         MVC   4(1,RF),RESE           SET SE NUMBER FOR DATAMGR                 
*                                                                               
         TM    STATUS,ROIREC                                                    
         BZ    READ10                                                           
*                                                                               
         MVC   DIRNAME,=CL8'ROIDIR'                                             
         LA    R2,KEY+32                                                        
         XC    KEY,KEY                                                          
*                                                                               
READ10   GOTO1 DATAMGR,DMCB,(DMINBITS,COMMAND),DIRNAME,KEYSAVE,KEY              
*                                                                               
         CLI   RETRACE,C'Y'        SKIP IF NOT TRACING                          
         BNE   READ11                                                           
*                                                                               
         GOTO1 =A(KEYTRA),DIRNAME  TRACE KEYS                                   
*                                                                               
READ11   DS    0H                                                               
*                                                                               
         MVC   DIRNAME,=CL8'REPDIR'                                             
*                                                                               
         TM    STATUS,ROIREC                                                    
         BO    READ20                                                           
*                                                                               
         MVC   REKEY,KEY           PASS USER KEY                                
*                                                                               
READ20   MVC   REDSKADD,0(R2)      AND DISK ADDRESS                             
*                                                                               
         TM    DMCB+8,X'10'                                                     
         BO    NOTOK               RECORD NOT FOUND                             
         TM    DMCB+8,X'02'                                                     
         BO    NOTOK               RECORD IS DELETED                            
*                                                                               
         B     DMCHECK                                                          
*                                                                               
GETREC   MVC   COMMAND,=CL8'GETREC'                                             
         B     RDFILE                                                           
*                                                                               
RDFILE   NTR1  LABEL=*                                                          
*                                                                               
         ICM   RF,15,REUTLA        IF A(UTL) KNOWN                              
         BZ    *+18                                                             
         CLI   RESE,0              AND SE NUMBER KNOWN                          
         BE    *+10                                                             
         MVC   4(1,RF),RESE           SET SE NUMBER FOR DATAMGR                 
*                                                                               
         LA    R2,KEY+28                                                        
         L     R3,REAIO                                                         
*                                                                               
         TM    STATUS,ROIREC                                                    
         BZ    READF10                                                          
*                                                                               
         MVC   FILENAME,=CL8'ROIFIL'                                            
         LA    R2,KEY+32                                                        
         L     R3,REAIO2                                                        
*                                                                               
READF10  GOTO1 DATAMGR,DMCB,(DMINBITS,COMMAND),                        X        
               FILENAME,(R2),(R3),DMWORK                                        
         CLI   RETRACE,C'Y'        SKIP IF NOT TRACING                          
         BNE   READF11                                                          
*                                                                               
         GOTO1 =A(KEYTRA),FILENAME TRACE KEYS                                   
*                                                                               
READF11  DS    0H                                                               
*                                                                               
         MVC   FILENAME,=CL8'REPFIL'                                            
         ST    R3,REAREC                                                        
*                                                                               
DMCHECK  TM    DMCB+8,X'02'        ACCEPT DELETED RECORD                        
         BO    NOTOK                                                            
         CLI   DMCB+8,0                                                         
         BE    XIT                                                              
         DC    H'0'                                                             
*                                                                               
*        TABLES USED BY TRACE ROUTINES                                          
*                                                                               
HEXTRN   DC    C'0123456789ABCDEF'                                              
*                                                                               
PRNTBLE  DC    256C'.'             PRINTABLE CHARACTERS                         
         ORG   PRNTBLE+C'A'                                                     
         DC    C'ABCDEFGHI'                                                     
         ORG   PRNTBLE+C'J'                                                     
         DC    C'JKLMNOPQR'                                                     
         ORG   PRNTBLE+C'S'                                                     
         DC    C'STUVWXYZ'                                                      
         ORG   PRNTBLE+C'0'                                                     
         DC    C'0123456789'                                                    
         ORG   PRNTBLE+C' '                                                     
         DC    C' '                                                             
         ORG   PRNTBLE+C'*'                                                     
         DC    C'*'                                                             
*                                                                               
         ORG                                                                    
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - DATAMGR'                        
***********************************************************************         
*                                                                     *         
*              ASSORTED ROUTINES                                      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         GETEL R6,DATADISP,ELCODE                                               
*                                                                               
KEYCOMP  ZIC   R1,LKEY             VARIABLE LENGTH FOR COMPARISON               
         BCTR  R1,0                DECREMENT FOR EXECUTE                        
         EX    R1,*+6              SET CC                                       
         BR    RE                  AND EXIT                                     
         CLC   KEY(0),KEYSAVE                                                   
*                                                                               
OK       SR    R1,R1                                                            
         B     *+8                                                              
*                                                                               
NOTOK    LA    R1,1                                                             
*                                                                               
         LTR   R1,R1                                                            
*                                                                               
XIT      XIT1                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - DATAMGR'                        
***********************************************************************         
*                                                                     *         
*              CONSTANTS TABLES ETC                                   *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
DATADISP DC    H'34'                                                            
DMINBITS DC    X'00'                                                            
***DMINBITS DC    X'08'                                                         
*                                                                               
* ROUTINE ADDRESSES FOR DIFFERENT RECORDS *                                     
*                                                                               
READADDS DS    0A                                                               
         DC    AL1(RADVKTYQ),AL3(ADV-RENWRIO)                                   
         DC    AL1(RAGK2TYQ),AL3(AGY-RENWRIO)                                   
         DC    AL1(RBUDKTYQ),AL3(BUD-RENWRIO)                                   
         DC    AL1(RBSPKTYQ),AL3(BSP-RENWRIO)                                   
         DC    AL1(RBSSKTYQ),AL3(BSP-RENWRIO)                                   
         DC    AL1(RBCDKTYQ),AL3(BCD-RENWRIO)  BUY CODES                        
         DC    AL1(ROBDKTYQ),AL3(OBD-RENWRIO)                                   
         DC    AL1(RCLSKTYQ),AL3(STD-RENWRIO)                                   
         DC    AL1(RCBDKTYQ),AL3(CBD-RENWRIO)                                   
         DC    AL1(RCONKTYQ),AL3(CON-RENWRIO)                                   
*        DC    AL1(RCONKTYQ),AL3(FLT-RENWRIO)  USE RIS KEYS ALWAYS              
         DC    AL1(RCTGKTYQ),AL3(STD-RENWRIO)                                   
         DC    AL1(RCTYKTYQ),AL3(STD-RENWRIO)                                   
         DC    AL1(RDCTKTYQ),AL3(STD-RENWRIO)                                   
         DC    AL1(RDSPKTYQ),AL3(STD-RENWRIO)                                   
         DC    AL1(RGRPKTYQ),AL3(STD-RENWRIO)                                   
         DC    AL1(RMKTKTYQ),AL3(STD-RENWRIO)                                   
         DC    AL1(RNRGKTYQ),AL3(RGON-RENWRIO)                                  
         DC    AL1(RFLTKTYQ),AL3(FLT-RENWRIO)                                   
         DC    AL1(ROFFKTYQ),AL3(STD-RENWRIO)                                   
         DC    AL1(ROWNKTYQ),AL3(STD-RENWRIO)                                   
         DC    AL1(RPRDKTYQ),AL3(PRD-RENWRIO)                                   
         DC    AL1(RPTPKTYQ),AL3(STD-RENWRIO)                                   
         DC    AL1(RREGKTYQ),AL3(STD-RENWRIO)                                   
         DC    AL1(RREPKTYQ),AL3(REP-RENWRIO)                                   
         DC    AL1(RSALKTYQ),AL3(STD-RENWRIO)                                   
*******  DC    AL1(RSTAKTYQ),AL3(STA-RENWRIO)                                   
         DC    AL1(RSJLKTYQ),AL3(SJL-RENWRIO)                                   
         DC    AL1(RTEMKTYQ),AL3(STD-RENWRIO)                                   
         DC    AL1(RTERKTYQ),AL3(STD-RENWRIO)                                   
         DC    X'FF'                                                            
         EJECT                                                                  
*                                                                               
ROIFLSTR DC    CL8' ROIDIR'        READ-ONLY LIST                               
         DC    CL8' ROIFILE'                                                    
         DC    CL8'X       '                                                    
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - GOHOOK'                         
***********************************************************************         
*                                                                     *         
*        HOOK TO APPLICATION                                          *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
GOHOOK   NTR1  LABEL=*                                                          
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         OI    STATUS,FOUNDONE     SET WE PASSED A RECORD TO APPLIC.            
         MVI   REMODE,PROCREC                                                   
*                                                                               
         L     RF,REHOOK                                                        
         L     RE,USERRD                                                        
         LM    R0,RC,20(RE)                                                     
*                                                                               
         BASR  RE,RF                                                            
*                                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - RELINIT'                        
***********************************************************************         
*                                                                     *         
*        INITIALIZATION CODE                                          *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RELINIT  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         CLC   =CL8'REPDIR',DIRNAME                                             
         BE    RELINITX            INIT ALREADY DONE                            
*                                                                               
         L     R1,REACOMFC         COMFACS ADDRESSES                            
         USING COMFACSD,R1                                                      
*                                                                               
         MVC   DATAMGR,CDATAMGR                                                 
         MVC   DATCON,CDATCON                                                   
         MVC   GETDAY,CGETDAY                                                   
         MVC   HEXOUT,CHEXOUT                                                   
         MVC   PERVERT,CPERVERT                                                 
         MVC   ADDAY,CADDAY                                                     
         MVC   BINSRCH,=V(BINSRCH)                                              
         MVC   CALLOV,CCALLOV                                                   
         MVC   XSORT,CXSORT                                                     
*                                                                               
         MVC   VRECUP,=V(RECUP)                                                 
*                                                                               
*                                  GET ADDRESS OF SQUASHER                      
         GOTO1 CALLOV,DMCB,0,X'D9000A0D'                                        
         MVC   SQUASHER,0(R1)                                                   
*                                  GET A(GETBROAD)                              
         GOTO1 CALLOV,DMCB,0,X'D9000A1D'                                        
         MVC   GETBROAD,0(R1)                                                   
         MVC   REGETBRD,GETBROAD   PASS TO WRITER                               
*                                  GET A(REPFACS)                               
         GOTO1 CALLOV,DMCB,0,X'D9000AAC'                                        
         MVC   VREPFACS,0(R1)                                                   
*                                                                               
         MVI   SPACES,C' '                                                      
         MVC   SPACES+1(L'SPACES-1),SPACES                                      
*                                                                               
         MVI   RESPACES,C' '                                                    
         MVC   RESPACES+1(L'RESPACES-1),RESPACES                                
*                                                                               
         MVC   DIRNAME,=CL8'REPDIR'                                             
         MVC   FILENAME,=CL8'REPFIL'                                            
*                                                                               
*                                                                               
* SET UP DATE PARAMETERS                                                        
*                                                                               
         MVC   SVQSTART,REQPSTR    SAVE REQUEST PERIOD                          
         MVC   SVQEND,REQPEND                                                   
*                                                                               
*        SEED DUMP FOR LEGIBILITY                                               
*                                                                               
         MVC   RENWRIOD,=CL8'*WRIIOD*'                                          
         MVC   REFILTSH,=CL8'**FILTS*'                                          
         MVC   REMODEH,=CL8'**MODE**'                                           
         MVC   READDSH,=CL8'**ADDS**'                                           
         MVC   REKEYH,=CL8'**REKEY*'                                            
         MVC   RECODESH,=CL8'**CODES*'                                          
         MVC   RESUBS,=CL8'**SUBS**'                                            
         MVC   REQRECS,=CL8'**QREC**'                                           
*                                                                               
         MVC   REAIO,REAIO1        INIT IOAREA                                  
*                                                                               
         EJECT                                                                  
*                                                                               
*        INIT VALU2 TABLE(S) - MULTIPLES IF ASATDATE COLUMN FILTERS             
*                                                                               
         SR    R0,R0                                                            
         IC    R0,REQAADFN         NUMBER OF AS-AT-DATE FILTERS                 
         AH    R0,=H'1'            BUMP FOR REGULAR REPORT ALSO                 
         ICM   R3,15,REAADTBA      POINT TO START OF ASATDATES TABLE            
         BZ    RININI10            NONE AVAILABLE                               
*                                                                               
         OC    0(6,R3),0(R3)       SKIP IF ASATDATE ENTERED                     
         BNZ   RININI10                                                         
*                                                                               
*                                  ELSE USE RUN DATE AS AS-AT-DATE              
*                                                                               
         GOTO1 DATCON,DMCB,(5,0),(3,0(R3))  TODAY'S DATE                        
*                                                                               
RININI10 DS    0H                                                               
*                                                                               
         L     RF,REANWMON         ESTABLISH ADDRESSES OF W/A                   
         USING NWMNTABD,RF         ESTABLISH NEW MONTH TABLE AREA               
*                                                                               
RININWLP DS    0H                                                               
*                                                                               
         MVC   NWMTLABL,=C'**NEWMONTB**'  LABEL AREA                            
*                                                                               
         SR    RE,RE                                                            
         IC    RE,REQAADFN         NUMBER OF ASATDATES IN COLUMNS               
         LA    RE,1(RE)            ADD ONE FOR WHOLE REPORT                     
         SR    RE,R0               SECTION NUMBER                               
*                                                                               
         CVD   RE,DUB                                                           
         OI    DUB+7,X'0F'         SECTION NUMBER                               
         UNPK  NWMTLABL+10(1),DUB+7(1)                                          
*                                                                               
         MVC   NWMTAADT(6),0(R3)   SET ASATDATES                                
*                                                                               
RININWCN DS    0H                                                               
         LA    R3,6(R3)            BUMP TO NEXT AS-AT-DATE                      
         A     RF,=AL4(NWMTENTL)   BUMP TO NEXT SECTION                         
         BCT   R0,RININWLP                                                      
*                                                                               
RININWDN DS    0H                                                               
*                                                                               
RELINITX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE -BUD'                             
***********************************************************************         
*                                                                     *         
*        READ BUDGET RECORDS                                          *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
BUD      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
*        FIND FIRST REP                                                         
*                                                                               
         ICM   R2,15,REREPTBA      SKIP IF NO REP TABLE                         
         JZ    BREPREPX                                                         
*                                                                               
         USING REPTTABD,R2         ESTABLISH REP TABLE                          
*                                                                               
         ICM   R3,15,BSPATAB-BSPPRMS+REPTBSRP  1ST ENTRY IN TABLE               
         JZ    BREPREPX             NO TABLE                                    
*                                                                               
         USING REPTENT,R3          ESTABLISH REP TABLE ENTRY                    
*                                                                               
BREPLOOP DS    0H                  PROCESS BUDGET RECS FOR A REP                
*                                                                               
         OC    REPTENT(REPTENTL),REPTENT  TEST FOR END OF TABLE                 
         JZ    BREPDONE                                                         
*                                                                               
         ST    R3,REPTENTA         SET CURRENT TABLE ENTRY ADDRESS              
*                                                                               
         TM    REPTKEY+27,X'80'    SKIP IF DELETED                              
         BO    BREPCONT                                                         
*                                                                               
         MVC   REREPTA,REPTENTA    RETURN A(REP TABLE ENTRY)                    
*                                                                               
         MVC   REREP,RREPKREP-RREPKEY+REPTKEY   RETURN REP                      
         MVC   RESE,REPTSE         RETURN REP'S SE CODE                         
*                                                                               
         OC    REXFREP(REXFREPL),REXFREP IF CROSS-FILE REPORTING                
         BZ    *+10                                                             
         OC    REFGRP,REFGRP       IF FILTERING ON GROUP                        
         BZ    *+10                                                             
         MVC   REFGRP,REPTGRP         SET SPECIAL GROUP CODE                    
*                                                                               
         ICM   RF,15,REUTLA        POINT TO UTL                                 
         JZ    *+18                SKIP IF NOT AVAILABLE                        
         CLI   REPTSE,0            SKIP IF NOT AVAILABLE                        
         BE    *+10                                                             
         MVC   4(1,RF),REPTSE      SET SE NUMBER                                
*                                                                               
         XC    REMREP,REMREP       INIT MASTER REP                              
*                                                                               
         LA    R4,REPTELM          ESTABLISH REP DECRIPTION ELEMENT             
         USING RREPELEM,R4                                                      
*                                                                               
         CLC   =C'NU',REREP        SPECIAL FOR REP 'NU'                         
         BNE   *+14                                                             
         MVC   REMREP,=C'K3'                                                    
         B     BREPMRPX                                                         
*                                                                               
         CLC   RREPMAST,=CL4' '    SKIP IF NO MASTER REP                        
         BE    BREPMRPX                                                         
*                                                                               
         OC    RREPMAST,RREPMAST   SKIP IF NO MASTER REP                        
         BZ    BREPMRPX                                                         
*                                                                               
         CLC   RREPMAST,=4X'FF'    IF MASTER REP                                
         BNE   *+14                                                             
         MVC   REMREP,REREP           SAVE CURRENT REP AS MASTER REP            
         B     BREPMRPX                                                         
*                                                                               
         MVC   REMREP,RREPMAST     ELSE SAVE MASTER REP                         
*                                                                               
BREPMRPX DS    0H                                                               
*                                                                               
         BRAS  RE,TABS             LOAD REP'S TABLES                            
*                                                                               
         BRAS  RE,STA              LOAD REP'S STATIONS TO TABLE                 
*                                                                               
***********************************************************************         
*                                                                     *         
*        READ STATION BUDGET RECORDS FOR REP                          *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING RBUDKEY,R4          ESTABLISH BUDGET BASE KEY                    
*                                                                               
*        INIT CURRENT VALUES OF ALL KEY FIELDS                                  
*                                                                               
         XC    REBUDYR,REBUDYR     BUDGET YEAR                                  
         XC    REGRS,REGRS         GROUP                                        
         XC    RESTA,RESTA         STATION                                      
         XC    REOFF,REOFF         OFFICE                                       
*                                                                               
*        FIND STARTING VALUES FOR KEY FIELDS                                    
*                                                                               
         GOTO1 =A(BUDYRGET),DMCB,(C'N',REBUDYR) FIND FIRST YEAR                 
         GOTO1 =A(GRPGET),DMCB,(C'N',REGRP)     FIND FIRST GROUP                
         GOTO1 =A(STGET),DMCB,(C'N',RESTA)      FIND FIRST STATION              
*                                                                               
         L     R6,REAIO3           ESTABLISH STATION RECORD                     
         USING RSTAKEY,R6                                                       
*                                                                               
         CLI   RSTAKTYP,RSTAKTYQ   SKIP IF STATION REC NOT IN CORE              
         BNE   BUDINIT0                                                         
*                                                                               
         GOTO1 =A(GRPGET),DMCB,(C'G',RSTAGRUP) FIND STATION'S GROUP             
*                                                                               
         DROP  R6                                                               
*                                                                               
BUDINIT0 DS    0H                                                               
*                                                                               
         TM    REBTPS,X'40'        SKIP IF OFFICE LEVEL NOT WANTED              
         BNO   BUDINIT1                                                         
*                                                                               
         GOTO1 =A(OFFGET),DMCB,(C'N',REOFF)     FIND FIRST OFFICE               
*                                                                               
BUDINIT1 DS    0H                                                               
*                                                                               
*        FILL IN BUDGET KEY                                                     
*                                                                               
         MVI   RBUDKTYP,RBUDKTYQ   RECORD TYPE                                  
         MVC   RBUDKREP,REREP      REP                                          
         MVC   RBUDKYR,REBUDYR     BUDGET YEAR                                  
         MVC   RBUDKSTA,RESTA      STATION        (MAY BE NULLS)                
         MVC   RBUDKTEM,REOFF      OFFICE         (MAY BE NULLS)                
*                                                                               
         BRAS  RE,FIRSTHI          READ FIRST RECORD                            
*                                                                               
BUDLOOP  DS    0H                                                               
*                                                                               
*        CHECK FOR MAJOR CHANGES IN KEY                                         
*                                                                               
         LA    R4,KEY              RE-ESTABLISH KEY POINTER                     
*                                                                               
         CLC   RBUDKEY(RBUDKYR-RBUDKEY),KEYSAVE IF REP CHANGED                  
         JNE   BUDYR10             SAME AS CHANGE IN YEAR                       
*                                                                               
BUDYR    DS    0H                                                               
*                                                                               
         CLC   RBUDKYR,REBUDYR     IF YEAR CHANGED                              
         JE    BUDYROK                                                          
*                                                                               
BUDYR10  DS    0H                                                               
*                                                                               
         MVC   RBUDKEY,KEYSAVE     RESTORE SOUGHT KEY                           
*                                                                               
         GOTOR BUDYRGET,DMCB,(C'N',RBUDKYR)  FIND NEXT BUDGET YEAR              
         JNE   BUDDONE                     DONE IF NONE FOUND                   
*                                                                               
         XC    RESTA,RESTA            FORCE STATION LOOK UP                     
         XC    REOFF,REOFF            OFFICE                                    
*                                                                               
         J     BUDKEY                                                           
*                                                                               
BUDYROK  DS    0H                                                               
*                                                                               
BUDSTA   DS    0H                                                               
*                                                                               
         CLC   RBUDKSTA,RESTA      IF STATION CHANGES                           
         JE    BUDSTAOK                                                         
*                                                                               
         XC    REGRS,REGRS         NO FILTERING ON GROUP                        
*                                                                               
         GOTO1 =A(STGET),DMCB,(C'G',RBUDKSTA)     FIND NEXT STATION             
*                                                                               
         L     R6,REAIO3           ESTABLISH STATION RECORD                     
         USING RSTAKEY,R6                                                       
*                                                                               
         CLI   RSTAKTYP,RSTAKTYQ   SKIP IF STATION REC NOT IN CORE              
         BNE   BUDSTA10                                                         
*                                                                               
         GOTO1 =A(GRPGET),DMCB,(C'G',RSTAGRUP) FIND STATION'S GROUP             
*                                                                               
         CLC   REGRS,RSTAGRUP      OKAY IF STATION'S GROUP USED                 
         BE    BUDSTA10                                                         
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,RESTA+4        FORCE NEXT STATION                           
         LA    RF,1(RF)                                                         
         STC   RF,RESTA+4                                                       
*                                                                               
         B     BUDCNSKP                                                         
*                                                                               
         DROP  R6                                                               
*                                                                               
BUDSTA10 DS    0H                                                               
*                                                                               
         CLC   RESTA,RBUDKSTA      IF DEFAULT NOT USED                          
         JE    BUDSTAOK                                                         
*                                                                               
         XC    REOFF,REOFF            FORCE OFFICE LOOK UP                      
*                                                                               
         J     BUDKEY                                                           
*                                                                               
BUDSTAOK DS    0H                                                               
*                                                                               
BUDOFF   DS    0H                                                               
*                                                                               
         CLC   RBUDKTEM,REOFF      IF OFFICE CHANGES                            
         JE    BUDOFFOK                                                         
*                                                                               
         TM    REBTPS,X'40'        IF OFFICE LEVEL NOT WANTED                   
         BO    BUDOFF10                                                         
*                                                                               
         CLC   RBUDKTEM,RESPACES      IF NO OFFICE IN KEY                       
         BH    *+14                                                             
         XC    REOFF,REOFF               OKAY                                   
         B     BUDOFFOK                                                         
*                                                                               
BUDOFF10 DS    0H                                                               
*                                                                               
         GOTO1 =A(OFFGET),DMCB,(C'G',RBUDKTEM)  FIND NEXT OFFICE                
*                                                                               
         CLC   REOFF,RBUDKTEM      IF DEFAULT USED                              
         JE    BUDOFFOK               OKAY                                      
*                                                                               
         TM    REBTPS,X'40'        IF OFFICE LEVEL NOT WANTED                   
         BNO   BUDOFFOK               OKAY                                      
*                                                                               
         J     BUDKEY                                                           
*                                                                               
BUDOFFOK DS    0H                                                               
*                                                                               
*        CHECK IF CURRENT KEY IS ACCEPTABLE                                     
*              ANY BREAK IN KEY FORCES A SKIP READ                              
*                                                                               
BUDKEY   DS    0H                                                               
*                                                                               
         CLC   RBUDKYR,REBUDYR     YEAR                                         
         JNE   BUDCNSKP                                                         
         CLC   RBUDKSTA,RESTA      STATION                                      
         JNE   BUDCNSKP                                                         
*                                                                               
         TM    REBTPS,X'40'        IF OFFICE LEVEL NOT WANTED                   
         BNO   BUDKEYOK               OKAY                                      
*                                                                               
         CLC   RBUDKTEM,REOFF      OFFICE                                       
         JNE   BUDCNSKP                                                         
*                                                                               
BUDKEYOK DS    0H                                                               
*                                                                               
         TM    RBUDKEY+27,X'80'    SKIP DELETED RECORDS                         
         JO    BUDCONT                                                          
*                                                                               
         BRAS  RE,GETREC           READ BUDGET RECORD                           
         JNZ   BUDCONT             SKIP DELETED RECORDS                         
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
         USING RBUDREC,R4          ESTABLISH RECORD                             
*                                                                               
         XC    RECTY,RECTY         INIT CONTRACT TYPE                           
*                                                                               
         MVI   ELCODE,X'01'        FIND STATION BUDGET ELEMENT                  
         LR    R6,R4               START OF RECORD                              
         BRAS  RE,GETEL                                                         
         JNE   BUDSTAX             ELEMENT NOT FOUND                            
*                                                                               
         CLI   REBTPS,0            OKAY IF ALL BUDGET TYPES WANTED              
         BE    *+12                                                             
         TM    REBTPS,X'20'        IF CTY NOT WANTED                            
         BO    BUDSTAX                                                          
*                                                                               
         USING RBUDELEM,R6            ESTABLISH STATION ELEMENT                 
*                                                                               
         BRAS  RE,BUDPOST             POST STATION BUDGET                       
*                                                                               
         BRAS  RE,BUDHOOK             HOOK TO DRIVER                            
*                                                                               
BUDSTAX  DS    0H                                                               
*                                                                               
         CLI   RBUDCNTR,0          SKIP IF NO CTY ELEMENTS                      
         JE    BUDCTPX                                                          
*                                                                               
         CLI   REBTPS,0            OKAY IF ALL BUDGET TYPES WANTED              
         BE    *+12                                                             
         TM    REBTPS,X'20'        SKIP IF CTP NOT WANTED                       
         BNO   BUDCTPX                                                          
*                                                                               
BUDCTP   DS    0H                  LOOP THRU CONTRACT TYPES                     
*                                                                               
         MVI   ELCODE,X'02'        LOOK FOR CONTRACT TYPE ELEMENT               
         LR    R6,R4                                                            
         BRAS  RE,GETEL                                                         
*                                                                               
BUDCTPLP DS    0H                                                               
*                                                                               
         JNE   BUDCTPDN            NO MORE ELEMENTS IN RECORD                   
*                                                                               
         GOTO1 =A(CTYGET),DMCB,(C'G',RBUDTYPE)  VALIDATE CONTRACT TYPE          
         JNE   BUDCTPCN            NOT WANTED FOR REPORT                        
*                                                                               
         BRAS  RE,BUDPOST          POST ELEMENT                                 
*                                                                               
         BRAS  RE,BUDHOOK          HOOK TO DRIVER                               
*                                                                               
BUDCTPCN DS    0H                                                               
*                                                                               
         BRAS  RE,NEXTEL           GET NEXT ELEMENT                             
         J     BUDCTPLP                                                         
*                                                                               
BUDCTPDN DS    0H                                                               
*                                                                               
BUDCTPX  DS    0H                                                               
*                                                                               
BUDCONT  DS    0H                                                               
*                                                                               
         MVC   KEYSAVE,RBUDKEY     UPDATE STARTING KEY                          
*                                                                               
         BRAS  RE,SEQ                                                           
*                                                                               
         J     BUDLOOP             GET NEXT RECORD                              
*                                                                               
BUDCNSKP DS    0H                                                               
*                                                                               
*        RE-BUILD SEARCH KEY                                                    
*                                                                               
         MVI   RBUDKTYP,RBUDKTYQ   RECORD TYPE                                  
         MVC   RBUDKREP,REREP      REP                                          
*                                                                               
         MVC   RBUDKYR,REBUDYR     BUDGET YEAR    (MAY BE NULLS)                
         MVC   RBUDKSTA,RESTA      STATION        (MAY BE NULLS)                
         MVC   RBUDKTEM,REOFF      OFFICE         (MAY BE NULLS)                
*                                                                               
         BRAS  RE,HIGH             SKIP READ                                    
         J     BUDLOOP             GET NEXT RECORD                              
*                                                                               
BUDDONE  DS    0H                                                               
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE -BREPCONT'                        
***********************************************************************         
*                                                                     *         
*        FIND NEXT REP                                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
BREPCONT DS    0H                                                               
*                                                                               
         ICM   R2,15,REREPTBA      SKIP IF NO REP TABLE                         
         JZ    BREPDONE                                                         
*                                                                               
         USING REPTTABD,R2         ESTABLISH REP TABLE                          
*                                                                               
         ICM   R3,15,REPTENTA      POINT TO CURRENT TABLE ENTRY                 
         JZ    BREPDONE                                                         
*                                                                               
         USING REPTENT,R3          ESTABLISH TABLE ENTRY                        
*                                                                               
         A     R3,BSPLENR-BSPPRMS+REPTBSRP BUMP TO NEXT ENTRY                   
*                                                                               
         J     BREPLOOP                                                         
*                                                                               
BREPDONE DS    0H                                                               
*                                                                               
         XC    REPTENTA,REPTENTA   INDICATE END OF TABLE REACHED                
         MVC   REREPTA,REPTENTA                                                 
*                                                                               
BREPREPX DS    0H                                                               
*                                                                               
BUDX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE -CBD'                             
***********************************************************************         
*                                                                     *         
*        READ COMPANY BUDGET RECORDS                                  *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
CBD      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
*        FIND FIRST REP                                                         
*                                                                               
         ICM   R2,15,REREPTBA      SKIP IF NO REP TABLE                         
         JZ    CBRPREPX                                                         
*                                                                               
         USING REPTTABD,R2         ESTABLISH REP TABLE                          
*                                                                               
         ICM   R3,15,BSPATAB-BSPPRMS+REPTBSRP  1ST ENTRY IN TABLE               
         JZ    CBRPREPX             NO TABLE                                    
*                                                                               
         USING REPTENT,R3          ESTABLISH REP TABLE ENTRY                    
*                                                                               
CBRPLOOP DS    0H                  PROCESS CBDGET RECS FOR A REP                
*                                                                               
         OC    REPTENT(REPTENTL),REPTENT  TEST FOR END OF TABLE                 
         JZ    CBRPDONE                                                         
*                                                                               
         ST    R3,REPTENTA         SET CURRENT TABLE ENTRY ADDRESS              
*                                                                               
         TM    REPTKEY+27,X'80'    SKIP IF DELETED                              
         BO    CBRPCONT                                                         
*                                                                               
         MVC   REREPTA,REPTENTA    RETURN A(REP TABLE ENTRY)                    
*                                                                               
         MVC   REREP,RREPKREP-RREPKEY+REPTKEY   RETURN REP                      
         MVC   RESE,REPTSE         RETURN REP'S SE CODE                         
*                                                                               
         OC    REXFREP(REXFREPL),REXFREP IF CROSS-FILE REPORTING                
         BZ    *+10                                                             
         OC    REFGRP,REFGRP       IF FILTERING ON GROUP                        
         BZ    *+10                                                             
         MVC   REFGRP,REPTGRP         SET SPECIAL GROUP CODE                    
*                                                                               
         ICM   RF,15,REUTLA        POINT TO UTL                                 
         JZ    *+18                SKIP IF NOT AVAILABLE                        
         CLI   REPTSE,0            SKIP IF NOT AVAILABLE                        
         BE    *+10                                                             
         MVC   4(1,RF),REPTSE      SET SE NUMBER                                
*                                                                               
         XC    REMREP,REMREP       INIT MASTER REP                              
*                                                                               
         LA    R4,REPTELM          ESTABLISH REP DECRIPTION ELEMENT             
         USING RREPELEM,R4                                                      
*                                                                               
         CLC   =C'NU',REREP        SPECIAL FOR REP 'NU'                         
         BNE   *+14                                                             
         MVC   REMREP,=C'K3'                                                    
         B     CBRPMRPX                                                         
*                                                                               
         CLC   RREPMAST,=CL4' '    SKIP IF NO MASTER REP                        
         BE    CBRPMRPX                                                         
*                                                                               
         OC    RREPMAST,RREPMAST   SKIP IF NO MASTER REP                        
         BZ    CBRPMRPX                                                         
*                                                                               
         CLC   RREPMAST,=4X'FF'    IF MASTER REP                                
         BNE   CBRPMRP1                                                         
*                                                                               
         MVC   REMREP,REREP           SAVE CURRENT REP AS MASTER REP            
*                                                                               
         CLC   REREP,REQREP           SKIP IF NOT REQUESTING REP                
         BNE   CBRPCONT                  BUDGETS AT LOCAL REP LEVEL             
*                                                                               
         B     CBRPMRPX                                                         
*                                                                               
CBRPMRP1 DS    0H                                                               
*                                                                               
         MVC   REMREP,RREPMAST     ELSE SAVE MASTER REP                         
*                                                                               
CBRPMRPX DS    0H                                                               
*                                                                               
         BRAS  RE,TABS             LOAD REP'S TABLES                            
*                                                                               
***********************************************************************         
*                                                                     *         
*        READ COMPANY BUDGET RECORDS FOR REP                          *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING RBUDKEY,R4          ESTABLISH CBDGET BASE KEY                    
*                                                                               
*        INIT CURRENT VALUES OF ALL KEY FIELDS                                  
*                                                                               
         XC    REBUDYR,REBUDYR     CBDGET YEAR                                  
         XC    REOFF,REOFF         OFFICE                                       
*                                                                               
*        FIND STARTING VALUES FOR KEY FIELDS                                    
*                                                                               
         GOTO1 =A(BUDYRGET),DMCB,(C'N',REBUDYR) FIND FIRST YEAR                 
*                                                                               
         TM    REBTPC,X'40'        SKIP IF OFFICE LEVEL NOT WANTED              
         BNO   CBDINIT1                                                         
*                                                                               
         GOTO1 =A(OFFGET),DMCB,(C'N',REOFF)     FIND FIRST OFFICE               
*                                                                               
CBDINIT1 DS    0H                                                               
*                                                                               
*        FILL IN COMPANY BUDGET KEY                                             
*                                                                               
         MVI   RBUDKTYP,RBUDKTYQ   RECORD TYPE                                  
         MVC   RBUDKREP,REREP      REP                                          
         MVC   RBUDKYR,REBUDYR     CBDGET YEAR                                  
         MVC   RBUDKSTA,=C'C*MP '  STATION        (MAY BE NULLS)                
         MVC   RBUDKTEM,REOFF      OFFICE         (MAY BE NULLS)                
*                                                                               
         BRAS  RE,FIRSTHI          READ FIRST RECORD                            
*                                                                               
CBDLOOP  DS    0H                                                               
*                                                                               
*        CHECK FOR MAJOR CHANGES IN KEY                                         
*                                                                               
         LA    R4,KEY              RE-ESTABLISH KEY POINTER                     
*                                                                               
         CLC   RBUDKEY(RBUDKYR-RBUDKEY),KEYSAVE IF REP CHANGED                  
         JNE   CBDYR10             SAME AS CHANGE IN YEAR                       
*                                                                               
CBDYR    DS    0H                                                               
*                                                                               
         CLC   RBUDKYR,REBUDYR     IF YEAR CHANGED                              
         JNE   CBDYR10                                                          
*                                                                               
         CLC   RBUDKSTA,=C'C*MP '  OR END OF COMPANY RECORDS                    
         JNE   CBDYR10                                                          
*                                                                               
         TM    REBTPC,X'40'        OR OFFICE LEVEL NOT WANTED                   
         JO    CBDYROK                                                          
*                                                                               
         OC    RBUDKTEM,RBUDKTEM   AND OFFICE IN KEY                            
         JZ    CBDYROK                                                          
*                                                                               
CBDYR10  DS    0H                                                               
*                                                                               
         MVC   RBUDKEY,KEYSAVE     RESTORE SOUGHT KEY                           
*                                                                               
         GOTOR BUDYRGET,DMCB,(C'N',RBUDKYR)  FIND NEXT CBDGET YEAR              
         JNE   CBDDONE                     DONE IF NONE FOUND                   
*                                                                               
         XC    REOFF,REOFF            FORCE OFFICE LOOK UP                      
*                                                                               
         J     CBDKEY                                                           
*                                                                               
CBDYROK  DS    0H                                                               
*                                                                               
CBDOFF   DS    0H                                                               
*                                                                               
         CLC   RBUDKTEM,REOFF      IF OFFICE CHANGES                            
         JE    CBDOFFOK                                                         
*                                                                               
         TM    REBTPC,X'40'        IF OFFICE LEVEL NOT WANTED                   
         BO    CBDOFF10                                                         
*                                                                               
         CLC   RBUDKTEM,RESPACES      IF NO OFFICE IN KEY                       
         BH    *+14                                                             
         XC    REOFF,REOFF               OKAY                                   
         B     CBDOFFOK                                                         
*                                                                               
CBDOFF10 DS    0H                                                               
*                                                                               
         GOTO1 =A(OFFGET),DMCB,(C'G',RBUDKTEM)  FIND NEXT OFFICE                
*                                                                               
         CLC   REOFF,RBUDKTEM      IF DEFAULT USED                              
         JE    CBDOFFOK               OKAY                                      
*                                                                               
         TM    REBTPC,X'40'        IF OFFICE LEVEL NOT WANTED                   
         BNO   CBDOFFOK               OKAY                                      
*                                                                               
         J     CBDKEY                                                           
*                                                                               
CBDOFFOK DS    0H                                                               
*                                                                               
*        CHECK IF CURRENT KEY IS ACCEPTABLE                                     
*              ANY BREAK IN KEY FORCES A SKIP READ                              
*                                                                               
CBDKEY   DS    0H                                                               
*                                                                               
         CLC   RBUDKYR,REBUDYR     YEAR                                         
         JNE   CBDCNSKP                                                         
*                                                                               
         CLC   RBUDKSTA,=C'C*MP '  COMPANY ID                                   
         JNE   CBDCNSKP                                                         
*                                                                               
         TM    REBTPC,X'40'        IF OFFICE LEVEL NOT WANTED                   
         BNO   CBDKEYOK               OKAY                                      
*                                                                               
         CLC   RBUDKTEM,REOFF      OFFICE                                       
         JNE   CBDCNSKP                                                         
*                                                                               
CBDKEYOK DS    0H                                                               
*                                                                               
         TM    RBUDKEY+27,X'80'    SKIP DELETED RECORDS                         
         JO    CBDCONT                                                          
*                                                                               
         BRAS  RE,GETREC           READ CBDGET RECORD                           
         JNZ   CBDCONT             SKIP DELETED RECORDS                         
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
         USING RBUDREC,R4          ESTABLISH RECORD                             
*                                                                               
         XC    RECTY,RECTY         INIT CONTRACT TYPE                           
*                                                                               
         MVI   ELCODE,X'01'        FIND STATION BUDGET ELEMENT                  
         LR    R6,R4               START OF RECORD                              
         BRAS  RE,GETEL                                                         
         JNE   CBDSTAX             ELEMENT NOT FOUND                            
*                                                                               
         CLI   REBTPC,0            OKAY IF ALL BUDGET TYPES WANTED              
         BE    *+12                                                             
         TM    REBTPC,X'20'        IF CTY NOT WANTED                            
         BO    CBDSTAX                                                          
*                                                                               
         USING RBUDELEM,R6            ESTABLISH STATION ELEMENT                 
*                                                                               
         BRAS  RE,BUDPOST             POST COMPANY BUDGET                       
*                                                                               
         BRAS  RE,BUDHOOK             HOOK TO DRIVER                            
*                                                                               
CBDSTAX  DS    0H                                                               
*                                                                               
         CLI   RBUDCNTR,0          SKIP IF NO CTY ELEMENTS                      
         JE    CBDCTPX                                                          
*                                                                               
         CLI   REBTPC,0            OKAY IF ALL CBDGET TYPES WANTED              
         BE    *+12                                                             
         TM    REBTPC,X'20'        SKIP IF CTP NOT WANTED                       
         BNO   CBDCTPX                                                          
*                                                                               
CBDCTP   DS    0H                  LOOP THRU CONTRACT TYPES                     
*                                                                               
         MVI   ELCODE,X'02'        LOOK FOR CONTRACT TYPE ELEMENT               
         LR    R6,R4                                                            
         BRAS  RE,GETEL                                                         
*                                                                               
CBDCTPLP DS    0H                                                               
*                                                                               
         JNE   CBDCTPDN            NO MORE ELEMENTS IN RECORD                   
*                                                                               
         GOTO1 =A(CTYGET),DMCB,(C'G',RBUDTYPE)  VALIDATE CONTRACT TYPE          
         JNE   CBDCTPCN            NOT WANTED FOR REPORT                        
*                                                                               
         BRAS  RE,BUDPOST          POST ELEMENT                                 
*                                                                               
         BRAS  RE,BUDHOOK          HOOK TO DRIVER                               
*                                                                               
CBDCTPCN DS    0H                                                               
*                                                                               
         BRAS  RE,NEXTEL           GET NEXT ELEMENT                             
         J     CBDCTPLP                                                         
*                                                                               
CBDCTPDN DS    0H                                                               
*                                                                               
CBDCTPX  DS    0H                                                               
*                                                                               
CBDCONT  DS    0H                                                               
*                                                                               
         MVC   KEYSAVE,RBUDKEY     UPDATE STARTING KEY                          
*                                                                               
         BRAS  RE,SEQ                                                           
*                                                                               
         J     CBDLOOP             GET NEXT RECORD                              
*                                                                               
CBDCNSKP DS    0H                                                               
*                                                                               
*        RE-BUILD SEARCH KEY                                                    
*                                                                               
         MVI   RBUDKTYP,RBUDKTYQ   RECORD TYPE                                  
         MVC   RBUDKREP,REREP      REP                                          
*                                                                               
         MVC   RBUDKYR,REBUDYR     BUDGET YEAR    (MAY BE NULLS)                
         MVC   RBUDKSTA,=C'C*MP '  COMPANY                                      
         MVC   RBUDKTEM,REOFF      OFFICE         (MAY BE NULLS)                
*                                                                               
         BRAS  RE,HIGH             SKIP READ                                    
         J     CBDLOOP             GET NEXT RECORD                              
*                                                                               
CBDDONE  DS    0H                                                               
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE -BREPCONT'                        
***********************************************************************         
*                                                                     *         
*        FIND NEXT REP                                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
CBRPCONT DS    0H                                                               
*                                                                               
         ICM   R2,15,REREPTBA      SKIP IF NO REP TABLE                         
         JZ    CBRPDONE                                                         
*                                                                               
         USING REPTTABD,R2         ESTABLISH REP TABLE                          
*                                                                               
         ICM   R3,15,REPTENTA      POINT TO CURRENT TABLE ENTRY                 
         JZ    CBRPDONE                                                         
*                                                                               
         USING REPTENT,R3          ESTABLISH TABLE ENTRY                        
*                                                                               
         A     R3,BSPLENR-BSPPRMS+REPTBSRP BUMP TO NEXT ENTRY                   
*                                                                               
         J     CBRPLOOP                                                         
*                                                                               
CBRPDONE DS    0H                                                               
*                                                                               
         XC    REPTENTA,REPTENTA   INDICATE END OF TABLE REACHED                
         MVC   REREPTA,REPTENTA                                                 
*                                                                               
CBRPREPX DS    0H                                                               
*                                                                               
CBDX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE -OBD'                             
***********************************************************************         
*                                                                     *         
*        READ OFFICE BUDGET RECORDS                                   *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
OBD      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
*        FIND FIRST REP                                                         
*                                                                               
         L     RF,REAIO3           CLEAR EVIDENCE OF STATION RECORD             
         XC    0(L'RSTAKEY,RF),0(RF)                                            
*                                                                               
         ICM   R2,15,REREPTBA      SKIP IF NO REP TABLE                         
         JZ    OBRPREPX                                                         
*                                                                               
         USING REPTTABD,R2         ESTABLISH REP TABLE                          
*                                                                               
         ICM   R3,15,BSPATAB-BSPPRMS+REPTBSRP  1ST ENTRY IN TABLE               
         JZ    OBRPREPX             NO TABLE                                    
*                                                                               
         USING REPTENT,R3          ESTABLISH REP TABLE ENTRY                    
*                                                                               
OBRPLOOP DS    0H                  PROCESS BUDGET RECS FOR A REP                
*                                                                               
         OC    REPTENT(REPTENTL),REPTENT  TEST FOR END OF TABLE                 
         JZ    OBRPDONE                                                         
*                                                                               
         ST    R3,REPTENTA         SET CURRENT TABLE ENTRY ADDRESS              
*                                                                               
         TM    REPTKEY+27,X'80'    SKIP IF DELETED                              
         BO    OBRPCONT                                                         
*                                                                               
         MVC   REREPTA,REPTENTA    RETURN A(GROUP TABLE ENTRY)                  
*                                                                               
         MVC   REREP,RREPKREP-RREPKEY+REPTKEY   RETURN REP                      
         MVC   RESE,REPTSE         RETURN SE CODE                               
*                                                                               
         ICM   RF,15,REUTLA        POINT TO UTL                                 
         JZ    *+18                SKIP IF NOT AVAILABLE                        
         CLI   REPTSE,0            SKIP IF NOT AVAILABLE                        
         JE    *+10                                                             
         MVC   4(1,RF),REPTSE      SET SE NUMBER                                
*                                                                               
         XC    REMREP,REMREP       INIT MARTER REP                              
*                                                                               
         LA    R4,REPTELM          ESTABLISH REP DECRIPTION ELEMENT             
         USING RREPELEM,R4                                                      
*                                                                               
         CLC   =C'NU',REREP        SPECIAL FOR REP 'NU'                         
         BNE   *+14                                                             
         MVC   REMREP,=C'K3'                                                    
         B     OBRPMRPX                                                         
*                                                                               
         CLC   RREPMAST,=CL4' '    SKIP IF NO MASTER REP                        
         BE    OBRPMRPX                                                         
*                                                                               
         OC    RREPMAST,RREPMAST   SKIP IF NO MASTER REP                        
         BZ    OBRPMRPX                                                         
*                                                                               
         CLC   RREPMAST,=4X'FF'    IF MASTER REP                                
         BNE   *+14                                                             
         MVC   REMREP,REREP           SAVE CURRENT REP AS MASETER REP           
         B     OBRPMRPX                                                         
*                                                                               
         MVC   REMREP,RREPMAST     ELSE SAVE MASTER REP                         
*                                                                               
OBRPMRPX DS    0H                                                               
*                                                                               
         BRAS  RE,TABS             LOAD REP'S TABLES                            
*                                                                               
******   BRAS  RE,STA              LOAD REP'S STATIONS TO TABLE                 
*                                                                               
***********************************************************************         
*                                                                     *         
*        READ OFFICE BUDGET RECORDS FOR REP                           *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING ROBDKEY,R4          ESTABLISH BUDGET BASE KEY                    
*                                                                               
*        INIT CURRENT VALUES OF ALL KEY FIELDS                                  
*                                                                               
         XC    REBUDYR,REBUDYR     BUDGET YEAR                                  
         XC    REOFF,REOFF         OFFICE                                       
         XC    RETEM,RETEM         TEAM                                         
         XC    REGRS,REGRS         GROUP/SUBGROUP                               
*                                                                               
*        FIND STARTING VALUES FOR KEY FIELDS                                    
*                                                                               
         GOTO1 =A(BUDYRGET),DMCB,(C'N',REBUDYR) FIND FIRST YEAR                 
         GOTO1 =A(OFFGET),DMCB,(C'N',REOFF)     FIND FIRST OFFICE               
*                                                                               
         TM    REBTPO,X'40'        SKIP IF TEAM LEVEL NOT WANTED                
         JNO   OBDINIT1                                                         
*                                                                               
         GOTO1 =A(TEMGET),DMCB,(C'N',RETEM)     FIND FIRST TEAM                 
*                                                                               
OBDINIT1 DS    0H                                                               
*                                                                               
         TM    REBTPO,X'20'        SKIP IF GRP LEVEL NOT WANTED                 
         JNO   OBDINIT2                                                         
*                                                                               
         GOTO1 =A(GRPGET),DMCB,(C'N',REGRS)     FIND FIRST GROUP                
*                                                                               
OBDINIT2 DS    0H                                                               
*                                                                               
*        FILL IN OFFICE BUDGET KEY                                              
*                                                                               
         MVI   ROBDKTYP,ROBDKTYQ   RECORD TYPE                                  
         MVC   ROBDKREP,REREP      REP                                          
         MVC   ROBDKYR,REBUDYR     BUDGET YEAR                                  
         MVC   ROBDKOFF,REOFF      OFFICE         (MAY BE NULLS)                
         MVC   ROBDKTM,RETEM       TEAM           (MAY BE NULLS)                
         MVC   ROBDKSUB,REGRS      GROUP/SUBGROUP (MAY BE NULLS)                
*                                                                               
         BRAS  RE,FIRSTHI          READ FIRST RECORD                            
*                                                                               
OBDLOOP  DS    0H                                                               
*                                                                               
*        CHECK FOR MAJOR CHANGES IN KEY                                         
*                                                                               
         LA    R4,KEY              RE-ESTABLISH KEY POINTER                     
*                                                                               
         CLC   ROBDKEY(ROBDKYR-ROBDKEY),KEYSAVE IF REP CHANGED                  
         JNE   OBDYR10             SAME AS YEAR CHANGE                          
*                                                                               
OBDYR    DS    0H                                                               
*                                                                               
         CLC   ROBDKYR,REBUDYR     IF YEAR CHANGED                              
         JE    OBDYROK                                                          
*                                                                               
OBDYR10  DS    0H                                                               
*                                                                               
         MVC   ROBDKEY,KEYSAVE     RESTORE SOUGHT KEY                           
*                                                                               
         GOTOR BUDYRGET,DMCB,(C'N',ROBDKYR)  FIND NEXT BUDGET YEAR              
         JNE   OBDDONE                     DONE IF NONE FOUND                   
*                                                                               
         XC    REOFF,REOFF               OFFICE                                 
         XC    RETEM,RETEM               TEAM                                   
         XC    REGRS,REGRS               GROUP/SUBGROUP                         
*                                                                               
         J     OBDKEY                                                           
*                                                                               
OBDYROK  DS    0H                                                               
*                                                                               
OBDOFF   DS    0H                                                               
*                                                                               
         CLC   ROBDKOFF,REOFF      IF OFFICE CHANGES                            
         JE    OBDOFFOK                                                         
*                                                                               
         GOTO1 =A(OFFGET),DMCB,(C'G',ROBDKOFF)     FIND NEXT OFFICE             
*                                                                               
         CLC   REOFF,ROBDKOFF      IF DEFAULT NOT USED                          
         JE    OBDOFFOK                                                         
*                                                                               
         XC    RETEM,RETEM            FORCE TEAM LOOK UP                        
         XC    REGRS,REGRS            FORCE SUBGROUP LOOK UP                    
*                                                                               
         J     OBDKEY                                                           
*                                                                               
OBDOFFOK DS    0H                                                               
*                                                                               
OBDTEM   DS    0H                                                               
*                                                                               
         CLC   ROBDKTM,RETEM       IF TEAM CHANGES                              
         JE    OBDTEMOK                                                         
*                                                                               
         TM    REBTPO,X'40'        IF TEAM LEVEL NOT WANTED                     
         JO    OBDTEM10                                                         
*                                                                               
         CLC   ROBDKTM,RESPACES       IF NO TEAM IN KEY                         
         JH    *+14                                                             
         XC    RETEM,RETEM               OKAY                                   
         J     OBDTEMOK                                                         
*                                                                               
OBDTEM10 DS    0H                                                               
*                                                                               
         GOTO1 =A(TEMGET),DMCB,(C'G',ROBDKTM)  FIND NEXT TEAM                   
*                                                                               
         CLC   RETEM,ROBDKTM       IF DEFAULT USED                              
         JE    OBDTEMOK               OKAY                                      
*                                                                               
         TM    REBTPO,X'40'        IF TEAM LEVEL NOT WANTED                     
         BNO   OBDTEMOK               OKAY                                      
*                                                                               
         XC    REGRS,REGRS            FORCE SUBGROUP LOOK UP                    
*                                                                               
         J     OBDKEY                                                           
*                                                                               
OBDTEMOK DS    0H                                                               
*                                                                               
OBDGRP   DS    0H                                                               
*                                                                               
         CLC   ROBDKSUB,REGRP      IF SUBGROUP CHANGES                          
         JE    OBDGRPOK                                                         
*                                                                               
         TM    REBTPO,X'20'        IF SUBGROUP LEVEL NOT WANTED                 
         BO    OBDGRP10                                                         
*                                                                               
         CLC   ROBDKSUB,RESPACES      IF NO SUBGROUP IN KEY                     
         BH    *+14                                                             
         XC    REGRS,REGRS               OKAY                                   
         B     OBDGRPOK                                                         
*                                                                               
OBDGRP10 DS    0H                                                               
*                                                                               
         GOTO1 =A(GRPGET),DMCB,(C'G',ROBDKSUB)  FIND NEXT SUBGROUP              
*                                                                               
         CLC   REGRS,ROBDKSUB      IF DEFAULT USED                              
         JE    OBDGRPOK               OKAY                                      
*                                                                               
         TM    REBTPO,X'20'        IF SUBGROUP LEVEL NOT WANTED                 
         JNO   OBDGRPOK               OKAY                                      
*                                                                               
         J     OBDKEY                                                           
*                                                                               
OBDGRPOK DS    0H                                                               
*                                                                               
*        CHECK IF CURRENT KEY IS ACCEPTABLE                                     
*              ANY BREAK IN KEY FORCES A SKIP READ                              
*                                                                               
OBDKEY   DS    0H                                                               
*                                                                               
         CLC   ROBDKYR,REBUDYR     YEAR                                         
         JNE   OBDCNSKP                                                         
         CLC   ROBDKOFF,REOFF      OFFICE                                       
         JNE   OBDCNSKP                                                         
*                                                                               
         TM    REBTPO,X'40'        IF TEAM LEVEL NOT WANTED                     
         JNO   OBDKEY10               OKAY                                      
*                                                                               
         CLC   ROBDKTM,RETEM       TEAM                                         
         JNE   OBDCNSKP                                                         
*                                                                               
OBDKEY10 DS    0H                                                               
*                                                                               
         TM    REBTPO,X'20'        IF SUBGROUP LEVEL NOT WANTED                 
         JNO   OBDKEYOK               OKAY                                      
*                                                                               
         CLC   ROBDKSUB,REGRS         SUBGROUP                                  
         JNE   OBDCNSKP                                                         
*                                                                               
OBDKEYOK DS    0H                                                               
*                                                                               
         TM    ROBDKEY+27,X'80'    SKIP DELETED RECORDS                         
         JO    OBDCONT                                                          
*                                                                               
         BRAS  RE,GETREC           READ BUDGET RECORD                           
         JNZ   OBDCONT             SKIP DELETED RECORDS                         
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
         USING ROBDREC,R4          ESTABLISH RECORD                             
*                                                                               
         MVI   ELCODE,X'01'        FIND OFFICE BUDGET ELEMENT                   
         LR    R6,R4               START OF RECORD                              
         BRAS  RE,GETEL                                                         
         JNE   OBDOFFX             ELEMENT NOT FOUND                            
*                                                                               
         USING ROBDELEM,R6            ESTABLISH BUDGET ELEMENT                  
*                                                                               
         BRAS  RE,BUDPOST             POST BUDGET                               
*                                                                               
         BRAS  RE,BUDHOOK             HOOK TO DRIVER                            
*                                                                               
OBDOFFX  DS    0H                                                               
*                                                                               
OBDCONT  DS    0H                                                               
*                                                                               
         MVC   KEYSAVE,KEY         UPDATE STARTING KEY                          
*                                                                               
         BRAS  RE,SEQ                                                           
*                                                                               
         J     OBDLOOP             GET NEXT RECORD                              
*                                                                               
OBDCNSKP DS    0H                                                               
*                                                                               
*        RE-BUILD SEARCH KEY                                                    
*                                                                               
         MVI   ROBDKTYP,ROBDKTYQ   RECORD TYPE                                  
         MVC   ROBDKREP,REREP      REP                                          
*                                                                               
         MVC   ROBDKYR,REBUDYR     BUDGET YEAR    (MAY BE NULLS)                
         MVC   ROBDKOFF,REOFF      OFFICE         (MAY BE NULLS)                
         MVC   ROBDKTM,RETEM       TEAM           (MAY BE NULLS)                
         MVC   ROBDKSUB,REGRS      SUBGROUP       (MAY BE NULLS)                
*                                                                               
         BRAS  RE,HIGH             SKIP READ                                    
*                                                                               
         J     OBDLOOP             GET NEXT RECORD                              
*                                                                               
OBDDONE  DS    0H                                                               
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE -OBRPCONT'                        
***********************************************************************         
*                                                                     *         
*        FIND NEXT REP                                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
OBRPCONT DS    0H                                                               
*                                                                               
         ICM   R2,15,REREPTBA      SKIP IF NO REP TABLE                         
         JZ    OBRPDONE                                                         
*                                                                               
         USING REPTTABD,R2         ESTABLISH REP TABLE                          
*                                                                               
         ICM   R3,15,REPTENTA      POINT TO CURRENT TABLE ENTRY                 
         JZ    OBRPDONE                                                         
*                                                                               
         USING REPTENT,R3          ESTABLISH TABLE ENTRY                        
*                                                                               
         A     R3,BSPLENR-BSPPRMS+REPTBSRP BUMP TO NEXT ENTRY                   
*                                                                               
         J     OBRPLOOP                                                         
*                                                                               
OBRPDONE DS    0H                                                               
*                                                                               
         XC    REPTENTA,REPTENTA   INDICATE END OF TABLE REACHED                
         MVC   REREPTA,REPTENTA                                                 
*                                                                               
OBRPREPX DS    0H                                                               
*                                                                               
OBDX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE -BSP'                             
***********************************************************************         
*                                                                     *         
*        READ SALESPERSON BUDGET RECORDS                              *         
*              HANDLES BOTH WITH AND WITHOUT STATION IN KEY           *         
*                                                                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
BSP      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
*        FIND FIRST REP                                                         
*                                                                               
         ICM   R2,15,REREPTBA      SKIP IF NO REP TABLE                         
         JZ    BSPRREPX                                                         
*                                                                               
         USING REPTTABD,R2         ESTABLISH REP TABLE                          
*                                                                               
         ICM   R3,15,BSPATAB-BSPPRMS+REPTBSRP  1ST ENTRY IN TABLE               
         JZ    BSPRREPX             NO TABLE                                    
*                                                                               
         USING REPTENT,R3          ESTABLISH REP TABLE ENTRY                    
*                                                                               
BSPRLOOP DS    0H                  PROCESS SAL BUDGET RECS FOR A REP            
*                                                                               
         OC    REPTENT(REPTENTL),REPTENT  TEST FOR END OF TABLE                 
         JZ    BSPRDONE                                                         
*                                                                               
         ST    R3,REPTENTA         SET CURRENT TABLE ENTRY ADDRESS              
*                                                                               
         TM    REPTKEY+27,X'80'    SKIP IF DELETED                              
         BO    BSPRCONT                                                         
*                                                                               
         MVC   REREPTA,REPTENTA    RETURN A(REP TABLE ENTRY)                    
*                                                                               
         MVC   REREP,RREPKREP-RREPKEY+REPTKEY   RETURN REP                      
         MVC   RESE,REPTSE         RETURN SE CODE                               
*                                                                               
         ICM   RF,15,REUTLA        POINT TO UTL                                 
         JZ    *+18                SKIP IF NOT AVAILABLE                        
         CLI   REPTSE,0            SKIP IF NOT AVAILABLE                        
         JE    *+10                                                             
         MVC   4(1,RF),REPTSE      SET SE NUMBER                                
*                                                                               
         XC    REMREP,REMREP       INIT MASTER REP                              
*                                                                               
         LA    R4,REPTELM          ESTABLISH REP DESCRIPTION ELEMENT            
         USING RREPELEM,R4                                                      
*                                                                               
         CLC   =C'NU',REREP        SPECIAL FOR REP 'NU'                         
         BNE   *+14                                                             
         MVC   REMREP,=C'K3'                                                    
         B     BSPRMRPX                                                         
*                                                                               
         CLC   RREPMAST,=CL4' '    SKIP IF NO MASTER REP                        
         BE    BSPRMRPX                                                         
*                                                                               
         OC    RREPMAST,RREPMAST   SKIP IF NO MASTER REP                        
         BZ    BSPRMRPX                                                         
*                                                                               
         CLC   RREPMAST,=4X'FF'    IF MASTER REP                                
         BNE   *+14                                                             
         MVC   REMREP,REREP           SAVE CURRENT REP AS MASTER REP            
         B     BSPRMRPX                                                         
*                                                                               
         MVC   REMREP,RREPMAST     ELSE SAVE MASTER REP                         
*                                                                               
BSPRMRPX DS    0H                                                               
*                                                                               
         BRAS  RE,TABS             LOAD REP'S TABLES                            
*                                                                               
         BRAS  RE,STA              LOAD REP'S STATIONS TO FILE                  
*                                                                               
         L     RF,REAIO3           CLEAR EVIDENCE OF STATION RECORD             
         XC    0(256,RF),0(RF)                                                  
*                                                                               
***********************************************************************         
*                                                                     *         
*        READ SAL    BUDGET RECORDS FOR REP                           *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING RSBDKEY,R4          ESTABLISH BUDGET BASE KEY                    
*                                                                               
*        INIT CURRENT VALUES OF ALL KEY FIELDS                                  
*                                                                               
         XC    REBUDYR,REBUDYR     BUDGET YEAR                                  
         XC    REGRS,REGRS         GROUP                                        
         XC    RESTA,RESTA         STATION                                      
         XC    RESAL,RESAL         SALESPERSON                                  
         XC    REDCT,REDCT         DEVELOPMENTAL CONTRACT TYPE                  
*                                                                               
*        FIND STARTING VALUES FOR KEY FIELDS                                    
*                                                                               
         GOTOR BUDYRGET,DMCB,(C'N',REBUDYR) FIND FIRST YEAR                     
*                                                                               
         CLI   REREAD,RBSSKTYQ     IF STATION/SALESPERSON BUDGET                
         BNE   BSPRINI0                                                         
*                                                                               
         GOTOR GRPGET,DMCB,(C'N',REGRP) FIND FIRST GROUP                        
         GOTOR STAGET,DMCB,(C'N',RESTA) FIND FIRST STATION                      
*                                                                               
         L     R6,REAIO3           ESTABLISH STATION RECORD                     
         USING RSTAKEY,R6                                                       
*                                                                               
         CLI   RSTAKTYP,RSTAKTYQ   SKIP IF STATION REC NOT IN CORE              
         BNE   BSPRINI0                                                         
*                                                                               
         GOTOR GRPGET,DMCB,(C'G',RSTAGRUP) FIND STATION'S GROUP                 
*                                                                               
         DROP  R6                                                               
*                                                                               
BSPRINI0 DS    0H                                                               
*                                                                               
         L     R9,=A(STDPSAL)      POINT TO TABLE PARAMETERES                   
*                                                                               
         GOTOR SALGET,DMCB,(C'N',RESAL)     FIND FIRST SALESPERSON              
*                                                                               
         LA    R1,REBTPSP          DEFAULT TO SALESPERSON BUDGET                
         CLI   REREAD,RBSSKTYQ     TEST FOR STATION/SAL BUDGET                  
         BNE   *+8                                                              
         LA    R1,REBTPSS                                                       
*                                                                               
         TM    0(R1),X'40'         SKIP IF DCT LEVEL NOT WANTED                 
         BNO   BSPINIT1                                                         
*                                                                               
         L     R9,=A(STDPDCT)      POINT TO TABLE PARAMETERES                   
*                                                                               
         GOTOR DCTGET,DMCB,(C'N',REDCT)     FIND FIRST DCT CONTRACT TYP         
*                                                                               
BSPINIT1 DS    0H                                                               
*                                                                               
*        FILL IN SALESPERSON'S BUDGET KEY                                       
*                                                                               
         MVI   RSBDKTYP,X'15'      RECORD TYPE                                  
         MVC   RSBDKTYP+1(1),REREAD                                             
         NI    RSBDKTYP+1,X'0F'    KILL HIGH NYBBLE FOR CORRECT ID              
         MVC   RSBDKREP,REREP      REP                                          
         MVC   RSBDKYR,REBUDYR     BUDGET YEAR                                  
         MVC   RSBDKSTA,RESTA      STATION               (MAY BE NULLS)         
         MVC   RSBDKSAL,RESAL      SALESPERSON                                  
         MVC   RSBDKDCT,REDCT      DEVELOP/CONTRACT TYPE (MAY BE NULLS)         
*                                                                               
         BRAS  RE,FIRSTHI          READ FIRST RECORD                            
*                                                                               
BSPLOOP  DS    0H                                                               
*                                                                               
*        CHECK FOR MAJOR CHANGES IN KEY                                         
*                                                                               
         LA    R4,KEY              RE-ESTABLISH KEY POINTER                     
*                                                                               
         CLC   RSBDKEY(RSBDKYR-RSBDKEY),KEYSAVE IF REP CHANGED                  
         BNE   BSPYR10             SAME AS YEAR CHANGE                          
*                                                                               
BSPYR    DS    0H                                                               
*                                                                               
         CLC   RSBDKYR,REBUDYR     IF YEAR CHANGED                              
         BE    BSPYROK                                                          
*                                                                               
BSPYR10  DS    0H                                                               
*                                                                               
         MVC   RSBDKEY,KEYSAVE        RESTORE SOUGHT KEY                        
*                                                                               
         GOTOR BUDYRGET,DMCB,(C'N',RSBDKYR)  FIND NEXT BUDGET YEAR              
         BNE   BSPDONE                     DONE IF NONE FOUND                   
*                                                                               
         XC    RESTA,RESTA               STATION                                
         XC    RESAL,RESAL               SALESPERSON                            
         XC    REDCT,REDCT               DCT                                    
*                                                                               
         B     BSPKEY                                                           
*                                                                               
BSPYROK  DS    0H                                                               
*                                                                               
BSPSTA   DS    0H                                                               
*                                                                               
         CLI   REREAD,RBSSKTYQ     IF STATION/SAL BUDGET                        
         BNE   BSPSTAOK                                                         
*                                                                               
         CLC   RSBDKSTA,RESTA      IF STATION CHANGES                           
         BE    BSPSTAOK                                                         
*                                                                               
         XC    REGRS,REGRS         NO FILTERING ON GROUP                        
*                                                                               
         GOTOR STAGET,DMCB,(C'G',RSBDKSTA)     FIND NEXT STATION                
*                                                                               
         L     R6,REAIO3           ESTABLISH STATION RECORD                     
         USING RSTAKEY,R6                                                       
*                                                                               
         CLI   RSTAKTYP,RSTAKTYQ   SKIP IF STATION REC NOT IN CORE              
         BNE   BSPSTA10                                                         
*                                                                               
         GOTO1 =A(GRPGET),DMCB,(C'G',RSTAGRUP) FIND STATION'S GROUP             
*                                                                               
         CLC   REGRS,RSTAGRUP      OKAY IF STATION'S GROUP USED                 
         BE    BSPSTA10                                                         
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,RESTA+4        FORCE NEXT STATION                           
         LA    RF,1(RF)                                                         
         STC   RF,RESTA+4                                                       
*                                                                               
         B     BSPCNSKP                                                         
*                                                                               
         DROP  R6                                                               
*                                                                               
BSPSTA10 DS    0H                                                               
*                                                                               
         CLC   RESTA,RSBDKSTA      IF DEFAULT NOT USED                          
         BE    BSPSTAOK                                                         
*                                                                               
         XC    RESAL,RESAL            FORCE SAL LOOK UP                         
         XC    REDCT,REDCT            FORCE DCT LOOK UP                         
*                                                                               
         B     BSPKEY                                                           
*                                                                               
BSPSTAOK DS    0H                                                               
*                                                                               
BSPSAL   DS    0H                                                               
*                                                                               
         CLC   RSBDKSAL,RESAL      IF SAL CHANGES                               
         BE    BSPSALOK                                                         
*                                                                               
         L     R9,=A(STDPSAL)      POINT TO TABLE PARAMETERES                   
*                                                                               
         GOTOR SALGET,DMCB,(C'G',RSBDKSAL)     FIND NEXT SAL                    
*                                                                               
         CLC   RESAL,RSBDKSAL      IF DEFAULT NOT USED                          
         BE    BSPSALOK                                                         
*                                                                               
         XC    REDCT,REDCT            FORCE DCT LOOK UP                         
*                                                                               
         B     BSPKEY                                                           
*                                                                               
BSPSALOK DS    0H                                                               
*                                                                               
BSPDCT   DS    0H                                                               
*                                                                               
         CLC   RSBDKDCT,REDCT      IF DCT CHANGES                               
         BE    BSPDCTOK                                                         
*                                                                               
         TM    REBTPSP,X'40'       IF DCT LEVEL NOT WANTED                      
         BO    BSPDCT10                                                         
*                                                                               
         CLC   RSBDKDCT,RESPACES       IF NO DCT IN KEY                         
         BH    *+14                                                             
         XC    REDCT,REDCT                OKAY                                  
         B     BSPDCTOK                                                         
*                                                                               
BSPDCT10 DS    0H                                                               
*                                                                               
         L     R9,=A(STDPDCT)      POINT TO TABLE PARAMETERES                   
*                                                                               
         GOTOR DCTGET,DMCB,(C'G',RSBDKDCT)  FIND NEXT DCT                       
*                                                                               
         CLC   REDCT,RSBDKDCT      IF DEFAULT USED                              
         BE    BSPDCTOK               OKAY                                      
*                                                                               
         TM    REBTPSP,X'40'       IF DCT LEVEL NOT WANTED                      
         BNO   BSPDCTOK               OKAY                                      
*                                                                               
         B     BSPKEY                                                           
*                                                                               
BSPDCTOK DS    0H                                                               
*                                                                               
*        CHECK IF CURRENT KEY IS ACCEPTABLE                                     
*              ANY BREAK IN KEY FORCES A SKIP READ                              
*                                                                               
BSPKEY   DS    0H                                                               
*                                                                               
         CLC   RSBDKYR,REBUDYR     YEAR                                         
         BNE   BSPCNSKP                                                         
         CLC   RSBDKSTA,RESTA      STATION                                      
         BNE   BSPCNSKP                                                         
         CLC   RSBDKSAL,RESAL      SALESPERSON                                  
         BNE   BSPCNSKP                                                         
*                                                                               
         TM    REBTPSP,X'40'       IF DCT LEVEL NOT WANTED                      
         BNO   BSPKEY10               OKAY                                      
*                                                                               
         CLC   RSBD5DCT,REDCT        DCT                                        
         BNE   BSPCNSKP                                                         
*                                                                               
BSPKEY10 DS    0H                                                               
*                                                                               
BSPKEYOK DS    0H                                                               
*                                                                               
         TM    RSBDKEY+27,X'80'    SKIP DELETED RECORDS                         
         BO    BSPCONT                                                          
*                                                                               
         BRAS  RE,GETREC           READ BUDGET RECORD                           
         BNZ   BSPCONT             SKIP DELETED RECORDS                         
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
         USING RSBDREC,R4          ESTABLISH RECORD                             
*                                                                               
         MVI   ELCODE,X'02'        FIND MAIN BUDGET ELEMENT                     
         LR    R6,R4               START OF RECORD                              
         BRAS  RE,GETEL                                                         
*                                                                               
BSPBUDLP DS    0H                                                               
*                                                                               
         BNE   BSPBUDDN            ELEMENT NOT FOUND                            
*                                                                               
         USING RSBDELEM,R6            ESTABLISH BUDGET ELEMENT                  
*                                                                               
         BRAS  RE,BUDPOST             POST BUDGET                               
*                                                                               
         BRAS  RE,BUDHOOK             HOOK TO DRIVER                            
*                                                                               
BSPBUDCN DS    0H                                                               
*                                                                               
         BRAS  RE,NEXTEL                                                        
         B     BSPBUDLP                                                         
*                                                                               
BSPBUDDN DS    0H                                                               
*                                                                               
BSPCONT  DS    0H                                                               
*                                                                               
         MVC   KEYSAVE,KEY         UPDATE STARTING KEY                          
*                                                                               
         BRAS  RE,SEQ                                                           
*                                                                               
         B     BSPLOOP             GET NEXT RECORD                              
*                                                                               
BSPCNSKP DS    0H                                                               
*                                                                               
*        RE-BUILD SEARCH KEY                                                    
*                                                                               
         MVI   RSBDKTYP,X'15'      RECORD TYPE                                  
         MVC   RSBDKTYP+1(1),REREAD                                             
         NI    RSBDKTYP+1,X'0F'    KILL HIGH NYBBLE FOR CORRECT ID              
*                                                                               
         MVC   RSBDKREP,REREP      REP                                          
*                                                                               
         MVC   RSBDKYR,REBUDYR     BUDGET YEAR    (MAY BE NULLS)                
         MVC   RSBDKSTA,RESTA      STATION        (MAY BE NULLS)                
         MVC   RSBDKSAL,RESAL      SALESPERSON                                  
         MVC   RSBDKDCT,REDCT      DCT            (MAY BE NULLS)                
*                                                                               
         BRAS  RE,HIGH             SKIP READ                                    
*                                                                               
         B     BSPLOOP             GET NEXT RECORD                              
*                                                                               
BSPDONE  DS    0H                                                               
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE -BSPRCONT'                        
***********************************************************************         
*                                                                     *         
*        FIND NEXT REP                                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
BSPRCONT DS    0H                                                               
*                                                                               
         ICM   R2,15,REREPTBA      SKIP IF NO REP TABLE                         
         BZ    BSPRDONE                                                         
*                                                                               
         USING REPTTABD,R2         ESTABLISH REP TABLE                          
*                                                                               
         ICM   R3,15,REPTENTA      POINT TO CURRENT TABLE ENTRY                 
         BZ    BSPRDONE                                                         
*                                                                               
         USING REPTENT,R3          ESTABLISH TABLE ENTRY                        
*                                                                               
         A     R3,BSPLENR-BSPPRMS+REPTBSRP BUMP TO NEXT ENTRY                   
*                                                                               
         B     BSPRLOOP                                                         
*                                                                               
BSPRDONE DS    0H                                                               
*                                                                               
         XC    REPTENTA,REPTENTA   INDICATE END OF TABLE REACHED                
         MVC   REREPTA,REPTENTA                                                 
*                                                                               
BSPRREPX DS    0H                                                               
*                                                                               
BSPX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - BUDHOOK'                        
***********************************************************************         
*                                                                     *         
*        HOOK TO DRIVER                                               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
BUDHOOK  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         LA    R2,REYMSTRP         DEFAULT TO WHOLE PERIOD                      
         LA    R0,1                DEFAULT TO 1 TIME TO DRIVER                  
*                                                                               
         TM    RECNTRL,RECDLSTQ    IF DATE LIST PROCESSING                      
         JNO   BUDHOOK1                                                         
*                                                                               
         L     R5,REDLSTA             POINT TO DATE LISTS                       
         USING DATELSTD,R5            ESTABLISH DATELISTS                       
*                                                                               
         CLI   REQDTYPE,C'W'       IF WEEKS                                     
         JNE   *+16                                                             
         LA    R2,WEEKLSTB            USE BINARY WEEK  LIST                     
         LA    R0,104                 MAX 104 ENTRIES                           
         J     BUDHOOK1                                                         
*                                                                               
         CLI   REQDTYPE,C'M'       IF MONTHS                                    
         BNE   *+16                                                             
         LA    R2,MNTHLSTB            USE BINARY MONTH LIST                     
         LA    R0,50                  MAX 50 ENTRIES                            
         J     BUDHOOK1                                                         
*                                                                               
         CLI   REQDTYPE,C'Q'       IF QUARTERS                                  
         BNE   *+16                                                             
         LA    R2,QURTLIST            USE QUARTER      LIST                     
         LA    R0,16                  MAX 16 ENTRIES                            
         J     BUDHOOK1                                                         
*                                                                               
         CLI   REQDTYPE,C'S'       IF SEMI-ANNUAL                               
         JNE   *+16                                                             
         LA    R2,SEMILIST            USE SEMI-YEAR    LIST                     
         LA    R0,8                   MAX  8 ENTRIES                            
         J     BUDHOOK1                                                         
*                                                                               
         CLI   REQDTYPE,C'Y'       IF YEARS                                     
         JNE   *+16                                                             
         LA    R2,YEARLIST            USE YEARS        LIST                     
         LA    R0,4                   MAX  4 ENTRIES                            
         J     BUDHOOK1                                                         
*                                                                               
BUDHOOK1 DS    0H                                                               
*                                                                               
BUDHOOKL DS    0H                                                               
*                                                                               
         CLI   REQDTYPE,C'W'       IF WEEKS                                     
         JNE   *+20                                                             
         MVC   RECURSTB,0(R2)         SET DATES FOR THIS CALL                   
         MVC   RECURENB,3(R2)         YMD BINARY                                
         J     BUDHOOKM                                                         
*                                                                               
         MVC   RECURSTB(2),0(R2)   ELSE SET DATES FOR THIS CALL                 
         MVC   RECURENB(2),2(R2)        YM BINARY                               
         MVI   RECURSTB+2,0             DATES ARE YM ONLY                       
         MVI   RECURENB+2,0                                                     
*                                                                               
BUDHOOKM DS    0H                                                               
*                                                                               
         NI    RECNTRL,X'FF'-RECRTRNQ   TURN OFF RETURN SWITCH                  
*                                                                               
         BRAS  RE,GOHOOK           PASS RECORD TO DRIVER                        
*                                                                               
         TM    RECNTRL,RECRTRNQ    TEST IF NEED TO RETURN FOR MORE DATA         
         JO    BUDHOOKM                                                         
*                                                                               
         LA    R2,4(R2)            BUMP TO NEXT DATE IN LIST                    
*                                                                               
         CLI   REQDTYPE,C'W'       IF WEEKS                                     
         JNE   *+8                                                              
         LA    R2,2(R2)               BUMP 2 MORE POSITIONS                     
*                                                                               
         OC    0(4,R2),0(R2)       DONE AT END OF LIST                          
         JZ    BUDHOOKD                                                         
*                                                                               
         BRCT  R0,BUDHOOKL                                                      
*                                                                               
BUDHOOKD DS    0H                                                               
*                                                                               
BUDHOOKX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - BUDPOST'                        
***********************************************************************         
*                                                                     *         
*        ROUTINE TO POST DOLLARS IN A BUDGET RECORD                   *         
*        TO MONTH BUCKETS IN A TABLE.                                 *         
*                                                                     *         
*NTRY    R6==> BUDGET ELEMENT                                         *         
*                                                                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
BUDPOST  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
***********************************************************************         
*                                                                     *         
*    FIRST USE OVERALL REQUEST DATES TO ESTABLISH A MONTH TABLE       *         
*    IF START AND END DATES ARE MORE THAN 72 MONTHS (6 YEARS) APART   *         
*    TABLE CAN'T HANDLE THE SPREAD AND MONTHS OVER 72 FALL OFF        *         
*    END OF TABLE                                                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         L     R2,REANWMON         POINT TO BUDMON TABLES AREA                  
         USING BDMNTABD,R2         ESTABLISH BUD MONTH TABLE AREA               
*                                                                               
*        INIT TABLE                                                             
*                                                                               
         CLC   BDMTLBL,=CL2'*BUDMONTAB**' SKIP IF ALREADY INITIALIZED           
         BE    BDPINITX                                                         
*                                                                               
         XC    BDMTHDR,BDMTHDR     CLEAR HEADER                                 
         MVC   BDMTLBL,=CL12'*BUDMONTAB**'  SET TABLE ID                        
*                                                                               
*        CLEAR ENTRIES IN TABLE                                                 
*                                                                               
         LA    RF,BDMTNTRL         TABLE ENTRY LENGTH                           
         MHI   RF,BDMTMAXQ         NUMBER OF ENTRIES                            
         LA    RE,BDMTNTRY         A(FIRST ENTRY IN TABLE)                      
         XCEFL                                                                  
*                                                                               
         LA    R3,BDMTNTRY         POINT TO START OF TABLE                      
         USING BDMTNTRY,R3         ESTABLISH ENTRY IN TABLE                     
*                                                                               
*        START TABLE WITH JANUARY OF FIRST BROADCAST YR IN REQ PERIOD           
*                                                                               
         GOTO1 GETBROAD,DMCB,(1,REQPSTR),WORK,GETDAY,ADDAY                      
*                                                                               
*        END OF BROADCAST MONTH IS IN BROADCAST MONTH                           
*        USE SAME YEAR TO CREATE JANUARY FIRST                                  
*                                                                               
         MVC   WORK+8(4),=C'0101'                                               
*                                                                               
         MVC   BDMTCURC,WORK+6     LABEL ENTRY                                  
*                                                                               
         LA    R0,BDMTMAXQ-1       NUMBER OF BUCKETS LEFT TO IDENTIFY           
*                                                                               
BDPMMNLP EQU   *                                                                
*                                                                               
         CLC   BDMTCURC(4),SVQEND  ALL DATES LOADED?                            
         JNL   BDPMMNDN            YES - NO SEED OTHER DATES                    
*                                                                               
         LA    R5,BDMTNTRY+BDMTNTRL   SET A(NEXT DATE ENTRY)                    
*                                                                               
         GOTO1 ADDAY,DMCB,(C'M',BDMTCURC),(R5),1                                
*                                             CALC START OF NEXT MONTH          
*                                               ACTS AS DUMP LABEL              
BDPMMNCN DS    0H                                                               
*                                                                               
         LR    R3,R5               BUMP TABLE ENTRY POINTER                     
         BCT   R0,BDPMMNLP         DO NEXT DATE                                 
*                                                                               
BDPMMNDN EQU   *                                                                
*                                                                               
         DROP  R3                                                               
*                                                                               
*        FILL IN CUR,PRI,PR2,NXT BINARY DATES                                   
*                                                                               
         LA    R3,BDMTNTRY         A(NEW MONTH TABLE)                           
         USING BDMTNTRY,R3         ESTABLISH TABLE ENTRY                        
*                                                                               
         GOTO1 DATCON,DMCB,BDMTCURC,(3,WORK)   MONTH IS JAN - TO BINARY         
*                                                                               
         SR    RF,RF                                                            
*                                                                               
BDPMMN2L EQU   *                                                                
*                                                                               
         MVC   BDMTCURB,WORK       SET CURRENT START DATE - YM                  
*                                                                               
         IC    RF,WORK                                                          
         BCTR  RF,0                DECREMENT YEAR BY 1                          
         STC   RF,WORK             TO CALCULATE PRIOR YEAR                      
         MVC   BDMTPRIB,WORK       SET PRIOR DATE                               
*                                                                               
         BCTR  RF,0                SUBTRACT ANOTHER TO CALCULATE                
         STC   RF,WORK             2 YEARS PRIOR                                
         MVC   BDMTPR2B,WORK       SET 2 YEARS PRIOR                            
*                                                                               
         LA    RF,3(RF)            CALCULATE NEXT YEARS DATE                    
         STC   RF,WORK                                                          
         MVC   BDMTNXTB,WORK       SET NEXT YEARS DATE                          
*                                                                               
         CLI   WORK+1,12           IS IT DECEMBER?                              
         JL    BDPMMN23            NO                                           
         MVI   WORK+1,1            YES - SET MONTH TO JAN                       
*                                  YEAR IS ALREADY SET TO NEXT YEAR             
         J     BDPMMN25                                                         
*                                                                               
BDPMMN23 DS    0H                                                               
*                                                                               
         BCTR  RF,0                DECREMENT NEXT YEAR TO THIS YEAR             
         STC   RF,WORK             RESET YEAR TO CURRENT                        
         IC    RF,WORK+1           INCREMENT MONTH                              
         LA    RF,1(RF)                                                         
         STC   RF,WORK+1           RESTORE NEW MONTH                            
*                                                                               
BDPMMN25 DS    0H                                                               
*                                                                               
BDPMMN2C DS    0H                                                               
*                                                                               
         LA    R3,BDMTNTRY+BDMTNTRL NO - NEXT TABLE ENTRY                       
*                                                                               
         CLC   REQPENDB(2),WORK     END REACHED?                                
         BNL   BDPMMN2L             NO - GO BACK AND DO NEXT                    
*                                                                               
BDPMMN2D EQU   *                                                                
*                                                                               
         DROP  R3                                                               
*                                                                               
BDPINITX DS    0H                                                               
*                                                                               
*        SET UP TABLE HEADER                                                    
*                                                                               
BDPHDR   DS    0H                                                               
*                                                                               
         L     R4,REAIO1           POINT TO BUDGET RECORD                       
         USING RBUDREC,R4          ESTABLISH BUDGET RECORD                      
*                                                                               
         XC    BDMTHDR,BDMTHDR     CLEAR HEADER                                 
*                                                                               
         MVC   BDMTBDTP,RBUDKTYP   SET BUDGET RECORD TYPE                       
         MVC   BDMTBDT2,RBUDKTYP+1 SET BUDGET RECORD SUB-TYPE                   
         MVC   BDMTREP,REREP       SET REP                                      
*                                                                               
         CLI   BDMTBDTP,RBUDKTYQ   IF STATION BUDGET RECORD                     
         BNE   BDPSTAN                                                          
*                                                                               
         MVC   BDMTYR,RBUDKYR         SET YEAR                                  
         MVC   BDMTSTA,RBUDKSTA       SET STATION                               
         MVC   BDMTOFF,RBUDKTEM       SET OFFICE                                
         MVC   BDMTSGR,REGRS          SET GROUP                                 
*                                                                               
         CLC   RBUDKTEM,SPACES     IF OFFICE IN KEY                             
         BNH   *+12                                                             
         OI    BDMTSBTP,BDMTSBOQ      INDICATE OFFICE BUDGET                    
         B     BDPSTAX                                                          
*                                                                               
         OI    BDMTSBTP,BDMTSBSQ   ELSE INDICATE STATION BUDGET                 
*                                                                               
BDPSTAX  DS    0H                                                               
*                                                                               
         B     BDPHDRX                                                          
*                                                                               
BDPSTAN  DS    0H                                                               
*                                                                               
         CLI   BDMTBDTP,RCBDKTYQ   IF COMPANY BUDGET RECORD                     
         BNE   BDPCMPN                                                          
*                                                                               
         MVC   BDMTYR,RBUDKYR         SET YEAR                                  
         MVC   BDMTSTA,=C'C*MP '      SET STATION                               
         MVC   BDMTOFF,RBUDKTEM       SET OFFICE                                
*                                                                               
         CLC   RBUDKTEM,SPACES     IF OFFICE IN KEY                             
         BNH   *+12                                                             
         OI    BDMTSBTP,BDMTSBOQ      INDICATE OFFICE BUDGET                    
         B     BDPCMPX                                                          
*                                                                               
         OI    BDMTSBTP,BDMTSBSQ   ELSE INDICATE STATION BUDGET                 
*                                                                               
BDPCMPX  DS    0H                                                               
*                                                                               
         B     BDPHDRX                                                          
*                                                                               
BDPCMPN  DS    0H                                                               
*                                                                               
         CLI   BDMTBDTP,ROBDKTYQ   IF OFFICE BUDGET RECORD                      
         BNE   BDPOFFN                                                          
*                                                                               
         USING ROBDKEY,R4          ESTABLISH OFFICE BUDGET KEY                  
*                                                                               
         MVC   BDMTYR,ROBDKYR      SET YEAR                                     
         MVC   BDMTOFF,ROBDKOFF    SET OFFICE                                   
         MVC   BDMTTEM,ROBDKTM     SET TEAM                                     
         MVC   BDMTSGR,ROBDKSUB    SET SUB-GROUP                                
*                                                                               
         CLC   ROBDKSUB,SPACES     IF SUB-GROUP IN KEY                          
         BNH   *+12                                                             
         OI    BDMTOBTP,BDMTOBGQ      INDICATE SUB-GROUP BUDGET                 
         B     BDPOTPX                                                          
*                                                                               
         CLC   ROBDKTM,SPACES      IF TEAM IN KEY                               
         BNH   *+12                                                             
         OI    BDMTOBTP,BDMTOBTQ      INDICATE TEAM BUDGET                      
         B     BDPOTPX                                                          
*                                                                               
         OI    BDMTOBTP,BDMTOBOQ   ELSE INDICATE OFFICE  BUDGET                 
*                                                                               
BDPOTPX  DS    0H                                                               
*                                                                               
         B     BDPHDRX                                                          
*                                                                               
BDPOFFN  DS    0H                                                               
*                                                                               
         CLI   BDMTBDTP,X'15'      IF SALESPERSON BUDGET RECORD                 
         BNE   BDPBSPN                                                          
*                                                                               
         USING RSBDKEY,R4          ESTABLISH SALESPERSON BUDGET KEY             
*                                                                               
         MVC   BDMTYR,RSBDKYR         SET YEAR                                  
         MVC   BDMTSTA,RSBDKSTA       SET STATION                               
         MVC   BDMTSAL,RSBDKSAL       SET SALESPERSON                           
         MVC   BDMTDCT,RSBDKDCT       SET DCT                                   
*                                                                               
         LA    R1,BDMTSPTP         ASSUME SALESPERSON BUDGET                    
         CLI   BDMTBDT2,X'04'      CHECK IF SALESPERSON/STATION BUDGET          
         BNE   *+8                                                              
         LA    R1,BDMTSSTP                                                      
*                                                                               
         CLC   RSBDKDCT,SPACES     IF DCT IN KEY                                
         BNH   *+12                                                             
         OI    0(R1),BDMTSPDQ         INDICATE DCT BUDGET                       
         B     BDPSPPX                                                          
*                                                                               
         OI    0(R1),BDMTSPSQ      ELSE INDICATE SALESPERSON BUDGET             
*                                                                               
BDPSPPX  DS    0H                                                               
*                                                                               
         B     BDPHDRX                                                          
*                                                                               
BDPBSPN  DS    0H                                                               
*                                                                               
BDPHDRX  DS    0H                                                               
*                                                                               
*        CLEAR BUCKETS                                                          
*                                                                               
         USING RBUDKEY,R4          RE-ESTABLISH STATION BUDGET RECORD           
*                                                                               
         LA    R0,BDMTMAXQ         NUMBER OF BUCKETS                            
         LA    R3,BDMTNTRY         FIRST TABLE ENTRY                            
         USING BDMTNTRY,R3         ESTABLISH BUCKET                             
*                                                                               
         XC    BDMTBCK(BDMTBCKL),BDMTBCK   CLEAR BUCKET2                        
         LA    R3,BDMTNTRY+BDMTNTRL   BUMP TO NEXT ENTRY IN TABLE               
         BRCT  R0,*-10                                                          
*                                                                               
         DROP  R3                                                               
*                                                                               
         USING RBUDELEM,R6         ESTABLISH BUDGET ELEMENT                     
*                                                                               
         CLI   RBUDELEM,X'02'      IF CONTRACT TYPE ELEMENT                     
         BNE   *+14                                                             
         MVC   BDMTCTP,RBUDCNTR       SET CONTRACT TYPE                         
         OI    BDMTSBTP,BDMTSBCQ      INDICATE CTY BUDGET                       
*                                                                               
*        ASSIGN BUDGET DOLLARS TO BUCKETS                                       
*                                                                               
         MVC   WORK(2),BDMTYR      STARTING YEAR                                
         MVC   WORK+2(4),=C'0101'  SET FOR JANUARY START                        
         GOTO1 DATCON,DMCB,(0,WORK),(3,FULL)  CONVERT TO BINARY                 
*                                                                               
         LA    R0,12               MAX 12 MONTHS                                
         LA    R8,RBUDSTA          POINT TO FIRST BUCKET IN RECORD              
*                                                                               
BUDPMNLP DS    0H                                                               
*                                                                               
         LA    R3,BDMTNTRY         POINT TO FIRST ENTRY IN TABLE                
         USING BDMTNTRY,R3         ESTABLISH TABLE ENTRY                        
*                                                                               
         LA    R1,BDMTMAXQ         MAX ENTRYS                                   
*                                                                               
BUDPNTLP DS    0H                                                               
*                                                                               
         LA    R5,BDMTDTSL/(L'BDMTCURB) NUMBER OF DATES IN LIST                 
         LA    RF,BDMTDTS          START OF DATES                               
         LA    R9,BDMTBCK          START OF BUCKETS                             
*                                                                               
BUDPBKLP DS    0H                                                               
*                                                                               
         CLC   FULL(2),0(RF)       IF BUDGET DATE MATCHES BCKT DATE             
         BNE   *+10                                                             
         MVC   0(L'BDMTCUR,R9),0(R8)  MOVE BUCKET TO TABLE                      
*                                                                               
BUDPBKCN DS    0H                                                               
*                                                                               
         LA    RF,L'BDMTCURB(RF)   BUMP TO NEXT DATE                            
         LA    R9,L'BDMTCUR(R9)    BUMP TO NEXT BUCKET                          
         BRCT  R5,BUDPBKLP                                                      
*                                                                               
BUDPBKDN DS    0H                                                               
*                                                                               
BUDPNTCN DS    0H                                                               
*                                                                               
         LA    R3,BDMTNTRY+BDMTNTRL BUMP TO NEXT TABLE ENTRY                    
         BRCT  R1,BUDPNTLP                                                      
*                                                                               
BUDPNTDN DS    0H                                                               
*                                                                               
BUDPMNCN DS    0H                                                               
*                                                                               
         SR    RE,RE                                                            
         IC    RE,FULL+1           GET CURRENT MONTH                            
         AHI   RE,1                BUMP MONTH                                   
*                                                                               
         CHI   RE,13               IF INTO NEXT YEAR                            
         BL    *+20                                                             
         IC    RE,FULL                BUMP YEAR                                 
         AHI   RE,1                                                             
         STC   RE,FULL                                                          
         LA    RE,1                   SET TO JANUARY                            
*                                                                               
         STC   RE,FULL+1           NEW MONTH                                    
*                                                                               
         LA    R8,4(R8)            POINT TO NEXT BUDGET BUCKET                  
*                                                                               
         BRCT  R0,BUDPMNLP                                                      
*                                                                               
BUDPMNDN DS    0H                                                               
*                                                                               
BUDPOSTX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE -CON'                             
***********************************************************************         
*                                                                     *         
*        READ CONTRACT RECORDS                                        *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
CON      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
*        FIND FIRST REP                                                         
*                                                                               
         ICM   R2,15,REREPTBA      SKIP IF NO REP TABLE                         
         BZ    CREPREPX                                                         
*                                                                               
         USING REPTTABD,R2         ESTABLISH REP TABLE                          
*                                                                               
         ICM   R3,15,BSPATAB-BSPPRMS+REPTBSRP  1ST ENTRY IN TABLE               
         BZ    CREPREPX             NO TABLE                                    
         USING REPTENT,R3                                                       
*                                                                               
CREPLOOP DS    0H                  PROCESS CONTRACT RECS FOR A REP              
*                                                                               
         OC    REPTENT(REPTENTL),REPTENT  TEST FOR END OF TABLE                 
         BZ    CREPDONE                                                         
*                                                                               
         ST    R3,REPTENTA         SET CURRENT TABLE ENTRY ADDRESS              
*                                                                               
         TM    REPTKEY+27,X'80'    SKIP IF DELETED                              
         BO    CREPCONT                                                         
*                                                                               
         MVC   REREPTA,REPTENTA    RETURN A(REP TABLE ENTRY)                    
*                                                                               
         OC    REXFREP(REXFREPL),REXFREP IF CROSS-FILE REPORTING                
         BZ    *+10                                                             
         OC    REFGRP,REFGRP       IF FILTERING ON GROUP                        
         BZ    *+10                                                             
         MVC   REFGRP,REPTGRP         SET SPECIAL GROUP CODE                    
*                                                                               
         MVC   REREP,RREPKREP-RREPKEY+REPTKEY   RETURN REP                      
         MVC   RESE,REPTSE         RETURN REP'S SE CODE                         
*                                                                               
         ICM   RF,15,REUTLA        POINT TO UTL                                 
         JZ    *+18                SKIP IF NOT AVAILABLE                        
         CLI   REPTSE,0            SKIP IF NOT AVAILABLE                        
         BE    *+10                                                             
         MVC   4(1,RF),REPTSE      SET SE NUMBER                                
*                                                                               
         XC    REMREP,REMREP       INIT MASTER REP                              
*                                                                               
         LA    R4,REPTELM          ESTABLISH REP DECRIPTION ELEMENT             
         USING RREPELEM,R4                                                      
*                                                                               
         CLC   =C'NU',REREP        SPECIAL FOR REP 'NU'                         
         BNE   *+14                                                             
         MVC   REMREP,=C'K3'                                                    
         B     CREPMRPX                                                         
*                                                                               
         CLC   RREPMAST,=CL4' '    SKIP IF NO MASTER REP                        
         BE    CREPMRPX                                                         
*                                                                               
         OC    RREPMAST,RREPMAST   SKIP IF NO MASTER REP                        
         BZ    CREPMRPX                                                         
*                                                                               
         CLC   RREPMAST,=4X'FF'    IF MASTER REP                                
         BNE   *+14                                                             
         MVC   REMREP,REREP           SAVE CURRENT REP AS MASETER REP           
         B     CREPMRPX                                                         
*                                                                               
         MVC   REMREP,RREPMAST     ELSE SAVE MASTER REP                         
*                                                                               
CREPMRPX DS    0H                                                               
*                                                                               
         BRAS  RE,TABS             LOAD REP'S TABLES                            
*                                                                               
         BRAS  RE,STA              LOAD REP'S STATIONS                          
*                                                                               
***********************************************************************         
*                                                                     *         
*        READ CONTRACT RECORDS FOR REP                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING RCONKEY,R4          ESTABLISH CONTRACT BASE KEY                  
*                                                                               
*        INIT CURRENT VALUES OF ALL KEY FIELDS                                  
*                                                                               
         XC    REGRS,REGRS         GROUP/SUBGROUP                               
         XC    RESTA,RESTA         STATION                                      
         XC    REOFF,REOFF         OFFICE                                       
         XC    REAGY,REAGY         AGENCY                                       
         XC    REAOF,REAOF         AGENCY OFFICE                                
         XC    READV,READV         ADVERTISER                                   
         XC    RECON,RECON         CONTRACT                                     
*                                                                               
*        FIND STARTING VALUES FOR KEY FIELDS                                    
*                                                                               
         GOTO1 =A(GRPGET),DMCB,(C'N',REGRS)   FIND FIRST GROUP                  
         GOTO1 =A(STGET),DMCB,(C'N',RESTA)    FIND FIRST STATION                
         GOTO1 =A(OFFGET),DMCB,(C'N',REOFF)   FIND FIRST OFFICE                 
*                                                                               
         NI    REAGCNTL,X'FF'-REAGCFDQ TURN OFF FOUND SWITCH                    
*                                                                               
         TM    REAGCNTL,REAGCFTQ   SKIP IF NOT FILTERING                        
         BNO   CONAGYIX                                                         
*                                                                               
         GOTO1 =A(AGYGET),DMCB,(C'N',REAGY)   FIND 1ST AGENCY/AGY OFF           
*                                                                               
CONAGYIX DS    0H                                                               
*                                                                               
         NI    READCNTL,X'FF'-READCFDQ TURN OFF FOUND SWITCH                    
*                                                                               
         TM    READCNTL,READCFTQ   SKIP IF NOT FILTERING                        
         BNO   CONADVIX                                                         
*                                                                               
         GOTO1 =A(ADVGET),DMCB,(C'N',READV)   FIND 1ST ADVERTISER               
*                                                                               
CONADVIX DS    0H                                                               
*                                                                               
         OC    REFCON,REFCON       IF CONTRACT FILTER ENTERED                   
         BZ    *+10                                                             
         MVC   RECON,REFCON           SET CONTRACT NUMBER                       
*                                                                               
*        FILL IN CONTRACT KEY                                                   
*                                                                               
         MVI   RCONKTYP,RCONKTYQ   RECORD TYPE                                  
         MVC   RCONKREP,REREP      REP                                          
         MVC   RCONKGRP,REGRS      GROUP/SUBGROUP (MAY BE NULLS)                
         MVC   RCONKSTA,RESTA      STATION        (MAY BE NULLS)                
         MVC   RCONKOFF,REOFF      OFFICE         (MAY BE NULLS)                
         MVC   RCONKAGY,REAGY      AGENCY         (MAY BE NULLS)                
         MVC   RCONKAOF,REAOF      AGENCY OFFICE  (MAY BE NULLS)                
         MVC   RCONKADV,READV      ADVERTISER     (MAY BE NULLS)                
         MVC   RCONKCON,RECON      CONTRACT       (MAY BE NULLS)                
*                                                                               
         BAS   RE,FIRSTHI          READ FIRST RECORD                            
*                                                                               
CONLOOP  DS    0H                                                               
*                                                                               
         XC    REBCD,REBCD         RESET BUY CODE FIELDS                        
         XC    REBT1,REBT1         RESET BUY CODE FIELDS                        
         XC    REBT2,REBT2         RESET BUY CODE FIELDS                        
*                                                                               
*        CHECK FOR MAJOR CHANGES IN KEY                                         
*                                                                               
         LA    R4,KEY              RE-ESTABLISH KEY POINTER                     
*                                                                               
         CLC   RCONKEY(RCONKCON-RCONKEY),KEYSAVE IF SAME REP///ADV              
         BE    CONKEYOK                             CONTINUE                    
*                                                                               
         CLI   RCONKTYP,RCONKTYQ   DONE IF NOT A CONTRACT RECORD                
         BNE   CONDONE                                                          
*                                                                               
CONREP   DS    0H                                                               
*                                                                               
         CLC   RCONKREP,RCONKREP-RCONKEY+KEYSAVE IF REP CHANGED                 
         BNE   CONDONE                              DONE                        
*                                                                               
CONREPOK DS    0H                                                               
*                                                                               
CONGRP   DS    0H                                                               
*                                                                               
         CLC   RCONKGRP,REGRS      IF GROUP/SUBGROUP CHANGED                    
         BE    CONGRPOK                                                         
*****                                                                           
*****    OC    REFGRPSB,REFGRPSB   SKIP IF NOT FILTERING ON GRP/SUB             
*****    BNZ   *+10                                                             
*****    OC    REGRPSID,REGRPSID                                                
*****    BZ    CONGRPOK                                                         
*                                                                               
         GOTO1 =A(GRPGET),DMCB,(C'G',RCONKGRP)  FIND NEXT GP/SBGRP              
         BNE   CONDONE                     DONE IF NONE FOUND                   
*                                                                               
         CLC   REGRS,RCONKGRP      IF DEFAULT NOT USED                          
         BE    CONGRPOK                                                         
*                                                                               
         XC    RESTA,RESTA            FORCE STATION LOOK UP                     
         XC    REOFF,REOFF            OFFICE                                    
         XC    REAGY,REAGY            AGENCY                                    
         XC    REAOF,REAOF            AGENCY OFFICE                             
         XC    READV,READV            ADVERTISER                                
         XC    RECON,RECON            CONTRACT                                  
*                                                                               
         B     CONKEY                                                           
*                                                                               
CONGRPOK DS    0H                                                               
*                                                                               
CONSTA   DS    0H                                                               
*                                                                               
         CLC   RCONKSTA,RESTA      IF STATION CHANGES                           
         BE    CONSTAOK                                                         
*                                                                               
         GOTO1 =A(STGET),DMCB,(C'G',RCONKSTA)     FIND NEXT STATION             
*                                                                               
         CLC   RESTA,RCONKSTA      IF DEFAULT NOT USED                          
         BE    CONSTAOK                                                         
*                                                                               
         XC    REOFF,REOFF            FORCE OFFICE LOOK UP                      
         XC    REAGY,REAGY         AGENCY                                       
         XC    REAOF,REAOF         AGENCY OFFICE                                
         XC    READV,READV         ADVERTISER                                   
         XC    RECON,RECON         CONTRACT                                     
*                                                                               
         B     CONKEY                                                           
*                                                                               
CONSTAOK DS    0H                                                               
*                                                                               
CONOFF   DS    0H                                                               
*                                                                               
         CLC   RCONKOFF,REOFF      IF OFFICE CHANGES                            
         BE    CONOFFOK                                                         
*                                                                               
         GOTO1 =A(OFFGET),DMCB,(C'G',RCONKOFF)  FIND NEXT OFFICE                
*                                                                               
         CLC   REOFF,RCONKOFF      IF DEFAULT NOT USED                          
         BE    CONOFFOK                                                         
*                                                                               
         XC    REAGY,REAGY            FORCE AGENCY        LOOK UP               
         XC    REAOF,REAOF            FORCE AGENCY OFFICE LOOK UP               
         XC    READV,READV         ADVERTISER                                   
         XC    RECON,RECON         CONTRACT                                     
*                                                                               
         B     CONKEY                                                           
*                                                                               
CONOFFOK DS    0H                                                               
*                                                                               
CONAGY   DS    0H                                                               
*                                                                               
         CLC   RCONKAGY,REAGY      IF AGENCY        CHANGES                     
         BNE   *+10                                                             
         CLC   RCONKAOF,REAOF      OR AGENCY OFFICE CHANGES                     
         BE    CONAGYOK                                                         
*                                                                               
         NI    REAGCNTL,X'FF'-REAGCFDQ TURN OFF FOUND SWITCH                    
*                                                                               
         TM    REAGCNTL,REAGCFTQ      IF AGY NOT FILTERED                       
         BO    *+20                                                             
         MVC   REAGY,RCONKAGY            USE DEFAULT                            
         MVC   REAOF,RCONKAOF            USE DEFAULT                            
         B     CONAGYOK                                                         
*                                                                               
         GOTO1 =A(AGYGET),DMCB,(C'G',RCONKAGY)   FIND NEXT AGENCY               
*                                                                               
         CLC   REAGY,RCONKAGY      IF DEFAULT NOT USED                          
         BE    *+20                                                             
         XC    READV,READV            FORCE ADVERTISER LOOK UP                  
         XC    RECON,RECON         CONTRACT                                     
         B     CONKEY                                                           
*                                                                               
         CLC   REAOF,RCONKAOF      IF DEFAULT NOT USED                          
         BE    *+20                                                             
         XC    READV,READV            FORCE ADVERTISER LOOK UP                  
         XC    RECON,RECON         CONTRACT                                     
         B     CONKEY                                                           
*                                                                               
CONAGYOK DS    0H                                                               
*                                                                               
CONADV   DS    0H                                                               
*                                                                               
         CLC   RCONKADV,READV      IF ADVERTISER CHANGES                        
         BE    CONADVOK                                                         
*                                                                               
         NI    READCNTL,X'FF'-READCFDQ TURN OFF FOUND SWITCH                    
*                                                                               
         TM    READCNTL,READCFTQ      IF ADV NOT FILTERED                       
         BO    *+14                                                             
         MVC   READV,RCONKADV            USE DEFAULT                            
         B     CONADVOK                                                         
*                                                                               
         GOTO1 =A(ADVGET),DMCB,(C'G',RCONKADV)  FIND NEXT ADVERTISER            
*                                                                               
         CLC   READV,RCONKADV      IF DEFAULT NOT USED                          
         BE    *+14                                                             
         XC    RECON,RECON            FORCE CONTRACT LOOK UP                    
         B     CONKEY                                                           
*                                                                               
CONADVOK DS    0H                                                               
*                                                                               
CONCON   DS    0H                                                               
*                                                                               
         MVC   RECON,RCONKCON         DEFAULT TO NEW CONTRACT NUMBER            
*                                                                               
         OC    REFCON,REFCON       IF CONTRACT FILTER ENTERED                   
         BZ    *+10                                                             
         MVC   RECON,REFCON           SET CONTRACT NUMBER                       
*                                                                               
CONCONOK DS    0H                                                               
*                                                                               
*        CHECK IF CURRENT KEY IS ACCEPTABLE                                     
*              ANY BREAK IN KEY FORCES A SKIP READ                              
*                                                                               
CONKEY   DS    0H                                                               
*                                                                               
         CLC   RCONKGRP,REGRP      GROUP/SUBGROUP                               
         BNE   CONCNSKP                                                         
         CLC   RCONKSTA,RESTA      STATION                                      
         BNE   CONCNSKP                                                         
         CLC   RCONKOFF,REOFF      OFFICE                                       
         BNE   CONCNSKP                                                         
         CLC   RCONKAGY,REAGY      AGENCY                                       
         BNE   CONCNSKP                                                         
         CLC   RCONKAOF,REAOF      AGENCY OFFICE                                
         BNE   CONCNSKP                                                         
         CLC   RCONKADV,READV      ADVERTISER                                   
         BNE   CONCNSKP                                                         
         CLC   RCONKCON,RECON      CONTRACT                                     
         BNE   CONCNSKP                                                         
*                                                                               
CONKEYOK DS    0H                                                               
*                                                                               
         OC    REFCON,REFCON       SKIP IF NOT FILTERING ON CONTRACT #          
         BZ    CONKYOKX                                                         
*                                                                               
         CLC   RCONKCON,REFCON     CHECK CONTRACT NUMBER                        
         BE    CONKYOKX                                                         
*                                                                               
         BH    *+14                                                             
         MVC   RECON,REFCON        BUMP TO FILTER VALUE                         
         B     CONCNSKP                                                         
*                                                                               
         MVC   RECON,=X'FFFFFFFF'  BUMP TO NEXT ADV                             
         B     CONCNSKP                                                         
*                                                                               
CONKYOKX DS    0H                                                               
*                                                                               
         TM    RCONKEY+27,X'80'    SKIP DELETED RECORDS                         
         BO    CONCONT                                                          
*                                                                               
         MVC   RECON,RCONKCON      UPDATE CONTRACT NUMBER                       
         MVC   RECONKEY,KEY        SAVE KEY                                     
*                                                                               
         BAS   RE,GETREC           READ CONTRACT RECORD                         
*                                                                               
         BNZ   CONCONT             SKIP DELETED RECORDS                         
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
         USING RCONREC,R4          ESTABLISH RECORD                             
*                                                                               
         MVI   REPERTYP,0          INIT PERIOD TYPE                             
*                                                                               
CONDTS   DS    0H                  FILTER ON FLIGHT DATES                       
*                                                                               
         TM    REFDTTYP,REFDPR2Q   SKIP IF 2YR PRIOR DATA NOT NEEDED            
         BNO   CONDPR2X                                                         
*                                                                               
         CLC   RCONDATE(3),REFPR2EB IF DATES OVERLAP 2YR PRIOR PERIOD           
         BH    CONDPR2X                                                         
*                                                                               
         TM    REQCFOPT,REQCFYTQ   SKIP IF YTD OPTION IN PLAY                   
         BO    *+18                                                             
         CLC   RCONDATE+3(3),REFPR2SB                                           
         BNL   CONDPR2Y               KEEP RECORD                               
         B     CONDPR2X                                                         
*                                  COMPARE TO YTD START DATE                    
         CLC   RCONDATE+3(3),REFYP2SB                                           
         BL    CONDPR2X                                                         
*                                                                               
CONDPR2Y DS    0H                  KEEP CONTRACT                                
*                                                                               
         OI    REPERTYP,REPRPR2Q   PRIOR 2 YEAR CONTRACT                        
*                                                                               
         B     CONDTSOK                                                         
*                                                                               
CONDPR2X DS    0H                                                               
*                                                                               
         TM    REFDTTYP,REFDPRIQ   SKIP IF PRIOR DATA NOT NEEDED                
         BNO   CONDPRIX                                                         
*                                                                               
         CLC   RCONDATE(3),REFPRIEB IF DATES OVERLAP PRIOR  PERIOD              
         BH    CONDPRIX                                                         
*                                                                               
         TM    REQCFOPT,REQCFYTQ   SKIP IF YTD OPTION IN PLAY                   
         BO    *+18                                                             
         CLC   RCONDATE+3(3),REFPRISB                                           
         BNL   CONDPRIY               KEEP RECORD                               
         B     CONDPRIX                                                         
*                                  COMPARE TO YTD START DATE                    
         CLC   RCONDATE+3(3),REFYPRSB                                           
         BL    CONDPRIX                                                         
*                                                                               
CONDPRIY DS    0H                  KEEP CONTRACT                                
*                                                                               
         OI    REPERTYP,REPRPRIQ   PRIOR YEAR CONTRACT                          
*                                                                               
         B     CONDTSOK                                                         
*                                                                               
CONDPRIX DS    0H                                                               
*                                                                               
         CLC   RCONDATE(3),REFCUREB IF DATES OVERLAP CURRENT PERIOD             
         BH    CONDCURX                                                         
*                                                                               
         TM    REQCFOPT,REQCFYTQ   SKIP IF YTD OPTION IN PLAY                   
         BO    *+18                                                             
         CLC   RCONDATE+3(3),REFCURSB                                           
         BNL   CONDCURY               KEEP RECORD                               
         B     CONDCURX                                                         
*                                  COMPARE TO YTD START DATE                    
         CLC   RCONDATE+3(3),REFYCRSB                                           
         BL    CONDCURX                                                         
*                                                                               
CONDCURY DS    0H                  KEEP CONTRACT                                
*                                                                               
         OI    REPERTYP,REPRCURQ   CURRENT YEAR CONTRACT                        
*                                                                               
         B     CONDTSOK                                                         
*                                                                               
CONDCURX DS    0H                                                               
*                                                                               
         TM    REFDTTYP,REFDNXTQ   SKIP IF NEXT DATA NOT NEEDED                 
         BNO   CONDNXTX                                                         
*                                                                               
         CLC   RCONDATE(3),REFNXTEB IF DATES OVERLAP NEXT PERIOD                
         BH    CONDNXTX                                                         
*                                                                               
         TM    REQCFOPT,REQCFYTQ   SKIP IF YTD OPTION IN PLAY                   
         BO    *+18                                                             
         CLC   RCONDATE+3(3),REFNXTSB                                           
         BNL   CONDNXTY               KEEP RECORD                               
         B     CONDNXTX                                                         
*                                  COMPARE TO YTD START DATE                    
         CLC   RCONDATE+3(3),REFYNXSB                                           
         BL    CONDNXTX                                                         
*                                                                               
CONDNXTY DS    0H                  KEEP CONTRACT                                
*                                                                               
         OI    REPERTYP,REPRNXTQ   NEXT YEAR CONTRACT                           
*                                                                               
         B     CONDTSOK                                                         
*                                                                               
CONDNXTX DS    0H                                                               
*                                                                               
         B     CONCONT             SKIP TO NEXT CONTRACT                        
*                                                                               
CONDTSOK DS    0H                                                               
*                                                                               
         LA    R4,KEY              RE-ESTABLISH KEY                             
*                                                                               
         GOTO1 =A(RECFLT)          FILTER RECORD                                
         BNE   CONCONT             FAILS FILTER                                 
*                                                                               
*        IF PRODUCT NEEDED FOR REPORT, ADD TO TABLE                             
*                                                                               
         CLC   REPRD,SPACES        SKIP IF CONTRACT HAS NO PRD                  
         BNH   CONPRDDN                                                         
*                                                                               
         LA    RF,REDATA           CHECK IF PRODUCT NEEDED FOR REPORT           
         LA    R0,L'REDATA                                                      
*                                                                               
         CLI   0(RF),0             CHECK FOR END OF TABLE                       
         BE    CONPRDDN                                                         
         CLI   0(RF),RPRDKTYQ      CHECK IF PRD IN DATATYPES                    
         BE    CONPRDPT            YES - PUT IN PRD TABLE                       
         LA    RF,1(RF)            BUMP POINTER                                 
         BCT   R0,*-20                                                          
         B     CONPRDDN            PRODUCT NOT NEEDED                           
*                                                                               
CONPRDPT DS    0H                  ADD PRODUCT TO TABLE                         
*                                                                               
         GOTO1 =A(PRDGET),DMCB,(C'G',REPRD)                                     
*                                                                               
CONPRDDN DS    0H                                                               
*                                                                               
         MVC   REAREC,REAIO        SET A(RECORD BEING PROCESSED)                
*                                                                               
*MNTEST                                                                         
         TM    REFTYPS3,REFTBSPQ                                                
         BO    CONBUYLP                                                         
         TM    REFTYPS3,REFTBCDQ+REFTBT1Q+REFTBT2Q  IF BUYS NEEDED              
         BZ    CONBUYN                                                          
*MNTEST                                                                         
*                                                                               
CONBUYLP DS    0H                                                               
*                                                                               
         GOTOR BUY                    HANDLE BUYS FOR CONTRACT                  
         BNZ   CONBUYDN               NO MORE BUY PROCESSING                    
*                                                                               
CONBUYN  DS    0H                                                               
*                                                                               
         GOTO1 =A(DOVALU2)         POST MONTH TABLE                             
*                                                                               
*        FILTER ON CONFIRMED, UNCONFIRMED ETC. DOLLARS                          
*                                                                               
         TM    REQCSTAT,REQCSCFQ+REQCSUCQ  SKIP IF NO FILTERING                 
         BZ    CONCFX              ON CONFIRMED DOLLARS                         
*                                                                               
         L     RF,REANWMON         POINT TO 1ST MONTH TABLE AREA                
         LA    RF,NWMTCSPC-NWMNTABD(RF) POINT TO CONTRACT SPECS                 
*                                                                               
         TM    CSFRMISC(RF),X'20'  IF CONFIRMED CONTRACT DOLLARS                
         BNO   CONCF10                                                          
*                                                                               
         TM    REQCSTAT,REQCSCFQ      KEEP IF CONFIRMED WANTED                  
         BO    CONCFX                                                           
         B     CONHOOKX               ELSE BYPASS CONTRACT                      
*                                                                               
CONCF10  DS    0H                                                               
*                                                                               
         TM    REQCSTAT,REQCSUCQ      KEEP IF UNCONFIRMED WANTED                
         BO    CONCFX                                                           
         B     CONHOOKX               ELSE BYPASS CONTRACT                      
*                                                                               
CONCFX   DS    0H                                                               
*                                                                               
*        FILTER ON COMPETITIVE STATUS                                           
*                                                                               
CONCOMP  DS    0H                                                               
*                                                                               
         CLI   REQCOMPF,0          SKIP IF NO FILTERING ON COMPETITIVE          
         BE    CONCOMPX               STATUS                                    
*                                                                               
         L     RF,REANWMON         POINT TO 1ST MONTH TABLE AREA                
         LA    RF,NWMTCSPC-NWMNTABD(RF) POINT TO CONTRACT SPECS                 
*                                                                               
         CLI   CSPENDNG(RF),C'Y'   IF PENDING CONTRACT                          
         BE    *+8                                                              
         CLI   CSPENDNG(RF),C'P'   IF PENDING CONTRACT                          
         BNE   *+12                                                             
         TM    REQCOMPF,REQCFPDQ   DO WE INCLUDE PENDING CONTRACTS?             
         BO    CONCOMPX            YES                                          
*                                                                               
         TM    CSFRMISC(RF),X'80'  IF INCOMPLETE CONTRACT                       
         BNO   *+12                                                             
         TM    REQCOMPF,REQCFINQ   DO WE INCLUDE INCOMPLETE CONTRACTS?          
         BO    CONCOMPX            YES                                          
*                                                                               
         CLI   CSSPLOSS(RF),C'Y'   IF CONTRACT IS A LOSS                        
         BNE   *+12                                                             
         TM    REQCOMPF,REQCFLSQ   DO WE INCLUDE LOSSES                         
         BO    CONCOMPX            YES                                          
*                                                                               
*                                  CONTRACT IS COMPLETED WIN                    
*                                                                               
         TM    REQCOMPF,REQCFCPQ   DO WE INCLUDE COMPLETED WINS                 
         BO    CONCOMPX            YES                                          
*                                                                               
         B     CONCONT             DROP CONTRACT                                
*                                                                               
CONCOMPX DS    0H                                                               
*                                                                               
         CLI   REQCMPFX,0          SKIP IF NO EXCLUDING ON COMPETITIVE          
         BE    CONCMPFX               STATUS                                    
*                                                                               
         L     RF,REANWMON         POINT TO 1ST MONTH TABLE AREA                
         LA    RF,NWMTCSPC-NWMNTABD(RF) POINT TO CONTRACT SPECS                 
*                                                                               
         CLI   CSPENDNG(RF),C'Y'   IF PENDING CONTRACT                          
         BE    *+8                                                              
         CLI   CSPENDNG(RF),C'P'   IF PENDING CONTRACT                          
         BNE   *+12                                                             
         TM    REQCMPFX,REQCFPDQ   DO WE EXCLUDE PENDING CONTRACTS?             
         BO    CONCONT             YES - DROP CONTRACT                          
*                                                                               
         TM    CSFRMISC(RF),X'80'  IF INCOMPLETE CONTRACT                       
         BNO   *+12                                                             
         TM    REQCMPFX,REQCFINQ   DO WE EXCLUDE INCOMPLETE CONTRACTS?          
         BO    CONCONT             YES - DROP CONTRACT                          
*                                                                               
         CLI   CSSPLOSS(RF),C'Y'   IF CONTRACT IS A LOSS                        
         BNE   *+12                                                             
         TM    REQCMPFX,REQCFLSQ   DO WE EXCLUDE LOSSES                         
         BO    CONCONT             YES - DROP CONTRACT                          
*                                                                               
*                                  CONTRACT IS COMPLETED WIN                    
*                                                                               
         TM    REQCMPFX,REQCFCPQ   DO WE EXCLUDE COMPLETED WINS                 
         BO    CONCONT             YES - DROP CONTRACT                          
*                                                                               
CONCMPFX DS    0H                                                               
*                                                                               
         TM    REQFLAGS,REQPWCR    IF PAPERWORK RECORDS REQUIRED                
         BNO   CONPWCX                                                          
*                                                                               
         GOTO1 =A(PWCGET)             GO READ IN PAPERWORK RECORD               
*                                                                               
CONPWCX  DS    0H                                                               
*                                                                               
CONHOOK  DS    0H                                                               
*                                                                               
         MVC   CONCURSB,REYMSTRP   DEFAULT TO WHOLE PERIOD                      
         MVC   CONCUREB,REYMENDP                                                
*                                                                               
         LA    R2,CONCURSB                                                      
         LA    R0,1                DEFAULT TO 1 TIME TO DRIVER                  
*                                                                               
         TM    RECNTRL,RECDLSTQ    IF DATE LIST PROCESSING                      
         BNO   CONHOOK2                                                         
*                                                                               
         L     R5,REDLSTA             POINT TO DATE LISTS                       
         USING DATELSTD,R5            ESTABLISH DATELISTS                       
*                                                                               
         SR    RF,RF                                                            
*                                                                               
         CLI   REQDTYPE,C'W'       IF WEEKS                                     
         BNE   *+16                                                             
         LA    R2,WEEKLSTB            USE BINARY WEEK  LIST                     
         LA    R0,104                 MAX 104 ENTRIES                           
         B     CONHOOK1                                                         
*                                                                               
         CLI   REQDTYPE,C'M'       IF MONTHS                                    
         BNE   *+20                                                             
         LA    R2,MNTHLSTB            USE BINARY MONTH LIST                     
         LA    R0,50                  MAX 50 ENTRIES                            
         IC    RF,YTDADJM             YTD LIST ADJUSTMENT                       
         B     CONHOOK1                                                         
*                                                                               
         CLI   REQDTYPE,C'Q'       IF QUARTERS                                  
         BNE   *+20                                                             
         LA    R2,QURTLIST            USE QUARTER      LIST                     
         LA    R0,16                  MAX 16 ENTRIES                            
         IC    RF,YTDADJQ             YTD LIST ADJUSTMENT                       
         B     CONHOOK1                                                         
*                                                                               
         CLI   REQDTYPE,C'S'       IF SEMI-ANNUAL                               
         BNE   *+20                                                             
         LA    R2,SEMILIST            USE SEMI-YEAR    LIST                     
         LA    R0,8                   MAX  8 ENTRIES                            
         IC    RF,YTDADJS             YTD LIST ADJUSTMENT                       
         B     CONHOOK1                                                         
*                                                                               
         CLI   REQDTYPE,C'Y'       IF YEARS                                     
         BNE   *+20                                                             
         LA    R2,YEARLIST            USE YEARS        LIST                     
         LA    R0,4                   MAX  4 ENTRIES                            
         IC    RF,YTDADJY             YTD LIST ADJUSTMENT                       
         B     CONHOOK1                                                         
*                                                                               
CONHOOK1 DS    0H                                                               
*                                                                               
         LTR   RF,RF               ADJUST LIST START BY YTD FACTOR              
         BZ    CONHOOK2            NO FACTOR                                    
*                                                                               
         LA    R2,4(R2)            BUMP UP 1 TABLE ENTRY                        
         BCT   RF,*-4                                                           
*                                                                               
CONHOOK2 DS    0H                                                               
*                                                                               
CONHOOKL DS    0H                                                               
*                                                                               
         CLI   REQDTYPE,C'W'       IF WEEKS                                     
         BNE   *+20                                                             
         MVC   RECURSTB,0(R2)         SET DATES FOR THIS CALL                   
         MVC   RECURENB,3(R2)         YMD BINARY                                
         B     CONHOOKM                                                         
*                                                                               
         MVC   RECURSTB(2),0(R2)   ELSE SET DATES FOR THIS CALL                 
         MVC   RECURENB(2),2(R2)        YM BINARY                               
         MVI   RECURSTB+2,0             DATES ARE YM ONLY                       
         MVI   RECURENB+2,0                                                     
*                                                                               
CONHOOKM DS    0H                                                               
*                                                                               
*        EVALUATE DARE CONNECTION TYPE FILTERING                                
*                                                                               
CONCNT   DS    0H                                                               
*                                                                               
         TM    REFTYPS3,REFTTDRQ+REFTXMLQ SKIP IF NO DARE FILTERING             
         BNZ   *+8                                                              
         TM    REFTYPN3,REFTTDRQ+REFTXMLQ                                       
         BZ    CONCNTX                                                          
*                                                                               
         L     R6,REAIO                                                         
         USING RCONREC,R4          GET INFO FROM CONTRACT RECORD                
*                                                                               
         MVI   ELCODE,X'1D'        DARE AGENCY ORDER ELEMENT                    
         BRAS  RE,GETEL                                                         
         BE    CONCNT10            DARE ORDER # FOUND                           
*                                  NON=DARE ORDER                               
         TM    REFTYPS3,REFTTDRQ+REFTXMLQ SKIP IF INCLUDING DARE                
         BNZ   CONCONT                                                          
         B     CONMGO              ELSE KEEP                                    
*                                                                               
CONCNT10 DS    0H                                                               
*                                                                               
         USING RCONDREL,R6                                                      
*                                                                               
         CLI   RCONDRLN,RCONDRLQ   SKIP IF NO XML INFO                          
         BNH   CONCNT20                                                         
*                                                                               
         TM    RCONDRF2,X'01'      IF XML ORDER                                 
         BNO   CONCNT20                                                         
*                                                                               
         TM    REFTYPN3,REFTXMLQ      SKIP IF EXCLUDING XML                     
         BO    CONCONT                                                          
*                                                                               
         TM    REFTYPN3,REFTTDRQ      KEEP IF EXCLUDING TRUE DARE               
         BO    CONCNTX                                                          
*                                                                               
         TM    REFTYPS3,REFTXMLQ      SKIP IF NOT INCLUDING XML                 
         BNO   CONCONT                                                          
*                                                                               
         B     CONCNTX                ELSE KEEP                                 
*                                                                               
CONCNT20 DS    0H                                                               
*                                                                               
         TM    RCONDRFG,X'04'+X'02' IF DARE BUT NOT XML (TRUE DARE)             
         BNZ   CONCNT30                                                         
*                                                                               
         TM    REFTYPN3,REFTTDRQ      SKIP IF EXCLUDING TRUE DARE               
         BO    CONCONT                                                          
*                                                                               
         TM    REFTYPN3,REFTXMLQ      KEEP IF EXCLUDING XML                     
         BO    CONCNTX                                                          
*                                                                               
         TM    REFTYPS3,REFTTDRQ      SKIP IF NOT INCLUDING TRUE DARE           
         BNO   CONCONT                                                          
*                                                                               
         B     CONCNTX                ELSE KEEP                                 
*                                                                               
CONCNT30 DS    0H                  NOT A DARE CONTRACT                          
*                                  SHOULDN'T GET HERE                           
         TM    REFTYPS3,REFTTDRQ+REFTXMLQ  SKIP IF INCLUDING TRUE DARE          
         BNZ   CONCONT                OR XML                                    
*                                                                               
         B     CONCNTX                ELSE KEEP                                 
*                                                                               
CONCNTX  DS    0H                                                               
*                                                                               
*MN                                READ THIS DARE ORDER NUMBER                  
         TM    RPTCON,INBPRST                                                   
         BO    *+12                                                             
         TM    RPTCON,ORDPRST                                                   
         BZ    CONMGO                                                           
                                                                                
         MVC   DARSTAT,RESPACES                                                 
         XC    DARORD,DARORD                                                    
         XC    DARINBOX,DARINBOX                                                
*                                                                               
         L     R6,REAIO                                                         
         USING RCONREC,R4          GET INFO FROM CONTRACT RECORD                
*                                                                               
         MVI   ELCODE,X'1D'        DARE AGENCY ORDER ELEMENT                    
         BRAS  RE,GETEL                                                         
         BNE   CONMGO              NO DARE ORDER #                              
*                                                                               
         USING RCONDREL,R6                                                      
*                                                                               
         MVC   REORD,RCONDRLK      SAVE OFF ORDER #                             
         MVC   DARORD,RCONDRLK                                                  
*                                                                               
         OC    DARORD,DARORD                                                    
         BZ    CONMGO                                                           
*                                                                               
         DROP  R6                                                               
*                                                                               
         L     R6,REAIO                                                         
         MVI   ELCODE,X'20'        DARE AGENCY SEND ELEMENT                     
         BRAS  RE,GETEL                                                         
         BNE   CONDAR20                                                         
*                                                                               
         USING RCONSEND,R6                                                      
*                                                                               
         MVC   DARVER#,RCONSRV     SAVE OFF REVISION #                          
*                                                                               
         MVC   WORK(L'RCONSRDT),RCONSRDT                                        
         MVC   WORK+L'RCONSRDT(L'RCONSRTI),RCONSRTI                             
         DROP  R6                                                               
                                                                                
         L     R6,REAIO                                                         
         CLI   RCONKSTA+4-RCONKEY(R6),C' '   DON'T DO THIS FOR RADIO            
         BNE   CONDAR20                                                         
                                                                                
         L     R6,REAIO                                                         
         USING RCONREC,R4          GET INFO FROM CONTRACT RECORD                
*                                                                               
         MVI   ELCODE,X'1D'        DARE AGENCY ORDER ELEMENT                    
         BRAS  RE,GETEL                                                         
         BNE   CONDAR20            NO DARE ORDER #                              
*                                                                               
         USING RCONDREL,R6                                                      
*                                                                               
         CLC   RCONDRDA,WORK       COMPARE DATE/TIME ORDER                      
         BH    CONDAR20               APPROVED TO SENT                          
         BL    CONDAR15                                                         
*                                                                               
         GOTO1 =V(HEXIN),DMCB,WORK+2,WORK+10,6                                  
*                                                                               
         CLC   RCONDRTA,WORK+10                                                 
         BH    CONDAR20                                                         
                                                                                
CONDAR15 MVI   DARVER#,C'S'                                                     
                                                                                
CONDAR20 EQU   *                                                                
         GOTO1 =A(DARGET),DMCB,(C'G',REORD)   PROCESS DARE ORDER                
                                                                                
****************************************************************                
*        4 (R2) = RDARBSTS                                                      
*        5 (R2) = RDARMISC                                                      
*        6 (R2) = RECORD TYPE (41 OR 51)                                        
*        7 (R2) = RDARRNUM (REVISION NUMBER)                                    
*        8 (R2) = RDARFLG1                                                      
*        9 (R2) = RCONSRV (REP VERSION NUMBER)                                  
*        10(R2) = RDARDELS (DELETE FLAGS)                                       
                                                                                
         CLI   DARRECTY,X'51'                                                   
         BNE   CONDAR50                                                         
         TM    DARMISC,X'80'+X'10'                                              
         BNZ   CONDAR50                                                         
         MVC   DARSTAT(6),=CL6'CNFRMD'                                          
         B     ODAREX                                                           
*                                                                               
CONDAR50 MVC   BYTE,DARFLG1        (RDARFLG1)                                   
         NI    BYTE,X'FF'-X'40'                                                 
         TM    DARMISC,X'20'       NOTDARE? (RDARMISC)                          
         BZ    *+8                                                              
         OI    BYTE,X'40'          NOT DARE (RDARFLG1)                          
*                                                                               
         LA    R6,DARSTAB2                                                      
CONDAR52 DS    0H                                                               
         CLI   0(R6),X'FF'                                                      
         BE    CONDAR60                                                         
         MVC   WORK(1),BYTE        RDARFLG1                                     
         NC    WORK(1),0(R6)                                                    
         BZ    CONDAR55                                                         
         LA    R6,1(R6)                                                         
         B     CONDAR80            POINT TO RESULT                              
CONDAR55 AHI   R6,2                                                             
         B     CONDAR52                                                         
*                                                                               
CONDAR60 DS    0H                                                               
         MVI   WORK,0                                                           
         CLI   DARREV#,0           RDARRNUM                                     
         BE    *+8                                                              
         MVI   WORK,1                                                           
*                                                                               
         MVC   WORK+1(1),DARBSTS   RDARBSTS                                     
         CLI   WORK+1,0                                                         
         BNE   CONDAR70                                                         
         TM    DARMISC,X'80'       RDARMISC                                     
         BZ    CONDAR70                                                         
         MVI   WORK+1,C'S'         MARK AS RESENT                               
*                                                                               
CONDAR70 DS    0H                                                               
         LA    R6,DARSTAB3                                                      
CONDAR72 DS    0H                                                               
         CLI   0(R6),X'FF'                                                      
         BE    CONDAR78                                                         
         CLC   WORK(2),0(R6)                                                    
         BNE   CONDAR75                                                         
         LA    R6,2(R6)                                                         
         B     CONDAR80                                                         
CONDAR75 DS    0H                                                               
         LA    R6,3(R6)                                                         
         B     CONDAR72                                                         
CONDAR78 DS    0H                                                               
         DC    H'0'                                                             
*                                                                               
CONDAR80 DS    0H                                                               
         LA    R1,DARSTAB1                                                      
CONDAR82 DS    0H                                                               
         CLI   0(R1),X'FF'                                                      
         BE    CONDAR85                                                         
         CLC   0(1,R6),0(R1)                                                    
         BE    CONDAR90                                                         
         LA    R1,7(R1)                                                         
         B     CONDAR82                                                         
CONDAR85 DS    0H                                                               
         DC    H'0'                                                             
*                                                                               
CONDAR90 DS    0H                                                               
         MVC   DARSTAT(6),1(R1)                                                 
*                                                                               
         LA    RF,DARPTR1                                                       
         CR    R1,RF                                                            
         BNL   ODAREX              NO NEED TO CHECK -S FLAG                     
                                                                                
         CLI   DARVER#,C'S'                                                     
         BNE   *+14                                                             
         MVC   DARSTAT+6(2),=CL2'-S'                                            
         B     ODAREX                                                           
                                                                                
         TM    DARFLG1,X'40'      -S?   RDARFLG1                                
         BZ    ODAREX                                                           
         OC    DARVER#,DARVER#                                                  
         BZ    ODAREX                                                           
                                                                                
         MVC   CCONVER#,DARVER#                                                 
         EDIT  CCONVER#,(2,DARSTAT+6),ZERO=NOBLANK,FILL=0                       
*                                                                               
         B     ODAREX                                                           
*                                                                               
CCONVER# DS    XL1                                                              
*                                                                               
DARSTAB1 DS    0C                                                               
         DC    X'01',C'OPENED'                                                  
         DC    X'02',C'AMNDED'                                                  
         DC    X'03',C'REVOPN'                                                  
         DC    X'04',C'REVAMD'                                                  
         DC    X'05',C'MATCH '                                                  
DARPTR1  DS    0C    ABOVE NEED TO LOOK AT -S FLAG                              
         DC    X'06',C'RECALL'                                                  
         DC    X'07',C'REJECT'                                                  
         DC    X'08',C'RESENT'                                                  
*                                                                               
         DC    X'09',C'REVREC'                                                  
         DC    X'10',C'REVREJ'                                                  
         DC    X'11',C'REVRES'                                                  
         DC    X'12',C'NTDARE'                                                  
         DC    X'14',C'PENCF '                                                  
         DC    X'15',C'STACF '                                                  
         DC    X'16',C'NEW   '                                                  
         DC    X'17',C'REVNEW'                                                  
         DC    X'18',C'CNFRMD'                                                  
         DC    X'FF'                                                            
*                                                                               
DARSTAB2 DS    0C                                                               
         DC    X'10',X'15'              STACF                                   
         DC    X'20',X'14'              PENDCF                                  
         DC    X'40',X'12'              NTDARE                                  
         DC    X'80',X'05'              MATCH                                   
         DC    X'FF'                                                            
*                                                                               
DARSTAB3 DS    0C                                                               
*              REV/ORG,STATUS                                                   
         DC    X'00',C'C',X'06'         RECALL                                  
         DC    X'00',C'A',X'01'         OPEN                                    
         DC    X'00',C'R',X'07'         REJECT                                  
         DC    X'00',C'M',X'02'         AMEND                                   
         DC    X'00',C'S',X'08'         RESENT                                  
         DC    X'00',X'00',X'16'        NEW                                     
*                                                                               
         DC    X'01',C'C',X'09'         REVREC                                  
         DC    X'01',C'A',X'03'         REVOPN                                  
         DC    X'01',C'R',X'10'         REVREJ                                  
         DC    X'01',C'M',X'04'         REVAMD                                  
         DC    X'01',C'S',X'11'         REVRES                                  
         DC    X'01',X'00',X'17'        REVNEW                                  
         DC    X'FF'                                                            
*                                                                               
ODAREX   DS    0H                                                               
****************************************************************                
                                                                                
         XC    ELEMWORK,ELEMWORK              BUILD DUMMY ELEMENT THAT          
         MVI   ELEMWORK,X'DA'                 CONTAINS ALL DARE INFO            
         SR    R4,R4                                                            
         LA    R4,DARINFOQ                                                      
         LA    R4,2(R4)                                                         
         STC   R4,ELEMWORK+1                                                    
         MVC   ELEMWORK+2(DARINFOQ),DARINFO                                     
         L     R3,REAIO                       CALC ADDR OF END OF REC           
         SR    R4,R4                                                            
         ICM   R4,3,27(R3)                                                      
         AR    R4,R3                                                            
         GOTO1 VRECUP,DMCB,(C'R',(R3)),ELEMWORK,(C'R',(R4))                     
                                                                                
         XC    ELEMWORK,ELEMWORK              BUILD DUMMY ELEMENT THAT          
         MVI   ELEMWORK,X'DB'                 CONTAINS ALL DARE INFO            
         MVI   ELEMWORK+1,X'05'                                                 
         MVC   ELEMWORK+2(L'DARINBOX),DARINBOX                                  
         L     R3,REAIO                       CALC ADDR OF END OF REC           
         SR    R4,R4                                                            
         ICM   R4,3,27(R3)                                                      
         AR    R4,R3                                                            
         GOTO1 VRECUP,DMCB,(C'R',(R3)),ELEMWORK,(C'R',(R4))                     
                                                                                
CONMGO   EQU   *                                                                
         TM    RPTCON,MGOPRST                                                   
         BZ    CONMGO10                                                         
                                                                                
         GOTO1 =A(MGOGET),DMCB               TOTAL ACTIVE MAKEGOODS             
         XC    ELEMWORK,ELEMWORK             AND ADD DUMMY ELEMENT              
         MVI   ELEMWORK,X'DC'                TO CONREC                          
         MVI   ELEMWORK+1,X'06'                                                 
         ZAP   ELEMWORK+2(L'MKGCNT),MKGCNT                                      
         L     R3,REAIO                      CALC ADDR OF END OF REC            
         SR    R4,R4                                                            
         ICM   R4,3,27(R3)                                                      
         AR    R4,R3                                                            
         GOTO1 VRECUP,DMCB,(C'R',(R3)),ELEMWORK,(C'R',(R4))                     
                                                                                
CONMGO10 EQU   *                                                                
*MN                                                                             
         NI    RECNTRL,X'FF'-RECRTRNQ   TURN OFF RETURN SWITCH                  
*                                                                               
         BAS   RE,GOHOOK           PASS RECORD TO DRIVER                        
*                                                                               
         TM    RECNTRL,RECRTRNQ    TEST IF NEED TO RETURN FOR MORE DATA         
         BO    CONHOOKM                                                         
*                                                                               
         LA    R2,4(R2)            BUMP TO NEXT DATE IN LIST                    
*                                                                               
         CLI   REQDTYPE,C'W'       IF WEEKS                                     
         BNE   *+8                                                              
         LA    R2,2(R2)               BUMP 2 MORE POSITIONS                     
*                                                                               
         OC    0(4,R2),0(R2)       DONE AT END OF LIST                          
         BZ    CONHOOKX                                                         
*                                                                               
         BCT   R0,CONHOOKL                                                      
*                                                                               
CONHOOKX DS    0H                                                               
*MNTEST                                                                         
*        TM    REFTYPS3,REFTBSPQ                                                
*        BO    CONBUYLP                                                         
         TM    REFTYPS3,REFTBCDQ+REFTBT1Q+REFTBT2Q  IF BUYS NEEDED              
         BNZ   CONBUYLP                                                         
*MNTEST                                                                         
*                                                                               
CONBUYDN DS    0H                                                               
*                                                                               
CONCONT  DS    0H                                                               
*                                                                               
         MVC   KEYSAVE,KEY         COPY START OF SEQUENCE                       
*                                                                               
         BAS   RE,SEQ                                                           
*                                                                               
         B     CONLOOP             GET NEXT RECORD                              
*                                                                               
CONCNSKP DS    0H                                                               
*                                                                               
*        RE-BUILD SEARCH KEY                                                    
*                                                                               
         MVI   RCONKTYP,RCONKTYQ   RECORD TYPE                                  
         MVC   RCONKREP,REREP      REP                                          
*                                                                               
         MVC   RCONKGRP,REGRS      GROUP/SUBGROUP (MAY BE NULLS)                
         MVC   RCONKSTA,RESTA      STATION        (MAY BE NULLS)                
         MVC   RCONKOFF,REOFF      OFFICE         (MAY BE NULLS)                
         MVC   RCONKAGY,REAGY      AGENCY         (MAY BE NULLS)                
         MVC   RCONKAOF,REAOF      AGENCY OFFICE  (MAY BE NULLS)                
         MVC   RCONKADV,READV      ADVERTISER     (MAY BE NULLS)                
         MVC   RCONKCON,RECON      CONTRACT       (MAY BE NULLS)                
*                                                                               
         BAS   RE,HIGH             SKIP READ                                    
         B     CONLOOP             GET NEXT RECORD                              
*                                                                               
CONDONE  DS    0H                                                               
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - FILELISTS'                      
***********************************************************************         
*                                                                     *         
*        IF FILE LISTING READ APPROPRIATE RECORDS                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         TM    REALL2,REALSTAQ     SKIP IF NOT STATION FILE LISTING             
         JNO   *+8                                                              
         BRAS  RE,STLIST              GO LIST STATIONS                          
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE -CREPCONT'                        
***********************************************************************         
*                                                                     *         
*        FIND NEXT REP                                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
CREPCONT DS    0H                                                               
*                                                                               
         ICM   R2,15,REREPTBA      SKIP IF NO REP TABLE                         
         BZ    CREPDONE                                                         
*                                                                               
         USING REPTTABD,R2         ESTABLISH REP TABLE                          
*                                                                               
         ICM   R3,15,REPTENTA      POINT TO CURRENT TABLE ENTRY                 
         BZ    CREPDONE                                                         
*                                                                               
         USING REPTENT,R3          ESTABLISH TABLE ENTRY                        
*                                                                               
         A     R3,BSPLENR-BSPPRMS+REPTBSRP BUMP TO NEXT ENTRY                   
*                                                                               
         B     CREPLOOP                                                         
*                                                                               
CREPDONE DS    0H                                                               
*                                                                               
         XC    REPTENTA,REPTENTA   INDICATE END OF TABLE REACHED                
         MVC   REREPTA,REPTENTA                                                 
*                                                                               
         ICM   RF,15,REUTLA        IF UTL ADDRESS AVAILABLE                     
         JZ    *+16                                                             
         MVC   RESE,REQSE             RESTORE STARTING SE NUMBER                
         MVC   4(1,RF),REQSE                                                    
*                                                                               
CREPREPX DS    0H                                                               
*                                                                               
CONX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
CONCURSB DS    XL2                 YM - START DATE IF NO DATELIST               
CONCUREB DS    XL2                 YM - END   DATE IF NO DATELIST               
*                                                                               
ELEMWORK DS    CL(DARINFOQ+2)                                                   
*                                                                               
         DROP                                                                   
*                                                                               
*MN                                                                             
         TITLE 'RENWRIO - REPWRITER IO MODULE -DARE'                            
***********************************************************************         
*                                                                     *         
*        READ DARE RECORDS                                            *         
*                                                                     *         
***********************************************************************         
DARGET   NTR1  BASE=*,LABEL=*                                                   
DARE     EQU   *                                                                
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         MVC   SVREAIO,REAIO                                                    
         MVC   SVLKEY,LKEY                                                      
         MVI   LKEY,27                                                          
*                                                                               
         USING RAGY2KEY,R4         ESTABLISH CONTRACT BASE KEY                  
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         MVI   RAGK2TYP,RAGK2TYQ   RECORD TYPE                                  
         MVC   RAGK2AGY,REAGY      AGENCY         (MAY BE NULLS)                
         MVC   RAGK2AOF,REAOF      AGENCY OFFICE  (MAY BE NULLS)                
         MVC   RAGK2REP,REREP      REP                                          
*                                                                               
         BAS   RE,HIGH                                                          
         BAS   RE,KEYCOMP                                                       
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   REAIO,REAIO4                                                     
         BAS   RE,GETREC           READ DARE RECORD                             
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
         CLI   RAGY2CDE,RAGY2CDQ   SAVE OFF DARE AGENCY CODES                   
         BNE   DARDONE                                                          
         MVC   DARAGYOF,RAGY2DAR                                                
*                                                                               
         LA    R5,DARAGYOF                                                      
         LA    R6,4                                                             
*                                                                               
DREPLOOP DS    0H                  PROCESS CONTRACT RECS FOR A REP              
         LA    R2,RECONKEY                                                      
         L     R3,REAIO                                                         
         OC    0(5,R5),0(R5)                                                    
         BZ    DARDONE                                                          
         CLC   0(5,R5),SPACES                                                   
         BE    DARDONE                                                          
                                                                                
         USING RDARKEY,R4          ESTABLISH CONTRACT BASE KEY                  
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         MVI   RDARKTYP,RDARKTYQ   RECORD TYPE                                  
         MVC   RDARKREP,RECONKEY+(RCONKREP-RCONKEY)                             
         MVC   RDARKSTA(L'RDARKSTA-1),RECONKEY+(RCONKSTA-RCONKEY)               
         CLI   RDARKSTA+4,C' '                                                  
         BNE   *+8                                                              
         MVI   RDARKSTA+4,C'T'                                                  
         MVI   RDARKSTA+5,C' '                                                  
         MVC   RDARKAGY,0(R5)      AGENCY                                       
         MVC   RDARKAOF,3(R5)      AGENCY OFFICE                                
         MVC   RDARKORD,DARORD     DARE ORDER NUMBER                            
         MVI   RDARKRT,X'10'       AGENCY HEADER RECORD                         
*                                                                               
         BAS   RE,HIGH                                                          
         BAS   RE,KEYCOMP                                                       
         BE    DARKEYOK                                                         
*                                                                               
         MVC   KEY,KEYSAVE                                                      
         MVI   RDARKTYP,X'51'      TRY READ CONFIRMED                           
         BAS   RE,HIGH                                                          
         BAS   RE,KEYCOMP                                                       
         BE    DARKEYOK                                                         
*                                                                               
DREP10   LA    R5,5(R5)                                                         
         BCT   R6,DREPLOOP                                                      
         B     DARDONE                                                          
*                                                                               
DARKEYOK DS    0H                                                               
         MVC   REAIO,REAIO4                                                     
         BAS   RE,GETREC           READ DARE RECORD                             
*                                                                               
*TEST                                                                           
*        L     R4,REAIO            POINT TO FOUND RECORD                        
*        CLC   DARORD,=XL4'40370000'                                            
*        BNE   *+6                                                              
*        DC    H'0'                                                             
*TEST                                                                           
         USING RDARREC,R4          ESTABLISH RECORD                             
         L     R4,REAIO            POINT TO FOUND RECORD                        
         LR    R6,R4                                                            
         MVI   ELCODE,X'0F'                                                     
         BRAS  RE,GETEL                                                         
         BNE   *+10                                                             
         USING RDARFLEM,R6                                                      
DREP15   MVC   DARFLG1,RDARFLG1                                                 
         DROP  R6                                                               
*                                                                               
         USING RDARREC,R4          ESTABLISH RECORD                             
         L     R4,REAIO            POINT TO FOUND RECORD                        
         LR    R6,R4                                                            
         MVI   ELCODE,X'01'                                                     
         BRAS  RE,GETEL                                                         
         BNE   DAR020                                                           
*                                                                               
         USING RDARELEM,R6                                                      
         MVC   DARBSTS,RDARBSTS                                                 
         MVC   DARMISC,RDARMISC                                                 
         MVC   DARRECTY,KEY                                                     
         MVC   DARREV#,RDARRNUM                                                 
         MVC   DARDELS,RDARDELS                                                 
*                                                                               
DAR020   EQU   *                                                                
         L     R4,REAIO            POINT TO FOUND RECORD                        
         LR    R6,R4                                                            
         MVI   ELCODE,X'0A'                                                     
         BRAS  RE,GETEL                                                         
         BNE   DARDONE                                                          
         USING RDARPPEL,R6                                                      
         MVC   DARINBOX,RDARPPSP                                                
*                                                                               
DARDONE  DS    0H                                                               
*        RESTORE ORIGINAL CON KEYS AND SEQUENCE                                 
         MVC   REAIO,SVREAIO                                                    
         MVC   KEY,RECONKEY                                                     
         BAS   RE,READ                                                          
         MVC   LKEY,SVLKEY                                                      
*                                                                               
DARX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
SVLKEY   DS    XL1                                                              
*                                                                               
DARINFO  DS    0C                                                               
DARSTAT  DS    CL8                                                              
DARORD   DS    XL4                                                              
DARINFOQ EQU   *-DARINFO                                                        
*                                                                               
DARBSTS  DS    XL1                                                              
DARMISC  DS    XL1                                                              
DARRECTY DS    XL1                                                              
DARREV#  DS    XL1                                                              
DARFLG1  DS    XL1                                                              
DARVER#  DS    XL1                                                              
DARDELS  DS    XL1                                                              
*                                                                               
DARINBOX DS    CL3                                                              
*                                                                               
DARAGYOF DS    0CL20                                                            
DARAGY1  DS    CL3                                                              
DARAGYO1 DS    CL2                                                              
DARAGY2  DS    CL3                                                              
DARAGYO2 DS    CL2                                                              
DARAGY3  DS    CL3                                                              
DARAGYO3 DS    CL2                                                              
DARAGY4  DS    CL3                                                              
DARAGYO4 DS    CL2                                                              
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE -MGOGET'                          
***********************************************************************         
*                                                                     *         
*        READ DARE RECORDS                                            *         
*                                                                     *         
***********************************************************************         
MGOGET   NTR1  BASE=*,LABEL=*                                                   
MGO      EQU   *                                                                
*                                                                               
         ZAP   MKGCNT,=P'0'                                                     
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         MVC   SVREAIO,REAIO                                                    
         USING RMKGKEY,R4          ESTABLISH CONTRACT BASE KEY                  
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         MVI   RMKGKTYP,RMGOKTYQ                                                
         MVC   RMKGKREP,RECONKEY+(RCONKREP-RCONKEY)                             
         MVC   RMKGKOFF,RECONKEY+(RCONKOFF-RCONKEY)                             
         MVC   RMKGKSTA,RECONKEY+(RCONKSTA-RCONKEY)                             
*                                                                               
         LA    R6,RECONKEY+(RCONKCON-RCONKEY)                                   
         ZAP   WORK+10(5),=P'0'                                                 
         MVO   WORK+10(5),0(4,R6)                                               
         ZAP   WORK+5(5),=P'99999999'                                           
         SP    WORK+5(5),WORK+10(5) GET 9'S COMPLEMENT                          
         MVO   WORK(5),WORK+5(5)   CHANGE TO PWOS                               
         MVC   RMKGKCON,WORK                                                    
         PACK  RMKGKCON+0(1),WORK+3(1)                                          
         PACK  RMKGKCON+1(1),WORK+2(1)                                          
         PACK  RMKGKCON+2(1),WORK+1(1)                                          
         PACK  RMKGKCON+3(1),WORK+0(1)                                          
*                                                                               
         BAS   RE,HIGH                                                          
MKG020   CLC   KEYSAVE(RMKGKGRP-RMKGKEY),KEY                                    
         BNE   MKGX                                                             
*                                                                               
         OC    KEY+21(6),KEY+21                                                 
         BNZ   MKG040                                                           
*                                                                               
         MVC   REAIO,REAIO4                                                     
         BAS   RE,GETREC           READ MAKEGOOD RECORD                         
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
         USING RMKGREC,R4          ESTABLISH RECORD                             
*                                                                               
         CLI   RMKGSECD,X'01'                                                   
         BE    *+6                                                              
         DC    H'0'                                                             
         TM    RMKGSCST,RMKGSAPQ                                                
         BO    MKG040                                                           
         TM    RMKGSCST,RMKGSCNQ                                                
         BO    MKG040                                                           
*TEST                                                                           
*        LA    R6,RECONKEY+(RCONKCON-RCONKEY)                                   
*        CLC   0(4,R6),=XL4'03867167'                                           
*        BNE   *+6                                                              
*        DC    H'0'                                                             
*        CLC   0(4,R6),=XL4'03867168'                                           
*        BNE   *+6                                                              
*        DC    H'0'                                                             
*TEST                                                                           
         AP    MKGCNT,=P'1'                                                     
MKG040   BAS   RE,SEQ                                                           
         B     MKG020                                                           
*                                                                               
MKGX     DS    0H                                                               
         MVC   REAIO,SVREAIO                                                    
         MVC   KEY,RECONKEY                                                     
         BAS   RE,READ                                                          
         XIT1                                                                   
         LTORG                                                                  
*                                                                               
MKGCNT   DC    PL4'0'                                                           
SVREAIO  DS    F                                                                
*                                                                               
         DROP                                                                   
*MN                                                                             
         TITLE 'RENWRIO - REPWRITER IO MODULE -BUY'                             
***********************************************************************         
*                                                                     *         
*        READ BUYS FOR CONTRACT                                       *         
*                                                                     *         
*        READ BUYS FOR CONTRACT BASED ON BUY CODE PASSIVES            *         
*        ALTER CONTRACT RECORD TO REFLECT CONTRIBUTION OF BUYS        *         
*           FOR BUY CODE                                              *         
*                                                                     *         
*        RETURN WITH FIRST/NEXT ALTERED CONTRACT RECORD               *         
*                                                                     *         
*NTRY    REIO1  CONTRACT RECORD                                       *         
*                                                                     *         
*EXIT    CC EQ  REBCD - CURRENT BUY CODE                              *         
*               REBT1 - CURRENT BUY TYPE 1                            *         
*               REBT2 - CURRENT BUY TYPE 2                            *         
*               CONTRACT RECORD REFLECTS CONTRIBUTION OF BUYS         *         
*                  FOR BUY CODE                                       *         
*        CC NEQ END OF BUY CODES                                      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
BUY      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         L     R5,REAIO1           ESTABLISH CONTRACT RECORD                    
         USING RCONREC,R5                                                       
*                                                                               
         MVC   BUYKEYSV,KEY        SAVE CURRENT KEY                             
         MVC   BUYAIOSV,REAIO      SAVE CURRENT AIO                             
*                                                                               
******   OC    REBCD,REBCD         IF FIRST TIME                                
******   BNZ   BUYCLRX                                                          
*                                                                               
*        CLEAR OUT CONTRACT RECORD                                              
*              X'03' ELEMENTS - CONTRACT BUCKET ELEMENTS                        
*              X'04' ELEMENTS - CONTRACT STATION AMOUNT ELEMENTS                
*                                                                               
         LA    R6,RCONELEM         POINT TO 1ST ELM IN CONREC                   
*                                                                               
BUYCLRLP DS    0H                                                               
*                                                                               
         USING RCONBKEL,R6         ESTABLISH BUCKET ELEMENT                     
*                                                                               
         CLI   RCONBKCO,X'00'      DONE AT END OF RECORD                        
         BE    BUYCLRDN                                                         
*                                                                               
         CLI   RCONBKCO,X'03'      WANT X'03' ELMS                              
         BE    *+8                                                              
         CLI   RCONBKCO,X'04'      OR   X'04' ELMS                              
         BNE   BUYCLRCN            ELSE GET NEXT ELEMENT                        
*                                                                               
         GOTO1 VRECUP,DMCB,(C'R',RCONREC),(0,(R6)),0 DELETE ELM                 
*                                                                               
         B     BUYCLRLP            GO TO NEXT ELEMENT                           
*                                                                               
BUYCLRCN DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         IC    RF,RCONBKLN         GET ELEMENT LENGTH                           
         LA    R6,RCONBKEL(RF)     BUMP TO NEXT ELEMENT                         
         B     BUYCLRLP                                                         
*                                                                               
BUYCLRDN DS    0H                                                               
*                                                                               
BUYCLRX  DS    0H                                                               
*MNTEST                                                                         
         TM    REFTYPS3,REFTBCDQ+REFTBT1Q+REFTBT2Q                              
         BNZ   BUYBCDL1                                                         
         XC    KEY,KEY             ESTABLISH BUY KEY                            
         LA    R4,KEY                                                           
         USING RBUYREC,R4                                                       
*                                                                               
*        BUILD BUY KEY                                                          
*                                                                               
         MVI   RBUYKTYP,X'0B'     SET PASSIVE ID                                
         MVC   RBUYKREP,REREP      SET REP                                      
         MVC   FULL,RCONKCON                                                    
         GOTO1 (RFCONNUM,VREPFACS),DMCB,(1,FULL),(3,RBUYKCON)                   
*                                                                               
         MVC   REAIO,REAIO2        READ BUYS INTO IO2                           
         GOTO1 HIGH                READ FIRST BUY RECORD                        
*                                                                               
BSPLP01  DS    0H                                                               
         CLC   RBUYKEY(22),KEYSAVE  ON CHG IN BUY CODE                          
         BNE   BUYDONE                DONE                                      
         TM    RBUYKEY+27,X'80'    IGNORE DELETED RECORDS                       
         BO    BSPLP02                                                          
*                                                                               
         GOTO1 GETREC              READ IN BUY RECORD                           
         L     R4,REAIO            POINT TO FOUND RECORD                        
*              MOVE BUY DATA TO CONTRACT RECORD                                 
*              GOTOX ALLOWS RFBUCKUP TO BE PASSED                               
         GOTOX (RFBUCKUP,VREPFACS),DMCB,RBUYREC,(2,RCONREC),           X        
               REACOMFC,GETBROAD,VRECUP,BUYWORK                                 
         BE    *+6                                                              
         DC    H'0'                MUST UPDATE CORRECTLY                        
*                                                                               
BSPLP02  DS    0H                                                               
*                                                                               
         LA    R4,KEY              RE-POINT TO KEY                              
         GOTO1 SEQ                 NEXT BUY RECORD                              
*                                                                               
         B     BSPLP01                                                          
*                                                                               
*MNTEST                                                                         
*        FIND FIRST/NEXT BUY CODE TO HANDLE                                     
*                                                                               
BUYBCD   DS    0H                                                               
*                                                                               
BUYBCDL1 DS    0H                                                               
*                                                                               
         XC    REBT1,REBT1         INIT BUY TYPES                               
         XC    REBT2,REBT2                                                      
*                                                                               
         GOTO1 =A(BCDGET),DMCB,(C'N',REBCD),(C'B',0)  NEXT BUY CODE             
         BNZ   BUYBCDD1            NO MORE BUY CODES                            
*                                                                               
         ICM   R3,15,REBCDTA       ESTABLISH BUY CODE TABLE ENTRY               
         BZ    BUYBCD10                                                         
*                                                                               
         USING BCDTENT,R3          ESTABLISH BUY CODE TABLE ENTRY               
*                                                                               
         LA    R2,RSPCTYPS-RSPBELEM+BCDTELM   POINT TO BUY TYPES                
*                                                                               
         OC    REFBT1,REFBT1       IF FILTERING ON BTYPE1                       
         BZ    *+14                                                             
         CLC   REFBT1,0(R2)           MUST MATCH ON FIRST BUY TYPE              
         BNE   BUYBCDL1                                                         
*                                                                               
         OC    REFBT2,REFBT2       IF FILTERING ON BTYPE2                       
         BZ    *+14                                                             
         CLC   REFBT2,2(R2)           MUST MATCH ON SECOND BUY TYPE             
         BNE   BUYBCDL1                                                         
*                                                                               
         OC    0(L'REBT1,R2),0(R2) SKIP IF NO TYPE 1 CODE                       
         BZ    BUYBCD02                                                         
*                                                                               
         GOTO1 =A(BCDGET),DMCB,(C'G',0(R2)),(C'1',0)  BUY TYPE 1                
*                                                                               
BUYBCD02 DS    0H                                                               
*                                                                               
         OC    2(L'REBT1,R2),2(R2) SKIP IF NO TYPE 2 CODE                       
         BZ    BUYBCD04                                                         
*                                                                               
         GOTO1 =A(BCDGET),DMCB,(C'G',2(R2)),(C'2',0)  BUY TYPE 2                
*                                                                               
BUYBCD04 DS    0H                                                               
*                                                                               
         L     RF,REAIO2           INIT IOAREA                                  
         XC    0(256,RF),0(RF)                                                  
*                                                                               
BUYBCD10 DS    0H                                                               
*                                                                               
         XC    KEY,KEY             ESTABLISH BUY KEY                            
         LA    R4,KEY                                                           
         USING RBUYREC,R4                                                       
*                                                                               
*        BUILD PASSIVE FOR BUY CODE                                             
*                                                                               
         MVC   RBY3KTYP(2),=X'9B01'   SET PASSIVE ID                            
         MVC   RBY3KREP,REREP      SET REP                                      
         MVC   RBY3KCOD,REBCD      SET BUY CODE                                 
         MVC   RBY3KCON,RCONKCON   SET CONTRACT NUMBER                          
*                                                                               
         MVC   REAIO,REAIO2        READ BUYS INTO IO2                           
*                                                                               
         GOTO1 HIGH                READ FIRST BUY RECORD                        
*                                                                               
BUYLOOP  DS    0H                                                               
*                                                                               
         CLC   RBY3KEY(RBY3KCBL-RBY3KEY),KEYSAVE  ON CHG IN BUY CODE            
         BNE   BUYDONE                DONE                                      
*                                                                               
         TM    RBY3KEY+27,X'80'    IGNORE DELETED RECORDS                       
         BO    BUYCONT                                                          
*                                                                               
         GOTO1 GETREC              READ IN BUY RECORD                           
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
*                                                                               
*        MOVE BUY DATA TO CONTRACT RECORD                                       
*                                                                               
*              GOTOX ALLOWS RFBUCKUP TO BE PASSED                               
*                                                                               
         GOTOX (RFBUCKUP,VREPFACS),DMCB,RBUYREC,(2,RCONREC),           X        
               REACOMFC,GETBROAD,VRECUP,BUYWORK                                 
         BE    *+6                                                              
         DC    H'0'                MUST UPDATE CORRECTLY                        
*                                                                               
BUYCONT  DS    0H                                                               
*                                                                               
         LA    R4,KEY              RE-POINT TO KEY                              
         GOTO1 SEQ                 NEXT BUY RECORD                              
*                                                                               
         B     BUYLOOP                                                          
*                                                                               
BUYDONE  DS    0H                                                               
*                                                                               
*        FIX UP THE ASAT DATES IN THE BUCKETS                                   
*                                                                               
         L     R4,REAIO2           POINT TO FOUND BUYRECS                       
*                                                                               
         CLI   RBUYKTYP,RBUYKTYQ      SKIP IF NO BUYS FOUND                     
         BNE   BUYAADDN                                                         
*                                                                               
         L     R2,REANWMON         POINT TO 1ST MONTH TABLE AREA                
         USING NWMNTABD,R2         ESTABLISH MONTH TABLE AREA                   
*                                                                               
         LA    R6,RCONELEM         POINT TO 1ST ELM IN CONREC                   
*                                                                               
BUYAADLP DS    0H                                                               
*                                                                               
         USING RCONBKEL,R6         ESTABLISH BUCKET ELEMENT                     
*                                                                               
         CLI   RCONBKCO,X'00'      DONE AT END OF RECORD                        
         BE    BUYAADDN                                                         
*                                                                               
         CLI   RCONBKCO,X'03'      WANT X'03' ELMS                              
         BNE   BUYAADCN            ELSE GET NEXT ELEMENT                        
*                                                                               
         CLC   RCONBKYR(2),RECURSTB     BUCKET MONTH OF SERVICE EARLIER         
*                                          THAN REPORT REQUEST PERIOD?          
         BL    BUYAAD40                 YES - ASAT = TODAY, LAST YEAR           
*                                                                               
         MVC   RCONBKWK,NWMTMFRC        NO  - ASAT = TODAY, THIS YEAR           
*                                                                               
         B     BUYAADCN                                                         
*                                                                               
BUYAAD40 EQU   *                                                                
*                                                                               
         MVC   RCONBKWK,NWMTMFRC+2      ASAT = TODAY, LAST YEAR                 
*                                                                               
BUYAADCN DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         IC    RF,RCONBKLN         GET ELEMENT LENGTH                           
         LA    R6,RCONBKEL(RF)     BUMP TO NEXT ELEMENT                         
         B     BUYAADLP                                                         
*                                                                               
BUYAADDN DS    0H                                                               
*                                                                               
         MVC   KEY,BUYKEYSV        RESTORE CURRENT KEY                          
         MVC   REAIO,BUYAIOSV      RESTORE CURRENT REAIO                        
*                                                                               
         GOTO1 HIGH                RESTORE FILE POINTERS                        
*                                                                               
         CR    RB,RB               SET EQ CC                                    
*                                                                               
         B     BUYX                                                             
*                                                                               
BUYBCDDN DS    0H                                                               
*                                                                               
         MVC   KEY,BUYKEYSV        RESTORE CURRENT KEY                          
         MVC   REAIO,BUYAIOSV      RESTORE CURRENT REAIO                        
*                                                                               
         GOTO1 HIGH                RESTORE FILE POINTERS                        
*                                                                               
BUYBCDD1 DS    0H                                                               
*                                                                               
         LTR   RB,RB               SET NEQ CC                                   
*                                                                               
         B     BUYX                                                             
*                                                                               
BUYX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
BUYKEYSV DS    XL(L'KEY)           CURRENT KEY SAVEAREA                         
BUYAIOSV DS    XL4                 CURRENT AIO                                  
BUYWORK  DS    XL256               WORKAREA                                     
         DROP                                                                   
*                                                                               
         EJECT                                                                  
         TITLE 'RENWRIO - REPWRITER IO MODULE -RGON'                            
***********************************************************************         
*                                                                     *         
*        FIND RGON DATA                                               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
RGON     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
*        FIND FIRST REP                                                         
*                                                                               
         ICM   R2,15,REREPTBA      SKIP IF NO REP TABLE                         
         BZ    RREPREPX                                                         
*                                                                               
         USING REPTTABD,R2         ESTABLISH REP TABLE                          
*                                                                               
         ICM   R3,15,BSPATAB-BSPPRMS+REPTBSRP  1ST ENTRY IN TABLE               
         BZ    RREPREPX             NO TABLE                                    
         USING REPTENT,R3                                                       
*                                                                               
RREPLOOP DS    0H                  PROCESS RGON RECS FOR A REP                  
*                                                                               
         OC    REPTENT(REPTENTL),REPTENT  TEST FOR END OF TABLE                 
         BZ    RREPDONE                                                         
*                                                                               
         ST    R3,REPTENTA         SET CURRENT TABLE ENTRY ADDRESS              
*                                                                               
         TM    REPTKEY+27,X'80'    SKIP IF DELETED                              
         BO    RREPCONT                                                         
*                                                                               
         MVC   REREPTA,REPTENTA    RETURN A(GROUP TABLE ENTRY)                  
*                                                                               
         OC    REXFREP(REXFREPL),REXFREP IF CROSS-FILE REPORTING                
         BZ    *+10                                                             
         OC    REFGRP,REFGRP       IF FILTERING ON GROUP                        
         BZ    *+10                                                             
         MVC   REFGRP,REPTGRP         SET SPECIAL GROUP CODE                    
*                                                                               
         CLC   =X'FFFF',RREPMAST-RREPELEM+REPTELM  BYPASS MASTER REP            
         BE    RREPCONT                                                         
*                                                                               
         MVC   REREP,RREPKREP-RREPKEY+REPTKEY   RETURN REP                      
         MVC   RESE,REPTSE         RETURN REP'S SE CODE                         
*                                                                               
         ICM   RF,15,REUTLA        POINT TO UTL                                 
         JZ    *+18                SKIP IF NOT AVAILABLE                        
         CLI   REPTSE,0            SKIP IF NOT AVAILABLE                        
         BE    *+10                                                             
         MVC   4(1,RF),REPTSE      SET SE NUMBER                                
*                                                                               
         XC    REMREP,REMREP       INIT MASTER REP                              
*                                                                               
         LA    R4,REPTELM          ESTABLISH REP DECRIPTION ELEMENT             
         USING RREPELEM,R4                                                      
*                                                                               
         CLC   =C'NU',REREP        SPECIAL FOR REP 'NU'                         
         BNE   *+14                                                             
         MVC   REMREP,=C'K3'                                                    
         B     RREPMRPX                                                         
*                                                                               
         CLC   RREPMAST,=CL4' '    SKIP IF NO MASTER REP                        
         BE    RREPMRPX                                                         
*                                                                               
         OC    RREPMAST,RREPMAST   SKIP IF NO MASTER REP                        
         BZ    RREPMRPX                                                         
*                                                                               
         CLC   RREPMAST,=4X'FF'    IF MASTER REP                                
         BNE   *+14                                                             
         MVC   REMREP,REREP           SAVE CURRENT REP AS MASETER REP           
         B     RREPMRPX                                                         
*                                                                               
         MVC   REMREP,RREPMAST     ELSE SAVE MASTER REP                         
*                                                                               
RREPMRPX DS    0H                                                               
*                                                                               
         BRAS  RE,TABS             LOAD REP'S TABLES                            
*                                                                               
         BRAS  RE,STA              LOAD REP'S STATIONS TO TABLE                 
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE -  RRGLOOP'                       
***********************************************************************         
*                                                                     *         
*        READ RGON DATA FOR REP                                       *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
*                                                                               
*        INIT CURRENT VALUES OF ALL KEY FIELDS                                  
*                                                                               
         XC    RECODES(RECURDAT-RECODES),RECODES INIT CURRENT VALUES            
*                                                                               
*        SET UP TABLE FOR PROCESSING RGON DATATYPES                             
*                                                                               
         LA    R4,RERRGWRC         POINT TO RRGWRI CONTROL BLOCK                
         USING RRGWRI,R4           ESTABLISH CONTROL BLOCK                      
*                                                                               
         MVC   RRGWREP,REREP       SET REP CODE                                 
*                                                                               
         LA    R1,RRGWDT1          POINT TO FIRST DATATYPE                      
*                                                                               
         LA    R2,RRGTABLE         POINT TO FIRST DATATYPE TABLE ENTRY          
         USING RRGTENTD,R2         ESTABLISH TABLE ENTRY                        
*                                                                               
         LA    R0,8                MAX EIGHT ENTRIES                            
*                                                                               
         XC    RRGTENTD(RRGTENTL),RRGTENTD INIT FIRST TABLE ENTRY               
*                                                                               
RRGTBLLP DS    0H                                                               
*                                                                               
         CLI   0(R1),0             END OF DATATYPES                             
         BE    RRGTBLDN                                                         
*                                                                               
RRGSTD   DS    0H                                                               
*                                                                               
         L     R9,=A(STDPRMS)      POINT TO TABLE OF PARAMETERS                 
         USING STDPRMSD,R9         ESTABLISH ENTRY IN PARMS TABLE               
*                                                                               
RRGSTDLP DS    0H                                                               
*                                                                               
*        FIND APPLICABLE ENTRY IN TABLE                                         
*                                                                               
         CLI   STDPRID,X'FF'       AT END OF TABLE                              
         BE    RRGSTDDN               DONE                                      
*                                                                               
         CLC   STDPRID,0(R1)       FIND CORRECT ENTRY IN TABLE                  
         BE    RRGSTDFD                                                         
*                                                                               
RRGSTDCN DS    0H                                                               
*                                                                               
         LA    R9,STDPRMSD+STDPRMSL BUMP TO NEXT TABLE ENTRY                    
         B     RRGSTDLP                                                         
*                                                                               
RRGSTDFD DS    0H                                                               
*                                                                               
         ST    R1,RRGTDATA         A(DATATYPE FILTER AREA)                      
*                                                                               
         MVC   RRGTDTP,0(R1)       SAVE DATATYPE                                
*                                                                               
         ST    R9,RRGTSTDA         A(STANDARD TABLE ENTRY)                      
*                                                                               
         LA    R2,RRGTENTL(R2)     BUMP TO NEXT TABLE ENTRY                     
         XC    RRGTENTD(RRGTENTL),RRGTENTD  INIT NEXT ENTRY                     
*                                                                               
RRGSTDDN DS    0H                                                               
*                                                                               
RRGTBLCN DS    0H                                                               
*                                                                               
         LA    R1,L'RRGWDT1+L'RRGWDA1(R1) BUMP TO NEXT DATATYPE                 
*                                                                               
         BCT   R0,RRGTBLLP                                                      
*                                                                               
RRGTBLDN DS    0H                                                               
*                                                                               
         CLI   REFSTTP,0           SKIP IF NO STATION TYPE FILTER               
         BE    RRGSTTPX                                                         
*                                                                               
         TM    REFSTTP,RESTTPCQ    IF COMPARABLE STATIONS                       
         BNO   *+16                                                             
         MVI   0(R1),RSTPKTYQ         SET FOR STATION TYPE DATA                 
         MVI   L'RRGWDT1(R1),C'1'     SET DATA TO 1                             
         B     RRGSTTPX                                                         
*                                                                               
         TM    REFSTTP,RESTTPNQ    IF NEW        STATIONS                       
         BNO   *+16                                                             
         MVI   0(R1),RSTPKTYQ         SET FOR STATION TYPE DATA                 
         MVI   L'RRGWDT1(R1),C'2'     SET DATA TO 2                             
         B     RRGSTTPX                                                         
*                                                                               
         TM    REFSTTP,RESTTPOQ    IF OLD         TATIONS                       
         BNO   *+16                                                             
         MVI   0(R1),RSTPKTYQ         SET FOR STATION TYPE DATA                 
         MVI   L'RRGWDT1(R1),C'3'     SET DATA TO 3                             
         B     RRGSTTPX                                                         
*                                                                               
RRGSTTPX DS    0H                                                               
*                                                                               
*        FILL IN STARTING VALUES FOR RRGWRI                                     
*                                                                               
         LA    R2,RRGTABLE         ESTABLISH RRG TABLE                          
         USING RRGTENTD,R2                                                      
*                                                                               
RRGINILP DS    0H                                                               
*                                                                               
         CLI   RRGTDTP,0           DONE AT END OF TABLE                         
         BE    RRGINIDN                                                         
*                                                                               
         L     R9,RRGTSTDA         POINT TO STANDARD TABLE ENTRY                
         USING STDPRMSD,R9                                                      
*                                                                               
         L     RF,RRGTDATA         POINT TO FILTER AREA                         
         LA    RF,L'RRGWDT1(RF)    POINT TO FILTER VALUE                        
*                                                                               
         XC    0(L'RRGWDA1,RF),0(RF)   INIT FILTER                              
*                                                                               
         GOTO1 STDPGETA,DMCB,(C'N',0(RF))  SET INITIAL/NEXT VALUE               
*                                                                               
         L     R1,STDPCVLA         POINT TO CURRENT VALUE                       
         LA    R1,RENWRIOD(R1)     RE-LOCATE ADDRESS                            
*                                                                               
         L     RE,RRGTDATA         POINT TO FILTER AREA                         
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,STDPCVLL       CURRENT VALUE LENGTH                         
         BZ    *+6                 NONE FOUND                                   
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   L'RRGWDT1(0,RE),0(R1) PASS VALUE AS FILTER TO RRGWRI             
*                                                                               
RRGINICN DS    0H                                                               
*                                                                               
         LA    R2,RRGTENTL(R2)     BUMP TO NEXT DATATYPE                        
         B     RRGINILP                                                         
*                                                                               
RRGINIDN DS    0H                                                               
*                                                                               
*        FILL IN FILTERS IN RRGWRI CONTROL BLOCK                                
*                                                                               
         MVC   RRGWID,=C'**WRIT**' IDENTIFY CONTROL BLOCK                       
*                                                                               
         MVC   RRGWSTDT,REYMSTRP   REQUEST START DATE                           
*                                                                               
         TM    REQCFOPT,REQCFYTQ   IF YTD IN PLAY                               
         BNO   *+10                                                             
         MVC   RRGWSTDT,REQYTDSB      USE YTD START DATE                        
*                                                                               
         MVC   RRGWEDDT,REYMENDP   REQUEST END   DATE                           
*                                                                               
         MVI   RRGWOFFL,C'Y'       PASS OFFLINE INDICATOR                       
*                                                                               
         MVI   RRGWCNTL,0          SET CONTROL BYTE                             
         MVI   RRGWSTAT,0                                                       
         MVI   RRGWERR,0                                                        
*                                                                               
         MVC   RRGWPRNT,=V(PRINT)                                               
         MVC   RRGWSTAD,REAIO3     A(STATION I/OAREA)                           
*                                                                               
         CLI   RETRACE,C'Y'        SKIP IF NOT TRACING                          
         BNE   RRGRRG05                                                         
*                                                                               
         GOTO1 =A(RRGTRA)          TRACE RRGWRI CONTROL BLOCK                   
*                                                                               
RRGRRG05 DS    0H                                                               
*                                                                               
RRGLOOP  DS    0H                                                               
*                                                                               
RRGRRGLP DS    0H                                                               
*                                                                               
         MVI   RRGWSTAT,0                                                       
         MVI   RRGWERR,0                                                        
*                                                                               
         GOTO1 RENRGWRA,DMCB,RERRGWRC  GOTO RGON                                
*                                                                               
         CLI   RETRACE,C'Y'        SKIP IF NOT TRACING                          
         BNE   RRGRRG10                                                         
*                                                                               
         GOTO1 =A(RRGTRA)          TRACE RRGWRI CONTROL BLOCK                   
*                                                                               
RRGRRG10 DS    0H                                                               
*                                                                               
         CLI   RRGWSTAT,X'FF'      CHECK FOR END OF FILE                        
         BE    RRGRRGDN                                                         
*                                                                               
         CLI   RRGWERR,0           CHECK FOR ERRORS                             
         BNE   RRGRRGDN                                                         
*                                                                               
*        FIND RECORDS OR TABLE ENTRY FOR FOUND DATA                             
*                                                                               
         LA    R2,RRGTABLE         ESTABLISH RRG TABLE                          
         USING RRGTENTD,R2                                                      
         LA    R6,RRGWDAT1         DATA FOUND BY RGON                           
*                                                                               
RRGFLLLP DS    0H                                                               
*                                                                               
         CLI   RRGTDTP,0           DONE AT END OF TABLE                         
         BE    RRGFLLDN                                                         
*                                                                               
         L     R9,RRGTSTDA         POINT TO STANDARD TABLE ENTRY                
         USING STDPRMSD,R9                                                      
*                                                                               
         L     R1,STDPCVLA         POINT TO CURRENT VALUE                       
         LA    R1,RENWRIOD(R1)     RE-LOCATE ADDRESS                            
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,STDPCVLL       CURRENT VALUE LENGTH                         
         BZ    *+6                 NONE FOUND                                   
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   0(0,R1),0(R6)       CHECKS IF DATA CHANGED FROM BEFORE           
         BE    RRGFLLCN                                                         
*                                                                               
         GOTO1 STDPGETA,DMCB,(C'G',0(R6))  GET TABLE OR RECORD                  
*                                                                               
RRGFLLCN DS    0H                                                               
*                                                                               
         LA    R2,RRGTENTL(R2)     BUMP TO NEXT DATATYPE                        
         LA    R6,L'RRGWDAT1(R6)   NEXT FOUND DATA AREA                         
         B     RRGFLLLP                                                         
*                                                                               
RRGFLLDN DS    0H                                                               
*                                                                               
*        DETERMINE DATE PERIOD FOR RETURNED DATA                                
*                                                                               
         MVC   RRGCURSB,REYMSTRP   DEFAULT TO WHOLE PERIOD                      
*                                                                               
         TM    REQCFOPT,REQCFYTQ   IF YTD IN PLAY                               
         BNO   *+10                                                             
         MVC   RRGCURSB,REQYTDSB      USE YTD START                             
*                                                                               
         MVC   RRGCUREB,REYMENDP                                                
*                                                                               
         LA    R2,RRGCURSB                                                      
         LA    R0,1                DEFAULT TO 1 TIME TO DRIVER                  
*                                                                               
         L     R5,REDLSTA             POINT TO DATE LISTS                       
         USING DATELSTD,R5            ESTABLISH DATELISTS                       
*                                                                               
         SR    RF,RF                                                            
*                                                                               
         CLI   REQDTYPE,C'W'       IF WEEKS                                     
         BNE   *+16                                                             
         LA    R2,WEEKLSTB            USE BINARY WEEK  LIST                     
         LA    R0,104                 MAX 104 ENTRIES                           
         B     RRGHOOKX               NOT COVERED BY RRG                        
*                                                                               
         CLI   REQDTYPE,C'M'       IF MONTHS                                    
         BNE   *+20                                                             
         LA    R2,MNTHLSTB            USE BINARY MONTH LIST                     
         LA    R0,50                  MAX 50 ENTRIES                            
         IC    RF,YTDADJM             YTD LIST ADJUSTMENT FACTOR                
         B     RRGDTPR1                                                         
*                                                                               
         CLI   REQDTYPE,C'Q'       IF QUARTERS                                  
         BNE   *+20                                                             
         LA    R2,QURTLIST            USE QUARTER      LIST                     
         LA    R0,16                  MAX 16 ENTRIES                            
         IC    RF,YTDADJQ             YTD LIST ADJUSTMENT FACTOR                
         B     RRGDTPR1                                                         
*                                                                               
         CLI   REQDTYPE,C'S'       IF SEMI-ANNUAL                               
         BNE   *+20                                                             
         LA    R2,SEMILIST            USE SEMI-YEAR    LIST                     
         LA    R0,8                   MAX  8 ENTRIES                            
         IC    RF,YTDADJS             YTD LIST ADJUSTMENT FACTOR                
         B     RRGDTPR1                                                         
*                                                                               
         CLI   REQDTYPE,C'Y'       IF YEARS                                     
         BNE   *+20                                                             
         LA    R2,YEARLIST            USE YEARS        LIST                     
         LA    R0,4                   MAX  4 ENTRIES                            
         IC    RF,YTDADJY             YTD LIST ADJUSTMENT FACTOR                
         B     RRGDTPR1                                                         
*                                                                               
RRGDTPR1 DS    0H                                                               
*                                                                               
******   LTR   RF,RF               ADJUST LIST START BY YTD FACTOR              
******   BZ    RRGDTPR2            NO FACTOR                                    
******                                                                          
******   LA    R2,4(R2)            BUMP UP 1 TABLE ENTRY                        
******   BCT   RF,*-4                                                           
*                                                                               
RRGDTPR2 DS    0H                                                               
*                                                                               
*        FIND RETURNED DATE IN LIST                                             
*                                                                               
RRGDTPRL DS    0H                                                               
*                                                                               
         CLC   RRGWYRMO,0(R2)      AFTER START DATE                             
         BL    RRGDTPRD                                                         
         CLC   RRGWYRMO,2(R2)      BEFORE END DATE                              
         BNH   RRGDTPRF                                                         
*                                                                               
RRGDTPRC DS    0H                                                               
*                                                                               
         LA    R2,4(R2)            NEXT DATE RANGE IN LIST                      
         BCT   R0,RRGDTPRL                                                      
*                                                                               
RRGDTPRD DS    0H                                                               
*                                                                               
         B     RRGHOOKX            NOT COVERED BY LIST                          
*                                                                               
RRGDTPRF DS    0H                                                               
*                                                                               
         MVC   RECURSTB(2),0(R2)   SET START AND END OF PERIOD                  
         MVI   RECURSTB+2,0                                                     
         MVC   RECURENB(2),2(R2)   SET START AND END OF PERIOD                  
         MVI   RECURENB+2,0                                                     
*                                                                               
*        HOOK TO DRIVER FOR PROCESSING                                          
*                                                                               
RRGHOOK  DS    0H                                                               
*                                                                               
         NI    RECNTRL,X'FF'-RECRTRNQ   TURN OFF RETURN SWITCH                  
*                                                                               
         TM    REQCSTAT,REQCSCFQ   IF CONFIRMED DOLLARS ONLY                    
         BNO   *+8                                                              
         MVI   RRGWDTY,C'C'           FLAG FOR CONFIRMED ONLY                   
*                                                                               
         BAS   RE,GOHOOK           PASS RECORD TO DRIVER                        
*                                                                               
         TM    RECNTRL,RECRTRNQ    TEST IF NEED TO RETURN FOR MORE DATA         
         BO    RRGHOOK                                                          
*                                                                               
RRGHOOKX DS    0H                                                               
*                                                                               
RRGRRGCN DS    0H                                                               
         B     RRGRRGLP                                                         
*                                                                               
RRGRRGDN DS    0H                                                               
*                                                                               
RRGCONT  DS    0H                                                               
*                                                                               
*        FIND NEXT VALUES FOR DATATYPES                                         
*                                                                               
         LA    R2,RRGTABLE+7*RRGTENTL  ESTABLISH LAST ENTRY IN TABLE            
         USING RRGTENTD,R2                                                      
*                                                                               
         LA    R0,8                MAX NUMBER OF ENTRIES                        
*                                                                               
RRGCNLP  DS    0H                                                               
*                                                                               
         CLI   RRGTDTP,0           SKIP IF NO DATATYPE                          
         BE    RRGCNCN                                                          
*                                                                               
         L     RF,RRGTDATA         POINT TO FILTER AREA                         
*                                                                               
         CLC   L'RRGWDT1(L'RRGWDA1,RF),SPACES  SKIP IF NO VALUE                 
         BNH   RRGCNCN                                                          
*                                                                               
         LA    RF,L'RRGWDT1(RF)    POINT TO VALUE                               
*                                                                               
         L     R9,RRGTSTDA         POINT TO STANDARD TABLE ENTRY                
         USING STDPRMSD,R9                                                      
*                                                                               
         GOTO1 STDPGETA,DMCB,(C'N',0(RF))  SET NEXT VALUE                       
*                                                                               
         L     R1,STDPCVLA         POINT TO CURRENT VALUE                       
         LA    R1,RENWRIOD(R1)     RE-LOCATE ADDRESS                            
*                                                                               
         L     RE,RRGTDATA         POINT TO FILTER AREA                         
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,STDPCVLL       CURRENT VALUE LENGTH                         
         BZ    *+6                 NONE FOUND                                   
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   L'RRGWDT1(0,RE),0(R1) PASS VALUE AS FILTER TO RRGWRI             
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   L'RRGWDT1(0,RE),=16X'FF' DONE IF NOT AT END OF TABLE             
         BNE   RRGCNDN                                                          
         B     RRGCNCN                                                          
*                                                                               
RRGCNCN  DS    0H                                                               
*                                                                               
         AHI   R2,-RRGTENTL        BACK UP TO NEXT DATATYPE                     
         BCT   R0,RRGCNLP                                                       
*                                                                               
         B     RRGDONE             END OF REP                                   
*                                                                               
RRGCNDN  DS    0H                                                               
*                                                                               
RRGNXTLP DS    0H                                                               
*                                                                               
         LA    R2,RRGTENTL(R2)     BUMP TO NEXT ENTRY IN TABLE                  
         AHI   R0,1                RESTORE COUNTER                              
*                                                                               
         CLI   RRGTDTP,0           DONE IF END OF TABLE                         
         BE    RRGNXTDN                                                         
*                                                                               
         L     RE,RRGTDATA         POINT TO FILTER AREA                         
         XC    L'RRGWDT1(L'RRGWDA1,RE),L'RRGWDT1(RE)  INIT FILTER               
*                                                                               
         L     R9,RRGTSTDA         POINT TO STANDARD TABLE ENTRY                
         USING STDPRMSD,R9                                                      
*                                                                               
         L     R1,STDPCVLA         POINT TO CURRENT VALUE                       
         LA    R1,RENWRIOD(R1)     RE-LOCATE ADDRESS                            
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,STDPCVLL       CURRENT VALUE LENGTH                         
         BZ    *+6                 NONE FOUND                                   
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         XC    0(0,R1),0(R1)       INIT CURRENT VALUE OF FILTER                 
*                                                                               
         LA    RF,L'RRGWDT1(RE)    POINT TO NXT FILTER AREA                     
         GOTO1 STDPGETA,DMCB,(C'N',0(RF))  GET NEXT FILTER VALUE                
*                                                                               
         L     R1,STDPCVLA         POINT TO CURRENT VALUE                       
         LA    R1,RENWRIOD(R1)     RE-LOCATE ADDRESS                            
*                                                                               
         L     RE,RRGTDATA         POINT TO FILTER AREA                         
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,STDPCVLL       CURRENT VALUE LENGTH                         
         BZ    *+6                 NONE FOUND                                   
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   L'RRGWDT1(0,RE),0(R1)  PASS VALUE AS FILTER TO RRGWRI            
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   L'RRGWDT1(0,RE),=16X'FF'  RECYCLE IF AT END OF TABLE             
         BE    RRGCNCN                                                          
*                                                                               
RRGNXTCN DS    0H                                                               
*                                                                               
         B     RRGNXTLP                                                         
*                                                                               
RRGNXTDN DS    0H                                                               
*                                                                               
         B     RRGLOOP             NEXT CALL TO RRGWRI                          
*                                                                               
RRGDONE  DS    0H                                                               
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - FILELISTS'                      
***********************************************************************         
*                                                                     *         
*        IF FILE LISTING READ APPROPRIATE RECORDS                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         TM    REALL2,REALSTAQ     SKIP IF NOT STATION FILE LISTING             
         JNO   *+8                                                              
         BRAS  RE,STLIST              GO LIST STATIONS                          
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE -RREPCONT'                        
***********************************************************************         
*                                                                     *         
*        FIND NEXT REP                                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RREPCONT DS    0H                                                               
*                                                                               
         ICM   R2,15,REREPTBA      SKIP IF NO REP TABLE                         
         BZ    RREPDONE                                                         
*                                                                               
         USING REPTTABD,R2         ESTABLISH REP TABLE                          
*                                                                               
         ICM   R3,15,REPTENTA      POINT TO CURRENT TABLE ENTRY                 
         BZ    RREPDONE                                                         
*                                                                               
         USING REPTENT,R3          ESTABLISH TABLE ENTRY                        
*                                                                               
         A     R3,BSPLENR-BSPPRMS+REPTBSRP BUMP TO NEXT ENTRY                   
*                                                                               
         NI    RESTCNTL,X'FF'-RESTCFTQ NEW REP MEANS TABLE MISSING              
*                                              ITS STATIONS                     
         B     RREPLOOP                                                         
*                                                                               
RREPDONE DS    0H                                                               
*                                                                               
         XC    REPTENTA,REPTENTA   INDICATE END OF TABLE REACHED                
         MVC   REREPTA,REPTENTA                                                 
*                                                                               
         ICM   RF,15,REUTLA        IF UTL ADDRESS AVAILABLE                     
         JZ    *+16                                                             
         MVC   RESE,REQSE             RESTORE STARTING SE NUMBER                
         MVC   4(1,RF),REQSE                                                    
*                                                                               
RREPREPX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
RRGCURSB DS    XL2                 YM - START DATE IF NO DATELIST               
RRGCUREB DS    XL2                 YM - END   DATE IF NO DATELIST               
*                                                                               
         DS    0D                                                               
RRGTABLE DS    XL(9*RRGTENTL)      RRG RABLE                                    
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - FLT'                            
***********************************************************************         
*                                                                     *         
*        READ CONTRACT RECORDS BASED ON FLIGHT DATES                  *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
FLT      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
*        FIND FIRST REP                                                         
*                                                                               
         ICM   R2,15,REREPTBA      SKIP IF NO REP TABLE                         
         BZ    FREPREPX                                                         
*                                                                               
         USING REPTTABD,R2         ESTABLISH REP TABLE                          
*                                                                               
         ICM   R3,15,BSPATAB-BSPPRMS+REPTBSRP  1ST ENTRY IN TABLE               
         BZ    FREPREPX             NO TABLE                                    
*                                                                               
         USING REPTENT,R3                                                       
*                                                                               
FREPLOOP DS    0H                  PROCESS CONTRACT RECS FOR A REP              
*                                                                               
         OC    REPTENT(REPTENTL),REPTENT  TEST FOR END OF TABLE                 
         BZ    FREPDONE                                                         
*                                                                               
         ST    R3,REPTENTA         SET CURRENT TABLE ENTRY ADDRESS              
*                                                                               
         TM    REPTKEY+27,X'80'    SKIP IF DELETED                              
         BO    FREPCONT                                                         
*                                                                               
         MVC   REREPTA,REPTENTA    RETURN A(GROUP TABLE ENTRY)                  
*                                                                               
         OC    REXFREP(REXFREPL),REXFREP IF CROSS-FILE REPORTING                
         BZ    *+10                                                             
         OC    REFGRP,REFGRP       IF FILTERING ON GROUP                        
         BZ    *+10                                                             
         MVC   REFGRP,REPTGRP         SET SPECIAL GROUP CODE                    
*                                                                               
         MVC   REREP,RREPKREP-RREPKEY+REPTKEY   RETURN REP                      
         MVC   RESE,REPTSE         RETURN REP'S SE CODE                         
*                                                                               
         ICM   RF,15,REUTLA        POINT TO UTL                                 
         JZ    *+18                SKIP IF NOT AVAILABLE                        
         CLI   REPTSE,0            SKIP IF NOT AVAILABLE                        
         BE    *+10                                                             
         MVC   4(1,RF),REPTSE      SET SE NUMBER                                
*                                                                               
         XC    REMREP,REMREP       INIT MASTER REP                              
*                                                                               
         LA    R4,REPTELM          ESTABLISH REP DECRIPTION ELEMENT             
         USING RREPELEM,R4                                                      
*                                                                               
         CLC   =C'NU',REREP        SPECIAL FOR REP 'NU'                         
         BNE   *+14                                                             
         MVC   REMREP,=C'K3'                                                    
         B     FREPMRPX                                                         
*                                                                               
         CLC   RREPMAST,=CL4' '    SKIP IF NO MASTER REP                        
         BE    FREPMRPX                                                         
*                                                                               
         OC    RREPMAST,RREPMAST   SKIP IF NO MASTER REP                        
         BZ    FREPMRPX                                                         
*                                                                               
         CLC   RREPMAST,=4X'FF'    IF MASTER REP                                
         BNE   *+14                                                             
         MVC   REMREP,REREP           SAVE CURRENT REP AS MASETER REP           
         B     FREPMRPX                                                         
*                                                                               
         MVC   REMREP,RREPMAST     ELSE SAVE MASTER REP                         
*                                                                               
FREPMRPX DS    0H                                                               
*                                                                               
         BRAS  RE,TABS             FILL SREP'S TABS                             
*                                                                               
         BRAS  RE,STA              ADD REP'S STATIONS TO FILE                   
*                                                                               
***********************************************************************         
*                                                                     *         
*        READ CONTRACT RECORDS FOR REP USING 8E PASSIVE POINTER       *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING RCONKEY,R4          ESTABLISH CONTRACT BASE KEY                  
*                                                                               
*        INIT CURRENT VALUES OF ALL KEY FIELDS                                  
*                                                                               
         XC    RESTA,RESTA         STATION                                      
*                                                                               
*        FIND STARTING VALUES FOR KEY FIELDS                                    
*                                                                               
         GOTO1 =A(STGET),DMCB,(C'N',RESTA)    FIND FIRST STATION                
*                                                                               
*        FILL IN CONTRACT 8E KEY                                                
*                                                                               
         MVI   RCON8ETP,X'8E'      RECORD TYPE                                  
         MVC   RCON8ERP,REREP      REP                                          
         MVC   RCON8EST,RESTA      STATION        (MAY BE NULLS)                
*                                                                               
*        TRY TO SET A STARTING DATE FOR FILE READS                              
*                                                                               
*        BASED ON FACT THAT NO CONTRACT IS LONGER THAN 1 YEAR                   
*                                                                               
         TM    REFDTTYP,REFDPR2Q   READ EVERYTHING IF 2YR PRIOR NEEDED          
         BO    FLTKYDTX                                                         
*                                                                               
         TM    REFDTTYP,REFDPRIQ   IF PRIOR DATA NEEDED                         
         BNO   *+28                                                             
         MVC   RCON8EFS,REFPR2ST      USE PRIOR 2 YR START                      
         TM    REQCFOPT,REQCFYTQ      IF YTD OPTION IN PLAY                     
         BNO   *+10                                                             
         MVC   RCON8EFS,REFYP2ST      USE YTD PRIOR 2 YR START                  
         B     FLTKYDTX                                                         
*                                                                               
         TM    REFDTTYP,REFDCURQ   IF CURRENT DATA NEEDED                       
         BNO   *+28                                                             
         MVC   RCON8EFS,REFPRIST      USE PRIOR START                           
         TM    REQCFOPT,REQCFYTQ      IF YTD OPTION IN PLAY                     
         BNO   *+10                                                             
         MVC   RCON8EFS,REFYPRST      USE YTD PRIOR START                       
         B     FLTKYDTX                                                         
*                                                                               
         TM    REFDTTYP,REFDNXTQ   IF NEXT YR DATA NEEDED                       
         BNO   *+28                                                             
         MVC   RCON8EFS,REFCURST      USE CURRENT START                         
         TM    REQCFOPT,REQCFYTQ      IF YTD OPTION IN PLAY                     
         BNO   *+10                                                             
         MVC   RCON8EFS,REFYCRST      USE YTD CURRENT START                     
         B     FLTKYDTX                                                         
*                                                                               
FLTKYDTX DS    0H                                                               
*                                                                               
         MVC   FLTSTRSV,RCON8EFS   SAVE STARTING DATE                           
*                                                                               
         BAS   RE,FIRSTHI          READ FIRST RECORD                            
*                                                                               
FLTLOOP  DS    0H                                                               
*                                                                               
*        CHECK FOR MAJOR CHANGES IN KEY                                         
*                                                                               
         CLI   RCON8ETP,X'8E'     DONE IF NOT AN 8E POINTER                     
         BNE   FLTDONE                                                          
*                                                                               
FLTREP   DS    0H                                                               
*                                                                               
         CLC   RCON8ERP,RCON8ERP-RCONKEY+KEYSAVE IF REP CHANGED                 
         BNE   FLTDONE                              DONE                        
*                                                                               
FLTSTA   DS    0H                                                               
*                                                                               
         MVC   FLTSTASV,RESTA      SAVE CURRENT STATION                         
*                                                                               
         CLC   RCON8EST,RESTA      IF STATION CHANGES                           
         BE    FLTSTAOK                                                         
*                                                                               
         GOTO1 =A(STGET),DMCB,(C'G',RCON8EST)    FIND NEXT STATION              
*                                                                               
         CLC   RESTA,RCON8EST      SKIP IF DEFAULT NOT USED                     
         BNE   FLTSKIP                GO RESET KEY                              
*                                                                               
FLTSTAOK DS    0H                                                               
*                                                                               
         MVI   REPERTYP,0          INIT PERIOD TYPE                             
*                                                                               
FLTDTS   DS    0H                  FILTER ON FLIGHT DATES                       
*                                                                               
         CLC   RCON8EFE,FLTSTRSV   SKIP IF START DATE NOT REACHED               
         BL    FLTSKIP                                                          
*                                                                               
         TM    REFDTTYP,REFDPR2Q   SKIP IF 2YR PRIOR DATA NOT NEEDED            
         BNO   FLTDPR2X                                                         
*                                                                               
         CLC   RCON8EFS,REFPR2EN   IF DATES OVERLAP 2YR PRIOR PERIOD            
         BH    FLTDPR2X                                                         
*                                                                               
         TM    REQCFOPT,REQCFYTQ   SKIP IF YTD OPTION IN PLAY                   
         BO    *+18                                                             
         CLC   RCON8EFE,REFPR2ST                                                
         BNL   FLTDPR2Y               KEEP RECORD                               
         B     FLTDPR2X                                                         
*                                  COMPARE TO YTD START DATE                    
         CLC   RCON8EFE+3(3),REFYP2ST                                           
         BL    FLTDPR2X                                                         
*                                                                               
FLTDPR2Y DS    0H                  KEEP CONTRACT                                
*                                                                               
         OI    REPERTYP,REPRPR2Q   PRIOR 2 YEAR CONTRACT                        
*                                                                               
         B     FLTDTSOK                                                         
*                                                                               
*                                                                               
FLTDPR2X DS    0H                                                               
*                                                                               
         TM    REFDTTYP,REFDPRIQ   SKIP IF PRIOR DATA NOT NEEDED                
         BNO   FLTDPRIX                                                         
*                                                                               
         CLC   RCON8EFS,REFPRIEN   IF DATES OVERLAP PRIOR  PERIOD               
         BH    FLTDPRIX                                                         
*                                                                               
         TM    REQCFOPT,REQCFYTQ   SKIP IF YTD OPTION IN PLAY                   
         BO    *+18                                                             
         CLC   RCON8EFE,REFPRIST                                                
         BNL   FLTDPRIY               KEEP RECORD                               
         B     FLTDPRIX                                                         
*                                  COMPARE TO YTD START DATE                    
         CLC   RCON8EFE,REFYPRST                                                
         BL    FLTDPRIX                                                         
*                                                                               
FLTDPRIY DS    0H                  KEEP CONTRACT                                
*                                                                               
         OI    REPERTYP,REPRPRIQ   PRIOR YEAR CONTRACT                          
*                                                                               
         B     FLTDTSOK                                                         
*                                                                               
FLTDPRIX DS    0H                                                               
*                                                                               
         CLC   RCON8EFS,REFCUREN  IF DATES OVERLAP CURRENT PERIOD               
         BH    FLTDCURX                                                         
*                                                                               
         TM    REQCFOPT,REQCFYTQ   SKIP IF YTD OPTION IN PLAY                   
         BO    *+18                                                             
         CLC   RCON8EFE,REFCURST                                                
         BNL   FLTDCURY               KEEP RECORD                               
         B     FLTDCURX                                                         
*                                  COMPARE TO YTD START DATE                    
         CLC   RCON8EFE,REFYCRST                                                
         BL    FLTDCURX                                                         
*                                                                               
FLTDCURY DS    0H                  KEEP CONTRACT                                
*                                                                               
         OI    REPERTYP,REPRCURQ   CURRENT YEAR CONTRACT                        
*                                                                               
         B     FLTDTSOK                                                         
*                                  COMPARE TO YTD START DATE                    
FLTDCURX DS    0H                                                               
*                                                                               
         TM    REFDTTYP,REFDNXTQ   SKIP IF NEXT DATA NOT NEEDED                 
         BNO   FLTDNXTX                                                         
*                                                                               
         CLC   RCON8EFS,REFNXTEN   IF DATES OVERLAP NEXT PERIOD                 
         BH    FLTDNXTX                                                         
*                                                                               
         TM    REQCFOPT,REQCFYTQ   SKIP IF YTD OPTION IN PLAY                   
         BO    *+18                                                             
         CLC   RCON8EFE,REFNXTST                                                
         BNL   FLTDNXTY               KEEP RECORD                               
         B     FLTDNXTX                                                         
*                                  COMPARE TO YTD START DATE                    
         CLC   RCON8EFE,REFYNXST                                                
         BL    FLTDNXTX                                                         
*                                                                               
FLTDNXTY DS    0H                  KEEP CONTRACT                                
*                                                                               
         OI    REPERTYP,REPRNXTQ   NEXT YEAR CONTRACT                           
*                                                                               
         B     FLTDTSOK                                                         
*                                  COMPARE TO YTD START DATE                    
*                                                                               
FLTDNXTX DS    0H                                                               
*                                                                               
*        CONTRACT DOES NOT OVERLAP ANY PERIOD                                   
*                                                                               
*        IF START DATE PAST ALL RANGES                                          
*           SKIP TO NEXT STATION                                                
*                                                                               
         CLC   RCON8EFS,REFCUREN   IF START DATE AFTER CURRENT END              
         BNH   FLTDTSX                                                          
*                                                                               
         TM    REFDTTYP,REFDNXTQ   SKIP IF NEXT DATA NOT NEEDED                 
         BNO   *+14                                                             
         CLC   RCON8EFS,REFNXTEN   AND NEXT YEAR END                            
         BNH   FLTDTSX                                                          
*                                                                               
******   XC    FLTSTASV,FLTSTASV   FORCE NEW STATION                            
*                                                                               
         B     FLTSKIP             SKIP TO NEXT STATION                         
*                                                                               
FLTDTSX  DS    0H                                                               
         B     FLTCONT             READ NEXT KEY ON FILE                        
*                                                                               
FLTDTSOK DS    0H                                                               
*                                                                               
         MVC   RECON,RCON8ECN      DEFAULT TO NEW CONTRACT NUMBER               
*                                                                               
         OC    REFCON,REFCON       SKIP IF NOT FILTERING ON CONTRACT #          
         BZ    FLTCONOK                                                         
*                                                                               
         CLC   RCON8ECN,REFCON     CHECK CONTRACT NUMBER                        
         BNE   FLTCONT                                                          
*                                                                               
FLTCONOK DS    0H                                                               
*                                                                               
*        ANALYZE SUB TYPE 1 KEY                                                 
*                                                                               
FLTSTP1  DS    0H                  KEY SUB-ID                                   
*                                                                               
         CLI   RCON8EID,1          SKIP IF NOT KEY TYPE 1                       
         BNE   FLTSTP1X                                                         
*                                                                               
FLTAGY   DS    0H                                                               
*                                                                               
         CLC   RCON8EAG(L'REAGY),REAGY   IF AGENCY        CHANGES               
         BNE   *+10                                                             
         CLC   RCON8EAG+L'REAGY(L'REAOF),REAOF OR AOF CHANGES                   
         BE    FLTAGYOK                                                         
*                                                                               
         NI    REAGCNTL,X'FF'-REAGCFDQ TURN OFF FOUND SWITCH                    
*                                                                               
         TM    REAGCNTL,REAGCFTQ      IF AGY NOT FILTERED                       
         BO    *+20                                                             
         MVC   REAGY,RCON8EAG            USE DEFAULT                            
         MVC   REAOF,RCON8EAG+L'REAGY    USE DEFAULT                            
         B     FLTAGYOK                                                         
*                                                                               
         GOTO1 =A(AGYGET),DMCB,(C'G',RCON8EAG)  FIND NEXT AGENCY                
*                                                                               
         CLC   REAGY,RCON8EAG      DROP IF DEFAULT NOT USED                     
         BNE   FLTCONT                                                          
*                                                                               
         CLC   REAOF,RCON8EAG+L'REAGY    DROP IF DEFAULT NOT USED               
         BNE   FLTCONT                                                          
*                                                                               
FLTAGYOK DS    0H                                                               
*                                                                               
FLTADV   DS    0H                                                               
*                                                                               
         CLC   RCON8EAV,READV     IF ADVERTISER CHANGES                         
         BE    FLTADVOK                                                         
*                                                                               
         NI    READCNTL,X'FF'-READCFDQ TURN OFF FOUND SWITCH                    
*                                                                               
         TM    READCNTL,READCFTQ      IF ADV NOT FILTERED                       
         BO    *+14                                                             
         MVC   READV,RCON8EAV            USE DEFAULT                            
         B     FLTADVOK                                                         
*                                                                               
         GOTO1 =A(ADVGET),DMCB,(C'G',RCON8EAV) FIND NEXT ADVERTISER             
*                                                                               
         CLC   READV,RCON8EAV      DROP IF DEFAULT NOT USED                     
         BNE   FLTCONT                                                          
*                                                                               
FLTADVOK DS    0H                                                               
*                                                                               
         BAS   RE,SEQ              READ NEXT POINTER                            
         CLI   RCON8EID,1          REPEAT IF WE DON'T FIND NEW RECTYPE          
         BE    *-8                                                              
*                                                                               
FLTSTP1X DS    0H                                                               
*                                                                               
*        ANALYZE SUB TYPE 2 KEY                                                 
*                                                                               
FLTSTP2  DS    0H                                                               
*                                                                               
         CLI   RCON8EID,2          SKIP IF NOT KEY TYPE 2                       
         BNE   FLTSTP2X                                                         
*                                                                               
FLTSAL   DS    0H                                                               
*                                                                               
         CLC   RESAL,RCON8ESP      OKAY IF SALESPERSON NOT CHANGED              
         BE    FLTSALOK                                                         
*                                                                               
         L     R9,=A(STDPSAL)      POINT TO TABLE PARAMETERES                   
*                                                                               
         GOTO1 =A(SALGET),DMCB,(C'G',RCON8ESP) FIND NEXT SALESPERSON            
*                                                                               
         CLC   RESAL,RCON8ESP      DROP IF DEFAULT NOT USED                     
         BNE   FLTCONT                                                          
*                                                                               
FLTSALOK DS    0H                                                               
*                                                                               
FLTCTY   DS    0H                                                               
*                                                                               
         CLC   RECTY,RCON8ECP      OKAY IF CON TYPE NOT CHANGED                 
         BE    FLTCTYOK                                                         
*                                                                               
         L     R9,=A(STDPCTY)      POINT TO TABLE PARAMETERES                   
*                                                                               
         GOTO1 =A(CTYGET),DMCB,(C'G',RCON8ECP) FIND NEXT CON TYPE               
*                                                                               
         CLC   RECTY,RCON8ECP      DROP IF DEFAULT NOT USED                     
         BNE   FLTCONT                                                          
*                                                                               
FLTCTYOK DS    0H                                                               
*                                                                               
FLTGRS   DS    0H                                                               
*                                                                               
         CLC   REGRS,RCON8EGS      OKAY IF GRP/SGRP NOT CHANGED                 
         BE    FLTGRSOK                                                         
*                                                                               
         L     R9,=A(STDPGRP)      POINT TO TABLE PARAMETERES                   
*                                                                               
         GOTO1 =A(GRPGET),DMCB,(C'G',RCON8EGS)     GET GROUP                    
*                                                                               
         CLC   REGRS,RCON8EGS      DROP IF DEFAULT NOT USED                     
         BNE   FLTCONT                                                          
*                                                                               
FLTGRSOK DS    0H                                                               
*                                                                               
FLTCTG   DS    0H                                                               
*                                                                               
         CLC   RECTG,RCON8ECG      OKAY IF CATEGORY NOT CHANGED                 
         BE    FLTCTGOK                                                         
*                                                                               
         L     R9,=A(STDPCTG)      POINT TO TABLE PARAMETERES                   
*                                                                               
         GOTO1 =A(CTGGET),DMCB,(C'G',RCON8ECG) FIND NEXT CATEGORY               
*                                                                               
         CLC   RECTG,RCON8ECG      DROP IF DEFAULT NOT USED                     
         BNE   FLTCONT                                                          
*                                                                               
FLTCTGOK DS    0H                                                               
*                                                                               
FLTTEM   DS    0H                                                               
*                                                                               
         CLC   RETEM,RCON8ETM      OKAY IF TEAM NOT CHANGED                     
         BE    FLTTEMOK                                                         
*                                                                               
         L     R9,=A(STDPTEM)      POINT TO TABLE PARAMETERES                   
*                                                                               
         GOTO1 =A(TEMGET),DMCB,(C'G',RCON8ETM) FIND NEXT TEAM                   
*                                                                               
         CLC   RETEM,RCON8ETM      DROP IF DEFAULT NOT USED                     
         BNE   FLTCONT                                                          
*                                                                               
FLTTEMOK DS    0H                                                               
*                                                                               
         BAS   RE,SEQ              READ NEXT POINTER                            
         CLI   RCON8EID,2          REPEAT IF WE DON'T FIND NEW RECTYPE          
         BE    *-8                                                              
*                                                                               
FLTSTP2X DS    0H                                                               
*                                                                               
*        ANALYZE SUB TYPE 3 KEY                                                 
*                                                                               
FLTSTP3  DS    0H                                                               
*                                                                               
         CLI   RCON8EID,3          SKIP IF NOT KEY TYPE 3                       
         BNE   FLTSTP3X                                                         
*                                                                               
FLTOFF   DS    0H                                                               
*                                                                               
         CLC   REOFF,RCON8EOF      OKAY IF OFFICE NOT CHANGED                   
         BE    FLTOFFOK                                                         
*                                                                               
         L     R9,=A(STDPOFF)      POINT TO TABLE PARAMETERES                   
*                                                                               
         GOTO1 =A(OFFGET),DMCB,(C'G',RCON8EOF) FIND NEXT OFFICE                 
*                                                                               
         CLC   REOFF,RCON8EOF      DROP IF DEFAULT NOT USED                     
         BNE   FLTCONT                                                          
*                                                                               
FLTOFFOK DS    0H                                                               
*                                                                               
FLTSTP3X DS    0H                                                               
*                                                                               
         TM    RCONKEY+27,X'80'    SKIP DELETED RECORDS                         
         BO    FLTCONT                                                          
*                                                                               
         MVC   RECONKEY,KEY        SAVE KEY                                     
*                                                                               
         BAS   RE,GETREC           READ RECORD                                  
*                                                                               
         BNZ   FLTCONT             IGNORE DELETED RECORDS                       
*                                                                               
         GOTO1 =A(RECFLT)          FILTER RECORD                                
         BNE   FLTCONT             FAILS FILTER                                 
*                                                                               
         MVC   REAREC,REAIO        SET A(RECORD BEING PROCESSED)                
*                                                                               
         GOTO1 =A(DOVALU2)         POST MONTH TABLE                             
*                                                                               
*        FILTER ON CONFIRMED, UNCONFIRMED ETC. DOLLARS                          
*                                                                               
         TM    REQCSTAT,REQCSCFQ+REQCSUCQ  SKIP IF NO FILTERING                 
         BZ    FLTCFX              ON CONFIRMED DOLLARS                         
*                                                                               
         L     RF,REANWMON         POINT TO 1ST MONTH TABLE AREA                
         LA    RF,NWMTCSPC-NWMNTABD(RF) POINT TO CONTRACT SPECS                 
*                                                                               
         TM    CSFRMISC(RF),X'20'  IF CONFIRMED CONTRACT DOLLARS                
         BNO   FLTCF10                                                          
*                                                                               
         TM    REQCSTAT,REQCSCFQ      KEEP IF CONFIRMED WANTED                  
         BO    FLTCFX                                                           
         B     FLTHOOKX               ELSE BYPASS CONTRACT                      
*                                                                               
FLTCF10  DS    0H                                                               
*                                                                               
         TM    REQCSTAT,REQCSUCQ      KEEP IF UNCONFIRMED WANTED                
         BO    FLTCFX                                                           
         B     FLTHOOKX               ELSE BYPASS CONTRACT                      
*                                                                               
FLTCFX   DS    0H                                                               
*                                                                               
*        FILTER ON COMPETITIVE STATUS                                           
*                                                                               
FLTCOMP  DS    0H                                                               
*                                                                               
         CLI   REQCOMPF,0          SKIP IF NO FILTERING ON COMPETITIVE          
         BE    FLTCOMPX               STATUS                                    
*                                                                               
         L     RF,REANWMON         POINT TO 1ST MONTH TABLE AREA                
         LA    RF,NWMTCSPC-NWMNTABD(RF) POINT TO CONTRACT SPECS                 
*                                                                               
         CLI   CSPENDNG(RF),C'Y'   IF PENDING CONTRACT                          
         BE    *+8                                                              
         CLI   CSPENDNG(RF),C'P'   IF PENDING CONTRACT                          
         BNE   *+12                                                             
         TM    REQCOMPF,REQCFPDQ   DO WE INCLUDE PENDING CONTRACTS?             
         BO    FLTCOMPX            YES                                          
*                                                                               
         TM    CSFRMISC(RF),X'80'  IF INCOMPLETE CONTRACT                       
         BNO   *+12                                                             
         TM    REQCOMPF,REQCFINQ   DO WE INCLUDE INCOMPLETE CONTRACTS?          
         BO    FLTCOMPX            YES                                          
*                                                                               
         CLI   CSSPLOSS(RF),C'Y'   IF CONTRACT IS A LOSS                        
         BNE   *+12                                                             
         TM    REQCOMPF,REQCFLSQ   DO WE INCLUDE LOSSES                         
         BO    FLTCOMPX            YES                                          
*                                                                               
*                                  CONTRACT IS COMPLETED WIN                    
*                                                                               
         TM    REQCOMPF,REQCFCPQ   DO WE INCLUDE COMPLETED WINS                 
         BO    FLTCOMPX            YES                                          
*                                                                               
         B     FLTCONT             DROP CONTRACT                                
*                                                                               
FLTCOMPX DS    0H                                                               
*                                                                               
         CLI   REQCMPFX,0          SKIP IF NO EXCLUDING ON COMPETITIVE          
         BE    FLTCMPFX               STATUS                                    
*                                                                               
         L     RF,REANWMON         POINT TO 1ST MONTH TABLE AREA                
         LA    RF,NWMTCSPC-NWMNTABD(RF) POINT TO CONTRACT SPECS                 
*                                                                               
         CLI   CSPENDNG(RF),C'Y'   IF PENDING CONTRACT                          
         BE    *+8                                                              
         CLI   CSPENDNG(RF),C'P'   IF PENDING CONTRACT                          
         BNE   *+12                                                             
         TM    REQCMPFX,REQCFPDQ   DO WE EXCLUDE PENDING CONTRACTS?             
         BO    FLTCONT             YES - DROP CONTRACT                          
*                                                                               
         TM    CSFRMISC(RF),X'80'  IF INCOMPLETE CONTRACT                       
         BNO   *+12                                                             
         TM    REQCMPFX,REQCFINQ   DO WE EXCLUDE INCOMPLETE CONTRACTS?          
         BO    FLTCONT             YES - DROP CONTRACT                          
*                                                                               
         CLI   CSSPLOSS(RF),C'Y'   IF CONTRACT IS A LOSS                        
         BNE   *+12                                                             
         TM    REQCMPFX,REQCFLSQ   DO WE EXCLUDE LOSSES                         
         BO    FLTCONT             YES - DROP CONTRACT                          
*                                                                               
*                                  CONTRACT IS COMPLETED WIN                    
*                                                                               
         TM    REQCMPFX,REQCFCPQ   DO WE EXCLUDE COMPLETED WINS                 
         BO    FLTCONT             YES - DROP CONTRACT                          
*                                                                               
FLTCMPFX DS    0H                                                               
*                                                                               
         TM    REQFLAGS,REQPWCR    IF PAPERWORK RECORDS REQUIRED                
         BNO   FLTPWCX                                                          
*                                                                               
         GOTO1 =A(PWCGET)             GO READ IN PAPERWORK RECORD               
*                                                                               
FLTPWCX  DS    0H                                                               
*                                                                               
FLTHOOK  DS    0H                                                               
*                                                                               
         MVC   FLTCURSB,REYMSTRP   DEFAULT TO WHOLE PERIOD                      
         MVC   FLTCUREB,REYMENDP                                                
*                                                                               
         LA    R2,FLTCURSB                                                      
         LA    R0,1                DEFAULT TO 1 TIME TO DRIVER                  
*                                                                               
         TM    RECNTRL,RECDLSTQ    IF DATE LIST PROCESSING                      
         BNO   FLTHOOK2                                                         
*                                                                               
         L     R5,REDLSTA             POINT TO DATE LISTS                       
         USING DATELSTD,R5            ESTABLISH DATELISTS                       
*                                                                               
         SR    RF,RF                                                            
*                                                                               
         CLI   REQDTYPE,C'W'       IF WEEKS                                     
         BNE   *+16                                                             
         LA    R2,WEEKLSTB            USE BINARY WEEK  LIST                     
         LA    R0,104                 MAX 104 ENTRIES                           
         B     FLTHOOK1                                                         
*                                                                               
         CLI   REQDTYPE,C'M'       IF MONTHS                                    
         BNE   *+20                                                             
         LA    R2,MNTHLSTB            USE BINARY MONTH LIST                     
         LA    R0,50                  MAX 50 ENTRIES                            
         IC    RF,YTDADJM             YTD ADJUSTMENT FACTOR                     
         B     FLTHOOK1                                                         
*                                                                               
         CLI   REQDTYPE,C'Q'       IF QUARTERS                                  
         BNE   *+20                                                             
         LA    R2,QURTLIST            USE QUARTER      LIST                     
         LA    R0,16                  MAX 16 ENTRIES                            
         IC    RF,YTDADJQ             YTD ADJUSTMENT FACTOR                     
         B     FLTHOOK1                                                         
*                                                                               
         CLI   REQDTYPE,C'S'       IF SEMI-YEARS                                
         BNE   *+20                                                             
         LA    R2,SEMILIST            USE SEMI-YEARS   LIST                     
         LA    R0,8                   MAX  8 ENTRIES                            
         IC    RF,YTDADJS             YTD ADJUSTMENT FACTOR                     
         B     FLTHOOK1                                                         
*                                                                               
         CLI   REQDTYPE,C'Y'       IF YEARS                                     
         BNE   *+20                                                             
         LA    R2,YEARLIST            USE YEARS        LIST                     
         LA    R0,4                   MAX  4 ENTRIES                            
         IC    RF,YTDADJY             YTD ADJUSTMENT FACTOR                     
         B     FLTHOOK1                                                         
*                                                                               
FLTHOOK1 DS    0H                                                               
*                                                                               
         LTR   RF,RF               ADJUST LIST START BY YTD FACTOR              
         BZ    FLTHOOK2            NO FACTOR                                    
*                                                                               
         LA    R2,4(R2)            BUMP UP 1 TABLE ENTRY                        
         BCT   RF,*-4                                                           
*                                                                               
FLTHOOK2 DS    0H                                                               
*                                                                               
FLTHOOKL DS    0H                                                               
*                                                                               
         CLI   REQDTYPE,C'W'       IF WEEKS                                     
         BNE   *+20                                                             
         MVC   RECURSTB,0(R2)         SET DATES FOR THIS CALL                   
         MVC   RECURENB,3(R2)         YMD BINARY                                
         B     FLTHOOKM                                                         
*                                                                               
         MVC   RECURSTB(2),0(R2)   ELSE SET DATES FOR THIS CALL                 
         MVC   RECURENB(2),2(R2)        YM BINARY                               
         MVI   RECURSTB+2,0             DATES ARE YM ONLY                       
         MVI   RECURENB+2,0                                                     
*                                                                               
FLTHOOKM DS    0H                                                               
*                                                                               
         NI    RECNTRL,X'FF'-RECRTRNQ   TURN OFF RETURN SWITCH                  
*                                                                               
         BAS   RE,GOHOOK           PASS RECORD TO DRIVER                        
*                                                                               
         TM    RECNTRL,RECRTRNQ    TEST IF NEED TO RETURN FOR MORE DATA         
         BO    FLTHOOKM                                                         
*                                                                               
         LA    R2,4(R2)            BUMP TO NEXT DATE IN LIST                    
*                                                                               
         CLI   REQDTYPE,C'W'       IF WEEKS                                     
         BNE   *+8                                                              
         LA    R2,2(R2)               BUMP 2 MORE PLACES                        
*                                                                               
         OC    0(4,R2),0(R2)       DONE AT END OF LIST                          
         BZ    FLTHOOKD                                                         
*                                                                               
         BCT   R0,FLTHOOKL                                                      
*                                                                               
FLTHOOKD DS    0H                                                               
*                                                                               
FLTHOOKX DS    0H                                                               
*                                                                               
FLTCONT  DS    0H                                                               
*                                                                               
         LA    R4,KEY              RE-ESTABLISH KEY                             
         USING RCONKEY,R4                                                       
*                                                                               
         BAS   RE,SEQ                                                           
         CLI   RCON8EID,1          KEEP GOING TIL NEXT FIRST KEY                
         BNE   *-8                                                              
*                                                                               
         B     FLTLOOP             GET NEXT RECORD                              
*                                                                               
FLTSKIP  DS    0H                                                               
*                                                                               
*        RE-BUILD SEARCH KEY                                                    
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY              RE-ESTABLISH KEY                             
         USING RCONKEY,R4                                                       
*                                                                               
         MVI   RCON8ETP,X'8E'      RECORD TYPE                                  
         MVC   RCON8ERP,REREP      REP                                          
*                                                                               
         MVC   RCON8EST,RESTA      STATION                                      
*                                                                               
         CLC   FLTSTASV,RESTA      SKIP IF WE KNOW NEXT STATION                 
         BNE   *+20                                                             
         MVC   RCON8EFS,=2X'FF'    FORCE NEW STATION                            
         MVC   RCON8EFE,=2X'FF'                                                 
         B     FLTSKDTX                                                         
*                                                                               
         MVC   RCON8EFS,FLTSTRSV   SET STARTING DATE                            
*                                                                               
FLTSKDTX DS    0H                                                               
*                                                                               
         BAS   RE,HIGH             SKIP READ                                    
*                                                                               
         B     FLTLOOP             GET NEXT RECORD                              
*                                                                               
FLTDONE  DS    0H                                                               
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - FILELISTS'                      
***********************************************************************         
*                                                                     *         
*        IF FILE LISTING READ APPROPRIATE RECORDS                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         TM    REALL2,REALSTAQ     SKIP IF NOT STATION FILE LISTING             
         JNO   *+8                                                              
         BRAS  RE,STLIST              GO LIST STATIONS                          
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE -FREPCONT'                        
***********************************************************************         
*                                                                     *         
*        FIND NEXT REP                                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
FREPCONT DS    0H                                                               
*                                                                               
         ICM   R2,15,REREPTBA      SKIP IF NO REP TABLE                         
         BZ    FREPDONE                                                         
*                                                                               
         USING REPTTABD,R2         ESTABLISH REP TABLE                          
*                                                                               
         ICM   R3,15,REPTENTA      POINT TO CURRENT TABLE ENTRY                 
         BZ    FREPDONE                                                         
*                                                                               
         USING REPTENT,R3          ESTABLISH TABLE ENTRY                        
*                                                                               
         A     R3,BSPLENR-BSPPRMS+REPTBSRP BUMP TO NEXT ENTRY                   
*                                                                               
         B     FREPLOOP                                                         
*                                                                               
FREPDONE DS    0H                                                               
*                                                                               
         XC    REPTENTA,REPTENTA   INDICATE END OF TABLE REACHED                
         MVC   REREPTA,REPTENTA                                                 
*                                                                               
         ICM   RF,15,REUTLA        IF UTL ADDRESS AVAILABLE                     
         JZ    *+16                                                             
         MVC   RESE,REQSE             RESTORE STARTING SE NUMBER                
         MVC   4(1,RF),REQSE                                                    
*                                                                               
FREPREPX DS    0H                                                               
*                                                                               
FLTX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
FLTSTASV DS    XL(L'RESTA)         CURRENT STATION SAVEAREA                     
FLTSTRSV DS    XL2                 COMPRESSED START DATE SAVEAREA               
*                                                                               
         LTORG                                                                  
*                                                                               
FLTCURSB DS    XL2                 YM - START DATE IF NO DATELIST               
FLTCUREB DS    XL2                 YM - END   DATE IF NO DATELIST               
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - RECFLT'                         
***********************************************************************         
*                                                                     *         
*        FILTER RECORD                                                *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
*EXIT    NEQ   DROP RECORD                                            *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RECFLT   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         L     R4,REAIO1                                                        
         USING RCONREC,R4          ESTABLISH CONTRACT RECORD                    
*                                                                               
         MVI   ELCODE,X'01'        FIND DESCRIPTION ELEMENT                     
         LR    R6,R4                                                            
         BRAS  RE,GETEL                                                         
         USING RCONELEM,R6                                                      
*                                                                               
*        FILTER ON DATES                                                        
*                                                                               
         MVC   RECONSTR,RCONDATE   SET CONTRACT DATES                           
         MVC   RECONEND,RCONDATE+3                                              
*                                                                               
         BAS   RE,DATEFLT          FILTER DATES                                 
         BNZ   RCFDROP             DROP RECORD                                  
*                                                                               
*        GET CONTRACT START BROADCAST MONTH                                     
*                                                                               
         GOTO1 DATCON,DMCB,(3,RECONSTR),WORK   CONTRACT START TO YYMMDD         
         GOTO1 GETBROAD,DMCB,(1,WORK),WORK+12,GETDAY,ADDAY  B'MON               
         GOTO1 DATCON,DMCB,(0,WORK+18),(3,RECNBSTB)  B'MON END TO BIN           
         MVI   RECNBSTB+2,0        NO DAYS                                      
*                                                                               
*        GET BROADCAST MONTH END OF CONTRACT END DATE                           
*                                                                               
*        NOTE: END OF B'MON ALWAYS IN CALENDAR MONTH                            
*                                                                               
         GOTO1 DATCON,DMCB,(3,RECONEND),WORK   CONTRACT END TO YYMMDD           
         GOTO1 GETBROAD,DMCB,(1,WORK),WORK+12,GETDAY,ADDAY  B'MON               
         GOTO1 DATCON,DMCB,(0,WORK+18),(3,RECNBENB)  B'MON END TO BIN           
         MVI   RECNBENB+2,0        NO DAYS                                      
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - RCFPRD'                         
***********************************************************************         
*                                                                     *         
*        FILTER ON PRODUCT                                            *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RCFPRD   DS    0H                                                               
*                                                                               
         MVC   REPRD,RCONPRD       DEFAULT TO FOUND PRODUCT                     
         XC    REPRDTA,REPRDTA     CLEAR PRODUCT TABLE POINTER                  
*                                                                               
         CLC   REPRD,SPACES        IF NO PRODUCT                                
         BH    RCFPRD1                                                          
*                                                                               
         TM    REFTYPS1,REFTPRDQ   KEEP IF NOT FILTERING ON PRODUCT             
         BNO   RCFPRDX                                                          
*                                                                               
         TM    REFTYPN1,REFTPRDQ   DROP IF NOT NEGATIVE FILTERING               
         BNO   RCFDROP                                                          
         B     RCFPRDX             ELSE KEEP                                    
*                                                                               
RCFPRD1 DS     0H                                                               
*                                                                               
         TM    REFTYPS1,REFTPRDQ   IF NOT FILTERING ON PRODUCT                  
         BO    *+8                                                              
         OI    REPRCNTL,REPRCPTQ      FORCE ADDING TO TABLE                     
*                                                                               
         GOTO1 =A(PRDGET),DMCB,(C'G',RCONPRD)   IS PRD IN TABLE?                
         BNE   RCFDROP             NOT FOUND - DROP                             
*                                                                               
         CLC   REPRD,RCONPRD       DID WE FIND WANTED PRODUCT?                  
         BNE   RCFDROP             NO                                           
*                                                                               
RCFPRDX DS     0H                                                               
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - RCFCTG'                         
***********************************************************************         
*                                                                     *         
*        FILTER ON CATEGORY                                           *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RCFCTG   DS    0H                                                               
*                                                                               
         MVC   RECTG,RCONCTGY      SET TO FOUND CATEGORY                        
         XC    RECTGTA,RECTGTA     CLEAR CATEGORY TABLE POINTER                 
*                                                                               
         TM    REFTYPS1,REFTCTGQ   OKAY IF NOT FILTERING ON CTG                 
         JNO   RCFCTGX                                                          
*                                                                               
         CLC   RECTG,SPACES        IF NO CATEGORY                               
         JH    RCFCTG1                                                          
*                                                                               
         TM    REFTYPN1,REFTCTGQ      KEEP IF NEGATIVE FILTERING                
         JO    RCFCTGX                                                          
         J     RCFDROP                ELSE DROP                                 
*                                                                               
RCFCTG1 DS     0H                                                               
*                                                                               
         L     R9,=A(STDPCTG)      POINT TO TABLE PARAMETERS                    
*                                                                               
         GOTO1 =A(CTGGET),DMCB,(C'G',RCONCTGY)   IS CTG IN TABLE?               
         BNZ   RCFDROP             NOT FOUND - DROP                             
*                                                                               
         CLC   RECTG,RCONCTGY      DROP IF NOT WANTED CATEGORY                  
         BNE   RCFDROP                                                          
*                                                                               
RCFCTGX DS     0H                                                               
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - RCFCLS'                         
***********************************************************************         
*                                                                     *         
*        FILTER ON CLASS                                              *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RCFCLS   DS    0H                                                               
*                                                                               
         XC    RECLSTA,RECLSTA     CLEAR CLASS TABLE POINTER                    
         XC    RECLS,RECLS         DEFAULT TO NO CLASS                          
*                                                                               
         TM    REFTYPS1,REFTCLSQ   OKAY IF NOT FILTERING ON CLS                 
         JNO   RCFCLSX                                                          
*                                                                               
*        FIND CATEGORY FIRST                                                    
*                                                                               
         MVC   RECTG,RCONCTGY      SET TO FOUND CATEGORY                        
         XC    RECTGTA,RECTGTA     CLEAR CATEGORY TABLE POINTER                 
*                                                                               
         CLC   RECTG,SPACES        IF NO CATEGORY                               
         BH    RCFCTCL1                                                         
*                                                                               
         TM    REFTYPN1,REFTCLSQ      KEEP IF NEGATIVE FILTERING                
         BO    RCFCLSX                                                          
         B     RCFDROP                ELSE DROP                                 
*                                                                               
RCFCTCL1 DS    0H                                                               
*                                                                               
         L     R9,=A(STDPCTG)      POINT TO TABLE PARAMETERS                    
*                                                                               
         GOTO1 =A(CTGGET),DMCB,(C'G',RCONCTGY)   IS CTG IN TABLE?               
         BNZ   RCFDROP             NOT FOUND - DROP                             
*                                                                               
         CLC   RECTG,RCONCTGY      DROP IF NOT WANTED CATEGORY                  
         BNE   RCFDROP                                                          
*                                                                               
         L     R3,RECTGTA          POINT TO CATEGORY TABLE ENTRY                
         USING CTGTENT,R3          ESTABLISH TABLE ENTRY                        
*                                                                               
*        FILTER ON CLASS FOUND IN CATEGORY RECORD                               
*                                                                               
         MVC   RECLS,RCTGCLSS-RCTGELEM+CTGTELM  SET TO FOUND CLASS              
         XC    RECLSTA,RECLSTA     CLEAR CLASS TABLE POINTER                    
*                                                                               
         CLC   RECLS,SPACES        IF NO CLASS                                  
         BH    RCFCLS1                                                          
*                                                                               
         TM    REFTYPN1,REFTCLSQ      KEEP IF NEGATIVE FILTERING                
         BO    RCFCLSX                                                          
         B     RCFDROP                ELSE DROP                                 
*                                                                               
RCFCLS1  DS    0H                                                               
*                                                                               
         L     R9,=A(STDPCLS)      POINT TO TABLE PARAMETERS                    
*                                                                               
         GOTO1 =A(CLSGET),DMCB,(C'G',RECLS)   IS CLASS IN TABLE?                
         BNZ   RCFDROP             NOT FOUND - DROP                             
*                                                                               
         CLC   RECLS,RCTGCLSS-RCTGELEM+CTGTELM  DROP IF NOT WANTED CLS          
         BNE   RCFDROP                                                          
*                                                                               
RCFCLSX DS     0H                                                               
*                                                                               
         DROP  R3                                                               
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - RCFTEM'                         
***********************************************************************         
*                                                                     *         
*        FILTER ON DIV/TEAM                                           *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RCFTEM   DS    0H                                                               
*                                                                               
         MVC   RETEM,RCONTEM       SET TO FOUND DIV/TEM                         
         XC    RETEMTA,RETEMTA     CLEAR DIV/TEM TABLE POINTER                  
*                                                                               
         TM    REFTYPS2,REFTTEMQ   OKAY IF NOT FILTERING ON TEM                 
         JNO   RCFTEMX                                                          
*                                                                               
         CLC   RETEM,SPACES        IF NO TEAM                                   
         JH    RCFTEM1                                                          
*                                                                               
         TM    REFTYPN2,REFTTEMQ      KEEP IF NEGATIVE FILTERING                
         JO    RCFTEMX                                                          
         J     RCFDROP                ELSE DROP                                 
*                                                                               
RCFTEM1 DS     0H                                                               
*                                                                               
         L     R9,=A(STDPTEM)      POINT TO TABLE PARAMETERS                    
*                                                                               
         GOTO1 =A(TEMGET),DMCB,(C'G',RCONTEM)   IS TEM IN TABLE?                
         BNZ   RCFDROP             NOT FOUND - DROP                             
*                                                                               
         CLC   RETEM,RCONTEM       DROP IF NOT WANTED TEAM                      
         BNE   RCFDROP                                                          
*                                                                               
RCFTEMX DS     0H                                                               
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - RCFSAL'                         
***********************************************************************         
*                                                                     *         
*        FILTER ON SALESPERSON                                        *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RCFSAL   DS    0H                                                               
*                                                                               
         MVC   RESAL,RCONSAL       SET TO FOUND SALESPERSON                     
         XC    RESALTA,RESALTA     CLEAR SALESPERSON TABLE POINTER              
*                                                                               
         TM    REFTYPS1,REFTSALQ   OKAY IF NOT FILTERING                        
         BNO   RCFSALX                ON SALESPERSON                            
*                                                                               
         CLC   RESAL,SPACES        IF NO SALESPERSON                            
         JH    RCFSAL1                                                          
*                                                                               
         TM    REFTYPN2,REFTSALQ      KEEP IF NEGATIVE FILTERING                
         JO    RCFSALX                                                          
         J     RCFDROP                ELSE DROP                                 
*                                                                               
RCFSAL1 DS     0H                                                               
*                                                                               
         L     R9,=A(STDPSAL)      POINT TO TABLE PARAMETERS                    
*                                                                               
         GOTO1 =A(SALGET),DMCB,(C'G',RCONSAL)   IS SAL IN TABLE?                
         BNZ   RCFDROP             NOT FOUND - DROP                             
*                                                                               
         CLC   RESAL,RCONSAL       DROP IF NOT WANTED SALESPERSON               
         BNE   RCFDROP                                                          
*                                                                               
RCFSALX DS     0H                                                               
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - RCFCTY'                         
***********************************************************************         
*                                                                     *         
*        FILTER ON CONTRACT TYPE                                      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RCFCTY   DS    0H                                                               
*                                                                               
         MVC   RECTY,RCONTYPE      SET TO FOUND CONTRACT TYPE                   
         XC    RECTYTA,RECTYTA     CLEAR CONTRACT TYPE TABLE POINTER            
*                                                                               
         TM    REFTYPS1,REFTCTYQ   SKIP IF NOT FILTERING                        
         BNO   RCFCTYX                ON CONTRACT TYPE                          
*                                                                               
         CLC   RECTY,SPACES        IF NO CONTRACT TYPE                          
         BH    *+16                                                             
         TM    REFTYPN1,REFTCTYQ      KEEP IF NEGATIVE FILTERING                
         BO    RCFCTYX                                                          
         B     RCFDROP                ELSE DROP                                 
*                                                                               
         L     R9,=A(STDPCTY)      POINT TO TABLE PARAMETERS                    
*                                                                               
         GOTO1 =A(CTYGET),DMCB,(C'G',RCONTYPE)   IS CTY IN TABLE?               
         BNZ   RCFDROP             NOT FOUND - DROP                             
*                                                                               
         CLC   RECTY,RCONTYPE      DROP IF NOT WANTED CONTRACT TYPE             
         BNE   RCFDROP                                                          
*                                                                               
RCFCTYX DS     0H                                                               
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - RCFDEV'                         
***********************************************************************         
*                                                                     *         
*        FIND DEVELOPMENTAL ELEMENT IF NEEDED                         *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RCFDEV   DS    0H                                                               
*                                                                               
         XC    REDCT,REDCT         CLEAR SAVEAREAS                              
         XC    REDSP,REDSP                                                      
         XC    REDCTTA,REDCTTA        CLEAR DEVELOP TYPE TABLE POINTER          
         XC    REDSPTA,REDSPTA        CLEAR DEVELOP SALES PERS POINTER          
*                                                                               
         TM    REFTYPS1,REFTDCTQ+REFTDSPQ  IF FILTERING ON DEVELOP DATA         
         BZ    RCFDEVX                                                          
*                                                                               
         MVI   ELCODE,X'18'        FIND DEVELOPMENTAL ELEMENT                   
         L     R6,REAIO1           POINT TO CONTRACT RECORD                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         SR    R6,R6                  NOT FOUND                                 
*                                                                               
         USING RCONDVEL,R6         ESTABLISH ELEMENT                            
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - RCFDCT'                         
***********************************************************************         
*                                                                     *         
*        FILTER ON DEVELOPMENTAL CONTRACT TYPE                        *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RCFDCT   DS    0H                                                               
*                                                                               
         LTR   R6,R6               IF ELEMENT FOUND                             
         BZ    *+10                                                             
         MVC   REDCT,RCONDVCT         SET TO FOUND DEVELOP TYPE                 
*                                                                               
         TM    REFTYPS1,REFTDCTQ   OKAY IF NOT FILTERING ON DCT                 
         JNO   RCFDCTX                                                          
*                                                                               
         CLC   REDCT,SPACES        IF NO CONTRACT TYPE                          
         BH    *+16                                                             
         TM    REFTYPN1,REFTDCTQ      KEEP IF NEGATIVE FILTERING                
         BO    RCFDCTX                                                          
         B     RCFDROP                ELSE DROP                                 
*                                                                               
         L     R9,=A(STDPDCT)      SET TABLE PARAMETERS                         
*                                                                               
         GOTO1 =A(DCTGET),DMCB,(C'G',REDCT)                                     
         BNZ   RCFDROP             NOT FOUND - DROP                             
*                                                                               
         CLC   REDCT,RCONDVCT      DROP IF NOT WANTED CONTRACT TYPE             
         BNE   RCFDROP                                                          
*                                                                               
RCFDCTX  DS    0H                                                               
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - RCFDSP'                         
***********************************************************************         
*                                                                     *         
*        FILTER ON DEVELOPMENTAL CONTRACT PERSON                      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RCFDSP   DS    0H                                                               
*                                                                               
         LTR   R6,R6               IF ELEMENT FOUND                             
         BZ    *+10                                                             
         MVC   REDSP,RCONDVSP         SET TO FOUND DEVELOP PERSON               
*                                                                               
         TM    REFTYPS1,REFTDSPQ   OKAY IF NOT FILTERING ON DSP                 
         JNO   RCFDSPX                                                          
*                                                                               
         CLC   REDSP,SPACES        IF NO SALESPERSON                            
         BH    *+16                                                             
         TM    REFTYPN1,REFTDSPQ      KEEP IF NEGATIVE FILTERING                
         BO    RCFDSPX                                                          
         B     RCFDROP                ELSE DROP                                 
*                                                                               
         L     R9,=A(STDPDSP)      SET TABLE PARAMETERS                         
*                                                                               
         GOTO1 =A(DSPGET),DMCB,(C'G',REDSP)                                     
         BNZ   RCFDROP             NOT FOUND - DROP                             
*                                                                               
         CLC   REDSP,RCONDVSP      DROP IF NOT WANTED SALESPERSON               
         BNE   RCFDROP                                                          
*                                                                               
RCFDSPX DS     0H                                                               
*                                                                               
RCFDEVX DS     0H                                                               
*                                                                               
         DROP  R6                                                               
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - RCFCFR'                         
***********************************************************************         
*                                                                     *         
*        FILTER ON FORECAST ORDERS                                    *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RCFCFR   DS    0H                                                               
*                                                                               
         TM    REQCSTAT,REQCSFRQ   IF FORECAST ORDERS ONLY                      
         BNO   RCFFRX                                                           
*                                                                               
         MVI   ELCODE,X'12'        FIND SAR ELEMENT                             
         L     R6,REAIO1           POINT TO CONTRACT RECORD                     
         BRAS  RE,GETEL                                                         
         BNZ   RCFDROP             DROP IF NO ELEMENT                           
*                                                                               
         USING RSARXEL,R6          ASSUME EXTENDED SAR ELEMENT                  
*                                                                               
         CLI   RSARXLEN,RSARXLTH   DROP IF OLD SAR ELEMENT                      
         BL    RCFDROP                                                          
*                                                                               
         TM    RSARXFLG,X'10'      DROP IF NOT FORECAST ORDER                   
         BNO   RCFDROP                                                          
*                                                                               
RCFFRX   DS    0H                                                               
*                                                                               
         TM    REQCSTAT,REQCSXFQ   IF EXCLUDING FORECAST ORDERS                 
         BNO   RCFXFRX                                                          
*                                                                               
         MVI   ELCODE,X'12'        FIND SAR ELEMENT                             
         L     R6,REAIO1           POINT TO CONTRACT RECORD                     
         BRAS  RE,GETEL                                                         
         BNZ   RCFXFRX             KEEP IF NO ELEMENT                           
*                                                                               
         USING RSARXEL,R6          ASSUME EXTENDED SAR ELEMENT                  
*                                                                               
         CLI   RSARXLEN,RSARXLTH   SKIP IF OLD SAR ELEMENT                      
         BL    RCFXFRX                                                          
*                                                                               
         TM    RSARXFLG,X'10'      DROP IF FORECAST ORDER                       
         BO    RCFDROP                                                          
*                                                                               
RCFXFRX  DS    0H                                                               
*                                                                               
*MNRCU                                                                          
         TITLE 'RENWRIO - REPWRITER IO MODULE - RCFRCU'                         
***********************************************************************         
*                                                                     *         
*        FILTER ON SCRIPT UPLOAD ORDERS                               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RCFRCU   DS    0H                                                               
*                                                                               
         TM    REQCSTAT,REQCRCU    IF SCRIPT UPLOAD ORDERS ONLY                 
         BNO   RCFXRCU                                                          
*                                                                               
         MVI   ELCODE,X'3C'        FIND SAR ELEMENT                             
         L     R6,REAIO1           POINT TO CONTRACT RECORD                     
         BRAS  RE,GETEL                                                         
         BNE   RCFDROP             DROP IF NO ELEMENT                           
*                                                                               
RCFXRCU  DS    0H                                                               
*                                                                               
         TM    REQCSTAT,REQCXRCU   IF EXCLUDING SCRIPT UPLOAD ORDERS            
         BNO   RCFXRCX                                                          
*                                                                               
         MVI   ELCODE,X'3C'        FIND SAR ELEMENT                             
         L     R6,REAIO1           POINT TO CONTRACT RECORD                     
         BRAS  RE,GETEL                                                         
         BE    RCFDROP             KEEP IF NO ELEMENT                           
*                                                                               
RCFXRCX  DS    0H                                                               
*                                                                               
*MNRCU                                                                          
*MNRCU                                                                          
         TITLE 'RENWRIO - REPWRITER IO MODULE - RCFRCM'                         
***********************************************************************         
*                                                                     *         
*        FILTER ON SCRIPT MANUAL ORDERS                               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RCFRCM   DS    0H                                                               
*                                                                               
         TM    REQCSTAT,REQCRCM    IF SCRIPT UPLOAD ORDERS ONLY                 
         BNO   RCFXRCM                                                          
*                                                                               
         MVI   ELCODE,X'3C'        FIND SAR ELEMENT                             
         L     R6,REAIO1           POINT TO CONTRACT RECORD                     
         BRAS  RE,GETEL                                                         
         BNE   RCFDROP             DROP IF NO ELEMENT                           
*                                                                               
         USING RCONCUEL,R6         SCRIPT CONTRACT UPLOAD ELEMENT               
         CLI   RCONCULN,RCONCULQ                                                
         BL    RCFDROP                                                          
         OC    RCONCUMD,RCONCUMD   MANUAL UPLOAD DATE                           
         BZ    RCFDROP                                                          
*        OC    RCONCUCT,RCONCUCT   COUNT                                        
*        BNZ   RCFDROP                                                          
*                                                                               
RCFXRCM  DS    0H                                                               
*                                                                               
         TM    REQCSTA2,REQCXRCM   IF EXCLUDING SCRIPT UPLOAD ORDERS            
         BNO   RCFXRMX                                                          
*                                                                               
         MVI   ELCODE,X'3C'        FIND SAR ELEMENT                             
         L     R6,REAIO1           POINT TO CONTRACT RECORD                     
         BRAS  RE,GETEL                                                         
         BNE   RCFXRMX             KEEP IF NO ELEMENT                           
*                                                                               
         USING RCONCUEL,R6         SCRIPT CONTRACT UPLOAD ELEMENT               
         CLI   RCONCULN,RCONCULQ                                                
         BL    RCFXRMX                                                          
         OC    RCONCUMD,RCONCUMD   MANUAL UPLOAD DATE                           
         BNZ   RCFDROP                                                          
*        OC    RCONCUCT,RCONCUCT   COUNT                                        
*        BZ    RCFDROP                                                          
*                                                                               
RCFXRMX  DS    0H                                                               
         DROP  R6                                                               
*                                                                               
*MNRCU                                                                          
         TITLE 'RENWRIO - REPWRITER IO MODULE - RCFAGY'                         
***********************************************************************         
*                                                                     *         
*        FILTER ON AGENCY                                             *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RCFAGY   DS    0H                                                               
*                                                                               
*        IF NO FILTERING ON AGY                                                 
*           READ AGY RECORD AND ADD TO TABLE                                    
*                                                                               
         TM    REAGCNTL,REAGCFDQ   SKIP IF TABLE ENTRY ALREADY FOUND            
         BO    RCFAGYX                                                          
*                                                                               
         L     R4,REAIO1                                                        
         USING RCONREC,R4          ESTABLISH CONTRACT RECORD                    
*                                                                               
         OI    REAGCNTL,REAGCPTQ   FORCE ADDING TO TABLE                        
*                                                                               
         GOTO1 =A(AGYGET),DMCB,(C'G',RCONKAGY)                                  
         BNE   RCFDROP             AGY NOT FOUND                                
*                                                                               
         CLC   REAGY(6),RCONKAGY   DROP IF AGY NOT IN TABLE                     
         BNE   RCFDROP                                                          
*                                                                               
RCFAGYX  DS    0H                                                               
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - RCFADV'                         
***********************************************************************         
*                                                                     *         
*        FILTER ON ADVERTISER                                         *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RCFADV   DS    0H                                                               
*                                                                               
*        IF NO FILTERING ON ADV                                                 
*           READ ADV RECORD AND ADD TO TABLE                                    
*                                                                               
         TM    READCNTL,READCFDQ   SKIP IF TABLE ENTRY ALREADY FOUND            
         BO    RCFADVX                                                          
*                                                                               
         L     R4,REAIO1                                                        
         USING RCONREC,R4          ESTABLISH CONTRACT RECORD                    
*                                                                               
         OI    READCNTL,READCPTQ   FORCE ADDING TO TABLE                        
*                                                                               
         GOTO1 =A(ADVGET),DMCB,(C'G',RCONKADV)                                  
         BNE   RCFDROP             ADV NOT FOUND                                
*                                                                               
         CLC   READV,RCONKADV      DROP IF ADV NOT IN TABLE                     
         BNE   RCFDROP                                                          
*                                                                               
RCFADVX  DS    0H                                                               
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - RCFCCD'                         
***********************************************************************         
*                                                                     *         
*        FILTER ON CONTRACT HEADER CREATION DATE                      *         
*                                                                     *         
*        CONTRACT HEADER CREATION DATE MUST LIE BETWEEN               *         
*        FILTER DATES                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RCFCCD   DS    0H                                                               
*                                                                               
         OC    REQCCDDT,REQCCDDT   SKIP IF NOT FILTERING                        
         BZ    RCFCCDX                                                          
*                                                                               
         L     R4,REAIO1                                                        
         USING RCONREC,R4          ESTABLISH CONTRACT RECORD                    
*                                                                               
         CLC   RCONHDRD,REQCCDST   MUST BE AFTER START OF DATE RANGE            
         BL    RCFDROP                                                          
*                                                                               
         OC    REQCCDEN,REQCCDEN   OKAY IF NO END DATE                          
         BZ    RCFCCDX                                                          
*                                                                               
         CLC   RCONHDRD,REQCCDEN   MUST BE ON OR BEFORE END DATE RANGE          
         BH    RCFDROP                                                          
*                                                                               
RCFCCDX  DS    0H                                                               
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - RCFCMB'                         
***********************************************************************         
*                                                                     *         
*        FILTER ON COMBINATION CONTRACTS                              *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RCFCMB   DS    0H                                                               
*                                                                               
         CLI   RECOMBO,0           SKIP IF NO OPTION ENTERED                    
         BE    RCFCMBX                                                          
*                                                                               
         L     R4,REAIO1                                                        
         USING RCONREC,R4          ESTABLISH CONTRACT RECORD                    
*                                                                               
         LA    R6,RCONELEM         POINT TO FIRST ELEMENT                       
         USING RCONCBEL,R6         ESTABLISH AS COMBINATION ELEMENT             
*                                                                               
*        SEARCH FOR COMBINATION ELEMENTS                                        
*                                                                               
         SR    RF,RF                                                            
*                                                                               
RCFCMBLP DS    0H                                                               
*                                                                               
         CLI   RCONCBO,0           DONE AT END OF RECORD                        
         BE    RCFCMBDN                                                         
*                                                                               
         CLI   RCONCBO,X'17'       SEARCH FOR COMBINATION ELEMENT               
         BE    RCFCMBFD                                                         
*                                                                               
RCFCMBCN DS    0H                                                               
*                                                                               
         IC    RF,RCONCBLN         BUMP TO NEXT ELEMENT                         
         LA    R6,RCONCBEL(RF)                                                  
         B     RCFCMBLP                                                         
*                                                                               
RCFCMBDN DS    0H                  NO COMBINATION ELEMENTS                      
*                                                                               
         CLI   RECOMBO,C'Y'        DROP IF COMBOS ONLY                          
         BE    RCFDROP                                                          
*                                                                               
         B     RCFCMBX             KEEP RECORD                                  
*                                                                               
RCFCMBFD DS    0H                  COMBINATION ELEMENTS FOUND                   
*                                                                               
         CLI   RECOMBO,C'N'        DROP IF COMBOS EXCLUDED                      
         BE    RCFDROP                                                          
*                                                                               
RCFCMBX  DS    0H                                                               
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - RCFPTP'                         
***********************************************************************         
*                                                                     *         
*        FILTER ON POINT PERSON                                       *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RCFPTP   DS    0H                                                               
*                                                                               
         XC    REPTP,REPTP         CLEAR CURRENT VALUE                          
         XC    REPTPTA,REPTPTA     CLEAR A(CURRENT PTP TABLE ENTRY)             
*                                                                               
         TM    REFTYPS1,REFTPTPQ   OKAY IF NOT FILTERING ON PTP                 
         JNO   RCFPTPX                                                          
*                                                                               
*        FIND PROD FIRST                                                        
*                                                                               
         ICM   R3,15,REPRDTA       POINT TO ENTRY IN PRODUCT TABLE              
         JNZ   *+16                IF NOT AVAILABLE                             
         TM    REFTYPN1,REFTPTPQ      KEEP IF NEGATIVE FILTERING                
         BO    RCFPTPX                                                          
         B     RCFDROP                ELSE DROP                                 
*                                                                               
         USING PRDTENT,R3          ESTABLISH PRODUCT TABLE ENTRY                
*                                                                               
         SR    RF,RF                                                            
         LA    R6,PRDTELM          ESTABLISH PRODUCT DESCRIPTION                
*                                                                               
*        FIND NETWORK CONTRACT ELEMENT                                          
*                                                                               
RCFPTPLP DS    0H                                                               
*                                                                               
         CLI   0(R6),0             CHECK FOR END OF RECORD                      
         JE    RCFPTPDN               DROP IF NO ELEMENT                        
*                                                                               
         CLI   0(R6),X'02'         FIND NETWORK CONTRACT ELEMENT                
         JE    RCFPTPFD                                                         
*                                                                               
RCFPTPCN DS    0H                                                               
*                                                                               
         IC    RF,1(R6)                                                         
         LA    R6,0(RF,R6)         NEXT ELEMENT                                 
         J     RCFPTPLP                                                         
*                                                                               
RCFPTPDN DS    0H                  NO NETWORK CONTRACT ELEMENT                  
*                                                                               
         TM    REFTYPN1,REFTPTPQ      KEEP IF NEGATIVE FILTERING                
         BO    RCFPTPX                                                          
         B     RCFDROP                ELSE DROP                                 
*                                                                               
RCFPTPFD DS    0H                                                               
*                                                                               
         USING RPRDNELM,R6         ESTABLISH NETWORK CONTRACT ELEMENT           
*                                                                               
         MVC   REPTP,RPRDNPNT      GET PTP                                      
*                                                                               
         CLC   REPTP,SPACES        IF NO SALESPERSON                            
         BH    *+16                                                             
         TM    REFTYPN1,REFTPTPQ      KEEP IF NEGATIVE FILTERING                
         BO    RCFPTPX                                                          
         B     RCFDROP                ELSE DROP                                 
*                                                                               
         L     R9,=A(STDPPTP)      SET TABLE PARAMETERS                         
*                                                                               
         GOTO1 =A(PTPGET),DMCB,(C'G',REPTP)                                     
         BNZ   RCFDROP             NOT FOUND - DROP                             
*                                                                               
         CLC   REPTP,RPRDNPNT      DROP IF NOT WANTED PTP                       
         BNE   RCFDROP                                                          
*                                                                               
RCFPTPX  DS    0H                                                               
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - RCFBKB'                         
***********************************************************************         
*                                                                     *         
*        FILTER ON BACK BILLING OPTION                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RCFBKB   DS    0H                                                               
*                                                                               
         L     R4,REAIO1           RE-ESTABLISH CONTRACT RECORD                 
         USING RCONREC,R4                                                       
*                                                                               
         CLC   =C'ACC-BB',RCONBUYR CHECK FOR BACK BILL CONTRACT                 
         JNE   RCFBKBNF                                                         
*                                                                               
*        CONTRACT IS A BACK BILL                                                
*                                                                               
RCFBKBFD DS    0H                                                               
*                                                                               
         CLI   REFBKBOP,C'I'       ACCEPT IF INCLUDING BACK BILLING             
         JE    RCFBKBOK                                                         
*                                                                               
         CLI   REFBKBOP,C'O'       ACCEPT IF BACK BILLING ONLY                  
         JE    RCFBKBOK                                                         
*                                                                               
         CLI   REFBKBOP,C'X'       DROP IF EXCLUDING BACK BILLING               
         JE    RCFDROP                                                          
*                                                                               
         CLI   REREPPRF+15,C'B'    DROP IF REP EXCLUDES BACK BILLING            
         JE    RCFDROP                KEEP FOR REPORT                           
*                                                                               
         J     RCFBKBOK            ELSE ACCEPT                                  
*                                                                               
*        CONTRACT IS NOT A BACK BILL                                            
*                                                                               
RCFBKBNF DS    0H                                                               
*                                                                               
         CLI   REFBKBOP,C'O'       DROP IF BACK BILLING ONLY                    
         JE    RCFDROP                DROP                                      
*                                                                               
         J     RCFBKBOK            ELSE KEEP FOR REPORT                         
*                                                                               
RCFBKBOK DS     0H                                                              
*                                                                               
         J     RCFBKBX             KEEP RECORD                                  
*                                                                               
RCFBKBX  DS    0H                                                               
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - RECFLTX'                        
***********************************************************************         
*                                                                     *         
*        END OF RECORD FILTERING                                      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RCFOK    DS    0H                                                               
*                                                                               
         CR    RB,RB               SET EQ  CC                                   
*                                                                               
         J     RECFLTX                                                          
*                                                                               
RCFDROP DS     0H                                                               
*                                                                               
         LTR   RB,RB               SET NEQ CC                                   
*                                                                               
         J     RECFLTX                                                          
*                                                                               
RECFLTX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE -STLIST'                          
***********************************************************************         
*                                                                     *         
*        READ ALL STATION RECORDS                                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
STLIST   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         MVC   STLRID,REREAD       SAVE CURRENT RECORD TYPE                     
         MVI   REREAD,RSTAKTYQ     SET TO READ STATION RECORDS                  
*                                                                               
         L     RF,REAIO1           CLEAR I/O AREAS                              
         XC    0(256,RF),0(RF)                                                  
         L     RF,REAIO2           CLEAR I/O AREAS                              
         XC    0(256,RF),0(RF)                                                  
         L     RF,REAIO3           CLEAR I/O AREAS                              
         XC    0(256,RF),0(RF)                                                  
*                                                                               
         XC    KEY,KEY             INIT KEYAREA                                 
*                                                                               
*        INIT CURRENT VALUES OF ALL KEY FIELDS                                  
*                                                                               
         XC    REGRS,REGRS         GROUP/SUBGROUP                               
         XC    RESTA,RESTA         STATION                                      
         XC    REOFF,REOFF         OFFICE                                       
         XC    REAGY,REAGY         AGENCY                                       
         XC    REAOF,REAOF         AGENCY OFFICE                                
         XC    READV,READV         ADVERTISER                                   
         XC    RECON,RECON         CONTRACT                                     
*                                                                               
*        FIND STARTING VALUES FOR KEY FIELDS                                    
*                                                                               
         GOTO1 =A(STGET),DMCB,(C'N',RESTA)    FIND FIRST STATION                
*                                                                               
STLLOOP  DS    0H                                                               
*                                                                               
*        CHECK FOR MAJOR CHANGES IN KEY                                         
*                                                                               
         CLC   RESTA,=16X'FF'      END OF STATIONS FOR GROUP                    
         JE    STLDONE                                                          
*                                                                               
STLHOOK  DS    0H                                                               
*                                                                               
         NI    RECNTRL,X'FF'-RECRTRNQ   TURN OFF RETURN SWITCH                  
*                                                                               
         BRAS  RE,GOHOOK           PASS RECORD TO DRIVER                        
*                                                                               
         TM    RECNTRL,RECRTRNQ    TEST IF NEED TO RETURN FOR MORE DATA         
         JO    STLHOOK                                                          
*                                                                               
STLHOOKX DS    0H                                                               
*                                                                               
STLCONT  DS    0H                                                               
*                                                                               
         XC    REGRS,REGRS         KILL PROCESSING BY GROUP                     
         GOTO1 =A(STGET),DMCB,(C'N',RESTA) GET NEXT STATION                     
*                                                                               
         J     STLLOOP                                                          
*                                                                               
STLDONE  DS    0H                                                               
*                                                                               
         MVC   REREAD,STLRID       RESTORE CURRENT RECORD TYPE                  
*                                                                               
STLISTX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
STLRID   DS    XL(L'REREAD)        CURRENT RECORD TYPE                          
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - GRP'                            
***********************************************************************         
*                                                                     *         
*        READ ALL GROUP RECS, SAVING GROUP RECORD                     *         
*                                    GROUP SET RECORD                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
GRP      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
*        NOT CALLED - GRP TABLE BUILT IN STD ROUTINE                            
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
*        ESTABLISH GROUP TABLE                                                  
*                                                                               
         SR    R3,R3               INIT GROUP TABLE ENTRY POINTER               
*                                                                               
         ICM   R2,15,REGRPTBA      TABLE ADDRESS                                
         BZ    GRPX                NO TABLE AVAILABLE                           
*                                                                               
         USING GRPTTABD,R2         ESTABLISH GROUP TABLE AREA                   
*                                                                               
*        INITIALIZE GROUP TABLE                                                 
*                                                                               
GRPINIT  DS    0H                                                               
*                                                                               
         OC    GRPTBXLE,GRPTBXLE   SKIP IF TABLE ALREADY INITIALIZED            
         BNZ   GRPINITX                                                         
*                                                                               
         LA    RF,GRPTTAB          SET TABLE START                              
         ST    RF,GRPTSTRA                                                      
*                                                                               
         BCTR  RF,0                SET END OF TABLE AS START MINUS ONE          
         ST    RF,GRPTENDA                                                      
*                                                                               
         LA    RF,GRPTENTL         SET ENTRY LENGTH                             
         ST    RF,GRPTLEN                                                       
*                                                                               
         LA    RF,GRPTMAXQ         SET # OF AVAILABLE ENTRIES TO MAX            
         ST    RF,GRPTAVL                                                       
*                                                                               
*        READ GROUP SET RECORD                                                  
*                                                                               
         XC    GRPTSKEY,GRPTSKEY   INIT GROUP SET RECORD KEY                    
*                                                                               
         OC    REGRPSID,REGRPSID   SKIP IF NO GROUP SET FILTER                  
         BZ    GRPSETX                                                          
*                                                                               
*        REP FOR READING SET RECORD IS THE SAME AS THAT FOR GROUPS              
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING RGRPKEY,R4          ESTABLISH AS GROUP RECORD                    
*                                                                               
         MVI   RGRPKTYP,RGRPKTYQ   SET GROUP ID                                 
         MVC   RGRPKREP,REREP                                                   
*                                                                               
         GOTO1 =A(SETREP),DMCB,KEY FIND FILE REP FOR GROUPS                     
*                                  WINDS UP IN REDMREP                          
*                                                                               
         XC    KEY,KEY                                                          
         USING RSETKEY,R4          ESTABLISH SET KEY                            
*                                                                               
         MVI   RSETKTYP,RSETKTYQ   RECORD ID                                    
         MVC   RSETKREP,REDMREP    REP                                          
         MVC   RSETKSET,=C'GS'     SET ID                                       
         MVC   RSETKID,REGRPSID    SET ID                                       
*                                                                               
         BAS   RE,HIGH             READ KEY                                     
*                                                                               
         CLC   RSETKEY,KEYSAVE     MUST FIND IT                                 
         BNE   GRPX                                                             
*                                                                               
         BAS   RE,GETREC           READ IN RECORD                               
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
         MVC   GRPTSKEY,RSETKEY    SAVE RECORD KEY                              
*                                                                               
*        SAVE SET DECRIPTION ELEMENT                                            
*                                                                               
         LA    R6,RSETELEM         POINT TO FIRST ELEMENT IN RECORD             
         USING RSETDESD,R6         ESTABLISH DESCRIPTIVE ELEMENT                
*                                                                               
         SR    RF,RF                                                            
*                                                                               
         CLI   RSETDCDE,0          DONE AT END OF RECORD                        
         BE    GRPSTDSX                                                         
         CLI   RSETDCDE,RSETDCDQ   FIND DESCRIPTION ELEMENT                     
         BE    *+16                                                             
         IC    RF,RSETDELN         GET ELEMENT LENGTH                           
         LA    R6,RSETDESD(RF)     BUMP TO NEXT ELEMENT                         
         B     *-24                                                             
*                                                                               
         IC    RF,RSETDELN         GET ELEMENT LENGTH                           
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   GRPTSDSC(0),RSETDESD SAVE SET DESCRIPTION ELEMENT                
*                                                                               
GRPSTDSX DS    0H                                                               
*                                                                               
*        FIND MEMBER ELEMENT                                                    
*                                                                               
         LA    R6,RSETELEM         POINT TO FIRST ELEMENT IN RECORD             
         USING RSETMEMD,R6                                                      
*                                                                               
         SR    RF,RF                                                            
*                                                                               
         CLI   RSETMCDE,0          DONE AT END OF RECORD                        
         BE    GRPSTMBX                                                         
         CLI   RSETMCDE,RSETMCDQ   FIND DESCRIPTION ELEMENT                     
         BE    *+16                                                             
         IC    RF,RSETMELN         GET ELEMENT LENGTH                           
         LA    R6,RSETMEMD(RF)     BUMP TO NEXT ELEMENT                         
         B     *-24                                                             
*                                                                               
         IC    RF,RSETMELN         GET ELEMENT LENGTH                           
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   GRPTSMEM(0),RSETMEMD SAVE SET MEMBER ELEMENT                     
*                                                                               
         DROP  R6                                                               
*                                                                               
GRPSTMBX DS    0H                                                               
*                                                                               
GRPSETX  DS    0H                                                               
*                                                                               
GRPINITX DS    0H                  END OF TABLE INITIALIZATION                  
*                                                                               
*        READ ALL APPLICABLE GROUP RECORDS                                      
*        SAVE IN TABLE                                                          
*                                                                               
         SR    R8,R8               INIT MEMBER ELEMENT POINTER                  
*                                                                               
         OC    GRPTSKEY,GRPTSKEY   SKIP IF THERE IS NO SET RECORD               
         BZ    GRPIMEMX                                                         
*                                                                               
         LA    R8,GRPTSMEM         POINT TO MEMBERS ELEMENT                     
         USING RSETMCDE,R8         ESTABLISH SET MEMBER ELEMENT                 
*                                                                               
         SR    R9,R9                                                            
         IC    R9,RSETMELN         ELEMENT LENGTH                               
*                                                                               
         SH    R9,=Y(RSETMTOV)     DECREMENT BY OVERHEAD LENGTH                 
         BP    *+8                                                              
         B     GRPDONE                NO MEMBERS IN SET - NO GROUPS             
*                                                                               
         SRL   R9,1                NUMBER OF GROUPS IN ELEMENT                  
*                                                                               
*                                  SORT MEMBERSHIP LIST                         
         XC    DMCB(24),DMCB                                                    
         MVC   DMCB+11(1),RSETMLEN                                              
         MVC   DMCB+15(1),RSETMLEN                                              
*                                                                               
         GOTO1 XSORT,DMCB,RSETMEMB,(R9)                                         
*                                                                               
GRPIMEMX DS    0H                                                               
*                                                                               
         ICM   R0,15,GRPTAVL       GET NUMBER OF TABLE SLOTS AVAILABLE          
*                                                                               
         L     R3,GRPTENDA         POINT TO FIRST AVAILABLE SLOT IN TAB         
         LA    R3,1(R3)                                                         
         USING GRPTENT,R3          ESTABLISH GROUP ENTRY                        
*                                                                               
         XC    GRPTKEY,GRPTKEY     INIT FIRST GROUP ENTRY KEY                   
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING RGRPKEY,R4          ESTABLISH GROUP KEY                          
*                                                                               
         MVI   RGRPKTYP,RGRPKTYQ   RECORD ID                                    
         MVC   RGRPKREP,REREP      REP                                          
*                                                                               
         GOTO1 =A(SETREP),DMCB,RGRPKEY SET FILE READ REP                        
*                                                                               
         LTR   R8,R8               IF SET MEMBER ELEMENT AROUND                 
         BZ    *+10                                                             
         MVC   RGRPKGRP,RSETMEMB      USE IT                                    
*                                                                               
         OC    REFGRP,REFGRP       IF GROUP FILTER SET                          
         BZ    *+10                                                             
         MVC   RGRPKGRP,REFGRP        USE IT                                    
*                                                                               
         MVI   LKEY,25             SET KEY COMPARE LENGTH                       
*                                                                               
         OC    RGRPKGRP,RGRPKGRP   IF GROUP CODE SET IN KEY                     
         BZ    *+8                                                              
         MVI   LKEY,27                KEYS MUST NOW MATCH TO GROUP/SUB          
*                                                                               
         CLI   RGRPKGRP+1,0        IF NO SUBGROUP SPECIFIED                     
         BNZ   *+8                                                              
         MVI   LKEY,26                KEYS MUST MATCH GROUP ONLY                
*                                                                               
         BAS   RE,FIRSTHI          READ FIRST GROUP RECORD                      
*                                                                               
GRPLOOP  DS    0H                                                               
*                                                                               
         LA    R4,KEY              RE-POINT TO FOUND KEY                        
*                                                                               
         BAS   RE,KEYCOMP          SKIP IF NOT GROUP KEY FOUND                  
         BNE   GRPCONT                                                          
*                                                                               
         BAS   RE,GETREC           READ IN RECORD                               
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
*                                                                               
         MVC   GRPTKEY,RGRPKEY     SAVE GROUP KEY                               
*                                                                               
         GOTO1 =A(TBLREP),DMCB,GRPTKEY  FIND REP FOR TABLE STORAGE              
*                                                                               
         MVC   RGRPKREP-RGRPKEY+GRPTKEY,RETBREP    USE IT IN TABLE              
*                                                                               
*        SAVE GROUP DECRIPTION ELEMENT                                          
*                                                                               
         SR    RF,RF                                                            
         LA    R6,RGRPELEM         POINT TO FIRST ELEMENT IN RECORD             
         USING RGRPELEM,R6         ESTABLISH DESCRIPTIVE ELEMENT                
*                                                                               
         IC    RF,RGRPELLN         GET ELEMENT LENGTH                           
*                                                                               
         CLI   RGRPELEM,0          DONE AT END OF RECORD                        
         BE    GRPDSCX                                                          
         CLI   RGRPELEM,X'10'      FIND DESCRIPTION ELEMENT                     
         BE    *+16                                                             
         IC    RF,RGRPELLN         GET ELEMENT LENGTH                           
         LA    R6,RGRPELEM(RF)     BUMP TO NEXT ELEMENT                         
         B     *-24                                                             
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   GRPTELM(0),RGRPELEM SAVE GROUP DESCRIPTION ELEMENT               
*                                                                               
GRPDSCX  DS    0H                                                               
*                                                                               
         BCT   R0,*+6              DECREMENT SPACE AVAILABLE COUNTER            
         DC    H'0'                INCREASE GROUP TABLE                         
*                                                                               
         LA    R3,GRPTENT+GRPTENTL  BUMP TO NEXT AVAILABLE TABLE ENTRY          
         XC    GRPTKEY,GRPTKEY      INIT NEXT ENTRY                             
*                                                                               
GRPCONT  DS    0H                                                               
*                                                                               
         OC    REFGRPSB,REFGRPSB   DONE IF FILTERING ON GRP/SUB                 
         BNZ   GRPDONE                                                          
*                                                                               
         LTR   R8,R8               IF SET MEMBER ELEMENT AROUND                 
         BZ    GRPCONT1                                                         
*                                                                               
         BCT   R9,*+8                 DECREMENT GROUP COUNTER                   
         B     GRPDONE                NONE LEFT IN ELEMENT                      
*                                                                               
         LA    R4,KEY              RE-POINT TO FOUND KEY                        
         MVC   KEY,KEYSAVE         RESTORE TO SOUGHT KEY                        
*                                                                               
         LA    R8,L'RGRPKGRP(R8)   BUMP TO NEXT GROUP IN ELEMENT                
*                                                                               
         MVC   RGRPKGRP,RSETMEMB      USE IT                                    
*                                                                               
         MVI   LKEY,27             KEYS MUST MATCH TO GROUP/SUB                 
*                                                                               
         CLI   RGRPKGRP+1,0        IF NO SUBGROUP SPECIFIED                     
         BNZ   *+8                                                              
         MVI   LKEY,26                KEYS MUST MATCH GROUP ONLY                
*                                                                               
         BAS   RE,HIGH             READ DIRECTORY POINTER                       
*                                                                               
         B     GRPCONT9                                                         
*                                                                               
GRPCONT1 DS    0H                                                               
*                                                                               
         BAS   RE,SEQ              READ NEXT GROUP RECORD                       
*                                                                               
GRPCONT9 DS    0H                                                               
*                                                                               
         B     GRPLOOP                                                          
*                                                                               
GRPDONE  DS    0H                                                               
*                                                                               
         LTR   R3,R3               IF WE PUT ANYTHING IN TABLE                  
         BZ    GRPDONE1                                                         
*                                                                               
         BCTR  R3,0                   RESET END OF TABLE                        
         ST    R3,GRPTENDA                                                      
*                                                                               
GRPDONE1 DS    0H                                                               
*                                                                               
GRPX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - GRPGET'                         
***********************************************************************         
*                                                                     *         
*        RETRIEVE NEXT GROUP/SUBGROUP                                 *         
*                                                                     *         
*NTRY    PARM0+0   C'N' - FIND NEXT ENTRY IN TABLE                    *         
*                  C'G' - FIND ENTRY FOR DEFAULT                      *         
*        PARM0 ==> DEFAULT VALUE TO USE                               *         
*                                                                     *         
*                                                                     *         
*EXIT    REGRS = X'FFFF' IF NONE FOUND                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
GRPGET   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         L     R9,0(R1)            POINT TO DEFAULT VALUE                       
         MVC   GRPGOPT,0(R1)       SAVE OPTION                                  
         MVC   GRPGKEY,KEY         SAVE CURRENT KEY                             
*                                                                               
         ICM   R2,15,REGRPTBA      GET GRP TABLE ADDRESS                        
         BZ    GRPGDFLT            USE DEFAULT IF NO TABLE                      
*                                                                               
         USING GRPTTABD,R2         ESTABLISH TABLE                              
*                                                                               
         LM    R3,R5,GRPTBXLE      LOAD BXLE REGISTERS                          
         USING GRPTENT,R3          ESTABLISH TABLE ENTRY                        
*                                  R3 ==> FIRST TABLE ENTRY                     
         CR    R3,R5               USE DEFAULT IF TABLE EMPTY                   
         BNL   GRPGDFLT                                                         
*                                                                               
         XC    KEY,KEY             INIT KEY BUILD AREA                          
         LA    R6,KEY              ESTABLISH GROUP RECORD                       
         USING RGRPKEY,R6                                                       
*                                                                               
         MVI   RGRPKTYP,RGRPKTYQ   SET KEY FOR GROUP                            
         MVC   RGRPKREP,REREP      DEFAULT TO CURRENT REP                       
*                                                                               
         GOTO1 =A(TBLREP),DMCB,KEY   FIND REP FOR TABLE SEARCH                  
*                                                                               
         MVC   RGRPKREP,RETBREP    SET TABLE SEARCH REP                         
*                                                                               
         MVC   KEY,GRPGKEY         RESTORE KEY                                  
*                                                                               
         DROP  R6                                                               
*                                                                               
GRPGREPL DS    0H                                                               
*                                                                               
         TM    GRPTKEY+27,X'80'    SKIP IF DELETED                              
         BO    GRPGREPC                                                         
*                                                                               
         CLC   RGRPKREP-RGRPKEY+GRPTKEY,RETBREP FIND 1ST FOR REP                
         BE    GRPGREPF                                                         
*                                                                               
GRPGREPC DS    0H                                                               
         BXLE  R3,R4,GRPGREPL                                                   
         B     GRPGNFD             REP NOT IN TABLE                             
*                                                                               
GRPGREPF DS    0H                                                               
*                                                                               
         ST    R3,GRPG1STA         SAVE STARTING ADDRESS                        
*                                                                               
         OC    GRPTENTA,GRPTENTA   DONE IF FIRST TIME                           
         BZ    GRPGLOOP                                                         
*                                                                               
         OC    REGRS,REGRS         DONE IF RESTARTING TABLE                     
         BZ    GRPGLOOP                                                         
*                                                                               
         CLC   GRPTENTA,=4X'FF'    IF END OF TABLE LAST TIME                    
         BE    GRPGLOOP               RESTART TABLE                             
*                                                                               
         ICM   R3,15,GRPTENTA      POINT TO LAST ENTRY USED                     
*                                                                               
         CLC   RGRPKREP-RGRPKEY+GRPTKEY,RETBREP MATCH TABLE REP                 
         BNE   GRPGLOOP                                                         
*                                                                               
         CLC   RGRPKGRP-RGRPKEY+GRPTKEY(2),0(R9) IF PAST DEFAULT                
         BNH   *+8                 RE-START TABLE                               
         ICM   R3,15,GRPG1STA      POINT TO FIRST ENTRY IN TABLE                
*                                                                               
GRPGLOOP DS    0H                                                               
*                                                                               
         TM    GRPTKEY+27,X'80'    SKIP IF DELETED                              
         BO    GRPGCONT                                                         
*                                                                               
         CLC   RGRPKREP-RGRPKEY+GRPTKEY,RETBREP MATCH TABLE REP                 
         BNE   GRPGCONT                                                         
*                                                                               
         CLC   RGRPKGRP-RGRPKEY+GRPTKEY,0(R9) MATCH TO DEFAULT                  
         BH    GRPGFD              USE IF PAST DEFAULT                          
         BL    GRPGCONT            SKIP IF LESS THAN                            
*                                                                               
         CLI   GRPGOPT,C'G'        IF GET OPTION                                
         BE    GRPGFD                 USE IF EQUAL                              
*                                                                               
GRPGCONT DS    0H                                                               
*                                                                               
         BXLE  R3,R4,GRPGLOOP      POINT TO NEXT ENTRY IN TABLE                 
*                                                                               
GRPGDONE DS    0H                                                               
*                                                                               
         B     GRPGNFD             END OF TABLE                                 
*                                                                               
GRPGFD   DS    0H                                                               
*                                                                               
         ST    R3,GRPTENTA         SET TABLE ENTRY POINTER                      
         MVC   REGRPTA,GRPTENTA    RETURN A(GROUP TABLE ENTRY)                  
*                                                                               
         MVC   REGRS,RGRPKGRP-RGRPKEY+GRPTKEY   RETURN GROUP                    
*                                                                               
         B     GRPGOK                                                           
*                                                                               
GRPGDFLT DS    0H                  DEFAULT TO GRP IN CONTRACT KEY               
*                                                                               
         MVC   REGRS,0(R9)         SET DEFAULT VALUE                            
*                                                                               
         SR    R3,R3               INIT GROUP TABLE ENTRY POINTER               
         ST    R3,REGRPTA          NO GROUP TABLE ENTRY                         
*                                                                               
GRPGOK   DS    0H                                                               
*                                                                               
         CR    RB,RB               SET EQ CC                                    
*                                                                               
         B     GRPGETX                                                          
*                                                                               
GRPGNFD  DS    0H                                                               
*                                                                               
         MVC   REGRS,=16X'FF'      NOT FOUND VALUE                              
         MVC   GRPTENTA,=4X'FF'    INDICATE END OF TABLE REACHED                
         MVC   REGRPTA,GRPTENTA    RETURN A(GROUP TABLE ENTRY)                  
*                                                                               
         LTR   RB,RB               SET NEQ CC                                   
*                                                                               
GRPGETX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         DS    0D                  ALIGNMENT                                    
GRPGOPT  DS    XL1                 C'G'  GET STATION                            
*                                  C'N'  GET NEXT STATION                       
         DS    XL3                 SPARE                                        
GRPG1STA DS    A                   A(FIRST ENTRY FOR REP)                       
GRPGKEY  DS    XL(L'KEY)           KEY SAVEAREA                                 
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - BUDYRGET'                       
***********************************************************************         
*                                                                     *         
*        RETRIEVE NEXT YEAR FOR BUDGET RECORDS                        *         
*                                                                     *         
*NTRY    PARM0+0   C'N' - FIND NEXT ENTRY IN TABLE                    *         
*                  C'G' - FIND ENTRY FOR DEFAULT                      *         
*        PARM0 ==> DEFAULT VALUE TO USE                               *         
*                                                                     *         
*                                                                     *         
*EXIT    REBUDYR = X'FFFF' IF NONE FOUND                              *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
BUDYRGET NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         L     R9,0(R1)            POINT TO DEFAULT VALUE                       
         MVC   BDYGOPT,0(R1)       SAVE OPTION                                  
*                                                                               
         OC    REBDYTAB,REBDYTAB   SKIP IF YEAR TABLE INITIALIZED               
         BNZ   BDYGINIX                                                         
*                                                                               
*        DETERMINE START/END YEAR FOR BUDGET RECORDS                            
*                                                                               
         XC    REBUDYR,REBUDYR     INIT CURRENT YEAR SAVEAREA                   
*                                                                               
         TM    REFDTTYP,REFDPR2Q   SKIP IF PRIOR 2YR NOT NEEDED                 
         BNO   *+14                                                             
         MVC   WORK(1),REFPR2SB    START WITH PRIOR 2 YR START YR               
         B     BDYGINI3                                                         
*                                                                               
         TM    REFDTTYP,REFDPRIQ   SKIP IF PRIOR NOT NEEDED                     
         BNO   *+14                                                             
         MVC   WORK(1),REFPRISB    START WITH PRIOR START YR                    
         B     BDYGINI3                                                         
*                                                                               
         TM    REFDTTYP,REFDCURQ   SKIP IF CURRENT NOT NEEDED                   
         BNO   *+14                                                             
         MVC   WORK(1),REFCURSB    START WITH CURRENT START YR                  
         B     BDYGINI3                                                         
*                                                                               
         TM    REFDTTYP,REFDNXTQ   SKIP IF NEXT NOT NEEDED                      
         BNO   *+14                                                             
         MVC   WORK(1),REFNXTSB    START WITH NEXT START YR                     
         B     BDYGINI3                                                         
*                                                                               
         DC    H'0'                SHOULD NOT BE HERE                           
*                                                                               
BDYGINI3 DS    0H                                                               
*                                                                               
         TM    REFDTTYP,REFDNXTQ   SKIP IF NEXT NOT NEEDED                      
         BNO   *+14                                                             
         MVC   WORK+1(1),REFNXTEB     END WITH NEXT END YR                      
         B     BDYGINI5                                                         
*                                                                               
         TM    REFDTTYP,REFDCURQ   SKIP IF CURRENT NOT NEEDED                   
         BNO   *+14                                                             
         MVC   WORK+1(1),REFCUREB       END WITH CURRENT END YR                 
         B     BDYGINI5                                                         
*                                                                               
         TM    REFDTTYP,REFDPRIQ   SKIP IF PRIOR NOT NEEDED                     
         BNO   *+14                                                             
         MVC   WORK+1(1),REFPRIEB    END WITH PRIOR END YR                      
         B     BDYGINI5                                                         
*                                                                               
         TM    REFDTTYP,REFDPR2Q   SKIP IF PRIOR 2YR NOT NEEDED                 
         BNO   *+14                                                             
         MVC   WORK+1(1),REFPR2EB    END WITH PRIOR 2 YR END YR                 
         B     BDYGINI5                                                         
*                                                                               
         DC    H'0'                SHOULD NOT BE HERE                           
*                                                                               
BDYGINI5 DS    0H                                                               
*                                                                               
*        BUILD LIST OF VALID YEARS                                              
*                                                                               
         MVC   FULL(3),=X'000101'  SKELETON JAN1                                
*                                                                               
         LA    R2,REBDYTAB         START OF TABLE                               
         SR    R3,R3               INITIAL YEAR                                 
         IC    R3,WORK                                                          
*                                                                               
BDYGINIL DS    0H                                                               
*                                                                               
         STC   R3,FULL             ADD YEAR TO SKELETON JAN1                    
*                                                                               
         GOTO1 DATCON,DMCB,(3,FULL),(0,WORK+6)   CONVERT TO YYMMDD              
*                                                                               
         MVC   0(2,R2),WORK+6      SAVE YEAR IN YY FORMAT                       
*                                                                               
BDYGINIC DS    0H                                                               
*                                                                               
         LA    R2,2(R2)            BUMP POINTER                                 
         LA    R3,1(R3)            BUMP YEAR                                    
         CLM   R3,1,WORK+1         CONTINUE IF WITHIN BOUNDARIES                
         BNH   BDYGINIL                                                         
*                                                                               
BDYINIC  DS    0H                                                               
*                                                                               
BDYGINIX DS    0H                                                               
*                                                                               
         LA    R3,REBDYTAB         POINT TO REBDYTAB                            
*                                                                               
         OC    REBUDYR,REBUDYR     DONE IF RESTARTING TABLE                     
         BZ    BDYGFD                                                           
*                                                                               
         CLC   REBUDYR,=4X'FF'     IF END OF TABLE LAST TIME                    
         BE    BDYGNFD                STILL END OF TABLE                        
*                                                                               
BDYGLOOP DS    0H                                                               
*                                                                               
         CLC   0(2,R3),0(R9)       MATCH TO DEFAULT                             
         BNE   BDYGCONT            SKIP IF NO MATCH                             
*                                                                               
         CLI   BDYGOPT,C'G'        IF GET OPTION                                
         BE    BDYGFD                 USE IF EQUAL                              
*                                                                               
         CLI   BDYGOPT,C'N'        HANDLE NEXT BECAUSE NON DDS FORMAT           
         BNE   BDYGCONT                                                         
*                                                                               
         LA    R3,2(R3)            BUMP TABLE POINTER                           
*                                                                               
         OC    0(2,R3),0(R3)       USE ENTRY IF THERE                           
         BNZ   BDYGFD                                                           
         B     BDYGNFD             ELSE NOT FOUND                               
*                                                                               
BDYGCONT DS    0H                                                               
*                                                                               
         LA    R3,2(R3)            BUMP TO NEXT ENTRY IN TABLE                  
         OC    0(2,R3),0(R3)                                                    
         BNZ   BDYGLOOP            POINT TO NEXT ENTRY IN TABLE                 
*                                                                               
BDYGDONE DS    0H                                                               
*                                                                               
         B     BDYGNFD             END OF TABLE                                 
*                                                                               
BDYGFD   DS    0H                                                               
*                                                                               
         MVC   REBUDYR,0(R3)       RETURN BUDGET YEAR                           
*                                                                               
         B     BDYGOK                                                           
*                                                                               
BDYGDFLT DS    0H                  DEFAULT TO YEAR IN CONTRACT KEY              
*                                                                               
         MVC   REBUDYR,0(R9)       SET DEFAULT VALUE                            
*                                                                               
BDYGOK   DS    0H                                                               
*                                                                               
         CR    RB,RB               SET EQ CC                                    
*                                                                               
         B     BDYGETX                                                          
*                                                                               
BDYGNFD  DS    0H                                                               
*                                                                               
         MVC   REBUDYR,=16X'FF'    NOT FOUND VALUE                              
*                                                                               
         LTR   RB,RB               SET NEQ CC                                   
*                                                                               
BDYGETX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
BDYGOPT  DS    XL1                 C'G'  GET STATION                            
*                                  C'N'  GET NEXT STATION                       
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - OFFGET'                         
***********************************************************************         
*                                                                     *         
*        RETRIEVE NEXT OFFICE                                         *         
*                                                                     *         
*NTRY    PARM0+0   C'N' - FIND NEXT ENTRY IN TABLE                    *         
*                  C'G' - FIND ENTRY FOR DEFAULT                      *         
*        PARM0 ==> DEFAULT VALUE TO USE                               *         
*                                                                     *         
*EXIT    REGRS = X'FFFF' IF NONE FOUND                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
OFFGET   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         L     R9,0(R1)            POINT TO DEFAULT VALUE                       
         MVC   OFFGOPT,0(R1)       SAVE OPTION                                  
         MVC   OFFGKEY,KEY         SAVE CURRENT KEY                             
*                                                                               
         ICM   R2,15,REOFFTBA      GET OFFICE TABLE ADDRESS                     
         BZ    OFFGDFLT            USE DEFAULT IF NO TABLE                      
*                                                                               
         USING OFFTTABD,R2         ESTABLISH TABLE                              
*                                                                               
         LM    R3,R5,OFFTBXLE      LOAD BXLE REGISTERS                          
         USING OFFTENT,R3          ESTABLISH TABLE ENTRY                        
*                                  R3 ==> FIRST TABLE ENTRY                     
         CR    R3,R5               USE DEFAULT IF TABLE EMPTY                   
         BNL   OFFGDFLT                                                         
*                                                                               
         XC    KEY,KEY                                                          
         LA    R6,KEY              ESTABLISH OFFICE KEY                         
         USING ROFFKEY,R6                                                       
*                                                                               
         MVI   KEY,ROFFKTYQ        SET KEY FOR OFFICE                           
         MVC   ROFFKREP,REREP      DEFAULT TO CURRENT REP                       
*                                                                               
         GOTO1 =A(TBLREP),DMCB,ROFFKEY  FIND TABLE SEARCH REP                   
*                                                                               
         MVC   KEY,OFFGKEY         RESTORE KEY                                  
*                                                                               
         DROP  R6                                                               
*                                                                               
OFFGREPL DS    0H                                                               
*                                                                               
         TM    OFFTKEY+27,X'80'    SKIP IF DELETED                              
         BO    OFFGREPC                                                         
*                                                                               
         CLC   ROFFKREP-ROFFKEY+OFFTKEY,RETBREP FIND 1ST FOR REP                
         BE    OFFGREPF                                                         
*                                                                               
OFFGREPC DS    0H                                                               
         BXLE  R3,R4,OFFGREPL                                                   
         B     OFFGNFD             REP NOT IN TABLE                             
*                                                                               
OFFGREPF DS    0H                                                               
*                                                                               
         ST    R3,OFFG1STA         SAVE START OF REP                            
*                                                                               
         OC    OFFTENTA,OFFTENTA   FIRST TIME                                   
         BZ    OFFGLOOP                                                         
*                                                                               
         OC    REOFF,REOFF         RESTARTING TABLE                             
         BZ    OFFGLOOP                                                         
*                                                                               
         CLC   OFFTENTA,=4X'FF'    IF END OF TABLE LAST TIME                    
         BE    OFFGLOOP               START AT BEGINNING OF TABLE               
*                                                                               
         ICM   R3,15,OFFTENTA      POINT TO LAST ENTRY USED                     
*                                                                               
         CLC   ROFFKOFF-ROFFKEY+OFFTKEY,0(R9) IF PAST DEFAULT                   
         BNH   *+8                 RE-START TABLE                               
         ICM   R3,15,OFFG1STA      POINT TO FIRST ENTRY IN TABLE                
*                                                                               
OFFGLOOP DS    0H                                                               
*                                                                               
         TM    OFFTKEY+27,X'80'    SKIP IF DELETED                              
         BO    OFFGCONT                                                         
*                                                                               
         CLC   ROFFKREP-ROFFKEY+OFFTKEY,RETBREP MATCH CURRENT REP               
         BNE   OFFGCONT                                                         
*                                                                               
         CLC   ROFFKOFF-ROFFKEY+OFFTKEY,0(R9) MATCH TO DEFAULT                  
         BH    OFFGFD              USE IF PASSED DEFAULT                        
         BL    OFFGCONT            SKIP IF LESS THAN                            
*                                                                               
         CLI   OFFGOPT,C'G'        IF GET OPTION                                
         BE    OFFGFD                 USE IF EQUAL                              
*                                                                               
OFFGCONT DS    0H                                                               
*                                                                               
         BXLE  R3,R4,OFFGLOOP      POINT TO NEXT ENTRY IN TABLE                 
*                                                                               
OFFGDONE DS    0H                                                               
*                                                                               
         B     OFFGNFD             END OF TABLE                                 
*                                                                               
OFFGFD   DS    0H                                                               
*                                                                               
         ST    R3,OFFTENTA         SET TABLE ENTRY POINTER                      
         MVC   REOFFTA,OFFTENTA    RETURN A(OFFICE TABLE ENTRY)                 
*                                                                               
         MVC   REOFF,ROFFKOFF-ROFFKEY+OFFTKEY   RETURN NEXT OFFICE              
*                                                                               
         B     OFFGOK                                                           
*                                                                               
OFFGDFLT DS    0H                  DEFAULT TO OFF IN CONTRACT KEY               
*                                                                               
         MVC   REOFF,0(R9)         SET DEFAULT VALUE                            
         SR    R3,R3               INIT OFFICE TABLE ENTRY POINTER              
         ST    R3,REOFFTA          NO  TABLE ENTRY POINTER                      
*                                                                               
OFFGOK   DS    0H                                                               
*                                                                               
         CR    RB,RB               SET EQ CC                                    
*                                                                               
         B     OFFGETX                                                          
*                                                                               
OFFGNFD  DS    0H                                                               
*                                                                               
         MVC   REOFF,=16X'FF'      NOT FOUND VALUE                              
         MVC   OFFTENTA,=4X'FF'    INDICATE END OF TABLE REACHED                
         MVC   REOFFTA,OFFTENTA    RETURN A(OFFICE TABLE ENTRY)                 
*                                                                               
         LTR   RB,RB               SET NEQ CC                                   
*                                                                               
OFFGETX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         DS    0D                                                               
OFFGOPT  DS    XL1                 C'G'  GET OFFICE                             
*                                  C'N'  GET NEXT OFFICE                        
         DS    XL3                 SPARE                                        
OFFG1STA DS    A                   A(FIRST ENTRY FOR REP)                       
OFFGKEY  DS    XL(L'KEY)           KEY SAVEAREA                                 
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - ADVGET'                         
***********************************************************************         
*                                                                     *         
*        RETRIEVE NEXT ADVERTISER                                     *         
*                                                                     *         
*NTRY    PARM0+0   C'N' - FIND NEXT ENTRY IN TABLE                    *         
*                  C'G' - FIND ENTRY FOR DEFAULT                      *         
*        PARM0 ==> DEFAULT VALUE TO USE                               *         
*                                                                     *         
*EXIT    READV = X'FFFF' IF NONE FOUND                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
ADVGET   NTR1  BASE=*,LABEL=*,WORK=(R9,256)                                     
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         ST    R9,ADVGWRKA         SAVE A(LOCAL WORKING STORAGE)                
*                                                                               
         L     R9,0(R1)            POINT TO DEFAULT VALUE                       
         MVC   ADVGADV,0(R9)       SAVE DEFAULT VALUE                           
         MVC   ADVGOPT,0(R1)       SAVE OPTION                                  
*                                                                               
         XC    ADVGKEY,ADVGKEY     INIT CURRENT KEY SAVEAREA                    
         XC    ADVGAIO,ADVGAIO     INIT IO CURRENT VALUE                        
*                                                                               
         SR    R3,R3               INIT TABLE ENTRY POINTER                     
*                                                                               
         ICM   R2,15,READVTBA      GET ADVERTISER TABLE ADDRESS                 
         BZ    ADVGDFLT            USE DEFAULT IF NO TABLE                      
*                                                                               
         USING ADVTTABD,R2         ESTABLISH TABLE                              
*                                                                               
         TM    READCNTL,READCFTQ   IF FILTERING THERE IS A TABLE                
         BNO   ADVGFLTN                                                         
*                                                                               
         LA    R4,ADVTKEY-ADVTTABD(R2)  POINT TO KEY BUILD AREA                 
         USING RADVKEY,R4          ESTABLISH AGENCY KEY                         
*                                                                               
         XC    RADVKEY,RADVKEY     INIT KEY                                     
*                                                                               
         MVI   RADVKTYP,RADVKTYQ   RECORD ID                                    
         MVC   RADVKADV,ADVGADV    DEFAULT ADV CODE                             
         MVC   RADVKREP,REREP      REP                                          
*                                                                               
         GOTO1 =A(TBLREP),DMCB,RADVKEY   FIND TABLE SEARCH REP                  
*                                                                               
         MVC   RADVKREP,RETBREP    SET TABLE SEARCH REP                         
*                                                                               
*        FIND FIRST ENTRY IN TABLE FOR REP                                      
*                                                                               
         L     R3,BSPATAB-BSPPRMS+ADVTBSRP   POINT TO 1ST TABLE ENTRY           
         USING ADVTENT,R3          ESTABLISH ENTRY                              
*                                                                               
ADVG1STL DS    0H                                                               
*                                                                               
         OC    ADVTKEY,ADVTKEY     TEST FOR END OF TABLE                        
         BZ    ADVGNFD                                                          
*                                                                               
         TM    ADVTKEY+27,X'80'    SKIP IF ENTRY DELETED                        
         BO    ADVG1STC                                                         
*                                                                               
         CLC   RADVKREP-RADVKEY+ADVTKEY,RETBREP  OKAY IF CORRECT REP            
         BNE   ADVG1STC                                                         
*                                                                               
         B     ADVG1STD                                                         
*                                                                               
ADVG1STC DS    0H                                                               
*                                                                               
         A     R3,BSPLENR-BSPPRMS+ADVTBSRP   BUMP TO NEXT ENTRY                 
         B     ADVG1STL            END OF TABLE                                 
*                                                                               
ADVG1STD DS    0H                                                               
*                                                                               
         CLC   ADVGADV,RESPACES    IF RE-STARTING TABLE                         
         BNH   ADVGFD                 USE FIRST ENTRY FOR REP                   
*                                                                               
         CLC   ADVGADV,RADVKADV-RADVKEY+ADVTKEY   IF DEFAULT LOWER              
         BL    ADVGFD              THAN FIRST ENTRY - USE 1ST ENTRY             
*                                                                               
         GOTO1 BINSRCH,ADVTBSRP,('BSPRDHI',RADVKEY)   FIND IN TABLE             
*                                                                               
         CLI   BSPCNTL-BSPPRMS+ADVTBSRP,BSPNF IF NOT FOUND                      
         BE    ADVGNFD                THEN NOT IN TABLE                         
*                                                                               
         ICM   R3,15,BSPAREC-BSPPRMS+ADVTBSRP  POINT TO FOUND ENTRY             
         BZ    ADVGNFD             NONE FOUND                                   
*                                                                               
*                                                                               
ADVGDFTL DS    0H                                                               
*                                                                               
         OC    ADVTKEY,ADVTKEY     TEST FOR END OF TABLE                        
         BZ    ADVGNFD                                                          
*                                                                               
         CLC   RADVKREP-RADVKEY+ADVTKEY,RETBREP  OKAY IF CORRECT REP            
         BNE   ADVGDFTC                                                         
*                                                                               
         TM    ADVTKEY+27,X'80'    SKIP IF ENTRY DELETED                        
         BO    ADVGDFTC                                                         
*                                                                               
         B     ADVGDFTD                                                         
*                                                                               
ADVGDFTC DS    0H                                                               
*                                                                               
         A     R3,BSPLENR-BSPPRMS+ADVTBSRP   BUMP TO NEXT ENTRY                 
         B     ADVGDFTL            END OF TABLE                                 
*                                                                               
ADVGDFTD DS    0H                                                               
*                                                                               
         CLC   ADVGADV,RADVKADV-RADVKEY+ADVTKEY  IF DEFAULT LOWER               
         BL    ADVGFD                    USE ENTRY                              
         BH    ADVGNFD                                                          
*                                                                               
*                                  TABLE ENTRY FOUND                            
*                                                                               
         CLI   ADVGOPT,C'G'        IF GETTING AGENCY                            
         BE    ADVGFD                 USE THIS ENTRY                            
*                                                                               
ADVGNXLP DS    0H                                                               
*                                                                               
         A     R3,BSPLENR-BSPPRMS+ADVTBSRP   BUMP TO NEXT ENTRY                 
*                                                                               
         OC    ADVTKEY,ADVTKEY     TEST FOR END OF TABLE                        
         BZ    ADVGNFD                                                          
*                                                                               
         CLC   RADVKREP-RADVKEY+ADVTKEY,RETBREP  OKAY IF CORRECT REP            
         BNE   ADVGNXCN                                                         
*                                                                               
         TM    ADVTKEY+27,X'80'    SKIP IF ENTRY DELETED                        
         BO    ADVGNXCN                                                         
*                                                                               
         B     ADVGNXDN                                                         
*                                                                               
ADVGNXCN DS    0H                                                               
*                                                                               
         B     ADVGNXLP                                                         
*                                                                               
ADVGNXDN DS    0H                                                               
*                                                                               
         B     ADVGFD                                                           
*                                                                               
         DROP  R3                                                               
*                                                                               
ADVGFLTN DS    0H                                                               
*                                                                               
         LA    R3,ADVTTAB          BUILD ENTRY IN 1ST TABLE SLOT                
*                                                                               
         USING ADVTENT,R3          ESTABLISH ENTRY                              
*                                                                               
         XC    ADVTKEY,ADVTKEY     INIT KEY                                     
         XC    ADVTELM,ADVTELM     INIT DESCRIPTION ELEMENT                     
*                                                                               
*        BUILD KEY                                                              
*                                                                               
         LA    R4,ADVTKEY                                                       
         USING RADVKEY,R4          ESTABLISH ADVERTISER KEY                     
*                                                                               
         MVI   RADVKTYP,RADVKTYQ   RECORD ID                                    
         MVC   RADVKADV,ADVGADV    DEFAULT ADVERTISER CODE                      
         MVC   RADVKREP,REREP      REP                                          
*                                                                               
         GOTO1 =A(TBLREP),DMCB,RADVKEY  GET TABLE SEARCH REP                    
*                                                                               
         MVC   RADVKREP,RETBREP    SET TABLE REP                                
*                                                                               
         GOTO1 BINSRCH,ADVTBSRP,('BSPFIND',RADVKEY)   FIND IN TABLE             
*                                                                               
         CLI   BSPCNTL-BSPPRMS+ADVTBSRP,BSPNF IF NOT FOUND                      
         BE    ADVGPUT                           ADD TO TABLE                   
*                                                                               
         ICM   R3,15,BSPAREC-BSPPRMS+ADVTBSRP  POINT TO FOUND ELEMENT           
         BZ    ADVGPUT             NONE FOUND                                   
*                                                                               
         USING ADVTENT,R3          ESTABLISH TABLE ENTRY                        
*                                                                               
         TM    ADVTKEY+27,X'80'    DROP IF ENTRY DELETED                        
         BO    ADVGNFD                                                          
*                                                                               
         CLI   ADVGOPT,C'G'        IF GETTING ADVERTISER                        
         BE    ADVGFD                 USE THIS ENTRY                            
*                                                                               
*        FIND NEXT ENTRY IN TABLE                                               
*                                                                               
ADVGNXTL DS    0H                                                               
*                                                                               
         A     R3,BSPLENR-BSPPRMS+ADVTBSRP   BUMP TO NEXT ENTRY                 
*                                                                               
         OC    ADVTKEY,ADVTKEY     TEST FOR END OF TABLE                        
         BZ    ADVGNFD                                                          
*                                                                               
         CLC   RADVKREP-RADVKEY+ADVTKEY,RETBREP  OKAY IF CORRECT REP            
         BNE   ADVGNXTC                                                         
*                                                                               
         TM    ADVTKEY+27,X'80'    SKIP IF ENTRY DELETED                        
         BO    ADVGNXTC                                                         
*                                                                               
         B     ADVGNXTD                                                         
*                                                                               
ADVGNXTC DS    0H                                                               
*                                                                               
         B     ADVGNXTL                                                         
*                                                                               
ADVGNXTD DS    0H                                                               
*                                                                               
         B     AGYGFD                                                           
*                                                                               
ADVGFD   DS    0H                                                               
*                                                                               
         ST    R3,ADVTENTA         SET TABLE ENTRY POINTER                      
         MVC   READVTA,ADVTENTA    RETURN A(GROUP TABLE ENTRY)                  
*                                                                               
         OI    READCNTL,READCFDQ   INDICATE TABLE ENTRY FOUND                   
*                                                                               
         MVC   READV,RADVKADV-RADVKEY+ADVTKEY   RETURN ADVERTISER               
*                                                                               
         B     ADVGOK                                                           
*                                                                               
         DROP  R3                                                               
*                                                                               
*        PUT NEW ADVERTISER IN TABLE                                            
*                                                                               
ADVGPUT  DS    0H                  PUT NEW ADVERTISER IN TABLE                  
*                                                                               
         TM    READCNTL,READCFTQ   IF FILTERING                                 
         BO    ADVGNFD                ASSUME NOT FOUND                          
*                                                                               
         CLI   ADVGOPT,C'G'        IF GETTING ENTRY                             
         BE    ADVGPUT1                CREATE TABLE ENTRY                       
*                                                                               
         TM    READCNTL,READCPTQ   USE DEFAULT IF NOT FORCED TO                 
         BNO   ADVGDFLT               CREATE TABLE ENTRY                        
*                                                                               
ADVGPUT1 DS    0H                                                               
*                                                                               
         NI    READCNTL,X'FF'-READCPTQ TURN OFF FORCE                           
*                                                                               
*        READ ADVERTISER RECORD AND ADD ADV TO TABLE                            
*                                                                               
*        BUILD ELEMENT IN FIRST TABLE SLOT                                      
*                                                                               
*        BUILD KEY                                                              
*                                                                               
         TM    READCNTL,READCSRQ   SKIP IF NOT SORTING ON ADV                   
         BNO   ADVGADD                                                          
*                                                                               
         MVC   ADVGKEY,KEY         SAVE CURRENT KEY                             
*                                                                               
         MVC   KEY,ADVTKEY         COPY DESIRED KEY                             
*                                  REP IN THIS KEY IS THAT FOR TABLE            
*                                  STORAGE                                      
*                                                                               
         MVC   RADVKREP-RADVKEY+KEY,REREP   SET FOR CURRENT REP                 
*                                                                               
         GOTO1 =A(SETREP),DMCB,KEY          SET CORRECT REP IN KEY              
*                                                                               
         LA    R4,KEY                                                           
         USING RADVKEY,R4          ESTABLISH ADVERTISER KEY                     
*                                                                               
         MVI   LKEY,L'RADVKEY      WANT EXACT MATCH                             
         OC    ADVGADV,ADVGADV     IF NO DEFAULT VALUE                          
         BNZ   *+8                                                              
         MVI   LKEY,RADVKADV-RADVKEY  MATCH UP TO ADV CODE                      
*                                                                               
         BRAS  RE,HIGH             READ DIRECTORY POINTER                       
*                                                                               
ADVTPLP  DS    0H                                                               
*                                                                               
         BAS   RE,KEYCOMP          CHECK IF KEY FOUND                           
         BNE   ADVGNFD                                                          
*                                                                               
         CLC   REDMREP,RADVKREP      MAKE SURE SAME REP                         
         BE    ADVTPFD                                                          
*                                                                               
ADVTPCN  DS    0H                                                               
*                                                                               
         BAS   RE,SEQ              READ NEXT ADV RECORD                         
         B     ADVTPLP                                                          
*                                                                               
ADVTPFD  DS    0H                                                               
*                                                                               
         MVC   ADVTKEY,KEY         SAVE FOUND KEY                               
*                                                                               
         GOTO1 =A(TBLREP),DMCB,ADVTKEY    FIND REP FOR STABLE STORAGE           
*                                                                               
         MVC   RADVKREP-RADVKEY+ADVTKEY,RETBREP  USE IN TABLE                   
*                                                                               
         MVC   ADVGAIO,REAIO       SAVE    CURRENT RECORD POINTER               
         MVC   REAIO,ADVGWRKA      READ INTO LOCAL WORKING STORAGE              
         BRAS  RE,GETREC           READ IN RECORD                               
         MVC   REAIO,ADVGAIO       RESTORE CURRENT RECORD POINTER               
*                                                                               
         L     R4,ADVGWRKA         POINT TO FOUND RECORD                        
*                                                                               
*        SAVE DESCRIPTION ELEMENT                                               
*                                                                               
         LA    R6,34(R4)           POINT TO FIRST ELEMENT IN RECORD             
*                                                                               
         SR    RF,RF                                                            
         IC    RF,1(R6)            GET ELEMENT LENGTH                           
*                                                                               
         CLI   0(R6),0             DONE AT END OF RECORD                        
         BE    ADVGDSCX                                                         
         CLI   0(R6),X'01'         FIND DESCRIPTION ELEMENT                     
         BE    *+16                                                             
         IC    RF,1(R6)            GET ELEMENT LENGTH                           
         LA    R6,0(RF,R6)         BUMP TO NEXT ELEMENT                         
         B     *-24                                                             
*                                                                               
         MVC   ADVTELM,0(R6)       SAVE DESCRIPTION ELEMENT                     
*                                     NOT ALL USED                              
ADVGDSCX DS    0H                                                               
*                                                                               
         LA    R4,ADVTENT          POINT TO ENTRY IN TABLE                      
*                                                                               
ADVGADD  DS    0H                                                               
*                                                                               
         MVC   READV,RADVKADV      SET CURRENT VALUE                            
*                                                                               
         GOTO1 BINSRCH,ADVTBSRP,('BSPADD',ADVTENT)  ADD TO TABLE                
*                                                                               
         ICM   R3,15,BSPAREC-BSPPRMS+ADVTBSRP   POINT TO INSERTED REC           
         BNZ   *+6                                                              
         DC    H'0'                DIE ON TABLE OVERFLOW                        
*                                                                               
         ST    R3,READVTA          A(CURRENT TABLE ENTRY)                       
         ST    R3,ADVTENTA                                                      
*                                                                               
         OI    READCNTL,READCFDQ   INDICATE TABLE ENTRY FOUND                   
*                                                                               
         B     ADVGOK                                                           
*                                                                               
ADVGDFLT DS    0H                  DEFAULT TO ADV IN CONTRACT KEY               
*                                                                               
         MVC   READV,ADVGADV       SET DEFAULT VALUE                            
         SR    R3,R3               INIT GROUP TABLE ENTRY POINTER               
         ST    R3,READVTA          NO     A(GROUP TABLE ENTRY)                  
*                                                                               
ADVGOK   DS    0H                                                               
*                                                                               
         OC    ADVGKEY,ADVGKEY     IF RECORD READ                               
         BZ    ADVGOKX                                                          
*                                                                               
         MVC   KEY,ADVGKEY         RESTORE CURRENT KEY                          
         BAS   RE,HIGH             RESET DIRECTORY POINTER                      
*                                                                               
ADVGOKX  DS    0H                                                               
*                                                                               
         CR    RB,RB               SET EQ CC                                    
*                                                                               
         B     ADVGETX                                                          
*                                                                               
ADVGNFD  DS    0H                                                               
*                                                                               
         MVC   READV,=16X'FF'      NOT FOUND VALUE                              
         MVC   ADVTENTA,=4X'FF'    INDICATE END OF TABLE REACHED                
         MVC   READVTA,ADVTENTA    RETURN A(ADV TABLE ENTRY)                    
*                                                                               
         OC    ADVGKEY,ADVGKEY     IF RECORD READ                               
         BZ    ADVGNFDX                                                         
*                                                                               
         MVC   KEY,ADVGKEY         RESTORE CURRENT KEY                          
         BAS   RE,HIGH             RESET DIRECTORY POINTER                      
*                                                                               
ADVGNFDX DS    0H                                                               
*                                                                               
         LTR   RB,RB               SET NEQ CC                                   
*                                                                               
ADVGETX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
ADVGAIO  DS    F                   DISK ADDR SAVEAREA                           
ADVGWRKA DS    A                   A(LOCAL WORKING STORAGE)                     
ADVGADV  DS    XL(L'RADVKADV)      DEFAULT SAVEAREA                             
ADVGKEY  DS    XL(L'KEY)           CURRENT KEY SAVE AREA                        
ADVGOPT  DS    CL1                 OPTION                                       
*                                  C'N' - NEXT AGV IN TABLE/FILE                
*                                  C'G' - FIND THIS AGY IN TABLE/FILE           
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - PRDGET'                         
***********************************************************************         
*                                                                     *         
*        RETRIEVE NEXT PRODUCT                                        *         
*                                                                     *         
*NTRY    PARM0+0   C'N' - FIND NEXT ENTRY IN TABLE                    *         
*                  C'G' - FIND ENTRY FOR DEFAULT                      *         
*        PARM0 ==> DEFAULT VALUE TO USE                               *         
*                                                                     *         
*EXIT    REPRD = X'FFFF' IF NONE FOUND                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
PRDGET   NTR1  BASE=*,LABEL=*,WORK=(R9,256)                                     
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         ST    R9,PRDGWRKA         SAVE A(LOCAL WORKING STOREAGE)               
*                                                                               
         L     R9,0(R1)            POINT TO DEFAULT VALUE                       
         MVC   PRDGPRD,0(R9)       SAVE DEFAULT VALUE                           
         MVC   PRDGOPT,0(R1)       SAVE OPTION                                  
*                                                                               
         XC    PRDGKEY,PRDGKEY     INIT KEY SAVEAREA                            
         XC    PRDGAIO,PRDGAIO     INIT IO CURRENT VALUE                        
*                                                                               
         SR    R3,R3               INIT TABLE ENTRY POINTER                     
*                                                                               
         ICM   R2,15,REPRDTBA      GET PRODUCT TABLE ADDRESS                    
         BZ    PRDGDFLT            USE DEFAULT IF NO TABLE                      
*                                                                               
         USING PRDTTABD,R2         ESTABLISH TABLE                              
*                                                                               
         XC    PRDTKEY,PRDTKEY     INIT KEY                                     
         XC    PRDTELM,PRDTELM     INIT DESCRIPTION ELEMENT                     
*                                                                               
         TM    REPRCNTL,REPRCFTQ   IF FILTERING THERE IS A TABLE                
         BNO   PRDGFLTN                                                         
*                                                                               
*        FIND FIRST ENTRY IN TABLE FOR REP                                      
*                                                                               
*        BUILD KEY                                                              
*                                                                               
         LA    R4,PRDTKEY-PRDTTABD(R2)   POINT TO KEY BUILD AREA                
         USING RPRDKEY,R4          ESTABLISH PRODUCT KEY                        
*                                                                               
         MVI   RPRDKTYP,RPRDKTYQ   RECORD ID                                    
         MVC   RPRDKADV,READV      ADV CODE                                     
         MVC   RPRDKPRD,PRDGPRD    DEFAULT PRODUCT CODE                         
         MVC   RPRDKREP,REREP      REP                                          
*                                                                               
         GOTO1 =A(TBLREP),DMCB,RPRDKEY  GET CORRECT REP IN KEY                  
*                                                                               
         MVC   RPRDKREP,RETBREP    SET REP FOR TABLE                            
*                                                                               
*        FIND FIRST PRODUCT FOR ADV                                             
*                                                                               
         L     R3,BSPATAB-BSPPRMS+PRDTBSRP   POINT TO 1ST TABLE ENTRY           
         USING PRDTENT,R3          ESTABLISH ENTRY                              
*                                                                               
PRDG1STL DS    0H                                                               
*                                                                               
         OC    PRDTKEY,PRDTKEY     TEST FOR END OF TABLE                        
         BZ    PRDG1STD                                                         
*                                                                               
         TM    PRDTKEY+27,X'80'    SKIP IF ENTRY DELETED                        
         BO    PRDG1STC                                                         
*                                                                               
         CLC   RPRDKADV-RPRDKEY+PRDTKEY,READV    OKAY IF CORRECT ADV            
         BNE   PRDG1STC                                                         
*                                                                               
         CLC   RPRDKREP-RPRDKEY+PRDTKEY,RETBREP  OKAY IF CORRECT REP            
         BE    PRDG1STF                                                         
*                                                                               
PRDG1STC DS    0H                                                               
*                                                                               
         A     R3,BSPLENR-BSPPRMS+PRDTBSRP   BUMP TO NEXT ENTRY                 
         B     PRDG1STL                                                         
*                                                                               
PRDG1STD DS    0H                                                               
*                                                                               
         B     PRDGNFD             END OF TABLE                                 
*                                                                               
PRDG1STF DS    0H                                                               
*                                                                               
         CLC   PRDGPRD,RESPACES    IF RE-STARTING TABLE                         
         BNH   PRDGFD                 USE FIRST ENTRY FOR REP                   
*                                                                               
         CLC   PRDGPRD,RPRDKPRD-RPRDKEY+PRDTKEY   IF DEFAULT LOWER              
         BL    PRDGFD              THAN FIRST ENTRY - USE 1ST ENTRY             
*                                                                               
         GOTO1 BINSRCH,PRDTBSRP,('BSPRDHI',RPRDKEY)   FIND IN TABLE             
*                                                                               
         CLI   BSPCNTL-BSPPRMS+PRDTBSRP,BSPNF IF NOT FOUND                      
         BE    PRDGNFD                           ADD TO TABLE                   
*                                                                               
         ICM   R3,15,BSPAREC-BSPPRMS+PRDTBSRP  POINT TO FOUND ELEMENT           
         BZ    PRDGNFD             NONE FOUND                                   
*                                                                               
         USING PRDTENT,R3          ESTABLISH TABLE ENTRY                        
*                                                                               
PRDGNXTL DS    0H                                                               
*                                                                               
         OC    PRDTKEY,PRDTKEY     TEST FOR END OF TABLE                        
         BZ    PRDGNXTD                                                         
*                                                                               
         TM    PRDTKEY+27,X'80'    SKIP IF ENTRY DELETED                        
         BO    PRDGNXTC                                                         
*                                                                               
         CLC   RPRDKADV-RPRDKEY+PRDTKEY,READV    OKAY IF CORRECT ADV            
         BNE   PRDGNXTC                                                         
*                                                                               
         CLC   RPRDKREP-RPRDKEY+PRDTKEY,RETBREP  OKAY IF CORRECT REP            
         BE    PRDGNXTF                                                         
*                                                                               
PRDGNXTC DS    0H                                                               
*                                                                               
         A     R3,BSPLENR-BSPPRMS+PRDTBSRP   BUMP TO NEXT ENTRY                 
         B     PRDGNXTL                                                         
*                                                                               
PRDGNXTD DS    0H                                                               
*                                                                               
         B     PRDGNFD             END OF TABLE                                 
*                                                                               
PRDGNXTF DS    0H                                                               
*                                                                               
         CLC   PRDGPRD,RPRDKPRD-RPRDKEY+PRDTKEY IF DEFAULT LOWER                
         BL    PRDGFD              USE ENTRY                                    
         BH    PRDGNFD                                                          
*                                                                               
*                                  TABLE ENTRY FOUND                            
*                                                                               
         CLI   PRDGOPT,C'G'        IF GETTING PRODUCT                           
         BE    PRDGFD                 USE THIS ENTRY                            
*                                  ELSE FIND NEXT IN TABLE                      
PRDGTNXL DS    0H                                                               
*                                                                               
         OC    PRDTKEY,PRDTKEY     TEST FOR END OF TABLE                        
         BZ    PRDGTNXD                                                         
*                                                                               
         TM    PRDTKEY+27,X'80'    SKIP IF ENTRY DELETED                        
         BO    PRDGTNXC                                                         
*                                                                               
         CLC   RPRDKADV-RPRDKEY+PRDTKEY,READV    OKAY IF CORRECT ADV            
         BNE   PRDGTNXC                                                         
*                                                                               
         CLC   RPRDKREP-RPRDKEY+PRDTKEY,RETBREP  OKAY IF CORRECT REP            
         BE    PRDGTNXF                                                         
*                                                                               
PRDGTNXC DS    0H                                                               
*                                                                               
         A     R3,BSPLENR-BSPPRMS+PRDTBSRP   BUMP TO NEXT ENTRY                 
         B     PRDGTNXL                                                         
*                                                                               
PRDGTNXD DS    0H                                                               
*                                                                               
         B     PRDGNFD             END OF TABLE                                 
*                                                                               
PRDGTNXF DS    0H                                                               
*                                                                               
         B     PRDGFD                                                           
*                                                                               
         DROP  R3                                                               
*                                                                               
*        PUT NEW PRODUCT IN TABLE                                               
*                                                                               
PRDGFLTN DS    0H                  PUT NEW PRODUCT IN TABLE                     
*                                                                               
         LA    R3,PRDTTAB          BUILD ENTRY IN FIRST TABLE SLOT              
         USING PRDTENT,R3                                                       
*                                                                               
*        BUILD KEY                                                              
*                                                                               
         LA    R4,PRDTKEY-PRDTTABD(R2)   POINT TO KEY BUILD AREA                
         USING RPRDKEY,R4          ESTABLISH PRODUCT KEY                        
*                                                                               
         MVI   RPRDKTYP,RPRDKTYQ   RECORD ID                                    
         MVC   RPRDKADV,READV      ADV CODE                                     
         MVC   RPRDKPRD,PRDGPRD    DEFAULT PRODUCT CODE                         
         MVC   RPRDKREP,REREP      REP                                          
*                                                                               
         GOTO1 =A(TBLREP),DMCB,RPRDKEY    SET CORRECT REP IN KEY                
*                                                                               
         MVC   RPRDKREP,RETBREP    SET REP FOR TABLE                            
*                                                                               
         GOTO1 BINSRCH,PRDTBSRP,('BSPFIND',RPRDKEY)   FIND IN TABLE             
*                                                                               
         CLI   BSPCNTL-BSPPRMS+PRDTBSRP,BSPNF IF NOT FOUND                      
         BE    PRDGPUT                           ADD TO TABLE                   
*                                                                               
         ICM   R3,15,BSPAREC-BSPPRMS+PRDTBSRP  POINT TO FOUND ELEMENT           
         BZ    PRDGPUT             NONE FOUND                                   
*                                                                               
         USING PRDTENT,R3          ESTABLISH TABLE ENTRY                        
*                                                                               
         CLI   PRDGOPT,C'G'        IF GETTING PRODUCT                           
         BE    PRDGFD                 USE THIS ENTRY                            
*                                                                               
*                                  ELSE FIND NEXT IN TABLE                      
PRDGUSEL DS    0H                                                               
*                                                                               
         OC    PRDTKEY,PRDTKEY     TEST FOR END OF TABLE                        
         BZ    PRDGUSED                                                         
*                                                                               
         TM    PRDTKEY+27,X'80'    SKIP IF ENTRY DELETED                        
         BO    PRDGUSEC                                                         
*                                                                               
         CLC   RPRDKADV-RPRDKEY+PRDTKEY,READV    OKAY IF CORRECT ADV            
         BNE   PRDGUSEC                                                         
*                                                                               
         CLC   RPRDKREP-RPRDKEY+PRDTKEY,RETBREP  OKAY IF CORRECT REP            
         BE    PRDGUSEF                                                         
*                                                                               
PRDGUSEC DS    0H                                                               
*                                                                               
         A     R3,BSPLENR-BSPPRMS+PRDTBSRP   BUMP TO NEXT ENTRY                 
         B     PRDGUSEL                                                         
*                                                                               
PRDGUSED DS    0H                                                               
*                                                                               
         B     PRDGNFD             END OF TABLE                                 
*                                                                               
PRDGUSEF DS    0H                                                               
*                                                                               
PRDGFD   DS    0H                                                               
*                                                                               
         ST    R3,PRDTENTA         SET TABLE ENTRY POINTER                      
         MVC   REPRDTA,PRDTENTA    RETURN A(GROUP TABLE ENTRY)                  
*                                                                               
         OI    REPRCNTL,REPRCFDQ   INDICATE TABLE ENTRY FOUND                   
*                                                                               
         MVC   REPRD,RPRDKPRD-RPRDKEY+PRDTKEY   RETURN PRODUCT                  
*                                                                               
         B     PRDGOK                                                           
*                                                                               
         DROP  R3                                                               
*                                                                               
PRDGPUT  DS    0H                                                               
*                                                                               
*        PUT NEW PRODUCT IN TABLE                                               
*                                                                               
         TM    REPRCNTL,REPRCFTQ   IF FILTERING                                 
         BO    PRDGNFD                ASSUME NOT FOUND                          
*                                                                               
         CLI   PRDGOPT,C'G'        IF GETTING ENTRY                             
         BE    PRDGPUT1                CREATE TABLE ENTRY                       
*                                                                               
         TM    REPRCNTL,REPRCPTQ   USE DEFAULT IF NOT FORCED TO                 
         BNO   PRDGDFLT               CREATE TABLE ENTRY                        
*                                                                               
PRDGPUT1 DS    0H                                                               
*                                                                               
         NI    REPRCNTL,X'FF'-REPRCPTQ TURN OFF FORCE                           
*                                                                               
*        READ PRODUCT RECORD AND ADD PRD TO TABLE                               
*                                                                               
*        BUILD ELEMENT IN FIRST TABLE SLOT                                      
*                                                                               
*        BUILD KEY                                                              
*                                                                               
         TM    REFTYPS1,REFTPTPQ   READ RECORD IF FILTERING ON PTP              
         BO    *+12                                                             
         TM    REPRCNTL,REPRCSRQ   SKIP IF NOT SORTING ON PRD                   
         BNO   PRDGADD                                                          
*                                                                               
         MVC   PRDGKEY,KEY         SAVE CURRENT KEY                             
         MVC   KEY,PRDTKEY         COPY DESIRED KEY                             
*                                                                               
         LA    R4,KEY                                                           
         USING RPRDKEY,R4          ESTABLISH PRODUCT KEY                        
*                                                                               
         MVC   RPRDKREP,REREP      DEFAULT TO CURRENT REP                       
*                                                                               
         GOTO1 =A(SETREP),DMCB,RPRDKEY      SET CORRECT REP IN KEY              
*                                                                               
         MVI   LKEY,L'RPRDKEY      WANT EXACT MATCH                             
         OC    PRDGPRD,PRDGPRD     IF NO DEFAULT VALUE                          
         BNZ   *+8                                                              
         MVI   LKEY,RPRDKPRD-RPRDKEY  MATCH UP TO PRD CODE                      
*                                                                               
         BRAS  RE,HIGH             READ DIRECTORY POINTER                       
*                                                                               
PRDTPLP  DS    0H                                                               
*                                                                               
         BAS   RE,KEYCOMP          CHECK IF KEY FOUND                           
         BNE   PRDGNFD                                                          
*                                                                               
         CLC   REDMREP,RPRDKREP      MAKE SURE SAME REP                         
         BE    PRDTPFD                                                          
*                                                                               
PRDTPCN  DS    0H                                                               
*                                                                               
         BAS   RE,SEQ              READ NEXT PRD RECORD                         
         B     PRDTPLP                                                          
*                                                                               
PRDTPFD  DS    0H                                                               
*                                                                               
         MVC   PRDTKEY,KEY         SAVE FOUND KEY                               
*                                                                               
         GOTO1 =A(TBLREP),DMCB,PRDTKEY FIND REP FOR TABLE                       
*                                                                               
         MVC   RPRDKREP-RPRDKEY+PRDTKEY,RETBREP   USE IN TABLE                  
*                                                                               
         MVC   PRDGAIO,REAIO       SAVE    CURRENT RECORD POINTER               
         MVC   REAIO,PRDGWRKA      READ INTO LOCAL WORKING STORAGE              
         BAS   RE,GETREC           READ IN RECORD                               
         MVC   REAIO,PRDGAIO       RESTORE CURRENT RECORD POINTER               
*                                                                               
         L     R4,PRDGWRKA         POINT TO FOUND RECORD                        
*                                                                               
         TM    REFTYPS1,REFTPTPQ   OKAY IF NOT FILTERING ON PTP                 
         JNO   PRDGPTPX                                                         
*                                                                               
         SR    RF,RF                                                            
         LA    R6,34(R4)           POINT TO FIRST ELEMENT IN RECORD             
*                                                                               
*        FIND NETWORK CONTRACT ELEMENT                                          
*                                                                               
PRGPTPLP DS    0H                                                               
*                                                                               
         CLI   0(R6),0             CHECK FOR END OF RECORD                      
         JE    PRGPTPDN               DROP IF NO ELEMENT                        
*                                                                               
         CLI   0(R6),X'02'         FIND NETWORK CONTRACT ELEMENT                
         JE    PRGPTPFD                                                         
*                                                                               
PRGPTPCN DS    0H                                                               
*                                                                               
         IC    RF,1(R6)                                                         
         LA    R6,0(RF,R6)         NEXT ELEMENT                                 
         J     PRGPTPLP                                                         
*                                                                               
PRGPTPDN DS    0H                  NO NETWORK CONTRACT ELEMENT                  
*                                                                               
         TM    REFTYPN1,REFTPTPQ      KEEP IF NEGATIVE FILTERING                
         BO    PRDGPTPX                                                         
         B     PRDGNFD                ELSE DROP                                 
*                                                                               
PRGPTPFD DS    0H                                                               
*                                                                               
         USING RPRDNELM,R6         ESTABLISH NETWORK CONTRACT ELEMENT           
*                                                                               
         MVC   REPTP,RPRDNPNT      GET PTP                                      
*                                                                               
         CLC   REPTP,SPACES        IF NO SALESPERSON                            
         BH    *+16                                                             
         TM    REFTYPN1,REFTPTPQ      KEEP IF NEGATIVE FILTERING                
         BO    PRDGPTPX                                                         
         B     PRDGNFD                ELSE DROP                                 
*                                                                               
         L     R9,=A(STDPPTP)      SET TABLE PARAMETERS                         
*                                                                               
         GOTO1 =A(PTPGET),DMCB,(C'G',REPTP)                                     
         BNZ   PRDGNFD             NOT FOUND - DROP                             
*                                                                               
         CLC   REPTP,RPRDNPNT      DROP IF NOT WANTED PTP                       
         BNE   PRDGNFD                                                          
*                                                                               
PRDGPTPX DS    0H                                                               
*                                                                               
*        SAVE DECRIPTION ELEMENT                                                
*                                                                               
         LA    R6,34(R4)           POINT TO FIRST ELEMENT IN RECORD             
*                                                                               
         SR    RF,RF                                                            
         LA    R1,PRDTELM          START OF ELEMENTS SAVEAREA                   
*                                                                               
PRDGELLP DS    0H                                                               
*                                                                               
         CLI   0(R6),0             DONE AT END OF RECORD                        
         BE    PRDGELDN                                                         
*                                                                               
         CLI   0(R6),X'01'         FIND DESCRIPTION ELEMENT                     
         BE    *+8                                                              
         CLI   0(R6),X'02'         FIND NETWORK CONTRACT ELEMENT                
         BNE   PRDGELCN                                                         
*                                                                               
         IC    RF,1(R6)            GET ELEMENT LENGTH                           
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),0(R6)       SAVE ELEMENT                                 
*                                                                               
         LA    R1,1(RF,R1)         POINT TO NEXT AREA                           
*                                                                               
PRDGELCN DS    0H                                                               
*                                                                               
         IC    RF,1(R6)            GET ELEMENT LENGTH                           
         LA    R6,0(RF,R6)         BUMP TO NEXT ELEMENT                         
         B     PRDGELLP                                                         
*                                                                               
PRDGELDN DS    0H                                                               
*                                                                               
         LA    R4,PRDTENT          POINT TO KEY IN TABLE                        
*                                                                               
PRDGADD  DS    0H                                                               
*                                                                               
         MVC   REPRD,RPRDKPRD      SET CURRENT VALUE                            
*                                                                               
         GOTO1 BINSRCH,PRDTBSRP,('BSPADD',PRDTENT)  ADD TO TABLE                
*                                                                               
         ICM   R3,15,BSPAREC-BSPPRMS+PRDTBSRP   POINT TO INSERTED REC           
         BNZ   *+6                                                              
         DC    H'0'                DIE ON TABLE OVERFLOW                        
*                                                                               
         ST    R3,REPRDTA          A(CURRENT TABLE ENTRY)                       
         ST    R3,PRDTENTA                                                      
*                                                                               
         OI    REPRCNTL,REPRCFDQ   INDICATE TABLE ENTRY FOUND                   
*                                                                               
         B     PRDGOK                                                           
*                                                                               
PRDGDFLT DS    0H                  DEFAULT TO PRD IN CONTRACT KEY               
*                                                                               
         MVC   REPRD,PRDGPRD       SET DEFAULT VALUE                            
         SR    R3,R3               INIT GROUP TABLE ENTRY POINTER               
         ST    R3,REPRDTA          NO     A(GROUP TABLE ENTRY)                  
*                                                                               
PRDGOK   DS    0H                                                               
*                                                                               
         OC    PRDGKEY,PRDGKEY     IF RECORD READ                               
         BZ    PRDGOKX                                                          
*                                                                               
         MVC   KEY,PRDGKEY         RESTORE CURRENT KEY                          
         BAS   RE,HIGH             RESET DIRECTORY POINTER                      
*                                                                               
PRDGOKX  DS    0H                                                               
*                                                                               
         CR    RB,RB               SET EQ CC                                    
*                                                                               
         B     PRDGETX                                                          
*                                                                               
PRDGNFD  DS    0H                                                               
*                                                                               
         MVC   REPRD,=16X'FF'      NOT FOUND VALUE                              
         MVC   PRDTENTA,=4X'FF'    INDICATE END OF TABLE REACHED                
         MVC   REPRDTA,PRDTENTA    RETURN A(PRODUCT TABLE ENTRY)                
*                                                                               
         OC    PRDGKEY,PRDGKEY     IF RECORD READ                               
         BZ    PRDGNFDX                                                         
*                                                                               
         MVC   KEY,PRDGKEY         RESTORE CURRENT KEY                          
         BAS   RE,HIGH             RESET DIRECTORY POINTER                      
*                                                                               
PRDGNFDX DS    0H                                                               
*                                                                               
         LTR   RB,RB               SET NEQ CC                                   
*                                                                               
PRDGETX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
PRDGOPT  DS    XL1                 OPTION                                       
*                                  C'N' - NEXT PRD IN TABLE/FILE                
*                                  C'G' - FIND THIS PRD IN TABLE/FILE           
         DS    XL3                 SPARE                                        
*                                                                               
PRDGAIO  DS    A                   A(CURRENT IOAREA)                            
PRDGWRKA DS    A                   A(LOCAL WORKING STORAGE)                     
PRDGPRD  DS    XL(L'RPRDKPRD)      DEFAULT SAVEAREA                             
PRDGKEY  DS    XL(L'KEY)           CURRENT KEY SAVE AREA                        
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - BCDGET'                         
***********************************************************************         
*                                                                     *         
*        RETRIEVE NEXT BUY CODE OR TYPE                               *         
*                                                                     *         
*NTRY    PARM0+0   C'N' - FIND NEXT ENTRY IN TABLE                    *         
*                  C'G' - FIND ENTRY FOR DEFAULT                      *         
*        PARM0 ==> DEFAULT VALUE TO USE                               *         
*                                                                     *         
*        PARM1+0   C'1'  - BUY TYPE 1                                 *         
*                  C'2'  - BUY TYPE 2                                 *         
*                  C'B'  - BUY CODE                                   *         
*                                                                     *         
*EXIT    REBCD = X'FFFF' IF NONE FOUND                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
BCDGET   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         L     R9,0(R1)            POINT TO DEFAULT VALUE                       
         MVC   BCDGOPT,0(R1)       SAVE OPTION                                  
         MVC   BCDGKEY,KEY         SAVE CURRENT KEY                             
         MVC   BCDGTYPE,4(R1)      SAVE CODE/TYPE OPTION                        
*                                                                               
         ICM   R2,15,REBCDTBA      GET BCD TABLE ADDRESS                        
         BZ    BCDGDFLT            USE DEFAULT IF NO TABLE                      
*                                                                               
         USING BCDTTABD,R2         ESTABLISH TABLE                              
*                                                                               
         LM    R3,R5,BCDTBXLE      LOAD BXLE REGISTERS                          
         USING BCDTENT,R3          ESTABLISH TABLE ENTRY                        
*                                  R3 ==> FIRST TABLE ENTRY                     
         CR    R3,R5               USE DEFAULT IF TABLE EMPTY                   
         BNL   BCDGDFLT                                                         
*                                                                               
         XC    KEY,KEY             INIT KEY BUILD AREA                          
         LA    R6,KEY              ESTABLISH BUY CODE RECORD                    
         USING RSPBKEY,R6                                                       
*                                                                               
         MVI   RSPBKTYP,RBCDKTYQ   SET KEY FOR BUY CODE                         
         MVC   RSPBKREP,REREP      DEFAULT TO CURRENT REP                       
*                                                                               
         GOTO1 =A(TBLREP),DMCB,KEY   FIND REP FOR TABLE SEARCH                  
*                                                                               
         MVC   RSPBKREP,RETBREP    SET TABLE SEARCH REP                         
*                                                                               
         MVC   KEY,RSPBKEY         RESTORE KEY                                  
*                                                                               
         DROP  R6                                                               
*                                                                               
BCDGREPL DS    0H                                                               
*                                                                               
         CLI   BCDGOPT,C'G'        SKIP DELETED TEST IF GET OPTION              
         BE    *+12                                                             
         TM    BCDTKEY+27,X'80'    SKIP IF DELETED                              
         BO    BCDGREPC                                                         
*                                                                               
         CLC   RSPBKREP-RSPBKEY+BCDTKEY,RETBREP FIND 1ST FOR REP                
         BE    BCDGREPF                                                         
*                                                                               
BCDGREPC DS    0H                                                               
         BXLE  R3,R4,BCDGREPL                                                   
         B     BCDGNFD             REP NOT IN TABLE                             
*                                                                               
BCDGREPF DS    0H                                                               
*                                                                               
         ST    R3,BCDG1STA         SAVE STARTING ADDRESS                        
*                                                                               
         CLI   BCDGTYPE,C'B'       IF BUY CODE WANTED                           
         BNE   BCDG10                                                           
*                                                                               
         OC    BCDTBCDA,BCDTBCDA      DONE IF FIRST TIME                        
         BZ    BCDGLOOP                                                         
*                                                                               
         OC    REBCD,REBCD            DONE IF RESTARTING TABLE                  
         BZ    BCDGLOOP                                                         
*                                                                               
         CLC   BCDTBCDA,=4X'FF'    IF END OF TABLE LAST TIME                    
         BE    BCDGLOOP               RESTART TABLE                             
*                                                                               
         ICM   R3,15,BCDTBCDA      POINT TO LAST ENTRY USED                     
*                                                                               
         B     BCDG1STX                                                         
*                                                                               
BCDG10   DS    0H                                                               
*                                                                               
         CLI   BCDGTYPE,C'1'       IF BUY TYPE 1 WANTED                         
         BNE   BCDG20                                                           
*                                                                               
         OC    BCDTBT1A,BCDTBT1A      DONE IF FIRST TIME                        
         BZ    BCDGLOOP                                                         
*                                                                               
         OC    REBT1,REBT1            DONE IF RESTARTING TABLE                  
         BZ    BCDGLOOP                                                         
*                                                                               
         CLC   BCDTBT1A,=4X'FF'    IF END OF TABLE LAST TIME                    
         BE    BCDGLOOP               RESTART TABLE                             
*                                                                               
         ICM   R3,15,BCDTBT1A      POINT TO LAST ENTRY USED                     
*                                                                               
         B     BCDG1STX                                                         
*                                                                               
BCDG20   DS    0H                                                               
*                                                                               
         CLI   BCDGTYPE,C'2'       IF BUY TYPE 2 WANTED                         
         BNE   BCDG30                                                           
*                                                                               
         OC    BCDTBT2A,BCDTBT2A      DONE IF FIRST TIME                        
         BZ    BCDGLOOP                                                         
*                                                                               
         OC    REBT2,REBT2            DONE IF RESTARTING TABLE                  
         BZ    BCDGLOOP                                                         
*                                                                               
         CLC   BCDTBT2A,=4X'FF'    IF END OF TABLE LAST TIME                    
         BE    BCDGLOOP               RESTART TABLE                             
*                                                                               
         ICM   R3,15,BCDTBT2A      POINT TO LAST ENTRY USED                     
*                                                                               
         B     BCDG1STX                                                         
*                                                                               
BCDG30   DS    0H                                                               
*                                                                               
BCDG1STX DS    0H                                                               
*                                                                               
         CLC   RSPBKREP-RSPBKEY+BCDTKEY,RETBREP MATCH TABLE REP                 
         BNE   BCDGLOOP                                                         
*                                                                               
         LHI   RF,L'RSPBKCOD       ASSUME BUY CODE                              
         CLI   BCDGTYPE,C'B'       IF NOT THEN                                  
         BE    *+8                                                              
         LHI   RF,L'RSPBKCOD-1        MUST BE A BUY TYPE                        
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   RSPBKCOD-RSPBKEY+BCDTKEY(0),0(R9) IF PAST DEFAULT                
         BNH   *+8                 RE-START TABLE                               
         ICM   R3,15,BCDG1STA      POINT TO FIRST ENTRY IN TABLE                
*                                                                               
BCDGLOOP DS    0H                                                               
*                                                                               
         CLI   BCDGOPT,C'G'        SKIP DELETED TEST IF GET OPTION              
         BE    *+12                                                             
         TM    BCDTKEY+27,X'80'    SKIP IF DELETED                              
         BO    BCDGCONT                                                         
*                                                                               
         CLC   RSPBKREP-RSPBKEY+BCDTKEY,RETBREP MATCH TABLE REP                 
         BNE   BCDGCONT                                                         
*                                                                               
         CLI   BCDGTYPE,C'B'       IF GETTING A BUY TYPE                        
         BNE   BCDGLP10                                                         
*                                                                               
         CLI   RSPBKTCD-RSPBKEY+BCDTKEY,1    MUST BE A BUY CODE KEY             
         BNE   BCDGCONT                                                         
*                                                                               
         CLC   RSPBKCOD-RSPBKEY+BCDTKEY,0(R9) MATCH TO DEFAULT                  
         BH    BCDGFD              USE IF PAST DEFAULT                          
         BL    BCDGCONT            SKIP IF LESS THAN                            
*                                                                               
         CLI   BCDGOPT,C'G'        IF GET OPTION                                
         BE    BCDGFD                 USE IF EQUAL                              
*                                                                               
         B     BCDGCONT                                                         
*                                                                               
BCDGLP10 DS    0H                                                               
*                                  MUST BE A BUY TYPE                           
         CLI   RSPBKTCD-RSPBKEY+BCDTKEY,0    MUST BE A BUY TYPE KEY             
         BNE   BCDGCONT                                                         
*                                                                               
         CLC   RSPBKCOD-RSPBKEY+BCDTKEY(2),0(R9) MATCH TO DEFAULT               
         BH    BCDGFD              USE IF PAST DEFAULT                          
         BL    BCDGCONT            SKIP IF LESS THAN                            
*                                                                               
         CLI   BCDGOPT,C'G'        IF GET OPTION                                
         BE    BCDGFD                 USE IF EQUAL                              
*                                                                               
         B     BCDGCONT                                                         
*                                                                               
BCDGCONT DS    0H                                                               
*                                                                               
         BXLE  R3,R4,BCDGLOOP      POINT TO NEXT ENTRY IN TABLE                 
*                                                                               
BCDGDONE DS    0H                                                               
*                                                                               
         B     BCDGNFD             END OF TABLE                                 
*                                                                               
BCDGFD   DS    0H                                                               
*                                                                               
         CLI   BCDGTYPE,C'B'       IF BUY CODE                                  
         BNE   BCDGFD10                                                         
*                                                                               
         ST    R3,BCDTBCDA         SET TABLE ENTRY POINTER                      
         MVC   REBCDTA,BCDTBCDA    RETURN A(BUY  CODE TABLE ENTRY)              
*                                                                               
         MVC   REBCD,RSPBKCOD-RSPBKEY+BCDTKEY   RETURN GROUP                    
*                                                                               
         B     BCDGOK                                                           
*                                                                               
BCDGFD10 DS    0H                                                               
*                                                                               
         CLI   BCDGTYPE,C'1'       IF BUY TYPE 1                                
         BNE   BCDGFD20                                                         
*                                                                               
         ST    R3,BCDTBT1A         SET TABLE ENTRY POINTER                      
         MVC   REBT1TA,BCDTBT1A    RETURN A(BUY  TYPE 1 TABLE ENTRY)            
*                                                                               
         MVC   REBT1,RSPBKCOD-RSPBKEY+BCDTKEY   RETURN GROUP                    
*                                                                               
         B     BCDGOK                                                           
*                                                                               
BCDGFD20 DS    0H                  MUST BE BUY TYPE 2                           
*                                                                               
         ST    R3,BCDTBT2A         SET TABLE ENTRY POINTER                      
         MVC   REBT2TA,BCDTBT2A    RETURN A(BUY  TYPE 2 TABLE ENTRY)            
*                                                                               
         MVC   REBT2,RSPBKCOD-RSPBKEY+BCDTKEY   RETURN GROUP                    
*                                                                               
         B     BCDGOK                                                           
*                                                                               
BCDGDFLT DS    0H                  DEFAULT TO BCD PASSED                        
*                                                                               
         CLI   BCDGTYPE,C'B'       IF BUY CODE                                  
         BNE   BCDGDF10                                                         
*                                                                               
         MVC   REBCD,0(R9)         SET DEFAULT VALUE                            
*                                                                               
         SR    R3,R3               INIT BUY CODE TABLE ENTRY POINTER            
         ST    R3,REBCDTA          NO BUY CODE TABLE ENTRY                      
*                                                                               
         B     BCDGOK                                                           
*                                                                               
BCDGDF10 DS    0H                                                               
*                                                                               
         CLI   BCDGTYPE,C'1'       IF BUY TYPE 1                                
         BNE   BCDGDF20                                                         
*                                                                               
         MVC   REBT1,0(R9)         SET DEFAULT VALUE                            
*                                                                               
         SR    R3,R3               INIT BUY TYPE 1 TABLE ENTRY POINTER          
         ST    R3,REBT1TA          NO BUY TYPE 1 TABLE ENTRY                    
*                                                                               
         B     BCDGOK                                                           
*                                                                               
BCDGDF20 DS    0H    MUST BE BUY TYPE 2                                         
*                                                                               
         MVC   REBT2,0(R9)         SET DEFAULT VALUE                            
*                                                                               
         SR    R3,R3               INIT BUY TYPE 2 TABLE ENTRY POINTER          
         ST    R3,REBT2TA          NO BUY TYPE 2 TABLE ENTRY                    
*                                                                               
         B     BCDGOK                                                           
*                                                                               
BCDGOK   DS    0H                                                               
*                                                                               
         CR    RB,RB               SET EQ CC                                    
*                                                                               
         B     BCDGETX                                                          
*                                                                               
BCDGNFD  DS    0H                                                               
*                                                                               
         CLI   BCDGTYPE,C'B'       IF BUY CODE                                  
         BNE   BCDGNF10                                                         
*                                                                               
         MVC   REBCD,=16X'FF'      NOT FOUND VALUE                              
         MVC   BCDTBCDA,=4X'FF'    INDICATE END OF TABLE REACHED                
         MVC   REBCDTA,BCDTBCDA    RETURN A(BUY CODE TABLE ENTRY)               
*                                                                               
         LTR   RB,RB               SET NEQ CC                                   
*                                                                               
         B     BCDGETX                                                          
*                                                                               
BCDGNF10 DS    0H                                                               
*                                                                               
         CLI   BCDGTYPE,C'1'       IF BUY TYPE 1                                
         BNE   BCDGNF20                                                         
*                                                                               
         MVC   REBT1,=16X'FF'      NOT FOUND VALUE                              
         MVC   BCDTBT1A,=4X'FF'    INDICATE END OF TABLE REACHED                
         MVC   REBT1TA,BCDTBT1A    RETURN A(BUY TYPE 1 TABLE ENTRY)             
*                                                                               
         LTR   RB,RB               SET NEQ CC                                   
*                                                                               
         B     BCDGETX                                                          
*                                                                               
BCDGNF20 DS    0H                  MUST BE BUY TYPE 2                           
*                                                                               
         MVC   REBT2,=16X'FF'      NOT FOUND VALUE                              
         MVC   BCDTBT2A,=4X'FF'    INDICATE END OF TABLE REACHED                
         MVC   REBT2TA,BCDTBT2A    RETURN A(BUY TYPE 2 TABLE ENTRY)             
*                                                                               
         LTR   RB,RB               SET NEQ CC                                   
*                                                                               
         B     BCDGETX                                                          
*                                                                               
BCDGETX  DS    0H                                                               
         MVC   KEY,BCDGKEY         RESTORE CURRENT KEY                          
         XIT1                                                                   
*                                                                               
         DS    0D                  ALIGNMENT                                    
BCDGTYPE DS    XL1                 C'B'  BUY CODE                               
*                                  C'1   BUY TYPE 1 CODE                        
*                                  C'2   BUY TYPE 2 CODE                        
BCDGOPT  DS    XL1                 C'G'  GET CODE                               
*                                  C'N'  GET NEXT CODE                          
         DS    XL2                 SPARE                                        
BCDG1STA DS    A                   A(FIRST ENTRY FOR REP)                       
BCDGKEY  DS    XL(L'KEY)           KEY SAVEAREA                                 
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - AGYGET'                         
***********************************************************************         
*                                                                     *         
*        RETRIEVE NEXT AGY/AGY-OFF                                    *         
*                                                                     *         
*NTRY    PARM0+0   C'N' FIND NEXT ENTRY IN TABLE                      *         
*                  C'G' FIND ENTRY FOR DEFAULT                        *         
*        PARM0 ==> DEFAULT VALUE TO USE                               *         
*                                                                     *         
*EXIT    REAGY = X'FFFF' IF NONE FOUND                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
AGYGET   DS    0D                                                               
AGGET    NTR1  BASE=*,LABEL=*,WORK=(R9,256)                                     
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         ST    R9,AGYGWRKA         SAVE A(LOCAL WORKING STORAGE)                
         MVI   AGYGCNTL,0          INIT CONTROL BYTE                            
*                                                                               
         L     R9,0(R1)            POINT TO DEFAULT VALUE                       
         MVC   AGYGOPT,0(R1)       SAVE OPTION                                  
         MVC   AGYGAGY(6),0(R9)    SAVE DEFAULT VALUE                           
         OC    AGYGAGY(6),RESPACES BLANK FILL                                   
*                                                                               
         XC    AGYGKEY,AGYGKEY     INIT KEY SAVEAREA                            
         XC    AGYGAIO,AGYGAIO     INIT IO CURRENT VALUE                        
*                                                                               
         SR    R3,R3               INIT TABLE ENTRY POINTER                     
*                                                                               
         ICM   R2,15,REAG2TBA      GET AGY/AGY-OFF TABLE ADDRESS                
         BZ    AGYGDFLT            USE DEFAULT IF NO TABLE                      
*                                                                               
         USING AGYTTABD,R2         ESTABLISH TABLE                              
*                                                                               
         TM    REAGCNTL,REAGCFTQ   IF FILTERING THERE IS A TABLE                
         BNO   AGYGFLTN                                                         
*                                                                               
         LA    R4,AGYTKEY-AGYTTABD(R2)   POINT TO KEY BUILD AREA                
         USING RAGY2KEY,R4         ESTABLISH AGENCY KEY                         
*                                                                               
         MVI   RAGK2TYP,RAGK2TYQ   RECORD ID                                    
         MVC   RAGK2AGY(6),AGYGAGY DEFAULT AGENCY CODE/AOF CODE                 
         MVC   RAGK2REP,REREP      REP                                          
*                                                                               
         GOTOR TBLREP,DMCB,RAGY2KEY  SET CORRECT REP IN KEY                     
*                                                                               
         MVC   RAGK2REP,RETBREP    SET REP FOR TABLE                            
*                                                                               
         L     R3,BSPATAB-BSPPRMS+AGYTBSRP   POINT TO 1ST TABLE ENTRY           
         USING AGYTENT,R3          ESTABLISH ENTRY                              
*                                                                               
AGYG1STL DS    0H                                                               
*                                                                               
         OC    AGYTKEY,AGYTKEY     TEST FOR END OF TABLE                        
         BZ    AGYGNFD             END OF TABLE                                 
*                                                                               
         CLC   RAGK2REP-RAGY2KEY+AGYTKEY,RETBREP OKAY IF CORRECT REP            
         BNE   AGYG1STC                                                         
*                                                                               
         TM    AGYTKEY+27,X'80'    SKIP IF ENTRY DELETED                        
         BO    AGYG1STC                                                         
*                                                                               
         B     AGYG1STD                                                         
*                                                                               
AGYG1STC DS    0H                                                               
*                                                                               
         A     R3,BSPLENR-BSPPRMS+AGYTBSRP   BUMP TO NEXT ENTRY                 
         B     AGYG1STL                                                         
*                                                                               
AGYG1STD DS    0H                                                               
*                                                                               
         CLC   AGYGAGY(6),RESPACES IF RE-STARTING TABLE                         
         BNH   AGYGFD                 USE FIRST ENTRY IN TABLE                  
*                                                                               
         CLC   AGYGAGY(6),RAGK2AGY-RAGY2KEY+AGYTKEY  IF DEFAULT LOWER           
         BL    AGYGFD              THAN FIRST ENTRY - USE 1ST ENTRY             
*                                                                               
         GOTO1 BINSRCH,AGYTBSRP,('BSPRDHI',RAGY2KEY)  FIND DFLT IN TAB          
*                                                                               
         CLI   BSPCNTL-BSPPRMS+AGYTBSRP,BSPNF IF NOT FOUND                      
         BE    AGYGNFD                                                          
*                                                                               
         ICM   R3,15,BSPAREC-BSPPRMS+AGYTBSRP  POINT TO FOUND ENTRY             
         BZ    AGYGNFD             NONE FOUND                                   
*                                                                               
AGYGDFTL DS    0H                                                               
*                                                                               
         OC    AGYTKEY,AGYTKEY     TEST FOR END OF TABLE                        
         BZ    AGYGNFD             END OF TABLE                                 
*                                                                               
         CLC   RAGK2REP-RAGY2KEY+AGYTKEY,RETBREP OKAY IF CORRECT REP            
         BNE   AGYGDFTC                                                         
*                                                                               
         TM    AGYTKEY+27,X'80'    SKIP IF ENTRY DELETED                        
         BO    AGYGDFTC                                                         
*                                                                               
         B     AGYGDFTD            1ST ENTRY PAST DFLT FOUND                    
*                                                                               
AGYGDFTC DS    0H                                                               
*                                                                               
         A     R3,BSPLENR-BSPPRMS+AGYTBSRP   BUMP TO NEXT ENTRY                 
         B     AGYGDFTL                                                         
*                                                                               
AGYGDFTD DS    0H                                                               
*                                                                               
         CLC   RAGK2AGY-RAGY2KEY+AGYTKEY(6),AGYGAGY IF DEFAULT LOWER            
         BH    AGYGFD                    USE IT                                 
         BL    AGYGNFD                                                          
*                                                                               
*                                  TABLE ENTRY FOUND                            
*                                                                               
         CLI   AGYGOPT,C'G'        IF GETTING AGENCY                            
         BE    AGYGFD                 USE THIS ENTRY                            
*                                                                               
*        FIND NEXT ENTRY IN TABLE                                               
*                                                                               
AGYGNXLP DS    0H                                                               
*                                                                               
         A     R3,BSPLENR-BSPPRMS+AGYTBSRP   BUMP TO NEXT ENTRY                 
*                                                                               
         OC    AGYTKEY,AGYTKEY     END OF TABLE IF NO KEY                       
         BZ    AGYGNXDN                                                         
*                                                                               
         CLC   RAGK2REP-RAGY2KEY+AGYTKEY,RETBREP   MATCH ON REP                 
         BNE   AGYGNXCN                                                         
*                                                                               
         TM    AGYTKEY+27,X'80'    SKIP IF ENTRY DELETED                        
         BO    AGYGNXCN                                                         
*                                                                               
         B     AGYGNXDN                                                         
*                                                                               
AGYGNXCN DS    0H                                                               
         B     AGYGNXLP                                                         
*                                                                               
AGYGNXDN DS    0H                                                               
*                                                                               
         OC    AGYTKEY,AGYTKEY     END OF TABLE IF NO KEY                       
         BZ    AGYGNFD                                                          
*                                                                               
         B     AGYGFD                                                           
*                                                                               
         DROP  R3                                                               
*                                                                               
AGYGFLTN DS    0H                                                               
*                                                                               
         LA    R3,AGYTTAB          BUILD ENTRY IN 1ST TABLE SLOT                
*                                                                               
         USING AGYTENT,R3          ESTABLISH ENTRY                              
*                                                                               
         XC    AGYTKEY,AGYTKEY     INIT TABLE ENTRY                             
         XC    AGYTELM,AGYTELM                                                  
         XC    AGYTFAX,AGYTFAX                                                  
         XC    AGYTEXAD,AGYTEXAD                                                
*                                                                               
*        BUILD KEY                                                              
*                                                                               
         LA    R4,AGYTKEY                                                       
         USING RAGY2KEY,R4         ESTABLISH AGENCY KEY                         
*                                                                               
         MVI   RAGK2TYP,RAGK2TYQ   RECORD ID                                    
         MVC   RAGK2AGY(6),AGYGAGY DEFAULT AGENCY CODE/AOF CODE                 
         MVC   RAGK2REP,REREP      REP                                          
*                                                                               
         GOTOR TBLREP,DMCB,RAGY2KEY SET CORRECT REP IN KEY                      
*                                                                               
         MVC   RAGK2REP,RETBREP    SET REP FOR TABLE                            
*                                                                               
         GOTO1 BINSRCH,AGYTBSRP,('BSPFIND',RAGY2KEY)  FIND IN TABLE             
*                                                                               
         CLI   BSPCNTL-BSPPRMS+AGYTBSRP,BSPNF IF NOT FOUND                      
         BE    AGYGPUT                           ADD TO TABLE                   
*                                                                               
         ICM   R3,15,BSPAREC-BSPPRMS+AGYTBSRP  POINT TO FOUND ELEMENT           
         BZ    AGYGPUT             NONE FOUND                                   
*                                                                               
         USING AGYTENT,R3          ESTABLISH TABLE ENTRY                        
*                                                                               
         TM    AGYTKEY+27,X'80'    DROP IF ENTRY DELETED                        
         BO    AGYGNFD                                                          
*                                                                               
         CLI   AGYGOPT,C'G'        IF GETTING AGENCY                            
         BE    AGYGFD                 USE THIS ENTRY                            
*                                                                               
*        FIND NEXT ENTRY IN TABLE                                               
*                                                                               
AGYGNXTL DS    0H                                                               
*                                                                               
         A     R3,BSPLENR-BSPPRMS+AGYTBSRP   BUMP TO NEXT ENTRY                 
*                                                                               
         OC    AGYTKEY,AGYTKEY     TEST FOR END OF TABLE                        
         BZ    AGYGNFD             END OF TABLE                                 
*                                                                               
         CLC   RAGK2REP-RAGY2KEY+AGYTKEY,RETBREP OKAY IF CORRECT REP            
         BNE   AGYGNXTC                                                         
*                                                                               
         TM    AGYTKEY+27,X'80'    SKIP IF ENTRY DELETED                        
         BO    AGYGNXTC                                                         
*                                                                               
         B     AGYGNXTD                                                         
*                                                                               
AGYGNXTC DS    0H                                                               
*                                                                               
         B     AGYGNXTL                                                         
*                                                                               
AGYGNXTD DS    0H                                                               
*                                                                               
         B     AGYGFD                                                           
*                                                                               
AGYGFD   DS    0H                                                               
*                                                                               
         ST    R3,AGYTENTA         SET TABLE ENTRY POINTER                      
         MVC   REAGYTA,AGYTENTA    RETURN A(AGENCY TABLE ENTRY)                 
         MVC   REAG2TA,AGYTENTA    RETURN A(AGENCY TABLE ENTRY)                 
*                                                                               
         OI    REAGCNTL,REAGCFDQ   INDICATE TABLE ENTRY FOUND                   
*                                                                               
         MVC   REAGY,RAGK2AGY-RAGY2KEY+AGYTKEY  RETURN NEXT AGENCY              
         MVC   REAOF,RAGK2AOF-RAGY2KEY+AGYTKEY  RETURN NEXT AOF                 
*                                                                               
         B     AGYGOK                                                           
*                                                                               
         DROP  R3                                                               
*                                                                               
*        PUT NEW AGENCY IN TABLE                                                
*                                                                               
AGYGPUT  DS    0H                  PUT NEW AGENCY IN TABLE                      
*                                                                               
         TM    REAGCNTL,REAGCFTQ   IF FILTERING                                 
         BO    AGYGNFD                ASSUME NOT FOUND                          
*                                                                               
         CLI   AGYGOPT,C'G'        IF GETTING ENTRY                             
         BE    AGYGPUT1                CREATE TABLE ENTRY                       
*                                                                               
         TM    REAGCNTL,REAGCPTQ   USE DEFAULT IF NOT FORCED TO                 
         BNO   AGYGDFLT               CREATE TABLE ENTRY                        
*                                                                               
AGYGPUT1 DS    0H                  PUT NEW AGENCY IN TABLE                      
*                                                                               
         NI    REAGCNTL,X'FF'-REAGCPTQ TURN OFF FORCE                           
*                                                                               
*        READ AGENCY RECORD AND ADD AGY TO TABLE                                
*                                                                               
*        BUILD ENTRY IN FIRST TABLE SLOT                                        
*                                                                               
*        BUILD KEY                                                              
*                                                                               
         TM    REAGCNTL,REAGCSRQ   SKIP IF NOT SORTING ON AGY                   
         BNO   AGYGDSCX                                                         
*                                                                               
         CLI   AGYGCNTL,C'2'       SKIP IF SECOND TIME THROUGH                  
         BE    *+10                                                             
         MVC   AGYGKEY,KEY         SAVE CURRENT KEY                             
*                                                                               
         MVC   KEY,AGYTKEY         COPY DESIRED KEY                             
*                                                                               
         LA    R4,KEY                                                           
         USING RAGY2KEY,R4         ESTABLISH AGENCY KEY                         
*                                                                               
         MVC   RAGK2REP,REREP      DEFAULT TO CURRENT REP                       
*                                                                               
         GOTO1 =A(SETREP),DMCB,RAGY2KEY     SET CORRECT REP IN KEY              
*                                                                               
         MVI   LKEY,L'RAGY2KEY     WANT EXACT MATCH                             
*                                                                               
         CLI   AGYGCNTL,C'2'       SKIP IF SECOND TIME THROUGH                  
         BE    *+18                   FORCES EXACT MATCH                        
         CLC   RAGK2AOF,RESPACES   IF NO DEFAULT OFFICE                         
         BH    *+8                                                              
         MVI   LKEY,RAGK2AOF-RAGY2KEY MATCH UP TO AOF CODE                      
*                                                                               
         CLC   RAGK2AGY,RESPACES   IF NO DEFAULT AGENCY                         
         BH    *+8                                                              
         MVI   LKEY,RAGK2AGY-RAGY2KEY MATCH UP TO AGY CODE                      
*                                                                               
         BRAS  RE,HIGH             READ DIRECTORY POINTER                       
*                                                                               
AGYTPLP  DS    0H                                                               
*                                                                               
         BAS   RE,KEYCOMP          CHECK IF KEY FOUND                           
         BNE   AGYGNFD                                                          
*                                                                               
         CLC   REDMREP,RAGK2REP      MAKE SURE SAME REP                         
         BE    AGYTPFD                                                          
*                                                                               
AGYTPCN  DS    0H                                                               
*                                                                               
         BAS   RE,SEQ              READ NEXT AGY RECORD                         
         B     AGYTPLP                                                          
*                                                                               
AGYTPFD  DS    0H                                                               
*                                                                               
         MVC   AGYTKEY,KEY         SAVE FOUND KEY                               
         GOTO1 =A(TBLREP),DMCB,AGYTKEY    FIND REP FOR TABLE                    
         MVC   RAGK2REP-RAGY2KEY+AGYTKEY,RETBREP SET TABLE REP IN KEY           
*                                                                               
         XC    AGYTELM,AGYTELM     INIT DSC ELEMENT                             
         XC    AGYTFAX,AGYTFAX     INIT FAX ELEMENT                             
         XC    AGYTEXAD,AGYTEXAD   INIT EXTENDED ADDRESS ELEMENT                
*                                                                               
         MVC   AGYGAIO,REAIO       SAVE CURRENT RECORD POINTER                  
         MVC   REAIO,AGYGWRKA      READ INTO LOCAL WORKING STORAGE              
         BAS   RE,GETREC           READ IN RECORD                               
         MVC   REAIO,AGYGAIO       RESTORE CURRENT RECORD POINTER               
*                                                                               
         L     R4,AGYGWRKA         POINT TO FOUND RECORD                        
         USING RAGY2REC,R4                                                      
*                                                                               
*        SAVE DATA FOR AGENCY                                                   
*                                                                               
         USING RAG2ELEM,R6         ESTABLISH AGENCY ELEMENT                     
*                                                                               
         MVI   ELCODE,X'1F'        FIND AGENCY DECRIPTION ELEMENT               
         LR    R6,R4               START OF RECORD                              
         BRAS  RE,GETEL                                                         
         BNE   *+14                ELEMENT NOT FOUND                            
         MVC   AGYTELM,RAG2ELEM    SAVE AGENCY ELEMENT                          
         MVI   AGYTELM+1,L'AGYTELM RESET ELEMENT LENGTH                         
*                                                                               
         USING RAGY2FXE,R6         ESTABLISH FAX ELEMENT                        
*                                                                               
         MVI   ELCODE,X'10'        FIND FAX ELEMENT                             
         LR    R6,R4                                                            
         BAS   RE,GETEL                                                         
         BNZ   *+14                ELEMENT NOT FOUND                            
         MVC   AGYTFAX,RAGY2FXE    SAVE FAX ELEMENT                             
         MVI   AGYTFAX+1,L'AGYTFAX RESET ELEMENT LENGTH                         
*                                                                               
         USING RAGY2AE1,R6         ESTABLISH ADDRESS ELEMENT                    
*                                                                               
         MVI   ELCODE,X'20'        FIND ADDRESS ELEMENT                         
         LR    R6,R4                                                            
         BAS   RE,GETEL                                                         
         BNZ   *+14                ELEMENT NOT FOUND                            
         MVC   AGYTEXAD,RAGY2AE1   SAVE ADDRESS ELEMENT                         
         MVI   AGYTEXAD+1,L'AGYTEXAD RESET ELEMENT LENGTH                       
*                                                                               
AGYGDSCX DS    0H                                                               
*                                                                               
         GOTO1 BINSRCH,AGYTBSRP,('BSPADD',AGYTENT)  ADD TO TABLE                
*                                                                               
         ICM   R3,15,BSPAREC-BSPPRMS+AGYTBSRP   POINT TO INSERTED REC           
         BNZ   *+6                                                              
         DC    H'0'                DIE ON TABLE OVERFLOW                        
*                                                                               
AGYGADD  DS    0H                                                               
*                                                                               
         CLI   AGYGCNTL,C'2'       SKIP IF SECOND TIME THROUGH                  
         BE    AGYGADD1                                                         
*                                                                               
         MVC   REAGY,RAGK2AGY      SET CURRENT VALUE                            
         MVC   REAOF,RAGK2AOF      SET CURRENT VALUE                            
*                                                                               
         ST    R3,REAGYTA          A(CURRENT TABLE ENTRY)                       
         ST    R3,REAG2TA          A(CURRENT TABLE ENTRY)                       
         ST    R3,AGYTENTA                                                      
*                                                                               
         MVC   RETER,RAGY2TER-RAGY2FXE+AGYTFAX RETURN NEXT TERRITORY            
*                                                                               
AGYGADD1 DS    0H                                                               
*                                                                               
         OI    REAGCNTL,REAGCFDQ   INDICATE TABLE ENTRY FOUND                   
*                                                                               
         CLC   RAGK2AOF,RESPACES   IF THERE IS AN OFFICE                        
         BNH   AGYGADDX                                                         
*                                                                               
         MVC   AGYGKEYS,AGYTKEY       SAVE OFFICE KEY                           
*                                                                               
         LA    R3,AGYTTAB-AGYTTABD(R2) RE-POINT TO KEY BUILD AREA               
         USING AGYTENT,R3             ESTABLISH ENTRY                           
*                                                                               
         LA    R4,AGYTKEY             RE-POINT TO OFFICE KEY                    
*                                                                               
         MVC   RAGK2AOF,RESPACES      CLEAR OFFICE                              
*                                                                               
         GOTO1 BINSRCH,AGYTBSRP,('BSPFIND',AGYTENT)  FIND PURE AGENCY           
*                                                                               
         CLI   BSPCNTL-BSPPRMS+AGYTBSRP,BSPNF OKAY IF FOUND                     
         BNE   AGYGADDX                                                         
*                                                                               
         MVI   AGYGCNTL,C'2'       SECOND TIME THROUGH                          
         B     AGYGPUT             ADD ENTRY FOR AGENCY ALONE                   
*                                                                               
AGYGADDX DS    0H                                                               
*                                                                               
         CLI   AGYGCNTL,C'2'       IF AGENCY ENTRY ADDED                        
         BNE   AGYGADDY                                                         
*                                                                               
         LA    R3,AGYTTAB-AGYTTABD(R2) RE-POINT TO KEY BUILD AREA               
         MVC   AGYTKEY,AGYGKEYS       RESTORE OFFICE KEY                        
*                                                                               
         GOTO1 BINSRCH,AGYTBSRP,('BSPFIND',AGYTENT)  RE-FIND OFFICE             
*                                                                               
         ICM   R3,15,BSPAREC-BSPPRMS+AGYTBSRP   POINT TO INSERTED REC           
         BNZ   *+6                                                              
         DC    H'0'                DIE ON TABLE OVERFLOW                        
*                                                                               
         ST    R3,REAGYTA          RESET A(CURRENT TABLE ENTRY)                 
         ST    R3,REAG2TA          RESET A(CURRENT TABLE ENTRY)                 
         ST    R3,AGYTENTA                                                      
*                                                                               
AGYGADDY DS    0H                                                               
         B     AGYGOK                                                           
*                                                                               
AGYGDFLT DS    0H                  DEFAULT TO AGY IN CONTRACT KEY               
*                                                                               
         MVC   REAGY,AGYGAGY       SET DEFAULT VALUE FOR AGENCY                 
         MVC   REAOF,AGYGAOF       SET DEFAULT VALUE FOR AGENCY OFC             
         XC    RETER,RETER         CLEAR TERRITORY                              
         SR    R3,R3               INIT TABLE ENTRY POINTER                     
         ST    R3,REAGYTA          NO TABLE ENTRY FOUND                         
         ST    R3,REAG2TA          NO TABLE ENTRY FOUND                         
*                                                                               
AGYGOK   DS    0H                                                               
*                                                                               
         OC    AGYGKEY,AGYGKEY     IF RECORD READ                               
         BZ    AGYGOKX                                                          
*                                                                               
         MVC   KEY,AGYGKEY         RESTORE CURRENT KEY                          
         BAS   RE,HIGH             RESET DIRECTORY POINTER                      
*                                                                               
AGYGOKX  DS    0H                                                               
*                                                                               
         CR    RB,RB               SET EQ CC                                    
*                                                                               
         B     AGYGETX                                                          
*                                                                               
AGYGNFD  DS    0H                                                               
*                                                                               
         MVC   REAGY,=16X'FF'      NOT FOUND VALUE                              
         MVC   REAOF,=16X'FF'      NOT FOUND VALUE                              
         MVC   RETER,=16X'FF'      NOT FOUND VALUE                              
         MVC   AGYTENTA,=4X'FF'    INDICATE END OF TABLE REACHED                
         MVC   REAGYTA,AGYTENTA    RETURN A(GROUP TABLE ENTRY)                  
         MVC   REAG2TA,AGYTENTA    RETURN A(GROUP TABLE ENTRY)                  
*                                                                               
         OC    AGYGKEY,AGYGKEY     IF RECORD READ                               
         BZ    AGYGNFDX                                                         
*                                                                               
         MVC   KEY,AGYGKEY         RESTORE CURRENT KEY                          
         BAS   RE,HIGH             RESET DIRECTORY POINTER                      
*                                                                               
AGYGNFDX DS    0H                                                               
*                                                                               
         LTR   RB,RB               SET NEQ CC                                   
*                                                                               
AGYGETX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
AGYGAIO  DS    F                   DISK ADDR SAVEAREA                           
AGYGWRKA DS    A                   A(LOCAL WORKING STORAGE)                     
AGYGAGY  DS    XL(L'RAGYKAGY)      DEFAULT SAVEAREA                             
AGYGAOF  DS    XL(L'RAGYKAOF)      DEFAULT SAVEAREA                             
AGYGKEY  DS    XL(L'KEY)           CURRENT KEY SAVE AREA                        
AGYGKEYS DS    XL(L'KEY)           CURRENT AOF KEY SAVE AREA                    
AGYGOPT  DS    CL1                 OPTION                                       
*                                  C'N' - NEXT AGENCY IN TABLE/FILE             
*                                  C'G' - FIND THIS AGY IN TABLE/FILE           
AGYGCNTL DS    XL1                 C'2' - SECOND TIME THROUGH                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - STGET'                          
***********************************************************************         
*                                                                     *         
*        RETRIEVE NEXT STATION                                        *         
*                                                                     *         
*NTRY    PARM0+0   C'N' - FIND NEXT ENTRY IN TABLE                    *         
*                  C'G' - FIND ENTRY FOR DEFAULT                      *         
*        PARM0 ==> DEFAULT VALUE TO USE                               *         
*                                                                     *         
*                                                                     *         
*EXIT    RESTA = X'FFFFFFFFFF' IF NO STATION FOUND                    *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
STAGET   DS    0D                                                               
STGET    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         MVI   STAGCNTL,0          RESET CONTROL BYTE                           
*                                                                               
         L     R9,0(R1)            POINT TO DEFAULT VALUE                       
         MVC   STAGOPT,0(R1)       SAVE OPTION                                  
         MVC   STAGSTA,0(R9)       SAVE DEFAULT VALUE                           
         XC    STAGAIO,STAGAIO     INIT IO CURRENT VALUES                       
         XC    STAGKEY,STAGKEY                                                  
*                                                                               
         SR    R3,R3               INIT TABLE ENTRY POINTER                     
*                                                                               
         ICM   R2,15,RESTATBA      GET STATION TABLE ADDRESS                    
         BZ    STAGDFLT            USE DEFAULT IF NO TABLE                      
*                                                                               
         USING STATTABD,R2         ESTABLISH TABLE                              
*                                                                               
         OC    BSPNOR-BSPPRMS+STATBSRP,BSPNOR-BSPPRMS+STATBSRP                  
         BZ    STAGNFD             EMPTY TABLE                                  
*        BZ    STAGDFLT            EMPTY TABLE                                  
*                                                                               
         TM    RESTCNTL,RESTCFTQ   IF FILTERING THERE IS A TABLE                
         BNO   STAGFLTN                                                         
*                                                                               
*        FIND FIRST ENTRY FOR REP                                               
*                                                                               
         LA    R4,STATTAB-STATTABD(R2)  BUILD SEARCH KEY IN WORKAREA            
         USING RSTAKEY,R4                                                       
         XC    RSTAKEY,RSTAKEY                                                  
*                                                                               
         MVI   RSTAKTYP,RSTAKTYQ   RECORD ID                                    
         MVC   RSTAKREP,REREP      REP                                          
*                                                                               
*        FIND STATION IN TABLE                                                  
*                                                                               
         GOTO1 BINSRCH,STATBSRP,('BSPRDHI',RSTAKEY)   FIND IN TABLE             
*                                                                               
         CLI   BSPCNTL-BSPPRMS+STATBSRP,BSPNF IF NOT FOUND                      
         BE    STAGNFD             NONE FOUND                                   
*                                                                               
         ICM   R3,15,BSPAREC-BSPPRMS+STATBSRP POINT TO FOUND ELEMENT            
         BZ    STAGNFD             NONE FOUND                                   
*                                                                               
         USING STATENT,R3          ESTABLISH TABLE ENTRY                        
*                                                                               
STAG1STL DS    0H                                                               
*                                                                               
         OC    STATKEY,STATKEY     DONE AT END OF TABLE                         
         BZ    STAGNFD                                                          
*                                                                               
         CLC   RSTAKREP-RSTAKEY+STATKEY,REREP  TEST IF REP FOUND                
         BNE   STAGNFD                                                          
*                                                                               
         TM    STATKEY+27,X'80'    SKIP IF ENTRY DELETED                        
         BO    STAG1STC                                                         
*                                                                               
         B     STAG1STF                                                         
*                                                                               
STAG1STC DS    0H                                                               
*                                                                               
         LA    R3,STATENT+STATENTL BUMP TO NEXT ENTRY                           
         B     STAG1STL                                                         
*                                                                               
STAG1STF DS    0H                                                               
*                                                                               
         CLC   STAGSTA,SPACES      IF RESTARTING TABLE                          
         BNH   STAGFD                 USE FIRST ENTRY FOR REP IN TABLE          
*                                                                               
         CLC   RSTAKSTA-RSTAKEY+STATKEY,STAGSTA   IF DEFAULT LOWER              
         BH    STAGFD              THAN FIRST ENTRY - USE 1ST ENTRY             
*                                                                               
         LA    R4,STATTAB-STATTABD(R2)  BUILD SEARCH KEY IN WORKAREA            
         USING RSTAKEY,R4                                                       
         XC    RSTAKEY,RSTAKEY                                                  
*                                                                               
         MVI   RSTAKTYP,RSTAKTYQ   RECORD ID                                    
         MVC   RSTAKREP,REREP      REP                                          
         MVC   RSTAKSTA,STAGSTA    DEFAULT                                      
*                                                                               
*        FIND STATION IN TABLE                                                  
*                                                                               
         GOTO1 BINSRCH,STATBSRP,('BSPRDHI',RSTAKEY)   FIND IN TABLE             
*                                                                               
         CLI   BSPCNTL-BSPPRMS+STATBSRP,BSPNF IF NOT FOUND                      
         BE    STAGNFD             NONE FOUND                                   
*                                                                               
         ICM   R3,15,BSPAREC-BSPPRMS+STATBSRP POINT TO FOUND ELEMENT            
         BZ    STAGNFD             NONE FOUND                                   
*                                                                               
STAGNXTL DS    0H                                                               
*                                                                               
         OC    STATKEY,STATKEY     END OF TABLE                                 
         BZ    STAGNFD                                                          
*                                                                               
         TM    STATKEY+27,X'80'    NEXT ENTRY IF DELETED                        
         BO    STAGNXTC                                                         
*                                                                               
         B     STAGNXTF                                                         
*                                                                               
STAGNXTC DS    0H                                                               
*                                                                               
         LA    R3,STATENT+STATENTL BUMP TO NEXT ENTRY                           
         B     STAGNXTL                                                         
*                                                                               
STAGNXTF DS    0H                                                               
*                                                                               
         CLC   RSTAKREP-RSTAKEY+STATKEY,REREP     IF DEFAULT LOWER              
         BL    STAGNFD             THAN FIRST ENTRY - USE FOUND ENTRY           
         CLC   RSTAKSTA-RSTAKEY+STATKEY,STAGSTA   IF DEFAULT LOWER              
         BH    STAGFD                                USE FOUND ENTRY            
         BL    STAGNFD              IF DEFAULT HIGHER THEN END OF TAB           
*                                                                               
*                                  TABLE ENTRY FOUND                            
*                                                                               
         CLI   STAGOPT,C'G'        IF GETTING STATION                           
         BE    STAGFD                 USE THIS ENTRY                            
*                                                                               
STAGTNXL DS    0H                                                               
*                                                                               
         A     R3,BSPLENR-BSPPRMS+STATBSRP   BUMP TO NEXT ENTRY                 
*                                                                               
         OC    STATKEY,STATKEY     END OF TABLE IF NO KEY                       
         BZ    STAGNFD                                                          
*                                                                               
         CLC   RSTAKREP-RSTAKEY+STATKEY,REREP  END OF TABLE IF                  
         BNE   STAGNFD             NEW REP                                      
*                                                                               
         TM    STATKEY+27,X'80'    SKIP IF ENTRY DELETED                        
         BO    STAGTNXL                                                         
*                                                                               
         B     STAGFD              STATION FOUND IN TABLE                       
*                                                                               
STAGFLTN DS    0H                                                               
*                                                                               
         LA    R4,STATTAB-STATTABD(R2)  BUILD SEARCH KEY IN WORKAREA            
         USING RSTAKEY,R4                                                       
         XC    RSTAKEY,RSTAKEY                                                  
*                                                                               
         MVI   RSTAKTYP,RSTAKTYQ   RECORD ID                                    
         MVC   RSTAKREP,REREP      REP                                          
         MVC   RSTAKSTA,STAGSTA    DEFAULT                                      
*                                                                               
*        FIND STATION IN TABLE                                                  
*                                                                               
         GOTO1 BINSRCH,STATBSRP,('BSPFIND',RSTAKEY)   FIND IN TABLE             
*                                                                               
         CLI   BSPCNTL-BSPPRMS+STATBSRP,BSPNF IF NOT FOUND                      
         BE    STAGDFT1            USE DEFAULT                                  
*                                                                               
         ICM   R3,15,BSPAREC-BSPPRMS+STATBSRP POINT TO FOUND ELEMENT            
         BZ    STAGDFT1            NONE FOUND - USE DEFAULT                     
*                                                                               
STAGNEXL DS    0H                                                               
*                                                                               
         OC    STATKEY,STATKEY     END OF TABLE IF NO KEY                       
         BZ    STAGNFD                                                          
*                                                                               
         CLC   RSTAKREP-RSTAKEY+STATKEY,REREP  END OF TABLE IF                  
         BNE   STAGNFD             NEW REP                                      
*                                                                               
         TM    STATKEY+27,X'80'    OKAY IF NOT DELETED                          
         BNO   STAGNEXF                                                         
*                                                                               
STAGNEXC DS    0H                                                               
*                                                                               
         A     R3,BSPLENR-BSPPRMS+STATBSRP   BUMP TO NEXT ENTRY                 
         B     STAGNEXL            STATION FOUND IN TABLE                       
*                                                                               
STAGNEXF DS    0H                                                               
*                                                                               
         CLC   RSTAKREP-RSTAKEY+STATKEY,REREP     IF DEFAULT LOWER              
         BL    STAGDFT1            THAN FIRST ENTRY - USE FOUND ENTRY           
         CLC   RSTAKSTA-RSTAKEY+STATKEY,STAGSTA   IF DEFAULT LOWER              
         BH    STAGFD                                USE FOUND ENTRY            
         BL    STAGDFT1             IF DEFAULT HIGHER THEN END OF TAB           
*                                                                               
*                                  TABLE ENTRY FOUND                            
*                                                                               
         CLI   STAGOPT,C'G'        IF GETTING STATION                           
         BE    STAGFD                 USE THIS ENTRY                            
*                                                                               
         A     R3,BSPLENR-BSPPRMS+STATBSRP   BUMP TO NEXT ENTRY                 
*                                                                               
         OC    STATKEY,STATKEY     END OF TABLE IF NO KEY                       
         BNZ   STAGFD                                                           
*                                                                               
         B     STAGNFD                NOT FOUND                                 
*                                                                               
STAGFD   DS    0H                                                               
*                                                                               
         B     STAGKBLD            GO BUILD KEY                                 
*                                                                               
STAGDFT1 DS    0H                                                               
*                                                                               
         TM    RESTCNTL,RESTCFTQ   IF FILTERING                                 
         BO    STAGNFD                ASSUME NOT FOUND                          
*                                                                               
STAGDFLT DS    0H                  USE PASSED DEFAULT                           
*                                                                               
         SR    R3,R3               INDICATE NO TABLE ENTRY FOUND                
*                                                                               
STAGKBLD DS    0H                  BUILD STARTING STATION KEY                   
*                                                                               
         MVC   STAGKEY,KEY         SAVE CURRENT KEY                             
         MVC   STAGAIO,REAIO       SAVE CURRENT AIO                             
         L     R0,REAIO            SAVE CURRENT AIO                             
         L     RF,REAIO3           READ INTO IO3                                
         ST    RF,REAIO                                                         
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY              ESTABLISH STATION KEY                        
         USING RSTAKEY,R4                                                       
*                                                                               
         LTR   R3,R3               SKIP IF NO TABLE ENTRY AVAILABLE             
         BZ    STAGKB10                                                         
*                                                                               
         MVC   KEY,STATKEY            USE KEY FROM TABLE                        
         MVC   KEYSAVE,KEY            USE KEY FROM TABLE                        
*                                                                               
         B     STAGRDLP                                                         
*                                                                               
STAGKB10 DS    0H                                                               
*                                                                               
         MVI   RSTAKTYP,X'02'      RECORD ID                                    
         MVC   RSTAKREP,REREP      REP                                          
         MVC   RSTAKSTA,STAGSTA    STATION                                      
*                                                                               
         L     RF,REAIO3                                                        
         CLC   RSTAKEY,0(RF)       SKIP IF STATION IN CORE                      
         BE    STAGRDFD                                                         
*                                                                               
STAGRD   DS    0H                  READ STATION KEY                             
*                                                                               
         BAS   RE,HIGH             READ DIRECTORY POINTER                       
*                                                                               
STAGRDLP DS    0H                                                               
*                                                                               
         CLC   RSTAKEY(RSTAKSTA-RSTAKEY),KEYSAVE DONE ON CHANGE IN REP          
         BNE   STAGRDDN                                                         
*                                                                               
         ST    R3,STAGENTA         SAVE TABLE ADDRESS                           
*                                                                               
         TM    RSTAKEY+27,X'80'    SKIP IF STATION DELETED FROM TABLE           
         BO    STAGRDCN                                                         
*                                                                               
         MVC   RESTAKEY,KEY        SAVE KEY                                     
*                                                                               
         BAS   RE,GETREC           READ RECORD                                  
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
*                                                                               
*        FILTER STATION RECORD HERE                                             
*                                                                               
*        FILTER ON GROUP                                                        
*                                                                               
         LA    R8,RSTAELEM         POINT TO FIRST ELEMENT                       
         SR    RF,RF                                                            
         USING RSTAELEM,R8         ESTABLISH STATION ELEMENT                    
*                                                                               
         CLI   RSTACODE,0          SKIP IF END OF RECORD REACHED                
         BE    STAGRDCN                                                         
         CLI   RSTACODE,X'01'      MATCH TO STATION ELEMENT CODE                
         BE    *+16                                                             
         IC    RF,RSTAELLN         ELEMENT LENGTH                               
         LA    R8,RSTAELEM(RF)     POINT TO NEXT ELEMENT                        
         B     *-24                                                             
*                                                                               
         CLI   REFLAVOR,C'F'       SKIP IF DOING FLIGHT DATES                   
         BE    STAGGRP1                                                         
*                                                                               
         CLC   REFSGR,RESPACES     IF NOT FILTERING ON GROUP                    
         BH    *+10                                                             
         CLC   REFGRP,RESPACES                                                  
         BH    STAGRD10                                                         
*                                                                               
         B     STAGRD10            ALWAYS ASSUME PROCESSING BY GROUP            
*                                                                               
STAGGRP1 DS    0H                                                               
*                                                                               
         MVC   REGRS,RSTAGRUP         DEFAULT TO THIS STATION'S                 
         GOTO1 =A(GRPGET),DMCB,(C'G',RSTAGRUP)   FIND IN GROUP TABLE            
*                                                                               
         BNE   STAGRDCN            GROUP NOT FOUND                              
*                                                                               
         CLI   REFLAVOR,C'R'       SKIP IF NOT RGON REPORT                      
         BNE   STAGRD05                                                         
*                                                                               
         LA    R6,RERRGWRC         RGON WORKAREA                                
         USING RRGWRI,R6           ESTABLISH CONTROL BLOCK                      
*                                                                               
         LA    R0,8                SEARCH FOR GROUP DATATYPE                    
         LA    R1,RRGWDT1          FIRST DATATYPE                               
*                                                                               
         CLI   0(R1),RGRPKTYQ      FIND GROUP DATATYPE                          
         BE    *+16                                                             
         LA    R1,L'RRGWDT1+L'RRGWDA1(R1) NEXT DATATYPE                         
         BCT   R0,*-12                                                          
         B     *+10                NO GROUP ASKED FOR                           
*                                                                               
         MVC   L'RRGWDT1(L'REGRS,R1),REGRS   RESET GROUP CODE                   
*                                                                               
STAGRD05 DS    0H                                                               
*                                                                               
         B     STAGRDGX                                                         
*                                                                               
STAGRD10 DS    0H                                                               
*                                                                               
         CLI   REGRP,C' '          SKIP IF NO GROUP FILTERING                   
         BNH   STAGRDGX                                                         
*                                                                               
         CLC   REGRP,RSTAGRUP      MATCH ON GROUP                               
         BNE   STAGRDCN               SKIP IF NO MATCH                          
*                                                                               
******   CLI   RESGR,C' '          SKIP IF NO SUBGROUP FILTERING                
******   BNH   STAGRDGX                                                         
*                                                                               
         CLC   RESGR,RSTAGRUP+1    ELSE MATCH ON SUBGROUP                       
         BNE   STAGRDCN               SKIP IF NO MATCH                          
*                                                                               
STAGRDGX DS    0H                                                               
*                                                                               
*        FILTER ON MARKET                                                       
*                                                                               
STAGMKT  DS    0H                                                               
*                                                                               
         XC    REMKTTA,REMKTTA     CLEAR A(CURRENT MKT TABLE ENTRY)             
         XC    REMKT,REMKT         INIT CURRENT MARKET CODE                     
*                                                                               
         L     R6,REAIO            POINT TO STATION RECORD                      
         LA    R6,RSTAELEM-RSTAKEY(R6) POINT TO FIRST ELEMENT                   
*                                                                               
         USING RSTAXXEL,R6         ESTABLISH AS EXTRA DESRIPTION ELM            
         SR    RF,RF                                                            
*                                                                               
         CLI   RSTAXXEL,0          CHECK FOR END OF RECORD                      
         BE    STAGMKTA               STATION HAS NO MARKET CODE                
         CLI   RSTAXXEL,X'08'      LOOK FOR EXTRA DESC ELM                      
         BE    *+16                                                             
         IC    RF,RSTAXXEL+1       ELEMENT LENGTH                               
         LA    R6,RSTAXXEL(RF)     BUMP TO NEXT ELEMENT                         
         B     *-24                                                             
*                                                                               
         CLC   RSTAMKTC,SPACES     SKIP IF STATION HAS NO MARKET CODE           
         BNH   STAGMKTA                                                         
*                                                                               
         OC    REMKTTBA,REMKTTBA   IF NO MARKET TABLE AVAILABLE                 
         BNZ   STAGMKT1                                                         
*                                                                               
         MVC   REMKT,RSTAMKTC         DEFAULT TO FOUND MARKET                   
*                                                                               
STAGMKTA DS    0H                                                               
*                                                                               
         TM    REFTYPS2,REFTMKTQ   SKIP IF FILTERING ON MARKET                  
         BO    STAGRDCN                                                         
*                                                                               
         B     STAGMKTY               ACCEPT STATION                            
*                                                                               
STAGMKT1 DS    0H                                                               
*                                                                               
*        FIND MARKET IN MARKET TABLE                                            
*                                                                               
         STM   R0,RF,STAGREGS      SAVE CURRENT REGISTERS                       
*                                                                               
         ICM   R2,15,REMKTTBA      POINT TO MARKET TABLE                        
         USING MKTTTABD,R2         ESTABLISH MARKET TABLE                       
*                                                                               
         LM    R3,R5,MKTTBXLE      LOAD BXLE REGISTERS                          
         USING MKTTENT,R3          ESTABLISH TABLE ENTRY                        
*                                                                               
STAGMKTL DS    0H                                                               
*                                                                               
         CLC   RSTAMKTC,RMKTKMKT-RMKTKEY+MKTTKEY    MATCH MARKET                
         BE    STAGMKTF                                                         
*                                                                               
STAGMKTC DS    0H                                                               
*                                                                               
         BXLE  R3,R4,STAGMKTL                                                   
*                                                                               
STAGMKTD DS    0H                                                               
*                                                                               
         B     STAGMKDP            MARKET NOT IN TABLE - DROP                   
*                                                                               
STAGMKTF DS    0H                                                               
*                                                                               
         TM    MKTTKEY+27,X'80'    DROP IF MARKET DELETED FROM TABLE            
         BO    STAGMKDP               DROP                                      
*                                                                               
         CLI   REFLAVOR,C'R'       SKIP IF NOT RGON REPORT                      
         BNE   STAGMK10                                                         
*                                                                               
         LA    R5,RERRGWRC         RGON WORKAREA                                
         USING RRGWRI,R5           ESTABLISH CONTROL BLOCK                      
*                                                                               
         LA    R0,8                SEARCH FOR MARKET DATATYPE                   
         LA    R1,RRGWDT1          FIRST DATATYPE                               
*                                                                               
         CLI   0(R1),RMKTKTYQ      FIND MARKET DATATYPE                         
         BE    *+16                                                             
         LA    R1,L'RRGWDT1+L'RRGWDA1(R1) NEXT DATATYPE                         
         BCT   R0,*-12                                                          
         B     STAGMK10            NO MARKET ASKED FOR                          
*                                                                               
         CLC   L'RRGWDT1(L'REMKT,R1),RSTAMKTC   MATCH ON MARKET CODE            
         BNE   STAGMKDP                                                         
*                                                                               
STAGMK10 DS    0H                                                               
*                                                                               
         B     STAGMKTX                                                         
*                                                                               
STAGMKDP DS    0H                  MKT FAILS FILTERING - DROP STATION           
*                                                                               
         LM    R0,RF,STAGREGS      RESTORE REGISTERS                            
         B     STAGRDCN                                                         
*                                                                               
STAGMKTX DS    0H                                                               
         LM    R0,RF,STAGREGS      RESTORE REGISTERS                            
*                                                                               
STAGMKTY DS    0H                                                               
*                                                                               
         DROP  R6,R5                                                            
         DROP  R2                                                               
*                                                                               
*        FILTER ON OWNER                                                        
*                                                                               
STAGOWN  DS    0H                                                               
*                                                                               
         TM    REFTYPS2,REFTOWNQ   SKIP IF NOT FILTERING ON OWNER               
         BNO   STAGOWFX                                                         
*                                                                               
         TM    REFTYPN2,REFTOWNQ   SKIP IF NOT NEGATIVE FILTERING               
         BNO   STAGOWFX                                                         
*                                                                               
         CLC   RSTAOWN,REFOWN      DROP IF EQUAL TO FILTER VALUE                
         BE    STAGOWND                                                         
*                                                                               
STAGOWFX DS    0H                                                               
*                                                                               
         MVC   REOWN,RSTAOWN       DEFAULT TO FOUND OWNER                       
*                                                                               
         TM    REFTYPS2,REFTOWNQ   SKIP IF NOT FILTERING ON OWNER               
         BNO   STAGOWNX                                                         
*                                                                               
         OC    REOWNTBA,REOWNTBA   SKIP IF NO OWNER TABLE AVAILABLE             
         BZ    STAGOWNX                                                         
*                                                                               
         STM   R0,RF,STAGREGS      SAVE CURRENT REGISTERS                       
*                                                                               
         ICM   R2,15,REOWNTBA      POINT TO OWNER TABLE                         
         USING OWNTTABD,R2         ESTABLISH OWNER TABLE                        
*                                                                               
         LM    R3,R5,OWNTBXLE      LOAD BXLE REGISTERS                          
         USING OWNTENT,R3          ESTABLISH TABLE ENTRY                        
*                                                                               
STAGOWNL DS    0H                                                               
*                                                                               
         CLC   RSTAOWN,ROWNKOWN-ROWNKEY+OWNTKEY    MATCH OWNER                  
         BE    STAGOWNF                                                         
*                                                                               
STAGOWNC DS    0H                                                               
*                                                                               
         BXLE  R3,R4,STAGOWNL                                                   
*                                                                               
STAGOWND DS    0H                                                               
*                                                                               
         OI    STAGCNTL,X'80'      DELETE STATION FROM TABLE                    
*                                                                               
         XC    REOWNTA,REOWNTA     CLEAR A(CURRENT OWN TABLE ENTRY)             
*                                                                               
         LM    R0,RF,STAGREGS      RESTORE REGISTERS                            
*                                                                               
         B     STAGRDCN                                                         
*                                                                               
STAGOWNF DS    0H                                                               
*                                                                               
         ST    R3,REOWNTA          SET OWNER TABLE ENTRY ADDRESS                
*                                                                               
         LM    R0,RF,STAGREGS      RESTORE REGISTERS                            
*                                                                               
STAGOWNX DS    0H                                                               
*                                                                               
*        FILTER ON AFFILIATION                                                  
*                                                                               
STAGAFF  DS    0H                                                               
*                                                                               
         MVC   REAFF,RSTAAFFL      DEFAULT TO FOUND AFFILIATION                 
*                                                                               
         CLC   REFAFF,RESPACES     OKAY IF NOT FILTERING ON AFFILIATION         
         BNH   STAGAFFX                                                         
*                                                                               
         CLC   REFAFF,REAFF        FILTER ON AFFILIATION                        
         BE    STAGAFFX                                                         
*                                                                               
         B     STAGRDCN                                                         
*                                                                               
STAGAFFX DS    0H                                                               
*                                                                               
*        FILTER ON TVB REGION                                                   
*                                                                               
STAGTVB  DS    0H                                                               
*                                                                               
         MVC   RETVB,RSTATVB       DEFAULT TO FOUND TVB REGION                  
*                                                                               
         CLC   REFTVB,RESPACES     OKAY IF NOT FILTERING ON TVB REGION          
         BNH   STAGTVBX                                                         
*                                                                               
         CLC   REFTVB,RETVB        FILTER ON TVB REGION                         
         BE    STAGTVBX                                                         
*                                                                               
         B     STAGRDCN                                                         
*                                                                               
STAGTVBX DS    0H                                                               
*                                                                               
*        FILTER ON MARKET RANK                                                  
*                                                                               
STAGRNK  DS    0H                                                               
*                                                                               
         MVC   RERNK,RSTARANK      DEFAULT TO FOUND RANK                        
*                                                                               
         CLC   REFRNK,RESPACES     OKAY IF NOT FILTERING ON RANK                
         BNH   STAGRNKX                                                         
*                                                                               
         CLC   REFRNK,RERNK        FILTER ON RANK                               
         BE    STAGRNKX                                                         
*                                                                               
         B     STAGRDCN                                                         
*                                                                               
STAGRNKX DS    0H                                                               
*                                                                               
*        FILTER ON STATION TYPE                                                 
*                                                                               
         GOTO1 =A(STPGET)          RETRIEVE STATION TYPE                        
         BNE   STAGRDCN            STATION FAILS FILTERING                      
*                                                                               
*        FILTER ON JOIN/LEAVE DATES                                             
*                                                                               
         OC    RESJLTBA,RESJLTBA   SKIP IF JOIN/LEAVE DATES NOT NEEDED          
         BZ    STAGSJLX                                                         
*                                                                               
         GOTO1 =A(SJLGET),DMCB,RSTAKSTA  GET STATION JOIN/LEAVE DATES           
         BNE   STAGRDCN               STATION FAILS FILTERING                   
*                                                                               
STAGSJLX DS    0H                                                               
*                                                                               
         B     STAGRDFD            STATION PASSES FILTERING                     
*                                                                               
STAGRDCN DS    0H                                                               
*                                                                               
         ICM   R2,15,RESTATBA      GET STATION TABLE ADDRESS                    
         BZ    STAGRDC1            SKIP IF NO TABLE                             
*                                                                               
         USING STATTABD,R2         ESTABLISH TABLE                              
*                                                                               
         ICM   R3,15,STAGENTA      RESTORE TABLE ENTRY POINTER                  
         BZ    STAGRDC1                                                         
*                                                                               
         USING STATENT,R3          ESTABLISH STATION TABLE ENTRY                
*                                                                               
         TM    STAGCNTL,X'80'      CHECK IF STATION TO BE DELETED               
         BNO   *+12                                                             
         NI    STAGCNTL,X'FF'-X'80' TURN OFF INDICATOR                          
         OI    STATKEY+27,X'80'    SET DELETION BIT                             
*                                                                               
         A     R3,BSPLENR-BSPPRMS+STATBSRP   BUMP TO NEXT TABLE ENTRY           
*                                                                               
         OC    STATKEY,STATKEY     CHECK FOR END OF TABLE                       
         BZ    STAGRDDN                                                         
*                                                                               
         CLC   REREP,RSTAKREP-RSTAKEY+STATKEY CHECK FOR END OF TABLE            
         BNE   STAGRDDN                                                         
*                                                                               
         LA    R4,KEY              ESTABLISH STATION KEY                        
*                                                                               
         MVC   KEY,STATKEY         SET KEY FOR NEXT STATION                     
*                                                                               
         B     STAGRDLP                                                         
*                                                                               
STAGRDC1 DS    0H                                                               
*                                                                               
         LA    R4,KEY              ESTABLISH STATION KEY                        
*                                                                               
         BAS   RE,SEQ              READ NEXT STATION FILE                       
*                                                                               
         B     STAGRDLP                                                         
*                                                                               
STAGRDDN DS    0H                                                               
*                                                                               
         B     STAGNFD             STATION NOT FOUND                            
*                                                                               
STAGRDFD DS    0H                                                               
*                                                                               
         ICM   R2,15,RESTATBA      GET STATION TABLE ADDRESS                    
         BZ    STAGDFL             USE DEFAULT IF NO TABLE                      
*                                                                               
         USING STATTABD,R2         ESTABLISH TABLE                              
*                                                                               
         LTR   R3,R3               IF STATION NOT YET IN TABLE                  
         BNZ   STAGRDF1                                                         
*                                                                               
         LA    R3,STATTAB-STATTABD(R2)  BUILD SEARCH KEY IN WORKAREA            
*                                                                               
         MVC   STATKEY,KEY         SAVE STATION KEY                             
*                                                                               
         GOTO1 BINSRCH,STATBSRP,('BSPADD',STATENT)  ADD TO TABLE                
*                                                                               
         ICM   R3,15,BSPAREC-BSPPRMS+STATBSRP POINT TO TABLE ENTRY              
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
*                                                                               
STAGRDF1 DS    0H                                                               
*                                                                               
         MVC   RESTA,RSTAKSTA-RSTAKEY+STATKEY SET CURRENT STATION               
         ST    R3,STATENTA         SET A(CURRENT TABLE ENTRY)                   
         ST    R3,RESTATA                                                       
*                                                                               
         B     STAGOK                                                           
*                                                                               
STAGDFL  DS    0H                                                               
*                                                                               
         MVC   RESTA,RSTAKSTA      DEFAULT TO FOUND STATION                     
         XC    RESTATA,RESTATA     NO CURRENT TABLE ENTRY                       
*                                                                               
STAGOK   DS    0H                                                               
*                                                                               
         TM    REQCSTAT,REQCSACQ   IF USING ALTERNATE CALENDAR                  
         BNO   *+8                                                              
         BRAS  RE,ALTCAL              ADJUST DATES                              
*                                                                               
         TM    REQTABLE,REQCOMRQ   IF COMMISSION RATE TABLE NEEDED              
         BNO   *+8                                                              
         BRAS  RE,COMGET                                                        
*                                                                               
         OC    STAGAIO,STAGAIO     IF ANY RECORD WAS READ                       
         BZ    STAGOK1                                                          
*                                                                               
         MVC   REAIO,STAGAIO       RESTORE IOAREA POINTER                       
         MVC   KEY,STAGKEY         RESTORE CURRENT KEY                          
*                                                                               
         BAS   RE,HIGH             RESET FILE POINTERS                          
*                                                                               
STAGOK1  DS    0H                                                               
*                                                                               
         CR    RB,RB               SET EQ CC                                    
*                                                                               
         B     STGETX                                                           
*                                                                               
STAGNFD  DS    0H                                                               
*                                                                               
         MVC   RESTA,=16X'FF'      NOT FOUND VALUE                              
         MVC   RESTATA,=4X'FF'     INDICATE END OF TABLE REACHED                
*                                                                               
         LTR   R2,R2               SKIP IF NO TABLE                             
         BZ    *+10                                                             
         MVC   STATENTA,RESTATA    RETURN A(STATION TABLE ENTRY)                
*                                                                               
         CLC   RESGR,RESPACES      IF NOT FILTERING ON GROUP                    
         BH    *+10                                                             
         CLC   REGRP,RESPACES                                                   
         BH    STAGNF10                                                         
*                                                                               
         MVC   REGRS,=16X'FF'         SET TO END OF GROUP TABLE                 
*                                                                               
         ICM   R2,15,REGRPTBA         GET GRP TABLE ADDRESS                     
         BZ    STAGNF10                                                         
*                                                                               
         USING GRPTTABD,R2            ESTABLISH TABLE                           
*                                                                               
         MVC   GRPTENTA,=16X'FF'      FLAG END OF TABLE                         
         MVC   REGRPTA,=16X'FF'                                                 
*                                                                               
STAGNF10 DS    0H                                                               
*                                                                               
         TM    REFTYPS2,REFTMKTQ   IF NOT FILTERING ON MARKET                   
         BO    STAGNF11                                                         
*                                                                               
         MVC   REMKT,=16X'FF'         SET TO END OF MARKET TABLE                
*                                                                               
         ICM   R2,15,REMKTTBA         GET MKT TABLE ADDRESS                     
         BZ    STAGNF11                                                         
*                                                                               
         USING MKTTTABD,R2            ESTABLISH TABLE                           
*                                                                               
         MVC   MKTTENTA,=16X'FF'      FLAG END OF TABLE                         
         MVC   REMKTTA,=16X'FF'                                                 
*                                                                               
STAGNF11 DS    0H                                                               
*                                                                               
         OC    STAGAIO,STAGAIO     IF ANY RECORD WAS READ                       
         BZ    STAGNFD1                                                         
*                                                                               
         MVC   REAIO,STAGAIO       RESTORE IOAREA POINTER                       
         MVC   KEY,STAGKEY         RESTORE CURRENT KEY                          
*                                                                               
         BAS   RE,HIGH             RESET FILE POINTERS                          
*                                                                               
STAGNFD1 DS    0H                                                               
*                                                                               
         LTR   RB,RB               SET NEQ CC                                   
*                                                                               
         B     STGETX                                                           
*                                                                               
STGETX   DS    0H                                                               
*                                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
STAGREGS DS    16F                 REGISTER SAVEAREA                            
*                                                                               
STAGCNTL DS    XL1                 CONTROL BIT                                  
*                                  X'80' - DELETED                              
*                                                                               
STAGOPT  DS    XL1                 C'G'  GET STATION                            
*                                  C'N'  GET NEXT STATION                       
STAGSTA  DS    CL5                 DEFAULT STATION SAVEAREA                     
STAGAIO  DS    A                   AIO SAVEAREA                                 
STAGENTA DS    A                   A(CURRENT TABLE ENTRY)                       
STAGKEY  DS    XL(L'KEY)           KEY SAVEAREA                                 
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - ALTCAL'                         
***********************************************************************         
*                                                                     *         
*        SWITCH FILTER DATES TO THOSE OF STATION'S ALTERNATE DATES    *         
*                                                                     *         
*NTRY    RESTA CURRENT STATION                                        *         
*                                                                     *         
*EXIT          FILTER DATES NOW BASED ON ALTERNATE CALENDAR           *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
ALTCAL   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         OC    ALTDTES(ALTDTESL),ALTDTES     IF FIRST TIME                      
         BNZ   ALT1STX                                                          
*                                     SAVE ORIGINAL REQUEST DATES               
         MVC   ALTDTESC,REFDTESC           COMPRESSED FILTER DATES              
         MVC   ALTDTESB,REFDTESB           BINARY     FILTER DATES              
         MVC   ALTYDTSC,REFYDTSC           COMPRESSED YTD    DATES              
         MVC   ALTYDTSB,REFYDTSB           BINARY     YTD    DATES              
*                                                                               
*        BUILD FACILITIES LIST                                                  
*                                                                               
         MVC   ALTGTBRD,GETBROAD   A(GETBROAD)                                  
         MVC   ALTGTDAY,GETDAY     A(GETDAY)                                    
         MVC   ALTADDAY,ADDAY      A(ADDAY)                                     
         MVC   ALTDTCON,DATCON     A(DATCON)                                    
         MVC   ALTDMGR,DATAMGR     A(DATAMGR)                                   
*                                                                               
         XC    ALTWORK,ALTWORK     INIT OUTPUT AREA                             
*                                                                               
         XC    ALTREPSV,ALTREPSV   INIT REP SAVEAREA                            
         MVC   ALTRDTES(ALTDTESL),ALTDTES INIT REP ALTCAL TO REQ DATES          
*                                                                               
         XC    ALTSTASV,ALTSTASV   INIT STATION SAVEAREA                        
*                                                                               
ALT1STX  DS    0H                                                               
*                                                                               
         OC    ALTSTASV,ALTSTASV   IF STATION ALTCAL DATES PREVIOUSLY           
         BZ    ALTSTAX                                                          
*                                                                               
         XC    ALTSTASV,ALTSTASV      CLEAR STATION ID                          
*                                                                               
         MVC   REFDTESC(REFDTECL),ALTRDTSC DEFAULT TO REP'S ALTCAL DTES         
         MVC   REFDTESB(REFDTEBL),ALTRDTSB                                      
         MVC   REFYDTSC(REFYDTCL),ALTRYDSC                                      
         MVC   REFYDTSB(REFYDTBL),ALTRYDSB                                      
*                                                                               
ALTSTAX  DS    0H                                                               
*                                                                               
*        CONVERT FILTER DATES TO ALTERNATE CALENDAR USING REGENABM              
*                                                                               
         LA    R0,4                NUMBER OF START-END DATES TO CONVERT         
*                                                                               
*        PRE-LOAD PART OF ALTBCMON PARAMETER LIST                               
*                                                                               
         XC    ALTDMCB+12(4),ALTDMCB+12                                         
         MVC   ALTDMCB+14(2),REREP   SET REP CODE                               
*                                                                               
         LA    R2,ALTDTESB         ORIGINAL FILTER DATES - BINARY               
         LA    R3,ALTDTESC         ORIGINAL FILTER DATES - COMPRESSED           
         LA    R4,REFDTESB         ALTCAL   FILTER DATES - BINARY               
         LA    R5,REFDTESC         ALTCAL   FILTER DATES - COMPRESSED           
*                                                                               
ALTDTELP DS    0H                                                               
*                                                                               
         OC    0(6,R2),0(R2)       SKIP IF DATE RANGE NOT USED                  
         BZ    ALTDTECN                                                         
*                                                                               
*        HANDLE START DATE OF RANGE                                             
*                                                                               
         GOTO1 DATCON,DMCB,(3,0(R2)),DUB         CONVERT DATE TO CH             
*                                                                               
         GOTO1 ADDAY,DMCB,DUB,ALTDTECH,15  BUMP START TO CALENDAR MONTH         
*                                                                               
                                                                                
         GOTO1 ALTBCMON,ALTDMCB,ALTDTECH,ALTWORK,ALTFACS,,RESTA,KEY             
         CLI   0(R1),X'FF'         DIE ON ERRORS                                
         BNE   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         TM    0(R1),X'10'         EXIT IF NO ALT CALENDAR FOUND                
         BO    ALTCALX                REQ DATES WILL BE USED                    
*                                                                               
         TM    0(R1),X'80'         IF STATION CALENDAR FOUND                    
         BNO   *+14                                                             
         MVC   ALTSTASV,RESTA         RESET STATION ID                          
         B     ALTCAL10                                                         
*                                                                               
         CLC   REREP,ALTREPSV      IF REP UNCHANGED                             
         BE    ALTCALX                EXIT - REP'S ALTCAL WILL BE USED          
*                                                                               
ALTCAL10 DS    0H                                                               
*                                                                               
         MVC   0(3,R4),ALTWORK     ALTCAL START BROADCAST DATE                  
*                                                                               
         GOTO1 DATCON,DMCB,(3,0(R4)),(2,0(R5))  COMPRESSED VERSION              
*                                                                               
*        HANDLE END   DATE OF RANGE                                             
*                                                                               
         GOTO1 DATCON,DMCB,(3,3(R2)),DUB         CONVERT DATE TO CH             
*                                                                               
         GOTO1 ADDAY,DMCB,DUB,ALTDTECH,-15 BACK UP END TO MIDDLE OF MON         
*                                                                               
         GOTO1 ALTBCMON,ALTDMCB,ALTDTECH,ALTWORK,ALTFACS,,RESTA,KEY             
         CLI   0(R1),X'FF'         DIE ON ERRORS                                
         BNE   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   3(3,R4),ALTWORK+3   ALTCAL END   BROADCAST DATE                  
*                                                                               
         GOTO1 DATCON,DMCB,(3,3(R4)),(2,2(R5))  COMPRESSED VERSION              
*                                                                               
ALTDTECN DS    0H                                                               
*                                                                               
         LA    R2,6(R2)            BUMP DATE POINTERS                           
         LA    R3,4(R3)                                                         
         LA    R4,6(R4)                                                         
         LA    R5,4(R5)                                                         
*                                                                               
         BCT   R0,ALTDTELP                                                      
*                                                                               
ALTDTEDN DS    0H                                                               
*                                                                               
*        CONVERT YTD DATES TO ALTERNATE CALENDARUSING REGENABM                  
*                                                                               
         TM    REQCFOPT,REQCFYTQ   SKIP IF YTD OPTION NOT IN PLAY               
         BNO   ALTYTDX                                                          
*                                                                               
         LA    R0,4                NUMBER OF YTD DATES TO CONVERT               
*                                                                               
         LA    R2,ALTYDTSB         ORIGINAL FILTER DATES - BINARY               
         LA    R3,ALTYDTSC         ORIGINAL FILTER DATES - COMPRESSED           
         LA    R4,REFYDTSB         ALTCAL   FILTER DATES - BINARY               
         LA    R5,REFYDTSC         ALTCAL   FILTER DATES - COMPRESSED           
*                                                                               
ALTYTDLP DS    0H                                                               
*                                                                               
         OC    0(6,R2),0(R2)       SKIP IF DATE RANGE NOT USED                  
         BZ    ALTYTDCN                                                         
*                                                                               
*        YTD DATE IS START OF 1ST BROADCAST MONTH IN YEAR                       
*                                                                               
         GOTO1 DATCON,DMCB,(3,0(R2)),DUB         CONVERT DATE TO CH             
*                                                                               
         GOTO1 ADDAY,DMCB,DUB,ALTDTECH,15  BUMP START TO CALENDAR MONTH         
*                                                                               
         GOTO1 ALTBCMON,ALTDMCB,ALTDTECH,ALTWORK,ALTFACS,,RESTA,KEY             
         CLI   0(R1),X'FF'         DIE ON ERRORS                                
         BNE   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   0(3,R4),ALTWORK     ALTCAL START BROADCAST DATE                  
*                                                                               
         GOTO1 DATCON,DMCB,(3,0(R4)),(2,0(R5))  COMPRESSED VERSION              
*                                                                               
ALTYTDCN DS    0H                                                               
*                                                                               
         LA    R2,3(R2)            BUMP DATE POINTERS                           
         LA    R3,2(R3)                                                         
         LA    R4,3(R4)                                                         
         LA    R5,2(R5)                                                         
*                                                                               
         BCT   R0,ALTYTDLP                                                      
*                                                                               
ALTYTDDN DS    0H                                                               
*                                                                               
ALTYTDX  DS    0H                                                               
*                                                                               
*        SAVE REP ALTCAL IF FIRST TIME FOR REP AND NOT STA ALTCAL               
*                                                                               
         OC    ALTSTASV,ALTSTASV   SKIP IF STATION CALENDAR                     
         BNZ   ALTREPX                                                          
*                                                                               
         CLC   REREP,ALTREPSV      SKIP IF SAME OLD REP                         
         BE    ALTREPX                                                          
*                                                                               
         MVC   ALTRDTSC,REFDTESC   UPDATE SAVED REP DATES                       
         MVC   ALTRDTSB,REFDTESB                                                
         MVC   ALTRYDSC,REFYDTSC                                                
         MVC   ALTRYDSB,REFYDTSB                                                
*                                                                               
         MVC   ALTREPSV,REREP      UPDATE CURRENT REP                           
*                                                                               
ALTREPX  DS    0H                                                               
*                                                                               
ALTCALX  DS    0H                                                               
*                                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
ALTBCMON DC    V(ALTBCMON)                                                      
*                                                                               
*        FACILITIES LIST FOR REGENABM                                           
*                                                                               
ALTFACS  DS    0D                                                               
ALTGTBRD DS    A                   A(GETBROAD)                                  
ALTGTDAY DS    A                   A(GETDAY)                                    
ALTADDAY DS    A                   A(ADDAY)                                     
ALTDTCON DS    A                   A(DATCON)                                    
ALTDMGR  DS    A                   A(DATAMGR)                                   
*                                                                               
ALTWORK  DS    XL32                WORKAREA                                     
ALTDMCB  DS    6F                  DMCB                                         
*                                                                               
*        REQUEST FILTER DATES SAVEAREA                                          
*                                                                               
ALTDTES  DS    0X                  DATES SAVEAREA                               
ALTDTESC DS    XL(2*8)             FILTER DATES COMPRESSED                      
ALTDTESB DS    XL(3*8)             FILTER DATES BINARY                          
ALTYDTSC DS    XL(2*4)             FILTER YTD DATES COMPRESSED                  
ALTYDTSB DS    XL(3*8)             FILTER YTD DATES BINARY                      
ALTDTESL EQU   *-ALTDTES           SAVEAREA LENGTH                              
*                                                                               
*        REP CALENDAR DATES SAVEAREA                                            
*                                                                               
ALTREPSV DS    CL2                 REP SAVEAREA                                 
ALTRDTES DS    0X                  REP DATES SAVEAREA                           
ALTRDTSC DS    XL(2*8)             FILTER DATES COMPRESSED                      
ALTRDTSB DS    XL(3*8)             FILTER DATES BINARY                          
ALTRYDSC DS    XL(2*4)             FILTER YTD DATES COMPRESSED                  
ALTRYDSB DS    XL(3*8)             FILTER YTD DATES BINARY                      
*                                                                               
ALTSTASV DS    XL(L'RESTA)         STATION FOR CALENDAR DATES                   
*                                  NULLS IF CALENDAR DATES FOR REP              
ALTDTECH DS    CL6                 DATE IN EBCIDIC                              
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - COMGET'                         
***********************************************************************         
*                                                                     *         
*        BUILD COMMISSION RATE TABLE FOR STATION                      *         
*                                                                     *         
*NTRY    RESTA CURRENT STATION                                        *         
*                                                                     *         
*EXIT    ALL COMMISSION RATES FOR A STATION ARE IN A TABLE            *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
COMGET   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
*        ESTABLISH COMMISSION RATE TABLE                                        
*                                                                               
         SR    R3,R3               INIT RATE TABLE ENTRY POINTER                
*                                                                               
         ICM   R2,15,RECOMTBA      TABLE ADDRESS                                
         BZ    COMGETX             NO TABLE AVAILABLE                           
*                                                                               
         USING COMTTABD,R2         ESTABLISH RATE TABLE AREA                    
*                                                                               
*        INITIALIZE RATE TABLE                                                  
*                                                                               
COMGINI  DS    0H                                                               
*                                                                               
         LA    RF,COMTTAB          SET TABLE START                              
         ST    RF,COMTSTRA                                                      
*                                                                               
         XC    0(COMTENTL,RF),0(RF) CLEAR FIRST ENTRY                           
*                                                                               
         BCTR  RF,0                SET END OF TABLE AS START MINUS ONE          
         ST    RF,COMTENDA                                                      
*                                                                               
         LA    RF,COMTENTL         SET ENTRY LENGTH                             
         ST    RF,COMTLEN                                                       
*                                                                               
         LA    RF,COMTMAXQ         SET # OF AVAILABLE ENTRIES TO MAX            
         ST    RF,COMTAVL                                                       
*                                                                               
COMGINIX DS    0H                  END OF TABLE INITIALIZATION                  
*                                                                               
*        READ ALL APPLICABLE RATE RECORDS                                       
*        SAVE IN TABLE                                                          
*                                                                               
         SR    R8,R8               INIT MEMBER ELEMENT POINTER                  
*                                                                               
         ICM   R0,15,COMTAVL       GET NUMBER OF TABLE SLOTS AVAILABLE          
*                                                                               
         L     R3,COMTENDA         POINT TO FIRST AVAILABLE SLOT IN TAB         
         LA    R3,1(R3)                                                         
         USING COMTENT,R3          ESTABLISH RATE ENTRY                         
*                                                                               
         XC    COMTKEY,COMTKEY     INIT FIRST RATE ENTRY KEY                    
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING RCOMKEY,R4          ESTABLISH RATE KEY                           
*                                                                               
         MVI   RCOMKTYP,RCOMKTYQ   RECORD ID                                    
         MVC   RCOMKREP,REREP      REP                                          
*                                                                               
         GOTO1 =A(SETREP),DMCB,RCOMKEY SET FILE READ REP                        
*                                                                               
         MVC   RCOMKSTA,RESTA      SET STATION                                  
*                                                                               
         MVI   LKEY,RCOMKOFF-RCOMKEY  SET KEY COMPARE LENGTH                    
*                                                                               
         BAS   RE,FIRSTHI          READ FIRST RATE RECORD                       
*                                                                               
COMGLOOP DS    0H                                                               
*                                                                               
         LA    R4,KEY              RE-POINT TO FOUND KEY                        
*                                                                               
         BAS   RE,KEYCOMP          SKIP IF NOT RATE KEY FOUND                   
         BNE   COMGDONE                                                         
*                                                                               
         BAS   RE,GETREC           READ IN RECORD                               
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
*                                                                               
         MVC   COMTKEY,RCOMKEY     SAVE RATE KEY                                
*                                                                               
         GOTO1 =A(TBLREP),DMCB,COMTKEY  FIND REP FOR TABLE STORAGE              
*                                                                               
         MVC   RCOMKREP-RCOMKEY+COMTKEY,RETBREP    USE IT IN TABLE              
*                                                                               
*        SAVE RATE DECRIPTION ELEMENT                                           
*                                                                               
         SR    RF,RF                                                            
         LA    R6,RCOMELEM         POINT TO FIRST ELEMENT IN RECORD             
         USING RCOMELEM,R6         ESTABLISH DESCRIPTIVE ELEMENT                
*                                                                               
COMGRTLP DS    0H                                                               
*                                                                               
         CLI   RCOMELEM,0          DONE AT END OF RECORD                        
         BE    COMGRTDN                                                         
*                                                                               
         CLI   RCOMELEM,X'01'      FIND RATE ELEMENT                            
         BE    COMGRTFD                                                         
*                                                                               
COMGRTCN DS    0H                                                               
*                                                                               
         IC    RF,RCOMELLN         GET ELEMENT LENGTH                           
         LA    R6,RCOMELEM(RF)     BUMP TO NEXT ELEMENT                         
         B     COMGRTLP                                                         
*                                                                               
COMGRTFD DS    0H                                                               
*                                                                               
         IC    RF,RCOMELLN         GET ELEMENT LENGTH                           
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   COMTELM(0),RCOMELEM SAVE RATE DESCRIPTION ELEMENT                
*                                                                               
COMGRTDN DS    0H                                                               
*                                                                               
         BCT   R0,*+6              DECREMENT SPACE AVAILABLE COUNTER            
         DC    H'0'                INCREASE RATE TABLE                          
*                                                                               
         LA    R3,COMTENT+COMTENTL  BUMP TO NEXT AVAILABLE TABLE ENTRY          
         XC    COMTENT(COMTENTL),COMTENT INIT NEXT ENTRY                        
*                                                                               
COMGCONT DS    0H                                                               
*                                                                               
         BAS   RE,SEQ              READ NEXT RATE RECORD                        
*                                                                               
         B     COMGLOOP                                                         
*                                                                               
COMGDONE DS    0H                                                               
*                                                                               
         LTR   R3,R3               IF WE PUT ANYTHING IN TABLE                  
         BZ    COMGDON1                                                         
*                                                                               
         BCTR  R3,0                   RESET END OF TABLE                        
         ST    R3,COMTENDA                                                      
*                                                                               
COMGDON1 DS    0H                                                               
*                                                                               
*                                                                               
COMGETX  DS    0H                                                               
*                                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - SJLGET'                         
***********************************************************************         
*                                                                     *         
*        ADD STATION'S JOIN AND LEAVE DATES TO STATION ENTRY IN TABLE *         
*                                                                     *         
*        IF REPORTING FOR A MASTER REP THE STATION COULD MOVE         *         
*           BETWEEN SUBSIDERIES AND THUS ITS DOLLARS ARE COMPARABLE   *         
*           FROM THE MASTER'S VIEWPOINT.                              *         
*        THIS ROUTINE SEARCHES THE SJL TABLE BASED ON STATION CALL    *         
*           LETTERS.                                                  *         
*           IF NO ENTRY IS FOUND IT READS STATION FILE USING RST2     *         
*           PASSIVE KEY (ESSENTIALY IN STATIO/REP ORDER) AND BUILDS   *         
*           ENTRY LISTING THE JOIN/LEAVE DATES FOR EACH REP THAT      *         
*           IS INVOLVED WITH THE REPORT.                              *         
*                                                                     *         
*NTRY    P1    A(STATION CALL LETTERS)                                *         
*                                                                     *         
*EXIT    RESJLTA  POINTS TO CURRENT STATION'S TABLE ENTRY             *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
SJLGET   NTR1  BASE=*,LABEL=*,WORK=(R8,500)                                     
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         ST    R8,SJLGAIO1         SAVE A(WORKAREA)                             
*                                                                               
         L     RF,0(R1)            POINT TO PASSED CALL LETTERS                 
         MVC   SJLGSTA,0(RF)       SAVE STATION CALL LETTERS                    
*                                                                               
         XC    RESJLTA,RESJLTA     INIT A(TABLE ENTRY)                          
*                                                                               
         ICM   R2,15,RESJLTBA      POINT TO JOIN/LEAVE TABLE                    
         BZ    SJLGETX             SKIP  IF NO TABLE AVAILABLE                  
*                                                                               
         USING SJLTTABD,R2         ESTABLISH TABLE                              
*                                                                               
         LA    R3,SJLTENT          ESTABLISH 1ST ENTRY FOR KEY BUILDING         
         USING SJLTENT,R3                                                       
*                                                                               
         XC    SJLTENT(SJLTENTL),SJLTENT INIT ENTRY                             
         MVC   SJLTCALL,SJLGSTA    KEY IS STATION CALL LETTERS                  
*                                                                               
         GOTO1 BINSRCH,SJLTBSRP,('BSPFIND',SJLTENT) SEARCH TABLE                
*                                                                               
         CLI   BSPCNTL-BSPPRMS+SJLTBSRP,BSPNF IF NOT FOUND                      
         BE    SJLGADD                           ADD TO TABLE                   
*                                                                               
         ICM   R3,15,BSPAREC-BSPPRMS+SJLTBSRP  POINT TO FOUND ELEMENT           
         BZ    SJLGADD             NONE FOUND - ADD ENTRY TO TABLE              
*                                                                               
         ST    R3,RESJLTA          RETURN TABLE ENTRY ADDRESS                   
*                                                                               
         B     SJLGETX             ALL DONE                                     
*                                                                               
SJLGADD  DS    0H                  ADD ENTRY TO TABLE                           
*                                                                               
         MVC   SJLGKEY,KEY         SAVE CURRENT KEY AND A(IOAREA)               
         MVC   SJLGAIO,REAIO                                                    
         MVC   REAIO,SJLGAIO1      SET TO READ INTO LOCAL WORK AREA             
*                                                                               
         XC    KEY,KEY             ESTABLISH KEY AS RST2KEY                     
         LA    R4,KEY                                                           
         USING RST2KEY,R4                                                       
*                                                                               
         MVI   RST2KTYP,X'82'      SET PASSIVE KEY TYPE                         
         MVC   RST2KSTA,SJLGSTA    SET STATION CALL LETTERS                     
*                                                                               
         BAS   RE,HIGH             READ FIRST ON FILE                           
*                                                                               
         LA    R5,SJLTDTES         ESTABLISH JOIN/LEAVE DATES                   
         USING SJLTDTES,R5                                                      
*                                                                               
         XC    SJLTDTES(SJLTDTEL),SJLTDTES  INIT FIRST DATE AREA                
*                                                                               
SJLGLOOP DS    0H                                                               
*                                                                               
         CLC   RST2KEY(RST2KEND-RST2KEY),KEYSAVE DONE ON STATION CHANGE         
         BNE   SJLGDONE                                                         
*                                                                               
*        MAKE SURE REP WANTED FOR REPORT                                        
*                                                                               
         ICM   R8,15,REREPTBA      POINT TO REP TABLE                           
         BZ    SJLGCONT            SKIP  IF NO TABLE AVAILABLE                  
*                                                                               
         USING REPTTABD,R8         ESTABLISH TABLE                              
*                                                                               
         LA    R9,REPTENT          ESTABLISH 1ST ENTRY FOR KEY BUILDING         
         USING REPTENT,R9                                                       
*                                                                               
         XC    REPTENT(REPTENTL),REPTENT INIT ENTRY                             
*                                                                               
*        BUILD REP RECORD KEY                                                   
*                                                                               
         MVI   RREPKTYP-RREPKEY+REPTENT,RREPKTYQ   REP RECORD TYPE              
         MVC   RREPKREP-RREPKEY+REPTENT,RST2KREP   REP CODE                     
*                                                                               
         GOTO1 BINSRCH,REPTBSRP,('BSPFIND',REPTENT) SEARCH REP TABLE            
*                                                                               
         CLI   BSPCNTL-BSPPRMS+REPTBSRP,BSPNF SKIP IF NOT FOUND                 
         BE    SJLGCONT                                                         
*                                                                               
         L     R9,BSPAREC-BSPPRMS+REPTBSRP ESTBLSH REP TABLE ENTRY              
*                                                                               
         TM    REPTKEY+27,X'80'    SKIP IF DELETED                              
         BO    SJLGCONT                                                         
*                                                                               
         BAS   RE,GETREC           READ STATION RECORD                          
*                                                                               
         ICM   R4,15,SJLGAIO1      POINT TO FOUND RECORD                        
         BZ    SJLGCONT            NOT FOUND                                    
         USING RSTAREC,R4          ESTABLISH STATION RECORD                     
*                                                                               
         MVC   SJLTJOIN,RSTASTRT   SAVE JOIN DATE                               
         MVC   SJLTLEAV,RSTAEND    SAVE END DATE                                
         OC    SJLTLEAV,SJLTLEAV   IF NO END DATE                               
         BNZ   *+10                                                             
         MVC   SJLTLEAV,=3X'FF'       FORCE LAST SYLLABLE OF RECORDED           
*                                     TIME                                      
         LA    R5,SJLTDTEL(R5)     BUMP TO NEXT DATE AREA                       
*                                                                               
         XC    SJLTDTES(SJLTDTEL),SJLTDTES  INIT NEXT DATE AREA                 
*                                                                               
SJLGCONT DS    0H                                                               
*                                                                               
         LA    R4,KEY              RE-ESTABLISH PASSIVE KEY                     
         USING RST2KEY,R4                                                       
*                                                                               
         BAS   RE,SEQ              READ NEXT ON FILE                            
*                                                                               
SJLGDONE DS    0H                                                               
*                                                                               
         DROP  R5                                                               
*                                                                               
         GOTO1 BINSRCH,SJLTBSRP,('BSPADD',SJLTENT) ADD TO TABLE                 
*                                                                               
         ICM   R3,15,BSPAREC-BSPPRMS+SJLTBSRP  POINT TO FOUND ELEMENT           
         BNZ   *+6                                                              
         DC    H'0'                NO ROOM                                      
*                                                                               
         ST    R3,RESJLTA          RETURN TABLE ENTRY ADDRESS                   
*                                                                               
         MVC   KEY,SJLGKEY         RESTORE CURRENT KEY                          
         MVC   REAIO,SJLGAIO       RESTORE IOAREA POINTER                       
*                                                                               
         BAS   RE,HIGH             RESTORE FILE POINTER                         
*                                                                               
*        DROP STATIONS THAT JOINED IN CURRENT PERIOD                            
*              OR LEFT IN PRIOR PERIOD                                          
*                                                                               
         TM    REQBLLOP,REQBOR5Q   SKIP IF NOT R5 BILLING OPTION                
         BNO   SJLGR5N                                                          
*                                                                               
*        FIND EARLIEST JOIN DATE AND LATEST LEAVE DATE                          
*                                                                               
         LA    R5,SJLTDTES         ESTABLISH JOIN/LEAVE DATES                   
         USING SJLTDTES,R5                                                      
*                                                                               
         MVC   SJLGJOIN,=3X'FF'    INIT WORK DATES                              
         XC    SJLGLEAV,SJLGLEAV                                                
*                                                                               
SJLGR5LP DS    0H                                                               
*                                                                               
         OC    SJLTDTES(SJLTDTEL),SJLTDTES   DONE AT END OF LIST                
         BZ    SJLGR5DN                                                         
*                                                                               
         CLC   SJLTJOIN,SJLGJOIN   FIND EARLIEST JOIN  DATE                     
         BNL   *+10                                                             
         MVC   SJLGJOIN,SJLTJOIN                                                
*                                                                               
         CLC   SJLTLEAV,SJLGLEAV   FIND LATEST   LEAVE DATE                     
         BNH   *+10                                                             
         MVC   SJLGLEAV,SJLTLEAV                                                
*                                                                               
SJLGR5CN DS    0H                                                               
*                                                                               
         LA    R5,SJLTDTEL(R5)     NEXT SET OF DATES                            
         B     SJLGR5LP                                                         
*                                                                               
SJLGR5DN DS    0H                                                               
*                                                                               
         DROP  R5                                                               
*                                                                               
         CLC   SJLGJOIN,REFCURSB   DROP IF JOINED IN CURRENT PERIOD             
         BNL   SJLGDROP                                                         
*                                                                               
         CLC   SJLGLEAV,REFPRIEB   DROP IF LEFT IN PRIOR PERIOD                 
         BNH   SJLGDROP                                                         
*                                                                               
SJLGR5N  DS    0H                                                               
*                                                                               
         B     SJLGOK              KEEP STATION IN REPORT                       
*                                                                               
SJLGDROP DS    0H                  DROP STATION FROM REPORT                     
*                                                                               
         XC    RESJLTA,RESJLTA     CLEAR TABLE ENTRY POINTER                    
         LTR   RB,RB               SET NE CC                                    
*                                                                               
         B     SJLGETX                                                          
*                                                                               
SJLGOK   DS    0H                  STATION OK FOR REPORT                        
*                                                                               
         CR    RB,RB               SET EQ CC                                    
*                                                                               
         B     SJLGETX             ALL DONE                                     
*                                                                               
SJLGETX  DS    0H                                                               
*                                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
SJLGREGS DS    16F                 REGISTER SAVEAREA                            
*                                                                               
SJLGSTA  DS    CL5                 DEFAULT STATION SAVEAREA                     
SJLGAIO  DS    A                   AIO SAVEAREA                                 
SJLGAIO1 DS    A                   A(IOAREA FOR ROUTINE)                        
SJLGENTA DS    A                   A(CURRENT TABLE ENTRY)                       
SJLGKEY  DS    XL(L'KEY)           KEY SAVEAREA                                 
*                                                                               
SJLGJOIN DS    XL3                 WORK JOIN  DATE - YMD BINARY                 
SJLGLEAV DS    XL3                 WORK LEAVE DATE - YMD BINARY                 
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - STPGET'                         
***********************************************************************         
*                                                                     *         
*        GET STATION TYPE                                             *         
*                                                                     *         
*        STATUS   DEFINITION                                          *         
*        ------   ----------                                          *         
*        OLD      LEFT   BEFORE REQUEST END   MONTH                   *         
*        NEW      JOINED AFTER  REQUEST START MONTH                   *         
*        COMP     NONE OF THE REST                                    *         
*        JOINED   JOINED BEFORE MID-MONTH (REQUEST START MONTH)       *         
*        LEFT     LEFT   BEFORE MID-MONTH (REQUEST END   MONTH)       *         
*                                                                     *         
* NTRY   R6 ==>   RSTAREC                                             *         
*        R8 ==>   RSTAELEM                                            *         
*        REFJLSTR JOIN/LEAVE START DATE - YMD                         *         
*        REFJLEND JOIN/LEAVE END   DATE - YMD                         *         
*                                                                     *         
*EXIT    RESTTP   CURRENT STATION TYPE   - OLD, NEW, COMP, LEFT,JOINED*         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
STPGET   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         USING RSTAREC,R6          ESTABLISH STATION RECORD                     
         USING RSTAELEM,R8         ESTABLISH STATION ELEMENT                    
*                                                                               
         MVI   RESTTP,RESTTPCQ     ASSUME COMPARABLE                            
*                                                                               
         XC    RESTSTR,RESTSTR     INIT STATION JOINED DATE                     
         MVC   RESTEND,=6X'FF'     INIT STATION LEAVE  DATE                     
*                                                                               
*        DETERMINE JOINED/LEFT PERIOD                                           
*                                                                               
         OC    REQPSTRB(6),REQPSTRB     SKIP IF NO REQUEST DATES                
         BZ    STPGETX                                                          
*                                                                               
         GOTO1 DATCON,DMCB,REQPSTR,(3,STPGFSTR)   DEFAULT IS REQ START          
*                                                                               
         OC    REFJLSTR,REFJLSTR   OVERRIDE WITH ENTERED JOIN DATE              
         BZ    *+10                                                             
         MVC   STPGFSTR,REFJLSTR                                                
*                                                                               
         GOTO1 DATCON,DMCB,REQPEND,(3,STPGFEND)   DEFAULT IS REQ END            
*                                                                               
         OC    REFJLEND,REFJLEND   OVERRIDE WITH ENTERED JOIN DATE              
         BZ    *+10                                                             
         MVC   STPGFEND,REFJLEND                                                
*                                                                               
STPGSTR  DS    0H                                                               
*                                                                               
         OC    RSTASTRT,RSTASTRT   SKIP IF NO JOIN DATE FOR STATION             
         BZ    STPGSTRX                                                         
*                                                                               
*        THIS CODE TAKES CARE OF QUIRKS IN KATZ CONVERSION                      
*                                                                               
         CLI   RSTASTRT+1,1        SKIP IF BOGUS MONTH                          
         BL    STPGSTRX                                                         
         CLI   RSTASTRT+1,12                                                    
         BH    STPGSTRX                                                         
*                                                                               
         CLI   RSTASTRT+2,1        SKIP IF BOGUS DAY                            
         BL    STPGSTRX                                                         
         CLI   RSTASTRT+2,31                                                    
         BH    STPGSTRX                                                         
*                                                                               
*        STATION JOIN DATE IS THE 16TH OF FIRST CALENDAR MONTH                  
*              THAT IS ALSO THE FIRST BROADCAST MONTH                           
*                                                                               
         GOTO1 DATCON,DMCB,(3,RSTASTRT),STPGSTRC   JOIN TO YYMMDD               
*                                                                               
         GOTO1 GETBROAD,DMCB,(1,STPGSTRC),STPGBRDM,GETDAY,ADDAY                 
*                                                                               
         CLC   STPGSTRC,STPGBSTR   OKAY IF JOINED AT B'MON START                
         BE    STPGSTR1                                                         
*                                                                               
         MVC   STPGBSTR,STPGBEND   ELSE COPY B'MON END DATE                     
*                                  END DATE ALWAYS IN CALENDAR MONTH            
*                                                                               
         GOTO1 ADDAY,DMCB,STPGBSTR,STPGBEND,15  BUMP END TO NXT MON             
*                                                                               
STPGSTR1 DS    0H                                                               
*                                                                               
         GOTO1 DATCON,DMCB,STPGBEND,(3,RESTSTR)   CHANGE TO YMD                 
*                                                                               
         MVI   RESTSTR+2,16        SET TO 16TH OF MONTH                         
*                                                                               
STPGSTRX DS    0H                                                               
*                                                                               
STPGEND  DS    0H                                                               
*                                                                               
         OC    RSTAEND,RSTAEND     SKIP IF NO LEAVE DATE FOR STATION            
         BZ    STPGENDX                                                         
*                                                                               
*        THIS CODE TAKES CARE OF QUIRKS IN KATZ CONVERSION                      
*                                                                               
         CLI   RSTAEND+1,1         SKIP IF BOGUS MONTH                          
         BL    STPGENDX                                                         
         CLI   RSTAEND+1,12                                                     
         BH    STPGENDX                                                         
*                                                                               
         CLI   RSTAEND+2,1         SKIP IF BOGUS DAY                            
         BL    STPGENDX                                                         
         CLI   RSTAEND+2,31                                                     
         BH    STPGENDX                                                         
*                                                                               
*        STATION LEAVE DATE IS THE 15TH OF LAST CALENDAR MONTH                  
*              THAT IS ALSO THE LAST BROADCAST MONTH                            
*                                                                               
         GOTO1 DATCON,DMCB,(3,RSTAEND),STPGENDC   LEAVE TO YYMMDD               
*                                                                               
         GOTO1 GETBROAD,DMCB,(1,STPGENDC),STPGBRDM,GETDAY,ADDAY                 
*                                                                               
         CLC   STPGENDC,STPGBEND   OKAY IF LEFT AT B'MON END                    
         BE    STPGEND1                                                         
*                                                                               
         GOTO1 ADDAY,DMCB,STPGBSTR,STPGBEND,F'-15'  START TO PREV MON           
*                                                                               
STPGEND1 DS    0H                                                               
*                                                                               
         GOTO1 DATCON,DMCB,STPGBEND,(3,RESTEND)   CHANGE TO YMD                 
*                                                                               
         MVI   RESTEND+2,15        SET TO 15TH OF MONTH                         
*                                                                               
STPGENDX DS    0H                                                               
*                                                                               
*        DETERMINE STATION'S TYPE                                               
*              ALL DATE COMPARISONS ARE YM ONLY                                 
*                                                                               
*        OLD, NEW OR COMPARABLE STATUS                                          
*                                                                               
         CLC   RESTEND(2),CURND    IF LEFT BEFORE LAST REQUEST MONTH            
         BNL   *+8                                                              
         OI    RESTTP,RESTTPOQ        SET TYPE AS OLD                           
*                                                                               
         CLC   RESTSTR(2),PRIST    IF JOINED AFTER 1ST PRIOR MONTH              
         BNH   *+8                                                              
         OI    RESTTP,RESTTPNQ        SET TYPE AS NEW                           
*                                                                               
*        DETERMINE LEFT OR JOINED STATUS                                        
*                                                                               
         OC    RSTAEND,RSTAEND     OKAY IF STILL AROUND                         
         BZ    STPGLFTX                                                         
*                                                                               
         CLC   RSTAEND,CURND       OKAY IF LEFT AFTER REQUEST END               
         BH    STPGLFTX                                                         
*                                                                               
         CLC   RSTAEND,CURST       IF LEFT ON/AFTER REQUEST START               
         BL    *+8                                                              
         OI    RESTTP,RESTTPLQ        SET AS LEFT                               
*                                                                               
STPGLFTX DS    0H                                                               
*                                                                               
         OC    RSTASTRT,RSTASTRT   OKAY IF ALWAYS AROUND                        
         BZ    STPGJNX                                                          
*                                                                               
         CLC   RSTASTRT,CURND      OKAY IF JOINED AFTER REQUEST END             
         BH    STPGJNX                                                          
*                                                                               
         CLC   RSTASTRT,CURST      IF JOINED ON OR AFTER REQUEST START          
         BL    *+8                                                              
         OI    RESTTP,RESTTPJQ        SET AS JOINED                             
*                                                                               
STPGJNX  DS    0H                                                               
*                                                                               
         TM    RESTTP,X'FF'-RESTTPCQ IF ANYTHING BESIDES COMPARABLE             
         BZ    *+8                                                              
         NI    RESTTP,X'FF'-RESTTPCQ    TURN OF COMPARABLE IND                  
*                                                                               
*        FILTER ON STATION TYPE                                                 
*                                                                               
         CLI   REFSTTP,0           SKIP IF NO STATION TYPE FILTER               
         BE    STPGTYPX                                                         
*                                                                               
         MVC   FULL(1),REFSTTP     COPY FILTER                                  
*                                                                               
         NC    FULL(1),RESTTP      COMPARE WITH FILTER                          
         BZ    STPGDROP            NO MATCH                                     
*                                                                               
         TM    REFSTTP,RESTTPNQ+RESTTPJQ  IF FILTERING ON NEW OR JOIN           
         BZ    *+12                                                             
         TM    RESTTP,RESTTPOQ+RESTTPLQ   AND STATION IS OLD OR LEFT            
         BNZ   STPGDROP                   DROP STATION                          
*                                                                               
STPGTYPX DS    0H                                                               
*                                                                               
         B     STPGETOK                                                         
*                                                                               
STPGDROP DS    0H                  STATION TO BE DROPPED FROM REPORT            
         LTR   RB,RB                                                            
         B     STPGETX                                                          
*                                                                               
STPGETOK DS    0H                  STATION TO BE INCLUDED IN REPORT             
         CR    RB,RB                                                            
*                                                                               
STPGETX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
STPGSTRC DS    CL6                 STATION JOIN   DATE - YMD                    
STPGENDC DS    CL6                 STATION LEAVE  DATE - YMD                    
STPGBRDM DS    0CL12               BROADCAST MONTH                              
STPGBSTR DS    CL6                 START OF BROADCAST MONTH                     
STPGBEND DS    CL6                 END   OF BROADCAST MONTH                     
STPGFSTR DS    XL3                 START OF JOINED/LEFT PERIOD                  
STPGFEND DS    XL3                 END   OF JOINED/LEFT PERIOD                  
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - AGY'                            
***********************************************************************         
*                                                                     *         
*        INIT AGENCY TABLE                                            *         
*                                                                     *         
*        MAY GET HERE MULTIPLE TIMES IF PROCESSING SEVERAL REPS       *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
AGY      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
*        ESTABLISH AGENCY TABLE                                                 
*                                                                               
         SR    R3,R3               INIT AGY TABLE ENTRY POINTER                 
         XC    REAGYTA,REAGYTA     INIT A(AGY TABLE ENTRY)                      
         XC    REAG2TA,REAG2TA     INIT A(AGY TABLE ENTRY)                      
*                                                                               
         ICM   R2,15,REAG2TBA      TABLE ADDRESS                                
         BZ    AGYX                NO TABLE AVAILABLE                           
*                                                                               
         USING AGYTTABD,R2         ESTABLISH AGY TABLE AREA                     
*                                                                               
*        INITIALIZE AGY TABLE                                                   
*                                                                               
AGYINIT  DS    0H                                                               
*                                                                               
         OC    AGYTBSRP,AGYTBSRP   SKIP IF TABLE ALREADY INITIALIZED            
         BNZ   AGYBSPX                                                          
*                                                                               
         LA    RF,AGYTTAB+AGYTENTL SET TABLE START - RESERVE 1ST SPOT           
         ST    RF,BSPATAB-BSPPRMS+AGYTBSRP IN TABLE FOR BUILDING ENTRY          
*                                                                               
         LA    RF,AGYTENTL         SET ENTRY LENGTH                             
         ST    RF,BSPLENR-BSPPRMS+AGYTBSRP                                      
*                                                                               
         LA    RF,L'RAGY2KEY       SET KEY LENGTH                               
         ST    RF,BSPLENK-BSPPRMS+AGYTBSRP                                      
*                                                                               
         LHI   RF,AGYTMAXQ         SET # OF AVAILABLE ENTRIES TO MAX            
         ST    RF,BSPMAX-BSPPRMS+AGYTBSRP                                       
*                                                                               
AGYBSPX  DS    0H                  END OF TABLE INITIALIZATION                  
*                                                                               
*        INIT WORK FIELDS                                                       
*                                                                               
         XC    AGYIMBA,AGYIMBA     INIT A(MEMBERS ELEMENT)                      
         XC    AGYIMBMA,AGYIMBMA   INIT A(CURRENT AGY CODE)                     
         XC    AGYISSA,AGYISSA     INIT A(SET OF SETS MEMBERS ELEMENT)          
         XC    AGYISSMA,AGYISSMA   INIT A(CURRENT SET OF SET MEMBER)            
         ZAP   AGYIMBCT,=P'0'      INIT MEMBERS COUNTER                         
         ZAP   AGYISSCT,=P'0'      INIT SET OF SETS COUNTER                     
*                                                                               
*        CHECK FOR FILTERING ON SINGLE AGY                                      
*                                                                               
AGYIAGY  DS    0H                                                               
*                                                                               
         OC    REFAGY(6),REFAGY    IF FILTERING ON SINGLE AGY                   
         BZ    AGYIAGYN                                                         
*                                                                               
         LA    R9,REFAGY              SET AS SINGLE MEMBER OF SET               
         ST    R9,AGYIMBMA                                                      
         ZAP   AGYIMBCT,=P'1'                                                   
         OI    REAGCNTL,REAGCFTQ      AGY BEING FILTERED                        
*                                                                               
         B     AGYSETX                GO PROCESS                                
*                                                                               
AGYIAGYN DS    0H                                                               
*                                                                               
*        READ FOR AGY SET RECORD                                                
*                                                                               
         XC    AGYTSKEY,AGYTSKEY   INIT AGY SET RECORD KEY                      
         XC    AGYTS1EL,AGYTS1EL   INIT AGY SET RECORD BASIC INFO  ELM          
         XC    AGYTSDSC,AGYTSDSC   INIT AGY SET RECORD DESCRIPTION ELM          
         XC    AGYTSMEM,AGYTSMEM   INIT AGY SET RECORD MEMBER      ELM          
*                                                                               
         OC    REAGYSID,REAGYSID   DONE IF NO AGY SET FILTER                    
         BZ    AGYSETN                                                          
*                                                                               
*        READ AGY SET RECORD                                                    
*                                                                               
*        REP FOR READING SET RECORD IS THE SAME AS THAT FOR AGENCIES            
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING RAGY2KEY,R4         ESTABLISH AS AGENCY RECORD                   
*                                                                               
         MVI   RAGK2TYP,RAGK2TYQ   SET AGENCY RECORD ID                         
         MVC   RAGK2REP,REREP                                                   
*                                                                               
         GOTOR SETREP,DMCB,KEY     FIND FILE REP FOR AGENCIES                   
*                                  WINDS UP IN REDMREP                          
*                                                                               
         XC    KEY,KEY                                                          
         USING RSETKEY,R4          ESTABLISH SET KEY                            
*                                                                               
         GOTOR TBLREP,DMCB,AGYTKEY    REP FOR TABLE                             
*                                       WINDS UP IN RETBREP                     
*                                                                               
         MVI   RSETKTYP,RSETKTYQ   RECORD ID                                    
         MVC   RSETKREP,RETBREP    REP                                          
         MVC   RSETKSET,=C'AG'     SET TYPE                                     
         MVC   RSETKID,REAGYSID    SET ID                                       
*                                                                               
         CLC   RSETKEY,AGYTSKEY    SKIP IF SET RECORD ALREADY READ              
         BE    AGYSETX                                                          
*                                                                               
         MVC   RSETKREP,REDMREP    REP                                          
*                                                                               
         BAS   RE,HIGH             READ KEY                                     
*                                                                               
         CLC   RSETKEY,KEYSAVE     MUST FIND IT                                 
         BNE   AGYX                                                             
*                                                                               
         BAS   RE,GETREC           READ RECORD                                  
*                                                                               
*        EXTRACT INFORMATION FROM SET RECORD                                    
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
         MVC   AGYTSKEY,RSETKEY    SAVE RECORD KEY                              
         MVC   RSETKREP-RSETKEY+AGYTSKEY,RETBREP   SET TABLE REP                
*                                                                               
         LA    R6,RSETELEM         POINT TO FIRST ELEMENT IN RECORD             
         SR    RF,RF                                                            
*                                                                               
AGYSETLP DS    0H                                                               
*                                                                               
         CLI   0(R6),0             DONE AT END OF RECORD                        
         BE    AGYSETDN                                                         
*                                                                               
         CLI   0(R6),X'01'         IF BASIC INFO ELEMENT                        
         BNE   AGYSET10                                                         
*                                                                               
         USING RSET1DES,R6            ESTABLISH BASIC INFO ELEMENT              
*                                                                               
         IC    RF,RSET1ELN            GET ELEMENT LENGTH                        
         BCTR  RF,0                   DECREMENT FOR EXECUTE                     
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   AGYTS1EL(0),RSET1DES   SAVE SET BASIC INFO ELEMENT               
*                                                                               
AGYSET10 DS    0H                                                               
*                                                                               
         CLI   0(R6),RSETDCDQ      IF DESCRIPTION ELEMENT                       
         BNE   AGYSET20                                                         
*                                                                               
         USING RSETDESD,R6            ESTABLISH DESCRIPTIVE ELEMENT             
*                                                                               
         IC    RF,RSETDELN            GET ELEMENT LENGTH                        
         BCTR  RF,0                   DECREMENT FOR EXECUTE                     
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   AGYTSDSC(0),RSETDESD   SAVE SET DESCRIPTION ELEMENT              
*                                                                               
AGYSET20 DS    0H                                                               
*                                                                               
         CLI   0(R6),RSETMCDQ   IF MEMBERSHIP ELEMENT                           
         BNE   AGYSET30                                                         
*                                                                               
         USING RSETMEMD,R6         ESTABLISH MEMBERSHIP ELEMENT                 
*                                                                               
         IC    RF,RSETMELN         GET ELEMENT LENGTH                           
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   AGYTSMEM(0),RSETMEMD SAVE SET MEMBER ELEMENT                     
*                                                                               
AGYSET30 DS    0H                                                               
*                                                                               
AGYSETCN DS    0H                                                               
*                                                                               
         IC    RF,1(R6)            GET ELEMENT LENGTH                           
         LA    R6,0(RF,R6)         POINT TO NEXT ELEMENT                        
         B     AGYSETLP                                                         
*                                                                               
AGYSETDN DS    0H                                                               
*                                                                               
         TM    RSET1FLG-RSET1DES+AGYTS1EL,X'08' IF NOT EXCLUSION SET            
         BO    *+8                                                              
         OI    REAGCNTL,REAGCFTQ      AGY BEING FILTERED                        
*                                                                               
         B     AGYSETX                                                          
*                                                                               
AGYSETN  DS    0H                                                               
*                                                                               
*        FILTER ON TERRITORY IF NEEDED                                          
*                                                                               
         CLC   REFTER,SPACES       SKIP IF NOT FILTERING ON TERRITORY           
         BNH   AGYX                                                             
*                                                                               
         GOTOR AGTERR                                                           
*                                                                               
         B     AGYX                TABLES ALL LOADED                            
*                                                                               
AGYSETX  DS    0H                                                               
*                                                                               
         DROP  R6                                                               
*                                                                               
*        INITIALIZATION FOR FILLING TABLE                                       
*                                                                               
         LA    R3,AGYTTAB          POINT TO FIRST TABLE ENTRY                   
         USING AGYTENT,R3          ESTABLISH AGY ENTRY                          
*                                                                               
         XC    AGYTKEY,AGYTKEY     INIT AGY ENTRY KEY                           
*                                                                               
*        READ ALL APPLICABLE AGY RECORDS                                        
*           SAVE IN TABLE                                                       
*                                                                               
*        CHECK FOR SET RECORD                                                   
*                                                                               
         SR    R8,R8               INIT MEMBER ELEMENT POINTER                  
*                                                                               
         OC    AGYTSKEY,AGYTSKEY   SKIP IF THERE IS NO SET RECORD               
         BZ    AGYIMB                                                           
*                                                                               
         LA    R8,AGYTSMEM         POINT TO MEMBERS ELEMENT                     
         USING RSETMCDE,R8         ESTABLISH SET MEMBER ELEMENT                 
*                                                                               
         LA    R9,RSETMEMB         POINT TO FIRST MEMBER                        
*                                                                               
         SR    RF,RF                                                            
         IC    RF,RSETMELN         ELEMENT LENGTH                               
*                                                                               
         AHI   RF,-RSETMTOV        DECREMENT BY OVERHEAD LENGTH                 
         BP    *+8                                                              
         B     AGYDONE                NO SETS IN SET - NO AGYS                  
*                                                                               
         SR    R1,R1                                                            
         ICM   R1,1,RSETMLEN       GET LENGTH OF EACH MEMBER                    
         BZ    AGYDONE                                                          
*                                                                               
         SR    RE,RE                                                            
         DR    RE,R1               NUMBER OF MEMBERS IN ELEMENT                 
         CVD   RF,DUB                                                           
*                                                                               
         XC    DMCB(24),DMCB       SORT MEMBERSHIP LIST                         
         MVC   DMCB+11(1),RSETMLEN                                              
         MVC   DMCB+15(1),RSETMLEN                                              
*                                                                               
         GOTO1 XSORT,DMCB,RSETMEMB,(RF)                                         
*                                                                               
*        CHECK FOR SET OF SETS CASE                                             
*                                                                               
         TM    RSET1FLG-RSET1DES+AGYTS1EL,X'80' TEST FOR SET OF SETS            
         BO    AGYISS                 YES                                       
*                                                                               
         ST    R8,AGYIMBA          NO - SAVE AS A(AGY MEMBERS ELEMENT)          
         ST    R9,AGYIMBMA              SAVE A(FIRST MEMBER)                    
         ZAP   AGYIMBCT,DUB        SAVE NUMBER OF MEMBERS                       
         B     AGYIMB                                                           
*                                                                               
*        WE HAVE A SET OF SETS                                                  
*                                                                               
AGYISS   DS    0H                                                               
*                                                                               
         ST    R8,AGYISSA          SAVE AS A(SET OF SETS MEMBERS ELM)           
         ST    R9,AGYISSMA         SAVE A(FIRST MEMBER)                         
         ZAP   AGYISSCT,DUB        SAVE NUMBER OF MEMBERS                       
*                                                                               
*        HANDLE SET OF SETS                                                     
*                                                                               
AGYISSLP DS    0H                                                               
*                                                                               
*        READ FIRST/NEXT SET RECORD                                             
*                                                                               
         ICM   R9,15,AGYISSMA      A(NEXT SET ID)                               
         BZ    AGYISSDN            NO SET IDS AVAILABLE                         
*                                                                               
         LA    R4,KEY              ESTABLISH KEY FOR READING SETS               
         USING RSETKEY,R4                                                       
*                                                                               
         MVC   KEY,AGYTSKEY        COPY MASTER SET KEY                          
         MVC   RSETKREP,REDMREP    SET REP FOR FILE READS                       
         MVC   RSETKID,0(R9)       FILL IN MEMBER SET                           
*                                                                               
         GOTO1 HIGH                READ MEMBER SET POINTER                      
*                                                                               
         CLC   RSETKEY,KEYSAVE     SKIP IF NOT FOUND                            
         BNE   AGYISSCN                                                         
*                                                                               
         MVC   REAIO,REAIO2        READ INTO AIO2                               
         GOTO1 GETREC                                                           
         MVC   REAIO,REAIO1        RESTORE IOAREA POINTER                       
*                                                                               
*        FIND MEMBERSHIP ELEMENT                                                
*                                                                               
         L     RE,REAIO2           POINT TO FOUND RECORD                        
         LA    R1,RSETELEM-RSETKEY(RE)  POINT TO 1ST ELEMENT                    
         SR    RF,RF                                                            
*                                                                               
         CLI   0(R1),0             DONE AT END OF RECORD                        
         BE    AGYISSCN                                                         
         CLI   0(R1),RSETMCDQ      FIND MEMBER ELEMENT                          
         BE    *+16                                                             
         IC    RF,1(R1)                                                         
         LA    R1,0(RF,R1)                                                      
         B     *-24                                                             
*                                                                               
         ST    R1,AGYIMBA          SAVE A(MEMBER'S ELEMENT)                     
*                                                                               
AGYIMB   DS    0H                  HANDLE SET OF AGY'S                          
*                                                                               
         ICM   R8,15,AGYIMBA       POINT TO MEMBER ELM OF SET                   
         BZ    AGYIMB10                                                         
*                                                                               
         USING RSETMEMD,R8                                                      
*                                                                               
         SR    RF,RF                                                            
         IC    RF,RSETMELN         ELEMENT LENGTH                               
*                                                                               
         AHI   RF,-RSETMTOV        DECREMENT BY OVERHEAD LENGTH                 
         BP    *+8                                                              
         B     AGYIMBDN               NO AGYS IN SET                            
*                                                                               
         SR    R1,R1                                                            
         ICM   R1,1,RSETMLEN       GET LENGTH OF EACH MEMBER                    
         BZ    AGYIMBDN                                                         
*                                                                               
         SR    RE,RE                                                            
         DR    RE,R1               NUMBER OF SETS IN ELEMENT                    
         CVD   RF,DUB                                                           
         ZAP   AGYIMBCT,DUB        SAVE NUMBER OF SETS                          
*                                                                               
         LA    R9,RSETMEMB         SAVE A(CURRENT MEMBER)                       
         ST    R9,AGYIMBMA                                                      
*                                                                               
AGYIMB10 DS    0H                                                               
*                                                                               
         ICM   R9,15,AGYIMBMA      SKIP IF NO AGY AVAILABLE                     
         BZ    AGYIMBDN                                                         
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING RAGY2KEY,R4         ESTABLISH AGY2 KEY                           
*                                                                               
         MVI   RAGK2TYP,RAGK2TYQ   RECORD ID                                    
*                                                                               
         MVC   RAGK2AGY(6),0(R9)   SET AGENCY ID IN KEY                         
*                                                                               
         MVI   LKEY,RAGK2REP-RAGY2KEY  SET KEY COMPARE LENGTH                   
*                                                                               
         CLC   RAGK2AOF,RESPACES   IF NO OFFICE SPECIFIED                       
         BH    *+8                                                              
         MVI   LKEY,RAGK2AOF-RAGY2KEY  RESET COMPARE LENGTH                     
*                                                                               
         CLC   RAGK2AGY,RESPACES   IF NO AGENCY SPECIFIED                       
         BH    *+8                                                              
         MVI   LKEY,RAGK2AGY-RAGY2KEY  RESET COMPARE LENGTH                     
*                                                                               
         GOTO1 =A(SETREP),DMCB,RAGY2KEY      SET CORRECT REP IN KEY             
*                                                                               
         BAS   RE,FIRSTHI          READ FIRST AGY RECORD                        
*                                                                               
         MVI   AGYSW,0             INIT SWITCH                                  
*                                                                               
AGYIMBLP DS    0H                                                               
*                                                                               
         BAS   RE,KEYCOMP          SKIP IF BREAK IN KEY FOUND                   
         BNE   AGYIMBCN                                                         
*                                                                               
         LA    R4,KEY                                                           
         USING RAGY2KEY,R4         ESTABLISH AGY KEY                            
*                                                                               
         CLC   RAGK2REP,REDMREP      REPS MUST MATCH                            
         BNE   AGYIMBC1                                                         
*                                                                               
         LA    R3,AGYTTAB          RESET POINTER                                
         USING AGYTENT,R3          ESTABLISH AGY ENTRY                          
*                                                                               
         MVC   AGYTKEY,RAGY2KEY    SAVE AGY KEY                                 
*                                                                               
         GOTOR TBLREP,DMCB,AGYTKEY    REP FOR TABLE                             
*                                                                               
         MVC   RAGK2REP-RAGY2KEY+AGYTKEY,RETBREP                                
*                                                                               
         GOTO1 BINSRCH,AGYTBSRP,('BSPFIND',AGYTENT)  CHECK IF IN TABLE          
*                                                                               
         CLI   BSPCNTL-BSPPRMS+AGYTBSRP,BSPNF IF NOT FOUND                      
         BNE   AGYTABX                           ADD TO TABLE                   
*                                                                               
         BAS   RE,GETREC           READ IN RECORD                               
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
*                                                                               
         USING RAG2ELEM,R6         ESTABLISH AGENCY ELEMENT                     
*                                                                               
         MVI   ELCODE,X'1F'        FIND AGENCY DECRIPTION ELEMENT               
         LR    R6,R4               START OF RECORD                              
         BRAS  RE,GETEL                                                         
         BNE   *+14                ELEMENT NOT FOUND                            
         MVC   AGYTELM,RAG2ELEM    SAVE AGENCY ELEMENT                          
         MVI   AGYTELM+1,L'AGYTELM RESET ELEMENT LENGTH                         
*                                                                               
         USING RAGY2FXE,R6         ESTABLISH FAX ELEMENT                        
*                                                                               
         MVI   ELCODE,X'10'        FIND FAX ELEMENT                             
         LR    R6,R4                                                            
         BAS   RE,GETEL                                                         
         BNZ   *+14                ELEMENT NOT FOUND                            
         MVC   AGYTFAX,RAGY2FXE    SAVE FAX ELEMENT                             
         MVI   AGYTFAX+1,L'AGYTFAX RESET ELEMENT LENGTH                         
*                                                                               
         CLC   REFTER,RESPACES     IF FILTER PRESENT                            
         BNH   *+14                                                             
         CLC   REFTER,RAGY2TER-RAGY2FXE+AGYTFAX   MUST MATCH FILTER             
         BNE   AGYIMBCN                                                         
*                                                                               
         USING RAGY2AE1,R6         ESTABLISH ADDRESS ELEMENT                    
*                                                                               
         MVI   ELCODE,X'20'        FIND ADDRESS ELEMENT                         
         LR    R6,R4                                                            
         BAS   RE,GETEL                                                         
         BNZ   *+14                ELEMENT NOT FOUND                            
         MVC   AGYTEXAD,RAGY2AE1   SAVE ADDRESS ELEMENT                         
         MVI   AGYTEXAD+1,L'AGYTEXAD RESET ELEMENT LENGTH                       
*                                                                               
         USING RAGY2REC,R4                                                      
*                                                                               
         TM    RSET1FLG-RSET1DES+AGYTS1EL,X'08' IF EXCLUSION SET                
         BNO   *+8                                                              
         OI    AGYTKEY+27,X'80'     MARK RECORD DELETED                         
*                                                                               
         CLI   AGYSW,C'1'          IF ADDING AGENCY ENTRY                       
         BNE   *+8                                                              
         OI    AGYTKEY+27,X'80'     MARK RECORD DELETED                         
*                                                                               
         GOTO1 BINSRCH,AGYTBSRP,('BSPADD',AGYTENT)  ADD TO TABLE                
*                                                                               
         OC    BSPAREC-BSPPRMS+AGYTBSRP,BSPAREC-BSPPRMS+AGYTBSRP                
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
*                                                                               
AGYTABX  DS    0H                                                               
*                                                                               
         MVI   AGYSW,0             RESET SWITCH                                 
*                                                                               
         TM    REALL2,REALAGYQ     IF WE NEED TO FILE LIST                      
         BNO   AGYLLSTX                                                         
*                                                                               
         L     R3,BSPAREC-BSPPRMS+AGYTBSRP POINT TO TABLE ENTRY                 
*                                                                               
         ST    R3,REAGYTA          RESET A(CURRENT TABLE ENTRY)                 
         ST    R3,REAG2TA          RESET A(CURRENT TABLE ENTRY)                 
         ST    R3,AGYTENTA                                                      
*                                                                               
         LA    R4,AGYTKEY          ESTABLISH AGENCY KEY                         
         USING RAGY2REC,R4                                                      
*                                                                               
         MVC   REAGY,RAGK2AGY      SET CURRENT AGENCY                           
         MVC   REAOF,RAGK2AOF      SET CURRENT AGENCY OFFICE                    
         MVC   RETER,RAGY2TER-RAGY2FXE+AGYTFAX   SET TERR CODE                  
*                                                                               
         DROP  R6                                                               
*                                                                               
AGYHOOKM DS    0H                                                               
*                                                                               
         NI    RECNTRL,X'FF'-RECRTRNQ   TURN OFF RETURN SWITCH                  
*                                                                               
         BAS   RE,GOHOOK           PASS RECORD TO DRIVER                        
*                                                                               
         TM    RECNTRL,RECRTRNQ    TEST IF NEED TO RETURN FOR MORE DATA         
         BO    AGYHOOKM                                                         
*                                                                               
AGYLLSTX DS    0H                                                               
*                                                                               
AGYIMBC1 DS    0H                                                               
*                                                                               
         BAS   RE,SEQ              NEXT ON FILE                                 
         B     AGYIMBLP                                                         
*                                                                               
AGYIMBCN DS    0H                                                               
*                                                                               
         LA    R4,KEY              RESTORE DESIRED KEY                          
         MVC   KEY,KEYSAVE                                                      
*                                                                               
         CLC   RAGK2AOF,RESPACES   IF AGENCY OFFICE FOUND                       
         BNH   AGYIMBC2                                                         
*                                                                               
         MVC   RAGK2AOF,RESPACES      ERASE OFFICE                              
*                                                                               
         GOTO1 HIGH                   FIND AGENCY RECORD                        
         MVI   AGYSW,C'1'             SET SWITCH                                
         B     AGYIMBLP                                                         
*                                                                               
AGYIMBC2 DS    0H                                                               
*                                                                               
         SP    AGYIMBCT,=P'1'      DECREMENT MEMBER COUNTER                     
         BNP   AGYIMBDN            NONE LEFT IN ELEMENT                         
*                                                                               
         ICM   R9,15,AGYIMBMA      UPDATE MEMBER POINTER                        
         BZ    AGYIMBDN                                                         
*                                                                               
         LA    R9,L'RAGK2AGY+L'RAGK2AOF(R9)   BUMP TO NEXT MEMBER               
         ST    R9,AGYIMBMA         UPDATE MEMBER POINTER                        
*                                                                               
         LA    R4,KEY              RE-POINT TO FOUND KEY                        
         MVC   KEY,KEYSAVE         RESTORE SOUGHT AFTER KEY                     
*                                                                               
         MVC   RAGK2AGY(6),0(R9)   SET NEXT AGY IN KEY                          
         XC    RAGK2REP,RAGK2REP   KILL REP                                     
*                                                                               
         BAS   RE,HIGH             READ DIRECTORY POINTER                       
*                                                                               
         B     AGYIMBLP                                                         
*                                                                               
AGYIMBDN DS    0H                                                               
*                                                                               
         XC    AGYIMBMA,AGYIMBMA   RESET MEMBER OF MEMBER SET POINTER           
         XC    AGYIMBA,AGYIMBA     RESET MEMBER SET POINTER                     
         ZAP   AGYIMBCT,=P'0'      RESET MEMBER COUNTER                         
*                                                                               
AGYISSCN DS    0H                                                               
*                                                                               
         SP    AGYISSCT,=P'1'      DECREMENT MEMBER SET COUNTER                 
         BNP   AGYISSDN                                                         
*                                                                               
         L     R9,AGYISSMA         POINT TO NEXT SET ID                         
         LA    R9,4(R9)                                                         
         ST    R9,AGYISSMA                                                      
*                                                                               
         B     AGYISSLP                                                         
*                                                                               
AGYISSDN DS    0H                                                               
*                                                                               
         XC    AGYISSMA,AGYISSMA   RESET MEMBER SET POINTER                     
         XC    AGYISSA,AGYISSA     RESET SET OF SETS ELM PTR                    
         ZAP   AGYISSCT,=P'0'      RESET SET COUNTER                            
*                                                                               
AGYDONE  DS    0H                                                               
*                                                                               
AGYX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
AGYISSA  DS    A                   A(SET OF SETS MEMBER ELM)                    
AGYISSMA DS    A                   A(CURRENT MBR OF SET OF SETS ELM)            
AGYIMBA  DS    A                   A(SET MEMBER ELEMENT)                        
AGYIMBMA DS    A                   A(CURRENT MEMBER OF MEMBER ELM)              
AGYISSCT DS    PL2                 COUNT OF SETS REMAINING                      
AGYIMBCT DS    PL2                 COUNT OF MEMBERS REMAINING                   
AGYSW    DS    C                   C'1' MEANS LOOKING FOR AGENCY RECORD         
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - AGYTERR'                        
***********************************************************************         
*                                                                     *         
*        BUILD AGENCY TABLE USING TERRITORY FILTER                    *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
AGYTERR  DS    0D                                                               
AGTERR   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
*        ESTABLISH ADVERTISER TABLE                                             
*                                                                               
         SR    R3,R3               INIT AGY TABLE ENTRY POINTER                 
         XC    REAGYTA,REAGYTA     INIT A(AGY TABLE ENTRY)                      
         XC    REAG2TA,REAG2TA     INIT A(AGY TABLE ENTRY)                      
*                                                                               
         ICM   R2,15,REAG2TBA      TABLE ADDRESS                                
         BZ    AGYTERRX            NO TABLE AVAILABLE                           
*                                                                               
         OI    REAGCNTL,REAGCFTQ   AGY BEING FILTERED                           
*                                                                               
         USING AGYTTABD,R2         ESTABLISH AGY TABLE AREA                     
*                                                                               
         LA    R3,AGYTTAB          POINT TO FIRST TABLE ENTRY                   
         USING AGYTENT,R3          ESTABLISH AGY ENTRY                          
*                                                                               
         XC    AGYTKEY,AGYTKEY     INIT AGY ENTRY KEY                           
         XC    AGYTELM,AGYTELM     INIT AGY ENTRY DESC ELM                      
         XC    AGYTFAX,AGYTFAX     INIT AGY ENTRY FAX ELM                       
         XC    AGYTEXAD,AGYTEXAD   INIT AGY ENTRY ADDRESS ELEMENT               
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING RAGKTKEY,R4         ESTABLISH TERRITORY PASSIVE PTR              
*                                                                               
         MVI   RAGKTTYP,RAGKTTYQ   RECORD ID                                    
         MVC   RAGKTREP,REREP      REP                                          
*                                                                               
         GOTO1 =A(SETREP),DMCB,RAGKTKEY      SET CORRECT REP IN KEY             
*                                                                               
         MVC   RAGKTTER,REFTER        USE ITS TERRITORY                         
*                                                                               
         OC    REFAGY(6),RESPACES     IF AGY FILTER SET                         
         BNH   *+10                                                             
         MVC   RAGKTAGY(6),REFAGY        USE IT                                 
*                                                                               
         MVI   LKEY,RAGKTAOF+L'RAGKTAOF-RAGKTKEY  SET KEY COMPARE               
*                                                                               
         CLC   RAGKTAOF,RESPACES   IF NO OFFICE SPECIFIED                       
         BH    AGTLKEYX                                                         
*                                                                               
         MVI   LKEY,RAGKTAOF-RAGKTKEY  RESET COMPARE LENGTH                     
*                                                                               
         CLC   RAGKTAGY,RESPACES   IF NO AGENCY SPECIFIED                       
         BH    AGTLKEYX                                                         
*                                                                               
         MVI   LKEY,RAGKTAGY-RAGKTKEY  RESET COMPARE LENGTH                     
*                                                                               
         CLC   RAGKTTER,RESPACES   IF NO TERRITORY SPECIFIED                    
         BH    AGTLKEYX                                                         
*                                                                               
         MVI   LKEY,RAGKTTER-RAGKTKEY  RESET COMPARE LENGTH                     
*                                                                               
AGTLKEYX DS    0H                                                               
*                                                                               
         BAS   RE,FIRSTHI          READ FIRST AGY/TER POINTER                   
*                                                                               
AGTLOOP  DS    0H                                                               
*                                                                               
         LA    R4,KEY                                                           
         USING RAGKTKEY,R4         ESTABLISH AGY/TER KEY                        
*                                                                               
         BAS   RE,KEYCOMP          SKIP IF BREAK IN KEY FOUND                   
         BNE   AGTDONE                                                          
*                                                                               
         MVC   AGTTKEY,RAGKTKEY     SAVE AGT KEY                                
*                                                                               
         BAS   RE,GETREC           READ IN RECORD                               
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
*                                                                               
         USING RAGY2KEY,R4         ESTABLISH AGY2REC KEY                        
*                                                                               
         MVC   AGYTKEY,RAGY2KEY    SAVE MASTER KEY                              
*                                                                               
         USING RAG2ELEM,R6         ESTABLISH AGENCY ELEMENT                     
*                                                                               
         MVI   ELCODE,X'1F'        FIND AGENCY DECRIPTION ELEMENT               
         LR    R6,R4               START OF RECORD                              
         BRAS  RE,GETEL                                                         
         BNE   *+10                ELEMENT NOT FOUND                            
         MVC   AGYTELM,RAG2ELEM    SAVE AGENCY ELEMENT                          
*                                                                               
         USING RAGY2FXE,R6         ESTABLISH FAX ELEMENT                        
*                                                                               
         MVI   ELCODE,RAGY2CDQ     FIND FAX ELEMENT                             
         LR    R6,R4                                                            
         BAS   RE,GETEL                                                         
         BNZ   *+10                RECORD NOT FOUND                             
         MVC   AGYTFAX,RAGY2FXE    SAVE ELEMENT                                 
*                                                                               
         USING RAGY2AE1,R6         ESTABLISH ADDRESS ELEMENT                    
*                                                                               
         MVI   ELCODE,X'20'        FIND ADDRESS ELEMENT                         
         LR    R6,R4                                                            
         BAS   RE,GETEL                                                         
         BNZ   *+10                RECORD NOT FOUND                             
         MVC   AGYTEXAD,RAGY2AE1   SAVE ELEMENT                                 
*                                                                               
         GOTOR TBLREP,DMCB,AGYTKEY    FIND REP FOR TABLE                        
*                                                                               
         MVC   RAGK2REP-RAGY2KEY+AGYTKEY,RETBREP   SET TABLE KEY                
*                                                                               
         GOTO1 BINSRCH,AGYTBSRP,('BSPADD',AGYTENT)  ADD TO TABLE                
*                                                                               
         OC    BSPAREC-BSPPRMS+AGYTBSRP,BSPAREC-BSPPRMS+AGYTBSRP                
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
*                                                                               
*        ADD ENTRIES FOR ANY OFFICES                                            
*                                                                               
         CLC   RAGK2AOF,RESPACES   SKIP IF NOT A MASTER AGENCY REC              
         BH    AGTLTOFX                                                         
*                                                                               
         MVC   AGTLKEY,LKEY        SAVE ORIGINAL KEY COMPARE LENGTH             
*                                                                               
         MVC   AGT2FXE,AGYTFAX     SAVE ELEMENT CONTAINING TERRITORY            
         MVC   AGT2AE1,AGYTEXAD    SAVE ELEMENT CONTAINING ADDRESS              
*                                                                               
         MVI   LKEY,RAGYKAOF-RAGYKEY   READING FOR ONLY 1 AGENCY                
*                                                                               
         MVC   KEY,RAGY2KEY        COPY MASTER KEY                              
*                                                                               
         LA    R4,KEY              ESTABLISH MASTER KEY                         
         USING RAGY2KEY,R4                                                      
*                                                                               
         GOTO1 =A(SETREP),DMCB,RAGY2KEY     SET CORRECT REP IN KEY              
*                                                                               
         BAS   RE,FIRSTHI          FIRST OFFICE                                 
*                                                                               
AGTLTOFL DS    0H                                                               
*                                                                               
         LA    R4,KEY                                                           
         USING RAGY2KEY,R4         ESTABLISH MASTER KEY                         
*                                                                               
         BAS   RE,KEYCOMP                                                       
         BNE   AGTLTOFD            END OF OFFICES                               
*                                                                               
         CLC   RAGK2REP,REDMREP    REPS MUST MATCH                              
         BNE   AGTLTOFC                                                         
*                                                                               
         CLC   RAGK2AOF,RESPACES   MUST HAVE AN OFFICE                          
         BNH   AGTLTOFC                                                         
*                                                                               
         BAS   RE,GETREC           READ IN RECORD                               
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
*                                                                               
*        BUILD ENTRY FOR AGENCY TABLE                                           
*                                                                               
         MVC   AGYTKEY,RAGY2KEY    SAVE KEY                                     
*                                                                               
         GOTOR TBLREP,DMCB,AGYTKEY    FIND REP FOR TABLE                        
         MVC   RAGK2REP-RAGY2KEY+AGYTKEY,RETBREP TABLE REP                      
*                                                                               
         USING RAG2ELEM,R6         ESTABLISH AGENCY ELEMENT                     
*                                                                               
         MVI   ELCODE,X'1F'        FIND AGENCY DECRIPTION ELEMENT               
         LR    R6,R4               START OF RECORD                              
         BRAS  RE,GETEL                                                         
         BNE   *+10                ELEMENT NOT FOUND                            
         MVC   AGYTELM,RAG2ELEM    SAVE AGENCY ELEMENT                          
*                                                                               
         USING RAGY2FXE,R6         ESTABLISH FAX ELEMENT                        
*                                                                               
         MVI   ELCODE,RAGY2CDQ     FIND FAX ELEMENT                             
         LR    R6,R4                                                            
         BAS   RE,GETEL                                                         
         BNZ   *+10                RECORD NOT FOUND                             
         MVC   AGYTFAX,RAGY2FXE    SAVE ELEMENT                                 
*                                                                               
         CLC   RAGY2TER-RAGY2FXE+AGYTFAX,RESPACES IF NO TERR FOR OFC            
         BH    *+10                                                             
         MVC   RAGY2TER-RAGY2FXE+AGYTFAX,RAGY2TER-RAGY2FXE+AGT2FXE              
*                                     USE AGENCY'S AS DEFAULT                   
*                                                                               
         USING RAGY2AE1,R6         ESTABLISH ADDRESS ELEMENT                    
*                                                                               
         MVI   ELCODE,X'20'        FIND ADDRESS ELEMENT                         
         LR    R6,R4                                                            
         BAS   RE,GETEL                                                         
         BNZ   *+10                RECORD NOT FOUND                             
         MVC   AGYTEXAD,RAGY2AE1   SAVE ELEMENT                                 
*                                                                               
         GOTO1 BINSRCH,AGYTBSRP,('BSPADD',AGYTENT)  ADD TO TABLE                
*                                                                               
         OC    BSPAREC-BSPPRMS+AGYTBSRP,BSPAREC-BSPPRMS+AGYTBSRP                
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
*                                                                               
AGTLTOFC DS    0H                                                               
*                                                                               
         BAS   RE,SEQ              NEXT AGENCY OFFICE RECORD                    
         B     AGTLTOFL                                                         
*                                                                               
AGTLTOFD DS    0H                                                               
*                                                                               
         MVC   LKEY,AGTLKEY        RESTORE ORIGINAL KEY COMPARE LENGTH          
*                                                                               
*        RESTORE SEQUENTIAL READ                                                
*                                                                               
         MVC   KEY,AGTTKEY         RESTORE ORIGINAL AGY/TER KEY                 
*                                                                               
         LA    R4,KEY              RESTORE AGYTER KEY                           
         USING RAGKTKEY,R4                                                      
*                                                                               
         GOTO1 =A(SETREP),DMCB,RAGKTKEY      SET CORRECT REP IN KEY             
*                                                                               
         BAS   RE,HIGH             RESTORE FILE POINTER                         
*                                                                               
AGTLTOFX DS    0H                                                               
*                                                                               
AGYCONT  DS    0H                                                               
*                                                                               
         BAS   RE,SEQ              NEXT ON FILE                                 
         B     AGTLOOP                                                          
*                                                                               
AGTDONE  DS    0H                                                               
*                                                                               
AGYTERRX DS    0H                                                               
         XIT1                                                                   
*                                                                               
AGTMBCTR DC    PL2'0'              SET MEMBERS COUNTER                          
*                                                                               
AGTTKEY  DS    XL(L'KEY)           KEY SAVEAREA                                 
AGTLKEY  DS    XL1                 KEY COMPARE LENGTH SAVEAREA                  
AGT2FXE  DS    XL(RAGY2FLQ)        AGENCY FAX ELEMENT SAVEAREA                  
AGT2AE1  DS    XL(RAGY2FL1)        AGENCY EXTENDED ADDRESS SAVEAREA             
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - ADV'                            
***********************************************************************         
*                                                                     *         
*        INIT ADVERTISER TABLE                                        *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
ADV      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
*        ESTABLISH ADVERTISER TABLE                                             
*                                                                               
         SR    R3,R3               INIT ADV TABLE ENTRY POINTER                 
         XC    READVTA,READVTA     INIT A(ADV TABLE ENTRY)                      
*                                                                               
         ICM   R2,15,READVTBA      TABLE ADDRESS                                
         BZ    ADVX                NO TABLE AVAILABLE                           
*                                                                               
         USING ADVTTABD,R2         ESTABLISH ADV TABLE AREA                     
*                                                                               
*        INITIALIZE ADV TABLE                                                   
*                                                                               
ADVINIT  DS    0H                                                               
*                                                                               
*        INIT BINSRCH PARAMETERES                                               
*                                                                               
         OC    ADVTBSRP,ADVTBSRP   SKIP IF TABLE ALREADY INITIALIZED            
         BNZ   ADVBSRPX                                                         
*                                                                               
         LA    RF,ADVTTAB+ADVTENTL SET TABLE START - RESERVE 1ST SPOT           
         ST    RF,BSPATAB-BSPPRMS+ADVTBSRP IN TABLE FOR BUILDING ENTRY          
*                                                                               
         LA    RF,ADVTENTL         SET ENTRY LENGTH                             
         ST    RF,BSPLENR-BSPPRMS+ADVTBSRP                                      
*                                                                               
         LA    RF,L'RADVKEY        SET KEY LENGTH                               
         ST    RF,BSPLENK-BSPPRMS+ADVTBSRP                                      
*                                                                               
         ICM   RF,15,=AL4(ADVTMAXQ)   SET # OF AVAILABLE ENTRIES TO MAX         
         ST    RF,BSPMAX-BSPPRMS+ADVTBSRP                                       
*                                                                               
ADVBSRPX DS    0H                                                               
*                                                                               
*        INIT WORK FIELDS                                                       
*                                                                               
         XC    ADVIMBA,ADVIMBA     INIT A(MEMBERS ELEMENT)                      
         XC    ADVIMBMA,ADVIMBMA   INIT A(CURRENT ADV CODE)                     
         XC    ADVISSA,ADVISSA     INIT A(SET OF SETS MEMBERS ELEMENT)          
         XC    ADVISSMA,ADVISSMA   INIT A(CURRENT SET OF SET MEMBER)            
         ZAP   ADVIMBCT,=P'0'      INIT MEMBERS COUNTER                         
         ZAP   ADVISSCT,=P'0'      INIT SET OF SETS COUNTER                     
*                                                                               
*        CHECK FOR FILTERING ON SINGLE ADV                                      
*                                                                               
ADVIADV  DS    0H                                                               
*                                                                               
         OC    REFADV,REFADV       IF FILTERING ON SINGLE ADV                   
         BZ    ADVIADVN                                                         
*                                                                               
         LA    R9,REFADV              SET AS SINGLE MEMBER OF SET               
         ST    R9,ADVIMBMA                                                      
         ZAP   ADVIMBCT,=P'1'                                                   
         OI    READCNTL,READCFTQ      ADV BEING FILTERED                        
*                                                                               
         B     ADVSETX                GO PROCESS                                
*                                                                               
ADVIADVN DS    0H                                                               
*                                                                               
*        READ FOR ADV SET RECORD                                                
*                                                                               
         XC    ADVTSKEY,ADVTSKEY   INIT ADV SET RECORD KEY                      
         XC    ADVTS1EL,ADVTS1EL   INIT ADV SET RECORD BASIC INFO  ELM          
         XC    ADVTSDSC,ADVTSDSC   INIT ADV SET RECORD DESCRIPTION ELM          
         XC    ADVTSMEM,ADVTSMEM   INIT ADV SET RECORD MEMBER      ELM          
*                                                                               
         OC    READVSID,READVSID   DONE IF NO ADV SET FILTER                    
         BZ    ADVSETX                                                          
*                                                                               
*        REP FOR READING SET RECORD IS THE SAME AS THAT FOR ADVS                
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING RADVKEY,R4          ESTABLISH AS ADVERTISER RECORD               
*                                                                               
         MVI   RADVKTYP,RADVKTYQ   SET ADVERTISER RECORD ID                     
         MVC   RADVKREP,REREP                                                   
*                                                                               
         GOTO1 =A(SETREP),DMCB,KEY    FIND FILE REP FOR ADVERTISERS             
*                                     WINDS UP IN REDMREP                       
*                                                                               
         XC    KEY,KEY                                                          
         USING RSETKEY,R4          ESTABLISH SET KEY                            
*                                                                               
         MVI   RSETKTYP,RSETKTYQ   RECORD ID                                    
         MVC   RSETKREP,REDMREP    REP                                          
         MVC   RSETKSET,=C'AD'     SET ID                                       
         MVC   RSETKID,READVSID    SET ID                                       
*                                                                               
         BAS   RE,HIGH             READ KEY                                     
*                                                                               
         CLC   RSETKEY,KEYSAVE     MUST FIND IT                                 
         BNE   ADVSETX                                                          
*                                                                               
         BAS   RE,GETREC           READ IN RECORD                               
*                                                                               
*        EXTRACT INFORMATION FROM SET RECORD                                    
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
         MVC   ADVTSKEY,RSETKEY    SAVE RECORD KEY                              
*                                                                               
         LA    R6,RSETELEM         POINT TO FIRST ELEMENT IN RECORD             
         SR    RF,RF                                                            
*                                                                               
ADVSETLP DS    0H                                                               
*                                                                               
         CLI   0(R6),0             DONE AT END OF RECORD                        
         BE    ADVSETDN                                                         
*                                                                               
         CLI   0(R6),X'01'         IF BASIC INFO ELEMENT                        
         BNE   ADVSET10                                                         
*                                                                               
         USING RSET1DES,R6            ESTABLISH BASIC INFO ELEMENT              
*                                                                               
         IC    RF,RSET1ELN            GET ELEMENT LENGTH                        
         BCTR  RF,0                   DECREMENT FOR EXECUTE                     
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   ADVTS1EL(0),RSET1DES   SAVE SET BASIC INFO ELEMENT               
*                                                                               
ADVSET10 DS    0H                                                               
*                                                                               
         CLI   0(R6),RSETDCDQ      IF DESCRIPTION ELEMENT                       
         BNE   ADVSET20                                                         
*                                                                               
         USING RSETDESD,R6            ESTABLISH DESCRIPTIVE ELEMENT             
*                                                                               
         IC    RF,RSETDELN            GET ELEMENT LENGTH                        
         BCTR  RF,0                   DECREMENT FOR EXECUTE                     
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   ADVTSDSC(0),RSETDESD   SAVE SET DESCRIPTION ELEMENT              
*                                                                               
ADVSET20 DS    0H                                                               
*                                                                               
         CLI   0(R6),RSETMCDQ   IF MEMBERSHIP ELEMENT                           
         BNE   ADVSET30                                                         
*                                                                               
         USING RSETMEMD,R6         ESTABLISH MEMBERSHIP ELEMENT                 
*                                                                               
         IC    RF,RSETMELN         GET ELEMENT LENGTH                           
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   ADVTSMEM(0),RSETMEMD SAVE SET MEMBER ELEMENT                     
*                                                                               
ADVSET30 DS    0H                                                               
*                                                                               
ADVSETCN DS    0H                                                               
*                                                                               
         IC    RF,1(R6)            GET ELEMENT LENGTH                           
         LA    R6,0(RF,R6)         POINT TO NEXT ELEMENT                        
         B     ADVSETLP                                                         
*                                                                               
ADVSETDN DS    0H                                                               
*                                                                               
         TM    RSET1FLG-RSET1DES+ADVTS1EL,X'08' IF NOT EXCLUSION SET            
         BO    *+8                                                              
         OI    READCNTL,READCFTQ      ADV BEING FILTERED                        
*                                                                               
         DROP  R6                                                               
*                                                                               
ADVSETX  DS    0H                  END OF TABLE INITIALIZATION                  
*                                                                               
*        INITIALIZATION FOR FILLING TABLE                                       
*                                                                               
         LA    R3,ADVTTAB          POINT TO FIRST TABLE ENTRY                   
         USING ADVTENT,R3          ESTABLISH ADV ENTRY                          
*                                                                               
         XC    ADVTKEY,ADVTKEY     INIT ADV ENTRY KEY                           
*                                                                               
*        READ ALL APPLICABLE ADV RECORDS                                        
*           SAVE IN TABLE                                                       
*                                                                               
*        CHECK FOR SET RECORD                                                   
*                                                                               
         SR    R8,R8               INIT MEMBER ELEMENT POINTER                  
*                                                                               
         OC    ADVTSKEY,ADVTSKEY   SKIP IF THERE IS NO SET RECORD               
         BZ    ADVIMB                                                           
*                                                                               
         LA    R8,ADVTSMEM         POINT TO MEMBERS ELEMENT                     
         USING RSETMCDE,R8         ESTABLISH SET MEMBER ELEMENT                 
*                                                                               
         LA    R9,RSETMEMB         POINT TO FIRST MEMBER                        
*                                                                               
         SR    RF,RF                                                            
         IC    RF,RSETMELN         ELEMENT LENGTH                               
*                                                                               
         AHI   RF,-RSETMTOV        DECREMENT BY OVERHEAD LENGTH                 
         BP    *+8                                                              
         B     ADVIMB                 NO SETS IN SET - NO ADVS                  
*                                                                               
         SR    R1,R1                                                            
         ICM   R1,1,RSETMLEN       GET LENGTH OF EACH MEMBER                    
         BZ    ADVIMB                                                           
*                                                                               
         SR    RE,RE                                                            
         DR    RE,R1               NUMBER OF MEMBERS IN ELEMENT                 
         CVD   RF,DUB                                                           
*                                                                               
         XC    DMCB(24),DMCB       SORT MEMBERSHIP LIST                         
         MVC   DMCB+11(1),RSETMLEN                                              
         MVC   DMCB+15(1),RSETMLEN                                              
*                                                                               
         GOTO1 XSORT,DMCB,RSETMEMB,(RF)                                         
*                                                                               
*        CHECK FOR SET OF SETS CASE                                             
*                                                                               
         TM    RSET1FLG-RSET1DES+ADVTS1EL,X'80' TEST FOR SET OF SETS            
         BO    ADVISS                 YES                                       
*                                                                               
         ST    R8,ADVIMBA          NO - SAVE AS A(ADV MEMBERS ELEMENT)          
         ST    R9,ADVIMBMA              SAVE A(FIRST MEMBER)                    
         ZAP   ADVIMBCT,DUB        SAVE NUMBER OF MEMBERS                       
         B     ADVIMB                                                           
*                                                                               
*        WE HAVE A SET OF SETS                                                  
*                                                                               
ADVISS   DS    0H                                                               
*                                                                               
         ST    R8,ADVISSA          SAVE AS A(SET OF SETS MEMBERS ELM)           
         ST    R9,ADVISSMA         SAVE A(FIRST MEMBER)                         
         ZAP   ADVISSCT,DUB        SAVE NUMBER OF MEMBERS                       
*                                                                               
*        HANDLE SET OF SETS                                                     
*                                                                               
ADVISSLP DS    0H                                                               
*                                                                               
*        READ FIRST/NEXT SET RECORD                                             
*                                                                               
         ICM   R9,15,ADVISSMA      A(NEXT SET ID)                               
         BZ    ADVISSDN            NO SET IDS AVAILABLE                         
*                                                                               
         LA    R4,KEY              ESTABLISH KEY FOR READING SETS               
         USING RSETKEY,R4                                                       
*                                                                               
         MVC   KEY,ADVTSKEY        COPY MASTER SET KEY                          
         MVC   RSETKID,0(R9)       FILL IN MEMBER SET                           
*                                                                               
         GOTO1 HIGH                READ MEMBER SET POINTER                      
*                                                                               
         CLC   RSETKEY,KEYSAVE     SKIP IF NOT FOUND                            
         BNE   ADVISSCN                                                         
*                                                                               
         MVC   REAIO,REAIO2        READ INTO AIO2                               
         GOTO1 GETREC                                                           
         MVC   REAIO,REAIO1        RESTORE IOAREA POINTER                       
*                                                                               
*        FIND MEMBERSHIP ELEMENT                                                
*                                                                               
         L     RE,REAIO2           POINT TO FOUND RECORD                        
         LA    R1,RSETELEM-RSETKEY(RE)  POINT TO 1ST ELEMENT                    
         SR    RF,RF                                                            
*                                                                               
         CLI   0(R1),0             DONE AT END OF RECORD                        
         BE    ADVISSCN                                                         
         CLI   0(R1),RSETMCDQ      FIND MEMBER ELEMENT                          
         BE    *+16                                                             
         IC    RF,1(R1)                                                         
         LA    R1,0(RF,R1)                                                      
         B     *-24                                                             
*                                                                               
         ST    R1,ADVIMBA          SAVE A(MEMBER'S ELEMENT)                     
*                                                                               
ADVIMB   DS    0H                  HANDLE SET OF ADV'S                          
*                                                                               
         ICM   R8,15,ADVIMBA       POINT TO MEMBER ELM OF SET                   
         BZ    ADVIMB10            (DOESN'T EXIST FOR SINGLE FILTER)            
*                                                                               
         USING RSETMEMD,R8                                                      
*                                                                               
         SR    RF,RF                                                            
         IC    RF,RSETMELN         ELEMENT LENGTH                               
*                                                                               
         AHI   RF,-RSETMTOV        DECREMENT BY OVERHEAD LENGTH                 
         BP    *+8                                                              
         B     ADVIMBDN               NO ADVS IN SET                            
*                                                                               
         SR    R1,R1                                                            
         ICM   R1,1,RSETMLEN       GET LENGTH OF EACH MEMBER                    
         BZ    ADVIMBDN                                                         
*                                                                               
         SR    RE,RE                                                            
         DR    RE,R1               NUMBER OF SETS IN ELEMENT                    
         CVD   RF,DUB                                                           
         ZAP   ADVIMBCT,DUB        SAVE NUMBER OF SETS                          
*                                                                               
         LA    R9,RSETMEMB         SAVE A(CURRENT MEMBER)                       
         ST    R9,ADVIMBMA                                                      
*                                                                               
ADVIMB10 DS    0H                                                               
*                                                                               
         ICM   R9,15,ADVIMBMA      SKIP IF NO ADV AVAILABLE                     
         BZ    ADVIMBDN                                                         
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING RADVKEY,R4          ESTABLISH ADV KEY                            
*                                                                               
         MVI   RADVKTYP,RADVKTYQ   RECORD ID                                    
         MVC   RADVKREP,REREP      REP                                          
*                                                                               
         MVC   RADVKADV,0(R9)      SET ADV IN KEY                               
*                                                                               
         MVI   LKEY,27             SET KEY COMPARE LENGTH                       
*                                                                               
         GOTO1 =A(SETREP),DMCB,RADVKEY      SET CORRECT REP IN KEY              
*                                                                               
         BAS   RE,FIRSTHI          READ FIRST ADV RECORD                        
*                                                                               
ADVIMBLP DS    0H                                                               
*                                                                               
         LA    R4,KEY                                                           
         USING RADVKEY,R4          ESTABLISH ADV KEY                            
*                                                                               
         BAS   RE,KEYCOMP          SKIP IF NOT ADV KEY FOUND                    
         BNE   ADVIMBCN                                                         
*                                                                               
         LA    R3,ADVTTAB          RESET POINTER                                
         USING ADVTENT,R3          ESTABLISH ADV ENTRY                          
*                                                                               
         MVC   ADVTKEY,RADVKEY    SAVE ADV KEY                                  
*                                                                               
         GOTOR TBLREP,DMCB,ADVTKEY    REP FOR TABLE                             
*                                                                               
         MVC   RADVKREP-RADVKEY+ADVTKEY,RETBREP                                 
*                                                                               
         GOTO1 BINSRCH,ADVTBSRP,('BSPFIND',ADVTENT)  CHECK IF IN TABLE          
*                                                                               
         CLI   BSPCNTL-BSPPRMS+ADVTBSRP,BSPNF IF NOT FOUND                      
         BNE   ADVIMBCN                          ADD TO TABLE                   
*                                                                               
         BAS   RE,GETREC           READ IN RECORD                               
*                                                                               
         TM    RSET1FLG-RSET1DES+ADVTS1EL,X'08' IF EXCLUSION SET                
         BNO   *+8                                                              
         OI    ADVTKEY+27,X'80'     MARK RECORD DELETED                         
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
*                                                                               
         MVC   ADVTELM,RADVELEM    SAVE FIRST ELEMENT                           
*                                                                               
         GOTO1 BINSRCH,ADVTBSRP,('BSPADD',ADVTENT)  ADD TO TABLE                
*                                                                               
         OC    BSPAREC-BSPPRMS+ADVTBSRP,BSPAREC-BSPPRMS+ADVTBSRP                
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
*                                                                               
ADVIMBCN DS    0H                                                               
*                                                                               
         SP    ADVIMBCT,=P'1'      DECREMENT MEMBER COUNTER                     
         BNP   ADVIMBDN            NONE LEFT IN ELEMENT                         
*                                                                               
         ICM   R9,15,ADVIMBMA      UPDATE MEMBER POINTER                        
         BZ    ADVIMBDN                                                         
*                                                                               
         LA    R9,L'RADVKADV(R9)   BUMP TO NEXT MEMBER                          
         ST    R9,ADVIMBMA         UPDATE MEMBER POINTER                        
*                                                                               
         LA    R4,KEY              RE-POINT TO FOUND KEY                        
         MVC   KEY,KEYSAVE         RESTORE SOUGHT AFTER KEY                     
*                                                                               
         MVC   RADVKADV,0(R9)      SET NEXT ADV IN SET                          
*                                                                               
         BAS   RE,HIGH             READ DIRECTORY POINTER                       
*                                                                               
         B     ADVIMBLP                                                         
*                                                                               
ADVIMBDN DS    0H                                                               
*                                                                               
         XC    ADVIMBMA,ADVIMBMA   RESET MEMBER OF MEMBER SET POINTER           
         XC    ADVIMBA,ADVIMBA     RESET MEMBER SET POINTER                     
         ZAP   ADVIMBCT,=P'0'      RESET MEMBER COUNTER                         
*                                                                               
ADVISSCN DS    0H                                                               
*                                                                               
         SP    ADVISSCT,=P'1'      DECREMENT MEMBER SET COUNTER                 
         BNP   ADVISSDN                                                         
*                                                                               
         L     R9,ADVISSMA         POINT TO NEXT SET ID                         
         LA    R9,4(R9)                                                         
         ST    R9,ADVISSMA                                                      
*                                                                               
         B     ADVISSLP                                                         
*                                                                               
ADVISSDN DS    0H                                                               
*                                                                               
         XC    ADVISSMA,ADVISSMA   RESET MEMBER SET POINTER                     
         XC    ADVISSA,ADVISSA     RESET SET OF SETS ELM PTR                    
         ZAP   ADVISSCT,=P'0'      RESET SET COUNTER                            
*                                                                               
ADVDONE  DS    0H                                                               
*                                                                               
ADVX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
ADVISSA  DS    A                   A(SET OF SETS MEMBER ELM)                    
ADVISSMA DS    A                   A(CURRENT MBR OF SET OF SETS ELM)            
ADVIMBA  DS    A                   A(SET MEMBER ELEMENT)                        
ADVIMBMA DS    A                   A(CURRENT MEMBER OF MEMBER ELM)              
ADVISSCT DS    PL2                 COUNT OF SETS REMAINING                      
ADVIMBCT DS    PL2                 COUNT OF MEMBERS REMAINING                   
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - PRD'                            
***********************************************************************         
*                                                                     *         
*        INIT PRODUCT TABLE                                           *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
PRD      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
*        ESTABLISH PRODUCT TABLE                                                
*                                                                               
         SR    R3,R3               INIT PRD TABLE ENTRY POINTER                 
         XC    REPRDTA,REPRDTA     INIT A(PRD TABLE ENTRY)                      
*                                                                               
         ICM   R2,15,REPRDTBA      TABLE ADDRESS                                
         BZ    PRDX                NO TABLE AVAILABLE                           
*                                                                               
         USING PRDTTABD,R2         ESTABLISH PRD TABLE AREA                     
*                                                                               
*        INITIALIZE PRD TABLE                                                   
*                                                                               
PRDINIT  DS    0H                                                               
*                                                                               
         OC    PRDTBSRP,PRDTBSRP   SKIP IF TABLE ALREADY INITIALIZED            
         BNZ   PRDINITX                                                         
*                                                                               
         LA    RF,PRDTTAB+PRDTENTL SET TABLE START - RESERVE 1ST SPOT           
         ST    RF,BSPATAB-BSPPRMS+PRDTBSRP IN TABLE FOR BUILDING ENTRY          
*                                                                               
         LA    RF,PRDTENTL         SET ENTRY LENGTH                             
         ST    RF,BSPLENR-BSPPRMS+PRDTBSRP                                      
*                                                                               
         LA    RF,L'RPRDKEY        SET KEY LENGTH                               
         ST    RF,BSPLENK-BSPPRMS+PRDTBSRP                                      
*                                                                               
         ICM   RF,15,=AL4(PRDTMAXQ)   SET # OF AVAILABLE ENTRIES TO MAX         
         ST    RF,BSPMAX-BSPPRMS+PRDTBSRP                                       
*                                                                               
PRDINITX DS    0H                  END OF TABLE INITIALIZATION                  
*                                                                               
*        READ ALL APPLICABLE PRD RECORDS                                        
*        SAVE IN TABLE                                                          
*                                                                               
         OC    REFPRD,REFPRD       DONE IF NO PRD FILTER FOUND                  
         BZ    PRDX                                                             
*                                                                               
         SR    R8,R8               INIT MEMBER ELEMENT POINTER                  
*                                                                               
         LA    R3,PRDTTAB          POINT TO FIRST TABLE ENTRY                   
         USING PRDTENT,R3          ESTABLISH PRD ENTRY                          
*                                                                               
         XC    PRDTKEY,PRDTKEY     INIT PRD ENTRY KEY                           
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING RPRDKEY,R4          ESTABLISH PRD KEY                            
*                                                                               
         MVI   RPRDKTYP,RPRDKTYQ   RECORD ID                                    
         MVC   RPRDKADV,REFADV     ADV                                          
         MVC   RPRDKREP,REREP      REP                                          
*                                                                               
         OC    REFPRD,REFPRD       IF PRD FILTER SET                            
         BZ    *+14                                                             
         MVC   RPRDKPRD,REFPRD        USE IT                                    
         OI    REPRCNTL,REPRCFTQ      PRD BEING FILTERED                        
*                                                                               
         MVI   LKEY,27             SET KEY COMPARE LENGTH                       
*                                                                               
         TM    REPRCNTL,REPRCFTQ   PRD MUST BE FILTERED - ELSE                  
         BNO   PRDX                  TABLE FILLED AS PRD'S ENCOUNTERED          
*                                                                               
         GOTO1 =A(SETREP),DMCB,RPRDKEY  SET CORRECT FILE READ REP               
*                                                                               
         BAS   RE,FIRSTHI          READ FIRST PRD RECORD                        
*                                                                               
PRDLOOP  DS    0H                                                               
*                                                                               
         BAS   RE,KEYCOMP          SKIP IF NOT PRD KEY FOUND                    
         BNE   PRDDONE                                                          
*                                                                               
         BAS   RE,GETREC           READ IN RECORD                               
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
*                                                                               
         MVC   PRDTKEY,RPRDKEY     SAVE PRD KEY                                 
         GOTO1 =A(TBLREP),DMCB,PRDTKEY   GET REP FOR TABLE STORAGE              
         MVC   RPRDKREP-RPRDKEY+PRDTKEY,RETBREP SET TABLE REP                   
*                                                                               
         MVC   PRDTELM,RPRDELEM    SAVE FIRST & SECOND ELEMENT                  
*                                                                               
         GOTO1 BINSRCH,PRDTBSRP,('BSPADD',PRDTENT)  ADD TO TABLE                
*                                                                               
         OC    BSPAREC-BSPPRMS+PRDTBSRP,BSPAREC-BSPPRMS+PRDTBSRP                
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
*                                                                               
PRDCONT  DS    0H                                                               
*                                                                               
         OC    REFPRD,REFPRD       DONE IF FILTERING ON SPECIFIC PRD            
         BNZ   PRDDONE                                                          
*                                                                               
PRDDONE  DS    0H                                                               
*                                                                               
PRDX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - BCD'                            
***********************************************************************         
*                                                                     *         
*        INIT BUY CODE TABLE                                          *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
BCD      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
*        ESTABLISH BUY CODE TABLE                                               
*                                                                               
         SR    R3,R3               INIT BCD TABLE ENTRY POINTER                 
         XC    REBCDTA,REBCDTA     INIT A(BCD TABLE ENTRY)                      
*                                                                               
         ICM   R2,15,REBCDTBA      TABLE ADDRESS                                
         BZ    BCDX                NO TABLE AVAILABLE                           
*                                                                               
         USING BCDTTABD,R2         ESTABLISH BCD TABLE AREA                     
*                                                                               
*        INITIALIZE BCD TABLE                                                   
*                                                                               
BCDINIT  DS    0H                                                               
*                                                                               
         OC    BCDTBXLE,BCDTBXLE   SKIP IF TABLE ALREADY INITIALIZED            
         BNZ   BCDINITX                                                         
*                                                                               
         LA    RF,BCDTTAB          SET TABLE START                              
         ST    RF,BCDTSTRA                                                      
*                                                                               
         BCTR  RF,0                SET END OF TABLE AS START MINUS ONE          
         ST    RF,BCDTENDA                                                      
*                                                                               
         LA    RF,BCDTENTL         SET ENTRY LENGTH                             
         ST    RF,BCDTLEN                                                       
*                                                                               
         LA    RF,BCDTMAXQ         SET # OF AVAILABLE ENTRIES TO MAX            
         ST    RF,BCDTAVL                                                       
*                                                                               
BCDINITX DS    0H                  END OF TABLE INITIALIZATION                  
*                                                                               
*        READ ALL APPLICABLE BCD RECORDS                                        
*        SAVE IN TABLE                                                          
*                                                                               
         L     R3,BCDTENDA         POINT TO FIRST AVAILABLE SLOT IN TAB         
         LA    R3,1(R3)                                                         
         USING BCDTENT,R3          ESTABLISH GROUP ENTRY                        
*                                                                               
         XC    BCDTKEY,BCDTKEY     INIT FIRST BCD ENTRY KEY                     
*                                                                               
         ICM   R0,15,BCDTAVL       GET NUMBER OF TABLE SLOTS AVAILABLE          
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING RSPBKEY,R4          ESTABLISH BCD KEY                            
*                                                                               
         MVI   RSPBKTYP,RBCDKTYQ   RECORD ID                                    
         MVC   RSPBKREP,REREP      REP                                          
*                                                                               
         MVI   LKEY,RSPBKTCD-RSPBKEY  SET KEY COMPARE LENGTH                    
*                                                                               
         GOTO1 =A(SETREP),DMCB,RSPBKEY  SET CORRECT FILE READ REP               
*                                                                               
         BAS   RE,FIRSTHI          READ FIRST BCD RECORD                        
*                                                                               
BCDLOOP  DS    0H                                                               
*                                                                               
         BAS   RE,KEYCOMP          SKIP IF NOT BCD KEY FOUND                    
         BNE   BCDDONE                                                          
*                                                                               
         CLI   RSPBKTCD,1          IF BUY CODE KEY                              
         BNE   BCDLP03                                                          
*                                                                               
         OC    REFBCD,REFBCD       IF BUY CODE FILTER EXISTS                    
         BZ    BCDLP10                                                          
*                                                                               
         CLC   REFBCD,RSPBKCOD        KEEP IF IT MATCHES FILTER                 
         BE    BCDLP10                                                          
         B     BCDCONT                ELSE DROP                                 
*                                                                               
BCDLP03  DS    0H                                                               
*                                                                               
*        BUY TYPE CODE                                                          
*                                                                               
         OC    REFBT1,REFBT1       IF BUY TYPE 1 FILTER EXISTS                  
         BNZ   *+10                                                             
         OC    REFBT2,REFBT2       OR BUY TYPE 2 FILTER EXISTS                  
         BZ    BCDLP10                                                          
*                                                                               
         CLC   REFBT1,RSPBKCOD        KEEP IF IT MATCHES FILTER                 
         BE    BCDLP10                                                          
         CLC   REFBT2,RSPBKCOD        KEEP IF IT MATCHES FILTER                 
         BE    BCDLP10                                                          
*                                                                               
         OI    RSPBKEY+27,X'80'    ELSE MARK DELETED                            
*                                  ENSURES ENTRY IN TABLE FOR REPORT            
*                                  BUT WON'T BE USED FOR FILTERING              
*                                                                               
BCDLP10  DS    0H                                                               
*                                                                               
         MVC   BCDTKEY,RSPBKEY     SAVE BCD KEY                                 
*                                                                               
         BAS   RE,GETREC           READ IN RECORD                               
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
*                                                                               
         GOTO1 =A(TBLREP),DMCB,BCDTKEY   GET REP FOR TABLE STORAGE              
         MVC   RSPBKREP-RSPBKEY+BCDTKEY,RETBREP SET TABLE REP                   
*                                                                               
         MVC   BCDTELM,RSPBELEM    SAVE FIRST ELEMENT                           
*                                                                               
         BCT   R0,*+6              DECREMENT SPACE AVAILABLE COUNTER            
         DC    H'0'                INCREASE BUY CODE TABLE                      
*                                                                               
         LA    R3,BCDTENT+BCDTENTL  BUMP TO NEXT AVAILABLE TABLE ENTRY          
         XC    BCDTKEY,BCDTKEY      INIT NEXT ENTRY                             
*                                                                               
BCDCONT  DS    0H                                                               
*                                                                               
         LA    R4,KEY              RE-POINT TO KEY AREA                         
         BAS   RE,SEQ              READ NEXT RECORD                             
*                                                                               
         B     BCDLOOP                                                          
*                                                                               
BCDDONE  DS    0H                                                               
*                                                                               
         LTR   R3,R3               IF WE PUT ANYTHING IN TABLE                  
         BZ    BCDDONE1                                                         
*                                                                               
         BCTR  R3,0                   RESET END OF TABLE                        
         ST    R3,BCDTENDA                                                      
*                                                                               
BCDDONE1 DS    0H                                                               
*                                                                               
BCDX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - REP'                            
***********************************************************************         
*                                                                     *         
*        INIT REP TABLE                                               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
REP      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
*        ESTABLISH REP TABLE                                                    
*                                                                               
         SR    R3,R3               INIT REP TABLE ENTRY POINTER                 
         XC    REREPTA,REREPTA     INIT A(REP TABLE ENTRY)                      
*                                                                               
         ICM   R2,15,REREPTBA      TABLE ADDRESS                                
         BZ    REPX                NO TABLE AVAILABLE                           
*                                                                               
         USING REPTTABD,R2         ESTABLISH REP TABLE AREA                     
*                                                                               
*        INITIALIZE REP TABLE                                                   
*                                                                               
REPINIT  DS    0H                                                               
*                                                                               
         OC    REPTBSRP,REPTBSRP   SKIP IF TABLE ALREADY INITIALIZED            
         BNZ   REPINITX                                                         
*                                                                               
         LA    RF,REPTTAB+REPTENTL SET TABLE START - RESERVE 1ST SPOT           
         ST    RF,BSPATAB-BSPPRMS+REPTBSRP IN TABLE FOR BUILDING ENTRY          
*                                                                               
         LA    RF,REPTENTL         SET ENTRY LENGTH                             
         ST    RF,BSPLENR-BSPPRMS+REPTBSRP                                      
*                                                                               
         LA    RF,L'RREPKEY        SET KEY LENGTH                               
         ST    RF,BSPLENK-BSPPRMS+REPTBSRP                                      
*                                                                               
         ICM   RF,15,=AL4(REPTMAXQ)   SET # OF AVAILABLE ENTRIES TO MAX         
         ST    RF,BSPMAX-BSPPRMS+REPTBSRP                                       
*                                                                               
REPINITX DS    0H                                                               
*                                                                               
         XC    REPIMBMA,REPIMBMA   INIT CURRENT SET MEMBER POINTER              
         XC    REPISSMA,REPISSMA   INIT CURRENT SET OF SETS POINTER             
         ZAP   REPIMBCT,=P'0'      INIT MEMBERS COUINTER                        
         ZAP   REPISSCT,=P'0'      INIT SET OF SETS COUNTER                     
*                                                                               
*        CHECK FOR FILTERING ON SINGLE VALUE                                    
*                                                                               
REP1FLT  DS    0H                                                               
*                                                                               
         OC    REFREP,REFREP       IF FILTERING ON A SINGLE REP                 
         BZ    REP1FLTN                                                         
*                                                                               
         LA    R9,REFREP                                                        
         ST    R9,REPIMBMA         SET UP AS CURRENT SET MEMBER                 
         ZAP   REPIMBCT,=P'1'      SET HAS ONLY ONE MEMBER                      
*                                                                               
         TM    REFTYPN2,REFTREPQ   IF NEGATIVE FILTER                           
         BNO   *+8                                                              
         OI    REPSWTCH,REPSEXCQ      TREAT AS EXCLUSION SET                    
*                                                                               
         B     REPSETX                                                          
*                                                                               
REP1FLTN DS    0H                                                               
*                                                                               
*        CROSS-FILE REPORTING HAS ITS OWN PROCEDURES                            
*                                                                               
REPXFR   DS    0H                                                               
*                                                                               
         OC    REXFREP(REXFREPL),REXFREP  IF CROSS-FILE REPORTING               
         BNZ   REPSETX                IT HAS ITS OWN PROCEDURES                 
*                                                                               
*        READ REP SET RECORD                                                    
*                                                                               
REPSET   DS    0H                                                               
*                                                                               
         XC    REPTSKEY,REPTSKEY   INIT REP SET RECORD KEY                      
         XC    REPTS1EL,REPTS1EL   INIT REP SET RECORD BASIC INFO  ELM          
         XC    REPTSDSC,REPTSDSC   INIT REP SET RECORD DESCRIPTION ELM          
*                                                                               
         OC    REREPSID,REREPSID   SKIP IF NO REP SET FILTER                    
         BZ    REPSETX                                                          
*                                                                               
*        REP FOR READING SET RECORD IS THE SAME AS THAT FOR REPS                
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING RREPKEY,R4          ESTABLISH AS REP RECORD                      
*                                                                               
         MVI   RREPKTYP,RREPKTYQ   SET REP RECORD ID                            
         MVC   RREPKREP,REREP                                                   
*                                                                               
         GOTO1 =A(SETREP),DMCB,KEY    FIND FILE REP FOR REPS                    
*                                     WINDS UP IN REDMREP                       
*                                                                               
         XC    KEY,KEY                                                          
         USING RSETKEY,R4          ESTABLISH SET KEY                            
*                                                                               
         MVI   RSETKTYP,RSETKTYQ   RECORD ID                                    
         MVC   RSETKREP,REDMREP    REP                                          
         MVC   RSETKSET,=C'RE'     SET ID                                       
         MVC   RSETKID,REREPSID    SET ID                                       
*                                                                               
         BAS   RE,HIGH             READ KEY                                     
*                                                                               
         CLC   RSETKEY,KEYSAVE     MUST FIND IT                                 
         BNE   REPX                                                             
*                                                                               
         BAS   RE,GETREC           READ IN RECORD                               
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
         MVC   REPTSKEY,RSETKEY    SAVE RECORD KEY                              
*                                                                               
*        SAVE DAT FROM REP SET RECORD                                           
*                                                                               
         SR    RF,RF                                                            
         LA    R6,RSETELEM         POINT TO FIRST ELEMENT IN RECORD             
         USING RSETDESD,R6         ESTABLISH DESCRIPTIVE ELEMENT                
*                                                                               
         SR    RF,RF                                                            
*                                                                               
REPSETLP DS    0H                                                               
*                                                                               
         CLI   0(R6),0             DONE AT END OF RECORD                        
         BE    REPSETDN                                                         
*                                                                               
         CLI   0(R6),X'01'         IF BASIC INFO ELEMENT                        
         BNE   REPSET10                                                         
*                                                                               
         USING RSET1DES,R6            ESTABLISH BASIC INFO ELEMENT              
*                                                                               
         IC    RF,RSET1ELN            GET ELEMENT LENGTH                        
         BCTR  RF,0                   DECREMENT FOR EXECUTE                     
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   REPTS1EL(0),RSET1DES   SAVE SET BASIC INFO ELEMENT               
*                                                                               
         TM    RSET1FLG,X'08'      IF EXCLUSION SET                             
         BNO   *+8                                                              
         OI    REPSWTCH,REPSEXCQ      RECORD THIS FACT                          
*                                                                               
         B     REPSETCN                                                         
*                                                                               
REPSET10 DS    0H                                                               
*                                                                               
         CLI   0(R6),RSETDCDQ      IF DESCRIPTION ELEMENT                       
         BNE   REPSET20                                                         
*                                                                               
         USING RSETDESD,R6         ESTABLISH DESCRIPTIVE ELEMENT                
*                                                                               
         IC    RF,RSETDELN            GET ELEMENT LENGTH                        
         BCTR  RF,0                   DECREMENT FOR EXECUTE                     
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   REPTSDSC(0),RSETDESD   SAVE SET DESCRIPTION ELEMENT              
*                                                                               
         B     REPSETCN                                                         
*                                                                               
REPSET20 DS    0H                                                               
*                                                                               
         CLI   0(R6),RSETMCDQ      IF  MEMBER ELEMENT                           
         BNE   REPSET30                                                         
*                                                                               
         USING RSETMEMD,R6         ESTABLISH MEMBER ELEMENT                     
*                                                                               
         IC    RF,RSETMELN             GET ELEMENT LENGTH                       
         BCTR  RF,0                    DECREMENT FOR EXECUTE                    
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   REPTSMEM(0),RSETMEMD SAVE SET MEMBER ELEMENT                     
*                                                                               
REPSET30 DS    0H                                                               
*                                                                               
REPSETCN DS    0H                                                               
*                                                                               
         IC    RF,1(R6)            GET ELEMENT LENGTH                           
         LA    R6,0(RF,R6)         BUMP TO NEXT ELEMENT                         
         B     REPSETLP                                                         
*                                                                               
REPSETDN DS    0H                                                               
*                                                                               
         DROP  R6                                                               
*                                                                               
REPSETX  DS    0H                                                               
*                                                                               
*        READ ALL APPLICABLE REP RECORDS                                        
*           SAVE IN TABLE                                                       
*                                                                               
*        IF WE ARE DEALING WITH EXCLUSION SETS                                  
*        WE WILL GO THROUGH THIS CODE TWICE                                     
*              FIRST  TO LOAD TABLE WITH ALL POSSIBLE ENTRIES                   
*              SECOND TO MARK DELETED ALL ITEMS TO BE EXCLUDED                  
*        STATUS TRACKED BY STDSWTCH                                             
*                                                                               
REPREAD  DS    0H                                                               
*                                                                               
         SR    R8,R8               INIT MEMBER ELEMENT POINTER                  
         SR    R9,R9               INIT MEMBER         POINTER                  
*                                                                               
         TM    REPSWTCH,REPS2NDQ   IF NOT SECOND PASS                           
         BO    REPRD10                                                          
         TM    REPSWTCH,REPSEXCQ   AND IF EXCLUDING DATA                        
         BO    REPIMB                 SKIP PROCESSING BY SET RECORDS            
*                                     THIS WILL FORCE ADDING ALL ITEMS          
*                                     TO THE TABLE                              
*                                                                               
REPRD10  DS    0H                                                               
*                                                                               
         OC    REREPSID,REREPSID   SKIP IF NO SET ID FOUND                      
         BZ    REPIMB                                                           
*                                                                               
         OC    REPTSKEY,REPTSKEY   SKIP IF THERE IS NO SET RECORD               
         BZ    REPIMB                                                           
*                                                                               
         LA    R8,REPTSMEM         POINT TO MEMBERS ELEMENT                     
         USING RSETMCDE,R8         ESTABLISH SET MEMBER ELEMENT                 
*                                                                               
         LA    R9,RSETMEMB         POINT TO FIRST MEMBER                        
*                                                                               
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         IC    RF,RSETMELN         ELEMENT LENGTH                               
*                                                                               
         AHI   RF,-RSETMTOV        DECREMENT BY OVERHEAD LENGTH                 
         BNP   REPIMB                 NO MEMBERS IN SET - NO REPS               
*                                                                               
         SR    R1,R1                                                            
         ICM   R1,1,RSETMLEN       LENGTH OF SET MEMBER                         
         BZ    REPIMB                                                           
*                                                                               
         DR    RE,R1               NUMBER OF REPS IN ELEMENT                    
         CVD   RF,DUB                                                           
*                                                                               
         XC    DMCB(24),DMCB       SORT MEMBERSHIP LIST                         
         MVC   DMCB+11(1),RSETMLEN                                              
         MVC   DMCB+15(1),RSETMLEN                                              
*                                                                               
         GOTO1 XSORT,DMCB,RSETMEMB,(RF)                                         
*                                                                               
*        CHECK FOR SET OF SETS CASE                                             
*                                                                               
         TM    RSET1FLG-RSET1DES+REPTS1EL,X'80' TEST FOR SET OF SETS            
         BO    REPISS                 YES                                       
*                                                                               
         ST    R9,REPIMBMA         NO - SAVE A(FIRST MEMBER)                    
         ZAP   REPIMBCT,DUB        SAVE NUMBER OF MEMBERS                       
         B     REPIMB                                                           
*                                                                               
*        WE HAVE A SET OF SETS                                                  
*                                                                               
REPISS   DS    0H                                                               
*                                                                               
         ST    R9,REPISSMA         SAVE A(FIRST MEMBER)                         
         ZAP   REPISSCT,DUB        SAVE NUMBER OF MEMBERS                       
*                                                                               
*        HANDLE SET OF SETS                                                     
*                                                                               
REPISSLP DS    0H                                                               
*                                                                               
*        READ FIRST/NEXT SET RECORD                                             
*                                                                               
         ICM   R9,15,REPISSMA      A(NEXT SET ID)                               
         BZ    REPIMB              NO SET OF SETS IDS AVAILABLE                 
*                                                                               
         LA    R4,KEY              ESTABLISH KEY FOR READING SETS               
         USING RSETKEY,R4                                                       
*                                                                               
         MVC   KEY,REPTSKEY        COPY MASTER SET KEY                          
         MVC   RSETKID,0(R9)       FILL IN MEMBER SET                           
*                                                                               
         GOTO1 HIGH                READ MEMBER SET POINTER                      
*                                                                               
         CLC   RSETKEY,KEYSAVE     SKIP IF NOT FOUND                            
         BNE   REPISSCN                                                         
*                                                                               
         MVC   REAIO,REAIO2        READ INTO AIO2                               
         GOTO1 GETREC                                                           
         MVC   REAIO,REAIO1        RESTORE IOAREA POINTER                       
*                                                                               
*        FIND MEMBERSHIP ELEMENT                                                
*                                                                               
         L     RE,REAIO2           POINT TO FOUND RECORD                        
         LA    R8,RSETELEM-RSETKEY(RE)  POINT TO 1ST ELEMENT                    
         SR    RF,RF                                                            
*                                                                               
REPISS1L DS    0H                  FIND MEMBER ELEMENT                          
         CLI   0(R8),0             DONE AT END OF RECORD                        
         BE    REPISS1D                                                         
         CLI   0(R8),RSETMCDQ      FIND MEMBER ELEMENT                          
         BE    REPISS1F                                                         
REPISS1C DS    0H                                                               
         IC    RF,1(R8)                                                         
         LA    R8,0(RF,R8)                                                      
         B     REPISS1L                                                         
REPISS1D DS    0H                                                               
         B     REPISSCN                                                         
*                                                                               
REPISS1F DS    0H                                                               
*                                                                               
*        SET UP TO PROCESS MEMBERS OF THIS SET                                  
*                                                                               
         USING RSETMEMD,R8                                                      
*                                                                               
         SR    RF,RF                                                            
         IC    RF,RSETMELN         ELEMENT LENGTH                               
*                                                                               
         AHI   RF,-RSETMTOV        DECREMENT BY OVERHEAD LENGTH                 
         BNP   REPIMBDN               NO REPS IN SET                            
*                                                                               
         SR    R1,R1                                                            
         ICM   R1,1,RSETMLEN       GET LENGTH OF EACH MEMBER                    
         BZ    REPIMBDN                                                         
*                                                                               
         SR    RE,RE                                                            
         DR    RE,R1               NUMBER OF MEMBERS IN ELEMENT                 
         CVD   RF,DUB                                                           
         ZAP   REPIMBCT,DUB        SAVE NUMBER OF SETS                          
*                                                                               
         LA    R9,RSETMEMB         SAVE A(CURRENT MEMBER)                       
         ST    R9,REPIMBMA                                                      
*                                                                               
*        READ ALL APPLICABLE STANDARD RECORDS                                   
*        SAVE IN TABLE                                                          
*                                                                               
REPIMB   DS    0H                                                               
*                                                                               
         LA    R3,REPTTAB          POINT TO FIRST TABLE ENTRY                   
         USING REPTENT,R3          ESTABLISH REP ENTRY                          
*                                                                               
         XC    REPTKEY,REPTKEY     INIT REP ENTRY KEY                           
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING RREPKEY,R4          ESTABLISH REP KEY                            
*                                                                               
         MVI   RREPKTYP,RREPKTYQ   RECORD ID                                    
         MVC   RREPKREP,REREP      START WITH REQUESTING REP                    
         MVI   LKEY,27             SET KEY COMPARE LGTH FOR EXACT MATCH         
*                                                                               
         TM    REPSWTCH,REPS2NDQ  IF NOT SECOND PASS                            
         BO    *+12                                                             
         TM    REPSWTCH,REPSEXCQ  SKIP IF EXCLUSION CASE                        
         BO    REPKMEMX                                                         
*                                                                               
         ICM   R9,15,REPIMBMA      POINT TO REP IN SET                          
         BZ    *+10                   NONE AVAILABLE                            
         MVC   RREPKREP,0(R9)      REP - SET TO CURRENT REP IN SET              
*                                                                               
REPKMEMX DS    0H                                                               
*                                                                               
         OC    REXFREP(REXFREPL),REXFREP IF CROSS-FILE REPORTING                
         BZ    *+8                                                              
         BRAS  RE,REPXFHI          FIND FIRST CROSS-FILE REP                    
*                                                                               
         BAS   RE,FIRSTHI          READ FIRST REP RECORD                        
*                                                                               
REPIMBLP DS    0H                                                               
*                                                                               
REPLOOP  DS    0H                                                               
*                                                                               
         BAS   RE,KEYCOMP          DONE IF REP KEY NOT FOUND                    
         BNE   REPDONE                                                          
*                                                                               
         GOTO1 BINSRCH,REPTBSRP,('BSPFIND',KEY)   FIND IN TABLE                 
*                                                                               
         CLI   BSPCNTL-BSPPRMS+REPTBSRP,BSPNF IF NOT FOUND                      
         BE    REPLP10                           ADD TO TABLE                   
*                                                                               
         TM    REPSWTCH,REPS2NDQ   IF SECOND PASS                               
         BNO   *+12                                                             
         L     RF,BSPAREC-BSPPRMS+REPTBSRP  POINT TO ENTRY                      
         OI    27(RF),X'80'           MARK ENTRY IN TABLE DELETED               
*                                                                               
         B     REPCONT             DO NOT ADD TO TABLE                          
*                                                                               
REPLP10  DS    0H                                                               
*                                                                               
         TM    REPSWTCH,REPS2NDQ   IF SECOND PASS                               
         BO    REPCONT                DON'T ADD TO TABLE                        
*                                                                               
         BAS   RE,GETREC           READ IN RECORD                               
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
*                                                                               
         MVC   REPTKEY,RREPKEY     SAVE REP KEY                                 
         MVC   REPTELM,RREPELEM    SAVE FIRST ELEMENT                           
         MVC   REPTGRP,REPXFGRP    SET SPECIAL GROUP CODE                       
*                                                                               
         ICM   RF,15,REUTLA        POINT TO UTL                                 
         BZ    *+10                SKIP IF NOT AVAILABLE                        
         MVC   REPTSE,4(RF)        SAVE SE NUMBER                               
*                                                                               
         GOTO1 BINSRCH,REPTBSRP,('BSPADD',REPTENT)  ADD TO TABLE                
*                                                                               
         OC    BSPAREC-BSPPRMS+REPTBSRP,BSPAREC-BSPPRMS+REPTBSRP                
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
*                                                                               
*        ADD MASTER REP IF WE HAVE SUBSIDARY REP                                
*                                                                               
         CLC   REREP,=C'NU'        IF REP NU                                    
         BNE   *+14                                                             
         MVC   REMREP,=C'K3'          ASSUME K3 IS MASTER REP                   
         B     REPMREPX                                                         
*                                                                               
         OC    RREPMAST,RREPMAST   SKIP IF NO MASTER REP                        
         BZ    REPMREPX                                                         
         CLC   RREPMAST,RESPACES                                                
         BE    REPMREPX                                                         
*                                                                               
         CLC   RREPMAST,=2X'FF'    SPECIAL IF THIS IS MASTER REP                
         BE    REPMREP                                                          
*                                                                               
         MVC   REMREP,RREPMAST     SAVE MASTER REP FOR REQUESTING REP           
*                                                                               
*        ADD MASTER REP FOR THIS REP                                            
*                                                                               
         MVC   REPKEYSV,KEY        SAVE CURRENT KEY                             
*                                                                               
         XC    KEY,KEY                                                          
*                                                                               
         MVI   RREPKTYP-RREPKEY+KEY,RREPKTYQ   RECORD ID                        
         MVC   RREPKREP-RREPKEY+KEY,RREPMAST   MASTER REP                       
*                                                                               
         GOTO1 BINSRCH,REPTBSRP,('BSPFIND',KEY)   FIND IN TABLE                 
*                                                                               
         CLI   BSPCNTL-BSPPRMS+REPTBSRP,BSPNF IF NOT FOUND                      
         BE    *+14                              ADD TO TABLE                   
         MVC   KEY,REPKEYSV           FIRST RESTORE CURRENT REP KEY             
         B     REPMREPX               THEN ALL DONE                             
*                                                                               
         MVI   LKEY,27             SET KEY COMPARE LENGTH                       
*                                                                               
         BAS   RE,FIRSTHI          READ MASTER REP RECORD                       
*                                                                               
         BAS   RE,KEYCOMP          SKIP IF MASTER REP KEY NOT FOUND             
         BNE   REPSMRP9                                                         
*                                                                               
         MVC   REAIO,REAIO2        USE SECOND IOAREA                            
         BAS   RE,GETREC           READ IN RECORD                               
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
*                                                                               
         MVC   REPTKEY,RREPKEY     SAVE REP KEY                                 
         MVC   REPTELM,RREPELEM    SAVE FIRST ELEMENT                           
*                                                                               
         GOTO1 BINSRCH,REPTBSRP,('BSPADD',REPTENT)  ADD TO TABLE                
*                                                                               
         OC    BSPAREC-BSPPRMS+REPTBSRP,BSPAREC-BSPPRMS+REPTBSRP                
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
*                                                                               
REPSMRP9 DS    0H                                                               
*                                                                               
         MVC   REAIO,REAIO1        RESET A(IOAREA)                              
         L     R4,REAIO            RESTORE RECORD POINTER                       
*                                                                               
         MVC   KEY,REPKEYSV                                                     
         BRAS  RE,HIGH             RESTORE FILE POINTER                         
*                                                                               
REPSMRPX DS    0H                                                               
*                                                                               
         B     REPMREPX                                                         
*                                                                               
REPMREP  DS    0H                                                               
*                                                                               
*        ADD ALL SUBSIDIARY REPS FOR A MASTER REP                               
*                                                                               
REPSREP  DS    0H                                                               
*                                                                               
         MVC   REPKEYSV,KEY        SAVE CURRENT KEY                             
*                                                                               
         LR    R6,R4               POINT TO CURRENT REP RECORD                  
         LA    R6,34(R4)           POINT TO FIRST ELEMENT                       
         USING RREPSUB,R6          ESTABLISH AS SUBSIDIARY REP ELM              
         SR    RF,RF                                                            
*                                                                               
         CLI   RREPSCDE,0          DONE AT END OF RECORD                        
         BE    REPSREPD                                                         
         CLI   RREPSCDE,X'02'      SEARCH FOR SUBSIDIARY REP ELMS               
         BE    *+16                                                             
         IC    RF,RREPSLEN         ELEMENT LENGTH                               
         LA    R6,RREPSUB(RF)      BUMP TO NEXT ELEMENT                         
         B     *-24                                                             
*                                                                               
*        CALCULATE HOW MANY SUBSIDIARY REP CODES IN ELEMENT                     
*                                                                               
         SR    R0,R0               ELEMENT LENGTH                               
         IC    R0,RREPSLEN         ELEMENT LENGTH                               
         SH    R0,=Y(RREPSCOD-RREPSUB)                                          
         SRL   R0,1                NUMBER OF SUBSIDIARY REP CODES               
*                                                                               
         LTR   R0,R0               SKIP IF NO CODES IN ELEMENT                  
         BZ    REPSREPD                                                         
*                                                                               
         LA    R6,RREPSCOD         POINT TO FIRST SUBSIDIARY REP CODE           
*                                                                               
         DROP  R6                                                               
*                                                                               
         MVC   REAIO,REAIO2        USE SECOND IOAREA                            
*                                                                               
REPSREPL DS    0H                                                               
*                                                                               
         XC    KEY,KEY                                                          
*                                                                               
         MVI   RREPKTYP-RREPKEY+KEY,RREPKTYQ   RECORD ID                        
         MVC   RREPKREP-RREPKEY+KEY,0(R6)      SUBSIDIARY REP                   
*                                                                               
         GOTO1 BINSRCH,REPTBSRP,('BSPFIND',KEY)   FIND IN TABLE                 
*                                                                               
         CLI   BSPCNTL-BSPPRMS+REPTBSRP,BSPNF OK IF FOUND                       
         BNE   REPSREPC                                                         
*                                                                               
         BAS   RE,FIRSTHI          READ SUB REP RECORD                          
*                                                                               
         BAS   RE,KEYCOMP          SKIP IF SUB REP KEY NOT FOUND                
         BNE   REPSREPC                                                         
*                                                                               
         BAS   RE,GETREC           READ IN RECORD                               
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
*                                                                               
         MVC   REPTKEY,RREPKEY     SAVE REP KEY                                 
         MVC   REPTELM,RREPELEM    SAVE FIRST ELEMENT                           
*                                                                               
         GOTO1 BINSRCH,REPTBSRP,('BSPADD',REPTENT)  ADD TO TABLE                
*                                                                               
         OC    BSPAREC-BSPPRMS+REPTBSRP,BSPAREC-BSPPRMS+REPTBSRP                
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
*                                                                               
REPSREPC DS    0H                                                               
*                                                                               
         LA    R6,L'RREPSCOD(R6)   BUMP TO NEXT REP CODE                        
         BCT   R0,REPSREPL                                                      
*                                                                               
REPSREPD DS    0H                                                               
*                                                                               
         MVC   REAIO,REAIO1        RESET A(IOAREA)                              
         L     R4,REAIO            RESTORE RECORD POINTER                       
*                                                                               
         MVC   KEY,REPKEYSV                                                     
         BRAS  RE,HIGH             RESTORE FILE POINTER                         
*                                                                               
REPSREPX DS    0H                                                               
*                                                                               
         B     REPMREPX                                                         
*                                                                               
REPMREPX DS    0H                                                               
*                                                                               
REPCONT  DS    0H                                                               
*                                                                               
         BAS   RE,SEQ                                                           
         B     REPLOOP                                                          
*                                                                               
REPDONE  DS    0H                                                               
*                                                                               
REPIMBCN DS    0H                                                               
*                                                                               
         OC    REXFREP(REXFREPL),REXFREP IF CROSS-FILE REPORTING                
         BZ    REPIMBC1                                                         
*                                                                               
         BRAS  RE,REPXFSEQ         FIND NEXT CROSS-FILE REP                     
*                                                                               
         ICM   RF,15,REPXFRPA      POINT TO CURRENT REP                         
         JZ    REPIMBDN               END OF LIST                               
         J     REPIMBC3                                                         
*                                                                               
REPIMBC1 DS    0H                                                               
*                                                                               
         TM    REPSWTCH,REPSEXCQ   IF EXCLUDING ITEMS                           
         BNO   REPIMBC2                                                         
*                                                                               
         TM    REPSWTCH,REPS2NDQ   AND IF NOT SECOND PASS                       
         BNO   REPIMBDN               DONE WITH FIRST PASS                      
*                                                                               
REPIMBC2 DS    0H                                                               
*                                                                               
         ICM   R9,15,REPIMBMA      IF SET MEMBER POINTER AROUND                 
         BZ    REPIMBDN                                                         
*                                                                               
         SP    REPIMBCT,=P'1'         DECREMENT MEMBER COUNTER                  
         BNP   REPIMBDN               NONE LEFT IN ELEMENT                      
*                                                                               
         LA    R4,KEY              RE-POINT TO FOUND KEY                        
         MVC   KEY,KEYSAVE         RESTORE BASIC KEY                            
*                                                                               
         LA    R9,L'RREPKREP(R9)   BUMP TO NEXT MEMBER                          
         MVC   RREPKREP,0(R9)         USE IT                                    
         ST    R9,REPIMBMA            SAVE POINTER                              
*                                                                               
REPIMBC3 DS    0H                                                               
*                                                                               
         BAS   RE,HIGH             READ DIRECTORY POINTER                       
*                                                                               
         J     REPIMBLP                                                         
*                                                                               
REPIMBDN DS    0H                                                               
*                                                                               
         ICM   RF,15,REUTLA        IF UTL ADDRESS AVAILABLE                     
         JZ    *+16                                                             
         MVC   RESE,REQSE             RESTORE STARTING SE NUMBER                
         MVC   4(1,RF),REQSE                                                    
*                                                                               
REPISSCN DS    0H                                                               
*                                                                               
         ICM   R9,15,REPISSMA      IF SET OF SETS MEMBER POINTER AROUND         
         BZ    REPISSDN                                                         
*                                                                               
         SP    REPISSCT,=P'1'         DECREMENT MEMBER COUNTER                  
         BNP   REPISSDN               NONE LEFT IN ELEMENT                      
*                                                                               
         LA    R9,L'RSETKID(R9)   BUMP TO NEXT SET OF SETS                      
         ST    R9,REPISSMA         SAVE POINTER                                 
*                                                                               
         B     REPISSLP                                                         
*                                                                               
REPISSDN DS    0H                                                               
*                                                                               
         TM    REPSWTCH,REPSEXCQ   IF EXCLUDING ITEMS                           
         BNO   REP2NDX                                                          
         TM    REPSWTCH,REPS2NDQ   AND IF NOT SECOND PASS                       
         BO    REP2NDX                                                          
         OI    REPSWTCH,REPS2NDQ      SET FOR SECOND PASS                       
         B     REPREAD                AND GO DO IT                              
*                                                                               
REP2NDX  DS    0H                                                               
*                                                                               
REPX     DS    0H                                                               
         MVI   REPSWTCH,0                                                       
         XIT1                                                                   
*                                                                               
REPIMBMA DS    A                   A(CURRENT REP TO BE ADDED)                   
REPISSMA DS    A                   A(CURRENT SET OF SETS)                       
REPIMBCT DS    PL2                 REPS IN SET COUNTER                          
REPISSCT DS    PL2                 SETS IN SET OF SETS COUNTER                  
*                                                                               
REPSWTCH DS    XL1                 REP CONTROL SWITCH                           
REPSEXCQ EQU   X'80'               EXCLUDING REPS FROM REPORT                   
REPS2NDQ EQU   X'40'               SECOND PASS BEING DONE                       
*                                                                               
REPKEYSV DS    XL(L'KEY)           KEY SAVEAREA                                 
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - REPXFHI/SEQ'                    
***********************************************************************         
*                                                                     *         
*        FIND FIRST/NEXT CROSS-FILE REP                               *         
*              ALSO SET UP TO READ THAT REP'S FILES                   *         
*                                                                     *         
*NTRY    R4==> RREPKEY                                                *         
*                                                                     *         
*EXIT    RREPKREP FILLED IN AND FILES SET TO THE REP'S FILES          *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
REPXFHI  NTR1  LABEL=*                                                          
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         USING RREPKEY,R4          ESTABLISH REP RECORD KEY                     
*                                                                               
         LA    R2,REXFREP          POINT TO FIRST REP IN LIST                   
*                                                                               
         J     REPXF10                                                          
*                                                                               
REPXFSEQ NTR1  LABEL=*             NEXT REP IN LIST ENTRY                       
*                                                                               
         ICM   R2,15,REPXFRPA      POINT TO LAST USED REP                       
         JZ    REPXFANF            NO POINTER AVAILABLE                         
*                                                                               
         LA    R2,L'REXFREP(R2)    POINT TO NEXT REP IN LIST                    
*                                                                               
REPXF10  DS    0H                                                               
*                                                                               
         XC    REPXFRPA,REPXFRPA   INIT REP POINTER                             
         MVC   REPXFGRP,REFGRP     INIT SPECIAL GROUP CODE                      
*                                                                               
         OC    0(L'REXFREP,R2),0(R2)   DONE IF END OF LIST                      
         BZ    REPXFX                                                           
*                                                                               
         ST    R2,REPXFRPA         SAVE ADDRESS                                 
*                                                                               
         MVC   RREPKREP,0(R2)      PUT REP IN KEY                               
*                                                                               
         MVC   REPXFKEY,RREPKEY    SAVE KEY                                     
*                                                                               
*        GET SYSTEM NUMBER                                                      
*                                                                               
         ICM   RF,15,REUTLA        POINT TO UTL                                 
         JZ    *+12                                                             
         IC    R0,4(RF)            SAVE CURRENT SE NUMBER                       
         MVI   4(RF),X'0A'         SET TO THE CONTROL SYSTEM                    
*                                                                               
         XC    KEY,KEY             INIT KEY AREA                                
         LA    R5,KEY              ESTABLISH CT5REC (SYSTEM ACCESS REC)         
         USING CT5REC,R5                                                        
*                                                                               
         MVI   CT5KTYP,CT5KTYPQ    RECORD ID                                    
         MVC   CT5KALPH,RREPKREP-RREPKEY+REPXFKEY  SET REP ID                   
*                                                                               
         GOTO1 DATAMGR,DMCB,=CL8'DMREAD',=CL8'CTFILE',KEY,REAIO1,0 READ         
         CLI   8(R1),0             NO ERRORS ALLOWED                            
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R5,REAIO1           POINT TO FOUND RECORD                        
*                                                                               
         LA    R6,CT5DATA          POINT TO FIRST ELEMENT IN RECORD             
         SR    RF,RF                                                            
*                                                                               
REPXFALP DS    0H                                                               
*                                                                               
         USING CTSYSD,R6           ESTABLISH SYS AUTH ELEMENT                   
*                                                                               
         CLI   CTSYSEL,0           MUST FIND AUTH ELEMENT                       
         BNE   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLI   CTSYSEL,CTSYSELQ    FIND SYSTEM AUTH ELEMENT                     
         BNE   REPXFACN                                                         
*                                                                               
         CLI   CTSYSNUM,8          MUST BE FOR REP SYSTEM                       
         BE    REPXFAFD                                                         
*                                                                               
REPXFACN DS    0H                                                               
*                                                                               
         IC    RF,CTSYSLEN         BUMP TO NEXT ELEMENT                         
         AR    R6,RF                                                            
         B     REPXFALP                                                         
*                                                                               
REPXFANF DS    0H                  ELEMENT NOT FOUND                            
*                                                                               
         MVI   REPXFSE,0           CLEAR SE NUMBER                              
         XC    REPXFRPA,REPXFRPA   CLEAR A(XFREP)                               
*                                                                               
         B     REPXFOPX                                                         
*                                                                               
REPXFAFD DS    0H                                                               
*                                                                               
         MVC   REPXFSE,CTSYSSE     SAVE REP SE NUMBER                           
*                                                                               
         CLM   R0,1,CTSYSSE        IF NEW REP SYSTEM, OPEN FILES                
         BE    REPXFOPX                                                         
*                                                                               
         ICM   RF,15,REUTLA                                                     
         MVC   4(1,RF),REPXFSE     SET REP SE NUMBER                            
*                                                                               
*        OPEN REP FILES                                                         
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMOPEN',=C'REP    ',REPFILES,DMWORK              
*                                                                               
REPXFOPX DS    0H                                                               
*                                                                               
         MVC   KEY,REPXFKEY        RESTORE REP KEY                              
         MVC   RESE,REPXFSE        SET TO THIS REP'S FILES                      
*                                                                               
         ICM   RF,15,REUTLA        POINT TO UTL                                 
         STC   R0,4(RF)            RESTORE TO CURRENT FILES                     
*                                                                               
         OC    REFGRP,REFGRP       SKIP IF NOT FILTERING ON GROUP               
         BZ    REPXFGPX                                                         
*                                                                               
*        MAKE SURE GROUP FILTER IS A SPECIAL ONE                                
*                                                                               
         LA    RF,REPXTAB          POINT TO GROUP TABLE                         
*                                                                               
         CLI   0(RF),X'FF'         END OF TABLE                                 
         BE    REPXFGPX              SKIP - GROUP FILTER NOT IN TABLE           
         CLC   REFGRP,2(RF)                                                     
         BE    *+12                                                             
         LA    RF,3(RF)            NEXT ENTRY IN TABLE                          
         B     *-22                                                             
*                                                                               
*        FIND GROUP FILTER VALUE FOR REP                                        
*                                                                               
         LA    RF,REPXTAB          POINT TO GROUP TABLE                         
*                                                                               
         CLI   0(RF),X'FF'         END OF TABLE                                 
         BE    REPXFGPX              SKIP - REP NOT IN TABLE                    
         CLC   RREPKREP-RREPKEY+REPXFKEY,0(RF)                                  
         BE    *+12                                                             
         LA    RF,3(RF)            NEXT ENTRY IN TABLE                          
         B     *-22                                                             
*                                                                               
         MVC   REPXFGRP,2(RF)      SET NEW GROUP VALUE                          
*                                                                               
REPXFGPX DS    0H                                                               
*                                                                               
REPXFX   DS    0H                                                               
         XIT1                                                                   
*                                                                               
REPFILES DC    CL8' REPDIR'        REP SYSTEM FILES TO OPEN                     
         DC    CL8' REPFIL'                                                     
         DC    CL8' ROIDIR'                                                     
         DC    CL8' ROIFIL'                                                     
         DC    CL8'X'                                                           
*                                                                               
*        TABLE OF REPS AND TV GROUP CODES                                       
*                                                                               
REPXTAB  DS    0X                                                               
         DC    C'BL',C'T'          BLAIR                                        
         DC    C'PV',C'P'          PETRY                                        
         DC    C'FN',C'F'          FOX                                          
         DC    X'FF'               EOT                                          
*                                                                               
REPXFSE  DS    XL1                 CROSS FILE REP'S SE                          
REPXFGRP DS    XL1                 CROSS FILE REP'S GROUP CODE                  
         DS    XL3                 SPARE                                        
REPXFRPA DS    A                   A(XFREP)                                     
*                                                                               
REPXFKEY DS    XL(L'KEY)           KEY SAVEAREA                                 
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - STA'                            
***********************************************************************         
*                                                                     *         
*        PUT ALL STATION RECORDS IN A TABLE                           *         
*              FILTER ON SET RECORD OR SINGLE STATION                 *         
*              TABLE IS BUILT ONLY IF SET RECORD OR SINGLE STATION    *         
*              REQUESTED                                              *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
STA      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
*        SKIP IF WE ARE DOING A MASTER REP                                      
*                                                                               
         ICM   RF,15,REREPTA       POINT TO CURRENT REP TABLE ENTRY             
         BZ    STAMSTX             SKIP IF NO REP TABLE ENTRY                   
         USING REPTENT,RF          ESTABLISH TABLE ENTRY                        
*                                                                               
         CLC   =2X'FF',RREPMAST-RREPELEM+REPTELM SKIP IF MASTER REP             
         BE    STAX                                                             
*                                                                               
         DROP  RF                                                               
*                                                                               
STAMSTX  DS    0H                                                               
*                                                                               
*        ESTABLISH STATION TABLE                                                
*                                                                               
         SR    R3,R3               INIT STATION TABLE ENTRY POINTER             
         XC    RESTATA,RESTATA     INIT A(STATION TABLE ENTRY)                  
         XC    RESJLTA,RESJLTA     INIT A(JOIN/LEAVE TABLE ENTRY)               
*                                                                               
         ICM   R2,15,RESTATBA      TABLE ADDRESS                                
         BZ    STAX                NO TABLE AVAILABLE                           
*                                                                               
         USING STATTABD,R2         ESTABLISH STATION TABLE AREA                 
*                                                                               
*        INITIALIZE STATION TABLE                                               
*                                                                               
STAINIT  DS    0H                                                               
*                                                                               
         OC    STATBSRP,STATBSRP   SKIP IF TABLE ALREADY INITIALIZED            
         BNZ   STABSRPX                                                         
*                                                                               
         LA    RF,STATTAB+STATENTL SET TABLE START - RESERVE 1ST SPOT           
         ST    RF,BSPATAB-BSPPRMS+STATBSRP IN TABLE FOR BUILDING ENTRY          
*                                                                               
         LA    RF,STATENTL         SET ENTRY LENGTH                             
         ST    RF,BSPLENR-BSPPRMS+STATBSRP                                      
*                                                                               
         LA    RF,L'RSTAKEY        SET KEY LENGTH                               
         ST    RF,BSPLENK-BSPPRMS+STATBSRP                                      
*                                                                               
         ICM   RF,15,=AL4(STATMAXQ)   SET # OF AVAILABLE ENTRIES TO MAX         
         ST    RF,BSPMAX-BSPPRMS+STATBSRP                                       
*                                                                               
STABSRPX DS    0H                                                               
*                                                                               
*        INIT WORK FIELDS                                                       
*                                                                               
         XC    STAIMBMA,STAIMBMA   INIT A(CURRENT STA CODE)                     
         XC    STAISSMA,STAISSMA   INIT A(CURRENT SET OF SET MEMBER)            
         MVI   STASWTCH,0          INIT STA CODE                                
         ZAP   STAIMBCT,=P'0'      INIT MEMBERS COUNTER                         
         ZAP   STAISSCT,=P'0'      INIT SET OF SETS COUNTER                     
*                                                                               
         OI    RESTCNTL,RESTCFTQ      STATION TABLE ALWAYS BUILT                
*                                  THUS STATION IS FILTERED                     
*                                                                               
*        CHECK FOR FILTERING ON SINGLE STA                                      
*                                                                               
STAISTA  DS    0H                                                               
*                                                                               
         OC    REFSTA,REFSTA       IF FILTERING ON SINGLE STA                   
         BZ    STAISTAN                                                         
*                                                                               
         LA    R9,REFSTA              SET AS SINGLE MEMBER OF SET               
         ST    R9,STAIMBMA                                                      
         ZAP   STAIMBCT,=P'1'                                                   
*                                                                               
         TM    REFTYPN2,REFTSTAQ   IF NEGATIVE FILTER                           
         BNO   *+8                                                              
         OI    STASWTCH,STASEXCQ      TREAT AS EXCLUSION SET                    
*                                                                               
         B     STASETX                                                          
*                                                                               
STAISTAN DS    0H                                                               
*                                                                               
*        READ STATION SET RECORD                                                
*                                                                               
STASET   DS    0H                                                               
*                                                                               
         XC    STATSKEY,STATSKEY   INIT STATION SET RECORD KEY                  
         XC    STATS1EL,STATS1EL   INIT STA SET RECORD BASIC INFO  ELM          
         XC    STATSDSC,STATSDSC   INIT STA SET RECORD DESCRIPTION ELM          
*                                                                               
         OC    RESTASID,RESTASID   SKIP IF NO STATION SET FILTER                
         BZ    STASETX                                                          
*                                                                               
*        REP FOR READING SET RECORD IS THE SAME AS THAT FOR STATIONS            
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING RSTAKEY,R4          ESTABLISH AS STATION RECORD                  
*                                                                               
         MVI   RSTAKTYP,RSTAKTYQ   SET STATION RECORD ID                        
         MVC   RSTAKREP,REREP                                                   
*                                                                               
         GOTOR SETREP,DMCB,KEY     FIND FILE REP FOR STATIONS                   
*                                     WINDS UP IN REDMREP                       
*                                                                               
         XC    KEY,KEY                                                          
         USING RSETKEY,R4          ESTABLISH SET KEY                            
*                                                                               
         MVI   RSETKTYP,RSETKTYQ   RECORD ID                                    
         MVC   RSETKREP,REDMREP    REP                                          
*                                                                               
         CLC   REMREP,SPACES       IF MASTER REP EXISTS                         
         BNH   STASTRPX                                                         
         CLC   REMREP,REQREP       IF REPORT REQUESTED BY MASTER REP            
         BNE   *+10                                                             
         MVC   RSETKREP,REMREP        USE IT FOR SETS                           
*                                                                               
STASTRPX DS    0H                                                               
*                                                                               
         MVC   RSETKSET,=C'ST'     SET ID                                       
         MVC   RSETKID,RESTASID    SET ID                                       
*                                                                               
         GOTO1 =A(SETREP),DMCB,RSETKEY SET CORRECT REP                          
*                                                                               
         BAS   RE,HIGH             READ KEY                                     
*                                                                               
         CLC   RSETKEY,KEYSAVE     MUST FIND IT                                 
         BNE   STAX                                                             
*                                                                               
         BAS   RE,GETREC           READ IN RECORD                               
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
         MVC   STATSKEY,RSETKEY    SAVE RECORD KEY                              
*                                                                               
*        SAVE SET DECRIPTION ELEMENT                                            
*                                                                               
         SR    RF,RF                                                            
         LA    R6,RSETELEM         POINT TO FIRST ELEMENT IN RECORD             
         USING RSETDESD,R6         ESTABLISH DESCRIPTIVE ELEMENT                
*                                                                               
         SR    RF,RF                                                            
*                                                                               
STASETLP DS    0H                                                               
*                                                                               
         CLI   0(R6),0             DONE AT END OF RECORD                        
         BE    STASETDN                                                         
*                                                                               
         CLI   0(R6),X'01'         IF BASIC INFO ELEMENT                        
         BNE   STASET10                                                         
*                                                                               
         USING RSET1DES,R6            ESTABLISH BASIC INFO ELEMENT              
*                                                                               
         IC    RF,RSET1ELN            GET ELEMENT LENGTH                        
         BCTR  RF,0                   DECREMENT FOR EXECUTE                     
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   STATS1EL(0),RSET1DES   SAVE SET BASIC INFO ELEMENT               
*                                                                               
         TM    RSET1FLG,X'08'      IF EXCLUSION SET                             
         BNO   *+8                                                              
         OI    STASWTCH,STASEXCQ      RECORD THIS FACT                          
*                                                                               
         B     STASETCN                                                         
*                                                                               
STASET10 DS    0H                                                               
*                                                                               
         CLI   0(R6),RSETDCDQ      IF DESCRIPTION ELEMENT                       
         BNE   STASET20                                                         
*                                                                               
         USING RSETDESD,R6         ESTABLISH DESCRIPTIVE ELEMENT                
*                                                                               
         IC    RF,RSETDELN            GET ELEMENT LENGTH                        
         BCTR  RF,0                   DECREMENT FOR EXECUTE                     
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   STATSDSC(0),RSETDESD   SAVE SET DESCRIPTION ELEMENT              
*                                                                               
         B     STASETCN                                                         
*                                                                               
STASET20 DS    0H                                                               
*                                                                               
         CLI   0(R6),RSETMCDQ      IF  MEMBER ELEMENT                           
         BNE   STASET30                                                         
*                                                                               
         USING RSETMEMD,R6         ESTABLISH MEMBER ELEMENT                     
*                                                                               
         IC    RF,RSETMELN             GET ELEMENT LENGTH                       
         BCTR  RF,0                    DECREMENT FOR EXECUTE                    
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   STATSMEM(0),RSETMEMD SAVE SET MEMBER ELEMENT                     
*                                                                               
STASET30 DS    0H                                                               
*                                                                               
STASETCN DS    0H                                                               
*                                                                               
         IC    RF,1(R6)            GET ELEMENT LENGTH                           
         LA    R6,0(RF,R6)         BUMP TO NEXT ELEMENT                         
         B     STASETLP                                                         
*                                                                               
STASETDN DS    0H                                                               
*                                                                               
         DROP  R6                                                               
*                                                                               
STASETX  DS    0H                                                               
*                                                                               
*        IF WE ARE DEALING WITH EXCLUSION SETS                                  
*        WE WILL GO THROUGH THIS CODE TWICE                                     
*              FIRST  TO LOAD TABLE WITH ALL POSSIBLE ENTRIES                   
*              SECOND TO MARK DELETED ALL ITEMS TO BE EXCLUDED                  
*        STATUS TRACKED BY STDSWTCH                                             
*                                                                               
STAREAD  DS    0H                                                               
*                                                                               
         SR    R8,R8               INIT MEMBER ELEMENT POINTER                  
         SR    R9,R9               INIT MEMBER         POINTER                  
*                                                                               
         TM    STASWTCH,STAS2NDQ   IF NOT SECOND PASS                           
         BO    STARD10                                                          
         TM    STASWTCH,STASEXCQ   AND IF EXCLUDING DATA                        
         BO    STAIMB                 SKIP PROCESSING BY SET RECORDS            
*                                     THIS WILL FORCE ADDING ALL ITEMS          
*                                     TO THE TABLE                              
*                                                                               
STARD10  DS    0H                                                               
*                                                                               
         OC    RESTASID,RESTASID   SKIP IF NO SET ID FOUND                      
         BZ    STAIMB                                                           
*                                                                               
         OC    STATSKEY,STATSKEY   SKIP IF THERE IS NO SET RECORD               
         BZ    STAIMB                                                           
*                                                                               
         LA    R8,STATSMEM         POINT TO MEMBERS ELEMENT                     
         USING RSETMCDE,R8         ESTABLISH SET MEMBER ELEMENT                 
*                                                                               
         LA    R9,RSETMEMB         POINT TO FIRST MEMBER                        
*                                                                               
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         IC    RF,RSETMELN         ELEMENT LENGTH                               
*                                                                               
         AHI   RF,-RSETMTOV        DECREMENT BY OVERHEAD LENGTH                 
         BNP   STAIMB                 NO MEMBERS IN SET - NO STAS               
*                                                                               
         SR    R1,R1                                                            
         ICM   R1,1,RSETMLEN       LENGTH OF SET MEMBER                         
         BZ    STAIMB                                                           
*                                                                               
         DR    RE,R1               NUMBER OF REPS IN ELEMENT                    
         CVD   RF,DUB                                                           
*                                                                               
         XC    DMCB(24),DMCB       SORT MEMBERSHIP LIST                         
         MVC   DMCB+11(1),RSETMLEN                                              
         MVC   DMCB+15(1),RSETMLEN                                              
*                                                                               
         GOTO1 XSORT,DMCB,RSETMEMB,(RF)                                         
*                                                                               
*        CHECK FOR SET OF SETS CASE                                             
*                                                                               
         TM    RSET1FLG-RSET1DES+STATS1EL,X'80' TEST FOR SET OF SETS            
         BO    STAISS                 YES                                       
*                                                                               
         ST    R9,STAIMBMA         NO - SAVE A(FIRST MEMBER)                    
         ZAP   STAIMBCT,DUB        SAVE NUMBER OF MEMBERS                       
         B     STAIMB                                                           
*                                                                               
*        WE HAVE A SET OF SETS                                                  
*                                                                               
STAISS   DS    0H                                                               
*                                                                               
         ST    R9,STAISSMA         SAVE A(FIRST MEMBER)                         
         ZAP   STAISSCT,DUB        SAVE NUMBER OF MEMBERS                       
*                                                                               
*        HANDLE SET OF SETS                                                     
*                                                                               
STAISSLP DS    0H                                                               
*                                                                               
*        READ FIRST/NEXT SET RECORD                                             
*                                                                               
         ICM   R9,15,STAISSMA      A(NEXT SET ID)                               
         BZ    STAIMB              NO SET OF SETS IDS AVAILABLE                 
*                                                                               
         LA    R4,KEY              ESTABLISH KEY FOR READING SETS               
         USING RSETKEY,R4                                                       
*                                                                               
         MVC   KEY,STATSKEY        COPY MASTER SET KEY                          
         MVC   RSETKID,0(R9)       FILL IN MEMBER SET                           
*                                                                               
         GOTO1 HIGH                READ MEMBER SET POINTER                      
*                                                                               
         CLC   RSETKEY,KEYSAVE     SKIP IF NOT FOUND                            
         BNE   STAISSCN                                                         
*                                                                               
         MVC   REAIO,REAIO2        READ INTO AIO2                               
         GOTO1 GETREC                                                           
         MVC   REAIO,REAIO1        RESTORE IOAREA POINTER                       
*                                                                               
*        FIND MEMBERSHIP ELEMENT                                                
*                                                                               
         MVI   ELCODE,RSETMCDQ     FIND MEMBER ELEMENT                          
         L     R6,REAIO2           START OF RECORD                              
         BRAS  RE,GETEL                                                         
         BNE   STAISSCN            ELEMENT NOT FOUND                            
*                                                                               
*        SET UP TO PROCESS MEMBERS OF THIS SET                                  
*                                                                               
         LR    R8,R6               COPY ELEMENT POINTER                         
         USING RSETMEMD,R8                                                      
*                                                                               
         SR    RF,RF                                                            
         IC    RF,RSETMELN         ELEMENT LENGTH                               
*                                                                               
         AHI   RF,-RSETMTOV        DECREMENT BY OVERHEAD LENGTH                 
         BNP   STAIMBDN               NO STAS IN SET                            
*                                                                               
         SR    R1,R1                                                            
         ICM   R1,1,RSETMLEN       GET LENGTH OF EACH MEMBER                    
         BZ    STAIMBDN                                                         
*                                                                               
         SR    RE,RE                                                            
         DR    RE,R1               NUMBER OF MEMBERS IN ELEMENT                 
         CVD   RF,DUB                                                           
         ZAP   STAIMBCT,DUB        SAVE NUMBER OF SETS                          
*                                                                               
         LA    R9,RSETMEMB         SAVE A(CURRENT MEMBER)                       
         ST    R9,STAIMBMA                                                      
*                                                                               
*        READ ALL APPLICABLE STATION RECORDS                                    
*        SAVE IN TABLE                                                          
*                                                                               
STAIMB   DS    0H                                                               
*                                                                               
         LA    R3,STATTAB          POINT TO FIRST AVAILABLE SLOT IN TAB         
         USING STATENT,R3          ESTABLISH STATION ENTRY                      
*                                                                               
         XC    STATKEY,STATKEY     INIT FIRST STATION ENTRY KEY                 
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING RSTAKEY,R4          ESTABLISH STATION KEY                        
*                                                                               
         MVI   RSTAKTYP,RSTAKTYQ   RECORD ID                                    
         MVC   RSTAKREP,REREP      REP - NOTE CURRENT REP HERE                  
         MVI   LKEY,RSTAKSTA-RSTAKEY   SET BASE KEY COMPARE LENGTH              
*                                                                               
         TM    STASWTCH,STAS2NDQ  IF NOT SECOND PASS                            
         BO    *+12                                                             
         TM    STASWTCH,STASEXCQ  SKIP IF EXCLUSION CASE                        
         BO    STAKMEMX                                                         
*                                                                               
         ICM   R9,15,STAIMBMA      POINT TO STA IN SET                          
         BZ    STAKMEMX               NONE AVAILABLE                            
*                                                                               
         MVC   RSTAKSTA,0(R9)      STA - SET TO CURRENT STA IN SET              
         MVI   LKEY,L'RSTAKEY      SET FOR EXACT MATCH                          
*                                                                               
STAKMEMX DS    0H                                                               
*                                                                               
         BAS   RE,FIRSTHI          READ FIRST STATION RECORD                    
*                                                                               
STAIMBLP DS    0H                                                               
*                                                                               
STALOOP  DS    0H                                                               
*                                                                               
         LA    R4,KEY              RE-POINT TO FOUND KEY                        
*                                                                               
         BAS   RE,KEYCOMP          DONE IF NON STATION KEY FOUND                
         BNE   STADONE                                                          
*                                                                               
         GOTO1 BINSRCH,STATBSRP,('BSPFIND',KEY)   FIND IN TABLE                 
*                                                                               
         CLI   BSPCNTL-BSPPRMS+STATBSRP,BSPNF IF NOT FOUND                      
         BE    STALP10                           ADD TO TABLE                   
*                                                                               
         TM    STASWTCH,STAS2NDQ   IF SECOND PASS                               
         BNO   *+12                                                             
         L     RF,BSPAREC-BSPPRMS+STATBSRP  POINT TO ENTRY                      
         OI    27(RF),X'80'           MARK ENTRY IN TABLE DELETED               
*                                                                               
         B     STALP20             DO NOT ADD TO TABLE                          
*                                                                               
STALP10  DS    0H                                                               
*                                                                               
         MVC   STATKEY,RSTAKEY     SAVE STATION KEY                             
*                                                                               
         GOTO1 BINSRCH,STATBSRP,('BSPADD',STATENT)  ADD TO TABLE                
*                                                                               
         OC    BSPAREC-BSPPRMS+STATBSRP,BSPAREC-BSPPRMS+STATBSRP                
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
*                                                                               
*        ADD ALL STATIONS THAT MAKE UP A COMBO                                  
*                                                                               
STALP20  DS    0H                                                               
*                                                                               
         CLI   RSTAKSTA+4,C'C'     SKIP IF NOT A COMBO STATION                  
         BNE   STACMBX                                                          
*                                                                               
         MVC   STAAIO,REAIO        SAVE CURRENT I/O AREA POINTER                
         MVC   REAIO,REAIO3        USE I/O AREA 3                               
         MVC   STAKEY,KEY          SAVE CURRENT KEY                             
         BAS   RE,GETREC           READ IN STATION RECORD                       
         MVC   REAIO,STAAIO        RESTORE I/O AREA POINTER                     
*                                                                               
         L     R4,REAIO3           POINT TO FOUND RECORD                        
*                                                                               
         LA    R6,RSTAELEM         POINT TO FIRST ELEMENT IN REC                
         USING RSTACSEL,R6         ESTABLISH AS COMBO ELEMENT                   
         SR    RF,RF                                                            
*                                                                               
         LA    R4,KEY              POINT TO CURRENT KEY                         
*                                                                               
STACMBLP DS    0H                                                               
*                                                                               
         CLI   RSTACSEL,0          DONE AT END OF RECORD                        
         BE    STACMBDN                                                         
*                                                                               
         CLI   RSTACSEL,X'0A'      LOOKING FOR COMBO ELEMENT                    
         BNE   STACMBCN                                                         
*                                                                               
         MVC   RSTAKSTA,RSTACS     COPY COMBINED STATION                        
*                                                                               
         BAS   RE,HIGH             READ DIRECTORY                               
*                                                                               
         CLC   RSTAKEY,KEYSAVE     MUST FIND KEY                                
         BNE   STACMBCN                                                         
*                                                                               
         MVC   STATKEY,KEY         MOVE KEY TO WORKAREA                         
*                                                                               
         GOTO1 BINSRCH,STATBSRP,('BSPFIND',KEY)   FIND IN TABLE                 
*                                                                               
         CLI   BSPCNTL-BSPPRMS+STATBSRP,BSPNF IF NOT FOUND                      
         BE    STACMBL1                          ADD TO TABLE                   
*                                                                               
         TM    STASWTCH,STAS2NDQ   IF SECOND PASS                               
         BNO   *+12                                                             
         L     RF,BSPAREC-BSPPRMS+STATBSRP  POINT TO ENTRY                      
         OI    27(RF),X'80'           MARK ENTRY IN TABLE DELETED               
*                                                                               
         B     STACMBL2            DO NOT ADD TO TABLE                          
*                                                                               
STACMBL1 DS    0H                                                               
*                                                                               
         GOTO1 BINSRCH,STATBSRP,('BSPADD',STATENT)  ADD STATION TO TBL          
*                                                                               
         OC    BSPAREC-BSPPRMS+STATBSRP,BSPAREC-BSPPRMS+STATBSRP                
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
*                                                                               
STACMBL2 DS    0H                                                               
*                                                                               
STACMBCN DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         IC    RF,RSTACSLN         ELEMENT LENGTH                               
         LA    R6,RSTACSEL(RF)     NEXT ELEMENT                                 
         B     STACMBLP                                                         
*                                                                               
STACMBDN DS    0H                                                               
*                                                                               
         MVC   KEY,STAKEY          RESTORE FILE POINTER                         
         BAS   RE,HIGH                                                          
*                                                                               
STACMBX  DS    0H                                                               
*                                                                               
STACONT  DS    0H                                                               
*                                                                               
         BAS   RE,SEQ              READ NEXT STATION                            
*                                                                               
         B     STALOOP                                                          
*                                                                               
STADONE  DS    0H                                                               
*                                                                               
STAIMBCN DS    0H                                                               
*                                                                               
         TM    STASWTCH,STASEXCQ   IF EXCLUDING ITEMS                           
         BNO   STAIMBC2                                                         
*                                                                               
         TM    STASWTCH,STAS2NDQ   AND IF NOT SECOND PASS                       
         BNO   STAIMBDN               DONE WITH FIRST PASS                      
*                                                                               
STAIMBC2 DS    0H                                                               
*                                                                               
         ICM   R9,15,STAIMBMA      IF SET MEMBER POINTER AROUND                 
         BZ    STAIMBDN                                                         
*                                                                               
         SP    STAIMBCT,=P'1'         DECREMENT MEMBER COUNTER                  
         BNP   STAIMBDN               NONE LEFT IN ELEMENT                      
*                                                                               
         LA    R4,KEY              RE-POINT TO FOUND KEY                        
         MVC   KEY,KEYSAVE         RESTORE BASIC KEY                            
*                                                                               
         LA    R9,L'RSTAKSTA(R9)   BUMP TO NEXT MEMBER                          
         MVC   RSTAKSTA,0(R9)         USE IT                                    
         ST    R9,STAIMBMA            SAVE POINTER                              
*                                                                               
STAIMBC3 DS    0H                                                               
*                                                                               
         BAS   RE,HIGH             READ DIRECTORY POINTER                       
*                                                                               
         J     STAIMBLP                                                         
*                                                                               
STAIMBDN DS    0H                                                               
*                                                                               
STAISSCN DS    0H                                                               
*                                                                               
         ICM   R9,15,STAISSMA      IF SET OF SETS MEMBER POINTER AROUND         
         BZ    STAISSDN                                                         
*                                                                               
         SP    STAISSCT,=P'1'         DECREMENT MEMBER COUNTER                  
         BNP   STAISSDN               NONE LEFT IN ELEMENT                      
*                                                                               
         LA    R9,L'RSETKID(R9)   BUMP TO NEXT SET OF SETS                      
         ST    R9,STAISSMA         SAVE POINTER                                 
*                                                                               
         B     STAISSLP                                                         
*                                                                               
STAISSDN DS    0H                                                               
*                                                                               
         TM    STASWTCH,STASEXCQ   IF EXCLUDING ITEMS                           
         BNO   STA2NDX                                                          
         TM    STASWTCH,STAS2NDQ   AND IF NOT SECOND PASS                       
         BO    STA2NDX                                                          
         OI    STASWTCH,STAS2NDQ      SET FOR SECOND PASS                       
         B     STAREAD                AND GO DO IT                              
*                                                                               
STA2NDX  DS    0H                                                               
*                                                                               
STAX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
STAIMBMA DS    A                   A(CURRENT STA TO BE ADDED)                   
STAISSMA DS    A                   A(CURRENT SET OF SETS)                       
STAIMBCT DS    PL2                 STAS IN SET COUNTER                          
STAISSCT DS    PL2                 SETS IN SET OF SETS COUNTER                  
*                                                                               
STASWTCH DS    XL1                 STA CONTROL SWITCH                           
STASEXCQ EQU   X'80'               EXCLUDING STAS FROM STAORT                   
STAS2NDQ EQU   X'40'               SECOND PASS BEING DONE                       
*                                                                               
STAAIO   DS    A                   A(I/O AREA) SAVEAREA                         
STAKEY   DS    XL(L'KEY)           KEY SAVEAREA                                 
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - SJL'                            
***********************************************************************         
*                                                                     *         
*        INITIALIZE STATION JOIN/LEAVE DATES TABLE                    *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
SJL      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
*        ESTABLISH STATION JOIN/LEAVE TABLE                                     
*                                                                               
         SR    R3,R3               INIT STATION TABLE ENTRY POINTER             
         XC    RESJLTA,RESJLTA     INIT A(JOIN/LEAVE TABLE ENTRY)               
*                                                                               
*                                                                               
*        SKIP IF STATION JOIN/LEAVE TABLE NOT NEEDED                            
*                                                                               
         ICM   R2,15,RESJLTBA      TABLE ADDRESS                                
         BZ    SJLX                NO TABLE AVAILABLE                           
*                                                                               
         USING SJLTTABD,R2         ESTABLISH JOIN/LEAVE TABLE AREA              
*                                                                               
*        INITIALIZE JOIN/LEAVE TABLE                                            
*                                                                               
SJLTINIT DS    0H                                                               
*                                                                               
         OC    SJLTBSRP,SJLTBSRP   SKIP IF TABLE ALREADY INITIALIZED            
         BNZ   SJLTINIX                                                         
*                                                                               
         LA    RF,SJLTTAB+SJLTENTL SET TABLE START - RESERVE 1ST SPOT           
         ST    RF,BSPATAB-BSPPRMS+SJLTBSRP IN TABLE FOR BUILDING ENTRY          
*                                                                               
         LA    RF,SJLTENTL         SET ENTRY LENGTH                             
         ST    RF,BSPLENR-BSPPRMS+SJLTBSRP                                      
*                                                                               
         LA    RF,L'SJLTKEY        SET KEY LENGTH                               
         ST    RF,BSPLENK-BSPPRMS+SJLTBSRP                                      
*                                                                               
         ICM   RF,15,=AL4(SJLTMAXQ)   SET # OF AVAILABLE ENTRIES TO MAX         
         ST    RF,BSPMAX-BSPPRMS+SJLTBSRP                                       
*                                                                               
SJLTINIX DS    0H                  END OF TABLE INITIALIZATION                  
*                                                                               
SJLX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - STDGET'                         
***********************************************************************         
*                                                                     *         
*        RETRIEVE NEXT ITEM FROM A STANDARD TABLE                     *         
*                                                                     *         
*NTRY    PARM0+0   C'N' - FIND NEXT ENTRY IN TABLE                    *         
*                  C'G' - FIND ENTRY FOR DEFAULT                      *         
*        PARM0 ==> DEFAULT VALUE TO USE                               *         
*        R9 ==> STANDARD PARMS                                        *         
*                                                                     *         
*EXIT    CURRENT VALUE = X'FFFF' IF NONE FOUND                        *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
CLSGET   DS    0H                  CLASS                                        
CTGGET   DS    0H                  CATEGORY                                     
CTYGET   DS    0H                  CONTRACT/TYPE                                
DCTGET   DS    0H                  DEVELOP/TYPE                                 
DSPGET   DS    0H                  DEVELOP/PERSON                               
MKTGET   DS    0H                  MARKET                                       
OWNGET   DS    0H                  OWNER                                        
PTPGET   DS    0H                  POINT/PERSON                                 
REGGET   DS    0H                  REGION                                       
REPGET   DS    0H                  REP - NOT USED                               
SALGET   DS    0H                  SALESPERSON                                  
TEMGET   DS    0H                  DIV/TEM                                      
TERGET   DS    0H                  TERRITORY                                    
STDGET   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         USING STDPRMSD,R9                                                      
*                                                                               
         L     R8,0(R1)            POINT TO DEFAULT VALUE                       
         MVC   STDGOPT,0(R1)       SAVE OPTION                                  
*                                                                               
         MVC   STDGKEY,KEY         SAVE CURRENT KEY                             
*                                                                               
         ICM   R2,15,STDPTBA       GET STANDARD TABLE ADDRESS                   
         BZ    STDGDFLT            USE DEFAULT IF NO TABLE                      
*                                                                               
         LA    R2,RENWRIOD(R2)     RE-LOCATE ADDRESS                            
         ICM   R2,15,0(R2)         POINT TO TABLE                               
         BZ    STDGDFLT            NO TABLE                                     
*                                                                               
         USING STDTTABD,R2         ESTABLISH TABLE                              
*                                                                               
         LM    R3,R5,STDTBXLE      LOAD BXLE REGISTERS                          
         USING STDTENT,R3          ESTABLISH TABLE ENTRY                        
*                                  R3 ==> FIRST TABLE ENTRY                     
         CR    R3,R5               USE DEFAULT IF TABLE EMPTY                   
         BNL   STDGDFLT                                                         
*                                                                               
*        FIND FIRST IN TABLE FOR CURRENT REP                                    
*        USE THIS AS FIRST ENTRY IN TABLE                                       
*                                                                               
         MVC   KEY(1),STDPRID      SET RECORD TYPE                              
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,1,STDPREPD       REP DISPLACEMENT IN KEY                      
         BZ    STDGREPX            REP NOT MAJOR IN KEY                         
*                                                                               
         LA    R1,KEY(RE)          POINT TO REP IN KEY                          
         MVC   0(L'REREP,R1),REREP PUT CURRENT REP IN KEY                       
*                                                                               
         GOTO1 =A(TBLREP),DMCB,KEY    FIND TABLE REP                            
*                                                                               
         MVC   KEY,STDGKEY         RESTORE ORIGINAL KEY                         
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,1,STDPREPD       REP DISPLACEMENT IN KEY                      
*                                                                               
STDGREPL DS    0H                                                               
*                                                                               
         TM    STDTKEY+27,X'80'    SKIP IF DELETED                              
         BO    STDGREPC                                                         
*                                                                               
         LA    R1,STDTKEY(RE)      POINT TO REP IN KEY                          
*                                                                               
         CLC   RETBREP,0(R1)       FIND FIRST FOR CURRENT REP                   
         BE    STDGREPF                                                         
*                                                                               
STDGREPC DS    0H                                                               
         BXLE  R3,R4,STDGREPL                                                   
         B     STDGNFD             REP NOT IN TABLE                             
*                                                                               
STDGREPF DS    0H                                                               
*                                                                               
STDGREPX DS    0H                                                               
*                                                                               
         ST    R3,STDG1STA         A(FIRST ENTRY FOR REP)                       
*                                                                               
         OC    STDTENTA,STDTENTA   START WITH FIRST ENTRY IF FIRST TIME         
         BZ    STDGLOOP                                                         
*                                                                               
*        IF CURRENT VALUE IS NULLS, RESTART TABLE                               
*                                                                               
         L     RE,STDPCVLA         POINT TO CURRENT VALUE                       
         LA    RE,RENWRIOD(RE)     RE-LOCATE ADDRESS                            
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,STDPCVLL       CURRENT VALUE LENGTH                         
         BZ    *+6                                                              
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         OC    0(0,RE),0(RE)       RESTART    TABLE                             
         BZ    STDGLOOP                                                         
*                                                                               
         CLC   STDTENTA,=4X'FF'    IF END OF TABLE LAST TIME                    
         BE    STDGLOOP               START AT BEGINNING OF TABLE               
*                                                                               
         ICM   R3,15,STDTENTA      POINT TO LAST ENTRY USED                     
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,1,STDPREPD       REP DISPLACEMENT IN KEY                      
         BZ    *+14                REP NOT MAJOR IN KEY                         
         LA    RE,STDTKEY(RE)      POINT TO REP IN KEY                          
         CLC   RETBREP,0(RE)       COMPARE TO CURRENT REP                       
         BNE   STDGLOOP                                                         
*                                                                               
         SR    RE,RE                                                            
         IC    RE,STDPKY1D         GET DATA DISPLACEMENT IN KEY                 
         LA    RE,STDTKEY(RE)          POINT TO AREA IN KEY                     
*                                                                               
         SR    RF,RF                                                            
         IC    RF,STDPCVLL         LENGTH OF FILTER                             
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   0(0,RE),0(R8)       IF PAST DEFAULT                              
         BNH   *+8                    RE-START TABLE                            
         ICM   R3,15,STDG1STA         POINT TO FIRST ENTRY IN TABLE             
*                                                                               
STDGLOOP DS    0H                                                               
*                                                                               
         TM    STDTKEY+27,X'80'    SKIP IF DELETED                              
         BO    STDGCONT                                                         
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,1,STDPREPD       REP DISPLACEMENT IN KEY                      
         BZ    *+18                REP NOT MAJOR IN KEY                         
         LA    RE,STDTKEY(RE)      POINT TO REP IN KEY                          
         CLC   RETBREP,0(RE)       COMPARE TO CURRENT REP                       
         BNE   STDGCONT                                                         
*                                                                               
         SR    RE,RE                                                            
         IC    RE,STDPKY1D         GET DATA DISPLACEMENT IN KEY                 
         LA    RE,STDTKEY(RE)          POINT TO AREA IN KEY                     
*                                                                               
         SR    RF,RF                                                            
         IC    RF,STDPCVLL         LENGTH OF FILTER                             
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   0(0,RE),0(R8)       USE IF GREATER THAN                          
         BH    STDGFD                                                           
         BL    STDGCONT            SKIP IF LESS THAN                            
*                                                                               
         CLI   STDGOPT,C'G'        IF GET OPTION                                
         BE    STDGFD                 USE IF EQUAL                              
*                                                                               
STDGCONT DS    0H                                                               
*                                                                               
         BXLE  R3,R4,STDGLOOP      POINT TO NEXT ENTRY IN TABLE                 
*                                                                               
STDGDONE DS    0H                                                               
*                                                                               
         B     STDGNFD             END OF TABLE                                 
*                                                                               
STDGFD   DS    0H                                                               
*                                                                               
         ST    R3,STDTENTA         SET TABLE ENTRY POINTER                      
*                                                                               
         L     R1,STDPENTA                                                      
         LA    R1,RENWRIOD(R1)                                                  
         ST    R3,0(R1)            RETURN A(STANDARD TABLE ENTRY)               
*                                                                               
         L     R1,STDPCVLA         POINT TO CURRENT VALUE AREA                  
         LA    R1,RENWRIOD(R1)                                                  
*                                                                               
         SR    RE,RE                                                            
         IC    RE,STDPKY1D         GET DATA DISPLACEMENT IN KEY                 
         LA    RE,STDTKEY(RE)          POINT TO AREA IN KEY                     
*                                                                               
         SR    RF,RF                                                            
         IC    RF,STDPCVLL         LENGTH OF FILTER                             
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),0(RE)       UPDATE CURRENT VALUE                         
*                                                                               
         B     STDGOK                                                           
*                                                                               
STDGDFLT DS    0H                  DEFAULT TO STD IN CONTRACT KEY               
*                                                                               
         SR    R3,R3               INIT GROUP TABLE ENTRY POINTER               
*                                                                               
         LTR   R2,R2               IF TABLE EXISTS                              
         BZ    *+8                                                              
         ST    R3,STDTENTA         SET TABLE ENTRY POINTER                      
*                                                                               
         L     R1,STDPENTA                                                      
         LA    R1,RENWRIOD(R1)                                                  
         ST    R3,0(R1)            RETURN A(STANDARD TABLE ENTRY)               
*                                                                               
         L     R1,STDPCVLA         POINT TO CURRENT VALUE AREA                  
         LA    R1,RENWRIOD(R1)                                                  
*                                                                               
         SR    RF,RF                                                            
         IC    RF,STDPCVLL         LENGTH OF FILTER                             
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),0(R8)       USE DEFAULT                                  
*                                                                               
STDGOK   DS    0H                                                               
*                                                                               
         CR    RB,RB               SET EQ CC                                    
*                                                                               
         B     STDGETX                                                          
*                                                                               
STDGNFD  DS    0H                                                               
*                                                                               
         MVC   STDTENTA,=4X'FF'    SET TABLE ENTRY POINTER                      
*                                                                               
         L     R1,STDPENTA                                                      
         LA    R1,RENWRIOD(R1)                                                  
         MVC   0(4,R1),=4X'FF'     INDICATE END OF TABLE REACHED                
*                                                                               
         L     R1,STDPCVLA         POINT TO CURRENT VALUE AREA                  
         LA    R1,RENWRIOD(R1)                                                  
*                                                                               
         SR    RF,RF                                                            
         IC    RF,STDPCVLL         LENGTH OF FILTER                             
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),=16X'FF'    END OF TABLE REACHED                         
*                                                                               
         LTR   RB,RB               SET NEQ CC                                   
*                                                                               
STDGETX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         DS    0D                  ALIGNMENT                                    
STDGOPT  DS    CL1                 OPTION                                       
         DS    XL3                 SPARE                                        
STDG1STA DS    A                   A(FIRST ENTRY FOR REP)                       
STDGKEY  DS    XL(L'KEY)           KEY SAVEAREA                                 
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - STD'                            
***********************************************************************         
*                                                                     *         
*        PUT ALL STANDARD RECORDS IN A TABLE                          *         
*              FILTER ON SET RECORD OR SINGLE STANDARD                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
STD      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
*        FIND PARAMETERS FOR BUILDING TABLE                                     
*                                                                               
STDTAB   DS    0H                                                               
*                                                                               
         LA    R5,STDPRMS          POINT TO TABLE OF PARAMETERS                 
*                                     FOR BUILDING STANDARD TABLE               
*                                                                               
         USING STDPRMSD,R5         ESTABLISH ENTRY IN PARMS TABLE               
*                                                                               
STDTABLP DS    0H                                                               
         CLI   STDPRID,X'FF'       AT END OF TABLE                              
         BE    STDX                   EXIT                                      
         CLC   STDPRID,REREAD      FIND CORRECT ENTRY IN TABLE                  
         BE    STDTABFD                                                         
         LA    R5,STDPRMSD+STDPRMSL BUMP TO NEXT TABLE ENTRY                    
         B     STDTABLP                                                         
STDTABFD DS    0H                                                               
*                                                                               
*        ESTABLISH STANDARD TABLE                                               
*                                                                               
         ICM   R2,15,STDPTBA       TABLE ADDRESS                                
         BZ    STDX                NO TABLE AVAILABLE                           
*                                                                               
         LA    R2,RENWRIOD(R2)     RE-LOCATE ADDRESS                            
         ICM   R2,15,0(R2)         POINT TO TABLE                               
         BZ    STDX                NO TABLE                                     
*                                                                               
         USING STDTTABD,R2         ESTABLISH STANDARD TABLE AREA                
*                                                                               
*        INITIALIZE STANDARD TABLE                                              
*                                                                               
STDINIT  DS    0H                                                               
*                                                                               
         OC    STDTBXLE,STDTBXLE   SKIP IF TABLE ALREADY INITIALIZED            
         BNZ   STDINITX                                                         
*                                                                               
         LA    RF,STDTTAB          SET TABLE START                              
         ST    RF,STDTSTRA                                                      
*                                                                               
         BCTR  RF,0                SET END OF TABLE AS START MINUS ONE          
         ST    RF,STDTENDA                                                      
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,STDPENTL       SET ENTRY LENGTH                             
         ST    RF,STDTLEN                                                       
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,STDPMAX        SET # OF AVAILABLE ENTRIES TO MAX            
         ST    RF,STDTAVL                                                       
*                                                                               
*        INIT WORK FIELDS                                                       
*                                                                               
STDINITX DS    0H                                                               
*                                                                               
         XC    STDFLTR,STDFLTR     INIT SINGLE FILTER SAVEAREA                  
         XC    STDIMBMA,STDIMBMA   INIT A(CURRENT STD CODE)                     
         MVI   STDIMBML,0          INIT STD CODE LENGTH                         
         MVI   STDSWTCH,0          INIT STD SWITCH                              
         XC    STDISSMA,STDISSMA   INIT A(CURRENT SET OF SET MEMBER)            
         ZAP   STDIMBCT,=P'0'      INIT MEMBERS COUNTER                         
         ZAP   STDISSCT,=P'0'      INIT SET OF SETS COUNTER                     
*                                                                               
*        CHECK FOR FILTERING ON SINGLE VALUE                                    
*                                                                               
STD1FLT  DS    0H                                                               
*                                                                               
         ICM   R1,15,STDPFL1A      POINT TO FIRST FILTER VALUE                  
         BZ    STD1FLTN            NONE AVAILABLE                               
*                                                                               
         LA    R1,RENWRIOD(R1)     RE-LOCATE ADDRESS                            
*                                                                               
         SR    RF,RF                                                            
         IC    RF,STDPDA1L         GET LENGTH OF DATA                           
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         OC    0(0,R1),0(R1)       SKIP IF NO VALUE TO FILTER ON                
         BZ    STD1FLTN                                                         
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   STDFLTR,0(R1)       SAVE SINGLE FILTER                           
*                                                                               
         LA    RF,1(RF)            RECTIFY LENGTH                               
         STC   RF,STDIMBML         SAVE TOTAL LENGTH                            
*                                                                               
         LA    RE,STDFLTR(RF)      BUMP TO SECOND FILTER AREA                   
*                                                                               
         ICM   R1,15,STDPFL2A      POINT TO SECOND FILTER VALUE                 
         BZ    STD1FLTX               NON-AVAILABLE                             
*                                                                               
         LA    R1,RENWRIOD(R1)     RE-LOCATE ADDRESS                            
*                                                                               
         SR    RF,RF                                                            
         IC    RF,STDPDA2L         GET LENGTH OF DATA                           
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         OC    0(0,R1),0(R1)       SKIP IF NO VALUE TO FILTER ON                
         BZ    STD1FLTX                                                         
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),0(R1)       SAVE SECOND PART OF SINGLE FILTER            
*                                                                               
         LA    RF,1(RF)            RECTIFY LENGTH                               
*                                                                               
         SR    RE,RE                                                            
         IC    RE,STDIMBML         INCREMENT FILTER LENGTH                      
         AR    RF,RE                                                            
         STC   RF,STDIMBML         SAVE TOTAL LENGTH                            
*                                                                               
STD1FLTX DS    0H                  SINGLE VALUE FOR FILTERING                   
*                                      TREATED AS SET WITH SINGLE MBR           
         LA    R9,STDFLTR                                                       
         ST    R9,STDIMBMA         SET UP AS CURRENT SET MEMBER                 
         ZAP   STDIMBCT,=P'1'      SET HAS ONLY ONE MEMBER                      
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,STDPFLEQ       SKIP IF NO FILTER EQUATE GIVEN               
         BZ    STD1FLTY                                                         
*                                                                               
         SR    RE,RE                                                            
         IC    RE,STDPFLNM         GET FILTER NUMBER                            
         LA    R1,REFTYPS1-1(RE)   POINT TO FILTER SWITCHES                     
*                                                                               
         EX    RF,*+8                                                           
         B     *+8                                                              
         OI    0(R1),0             SET TO FILTER ON DATATYPE                    
*                                                                               
         LA    R1,REFTYPN1-1(RE)   POINT TO NEGATIVE FILTERS                    
         EX    RF,*+8                                                           
         B     *+8                                                              
         TM    0(R1),0             IF NEGATIVE FILTER                           
         BNO   *+8                                                              
         OI    STDSWTCH,STDSEXCQ      TREAT AS EXCLUSION SET                    
*                                                                               
STD1FLTY DS    0H                                                               
*                                                                               
         B     STDSETX                                                          
*                                                                               
STD1FLTN DS    0H                                                               
*                                                                               
*        READ STANDARD SET RECORD                                               
*                                                                               
STDSET   DS    0H                                                               
*                                                                               
         XC    STDTSKEY,STDTSKEY   INIT STD SET RECORD KEY                      
         XC    STDTS1EL,STDTS1EL   INIT STD SET RECORD BASIC INFO  ELM          
         XC    STDTSDSC,STDTSDSC   INIT STD SET RECORD DESCRIPTION ELM          
         XC    STDTSMEM,STDTSMEM   INIT STD SET RECORD MEMBER      ELM          
*                                                                               
*                                                                               
         OC    STDPSTP,STDPSTP     SKIP IF NO SET TYPE AVAILABLE                
         BZ    STDSETX                                                          
*                                                                               
         L     RF,STDPSIDA         POINT TO SET RECORD ID                       
         LA    RF,RENWRIOD(RF)                                                  
*                                                                               
         OC    0(L'RSETKSET,RF),0(RF)  SKIP IF NO SET FILTER                    
         BZ    STDSETX                                                          
*                                                                               
*      REP FOR READING SET RECORD IS THE SAME AS THAT FOR ITEMS IN SET          
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         MVC   0(1,R4),STDPRID     RECORD ID                                    
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,1,STDPREPD       REP DISPLACEMENT IN KEY                      
         BZ    *+14                REP NOT MAJOR IN KEY                         
         LA    RE,KEY(RE)          POINT TO REP IN KEY                          
         MVC   0(L'REREP,RE),REREP PLACE REP IN KEY                             
*                                                                               
         GOTOR SETREP,DMCB,KEY     FIND FILE REP FOR ITEMS IN SET               
*                                     WINDS UP IN REDMREP                       
*                                                                               
         XC    KEY,KEY                                                          
         USING RSETKEY,R4          ESTABLISH SET KEY                            
*                                                                               
         MVI   RSETKTYP,RSETKTYQ   RECORD ID                                    
         MVC   RSETKREP,REDMREP    REP                                          
         MVC   RSETKSET,STDPSTP    SET TYPE                                     
*                                                                               
         L     RF,STDPSIDA         POINT TO SET RECORD ID                       
         LA    RF,RENWRIOD(RF)                                                  
         MVC   RSETKID,0(RF)       SET ID                                       
*                                                                               
         BAS   RE,HIGH             READ KEY                                     
*                                                                               
         CLC   RSETKEY,KEYSAVE     MUST FIND IT                                 
         BNE   STDSETX                                                          
*                                                                               
         BAS   RE,GETREC           READ IN RECORD                               
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,STDPFLEQ       SKIP IF NO FILTER EQUATE GIVEN               
         BZ    STDSET03                                                         
*                                                                               
         SR    RE,RE                                                            
         IC    RE,STDPFLNM         GET FILTER NUMBER                            
         LA    R1,REFTYPS1-1(RE)   POINT TO FILTER SWITCHES                     
*                                                                               
         EX    RF,*+8                                                           
         B     *+8                                                              
         OI    0(R1),0             SET AS FILTERING ON DATATYPE                 
*                                                                               
STDSET03 DS    0H                                                               
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
         MVC   STDTSKEY,RSETKEY    SAVE RECORD KEY                              
*                                                                               
*        SAVE SET DATA FROM SET RECORD                                          
*                                                                               
         LA    R6,RSETELEM         POINT TO FIRST ELEMENT IN RECORD             
         SR    RF,RF                                                            
*                                                                               
STDSETLP DS    0H                                                               
*                                                                               
         CLI   0(R6),0             DONE AT END OF RECORD                        
         BE    STDSETDN                                                         
*                                                                               
         CLI   0(R6),X'01'         IF BASIC INFO ELEMENT                        
         BNE   STDSET10                                                         
*                                                                               
         USING RSET1DES,R6            ESTABLISH BASIC INFO ELEMENT              
*                                                                               
         IC    RF,RSET1ELN            GET ELEMENT LENGTH                        
         BCTR  RF,0                   DECREMENT FOR EXECUTE                     
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   STDTS1EL(0),RSET1DES   SAVE SET BASIC INFO ELEMENT               
*                                                                               
         TM    RSET1FLG,X'08'      IF EXCLUSION SET                             
         BNO   STDSET05                                                         
*                                                                               
*        SET FLAGS FOR EXCLUSION SETS                                           
*                                                                               
         OI    STDSWTCH,STDSEXCQ      RECORD THIS FACT                          
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,STDPFLEQ       SKIP IF NO FILTER EQUATE GIVEN               
         BZ    STDSET05                                                         
*                                                                               
         LA    R1,REFTYPN1-1(RE)   POINT TO NEGATIVE FILTER SWITCHES            
*                                                                               
         EX    RF,*+8                                                           
         B     *+8                                                              
         OI    0(R1),0             SET AS EXCLUSION FILTER                      
*                                                                               
STDSET05 DS    0H                                                               
*                                                                               
         B     STDSETCN                                                         
*                                                                               
STDSET10 DS    0H                                                               
*                                                                               
         CLI   0(R6),RSETDCDQ      IF DESCRIPTION ELEMENT                       
         BNE   STDSET20                                                         
*                                                                               
         USING RSETDESD,R6         ESTABLISH DESCRIPTIVE ELEMENT                
*                                                                               
         IC    RF,RSETDELN            GET ELEMENT LENGTH                        
         BCTR  RF,0                   DECREMENT FOR EXECUTE                     
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   STDTSDSC(0),RSETDESD   SAVE SET DESCRIPTION ELEMENT              
*                                                                               
         B     STDSETCN                                                         
*                                                                               
STDSET20 DS    0H                                                               
*                                                                               
         CLI   0(R6),RSETMCDQ      IF  MEMBER ELEMENT                           
         BNE   STDSET30                                                         
*                                                                               
         USING RSETMEMD,R6         ESTABLISH MEMBER ELEMENT                     
*                                                                               
         IC    RF,RSETMELN             GET ELEMENT LENGTH                       
         BCTR  RF,0                    DECREMENT FOR EXECUTE                    
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   STDTSMEM(0),RSETMEMD SAVE SET MEMBER ELEMENT                     
*                                                                               
STDSET30 DS    0H                                                               
*                                                                               
STDSETCN DS    0H                                                               
*                                                                               
         IC    RF,1(R6)            GET ELEMENT LENGTH                           
         LA    R6,0(RF,R6)         BUMP TO NEXT ELEMENT                         
         B     STDSETLP                                                         
*                                                                               
STDSETDN DS    0H                                                               
*                                                                               
         DROP  R6                                                               
*                                                                               
STDSETX  DS    0H                                                               
*                                                                               
*        READ ALL APPLICABLE STD RECORDS                                        
*           SAVE IN TABLE                                                       
*                                                                               
*        IF WE ARE DEALING WITH EXCLUSION SETS                                  
*        WE WILL GO THROUGH THIS CODE TWICE                                     
*              FIRST  TO LOAD TABLE WITH ALL POSSIBLE ENTRIES                   
*              SECOND TO MARK DELETED ALL ITEMS TO BE EXCLUDED                  
*        STATUS TRACKED BY STDSWTCH                                             
*                                                                               
STDREAD  DS    0H                                                               
*                                                                               
*        CHECK FOR SET RECORD                                                   
*                                                                               
         SR    R8,R8               INIT MEMBER ELEMENT POINTER                  
         SR    R9,R9               INIT MEMBER         POINTER                  
*                                                                               
         TM    STDSWTCH,STDS2NDQ   IF NOT SECOND PASS                           
         BO    STDRD10                                                          
         TM    STDSWTCH,STDSEXCQ   AND IF EXCLUDING DATA                        
         BO    STDIMB                 SKIP PROCESSING BY SET RECORDS            
*                                     THIS WILL FORCE ADDING ALL ITEMS          
*                                     TO THE TABLE                              
*                                                                               
STDRD10  DS    0H                                                               
*                                                                               
         OC    STDTSKEY,STDTSKEY   SKIP IF THERE IS NO SET RECORD               
         BZ    STDIMB                                                           
*                                                                               
         LA    R8,STDTSMEM         POINT TO MEMBERS ELEMENT                     
         USING RSETMCDE,R8         ESTABLISH SET MEMBER ELEMENT                 
*                                                                               
         LA    R9,RSETMEMB         POINT TO FIRST MEMBER                        
*                                                                               
         SR    RF,RF                                                            
         IC    RF,RSETMELN         ELEMENT LENGTH                               
*                                                                               
         AHI   RF,-RSETMTOV        DECREMENT BY OVERHEAD LENGTH                 
         BNP   STDIMB                 NO SETS IN SET                            
*                                                                               
         SR    R1,R1                                                            
         ICM   R1,1,RSETMLEN       GET LENGTH OF EACH MEMBER                    
         BZ    STDIMB                                                           
*                                                                               
         STC   R1,STDIMBML         SAVE MEMBER LENGTH                           
*                                                                               
         SR    RE,RE                                                            
         DR    RE,R1               NUMBER OF MEMBERS IN ELEMENT                 
         CVD   RF,DUB                                                           
*                                                                               
         XC    DMCB(24),DMCB       SORT MEMBERSHIP LIST                         
         MVC   DMCB+11(1),RSETMLEN                                              
         MVC   DMCB+15(1),RSETMLEN                                              
*                                                                               
         GOTO1 XSORT,DMCB,RSETMEMB,(RF)                                         
*                                                                               
*        CHECK FOR SET OF SETS CASE                                             
*                                                                               
         TM    RSET1FLG-RSET1DES+STDTS1EL,X'80' TEST FOR SET OF SETS            
         BO    STDISS                 YES                                       
*                                                                               
         ST    R9,STDIMBMA         NO - SAVE A(FIRST MEMBER)                    
         ZAP   STDIMBCT,DUB        SAVE NUMBER OF MEMBERS                       
         B     STDIMB                                                           
*                                                                               
*        WE HAVE A SET OF SETS                                                  
*                                                                               
STDISS   DS    0H                                                               
*                                                                               
         ST    R9,STDISSMA         SAVE A(FIRST MEMBER)                         
         ZAP   STDISSCT,DUB        SAVE NUMBER OF MEMBERS                       
*                                                                               
*        HANDLE SET OF SETS                                                     
*                                                                               
STDISSLP DS    0H                                                               
*                                                                               
*        READ FIRST/NEXT SET RECORD                                             
*                                                                               
         ICM   R9,15,STDISSMA      A(NEXT SET ID)                               
         BZ    STDIMB              NO SET OF SETS IDS AVAILABLE                 
*                                                                               
         LA    R4,KEY              ESTABLISH KEY FOR READING SETS               
         USING RSETKEY,R4                                                       
*                                                                               
         MVC   KEY,STDTSKEY        COPY MASTER SET KEY                          
         MVC   RSETKID,0(R9)       FILL IN MEMBER SET                           
         OC    RSETKID,SPACES      SPACE FILL                                   
*                                                                               
         GOTO1 HIGH                READ MEMBER SET POINTER                      
*                                                                               
         CLC   RSETKEY,KEYSAVE     SKIP IF NOT FOUND                            
         BNE   STDISSCN                                                         
*                                                                               
         MVC   REAIO,REAIO2        READ INTO AIO2                               
         GOTO1 GETREC                                                           
         MVC   REAIO,REAIO1        RESTORE IOAREA POINTER                       
*                                                                               
*        FIND MEMBERSHIP ELEMENT                                                
*                                                                               
         L     RE,REAIO2           POINT TO FOUND RECORD                        
         LA    R8,RSETELEM-RSETKEY(RE)  POINT TO 1ST ELEMENT                    
         SR    RF,RF                                                            
*                                                                               
STDISS1L DS    0H                  FIND MEMBER ELEMENT                          
         CLI   0(R8),0             DONE AT END OF RECORD                        
         BE    STDISS1D                                                         
         CLI   0(R8),RSETMCDQ      FIND MEMBER ELEMENT                          
         BE    STDISS1F                                                         
STDISS1C DS    0H                                                               
         IC    RF,1(R8)                                                         
         LA    R8,0(RF,R8)                                                      
         B     STDISS1L                                                         
STDISS1D DS    0H                                                               
         B     STDISSCN                                                         
*                                                                               
STDISS1F DS    0H                                                               
*                                                                               
*        SET UP TO PROCESS MEMBERS OF THIS SET                                  
*                                                                               
         USING RSETMEMD,R8                                                      
*                                                                               
         SR    RF,RF                                                            
         IC    RF,RSETMELN         ELEMENT LENGTH                               
*                                                                               
         AHI   RF,-RSETMTOV        DECREMENT BY OVERHEAD LENGTH                 
         BNP   STDIMBDN               NO STDS IN SET                            
*                                                                               
         SR    R1,R1                                                            
         ICM   R1,1,RSETMLEN       GET LENGTH OF EACH MEMBER                    
         BZ    STDIMBDN                                                         
*                                                                               
         STC   R1,STDIMBML         SAVE SET MEMBER LENGTH                       
*                                                                               
         SR    RE,RE                                                            
         DR    RE,R1               NUMBER OF MEMBERS IN ELEMENT                 
         CVD   RF,DUB                                                           
         ZAP   STDIMBCT,DUB        SAVE NUMBER OF SETS                          
*                                                                               
         XC    DMCB(24),DMCB       SORT MEMBERSHIP LIST                         
         MVC   DMCB+11(1),RSETMLEN                                              
         MVC   DMCB+15(1),RSETMLEN                                              
*                                                                               
         GOTO1 XSORT,DMCB,RSETMEMB,(RF)                                         
*                                                                               
         LA    R9,RSETMEMB         SAVE A(CURRENT MEMBER)                       
         ST    R9,STDIMBMA                                                      
*                                                                               
*        READ ALL APPLICABLE STANDARD RECORDS                                   
*        SAVE IN TABLE                                                          
*                                                                               
STDIMB   DS    0H                                                               
*                                                                               
*        BUILD KEY                                                              
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
*                                                                               
         MVC   0(1,R4),STDPRID     RECORD ID                                    
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,1,STDPREPD       REP DISPLACEMENT IN KEY                      
         BZ    *+14                REP NOT IN KEY                               
         LA    RE,KEY(RE)          POINT TO REP IN KEY                          
         MVC   0(L'REREP,RE),REREP PLACE REP IN KEY                             
*                                                                               
         MVC   LKEY,STDPKY1D       SET KEY COMPARE LENGTH                       
*                                  EQUALS DISPLACEMENT OF DATA IN KEY           
*                                                                               
         TM    STDSWTCH,STDS2NDQ  IF NOT SECOND PASS                            
         BO    *+12                                                             
         TM    STDSWTCH,STDSEXCQ  SKIP IF EXCLUSION CASE                        
         BO    STDKMEMX                                                         
*                                                                               
*        ADD FILTER VALUES TO KEY                                               
*                                                                               
         ICM   R9,15,STDIMBMA      SKIP IF NO MEMBER AVAILABLE                  
         BZ    STDKMEMX               GO LOAD ALL OCCURRENCES                   
*                                                                               
         SR    RE,RE                                                            
         IC    RE,STDPKY1D         GET DATA DISPLACEMENT IN KEY                 
         LA    RE,KEY(RE)          POINT TO AREA IN KEY                         
*                                                                               
         SR    RF,RF                                                            
         IC    RF,STDIMBML         GET LENGTH OF DATA                           
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),0(R9)       SET FILTER VALUE                             
*                                                                               
         SR    R1,R1               UPDATE KEY COMPARE LENGTH                    
         IC    R1,LKEY             CURRENT KEY COMPARE LENGTH                   
         LA    R1,1(RF,R1)         ADD ON MEMBER LENGTH                         
         STC   R1,LKEY             UPDATE KEY COMPARE LENGTH                    
*                                                                               
STDKMEMX DS    0H                                                               
*                                                                               
         GOTO1 =A(SETREP),DMCB,KEY SET CORRECT REP IN KEY                       
*                                                                               
         BAS   RE,FIRSTHI          READ FIRST STANDARD RECORD                   
*                                                                               
STDIMBLP DS    0H                                                               
*                                                                               
STDLOOP  DS    0H                                                               
*                                                                               
         LA    R4,KEY              RE-POINT TO FOUND KEY                        
*                                                                               
         BAS   RE,KEYCOMP          DONE IF BASIC KEY NOT FOUND                  
         BNE   STDDONE                                                          
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,1,STDPREPD       REP DISPLACEMENT IN KEY                      
         BZ    *+18                REP NOT IN KEY                               
         LA    RE,KEY(RE)          POINT TO REP IN KEY                          
         CLC   0(L'REREP,RE),REDMREP CHECK REP IN KEY                           
         BNE   STDCONT             WRONG REP                                    
*                                                                               
         L     R3,STDTENDA         BUILD IN NEXT AVAILABLE ENTRY                
         LA    R3,1(R3)                                                         
         USING STDTENT,R3          ESTABLISH STANDARD ENTRY                     
*                                                                               
         MVC   STDTKEY,KEY         SAVE FOUND KEY                               
*                                                                               
         GOTOR TBLREP,DMCB,STDTKEY  FIND TABLE REP                              
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,1,STDPREPD       REP DISPLACEMENT IN KEY                      
         BZ    *+14                SKIP IF NO REP IN KEY                        
         LA    RE,STDTKEY(RE)      POINT TO REP IN KEY                          
         MVC   0(L'REREP,RE),RETBREP  SET TABLE REP IN KEY                      
*                                                                               
*        CHECK IF ENTRY ALREADY IN TABLE                                        
*                                                                               
         L     RF,STDTSTRA         POINT TO FIRST ELEMENT IN TABLE              
*                                                                               
         CR    RF,R3               SKIP IF FIRST ENTRY IN TABLE                 
         BNL   STDRPTDN                                                         
*                                                                               
STDRPTLP DS    0H                                                               
*                                                                               
         CLC   STDTKEY(L'RREPKEY),STDTKEY-STDTENT(RF) IF ENTRY IN TAB           
         BNE   STDRPTCN                                                         
*                                                                               
         TM    STDSWTCH,STDS2NDQ   IF SECOND PASS                               
         BNO   *+8                                                              
         OI    27(RF),X'80'           MARK ENTRY IN TABLE DELETED               
*                                                                               
         B     STDCONT             DO NOT ADD TO TABLE                          
*                                                                               
STDRPTCN DS    0H                                                               
*                                                                               
         A     RF,STDTLEN          BUMP TO NEXT ENTRY IN TABLE                  
         CR    RF,R3               CHECK IF WE HAVE REACHED END OF TAB          
         BL    STDRPTLP                                                         
*                                                                               
STDRPTDN DS    0H                  ADD ENTRY TO TABLE                           
*                                                                               
*        READ RECORD TO STORE REQUIRED ELEMENT                                  
*                                                                               
         TM    STDSWTCH,STDS2NDQ   SKIP IF SECOND PASS                          
         BO    STDCONT                  MAY HAPPEN WITH SALESPERSON             
*                                                                               
         CLI   STDPELID,0          SKIP IF NO ELEMENT TO SAVE                   
         BZ    STDDSCX                                                          
*                                                                               
         BAS   RE,GETREC           READ IN RECORD                               
*                                                                               
         L     R4,REAIO            POINT TO FOUND RECORD                        
*                                                                               
*        SAVE DESCRIPTION ELEMENT                                               
*                                                                               
         LA    R6,34(R4)           POINT TO FIRST ELEMENT IN RECORD             
*                                                                               
         SR    RF,RF                                                            
         IC    RF,1(R6)            GET ELEMENT LENGTH                           
*                                                                               
STDDSCLP DS    0H                                                               
         CLI   0(R6),0             DONE AT END OF RECORD                        
         BE    STDDSCX                                                          
         CLC   0(1,R6),STDPELID    FIND DESCRIPTION ELEMENT                     
         BE    STDDSCFD                                                         
STDDSCCN DS    0H                                                               
         IC    RF,1(R6)            GET ELEMENT LENGTH                           
         LA    R6,0(RF,R6)         BUMP TO NEXT ELEMENT                         
         B     STDDSCLP                                                         
*                                                                               
STDDSCFD DS    0H                                                               
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   STDTELM(0),0(R6)    SAVE DESCRIPTION ELEMENT                     
*                                                                               
         CLI   STDPRID,RSALKTYQ    IF SALESPERSON RECORD                        
         BNE   STDSALN                                                          
*                                                                               
         TM    REREQPRF+1,X'40'    SKIP IF NO OFFICE ACCESS RESTRICTION         
*****    BNO   STDSSECX                                                         
         B     STDSSECX            BYPASS OFFICE SECURITY CHECK                 
*                                                                               
         CLC   =C'O=',REACCS       TEST FOR OFFICE LIMITED ACCESS               
         BNE   STDSSECX                                                         
*                                                                               
         TM    REAUTH,X'80'        TERMINAL HAS ACCESS TO ALL OFFICES?          
         BO    STDSSECX             YES                                         
*                                                                               
*        SECURITY ALL SALESPEOPLE MUST BE FOR USER'S OFFICE                     
*                                                                               
         USING RSALELEM,R6         ESTABLISH DESCRIPTION ELEMENT                
*                                                                               
         CLC   RSALOFF,REACCS+2                                                 
         BNE   STDCONT                                                          
*                                                                               
STDSSECX DS    0H                                                               
         B     STDDSCX                                                          
*                                                                               
         DROP  R6                                                               
*                                                                               
STDSALN  DS    0H                                                               
*                                                                               
STDDSCX  DS    0H                                                               
*                                                                               
         ICM   R0,15,STDTAVL       GET NUMBER OF TABLE SLOTS AVAILABLE          
         BCT   R0,*+6              DECREMENT SPACE AVAILABLE COUNTER            
         DC    H'0'                INCREASE TABLE                               
         STCM  R0,15,STDTAVL       UPDATE NUMBER OF AVAILABLE SPOTS             
*                                                                               
         A     R3,STDTLEN          BUMP TO NEXT AVAILABLE TABLE ENTRY           
         XC    STDTKEY,STDTKEY     INIT NEXT ENTRY                              
*                                                                               
         BCTR  R3,0                RE-CALCULATE END OF TABLE                    
         ST    R3,STDTENDA                                                      
         AHI   R3,1                RESTORE POINTER                              
*                                                                               
STDCONT  DS    0H                                                               
*                                                                               
         BAS   RE,SEQ                                                           
*                                                                               
         B     STDLOOP                                                          
*                                                                               
STDDONE  DS    0H                                                               
*                                                                               
STDIMBCN DS    0H                                                               
*                                                                               
         ICM   R9,15,STDIMBMA      IF SET MEMBER POINTER AROUND                 
         BZ    STDIMBDN                                                         
*                                                                               
         SP    STDIMBCT,=P'1'         DECREMENT MEMBER COUNTER                  
         BNP   STDIMBDN               NONE LEFT IN ELEMENT                      
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE BASIC KEY                            
         LA    R4,KEY              RESTORE KEY POINTER                          
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,STDIMBML       GET LENGTH OF MEMBER OF SET                  
         LA    R9,0(RF,R9)         POINT TO NEXT MEMBER IN SET                  
         ST    R9,STDIMBMA         UPDATE MEMBER OF SET POINTER                 
*                                                                               
         SR    RE,RE                                                            
         IC    RE,STDPKY1D         GET DATA DISPLACEMENT IN KEY                 
         LA    RE,KEY(RE)          POINT TO AREA IN KEY                         
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),0(R9)       SET NEXT MEMBER ID                           
*                                                                               
         BAS   RE,HIGH             READ DIRECTORY POINTER                       
*                                                                               
         B     STDIMBLP                                                         
*                                                                               
STDIMBDN DS    0H                                                               
*                                                                               
STDISSCN DS    0H                                                               
*                                                                               
         ICM   R9,15,STDISSMA      IF SET OF SETS MEMBER POINTER AROUND         
         BZ    STDISSDN                                                         
*                                                                               
         SP    STDISSCT,=P'1'         DECREMENT MEMBER COUNTER                  
         BNP   STDISSDN               NONE LEFT IN ELEMENT                      
*                                                                               
         LA    R9,L'RSETKID(R9)   BUMP TO NEXT SET OF SETS                      
         ST    R9,STDISSMA         SAVE POINTER                                 
*                                                                               
         B     STDISSLP                                                         
*                                                                               
STDISSDN DS    0H                                                               
*                                                                               
         TM    STDSWTCH,STDSEXCQ   IF EXCLUDING ITEMS                           
         BNO   STD2NDX                                                          
         TM    STDSWTCH,STDS2NDQ   AND IF NOT SECOND PASS                       
         BO    STD2NDX                                                          
         OI    STDSWTCH,STDS2NDQ      SET FOR SECOND PASS                       
         B     STDREAD                AND GO DO IT                              
*                                                                               
STD2NDX  DS    0H                                                               
*                                                                               
*        SORT ENTRIES                                                           
*                                                                               
         XC    DMCB(24),DMCB       SORT MEMBERSHIP LIST                         
*                                                                               
         LM    R3,R5,STDTBXLE      BXLE PARMS FOR TABLE                         
*                                                                               
         ST    R3,DMCB             START OF TABLE TO SORT                       
*                                                                               
         SR    RE,RE                                                            
         LR    RF,R5                                                            
         AHI   RF,1                                                             
         SR    RF,R3               TABLE LENGTH                                 
         DR    RE,R4               NUMBER OF ENTRIES IN TABLE                   
*                                                                               
         ST    RF,DMCB+4           NUMBER OF ENTRIES TO SORT                    
*                                                                               
         ST    R4,DMCB+8           ENTRY LENGTH                                 
*                                                                               
         LA    R1,L'STDTKEY                                                     
         ST    R1,DMCB+12          KEY LENGTH                                   
*                                                                               
         GOTO1 XSORT,DMCB          SORT TABLE                                   
*                                                                               
*                                                                               
STDX     DS    0H                                                               
         CLI   RETRACE,C'Y'        IF TRACING                                   
         BNE   STDTRAX                                                          
*                                                                               
****     GOTO1 =A(TBLTRA)             PRINT TABLE CONTENTS                      
*                                                                               
STDTRAX  DS    0H                                                               
*                                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
STDISSMA DS    A                   A(CURRENT MBR OF SET OF SETS ELM)            
STDIMBMA DS    A                   A(CURRENT MEMBER OF MEMBER ELM)              
STDISSCT DS    PL2                 COUNT OF SETS REMAINING                      
STDIMBCT DS    PL2                 COUNT OF MEMBERS REMAINING                   
STDFLTR  DS    XL32                SINGLE FILTER SAVEAREA                       
STDIMBML DS    XL1                 LENGTH OF MEMBER                             
*                                                                               
STDSWTCH DS    XL1                 STATUS SWITCH                                
STDSEXCQ EQU   X'80'               EXCLUDING DATA                               
STDS2NDQ EQU   X'40'               SECOND PASS THROUGH CODE                     
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - STDPRMS'                        
***********************************************************************         
*                                                                     *         
*        TABLE OF PARAMETERS FOR CREATING TABLES OF STANDARD DATA     *         
*              USE DSECT STDPRMSD                                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
STDPRMS  DS    0D                                                               
*                                                                               
         PRINT GEN                                                              
*ADV      STDPR ADVERTISER,SID=AD,KEY2=REP,ELMID=01                             
*AGY      STDPR AGENCY/AGENCY-OFFICE,SID=AG,KEY2=AOF,ELMID=01,        X         
*               REID=AGYAOF                                                     
CLS      STDPR CLASS,ELMID=01,FLT=Y                                             
CTG      STDPR CATEGORY,ELMID=01,FLT=Y                                          
CTY      STDPR CONTRACT/TYPE,SID=CT,ELMID=01,FLT=Y                              
DCT      STDPR DEVELOP/TYPE,SID=DT,KEY1=CTY,ELMID=01,FLT=Y                      
DSP      STDPR DEVELOP/PERSON,KEY1=SAL,ELMID=01,FLT=Y                           
GRP      STDPR GRP/SUBGRP,KEY1=GP,KEY2=SGR,SID=GS,ELMID=01,REID=GRS             
MKT      STDPR MARKET,SID=MK,ELMID=01,FLT=Y,FLTNM=2                             
OFF      STDPR OFFICE,SID=OF,ELMID=01,FLT=Y,FLTNM=2                             
OWN      STDPR OWNER,ELMID=01,FLT=F,FLTNM=2                                     
PRD      STDPR PRODUCT,KEY1=ADV,KEY2=PRD,ELMID=01                               
PTP      STDPR POINT/PERSON,KEY1=REC,SID=PP,ELMID=01,FLT=Y                      
REG      STDPR REGION,ELMID=01                                                  
REP      STDPR REP,SID=RE,ELMID=01,FLT=Y,FLTNM=2                                
SAL      STDPR SALESPERSON,SID=SP,ELMID=01,FLT=Y                                
STA      STDPR STATION,SID=ST,ELMID=00                                          
TEM      STDPR DIV/TEM,ELMID=01,FLT=Y,FLTNM=2                                   
TER      STDPR TERRITORY,KEY1=-,ELMID=01 DON'T FILTER TABLE                     
         DC    X'FF'               END OF TABLE                                 
*                                                                               
         PRINT NOGEN                                                            
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - TABS'                           
***********************************************************************         
*                                                                     *         
*        LOAD TABLES FOR A NEW REP                                    *         
*                                                                     *         
*        REP REQUESTING REPORT WAS DONE IN NORMAL                     *         
*        STARTUP                                                      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
TABS     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         MVC   TABSREAD,REREAD     SAVE READ CODE                               
*                                                                               
         OC    TABSREP,TABSREP     IF FIRST TIME                                
*****    JNZ   *+14                                                             
         J     *+14                                                             
         MVC   TABSREP,REREP          SAVE REP AND EXIT BECAUSE TABLES          
         J     TABSX                  ALREADY LOADED                            
*                                                                               
*        ADD TABLES FOR NEEDED DATA AND INITIALIZE THE TABLE                    
*                                                                               
         LA    R2,REDATA           RESET POINTER                                
         LA    R0,L'REDATA         RESET COUNTER                                
*                                                                               
TABS1LP  DS    0H                                                               
*                                                                               
         CLI   0(R2),0             DONE AT END OF LIST                          
         JE    TABS1DN                                                          
*                                                                               
         CLI   0(R2),RREPKTYQ      REPS TABLE ALREADY FILLED                    
         JE    TABS1CN                                                          
*                                                                     *         
         CLI   0(R2),RCONKTYQ      CONTRACTS HANDLED SEPARATELY                 
         JE    TABS1CN                                                          
*                                                                     *         
         CLI   0(R2),RBUDKTYQ      BUDGETS   HANDLED SEPARATELY                 
         JE    TABS1CN                                                          
*                                                                     *         
         CLI   0(R2),RCBDKTYQ      BUDGETS   HANDLED SEPARATELY                 
         JE    TABS1CN                                                          
*                                                                     *         
         CLI   0(R2),ROBDKTYQ      BUDGETS   HANDLED SEPARATELY                 
         JE    TABS1CN                                                          
*                                                                     *         
         CLI   0(R2),RBSPKTYQ      BUDGETS   HANDLED SEPARATELY                 
         JE    TABS1CN                                                          
*                                                                     *         
         CLI   0(R2),RBSSKTYQ      BUDGETS   HANDLED SEPARATELY                 
         JE    TABS1CN                                                          
*                                                                     *         
         CLI   0(R2),RNRGKTYQ      RRGON     HANDLED SEPARATELY                 
         JE    TABS1CN                                                          
*                                                                     *         
*        FIND ADDRESS OF READ ROUTINE FOR RECORD TYPE                           
*                                                                               
         L     R1,=A(READADDS)     POINT TO TABLE OF ADDRESSES                  
*                                  TABLE IS AL1(RECORD ID),AL3(ROUTINE)         
TABSALP DS     0H                                                               
*                                                                               
         CLI   0(R1),X'FF'         DONE AT END OF TABLE                         
         JE    TABSADN                                                          
*                                                                               
         CLC   0(1,R2),0(R1)       MATCH RECORD ID TO TABLE                     
         JE    TABSAFD                                                          
*                                                                               
TABSACN DS     0H                                                               
*                                                                               
         LA    R1,4(R1)            BUMP TABLE POINTER                           
         J     TABSALP             CHECK NEXT ENTRY                             
*                                                                               
*        ROUTINE FOUND                                                          
*                                                                               
TABSAFD DS     0H                  MATCH TO TABLE FOUND                         
*                                                                               
*        CREATE TABLE                                                           
*                                                                               
         MVC   REREAD,0(R2)        INDICATE RECORD TYPE WANTED                  
*                                                                               
         LA    R4,KEY              PRESET A SIMPLE STARTING KEY                 
         XC    KEY,KEY                                                          
         MVC   KEY(1),0(R2)        SET RECORD ID                                
*                                                                               
         L     RF,0(R1)            PICK UP ROUTINE DISPLACEMENT                 
         A     RF,RENWRIOA         ADD A(BEGIN OF WRIIO)                        
         BASR  RE,RF               AND EXECUTE                                  
*                                                                               
         J     TABS1CN                                                          
*                                                                               
TABSADN DS     0H                  EOT                                          
*                                                                               
         J     TABS1CN             NO READ ROUTINE FOR THIS RECORD TYPE         
*                                                                               
TABS1CN  DS    0H                                                               
*                                                                               
         LA    R2,1(R2)            BUMP LIST POINTER                            
         BRCT  R0,TABS1LP                                                       
*                                                                               
TABS1DN  DS 0H                                                                  
*                                                                               
TABSX    DS    0H                                                               
         MVC   REREAD,TABSREAD     SAVE READ CODE                               
         XIT1                                                                   
*                                                                               
TABSREP  DC    XL(L'REREP)'0000'   LAST REP LOADED                              
*                                                                               
         LTORG                                                                  
*                                                                               
TABSREAD DS    XL1                 READ CODE SAVEAREA                           
*                                                                               
         DROP                                                                   
*                                                                               
         PRINT NOGEN                                                            
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - REREPRGEQC'                     
       ++INCLUDE REREPRGEQC                                                     
         TITLE 'RENWRIO - REPWRITER IO MODULE - DOVALU2'                        
***********************************************************************         
*                                                                     *         
*        - ROUTINES TO SET UP AND EXECUTE VALU2NEW TO EXTRACT         *         
*        - BILLING DATA FROM CONTRACT RECORDS                         *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
DOVALU2  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         L     RF,REAIO1           POINT TO CONTRACT RECORD                     
         CLC   =X'0C00',0(RF)      SKIP IF NOT DOING CONTRACT RECORD            
         BNE   DOVALU2X                                                         
*                                                                               
*        INITIALIZE WORK AREAS                                                  
*                                                                               
DVLINIT  DS    0H                                                               
*                                                                               
         CLI   DVLINISW,0          SKIP IF INITIALIZATION ALREADY DONE          
         BNE   DVLINITX                                                         
*                                                                               
*        INITIALIZE WORKAREAS                                                   
*                                                                               
         GOTO1 =A(REQINIT)         SET UP QWKD                                  
*                                                                               
         GOTO1 =A(SETUPMON)        SET UP MONTH INFORMATION                     
*                                                                               
         GOTO1 =A(SETMONTB)        NO/LOAD IT                                   
*                                                                               
DVLINITX DS    0H                                                               
*                                                                               
         MVI   DVLINISW,1                                                       
*                                                                               
         GOTO1 =A(POSTMNTH)        POST IT                                      
*                                                                               
DOVALU2X DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - REQINIT'                        
***********************************************************************         
*                                                                     *         
*        ROUTINE TO SET UP REQUEST WORK AREAS                         *         
*                                                                     *         
*NTRY    R2 ==> REQUEST WORKAREA                                      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
REQINIT  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
REQINITX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - SETUPMON'                       
***********************************************************************         
*                                                                     *         
*        ROUTINE TO SET UP MONTH INFORMATION                          *         
*                                                                     *         
*NTRY    R2 ==> REQUEST WORKAREA                                      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
SETUPMON NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         XC    REMONACC,REMONACC   INIT MONTHLY ACTIVITY DATES                  
*                                                                               
         MVC   SMNCURSB,REFCURSB   DEFAULT TO CURRENT START MONTH               
*                                                                               
         TM    REQCFOPT,REQCFYTQ   IF YTD IN EFFECT                             
         BNO   *+10                                                             
         MVC   SMNCURSB,REFYCRSB      USE CURRENT YTD START                     
*                                                                               
         CLI   SMNCURSB+2,0        SKIP IF NO DAY IN REQUEST DATE?              
         BE    SMON0010                                                         
*                                                                               
*   SET UP MONTHLY ACTIVITY DATES:  CONVERT FROM BINARY TO YYMMDD               
*                                                                               
         GOTO1 DATCON,DMCB,(3,SMNCURSB),(0,WORK) YYMMDD                         
         GOTO1 =A(GETMDAY),DMCB,WORK,REMACCRS    CURR START ACT DTE             
*                                                                               
         GOTO1 ADDAY,DMCB,(C'Y',WORK),(0,WORK),F'-1'  SUBTRACT A YEAR           
         GOTO1 =A(GETMDAY),DMCB,WORK,REMACPRS    PRIOR START ACT DTE            
*                                                                               
         GOTO1 DATCON,DMCB,(3,REFCUREB),(0,WORK) YYMMDD                         
         GOTO1 =A(GETMDAY),DMCB,WORK,REMACCRE    CURR END ACT DTE               
*                                                                               
         GOTO1 ADDAY,DMCB,(C'Y',WORK),(0,WORK),F'-1'  SUBTRACT A YEAR           
         GOTO1 =A(GETMDAY),DMCB,WORK,REMACPRE    PRIOR END ACT DTE              
*                                                                               
SMON0010 EQU   *                                                                
*                                                                               
         SR    R5,R5                                                            
*                                                                               
*        START BROADCAST MONTH IS SAME AS THE CALENDAR MONTH                    
*        OF THE END DATE OF THE START DATE'S BRADCAST MONTH                     
*                                                                               
         GOTO1 DATCON,DMCB,(3,SMNCURSB),WORK   YYMMDD                           
         GOTO1 GETBROAD,DMCB,(1,WORK),WORK+12,GETDAY,ADDAY                      
*                                                                               
         GOTO1 DATCON,DMCB,WORK+18,(3,WORK+12) YMD BINARY                       
*                                                                               
         MVC   WORK(2),WORK+12     START YM                                     
*                                                                               
         CLC   SMNCURSB(1),REFCUREB  IF REQ WITHIN ONE CALENDAR YEAR            
         BNE   *+8                                                              
         MVI   WORK+1,1               YES- START FROM JAN                       
*                                                                               
         MVC   WORK+2(2),WORK      COPY START BROADCAST MONTH                   
*                                                                               
         SR    R5,R5                                                            
         IC    R5,WORK             DECREMENT YEAR BY 1 FOR PRIOR YR             
         BCTR  R5,0                                                             
         STC   R5,WORK+2           PRIOR YR BROADCAST MONTH                     
*                                                                               
         MVC   WORK+4(2),WORK      CALCULATE 2 YEARS PRIOR                      
*                                                                               
         IC    R5,WORK+4                                                        
         BCTR  R5,0                DECREMENT PRIOR YEAR BY 1                    
         BCTR  R5,0                DECREMENT PRIOR YEAR BY 1                    
         STC   R5,WORK+4                                                        
*                                                                               
         MVC   WORK+6(2),WORK      CALCULATE NEXT YEAR                          
*                                                                               
         IC    R5,WORK+6                                                        
         LA    R5,1(R5)            ADD 1 YEAR TO CURRENT YEAR                   
         STC   R5,WORK+6                                                        
*                                                                               
*        BUILD LIST OF MONTH DATES YM BINARY FORMAT                             
*              LIST CONSISTS OF CURRENT    Y/M                                  
*                               PRIOR      Y/M                                  
*                               2 YR PRIOR Y/M                                  
*                               NEXT       Y/M                                  
*                                                                               
         L     R2,REANWMON         POINT TO 1ST MONTH TABLE AREA                
         USING NWMNTABD,R2         ESTABLISH MONTH TABLE AREA                   
*                                                                               
         XC    NWMTMINF,NWMTMINF  INIT MONTH INFO LIST                          
*                                                                               
         LA    R4,NWMTMINF         POINT TO MONTHLY INFO LIST                   
*                                                                               
SMONLOOP DS    0H                                                               
*                                                                               
         MVC   0(2,R4),WORK        CURRENT Y/M                                  
         MVC   2(2,R4),WORK+2      PRIOR   Y/M                                  
         MVC   4(2,R4),WORK+4      2 YEAR  PRIOR Y/M                            
         MVC   6(2,R4),WORK+6      NEXT YEAR                                    
*                                                                               
SMONCONT DS    0H                                                               
*                                                                               
         CLI   WORK+1,12           HAVE WE REACHED DECEMBER?                    
         BE    *+16                  YES                                        
         IC    R5,WORK+1             NO - BUMP MONTH                            
         LA    R5,1(R5)                                                         
         B     SMONCN10                                                         
*                                                                               
*        BUMP EACH YEAR BY ONE AND SET MONTH TO JANUARY                         
*                                                                               
         MVC   WORK+4(1),WORK+2    PRIOR   2 YR = PRIOR YEAR                    
         MVC   WORK+2(1),WORK      PRIOR   YEAR = CURRENT YEAR                  
         MVC   WORK(1),WORK+6      CURRENT YEAR = NEXT YEAR                     
*                                                                               
         IC    R5,WORK+6           ADD 1 TO NEXT YEAR                           
         LA    R5,1(R5)                                                         
         STC   R5,WORK+6                                                        
*                                                                               
         LA    R5,1                SET MONTH TO JANUARY                         
*                                                                               
SMONCN10 DS    0H                  SET MONTH                                    
*                                                                               
         STC   R5,WORK+1           CURRENT MONTH                                
         STC   R5,WORK+3           PRIOR MONTH                                  
         STC   R5,WORK+5           2 YR PRIOR MONTH                             
         STC   R5,WORK+7           NEXT YEAR MONTH                              
*                                                                               
         LA    R4,8(R4)            POINT TO NEXT ENTRY IN LIST                  
*                                                                               
         CLC   REFCUREB(2),WORK    HAVE WE PASSED PERIOD END                    
         BNL   SMONLOOP                                                         
*                                                                               
SMONDONE EQU   *                                                                
*                                                                               
*        SET UP AS-AT DATES FOR EACH ASATDATE IN TABLE                          
*                                                                               
         L     R3,REAADTBA         POINT TO START OF ASATDATES TABLE            
         LA    R4,NWMTMINF         POINT TO 1ST MONTHLY INFO LIST               
*                                                                               
         SR    R0,R0                                                            
         IC    R0,REQAADFN         NUMBER OF ASATDATE FILTERS                   
         AH    R0,=H'1'            BUMP TO INCLUDE BASIC REPORT                 
*                                                                               
SMONAADL DS    0H                                                               
*                                                                               
         OC    0(6,R3),0(R3)       DONE IF NO MORE AAD'S IN TABLE               
         BZ    SMONAADD                                                         
*                                                                               
         GOTO1 =A(ASATPROC),DMCB,NWMTMFRC,(R3) SET UP AS-AT DATES               
*                                                                               
SMONAADC DS    0H                                                               
*                                                                               
         A     R2,=A(NWMTENTL)     BUMP TO NEXT SECTION                         
         LA    R3,6(R3)            BUMP TO NEXT ASATDATES                       
*                                                                               
         BCT   R0,*+8                                                           
         B     SMONAADD            END OF TABLE                                 
*                                                                               
         MVC   NWMTMINF,0(R4)      COPY MONTH INFO TABLE                        
*                                                                               
         B     SMONAADL                                                         
*                                                                               
SMONAADD DS    0H                                                               
*                                                                               
SETUPMNX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
SMNCURSB DS    XL3                 START DATE TO USE - YMD -BINARY              
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - GETMDAY'                        
***********************************************************************         
*                                                                     *         
*        GETMDAY ROUTINE RETURNS MONDAY DATE FOR WEEK GIVEN           *         
*                                                                     *         
*NTRY    P0      A(YYMMDD) INPUT DATE                                 *         
*                                                                     *         
*EXIT    P1      A(COMPRESSED MONDAY DATE)                            *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
*                                                                               
GETMDAY  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         LM    R5,R6,0(R1)         R5=A(INPUT), R6=A(OUTPUT)                    
*                                                                               
         GOTO1 DATCON,DMCB,(0,0(R5)),(3,GTMDUB) BINARY DATE                     
*                                                                               
         TM    GTMDUB,X'03'        IF LAST 2 BITS OF YEAR ARE OFF               
         BZ    GETM10                 THEN LEAP YEAR                            
*                                                                               
*                                  ELSE NON-LEAP YEAR                           
*                                                                               
         CLC   2(4,R5),=C'0229'         FEB 29 NOT VALID                        
         BNE   *+10                                                             
         MVC   2(4,R5),=C'0301'         CHANGE TO MAR 01                        
*                                                                               
GETM10   EQU   *                                                                
*                                                                               
         GOTO1 GETDAY,DMCB,(R5),GTMDUB FIND DAY OF WEEK                         
*                                                                               
         CLC   GTMDUB(3),SPACES    MUST HAVE A DAY                              
         BNE   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         SR    RF,RF                                                            
         IC    RF,DMCB             DAY NUMBER                                   
*                                                                               
         BCTR  RF,0                BACK UP A DAY                                
*                                                                               
         ST    RF,WORD             STORE THE # OF DAYS FROM MONDAY              
*                                                                               
         LNR   RF,RF               NUMBER OF DAYS TO SUBTRACT                   
*                                     TO GET TO MONDAY                          
*                                                                               
         ICM   R3,15,REREPTA       GET CURRENT REP TABLE ENTRY ADDRESS          
         USING REPTENT,R3                                                       
*                                                                               
         CLI   RREPPROF+27-RREPELEM+REPTELM,C'Y'  IF DAILY PACING               
         BNE   *+6                                                              
         SR    RF,RF              ASSUME ALL DATES ARE MONDAY                   
*                                                                               
         GOTO1 ADDAY,DMCB,(R5),GTMDUB,(RF)   BACK UP TO MONDAY                  
*                                                                               
         GOTO1 DATCON,DMCB,GTMDUB,(2,(R6))   COMPRESSED DATE                    
*                                                                               
GETMDAYX DS    0H                                                               
         XIT1                                                                   
*                                                                               
GTMDUB   DS    D                   WORKAREA                                     
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - ASATPROC'                       
***********************************************************************         
*                                                                     *         
*  THIS ROUTINE SETS 'FORECAST' DATE BUCKETS USING AS AT DATES.  IF   *         
*     AN AS-AT TO-DATE HAS BEEN ENTERED, INDICATING A REQUEST FOR     *         
*     AS-AT RANGE TESTING, FOUR ADDITIONAL DATES ARE GENERATED.       *         
*                                                                     *         
*NTRY    P0    A(MONTH FORECAST BUCKETS)                              *         
*        P1    A(ASATDATE(S))                                         *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
ASATPROC NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         L     R6,0(R1)            POINT TO MONTH FORECAST TABLE                
         LR    R2,R6               SAVE TABLE POINTER                           
*                                                                               
         XC    0(50,R6),0(R6)      INIT TABLE                                   
*                                                                               
         L     R3,4(R1)            POINT TO ASATDATES                           
*                                                                               
*   SET 'CURRENT AS-AT DATE' (FROM), AND THREE DATES BASED ON IT                
*                                                                               
         GOTO1 =A(SET4DATS),DMCB,(R6),(R3)                                      
*                                                                               
*   CHECK FOR AN AS-AT TO-DATE.  IF PRESENT, INSERT FOUR DATES                  
*                                                                               
         LA    R6,8(R6)            A(MON FCST TABLE: TO-DATES)                  
*                                                                               
         OC    3(3,R3),3(R3)       ANY AS-AT TO-DATE?                           
         BZ    ASATPRC1            NO  - FINISHED                               
*                                                                               
*   SET 'CURRENT AS-AT DATE' (TO), AND THREE DATES BASED ON IT                  
*                                                                               
         GOTO1 =A(SET4DATS),DMCB,(R6),3(R3)                                     
*                                                                               
ASATPRC1 EQU *                                                                  
*                                                                               
*        THIS WEEK FOR ACTIVITY IS CURRENT ASATADATE                            
*                                                                               
         LA    R6,8(R6)            A(LAST WEEK ACTIVITY DATE)                   
*                                                                               
         GOTO1 DATCON,DMCB,(2,0(R2)),(0,WORK+48)                                
*                                                                               
*                                  BACK UP ONE WEEK                             
*                                                                               
         GOTO1 ADDAY,DMCB,WORK+48,WORK+54,F'-7'                                 
*                                                                               
         GOTO1 DATCON,DMCB,(0,WORK+54),(2,0(R6))                                
*                                                                               
ASATPRCX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - SET4DATS'                       
***********************************************************************         
*                                                                     *         
*  THIS ROUTINE SETS THE SET OF FOUR DATES FOR AS-AT PROCESSING.      *         
*                                                                     *         
*NTRY    P0 ==> TABLE OF 4 ASAT DATES - COMPRESSED - OUTPUT           *         
*              CURRENT                                                *         
*              PRIOR                                                  *         
*              2YR PRIOR                                              *         
*              NEXT                                                   *         
*        P1 ==> STARTING ASATDATE - YMD - INPUT                       *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
SET4DATS NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         L     R6,0(R1)            A(TABLE)                                     
*                                                                               
         L     RF,4(R1)            CURRENT YEAR STARTING DATE                   
         GOTO1 DATCON,DMCB,(3,0(RF)),S4DCUR   SAVE STARTING DATE                
*                                                                               
*        CURRENT ASATDATE IS MONDAY OF BROADCAST WEEK OF STARTING DATE          
*                                                                               
         GOTO1 =A(GETMDAY),DMCB,S4DCUR,(R6)                                     
*                                                                               
*        OTHER AS-AT-DATES ARE THE MONDAY OF THE SAME BROADCAST WEEK            
*        AS THAT OF THE CURRENT STARTING DATE                                   
*                                                                               
* GET BROADCAST YEAR START OF AS-AT DATE:  MAY NOT BE SAME - IE:                
*    DEC30/91 IS BROADCAST YEAR 02.  (CHECK THE CALENDAR).                      
*    TAKE THE YEAR FROM THE TO-DATE PORTION, FOR SAME REASON.                   
*                                                                               
*        BROADCAST MONTH OF START DATE                                          
*                                                                               
         GOTO1 GETBROAD,DMCB,(1,S4DCUR),S4DBRDST,GETDAY,ADDAY                   
*                                                                               
*        TAKE YEAR FROM YEAR OF END OF BROADCAST MONTH                          
*        AND THEN FIND JANUARY BROADCAST MONTH                                  
*                                                                               
         MVC   S4DJ15YR,S4DBRDEN     START BDCST YEAR                           
         MVC   S4DJ15MN(4),=C'0115'  SET JAN15 OF YEAR                          
*                                                                               
*        JANUARY BROADCAST MONTH                                                
*                                                                               
         GOTO1 GETBROAD,DMCB,(1,S4DJ15DT),S4DBRDST,GETDAY,ADDAY                 
*                                                                               
*        CALCULATE WEEK # FROM BDCAST YEAR START THRU CURR AS AT DATE           
*                                                                               
         GOTO1 PERVERT,DMCB,S4DBRDST,S4DCUR                                     
*                                                                               
         ZICM  RF,DMCB+12,2        SAVE WEEK# OF CURR AS AT DATE                
*                                                                               
         OC    DMCB+10(2),DMCB+10  ANY PERVERT DAYS REMAINING?                  
         BNZ   *+6                 YES - DON'T ADJUST WEEK #                    
         BCTR  RF,0                NO  - DECREMENT WEEK #                       
*                                                                               
         STCM  RF,3,S4DWKS         SAVE WEEK# OF CURR AS AT DATE                
*                                                                               
*        PRIOR ASATDATE                                                         
*                                                                               
         LA    R6,2(R6)            A(PRIOR AS-AT DATE)                          
*                                                                               
         GOTO1 ADDAY,DMCB,(C'Y',S4DJ15DT),S4DADJDT,F'-1' PRIOR YEAR             
*                                                                               
         GOTO1 SETASAT,DMCB,(R6),S4DADJDT,S4DWKS                                
*                                                                               
*        2YR PRIOR ASATDATE                                                     
*                                                                               
         LA    R6,2(R6)            A(2YR PRIOR AS AT DATE)                      
*                                                                               
         GOTO1 ADDAY,DMCB,(C'Y',S4DJ15DT),S4DADJDT,F'-2' 2 YR PRIOR             
*                                                                               
         GOTO1 SETASAT,DMCB,(R6),S4DADJDT,S4DWKS                                
*                                                                               
*        NEXT ASATDATE                                                          
*                                                                               
         LA    R6,2(R6)            A(NEXT YEAR AS AT DATE)                      
*                                                                               
         GOTO1 ADDAY,DMCB,(C'Y',S4DJ15DT),S4DADJDT,F'1' NEXT YEAR               
*                                                                               
         GOTO1 SETASAT,DMCB,(R6),S4DADJDT,S4DWKS                                
*                                                                               
SET4DATX DS    0H                                                               
         XIT1                                                                   
*                                                                               
S4DCUR   DS    CL6                 CURRENT STARTING DATE - YYMMDD               
S4DBRDST DS    CL6                 BROADCAST MONTH START - YYMMDD               
S4DBRDEN DS    CL6                 BROADCAST MONTH END   - YYMMDD               
S4DADJDT DS    CL6                 JAN15 WITH ADJUSTED YEAR                     
*                                                                               
S4DJ15DT DS    0CL6                JANUARY 15 DATE  - YYMMDD                    
S4DJ15YR DS    CL2                 JANUARY 15 YEAR  - YY                        
S4DJ15MN DS    CL2                 JANUARY 15 MONTH - MM                        
S4DJ15DY DS    CL2                 JANUARY 15 DAY   - DD                        
*                                                                               
S4DWKS   DS    H                   RELATIVE BROADCAST WEEK FOR CUR DATE         
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - SETASAT'                        
***********************************************************************         
*                                                                     *         
*  THIS ROUTINE CALCULATES THE MONDAY DATE OF THE NTH WEEK OF THE     *         
*     BROADCAST YEAR                                                  *         
*                                                                     *         
*NTRY    P0    A(ENTRY IN ASATDATE TABLE)                             *         
*        P1    A(JAN15 OF YEAR)                                       *         
*        P2    A(NUMBER OF WEEKS FROM START OF YEAR)                  *         
*                                                                     *         
*EXIT          TABLE ENTRY FILLED IN                                  *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
SETASAT  NTR1                                                                   
*                                                                               
         L     R6,0(R1)            RESET A(MONFORC TABLE ENTRY)                 
*                                                                               
         L     RF,4(R1)                                                         
         MVC   STASJN15,0(RF)      SAVE JAN15 DATE OF DESIRED YEAR              
*                                                                               
         L     RF,8(R1)                                                         
         MVC   STASWKS,0(RF)       SAVE RELATIVE WEEK OF ASATDATE               
*                                                                               
*        START OF BROADCAST YEAR IS START OF JANUARY BROADCAST MONTH            
*                                                                               
         GOTO1 GETBROAD,DMCB,(1,STASJN15),STASBRDT,GETDAY,ADDAY                 
*                                                                               
         LH    R2,STASWKS          INSERT WEEK# OF CURRENT DATE                 
         CH    R2,=H'52'           IS CURRENT WEEK # 53?                        
*                                                                               
*   WEEK # IS UNDERSTATED BY 1.  DAYS 1-7 ARE WEEK 1, BUT PERVERT               
*    CALCULATION RETURNS 0.                                                     
*                                                                               
         BNE   *+6                 NO                                           
         BCTR  R2,0                YES - SET IT TO 52 FOR OTHER YEARS           
*                                                                               
         MH    R2,=H'7'            MULT BY 7 = # OF DAYS                        
*                                                                               
         SR    R0,R0               ADD IN THE # OF DAYS FROM MONDAY             
         L     R0,WORD                                                          
         AR    R2,R0                                                            
*                                                                               
         GOTO1 ADDAY,DMCB,STASBRDT,STASADJD,(R2)                                
*                                                                               
*        INSERT MONDAY DATE OF WEEK# INTO MONFOR TABLE                          
*                                                                               
         GOTO1 =A(GETMDAY),DMCB,STASADJD,(R6)                                   
*                                                                               
SETASATX DS    0H                                                               
         XIT1                                                                   
*                                                                               
STASADJD DS    CL6                 ADDJUSTED DATE - YYMMDD                      
STASJN15 DS    CL6                 JAN15 OF DESIRED YEAR                        
STASWKS  DS    H                   WEEK NUMBER OF ASATADATE                     
STASBRDT DS    CL12                BROADCAST MONTH START AND END                
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - SETCOMBO'                       
***********************************************************************         
*                                                                     *         
*   ACCESS STATION RECORD OF REQUEST, RETRIEVE EACH X'0A' ELEMENT,    *         
*     AND TABLE ITS STATION FOR LATER FILTERING.                      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
SETCOMBO NTR1                                                                   
         L     R2,0(R1)            A(REQUEST WORK AREA)                         
         USING QWKD,R2                                                          
         XC    KEY,KEY                                                          
         MVI   KEY,2               SET RECORD TYPE                              
* NOTE!!  RRREPFL ???                                                           
**       MVC   KEY+20(2),RRREPFL   INSERT REP CODE                              
         MVC   KEY+22(5),QSTATION  INSERT STATION FROM REQ REC                  
**       GOTO1 AHIGH                                                            
         BAS   RE,HIGH             READ KEY                                     
         CLC   KEY(27),KEYSAVE     FOUND?                                       
         BE    *+6                 YES                                          
         DC    H'0'                NO  - MUST BE ON FILE                        
* - SEE WHERE TO SET UP COMBO STATIONS/ IN EARLIER STATION READ ????            
***      L     R6,REAREC                                                        
***      USING                                                                  
**       GOTO1 AGETSTA                                                          
****     BAS   RE,GETREC2          RETRIEVE RECORD                              
****     LA    R3,QWCOMBOS         A(PARTICIPATING STATIONS)                    
*****    LA    R4,RSTAELEM         X'01' ELEMENT                                
SCOM0010 EQU   *                                                                
         CLI   0(R4),X'00'         END OF RECORD?                               
         BE    SCOM0040            YES - FINISHED                               
         CLI   0(R4),X'0A'         NO  - COMBO STATION ELEMENT?                 
         BNE   SCOM0030            NO  -                                        
         CLI   1(R4),7             OLD FORMAT ELEMENT?                          
         BNH   SCOM0020            YES -                                        
         CLI   7(R4),C'-'          NO  - NON-PARTICIPATING STATION?             
         BE    SCOM0030            YES - DON'T TABLE IT                         
SCOM0020 EQU   *                                                                
         MVC   0(5,R3),2(R4)       YES - MOVE STATION TO TABLE                  
         LA    R3,5(R3)            BUMP A(TABLE ENTRY)                          
SCOM0030 EQU   *                                                                
         ZIC   RF,1(R4)            BUMP TO NEXT ELEMENT                         
         AR    R4,RF                                                            
         B     SCOM0010            GO BACK FOR NEXT                             
SCOM0040 EQU   *                                                                
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - SETMONTB'                       
***********************************************************************         
*                                                                     *         
*    ROUTINE TO USE OVERALL REQUEST DATES TO ESTABLISH A MONTH TABLE  *         
*    IF START AND END DATES ARE MORE THAN 72 MONTHS (6 YEARS) APART   *         
*    TABLE CAN'T HANDLE THE SPREAD AND MONTHS OVER 72 FALL OFF        *         
*    END OF TABLE                                                     *         
*                                                                     *         
*        ONE COPY IS SET UP FOR EACH ENTRY IN ASATDATE TABLE          *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
SETMONTB NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         L     R2,REANWMON         POINT TO NEWMON TABLES AREA                  
         USING NWMNTABD,R2         ESTABLISH NEW MONTH TABLE AREA               
*                                                                               
         L     R3,REAADTBA         POINT TO ASATDATE TABLE                      
*                                                                               
         SR    R0,R0                                                            
         IC    R0,REQAADFN         NUMBER OF ASATDATE FILTERS                   
         AH    R0,=H'1'            ADD ONE FOR OVERALL REPORT                   
*                                                                               
SETMLOOP DS    0H                                                               
*                                                                               
         LA    RF,NEXTBUCK         L(NEW MONTH TABLE ENTRY)                     
         MH    RF,=H'72'           NUMBER OF ENTRIES                            
         LA    RE,NWMTNWMT         A(NEW MONTH TABLE)                           
         XCEFL                                                                  
*                                                                               
         LA    R4,NWMTNWMT         A(NEW MONTH TABLE)                           
*                                                                               
*  SET THE ADDRESS OF CONTRACT SPECIFIC INFORMATION INTO THE MIS-               
*    CELLANEOUS STORAGE AREA JUST PRECEDING THE NEW MONTH TABLE.                
*    THIS SERVES AS A FLAG TO VALUENEW TO EXTRACT DATA.                         
*                                                                               
         SH    R4,=Y(CONSPINF)     POINT TO A(CONTRACT SPECIFIC INFO)           
*                                                                               
         LA    RF,NWMTCSPC         POINT TO CONTRACT SPECIFIC INFO              
         STCM  RF,15,0(R4)         LOAD A(CONTRACT SPEC INFO)                   
*                                                                               
         LA    R4,CONSPINF(R4)     RESET A(NEW MONTH TABLE)                     
*                                                                               
         GOTO1 GETBROAD,DMCB,(1,REQPSTR),WORK,GETDAY,ADDAY                      
*                                                                               
         MVC   0(6,R4),WORK+6      END OF B'MON IS IN CALENDAR MONTH            
         MVC   2(4,R4),=C'0101'    SET EARLIEST DATE TO JAN/1                   
*                                                                               
         LA    R5,71               72 BUCKETS TOTAL: 1ST LOADED                 
*                                                                               
SETMMNLP EQU   *                                                                
*                                                                               
         CLC   0(4,R4),SVQEND      ALL DATES LOADED?                            
         BE    SETMMNDN            YES - NO SEED OTHER DATES                    
*                                                                               
         LA    R6,NEXTBUCK(R4)     SET A(NEXT DATE ENTRY)                       
*                                                                               
         GOTO1 ADDAY,DMCB,(C'M',0(R4)),(R6),1 CALC START OF NEXT MONTH          
*                                               ACTS AS DUMP LABEL              
SETMMNCN DS    0H                                                               
*                                                                               
         LR    R4,R6                                                            
         BCT   R5,SETMMNLP         DO NEXT DATE                                 
*                                                                               
SETMMNDN EQU   *                                                                
*                                                                               
         LA    R4,NWMTNWMT         A(NEW MONTH TABLE)                           
*                                                                               
         GOTO1 DATCON,DMCB,(R4),(3,WORK)   MONTH IS JANUARY                     
*                                                                               
         SR    RF,RF                                                            
*                                                                               
SETMMN2L EQU   *                                                                
*                                                                               
         MVC   CURDATE(2,R4),WORK  SET CURRENT START DATE                       
*                                                                               
         IC    RF,WORK                                                          
         BCTR  RF,0                DECREMENT YEAR BY 1                          
         STC   RF,WORK             TO CALCULATE PRIOR YEAR                      
         MVC   PRIDATE(2,R4),WORK  SET PRIOR DATE                               
*                                                                               
         BCTR  RF,0                SUBTRACT ANOTHER TO CALCULATE                
         STC   RF,WORK             2 YEARS PRIOR                                
         MVC   PRI2DATE(2,R4),WORK SET 2 YEARS PRIOR                            
*                                                                               
         LA    RF,3(RF)            CALCULATE NEXT YEARS DATE                    
         STC   RF,WORK                                                          
         MVC   NEXTDATE(2,R4),WORK SET NEXT YEARS DATE                          
*                                                                               
         CLI   WORK+1,12           IS IT DECEMBER?                              
         BL    SETM0016            NO                                           
         MVI   WORK+1,1            YES - SET MONTH TO JAN                       
*                                  YEAR IS ALREADY SET TO NEXT YEAR             
         B     SETM0020                                                         
*                                                                               
SETM0016 EQU   *                                                                
*                                                                               
         BCTR  RF,0                DECREMENT NEXT YEAR TO THIS YEAR             
         STC   RF,WORK             RESET YEAR TO CURRENT                        
         IC    RF,WORK+1           INCREMENT MONTH                              
         LA    RF,1(RF)                                                         
         STC   RF,WORK+1           RESTORE NEW MONTH                            
*                                                                               
SETM0020 EQU   *                                                                
*                                                                               
SETMMN2C DS    0H                                                               
*                                                                               
         CLC   REQPENDB(2),WORK    END REACHED?                                 
         BL    SETMMN2D            YES                                          
*                                                                               
         LA    R4,NEXTBUCK(R4)     NO  - NEXT TABLE ENTRY                       
         B     SETMMN2L            GO BACK AND DO NEXT                          
*                                                                               
SETMMN2D EQU   *                                                                
*                                                                               
         TM    REQBLLOP,REQBODRQ+REQBOPPQ     IF DR/PP ANALYSIS                 
         BZ    SETMCUTX                                                         
*                                                                               
         GOTO1 =A(CUTOFF),DMCB,(R2),(R3)         BUILD CUTOFF DATES             
*                                                                               
SETMCUTX DS    0H                                                               
*                                                                               
SETMCONT DS    0H                                                               
*                                                                               
         A     R2,=A(NWMTENTL)     BUMP TO NEXT SECTION                         
         BCT   R0,SETMLOOP                                                      
*                                                                               
SETMDONE DS    0H                                                               
*                                                                               
SETMONTX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - CUTOFF'                         
***********************************************************************         
*                                                                     *         
*    ROUTINE TO DETERMINE CURRENT AND PRIOR CUTOFF DATES FOR DIRECT   *         
*    RESPONSE AND PAID PROGRAMMING REPORTING                          *         
*                                                                     *         
*    GIVEN AN ASATDATE,                                               *         
*        THE NEAREST WEDNESDAY IS FOUND                               *         
*        IF THIS WEDNESDAY IS BEFORE FIFTEENTH OF THE MONTH           *         
*           CUTOFF DATE IS MONTH OF ASATDATE                          *         
*           ELSE CUTOFF IS NEXT MONTH                                 *         
*                                                                     *         
*        PRIOR CUTOFF DATE IS ONE YEAR BEFORE CURRENT CUTOFF          *         
*            DOES NOT DEPEND ON ASATDATE OF A YEAR AGO                *         
*                                                                     *         
*                                                                     *         
*NTRY    P0    A(NEW MONTH TABLE AREA)                                *         
*        P1    A(ASATDATE) - YMD BINARY                               *         
*                                                                     *         
*EXIT    CURRENT AND PRIOR CUTOFF DATES FILLED IN IN NEWMONTH TABLE   *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
CUTOFF   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         L     R2,0(R1)            POINT TO NEWMON TABLES AREA                  
         USING NWMNTABD,R2         ESTABLISH NEW MONTH TABLE AREA               
*                                                                               
         L     R3,4(R1)            POINT TO ASATDATE                            
*                                                                               
         GOTO1 DATCON,DMCB,(3,0(R3)),WORK   DATE TO YYMMDD                      
*                                                                               
         GOTO1 GETDAY,DMCB,WORK,WORK+6 GET DAY OF WEEK                          
*                                                                               
         SR    RF,RF                                                            
         IC    RF,DMCB             GET NUMBER OF DAY OF WEEK                    
*                                                                               
         LA    RE,3                DEFAULT TO 3                                 
         CLI   DMCB,6              IF SATURDAY OR SUNDAY                        
         BL    *+8                                                              
         LA    RE,10                  USE 10                                    
*                                                                               
         SR    RE,RF               NUMBER OF DAYS TO REFERENCE WED              
*                                                                               
         GOTO1 ADDAY,DMCB,WORK,WORK+6,(RF)    DATE OF WEDNESDAY                 
*                                                                               
         GOTO1 DATCON,DMCB,WORK+6,(3,DUB)     BINARY DATE                       
*                                                                               
         CLI   DUB+2,15            IF BEFORE THE FIFTEENTH                      
         BNL   CTOF10                                                           
*                                                                               
         SR    RF,RF                                                            
         IC    RF,DUB+1               GET MONTH                                 
*                                                                               
         BCT   RF,*+18                DECREMENT MONTH                           
         IC    RF,DUB                    MONTH WAS JANUARY                      
         BCTR  RF,0                      SET TO DEC OF PREVIOUS YEAR            
         STC   RF,DUB                                                           
         LA    RF,12                     DECEMBER                               
*                                                                               
         STC   RF,DUB+1               SET CUTOFF MONTH                          
*                                                                               
CTOF10   DS    0H                  DATE IS ON OR AFTER FIFTEENTH                
*                                                                               
         MVC   NWMTCTCR,DUB        SET YM OF CUTOFF DATE                        
*                                                                               
         SR    RF,RF                                                            
         IC    RF,NWMTCTCR         GET YEAR OF CURRENT CUTOFF DATE              
*                                                                               
         MVC   NWMTCTPR,DUB        INIT PRIOR CUTOFF DATE                       
         BCTR  RF,0                DECREMENT YEAR                               
         STC   RF,NWMTCTPR         SET PRIOR YEAR                               
*                                                                               
         MVC   NWMTCT2P,DUB        INIT 2YR PRIOR CUTOFF DATE                   
         BCTR  RF,0                DECREMENT YEAR                               
         STC   RF,NWMTCT2P         SET 2YR PRIOR YEAR                           
*                                                                               
         MVC   NWMTCTNX,DUB        INIT NEXT YEAR CUTOFF DATE                   
         LA    RF,3(RF)            INCREMENT YEAR                               
         STC   RF,NWMTCTNX         SET NEXT YEAR CUTOFF DATE                    
*                                                                               
         B     CUTOFFX                                                          
*                                                                               
CUTOFFX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - POSTMNTH'                       
***********************************************************************         
*                                                                     *         
*        ROUTINE TO POST THE MONTH TABLE                              *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
POSTMNTH NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         SR    R0,R0                                                            
         IC    R0,REQAADFN         NUMBER OF ASATDATE FILTERS                   
         AH    R0,=H'1'            BUMP TO ALLOW FOR TOTAL REPORT               
*                                                                               
         L     R2,REANWMON         ESTABLISH ADDRESSES OF W/A                   
         USING NWMNTABD,R2         ESTABLISH NEW MONTH TABLE AREA               
*                                                                               
         XC    WORK,WORK                                                        
*                                                                               
         MVI   WORK+20,C'R'        SET 'SOURCE=RRG' INDICATOR                   
*                                                                               
         CLI   REQPSTRB+2,0        ANY DAY IN START DATE?                       
         BE    PM0010              NO  - NOT ACTIVITY REPORT                    
*                                                                               
         LA    R1,REMONACC         YES - ACTIVITY DATES                         
         ST    R1,WORK+16                                                       
*                                                                               
PM0010   EQU   *                                                                
*                                                                               
         MVI   WORK+16,C'P'        NO  - INSERT PENNIES OPTION                  
*                                                                               
POSTLOOP DS    0H                                                               
*                                                                               
         MVC   WORK(4),REAIO1      POINT TO CONTRACT RECORD                     
         MVI   WORK,0              CLEAR HIGH ORDER NIBBLE                      
*                                                                               
         TM    REQCSTAT,REQCSACQ   IF USING ALTERNATE CALENDAR                  
         BNO   *+8                                                              
         OI    WORK,X'80'             SET FLAG FOR ALTERNATE CALENDAR           
*                                                                               
         MVC   WORK+32(4),DATCON   SET UP ADDRESS LIST                          
         MVC   WORK+36(4),ADDAY                                                 
         MVC   WORK+40(4),GETDAY                                                
         MVC   WORK+44(4),GETBROAD                                              
         MVC   WORK+48(4),DATAMGR                                               
         MVC   WORK+52(4),PERVERT                                               
         LAY   R1,ALTBCMON                                                      
         MVC   WORK+56(4),0(R1)                                                 
*                                                                               
         GOTO1 =V(VALU5NEW),WORK,,NWMTNWMT,NWMTMINF,NWMTMFRC,,,WORK+32          
*                                                                               
*        RESTORE FILE POINTERS                                                  
*                                                                               
         MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,=CL8'DMRDHI',DIRNAME,KEY,KEY                        
*                                                                               
         TM    REQCSTAT,REQCSACQ   SKIP IF USING ALTERNATE CALENDAR             
         BO    POSTVL2X                                                         
*                                                                               
         CLI   REREPPRF+10,C'Y'    IF REP DEFAULTS TO INV CLOSE DATE            
         BNE   POSTVL2X                                                         
*                                                                               
         L     R4,REAIO1           ESTABLISH CONTRACT RECORD                    
         USING RCONREC,R4                                                       
*                                                                               
         CLC   =C'ACC-BBL',RCONBUYR   SKIP IF BACKBILL CONTRACT                 
         BE    POSTVL2X                                                         
*                                                                               
         L     R5,REAIO3           ESTABLISH STATION RECORD                     
         USING RSTAREC,R5                                                       
*                                                                               
         GOTO1 =A(SETVALU2),DMCB,RSTACLDT,NWMTNWMT,NWMTMFRC,RECURSTB            
*                                                                               
POSTVL2X DS    0H                                                               
*                                                                               
POSTCONT DS    0H                                                               
*                                                                               
         AHI   R2,NWMTENTL         BUMP TO NEXT SECTION                         
         BCT   R0,POSTLOOP                                                      
*                                                                               
POSTDONE DS    0H                                                               
*                                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
       ++INCLUDE RESETVALWR                                                     
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - PWCGET'                         
***********************************************************************         
*                                                                     *         
*        ROUTINE TO READ IN PAPERWORK RECORD FOR CONTRACT             *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
PWCGET   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         MVC   PWGKEYSV,KEY        SAVE CURRENT KEY                             
         MVC   PWGAIOSV,REAIO      SAVE CURRENT A(IOAREA)                       
*                                                                               
*  ROIOPEN  -- OPEN ROI DIR/FIL FOR READING (NO UPDATE)                         
*                                                                               
         TM    REQFLAGS,REQPWCOP                                                
         BO    PWCGOPNX                                                         
*                                                                               
         OI    REQFLAGS,REQPWCOP                                                
*                                                                               
         LA    R2,ROIFLSTR         READ-ONLY FILE LIST                          
         L     R3,REAIO2                                                        
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMOPEN',=C'REP',(R2),(R3)                        
*                                                                               
PWCGOPNX DS    0H                                                               
*                                                                               
         OI    STATUS,ROIREC       INDICATE ROIREC BEING READ                   
         MVC   REAIO,REAIO2        READ INTO IOAREA2                            
*                                                                               
         L     RF,REAIO2                                                        
         XC    0(L'RPWCKEY,RF),0(RF) INIT RECORD AREA                           
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY              ESTABLISH ROIREC KEY                         
         USING RPWCKEY,R4          ESTABLISH PAPERWORK RECORD KEY               
*                                                                               
         MVI   RPWCKTYP,X'2F'      SET RECORD TYPE                              
         MVC   RPWCKREP,REREP      SET REP                                      
         MVC   RPWCKCDE,RECON      SET CONTRACT NUMBER                          
*                                                                               
         BRAS  RE,HIGH             FIND RECORD POINTER                          
*                                                                               
         CLC   RPWCKEY,KEYSAVE     SKIP IF RECORD NOT FOUND                     
         BNE   PWCGETX                                                          
*                                                                               
         BRAS  RE,GETREC           READ IN RECORD                               
*                                                                               
         MVC   REAPWC,REAIO        SAVE RECORD ADDRESS                          
*                                                                               
PWCGETX  DS    0H                                                               
*                                                                               
         NI    STATUS,X'FF'-ROIREC TURN OFF ROIREC READ                         
         MVC   KEY,PWGKEYSV        RESTORE CURRENT KEY                          
         MVC   REAIO,PWGAIOSV      RESTORE A(IOAREA)                            
*                                                                               
         BRAS  RE,HIGH             RESTORE FILE POINTERS                        
*                                                                               
         XIT1                                                                   
*                                                                               
PWGKEYSV DS    CL32                CURRENT KEY SAVEAREA                         
PWGAIOSV DS    A                   CURRENT I/O AREA SAVE                        
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - KEYTRA'                         
***********************************************************************         
*                                                                     *         
*        TRACE KEYS READ AND ASKED FOR                                *         
*                                                                     *         
*NTRY    R1 ==> FILE NAME                                             *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
KEYTRA   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         MVI   PCC,0               INIT CONTROL CHARACTER                       
*                                                                               
*        PRINT DATAMGR CALL PARAMETERS                                          
*                                                                               
         MVC   P,SPACES                                                         
         MVC   P(06),COMMAND       COMMAND                                      
         MVC   P+8(06),0(R1)       FILE NAME                                    
*                                                                               
         L     RE,4(RD)            POINT TO CALLER                              
         L     RE,4(RE)            POINT TO HIS CALLER                          
         L     RF,4(RE)                                                         
*                                                                               
         MVC   P+16(4),0(RF)       PRINT CSECT ID                               
*                                                                               
         L     RF,12(RE)    REG 14                                              
         LA    RF,0(RF)     STRIP FIRST BYTE                                    
         L     RE,64(RE)    BASE                                                
         LA    RE,0(RE)                                                         
*                                                                               
         SR    RF,RE                                                            
         ST    RF,FULL                                                          
         UNPK  P+24(9),FULL(5)                                                  
         MVI   P+32,C' '                                                        
         TR    P+24(8),HEXTRN-C'0'                                              
*                                                                               
         MVC   P+80(50),P                                                       
*                                                                               
         GOTO1 =V(PRINT),DMCB,PCC,=C'BL01' PRINT LINE                           
         MVC   P,SPACES                                                         
*                                                                               
         MVC   P(08),=CL08'KEY'                                                 
*                                                                               
         LA    RF,P+10             PRINT START                                  
         LA    RE,KEY                                                           
         LA    R0,8                COUNTER                                      
*                                                                               
         UNPK  0(9,RF),0(5,RE)                                                  
         LA    RF,8(RF)                                                         
         LA    RE,4(RE)                                                         
         BCT   R0,*-14                                                          
*                                                                               
         MVI   0(RF),C' '                                                       
         TR    P+10(64),HEXTRN-C'0'                                             
*                                                                               
         MVC   P+99(32),KEY                                                     
         TR    P+99(32),PRNTBLE                                                 
*                                                                               
         GOTO1 =V(PRINT),DMCB,PCC,=C'BL01'                                      
         MVC   P,SPACES                                                         
*                                                                               
         CLC   KEY,KEYSAVE         SKIP IF KEY AND KEYSAVE THE SAME             
         BE    KEYTRA20                                                         
*                                                                               
         CLC   =C'GETREC',COMMAND  SKIP IF GET RECORD COMMAND                   
         BE    KEYTRA20                                                         
*                                                                               
         MVC   P(08),=CL08'KEYSAVE'                                             
*                                                                               
         LA    RF,P+10             PRINT START                                  
         LA    RE,KEYSAVE                                                       
         LA    R0,8                COUNTER                                      
*                                                                               
         UNPK  0(9,RF),0(5,RE)                                                  
         LA    RF,8(RF)                                                         
         LA    RE,4(RE)                                                         
         BCT   R0,*-14                                                          
*                                                                               
         MVI   0(RF),C' '                                                       
         TR    P+10(64),HEXTRN-C'0'                                             
*                                                                               
         MVC   P+99(32),KEYSAVE                                                 
         TR    P+99(32),PRNTBLE                                                 
*                                                                               
         GOTO1 =V(PRINT),DMCB,PCC,=C'BL01'                                      
         MVC   P,SPACES                                                         
*                                                                               
KEYTRA20 DS    0H                                                               
*                                                                               
KEYTRAX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - RRGTRA'                         
***********************************************************************         
*                                                                     *         
*        TRACE RRGWRI CONTROL BLOCK                                   *         
*                                                                     *         
*NTRY    R1 ==> FILE NAME                                             *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RRGTRA   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         LA    R6,RERRGWRC                                                      
         USING RRGWRI,R6                                                        
*                                                                               
         MVI   PCC,0               INIT CONTROL CHARACTER                       
*                                                                               
*        PRINT RRGWRI CONTROL BLOCK                                             
*                                                                               
         MVC   P,SPACES                                                         
*                                                                               
         LA    R0,8                MAX 8 DATATYPES                              
         LA    R3,P+2                                                           
         LA    R2,RRGWDT1                                                       
         LA    R4,RRGWDAT1                                                      
*                                                                               
RRGHDLP  DS    0H                                                               
*                                                                               
         UNPK  0(3,R3),0(2,R2)     DATATYPE                                     
         MVI   2(R3),C' '                                                       
         TR    0(2,R3),HEXTRN-C'0'                                              
         MVC   4(8,R3),1(R2)       ASKED FOR DATA                               
         MVC   14(8,R3),0(R4)      FOUND DATA                                   
*                                                                               
         CH    R0,=H'5'                                                         
         BNE   RRGHDCN                                                          
*                                                                               
         GOTO1 =V(PRINT),DMCB,PCC,=C'BL01'                                      
         MVC   P,SPACES                                                         
*                                                                               
         LA    R3,P+2                                                           
*                                                                               
RRGHDCN  DS    0H                                                               
*                                                                               
         LA    R3,24(R3)                                                        
         LA    R2,9(R2)                                                         
         LA    R4,8(R4)                                                         
*                                                                               
         BCT   R0,RRGHDLP                                                       
*                                                                               
RRGHDDN  DS    0H                                                               
*                                                                               
         GOTO1 =V(PRINT),DMCB,PCC,=C'BL01'                                      
         MVC   P,SPACES                                                         
*                                                                               
         MVC   P(5),=C'DATE='                                                   
         UNPK  P+5(5),RRGWYRMO(3)                                               
         MVI   P+9,C' '                                                         
         TR    P+5(4),HEXTRN-C'0'                                               
*                                                                               
         MVC   P+15(7),=C'STATUS='                                              
         UNPK  P+22(3),RRGWSTAT(2)                                              
         MVI   P+24,C' '                                                        
         TR    P+22(2),HEXTRN-C'0'                                              
*                                                                               
         MVC   P+30(6),=C'ERROR='                                               
         UNPK  P+36(3),RRGWERR(2)                                               
         MVI   P+38,C' '                                                        
         TR    P+36(2),HEXTRN-C'0'                                              
*                                                                               
         GOTO1 =V(PRINT),DMCB,PCC,=C'BL01'                                      
         MVC   P,SPACES                                                         
*                                                                               
         LA    R0,6                                                             
         LA    R1,P+1                                                           
         LA    R2,RRGWPRBL                                                      
*                                                                               
RRGDTLLP DS    0H                                                               
*                                                                               
         UNPK  0(9,R1),0(5,R2)                                                  
         MVI   8(R1),C' '                                                       
         TR    0(8,R1),HEXTRN-C'0'                                              
*                                                                               
RRGDTLCN DS    0H                                                               
*                                                                               
         LA    R1,9(R1)                                                         
         LA    R2,4(R2)                                                         
         BCT   R0,RRGDTLLP                                                      
*                                                                               
         LA    R0,4                                                             
         LA    R1,P+60                                                          
         LA    R2,RRGWCPAC                                                      
*                                                                               
RRGPCTLP DS    0H                                                               
*                                                                               
         UNPK  0(5,R1),0(3,R2)                                                  
         MVI   4(R1),C' '                                                       
         TR    0(4,R1),HEXTRN-C'0'                                              
*                                                                               
RRGPCTCN DS    0H                                                               
*                                                                               
         LA    R1,5(R1)                                                         
         LA    R2,2(R2)                                                         
         BCT   R0,RRGPCTLP                                                      
*                                                                               
         GOTO1 =V(PRINT),DMCB,PCC,=C'BL01'                                      
         MVC   P,SPACES                                                         
*                                                                               
RRGTRAX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - TBLTRA'                         
***********************************************************************         
*                                                                     *         
*        PRINT CONTENTS OF A TABLE                                    *         
*                                                                     *         
*NTRY    R5==> PARAMETERS TABLE ENTRY                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
TBLTRA   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         USING STDPRMSD,R5         ESTABLISH TABLE PARAMETERS                   
*                                                                               
         MVI   PCC,0               INIT CONTROL CHARACTER                       
*                                                                               
         ICM   R2,15,STDPTBA       POINT TO TABLE                               
         BZ    TBLTRAX             SKIP IF NONE AVAILABLE                       
*                                                                               
         LA    R2,RENWRIOD(R2)     RE-LOCATE ADDRESS                            
*                                                                               
         ICM   R2,15,0(R2)         POINT TO TABLE                               
         BZ    TBLTRAX             NO TABLE                                     
*                                                                               
         USING STDTTABD,R2         ESTABLISH TABLE                              
*                                                                               
         MVC   P,SPACES                                                         
         GOTO1 =V(PRINT),DMCB,PCC,=C'BL01' PRINT SPACING LINE                   
*                                                                               
*        PRINT TABLE ID                                                         
*                                                                               
         MVC   P(20),=CL20'TABLE ID=' IDENTIFY TABLE                            
         UNPK  P+20(3),STDPRID(2)                                               
         MVI   P+22,C' '                                                        
         TR    P+20(2),HEXTRN-C'0' TRANSLATE HEX                                
*                                                                               
         LR    RF,R2               PRINT ENGLISH ID                             
         SH    RF,=H'8'                                                         
         MVC   P+24(8),0(RF)                                                    
*                                                                               
         GOTO1 =V(PRINT),DMCB,PCC,=C'BL01' PRINT LINE                           
         MVC   P,SPACES                                                         
*                                                                               
         MVC   P(20),=CL20'SET KEY='                                            
*                                                                               
         LA    RF,P+20             PRINT START                                  
         LA    RE,STDTSKEY                                                      
         LA    R0,8                COUNTER                                      
*                                                                               
         UNPK  0(9,RF),0(5,RE)                                                  
         LA    RF,8(RF)                                                         
         LA    RE,4(RE)                                                         
         BCT   R0,*-14                                                          
*                                                                               
         MVI   0(RF),C' '                                                       
         TR    P+20(64),HEXTRN-C'0'                                             
*                                                                               
         MVC   P+99(32),STDTSKEY   HEX VALUES TO BE DUMPED                      
         TR    P+99(32),PRNTBLE    KILL UNPRINTABLE CHARACTERS                  
*                                                                               
         GOTO1 =V(PRINT),DMCB,PCC,=C'BL01'                                      
         MVC   P,SPACES                                                         
*                                                                               
         MVC   P(20),=CL20'MEMBERS DESCRIPTION='                                
         GOTO1 =V(PRINT),DMCB,PCC,=C'BL01'                                      
         MVC   P,SPACES                                                         
*                                                                               
         LA    R6,STDTSDSC                                                      
         USING RSETDESC,R6                                                      
*                                                                               
         BAS   RE,DUMPELM                                                       
*                                                                               
         MVC   P(20),=CL20'MEMBERS ELEMENT='                                    
         GOTO1 =V(PRINT),DMCB,PCC,=C'BL01'                                      
         MVC   P,SPACES                                                         
*                                                                               
         LA    R6,STDTSMEM                                                      
         USING RSETMEMD,R6                                                      
*                                                                               
         BAS   RE,DUMPELM                                                       
*                                                                               
         MVC   P(20),=CL20'BXLE REGISTERS='                                     
*                                                                               
         UNPK  P+20(09),STDTSTRA(5)                                             
         MVI   P+28,C' '                                                        
         TR    P+20(08),HEXTRN-C'0'                                             
*                                                                               
         UNPK  P+29(09),STDTLEN(5)                                              
         MVI   P+37,C' '                                                        
         TR    P+29(08),HEXTRN-C'0'                                             
*                                                                               
         UNPK  P+38(09),STDTENDA(5)                                             
         MVI   P+46,C' '                                                        
         TR    P+38(08),HEXTRN-C'0'                                             
*                                                                               
         UNPK  P+47(09),STDTAVL(5)  SPACES LEFT IN TABLE                        
         MVI   P+55,C' '                                                        
         TR    P+47(08),HEXTRN-C'0'                                             
*                                                                               
         GOTO1 =V(PRINT),DMCB,PCC,=C'BL01'                                      
         MVC   P,SPACES                                                         
*                                                                               
         MVC   P(20),=CL20'TABLE ELEMENTS='                                     
         GOTO1 =V(PRINT),DMCB,PCC,=C'BL01'                                      
         MVC   P,SPACES                                                         
*                                                                               
         LM    R3,R5,STDTBXLE      LOAD BXLE REGISTERS                          
*                                                                               
TBTLOOP  DS    0H                                                               
*                                                                               
         USING STDTENT,R3          ESTABLISH ENTRY                              
*                                                                               
         MVC   P(20),=CL20'KEY='                                                
*                                                                               
         LA    RF,P+20             PRINT START                                  
         LA    RE,STDTKEY                                                       
         LA    R0,8                COUNTER                                      
*                                                                               
         UNPK  0(9,RF),0(5,RE)                                                  
         LA    RF,8(RF)                                                         
         LA    RE,4(RE)                                                         
         BCT   R0,*-14                                                          
*                                                                               
         MVI   0(RF),C' '                                                       
*                                                                               
         TR    P+20(64),HEXTRN-C'0'                                             
*                                                                               
         MVC   P+99(32),STDTKEY    HEX VALUES TO BE DUMPED                      
         TR    P+99(32),PRNTBLE    KILL UNPRINTABLE CHARACTERS                  
*                                                                               
         GOTO1 =V(PRINT),DMCB,PCC,=C'BL01'                                      
         MVC   P,SPACES                                                         
*                                                                               
         LA    R6,STDTELM          PRINT SAVED ELEMENT                          
*                                                                               
         BAS   RE,DUMPELM                                                       
*                                                                               
TBTCONT  DS    0H                                                               
*                                                                               
         BXLE  R3,R4,TBTLOOP                                                    
*                                                                               
TBTDONE  DS    0H                                                               
*                                                                               
         GOTO1 =V(PRINT),DMCB,PCC,=C'BL01' PRINT SPACING LINE                   
         MVC   P,SPACES                                                         
*                                                                               
TBLTRAX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - DUMPELM'                        
***********************************************************************         
*                                                                     *         
*        DUMP STANDARD ELEMENT                                        *         
*                                                                     *         
*NTRY    R6==> ELEMENT TO BE DUMPED                                   *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
DUMPELM  NTR1  LABEL=*                                                          
*                                                                               
         USING RENWRIOD,R7         ESTABLISH RENWRIO BLOCK                      
         USING SUBROUTS,RA         ESTABLISH SUBROUTINES                        
         USING NWRIOWD,RC          ESTABLISH PROGRAM WORKING STORAGE            
*                                                                               
         SR    R0,R0                                                            
         IC    R0,1(R6)            ELEMENT LENGTH                               
*                                                                               
         LR    R3,R6               START OF AREA TO BE DUMPED                   
*                                                                               
DME1LP   DS    0H                                                               
*                                                                               
         LA    R1,P                START OF PRINT AREA                          
         LA    R2,32               MAX BYTES PER LINE                           
*                                                                               
         CR    R2,R0               IF FEWER BYTES LEFT IN ELEMENT               
         BNH   *+6                                                              
         LR    R2,R0                  RESET TO WHAT IS LEFT                     
*                                                                               
         LTR   RF,R2               MAX BYTES FOR THIS LINE                      
         BZ    DME1DN              NOTHING LEFT TO DUMP                         
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   P+99(0),0(R3)       HEX VALUES TO BE DUMPED                      
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         TR    P+99(0),PRNTBLE     KILL UNPRINTABLE CHARACTERS                  
*                                                                               
DME2LP   DS    0H                                                               
*                                                                               
         LA    R4,4                MAX BYTES TO UNPACK                          
*                                                                               
         CR    R4,R2               TEST IF END OF ELEMENT REACHED               
         BNH   *+6                                                              
         LR    R4,R2                                                            
*                                                                               
         LR    RF,R4               GET RECEIVING EXECUTE LENGTH                 
         SLL   RF,4                PLACE IN LEFT NYBBLE                         
         SLL   RF,1                DOUBLE TO LENGTH                             
         OR    RF,R4               ADD FROM EX LENGTH TO RIGHT NYBBLE           
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         UNPK  0(0,R1),0(0,R3)     UNPACK DATA                                  
*                                                                               
         SRL   RF,4                RECEIVING EXECUTE LENGTH                     
*                                                                               
         LA    RE,0(RF,R1)         GARBAGE BYTE                                 
         MVI   0(RE),C' '          CLEAR GARBAGE BYTE                           
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         TR    0(0,R1),HEXTRN-C'0'    PRINTABLE HEX                             
*                                                                               
DME2CN   DS    0H                                                               
*                                                                               
         LA    R1,9(R1)            NEXT PRINT AREA                              
         LA    R3,4(R3)            NEXT AREA TO DUMP                            
*                                                                               
         SR    R2,R4               DECREMENT ITEMS ON LINE CTR                  
         BP    DME2LP              PROCESS NEXT CHUNK                           
*                                                                               
DME2DN   DS    0H                                                               
*                                                                               
         GOTO1 =V(PRINT),DMCB,PCC,=C'BL01' PRINT LINE                           
         MVC   P,SPACES            CLEAR LINE                                   
*                                                                               
DME1CN   DS    0H                                                               
*                                                                               
         SH    R0,=H'32'           LOOP IF MORE TO PRINT                        
         BP    DME1LP                                                           
*                                                                               
DME1DN   DS    0H                                                               
*                                                                               
         GOTO1 =V(PRINT),DMCB,PCC,=C'BL01' PRINT SPACING LINE                   
*                                                                               
DUMPELMX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP                                                                   
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - QWAREA'                         
***********************************************************************         
*                                                                     *         
*        WORK AREA FOR POSTING ROUTINES                               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DC    CL8'*QWAREA*'                                                    
QWAREA   EQU   *                                                                
         DC    (QWEND-QWKD)X'00'         REQUEST WORK AREA                      
QWAREAX  EQU   *-1                                                              
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - RRGENTD'                        
***********************************************************************         
*                                                                     *         
*        DSECT FOR RGON PROCESSING TABLE                              *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
RRGTENTD DSECT                                                                  
RRGTDTP  DS    AL1                 DATATYPE                                     
         DS    XL3                 SPARE                                        
RRGTDATA DS    A                   A(DATATYPE VALUE)                            
RRGTSTDA DS    A                   A(STANDARD TABLE ENTRY FOR DATATYPE)         
RRGTENTL EQU   *-RRGTENTD          LENGTH OF TABLE ENTRY                        
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - STDPRMSD'                       
***********************************************************************         
*                                                                     *         
*        DSECT FOR PARAMETERS FOR A STANDARD TABLE                    *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
STDPRMSD DSECT                     PARAMETERS FOR STANDARD TABLE                
*                                                                               
STDPRID  DS    AL1                 RECORD ID                                    
*                                                                               
STDPREPD DS    AL1                 DISPLACEMENT OF REP IN KEY                   
*                                                                               
*        SET RECORD DATA                                                        
*                                                                               
STDPSTP  DS    CL2                 SET RECORD TYPE                              
STDPSIDA DS    A                   A(SET RECORD FILTER-RENWRIOD)                
*                                                                               
*        KEY COMPONENTS                                                         
*                                                                               
STDPDA1L DS    AL1                 FIRST LENGTH                                 
STDPKY1D DS    AL1                 FIRST DISPLACEMENT INTO KEY                  
         DS    XL2                 SPARE                                        
STDPFL1A DS    A                   A(FILTER VALUE-RENWRIOD)                     
*                                                                               
STDPDA2L DS    AL1                 SECOND LENGTH                                
STDPKY2D DS    AL1                 SECOND DISPLACEMENT INTO KEY                 
         DS    XL2                 SPARE                                        
STDPFL2A DS    A                   A(FILTER VALUE-RENWRIOD)                     
*                                                                               
*        TABLE PARAMETERS                                                       
*                                                                               
STDPTBA  DS    A                   A(TABLE IN BUFFER-RENWRIOD)                  
*                                                                               
STDPMAX  DS    AL2                 MAX NUMBER OF ENTRIES IN TABLE               
STDPENTL DS    AL2                 LENGTH OF ENTRY IN TABLE                     
*                                                                               
STDPELID DS    XL1                 ELEMENT TO BE SAVED ID                       
STDPFLEQ DS    XL1                 FILTER EQUATE                                
STDPFLNM DS    XL1                 FILTER NUMBER (1-4)                          
         DS    XL1                 SPARE                                        
*                                                                               
STDPCVLL DS    AL1                 L'CURRENT VALUE                              
STDPCVLA DS    A                   A(CURRENT VALUE)                             
STDPGETA DS    A                   A(GET NEXT ROUTINE)                          
STDPENTA DS    A                   A(CURRENT TABLE ENTRY)                       
*                                                                               
STDPRMSL EQU   *-STDPRMSD                                                       
*                                                                               
         TITLE 'RENWRIO - REPWRITER IO MODULE - NWRIOWD'                        
***********************************************************************         
*                                                                     *         
*              WORKING STORAGE                                        *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
NWRIOWD DSECT                                                                   
         DS    0F                                                               
*                                                                               
RENWRIOA DS    F                   A(RENWRIO)                                   
*                                                                               
FILENAME DS    CL8                                                              
DIRNAME  DS    CL8                                                              
DMCB     DS    6F                                                               
DUB      DS    D                                                                
WORK     DS    CL64                                                             
DMWORK   DS    CL96                                                             
FULL     DS    F                                                                
WORD     DS    F                                                                
HALF     DS    H                                                                
HALF2    DS    H                                                                
THREE    DS    CL3                                                              
BYTE     DS    CL1                                                              
FILTLEV  DS    CL1                                                              
         SPACE                                                                  
COMMAND  DS    CL8                                                              
USERRD   DS    A                   USER REGISTER 13                             
DATAMGR  DS    V                                                                
HEXOUT   DS    V                                                                
DATCON   DS    V                                                                
SQUASHER DS    V                                                                
GETDAY   DS    V                                                                
PERVERT  DS    V                                                                
GETBROAD DS    V                                                                
ADDAY    DS    V                                                                
CALLOV   DS    V                                                                
XSORT    DS    V                                                                
VRECUP   DS    V                                                                
VREPFACS DS    V                                                                
         SPACE                                                                  
NLIMOFF  DS    XL1                 OFFICE LIMIT ACCESS                          
LIMOFF   DS    CL120                                                            
SPACES   DS    CL133                                                            
MAINREAD DS    XL1                                                              
SUBREAD  DS    XL1                                                              
ELCODE   DS    CL1                                                              
LKEY     DS    XL1                                                              
PRIMELKY DS    XL1                                                              
STATUS   DS    XL1                                                              
FOUNDONE EQU   X'80'               PASSED A RECORD TO APPLIC.                   
ROIREC   EQU   X'40'               USE ROIDIR/FIL - NOT REPDIR/FIL              
         DS    0D                                                               
INTCOMM  DS    F                                                                
TESTBYTE DS    XL1                                                              
*                                                                               
         DS    0D                                                               
PRIMEKEY DS    CL40                                                             
PRIMESAV DS    CL40                                                             
KEY      DS    CL36                                                             
KEYSAVE  DS    CL36                                                             
SVKEY    DS    CL40                                                             
SVQSTART DS    CL6                 C'999999'  EARLIEST REQ START DATE           
SVQSTRT2 DS    CL2                 TWO BYTE FORMAT                              
SVQEND   DS    CL6                 C'000000'  LATEST REQ END DATE               
SVQEND2  DS    CL2                 TWO BYTE FORMAT                              
BSTARTDT DS    CL3                 2 YEAR PRIOR TO REQUESTED START              
BENDDT   DS    CL3                 1 YEAR POST REQUESTED DATE                   
DVLINISW DS    CL1                 X'01' NEWVALU2 INITIALIZATION DONE           
PCC      DS    C                   PRINT CONTROL CHARACTER                      
P        DS    CL132               USED FOR PRINTING DUMPS                      
*                                                                               
WRIIOWKX EQU   *                                                                
         EJECT                                                                  
         DSECT                                                                  
       ++INCLUDE RENWRIOD                                                       
         EJECT                                                                  
       ++INCLUDE REREPQWKDB                                                     
         EJECT                                                                  
QREC2D   DSECT                                                                  
       ++INCLUDE REGENREQ2                                                      
         SPACE                                                                  
*REGENALL1                                                                      
         PRINT OFF                                                              
       ++INCLUDE REGENALL1                                                      
         PRINT ON                                                               
*MN                                                                             
         PRINT OFF                                                              
       ++INCLUDE REGENDAR                                                       
         PRINT ON                                                               
         PRINT OFF                                                              
       ++INCLUDE REGENMKG                                                       
         PRINT ON                                                               
*MN                                                                             
         ORG   RGRPKGRP                                                         
RGRPKGP  DS    CL1                 GROUP                                        
RGRPKSGR DS    CL1                 SUBGROUP                                     
         ORG                                                                    
*RENWRDLSTD                                                                     
         PRINT OFF                                                              
       ++INCLUDE RENWRDLSTD                                                     
         PRINT ON                                                               
*RENWRNRG                                                                       
         PRINT OFF                                                              
       ++INCLUDE RENWRNRG                                                       
         PRINT ON                                                               
*CTGENFILE                                                                      
         PRINT OFF                                                              
       ++INCLUDE CTGENFILE                                                      
         PRINT ON                                                               
*REGENDCT                                                                       
         PRINT OFF                                                              
       ++INCLUDE REGENDCT                                                       
         PRINT ON                                                               
*REGENDSP                                                                       
         PRINT OFF                                                              
       ++INCLUDE REGENDSP                                                       
         PRINT ON                                                               
*REGENSPEC                                                                      
RSPBRECD DSECT                                                                  
         PRINT OFF                                                              
       ++INCLUDE REGENSPEC                                                      
         PRINT ON                                                               
*REGENPWC                                                                       
         PRINT OFF                                                              
       ++INCLUDE REGENPWC                                                       
         PRINT ON                                                               
*REGENSET                                                                       
         PRINT OFF                                                              
       ++INCLUDE REGENSET                                                       
         PRINT ON                                                               
*REGENTER                                                                       
         PRINT OFF                                                              
RTERRECD DSECT                                                                  
       ++INCLUDE REGENTER                                                       
         PRINT ON                                                               
*REGENAGY2                                                                      
         PRINT OFF                                                              
RAGY2RCD DSECT                                                                  
       ++INCLUDE REGENAGY2                                                      
         PRINT ON                                                               
*REGENOBUD                                                                      
         PRINT OFF                                                              
ROBDRECD DSECT                                                                  
       ++INCLUDE REGENOBUD                                                      
         PRINT ON                                                               
*REGENSBUD                                                                      
         PRINT OFF                                                              
RSBDRECD DSECT                                                                  
       ++INCLUDE REGENSBUD                                                      
         PRINT ON                                                               
*REGENCOM                                                                       
         PRINT OFF                                                              
RCOMRECD DSECT                                                                  
       ++INCLUDE REGENCOM                                                       
         PRINT ON                                                               
*DDCOMFACS                                                                      
         PRINT OFF                                                              
       ++INCLUDE DDCOMFACS                                                      
         PRINT ON                                                               
*REPFACSQ                                                                       
         PRINT OFF                                                              
       ++INCLUDE REPFACSQ                                                       
         PRINT ON                                                               
*RENWRDSCTS                                                                     
         PRINT OFF                                                              
       ++INCLUDE RENWRDSCTS                                                     
         PRINT ON                                                               
*INTEREP                                                                        
         PRINT OFF                                                              
       ++INCLUDE INTEREP                                                        
         PRINT ON                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'120RENWRIO   04/30/12'                                      
         END                                                                    
